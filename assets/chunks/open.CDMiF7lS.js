const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/chunks/blosc.nNxqTOai.js","assets/chunks/chunk-INHXZS53.D3tQiqtZ.js","assets/chunks/lz4.COuoZ_ur.js","assets/chunks/zstd.CtzXwP91.js"])))=>i.map(i=>d[i]);
var Qe=Object.defineProperty;var Te=t=>{throw TypeError(t)};var qe=(t,e,r)=>e in t?Qe(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r;var h=(t,e,r)=>qe(t,typeof e!="symbol"?e+"":e,r),re=(t,e,r)=>e.has(t)||Te("Cannot "+r);var c=(t,e,r)=>(re(t,e,"read from private field"),r?r.call(t):e.get(t)),y=(t,e,r)=>e.has(t)?Te("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,r),_=(t,e,r,n)=>(re(t,e,"write to private field"),n?n.call(t,r):e.set(t,r),r),ne=(t,e,r)=>(re(t,e,"access private method"),r);import{a5 as se}from"./framework.BisDmvbf.js";function Ye(t,e,r,n={}){return e!==void 0&&r!==void 0&&(n={...n,headers:{...n.headers,Range:`bytes=${e}-${e+r-1}`}}),fetch(t,n)}function et(t,e){return{...t,...e,headers:{...t.headers,...e.headers}}}function Ne(t,e){const r=typeof t=="string"?new URL(t):t;r.pathname.endsWith("/")||(r.pathname+="/");const n=new URL(e.slice(1),r);return n.search=r.search,n}async function Ie(t){if(t.status!==404){if(t.status===200||t.status===206)return new Uint8Array(await t.arrayBuffer());throw new Error(`Unexpected response status ${t.status} ${t.statusText}`)}}async function tt(t,e,r,n){if(n)return fetch(t,{...r,headers:{...r.headers,Range:`bytes=-${e}`}});let s=await fetch(t,{...r,method:"HEAD"});if(!s.ok)return s;let i=s.headers.get("Content-Length"),o=Number(i);return Ye(t,o-e,o,r)}var z,B,j,oe;class Wt{constructor(e,r={}){y(this,j);h(this,"url");y(this,z);y(this,B);this.url=e,_(this,z,r.overrides??{}),_(this,B,r.useSuffixRequest??!1)}async get(e,r={}){let n=Ne(this.url,e).href,s=await fetch(n,ne(this,j,oe).call(this,r));return Ie(s)}async getRange(e,r,n={}){let s=Ne(this.url,e),i=ne(this,j,oe).call(this,n),o;return"suffixLength"in r?o=await tt(s,r.suffixLength,i,c(this,B)):o=await Ye(s,r.offset,r.length,i),Ie(o)}}z=new WeakMap,B=new WeakMap,j=new WeakSet,oe=function(e){return et(c(this,z),e)};var k;class Je{constructor(e,r,n){y(this,k);typeof e=="number"?_(this,k,new Uint8Array(e)):e instanceof ArrayBuffer?_(this,k,new Uint8Array(e,r,n)):_(this,k,new Uint8Array(Array.from(e,s=>s?1:0)))}get BYTES_PER_ELEMENT(){return 1}get byteOffset(){return c(this,k).byteOffset}get byteLength(){return c(this,k).byteLength}get buffer(){return c(this,k).buffer}get length(){return c(this,k).length}get(e){let r=c(this,k)[e];return typeof r=="number"?r!==0:r}set(e,r){c(this,k)[e]=r?1:0}fill(e){c(this,k).fill(e?1:0)}*[Symbol.iterator](){for(let e=0;e<this.length;e++)yield this.get(e)}}k=new WeakMap;var L;class fe{constructor(e,r,n,s){h(this,"_data");h(this,"chars");y(this,L);if(this.chars=e,_(this,L,new TextEncoder),typeof r=="number")this._data=new Uint8Array(r*e);else if(r instanceof ArrayBuffer)s&&(s=s*e),this._data=new Uint8Array(r,n,s);else{let i=Array.from(r);this._data=new Uint8Array(i.length*e);for(let o=0;o<i.length;o++)this.set(o,i[o])}}get BYTES_PER_ELEMENT(){return this.chars}get byteOffset(){return this._data.byteOffset}get byteLength(){return this._data.byteLength}get buffer(){return this._data.buffer}get length(){return this.byteLength/this.BYTES_PER_ELEMENT}get(e){const r=new Uint8Array(this.buffer,this.byteOffset+this.chars*e,this.chars);return new TextDecoder().decode(r).replace(/\x00/g,"")}set(e,r){const n=new Uint8Array(this.buffer,this.byteOffset+this.chars*e,this.chars);n.fill(0),n.set(c(this,L).encode(r))}fill(e){const r=c(this,L).encode(e);for(let n=0;n<this.length;n++)this._data.set(r,n*this.chars)}*[Symbol.iterator](){for(let e=0;e<this.length;e++)yield this.get(e)}}L=new WeakMap;var w;const ke=class ke{constructor(e,r,n,s){y(this,w);h(this,"chars");if(this.chars=e,typeof r=="number")_(this,w,new Int32Array(r*e));else if(r instanceof ArrayBuffer)s&&(s*=e),_(this,w,new Int32Array(r,n,s));else{const i=r,o=new ke(e,1);_(this,w,new Int32Array(function*(){for(let a of i)o.set(0,a),yield*c(o,w)}()))}}get BYTES_PER_ELEMENT(){return c(this,w).BYTES_PER_ELEMENT*this.chars}get byteLength(){return c(this,w).byteLength}get byteOffset(){return c(this,w).byteOffset}get buffer(){return c(this,w).buffer}get length(){return c(this,w).length/this.chars}get(e){const r=this.chars*e;let n="";for(let s=0;s<this.chars;s++)n+=String.fromCodePoint(c(this,w)[r+s]);return n.replace(/\u0000/g,"")}set(e,r){const n=this.chars*e,s=c(this,w).subarray(n,n+this.chars);s.fill(0);for(let i=0;i<this.chars;i++)s[i]=r.codePointAt(i)??0}fill(e){this.set(0,e);let r=c(this,w).subarray(0,this.chars);for(let n=1;n<this.length;n++)c(this,w).set(r,n*this.chars)}*[Symbol.iterator](){for(let e=0;e<this.length;e++)yield this.get(e)}};w=new WeakMap;let $=ke;function X(t){const e=new TextDecoder().decode(t);return JSON.parse(e)}function Ue(t,e){const r=e/2,n=e-1;let s=0;for(let i=0;i<t.length;i+=e)for(let o=0;o<r;o+=1)s=t[i+o],t[i+o]=t[i+n-o],t[i+n-o]=s}function We(t){if(t==="v2:object")return globalThis.Array;let e=t.match(/v2:([US])(\d+)/);if(e){let[,n,s]=e;return(n==="U"?$:fe).bind(null,Number(s))}let r={int8:Int8Array,int16:Int16Array,int32:Int32Array,int64:globalThis.BigInt64Array,uint8:Uint8Array,uint16:Uint16Array,uint32:Uint32Array,uint64:globalThis.BigUint64Array,float16:globalThis.Float16Array,float32:Float32Array,float64:Float64Array,bool:Je}[t];return p(r,`Unknown or unsupported data_type: ${t}`),r}function I(t,e){const r=t.length;typeof e=="string"&&(e=e==="C"?Array.from({length:r},(i,o)=>o):Array.from({length:r},(i,o)=>r-1-o)),p(r===e.length,"Order length must match the number of dimensions.");let n=1,s=new Array(r);for(let i=e.length-1;i>=0;i--)s[e[i]]=n,n*=t[e[i]];return s}function rt({name:t,configuration:e}){if(t==="default"){const r=(e==null?void 0:e.separator)??"/";return n=>["c",...n].join(r)}if(t==="v2"){const r=(e==null?void 0:e.separator)??".";return n=>n.join(r)||"0"}throw new Error(`Unknown chunk key encoding: ${t}`)}function nt(t){if(t==="|O")return{data_type:"v2:object"};let e=t.match(/^([<|>])(.*)$/);p(e,`Invalid dtype: ${t}`);let[,r,n]=e,s={b1:"bool",i1:"int8",u1:"uint8",i2:"int16",u2:"uint16",i4:"int32",u4:"uint32",i8:"int64",u8:"uint64",f2:"float16",f4:"float32",f8:"float64"}[n]??(n.startsWith("S")||n.startsWith("U")?`v2:${n}`:void 0);return p(s,`Unsupported or unknown dtype: ${t}`),r==="|"?{data_type:s}:{data_type:s,endian:r==="<"?"little":"big"}}function st(t,e={}){let r=[],n=nt(t.dtype);t.order==="F"&&r.push({name:"transpose",configuration:{order:"F"}}),"endian"in n&&n.endian==="big"&&r.push({name:"bytes",configuration:{endian:"big"}});for(let{id:s,...i}of t.filters??[])r.push({name:s,configuration:i});if(t.compressor){let{id:s,...i}=t.compressor;r.push({name:s,configuration:i})}return{zarr_format:3,node_type:"array",shape:t.shape,data_type:n.data_type,chunk_grid:{name:"regular",configuration:{chunk_shape:t.chunks}},chunk_key_encoding:{name:"v2",configuration:{separator:t.dimension_separator??"."}},codecs:r,fill_value:t.fill_value,attributes:e}}function it(t,e={}){return{zarr_format:3,node_type:"group",attributes:e}}function ot(t,e){if(e!=="number"&&e!=="bigint"&&e!=="boolean"&&e!=="object"&&e!=="string")return t===e;let r=t==="bool";if(e==="boolean")return r;let n=t.startsWith("v2:U")||t.startsWith("v2:S");if(e==="string")return n;let s=t==="int64"||t==="uint64";if(e==="bigint")return s;let i=t==="v2:object";return e==="object"?i:!n&&!s&&!r&&!i}function at(t){return(t==null?void 0:t.name)==="sharding_indexed"}function Ve(t){return(t.data_type==="uint64"||t.data_type==="int64")&&t.fill_value!=null?BigInt(t.fill_value):t.fill_value}function Ge(t,...e){if(!e.some(r=>t instanceof r))throw t}function p(t,e=""){if(!t)throw new Error(e)}async function Ke(t,{format:e,signal:r}){const n=t instanceof Response?t:new Response(t);p(n.body,"Response does not contain body.");try{return await new Response(n.body.pipeThrough(new DecompressionStream(e),{signal:r})).arrayBuffer()}catch{throw r==null||r.throwIfAborted(),new Error(`Failed to decode ${e}`)}}class le{constructor(e,r){h(this,"kind","array_to_array");p(e.keepbits>=0,"keepbits must be zero or positive")}static fromConfig(e,r){return new le(e,r)}encode(e){throw new Error("`BitroundCodec.encode` is not implemented. Please open an issue at https://github.com/manzt/zarrita.js/issues.")}decode(e){return e}}const Se=ct();function ct(){const t=new Uint32Array([305419896]);return new Uint8Array(t.buffer,t.byteOffset,t.byteLength)[0]!==18}function Le(t){return"BYTES_PER_ELEMENT"in t?t.BYTES_PER_ELEMENT:4}var P,x,F,D,R;const Ee=class Ee{constructor(e,r){h(this,"kind","array_to_bytes");y(this,P);y(this,x);y(this,F);y(this,D);y(this,R);_(this,R,e==null?void 0:e.endian),_(this,x,We(r.data_type)),_(this,D,r.shape),_(this,P,I(r.shape,"C"));const n=new(c(this,x))(0);_(this,F,n.BYTES_PER_ELEMENT)}static fromConfig(e,r){return new Ee(e,r)}encode(e){let r=new Uint8Array(e.data.buffer);return Se&&c(this,R)==="big"&&Ue(r,Le(c(this,x))),r}decode(e){return Se&&c(this,R)==="big"&&Ue(e,Le(c(this,x))),{data:new(c(this,x))(e.buffer,e.byteOffset,e.byteLength/c(this,F)),shape:c(this,D),stride:c(this,P)}}};P=new WeakMap,x=new WeakMap,F=new WeakMap,D=new WeakMap,R=new WeakMap;let q=Ee;class _e{constructor(){h(this,"kind","bytes_to_bytes")}static fromConfig(){return new _e}encode(e){throw new Error("Not implemented")}decode(e){return new Uint8Array(e.buffer,e.byteOffset,e.byteLength-4)}}class ye{constructor(){h(this,"kind","bytes_to_bytes")}static fromConfig(e){return new ye}encode(e){throw new Error("Gzip encoding is not enabled by default. Please register a custom codec with `numcodecs/gzip`.")}async decode(e){const r=await Ke(e,{format:"gzip"});return new Uint8Array(r)}}function ut(t,e){return p(!Number.isNaN(e),"JsonCodec allow_nan is false but NaN was encountered during encoding."),p(e!==Number.POSITIVE_INFINITY,"JsonCodec allow_nan is false but Infinity was encountered during encoding."),p(e!==Number.NEGATIVE_INFINITY,"JsonCodec allow_nan is false but -Infinity was encountered during encoding."),e}function dt(t,e){return e instanceof Object&&!Array.isArray(e)?Object.keys(e).sort().reduce((r,n)=>(r[n]=e[n],r),{}):e}var Y,J;const ve=class ve{constructor(e={}){h(this,"configuration");h(this,"kind","array_to_bytes");y(this,Y);y(this,J);this.configuration=e;const{encoding:r="utf-8",skipkeys:n=!1,ensure_ascii:s=!0,check_circular:i=!0,allow_nan:o=!0,sort_keys:a=!0,indent:d,strict:f=!0}=e;let u=e.separators;u||(d?u=[", ",": "]:u=[",",":"]),_(this,Y,{encoding:r,skipkeys:n,ensure_ascii:s,check_circular:i,allow_nan:o,indent:d,separators:u,sort_keys:a}),_(this,J,{strict:f})}static fromConfig(e){return new ve(e)}encode(e){const{indent:r,encoding:n,ensure_ascii:s,check_circular:i,allow_nan:o,sort_keys:a}=c(this,Y);p(n==="utf-8","JsonCodec does not yet support non-utf-8 encoding.");const d=[];p(i,"JsonCodec does not yet support skipping the check for circular references during encoding."),o||d.push(ut),a&&d.push(dt);const f=Array.from(e.data);f.push("|O"),f.push(e.shape);let u;d.length&&(u=(l,b)=>{let v=b;for(let A of d)v=A(l,v);return v});let m=JSON.stringify(f,u,r);return s&&(m=m.replace(/[\u007F-\uFFFF]/g,l=>{const b=`0000${l.charCodeAt(0).toString(16)}`;return`\\u${b.substring(b.length-4)}`})),new TextEncoder().encode(m)}decode(e){const{strict:r}=c(this,J);p(r,"JsonCodec does not yet support non-strict decoding.");const n=X(e),s=n.pop();n.pop(),p(s,"0D not implemented for JsonCodec.");const i=I(s,"C");return{data:n,shape:s,stride:i}}};Y=new WeakMap,J=new WeakMap;let ae=ve;function Re(t){return t instanceof Je||t instanceof fe||t instanceof $?new Proxy(t,{get(r,n){return r.get(Number(n))},set(r,n,s){return r.set(Number(n),s),!0}}):t}function ht(t,e){let r;return t.data instanceof fe||t.data instanceof $?r=new t.constructor(t.data.length,t.data.chars):r=new t.constructor(t.data.length),{data:r,shape:t.shape,stride:I(t.shape,e)}}function ft(t,e){let r=ht(t,e),n=t.shape.length,s=t.data.length,i=Array(n).fill(0),o=Re(t.data),a=Re(r.data);for(let d=0;d<s;d++){let f=0;for(let u=0;u<n;u++)f+=i[u]*r.stride[u];a[f]=o[d],i[0]+=1;for(let u=0;u<n;u++)if(i[u]===t.shape[u]){if(u+1===n)break;i[u]=0,i[u+1]+=1}}return r}function lt(t){let e=t.shape.length;return p(e===t.stride.length,"Shape and stride must have the same length."),t.stride.map((r,n)=>({stride:r,index:n})).sort((r,n)=>n.stride-r.stride).map(r=>r.index)}function _t(t,e){let r=lt(t);return p(r.length===e.length,"Orders must match"),r.every((n,s)=>n===e[s])}var W,C;const Ae=class Ae{constructor(e,r){h(this,"kind","array_to_array");y(this,W);y(this,C);let n=e.order??"C",s=r.shape.length,i=new Array(s),o=new Array(s);if(n==="C")for(let a=0;a<s;++a)i[a]=a,o[a]=a;else if(n==="F")for(let a=0;a<s;++a)i[a]=s-a-1,o[a]=s-a-1;else i=n,i.forEach((a,d)=>{p(o[a]===void 0,`Invalid permutation: ${JSON.stringify(n)}`),o[a]=d});_(this,W,i),_(this,C,o)}static fromConfig(e,r){return new Ae(e,r)}encode(e){return _t(e,c(this,C))?e:ft(e,c(this,C))}decode(e){return{data:e.data,shape:e.shape,stride:I(e.shape,c(this,W))}}};W=new WeakMap,C=new WeakMap;let ce=Ae;var V,G;const xe=class xe{constructor(e){h(this,"kind","array_to_bytes");y(this,V);y(this,G);_(this,V,e),_(this,G,I(e,"C"))}static fromConfig(e,r){return new xe(r.shape)}encode(e){throw new Error("Method not implemented.")}decode(e){let r=new TextDecoder,n=new DataView(e.buffer),s=Array(n.getUint32(0,!0)),i=4;for(let o=0;o<s.length;o++){let a=n.getUint32(i,!0);i+=4,s[o]=r.decode(e.buffer.slice(i,i+a)),i+=a}return{data:s,shape:c(this,V),stride:c(this,G)}}};V=new WeakMap,G=new WeakMap;let ue=xe;class pe{constructor(){h(this,"kind","bytes_to_bytes")}static fromConfig(e){return new pe}encode(e){throw new Error("Zlib encoding is not enabled by default. Please register a codec with `numcodecs/zlib`.")}async decode(e){const r=await Ke(e,{format:"deflate"});return new Uint8Array(r)}}function yt(){return new Map().set("blosc",()=>se(()=>import("./blosc.nNxqTOai.js"),__vite__mapDeps([0,1])).then(t=>t.default)).set("lz4",()=>se(()=>import("./lz4.COuoZ_ur.js"),__vite__mapDeps([2,1])).then(t=>t.default)).set("zstd",()=>se(()=>import("./zstd.CtzXwP91.js"),__vite__mapDeps([3,1])).then(t=>t.default)).set("gzip",()=>ye).set("zlib",()=>pe).set("transpose",()=>ce).set("bytes",()=>q).set("crc32c",()=>_e).set("vlen-utf8",()=>ue).set("json2",()=>ae).set("bitround",()=>le)}const pt=yt();function de(t){let e;return{async encode(r){e||(e=await Ce(t));for(const s of e.array_to_array)r=await s.encode(r);let n=await e.array_to_bytes.encode(r);for(const s of e.bytes_to_bytes)n=await s.encode(n);return n},async decode(r){e||(e=await Ce(t));for(let s=e.bytes_to_bytes.length-1;s>=0;s--)r=await e.bytes_to_bytes[s].decode(r);let n=await e.array_to_bytes.decode(r);for(let s=e.array_to_array.length-1;s>=0;s--)n=await e.array_to_array[s].decode(n);return n}}}async function Ce(t){let e=t.codecs.map(async i=>{var a;let o=await((a=pt.get(i.name))==null?void 0:a());return p(o,`Unknown codec: ${i.name}`),{Codec:o,meta:i}}),r=[],n,s=[];for await(let{Codec:i,meta:o}of e){let a=i.fromConfig(o.configuration,t);switch(a.kind){case"array_to_array":r.push(a);break;case"array_to_bytes":n=a;break;default:s.push(a)}}return n||(p(gt(t),`Cannot encode ${t.data_type} to bytes without a codec`),n=q.fromConfig({endian:"little"},t)),{array_to_array:r,array_to_bytes:n,bytes_to_bytes:s}}function gt(t){return t.data_type!=="v2:object"}class H extends Error{constructor(e,r={}){super(`Node not found: ${e}`,r),this.name="NodeNotFoundError"}}class ge extends Error{constructor(e){super(`Missing key: ${e}`),this.name="KeyError"}}const Oe=18446744073709551615n;function mt(t,e,r,n){p(t.store.getRange,"Store does not support range requests");let s=t.store.getRange.bind(t.store),i=e.map((d,f)=>d/n.chunk_shape[f]),o=de({data_type:"uint64",shape:[...i,2],codecs:n.index_codecs}),a={};return async d=>{let f=d.map((E,T)=>Math.floor(E/i[T])),u=t.resolve(r(f)).path,m;if(u in a)m=a[u];else{let E=4,T=16*i.reduce((He,Ze)=>He*Ze,1),Z=await s(u,{suffixLength:T+E});m=a[u]=Z?await o.decode(Z):null}if(m===null)return;let{data:l,shape:b,stride:v}=m,A=d.map((E,T)=>E%b[T]).reduce((E,T,Z)=>E+T*v[Z],0),U=l[A],g=l[A+1];if(!(U===Oe&&g===Oe))return s(u,{offset:Number(U),length:Number(g)})}}class O{constructor(e,r="/"){h(this,"store");h(this,"path");this.store=e,this.path=r}resolve(e){let r=new URL(`file://${this.path.endsWith("/")?this.path:`${this.path}/`}`);return new O(this.store,decodeURIComponent(new URL(e,r).pathname))}}var K;class me extends O{constructor(r,n,s){super(r,n);h(this,"kind","group");y(this,K);_(this,K,s)}get attrs(){return c(this,K).attributes}}K=new WeakMap;function Me(t){var r;const e=t.find(n=>n.name==="transpose");return((r=e==null?void 0:e.configuration)==null?void 0:r.order)??"C"}const M=Symbol("zarrita.context");function bt(t){return t[M]}function wt(t,e){let{configuration:r}=e.codecs.find(at)??{},n={encode_chunk_key:rt(e.chunk_key_encoding),TypedArray:We(e.data_type),fill_value:e.fill_value};if(r){let i=Me(r.codecs);return{...n,kind:"sharded",chunk_shape:r.chunk_shape,codec:de({data_type:e.data_type,shape:r.chunk_shape,codecs:r.codecs}),get_strides(o){return I(o,i)},get_chunk_bytes:mt(t,e.chunk_grid.configuration.chunk_shape,n.encode_chunk_key,r)}}let s=Me(e.codecs);return{...n,kind:"regular",chunk_shape:e.chunk_grid.configuration.chunk_shape,codec:de({data_type:e.data_type,shape:e.chunk_grid.configuration.chunk_shape,codecs:e.codecs}),get_strides(i){return I(i,s)},async get_chunk_bytes(i,o){let a=n.encode_chunk_key(i),d=t.resolve(a).path;return t.store.get(d,o)}}}var Pe,Fe,N,De;let ee=(De=class extends(Fe=O,Pe=M,Fe){constructor(r,n,s){super(r,n);h(this,"kind","array");y(this,N);h(this,Pe);_(this,N,{...s,fill_value:Ve(s)}),this[M]=wt(this,s)}get attrs(){return c(this,N).attributes}get shape(){return c(this,N).shape}get chunks(){return this[M].chunk_shape}get dtype(){return c(this,N).data_type}async getChunk(r,n){let s=this[M],i=await s.get_chunk_bytes(r,n);if(!i){let o=s.chunk_shape.reduce((d,f)=>d*f,1),a=new s.TypedArray(o);return a.fill(s.fill_value),{data:a,shape:s.chunk_shape,stride:s.get_strides(s.chunk_shape)}}return s.codec.decode(i)}is(r){return ot(this.dtype,r)}},N=new WeakMap,De);function*kt(t,e,r=1){e===void 0&&(e=t,t=0);for(let n=t;n<e;n+=r)yield n}function*Et(...t){if(t.length===0)return;const e=t.map(n=>n[Symbol.iterator]()),r=e.map(n=>n.next());if(r.some(n=>n.done))throw new Error("Input contains an empty iterator.");for(let n=0;;){if(r[n].done){if(e[n]=t[n][Symbol.iterator](),r[n]=e[n].next(),++n>=e.length)return}else yield r.map(({value:s})=>s),n=0;r[n]=e[n].next()}}function vt({start:t,stop:e,step:r},n){if(r===0)throw new Error("slice step cannot be zero");r=r??1;const s=r<0,[i,o]=s?[-1,n-1]:[0,n];return t===null?t=s?o:i:t<0?(t+=n,t<i&&(t=i)):t>o&&(t=o),e===null?e=s?i:o:e<0?(e+=n,e<i&&(e=i)):e>o&&(e=o),[t,e,r]}function $e(t,e,r=null){return e===void 0&&(e=t,t=null),{start:t,stop:e,step:r}}function At(){const t=[];return{add:e=>t.push(e()),onIdle:()=>Promise.all(t)}}class be extends Error{constructor(e){super(e),this.name="IndexError"}}function xt(t,e){throw new be(`too many indicies for array; expected ${e.length}, got ${t.length}`)}function Tt(t){throw new be(`index out of bounds for dimension with length ${t}`)}function Nt(){throw new be("only slices with step >= 1 are supported")}function It(t,e){t.length>e.length&&xt(t,e)}function Ut(t,e){return t=Math.trunc(t),t<0&&(t=e+t),(t>=e||t<0)&&Tt(e),t}class St{constructor({dim_sel:e,dim_len:r,dim_chunk_len:n}){h(this,"dim_sel");h(this,"dim_len");h(this,"dim_chunk_len");h(this,"nitems");e=Ut(e,r),this.dim_sel=e,this.dim_len=r,this.dim_chunk_len=n,this.nitems=1}*[Symbol.iterator](){const e=Math.floor(this.dim_sel/this.dim_chunk_len),r=e*this.dim_chunk_len,n=this.dim_sel-r;yield{dim_chunk_ix:e,dim_chunk_sel:n}}}class ze{constructor({dim_sel:e,dim_len:r,dim_chunk_len:n}){h(this,"start");h(this,"stop");h(this,"step");h(this,"dim_len");h(this,"dim_chunk_len");h(this,"nitems");h(this,"nchunks");const[s,i,o]=vt(e,r);this.start=s,this.stop=i,this.step=o,this.step<1&&Nt(),this.dim_len=r,this.dim_chunk_len=n,this.nitems=Math.max(0,Math.ceil((this.stop-this.start)/this.step)),this.nchunks=Math.ceil(this.dim_len/this.dim_chunk_len)}*[Symbol.iterator](){const e=Math.floor(this.start/this.dim_chunk_len),r=Math.ceil(this.stop/this.dim_chunk_len);for(const n of kt(e,r)){const s=n*this.dim_chunk_len,i=Math.min(this.dim_len,(n+1)*this.dim_chunk_len),o=i-s;let a=0,d=0;if(this.start<s){const b=(s-this.start)%this.step;b&&(d+=this.step-b),a=Math.ceil((s-this.start)/this.step)}else d=this.start-s;const f=this.stop>i?o:this.stop-s,u=[d,f,this.step],m=Math.ceil((f-d)/this.step),l=[a,a+m,1];yield{dim_chunk_ix:n,dim_chunk_sel:u,dim_out_sel:l}}}}function Lt(t,e){let r=[];return t===null?r=e.map(n=>$e(null)):Array.isArray(t)&&(r=t.map(n=>n??$e(null))),It(r,e),r}class Rt{constructor({selection:e,shape:r,chunk_shape:n}){h(this,"dim_indexers");h(this,"shape");this.dim_indexers=Lt(e,r).map((s,i)=>new(typeof s=="number"?St:ze)({dim_sel:s,dim_len:r[i],dim_chunk_len:n[i]})),this.shape=this.dim_indexers.filter(s=>s instanceof ze).map(s=>s.nitems)}*[Symbol.iterator](){for(const e of Et(...this.dim_indexers)){const r=e.map(s=>s.dim_chunk_ix),n=e.map(s=>"dim_out_sel"in s?{from:s.dim_chunk_sel,to:s.dim_out_sel}:{from:s.dim_chunk_sel,to:null});yield{chunk_coords:r,mapping:n}}}}function Ct(t,e){return"get"in t?t.get(e):t[e]}async function Ot(t,e,r,n){var d;let s=bt(t),i=new Rt({selection:e,shape:t.shape,chunk_shape:t.chunks}),o=n.prepare(new s.TypedArray(i.shape.reduce((f,u)=>f*u,1)),i.shape,s.get_strides(i.shape)),a=((d=r.create_queue)==null?void 0:d.call(r))??At();for(const{chunk_coords:f,mapping:u}of i)a.add(async()=>{let{data:m,shape:l,stride:b}=await t.getChunk(f,r.opts),v=n.prepare(m,l,b);n.set_from_chunk(o,v,u)});return await a.onIdle(),i.shape.length===0?Ct(o.data,0):o}function we(t,e=0,r){let n=r??t.length-e;return{length:n,subarray(s,i=n){return we(t,e+s,i-s)},set(s,i=0){for(let o=0;o<s.length;o++)t[e+i+o]=s.get(o)},get(s){return t[e+s]}}}function ie(t){return globalThis.Array.isArray(t.data)?{data:we(t.data),stride:t.stride,bytes_per_element:1}:{data:new Uint8Array(t.data.buffer,t.data.byteOffset,t.data.byteLength),stride:t.stride,bytes_per_element:t.data.BYTES_PER_ELEMENT}}function Mt(t){return"chars"in t?t.constructor.bind(null,t.chars):t.constructor}function $t(t,e){if(globalThis.Array.isArray(t.data))return we([e]);let r=Mt(t.data),n=new r([e]);return new Uint8Array(n.buffer,n.byteOffset,n.byteLength)}const zt={prepare(t,e,r){return{data:t,shape:e,stride:r}},set_scalar(t,e,r){let n=ie(t);he(n,e,$t(t,r),n.bytes_per_element)},set_from_chunk(t,e,r){let n=ie(t);Q(n,ie(e),n.bytes_per_element,r)}};async function Gt(t,e=null,r={}){return Ot(t,e,r,zt)}function Xe(t,e,r){return r<0&&e<t?Math.floor((t-e-1)/-r)+1:t<e?Math.floor((e-t-1)/r)+1:0}function he(t,e,r,n){if(e.length===0){t.data.set(r,0);return}const[s,...i]=e,[o,...a]=t.stride;if(typeof s=="number"){const l=t.data.subarray(o*s*n);he({data:l,stride:a},i,r,n);return}const[d,f,u]=s,m=Xe(d,f,u);if(i.length===0){for(let l=0;l<m;l++)t.data.set(r,o*(d+u*l)*n);return}for(let l=0;l<m;l++){const b=t.data.subarray(o*(d+u*l)*n);he({data:b,stride:a},i,r,n)}}function Q(t,e,r,n){const[s,...i]=n,[o,...a]=t.stride,[d,...f]=e.stride;if(s.from===null){if(i.length===0){t.data.set(e.data.subarray(0,r),s.to*r);return}Q({data:t.data.subarray(o*s.to*r),stride:a},e,r,i);return}if(s.to===null){if(i.length===0){let g=s.from*r;t.data.set(e.data.subarray(g,g+r),0);return}Q(t,{data:e.data.subarray(d*s.from*r),stride:f},r,i);return}const[u,m,l]=s.to,[b,v,A]=s.from,U=Xe(u,m,l);if(i.length===0){if(l===1&&A===1&&o===1&&d===1){let g=b*r,E=U*r;t.data.set(e.data.subarray(g,g+E),u*r);return}for(let g=0;g<U;g++){let E=d*(b+A*g)*r;t.data.set(e.data.subarray(E,E+r),o*(u+l*g)*r)}return}for(let g=0;g<U;g++)Q({data:t.data.subarray(o*(u+g*l)*r),stride:a},{data:e.data.subarray(d*(b+g*A)*r),stride:f},r,i)}let te=Bt();function Bt(){let t=new WeakMap;function e(r){let n=t.get(r)??{v2:0,v3:0};return t.set(r,n),n}return{increment(r,n){e(r)[n]+=1},version_max(r){let n=e(r);return n.v3>n.v2?"v3":"v2"}}}async function jt(t){let e=await t.store.get(t.resolve(".zattrs").path);return e?X(e):{}}async function Pt(t,e={}){let r="store"in t?t:new O(t),n={};return(e.attrs??!0)&&(n=await jt(r)),e.kind==="array"?Be(r,n):e.kind==="group"?je(r,n):Be(r,n).catch(s=>(Ge(s,H),je(r,n)))}async function Be(t,e){let{path:r}=t.resolve(".zarray"),n=await t.store.get(r);if(!n)throw new H("v2 array",{cause:new ge(r)});return te.increment(t.store,"v2"),new ee(t.store,t.path,st(X(n),e))}async function je(t,e){let{path:r}=t.resolve(".zgroup"),n=await t.store.get(r);if(!n)throw new H("v2 group",{cause:new ge(r)});return te.increment(t.store,"v2"),new me(t.store,t.path,it(X(n),e))}async function Ft(t){let{store:e,path:r}=t.resolve("zarr.json"),n=await t.store.get(r);if(!n)throw new H("v3 array or group",{cause:new ge(r)});let s=X(n);return s.node_type==="array"&&(s.fill_value=Ve(s)),s.node_type==="array"?new ee(e,t.path,s):new me(e,t.path,s)}async function Dt(t,e={}){let r="store"in t?t:new O(t),n=await Ft(r);if(te.increment(r.store,"v3"),e.kind===void 0||e.kind==="array"&&n instanceof ee||e.kind==="group"&&n instanceof me)return n;let s=n instanceof ee?"array":"group";throw new Error(`Expected node of kind ${e.kind}, found ${s}.`)}async function S(t,e={}){let r="store"in t?t.store:t,n=te.version_max(r),s=n==="v2"?S.v2:S.v3,i=n==="v2"?S.v3:S.v2;return s(t,e).catch(o=>(Ge(o,H),i(t,e)))}S.v2=Pt;S.v3=Dt;export{Wt as F,Gt as g,S as o,$e as s};

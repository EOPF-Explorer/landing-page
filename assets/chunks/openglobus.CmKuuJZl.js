import{Globe as Q,LonLat as R,Vec3 as $,OpenStreetMap as X,XYZ as K,WMS as J,Vector as W,Entity as Y,CanvasTiles as I}from"./og.es.BUTD8K8h.js";import{L as N,o as ee,p as te,q as ne,s as T,M as A,u as x,v as re,X as se,w as ie,x as oe,y as le}from"./XYZ.CeC_mTYy.js";import"./index.Du0sVlOV.js";import{O as ae,t as ce,g as F,i as O}from"./proj.DZpM1HQc.js";import{a as ue,A as fe,b as k}from"./lit-element.CBn2YVps.js";import{O as ge}from"./OSM.CvXshCtN.js";import{T as de}from"./TileWMS.ChapPYOL.js";import{V as he}from"./Vector.BaIzVGOT.js";import{g as pe}from"./commonjsHelpers.BosuxZz1.js";import{E as ye,u as me,l as be}from"./Polygon.DHQbtAHt.js";function P(e,t,n=void 0){return n||(n="EPSG:4326"),ae(e,t,n)}function Ye(e,t,n=void 0){return n||(n="EPSG:4326"),ce(e,t,n)}class _e extends ue{static get properties(){return{feature:{attribute:!1,property:!0,type:Object},propertyTransform:{attribute:!1,property:!0,type:Function}}}constructor(){super(),this.feature=null,this.propertyTransform=(t,n)=>t}render(){return this.feature?k` <style>
            ul {
              margin: 0;
              padding: 1rem 1rem 1rem 2rem;
              border-radius: 0.5rem;
              max-width: 250px;
              font-size: small;
              background-color: var(--inverse-surface);
              color: var(--inverse-on-surface);
              box-shadow: 0 0.25rem 0.5rem 0 rgb(0 0 0 / 0.4);
              line-height: normal;
              white-space: normal;
            }
            span {
              font-weight: bold;
            }
          </style>
          <ul>
            ${Object.entries(this.feature.getProperties()).map(([t,n])=>this.propertyTransform({key:t,value:n},this.feature)).filter(t=>t).map(({key:t,value:n})=>k`<li><span>${t}</span>: ${n}</li>`)}
          </ul>`:fe}}customElements.get("eox-map-tooltip")||customElements.define("eox-map-tooltip",_e);var q=16,_=Ae(),Se=new RegExp('(\\\\)?"@__(F|R|D|M|S|A|U|I|B|L)-'+_+'-(\\d+)__@"',"g"),Ee=/\{\s*\[native code\]\s*\}/g,Ce=/function.*?\(/,ve=/.*?=>.*?/,we=/[<>\/\u2028\u2029]/g,Fe=/<\/script[^>]*>/gi,Le=["*","async"],Re={"<":"\\u003C",">":"\\u003E","/":"\\u002F","\u2028":"\\u2028","\u2029":"\\u2029"};function Ne(e){return Re[e]}function Te(e){return e=e.replace(Fe,function(t){return t.replace(/</g,"\\u003C").replace(/\//g,"\\u002F").replace(/>/g,"\\u003E")}),e=e.replace(/\u2028/g,"\\u2028"),e=e.replace(/\u2029/g,"\\u2029"),e}function Ae(){for(var e=crypto.getRandomValues(new Uint8Array(q)),t="",n=0;n<q;++n)t+=e[n].toString(16);return t}function xe(e){var t=[];for(var n in e)typeof e[n]=="function"&&t.push(n);for(var r=0;r<t.length;r++)delete e[t[r]]}var Oe=function e(t,n){n||(n={}),(typeof n=="number"||typeof n=="string")&&(n={space:n});var r=[],s=[],i=[],c=[],a=[],f=[],u=[],l=[],h=[],p=[];function y(m,g){if(n.ignoreFunction&&xe(g),!g&&g!==void 0&&g!==BigInt(0))return g;var o=this[m],d=typeof o;if(d==="object"){if(o instanceof RegExp)return"@__R-"+_+"-"+(s.push(o)-1)+"__@";if(o instanceof Date)return"@__D-"+_+"-"+(i.push(o)-1)+"__@";if(o instanceof Map)return"@__M-"+_+"-"+(c.push(o)-1)+"__@";if(o instanceof Set)return"@__S-"+_+"-"+(a.push(o)-1)+"__@";if(o instanceof Array){var E=o.filter(function(){return!0}).length!==o.length;if(E)return"@__A-"+_+"-"+(f.push(o)-1)+"__@"}if(o instanceof URL)return"@__L-"+_+"-"+(p.push(o)-1)+"__@"}return d==="function"?"@__F-"+_+"-"+(r.push(o)-1)+"__@":d==="undefined"?"@__U-"+_+"-"+(u.push(o)-1)+"__@":d==="number"&&!isNaN(o)&&!isFinite(o)?"@__I-"+_+"-"+(l.push(o)-1)+"__@":d==="bigint"?"@__B-"+_+"-"+(h.push(o)-1)+"__@":g}function S(m,g){var o=m.toString();if(Ee.test(o))throw new TypeError("Serializing native function: "+m.name);if(g&&g.unsafe!==!0&&(o=Te(o)),Ce.test(o)||ve.test(o))return o;var d=o.indexOf("("),E=o.substr(0,d).trim().split(" ").filter(function(w){return w.length>0}),v=E.filter(function(w){return Le.indexOf(w)===-1});return v.length>0?(E.indexOf("async")>-1?"async ":"")+"function"+(E.join("").indexOf("*")>-1?"*":"")+o.substr(d):o}if(n.ignoreFunction&&typeof t=="function"&&(t=void 0),t===void 0)return String(t);var b;return n.isJSON&&!n.space?b=JSON.stringify(t):b=JSON.stringify(t,n.isJSON?null:y,n.space),typeof b!="string"?String(b):(n.unsafe!==!0&&(b=b.replace(we,Ne)),r.length===0&&s.length===0&&i.length===0&&c.length===0&&a.length===0&&f.length===0&&u.length===0&&l.length===0&&h.length===0&&p.length===0?b:b.replace(Se,function(m,g,o,d){if(g)return m;if(o==="D")return'new Date("'+i[d].toISOString()+'")';if(o==="R")return"new RegExp("+e(s[d].source)+', "'+s[d].flags+'")';if(o==="M")return"new Map("+e(Array.from(c[d].entries()),n)+")";if(o==="S")return"new Set("+e(Array.from(a[d].values()),n)+")";if(o==="A")return"Array.prototype.slice.call("+e(Object.assign({length:f[d].length},f[d]),n)+")";if(o==="U")return"undefined";if(o==="I")return l[d];if(o==="B")return'BigInt("'+h[d]+'")';if(o==="L")return"new URL("+e(p[d].toString(),n)+")";var E=r[d];return S(E,n)}))};const et=pe(Oe);function ke(e,t){return U(e.map.getLayers().getArray()).find(r=>r.get("id")===t)}function U(e){const t=[];t.push(...e);let n=t.filter(r=>r instanceof N);for(;n.length;){const r=[];for(let s=0;s<n.length;s++){const i=n[s].getLayers().getArray();t.push(...i),r.push(...i.filter(c=>c instanceof N))}n=r}return t}const z=["fullscreenchange","webkitfullscreenchange"],G={ENTERFULLSCREEN:"enterfullscreen",LEAVEFULLSCREEN:"leavefullscreen"};class B extends ee{constructor(t){t=t||{},super({element:document.createElement("div"),target:t.target}),this.on,this.once,this.un,this.keys_=t.keys!==void 0?t.keys:!1,this.source_=t.source,this.isInFullscreen_=!1,this.boundHandleMapTargetChange_=this.handleMapTargetChange_.bind(this),this.cssClassName_=t.className!==void 0?t.className:"ol-full-screen",this.documentListeners_=[],this.activeClassName_=t.activeClassName!==void 0?t.activeClassName.split(" "):[this.cssClassName_+"-true"],this.inactiveClassName_=t.inactiveClassName!==void 0?t.inactiveClassName.split(" "):[this.cssClassName_+"-false"];const n=t.label!==void 0?t.label:"⤢";this.labelNode_=typeof n=="string"?document.createTextNode(n):n;const r=t.labelActive!==void 0?t.labelActive:"×";this.labelActiveNode_=typeof r=="string"?document.createTextNode(r):r;const s=t.tipLabel?t.tipLabel:"Toggle full-screen";this.button_=document.createElement("button"),this.button_.title=s,this.button_.setAttribute("type","button"),this.button_.appendChild(this.labelNode_),this.button_.addEventListener(ye.CLICK,this.handleClick_.bind(this),!1),this.setClassName_(this.button_,this.isInFullscreen_),this.element.className=`${this.cssClassName_} ${te} ${ne}`,this.element.appendChild(this.button_)}handleClick_(t){t.preventDefault(),this.handleFullScreen_()}handleFullScreen_(){const t=this.getMap();if(!t)return;const n=t.getOwnerDocument();if(M(n))if(V(n))ze(n);else{let r;this.source_?r=typeof this.source_=="string"?n.getElementById(this.source_):this.source_:r=t.getTargetElement(),this.keys_?qe(r):D(r)}}handleFullScreenChange_(){const t=this.getMap();if(!t)return;const n=this.isInFullscreen_;this.isInFullscreen_=V(t.getOwnerDocument()),n!==this.isInFullscreen_&&(this.setClassName_(this.button_,this.isInFullscreen_),this.isInFullscreen_?(T(this.labelActiveNode_,this.labelNode_),this.dispatchEvent(G.ENTERFULLSCREEN)):(T(this.labelNode_,this.labelActiveNode_),this.dispatchEvent(G.LEAVEFULLSCREEN)),t.updateSize())}setClassName_(t,n){n?(t.classList.remove(...this.inactiveClassName_),t.classList.add(...this.activeClassName_)):(t.classList.remove(...this.activeClassName_),t.classList.add(...this.inactiveClassName_))}setMap(t){const n=this.getMap();n&&n.removeChangeListener(A.TARGET,this.boundHandleMapTargetChange_),super.setMap(t),this.handleMapTargetChange_(),t&&t.addChangeListener(A.TARGET,this.boundHandleMapTargetChange_)}handleMapTargetChange_(){const t=this.documentListeners_;for(let r=0,s=t.length;r<s;++r)me(t[r]);t.length=0;const n=this.getMap();if(n){const r=n.getOwnerDocument();M(r)?this.element.classList.remove(x):this.element.classList.add(x);for(let s=0,i=z.length;s<i;++s)t.push(be(r,z[s],this.handleFullScreenChange_,this));this.handleFullScreenChange_()}}}function M(e){const t=e.body;return!!(t.webkitRequestFullscreen||t.requestFullscreen&&e.fullscreenEnabled)}function V(e){return!!(e.webkitIsFullScreen||e.fullscreenElement)}function D(e){e.requestFullscreen?e.requestFullscreen():e.webkitRequestFullscreen&&e.webkitRequestFullscreen()}function qe(e){e.webkitRequestFullscreen?e.webkitRequestFullscreen():D(e)}function ze(e){e.exitFullscreen?e.exitFullscreen():e.webkitExitFullscreen&&e.webkitExitFullscreen()}const tt=(e,t,n)=>{const s=U(t.map.getLayers().getArray()).filter(i=>i.get("type")!=="Group").map(i=>i.get("_jsonDefinition")).filter(Boolean);return Array.from({length:e},()=>{const i=document.createElement("eox-map");return Object.assign(i.style,{width:"256px",height:"256px",position:"absolute",top:"-9999px",left:"-9999px"}),Object.assign(i,{projection:"EPSG:3857",layers:s}),n.appendChild(i),{tileMap:i,tileQueue:[],loadNextTile(){const c=this.tileQueue[0];H(i,c.layerId,c,this)}}})};async function H(e,t,n,r){const s=e.map;if(!s){e.addEventListener("mapmounted",()=>H(e,t,n,r),{once:!0});return}s.getLayers().forEach(a=>{a.setVisible(a.get("id")===t)});const c=re().getTileCoordExtent([n.tile.z,n.tile.x,n.tile.y]);s.getView().fit(c,{callback:()=>{s.once("rendercomplete",function(){const a=document.createElement("canvas"),f=s.getSize();a.width=f[0],a.height=f[1];const u=a.getContext("2d");Array.prototype.forEach.call(s.getViewport().querySelectorAll(".ol-layer canvas, canvas.ol-layer"),function(l){if(l.width>0){const h=l.parentNode.style.opacity||l.style.opacity;u.globalAlpha=h===""?1:Number(h);let p;const y=l.style.transform;y?p=y.match(/^matrix\(([^(]*)\)$/)[1].split(",").map(Number):p=[parseFloat(l.style.width)/l.width,0,0,parseFloat(l.style.height)/l.height,0,0],CanvasRenderingContext2D.prototype.setTransform.apply(u,p);const S=l.parentNode.style.backgroundColor;S&&(u.fillStyle=S,u.fillRect(0,0,l.width,l.height)),u.drawImage(l,0,0)}}),u.globalAlpha=1,u.setTransform(1,0,0,1,0,0),n.callback(a),r.tileQueue.shift(),r.tileQueue.length&&r.loadNextTile()}),s.renderSync()}})}function Ge(e,t,n,r){const{x:s,y:i,z:c}=n,a={layerId:t,tile:n,callback:r};let f=0,u=null;for(let l=0;l<e.length;l++){const h=e[l];if(!h.tileQueue.length){u=h;break}const p=h.tileQueue[h.tileQueue.length-1],y=Math.abs(p.tile.x-s)+Math.abs(p.tile.y-i)+Math.abs(p.tile.z-c);(f===0||y<f)&&(f=y,u=h)}return u.tileQueue.push(a),u}let C;function Me(e,t){const n={},r=oe(),s=le();s.properties=t||{};const i={fillColor:"fill-color",lineColor:"stroke-color",strokeColor:"stroke-color",lineWidth:"stroke-width",strokeWidth:"stroke-width"};for(const[c,a]of Object.entries(i)){const f=e[a];if(f!==void 0)if(Array.isArray(f))try{const u=ie(f,7,r);n[c]=u(s)}catch(u){console.error(`Error evaluating style expression for ${a}:`,u)}else n[c]=f}return n}const nt=({EOxMap:e,target:t,mapPool:n})=>{C=new Q({target:t,layers:e.getFlatLayersArray(e.map.getLayers().getArray()).filter(a=>a.get("type")!=="Group").map(a=>Ie(a,n)).filter(a=>a!==void 0),sun:{active:!1},atmosphereEnabled:!1,transparentBackground:!0,resourcesSrc:"https://cdn.jsdelivr.net/npm/@openglobus/og@0.27.21/lib/res",fontsSrc:"https://cdn.jsdelivr.net/npm/@openglobus/og@0.27.21/lib/res/fonts"});const r=2105e4/Math.pow(2,e.map.getView().getZoom()-1),s=e.map.getView().getCenter(),i=P(s,e.map.getView().getProjection().getCode(),"EPSG:4326");C.planet.camera.setLonLat(new R(i[0],i[1],r),new R(i[0],i[1],0),$.NORTH);const c=document.createElement("style");return c.textContent=`
    .og-inner {
      height: 100%;
    }
    .og-inner *:not(canvas) {
      display: none !important;
    }
  `,t.appendChild(c),C},Ve=()=>{C&&C.planet.layers.forEach(e=>{e instanceof I&&(e.abortLoading(),e.animated=!0,setTimeout(()=>e.animated=!1,200))})},Ie=(e,t)=>{const n=e.getSource&&e.getSource(),r=e.get("id");if(n instanceof ge)return new X(r,{isBaseLayer:e.get("base"),visibility:e.getVisible(),opacity:e.getOpacity()});if(n instanceof se)return new K(r,{isBaseLayer:e.get("base"),url:n.getUrls()[0],visibility:e.getVisible(),opacity:e.getOpacity()});if(n instanceof de){const s=n.getParams(),c=n.getUrls()[0],a=s.LAYERS||s.layers||"default";return new J(r,{isBaseLayer:e.get("base"),layers:a,url:c,visibility:e.getVisible(),opacity:e.getOpacity(),version:s.VERSION||s.Version||"1.1.1",extra:{...s}})}if(n instanceof he&&n.getUrl()){let s;if(fetch(n.getUrl().toString()).then(i=>i.json()).then(i=>{const c=i.crs;if(c&&(c.type=="name"?s=F(c.properties.name):c.type==="EPSG"&&(s=F("EPSG:"+c.properties.code))),s&&O(s,F("EPSG:4326"))||!c){const u=C.planet.getLayerByName(r);u&&C.planet.removeLayer(u);const l=new W(r,{visibility:e.getVisible(),opacity:e.getOpacity(),isBaseLayer:e.get("base")});l.addTo(C.planet);const h=e.getStyle();var a=i.features;for(let p=0;p<a.length;p++){var f=a[p];const y=Me(h,f.properties);l.add(new Y({geometry:{type:f.geometry.type,coordinates:f.geometry.coordinates,style:y}}))}return l}else return}),s&&O(s,F("EPSG:4326")))return}return new I(r,{opacity:e.getOpacity(),visibility:e.getVisible(),async drawTile(s,i){if(!s.segment)return;const c={x:s.segment.tileX,y:s.segment.tileY,z:s.segment.tileZoom},a=Ge(t,e.get("id"),c,f=>{var u;(u=s.segment)!=null&&u.initialized&&i(f)});a.tileQueue.length===1&&a.loadNextTile()}})},rt=e=>{var n,r,s,i,c,a,f,u;if(e.shadowRoot){let l=e.shadowRoot.querySelector("#globe");l||(l=document.createElement("div"),l.id="globe",l.style.width="100%",l.style.height="100%",l.style.display="block",(n=e.renderRoot)==null||n.appendChild(l)),e.registerProjectionFromCode("EPSG:3857"),e.globe=window.eoxMapGlobe.create({EOxMap:e,target:l}),e.shadowRoot.querySelector("#map").style.display="none",e.globeEnabled=!0}const t=(r=e.shadowRoot)==null?void 0:r.querySelectorAll(".ol-control");if(t&&t.forEach(l=>{e.shadowRoot.querySelector("#globe").appendChild(l)}),(s=e.controls)!=null&&s.Zoom){const l=(i=e.shadowRoot)==null?void 0:i.querySelector(".ol-zoom");l&&(l.style.display="block");const h=(c=e.shadowRoot)==null?void 0:c.querySelector(".ol-zoom-in"),p=(a=e.shadowRoot)==null?void 0:a.querySelector(".ol-zoom-out"),y=m=>{const g=e.globe.planet.camera;g.stopFlying();const o=250;let d=null;const E=v=>{if(d||(d=v),(v-d)/o<1){const L=g.getHeight();if(L>0){const Z=(L>2e6?.5:.3)/(o/16.67),j=L*Z*m;g.slide(0,0,-j),g.update()}requestAnimationFrame(E)}};requestAnimationFrame(E)},S=m=>{m.stopImmediatePropagation(),e.globe.renderer.controls.navigation.stop(),y(1)},b=m=>{m.stopImmediatePropagation(),e.globe.renderer.controls.navigation.stop(),y(-1)};h.addEventListener("click",S),p.addEventListener("click",b),e.globe.zoomInHandler=S,e.globe.zoomOutHandler=b}if((f=e.controls)!=null&&f.Rotate){const l=()=>{const p=e.globe.planet.getCartesianFromPixelTerrain(e.globe.renderer.handler.getCenter());p&&e.globe.planet.flyCartesian(p.normal().scaleTo(e.globe.planet.camera.eye.length()),{completeCallback:()=>e.globe.planet.camera.look(p)})},h=e.shadowRoot.querySelector(".ol-rotate");h.addEventListener("click",l),h.classList.remove("ol-hidden"),e.globe.rotateHandler=l}if((u=e.controls)!=null&&u.FullScreen){const l=e.map.getControls().getArray().find(h=>h instanceof B);l&&(l.source_=e.shadowRoot.querySelector("#globe"))}},st=e=>{if(e.globe){const t=e.globe,n=t.planet;let r=n.getCartesianFromPixelTerrain(t.renderer.handler.getCenter());const s=r?r.normal().scaleTo(r.length()+r.distance(n.camera.eye)):n.camera.eye;n.flyCartesian(s,{amplitude:0,completeCallback:()=>{var p,y,S,b,m;r&&n.camera.look(r);const i=t.planet.camera.getLonLat(),c=Math.log2(2105e4/i.height)+1,a=[i.lon,i.lat],f=P(a,"EPSG:4326",e.OLprojection);e.map.getView().setCenter(f),e.map.getView().setZoom(c);const u=(p=e.shadowRoot)==null?void 0:p.querySelectorAll(".ol-control");if(u&&u.forEach(g=>{e.shadowRoot.querySelector(".ol-viewport").appendChild(g)}),(y=e.controls)!=null&&y.Zoom){if(e.globe.zoomInHandler){const o=e.shadowRoot.querySelector(".ol-zoom-in"),d=e.shadowRoot.querySelector(".ol-zoom-out");o.removeEventListener("click",e.globe.zoomInHandler),d.removeEventListener("click",e.globe.zoomOutHandler)}const g=(S=e.shadowRoot)==null?void 0:S.querySelector(".ol-zoom");g&&(g.style.display="block")}if((b=e.controls)!=null&&b.Rotate&&e.globe.rotateHandler){const g=e.shadowRoot.querySelector(".ol-rotate");g.removeEventListener("click",e.globe.rotateHandler),g.classList.add("ol-hidden")}if((m=e.controls)!=null&&m.FullScreen){const g=e.map.getControls().getArray().find(o=>o instanceof B);g&&(g.source_=e.shadowRoot.querySelector("#map"))}e.globe=null;const l=e.shadowRoot.querySelector("#globe");l&&(l.style.display="none",l.remove());const h=e.shadowRoot.querySelector("#map");h&&(h.style.display=""),e.globeEnabled=!1}})}};function Pe(e,t){let n;return function(...s){const i=()=>{clearTimeout(n),e(...s)};clearTimeout(n),n=setTimeout(i,t)}}const Ue=(e,t,n)=>{const r=Pe(()=>{Ve()},200);e.on("change",()=>{if(e.styleVariables_){const s=e.get("id"),i=e.styleVariables_;if(!s||!i)return;n.forEach(c=>{c.tileQueue.length=0;const a=ke(c.tileMap,s);a&&a.updateStyleVariables&&a.updateStyleVariables(i)}),r()}}),e.on("propertychange",({key:s})=>{const i=t.planet.getLayerByName(e.get("id"));if(i)switch(s){case"visible":i.setVisibility(e.getVisible());break;case"opacity":i.opacity=e.getOpacity();break}})},Be=(e,t,n)=>{e.forEach(r=>{r.get("id")&&Ue(r,t,n),r.getLayers&&Be(r.getLayers().getArray(),t,n)})};export{B as F,nt as a,P as b,tt as c,st as d,rt as e,U as f,ke as g,Be as p,Ve as r,et as s,Ye as t};

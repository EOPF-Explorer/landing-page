import{d as A,S as p,C as T,e as x}from"./XYZ.CeC_mTYy.js";import{g as f,m as g,V as D,s as m,l as y,E as G,O as b,u as F,t as w,T as L,B as S}from"./Polygon.DHQbtAHt.js";import{p as v,q as O,E as U,F as X}from"./proj.DZpM1HQc.js";import{R as _}from"./Feature.sRpZ_lK_.js";let Y=!1;function K(l,e,t,s,n,r,i){const a=new XMLHttpRequest;a.open("GET",typeof l=="function"?l(t,s,n):l,!0),e.getType()=="arraybuffer"&&(a.responseType="arraybuffer"),a.withCredentials=Y,a.onload=function(o){if(!a.status||a.status>=200&&a.status<300){const h=e.getType();try{let u;h=="text"||h=="json"?u=a.responseText:h=="xml"?u=a.responseXML||a.responseText:h=="arraybuffer"&&(u=a.response),u?r(e.readFeatures(u,{extent:t,featureProjection:n}),e.readProjection(u)):i()}catch{i()}}else i()},a.onerror=i,a.send()}function I(l,e){return function(t,s,n,r,i){K(l,e,t,s,n,(a,o)=>{this.addFeatures(a),r!==void 0&&r(a)},()=>{this.changed(),i!==void 0&&i()})}}function N(l,e){return[[-1/0,-1/0,1/0,1/0]]}function q(l,e){return[l]}class R{constructor(e){this.rbush_=new A(e),this.items_={}}insert(e,t){const s={minX:e[0],minY:e[1],maxX:e[2],maxY:e[3],value:t};this.rbush_.insert(s),this.items_[f(t)]=s}load(e,t){const s=new Array(t.length);for(let n=0,r=t.length;n<r;n++){const i=e[n],a=t[n],o={minX:i[0],minY:i[1],maxX:i[2],maxY:i[3],value:a};s[n]=o,this.items_[f(a)]=o}this.rbush_.load(s)}remove(e){const t=f(e),s=this.items_[t];return delete this.items_[t],this.rbush_.remove(s)!==null}update(e,t){const s=this.items_[f(t)],n=[s.minX,s.minY,s.maxX,s.maxY];v(n,e)||(this.remove(t),this.insert(e,t))}getAll(){return this.rbush_.all().map(function(t){return t.value})}getInExtent(e){const t={minX:e[0],minY:e[1],maxX:e[2],maxY:e[3]};return this.rbush_.search(t).map(function(n){return n.value})}forEach(e){return this.forEach_(this.getAll(),e)}forEachInExtent(e,t){return this.forEach_(this.getInExtent(e),t)}forEach_(e,t){let s;for(let n=0,r=e.length;n<r;n++)if(s=t(e[n]),s)return s;return s}isEmpty(){return g(this.items_)}clear(){this.rbush_.clear(),this.items_={}}getExtent(e){const t=this.rbush_.toJSON();return O(t.minX,t.minY,t.maxX,t.maxY,e)}concat(e){this.rbush_.load(e.rbush_.all());for(const t in e.items_)this.items_[t]=e.items_[t]}}const d={ADDFEATURE:"addfeature",CHANGEFEATURE:"changefeature",CLEAR:"clear",REMOVEFEATURE:"removefeature",FEATURESLOADSTART:"featuresloadstart",FEATURESLOADEND:"featuresloadend",FEATURESLOADERROR:"featuresloaderror"};class c extends S{constructor(e,t,s){super(e),this.feature=t,this.features=s}}class H extends p{constructor(e){e=e||{},super({attributions:e.attributions,interpolate:!0,projection:void 0,state:"ready",wrapX:e.wrapX!==void 0?e.wrapX:!0}),this.on,this.once,this.un,this.loader_=D,this.format_=e.format||null,this.overlaps_=e.overlaps===void 0?!0:e.overlaps,this.url_=e.url,e.loader!==void 0?this.loader_=e.loader:this.url_!==void 0&&(m(this.format_,"`format` must be set when `url` is set"),this.loader_=I(this.url_,this.format_)),this.strategy_=e.strategy!==void 0?e.strategy:N;const t=e.useSpatialIndex!==void 0?e.useSpatialIndex:!0;this.featuresRtree_=t?new R:null,this.loadedExtentsRtree_=new R,this.loadingExtentsCount_=0,this.nullGeometryFeatures_={},this.idIndex_={},this.uidIndex_={},this.featureChangeKeys_={},this.featuresCollection_=null;let s,n;Array.isArray(e.features)?n=e.features:e.features&&(s=e.features,n=s.getArray()),!t&&s===void 0&&(s=new T(n)),n!==void 0&&this.addFeaturesInternal(n),s!==void 0&&this.bindFeaturesCollection_(s)}addFeature(e){this.addFeatureInternal(e),this.changed()}addFeatureInternal(e){const t=f(e);if(!this.addToIndex_(t,e)){this.featuresCollection_&&this.featuresCollection_.remove(e);return}this.setupChangeEvents_(t,e);const s=e.getGeometry();if(s){const n=s.getExtent();this.featuresRtree_&&this.featuresRtree_.insert(n,e)}else this.nullGeometryFeatures_[t]=e;this.dispatchEvent(new c(d.ADDFEATURE,e))}setupChangeEvents_(e,t){t instanceof _||(this.featureChangeKeys_[e]=[y(t,G.CHANGE,this.handleFeatureChange_,this),y(t,b.PROPERTYCHANGE,this.handleFeatureChange_,this)])}addToIndex_(e,t){let s=!0;if(t.getId()!==void 0){const n=String(t.getId());if(!(n in this.idIndex_))this.idIndex_[n]=t;else if(t instanceof _){const r=this.idIndex_[n];r instanceof _?Array.isArray(r)?r.push(t):this.idIndex_[n]=[r,t]:s=!1}else s=!1}return s&&(m(!(e in this.uidIndex_),"The passed `feature` was already added to the source"),this.uidIndex_[e]=t),s}addFeatures(e){this.addFeaturesInternal(e),this.changed()}addFeaturesInternal(e){const t=[],s=[],n=[];for(let r=0,i=e.length;r<i;r++){const a=e[r],o=f(a);this.addToIndex_(o,a)&&s.push(a)}for(let r=0,i=s.length;r<i;r++){const a=s[r],o=f(a);this.setupChangeEvents_(o,a);const h=a.getGeometry();if(h){const u=h.getExtent();t.push(u),n.push(a)}else this.nullGeometryFeatures_[o]=a}if(this.featuresRtree_&&this.featuresRtree_.load(t,n),this.hasListener(d.ADDFEATURE))for(let r=0,i=s.length;r<i;r++)this.dispatchEvent(new c(d.ADDFEATURE,s[r]))}bindFeaturesCollection_(e){let t=!1;this.addEventListener(d.ADDFEATURE,function(s){t||(t=!0,e.push(s.feature),t=!1)}),this.addEventListener(d.REMOVEFEATURE,function(s){t||(t=!0,e.remove(s.feature),t=!1)}),e.addEventListener(x.ADD,s=>{t||(t=!0,this.addFeature(s.element),t=!1)}),e.addEventListener(x.REMOVE,s=>{t||(t=!0,this.removeFeature(s.element),t=!1)}),this.featuresCollection_=e}clear(e){if(e){for(const s in this.featureChangeKeys_)this.featureChangeKeys_[s].forEach(F);this.featuresCollection_||(this.featureChangeKeys_={},this.idIndex_={},this.uidIndex_={})}else if(this.featuresRtree_){this.featuresRtree_.forEach(s=>{this.removeFeatureInternal(s)});for(const s in this.nullGeometryFeatures_)this.removeFeatureInternal(this.nullGeometryFeatures_[s])}this.featuresCollection_&&this.featuresCollection_.clear(),this.featuresRtree_&&this.featuresRtree_.clear(),this.nullGeometryFeatures_={};const t=new c(d.CLEAR);this.dispatchEvent(t),this.changed()}forEachFeature(e){if(this.featuresRtree_)return this.featuresRtree_.forEach(e);this.featuresCollection_&&this.featuresCollection_.forEach(e)}forEachFeatureAtCoordinateDirect(e,t){const s=[e[0],e[1],e[0],e[1]];return this.forEachFeatureInExtent(s,function(n){const r=n.getGeometry();if(r instanceof _||r.intersectsCoordinate(e))return t(n)})}forEachFeatureInExtent(e,t){if(this.featuresRtree_)return this.featuresRtree_.forEachInExtent(e,t);this.featuresCollection_&&this.featuresCollection_.forEach(t)}forEachFeatureIntersectingExtent(e,t){return this.forEachFeatureInExtent(e,function(s){const n=s.getGeometry();if(n instanceof _||n.intersectsExtent(e)){const r=t(s);if(r)return r}})}getFeaturesCollection(){return this.featuresCollection_}getFeatures(){let e;return this.featuresCollection_?e=this.featuresCollection_.getArray().slice(0):this.featuresRtree_&&(e=this.featuresRtree_.getAll(),g(this.nullGeometryFeatures_)||w(e,Object.values(this.nullGeometryFeatures_))),e}getFeaturesAtCoordinate(e){const t=[];return this.forEachFeatureAtCoordinateDirect(e,function(s){t.push(s)}),t}getFeaturesInExtent(e,t){if(this.featuresRtree_){if(!(t&&t.canWrapX()&&this.getWrapX()))return this.featuresRtree_.getInExtent(e);const n=U(e,t);return[].concat(...n.map(r=>this.featuresRtree_.getInExtent(r)))}return this.featuresCollection_?this.featuresCollection_.getArray().slice(0):[]}getClosestFeatureToCoordinate(e,t){const s=e[0],n=e[1];let r=null;const i=[NaN,NaN];let a=1/0;const o=[-1/0,-1/0,1/0,1/0];return t=t||L,this.featuresRtree_.forEachInExtent(o,function(h){if(t(h)){const u=h.getGeometry(),C=a;if(a=u instanceof _?0:u.closestPointXY(s,n,i,a),a<C){r=h;const E=Math.sqrt(a);o[0]=s-E,o[1]=n-E,o[2]=s+E,o[3]=n+E}}}),r}getExtent(e){var t;return((t=this.featuresRtree_)==null?void 0:t.getExtent(e))??null}getFeatureById(e){const t=this.idIndex_[e.toString()];return t!==void 0?t:null}getFeatureByUid(e){const t=this.uidIndex_[e];return t!==void 0?t:null}getFormat(){return this.format_}getOverlaps(){return this.overlaps_}getUrl(){return this.url_}handleFeatureChange_(e){const t=e.target,s=f(t),n=t.getGeometry();if(!n)s in this.nullGeometryFeatures_||(this.featuresRtree_&&this.featuresRtree_.remove(t),this.nullGeometryFeatures_[s]=t);else{const i=n.getExtent();s in this.nullGeometryFeatures_?(delete this.nullGeometryFeatures_[s],this.featuresRtree_&&this.featuresRtree_.insert(i,t)):this.featuresRtree_&&this.featuresRtree_.update(i,t)}const r=t.getId();if(r!==void 0){const i=r.toString();this.idIndex_[i]!==t&&(this.removeFromIdIndex_(t),this.idIndex_[i]=t)}else this.removeFromIdIndex_(t),this.uidIndex_[s]=t;this.changed(),this.dispatchEvent(new c(d.CHANGEFEATURE,t))}hasFeature(e){const t=e.getId();return t!==void 0?t in this.idIndex_:f(e)in this.uidIndex_}isEmpty(){return this.featuresRtree_?this.featuresRtree_.isEmpty()&&g(this.nullGeometryFeatures_):this.featuresCollection_?this.featuresCollection_.getLength()===0:!0}loadFeatures(e,t,s){const n=this.loadedExtentsRtree_,r=this.strategy_(e,t,s);for(let i=0,a=r.length;i<a;++i){const o=r[i];n.forEachInExtent(o,function(u){return X(u.extent,o)})||(++this.loadingExtentsCount_,this.dispatchEvent(new c(d.FEATURESLOADSTART)),this.loader_.call(this,o,t,s,u=>{--this.loadingExtentsCount_,this.dispatchEvent(new c(d.FEATURESLOADEND,void 0,u))},()=>{--this.loadingExtentsCount_,this.dispatchEvent(new c(d.FEATURESLOADERROR))}),n.insert(o,{extent:o.slice()}))}this.loading=this.loader_.length<4?!1:this.loadingExtentsCount_>0}refresh(){this.clear(!0),this.loadedExtentsRtree_.clear(),super.refresh()}removeLoadedExtent(e){const t=this.loadedExtentsRtree_,s=t.forEachInExtent(e,function(n){if(v(n.extent,e))return n});s&&t.remove(s)}removeFeatures(e){let t=!1;for(let s=0,n=e.length;s<n;++s)t=this.removeFeatureInternal(e[s])||t;t&&this.changed()}removeFeature(e){if(!e)return;this.removeFeatureInternal(e)&&this.changed()}removeFeatureInternal(e){const t=f(e);if(!(t in this.uidIndex_))return!1;t in this.nullGeometryFeatures_?delete this.nullGeometryFeatures_[t]:this.featuresRtree_&&this.featuresRtree_.remove(e);const s=this.featureChangeKeys_[t];s==null||s.forEach(F),delete this.featureChangeKeys_[t];const n=e.getId();if(n!==void 0){const r=n.toString(),i=this.idIndex_[r];i===e?delete this.idIndex_[r]:Array.isArray(i)&&(i.splice(i.indexOf(e),1),i.length===1&&(this.idIndex_[r]=i[0]))}return delete this.uidIndex_[t],this.hasListener(d.REMOVEFEATURE)&&this.dispatchEvent(new c(d.REMOVEFEATURE,e)),!0}removeFromIdIndex_(e){for(const t in this.idIndex_)if(this.idIndex_[t]===e){delete this.idIndex_[t];break}}setLoader(e){this.loader_=e}setUrl(e){m(this.format_,"`format` must be set when `url` is set"),this.url_=e,this.setLoader(I(e,this.format_))}setOverlaps(e){this.overlaps_=e,this.changed()}}export{R,H as V,d as a,q as b,K as l};

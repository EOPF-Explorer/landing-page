import{m as K,d as N,G as k,H as j,I as y,i as v,p as z,F as D,J as I,K as U,L as F,g as A,M,N as p,h as X,O as Q,P as w,Q as B}from"./proj.DZpM1HQc.js";import{f as C,h as Y,i as J,j as h,r as Z,E as $,S as ee,k as G,l as te,m as se,n as ie}from"./XYZ.CeC_mTYy.js";import{l as re,E as V,u as ne,v as ae,B as ce}from"./Polygon.DHQbtAHt.js";function P(r){return Array.isArray(r)?Math.min(...r):r}class oe extends C{constructor(e,t,s,i,n,a,c){let o=e.getExtent();o&&e.canWrapX()&&(o=o.slice(),o[0]=-1/0,o[2]=1/0);let u=t.getExtent();u&&t.canWrapX()&&(u=u.slice(),u[0]=-1/0,u[2]=1/0);const g=u?K(s,u):s,l=N(g),d=Y(e,t,l,i),_=$,R=new J(e,t,g,o,d*_,i),m=R.calculateSourceExtent(),f=k(m)?null:a(m,d,n),T=f?h.IDLE:h.EMPTY,b=f?f.getPixelRatio():1;super(s,i,b,T),this.targetProj_=t,this.maxSourceExtent_=o,this.triangulation_=R,this.targetResolution_=i,this.targetExtent_=s,this.sourceImage_=f,this.sourcePixelRatio_=b,this.interpolate_=c,this.canvas_=null,this.sourceListenerKey_=null}disposeInternal(){this.state==h.LOADING&&this.unlistenSource_(),super.disposeInternal()}getImage(){return this.canvas_}getProjection(){return this.targetProj_}reproject_(){const e=this.sourceImage_.getState();if(e==h.LOADED){const t=j(this.targetExtent_)/this.targetResolution_,s=y(this.targetExtent_)/this.targetResolution_;this.canvas_=Z(t,s,this.sourcePixelRatio_,P(this.sourceImage_.getResolution()),this.maxSourceExtent_,this.targetResolution_,this.targetExtent_,this.triangulation_,[{extent:this.sourceImage_.getExtent(),image:this.sourceImage_.getImage()}],0,void 0,this.interpolate_,!0)}this.state=e,this.changed()}load(){if(this.state==h.IDLE){this.state=h.LOADING,this.changed();const e=this.sourceImage_.getState();e==h.LOADED||e==h.ERROR?this.reproject_():(this.sourceListenerKey_=re(this.sourceImage_,V.CHANGE,t=>{const s=this.sourceImage_.getState();(s==h.LOADED||s==h.ERROR)&&(this.unlistenSource_(),this.reproject_())}),this.sourceImage_.load())}}unlistenSource_(){ne(this.sourceListenerKey_),this.sourceListenerKey_=null}}const E=4,L={IMAGELOADSTART:"imageloadstart",IMAGELOADEND:"imageloadend",IMAGELOADERROR:"imageloaderror"};class ue extends ce{constructor(e,t){super(e),this.image=t}}class de extends ee{constructor(e){super({attributions:e.attributions,projection:e.projection,state:e.state,interpolate:e.interpolate!==void 0?e.interpolate:!0}),this.on,this.once,this.un,this.loader=e.loader||null,this.resolutions_=e.resolutions!==void 0?e.resolutions:null,this.reprojectedImage_=null,this.reprojectedRevision_=0,this.image=null,this.wantedExtent_,this.wantedResolution_,this.static_=e.loader?e.loader.length===0:!1,this.wantedProjection_=null}getResolutions(){return this.resolutions_}setResolutions(e){this.resolutions_=e}findNearestResolution(e){const t=this.getResolutions();if(t){const s=ae(t,e,0);e=t[s]}return e}getImage(e,t,s,i){const n=this.getProjection();if(!n||!i||v(n,i))return n&&(i=n),this.getImageInternal(e,t,s,i);if(this.reprojectedImage_){if(this.reprojectedRevision_==this.getRevision()&&v(this.reprojectedImage_.getProjection(),i)&&this.reprojectedImage_.getResolution()==t&&z(this.reprojectedImage_.getExtent(),e))return this.reprojectedImage_;this.reprojectedImage_.dispose(),this.reprojectedImage_=null}return this.reprojectedImage_=new oe(n,i,e,t,s,(a,c,o)=>this.getImageInternal(a,c,o,n),this.getInterpolate()),this.reprojectedRevision_=this.getRevision(),this.reprojectedImage_}getImageInternal(e,t,s,i){if(this.loader){const n=q(e,t,s,1),a=this.findNearestResolution(t);if(this.image&&(this.static_||this.wantedProjection_===i&&(this.wantedExtent_&&D(this.wantedExtent_,n)||D(this.image.getExtent(),n))&&(this.wantedResolution_&&P(this.wantedResolution_)===a||P(this.image.getResolution())===a)))return this.image;this.wantedProjection_=i,this.wantedExtent_=n,this.wantedResolution_=a,this.image=new C(n,a,s,this.loader),this.image.addEventListener(V.CHANGE,this.handleImageChange.bind(this))}return this.image}handleImageChange(e){const t=e.target;let s;switch(t.getState()){case h.LOADING:this.loading=!0,s=L.IMAGELOADSTART;break;case h.LOADED:this.loading=!1,s=L.IMAGELOADEND;break;case h.ERROR:this.loading=!1,s=L.IMAGELOADERROR;break;default:return}this.hasListener(s)&&this.dispatchEvent(new ue(s,t))}}function _e(r,e){r.getImage().src=e}function q(r,e,t,s){const i=e/t,n=N(r),a=I(j(r)/i,E),c=I(y(r)/i,E),o=I((s-1)*a/2,E),u=a+2*o,g=I((s-1)*c/2,E),l=c+2*g;return U(n,i,0,[u,l])}const S="1.3.0",x=[101,101];function W(r,e,t,s,i){i.WIDTH=t[0],i.HEIGHT=t[1];const n=s.getAxisOrientation(),a=p(i.VERSION,"1.3")>=0;i[a?"CRS":"SRS"]=s.getCode();const c=a&&n.startsWith("ne")?[e[1],e[0],e[3],e[2]]:e;return i.BBOX=c.join(","),G(r,i)}function H(r,e,t,s,i,n,a){n=Object.assign({REQUEST:"GetMap"},n);const c=e/t,o=[F(j(r)/c,E),F(y(r)/c,E)];if(t!=1)switch(a){case"geoserver":const g=90*t+.5|0;"FORMAT_OPTIONS"in n?n.FORMAT_OPTIONS+=";dpi:"+g:n.FORMAT_OPTIONS="dpi:"+g;break;case"mapserver":n.MAP_RESOLUTION=90*t;break;case"carmentaserver":case"qgis":n.DPI=90*t;break;default:throw new Error("Unknown `serverType` configured")}return W(i,r,o,s,n)}function O(r,e){return Object.assign({REQUEST:e,SERVICE:"WMS",VERSION:S,FORMAT:"image/png",STYLES:"",TRANSPARENT:"TRUE"},r)}function Ee(r){const e=r.hidpi===void 0?!0:r.hidpi,t=A(r.projection||"EPSG:3857"),s=r.ratio||1.5,i=r.load||te,n=r.crossOrigin??null,a=r.referrerPolicy;return(c,o,u)=>{c=q(c,o,u,s),u!=1&&(!e||r.serverType===void 0)&&(u=1);const g=H(c,o,u,t,r.url,O(r.params,"GetMap"),r.serverType),l=new Image;return l.crossOrigin=n,a!==void 0&&(l.referrerPolicy=a),i(l,g).then(d=>({image:d,extent:c,pixelRatio:u}))}}function me(r,e,t){if(r.url===void 0)return;const s=A(r.projection||"EPSG:3857"),i=U(e,t,0,x),n={QUERY_LAYERS:r.params.LAYERS,INFO_FORMAT:"application/json"};Object.assign(n,O(r.params,"GetFeatureInfo"),r.params);const a=M((e[0]-i[0])/t,E),c=M((i[3]-e[1])/t,E),o=p(n.VERSION,"1.3")>=0;return n[o?"I":"X"]=a,n[o?"J":"Y"]=c,W(r.url,i,x,s,n)}function fe(r,e){if(r.url===void 0)return;const t={SERVICE:"WMS",VERSION:S,REQUEST:"GetLegendGraphic",FORMAT:"image/png"};if(e!==void 0){const s=A(r.projection||"EPSG:3857").getMetersPerUnit()||1,i=28e-5;t.SCALE=e*s/i}if(Object.assign(t,r.params),r.params!==void 0&&t.LAYER===void 0){const s=t.LAYERS;if(!(!Array.isArray(s)||s.length!==1))return;t.LAYER=s}return G(r.url,t)}class Re extends se{constructor(e){e=e||{};const t=Object.assign({},e.params);super({attributions:e.attributions,attributionsCollapsible:e.attributionsCollapsible,cacheSize:e.cacheSize,crossOrigin:e.crossOrigin,interpolate:e.interpolate,projection:e.projection,reprojectionErrorThreshold:e.reprojectionErrorThreshold,tileClass:e.tileClass,tileGrid:e.tileGrid,tileLoadFunction:e.tileLoadFunction,url:e.url,urls:e.urls,wrapX:e.wrapX!==void 0?e.wrapX:!0,transition:e.transition,zDirection:e.zDirection}),this.gutter_=e.gutter!==void 0?e.gutter:0,this.params_=t,this.v13_=!0,this.serverType_=e.serverType,this.hidpi_=e.hidpi!==void 0?e.hidpi:!0,this.tmpExtent_=X(),this.updateV13_(),this.setKey(this.getKeyForParams_())}getFeatureInfoUrl(e,t,s,i){const n=A(s),a=this.getProjection()||n;let c=this.getTileGrid();c||(c=this.getTileGridForProjection(a));const o=Q(e,n,a),u=Y(a,n,e,t),g=c.getZForResolution(u,this.zDirection),l=c.getResolution(g),d=c.getTileCoordForCoordAndZ(o,g);if(c.getResolutions().length<=d[0])return;let _=c.getTileCoordExtent(d,this.tmpExtent_);const R=this.gutter_;R!==0&&(_=w(_,l*R,_));const m={QUERY_LAYERS:this.params_.LAYERS};Object.assign(m,O(this.params_,"GetFeatureInfo"),i);const f=Math.floor((o[0]-_[0])/l),T=Math.floor((_[3]-o[1])/l);return m[this.v13_?"I":"X"]=f,m[this.v13_?"J":"Y"]=T,this.getRequestUrl_(d,_,1,a||n,m)}getLegendUrl(e,t){if(this.urls[0]===void 0)return;const s={SERVICE:"WMS",VERSION:S,REQUEST:"GetLegendGraphic",FORMAT:"image/png"};if(t===void 0||t.LAYER===void 0){const i=this.params_.LAYERS;if(!(!Array.isArray(i)||i.length===1))return;s.LAYER=i}if(e!==void 0){const i=this.getProjection()?this.getProjection().getMetersPerUnit():1,n=28e-5;s.SCALE=e*i/n}return Object.assign(s,t),G(this.urls[0],s)}getGutter(){return this.gutter_}getParams(){return this.params_}getRequestUrl_(e,t,s,i,n){const a=this.urls;if(!a)return;let c;if(a.length==1)c=a[0];else{const o=B(ie(e),a.length);c=a[o]}return H(t,(this.tileGrid||this.getTileGridForProjection(i)).getResolution(e[0]),s,i,c,n,this.serverType_)}getTilePixelRatio(e){return!this.hidpi_||this.serverType_===void 0?1:e}getKeyForParams_(){let e=0;const t=[];for(const s in this.params_)t[e++]=s+"-"+this.params_[s];return t.join("/")}setParams_(e){this.params_=e,this.updateV13_(),this.setKey(this.getKeyForParams_())}setParams(e){this.setParams_(Object.assign({},e))}updateParams(e){this.setParams_(Object.assign(this.params_,e))}updateV13_(){const e=this.params_.VERSION||S;this.v13_=p(e,"1.3")>=0}tileUrlFunction(e,t,s){let i=this.getTileGrid();if(i||(i=this.getTileGridForProjection(s)),i.getResolutions().length<=e[0])return;t!=1&&(!this.hidpi_||this.serverType_===void 0)&&(t=1);const n=i.getResolution(e[0]);let a=i.getTileCoordExtent(e,this.tmpExtent_);const c=this.gutter_;c!==0&&(a=w(a,n*c,a));const o=Object.assign({},O(this.params_,"GetMap"));return this.getRequestUrl_(e,a,t,s,o)}}export{E as D,de as I,Re as T,fe as a,q as b,Ee as c,_e as d,P as f,me as g};

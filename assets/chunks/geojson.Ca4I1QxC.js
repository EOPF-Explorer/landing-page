const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/chunks/raw.DxtaBMev.js","assets/chunks/basedecoder.B2c5_Eok.js","assets/chunks/lzw.BikwkTY2.js","assets/chunks/jpeg.CbvpOiPg.js","assets/chunks/deflate.B4_27dB1.js","assets/chunks/pako.esm.BkaqWuDM.js","assets/chunks/packbits.D6Qr5eNi.js","assets/chunks/lerc.BaubD7T4.js","assets/chunks/commonjsHelpers.BosuxZz1.js","assets/chunks/GeoJSON.BxIvHmzC.js","assets/chunks/math.CNQr2BuL.js","assets/chunks/OSM.aQ6pgj5c.js","assets/chunks/Group.CiSBx5zz.js","assets/chunks/WKT.n-xUC2SY.js","assets/chunks/item.Bx-rtsOD.js","assets/chunks/framework.DIIUVAST.js","assets/chunks/webimage.CU41Mh7j.js"])))=>i.map(i=>d[i]);
var ug=Object.defineProperty;var cg=(r,e,t)=>e in r?ug(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var de=(r,e,t)=>cg(r,typeof e!="symbol"?e+"":e,t);import{J as hg,F as qt,c as ce,i as ut,j as fg,l as dg,k as va,M as so,m as $i,n as dl,P as oo,L as xr,a as sr,o as pl,p as pg,q as gg,r as mg,s as Ri,S as Ju,u as yg,v as Ts,w as an,x as Qu,y as bi,z as Qe,A as gl,B as _g,C as ec,D as bg,E as ml,H as of,I as hr,R as af,K as xg,N as lf,O as Gn,Q as Eg,T as yl,U as ln,V as uf,W as cf,X as hf,Y as Ta,Z as Sa,t as tc,G as Ra,_ as wg,$ as Pa,f as Aa,h as vg,a0 as rc,a1 as Tg,a2 as Sg}from"./GeoJSON.BxIvHmzC.js";import{h as Rg,j as Ss,k as Rs,l as ff,m as Ct,n as _l,o as bl,s as Pg,w as Ag,p as Ig,q as $t,r as Pi,i as ao,t as Xt,u as zn,b as nt,v as Fe,x as un,y as Ln,g as me,D as df,z as Cg,T as Lg,E as gt,A as Fg,B as Mg,C as Og,c as ji,F as mr,f as xl,G as Ps,H as pf,I as Zt,e as Ng,d as As,a as nc,J as Dg,K as Ai,L as gf,M as Ug,N as Bg,O as ic,P as Gg,Q as zg,R as kg}from"./math.CNQr2BuL.js";import{y as lo,z as q,B as Z,E as G,G as Is,H as $g,J as Ur,N as te,P as R,Q as Pe,Y as ue,_ as At,$ as Wn,a0 as Fr,a1 as Ii,a2 as mf,a3 as Cs,a4 as Ls,a5 as k,a6 as T,a7 as D,a8 as uo,a9 as Ve,aa as lt,ab as El,ac as yf,ad as Fs,ae as Zr,af as jg,ag as Ee,ah as wt,ai as rr,aj as Vg,ak as Xg,g as Vi,s as Mr,q as nr,al as Ia,F as Or,am as Yr,V as en,an as Zg,ao as ee,ap as wl,aq as Wt,ar as Wg,as as vl,at as Ca,au as La,av as zr,aw as qg,ax as Xo,ay as Hg,az as Fa,aA as _f,aB as Sn,aC as Xi,aD as Yg,aE as Kg,aF as pe,aG as Ci,aH as Li,aI as _t,aJ as cn,aK as pn,aL as Jg,aM as re,aN as sc,aO as Qg,aP as em,aQ as Nr,aR as kr,aS as co,aT as bf,aU as Kr,aV as tm,aW as rm,aX as nm,aY as im,L as Tl,aZ as sm,a_ as qn,I as Hn,a$ as Sl,a as gn,b0 as mn,u as jr,b1 as xf,b2 as Zi,b3 as om,b4 as am,b5 as lm,b6 as um,l as Rl,b7 as cm,b8 as hm,b9 as fm,ba as Zo,j as Yn,m as Pl,bb as Ef,bc as dm,bd as Kn,i as Al,X as Ms,o as pm,W as gm,k as mm,e as Mn,h as Os,be as ym,bf as _m,w as Ns,bg as oc,bh as bm,S as Il,v as xm,d as Em,bi as wm,c as wf,bj as Ma,bk as vf,bl as ac,b as Tf,bm as Sf,bn as vm,bo as Rf,bp as Tm,bq as Sm,br as Rm,bs as Pm,bt as Am,bu as Im}from"./OSM.aQ6pgj5c.js";import{T as Pf}from"./WKT.n-xUC2SY.js";import{C as Cm,a as Oa,L as Af}from"./Group.CiSBx5zz.js";import{S as Lm,a as Fm,u as Cl,b as If,C as Na,I as Ds,M as Mm,A as os,c as ci,i as Wo,d as Om,f as Nm,g as lc}from"./item.Bx-rtsOD.js";import{a5 as vr}from"./framework.DIIUVAST.js";import{g as Cf}from"./commonjsHelpers.BosuxZz1.js";class Ll extends Lm{constructor(e,t=null,n={},i=[]){super(e,t,n,i)}getAll(){return[]}}class Dm extends Fm{constructor(e,t=null){super(e,t)}}class Lf extends Ll{constructor(e,t=null){const n={collections:i=>i.map(s=>s instanceof Na?s:new Na(s))};super(e,t,n)}getObjectType(){return"CollectionCollection"}getAll(){return this.collections}isCollectionCollection(){return!0}toGeoJSON(){return{type:"FeatureCollection",features:this.collections.map(t=>t.toGeoJSON()).filter(t=>t!==null)}}getBoundingBox(){return Cl(this.getBoundingBoxes())}getBoundingBoxes(){return this.collections.map(e=>e.getBoundingBox())}getTemporalExtent(){return If(this.getTemporalExtents())}getTemporalExtents(){return this.collections.map(e=>e.getTemporalExtent())}}class Ff extends Ll{constructor(e,t=null){const n={features:i=>i.map(s=>s instanceof Ds?s:new Ds(s))};super(e,t,n)}getObjectType(){return"ItemCollection"}getAll(){return this.features}toGeoJSON(){return this.toJSON()}getBoundingBox(){return Cl(this.getBoundingBoxes())}getBoundingBoxes(){return this.features.map(e=>e.getBoundingBox())}getTemporalExtent(){return If(this.getTemporalExtents())}getTemporalExtents(){return this.features.map(e=>e.getTemporalExtent())}}function as(r,e=!0,t=!1){return e&&(r=Mm.stac(r,t)),r.type==="Feature"?new Ds(r):r.type==="FeatureCollection"?new Ff(r):r.type==="Collection"||!r.type&&typeof r.extent<"u"&&typeof r.license<"u"?new Na(r):!r.type&&Array.isArray(r.collections)?new Lf(r):new Dm(r)}const Um={Point:zm,LineString:km,Polygon:Xm,MultiPoint:jm,MultiLineString:$m,MultiPolygon:Vm},Bm={Point:Zm,LineString:Wm,Polygon:qm,MultiPoint:Ym,MultiLineString:Hm,MultiPolygon:Km};class rR extends hg{constructor(e){e=e||{},super(),this.geometryName_=e.geometryName}readFeatureFromObject(e,t,n){const i=e,s=uc(i.geometry,t),o=new qt;if(this.geometryName_&&o.setGeometryName(this.geometryName_),o.setGeometry(s),i.attributes){o.setProperties(i.attributes,!0);const a=i.attributes[n];a!==void 0&&o.setId(a)}return o}readFeaturesFromObject(e,t){if(t=t||{},e.features){const n=e,i=[],s=n.features;for(let o=0,a=s.length;o<a;++o)i.push(this.readFeatureFromObject(s[o],t,e.objectIdFieldName));return i}return[this.readFeatureFromObject(e,t)]}readGeometryFromObject(e,t){return uc(e,t)}readProjectionFromObject(e){if(e.spatialReference&&e.spatialReference.wkid!==void 0){const n=e.spatialReference.wkid;return ce("EPSG:"+n)}return null}writeGeometryObject(e,t){return cc(e,this.adaptOptions(t))}writeFeatureObject(e,t){t=this.adaptOptions(t);const n={};if(!e.hasProperties())return n.attributes={},n;const i=e.getProperties(),s=e.getGeometry();if(s){n.geometry=cc(s,t);const o=t&&(t.dataProjection||t.featureProjection);o&&(n.geometry.spatialReference={wkid:Number(ce(o).getCode().split(":").pop())}),delete i[e.getGeometryName()]}return Rg(i)?n.attributes={}:n.attributes=i,n}writeFeaturesObject(e,t){t=this.adaptOptions(t);const n=[];for(let i=0,s=e.length;i<s;++i)n.push(this.writeFeatureObject(e[i],t));return{features:n}}}function uc(r,e){if(!r)return null;let t;if(typeof r.x=="number"&&typeof r.y=="number")t="Point";else if(r.points)t="MultiPoint";else if(r.paths)r.paths.length===1?t="LineString":t="MultiLineString";else if(r.rings){const i=r,s=Jn(i),o=Gm(i.rings,s);o.length===1?(t="Polygon",r=Object.assign({},r,{rings:o[0]})):(t="MultiPolygon",r=Object.assign({},r,{rings:o}))}const n=Um[t];return ut(n(r),!1,e)}function Gm(r,e){const t=[],n=[],i=[];let s,o;for(s=0,o=r.length;s<o;++s)t.length=0,fg(t,0,r[s],e.length),dg(t,0,t.length,e.length)?n.push([r[s]]):i.push(r[s]);for(;i.length;){const a=i.shift();let l=!1;for(s=n.length-1;s>=0;s--){const u=n[s][0];if(Ss(new va(u).getExtent(),new va(a).getExtent())){n[s].push(a),l=!0;break}}l||n.push([a.reverse()])}return n}function zm(r){let e;return r.m!==void 0&&r.z!==void 0?e=new sr([r.x,r.y,r.z,r.m],"XYZM"):r.z!==void 0?e=new sr([r.x,r.y,r.z],"XYZ"):r.m!==void 0?e=new sr([r.x,r.y,r.m],"XYM"):e=new sr([r.x,r.y]),e}function km(r){const e=Jn(r);return new xr(r.paths[0],e)}function $m(r){const e=Jn(r);return new $i(r.paths,e)}function Jn(r){let e="XY";return r.hasZ===!0&&r.hasM===!0?e="XYZM":r.hasZ===!0?e="XYZ":r.hasM===!0&&(e="XYM"),e}function jm(r){const e=Jn(r);return new dl(r.points,e)}function Vm(r){const e=Jn(r);return new so(r.rings,e)}function Xm(r){const e=Jn(r);return new oo(r.rings,e)}function Zm(r,e){const t=r.getCoordinates();let n;const i=r.getLayout();if(i==="XYZ")n={x:t[0],y:t[1],z:t[2]};else if(i==="XYM")n={x:t[0],y:t[1],m:t[2]};else if(i==="XYZM")n={x:t[0],y:t[1],z:t[2],m:t[3]};else if(i==="XY")n={x:t[0],y:t[1]};else throw new Error("Invalid geometry layout");return n}function Wi(r){const e=r.getLayout();return{hasZ:e==="XYZ"||e==="XYZM",hasM:e==="XYM"||e==="XYZM"}}function Wm(r,e){const t=Wi(r);return{hasZ:t.hasZ,hasM:t.hasM,paths:[r.getCoordinates()]}}function qm(r,e){const t=Wi(r);return{hasZ:t.hasZ,hasM:t.hasM,rings:r.getCoordinates(!1)}}function Hm(r,e){const t=Wi(r);return{hasZ:t.hasZ,hasM:t.hasM,paths:r.getCoordinates()}}function Ym(r,e){const t=Wi(r);return{hasZ:t.hasZ,hasM:t.hasM,points:r.getCoordinates()}}function Km(r,e){const t=Wi(r),n=r.getCoordinates(!1),i=[];for(let s=0;s<n.length;s++)for(let o=n[s].length-1;o>=0;o--)i.push(n[s][o]);return{hasZ:t.hasZ,hasM:t.hasM,rings:i}}function cc(r,e){const t=Bm[r.getType()];return t(ut(r,!0,e),e)}const _r="http://www.opengis.net/gml",Jm=/^\s*$/;class j extends lo{constructor(e){super(),e=e||{},this.featureType=e.featureType,this.featureNS=e.featureNS,this.srsName=e.srsName,this.schemaLocation="",this.FEATURE_COLLECTION_PARSERS={},this.FEATURE_COLLECTION_PARSERS[this.namespace]={featureMember:Z(this.readFeaturesInternal),featureMembers:q(this.readFeaturesInternal)},this.supportedMediaTypes=["application/gml+xml"]}readFeaturesInternal(e,t){const n=e.localName;let i=null;if(n=="FeatureCollection")i=G([],this.FEATURE_COLLECTION_PARSERS,e,t,this);else if(n=="featureMembers"||n=="featureMember"||n=="member"){const s=t[0];let o=s.featureType,a=s.featureNS;const l="p",u="p0";if(!o&&e.childNodes){o=[],a={};for(let f=0,p=e.childNodes.length;f<p;++f){const d=e.childNodes[f];if(d.nodeType===1){const g=d.nodeName.split(":").pop();if(!o.includes(g)){let m="",y=0;const _=d.namespaceURI;for(const b in a){if(a[b]===_){m=b;break}++y}m||(m=l+y,a[m]=_),o.push(m+":"+g)}}}n!="featureMember"&&(s.featureType=o,s.featureNS=a)}if(typeof a=="string"){const f=a;a={},a[u]=f}const c={},h=Array.isArray(o)?o:[o];for(const f in a){const p={};for(let d=0,g=h.length;d<g;++d)(h[d].includes(":")?h[d].split(":")[0]:u)===f&&(p[h[d].split(":").pop()]=n=="featureMembers"?Z(this.readFeatureElement,this):q(this.readFeatureElement,this));c[a[f]]=p}n=="featureMember"||n=="member"?i=G(void 0,c,e,t):i=G([],c,e,t)}return i===null&&(i=[]),i}readGeometryOrExtent(e,t){const n=t[0];return n.srsName=e.firstElementChild.getAttribute("srsName"),n.srsDimension=e.firstElementChild.getAttribute("srsDimension"),G(null,this.GEOMETRY_PARSERS,e,t,this)}readExtentElement(e,t){const n=t[0],i=this.readGeometryOrExtent(e,t);return i?pl(i,n):void 0}readGeometryElement(e,t){const n=t[0],i=this.readGeometryOrExtent(e,t);return i?ut(i,!1,n):void 0}readFeatureElementInternal(e,t,n){let i;const s={};for(let l=e.firstElementChild;l;l=l.nextElementSibling){let u;const c=l.localName;l.childNodes.length===0||l.childNodes.length===1&&(l.firstChild.nodeType===3||l.firstChild.nodeType===4)?(u=Is(l,!1),Jm.test(u)&&(u=void 0)):(n&&(u=c==="boundedBy"?this.readExtentElement(l,t):this.readGeometryElement(l,t)),u?c!=="boundedBy"&&(i=c):u=this.readFeatureElementInternal(l,t,!1));const h=l.attributes.length;if(h>0&&!(u instanceof pg)){u={_content_:u};for(let f=0;f<h;f++){const p=l.attributes[f].name;u[p]=l.attributes[f].value}}s[c]?(s[c]instanceof Array||(s[c]=[s[c]]),s[c].push(u)):s[c]=u}if(!n)return s;const o=new qt(s);i&&o.setGeometryName(i);const a=e.getAttribute("fid")||$g(e,this.namespace,"id");return a&&o.setId(a),o}readFeatureElement(e,t){return this.readFeatureElementInternal(e,t,!0)}readPoint(e,t){const n=this.readFlatCoordinatesFromNode(e,t);if(n)return new sr(n,"XYZ")}readMultiPoint(e,t){const n=G([],this.MULTIPOINT_PARSERS,e,t,this);if(n)return new dl(n)}readMultiLineString(e,t){const n=G([],this.MULTILINESTRING_PARSERS,e,t,this);if(n)return new $i(n)}readMultiPolygon(e,t){const n=G([],this.MULTIPOLYGON_PARSERS,e,t,this);if(n)return new so(n)}pointMemberParser(e,t){Ur(this.POINTMEMBER_PARSERS,e,t,this)}lineStringMemberParser(e,t){Ur(this.LINESTRINGMEMBER_PARSERS,e,t,this)}polygonMemberParser(e,t){Ur(this.POLYGONMEMBER_PARSERS,e,t,this)}readLineString(e,t){const n=this.readFlatCoordinatesFromNode(e,t);if(n)return new xr(n,"XYZ")}readFlatLinearRing(e,t){const n=G(null,this.GEOMETRY_FLAT_COORDINATES_PARSERS,e,t,this);if(n)return n}readLinearRing(e,t){const n=this.readFlatCoordinatesFromNode(e,t);if(n)return new va(n,"XYZ")}readPolygon(e,t){const n=G([null],this.FLAT_LINEAR_RINGS_PARSERS,e,t,this);if(n&&n[0]){const i=n[0],s=[i.length];let o,a;for(o=1,a=n.length;o<a;++o)Rs(i,n[o]),s.push(i.length);return new oo(i,"XYZ",s)}}readFlatCoordinatesFromNode(e,t){return G(null,this.GEOMETRY_FLAT_COORDINATES_PARSERS,e,t,this)}readGeometryFromNode(e,t){const n=this.readGeometryElement(e,[this.getReadOptions(e,t||{})]);return n||null}readFeaturesFromNode(e,t){const n={featureType:this.featureType,featureNS:this.featureNS};return n&&Object.assign(n,this.getReadOptions(e,t)),this.readFeaturesInternal(e,[n])||[]}readProjectionFromNode(e){return ce(this.srsName?this.srsName:e.firstElementChild.getAttribute("srsName"))}}j.prototype.namespace=_r;j.prototype.FLAT_LINEAR_RINGS_PARSERS={"http://www.opengis.net/gml":{}};j.prototype.GEOMETRY_FLAT_COORDINATES_PARSERS={"http://www.opengis.net/gml":{}};j.prototype.GEOMETRY_PARSERS={"http://www.opengis.net/gml":{}};j.prototype.MULTIPOINT_PARSERS={"http://www.opengis.net/gml":{pointMember:Z(j.prototype.pointMemberParser),pointMembers:Z(j.prototype.pointMemberParser)}};j.prototype.MULTILINESTRING_PARSERS={"http://www.opengis.net/gml":{lineStringMember:Z(j.prototype.lineStringMemberParser),lineStringMembers:Z(j.prototype.lineStringMemberParser)}};j.prototype.MULTIPOLYGON_PARSERS={"http://www.opengis.net/gml":{polygonMember:Z(j.prototype.polygonMemberParser),polygonMembers:Z(j.prototype.polygonMemberParser)}};j.prototype.POINTMEMBER_PARSERS={"http://www.opengis.net/gml":{Point:Z(j.prototype.readFlatCoordinatesFromNode)}};j.prototype.LINESTRINGMEMBER_PARSERS={"http://www.opengis.net/gml":{LineString:Z(j.prototype.readLineString)}};j.prototype.POLYGONMEMBER_PARSERS={"http://www.opengis.net/gml":{Polygon:Z(j.prototype.readPolygon)}};j.prototype.RING_PARSERS={"http://www.opengis.net/gml":{LinearRing:q(j.prototype.readFlatLinearRing)}};const Qm=_r+" http://schemas.opengis.net/gml/2.1.2/feature.xsd",ey={MultiLineString:"lineStringMember",MultiCurve:"curveMember",MultiPolygon:"polygonMember",MultiSurface:"surfaceMember"};class ae extends j{constructor(e){e=e||{},super(e),this.FEATURE_COLLECTION_PARSERS[_r].featureMember=Z(this.readFeaturesInternal),this.schemaLocation=e.schemaLocation?e.schemaLocation:Qm}readFlatCoordinates(e,t){const n=Is(e,!1).replace(/^\s*|\s*$/g,""),s=t[0].srsName;let o="enu";if(s){const u=ce(s);u&&(o=u.getAxisOrientation())}const a=n.trim().split(/\s+/),l=[];for(let u=0,c=a.length;u<c;u++){const h=a[u].split(/,+/),f=parseFloat(h[0]),p=parseFloat(h[1]),d=h.length===3?parseFloat(h[2]):0;o.startsWith("en")?l.push(f,p,d):l.push(p,f,d)}return l}readBox(e,t){const n=G([null],this.BOX_PARSERS_,e,t,this);return ff(n[1][0],n[1][1],n[1][3],n[1][4])}innerBoundaryIsParser(e,t){const n=G(void 0,this.RING_PARSERS,e,t,this);n&&t[t.length-1].push(n)}outerBoundaryIsParser(e,t){const n=G(void 0,this.RING_PARSERS,e,t,this);if(n){const i=t[t.length-1];i[0]=n}}GEOMETRY_NODE_FACTORY_(e,t,n){const i=t[t.length-1],s=i.multiSurface,o=i.surface,a=i.multiCurve;return Array.isArray(e)?n="Envelope":(n=e.getType(),n==="MultiPolygon"&&s===!0?n="MultiSurface":n==="Polygon"&&o===!0?n="Surface":n==="MultiLineString"&&a===!0&&(n="MultiCurve")),te("http://www.opengis.net/gml",n)}writeFeatureElement(e,t,n){const i=t.getId();i&&e.setAttribute("fid",i);const s=n[n.length-1],o=s.featureNS,a=t.getGeometryName();s.serializers||(s.serializers={},s.serializers[o]={});const l=[],u=[];if(t.hasProperties()){const h=t.getProperties();for(const f in h){const p=h[f];p!=null&&(l.push(f),u.push(p),f==a||typeof p.getSimplifiedGeometry=="function"?f in s.serializers[o]||(s.serializers[o][f]=R(this.writeGeometryElement,this)):f in s.serializers[o]||(s.serializers[o][f]=R(ue)))}}const c=Object.assign({},s);c.node=e,Pe(c,s.serializers,At(void 0,o),u,n,l)}writeCurveOrLineString(e,t,n){const s=n[n.length-1].srsName;if(e.nodeName!=="LineStringSegment"&&s&&e.setAttribute("srsName",s),e.nodeName==="LineString"||e.nodeName==="LineStringSegment"){const o=this.createCoordinatesNode_(e.namespaceURI);e.appendChild(o),this.writeCoordinates_(o,t,n)}else if(e.nodeName==="Curve"){const o=te(e.namespaceURI,"segments");e.appendChild(o),this.writeCurveSegments_(o,t,n)}}writeLineStringOrCurveMember(e,t,n){const i=this.GEOMETRY_NODE_FACTORY_(t,n);i&&(e.appendChild(i),this.writeCurveOrLineString(i,t,n))}writeMultiCurveOrLineString(e,t,n){const i=n[n.length-1],s=i.hasZ,o=i.srsName,a=i.curve;o&&e.setAttribute("srsName",o);const l=t.getLineStrings();Pe({node:e,hasZ:s,srsName:o,curve:a},this.LINESTRINGORCURVEMEMBER_SERIALIZERS,this.MULTIGEOMETRY_MEMBER_NODE_FACTORY_,l,n,void 0,this)}writeGeometryElement(e,t,n){const i=n[n.length-1],s=Object.assign({},i);s.node=e;let o;Array.isArray(t)?o=pl(t,i):o=ut(t,!0,i),Pe(s,this.GEOMETRY_SERIALIZERS,this.GEOMETRY_NODE_FACTORY_,[o],n,void 0,this)}createCoordinatesNode_(e){const t=te(e,"coordinates");return t.setAttribute("decimal","."),t.setAttribute("cs",","),t.setAttribute("ts"," "),t}writeCoordinates_(e,t,n){const i=n[n.length-1],s=i.hasZ,o=i.srsName,a=t.getCoordinates(),l=a.length,u=new Array(l);for(let c=0;c<l;++c){const h=a[c];u[c]=this.getCoords_(h,o,s)}ue(e,u.join(" "))}writeCurveSegments_(e,t,n){const i=te(e.namespaceURI,"LineStringSegment");e.appendChild(i),this.writeCurveOrLineString(i,t,n)}writeSurfaceOrPolygon(e,t,n){const i=n[n.length-1],s=i.hasZ,o=i.srsName;if(e.nodeName!=="PolygonPatch"&&o&&e.setAttribute("srsName",o),e.nodeName==="Polygon"||e.nodeName==="PolygonPatch"){const a=t.getLinearRings();Pe({node:e,hasZ:s,srsName:o},this.RING_SERIALIZERS,this.RING_NODE_FACTORY_,a,n,void 0,this)}else if(e.nodeName==="Surface"){const a=te(e.namespaceURI,"patches");e.appendChild(a),this.writeSurfacePatches_(a,t,n)}}RING_NODE_FACTORY_(e,t,n){const i=t[t.length-1],s=i.node,o=i.exteriorWritten;return o===void 0&&(i.exteriorWritten=!0),te(s.namespaceURI,o!==void 0?"innerBoundaryIs":"outerBoundaryIs")}writeSurfacePatches_(e,t,n){const i=te(e.namespaceURI,"PolygonPatch");e.appendChild(i),this.writeSurfaceOrPolygon(i,t,n)}writeRing(e,t,n){const i=te(e.namespaceURI,"LinearRing");e.appendChild(i),this.writeLinearRing(i,t,n)}getCoords_(e,t,n){let s=(t?ce(t).getAxisOrientation():"enu").startsWith("en")?e[0]+","+e[1]:e[1]+","+e[0];if(n){const o=e[2]||0;s+=","+o}return s}writePoint(e,t,n){const i=n[n.length-1],s=i.hasZ,o=i.srsName;o&&e.setAttribute("srsName",o);const a=this.createCoordinatesNode_(e.namespaceURI);e.appendChild(a);const l=t.getCoordinates(),u=this.getCoords_(l,o,s);ue(a,u)}writeMultiPoint(e,t,n){const i=n[n.length-1],s=i.hasZ,o=i.srsName;o&&e.setAttribute("srsName",o);const a=t.getPoints();Pe({node:e,hasZ:s,srsName:o},this.POINTMEMBER_SERIALIZERS,At("pointMember"),a,n,void 0,this)}writePointMember(e,t,n){const i=te(e.namespaceURI,"Point");e.appendChild(i),this.writePoint(i,t,n)}writeLinearRing(e,t,n){const s=n[n.length-1].srsName;s&&e.setAttribute("srsName",s);const o=this.createCoordinatesNode_(e.namespaceURI);e.appendChild(o),this.writeCoordinates_(o,t,n)}writeMultiSurfaceOrPolygon(e,t,n){const i=n[n.length-1],s=i.hasZ,o=i.srsName,a=i.surface;o&&e.setAttribute("srsName",o);const l=t.getPolygons();Pe({node:e,hasZ:s,srsName:o,surface:a},this.SURFACEORPOLYGONMEMBER_SERIALIZERS,this.MULTIGEOMETRY_MEMBER_NODE_FACTORY_,l,n,void 0,this)}writeSurfaceOrPolygonMember(e,t,n){const i=this.GEOMETRY_NODE_FACTORY_(t,n);i&&(e.appendChild(i),this.writeSurfaceOrPolygon(i,t,n))}writeEnvelope(e,t,n){const s=n[n.length-1].srsName;s&&e.setAttribute("srsName",s);const o=["lowerCorner","upperCorner"],a=[t[0]+" "+t[1],t[2]+" "+t[3]];Pe({node:e},this.ENVELOPE_SERIALIZERS,Wn,a,n,o,this)}MULTIGEOMETRY_MEMBER_NODE_FACTORY_(e,t,n){const i=t[t.length-1].node;return te("http://www.opengis.net/gml",ey[i.nodeName])}}ae.prototype.GEOMETRY_FLAT_COORDINATES_PARSERS={"http://www.opengis.net/gml":{coordinates:q(ae.prototype.readFlatCoordinates)}};ae.prototype.FLAT_LINEAR_RINGS_PARSERS={"http://www.opengis.net/gml":{innerBoundaryIs:ae.prototype.innerBoundaryIsParser,outerBoundaryIs:ae.prototype.outerBoundaryIsParser}};ae.prototype.BOX_PARSERS_={"http://www.opengis.net/gml":{coordinates:Z(ae.prototype.readFlatCoordinates)}};ae.prototype.GEOMETRY_PARSERS={"http://www.opengis.net/gml":{Point:q(j.prototype.readPoint),MultiPoint:q(j.prototype.readMultiPoint),LineString:q(j.prototype.readLineString),MultiLineString:q(j.prototype.readMultiLineString),LinearRing:q(j.prototype.readLinearRing),Polygon:q(j.prototype.readPolygon),MultiPolygon:q(j.prototype.readMultiPolygon),Box:q(ae.prototype.readBox)}};ae.prototype.GEOMETRY_SERIALIZERS={"http://www.opengis.net/gml":{Curve:R(ae.prototype.writeCurveOrLineString),MultiCurve:R(ae.prototype.writeMultiCurveOrLineString),Point:R(ae.prototype.writePoint),MultiPoint:R(ae.prototype.writeMultiPoint),LineString:R(ae.prototype.writeCurveOrLineString),MultiLineString:R(ae.prototype.writeMultiCurveOrLineString),LinearRing:R(ae.prototype.writeLinearRing),Polygon:R(ae.prototype.writeSurfaceOrPolygon),MultiPolygon:R(ae.prototype.writeMultiSurfaceOrPolygon),Surface:R(ae.prototype.writeSurfaceOrPolygon),MultiSurface:R(ae.prototype.writeMultiSurfaceOrPolygon),Envelope:R(ae.prototype.writeEnvelope)}};ae.prototype.LINESTRINGORCURVEMEMBER_SERIALIZERS={"http://www.opengis.net/gml":{lineStringMember:R(ae.prototype.writeLineStringOrCurveMember),curveMember:R(ae.prototype.writeLineStringOrCurveMember)}};ae.prototype.RING_SERIALIZERS={"http://www.opengis.net/gml":{outerBoundaryIs:R(ae.prototype.writeRing),innerBoundaryIs:R(ae.prototype.writeRing)}};ae.prototype.POINTMEMBER_SERIALIZERS={"http://www.opengis.net/gml":{pointMember:R(ae.prototype.writePointMember)}};ae.prototype.SURFACEORPOLYGONMEMBER_SERIALIZERS={"http://www.opengis.net/gml":{surfaceMember:R(ae.prototype.writeSurfaceOrPolygonMember),polygonMember:R(ae.prototype.writeSurfaceOrPolygonMember)}};ae.prototype.ENVELOPE_SERIALIZERS={"http://www.opengis.net/gml":{lowerCorner:R(ue),upperCorner:R(ue)}};const ty=_r+" http://schemas.opengis.net/gml/3.1.1/profiles/gmlsfProfile/1.0.0/gmlsf.xsd",ry={MultiLineString:"lineStringMember",MultiCurve:"curveMember",MultiPolygon:"polygonMember",MultiSurface:"surfaceMember"};class F extends j{constructor(e){e=e||{},super(e),this.surface_=e.surface!==void 0?e.surface:!1,this.curve_=e.curve!==void 0?e.curve:!1,this.multiCurve_=e.multiCurve!==void 0?e.multiCurve:!0,this.multiSurface_=e.multiSurface!==void 0?e.multiSurface:!0,this.schemaLocation=e.schemaLocation?e.schemaLocation:ty,this.hasZ=e.hasZ!==void 0?e.hasZ:!1}readMultiCurve(e,t){const n=G([],this.MULTICURVE_PARSERS,e,t,this);if(n)return new $i(n)}readFlatCurveRing(e,t){const n=G([],this.MULTICURVE_PARSERS,e,t,this),i=[];for(let s=0,o=n.length;s<o;++s)Rs(i,n[s].getFlatCoordinates());return i}readMultiSurface(e,t){const n=G([],this.MULTISURFACE_PARSERS,e,t,this);if(n)return new so(n)}curveMemberParser(e,t){Ur(this.CURVEMEMBER_PARSERS,e,t,this)}surfaceMemberParser(e,t){Ur(this.SURFACEMEMBER_PARSERS,e,t,this)}readPatch(e,t){return G([null],this.PATCHES_PARSERS,e,t,this)}readSegment(e,t){return G([],this.SEGMENTS_PARSERS,e,t,this)}readPolygonPatch(e,t){return G([null],this.FLAT_LINEAR_RINGS_PARSERS,e,t,this)}readLineStringSegment(e,t){return G([null],this.GEOMETRY_FLAT_COORDINATES_PARSERS,e,t,this)}interiorParser(e,t){const n=G(void 0,this.RING_PARSERS,e,t,this);n&&t[t.length-1].push(n)}exteriorParser(e,t){const n=G(void 0,this.RING_PARSERS,e,t,this);if(n){const i=t[t.length-1];i[0]=n}}readSurface(e,t){const n=G([null],this.SURFACE_PARSERS,e,t,this);if(n&&n[0]){const i=n[0],s=[i.length];let o,a;for(o=1,a=n.length;o<a;++o)Rs(i,n[o]),s.push(i.length);return new oo(i,"XYZ",s)}}readCurve(e,t){const n=G([null],this.CURVE_PARSERS,e,t,this);if(n)return new xr(n,"XYZ")}readEnvelope(e,t){const n=G([null],this.ENVELOPE_PARSERS,e,t,this);return ff(n[1][0],n[1][1],n[2][0],n[2][1])}readFlatPos(e,t){let n=Is(e,!1);const i=/^\s*([+\-]?\d*\.?\d+(?:[eE][+\-]?\d+)?)\s*/,s=[];let o;for(;o=i.exec(n);)s.push(parseFloat(o[1])),n=n.substr(o[0].length);if(n!=="")return;const l=t[0].srsName;if((l?ce(l).getAxisOrientation():"enu")==="neu")for(let h=0,f=s.length;h<f;h+=3){const p=s[h],d=s[h+1];s[h]=d,s[h+1]=p}const c=s.length;if(c==2&&s.push(0),c!==0)return s}readFlatPosList(e,t){const n=Is(e,!1).replace(/^\s*|\s*$/g,""),i=t[0],s=i.srsName,o=i.srsDimension,a=s?ce(s).getAxisOrientation():"enu",l=n.split(/\s+/);let u=2;e.getAttribute("srsDimension")?u=Fr(e.getAttribute("srsDimension")):e.getAttribute("dimension")?u=Fr(e.getAttribute("dimension")):e.parentNode.getAttribute("srsDimension")?u=Fr(e.parentNode.getAttribute("srsDimension")):o&&(u=Fr(o));const c=a.startsWith("en");let h,f,p;const d=[];for(let g=0,m=l.length;g<m;g+=u)h=parseFloat(l[g]),f=parseFloat(l[g+1]),p=u===3?parseFloat(l[g+2]):0,c?d.push(h,f,p):d.push(f,h,p);return d}writePos_(e,t,n){const i=n[n.length-1],s=i.hasZ,o=s?"3":"2";e.setAttribute("srsDimension",o);const a=i.srsName,l=a?ce(a).getAxisOrientation():"enu",u=t.getCoordinates();let c=l.startsWith("en")?u[0]+" "+u[1]:u[1]+" "+u[0];if(s){const h=u[2]||0;c+=" "+h}ue(e,c)}getCoords_(e,t,n){let s=(t?ce(t).getAxisOrientation():"enu").startsWith("en")?e[0]+" "+e[1]:e[1]+" "+e[0];if(n){const o=e[2]||0;s+=" "+o}return s}writePosList_(e,t,n){const i=n[n.length-1],s=i.hasZ,o=s?"3":"2";e.setAttribute("srsDimension",o);const a=i.srsName,l=t.getCoordinates(),u=l.length,c=new Array(u);let h;for(let f=0;f<u;++f)h=l[f],c[f]=this.getCoords_(h,a,s);ue(e,c.join(" "))}writePoint(e,t,n){const s=n[n.length-1].srsName;s&&e.setAttribute("srsName",s);const o=te(e.namespaceURI,"pos");e.appendChild(o),this.writePos_(o,t,n)}writeEnvelope(e,t,n){const s=n[n.length-1].srsName;s&&e.setAttribute("srsName",s);const o=["lowerCorner","upperCorner"],a=[t[0]+" "+t[1],t[2]+" "+t[3]];Pe({node:e},this.ENVELOPE_SERIALIZERS,Wn,a,n,o,this)}writeLinearRing(e,t,n){const s=n[n.length-1].srsName;s&&e.setAttribute("srsName",s);const o=te(e.namespaceURI,"posList");e.appendChild(o),this.writePosList_(o,t,n)}RING_NODE_FACTORY_(e,t,n){const i=t[t.length-1],s=i.node,o=i.exteriorWritten;return o===void 0&&(i.exteriorWritten=!0),te(s.namespaceURI,o!==void 0?"interior":"exterior")}writeSurfaceOrPolygon(e,t,n){const i=n[n.length-1],s=i.hasZ,o=i.srsName;if(e.nodeName!=="PolygonPatch"&&o&&e.setAttribute("srsName",o),e.nodeName==="Polygon"||e.nodeName==="PolygonPatch"){const a=t.getLinearRings();Pe({node:e,hasZ:s,srsName:o},this.RING_SERIALIZERS,this.RING_NODE_FACTORY_,a,n,void 0,this)}else if(e.nodeName==="Surface"){const a=te(e.namespaceURI,"patches");e.appendChild(a),this.writeSurfacePatches_(a,t,n)}}writeCurveOrLineString(e,t,n){const s=n[n.length-1].srsName;if(e.nodeName!=="LineStringSegment"&&s&&e.setAttribute("srsName",s),e.nodeName==="LineString"||e.nodeName==="LineStringSegment"){const o=te(e.namespaceURI,"posList");e.appendChild(o),this.writePosList_(o,t,n)}else if(e.nodeName==="Curve"){const o=te(e.namespaceURI,"segments");e.appendChild(o),this.writeCurveSegments_(o,t,n)}}writeMultiSurfaceOrPolygon(e,t,n){const i=n[n.length-1],s=i.hasZ,o=i.srsName,a=i.surface;o&&e.setAttribute("srsName",o);const l=t.getPolygons();Pe({node:e,hasZ:s,srsName:o,surface:a},this.SURFACEORPOLYGONMEMBER_SERIALIZERS,this.MULTIGEOMETRY_MEMBER_NODE_FACTORY_,l,n,void 0,this)}writeMultiPoint(e,t,n){const i=n[n.length-1],s=i.srsName,o=i.hasZ;s&&e.setAttribute("srsName",s);const a=t.getPoints();Pe({node:e,hasZ:o,srsName:s},this.POINTMEMBER_SERIALIZERS,At("pointMember"),a,n,void 0,this)}writeMultiCurveOrLineString(e,t,n){const i=n[n.length-1],s=i.hasZ,o=i.srsName,a=i.curve;o&&e.setAttribute("srsName",o);const l=t.getLineStrings();Pe({node:e,hasZ:s,srsName:o,curve:a},this.LINESTRINGORCURVEMEMBER_SERIALIZERS,this.MULTIGEOMETRY_MEMBER_NODE_FACTORY_,l,n,void 0,this)}writeRing(e,t,n){const i=te(e.namespaceURI,"LinearRing");e.appendChild(i),this.writeLinearRing(i,t,n)}writeSurfaceOrPolygonMember(e,t,n){const i=this.GEOMETRY_NODE_FACTORY_(t,n);i&&(e.appendChild(i),this.writeSurfaceOrPolygon(i,t,n))}writePointMember(e,t,n){const i=te(e.namespaceURI,"Point");e.appendChild(i),this.writePoint(i,t,n)}writeLineStringOrCurveMember(e,t,n){const i=this.GEOMETRY_NODE_FACTORY_(t,n);i&&(e.appendChild(i),this.writeCurveOrLineString(i,t,n))}writeSurfacePatches_(e,t,n){const i=te(e.namespaceURI,"PolygonPatch");e.appendChild(i),this.writeSurfaceOrPolygon(i,t,n)}writeCurveSegments_(e,t,n){const i=te(e.namespaceURI,"LineStringSegment");e.appendChild(i),this.writeCurveOrLineString(i,t,n)}writeGeometryElement(e,t,n){const i=n[n.length-1],s=Object.assign({},i);s.node=e;let o;Array.isArray(t)?o=pl(t,i):o=ut(t,!0,i),Pe(s,this.GEOMETRY_SERIALIZERS,this.GEOMETRY_NODE_FACTORY_,[o],n,void 0,this)}writeFeatureElement(e,t,n){const i=t.getId();i&&e.setAttribute("fid",i);const s=n[n.length-1],o=s.featureNS,a=t.getGeometryName();s.serializers||(s.serializers={},s.serializers[o]={});const l=[],u=[];if(t.hasProperties()){const h=t.getProperties();for(const f in h){const p=h[f];p!=null&&(l.push(f),u.push(p),f==a||typeof p.getSimplifiedGeometry=="function"?f in s.serializers[o]||(s.serializers[o][f]=R(this.writeGeometryElement,this)):f in s.serializers[o]||(s.serializers[o][f]=R(ue)))}}const c=Object.assign({},s);c.node=e,Pe(c,s.serializers,At(void 0,o),u,n,l)}writeFeatureMembers_(e,t,n){const i=n[n.length-1],s=i.featureType,o=i.featureNS,a={};a[o]={},a[o][s]=R(this.writeFeatureElement,this);const l=Object.assign({},i);l.node=e,Pe(l,a,At(s,o),t,n)}MULTIGEOMETRY_MEMBER_NODE_FACTORY_(e,t,n){const i=t[t.length-1].node;return te(this.namespace,ry[i.nodeName])}GEOMETRY_NODE_FACTORY_(e,t,n){const i=t[t.length-1],s=i.multiSurface,o=i.surface,a=i.curve,l=i.multiCurve;return Array.isArray(e)?n="Envelope":(n=e.getType(),n==="MultiPolygon"&&s===!0?n="MultiSurface":n==="Polygon"&&o===!0?n="Surface":n==="LineString"&&a===!0?n="Curve":n==="MultiLineString"&&l===!0&&(n="MultiCurve")),te(this.namespace,n)}writeGeometryNode(e,t){t=this.adaptOptions(t);const n=te(this.namespace,"geom"),i={node:n,hasZ:this.hasZ,srsName:this.srsName,curve:this.curve_,surface:this.surface_,multiSurface:this.multiSurface_,multiCurve:this.multiCurve_};return t&&Object.assign(i,t),this.writeGeometryElement(n,e,[i]),n}writeFeaturesNode(e,t){t=this.adaptOptions(t);const n=te(this.namespace,"featureMembers");n.setAttributeNS(Ii,"xsi:schemaLocation",this.schemaLocation);const i={srsName:this.srsName,hasZ:this.hasZ,curve:this.curve_,surface:this.surface_,multiSurface:this.multiSurface_,multiCurve:this.multiCurve_,featureNS:this.featureNS,featureType:this.featureType};return t&&Object.assign(i,t),this.writeFeatureMembers_(n,e,[i]),n}}F.prototype.GEOMETRY_FLAT_COORDINATES_PARSERS={"http://www.opengis.net/gml":{pos:q(F.prototype.readFlatPos),posList:q(F.prototype.readFlatPosList),coordinates:q(ae.prototype.readFlatCoordinates)}};F.prototype.FLAT_LINEAR_RINGS_PARSERS={"http://www.opengis.net/gml":{interior:F.prototype.interiorParser,exterior:F.prototype.exteriorParser}};F.prototype.GEOMETRY_PARSERS={"http://www.opengis.net/gml":{Point:q(j.prototype.readPoint),MultiPoint:q(j.prototype.readMultiPoint),LineString:q(j.prototype.readLineString),MultiLineString:q(j.prototype.readMultiLineString),LinearRing:q(j.prototype.readLinearRing),Polygon:q(j.prototype.readPolygon),MultiPolygon:q(j.prototype.readMultiPolygon),Surface:q(F.prototype.readSurface),MultiSurface:q(F.prototype.readMultiSurface),Curve:q(F.prototype.readCurve),MultiCurve:q(F.prototype.readMultiCurve),Envelope:q(F.prototype.readEnvelope)}};F.prototype.MULTICURVE_PARSERS={"http://www.opengis.net/gml":{curveMember:Z(F.prototype.curveMemberParser),curveMembers:Z(F.prototype.curveMemberParser)}};F.prototype.MULTISURFACE_PARSERS={"http://www.opengis.net/gml":{surfaceMember:Z(F.prototype.surfaceMemberParser),surfaceMembers:Z(F.prototype.surfaceMemberParser)}};F.prototype.CURVEMEMBER_PARSERS={"http://www.opengis.net/gml":{LineString:Z(j.prototype.readLineString),Curve:Z(F.prototype.readCurve)}};F.prototype.SURFACEMEMBER_PARSERS={"http://www.opengis.net/gml":{Polygon:Z(j.prototype.readPolygon),Surface:Z(F.prototype.readSurface)}};F.prototype.SURFACE_PARSERS={"http://www.opengis.net/gml":{patches:q(F.prototype.readPatch)}};F.prototype.CURVE_PARSERS={"http://www.opengis.net/gml":{segments:q(F.prototype.readSegment)}};F.prototype.ENVELOPE_PARSERS={"http://www.opengis.net/gml":{lowerCorner:Z(F.prototype.readFlatPosList),upperCorner:Z(F.prototype.readFlatPosList)}};F.prototype.PATCHES_PARSERS={"http://www.opengis.net/gml":{PolygonPatch:q(F.prototype.readPolygonPatch)}};F.prototype.SEGMENTS_PARSERS={"http://www.opengis.net/gml":{LineStringSegment:mf(F.prototype.readLineStringSegment)}};j.prototype.RING_PARSERS={"http://www.opengis.net/gml":{LinearRing:q(j.prototype.readFlatLinearRing),Ring:q(F.prototype.readFlatCurveRing)}};F.prototype.writeFeatures;F.prototype.RING_SERIALIZERS={"http://www.opengis.net/gml":{exterior:R(F.prototype.writeRing),interior:R(F.prototype.writeRing)}};F.prototype.ENVELOPE_SERIALIZERS={"http://www.opengis.net/gml":{lowerCorner:R(ue),upperCorner:R(ue)}};F.prototype.SURFACEORPOLYGONMEMBER_SERIALIZERS={"http://www.opengis.net/gml":{surfaceMember:R(F.prototype.writeSurfaceOrPolygonMember),polygonMember:R(F.prototype.writeSurfaceOrPolygonMember)}};F.prototype.POINTMEMBER_SERIALIZERS={"http://www.opengis.net/gml":{pointMember:R(F.prototype.writePointMember)}};F.prototype.LINESTRINGORCURVEMEMBER_SERIALIZERS={"http://www.opengis.net/gml":{lineStringMember:R(F.prototype.writeLineStringOrCurveMember),curveMember:R(F.prototype.writeLineStringOrCurveMember)}};F.prototype.GEOMETRY_SERIALIZERS={"http://www.opengis.net/gml":{Curve:R(F.prototype.writeCurveOrLineString),MultiCurve:R(F.prototype.writeMultiCurveOrLineString),Point:R(F.prototype.writePoint),MultiPoint:R(F.prototype.writeMultiPoint),LineString:R(F.prototype.writeCurveOrLineString),MultiLineString:R(F.prototype.writeMultiCurveOrLineString),LinearRing:R(F.prototype.writeLinearRing),Polygon:R(F.prototype.writeSurfaceOrPolygon),MultiPolygon:R(F.prototype.writeMultiSurfaceOrPolygon),Surface:R(F.prototype.writeSurfaceOrPolygon),MultiSurface:R(F.prototype.writeMultiSurfaceOrPolygon),Envelope:R(F.prototype.writeEnvelope)}};const Mf=F;Mf.prototype.writeFeatures;Mf.prototype.writeFeaturesNode;const Ne=[null,"http://www.topografix.com/GPX/1/0","http://www.topografix.com/GPX/1/1"],ny="http://www.topografix.com/GPX/1/1 http://www.topografix.com/GPX/1/1/gpx.xsd",iy={rte:Of,trk:Nf,wpt:Df},sy=k(Ne,{rte:Z(Of),trk:Z(Nf),wpt:Z(Df)}),oy=k(Ne,{text:T(D,"linkText"),type:T(D,"linkType")}),ay=k(Ne,{name:T(D),email:My,link:qi}),ly=k(Ne,{name:T(D),desc:T(D),author:T(Cy),copyright:T(Ly),link:qi,time:T(uo),keywords:T(D),bounds:Fy,extensions:ho}),uy=k(Ne,{year:T(Ve),license:T(D)}),cy=k(Ne,{rte:R(Uy),trk:R(By),wpt:R(zy)});class nR extends lo{constructor(e){super(),e=e||{},this.dataProjection=ce("EPSG:4326"),this.readExtensions_=e.readExtensions}handleReadExtensions_(e){e||(e=[]);for(let t=0,n=e.length;t<n;++t){const i=e[t];if(this.readExtensions_){const s=i.get("extensionsNode_")||null;this.readExtensions_(i,s)}i.set("extensionsNode_",void 0)}}readMetadata(e){return e?typeof e=="string"?this.readMetadataFromDocument(Cs(e)):Ls(e)?this.readMetadataFromDocument(e):this.readMetadataFromNode(e):null}readMetadataFromDocument(e){for(let t=e.firstChild;t;t=t.nextSibling)if(t.nodeType===Node.ELEMENT_NODE){const n=this.readMetadataFromNode(t);if(n)return n}return null}readMetadataFromNode(e){if(!Ne.includes(e.namespaceURI))return null;for(let t=e.firstElementChild;t;t=t.nextElementSibling)if(Ne.includes(t.namespaceURI)&&t.localName==="metadata")return G({},ly,t,[]);return null}readFeatureFromNode(e,t){if(!Ne.includes(e.namespaceURI))return null;const n=iy[e.localName];if(!n)return null;const i=n(e,[this.getReadOptions(e,t)]);return i?(this.handleReadExtensions_([i]),i):null}readFeaturesFromNode(e,t){if(!Ne.includes(e.namespaceURI))return[];if(e.localName=="gpx"){const n=G([],sy,e,[this.getReadOptions(e,t)]);return n?(this.handleReadExtensions_(n),n):[]}return[]}writeFeaturesNode(e,t){t=this.adaptOptions(t);const n=te("http://www.topografix.com/GPX/1/1","gpx");return n.setAttributeNS("http://www.w3.org/2000/xmlns/","xmlns:xsi",Ii),n.setAttributeNS(Ii,"xsi:schemaLocation",ny),n.setAttribute("version","1.1"),n.setAttribute("creator","OpenLayers"),Pe({node:n},cy,Iy,e,[t]),n}}const hy=k(Ne,{name:T(D),cmt:T(D),desc:T(D),src:T(D),link:qi,number:T(Ve),extensions:ho,type:T(D),rtept:Oy}),fy=k(Ne,{ele:T(lt),time:T(uo)}),dy=k(Ne,{name:T(D),cmt:T(D),desc:T(D),src:T(D),link:qi,number:T(Ve),type:T(D),extensions:ho,trkseg:Dy}),py=k(Ne,{trkpt:Ny}),gy=k(Ne,{ele:T(lt),time:T(uo)}),my=k(Ne,{ele:T(lt),time:T(uo),magvar:T(lt),geoidheight:T(lt),name:T(D),cmt:T(D),desc:T(D),src:T(D),link:qi,sym:T(D),type:T(D),fix:T(D),sat:T(Ve),hdop:T(lt),vdop:T(lt),pdop:T(lt),ageofdgpsdata:T(lt),dgpsid:T(Ve),extensions:ho}),yy=["text","type"],_y=k(Ne,{text:R(ue),type:R(ue)}),by=k(Ne,["name","cmt","desc","src","link","number","type","rtept"]),xy=k(Ne,{name:R(ue),cmt:R(ue),desc:R(ue),src:R(ue),link:R(Ol),number:R(Fs),type:R(ue),rtept:yf(R(Nl))}),Ey=k(Ne,["ele","time"]),wy=k(Ne,["name","cmt","desc","src","link","number","type","trkseg"]),vy=k(Ne,{name:R(ue),cmt:R(ue),desc:R(ue),src:R(ue),link:R(Ol),number:R(Fs),type:R(ue),trkseg:yf(R(Gy))}),Ty=At("trkpt"),Sy=k(Ne,{trkpt:R(Nl)}),Ry=k(Ne,["ele","time","magvar","geoidheight","name","cmt","desc","src","link","sym","type","fix","sat","hdop","vdop","pdop","ageofdgpsdata","dgpsid"]),Py=k(Ne,{ele:R(Zr),time:R(jg),magvar:R(Zr),geoidheight:R(Zr),name:R(ue),cmt:R(ue),desc:R(ue),src:R(ue),link:R(Ol),sym:R(ue),type:R(ue),fix:R(ue),sat:R(Fs),hdop:R(Zr),vdop:R(Zr),pdop:R(Zr),ageofdgpsdata:R(Zr),dgpsid:R(Fs)}),Ay={Point:"wpt",LineString:"rte",MultiLineString:"trk"};function Iy(r,e,t){const n=r.getGeometry();if(n){const i=Ay[n.getType()];if(i){const s=e[e.length-1].node;return te(s.namespaceURI,i)}}}function Fl(r,e,t,n){return r.push(parseFloat(t.getAttribute("lon")),parseFloat(t.getAttribute("lat"))),"ele"in n?(r.push(n.ele),delete n.ele,e.hasZ=!0):r.push(0),"time"in n?(r.push(n.time),delete n.time,e.hasM=!0):r.push(0),r}function Ml(r,e,t){let n="XY",i=2;if(r.hasZ&&r.hasM?(n="XYZM",i=4):r.hasZ?(n="XYZ",i=3):r.hasM&&(n="XYM",i=3),i!==4){for(let s=0,o=e.length/4;s<o;s++)e[s*i]=e[s*4],e[s*i+1]=e[s*4+1],r.hasZ&&(e[s*i+2]=e[s*4+2]),r.hasM&&(e[s*i+2]=e[s*4+3]);if(e.length=e.length/4*i,t)for(let s=0,o=t.length;s<o;s++)t[s]=t[s]/4*i}return n}function Cy(r,e){const t=G({},ay,r,e);if(t)return t}function Ly(r,e){const t=G({},uy,r,e);if(t){const n=r.getAttribute("author");return n!==null&&(t.author=n),t}}function Fy(r,e){const t=e[e.length-1],n=r.getAttribute("minlat"),i=r.getAttribute("minlon"),s=r.getAttribute("maxlat"),o=r.getAttribute("maxlon");i!==null&&n!==null&&o!==null&&s!==null&&(t.bounds=[[parseFloat(i),parseFloat(n)],[parseFloat(o),parseFloat(s)]])}function My(r,e){const t=e[e.length-1],n=r.getAttribute("id"),i=r.getAttribute("domain");n!==null&&i!==null&&(t.email=`${n}@${i}`)}function qi(r,e){const t=e[e.length-1],n=r.getAttribute("href");n!==null&&(t.link=n),Ur(oy,r,e)}function ho(r,e){const t=e[e.length-1];t.extensionsNode_=r}function Oy(r,e){const t=G({},fy,r,e);if(t){const n=e[e.length-1],i=n.flatCoordinates,s=n.layoutOptions;Fl(i,s,r,t)}}function Ny(r,e){const t=G({},gy,r,e);if(t){const n=e[e.length-1],i=n.flatCoordinates,s=n.layoutOptions;Fl(i,s,r,t)}}function Dy(r,e){const t=e[e.length-1];Ur(py,r,e);const n=t.flatCoordinates;t.ends.push(n.length)}function Of(r,e){const t=e[0],n=G({flatCoordinates:[],layoutOptions:{}},hy,r,e);if(!n)return;const i=n.flatCoordinates;delete n.flatCoordinates;const s=n.layoutOptions;delete n.layoutOptions;const o=Ml(s,i),a=new xr(i,o);ut(a,!1,t);const l=new qt(a);return l.setProperties(n,!0),l}function Nf(r,e){const t=e[0],n=G({flatCoordinates:[],ends:[],layoutOptions:{}},dy,r,e);if(!n)return;const i=n.flatCoordinates;delete n.flatCoordinates;const s=n.ends;delete n.ends;const o=n.layoutOptions;delete n.layoutOptions;const a=Ml(o,i,s),l=new $i(i,a,s);ut(l,!1,t);const u=new qt(l);return u.setProperties(n,!0),u}function Df(r,e){const t=e[0],n=G({},my,r,e);if(!n)return;const i={},s=Fl([],i,r,n),o=Ml(i,s),a=new sr(s,o);ut(a,!1,t);const l=new qt(a);return l.setProperties(n,!0),l}function Ol(r,e,t){r.setAttribute("href",e);const i=t[t.length-1].properties,s=[i.linkText,i.linkType];Pe({node:r},_y,Wn,s,t,yy)}function Nl(r,e,t){const n=t[t.length-1],s=n.node.namespaceURI,o=n.properties;switch(r.setAttributeNS(null,"lat",String(e[1])),r.setAttributeNS(null,"lon",String(e[0])),n.geometryLayout){case"XYZM":e[3]!==0&&(o.time=e[3]);case"XYZ":e[2]!==0&&(o.ele=e[2]);break;case"XYM":e[2]!==0&&(o.time=e[2]);break}const l=r.nodeName=="rtept"?Ey[s]:Ry[s],u=El(o,l);Pe({node:r,properties:o},Py,Wn,u,t,l)}function Uy(r,e,t){const n=t[0],i=e.getProperties(),s={node:r};s.properties=i;const o=e.getGeometry();if(o.getType()=="LineString"){const c=ut(o,!0,n);s.geometryLayout=c.getLayout(),i.rtept=c.getCoordinates()}const a=t[t.length-1].node,l=by[a.namespaceURI],u=El(i,l);Pe(s,xy,Wn,u,t,l)}function By(r,e,t){const n=t[0],i=e.getProperties(),s={node:r};s.properties=i;const o=e.getGeometry();if(o.getType()=="MultiLineString"){const c=ut(o,!0,n);i.trkseg=c.getLineStrings()}const a=t[t.length-1].node,l=wy[a.namespaceURI],u=El(i,l);Pe(s,vy,Wn,u,t,l)}function Gy(r,e,t){const n={node:r};n.geometryLayout=e.getLayout(),n.properties={},Pe(n,Sy,Ty,e.getCoordinates(),t)}function zy(r,e,t){const n=t[0],i=t[t.length-1];i.properties=e.getProperties();const s=e.getGeometry();if(s.getType()=="Point"){const o=ut(s,!0,n);i.geometryLayout=o.getLayout(),Nl(r,o.getCoordinates(),t)}}const ky=/^B(\d{2})(\d{2})(\d{2})(\d{2})(\d{5})([NS])(\d{3})(\d{5})([EW])([AV])(\d{5})(\d{5})/,$y=/^H.([A-Z]{3}).*?:(.*)/,jy=/^HFDTE(\d{2})(\d{2})(\d{2})/,Vy=/^HFDTEDATE:(\d{2})(\d{2})(\d{2}),(\d{2})/,Xy=/\r\n|\r|\n/;class iR extends Pf{constructor(e){super(),e=e||{},this.dataProjection=ce("EPSG:4326"),this.altitudeMode_=e.altitudeMode?e.altitudeMode:"none",this.lad_=!1,this.lod_=!1,this.ladStart_=0,this.ladStop_=0,this.lodStart_=0,this.lodStop_=0}readFeatureFromText(e,t){const n=this.altitudeMode_,i=e.split(Xy),s={},o=[];let a=2e3,l=0,u=1,c=-1,h,f;for(h=0,f=i.length;h<f;++h){const m=i[h];let y;if(m.charAt(0)=="B"){if(y=ky.exec(m),y){const _=parseInt(y[1],10),b=parseInt(y[2],10),w=parseInt(y[3],10);let x=parseInt(y[4],10)+parseInt(y[5],10)/6e4;this.lad_&&(x+=parseInt(m.slice(this.ladStart_,this.ladStop_),10)/6e4/10**(this.ladStop_-this.ladStart_)),y[6]=="S"&&(x=-x);let E=parseInt(y[7],10)+parseInt(y[8],10)/6e4;if(this.lod_&&(E+=parseInt(m.slice(this.lodStart_,this.lodStop_),10)/6e4/10**(this.lodStop_-this.lodStart_)),y[9]=="W"&&(E=-E),o.push(E,x),n!="none"){let A;n=="gps"?A=parseInt(y[11],10):n=="barometric"?A=parseInt(y[12],10):A=0,o.push(A)}let v=Date.UTC(a,l,u,_,b,w);v<c&&(v=Date.UTC(a,l,u+1,_,b,w)),o.push(v/1e3),c=v}}else if(m.charAt(0)=="H")y=Vy.exec(m),y?(u=parseInt(y[1],10),l=parseInt(y[2],10)-1,a=2e3+parseInt(y[3],10)):(y=jy.exec(m),y?(u=parseInt(y[1],10),l=parseInt(y[2],10)-1,a=2e3+parseInt(y[3],10)):(y=$y.exec(m),y&&(s[y[1]]=y[2].trim())));else if(m.charAt(0)=="I"){const _=parseInt(m.slice(1,3),10);for(let b=0;b<_;b++){const w=m.slice(7+b*7,10+b*7);if(w==="LAD"||w==="LOD"){const x=parseInt(m.slice(3+b*7,5+b*7),10)-1,E=parseInt(m.slice(5+b*7,7+b*7),10);w==="LAD"?(this.lad_=!0,this.ladStart_=x,this.ladStop_=E):w==="LOD"&&(this.lod_=!0,this.lodStart_=x,this.lodStop_=E)}}}}if(o.length===0)return null;const p=n=="none"?"XYM":"XYZM",d=new xr(o,p),g=new qt(ut(d,!1,t));return g.setProperties(s,!0),g}readFeaturesFromText(e,t){const n=this.readFeatureFromText(e,t);return n?[n]:[]}}const Xe={VERSION1:"version1",VERSION2:"version2",VERSION3:"version3"},hn={};hn[Xe.VERSION1]={level0:{supports:[],formats:[],qualities:["native"]},level1:{supports:["regionByPx","sizeByW","sizeByH","sizeByPct"],formats:["jpg"],qualities:["native"]},level2:{supports:["regionByPx","regionByPct","sizeByW","sizeByH","sizeByPct","sizeByConfinedWh","sizeByWh"],formats:["jpg","png"],qualities:["native","color","grey","bitonal"]}};hn[Xe.VERSION2]={level0:{supports:[],formats:["jpg"],qualities:["default"]},level1:{supports:["regionByPx","sizeByW","sizeByH","sizeByPct"],formats:["jpg"],qualities:["default"]},level2:{supports:["regionByPx","regionByPct","sizeByW","sizeByH","sizeByPct","sizeByConfinedWh","sizeByDistortedWh","sizeByWh"],formats:["jpg","png"],qualities:["default","bitonal"]}};hn[Xe.VERSION3]={level0:{supports:[],formats:["jpg"],qualities:["default"]},level1:{supports:["regionByPx","regionSquare","sizeByW","sizeByH","sizeByWh"],formats:["jpg"],qualities:["default"]},level2:{supports:["regionByPx","regionSquare","regionByPct","sizeByW","sizeByH","sizeByPct","sizeByConfinedWh","sizeByWh"],formats:["jpg","png"],qualities:["default"]}};hn.none={none:{supports:[],formats:[],qualities:[]}};const Zy=/^https?:\/\/library\.stanford\.edu\/iiif\/image-api\/(?:1\.1\/)?compliance\.html#level[0-2]$/,hc=/^https?:\/\/iiif\.io\/api\/image\/2\/level[0-2](?:\.json)?$/,Wy=/(^https?:\/\/iiif\.io\/api\/image\/3\/level[0-2](?:\.json)?$)|(^level[0-2]$)/;function qy(r){let e=r.getComplianceLevelSupportedFeatures();return e===void 0&&(e=hn[Xe.VERSION1].level0),{url:r.imageInfo["@id"]===void 0?void 0:r.imageInfo["@id"].replace(/\/?(?:info\.json)?$/g,""),supports:e.supports,formats:[...e.formats,r.imageInfo.formats===void 0?[]:r.imageInfo.formats],qualities:[...e.qualities,r.imageInfo.qualities===void 0?[]:r.imageInfo.qualities],resolutions:r.imageInfo.scale_factors,tileSize:r.imageInfo.tile_width!==void 0?r.imageInfo.tile_height!==void 0?[r.imageInfo.tile_width,r.imageInfo.tile_height]:[r.imageInfo.tile_width,r.imageInfo.tile_width]:r.imageInfo.tile_height!=null?[r.imageInfo.tile_height,r.imageInfo.tile_height]:void 0}}function Hy(r){const e=r.getComplianceLevelSupportedFeatures(),t=Array.isArray(r.imageInfo.profile)&&r.imageInfo.profile.length>1,n=t&&r.imageInfo.profile[1].supports?r.imageInfo.profile[1].supports:[],i=t&&r.imageInfo.profile[1].formats?r.imageInfo.profile[1].formats:[],s=t&&r.imageInfo.profile[1].qualities?r.imageInfo.profile[1].qualities:[];return{url:r.imageInfo["@id"].replace(/\/?(?:info\.json)?$/g,""),sizes:r.imageInfo.sizes===void 0?void 0:r.imageInfo.sizes.map(function(o){return[o.width,o.height]}),tileSize:r.imageInfo.tiles===void 0?void 0:[r.imageInfo.tiles.map(function(o){return o.width})[0],r.imageInfo.tiles.map(function(o){return o.height===void 0?o.width:o.height})[0]],resolutions:r.imageInfo.tiles===void 0?void 0:r.imageInfo.tiles.map(function(o){return o.scaleFactors})[0],supports:[...e.supports,...n],formats:[...e.formats,...i],qualities:[...e.qualities,...s]}}function Yy(r){const e=r.getComplianceLevelSupportedFeatures(),t=r.imageInfo.extraFormats===void 0?e.formats:[...e.formats,...r.imageInfo.extraFormats],n=r.imageInfo.preferredFormats!==void 0&&Array.isArray(r.imageInfo.preferredFormats)&&r.imageInfo.preferredFormats.length>0?r.imageInfo.preferredFormats.filter(function(i){return["jpg","png","gif"].includes(i)}).reduce(function(i,s){return i===void 0&&t.includes(s)?s:i},void 0):void 0;return{url:r.imageInfo.id,sizes:r.imageInfo.sizes===void 0?void 0:r.imageInfo.sizes.map(function(i){return[i.width,i.height]}),tileSize:r.imageInfo.tiles===void 0?void 0:[r.imageInfo.tiles.map(function(i){return i.width})[0],r.imageInfo.tiles.map(function(i){return i.height})[0]],resolutions:r.imageInfo.tiles===void 0?void 0:r.imageInfo.tiles.map(function(i){return i.scaleFactors})[0],supports:r.imageInfo.extraFeatures===void 0?e.supports:[...e.supports,...r.imageInfo.extraFeatures],formats:t,qualities:r.imageInfo.extraQualities===void 0?e.qualities:[...e.qualities,...r.imageInfo.extraQualities],preferredFormat:n}}const fo={};fo[Xe.VERSION1]=qy;fo[Xe.VERSION2]=Hy;fo[Xe.VERSION3]=Yy;class sR{constructor(e){this.setImageInfo(e)}setImageInfo(e){typeof e=="string"?this.imageInfo=JSON.parse(e):this.imageInfo=e}getImageApiVersion(){if(this.imageInfo===void 0)return;let e=this.imageInfo["@context"]||"ol-no-context";typeof e=="string"&&(e=[e]);for(let t=0;t<e.length;t++)switch(e[t]){case"http://library.stanford.edu/iiif/image-api/1.1/context.json":case"http://iiif.io/api/image/1/context.json":return Xe.VERSION1;case"http://iiif.io/api/image/2/context.json":return Xe.VERSION2;case"http://iiif.io/api/image/3/context.json":return Xe.VERSION3;case"ol-no-context":if(this.getComplianceLevelEntryFromProfile(Xe.VERSION1)&&this.imageInfo.identifier)return Xe.VERSION1;break}Ct(!1,"Cannot determine IIIF Image API version from provided image information JSON")}getComplianceLevelEntryFromProfile(e){if(!(this.imageInfo===void 0||this.imageInfo.profile===void 0))switch(e===void 0&&(e=this.getImageApiVersion()),e){case Xe.VERSION1:if(Zy.test(this.imageInfo.profile))return this.imageInfo.profile;break;case Xe.VERSION3:if(Wy.test(this.imageInfo.profile))return this.imageInfo.profile;break;case Xe.VERSION2:if(typeof this.imageInfo.profile=="string"&&hc.test(this.imageInfo.profile))return this.imageInfo.profile;if(Array.isArray(this.imageInfo.profile)&&this.imageInfo.profile.length>0&&typeof this.imageInfo.profile[0]=="string"&&hc.test(this.imageInfo.profile[0]))return this.imageInfo.profile[0];break}}getComplianceLevelFromProfile(e){const t=this.getComplianceLevelEntryFromProfile(e);if(t===void 0)return;const n=t.match(/level[0-2](?:\.json)?$/g);return Array.isArray(n)?n[0].replace(".json",""):void 0}getComplianceLevelSupportedFeatures(){if(this.imageInfo===void 0)return;const e=this.getImageApiVersion(),t=this.getComplianceLevelFromProfile(e);return t===void 0?hn.none.none:hn[e][t]}getTileSourceOptions(e){const t=e||{},n=this.getImageApiVersion();if(n===void 0)return;const i=n===void 0?void 0:fo[n](this);if(i!==void 0)return{url:i.url,version:n,size:[this.imageInfo.width,this.imageInfo.height],sizes:i.sizes,format:t.format!==void 0&&i.formats.includes(t.format)?t.format:i.preferredFormat!==void 0?i.preferredFormat:"jpg",supports:i.supports,quality:t.quality&&i.qualities.includes(t.quality)?t.quality:i.qualities.includes("native")?"native":"default",resolutions:Array.isArray(i.resolutions)?i.resolutions.sort(function(s,o){return o-s}):void 0,tileSize:i.tileSize}}}class Dl{read(e){if(!e)return null;if(typeof e=="string"){const t=Cs(e);return this.readFromDocument(t)}return Ls(e)?this.readFromDocument(e):this.readFromNode(e)}readFromDocument(e){for(let t=e.firstChild;t;t=t.nextSibling)if(t.nodeType==Node.ELEMENT_NODE)return this.readFromNode(t);return null}readFromNode(e){_l()}}const Ky="http://www.w3.org/1999/xlink";function Qn(r){return r.getAttributeNS(Ky,"href")}const bt=[null,"http://www.opengis.net/ows/1.1"],Jy=k(bt,{ServiceIdentification:T(v_),ServiceProvider:T(S_),OperationsMetadata:T(E_)});class Qy extends Dl{constructor(){super()}readFromNode(e){const t=G({},Jy,e,[]);return t||null}}const e_=k(bt,{DeliveryPoint:T(D),City:T(D),AdministrativeArea:T(D),PostalCode:T(D),Country:T(D),ElectronicMailAddress:T(D)}),t_=k(bt,{Value:Ee(R_)}),r_=k(bt,{AllowedValues:T(p_)}),n_=k(bt,{Phone:T(w_),Address:T(d_)}),i_=k(bt,{HTTP:T(b_)}),s_=k(bt,{Get:Ee(__),Post:void 0}),o_=k(bt,{DCP:T(y_)}),a_=k(bt,{Operation:x_}),l_=k(bt,{Voice:T(D),Facsimile:T(D)}),u_=k(bt,{Constraint:Ee(g_)}),c_=k(bt,{IndividualName:T(D),PositionName:T(D),ContactInfo:T(m_)}),h_=k(bt,{Abstract:T(D),AccessConstraints:T(D),Fees:T(D),Title:T(D),ServiceTypeVersion:T(D),ServiceType:T(D)}),f_=k(bt,{ProviderName:T(D),ProviderSite:T(Qn),ServiceContact:T(T_)});function d_(r,e){return G({},e_,r,e)}function p_(r,e){return G({},t_,r,e)}function g_(r,e){const t=r.getAttribute("name");if(t)return G({name:t},r_,r,e)}function m_(r,e){return G({},n_,r,e)}function y_(r,e){return G({},i_,r,e)}function __(r,e){const t=Qn(r);if(t)return G({href:t},u_,r,e)}function b_(r,e){return G({},s_,r,e)}function x_(r,e){const t=r.getAttribute("name"),n=G({},o_,r,e);if(!n)return;const i=e[e.length-1];i[t]=n}function E_(r,e){return G({},a_,r,e)}function w_(r,e){return G({},l_,r,e)}function v_(r,e){return G({},h_,r,e)}function T_(r,e){return G({},c_,r,e)}function S_(r,e){return G({},f_,r,e)}function R_(r,e){return D(r)}function fc(r,e,t,n,i,s){i!==void 0?(i=i,s=s!==void 0?s:0):(i=[],s=0);let o=e;for(;o<t;){const a=r[o++];i[s++]=r[o++],i[s++]=a;for(let l=2;l<n;++l)i[s++]=r[o++]}return i.length=s,i}class oR extends Pf{constructor(e){super(),e=e||{},this.dataProjection=ce("EPSG:4326"),this.factor_=e.factor?e.factor:1e5,this.geometryLayout_=e.geometryLayout?e.geometryLayout:"XY"}readFeatureFromText(e,t){const n=this.readGeometryFromText(e,t);return new qt(n)}readFeaturesFromText(e,t){return[this.readFeatureFromText(e,t)]}readGeometryFromText(e,t){const n=gg(this.geometryLayout_),i=A_(e,n,this.factor_);fc(i,0,i.length,n,i);const s=new xr(i,this.geometryLayout_);return ut(s,!1,this.adaptOptions(t))}writeFeatureText(e,t){const n=e.getGeometry();if(n)return this.writeGeometryText(n,t);throw new Error("Expected `feature` to have a geometry")}writeFeaturesText(e,t){return this.writeFeatureText(e[0],t)}writeGeometryText(e,t){e=ut(e,!0,this.adaptOptions(t));const n=e.getFlatCoordinates(),i=e.getStride();return fc(n,0,n.length,i,n),P_(n,i,this.factor_)}}function P_(r,e,t){t=t||1e5;const n=new Array(e).fill(0);for(let i=0,s=r.length;i<s;)for(let o=0;o<e;++o,++i){const a=r[i]*t,l=a<0?Math.ceil(a-.5):Math.round(a),u=l-n[o];n[o]=l,r[i]=u}return I_(r)}function A_(r,e,t){t=t||1e5;const n=new Array(e).fill(0),i=C_(r);for(let s=0,o=i.length;s<o;)for(let a=0;a<e;++a,++s)n[a]+=i[s],i[s]=n[a]/t;return i}function I_(r){for(let e=0,t=r.length;e<t;++e){const n=r[e];r[e]=n<0?~(n<<1):n<<1}return L_(r)}function C_(r){const e=F_(r);for(let t=0,n=e.length;t<n;++t){const i=e[t];e[t]=i&1?~(i>>1):i>>1}return e}function L_(r){let e="";for(let t=0,n=r.length;t<n;++t)e+=M_(r[t]);return e}function F_(r){const e=[];let t=0,n=0;for(let i=0,s=r.length;i<s;++i){const o=r.charCodeAt(i)-63;t|=(o&31)<<n,o<32?(e.push(t),t=0,n=0):n+=5}return e}function M_(r){let e,t="";for(;r>=32;)e=(32|r&31)+63,t+=String.fromCharCode(e),r>>=5;return e=r+63,t+=String.fromCharCode(e),t}class ge extends F{constructor(e){e=e||{},super(e),this.schemaLocation=e.schemaLocation?e.schemaLocation:this.namespace+" http://schemas.opengis.net/gml/3.2.1/gml.xsd"}writeGeometryElement(e,t,n){const i=n[n.length-1];n[n.length-1]=Object.assign({multiCurve:!0,multiSurface:!0},i),super.writeGeometryElement(e,t,n)}}ge.prototype.namespace="http://www.opengis.net/gml/3.2";ge.prototype.GEOMETRY_FLAT_COORDINATES_PARSERS={"http://www.opengis.net/gml/3.2":{pos:q(F.prototype.readFlatPos),posList:q(F.prototype.readFlatPosList),coordinates:q(ae.prototype.readFlatCoordinates)}};ge.prototype.FLAT_LINEAR_RINGS_PARSERS={"http://www.opengis.net/gml/3.2":{interior:F.prototype.interiorParser,exterior:F.prototype.exteriorParser}};ge.prototype.GEOMETRY_PARSERS={"http://www.opengis.net/gml/3.2":{Point:q(j.prototype.readPoint),MultiPoint:q(j.prototype.readMultiPoint),LineString:q(j.prototype.readLineString),MultiLineString:q(j.prototype.readMultiLineString),LinearRing:q(j.prototype.readLinearRing),Polygon:q(j.prototype.readPolygon),MultiPolygon:q(j.prototype.readMultiPolygon),Surface:q(ge.prototype.readSurface),MultiSurface:q(F.prototype.readMultiSurface),Curve:q(ge.prototype.readCurve),MultiCurve:q(F.prototype.readMultiCurve),Envelope:q(ge.prototype.readEnvelope)}};ge.prototype.MULTICURVE_PARSERS={"http://www.opengis.net/gml/3.2":{curveMember:Z(F.prototype.curveMemberParser),curveMembers:Z(F.prototype.curveMemberParser)}};ge.prototype.MULTISURFACE_PARSERS={"http://www.opengis.net/gml/3.2":{surfaceMember:Z(F.prototype.surfaceMemberParser),surfaceMembers:Z(F.prototype.surfaceMemberParser)}};ge.prototype.CURVEMEMBER_PARSERS={"http://www.opengis.net/gml/3.2":{LineString:Z(j.prototype.readLineString),Curve:Z(F.prototype.readCurve)}};ge.prototype.SURFACEMEMBER_PARSERS={"http://www.opengis.net/gml/3.2":{Polygon:Z(j.prototype.readPolygon),Surface:Z(F.prototype.readSurface)}};ge.prototype.SURFACE_PARSERS={"http://www.opengis.net/gml/3.2":{patches:q(F.prototype.readPatch)}};ge.prototype.CURVE_PARSERS={"http://www.opengis.net/gml/3.2":{segments:q(F.prototype.readSegment)}};ge.prototype.ENVELOPE_PARSERS={"http://www.opengis.net/gml/3.2":{lowerCorner:Z(F.prototype.readFlatPosList),upperCorner:Z(F.prototype.readFlatPosList)}};ge.prototype.PATCHES_PARSERS={"http://www.opengis.net/gml/3.2":{PolygonPatch:q(F.prototype.readPolygonPatch)}};ge.prototype.SEGMENTS_PARSERS={"http://www.opengis.net/gml/3.2":{LineStringSegment:mf(F.prototype.readLineStringSegment)}};ge.prototype.MULTIPOINT_PARSERS={"http://www.opengis.net/gml/3.2":{pointMember:Z(j.prototype.pointMemberParser),pointMembers:Z(j.prototype.pointMemberParser)}};ge.prototype.MULTILINESTRING_PARSERS={"http://www.opengis.net/gml/3.2":{lineStringMember:Z(j.prototype.lineStringMemberParser),lineStringMembers:Z(j.prototype.lineStringMemberParser)}};ge.prototype.MULTIPOLYGON_PARSERS={"http://www.opengis.net/gml/3.2":{polygonMember:Z(j.prototype.polygonMemberParser),polygonMembers:Z(j.prototype.polygonMemberParser)}};ge.prototype.POINTMEMBER_PARSERS={"http://www.opengis.net/gml/3.2":{Point:Z(j.prototype.readFlatCoordinatesFromNode)}};ge.prototype.LINESTRINGMEMBER_PARSERS={"http://www.opengis.net/gml/3.2":{LineString:Z(j.prototype.readLineString)}};ge.prototype.POLYGONMEMBER_PARSERS={"http://www.opengis.net/gml/3.2":{Polygon:Z(j.prototype.readPolygon)}};ge.prototype.RING_PARSERS={"http://www.opengis.net/gml/3.2":{LinearRing:q(j.prototype.readFlatLinearRing),Ring:q(ge.prototype.readFlatCurveRing)}};ge.prototype.RING_SERIALIZERS={"http://www.opengis.net/gml/3.2":{exterior:R(F.prototype.writeRing),interior:R(F.prototype.writeRing)}};ge.prototype.ENVELOPE_SERIALIZERS={"http://www.opengis.net/gml/3.2":{lowerCorner:R(ue),upperCorner:R(ue)}};ge.prototype.SURFACEORPOLYGONMEMBER_SERIALIZERS={"http://www.opengis.net/gml/3.2":{surfaceMember:R(F.prototype.writeSurfaceOrPolygonMember),polygonMember:R(F.prototype.writeSurfaceOrPolygonMember)}};ge.prototype.POINTMEMBER_SERIALIZERS={"http://www.opengis.net/gml/3.2":{pointMember:R(F.prototype.writePointMember)}};ge.prototype.LINESTRINGORCURVEMEMBER_SERIALIZERS={"http://www.opengis.net/gml/3.2":{lineStringMember:R(F.prototype.writeLineStringOrCurveMember),curveMember:R(F.prototype.writeLineStringOrCurveMember)}};ge.prototype.GEOMETRY_SERIALIZERS={"http://www.opengis.net/gml/3.2":{Curve:R(F.prototype.writeCurveOrLineString),MultiCurve:R(F.prototype.writeMultiCurveOrLineString),Point:R(ge.prototype.writePoint),MultiPoint:R(F.prototype.writeMultiPoint),LineString:R(F.prototype.writeCurveOrLineString),MultiLineString:R(F.prototype.writeMultiCurveOrLineString),LinearRing:R(F.prototype.writeLinearRing),Polygon:R(F.prototype.writeSurfaceOrPolygon),MultiPolygon:R(F.prototype.writeMultiSurfaceOrPolygon),Surface:R(F.prototype.writeSurfaceOrPolygon),MultiSurface:R(F.prototype.writeMultiSurfaceOrPolygon),Envelope:R(F.prototype.writeEnvelope)}};class Uf{constructor(e){this.tagName_=e}getTagName(){return this.tagName_}}class O_ extends Uf{constructor(e,t){super(e),this.conditions=t,Ct(this.conditions.length>=2,"At least 2 conditions are required")}}class N_ extends O_{constructor(e){super("And",Array.prototype.slice.call(arguments))}}class D_ extends Uf{constructor(e,t,n){if(super("BBOX"),this.geometryName=e,this.extent=t,t.length!==4)throw new Error("Expected an extent with four values ([minX, minY, maxX, maxY])");this.srsName=n}}function U_(r){const e=[null].concat(Array.prototype.slice.call(arguments));return new(Function.prototype.bind.apply(N_,e))}function B_(r,e,t){return new D_(r,e,t)}const dc={"http://www.opengis.net/gml":{boundedBy:T(j.prototype.readExtentElement,"bounds")},"http://www.opengis.net/wfs/2.0":{member:Z(j.prototype.readFeaturesInternal)}},G_={"http://www.opengis.net/wfs":{totalInserted:T(Ve),totalUpdated:T(Ve),totalDeleted:T(Ve)},"http://www.opengis.net/wfs/2.0":{totalInserted:T(Ve),totalUpdated:T(Ve),totalDeleted:T(Ve)}},z_={"http://www.opengis.net/wfs":{TransactionSummary:T(gc,"transactionSummary"),InsertResults:T(yc,"insertIds")},"http://www.opengis.net/wfs/2.0":{TransactionSummary:T(gc,"transactionSummary"),InsertResults:T(yc,"insertIds")}},k_={"http://www.opengis.net/wfs":{PropertyName:R(ue)},"http://www.opengis.net/wfs/2.0":{PropertyName:R(ue)}},Bf={"http://www.opengis.net/wfs":{Insert:R(_c),Update:R(xc),Delete:R(bc),Property:R(Ec),Native:R(wc)},"http://www.opengis.net/wfs/2.0":{Insert:R(_c),Update:R(xc),Delete:R(bc),Property:R(Ec),Native:R(wc)}},Gf="feature",Ul="http://www.w3.org/2000/xmlns/",Bl={"2.0.0":"http://www.opengis.net/ogc/1.1","1.1.0":"http://www.opengis.net/ogc","1.0.0":"http://www.opengis.net/ogc"},Da={"2.0.0":"http://www.opengis.net/wfs/2.0","1.1.0":"http://www.opengis.net/wfs","1.0.0":"http://www.opengis.net/wfs"},Gl={"2.0.0":"http://www.opengis.net/fes/2.0","1.1.0":"http://www.opengis.net/fes","1.0.0":"http://www.opengis.net/fes"},pc={"2.0.0":"http://www.opengis.net/wfs/2.0 http://schemas.opengis.net/wfs/2.0/wfs.xsd","1.1.0":"http://www.opengis.net/wfs http://schemas.opengis.net/wfs/1.1.0/wfs.xsd","1.0.0":"http://www.opengis.net/wfs http://schemas.opengis.net/wfs/1.0.0/wfs.xsd"},zl={"2.0.0":ge,"1.1.0":F,"1.0.0":ae},$_="1.1.0";class aR extends lo{constructor(e){super(),e=e||{},this.version_=e.version?e.version:$_,this.featureType_=e.featureType,this.featureNS_=e.featureNS,this.gmlFormat_=e.gmlFormat?e.gmlFormat:new zl[this.version_],this.schemaLocation_=e.schemaLocation?e.schemaLocation:pc[this.version_]}getFeatureType(){return this.featureType_}setFeatureType(e){this.featureType_=e}readFeaturesFromNode(e,t){const n={node:e};Object.assign(n,{featureType:this.featureType_,featureNS:this.featureNS_}),Object.assign(n,this.getReadOptions(e,t||{}));const i=[n];let s;this.version_==="2.0.0"?s=dc:s=this.gmlFormat_.FEATURE_COLLECTION_PARSERS;let o=G([],s,e,i,this.gmlFormat_);return o||(o=[]),o}readTransactionResponse(e){if(e){if(typeof e=="string"){const t=Cs(e);return this.readTransactionResponseFromDocument(t)}return Ls(e)?this.readTransactionResponseFromDocument(e):this.readTransactionResponseFromNode(e)}}readFeatureCollectionMetadata(e){if(e){if(typeof e=="string"){const t=Cs(e);return this.readFeatureCollectionMetadataFromDocument(t)}return Ls(e)?this.readFeatureCollectionMetadataFromDocument(e):this.readFeatureCollectionMetadataFromNode(e)}}readFeatureCollectionMetadataFromDocument(e){for(let t=e.firstChild;t;t=t.nextSibling)if(t.nodeType==Node.ELEMENT_NODE)return this.readFeatureCollectionMetadataFromNode(t)}readFeatureCollectionMetadataFromNode(e){const t={},n=Fr(e.getAttribute("numberOfFeatures"));return t.numberOfFeatures=n,G(t,dc,e,[],this.gmlFormat_)}readTransactionResponseFromDocument(e){for(let t=e.firstChild;t;t=t.nextSibling)if(t.nodeType==Node.ELEMENT_NODE)return this.readTransactionResponseFromNode(t)}readTransactionResponseFromNode(e){return G({},z_,e,[])}writeGetFeature(e){const t=te(Da[this.version_],"GetFeature");t.setAttribute("service","WFS"),t.setAttribute("version",this.version_),e.handle&&t.setAttribute("handle",e.handle),e.outputFormat&&t.setAttribute("outputFormat",e.outputFormat),e.maxFeatures!==void 0&&t.setAttribute("maxFeatures",String(e.maxFeatures)),e.resultType&&t.setAttribute("resultType",e.resultType),e.startIndex!==void 0&&t.setAttribute("startIndex",String(e.startIndex)),e.count!==void 0&&t.setAttribute("count",String(e.count)),e.viewParams!==void 0&&t.setAttribute("viewParams",e.viewParams),t.setAttributeNS(Ii,"xsi:schemaLocation",this.schemaLocation_);const n={node:t};if(Object.assign(n,{version:this.version_,srsName:e.srsName,featureNS:e.featureNS?e.featureNS:this.featureNS_,featurePrefix:e.featurePrefix,propertyNames:e.propertyNames?e.propertyNames:[]}),Ct(Array.isArray(e.featureTypes),"`options.featureTypes` must be an Array"),typeof e.featureTypes[0]=="string"){let i=e.filter;e.bbox&&(Ct(e.geometryName,"`options.geometryName` must also be provided when `options.bbox` is set"),i=this.combineBboxAndFilter(e.geometryName,e.bbox,e.srsName,i)),Object.assign(n,{geometryName:e.geometryName,filter:i}),Fc(t,e.featureTypes,[n])}else e.featureTypes.forEach(i=>{const s=this.combineBboxAndFilter(i.geometryName,i.bbox,e.srsName,e.filter);Object.assign(n,{geometryName:i.geometryName,filter:s}),Fc(t,[i.name],[n])});return t}combineBboxAndFilter(e,t,n,i){const s=B_(e,t,n);return i?U_(i,s):s}writeTransaction(e,t,n,i){const s=[],o=i.version?i.version:this.version_,a=te(Da[o],"Transaction");a.setAttribute("service","WFS"),a.setAttribute("version",o);let l;i&&(l=i.gmlOptions?i.gmlOptions:{},i.handle&&a.setAttribute("handle",i.handle)),a.setAttributeNS(Ii,"xsi:schemaLocation",pc[o]);const u=j_(a,l,o,i);return e&&ls("Insert",e,s,u),t&&ls("Update",t,s,u),n&&ls("Delete",n,s,u),i.nativeElements&&ls("Native",i.nativeElements,s,u),a}readProjectionFromDocument(e){for(let t=e.firstChild;t;t=t.nextSibling)if(t.nodeType==Node.ELEMENT_NODE)return this.readProjectionFromNode(t);return null}readProjectionFromNode(e){if(e.firstElementChild&&e.firstElementChild.firstElementChild){e=e.firstElementChild.firstElementChild;for(let t=e.firstElementChild;t;t=t.nextElementSibling)if(!(t.childNodes.length===0||t.childNodes.length===1&&t.firstChild.nodeType===3)){const n=[{}];return this.gmlFormat_.readGeometryElement(t,n),ce(n.pop().srsName)}}return null}}function j_(r,e,t,n){const i=n.featurePrefix?n.featurePrefix:Gf;let s;return t==="1.0.0"?s=2:t==="1.1.0"?s=3:t==="2.0.0"&&(s=3.2),Object.assign({node:r},{version:t,featureNS:n.featureNS,featureType:n.featureType,featurePrefix:i,gmlVersion:s,hasZ:n.hasZ,srsName:n.srsName},e)}function ls(r,e,t,n){Pe(n,Bf,At(r),e,t)}function gc(r,e){return G({},G_,r,e)}const V_={"http://www.opengis.net/ogc":{FeatureId:Z(function(r,e){return r.getAttribute("fid")})},"http://www.opengis.net/ogc/1.1":{FeatureId:Z(function(r,e){return r.getAttribute("fid")})}};function mc(r,e){Ur(V_,r,e)}const X_={"http://www.opengis.net/wfs":{Feature:mc},"http://www.opengis.net/wfs/2.0":{Feature:mc}};function yc(r,e){return G([],X_,r,e)}function _c(r,e,t){const n=t[t.length-1],i=n.featureType,s=n.featureNS,o=n.gmlVersion,a=te(s,i);r.appendChild(a),o===2?ae.prototype.writeFeatureElement(a,e,t):o===3?F.prototype.writeFeatureElement(a,e,t):ge.prototype.writeFeatureElement(a,e,t)}function zf(r,e,t){const i=t[t.length-1].version,s=Bl[i],o=te(s,"Filter"),a=te(s,"FeatureId");o.appendChild(a),a.setAttribute("fid",e),r.appendChild(o)}function kl(r,e){r=r||Gf;const t=r+":";return e.startsWith(t)?e:t+e}function bc(r,e,t){const n=t[t.length-1];Ct(e.getId()!==void 0,"Features must have an id set");const i=n.featureType,s=n.featurePrefix,o=n.featureNS,a=kl(s,i);r.setAttribute("typeName",a),r.setAttributeNS(Ul,"xmlns:"+s,o);const l=e.getId();l!==void 0&&zf(r,l,t)}function xc(r,e,t){const n=t[t.length-1];Ct(e.getId()!==void 0,"Features must have an id set");const i=n.version,s=n.featureType,o=n.featurePrefix,a=n.featureNS,l=kl(o,s),u=e.getGeometryName();r.setAttribute("typeName",l),r.setAttributeNS(Ul,"xmlns:"+o,a);const c=e.getId();if(c!==void 0){const h=e.getKeys(),f=[];for(let p=0,d=h.length;p<d;p++){const g=e.get(h[p]);if(g!==void 0){let m=h[p];g&&typeof g.getSimplifiedGeometry=="function"&&(m=u),f.push({name:m,value:g})}}Pe({version:i,gmlVersion:n.gmlVersion,node:r,hasZ:n.hasZ,srsName:n.srsName},Bf,At("Property"),f,t),zf(r,c,t)}}function Ec(r,e,t){const n=t[t.length-1],i=n.version,s=Da[i],a=te(s,i==="2.0.0"?"ValueReference":"Name"),l=n.gmlVersion;if(r.appendChild(a),ue(a,e.name),e.value!==void 0&&e.value!==null){const u=te(s,"Value");r.appendChild(u),e.value&&typeof e.value.getSimplifiedGeometry=="function"?l===2?ae.prototype.writeGeometryElement(u,e.value,t):l===3?F.prototype.writeGeometryElement(u,e.value,t):ge.prototype.writeGeometryElement(u,e.value,t):ue(u,e.value)}}function wc(r,e,t){e.vendorId&&r.setAttribute("vendorId",e.vendorId),e.safeToIgnore!==void 0&&r.setAttribute("safeToIgnore",String(e.safeToIgnore)),e.value!==void 0&&ue(r,e.value)}const po={"http://www.opengis.net/wfs":{Query:R(vc)},"http://www.opengis.net/wfs/2.0":{Query:R(vc)},"http://www.opengis.net/ogc":{During:R(Rc),And:R(us),Or:R(us),Not:R(Pc),BBOX:R(Tc),Contains:R(Ir),Intersects:R(Ir),Within:R(Ir),DWithin:R(Sc),PropertyIsEqualTo:R(Ft),PropertyIsNotEqualTo:R(Ft),PropertyIsLessThan:R(Ft),PropertyIsLessThanOrEqualTo:R(Ft),PropertyIsGreaterThan:R(Ft),PropertyIsGreaterThanOrEqualTo:R(Ft),PropertyIsNull:R(Ac),PropertyIsBetween:R(Ic),PropertyIsLike:R(Cc)},"http://www.opengis.net/fes/2.0":{During:R(Rc),And:R(us),Or:R(us),Not:R(Pc),BBOX:R(Tc),Contains:R(Ir),Disjoint:R(Ir),Intersects:R(Ir),ResourceId:R(W_),Within:R(Ir),DWithin:R(Sc),PropertyIsEqualTo:R(Ft),PropertyIsNotEqualTo:R(Ft),PropertyIsLessThan:R(Ft),PropertyIsLessThanOrEqualTo:R(Ft),PropertyIsGreaterThan:R(Ft),PropertyIsGreaterThanOrEqualTo:R(Ft),PropertyIsNull:R(Ac),PropertyIsBetween:R(Ic),PropertyIsLike:R(Cc)}};function vc(r,e,t){const n=t[t.length-1],i=n.version,s=n.featurePrefix,o=n.featureNS,a=n.propertyNames,l=n.srsName;let u;s?u=kl(s,e):u=e;let c;i==="2.0.0"?c="typeNames":c="typeName",r.setAttribute(c,u),l&&r.setAttribute("srsName",l),o&&r.setAttributeNS(Ul,"xmlns:"+s,o);const h=Object.assign({},n);h.node=r,Pe(h,k_,At("PropertyName"),a,t);const f=n.filter;if(f){const p=te(go(i),"Filter");r.appendChild(p),Z_(p,f,t)}}function Z_(r,e,t){const n=t[t.length-1],i={node:r};Object.assign(i,{context:n}),Pe(i,po,At(e.getTagName()),[e],t)}function Tc(r,e,t){const n=t[t.length-1],s=n.context.version;n.srsName=e.srsName;const o=zl[s];ei(s,r,e.geometryName),o.prototype.writeGeometryElement(r,e.extent,t)}function W_(r,e,t){r.setAttribute("rid",e.rid)}function Ir(r,e,t){const n=t[t.length-1],s=n.context.version;n.srsName=e.srsName;const o=zl[s];ei(s,r,e.geometryName),o.prototype.writeGeometryElement(r,e.geometry,t)}function Sc(r,e,t){const s=t[t.length-1].context.version;Ir(r,e,t);const o=te(go(s),"Distance");ue(o,e.distance.toString()),s==="2.0.0"?o.setAttribute("uom",e.unit):o.setAttribute("units",e.unit),r.appendChild(o)}function Rc(r,e,t){const s=t[t.length-1].context.version;Us(Gl[s],"ValueReference",r,e.propertyName);const o=te(_r,"TimePeriod");r.appendChild(o);const a=te(_r,"begin");o.appendChild(a),Lc(a,e.begin);const l=te(_r,"end");o.appendChild(l),Lc(l,e.end)}function us(r,e,t){const i=t[t.length-1].context,s={node:r};Object.assign(s,{context:i});const o=e.conditions;for(let a=0,l=o.length;a<l;++a){const u=o[a];Pe(s,po,At(u.getTagName()),[u],t)}}function Pc(r,e,t){const i=t[t.length-1].context,s={node:r};Object.assign(s,{context:i});const o=e.condition;Pe(s,po,At(o.getTagName()),[o],t)}function Ft(r,e,t){const s=t[t.length-1].context.version;e.matchCase!==void 0&&r.setAttribute("matchCase",e.matchCase.toString()),ei(s,r,e.propertyName),Bs(s,r,""+e.expression)}function Ac(r,e,t){const s=t[t.length-1].context.version;ei(s,r,e.propertyName)}function Ic(r,e,t){const s=t[t.length-1].context.version,o=go(s);ei(s,r,e.propertyName);const a=te(o,"LowerBoundary");r.appendChild(a),Bs(s,a,""+e.lowerBoundary);const l=te(o,"UpperBoundary");r.appendChild(l),Bs(s,l,""+e.upperBoundary)}function Cc(r,e,t){const s=t[t.length-1].context.version;r.setAttribute("wildCard",e.wildCard),r.setAttribute("singleChar",e.singleChar),r.setAttribute("escapeChar",e.escapeChar),e.matchCase!==void 0&&r.setAttribute("matchCase",e.matchCase.toString()),ei(s,r,e.propertyName),Bs(s,r,""+e.pattern)}function Us(r,e,t,n){const i=te(r,e);ue(i,n),t.appendChild(i)}function Bs(r,e,t){Us(go(r),"Literal",e,t)}function ei(r,e,t){r==="2.0.0"?Us(Gl[r],"ValueReference",e,t):Us(Bl[r],"PropertyName",e,t)}function Lc(r,e){const t=te(_r,"TimeInstant");r.appendChild(t);const n=te(_r,"timePosition");t.appendChild(n),ue(n,e)}function Fc(r,e,t){const n=t[t.length-1],i=Object.assign({},n);i.node=r,Pe(i,po,At("Query"),e,t)}function go(r){let e;return r==="2.0.0"?e=Gl[r]:e=Bl[r],e}const we={POINT:1,LINE_STRING:2,POLYGON:3,MULTI_POINT:4,MULTI_LINE_STRING:5,MULTI_POLYGON:6,GEOMETRY_COLLECTION:7,POLYHEDRAL_SURFACE:15,TIN:16,TRIANGLE:17};class Mc{constructor(e){this.view_=e,this.pos_=0,this.initialized_=!1,this.isLittleEndian_=!1,this.hasZ_=!1,this.hasM_=!1,this.srid_=null,this.layout_="XY"}readUint8(){return this.view_.getUint8(this.pos_++)}readUint32(e){return this.view_.getUint32((this.pos_+=4)-4,e!==void 0?e:this.isLittleEndian_)}readDouble(e){return this.view_.getFloat64((this.pos_+=8)-8,e!==void 0?e:this.isLittleEndian_)}readPoint(){const e=[];return e.push(this.readDouble()),e.push(this.readDouble()),this.hasZ_&&e.push(this.readDouble()),this.hasM_&&e.push(this.readDouble()),e}readLineString(){const e=this.readUint32(),t=[];for(let n=0;n<e;n++)t.push(this.readPoint());return t}readPolygon(){const e=this.readUint32(),t=[];for(let n=0;n<e;n++)t.push(this.readLineString());return t}readWkbHeader(e){const n=this.readUint8()>0,i=this.readUint32(n),s=Math.floor((i&268435455)/1e3),o=!!(i&2147483648)||s===1||s===3,a=!!(i&1073741824)||s===2||s===3,l=!!(i&536870912),u=(i&268435455)%1e3,c=["XY",o?"Z":"",a?"M":""].join(""),h=l?this.readUint32(n):null;if(e!==void 0&&e!==u)throw new Error("Unexpected WKB geometry type "+u);if(this.initialized_){if(this.isLittleEndian_!==n)throw new Error("Inconsistent endian");if(this.layout_!==c)throw new Error("Inconsistent geometry layout");if(h&&this.srid_!==h)throw new Error("Inconsistent coordinate system (SRID)")}else this.isLittleEndian_=n,this.hasZ_=o,this.hasM_=a,this.layout_=c,this.srid_=h,this.initialized_=!0;return u}readWkbPayload(e){switch(e){case we.POINT:return this.readPoint();case we.LINE_STRING:return this.readLineString();case we.POLYGON:case we.TRIANGLE:return this.readPolygon();case we.MULTI_POINT:return this.readMultiPoint();case we.MULTI_LINE_STRING:return this.readMultiLineString();case we.MULTI_POLYGON:case we.POLYHEDRAL_SURFACE:case we.TIN:return this.readMultiPolygon();case we.GEOMETRY_COLLECTION:return this.readGeometryCollection();default:throw new Error("Unsupported WKB geometry type "+e+" is found")}}readWkbBlock(e){return this.readWkbPayload(this.readWkbHeader(e))}readWkbCollection(e,t){const n=this.readUint32(),i=[];for(let s=0;s<n;s++){const o=e.call(this,t);o&&i.push(o)}return i}readMultiPoint(){return this.readWkbCollection(this.readWkbBlock,we.POINT)}readMultiLineString(){return this.readWkbCollection(this.readWkbBlock,we.LINE_STRING)}readMultiPolygon(){return this.readWkbCollection(this.readWkbBlock,we.POLYGON)}readGeometryCollection(){return this.readWkbCollection(this.readGeometry)}readGeometry(){const e=this.readWkbHeader(),t=this.readWkbPayload(e);switch(e){case we.POINT:return new sr(t,this.layout_);case we.LINE_STRING:return new xr(t,this.layout_);case we.POLYGON:case we.TRIANGLE:return new oo(t,this.layout_);case we.MULTI_POINT:return new dl(t,this.layout_);case we.MULTI_LINE_STRING:return new $i(t,this.layout_);case we.MULTI_POLYGON:case we.POLYHEDRAL_SURFACE:case we.TIN:return new so(t,this.layout_);case we.GEOMETRY_COLLECTION:return new Ri(t);default:return null}}getSrid(){return this.srid_}}class q_{constructor(e){e=e||{},this.layout_=e.layout,this.isLittleEndian_=e.littleEndian!==!1,this.isEWKB_=e.ewkb!==!1,this.writeQueue_=[],this.nodata_=Object.assign({X:0,Y:0,Z:0,M:0},e.nodata)}writeUint8(e){this.writeQueue_.push([1,e])}writeUint32(e){this.writeQueue_.push([4,e])}writeDouble(e){this.writeQueue_.push([8,e])}writePoint(e,t){const n=Object.assign.apply(null,t.split("").map((i,s)=>({[i]:e[s]})));for(const i of this.layout_)this.writeDouble(i in n?n[i]:this.nodata_[i])}writeLineString(e,t){this.writeUint32(e.length);for(let n=0;n<e.length;n++)this.writePoint(e[n],t)}writePolygon(e,t){this.writeUint32(e.length);for(let n=0;n<e.length;n++)this.writeLineString(e[n],t)}writeWkbHeader(e,t){e%=1e3,this.layout_.includes("Z")&&(e+=this.isEWKB_?2147483648:1e3),this.layout_.includes("M")&&(e+=this.isEWKB_?1073741824:2e3),this.isEWKB_&&Number.isInteger(t)&&(e|=536870912),this.writeUint8(this.isLittleEndian_?1:0),this.writeUint32(e),this.isEWKB_&&Number.isInteger(t)&&this.writeUint32(t)}writeMultiPoint(e,t){this.writeUint32(e.length);for(let n=0;n<e.length;n++)this.writeWkbHeader(1),this.writePoint(e[n],t)}writeMultiLineString(e,t){this.writeUint32(e.length);for(let n=0;n<e.length;n++)this.writeWkbHeader(2),this.writeLineString(e[n],t)}writeMultiPolygon(e,t){this.writeUint32(e.length);for(let n=0;n<e.length;n++)this.writeWkbHeader(3),this.writePolygon(e[n],t)}writeGeometryCollection(e){this.writeUint32(e.length);for(let t=0;t<e.length;t++)this.writeGeometry(e[t])}findMinimumLayout(e,t="XYZM"){const n=(i,s)=>i===s?i:i==="XYZM"?s:s==="XYZM"?i:"XY";if(e instanceof Ju)return n(e.getLayout(),t);if(e instanceof Ri){const i=e.getGeometriesArray();for(let s=0;s<i.length&&t!=="XY";s++)t=this.findMinimumLayout(i[s],t)}return t}writeGeometry(e,t){const n={Point:we.POINT,LineString:we.LINE_STRING,Polygon:we.POLYGON,MultiPoint:we.MULTI_POINT,MultiLineString:we.MULTI_LINE_STRING,MultiPolygon:we.MULTI_POLYGON,GeometryCollection:we.GEOMETRY_COLLECTION},i=e.getType(),s=n[i];if(!s)throw new Error("GeometryType "+i+" is not supported");this.layout_||(this.layout_=this.findMinimumLayout(e)),this.writeWkbHeader(s,t),e instanceof Ju?{Point:this.writePoint,LineString:this.writeLineString,Polygon:this.writePolygon,MultiPoint:this.writeMultiPoint,MultiLineString:this.writeMultiLineString,MultiPolygon:this.writeMultiPolygon}[i].call(this,e.getCoordinates(),e.getLayout()):e instanceof Ri&&this.writeGeometryCollection(e.getGeometriesArray())}getBuffer(){const e=this.writeQueue_.reduce((s,o)=>s+o[0],0),t=new ArrayBuffer(e),n=new DataView(t);let i=0;return this.writeQueue_.forEach(s=>{switch(s[0]){case 1:n.setUint8(i,s[1]);break;case 4:n.setUint32(i,s[1],this.isLittleEndian_);break;case 8:n.setFloat64(i,s[1],this.isLittleEndian_);break}i+=s[0]}),t}}class lR extends mg{constructor(e){super(),e=e||{},this.splitCollection=!!e.splitCollection,this.viewCache_=null,this.hex_=e.hex!==!1,this.littleEndian_=e.littleEndian!==!1,this.ewkb_=e.ewkb!==!1,this.layout_=e.geometryLayout,this.nodataZ_=e.nodataZ||0,this.nodataM_=e.nodataM||0,this.srid_=e.srid}getType(){return this.hex_?"text":"arraybuffer"}readFeature(e,t){return new qt({geometry:this.readGeometry(e,t)})}readFeatures(e,t){let n=[];const i=this.readGeometry(e,t);return this.splitCollection&&i instanceof Ri?n=i.getGeometriesArray():n=[i],n.map(s=>new qt({geometry:s}))}readGeometry(e,t){const n=Oc(e);if(!n)return null;const s=new Mc(n).readGeometry();return this.viewCache_=n,t=this.getReadOptions(e,t),this.viewCache_=null,ut(s,!1,t)}readProjection(e){const t=this.viewCache_||Oc(e);if(!t)return;const n=new Mc(t);return n.readWkbHeader(),n.getSrid()&&ce("EPSG:"+n.getSrid())||void 0}writeFeature(e,t){return this.writeGeometry(e.getGeometry(),t)}writeFeatures(e,t){return this.writeGeometry(new Ri(e.map(n=>n.getGeometry())),t)}writeGeometry(e,t){t=this.adaptOptions(t);const n=new q_({layout:this.layout_,littleEndian:this.littleEndian_,ewkb:this.ewkb_,nodata:{Z:this.nodataZ_,M:this.nodataM_}});let i=Number.isInteger(this.srid_)?Number(this.srid_):null;if(this.srid_!==!1&&!Number.isInteger(this.srid_)){const o=t.dataProjection&&ce(t.dataProjection);if(o){const a=o.getCode();a.startsWith("EPSG:")&&(i=Number(a.substring(5)))}}n.writeGeometry(ut(e,!0,t),i);const s=n.getBuffer();return this.hex_?H_(s):s}}function H_(r){const e=new Uint8Array(r);return Array.from(e.values()).map(t=>(t<16?"0":"")+Number(t).toString(16).toUpperCase()).join("")}function Y_(r){const e=new Uint8Array(r.length/2);for(let t=0;t<r.length/2;t++)e[t]=parseInt(r.substr(t*2,2),16);return new DataView(e.buffer)}function Oc(r){return typeof r=="string"?Y_(r):ArrayBuffer.isView(r)?r instanceof DataView?r:new DataView(r.buffer,r.byteOffset,r.byteLength):r instanceof ArrayBuffer?new DataView(r):null}const qe=[null,"http://www.opengis.net/wms","http://www.opengis.net/sld"];function Hi(r){return yg(r[0].version,"1.3")>=0}const K_=k(qe,{Service:T(_0),Capability:T(y0)}),J_=k(qe,{Request:T(P0),Exception:T(w0),Layer:T(v0),UserDefinedSymbolization:T(g0)});class uR extends Dl{constructor(){super(),this.version=void 0}readFromNode(e){this.version=e.getAttribute("version").trim();const t=G({version:this.version},K_,e,[]);return t||null}}const kf={Name:T(D),Title:T(D),Abstract:T(D),KeywordList:T(Wf),OnlineResource:T(Qn),ContactInformation:T(b0),Fees:T(D),AccessConstraints:T(D)},Q_=k(qe,kf),e0=k(qe,{...kf,LayerLimit:T(Ve),MaxWidth:T(Ve),MaxHeight:T(Ve)}),t0=k(qe,{ContactPersonPrimary:T(x0),ContactPosition:T(D),ContactAddress:T(E0),ContactVoiceTelephone:T(D),ContactFacsimileTelephone:T(D),ContactElectronicMailAddress:T(D)}),r0=k(qe,{ContactPerson:T(D),ContactOrganization:T(D)}),n0=k(qe,{AddressType:T(D),Address:T(D),City:T(D),StateOrProvince:T(D),PostCode:T(D),Country:T(D)}),i0=k(qe,{Format:Z(D)}),$f={Name:T(D),Title:T(D),Abstract:T(D),KeywordList:T(Wf),BoundingBox:Ee(Xf),Dimension:Ee(T0),Attribution:T(p0),AuthorityURL:Ee(C0),Identifier:Ee(D),MetadataURL:Ee(L0),DataURL:Ee(Er),FeatureListURL:Ee(Er),Style:Ee(F0),Layer:Ee(mo)},jf=k(qe,{...$f,SRS:Ee(D),Extent:T(S0),ScaleHint:Ee(R0),LatLonBoundingBox:T((r,e)=>Xf(r,e,!1)),Layer:Ee(mo)}),Vf=k(qe,{...$f,CRS:Ee(D),EX_GeographicBoundingBox:T(m0),MinScaleDenominator:T(lt),MaxScaleDenominator:T(lt),Layer:Ee(mo)}),s0=k(qe,{Title:T(D),OnlineResource:T(Qn),LogoURL:T(Zf)}),o0=k(qe,{westBoundLongitude:T(lt),eastBoundLongitude:T(lt),southBoundLatitude:T(lt),northBoundLatitude:T(lt)}),a0=k(qe,{GetCapabilities:T(hi),GetMap:T(hi),GetFeatureInfo:T(hi),DescribeLayer:T(hi),GetLegendGraphic:T(hi)}),l0=k(qe,{Format:Ee(D),DCPType:Ee(A0)}),u0=k(qe,{HTTP:T(I0)}),c0=k(qe,{Get:T(Er),Post:T(Er)}),h0=k(qe,{Name:T(D),Title:T(D),Abstract:T(D),LegendURL:Ee(Zf),StyleSheetURL:T(Er),StyleURL:T(Er)}),f0=k(qe,{Format:T(D),OnlineResource:T(Qn)}),d0=k(qe,{Keyword:Z(D)});function p0(r,e){return G({},s0,r,e)}function g0(r,e){return{SupportSLD:!!wt(r.getAttribute("SupportSLD")),UserLayer:!!wt(r.getAttribute("UserLayer")),UserStyle:!!wt(r.getAttribute("UserStyle")),RemoteWFS:!!wt(r.getAttribute("RemoteWFS")),InlineFeatureData:!!wt(r.getAttribute("InlineFeatureData")),RemoteWCS:!!wt(r.getAttribute("RemoteWCS"))}}function Xf(r,e,t=!0){const n=[rr(r.getAttribute("minx")),rr(r.getAttribute("miny")),rr(r.getAttribute("maxx")),rr(r.getAttribute("maxy"))],i=[rr(r.getAttribute("resx")),rr(r.getAttribute("resy"))],s={extent:n,res:i};return t&&(Hi(e)?s.crs=r.getAttribute("CRS"):s.srs=r.getAttribute("SRS")),s}function m0(r,e){const t=G({},o0,r,e);if(!t)return;const n=t.westBoundLongitude,i=t.southBoundLatitude,s=t.eastBoundLongitude,o=t.northBoundLatitude;if(!(n===void 0||i===void 0||s===void 0||o===void 0))return[n,i,s,o]}function y0(r,e){return G({},J_,r,e)}function _0(r,e){return G({},Hi(e)?e0:Q_,r,e)}function b0(r,e){return G({},t0,r,e)}function x0(r,e){return G({},r0,r,e)}function E0(r,e){return G({},n0,r,e)}function w0(r,e){return G([],i0,r,e)}function v0(r,e){const t=G({},Hi(e)?Vf:jf,r,e);return t.Layer===void 0?Object.assign(t,mo(r,e)):t}function mo(r,e){const t=Hi(e),n=e[e.length-1],i=G({},t?Vf:jf,r,e);if(!i)return;let s=wt(r.getAttribute("queryable"));s===void 0&&(s=n.queryable),i.queryable=s!==void 0?s:!1;let o=Fr(r.getAttribute("cascaded"));o===void 0&&(o=n.cascaded),i.cascaded=o;let a=wt(r.getAttribute("opaque"));a===void 0&&(a=n.opaque),i.opaque=a!==void 0?a:!1;let l=wt(r.getAttribute("noSubsets"));l===void 0&&(l=n.noSubsets),i.noSubsets=l!==void 0?l:!1;let u=rr(r.getAttribute("fixedWidth"));u||(u=n.fixedWidth),i.fixedWidth=u;let c=rr(r.getAttribute("fixedHeight"));c||(c=n.fixedHeight),i.fixedHeight=c;const h=["Style","AuthorityURL"];t?h.push("CRS"):h.push("SRS","Dimension"),h.forEach(function(p){if(p in n){const d=i[p]||[];i[p]=d.concat(n[p])}});const f=["BoundingBox","Attribution"];return t?f.push("Dimension","EX_GeographicBoundingBox","MinScaleDenominator","MaxScaleDenominator"):f.push("LatLonBoundingBox","ScaleHint","Extent"),f.forEach(function(p){if(!(p in i)){const d=n[p];i[p]=d}}),i}function T0(r,e){const t={name:r.getAttribute("name"),units:r.getAttribute("units"),unitSymbol:r.getAttribute("unitSymbol")};return Hi(e)&&Object.assign(t,{default:r.getAttribute("default"),multipleValues:wt(r.getAttribute("multipleValues")),nearestValue:wt(r.getAttribute("nearestValue")),current:wt(r.getAttribute("current")),values:D(r)}),t}function S0(r,e){return{name:r.getAttribute("name"),default:r.getAttribute("default"),nearestValue:wt(r.getAttribute("nearestValue"))}}function R0(r,e){return{min:rr(r.getAttribute("min")),max:rr(r.getAttribute("max"))}}function Er(r,e){return G({},f0,r,e)}function P0(r,e){return G({},a0,r,e)}function A0(r,e){return G({},u0,r,e)}function I0(r,e){return G({},c0,r,e)}function hi(r,e){return G({},l0,r,e)}function Zf(r,e){const t=Er(r,e);if(t){const n=[Fr(r.getAttribute("width")),Fr(r.getAttribute("height"))];return t.size=n,t}}function C0(r,e){const t=Er(r,e);if(t)return t.name=r.getAttribute("name"),t}function L0(r,e){const t=Er(r,e);if(t)return t.type=r.getAttribute("type"),t}function F0(r,e){return G({},h0,r,e)}function Wf(r,e){return G([],d0,r,e)}const M0="_feature",O0="_layer";class cR extends lo{constructor(e){super(),e=e||{},this.featureNS_="http://mapserver.gis.umn.edu/mapserver",this.gmlFormat_=new ae,this.layers_=e.layers?e.layers:null}getLayers(){return this.layers_}setLayers(e){this.layers_=e}readFeatures_(e,t){e.setAttribute("namespaceURI",this.featureNS_);const n=e.localName;let i=[];if(e.childNodes.length===0)return i;if(n=="msGMLOutput")for(let s=0,o=e.childNodes.length;s<o;s++){const a=e.childNodes[s];if(a.nodeType!==Node.ELEMENT_NODE)continue;const l=a,u=t[0],c=O0,h=l.localName.replace(c,"");if(this.layers_&&!this.layers_.includes(h))continue;const f=h+M0;u.featureType=f,u.featureNS=this.featureNS_;const p={};p[f]=Z(this.gmlFormat_.readFeatureElement,this.gmlFormat_);const d=k([u.featureNS,null],p);l.setAttribute("namespaceURI",this.featureNS_);const g=G([],d,l,t,this.gmlFormat_);g&&Rs(i,g)}if(n=="FeatureCollection"){const s=G([],this.gmlFormat_.FEATURE_COLLECTION_PARSERS,e,[{}],this.gmlFormat_);s&&(i=s)}return i}readFeaturesFromNode(e,t){const n={};return t&&Object.assign(n,this.getReadOptions(e,t)),this.readFeatures_(e,[n])}}const fr=[null,"http://www.opengis.net/wmts/1.0"],ti=[null,"http://www.opengis.net/ows/1.1"],N0=k(fr,{Contents:T(Z0)});let D0=class extends Dl{constructor(){super(),this.owsParser_=new Qy}readFromNode(e){let t=e.getAttribute("version");t&&(t=t.trim());let n=this.owsParser_.readFromNode(e);return n?(n.version=t,n=G(n,N0,e,[]),n||null):null}};const U0=k(fr,{Layer:Ee(W0),TileMatrixSet:Ee(q0)}),B0=k(fr,{Style:Ee(H0),Format:Ee(D),TileMatrixSetLink:Ee(Y0),Dimension:Ee(K0),ResourceURL:Ee(J0)},k(ti,{Title:T(D),Abstract:T(D),WGS84BoundingBox:T(Hf),BoundingBox:Ee(Q0),Identifier:T(D)})),G0=k(fr,{LegendURL:Ee(eb)},k(ti,{Title:T(D),Identifier:T(D)})),z0=k(fr,{TileMatrixSet:T(D),TileMatrixSetLimits:T(rb)}),k0=k(fr,{TileMatrixLimits:Z(nb)}),$0=k(fr,{TileMatrix:T(D),MinTileRow:T(Ve),MaxTileRow:T(Ve),MinTileCol:T(Ve),MaxTileCol:T(Ve)}),j0=k(fr,{Default:T(D),Value:Ee(D)},k(ti,{Identifier:T(D)})),qf=k(ti,{LowerCorner:Z(Ua),UpperCorner:Z(Ua)}),V0=k(fr,{WellKnownScaleSet:T(D),TileMatrix:Ee(tb)},k(ti,{SupportedCRS:T(D),Identifier:T(D),BoundingBox:T(Hf)})),X0=k(fr,{TopLeftCorner:T(Ua),ScaleDenominator:T(lt),TileWidth:T(Ve),TileHeight:T(Ve),MatrixWidth:T(Ve),MatrixHeight:T(Ve)},k(ti,{Identifier:T(D)}));function Z0(r,e){return G({},U0,r,e)}function W0(r,e){return G({},B0,r,e)}function q0(r,e){return G({},V0,r,e)}function H0(r,e){const t=G({},G0,r,e);if(!t)return;const n=r.getAttribute("isDefault")==="true";return t.isDefault=n,t}function Y0(r,e){return G({},z0,r,e)}function K0(r,e){return G({},j0,r,e)}function J0(r,e){const t=r.getAttribute("format"),n=r.getAttribute("template"),i=r.getAttribute("resourceType"),s={};return t&&(s.format=t),n&&(s.template=n),i&&(s.resourceType=i),s}function Hf(r,e){const t=G([],qf,r,e);if(t.length==2)return bl(t)}function Q0(r,e){const t=r.getAttribute("crs"),n=G([],qf,r,e);if(n.length==2)return{extent:bl(n),crs:t}}function eb(r,e){const t={};return t.format=r.getAttribute("format"),t.href=Qn(r),t}function Ua(r,e){const t=D(r).split(/\s+/);if(!t||t.length!=2)return;const n=+t[0],i=+t[1];if(!(isNaN(n)||isNaN(i)))return[n,i]}function tb(r,e){return G({},X0,r,e)}function rb(r,e){return G([],k0,r,e)}function nb(r,e){return G({},$0,r,e)}function Yf(r,e,t){const n=[];let i=r(0),s=r(1),o=e(i),a=e(s);const l=[s,i],u=[a,o],c=[1,0],h={};let f=1e5,p,d,g,m,y,_;for(;--f>0&&c.length>0;)g=c.pop(),i=l.pop(),o=u.pop(),_=g.toString(),_ in h||(n.push(o[0],o[1]),h[_]=!0),m=c.pop(),s=l.pop(),a=u.pop(),y=(g+m)/2,p=r(y),d=e(p),Pg(d[0],d[1],o[0],o[1],a[0],a[1])<t?(n.push(a[0],a[1]),_=m.toString(),h[_]=!0):(c.push(m,y,y,g),u.push(a,d,d,o),l.push(s,p,p,i));return n}function ib(r,e,t,n,i){const s=ce("EPSG:4326");return Yf(function(o){return[r,e+(t-e)*o]},Ts(s,n),i)}function sb(r,e,t,n,i){const s=ce("EPSG:4326");return Yf(function(o){return[e+(t-e)*o,r]},Ts(s,n),i)}function ob(r){if(!(r.context instanceof CanvasRenderingContext2D))throw new Error("Only works for render events from Canvas 2D layers");const e=r.inversePixelTransform[0],t=r.inversePixelTransform[1],n=Math.sqrt(e*e+t*t),i=r.frameState,s=an(r.inversePixelTransform.slice(),i.coordinateToPixelTransform),o=Vg(i.viewState.resolution,n);let a;return new Xg(r.context,n,i.extent,s,i.viewState.rotation,o,a)}const ab=new Mr({color:"rgba(0,0,0,0.2)"}),lb=[90,45,30,20,10,5,2,1,30/60,20/60,10/60,5/60,2/60,1/60,30/3600,20/3600,10/3600,5/3600,2/3600,1/3600];class fR extends Vi{constructor(e){e=e||{};const t=Object.assign({updateWhileAnimating:!0,updateWhileInteracting:!0,renderBuffer:0},e);delete t.maxLines,delete t.strokeStyle,delete t.targetSize,delete t.showLabels,delete t.lonLabelFormatter,delete t.latLabelFormatter,delete t.lonLabelPosition,delete t.latLabelPosition,delete t.lonLabelStyle,delete t.latLabelStyle,delete t.intervals,super(t),this.projection_=null,this.maxLat_=1/0,this.maxLon_=1/0,this.minLat_=-1/0,this.minLon_=-1/0,this.maxX_=1/0,this.maxY_=1/0,this.minX_=-1/0,this.minY_=-1/0,this.targetSize_=e.targetSize!==void 0?e.targetSize:100,this.maxLines_=e.maxLines!==void 0?e.maxLines:100,this.meridians_=[],this.parallels_=[],this.strokeStyle_=e.strokeStyle!==void 0?e.strokeStyle:ab,this.fromLonLatTransform_=void 0,this.toLonLatTransform_=void 0,this.projectionCenterLonLat_=null,this.bottomLeft_=null,this.bottomRight_=null,this.topLeft_=null,this.topRight_=null,this.meridiansLabels_=null,this.parallelsLabels_=null,e.showLabels&&(this.lonLabelFormatter_=e.lonLabelFormatter==null?Qu.bind(this,"EW"):e.lonLabelFormatter,this.latLabelFormatter_=e.latLabelFormatter==null?Qu.bind(this,"NS"):e.latLabelFormatter,this.lonLabelPosition_=e.lonLabelPosition==null?0:e.lonLabelPosition,this.latLabelPosition_=e.latLabelPosition==null?1:e.latLabelPosition,this.lonLabelStyleBase_=new nr({text:e.lonLabelStyle!==void 0?e.lonLabelStyle.clone():new Ia({font:"12px Calibri,sans-serif",textBaseline:"bottom",fill:new Or({color:"rgba(0,0,0,1)"}),stroke:new Mr({color:"rgba(255,255,255,1)",width:3})})}),this.lonLabelStyle_=n=>{const i=n.get("graticule_label");return this.lonLabelStyleBase_.getText().setText(i),this.lonLabelStyleBase_},this.latLabelStyleBase_=new nr({text:e.latLabelStyle!==void 0?e.latLabelStyle.clone():new Ia({font:"12px Calibri,sans-serif",textAlign:"right",fill:new Or({color:"rgba(0,0,0,1)"}),stroke:new Mr({color:"rgba(255,255,255,1)",width:3})})}),this.latLabelStyle_=n=>{const i=n.get("graticule_label");return this.latLabelStyleBase_.getText().setText(i),this.latLabelStyleBase_},this.meridiansLabels_=[],this.parallelsLabels_=[],this.addEventListener(Yr.POSTRENDER,this.drawLabels_.bind(this))),this.intervals_=e.intervals!==void 0?e.intervals:lb,this.setSource(new en({loader:this.loaderFunction.bind(this),strategy:this.strategyFunction.bind(this),features:new Cm,overlaps:!1,useSpatialIndex:!1,wrapX:e.wrapX})),this.featurePool_=[],this.lineStyle_=new nr({stroke:this.strokeStyle_}),this.loadedExtent_=null,this.renderedExtent_=null,this.renderedResolution_=null,this.setRenderOrder(null)}strategyFunction(e,t){let n=e.slice();return this.projection_&&this.getSource().getWrapX()&&Ag(n,this.projection_),this.loadedExtent_&&(Ig(this.loadedExtent_,n,t)?n=this.loadedExtent_.slice():this.getSource().removeLoadedExtent(this.loadedExtent_)),[n]}loaderFunction(e,t,n){this.loadedExtent_=e;const i=this.getSource(),s=this.getExtent()||[-1/0,-1/0,1/0,1/0],o=$t(s,e);if(this.renderedExtent_&&Pi(this.renderedExtent_,o)&&this.renderedResolution_===t||(this.renderedExtent_=o,this.renderedResolution_=t,ao(o)))return;const a=Xt(o),l=t*t/4;(!this.projection_||!bi(this.projection_,n))&&this.updateProjectionInfo_(n),this.createGraticule_(o,a,t,l);let c=this.meridians_.length+this.parallels_.length;this.meridiansLabels_&&(c+=this.meridians_.length),this.parallelsLabels_&&(c+=this.parallels_.length);let h;for(;c>this.featurePool_.length;)h=new qt,this.featurePool_.push(h);const f=i.getFeaturesCollection();f.clear();let p=0,d,g;for(d=0,g=this.meridians_.length;d<g;++d)h=this.featurePool_[p++],h.setGeometry(this.meridians_[d]),h.setStyle(this.lineStyle_),f.push(h);for(d=0,g=this.parallels_.length;d<g;++d)h=this.featurePool_[p++],h.setGeometry(this.parallels_[d]),h.setStyle(this.lineStyle_),f.push(h)}addMeridian_(e,t,n,i,s,o){const a=this.getMeridian_(e,t,n,i,o);if(zn(a.getExtent(),s)){if(this.meridiansLabels_){const l=this.lonLabelFormatter_(e);o in this.meridiansLabels_?this.meridiansLabels_[o].text=l:this.meridiansLabels_[o]={geom:new sr([]),text:l}}this.meridians_[o++]=a}return o}addParallel_(e,t,n,i,s,o){const a=this.getParallel_(e,t,n,i,o);if(zn(a.getExtent(),s)){if(this.parallelsLabels_){const l=this.latLabelFormatter_(e);o in this.parallelsLabels_?this.parallelsLabels_[o].text=l:this.parallelsLabels_[o]={geom:new sr([]),text:l}}this.parallels_[o++]=a}return o}drawLabels_(e){const t=e.frameState.viewState.rotation,n=e.frameState.viewState.resolution,i=e.frameState.size,s=e.frameState.extent,o=Xt(s);let a=s;if(t){const d=i[0]*n,g=i[1]*n;a=[o[0]-d/2,o[1]-g/2,o[0]+d/2,o[1]+g/2]}let l=0,u=0,c=this.latLabelPosition_<.5;const h=this.projection_.getExtent(),f=nt(h);if(this.getSource().getWrapX()&&this.projection_.canWrapX()&&!Ss(h,s)){l=Math.floor((s[0]-h[0])/f),u=Math.ceil((s[2]-h[2])/f);const d=Math.abs(t)>Math.PI/2;c=c!==d}const p=ob(e);for(let d=l;d<=u;++d){let g=this.meridians_.length+this.parallels_.length,m,y,_,b;if(this.meridiansLabels_)for(y=0,_=this.meridiansLabels_.length;y<_;++y){const w=this.meridians_[y];if(!t&&d===0)b=this.getMeridianPoint_(w,s,y);else{const x=w.clone();x.translate(d*f,0),x.rotate(-t,o),b=this.getMeridianPoint_(x,a,y),b.rotate(t,o)}m=this.featurePool_[g++],m.setGeometry(b),m.set("graticule_label",this.meridiansLabels_[y].text),p.drawFeature(m,this.lonLabelStyle_(m))}if(this.parallelsLabels_&&(d===l&&c||d===u&&!c))for(y=0,_=this.parallels_.length;y<_;++y){const w=this.parallels_[y];if(!t&&d===0)b=this.getParallelPoint_(w,s,y);else{const x=w.clone();x.translate(d*f,0),x.rotate(-t,o),b=this.getParallelPoint_(x,a,y),b.rotate(t,o)}m=this.featurePool_[g++],m.setGeometry(b),m.set("graticule_label",this.parallelsLabels_[y].text),p.drawFeature(m,this.latLabelStyle_(m))}}}createGraticule_(e,t,n,i){const s=this.getInterval_(n);if(s==-1){this.meridians_.length=0,this.parallels_.length=0,this.meridiansLabels_&&(this.meridiansLabels_.length=0),this.parallelsLabels_&&(this.parallelsLabels_.length=0);return}let o=!1;const a=this.projection_.getExtent(),l=nt(a);this.getSource().getWrapX()&&this.projection_.canWrapX()&&!Ss(a,e)&&(nt(e)>=l?(e[0]=a[0],e[2]=a[2]):o=!0);const u=[Fe(t[0],this.minX_,this.maxX_),Fe(t[1],this.minY_,this.maxY_)],c=this.toLonLatTransform_(u);isNaN(c[1])&&(c[1]=Math.abs(this.maxLat_)>=Math.abs(this.minLat_)?this.maxLat_:this.minLat_);let h=Fe(c[0],this.minLon_,this.maxLon_),f=Fe(c[1],this.minLat_,this.maxLat_);const p=this.maxLines_;let d,g,m,y,_=e;o||(_=[Fe(e[0],this.minX_,this.maxX_),Fe(e[1],this.minY_,this.maxY_),Fe(e[2],this.minX_,this.maxX_),Fe(e[3],this.minY_,this.maxY_)]);const b=un(_,this.toLonLatTransform_,void 0,8);let w=b[3],x=b[2],E=b[1],v=b[0];if(o||(Ln(_,this.bottomLeft_)&&(v=this.minLon_,E=this.minLat_),Ln(_,this.bottomRight_)&&(x=this.maxLon_,E=this.minLat_),Ln(_,this.topLeft_)&&(v=this.minLon_,w=this.maxLat_),Ln(_,this.topRight_)&&(x=this.maxLon_,w=this.maxLat_),w=Fe(w,f,this.maxLat_),x=Fe(x,h,this.maxLon_),E=Fe(E,this.minLat_,f),v=Fe(v,this.minLon_,h)),h=Math.floor(h/s)*s,y=Fe(h,this.minLon_,this.maxLon_),g=this.addMeridian_(y,E,w,i,e,0),d=0,o)for(;(y-=s)>=v&&d++<p;)g=this.addMeridian_(y,E,w,i,e,g);else for(;y!=this.minLon_&&d++<p;)y=Math.max(y-s,this.minLon_),g=this.addMeridian_(y,E,w,i,e,g);if(y=Fe(h,this.minLon_,this.maxLon_),d=0,o)for(;(y+=s)<=x&&d++<p;)g=this.addMeridian_(y,E,w,i,e,g);else for(;y!=this.maxLon_&&d++<p;)y=Math.min(y+s,this.maxLon_),g=this.addMeridian_(y,E,w,i,e,g);for(this.meridians_.length=g,this.meridiansLabels_&&(this.meridiansLabels_.length=g),f=Math.floor(f/s)*s,m=Fe(f,this.minLat_,this.maxLat_),g=this.addParallel_(m,v,x,i,e,0),d=0;m!=this.minLat_&&d++<p;)m=Math.max(m-s,this.minLat_),g=this.addParallel_(m,v,x,i,e,g);for(m=Fe(f,this.minLat_,this.maxLat_),d=0;m!=this.maxLat_&&d++<p;)m=Math.min(m+s,this.maxLat_),g=this.addParallel_(m,v,x,i,e,g);this.parallels_.length=g,this.parallelsLabels_&&(this.parallelsLabels_.length=g)}getInterval_(e){const t=this.projectionCenterLonLat_[0],n=this.projectionCenterLonLat_[1];let i=-1;const s=Math.pow(this.targetSize_*e,2),o=[],a=[];for(let l=0,u=this.intervals_.length;l<u;++l){const c=Fe(this.intervals_[l]/2,0,90),h=Fe(n,-90+c,90-c);if(o[0]=t-c,o[1]=h-c,a[0]=t+c,a[1]=h+c,this.fromLonLatTransform_(o,o),this.fromLonLatTransform_(a,a),Math.pow(a[0]-o[0],2)+Math.pow(a[1]-o[1],2)<=s)break;i=this.intervals_[l]}return i}getMeridian_(e,t,n,i,s){const o=ib(e,t,n,this.projection_,i);let a=this.meridians_[s];return a?(a.setFlatCoordinates("XY",o),a.changed()):(a=new xr(o,"XY"),this.meridians_[s]=a),a}getMeridianPoint_(e,t,n){const i=e.getFlatCoordinates();let s=1,o=i.length-1;i[s]>i[o]&&(s=o,o=1);const a=Math.max(t[1],i[s]),l=Math.min(t[3],i[o]),u=Fe(t[1]+Math.abs(t[1]-t[3])*this.lonLabelPosition_,a,l),h=[i[s-1]+(i[o-1]-i[s-1])*(u-i[s])/(i[o]-i[s]),u],f=this.meridiansLabels_[n].geom;return f.setCoordinates(h),f}getMeridians(){return this.meridians_}getParallel_(e,t,n,i,s){const o=sb(e,t,n,this.projection_,i);let a=this.parallels_[s];return a?(a.setFlatCoordinates("XY",o),a.changed()):a=new xr(o,"XY"),a}getParallelPoint_(e,t,n){const i=e.getFlatCoordinates();let s=0,o=i.length-2;i[s]>i[o]&&(s=o,o=0);const a=Math.max(t[0],i[s]),l=Math.min(t[2],i[o]),u=Fe(t[0]+Math.abs(t[0]-t[2])*this.latLabelPosition_,a,l),c=i[s+1]+(i[o+1]-i[s+1])*(u-i[s])/(i[o]-i[s]),h=[u,c],f=this.parallelsLabels_[n].geom;return f.setCoordinates(h),f}getParallels(){return this.parallels_}updateProjectionInfo_(e){const t=ce("EPSG:4326"),n=e.getWorldExtent();this.maxLat_=n[3],this.maxLon_=n[2],this.minLat_=n[1],this.minLon_=n[0];const i=Ts(e,t);if(this.minLon_<this.maxLon_)this.toLonLatTransform_=i;else{const o=this.minLon_+this.maxLon_/2;this.maxLon_+=360,this.toLonLatTransform_=function(a,l,u){u=u||2;const c=i(a,l,u);for(let h=0,f=c.length;h<f;h+=u)c[h]<o&&(c[h]+=360);return c}}this.fromLonLatTransform_=Ts(t,e);const s=un([this.minLon_,this.minLat_,this.maxLon_,this.maxLat_],this.fromLonLatTransform_,void 0,8);this.minX_=s[0],this.maxX_=s[2],this.minY_=s[1],this.maxY_=s[3],this.bottomLeft_=this.fromLonLatTransform_([this.minLon_,this.minLat_]),this.bottomRight_=this.fromLonLatTransform_([this.maxLon_,this.minLat_]),this.topLeft_=this.fromLonLatTransform_([this.minLon_,this.maxLat_]),this.topRight_=this.fromLonLatTransform_([this.maxLon_,this.maxLat_]),this.projectionCenterLonLat_=this.toLonLatTransform_(Xt(e.getExtent())),isNaN(this.projectionCenterLonLat_[1])&&(this.projectionCenterLonLat_[1]=Math.abs(this.maxLat_)>=Math.abs(this.minLat_)?this.maxLat_:this.minLat_),this.projection_=e}}function yn(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}function Gs(r,e){return r[0]=e[0],r[1]=e[1],r[4]=e[2],r[5]=e[3],r[12]=e[4],r[13]=e[5],r}function Ba(r,e,t,n,i,s,o){o=o??yn();const a=1/(r-e),l=1/(t-n),u=1/(i-s);return o[0]=-2*a,o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[5]=-2*l,o[6]=0,o[7]=0,o[8]=0,o[9]=0,o[10]=2*u,o[11]=0,o[12]=(r+e)*a,o[13]=(n+t)*l,o[14]=(s+i)*u,o[15]=1,o}function Nc(r,e,t,n,i){return i=i??yn(),i[0]=r[0]*e,i[1]=r[1]*e,i[2]=r[2]*e,i[3]=r[3]*e,i[4]=r[4]*t,i[5]=r[5]*t,i[6]=r[6]*t,i[7]=r[7]*t,i[8]=r[8]*n,i[9]=r[9]*n,i[10]=r[10]*n,i[11]=r[11]*n,i[12]=r[12],i[13]=r[13],i[14]=r[14],i[15]=r[15],i}function ub(r,e,t,n,i){i=i??yn();let s,o,a,l,u,c,h,f,p,d,g,m;return r===i?(i[12]=r[0]*e+r[4]*t+r[8]*n+r[12],i[13]=r[1]*e+r[5]*t+r[9]*n+r[13],i[14]=r[2]*e+r[6]*t+r[10]*n+r[14],i[15]=r[3]*e+r[7]*t+r[11]*n+r[15]):(s=r[0],o=r[1],a=r[2],l=r[3],u=r[4],c=r[5],h=r[6],f=r[7],p=r[8],d=r[9],g=r[10],m=r[11],i[0]=s,i[1]=o,i[2]=a,i[3]=l,i[4]=u,i[5]=c,i[6]=h,i[7]=f,i[8]=p,i[9]=d,i[10]=g,i[11]=m,i[12]=s*e+u*t+p*n+r[12],i[13]=o*e+c*t+d*n+r[13],i[14]=a*e+h*t+g*n+r[14],i[15]=l*e+f*t+m*n+r[15]),i}function cb(r,e,t,n){return n=n??yn(),n[0]=1,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=1,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=1,n[11]=0,n[12]=r,n[13]=e,n[14]=t,n[15]=1,n}const fn=34962,Yi=34963,$l=35044,On=35048,hb=5121,fb=5123,db=5125,Kf=5126,Dc=["experimental-webgl","webgl","webkit-3d","moz-webgl"];function pb(r,e){e=Object.assign({preserveDrawingBuffer:!0,antialias:!Zg},e);const t=Dc.length;for(let n=0;n<t;++n)try{const i=r.getContext(Dc[n],e);if(i)return i}catch{}return null}const gb={STATIC_DRAW:$l};class Br{constructor(e,t){this.array_=null,this.type_=e,Ct(e===fn||e===Yi,"A `WebGLArrayBuffer` must either be of type `ELEMENT_ARRAY_BUFFER` or `ARRAY_BUFFER`"),this.usage_=t!==void 0?t:gb.STATIC_DRAW}ofSize(e){return this.array_=new(cs(this.type_))(e),this}fromArray(e){return this.array_=cs(this.type_).from(e),this}fromArrayBuffer(e){return this.array_=new(cs(this.type_))(e),this}getType(){return this.type_}getArray(){return this.array_}setArray(e){const t=cs(this.type_);if(!(e instanceof t))throw new Error(`Expected ${t}`);this.array_=e}getUsage(){return this.usage_}getSize(){return this.array_?this.array_.length:0}}function cs(r){switch(r){case fn:return Float32Array;case Yi:return Uint32Array;default:return Float32Array}}const hs={LOST:"webglcontextlost",RESTORED:"webglcontextrestored"},mb=`
  precision mediump float;

  attribute vec2 a_position;
  varying vec2 v_texCoord;
  varying vec2 v_screenCoord;

  uniform vec2 u_screenSize;

  void main() {
    v_texCoord = a_position * 0.5 + 0.5;
    v_screenCoord = v_texCoord * u_screenSize;
    gl_Position = vec4(a_position, 0.0, 1.0);
  }
`,yb=`
  precision mediump float;

  uniform sampler2D u_image;
  uniform float u_opacity;

  varying vec2 v_texCoord;

  void main() {
    gl_FragColor = texture2D(u_image, v_texCoord) * u_opacity;
  }
`;class Uc{constructor(e){this.gl_=e.webGlContext;const t=this.gl_;this.scaleRatio_=e.scaleRatio||1,this.renderTargetTexture_=t.createTexture(),this.renderTargetTextureSize_=null,this.frameBuffer_=t.createFramebuffer(),this.depthBuffer_=t.createRenderbuffer();const n=t.createShader(t.VERTEX_SHADER);t.shaderSource(n,e.vertexShader||mb),t.compileShader(n);const i=t.createShader(t.FRAGMENT_SHADER);t.shaderSource(i,e.fragmentShader||yb),t.compileShader(i),this.renderTargetProgram_=t.createProgram(),t.attachShader(this.renderTargetProgram_,n),t.attachShader(this.renderTargetProgram_,i),t.linkProgram(this.renderTargetProgram_),this.renderTargetVerticesBuffer_=t.createBuffer();const s=[-1,-1,1,-1,-1,1,1,-1,1,1,-1,1];t.bindBuffer(t.ARRAY_BUFFER,this.renderTargetVerticesBuffer_),t.bufferData(t.ARRAY_BUFFER,new Float32Array(s),t.STATIC_DRAW),this.renderTargetAttribLocation_=t.getAttribLocation(this.renderTargetProgram_,"a_position"),this.renderTargetUniformLocation_=t.getUniformLocation(this.renderTargetProgram_,"u_screenSize"),this.renderTargetOpacityLocation_=t.getUniformLocation(this.renderTargetProgram_,"u_opacity"),this.renderTargetTextureLocation_=t.getUniformLocation(this.renderTargetProgram_,"u_image"),this.uniforms_=[],e.uniforms&&Object.keys(e.uniforms).forEach(o=>{this.uniforms_.push({value:e.uniforms[o],location:t.getUniformLocation(this.renderTargetProgram_,o)})})}getRenderTargetTexture(){return this.renderTargetTexture_}getGL(){return this.gl_}init(e){const t=this.getGL(),n=[t.drawingBufferWidth*this.scaleRatio_,t.drawingBufferHeight*this.scaleRatio_];if(t.bindFramebuffer(t.FRAMEBUFFER,this.getFrameBuffer()),t.bindRenderbuffer(t.RENDERBUFFER,this.getDepthBuffer()),t.viewport(0,0,n[0],n[1]),!this.renderTargetTextureSize_||this.renderTargetTextureSize_[0]!==n[0]||this.renderTargetTextureSize_[1]!==n[1]){this.renderTargetTextureSize_=n;const i=0,s=t.RGBA,o=0,a=t.RGBA,l=t.UNSIGNED_BYTE,u=null;t.bindTexture(t.TEXTURE_2D,this.renderTargetTexture_),t.texImage2D(t.TEXTURE_2D,i,s,n[0],n[1],o,a,l,u),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.renderTargetTexture_,0),t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT16,n[0],n[1]),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,this.depthBuffer_)}}apply(e,t,n,i){const s=this.getGL(),o=e.size;if(s.bindFramebuffer(s.FRAMEBUFFER,t?t.getFrameBuffer():null),s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,this.renderTargetTexture_),!t){const l=me(s.canvas);if(!e.renderTargets[l]){const u=s.getContextAttributes();u&&u.preserveDrawingBuffer&&(s.clearColor(0,0,0,0),s.clearDepth(1),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT)),e.renderTargets[l]=!0}}s.disable(s.DEPTH_TEST),s.enable(s.BLEND),s.blendFunc(s.ONE,s.ONE_MINUS_SRC_ALPHA),s.viewport(0,0,s.drawingBufferWidth,s.drawingBufferHeight),s.bindBuffer(s.ARRAY_BUFFER,this.renderTargetVerticesBuffer_),s.useProgram(this.renderTargetProgram_),s.enableVertexAttribArray(this.renderTargetAttribLocation_),s.vertexAttribPointer(this.renderTargetAttribLocation_,2,s.FLOAT,!1,0,0),s.uniform2f(this.renderTargetUniformLocation_,o[0],o[1]),s.uniform1i(this.renderTargetTextureLocation_,0);const a=e.layerStatesArray[e.layerIndex].opacity;s.uniform1f(this.renderTargetOpacityLocation_,a),this.applyUniforms(e),n&&n(s,e),s.drawArrays(s.TRIANGLES,0,6),i&&i(s,e)}getFrameBuffer(){return this.frameBuffer_}getDepthBuffer(){return this.depthBuffer_}applyUniforms(e){const t=this.getGL();let n,i=1;this.uniforms_.forEach(function(s){if(n=typeof s.value=="function"?s.value(e):s.value,n instanceof HTMLCanvasElement||n instanceof ImageData)s.texture||(s.texture=t.createTexture()),t.activeTexture(t[`TEXTURE${i}`]),t.bindTexture(t.TEXTURE_2D,s.texture),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),n instanceof ImageData?t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,n.width,n.height,0,t.UNSIGNED_BYTE,new Uint8Array(n.data)):t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,n),t.uniform1i(s.location,i++);else if(Array.isArray(n))switch(n.length){case 2:t.uniform2f(s.location,n[0],n[1]);return;case 3:t.uniform3f(s.location,n[0],n[1],n[2]);return;case 4:t.uniform4f(s.location,n[0],n[1],n[2],n[3]);return;default:return}else typeof n=="number"&&t.uniform1f(s.location,n)})}}const tr={PROJECTION_MATRIX:"u_projectionMatrix",SCREEN_TO_WORLD_MATRIX:"u_screenToWorldMatrix",TIME:"u_time",ZOOM:"u_zoom",RESOLUTION:"u_resolution",ROTATION:"u_rotation",VIEWPORT_SIZE_PX:"u_viewportSizePx",PIXEL_RATIO:"u_pixelRatio",HIT_DETECTION:"u_hitDetection"},ze={UNSIGNED_BYTE:hb,UNSIGNED_SHORT:fb,UNSIGNED_INT:db,FLOAT:Kf},zs={};function Bc(r){return"shared/"+r}let Gc=0;function _b(){const r="unique/"+Gc;return Gc+=1,r}function bb(r){let e=zs[r];if(!e){const t=document.createElement("canvas");t.width=1,t.height=1,t.style.position="absolute",t.style.left="0",e={users:0,context:pb(t)},zs[r]=e}return e.users+=1,e.context}function xb(r){const e=zs[r];if(!e||(e.users-=1,e.users>0))return;const t=e.context,n=t.getExtension("WEBGL_lose_context");n&&n.loseContext();const i=t.canvas;i.width=1,i.height=1,delete zs[r]}class Eb extends df{constructor(e){super(),e=e||{},this.boundHandleWebGLContextLost_=this.handleWebGLContextLost.bind(this),this.boundHandleWebGLContextRestored_=this.handleWebGLContextRestored.bind(this),this.canvasCacheKey_=e.canvasCacheKey?Bc(e.canvasCacheKey):_b(),this.gl_=bb(this.canvasCacheKey_),this.bufferCache_={},this.extensionCache_={},this.currentProgram_=null,this.needsToBeRecreated_=!1;const t=this.gl_.canvas;t.addEventListener(hs.LOST,this.boundHandleWebGLContextLost_),t.addEventListener(hs.RESTORED,this.boundHandleWebGLContextRestored_),this.offsetRotateMatrix_=Qe(),this.offsetScaleMatrix_=Qe(),this.tmpMat4_=yn(),this.uniformLocationsByProgram_={},this.attribLocationsByProgram_={},this.uniforms_=[],e.uniforms&&this.setUniforms(e.uniforms),this.postProcessPasses_=e.postProcesses?e.postProcesses.map(n=>new Uc({webGlContext:this.gl_,scaleRatio:n.scaleRatio,vertexShader:n.vertexShader,fragmentShader:n.fragmentShader,uniforms:n.uniforms})):[new Uc({webGlContext:this.gl_})],this.shaderCompileErrors_=null,this.startTime_=Date.now(),this.maxAttributeCount_=this.gl_.getParameter(this.gl_.MAX_VERTEX_ATTRIBS)}setUniforms(e){this.uniforms_=[],this.addUniforms(e)}addUniforms(e){for(const t in e)this.uniforms_.push({name:t,value:e[t]})}canvasCacheKeyMatches(e){return this.canvasCacheKey_===Bc(e)}getExtension(e){if(e in this.extensionCache_)return this.extensionCache_[e];const t=this.gl_.getExtension(e);return this.extensionCache_[e]=t,t}getInstancedRenderingExtension_(){const e=this.getExtension("ANGLE_instanced_arrays");return Ct(!!e,"WebGL extension 'ANGLE_instanced_arrays' is required for vector rendering"),e}bindBuffer(e){const t=this.gl_,n=me(e);let i=this.bufferCache_[n];if(!i){const s=t.createBuffer();i={buffer:e,webGlBuffer:s},this.bufferCache_[n]=i}t.bindBuffer(e.getType(),i.webGlBuffer)}flushBufferData(e){const t=this.gl_;this.bindBuffer(e),t.bufferData(e.getType(),e.getArray(),e.getUsage())}deleteBuffer(e){const t=me(e);delete this.bufferCache_[t]}disposeInternal(){const e=this.gl_.canvas;e.removeEventListener(hs.LOST,this.boundHandleWebGLContextLost_),e.removeEventListener(hs.RESTORED,this.boundHandleWebGLContextRestored_),xb(this.canvasCacheKey_),delete this.gl_}prepareDraw(e,t,n){const i=this.gl_,s=this.getCanvas(),o=e.size,a=e.pixelRatio;(s.width!==o[0]*a||s.height!==o[1]*a)&&(s.width=o[0]*a,s.height=o[1]*a,s.style.width=o[0]+"px",s.style.height=o[1]+"px");for(let l=this.postProcessPasses_.length-1;l>=0;l--)this.postProcessPasses_[l].init(e);i.bindTexture(i.TEXTURE_2D,null),i.clearColor(0,0,0,0),i.depthRange(0,1),i.clearDepth(1),i.clear(i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT),i.enable(i.BLEND),i.blendFunc(i.ONE,t?i.ZERO:i.ONE_MINUS_SRC_ALPHA),n?(i.enable(i.DEPTH_TEST),i.depthFunc(i.LEQUAL)):i.disable(i.DEPTH_TEST)}bindFrameBuffer(e,t){const n=this.getGL();n.bindFramebuffer(n.FRAMEBUFFER,e),t&&n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,t,0)}bindInitialFrameBuffer(){const e=this.getGL(),t=this.postProcessPasses_[0].getFrameBuffer();e.bindFramebuffer(e.FRAMEBUFFER,t);const n=this.postProcessPasses_[0].getRenderTargetTexture();e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,n,0)}bindTexture(e,t,n){const i=this.gl_;i.activeTexture(i.TEXTURE0+t),i.bindTexture(i.TEXTURE_2D,e),i.uniform1i(this.getUniformLocation(n),t)}bindAttribute(e,t,n){const i=this.getGL();this.bindBuffer(e);const s=this.getAttributeLocation(t);i.enableVertexAttribArray(s),i.vertexAttribPointer(s,n,i.FLOAT,!1,0,0)}prepareDrawToRenderTarget(e,t,n,i){const s=this.gl_,o=t.getSize();s.bindFramebuffer(s.FRAMEBUFFER,t.getFramebuffer()),s.bindRenderbuffer(s.RENDERBUFFER,t.getDepthbuffer()),s.viewport(0,0,o[0],o[1]),s.bindTexture(s.TEXTURE_2D,t.getTexture()),s.clearColor(0,0,0,0),s.depthRange(0,1),s.clearDepth(1),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT),s.enable(s.BLEND),s.blendFunc(s.ONE,n?s.ZERO:s.ONE_MINUS_SRC_ALPHA),i?(s.enable(s.DEPTH_TEST),s.depthFunc(s.LEQUAL)):s.disable(s.DEPTH_TEST)}drawElements(e,t){const n=this.gl_;this.getExtension("OES_element_index_uint");const i=n.UNSIGNED_INT,s=4,o=t-e,a=e*s;n.drawElements(n.TRIANGLES,o,i,a)}drawElementsInstanced(e,t,n){const i=this.gl_;this.getExtension("OES_element_index_uint");const s=this.getInstancedRenderingExtension_(),o=i.UNSIGNED_INT,a=4,l=t-e,u=e*a;s.drawElementsInstancedANGLE(i.TRIANGLES,l,o,u,n);for(let c=0;c<this.maxAttributeCount_;c++)s.vertexAttribDivisorANGLE(c,0)}finalizeDraw(e,t,n){for(let i=0,s=this.postProcessPasses_.length;i<s;i++)i===s-1?this.postProcessPasses_[i].apply(e,null,t,n):this.postProcessPasses_[i].apply(e,this.postProcessPasses_[i+1])}getCanvas(){return this.gl_.canvas}getGL(){return this.gl_}applyFrameState(e){const t=e.size,n=e.viewState.rotation,i=e.pixelRatio;this.setUniformFloatValue(tr.TIME,(Date.now()-this.startTime_)*.001),this.setUniformFloatValue(tr.ZOOM,e.viewState.zoom),this.setUniformFloatValue(tr.RESOLUTION,e.viewState.resolution),this.setUniformFloatValue(tr.PIXEL_RATIO,i),this.setUniformFloatVec2(tr.VIEWPORT_SIZE_PX,[t[0],t[1]]),this.setUniformFloatValue(tr.ROTATION,n)}applyHitDetectionUniform(e){const t=this.getUniformLocation(tr.HIT_DETECTION);this.getGL().uniform1i(t,e?1:0),e&&this.setUniformFloatValue(tr.PIXEL_RATIO,.5)}applyUniforms(e){const t=this.gl_;let n,i=0;this.uniforms_.forEach(s=>{if(n=typeof s.value=="function"?s.value(e):s.value,n instanceof HTMLCanvasElement||n instanceof HTMLImageElement||n instanceof ImageData||n instanceof WebGLTexture){n instanceof WebGLTexture&&!s.texture?(s.prevValue=void 0,s.texture=n):s.texture||(s.prevValue=void 0,s.texture=t.createTexture()),this.bindTexture(s.texture,i,s.name),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE);const o=!(n instanceof HTMLImageElement)||n.complete;!(n instanceof WebGLTexture)&&o&&s.prevValue!==n&&(s.prevValue=n,t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,n)),i++}else if(Array.isArray(n)&&n.length===6)this.setUniformMatrixValue(s.name,Gs(this.tmpMat4_,n));else if(Array.isArray(n)&&n.length<=4)switch(n.length){case 2:t.uniform2f(this.getUniformLocation(s.name),n[0],n[1]);return;case 3:t.uniform3f(this.getUniformLocation(s.name),n[0],n[1],n[2]);return;case 4:t.uniform4f(this.getUniformLocation(s.name),n[0],n[1],n[2],n[3]);return;default:return}else typeof n=="number"&&t.uniform1f(this.getUniformLocation(s.name),n)})}useProgram(e,t){this.disableAllAttributes_(),this.gl_.useProgram(e),this.currentProgram_=e,t&&(this.applyFrameState(t),this.applyUniforms(t))}compileShader(e,t){const n=this.gl_,i=n.createShader(t);return n.shaderSource(i,e),n.compileShader(i),i}getProgram(e,t){const n=this.gl_,i=this.compileShader(e,n.FRAGMENT_SHADER),s=this.compileShader(t,n.VERTEX_SHADER),o=n.createProgram();if(n.attachShader(o,i),n.attachShader(o,s),n.linkProgram(o),!n.getShaderParameter(i,n.COMPILE_STATUS)){const a=`Fragment shader compilation failed: ${n.getShaderInfoLog(i)}`;throw new Error(a)}if(n.deleteShader(i),!n.getShaderParameter(s,n.COMPILE_STATUS)){const a=`Vertex shader compilation failed: ${n.getShaderInfoLog(s)}`;throw new Error(a)}if(n.deleteShader(s),!n.getProgramParameter(o,n.LINK_STATUS)){const a=`GL program linking failed: ${n.getProgramInfoLog(o)}`;throw new Error(a)}return o}getUniformLocation(e){const t=me(this.currentProgram_);return this.uniformLocationsByProgram_[t]===void 0&&(this.uniformLocationsByProgram_[t]={}),this.uniformLocationsByProgram_[t][e]===void 0&&(this.uniformLocationsByProgram_[t][e]=this.gl_.getUniformLocation(this.currentProgram_,e)),this.uniformLocationsByProgram_[t][e]}getAttributeLocation(e){const t=me(this.currentProgram_);return this.attribLocationsByProgram_[t]===void 0&&(this.attribLocationsByProgram_[t]={}),this.attribLocationsByProgram_[t][e]===void 0&&(this.attribLocationsByProgram_[t][e]=this.gl_.getAttribLocation(this.currentProgram_,e)),this.attribLocationsByProgram_[t][e]}makeProjectionTransform(e,t){const n=e.size,i=e.viewState.rotation,s=e.viewState.resolution,o=e.viewState.center;return gl(t,0,0,2/(s*n[0]),2/(s*n[1]),-i,-o[0],-o[1]),t}setUniformFloatValue(e,t){this.gl_.uniform1f(this.getUniformLocation(e),t)}setUniformFloatVec2(e,t){this.gl_.uniform2fv(this.getUniformLocation(e),t)}setUniformFloatVec4(e,t){this.gl_.uniform4fv(this.getUniformLocation(e),t)}setUniformMatrixValue(e,t){this.gl_.uniformMatrix4fv(this.getUniformLocation(e),!1,t)}disableAllAttributes_(){for(let e=0;e<this.maxAttributeCount_;e++)this.gl_.disableVertexAttribArray(e)}enableAttributeArray_(e,t,n,i,s,o){const a=this.getAttributeLocation(e);a<0||(this.gl_.enableVertexAttribArray(a),this.gl_.vertexAttribPointer(a,t,n,!1,i,s),o&&this.getInstancedRenderingExtension_().vertexAttribDivisorANGLE(a,1))}enableAttributes_(e,t){const n=wb(e);let i=0;for(let s=0;s<e.length;s++){const o=e[s];o.name&&this.enableAttributeArray_(o.name,o.size,o.type||Kf,n,i,t),i+=o.size*Jf(o.type)}}enableAttributes(e){this.enableAttributes_(e,!1)}enableAttributesInstanced(e){this.enableAttributes_(e,!0)}handleWebGLContextLost(e){Cg(this.bufferCache_),this.currentProgram_=null,e.preventDefault()}handleWebGLContextRestored(){this.needsToBeRecreated_=!0}needsToBeRecreated(){return this.needsToBeRecreated_}createTexture(e,t,n,i){const s=this.gl_;n=n||s.createTexture();const o=i?s.NEAREST:s.LINEAR;s.bindTexture(s.TEXTURE_2D,n),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,o),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,o),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE);const a=0,l=s.RGBA,u=0,c=s.RGBA,h=s.UNSIGNED_BYTE;return t instanceof Uint8Array?s.texImage2D(s.TEXTURE_2D,a,l,e[0],e[1],u,c,h,t):t?s.texImage2D(s.TEXTURE_2D,a,l,c,h,t):s.texImage2D(s.TEXTURE_2D,a,l,e[0],e[1],u,c,h,null),n}}function wb(r){let e=0;for(let t=0;t<r.length;t++){const n=r[t];e+=n.size*Jf(n.type)}return e}function Jf(r){switch(r){case ze.UNSIGNED_BYTE:return Uint8Array.BYTES_PER_ELEMENT;case ze.UNSIGNED_SHORT:return Uint16Array.BYTES_PER_ELEMENT;case ze.UNSIGNED_INT:return Uint32Array.BYTES_PER_ELEMENT;case ze.FLOAT:default:return Float32Array.BYTES_PER_ELEMENT}}class vb extends Lg{constructor(e){super(),this.tile,this.handleTileChange_=this.handleTileChange_.bind(this),this.gutter=e.gutter||0,this.helper=e.helper,this.loaded=!1,this.ready=!1}setTile(e){if(e!==this.tile)if(this.tile&&this.tile.removeEventListener(gt.CHANGE,this.handleTileChange_),this.tile=e,this.loaded=e.getState()===ee.LOADED,this.loaded)this.uploadTile();else{if(e instanceof wl){const t=e.getImage();t instanceof Image&&!t.crossOrigin&&(t.crossOrigin="anonymous")}e.addEventListener(gt.CHANGE,this.handleTileChange_)}}uploadTile(){_l()}setReady(){this.ready=!0,this.dispatchEvent(gt.CHANGE)}handleTileChange_(){this.tile.getState()===ee.LOADED&&(this.loaded=!0,this.uploadTile())}setHelper(e){this.helper=e,this.helper&&this.loaded&&this.uploadTile()}disposeInternal(){this.setHelper(null),this.tile.removeEventListener(gt.CHANGE,this.handleTileChange_)}}function Qf(r,e,t){const n=t?r.LINEAR:r.NEAREST;r.bindTexture(r.TEXTURE_2D,e),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,n),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,n)}function Tb(r,e,t,n){Qf(r,e,n),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,r.RGBA,r.UNSIGNED_BYTE,t)}function zc(r,e,t,n,i,s){const o=r.getGL();let a,l;t instanceof Float32Array?(a=o.FLOAT,r.getExtension("OES_texture_float"),l=r.getExtension("OES_texture_float_linear")!==null):(a=o.UNSIGNED_BYTE,l=!0),Qf(o,e,s&&l);const u=t.byteLength/n[1];let c=1;u%8===0?c=8:u%4===0?c=4:u%2===0&&(c=2);let h;switch(i){case 1:{h=o.LUMINANCE;break}case 2:{h=o.LUMINANCE_ALPHA;break}case 3:{h=o.RGB;break}case 4:{h=o.RGBA;break}default:throw new Error(`Unsupported number of bands: ${i}`)}const f=o.getParameter(o.UNPACK_ALIGNMENT);o.pixelStorei(o.UNPACK_ALIGNMENT,c),o.texImage2D(o.TEXTURE_2D,0,h,n[0],n[1],0,h,a,t),o.pixelStorei(o.UNPACK_ALIGNMENT,f)}let Rn=null;function Sb(){Rn=zr(1,1,void 0,{willReadFrequently:!0})}class Rb extends vb{constructor(e){super(e),this.textures=[],this.renderSize_=Wt(e.grid.getTileSize(e.tile.tileCoord[0])),this.bandCount=NaN;const t=new Br(fn,$l);t.fromArray([0,1,1,1,1,0,0,0]),this.helper.flushBufferData(t),this.coords=t,this.setTile(e.tile)}setHelper(e){var n;const t=(n=this.helper)==null?void 0:n.getGL();if(t){this.helper.deleteBuffer(this.coords);for(let i=0;i<this.textures.length;++i)t.deleteTexture(this.textures[i])}super.setHelper(e),e&&e.flushBufferData(this.coords)}uploadTile(){const e=this.helper,t=e.getGL(),n=this.tile;this.textures.length=0;let i;n instanceof wl||n instanceof Wg?i=n.getImage():i=n.getData();const s=La(i);if(s){const _=t.createTexture();this.textures.push(_),this.bandCount=4,Tb(t,_,s,n.interpolate),this.setReady();return}i=Ca(i);const o=n.getSize(),a=[o[0]+2*this.gutter,o[1]+2*this.gutter],l=i instanceof Float32Array,u=a[0]*a[1],c=l?Float32Array:Uint8Array,h=c.BYTES_PER_ELEMENT,f=i.byteLength/a[1];this.bandCount=Math.floor(f/h/a[0]);const p=Math.ceil(this.bandCount/4);if(p===1){const _=t.createTexture();this.textures.push(_),zc(e,_,i,a,this.bandCount,n.interpolate),this.setReady();return}const d=new Array(p);for(let _=0;_<p;++_){const b=t.createTexture();this.textures.push(b);const w=_<p-1?4:(this.bandCount-1)%4+1;d[_]=new c(u*w)}let g=0,m=0;const y=a[0]*this.bandCount;for(let _=0;_<a[1];++_){for(let b=0;b<y;++b){const w=i[m+b],x=Math.floor(g/this.bandCount),E=b%this.bandCount,v=Math.floor(E/4),A=d[v],P=A.length/u,S=E%4;A[x*P+S]=w,++g}m+=f/h}for(let _=0;_<p;++_){const b=this.textures[_],w=d[_],x=w.length/u;zc(e,b,w,a,x,n.interpolate)}this.setReady()}getImagePixelData_(e,t,n){const i=this.gutter,s=this.renderSize_[0],o=this.renderSize_[1];Rn||Sb(),Rn.clearRect(0,0,1,1);const a=e.width,l=e.height,u=a-2*i,c=l-2*i,h=i+Math.floor(u*(t/s)),f=i+Math.floor(c*(n/o));let p;try{Rn.drawImage(e,h,f,1,1,0,0,1,1),p=Rn.getImageData(0,0,1,1).data}catch{return Rn=null,null}return p}getArrayPixelData_(e,t,n,i){const s=this.gutter,o=this.renderSize_[0],a=this.renderSize_[1],l=t[0],u=t[1],c=l+2*s,h=u+2*s,f=s+Math.floor(l*(n/o)),p=s+Math.floor(u*(i/a));if(e instanceof DataView){const g=e.byteLength/(c*h),m=g*(p*c+f),y=e.buffer.slice(m,m+g);return new DataView(y)}const d=this.bandCount*(p*c+f);return e.slice(d,d+this.bandCount)}getPixelData(e,t){if(!this.loaded)return null;if(this.tile instanceof vl){const n=this.tile.getData(),i=Ca(n);if(i){const s=this.tile.getSize();return this.getArrayPixelData_(i,s,e,t)}return this.getImagePixelData_(La(n),e,t)}return this.getImagePixelData_(this.tile.getImage(),e,t)}}class Ki extends qg{constructor(e,t){super(e),t=t||{},this.inversePixelTransform_=Qe(),this.postProcesses_=t.postProcesses,this.uniforms_=t.uniforms,this.helper,this.onMapChanged_=()=>{this.clearCache(),this.removeHelper()},e.addChangeListener(Oa.MAP,this.onMapChanged_),this.dispatchPreComposeEvent=this.dispatchPreComposeEvent.bind(this),this.dispatchPostComposeEvent=this.dispatchPostComposeEvent.bind(this)}dispatchPreComposeEvent(e,t){const n=this.getLayer();if(n.hasListener(Yr.PRECOMPOSE)){const i=new Xo(Yr.PRECOMPOSE,void 0,t,e);n.dispatchEvent(i)}}dispatchPostComposeEvent(e,t){const n=this.getLayer();if(n.hasListener(Yr.POSTCOMPOSE)){const i=new Xo(Yr.POSTCOMPOSE,void 0,t,e);n.dispatchEvent(i)}}reset(e){this.uniforms_=e.uniforms,this.helper&&this.helper.setUniforms(this.uniforms_)}removeHelper(){this.helper&&(this.helper.dispose(),delete this.helper)}prepareFrame(e){if(this.getLayer().getRenderSource()){let t=!0,n=-1,i;for(let o=0,a=e.layerStatesArray.length;o<a;o++){const l=e.layerStatesArray[o].layer,u=l.getRenderer();if(!(u instanceof Ki)){t=!0;continue}const c=l.getClassName();if((t||c!==i)&&(n+=1,t=!1),i=c,u===this)break}const s="map/"+e.mapId+"/group/"+n;(!this.helper||!this.helper.canvasCacheKeyMatches(s)||this.helper.needsToBeRecreated())&&(this.removeHelper(),this.helper=new Eb({postProcesses:this.postProcesses_,uniforms:this.uniforms_,canvasCacheKey:s}),i&&(this.helper.getCanvas().className=i),this.afterHelperCreated())}return this.prepareFrameInternal(e)}afterHelperCreated(){}prepareFrameInternal(e){return!0}clearCache(){}disposeInternal(){var e;this.clearCache(),this.removeHelper(),(e=this.getLayer())==null||e.removeChangeListener(Oa.MAP,this.onMapChanged_),super.disposeInternal()}dispatchRenderEvent_(e,t,n){const i=this.getLayer();if(i.hasListener(e)){gl(this.inversePixelTransform_,0,0,n.pixelRatio,-n.pixelRatio,0,0,-n.size[1]);const s=new Xo(e,this.inversePixelTransform_,n,t);i.dispatchEvent(s)}}preRender(e,t){this.dispatchRenderEvent_(Yr.PRERENDER,e,t)}postRender(e,t){this.dispatchRenderEvent_(Yr.POSTRENDER,e,t)}}const Pb={TILE_TRANSFORM:"u_tileTransform",TRANSITION_ALPHA:"u_transitionAlpha",DEPTH:"u_depth",RENDER_EXTENT:"u_renderExtent",PATTERN_ORIGIN:"u_patternOrigin",RESOLUTION:"u_resolution",ZOOM:"u_zoom",GLOBAL_ALPHA:"u_globalAlpha",PROJECTION_MATRIX:"u_projectionMatrix",SCREEN_TO_WORLD_MATRIX:"u_screenToWorldMatrix"};function kc(r){return 1/(r+2)}function Ab(){return{tileIds:new Set,representationsByZ:{}}}function $c(r,e){return r.tileIds.has(me(e))}function jc(r,e,t){const n=r.representationsByZ;t in n||(n[t]=new Set),n[t].add(e),r.tileIds.add(me(e.tile))}function qo(r,e){const t=r.layerStatesArray[r.layerIndex];t.extent&&(e=$t(e,of(t.extent,r.viewState.projection)));const n=t.layer.getRenderSource();if(!n.getWrapX()){const i=n.getTileGridForProjection(r.viewState.projection).getExtent();i&&(e=$t(e,i))}return e}function Ga(r,e){return`${me(r)},${r.getKey()},${r.getRevision()},${Sn(e)}`}class Ib extends Ki{constructor(e,t){super(e,{uniforms:t.uniforms,postProcesses:t.postProcesses}),this.renderComplete=!1,this.tileTransform_=Qe(),this.tempMat4=yn(),this.tempTileRange_=new Hg(0,0,0,0),this.tempTileCoord_=Fa(0,0,0),this.tempSize_=[0,0];const n=t.cacheSize!==void 0?t.cacheSize:512;this.tileRepresentationCache=new _f(n),this.frameState=null,this.renderedProjection_=void 0}reset(e){super.reset({uniforms:e.uniforms})}prepareFrameInternal(e){this.renderedProjection_?e.viewState.projection!==this.renderedProjection_&&(this.clearCache(),this.renderedProjection_=e.viewState.projection):this.renderedProjection_=e.viewState.projection;const n=this.getLayer().getRenderSource();return!n||ao(qo(e,e.extent))?!1:n.getState()==="ready"}createTileRepresentation(e){return _l()}enqueueTiles(e,t,n,i,s){const o=e.viewState,a=this.getLayer(),l=a.getRenderSource(),u=l.getTileGridForProjection(o.projection),c=l.getGutterForProjection(o.projection),h=me(l);h in e.wantedTiles||(e.wantedTiles[h]={});const f=e.wantedTiles[h],p=this.tileRepresentationCache,d=a.getMapInternal(),g=Math.max(n-s,u.getMinZoom(),u.getZForResolution(Math.min(a.getMaxResolution(),d?d.getView().getResolutionForZoom(Math.max(a.getMinZoom(),0)):u.getResolution(0)),l.zDirection)),m=o.rotation,y=m?Fg(o.center,o.resolution,m,e.size):void 0;for(let _=n;_>=g;--_){const b=u.getTileRangeForExtentAndZ(t,_,this.tempTileRange_),w=u.getResolution(_);for(let x=b.minX;x<=b.maxX;++x)for(let E=b.minY;E<=b.maxY;++E){if(m&&!u.tileCoordIntersectsViewport([_,x,E],y))continue;const v=Fa(_,x,E,this.tempTileCoord_),A=Ga(l,v);let P,S;if(p.containsKey(A)&&(P=p.get(A),S=P.tile),(!P||P.tile.key!==l.getKey())&&(S=l.getTile(_,x,E,e.pixelRatio,o.projection),!S)||$c(i,S))continue;P?P.setTile(S):(P=this.createTileRepresentation({tile:S,grid:u,helper:this.helper,gutter:c}),p.set(A,P)),jc(i,P,_);const I=S.getKey();f[I]=!0,S.getState()===ee.IDLE&&(e.tileQueue.isKeyQueued(I)||e.tileQueue.enqueue([S,h,u.getTileCoordCenter(v),w]))}}}beforeTilesRender(e,t){this.helper.prepareDraw(this.frameState,!t,!0)}beforeTilesMaskRender(e){return!1}renderTile(e,t,n,i,s,o,a,l,u,c,h){}renderTileMask(e,t,n,i){}drawTile_(e,t,n,i,s,o,a){if(!t.ready)return;const u=t.tile.tileCoord,c=Sn(u),h=c in o?o[c]:1,f=a.getResolution(n),p=Wt(a.getTileSize(n),this.tempSize_),d=a.getOrigin(n),g=a.getTileCoordExtent(u),m=h<1?-1:kc(n);h<1&&(e.animate=!0);const y=e.viewState,_=y.center[0],b=y.center[1],w=p[0]+2*i,x=p[1]+2*i,E=w/x,v=(_-d[0])/(p[0]*f),A=(d[1]-b)/(p[1]*f),P=y.resolution/f,S=u[1],I=u[2];_g(this.tileTransform_),ec(this.tileTransform_,2/(e.size[0]*P/w),-2/(e.size[1]*P/w)),bg(this.tileTransform_,y.rotation),ec(this.tileTransform_,1,1/E),ml(this.tileTransform_,(p[0]*(S-v)-i)/w,(p[1]*(I-A)-i)/x),this.renderTile(t,this.tileTransform_,e,s,f,p,d,g,m,i,h)}renderFrame(e){this.frameState=e,this.renderComplete=!0;const t=this.helper.getGL();this.preRender(t,e);const n=e.viewState,i=this.getLayer(),s=i.getRenderSource(),o=s.getTileGridForProjection(n.projection),a=s.getGutterForProjection(n.projection),l=qo(e,e.extent),u=o.getZForResolution(n.resolution,s.zDirection),c=Ab(),h=i.getPreload();if(e.nextExtent){const b=o.getZForResolution(n.nextResolution,s.zDirection),w=qo(e,e.nextExtent);this.enqueueTiles(e,w,b,c,h)}this.enqueueTiles(e,l,u,c,0),h>0&&setTimeout(()=>{this.enqueueTiles(e,l,u-1,c,h-1)},0);const f={};let p=!1;const d=c.representationsByZ;if(u in d){const b=me(this),w=e.time;for(const x of d[u]){const E=x.tile;if(E.getState()===ee.EMPTY)continue;const v=E.tileCoord;if(x.ready){const S=E.getAlpha(b,w);if(S===1){E.endTransition(b);continue}p=!0;const I=Sn(v);f[I]=S}if(this.renderComplete=!1,this.findAltTiles_(o,v,u+1,c))continue;const P=o.getMinZoom();for(let S=u-1;S>=P&&!this.findAltTiles_(o,v,S,c);--S);}}const g=Object.keys(d).map(Number).sort(Mg);if(this.beforeTilesMaskRender(e))for(let b=0,w=g.length;b<w;++b){const x=g[b];for(const E of d[x]){const v=E.tile.tileCoord;if(Sn(v)in f)continue;const P=o.getTileCoordExtent(v);this.renderTileMask(E,x,P,kc(x))}}this.beforeTilesRender(e,p);for(let b=0,w=g.length;b<w;++b){const x=g[b];for(const E of d[x]){const v=E.tile.tileCoord;Sn(v)in f||this.drawTile_(e,E,x,a,l,f,o)}}if(u in d)for(const b of d[u]){const w=b.tile.tileCoord;Sn(w)in f&&this.drawTile_(e,b,u,a,l,f,o)}this.beforeFinalize(e),this.helper.finalizeDraw(e,this.dispatchPreComposeEvent,this.dispatchPostComposeEvent);const y=this.helper.getCanvas();return this.tileRepresentationCache.expireCache(),this.postRender(t,e),y}beforeFinalize(e){}findAltTiles_(e,t,n,i){const s=e.getTileRangeForTileCoordAndZ(t,n,this.tempTileRange_);if(!s)return!1;let o=!0;const a=this.tileRepresentationCache,l=this.getLayer().getRenderSource();for(let u=s.minX;u<=s.maxX;++u)for(let c=s.minY;c<=s.maxY;++c){const h=Ga(l,[n,u,c]);let f=!1;if(a.containsKey(h)){const p=a.get(h);p.ready&&!$c(i,p.tile)&&(jc(i,p,n),f=!0)}f||(o=!1)}return o}clearCache(){super.clearCache();const e=this.tileRepresentationCache;e.forEach(t=>t.dispose()),e.clear()}afterHelperCreated(){super.afterHelperCreated(),this.tileRepresentationCache.forEach(e=>e.setHelper(this.helper))}disposeInternal(){super.disposeInternal(),delete this.frameState}}const J={...Pb,TILE_TEXTURE_ARRAY:"u_tileTextures",TEXTURE_PIXEL_WIDTH:"u_texturePixelWidth",TEXTURE_PIXEL_HEIGHT:"u_texturePixelHeight",TEXTURE_RESOLUTION:"u_textureResolution",TEXTURE_ORIGIN_X:"u_textureOriginX",TEXTURE_ORIGIN_Y:"u_textureOriginY"},xs={TEXTURE_COORD:"a_textureCoord"},Cb=[{name:xs.TEXTURE_COORD,size:2,type:ze.FLOAT}];class Lb extends Ib{constructor(e,t){super(e,t),this.program_,this.vertexShader_=t.vertexShader,this.fragmentShader_=t.fragmentShader,this.indices_=new Br(Yi,$l),this.indices_.fromArray([0,1,3,1,2,3]),this.paletteTextures_=t.paletteTextures||[]}reset(e){if(super.reset(e),this.helper){const t=this.helper.getGL();for(const n of this.paletteTextures_)n.delete(t)}if(this.vertexShader_=e.vertexShader,this.fragmentShader_=e.fragmentShader,this.paletteTextures_=e.paletteTextures||[],this.helper){this.program_=this.helper.getProgram(this.fragmentShader_,this.vertexShader_);const t=this.helper.getGL();for(const n of this.paletteTextures_)n.getTexture(t)}}afterHelperCreated(){super.afterHelperCreated();const e=this.helper.getGL();for(const t of this.paletteTextures_)t.getTexture(e);this.program_=this.helper.getProgram(this.fragmentShader_,this.vertexShader_),this.helper.flushBufferData(this.indices_)}removeHelper(){if(this.helper){const e=this.helper.getGL();for(const t of this.paletteTextures_)t.delete(e)}super.removeHelper()}createTileRepresentation(e){return new Rb(e)}beforeTilesRender(e,t){super.beforeTilesRender(e,t),this.helper.useProgram(this.program_,e)}renderTile(e,t,n,i,s,o,a,l,u,c,h){const f=this.helper.getGL();this.helper.bindBuffer(e.coords),this.helper.bindBuffer(this.indices_),this.helper.enableAttributes(Cb);let p=0;for(;p<e.textures.length;){const E=`${J.TILE_TEXTURE_ARRAY}[${p}]`;this.helper.bindTexture(e.textures[p],p,E),++p}for(let E=0;E<this.paletteTextures_.length;++E){const v=this.paletteTextures_[E],A=v.getTexture(f);this.helper.bindTexture(A,p,v.name),++p}const d=n.viewState,g=o[0]+2*c,m=o[1]+2*c,_=e.tile.tileCoord,b=_[1],w=_[2];this.helper.setUniformMatrixValue(J.TILE_TRANSFORM,Gs(this.tempMat4,t)),this.helper.setUniformFloatValue(J.TRANSITION_ALPHA,h),this.helper.setUniformFloatValue(J.DEPTH,u);let x=i;c>0&&(x=l,$t(x,i,x)),this.helper.setUniformFloatVec4(J.RENDER_EXTENT,x),this.helper.setUniformFloatValue(J.RESOLUTION,d.resolution),this.helper.setUniformFloatValue(J.ZOOM,d.zoom),this.helper.setUniformFloatValue(J.TEXTURE_PIXEL_WIDTH,g),this.helper.setUniformFloatValue(J.TEXTURE_PIXEL_HEIGHT,m),this.helper.setUniformFloatValue(J.TEXTURE_RESOLUTION,s),this.helper.setUniformFloatValue(J.TEXTURE_ORIGIN_X,a[0]+b*o[0]*s-c*s),this.helper.setUniformFloatValue(J.TEXTURE_ORIGIN_Y,a[1]-w*o[1]*s+c*s),this.helper.drawElements(0,this.indices_.getSize())}getData(e){if(!this.helper.getGL())return null;const n=this.frameState;if(!n)return null;const i=this.getLayer(),s=hr(n.pixelToCoordinateTransform,e.slice()),o=n.viewState,a=i.getExtent();if(a&&!Ln(of(a,o.projection),s))return null;const l=i.getSources(bl([s]),o.resolution);let u,c,h;for(u=l.length-1;u>=0;--u)if(c=l[u],c.getState()==="ready"){if(h=c.getTileGridForProjection(o.projection),c.getWrapX())break;const p=h.getExtent();if(!p||Ln(p,s))break}if(u<0)return null;const f=this.tileRepresentationCache;for(let p=h.getZForResolution(o.resolution);p>=h.getMinZoom();--p){const d=h.getTileCoordForCoordAndZ(s,p),g=Ga(c,d);if(!f.containsKey(g))continue;const m=f.get(g);if(m.tile.getState()===ee.EMPTY)return null;if(!m.loaded)continue;const _=h.getOrigin(p),b=Wt(h.getTileSize(p)),w=h.getResolution(p),x=(s[0]-_[0])/w-d[1]*b[0],E=(_[1]-s[1])/w-d[2]*b[1];return m.getPixelData(x,E)}return null}disposeInternal(){const e=this.helper;if(e){const t=e.getGL();for(const n of this.paletteTextures_)n.delete(t);this.paletteTextures_.length=0,t.deleteProgram(this.program_),delete this.program_,e.deleteBuffer(this.indices_)}super.disposeInternal(),delete this.indices_}}class Fb{constructor(e,t){this.name=e,this.data=t,this.texture_=null}getTexture(e){if(!this.texture_){const t=e.createTexture();e.bindTexture(e.TEXTURE_2D,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,this.data.length/4,1,0,e.RGBA,e.UNSIGNED_BYTE,this.data),this.texture_=t}return this.texture_}delete(e){this.texture_&&e.deleteTexture(this.texture_),this.texture_=null}}function Mb(r,e){return`operator_${r}_${Object.keys(e.functions).length}`}function Gr(r){const e=r.toString();return e.includes(".")?e:e+".0"}function jl(r){if(r.length<2||r.length>4)throw new Error("`formatArray` can only output `vec2`, `vec3` or `vec4` arrays.");return`vec${r.length}(${r.map(Gr).join(", ")})`}function Es(r){const e=Xi(r),t=e.length>3?e[3]:1;return jl([e[0]/255,e[1]/255,e[2]/255,t])}function Ob(r){const e=Wt(r);return jl(e)}const Ho={};let Nb=0;function kn(r){return r in Ho||(Ho[r]=Nb++),Ho[r]}function gr(r){return Gr(kn(r))}function yo(r){return"u_var_"+r}function Vl(){return{variables:{},properties:{},functions:{},bandCount:0,featureId:!1,geometryType:!1}}const Yo="getBandValue",ed="u_paletteTextures",td="featureId",rd="geometryType",za=-9999999;function Db(r,e,t,n){const i=Yg(r,e,t);return Xl(i,e,n)}function ye(r){return(e,t,n)=>{const i=t.args.length,s=new Array(i);for(let o=0;o<i;++o)s[o]=Xl(t.args[o],n,e);return r(s,e)}}const Ub={[re.Get]:(r,e)=>{const n=e.args[0].value;n in r.properties||(r.properties[n]={name:n,type:e.type});let s="a_prop_"+n;return sc(e.type,Ci)&&(s=`(${s} > 0.0)`),s},[re.Id]:r=>(r.featureId=!0,"a_"+td),[re.GeometryType]:r=>(r.geometryType=!0,"a_"+rd),[re.LineMetric]:()=>"currentLineMetric",[re.Var]:(r,e)=>{const n=e.args[0].value;n in r.variables||(r.variables[n]={name:n,type:e.type});let s=yo(n);return sc(e.type,Ci)&&(s=`(${s} > 0.0)`),s},[re.Has]:(r,e)=>{const n=e.args[0].value;return n in r.properties||(r.properties[n]={name:n,type:e.type}),`(a_prop_${n} != ${Gr(za)})`},[re.Resolution]:()=>"u_resolution",[re.Zoom]:()=>"u_zoom",[re.Time]:()=>"u_time",[re.Any]:ye(r=>`(${r.join(" || ")})`),[re.All]:ye(r=>`(${r.join(" && ")})`),[re.Not]:ye(([r])=>`(!${r})`),[re.Equal]:ye(([r,e])=>`(${r} == ${e})`),[re.NotEqual]:ye(([r,e])=>`(${r} != ${e})`),[re.GreaterThan]:ye(([r,e])=>`(${r} > ${e})`),[re.GreaterThanOrEqualTo]:ye(([r,e])=>`(${r} >= ${e})`),[re.LessThan]:ye(([r,e])=>`(${r} < ${e})`),[re.LessThanOrEqualTo]:ye(([r,e])=>`(${r} <= ${e})`),[re.Multiply]:ye(r=>`(${r.join(" * ")})`),[re.Divide]:ye(([r,e])=>`(${r} / ${e})`),[re.Add]:ye(r=>`(${r.join(" + ")})`),[re.Subtract]:ye(([r,e])=>`(${r} - ${e})`),[re.Clamp]:ye(([r,e,t])=>`clamp(${r}, ${e}, ${t})`),[re.Mod]:ye(([r,e])=>`mod(${r}, ${e})`),[re.Pow]:ye(([r,e])=>`pow(${r}, ${e})`),[re.Abs]:ye(([r])=>`abs(${r})`),[re.Floor]:ye(([r])=>`floor(${r})`),[re.Ceil]:ye(([r])=>`ceil(${r})`),[re.Round]:ye(([r])=>`floor(${r} + 0.5)`),[re.Sin]:ye(([r])=>`sin(${r})`),[re.Cos]:ye(([r])=>`cos(${r})`),[re.Atan]:ye(([r,e])=>e!==void 0?`atan(${r}, ${e})`:`atan(${r})`),[re.Sqrt]:ye(([r])=>`sqrt(${r})`),[re.Match]:ye(r=>{const e=r[0],t=r[r.length-1];let n=null;for(let i=r.length-3;i>=1;i-=2){const s=r[i],o=r[i+1];n=`(${e} == ${s} ? ${o} : ${n||t})`}return n}),[re.Between]:ye(([r,e,t])=>`(${r} >= ${e} && ${r} <= ${t})`),[re.Interpolate]:ye(([r,e,...t])=>{let n="";for(let i=0;i<t.length-2;i+=2){const s=t[i],o=n||t[i+1],a=t[i+2],l=t[i+3];let u;r===Gr(1)?u=`(${e} - ${s}) / (${a} - ${s})`:u=`(pow(${r}, (${e} - ${s})) - 1.0) / (pow(${r}, (${a} - ${s})) - 1.0)`,n=`mix(${o}, ${l}, clamp(${u}, 0.0, 1.0))`}return n}),[re.Case]:ye(r=>{const e=r[r.length-1];let t=null;for(let n=r.length-3;n>=0;n-=2){const i=r[n],s=r[n+1];t=`(${i} ? ${s} : ${t||e})`}return t}),[re.In]:ye(([r,...e],t)=>{const n=Mb("in",t),i=[];for(let s=0;s<e.length;s+=1)i.push(`  if (inputValue == ${e[s]}) { return true; }`);return t.functions[n]=`bool ${n}(float inputValue) {
${i.join(`
`)}
  return false;
}`,`${n}(${r})`}),[re.Array]:ye(r=>`vec${r.length}(${r.join(", ")})`),[re.Color]:ye(r=>{if(r.length===1)return`vec4(vec3(${r[0]} / 255.0), 1.0)`;if(r.length===2)return`vec4(vec3(${r[0]} / 255.0), ${r[1]})`;const e=r.slice(0,3).map(n=>`${n} / 255.0`);if(r.length===3)return`vec4(${e.join(", ")}, 1.0)`;const t=r[3];return`vec4(${e.join(", ")}, ${t})`}),[re.Band]:ye(([r,e,t],n)=>{if(!(Yo in n.functions)){let i="";const s=n.bandCount||1;for(let o=0;o<s;o++){const a=Math.floor(o/4);let l=o%4;o===s-1&&l===1&&(l=3);const u=`${J.TILE_TEXTURE_ARRAY}[${a}]`;i+=`  if (band == ${o+1}.0) {
    return texture2D(${u}, v_textureCoord + vec2(dx, dy))[${l}];
  }
`}n.functions[Yo]=`float getBandValue(float band, float xOffset, float yOffset) {
  float dx = xOffset / ${J.TEXTURE_PIXEL_WIDTH};
  float dy = yOffset / ${J.TEXTURE_PIXEL_HEIGHT};
${i}
}`}return`${Yo}(${r}, ${e??"0.0"}, ${t??"0.0"})`}),[re.Palette]:(r,e)=>{const[t,...n]=e.args,i=n.length,s=new Uint8Array(i*4);for(let u=0;u<n.length;u++){const c=n[u].value,h=Xi(c),f=u*4;s[f]=h[0],s[f+1]=h[1],s[f+2]=h[2],s[f+3]=h[3]*255}r.paletteTextures||(r.paletteTextures=[]);const o=`${ed}[${r.paletteTextures.length}]`,a=new Fb(o,s);r.paletteTextures.push(a);const l=Xl(t,pe,r);return`texture2D(${o}, vec2((${l} + 0.5) / ${i}.0, 0.5))`}};function Xl(r,e,t){if(r instanceof Kg){const n=Ub[r.operator];if(n===void 0)throw new Error(`No compiler defined for this operator: ${JSON.stringify(r.operator)}`);return n(t,r,e)}if((r.type&pe)>0)return Gr(r.value);if((r.type&Ci)>0)return r.value.toString();if((r.type&Li)>0)return gr(r.value.toString());if((r.type&_t)>0)return Es(r.value);if((r.type&cn)>0)return jl(r.value);if((r.type&pn)>0)return Ob(r.value);throw new Error(`Unexpected expression ${r.value} (expected type ${Jg(e)})`)}function Bb(){return{"fill-color":"rgba(255,255,255,0.4)","stroke-color":"#3399CC","stroke-width":1.25,"circle-radius":5,"circle-fill-color":"rgba(255,255,255,0.4)","circle-stroke-width":1.25,"circle-stroke-color":"#3399CC"}}const Vc=.985;function W(r,e,t){const n=Qg();return Db(e,t,n,r)}function Gb(r){const e=Xi(r),t=e[0]*256,n=e[1],i=e[2]*256,s=Math.round(e[3]*255);return[t+n,i+s]}const zb=`vec4 unpackColor(vec2 packedColor) {
  return vec4(
    min(floor(packedColor[0] / 256.0) / 255.0, 1.0),
    min(mod(packedColor[0], 256.0) / 255.0, 1.0),
    min(floor(packedColor[1] / 256.0) / 255.0, 1.0),
    min(mod(packedColor[1], 256.0) / 255.0, 1.0)
  );
}`;function Zl(r){return r===_t||r===pn?2:r===cn?4:1}function ka(r){const e=Zl(r);return e>1?`vec${e}`:"float"}function nd(r,e){for(const t in e.variables){const n=e.variables[t],i=yo(n.name);let s=ka(n.type);n.type===_t&&(s="vec4"),r.addUniform(i,s)}for(const t in e.properties){const n=e.properties[t],i=ka(n.type),s=`a_prop_${n.name}`;n.type===_t?r.addAttribute(s,i,`unpackColor(${s})`,"vec4"):r.addAttribute(s,i)}for(const t in e.functions)r.addVertexShaderFunction(e.functions[t]),r.addFragmentShaderFunction(e.functions[t])}function id(r,e){const t={};for(const n in r.variables){const i=r.variables[n],s=yo(i.name);t[s]=()=>{const o=e[i.name];if(typeof o=="number")return o;if(typeof o=="boolean")return o?1:0;if(i.type===_t){const a=[...Xi(o||"#eee")];return a[0]/=255,a[1]/=255,a[2]/=255,a[3]??(a[3]=1),a}return typeof o=="string"?kn(o):o}}return t}function sd(r){const e={};for(const t in r.properties){const n=r.properties[t],i=s=>{const o=s.get(n.name);return n.type===_t?Gb([...Xi(o||"#eee")]):typeof o=="string"?kn(o):typeof o=="boolean"?o?1:0:o};e[`prop_${n.name}`]={size:Zl(n.type),callback:i}}return e}const xn=`#ifdef GL_FRAGMENT_PRECISION_HIGH
precision highp float;
#else
precision mediump float;
#endif
uniform mat4 u_projectionMatrix;
uniform mat4 u_screenToWorldMatrix;
uniform vec2 u_viewportSizePx;
uniform float u_pixelRatio;
uniform float u_globalAlpha;
uniform float u_time;
uniform float u_zoom;
uniform float u_resolution;
uniform float u_rotation;
uniform vec4 u_renderExtent;
uniform vec2 u_patternOrigin;
uniform float u_depth;
uniform mediump int u_hitDetection;

const float PI = 3.141592653589793238;
const float TWO_PI = 2.0 * PI;
float currentLineMetric = 0.; // an actual value will be used in the stroke shaders

${zb}
`,En=Bb();class od{constructor(){this.uniforms_=[],this.attributes_=[],this.hasSymbol_=!1,this.symbolSizeExpression_=`vec2(${Gr(En["circle-radius"])} + ${Gr(En["circle-stroke-width"]*.5)})`,this.symbolRotationExpression_="0.0",this.symbolOffsetExpression_="vec2(0.0)",this.symbolColorExpression_=Es(En["circle-fill-color"]),this.texCoordExpression_="vec4(0.0, 0.0, 1.0, 1.0)",this.discardExpression_="false",this.symbolRotateWithView_=!1,this.hasStroke_=!1,this.strokeWidthExpression_=Gr(En["stroke-width"]),this.strokeColorExpression_=Es(En["stroke-color"]),this.strokeOffsetExpression_="0.",this.strokeCapExpression_=gr("round"),this.strokeJoinExpression_=gr("round"),this.strokeMiterLimitExpression_="10.",this.strokeDistanceFieldExpression_="-1000.",this.strokePatternLengthExpression_=null,this.hasFill_=!1,this.fillColorExpression_=Es(En["fill-color"]),this.vertexShaderFunctions_=[],this.fragmentShaderFunctions_=[]}addUniform(e,t){return this.uniforms_.push({name:e,type:t}),this}addAttribute(e,t,n,i){return this.attributes_.push({name:e,type:t,varyingName:e.replace(/^a_/,"v_"),varyingType:i??t,varyingExpression:n??e}),this}setSymbolSizeExpression(e){return this.hasSymbol_=!0,this.symbolSizeExpression_=e,this}getSymbolSizeExpression(){return this.symbolSizeExpression_}setSymbolRotationExpression(e){return this.symbolRotationExpression_=e,this}setSymbolOffsetExpression(e){return this.symbolOffsetExpression_=e,this}getSymbolOffsetExpression(){return this.symbolOffsetExpression_}setSymbolColorExpression(e){return this.hasSymbol_=!0,this.symbolColorExpression_=e,this}getSymbolColorExpression(){return this.symbolColorExpression_}setTextureCoordinateExpression(e){return this.texCoordExpression_=e,this}setFragmentDiscardExpression(e){return this.discardExpression_=e,this}getFragmentDiscardExpression(){return this.discardExpression_}setSymbolRotateWithView(e){return this.symbolRotateWithView_=e,this}setStrokeWidthExpression(e){return this.hasStroke_=!0,this.strokeWidthExpression_=e,this}setStrokeColorExpression(e){return this.hasStroke_=!0,this.strokeColorExpression_=e,this}getStrokeColorExpression(){return this.strokeColorExpression_}setStrokeOffsetExpression(e){return this.strokeOffsetExpression_=e,this}setStrokeCapExpression(e){return this.strokeCapExpression_=e,this}setStrokeJoinExpression(e){return this.strokeJoinExpression_=e,this}setStrokeMiterLimitExpression(e){return this.strokeMiterLimitExpression_=e,this}setStrokeDistanceFieldExpression(e){return this.strokeDistanceFieldExpression_=e,this}setStrokePatternLengthExpression(e){return this.strokePatternLengthExpression_=e,this}getStrokePatternLengthExpression(){return this.strokePatternLengthExpression_}setFillColorExpression(e){return this.hasFill_=!0,this.fillColorExpression_=e,this}getFillColorExpression(){return this.fillColorExpression_}addVertexShaderFunction(e){return this.vertexShaderFunctions_.includes(e)?this:(this.vertexShaderFunctions_.push(e),this)}addFragmentShaderFunction(e){return this.fragmentShaderFunctions_.includes(e)?this:(this.fragmentShaderFunctions_.push(e),this)}getSymbolVertexShader(){return this.hasSymbol_?`${xn}
${this.uniforms_.map(e=>`uniform ${e.type} ${e.name};`).join(`
`)}
attribute vec2 a_position;
attribute vec2 a_localPosition;
attribute vec2 a_hitColor;

varying vec2 v_texCoord;
varying vec2 v_quadCoord;
varying vec4 v_hitColor;
varying vec2 v_centerPx;
varying float v_angle;
varying vec2 v_quadSizePx;

${this.attributes_.map(e=>`attribute ${e.type} ${e.name};
varying ${e.varyingType} ${e.varyingName};`).join(`
`)}
${this.vertexShaderFunctions_.join(`
`)}
vec2 pxToScreen(vec2 coordPx) {
  vec2 scaled = coordPx / u_viewportSizePx / 0.5;
  return scaled;
}

vec2 screenToPx(vec2 coordScreen) {
  return (coordScreen * 0.5 + 0.5) * u_viewportSizePx;
}

void main(void) {
  v_quadSizePx = ${this.symbolSizeExpression_};
  vec2 halfSizePx = v_quadSizePx * 0.5;
  vec2 centerOffsetPx = ${this.symbolOffsetExpression_};
  vec2 offsetPx = centerOffsetPx + a_localPosition * halfSizePx * vec2(1., -1.);
  float angle = ${this.symbolRotationExpression_}${this.symbolRotateWithView_?" + u_rotation":""};
  float c = cos(-angle);
  float s = sin(-angle);
  offsetPx = vec2(c * offsetPx.x - s * offsetPx.y, s * offsetPx.x + c * offsetPx.y);
  vec4 center = u_projectionMatrix * vec4(a_position, 0.0, 1.0);
  gl_Position = center + vec4(pxToScreen(offsetPx), u_depth, 0.);
  vec4 texCoord = ${this.texCoordExpression_};
  float u = mix(texCoord.s, texCoord.p, a_localPosition.x * 0.5 + 0.5);
  float v = mix(texCoord.t, texCoord.q, a_localPosition.y * 0.5 + 0.5);
  v_texCoord = vec2(u, v);
  v_hitColor = unpackColor(a_hitColor);
  v_angle = angle;
  c = cos(-v_angle);
  s = sin(-v_angle);
  centerOffsetPx = vec2(c * centerOffsetPx.x - s * centerOffsetPx.y, s * centerOffsetPx.x + c * centerOffsetPx.y);
  v_centerPx = screenToPx(center.xy) + centerOffsetPx;
${this.attributes_.map(e=>`  ${e.varyingName} = ${e.varyingExpression};`).join(`
`)}
}`:null}getSymbolFragmentShader(){return this.hasSymbol_?`${xn}
${this.uniforms_.map(e=>`uniform ${e.type} ${e.name};`).join(`
`)}
varying vec2 v_texCoord;
varying vec4 v_hitColor;
varying vec2 v_centerPx;
varying float v_angle;
varying vec2 v_quadSizePx;
${this.attributes_.map(e=>`varying ${e.varyingType} ${e.varyingName};`).join(`
`)}
${this.fragmentShaderFunctions_.join(`
`)}

void main(void) {
${this.attributes_.map(e=>`  ${e.varyingType} ${e.name} = ${e.varyingName}; // assign to original attribute name`).join(`
`)}
  if (${this.discardExpression_}) { discard; }
  vec2 coordsPx = gl_FragCoord.xy / u_pixelRatio - v_centerPx; // relative to center
  float c = cos(v_angle);
  float s = sin(v_angle);
  coordsPx = vec2(c * coordsPx.x - s * coordsPx.y, s * coordsPx.x + c * coordsPx.y);
  gl_FragColor = ${this.symbolColorExpression_};
  gl_FragColor.rgb *= gl_FragColor.a;
  if (u_hitDetection > 0) {
    if (gl_FragColor.a < 0.05) { discard; };
    gl_FragColor = v_hitColor;
  }
}`:null}getStrokeVertexShader(){return this.hasStroke_?`${xn}
${this.uniforms_.map(e=>`uniform ${e.type} ${e.name};`).join(`
`)}
attribute vec2 a_segmentStart;
attribute vec2 a_segmentEnd;
attribute vec2 a_localPosition;
attribute float a_measureStart;
attribute float a_measureEnd;
attribute float a_angleTangentSum;
attribute float a_distanceLow;
attribute float a_distanceHigh;
attribute vec2 a_joinAngles;
attribute vec2 a_hitColor;

varying vec2 v_segmentStartPx;
varying vec2 v_segmentEndPx;
varying float v_angleStart;
varying float v_angleEnd;
varying float v_width;
varying vec4 v_hitColor;
varying float v_distancePx;
varying float v_measureStart;
varying float v_measureEnd;

${this.attributes_.map(e=>`attribute ${e.type} ${e.name};
varying ${e.varyingType} ${e.varyingName};`).join(`
`)}
${this.vertexShaderFunctions_.join(`
`)}
vec2 worldToPx(vec2 worldPos) {
  vec4 screenPos = u_projectionMatrix * vec4(worldPos, 0.0, 1.0);
  return (0.5 * screenPos.xy + 0.5) * u_viewportSizePx;
}

vec4 pxToScreen(vec2 pxPos) {
  vec2 screenPos = 2.0 * pxPos / u_viewportSizePx - 1.0;
  return vec4(screenPos, u_depth, 1.0);
}

bool isCap(float joinAngle) {
  return joinAngle < -0.1;
}

vec2 getJoinOffsetDirection(vec2 normalPx, float joinAngle) {
  float halfAngle = joinAngle / 2.0;
  float c = cos(halfAngle);
  float s = sin(halfAngle);
  vec2 angleBisectorNormal = vec2(s * normalPx.x + c * normalPx.y, -c * normalPx.x + s * normalPx.y);
  float length = 1.0 / s;
  return angleBisectorNormal * length;
}

vec2 getOffsetPoint(vec2 point, vec2 normal, float joinAngle, float offsetPx) {
  // if on a cap or the join angle is too high, offset the line along the segment normal
  if (cos(joinAngle) > 0.998 || isCap(joinAngle)) {
    return point - normal * offsetPx;
  }
  // offset is applied along the inverted normal (positive offset goes "right" relative to line direction)
  return point - getJoinOffsetDirection(normal, joinAngle) * offsetPx;
}

void main(void) {
  v_angleStart = a_joinAngles.x;
  v_angleEnd = a_joinAngles.y;
  float startEndRatio = a_localPosition.x * 0.5 + 0.5;
  currentLineMetric = mix(a_measureStart, a_measureEnd, startEndRatio);
  // we're reading the fractional part while keeping the sign (so -4.12 gives -0.12, 3.45 gives 0.45)

  float lineWidth = ${this.strokeWidthExpression_};
  float lineOffsetPx = ${this.strokeOffsetExpression_};

  // compute segment start/end in px with offset
  vec2 segmentStartPx = worldToPx(a_segmentStart);
  vec2 segmentEndPx = worldToPx(a_segmentEnd);
  vec2 tangentPx = normalize(segmentEndPx - segmentStartPx);
  vec2 normalPx = vec2(-tangentPx.y, tangentPx.x);
  segmentStartPx = getOffsetPoint(segmentStartPx, normalPx, v_angleStart, lineOffsetPx),
  segmentEndPx = getOffsetPoint(segmentEndPx, normalPx, v_angleEnd, lineOffsetPx);

  // compute current vertex position
  float normalDir = -1. * a_localPosition.y;
  float tangentDir = -1. * a_localPosition.x;
  float angle = mix(v_angleStart, v_angleEnd, startEndRatio);
  vec2 joinDirection;
  vec2 positionPx = mix(segmentStartPx, segmentEndPx, startEndRatio);
  // if angle is too high, do not make a proper join
  if (cos(angle) > ${Vc} || isCap(angle)) {
    joinDirection = normalPx * normalDir - tangentPx * tangentDir;
  } else {
    joinDirection = getJoinOffsetDirection(normalPx * normalDir, angle);
  }
  positionPx = positionPx + joinDirection * (lineWidth * 0.5 + 1.); // adding 1 pixel for antialiasing
  gl_Position = pxToScreen(positionPx);

  v_segmentStartPx = segmentStartPx;
  v_segmentEndPx = segmentEndPx;
  v_width = lineWidth;
  v_hitColor = unpackColor(a_hitColor);

  v_distancePx = a_distanceLow / u_resolution - (lineOffsetPx * a_angleTangentSum);
  float distanceHighPx = a_distanceHigh / u_resolution;
  ${this.strokePatternLengthExpression_!==null?`v_distancePx = mod(v_distancePx, ${this.strokePatternLengthExpression_});
  distanceHighPx = mod(distanceHighPx, ${this.strokePatternLengthExpression_});
  `:""}v_distancePx += distanceHighPx;

  v_measureStart = a_measureStart;
  v_measureEnd = a_measureEnd;
${this.attributes_.map(e=>`  ${e.varyingName} = ${e.varyingExpression};`).join(`
`)}
}`:null}getStrokeFragmentShader(){return this.hasStroke_?`${xn}
${this.uniforms_.map(e=>`uniform ${e.type} ${e.name};`).join(`
`)}
varying vec2 v_segmentStartPx;
varying vec2 v_segmentEndPx;
varying float v_angleStart;
varying float v_angleEnd;
varying float v_width;
varying vec4 v_hitColor;
varying float v_distancePx;
varying float v_measureStart;
varying float v_measureEnd;
${this.attributes_.map(e=>`varying ${e.varyingType} ${e.varyingName};`).join(`
`)}
${this.fragmentShaderFunctions_.join(`
`)}

vec2 pxToWorld(vec2 pxPos) {
  vec2 screenPos = 2.0 * pxPos / u_viewportSizePx - 1.0;
  return (u_screenToWorldMatrix * vec4(screenPos, 0.0, 1.0)).xy;
}

bool isCap(float joinAngle) {
  return joinAngle < -0.1;
}

float segmentDistanceField(vec2 point, vec2 start, vec2 end, float width) {
  vec2 tangent = normalize(end - start);
  vec2 normal = vec2(-tangent.y, tangent.x);
  vec2 startToPoint = point - start;
  return abs(dot(startToPoint, normal)) - width * 0.5;
}

float buttCapDistanceField(vec2 point, vec2 start, vec2 end) {
  vec2 startToPoint = point - start;
  vec2 tangent = normalize(end - start);
  return dot(startToPoint, -tangent);
}

float squareCapDistanceField(vec2 point, vec2 start, vec2 end, float width) {
  return buttCapDistanceField(point, start, end) - width * 0.5;
}

float roundCapDistanceField(vec2 point, vec2 start, vec2 end, float width) {
  float onSegment = max(0., 1000. * dot(point - start, end - start)); // this is very high when inside the segment
  return length(point - start) - width * 0.5 - onSegment;
}

float roundJoinDistanceField(vec2 point, vec2 start, vec2 end, float width) {
  return roundCapDistanceField(point, start, end, width);
}

float bevelJoinField(vec2 point, vec2 start, vec2 end, float width, float joinAngle) {
  vec2 startToPoint = point - start;
  vec2 tangent = normalize(end - start);
  float c = cos(joinAngle * 0.5);
  float s = sin(joinAngle * 0.5);
  float direction = -sign(sin(joinAngle));
  vec2 bisector = vec2(c * tangent.x - s * tangent.y, s * tangent.x + c * tangent.y);
  float radius = width * 0.5 * s;
  return dot(startToPoint, bisector * direction) - radius;
}

float miterJoinDistanceField(vec2 point, vec2 start, vec2 end, float width, float joinAngle) {
  if (cos(joinAngle) > ${Vc}) { // avoid risking a division by zero
    return bevelJoinField(point, start, end, width, joinAngle);
  }
  float miterLength = 1. / sin(joinAngle * 0.5);
  float miterLimit = ${this.strokeMiterLimitExpression_};
  if (miterLength > miterLimit) {
    return bevelJoinField(point, start, end, width, joinAngle);
  }
  return -1000.;
}

float capDistanceField(vec2 point, vec2 start, vec2 end, float width, float capType) {
   if (capType == ${gr("butt")}) {
    return buttCapDistanceField(point, start, end);
  } else if (capType == ${gr("square")}) {
    return squareCapDistanceField(point, start, end, width);
  }
  return roundCapDistanceField(point, start, end, width);
}

float joinDistanceField(vec2 point, vec2 start, vec2 end, float width, float joinAngle, float joinType) {
  if (joinType == ${gr("bevel")}) {
    return bevelJoinField(point, start, end, width, joinAngle);
  } else if (joinType == ${gr("miter")}) {
    return miterJoinDistanceField(point, start, end, width, joinAngle);
  }
  return roundJoinDistanceField(point, start, end, width);
}

float computeSegmentPointDistance(vec2 point, vec2 start, vec2 end, float width, float joinAngle, float capType, float joinType) {
  if (isCap(joinAngle)) {
    return capDistanceField(point, start, end, width, capType);
  }
  return joinDistanceField(point, start, end, width, joinAngle, joinType);
}

float distanceFromSegment(vec2 point, vec2 start, vec2 end) {
  vec2 tangent = end - start;
  vec2 startToPoint = point - start;
  // inspire by capsule fn in https://iquilezles.org/articles/distfunctions/
  float h = clamp(dot(startToPoint, tangent) / dot(tangent, tangent), 0.0, 1.0);
  return length(startToPoint - tangent * h);
}

void main(void) {
${this.attributes_.map(e=>`  ${e.varyingType} ${e.name} = ${e.varyingName}; // assign to original attribute name`).join(`
`)}

  vec2 currentPointPx = gl_FragCoord.xy / u_pixelRatio;
  #ifdef GL_FRAGMENT_PRECISION_HIGH
  vec2 worldPos = pxToWorld(currentPointPx);
  if (
    abs(u_renderExtent[0] - u_renderExtent[2]) > 0.0 && (
      worldPos[0] < u_renderExtent[0] ||
      worldPos[1] < u_renderExtent[1] ||
      worldPos[0] > u_renderExtent[2] ||
      worldPos[1] > u_renderExtent[3]
    )
  ) {
    discard;
  }
  #endif

  float segmentLengthPx = length(v_segmentEndPx - v_segmentStartPx);
  segmentLengthPx = max(segmentLengthPx, 1.17549429e-38); // avoid divide by zero
  vec2 segmentTangent = (v_segmentEndPx - v_segmentStartPx) / segmentLengthPx;
  vec2 segmentNormal = vec2(-segmentTangent.y, segmentTangent.x);
  vec2 startToPointPx = currentPointPx - v_segmentStartPx;
  float lengthToPointPx = max(0., min(dot(segmentTangent, startToPointPx), segmentLengthPx));
  float currentLengthPx = lengthToPointPx + v_distancePx;
  float currentRadiusPx = distanceFromSegment(currentPointPx, v_segmentStartPx, v_segmentEndPx);
  float currentRadiusRatio = dot(segmentNormal, startToPointPx) * 2. / v_width;
  currentLineMetric = mix(v_measureStart, v_measureEnd, lengthToPointPx / segmentLengthPx);

  if (${this.discardExpression_}) { discard; }

  float capType = ${this.strokeCapExpression_};
  float joinType = ${this.strokeJoinExpression_};
  float segmentStartDistance = computeSegmentPointDistance(currentPointPx, v_segmentStartPx, v_segmentEndPx, v_width, v_angleStart, capType, joinType);
  float segmentEndDistance = computeSegmentPointDistance(currentPointPx, v_segmentEndPx, v_segmentStartPx, v_width, v_angleEnd, capType, joinType);
  float distanceField = max(
    segmentDistanceField(currentPointPx, v_segmentStartPx, v_segmentEndPx, v_width),
    max(segmentStartDistance, segmentEndDistance)
  );
  distanceField = max(distanceField, ${this.strokeDistanceFieldExpression_});

  vec4 color = ${this.strokeColorExpression_};
  color.a *= smoothstep(0.5, -0.5, distanceField);
  gl_FragColor = color;
  gl_FragColor.a *= u_globalAlpha;
  gl_FragColor.rgb *= gl_FragColor.a;
  if (u_hitDetection > 0) {
    if (gl_FragColor.a < 0.1) { discard; };
    gl_FragColor = v_hitColor;
  }
}`:null}getFillVertexShader(){return this.hasFill_?`${xn}
${this.uniforms_.map(e=>`uniform ${e.type} ${e.name};`).join(`
`)}
attribute vec2 a_position;
attribute vec2 a_hitColor;

varying vec4 v_hitColor;

${this.attributes_.map(e=>`attribute ${e.type} ${e.name};
varying ${e.varyingType} ${e.varyingName};`).join(`
`)}
${this.vertexShaderFunctions_.join(`
`)}
void main(void) {
  gl_Position = u_projectionMatrix * vec4(a_position, u_depth, 1.0);
  v_hitColor = unpackColor(a_hitColor);
${this.attributes_.map(e=>`  ${e.varyingName} = ${e.varyingExpression};`).join(`
`)}
}`:null}getFillFragmentShader(){return this.hasFill_?`${xn}
${this.uniforms_.map(e=>`uniform ${e.type} ${e.name};`).join(`
`)}
varying vec4 v_hitColor;
${this.attributes_.map(e=>`varying ${e.varyingType} ${e.varyingName};`).join(`
`)}
${this.fragmentShaderFunctions_.join(`
`)}
vec2 pxToWorld(vec2 pxPos) {
  vec2 screenPos = 2.0 * pxPos / u_viewportSizePx - 1.0;
  return (u_screenToWorldMatrix * vec4(screenPos, 0.0, 1.0)).xy;
}

vec2 worldToPx(vec2 worldPos) {
  vec4 screenPos = u_projectionMatrix * vec4(worldPos, 0.0, 1.0);
  return (0.5 * screenPos.xy + 0.5) * u_viewportSizePx;
}

void main(void) {
${this.attributes_.map(e=>`  ${e.varyingType} ${e.name} = ${e.varyingName}; // assign to original attribute name`).join(`
`)}
  vec2 pxPos = gl_FragCoord.xy / u_pixelRatio;
  vec2 pxOrigin = worldToPx(u_patternOrigin);
  #ifdef GL_FRAGMENT_PRECISION_HIGH
  vec2 worldPos = pxToWorld(pxPos);
  if (
    abs(u_renderExtent[0] - u_renderExtent[2]) > 0.0 && (
      worldPos[0] < u_renderExtent[0] ||
      worldPos[1] < u_renderExtent[1] ||
      worldPos[0] > u_renderExtent[2] ||
      worldPos[1] > u_renderExtent[3]
    )
  ) {
    discard;
  }
  #endif
  if (${this.discardExpression_}) { discard; }
  gl_FragColor = ${this.fillColorExpression_};
  gl_FragColor.a *= u_globalAlpha;
  gl_FragColor.rgb *= gl_FragColor.a;
  if (u_hitDetection > 0) {
    if (gl_FragColor.a < 0.1) { discard; };
    gl_FragColor = v_hitColor;
  }
}`:null}}class ks{constructor(){this.globalCounter_=0,this.refToFeature_=new Map,this.uidToRef_=new Map,this.freeGlobalRef_=[],this.polygonBatch={entries:{},geometriesCount:0,verticesCount:0,ringsCount:0},this.pointBatch={entries:{},geometriesCount:0},this.lineStringBatch={entries:{},geometriesCount:0,verticesCount:0}}addFeatures(e,t){for(let n=0;n<e.length;n++)this.addFeature(e[n],t)}addFeature(e,t){let n=e.getGeometry();n&&(t&&(n=n.clone(),n.applyTransform(t)),this.addGeometry_(n,e))}clearFeatureEntryInPointBatch_(e){const t=me(e),n=this.pointBatch.entries[t];if(n)return this.pointBatch.geometriesCount-=n.flatCoordss.length,delete this.pointBatch.entries[t],n}clearFeatureEntryInLineStringBatch_(e){const t=me(e),n=this.lineStringBatch.entries[t];if(n)return this.lineStringBatch.verticesCount-=n.verticesCount,this.lineStringBatch.geometriesCount-=n.flatCoordss.length,delete this.lineStringBatch.entries[t],n}clearFeatureEntryInPolygonBatch_(e){const t=me(e),n=this.polygonBatch.entries[t];if(n)return this.polygonBatch.verticesCount-=n.verticesCount,this.polygonBatch.ringsCount-=n.ringsCount,this.polygonBatch.geometriesCount-=n.flatCoordss.length,delete this.polygonBatch.entries[t],n}addGeometry_(e,t){var i;const n=e.getType();switch(n){case"GeometryCollection":{const s=e.getGeometriesArray();for(const o of s)this.addGeometry_(o,t);break}case"MultiPolygon":{const s=e;this.addCoordinates_(n,s.getFlatCoordinates(),s.getEndss(),t,me(t),s.getStride());break}case"MultiLineString":{const s=e;this.addCoordinates_(n,s.getFlatCoordinates(),s.getEnds(),t,me(t),s.getStride());break}case"MultiPoint":{const s=e;this.addCoordinates_(n,s.getFlatCoordinates(),null,t,me(t),s.getStride());break}case"Polygon":{const s=e;this.addCoordinates_(n,s.getFlatCoordinates(),s.getEnds(),t,me(t),s.getStride());break}case"Point":{const s=e;this.addCoordinates_(n,s.getFlatCoordinates(),null,t,me(t),s.getStride());break}case"LineString":case"LinearRing":{const s=e,o=s.getStride();this.addCoordinates_(n,s.getFlatCoordinates(),null,t,me(t),o,(i=s.getLayout)==null?void 0:i.call(s));break}}}addCoordinates_(e,t,n,i,s,o,a){let l;switch(e){case"MultiPolygon":{const u=n;for(let c=0,h=u.length;c<h;c++){let f=u[c];const p=c>0?u[c-1]:null,d=p?p[p.length-1]:0,g=f[f.length-1];f=d>0?f.map(m=>m-d):f,this.addCoordinates_("Polygon",t.slice(d,g),f,i,s,o,a)}break}case"MultiLineString":{const u=n;for(let c=0,h=u.length;c<h;c++){const f=c>0?u[c-1]:0;this.addCoordinates_("LineString",t.slice(f,u[c]),null,i,s,o,a)}break}case"MultiPoint":for(let u=0,c=t.length;u<c;u+=o)this.addCoordinates_("Point",t.slice(u,u+2),null,i,s,null,null);break;case"Polygon":{const u=n;if(i instanceof af){const f=xg(t,u);if(f.length>1){this.addCoordinates_("MultiPolygon",t,f,i,s,o,a);return}}this.polygonBatch.entries[s]||(this.polygonBatch.entries[s]=this.addRefToEntry_(s,{feature:i,flatCoordss:[],verticesCount:0,ringsCount:0,ringsVerticesCounts:[]})),l=t.length/o;const c=n.length,h=n.map((f,p,d)=>p>0?(f-d[p-1])/o:f/o);this.polygonBatch.verticesCount+=l,this.polygonBatch.ringsCount+=c,this.polygonBatch.geometriesCount++,this.polygonBatch.entries[s].flatCoordss.push(kb(t,o)),this.polygonBatch.entries[s].ringsVerticesCounts.push(h),this.polygonBatch.entries[s].verticesCount+=l,this.polygonBatch.entries[s].ringsCount+=c;for(let f=0,p=u.length;f<p;f++){const d=f>0?u[f-1]:0;this.addCoordinates_("LinearRing",t.slice(d,u[f]),null,i,s,o,a)}break}case"Point":this.pointBatch.entries[s]||(this.pointBatch.entries[s]=this.addRefToEntry_(s,{feature:i,flatCoordss:[]})),this.pointBatch.geometriesCount++,this.pointBatch.entries[s].flatCoordss.push(t);break;case"LineString":case"LinearRing":this.lineStringBatch.entries[s]||(this.lineStringBatch.entries[s]=this.addRefToEntry_(s,{feature:i,flatCoordss:[],verticesCount:0})),l=t.length/o,this.lineStringBatch.verticesCount+=l,this.lineStringBatch.geometriesCount++,this.lineStringBatch.entries[s].flatCoordss.push($b(t,o,a)),this.lineStringBatch.entries[s].verticesCount+=l;break}}addRefToEntry_(e,t){const n=this.uidToRef_.get(e),i=n||this.freeGlobalRef_.pop()||++this.globalCounter_;return t.ref=i,n||(this.refToFeature_.set(i,t.feature),this.uidToRef_.set(e,i)),t}removeRef_(e,t){if(!e)throw new Error("This feature has no ref: "+t);this.refToFeature_.delete(e),this.uidToRef_.delete(t),this.freeGlobalRef_.push(e)}changeFeature(e,t){if(!this.uidToRef_.get(me(e)))return;this.removeFeature(e);let n=e.getGeometry();n&&(t&&(n=n.clone(),n.applyTransform(t)),this.addGeometry_(n,e))}removeFeature(e){let t=this.clearFeatureEntryInPointBatch_(e);t=this.clearFeatureEntryInPolygonBatch_(e)||t,t=this.clearFeatureEntryInLineStringBatch_(e)||t,t&&this.removeRef_(t.ref,me(t.feature))}clear(){this.polygonBatch.entries={},this.polygonBatch.geometriesCount=0,this.polygonBatch.verticesCount=0,this.polygonBatch.ringsCount=0,this.lineStringBatch.entries={},this.lineStringBatch.geometriesCount=0,this.lineStringBatch.verticesCount=0,this.pointBatch.entries={},this.pointBatch.geometriesCount=0,this.globalCounter_=0,this.freeGlobalRef_=[],this.refToFeature_.clear(),this.uidToRef_.clear()}getFeatureFromRef(e){return this.refToFeature_.get(e)}isEmpty(){return this.globalCounter_===0}filter(e){const t=new ks;t.globalCounter_=this.globalCounter_,t.uidToRef_=this.uidToRef_,t.refToFeature_=this.refToFeature_;let n=!0;for(const i of this.refToFeature_.values())e(i)&&(t.addFeature(i),n=!1);return n?new ks:t}}function kb(r,e){return e===2?r:r.filter((t,n)=>n%e<2)}function $b(r,e,t){return e===3&&t==="XYM"?r:e===4?r.filter((n,i)=>i%e!==2):e===3?r.map((n,i)=>i%e!==2?n:0):new Array(r.length*1.5).fill(0).map((n,i)=>i%3===2?0:r[Math.round(i/1.5)])}function ad(){const r='function t(t,n,x=2){const o=n&&n.length,i=o?n[0]*x:t.length;let f=e(t,0,i,x,!0);const l=[];if(!f||f.next===f.prev)return l;let c,y,h;if(o&&(f=function(t,n,r,x){const o=[];for(let r=0,i=n.length;r<i;r++){const f=e(t,n[r]*x,r<i-1?n[r+1]*x:t.length,x,!1);f===f.next&&(f.steiner=!0),o.push(a(f))}o.sort(u);for(let t=0;t<o.length;t++)r=s(o[t],r);return r}(t,n,f,x)),t.length>80*x){c=t[0],y=t[1];let e=c,n=y;for(let r=x;r<i;r+=x){const x=t[r],o=t[r+1];x<c&&(c=x),o<y&&(y=o),x>e&&(e=x),o>n&&(n=o)}h=Math.max(e-c,n-y),h=0!==h?32767/h:0}return r(f,l,x,c,y,h,0),l}function e(t,e,n,r,x){let o;if(x===function(t,e,n,r){let x=0;for(let o=e,i=n-r;o<n;o+=r)x+=(t[i]-t[o])*(t[o+1]+t[i+1]),i=o;return x}(t,e,n,r)>0)for(let x=e;x<n;x+=r)o=d(x/r|0,t[x],t[x+1],o);else for(let x=n-r;x>=e;x-=r)o=d(x/r|0,t[x],t[x+1],o);return o&&b(o,o.next)&&(w(o),o=o.next),o}function n(t,e){if(!t)return t;e||(e=t);let n,r=t;do{if(n=!1,r.steiner||!b(r,r.next)&&0!==v(r.prev,r,r.next))r=r.next;else{if(w(r),r=e=r.prev,r===r.next)break;n=!0}}while(n||r!==e);return e}function r(t,e,u,s,l,a,y){if(!t)return;!y&&a&&function(t,e,n,r){let x=t;do{0===x.z&&(x.z=c(x.x,x.y,e,n,r)),x.prevZ=x.prev,x.nextZ=x.next,x=x.next}while(x!==t);x.prevZ.nextZ=null,x.prevZ=null,function(t){let e,n=1;do{let r,x=t;t=null;let o=null;for(e=0;x;){e++;let i=x,f=0;for(let t=0;t<n&&(f++,i=i.nextZ,i);t++);let u=n;for(;f>0||u>0&&i;)0!==f&&(0===u||!i||x.z<=i.z)?(r=x,x=x.nextZ,f--):(r=i,i=i.nextZ,u--),o?o.nextZ=r:t=r,r.prevZ=o,o=r;x=i}o.nextZ=null,n*=2}while(e>1)}(x)}(t,s,l,a);let h=t;for(;t.prev!==t.next;){const c=t.prev,p=t.next;if(a?o(t,s,l,a):x(t))e.push(c.i,t.i,p.i),w(t),t=p.next,h=p.next;else if((t=p)===h){y?1===y?r(t=i(n(t),e),e,u,s,l,a,2):2===y&&f(t,e,u,s,l,a):r(n(t),e,u,s,l,a,1);break}}}function x(t){const e=t.prev,n=t,r=t.next;if(v(e,n,r)>=0)return!1;const x=e.x,o=n.x,i=r.x,f=e.y,u=n.y,s=r.y,l=Math.min(x,o,i),c=Math.min(f,u,s),a=Math.max(x,o,i),y=Math.max(f,u,s);let p=r.next;for(;p!==e;){if(p.x>=l&&p.x<=a&&p.y>=c&&p.y<=y&&h(x,f,o,u,i,s,p.x,p.y)&&v(p.prev,p,p.next)>=0)return!1;p=p.next}return!0}function o(t,e,n,r){const x=t.prev,o=t,i=t.next;if(v(x,o,i)>=0)return!1;const f=x.x,u=o.x,s=i.x,l=x.y,a=o.y,y=i.y,p=Math.min(f,u,s),b=Math.min(l,a,y),M=Math.max(f,u,s),m=Math.max(l,a,y),A=c(p,b,e,n,r),g=c(M,m,e,n,r);let Z=t.prevZ,d=t.nextZ;for(;Z&&Z.z>=A&&d&&d.z<=g;){if(Z.x>=p&&Z.x<=M&&Z.y>=b&&Z.y<=m&&Z!==x&&Z!==i&&h(f,l,u,a,s,y,Z.x,Z.y)&&v(Z.prev,Z,Z.next)>=0)return!1;if(Z=Z.prevZ,d.x>=p&&d.x<=M&&d.y>=b&&d.y<=m&&d!==x&&d!==i&&h(f,l,u,a,s,y,d.x,d.y)&&v(d.prev,d,d.next)>=0)return!1;d=d.nextZ}for(;Z&&Z.z>=A;){if(Z.x>=p&&Z.x<=M&&Z.y>=b&&Z.y<=m&&Z!==x&&Z!==i&&h(f,l,u,a,s,y,Z.x,Z.y)&&v(Z.prev,Z,Z.next)>=0)return!1;Z=Z.prevZ}for(;d&&d.z<=g;){if(d.x>=p&&d.x<=M&&d.y>=b&&d.y<=m&&d!==x&&d!==i&&h(f,l,u,a,s,y,d.x,d.y)&&v(d.prev,d,d.next)>=0)return!1;d=d.nextZ}return!0}function i(t,e){let r=t;do{const n=r.prev,x=r.next.next;!b(n,x)&&M(n,r,r.next,x)&&g(n,x)&&g(x,n)&&(e.push(n.i,r.i,x.i),w(r),w(r.next),r=t=x),r=r.next}while(r!==t);return n(r)}function f(t,e,x,o,i,f){let u=t;do{let t=u.next.next;for(;t!==u.prev;){if(u.i!==t.i&&p(u,t)){let s=Z(u,t);return u=n(u,u.next),s=n(s,s.next),r(u,e,x,o,i,f,0),void r(s,e,x,o,i,f,0)}t=t.next}u=u.next}while(u!==t)}function u(t,e){let n=t.x-e.x;if(0===n&&(n=t.y-e.y,0===n)){n=(t.next.y-t.y)/(t.next.x-t.x)-(e.next.y-e.y)/(e.next.x-e.x)}return n}function s(t,e){const r=function(t,e){let n=e;const r=t.x,x=t.y;let o,i=-1/0;if(b(t,n))return n;do{if(b(t,n.next))return n.next;if(x<=n.y&&x>=n.next.y&&n.next.y!==n.y){const t=n.x+(x-n.y)*(n.next.x-n.x)/(n.next.y-n.y);if(t<=r&&t>i&&(i=t,o=n.x<n.next.x?n:n.next,t===r))return o}n=n.next}while(n!==e);if(!o)return null;const f=o,u=o.x,s=o.y;let c=1/0;n=o;do{if(r>=n.x&&n.x>=u&&r!==n.x&&y(x<s?r:i,x,u,s,x<s?i:r,x,n.x,n.y)){const e=Math.abs(x-n.y)/(r-n.x);g(n,t)&&(e<c||e===c&&(n.x>o.x||n.x===o.x&&l(o,n)))&&(o=n,c=e)}n=n.next}while(n!==f);return o}(t,e);if(!r)return e;const x=Z(r,t);return n(x,x.next),n(r,r.next)}function l(t,e){return v(t.prev,t,e.prev)<0&&v(e.next,t,t.next)<0}function c(t,e,n,r,x){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-n)*x|0)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-r)*x|0)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function a(t){let e=t,n=t;do{(e.x<n.x||e.x===n.x&&e.y<n.y)&&(n=e),e=e.next}while(e!==t);return n}function y(t,e,n,r,x,o,i,f){return(x-i)*(e-f)>=(t-i)*(o-f)&&(t-i)*(r-f)>=(n-i)*(e-f)&&(n-i)*(o-f)>=(x-i)*(r-f)}function h(t,e,n,r,x,o,i,f){return!(t===i&&e===f)&&y(t,e,n,r,x,o,i,f)}function p(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!function(t,e){let n=t;do{if(n.i!==t.i&&n.next.i!==t.i&&n.i!==e.i&&n.next.i!==e.i&&M(n,n.next,t,e))return!0;n=n.next}while(n!==t);return!1}(t,e)&&(g(t,e)&&g(e,t)&&function(t,e){let n=t,r=!1;const x=(t.x+e.x)/2,o=(t.y+e.y)/2;do{n.y>o!=n.next.y>o&&n.next.y!==n.y&&x<(n.next.x-n.x)*(o-n.y)/(n.next.y-n.y)+n.x&&(r=!r),n=n.next}while(n!==t);return r}(t,e)&&(v(t.prev,t,e.prev)||v(t,e.prev,e))||b(t,e)&&v(t.prev,t,t.next)>0&&v(e.prev,e,e.next)>0)}function v(t,e,n){return(e.y-t.y)*(n.x-e.x)-(e.x-t.x)*(n.y-e.y)}function b(t,e){return t.x===e.x&&t.y===e.y}function M(t,e,n,r){const x=A(v(t,e,n)),o=A(v(t,e,r)),i=A(v(n,r,t)),f=A(v(n,r,e));return x!==o&&i!==f||(!(0!==x||!m(t,n,e))||(!(0!==o||!m(t,r,e))||(!(0!==i||!m(n,t,r))||!(0!==f||!m(n,e,r)))))}function m(t,e,n){return e.x<=Math.max(t.x,n.x)&&e.x>=Math.min(t.x,n.x)&&e.y<=Math.max(t.y,n.y)&&e.y>=Math.min(t.y,n.y)}function A(t){return t>0?1:t<0?-1:0}function g(t,e){return v(t.prev,t,t.next)<0?v(t,e,t.next)>=0&&v(t,t.prev,e)>=0:v(t,e,t.prev)<0||v(t,t.next,e)<0}function Z(t,e){const n=F(t.i,t.x,t.y),r=F(e.i,e.x,e.y),x=t.next,o=e.prev;return t.next=e,e.prev=t,n.next=x,x.prev=n,r.next=n,n.prev=r,o.next=r,r.prev=o,r}function d(t,e,n,r){const x=F(t,e,n);return r?(x.next=r.next,x.prev=r,r.next.prev=x,r.next=x):(x.prev=x,x.next=x),x}function w(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function F(t,e,n){return{i:t,x:e,y:n,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}function E(t,e){const n=e[0],r=e[1];return e[0]=t[0]*n+t[2]*r+t[4],e[1]=t[1]*n+t[3]*r+t[5],e}function I(t,e){const n=(r=e)[0]*r[3]-r[1]*r[2];var r;!function(t,e){if(!t)throw new Error(e)}(0!==n,"Transformation matrix cannot be inverted");const x=e[0],o=e[1],i=e[2],f=e[3],u=e[4],s=e[5];return t[0]=f/n,t[1]=-o/n,t[2]=-i/n,t[3]=x/n,t[4]=(i*s-f*u)/n,t[5]=-(x*s-o*u)/n,t}new Array(6);const z=[],B={vertexAttributesPosition:0,instanceAttributesPosition:0,indicesPosition:0};function P(t,e,n,r,x){const o=t[e++],i=t[e++],f=z;f.length=r;for(let n=0;n<f.length;n++)f[n]=t[e+n];let u=x?x.instanceAttributesPosition:0;return n[u++]=o,n[u++]=i,f.length&&(n.set(f,u),u+=f.length),B.instanceAttributesPosition=u,B}function N(t,e,n,r,x,o,i,f,u,s){const l=[t[e],t[e+1]],c=[t[n],t[n+1]],a=t[e+2],y=t[n+2],h=E(f,[...l]),p=E(f,[...c]);function v(t,e,n){const r=Math.sqrt((e[0]-t[0])*(e[0]-t[0])+(e[1]-t[1])*(e[1]-t[1])),x=[(e[0]-t[0])/r,(e[1]-t[1])/r],o=[-x[1],x[0]],i=Math.sqrt((n[0]-t[0])*(n[0]-t[0])+(n[1]-t[1])*(n[1]-t[1])),f=[(n[0]-t[0])/i,(n[1]-t[1])/i];let u=0===r||0===i?0:Math.acos((s=f[0]*x[0]+f[1]*x[1],l=-1,c=1,Math.min(Math.max(s,l),c)));var s,l,c;u=Math.max(u,1e-5);return f[0]*o[0]+f[1]*o[1]>0?u:2*Math.PI-u}let b=-1,M=-1,m=s;const A=null!==x;if(null!==r){b=v(h,p,E(f,[...[t[r],t[r+1]]])),Math.cos(b)<=.985&&(m+=Math.tan((b-Math.PI)/2))}if(A){M=v(p,h,E(f,[...[t[x],t[x+1]]])),Math.cos(M)<=.985&&(m+=Math.tan((Math.PI-M)/2))}const g=Math.pow(2,24),Z=u%g,d=Math.floor(u/g)*g;return o.push(l[0],l[1],a,c[0],c[1],y,b,M,Z,d,s),o.push(...i),{length:u+Math.sqrt((p[0]-h[0])*(p[0]-h[0])+(p[1]-h[1])*(p[1]-h[1])),angle:m}}function R(e,n,r,x,o){const i=2+o;let f=n;const u=e.slice(f,f+o);f+=o;const s=e[f++];let l=0;const c=new Array(s-1);for(let t=0;t<s;t++)l+=e[f++],t<s-1&&(c[t]=l);const a=e.slice(f,f+2*l),y=t(a,c,2);for(let t=0;t<y.length;t++)x.push(y[t]+r.length/i);for(let t=0;t<a.length;t+=2)r.push(a[t],a[t+1],...u);return f+2*l}const S="GENERATE_POLYGON_BUFFERS",T="GENERATE_POINT_BUFFERS",_="GENERATE_LINE_STRING_BUFFERS",O=self;O.onmessage=t=>{const e=t.data;switch(e.type){case T:{const t=2,n=2,r=e.customAttributesSize,x=n+r,o=new Float32Array(e.renderInstructions),i=o.length/x*(t+r),f=Uint32Array.from([0,1,3,1,2,3]),u=Float32Array.from([-1,-1,1,-1,1,1,-1,1]),s=new Float32Array(i);let l;for(let t=0;t<o.length;t+=x)l=P(o,t,s,r,l);const c=Object.assign({indicesBuffer:f.buffer,vertexAttributesBuffer:u.buffer,instanceAttributesBuffer:s.buffer,renderInstructions:o.buffer},e);O.postMessage(c,[u.buffer,s.buffer,f.buffer,o.buffer]);break}case _:{const t=[],n=e.customAttributesSize,r=3,x=new Float32Array(e.renderInstructions);let o=0;const i=[1,0,0,1,0,0];let f,u;for(I(i,e.renderInstructionsTransform);o<x.length;){u=Array.from(x.slice(o,o+n)),o+=n,f=x[o++];const e=o,s=o+(f-1)*r,l=x[e]===x[s]&&x[e+1]===x[s+1];let c=0,a=0;for(let n=0;n<f-1;n++){let y=null;n>0?y=o+(n-1)*r:l&&(y=s-r);let h=null;n<f-2?h=o+(n+2)*r:l&&(h=e+r);const p=N(x,o+n*r,o+(n+1)*r,y,h,t,u,i,c,a);c=p.length,a=p.angle}o+=f*r}const s=Uint32Array.from([0,1,3,1,2,3]),l=Float32Array.from([-1,-1,1,-1,1,1,-1,1]),c=Float32Array.from(t),a=Object.assign({indicesBuffer:s.buffer,vertexAttributesBuffer:l.buffer,instanceAttributesBuffer:c.buffer,renderInstructions:x.buffer},e);O.postMessage(a,[l.buffer,c.buffer,s.buffer,x.buffer]);break}case S:{const t=[],n=[],r=e.customAttributesSize,x=new Float32Array(e.renderInstructions);let o=0;for(;o<x.length;)o=R(x,o,t,n,r);const i=Uint32Array.from(n),f=Float32Array.from(t),u=Float32Array.from([]),s=Object.assign({indicesBuffer:i.buffer,vertexAttributesBuffer:f.buffer,instanceAttributesBuffer:u.buffer,renderInstructions:x.buffer},e);O.postMessage(s,[f.buffer,u.buffer,i.buffer,x.buffer]);break}}};';return new Worker(typeof Blob>"u"?"data:application/javascript;base64,"+Buffer.from(r,"binary").toString("base64"):URL.createObjectURL(new Blob([r],{type:"application/javascript"})))}const xi={GENERATE_POLYGON_BUFFERS:"GENERATE_POLYGON_BUFFERS",GENERATE_POINT_BUFFERS:"GENERATE_POINT_BUFFERS",GENERATE_LINE_STRING_BUFFERS:"GENERATE_LINE_STRING_BUFFERS"};function ld(r,e){e=e||[];const t=256,n=t-1,i=Math.floor(r/t/t/t)/n,s=Math.floor(r/t/t)%t/n,o=Math.floor(r/t)%t/n,a=r%t/n;return e[0]=i*256*255+s*255,e[1]=o*256*255+a*255,e}function ud(r){let e=0;const t=256,n=t-1;return e+=Math.round(r[0]*t*t*t*n),e+=Math.round(r[1]*t*t*n),e+=Math.round(r[2]*t*n),e+=Math.round(r[3]*n),e}function Wl(r,e,t,n){let i=0;for(const s in e){const o=e[s],a=o.callback.call(t,t.feature);let l=(a==null?void 0:a[0])??a;l===za&&console.warn('The "has" operator might return false positives.'),l===void 0?l=za:l===null&&(l=0),r[n+i++]=l,!(!o.size||o.size===1)&&(r[n+i++]=a[1],!(o.size<3)&&(r[n+i++]=a[2],!(o.size<4)&&(r[n+i++]=a[3])))}return i}function _o(r){return Object.keys(r).reduce((e,t)=>e+(r[t].size||1),0)}function jb(r,e,t,n){const i=(2+_o(t))*r.geometriesCount;(!e||e.length!==i)&&(e=new Float32Array(i));const s=[];let o=0;for(const a in r.entries){const l=r.entries[a];for(let u=0,c=l.flatCoordss.length;u<c;u++)s[0]=l.flatCoordss[u][0],s[1]=l.flatCoordss[u][1],hr(n,s),e[o++]=s[0],e[o++]=s[1],o+=Wl(e,t,l,o)}return e}function Vb(r,e,t,n){const i=3*r.verticesCount+(1+_o(t))*r.geometriesCount;(!e||e.length!==i)&&(e=new Float32Array(i));const s=[];let o=0;for(const a in r.entries){const l=r.entries[a];for(let u=0,c=l.flatCoordss.length;u<c;u++){s.length=l.flatCoordss[u].length,lf(l.flatCoordss[u],0,s.length,3,n,s,3),o+=Wl(e,t,l,o),e[o++]=s.length/3;for(let h=0,f=s.length;h<f;h+=3)e[o++]=s[h],e[o++]=s[h+1],e[o++]=s[h+2]}}return e}function Xb(r,e,t,n){const i=2*r.verticesCount+(1+_o(t))*r.geometriesCount+r.ringsCount;(!e||e.length!==i)&&(e=new Float32Array(i));const s=[];let o=0;for(const a in r.entries){const l=r.entries[a];for(let u=0,c=l.flatCoordss.length;u<c;u++){s.length=l.flatCoordss[u].length,lf(l.flatCoordss[u],0,s.length,2,n,s),o+=Wl(e,t,l,o),e[o++]=l.ringsVerticesCounts[u].length;for(let h=0,f=l.ringsVerticesCounts[u].length;h<f;h++)e[o++]=l.ringsVerticesCounts[u][h];for(let h=0,f=s.length;h<f;h+=2)e[o++]=s[h],e[o++]=s[h+1]}}return e}function $s(r){return(JSON.stringify(r).split("").reduce((t,n)=>(t<<5)-t+n.charCodeAt(0),0)>>>0).toString()}function ql(r,e,t,n){if(`${n}radius`in r&&n!=="icon-"){let i=W(t,r[`${n}radius`],pe);if(`${n}radius2`in r){const s=W(t,r[`${n}radius2`],pe);i=`max(${i}, ${s})`}`${n}stroke-width`in r&&(i=`(${i} + ${W(t,r[`${n}stroke-width`],pe)} * 0.5)`),e.setSymbolSizeExpression(`vec2(${i} * 2. + 0.5)`)}if(`${n}scale`in r){const i=W(t,r[`${n}scale`],pn);e.setSymbolSizeExpression(`${e.getSymbolSizeExpression()} * ${i}`)}`${n}displacement`in r&&e.setSymbolOffsetExpression(W(t,r[`${n}displacement`],cn)),`${n}rotation`in r&&e.setSymbolRotationExpression(W(t,r[`${n}rotation`],pe)),`${n}rotate-with-view`in r&&e.setSymbolRotateWithView(!!r[`${n}rotate-with-view`])}function cd(r,e,t,n,i){let s="vec4(0.)";if(e!==null&&(s=e),t!==null&&n!==null){const l=`smoothstep(-${n} + 0.63, -${n} - 0.58, ${r})`;s=`mix(${t}, ${s}, ${l})`}const o=`(1.0 - smoothstep(-0.63, 0.58, ${r}))`;let a=`${s} * vec4(1.0, 1.0, 1.0, ${o})`;return i!==null&&(a=`${a} * vec4(1.0, 1.0, 1.0, ${i})`),a}function Hl(r,e,t,n,i){const s=new Image;s.crossOrigin=r[`${n}cross-origin`]===void 0?"anonymous":r[`${n}cross-origin`],Ct(typeof r[`${n}src`]=="string",`WebGL layers do not support expressions for the ${n}src style property`),s.src=r[`${n}src`],t[`u_texture${i}_size`]=()=>s.complete?[s.width,s.height]:[0,0],e.addUniform(`u_texture${i}_size`,"vec2");const o=`u_texture${i}_size`;return t[`u_texture${i}`]=s,e.addUniform(`u_texture${i}`,"sampler2D"),o}function Yl(r,e,t,n,i){let s=W(t,r[`${e}offset`],pn);if(`${e}offset-origin`in r)switch(r[`${e}offset-origin`]){case"top-right":s=`vec2(${n}.x, 0.) + ${i} * vec2(-1., 0.) + ${s} * vec2(-1., 1.)`;break;case"bottom-left":s=`vec2(0., ${n}.y) + ${i} * vec2(0., -1.) + ${s} * vec2(1., -1.)`;break;case"bottom-right":s=`${n} - ${i} - ${s}`;break}return s}function Zb(r,e,t,n){n.functions.circleDistanceField=`float circleDistanceField(vec2 point, float radius) {
  return length(point) - radius;
}`,ql(r,e,n,"circle-");let i=null;"circle-opacity"in r&&(i=W(n,r["circle-opacity"],pe));let s="coordsPx";"circle-scale"in r&&(s=`coordsPx / ${W(n,r["circle-scale"],pn)}`);let o=null;"circle-fill-color"in r&&(o=W(n,r["circle-fill-color"],_t));let a=null;"circle-stroke-color"in r&&(a=W(n,r["circle-stroke-color"],_t));let l=W(n,r["circle-radius"],pe),u=null;"circle-stroke-width"in r&&(u=W(n,r["circle-stroke-width"],pe),l=`(${l} + ${u} * 0.5)`);const c=`circleDistanceField(${s}, ${l})`,h=cd(c,o,a,u,i);e.setSymbolColorExpression(h)}function Wb(r,e,t,n){n.functions.round=`float round(float v) {
  return sign(v) * floor(abs(v) + 0.5);
}`,n.functions.starDistanceField=`float starDistanceField(vec2 point, float numPoints, float radius, float radius2, float angle) {
  float startAngle = -PI * 0.5 + angle; // tip starts upwards and rotates clockwise with angle
  float c = cos(startAngle);
  float s = sin(startAngle);
  vec2 pointRotated = vec2(c * point.x - s * point.y, s * point.x + c * point.y);
  float alpha = TWO_PI / numPoints; // the angle of one sector
  float beta = atan(pointRotated.y, pointRotated.x);
  float gamma = round(beta / alpha) * alpha; // angle in sector
  c = cos(-gamma);
  s = sin(-gamma);
  vec2 inSector = vec2(c * pointRotated.x - s * pointRotated.y, abs(s * pointRotated.x + c * pointRotated.y));
  vec2 tipToPoint = inSector + vec2(-radius, 0.);
  vec2 edgeNormal = vec2(radius2 * sin(alpha * 0.5), -radius2 * cos(alpha * 0.5) + radius);
  return dot(normalize(edgeNormal), tipToPoint);
}`,n.functions.regularDistanceField=`float regularDistanceField(vec2 point, float numPoints, float radius, float angle) {
  float startAngle = -PI * 0.5 + angle; // tip starts upwards and rotates clockwise with angle
  float c = cos(startAngle);
  float s = sin(startAngle);
  vec2 pointRotated = vec2(c * point.x - s * point.y, s * point.x + c * point.y);
  float alpha = TWO_PI / numPoints; // the angle of one sector
  float radiusIn = radius * cos(PI / numPoints);
  float beta = atan(pointRotated.y, pointRotated.x);
  float gamma = round((beta - alpha * 0.5) / alpha) * alpha + alpha * 0.5; // angle in sector from mid
  c = cos(-gamma);
  s = sin(-gamma);
  vec2 inSector = vec2(c * pointRotated.x - s * pointRotated.y, abs(s * pointRotated.x + c * pointRotated.y));
  return inSector.x - radiusIn;
}`,ql(r,e,n,"shape-");let i=null;"shape-opacity"in r&&(i=W(n,r["shape-opacity"],pe));let s="coordsPx";"shape-scale"in r&&(s=`coordsPx / ${W(n,r["shape-scale"],pn)}`);let o=null;"shape-fill-color"in r&&(o=W(n,r["shape-fill-color"],_t));let a=null;"shape-stroke-color"in r&&(a=W(n,r["shape-stroke-color"],_t));let l=null;"shape-stroke-width"in r&&(l=W(n,r["shape-stroke-width"],pe));const u=W(n,r["shape-points"],pe);let c="0.";"shape-angle"in r&&(c=W(n,r["shape-angle"],pe));let h,f=W(n,r["shape-radius"],pe);if(l!==null&&(f=`${f} + ${l} * 0.5`),"shape-radius2"in r){let d=W(n,r["shape-radius2"],pe);l!==null&&(d=`${d} + ${l} * 0.5`),h=`starDistanceField(${s}, ${u}, ${f}, ${d}, ${c})`}else h=`regularDistanceField(${s}, ${u}, ${f}, ${c})`;const p=cd(h,o,a,l,i);e.setSymbolColorExpression(p)}function qb(r,e,t,n){let i="vec4(1.0)";"icon-color"in r&&(i=W(n,r["icon-color"],_t)),"icon-opacity"in r&&(i=`${i} * vec4(1.0, 1.0, 1.0, ${W(n,r["icon-opacity"],pe)})`);const s=$s(r["icon-src"]),o=Hl(r,e,t,"icon-",s);if(e.setSymbolColorExpression(`${i} * texture2D(u_texture${s}, v_texCoord)`).setSymbolSizeExpression(o),"icon-width"in r&&"icon-height"in r&&e.setSymbolSizeExpression(`vec2(${W(n,r["icon-width"],pe)}, ${W(n,r["icon-height"],pe)})`),"icon-offset"in r&&"icon-size"in r){const a=W(n,r["icon-size"],cn),l=e.getSymbolSizeExpression();e.setSymbolSizeExpression(a);const u=Yl(r,"icon-",n,"v_quadSizePx",a);e.setTextureCoordinateExpression(`(vec4((${u}).xyxy) + vec4(0., 0., ${a})) / (${l}).xyxy`)}if(ql(r,e,n,"icon-"),"icon-anchor"in r){const a=W(n,r["icon-anchor"],cn);let l="1.0";"icon-scale"in r&&(l=W(n,r["icon-scale"],pn));let u;r["icon-anchor-x-units"]==="pixels"&&r["icon-anchor-y-units"]==="pixels"?u=`${a} * ${l}`:r["icon-anchor-x-units"]==="pixels"?u=`${a} * vec2(vec2(${l}).x, v_quadSizePx.y)`:r["icon-anchor-y-units"]==="pixels"?u=`${a} * vec2(v_quadSizePx.x, vec2(${l}).x)`:u=`${a} * v_quadSizePx`;let c=`v_quadSizePx * vec2(0.5, -0.5) + ${u} * vec2(-1., 1.)`;if("icon-anchor-origin"in r)switch(r["icon-anchor-origin"]){case"top-right":c=`v_quadSizePx * -0.5 + ${u}`;break;case"bottom-left":c=`v_quadSizePx * 0.5 - ${u}`;break;case"bottom-right":c=`v_quadSizePx * vec2(-0.5, 0.5) + ${u} * vec2(1., -1.)`;break}e.setSymbolOffsetExpression(`${e.getSymbolOffsetExpression()} + ${c}`)}}function Hb(r,e,t,n){if("stroke-color"in r&&e.setStrokeColorExpression(W(n,r["stroke-color"],_t)),"stroke-pattern-src"in r){const i=$s(r["stroke-pattern-src"]),s=Hl(r,e,t,"stroke-pattern-",i);let o=s,a="vec2(0.)";"stroke-pattern-offset"in r&&"stroke-pattern-size"in r&&(o=W(n,r["stroke-pattern-size"],cn),a=Yl(r,"stroke-pattern-",n,s,o));let l="0.";"stroke-pattern-spacing"in r&&(l=W(n,r["stroke-pattern-spacing"],pe));let u="0.";"stroke-pattern-start-offset"in r&&(u=W(n,r["stroke-pattern-start-offset"],pe)),n.functions.sampleStrokePattern=`vec4 sampleStrokePattern(sampler2D texture, vec2 textureSize, vec2 textureOffset, vec2 sampleSize, float spacingPx, float startOffsetPx, float currentLengthPx, float currentRadiusRatio, float lineWidth) {
  float currentLengthScaled = (currentLengthPx - startOffsetPx) * sampleSize.y / lineWidth;
  float spacingScaled = spacingPx * sampleSize.y / lineWidth;
  float uCoordPx = mod(currentLengthScaled, (sampleSize.x + spacingScaled));
  float isInsideOfPattern = step(uCoordPx, sampleSize.x);
  float vCoordPx = (-currentRadiusRatio * 0.5 + 0.5) * sampleSize.y;
  // make sure that we're not sampling too close to the borders to avoid interpolation with outside pixels
  uCoordPx = clamp(uCoordPx, 0.5, sampleSize.x - 0.5);
  vCoordPx = clamp(vCoordPx, 0.5, sampleSize.y - 0.5);
  vec2 texCoord = (vec2(uCoordPx, vCoordPx) + textureOffset) / textureSize;
  return texture2D(texture, texCoord) * vec4(1.0, 1.0, 1.0, isInsideOfPattern);
}`;const c=`u_texture${i}`;let h="1.";"stroke-color"in r&&(h=e.getStrokeColorExpression()),e.setStrokeColorExpression(`${h} * sampleStrokePattern(${c}, ${s}, ${a}, ${o}, ${l}, ${u}, currentLengthPx, currentRadiusRatio, v_width)`),n.functions.computeStrokePatternLength=`float computeStrokePatternLength(vec2 sampleSize, float spacingPx, float lineWidth) {
  float patternLengthPx = sampleSize.x / sampleSize.y * lineWidth;
  return patternLengthPx + spacingPx;
}`,e.setStrokePatternLengthExpression(`computeStrokePatternLength(${o}, ${l}, v_width)`)}if("stroke-width"in r&&e.setStrokeWidthExpression(W(n,r["stroke-width"],pe)),"stroke-offset"in r&&e.setStrokeOffsetExpression(W(n,r["stroke-offset"],pe)),"stroke-line-cap"in r&&e.setStrokeCapExpression(W(n,r["stroke-line-cap"],Li)),"stroke-line-join"in r&&e.setStrokeJoinExpression(W(n,r["stroke-line-join"],Li)),"stroke-miter-limit"in r&&e.setStrokeMiterLimitExpression(W(n,r["stroke-miter-limit"],pe)),"stroke-line-dash"in r){n.functions.getSingleDashDistance=`float getSingleDashDistance(float distance, float radius, float dashOffset, float dashLength, float dashLengthTotal, float capType, float lineWidth) {
  float localDistance = mod(distance, dashLengthTotal);
  float distanceSegment = abs(localDistance - dashOffset - dashLength * 0.5) - dashLength * 0.5;
  distanceSegment = min(distanceSegment, dashLengthTotal - localDistance);
  if (capType == ${gr("square")}) {
    distanceSegment -= lineWidth * 0.5;
  } else if (capType == ${gr("round")}) {
    distanceSegment = min(distanceSegment, sqrt(distanceSegment * distanceSegment + radius * radius) - lineWidth * 0.5);
  }
  return distanceSegment;
}`;let i=r["stroke-line-dash"].map(d=>W(n,d,pe));i.length%2===1&&(i=[...i,...i]);let s="0.";"stroke-line-dash-offset"in r&&(s=W(n,r["stroke-line-dash-offset"],pe));const a=`dashDistanceField_${$s(r["stroke-line-dash"])}`,l=i.map((d,g)=>`float dashLength${g}`).join(", "),u=i.map((d,g)=>`dashLength${g}`).join(" + ");let c="0.",h=`getSingleDashDistance(distance, radius, ${c}, dashLength0, totalDashLength, capType, lineWidth)`;for(let d=2;d<i.length;d+=2)c=`${c} + dashLength${d-2} + dashLength${d-1}`,h=`min(${h}, getSingleDashDistance(distance, radius, ${c}, dashLength${d}, totalDashLength, capType, lineWidth))`;n.functions[a]=`float ${a}(float distance, float radius, float capType, float lineWidth, ${l}) {
  float totalDashLength = ${u};
  return ${h};
}`;const f=i.map((d,g)=>`${d}`).join(", ");e.setStrokeDistanceFieldExpression(`${a}(currentLengthPx + ${s}, currentRadiusPx, capType, v_width, ${f})`);let p=i.join(" + ");e.getStrokePatternLengthExpression()&&(n.functions.combinePatternLengths=`float combinePatternLengths(float patternLength1, float patternLength2) {
  return patternLength1 * patternLength2;
}`,p=`combinePatternLengths(${e.getStrokePatternLengthExpression()}, ${p})`),e.setStrokePatternLengthExpression(p)}}function Yb(r,e,t,n){if("fill-color"in r&&e.setFillColorExpression(W(n,r["fill-color"],_t)),"fill-pattern-src"in r){const i=$s(r["fill-pattern-src"]),s=Hl(r,e,t,"fill-pattern-",i);let o=s,a="vec2(0.)";"fill-pattern-offset"in r&&"fill-pattern-size"in r&&(o=W(n,r["fill-pattern-size"],cn),a=Yl(r,"fill-pattern-",n,s,o)),n.functions.sampleFillPattern=`vec4 sampleFillPattern(sampler2D texture, vec2 textureSize, vec2 textureOffset, vec2 sampleSize, vec2 pxOrigin, vec2 pxPosition) {
  float scaleRatio = pow(2., mod(u_zoom + 0.5, 1.) - 0.5);
  vec2 pxRelativePos = pxPosition - pxOrigin;
  // rotate the relative position from origin by the current view rotation
  pxRelativePos = vec2(pxRelativePos.x * cos(u_rotation) - pxRelativePos.y * sin(u_rotation), pxRelativePos.x * sin(u_rotation) + pxRelativePos.y * cos(u_rotation));
  // sample position is computed according to the sample offset & size
  vec2 samplePos = mod(pxRelativePos / scaleRatio, sampleSize);
  // also make sure that we're not sampling too close to the borders to avoid interpolation with outside pixels
  samplePos = clamp(samplePos, vec2(0.5), sampleSize - vec2(0.5));
  samplePos.y = sampleSize.y - samplePos.y; // invert y axis so that images appear upright
  return texture2D(texture, (samplePos + textureOffset) / textureSize);
}`;const l=`u_texture${i}`;let u="1.";"fill-color"in r&&(u=e.getFillColorExpression()),e.setFillColorExpression(`${u} * sampleFillPattern(${l}, ${s}, ${a}, ${o}, pxOrigin, pxPos)`)}}function $a(r,e,t){const n=Vl(),i=new od,s={};if("icon-src"in r?qb(r,i,s,n):"shape-points"in r?Wb(r,i,s,n):"circle-radius"in r&&Zb(r,i,s,n),Hb(r,i,s,n),Yb(r,i,s,n),t){const l=W(n,t,Ci);i.setFragmentDiscardExpression(`!${l}`)}const o={};function a(l,u,c,h){if(!n[l])return;const f=ka(c),p=Zl(c);i.addAttribute(`a_${u}`,f),o[u]={size:p,callback:h}}return a("geometryType",rd,Li,l=>kn(em(l.getGeometry()))),a("featureId",td,Li|pe,l=>{const u=l.getId()??null;return typeof u=="string"?kn(u):u}),nd(i,n),{builder:i,attributes:{...o,...sd(n)},uniforms:{...s,...id(n,e)}}}const Kb=[];let Ko;function Jb(){return Ko||(Ko=ad()),Ko}let Qb=0;const Mt={POSITION:"a_position",LOCAL_POSITION:"a_localPosition",SEGMENT_START:"a_segmentStart",SEGMENT_END:"a_segmentEnd",MEASURE_START:"a_measureStart",MEASURE_END:"a_measureEnd",ANGLE_TANGENT_SUM:"a_angleTangentSum",JOIN_ANGLES:"a_joinAngles",DISTANCE_LOW:"a_distanceLow",DISTANCE_HIGH:"a_distanceHigh"};class ex{constructor(e,t,n,i){this.helper_,this.hitDetectionEnabled_=!!i,this.styleShaders=tx(e,t),this.customAttributes_={},this.uniforms_={},this.hitDetectionEnabled_&&(this.customAttributes_.hitColor={callback(){return ld(this.ref,Kb)},size:2});for(const s of this.styleShaders){for(const o in s.attributes)o in this.customAttributes_||(this.customAttributes_[o]=s.attributes[o]);for(const o in s.uniforms)o in this.uniforms_||(this.uniforms_[o]=s.uniforms[o])}this.renderPasses_=this.styleShaders.map(s=>{const o={},a=Object.entries(this.customAttributes_).map(([l,u])=>({name:l in s.attributes||l==="hitColor"?`a_${l}`:null,size:u.size||1,type:ze.FLOAT}));return s.builder.getFillVertexShader()&&(o.fillRenderPass={vertexShader:s.builder.getFillVertexShader(),fragmentShader:s.builder.getFillFragmentShader(),attributesDesc:[{name:Mt.POSITION,size:2,type:ze.FLOAT},...a],instancedAttributesDesc:[],instancePrimitiveVertexCount:3}),s.builder.getStrokeVertexShader()&&(o.strokeRenderPass={vertexShader:s.builder.getStrokeVertexShader(),fragmentShader:s.builder.getStrokeFragmentShader(),attributesDesc:[{name:Mt.LOCAL_POSITION,size:2,type:ze.FLOAT}],instancedAttributesDesc:[{name:Mt.SEGMENT_START,size:2,type:ze.FLOAT},{name:Mt.MEASURE_START,size:1,type:ze.FLOAT},{name:Mt.SEGMENT_END,size:2,type:ze.FLOAT},{name:Mt.MEASURE_END,size:1,type:ze.FLOAT},{name:Mt.JOIN_ANGLES,size:2,type:ze.FLOAT},{name:Mt.DISTANCE_LOW,size:1,type:ze.FLOAT},{name:Mt.DISTANCE_HIGH,size:1,type:ze.FLOAT},{name:Mt.ANGLE_TANGENT_SUM,size:1,type:ze.FLOAT},...a],instancePrimitiveVertexCount:6}),s.builder.getSymbolVertexShader()&&(o.symbolRenderPass={vertexShader:s.builder.getSymbolVertexShader(),fragmentShader:s.builder.getSymbolFragmentShader(),attributesDesc:[{name:Mt.LOCAL_POSITION,size:2,type:ze.FLOAT}],instancedAttributesDesc:[{name:Mt.POSITION,size:2,type:ze.FLOAT},...a],instancePrimitiveVertexCount:6}),o}),this.hasFill_=this.renderPasses_.some(s=>s.fillRenderPass),this.hasStroke_=this.renderPasses_.some(s=>s.strokeRenderPass),this.hasSymbol_=this.renderPasses_.some(s=>s.symbolRenderPass),this.setHelper(n)}async generateBuffers(e,t){if(e.isEmpty())return null;const n=this.generateRenderInstructions_(e,t),[i,s,o]=await Promise.all([this.generateBuffersForType_(n.polygonInstructions,"Polygon",t),this.generateBuffersForType_(n.lineStringInstructions,"LineString",t),this.generateBuffersForType_(n.pointInstructions,"Point",t)]),a=Gn(Qe(),t);return{polygonBuffers:i,lineStringBuffers:s,pointBuffers:o,invertVerticesTransform:a}}generateRenderInstructions_(e,t){const n=this.hasFill_?Xb(e.polygonBatch,new Float32Array(0),this.customAttributes_,t):null,i=this.hasStroke_?Vb(e.lineStringBatch,new Float32Array(0),this.customAttributes_,t):null,s=this.hasSymbol_?jb(e.pointBatch,new Float32Array(0),this.customAttributes_,t):null;return{polygonInstructions:n,lineStringInstructions:i,pointInstructions:s}}generateBuffersForType_(e,t,n){if(e===null)return null;const i=Qb++;let s;switch(t){case"Polygon":s=xi.GENERATE_POLYGON_BUFFERS;break;case"LineString":s=xi.GENERATE_LINE_STRING_BUFFERS;break;case"Point":s=xi.GENERATE_POINT_BUFFERS;break}const o={id:i,type:s,renderInstructions:e.buffer,renderInstructionsTransform:n,customAttributesSize:_o(this.customAttributes_)},a=Jb();return a.postMessage(o,[e.buffer]),e=null,new Promise(l=>{const u=c=>{const h=c.data;if(h.id!==i||(a.removeEventListener("message",u),!this.helper_.getGL()))return;const f=new Br(Yi,On).fromArrayBuffer(h.indicesBuffer),p=new Br(fn,On).fromArrayBuffer(h.vertexAttributesBuffer),d=new Br(fn,On).fromArrayBuffer(h.instanceAttributesBuffer);this.helper_.flushBufferData(f),this.helper_.flushBufferData(p),this.helper_.flushBufferData(d),l([f,p,d])};a.addEventListener("message",u)})}render(e,t,n){for(const i of this.renderPasses_)i.fillRenderPass&&this.renderInternal_(e.polygonBuffers[0],e.polygonBuffers[1],e.polygonBuffers[2],i.fillRenderPass,t,n),i.strokeRenderPass&&this.renderInternal_(e.lineStringBuffers[0],e.lineStringBuffers[1],e.lineStringBuffers[2],i.strokeRenderPass,t,n),i.symbolRenderPass&&this.renderInternal_(e.pointBuffers[0],e.pointBuffers[1],e.pointBuffers[2],i.symbolRenderPass,t,n)}renderInternal_(e,t,n,i,s,o){const a=e.getSize();if(a===0)return;const l=i.instancedAttributesDesc.length;if(this.helper_.useProgram(i.program,s),this.helper_.bindBuffer(t),this.helper_.bindBuffer(e),this.helper_.enableAttributes(i.attributesDesc),this.helper_.bindBuffer(n),this.helper_.enableAttributesInstanced(i.instancedAttributesDesc),o(),l){const u=i.instancedAttributesDesc.reduce((h,f)=>h+(f.size||1),0),c=n.getSize()/u;this.helper_.drawElementsInstanced(0,a,c)}else this.helper_.drawElements(0,a)}setHelper(e,t=null){this.helper_=e;for(const n of this.renderPasses_)n.fillRenderPass&&(n.fillRenderPass.program=this.helper_.getProgram(n.fillRenderPass.fragmentShader,n.fillRenderPass.vertexShader)),n.strokeRenderPass&&(n.strokeRenderPass.program=this.helper_.getProgram(n.strokeRenderPass.fragmentShader,n.strokeRenderPass.vertexShader)),n.symbolRenderPass&&(n.symbolRenderPass.program=this.helper_.getProgram(n.symbolRenderPass.fragmentShader,n.symbolRenderPass.vertexShader));this.helper_.addUniforms(this.uniforms_),t&&(t.polygonBuffers&&(this.helper_.flushBufferData(t.polygonBuffers[0]),this.helper_.flushBufferData(t.polygonBuffers[1]),this.helper_.flushBufferData(t.polygonBuffers[2])),t.lineStringBuffers&&(this.helper_.flushBufferData(t.lineStringBuffers[0]),this.helper_.flushBufferData(t.lineStringBuffers[1]),this.helper_.flushBufferData(t.lineStringBuffers[2])),t.pointBuffers&&(this.helper_.flushBufferData(t.pointBuffers[0]),this.helper_.flushBufferData(t.pointBuffers[1]),this.helper_.flushBufferData(t.pointBuffers[2])))}}function tx(r,e){const t=Array.isArray(r)?r:[r];if("style"in t[0]){const n=[],i=t,s=[];for(const o of i){const a=Array.isArray(o.style)?o.style:[o.style];let l=o.filter;o.else&&s.length&&(l=["all",...s.map(c=>["!",c])],o.filter&&l.push(o.filter),l.length<3&&(l=l[1])),o.filter&&s.push(o.filter);const u=a.map(c=>$a(c,e,l));n.push(...u)}return n}return"builder"in t[0]?t:t.map(n=>$a(n,e,null))}const Kt=new Uint8Array(4);class hd{constructor(e,t){this.helper_=e;const n=e.getGL();this.texture_=n.createTexture(),this.framebuffer_=n.createFramebuffer(),this.depthbuffer_=n.createRenderbuffer(),this.size_=t||[1,1],this.data_=new Uint8Array(0),this.dataCacheDirty_=!0,this.updateSize_()}setSize(e){Og(e,this.size_)||(this.size_[0]=e[0],this.size_[1]=e[1],this.updateSize_())}getSize(){return this.size_}clearCachedData(){this.dataCacheDirty_=!0}readAll(){if(this.dataCacheDirty_){const e=this.size_,t=this.helper_.getGL();t.bindFramebuffer(t.FRAMEBUFFER,this.framebuffer_),t.readPixels(0,0,e[0],e[1],t.RGBA,t.UNSIGNED_BYTE,this.data_),this.dataCacheDirty_=!1}return this.data_}readPixel(e,t){if(e<0||t<0||e>this.size_[0]||t>=this.size_[1])return Kt[0]=0,Kt[1]=0,Kt[2]=0,Kt[3]=0,Kt;this.readAll();const n=Math.floor(e)+(this.size_[1]-Math.floor(t)-1)*this.size_[0];return Kt[0]=this.data_[n*4],Kt[1]=this.data_[n*4+1],Kt[2]=this.data_[n*4+2],Kt[3]=this.data_[n*4+3],Kt}getTexture(){return this.texture_}getFramebuffer(){return this.framebuffer_}getDepthbuffer(){return this.depthbuffer_}updateSize_(){const e=this.size_,t=this.helper_.getGL();this.texture_=this.helper_.createTexture(e,null,this.texture_),t.bindFramebuffer(t.FRAMEBUFFER,this.framebuffer_),t.viewport(0,0,e[0],e[1]),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.texture_,0),t.bindRenderbuffer(t.RENDERBUFFER,this.depthbuffer_),t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT16,e[0],e[1]),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,this.depthbuffer_),this.data_=new Uint8Array(e[0]*e[1]*4)}}function fd(r,e){const t=r.viewState.projection,i=e.getSource().getWrapX()&&t.canWrapX(),s=t.getExtent(),o=r.extent,a=i?nt(s):null,l=i?Math.ceil((o[2]-s[2])/a)+1:1;return[i?Math.floor((o[0]-s[0])/a):0,l,a]}const wn={...tr,RENDER_EXTENT:"u_renderExtent",PATTERN_ORIGIN:"u_patternOrigin",GLOBAL_ALPHA:"u_globalAlpha"};class dd extends Ki{constructor(e,t){const n={[wn.RENDER_EXTENT]:[0,0,0,0],[wn.PATTERN_ORIGIN]:[0,0],[wn.GLOBAL_ALPHA]:1};super(e,{uniforms:n,postProcesses:t.postProcesses}),this.hitDetectionEnabled_=!t.disableHitDetection,this.hitRenderTarget_,this.sourceRevision_=-1,this.previousExtent_=ji(),this.currentTransform_=Qe(),this.tmpCoords_=[0,0],this.tmpTransform_=Qe(),this.tmpMat4_=yn(),this.currentFrameStateTransform_=Qe(),this.styleVariables_={},this.style_=[],this.styleRenderer_=null,this.buffers_=null,this.applyOptions_(t),this.batch_=new ks,this.initialFeaturesAdded_=!1,this.sourceListenKeys_=null}addInitialFeatures_(e){const t=this.getLayer().getSource();let n;this.batch_.addFeatures(t.getFeatures(),n),this.sourceListenKeys_=[mr(t,Nr.ADDFEATURE,this.handleSourceFeatureAdded_.bind(this,n)),mr(t,Nr.CHANGEFEATURE,this.handleSourceFeatureChanged_.bind(this,n),this),mr(t,Nr.REMOVEFEATURE,this.handleSourceFeatureDelete_,this),mr(t,Nr.CLEAR,this.handleSourceFeatureClear_,this)]}applyOptions_(e){this.styleVariables_=e.variables,this.style_=e.style}createRenderers_(){this.buffers_=null,this.styleRenderer_=new ex(this.style_,this.styleVariables_,this.helper,this.hitDetectionEnabled_)}reset(e){this.applyOptions_(e),this.helper&&this.createRenderers_(),super.reset(e)}afterHelperCreated(){this.styleRenderer_?this.styleRenderer_.setHelper(this.helper,this.buffers_):this.createRenderers_(),this.hitDetectionEnabled_&&(this.hitRenderTarget_=new hd(this.helper))}handleSourceFeatureAdded_(e,t){const n=t.feature;this.batch_.addFeature(n,e)}handleSourceFeatureChanged_(e,t){const n=t.feature;this.batch_.changeFeature(n,e)}handleSourceFeatureDelete_(e){const t=e.feature;this.batch_.removeFeature(t)}handleSourceFeatureClear_(){this.batch_.clear()}applyUniforms_(e){Eg(this.tmpTransform_,this.currentFrameStateTransform_),an(this.tmpTransform_,e),this.helper.setUniformMatrixValue(wn.PROJECTION_MATRIX,Gs(this.tmpMat4_,this.tmpTransform_)),Gn(this.tmpTransform_,this.tmpTransform_),this.helper.setUniformMatrixValue(wn.SCREEN_TO_WORLD_MATRIX,Gs(this.tmpMat4_,this.tmpTransform_)),this.tmpCoords_[0]=0,this.tmpCoords_[1]=0,Gn(this.tmpTransform_,e),hr(this.tmpTransform_,this.tmpCoords_),this.helper.setUniformFloatVec2(wn.PATTERN_ORIGIN,this.tmpCoords_)}renderFrame(e){const t=this.helper.getGL();this.preRender(t,e);const[n,i,s]=fd(e,this.getLayer());this.helper.prepareDraw(e),this.renderWorlds(e,!1,n,i,s),this.helper.finalizeDraw(e,this.dispatchPreComposeEvent,this.dispatchPostComposeEvent);const o=this.helper.getCanvas();return this.hitDetectionEnabled_&&(this.renderWorlds(e,!0,n,i,s),this.hitRenderTarget_.clearCachedData()),this.postRender(t,e),o}prepareFrameInternal(e){this.initialFeaturesAdded_||(this.addInitialFeatures_(e),this.initialFeaturesAdded_=!0);const t=this.getLayer(),n=t.getSource(),i=e.viewState,s=!e.viewHints[kr.ANIMATING]&&!e.viewHints[kr.INTERACTING],o=!Pi(this.previousExtent_,e.extent),a=this.sourceRevision_<n.getRevision();if(a&&(this.sourceRevision_=n.getRevision()),s&&(o||a)){const l=i.projection,u=i.resolution,c=t instanceof co?t.getRenderBuffer():0,h=xl(e.extent,c*u);n.loadFeatures(h,u,l),this.ready=!1;const f=this.helper.makeProjectionTransform(e,Qe());this.styleRenderer_.generateBuffers(this.batch_,f).then(p=>{this.buffers_&&this.disposeBuffers(this.buffers_),this.buffers_=p,this.ready=!0,this.getLayer().changed()}),this.previousExtent_=e.extent.slice()}return!0}renderWorlds(e,t,n,i,s){let o=n;t&&(this.hitRenderTarget_.setSize([Math.floor(e.size[0]/2),Math.floor(e.size[1]/2)]),this.helper.prepareDrawToRenderTarget(e,this.hitRenderTarget_,!0));do this.helper.makeProjectionTransform(e,this.currentFrameStateTransform_),ml(this.currentFrameStateTransform_,o*s,0),this.buffers_&&this.styleRenderer_.render(this.buffers_,e,()=>{this.applyUniforms_(this.buffers_.invertVerticesTransform),this.helper.applyHitDetectionUniform(t)});while(++o<i)}forEachFeatureAtCoordinate(e,t,n,i,s){if(Ct(this.hitDetectionEnabled_,"`forEachFeatureAtCoordinate` cannot be used on a WebGL layer if the hit detection logic has been disabled using the `disableHitDetection: true` option."),!this.styleRenderer_||!this.hitDetectionEnabled_)return;const o=hr(t.coordinateToPixelTransform,e.slice()),a=this.hitRenderTarget_.readPixel(o[0]/2,o[1]/2),l=[a[0]/255,a[1]/255,a[2]/255,a[3]/255],u=ud(l),c=this.batch_.getFeatureFromRef(u);if(c)return i(c,this.getLayer(),null)}disposeBuffers(e){const t=n=>{for(const i of n)i&&this.helper.deleteBuffer(i)};e.pointBuffers&&t(e.pointBuffers),e.lineStringBuffers&&t(e.lineStringBuffers),e.polygonBuffers&&t(e.polygonBuffers)}disposeInternal(){this.buffers_&&this.disposeBuffers(this.buffers_),this.sourceListenKeys_&&(this.sourceListenKeys_.forEach(function(e){Ps(e)}),this.sourceListenKeys_=null),super.disposeInternal()}renderDeclutter(){}}const pr={BLUR:"blur",GRADIENT:"gradient",RADIUS:"radius"},rx=["#00f","#0ff","#0f0","#ff0","#f00"];class dR extends co{constructor(e){e=e||{};const t=Object.assign({},e);delete t.gradient,delete t.radius,delete t.blur,delete t.weight,super(t),this.filter_=e.filter??!0,this.styleVariables_=e.variables||{},this.gradient_=null,this.addChangeListener(pr.GRADIENT,this.handleGradientChanged_),this.setGradient(e.gradient?e.gradient:rx),this.setBlur(e.blur!==void 0?e.blur:15),this.setRadius(e.radius!==void 0?e.radius:8);const n=e.weight?e.weight:"weight";this.weight_=n,this.setRenderOrder(null)}getBlur(){return this.get(pr.BLUR)}getGradient(){return this.get(pr.GRADIENT)}getRadius(){return this.get(pr.RADIUS)}handleGradientChanged_(){this.gradient_=nx(this.getGradient())}setBlur(e){const t=this.get(pr.BLUR);if(this.set(pr.BLUR,e),typeof e=="number"&&typeof t=="number"){this.changed();return}this.clearRenderer()}setGradient(e){this.set(pr.GRADIENT,e)}setRadius(e){const t=this.get(pr.RADIUS);if(this.set(pr.RADIUS,e),typeof e=="number"&&typeof t=="number"){this.changed();return}this.clearRenderer()}setFilter(e){this.filter_=e,this.changed(),this.clearRenderer()}setWeight(e){this.weight_=e,this.changed(),this.clearRenderer()}createRenderer(){const e=new od,t=Vl(),n=W(t,this.filter_,Ci);let i=W(t,this.getRadius(),pe),s=W(t,this.getBlur(),pe);const o={};typeof this.getBlur()=="number"&&(s="a_blur",o.a_blur=()=>this.getBlur(),e.addUniform("a_blur","float")),typeof this.getRadius()=="number"&&(i="a_radius",o.a_radius=()=>this.getRadius(),e.addUniform("a_radius","float"));const a={};let l=null;if(typeof this.weight_=="string"||typeof this.weight_=="function"){const h=typeof this.weight_=="string"?f=>f.get(this.weight_):this.weight_;a.prop_weight={size:1,callback:f=>{const p=h(f);return p!==void 0?Fe(p,0,1):1}},l="a_prop_weight",e.addAttribute("a_prop_weight","float")}else{const h=["clamp",this.weight_,0,1];l=W(t,h,pe)}e.addFragmentShaderFunction(`float getBlurSlope() {
  float blur = max(1., ${s});
  float radius = ${i};
  return radius / blur;
}`).setSymbolSizeExpression(`vec2(${i} + ${s}) * 2.`).setSymbolColorExpression(`vec4(smoothstep(0., 1., (1. - length(coordsPx * 2. / v_quadSizePx)) * getBlurSlope()) * ${l})`).setStrokeColorExpression(`vec4(smoothstep(0., 1., (1. - length(currentRadiusPx * 2. / v_width)) * getBlurSlope()) * ${l})`).setStrokeWidthExpression(`(${i} + ${s}) * 2.`).setFillColorExpression(`vec4(${l})`).setFragmentDiscardExpression(`!${n}`),nd(e,t);const u=sd(t),c=id(t,this.styleVariables_);return new dd(this,{className:this.getClassName(),variables:this.styleVariables_,style:{builder:e,attributes:{...u,...a},uniforms:{...c,...o}},disableHitDetection:!1,postProcesses:[{fragmentShader:`
            precision mediump float;

            uniform sampler2D u_image;
            uniform sampler2D u_gradientTexture;
            uniform float u_opacity;

            varying vec2 v_texCoord;

            void main() {
              vec4 color = texture2D(u_image, v_texCoord);
              gl_FragColor.a = color.a * u_opacity;
              gl_FragColor.rgb = texture2D(u_gradientTexture, vec2(0.5, color.a)).rgb;
              gl_FragColor.rgb *= gl_FragColor.a;
            }`,uniforms:{u_gradientTexture:()=>this.gradient_,u_opacity:()=>this.getOpacity()}}]})}updateStyleVariables(e){Object.assign(this.styleVariables_,e),this.changed()}renderDeclutter(){}}function nx(r){const n=zr(1,256),i=n.createLinearGradient(0,0,1,256),s=1/(r.length-1);for(let o=0,a=r.length;o<a;++o)i.addColorStop(o*s,r[o]);return n.fillStyle=i,n.fillRect(0,0,1,256),n.canvas}class Kl extends bf{constructor(e,t,n,i,s){const o=s!==void 0?Kr.IDLE:Kr.LOADED;super(e,t,n,o),this.loader_=s!==void 0?s:null,this.canvas_=i,this.error_=null}getError(){return this.error_}handleLoad_(e){e?(this.error_=e,this.state=Kr.ERROR):this.state=Kr.LOADED,this.changed()}load(){this.state==Kr.IDLE&&(this.state=Kr.LOADING,this.changed(),this.loader_(this.handleLoad_.bind(this)))}getImage(){return this.canvas_}}class ix extends tm{constructor(e){super(e),this.vectorRenderer_=new rm(e),this.layerImageRatio_=e.getImageRatio(),this.coordinateToVectorPixelTransform_=Qe(),this.renderedPixelToCoordinateTransform_=null}disposeInternal(){this.vectorRenderer_.dispose(),super.disposeInternal()}getFeatures(e){if(!this.vectorRenderer_)return Promise.resolve([]);const t=hr(this.coordinateToVectorPixelTransform_,hr(this.renderedPixelToCoordinateTransform_,e.slice()));return this.vectorRenderer_.getFeatures(t)}handleFontsChanged(){this.vectorRenderer_.handleFontsChanged()}prepareFrame(e){var c;const t=e.pixelRatio,n=e.viewState,i=n.resolution,s=e.viewHints,o=this.vectorRenderer_;let a=e.extent;this.layerImageRatio_!==1&&(a=a.slice(0),pf(a,this.layerImageRatio_));const l=nt(a)/i,u=Zt(a)/i;if(!s[kr.ANIMATING]&&!s[kr.INTERACTING]&&!ao(a)){o.useContainer(null,null);const h=o.context,f=e.layerStatesArray[e.layerIndex],p=Object.assign({},f,{opacity:1}),d=Object.assign({},e,{extent:a,size:[l,u],viewState:Object.assign({},e.viewState,{rotation:0}),layerStatesArray:[p],layerIndex:0,declutter:null}),g=this.getLayer().getDeclutter();g&&(d.declutter={[g]:new nm(9)});const m=new Kl(a,i,t,h.canvas,function(y){o.prepareFrame(d)&&o.replayGroupChanged&&(o.clipping=!1,o.renderFrame(d,null),o.renderDeclutter(d),o.renderDeferred(d),y())});m.addEventListener(gt.CHANGE,()=>{if(m.getState()!==Kr.LOADED)return;this.image=m;const y=m.getPixelRatio(),_=im(m.getResolution())*t/y;this.renderedResolution=_,this.coordinateToVectorPixelTransform_=gl(this.coordinateToVectorPixelTransform_,l/2,u/2,1/_,-1/_,0,-n.center[0],-n.center[1])}),m.load()}return this.image&&(this.renderedPixelToCoordinateTransform_=e.pixelToCoordinateTransform.slice()),!((c=this.getLayer().getSource())!=null&&c.loading)&&!!this.image}preRender(){}postRender(){}renderDeclutter(){}forEachFeatureAtCoordinate(e,t,n,i,s){return this.vectorRenderer_?this.vectorRenderer_.forEachFeatureAtCoordinate(e,t,n,i,s):super.forEachFeatureAtCoordinate(e,t,n,i,s)}}class pR extends co{constructor(e){e=e||{};const t=Object.assign({},e);delete t.imageRatio,super(t),this.imageRatio_=e.imageRatio!==void 0?e.imageRatio:1}getImageRatio(){return this.imageRatio_}createRenderer(){return new ix(this)}}class sx extends Ki{constructor(e,t){const n=t.uniforms||{},i=Qe();n[tr.PROJECTION_MATRIX]=i,super(e,{uniforms:n,postProcesses:t.postProcesses}),this.sourceRevision_=-1,this.verticesBuffer_=new Br(fn,On),this.instanceAttributesBuffer_=new Br(fn,On),this.indicesBuffer_=new Br(Yi,On),this.vertexShader_=t.vertexShader,this.fragmentShader_=t.fragmentShader,this.program_,this.hitDetectionEnabled_=t.hitDetectionEnabled??!0;const s=t.attributes?t.attributes.map(function(a){return{name:"a_"+a.name,size:1,type:ze.FLOAT}}):[];this.attributes=[{name:"a_localPosition",size:2,type:ze.FLOAT}],this.instanceAttributes=[{name:"a_position",size:2,type:ze.FLOAT}],this.hitDetectionEnabled_&&(this.instanceAttributes.push({name:"a_hitColor",size:2,type:ze.FLOAT}),this.instanceAttributes.push({name:"a_featureUid",size:1,type:ze.FLOAT})),this.instanceAttributes.push(...s),this.customAttributes=t.attributes?t.attributes:[],this.previousExtent_=ji(),this.currentTransform_=i,this.renderTransform_=Qe(),this.invertRenderTransform_=Qe(),this.renderInstructions_=new Float32Array(0),this.hitRenderTarget_,this.lastSentId=0,this.worker_=ad(),this.worker_.addEventListener("message",a=>{const l=a.data;if(l.type===xi.GENERATE_POINT_BUFFERS){const u=l.projectionTransform;this.verticesBuffer_.fromArrayBuffer(l.vertexAttributesBuffer),this.instanceAttributesBuffer_.fromArrayBuffer(l.instanceAttributesBuffer),this.helper.flushBufferData(this.verticesBuffer_),this.helper.flushBufferData(this.instanceAttributesBuffer_),this.indicesBuffer_.fromArrayBuffer(l.indicesBuffer),this.helper.flushBufferData(this.indicesBuffer_),this.renderTransform_=u,Gn(this.invertRenderTransform_,this.renderTransform_),this.renderInstructions_=new Float32Array(a.data.renderInstructions),l.id===this.lastSentId&&(this.ready=!0),this.getLayer().changed()}}),this.featureCache_={},this.featureCount_=0;const o=this.getLayer().getSource();this.sourceListenKeys_=[mr(o,Nr.ADDFEATURE,this.handleSourceFeatureAdded_,this),mr(o,Nr.CHANGEFEATURE,this.handleSourceFeatureChanged_,this),mr(o,Nr.REMOVEFEATURE,this.handleSourceFeatureDelete_,this),mr(o,Nr.CLEAR,this.handleSourceFeatureClear_,this)],o.forEachFeature(a=>{const l=a.getGeometry();l&&l.getType()==="Point"&&(this.featureCache_[me(a)]={feature:a,properties:a.getProperties(),flatCoordinates:l.getFlatCoordinates()},this.featureCount_++)})}afterHelperCreated(){this.program_=this.helper.getProgram(this.fragmentShader_,this.vertexShader_),this.hitDetectionEnabled_&&(this.hitRenderTarget_=new hd(this.helper)),this.verticesBuffer_.getArray()&&this.helper.flushBufferData(this.verticesBuffer_),this.indicesBuffer_.getArray()&&this.helper.flushBufferData(this.indicesBuffer_)}handleSourceFeatureAdded_(e){const t=e.feature,n=t.getGeometry();n&&n.getType()==="Point"&&(this.featureCache_[me(t)]={feature:t,properties:t.getProperties(),flatCoordinates:n.getFlatCoordinates()},this.featureCount_++)}handleSourceFeatureChanged_(e){const t=e.feature,n=me(t),i=this.featureCache_[n],s=t.getGeometry();i?s&&s.getType()==="Point"?(i.properties=t.getProperties(),i.flatCoordinates=s.getFlatCoordinates()):(delete this.featureCache_[n],this.featureCount_--):s&&s.getType()==="Point"&&(this.featureCache_[n]={feature:t,properties:t.getProperties(),flatCoordinates:s.getFlatCoordinates()},this.featureCount_++)}handleSourceFeatureDelete_(e){const t=e.feature,n=me(t);n in this.featureCache_&&(delete this.featureCache_[n],this.featureCount_--)}handleSourceFeatureClear_(){this.featureCache_={},this.featureCount_=0}renderFrame(e){const t=this.helper.getGL();this.preRender(t,e);const[n,i,s]=fd(e,this.getLayer());return this.renderWorlds(e,!1,n,i,s),this.helper.finalizeDraw(e,this.dispatchPreComposeEvent,this.dispatchPostComposeEvent),this.hitDetectionEnabled_&&(this.renderWorlds(e,!0,n,i,s),this.hitRenderTarget_.clearCachedData()),this.postRender(t,e),this.helper.getCanvas()}prepareFrameInternal(e){const t=this.getLayer(),n=t.getSource(),i=e.viewState,s=!e.viewHints[kr.ANIMATING]&&!e.viewHints[kr.INTERACTING],o=!Pi(this.previousExtent_,e.extent),a=this.sourceRevision_<n.getRevision();if(a&&(this.sourceRevision_=n.getRevision()),s&&(o||a)){const l=i.projection,u=i.resolution,c=t instanceof co?t.getRenderBuffer():0,h=xl(e.extent,c*u);n.loadFeatures(h,u,l),this.rebuildBuffers_(e),this.previousExtent_=e.extent.slice()}return this.helper.useProgram(this.program_,e),this.helper.prepareDraw(e),!0}rebuildBuffers_(e){const t=Qe();this.helper.makeProjectionTransform(e,t);const i=(this.hitDetectionEnabled_?5:2)+this.customAttributes.length,s=i*this.featureCount_,o=this.renderInstructions_&&this.renderInstructions_.length===s?this.renderInstructions_:new Float32Array(s);this.renderInstructions_=null;let a=[];const l=[];let u=-1;e.viewState.projection;for(const h in this.featureCache_){const f=this.featureCache_[h];if(a[0]=f.flatCoordinates[0],a[1]=f.flatCoordinates[1],hr(t,a),o[++u]=a[0],o[++u]=a[1],this.hitDetectionEnabled_){const p=ld(u+3,l);o[++u]=p[0],o[++u]=p[1],o[++u]=Number(h)}for(let p=0;p<this.customAttributes.length;p++){const d=this.customAttributes[p].callback(f.feature,f.properties);o[++u]=d}}const c={id:++this.lastSentId,type:xi.GENERATE_POINT_BUFFERS,renderInstructions:o.buffer,customAttributesSize:i-2};c.projectionTransform=t,this.ready=!1,this.worker_.postMessage(c,[o.buffer])}forEachFeatureAtCoordinate(e,t,n,i,s){if(Ct(this.hitDetectionEnabled_,"`forEachFeatureAtCoordinate` cannot be used on a WebGL layer if the hit detection logic has been disabled using the `disableHitDetection: true` option."),!this.renderInstructions_||!this.hitDetectionEnabled_)return;const o=hr(t.coordinateToPixelTransform,e.slice()),a=this.hitRenderTarget_.readPixel(o[0]/2,o[1]/2),l=[a[0]/255,a[1]/255,a[2]/255,a[3]/255],u=ud(l),c=this.renderInstructions_[u],h=Math.floor(c).toString(),p=this.getLayer().getSource().getFeatureByUid(h);if(p)return i(p,this.getLayer(),null)}renderWorlds(e,t,n,i,s){let o=n;this.helper.useProgram(this.program_,e),t&&(this.hitRenderTarget_.setSize([Math.floor(e.size[0]/2),Math.floor(e.size[1]/2)]),this.helper.prepareDrawToRenderTarget(e,this.hitRenderTarget_,!0));const a=this.instanceAttributes.reduce((u,c)=>u+(c.size||1),0),l=this.instanceAttributesBuffer_.getSize()/a;do{this.helper.bindBuffer(this.indicesBuffer_),this.helper.bindBuffer(this.verticesBuffer_),this.helper.enableAttributes(this.attributes),this.helper.bindBuffer(this.instanceAttributesBuffer_),this.helper.enableAttributesInstanced(this.instanceAttributes),this.helper.makeProjectionTransform(e,this.currentTransform_),ml(this.currentTransform_,o*s,0),an(this.currentTransform_,this.invertRenderTransform_),this.helper.applyUniforms(e),this.helper.applyHitDetectionUniform(t);const u=this.indicesBuffer_.getSize();this.helper.drawElementsInstanced(0,u,l)}while(++o<i)}disposeInternal(){this.worker_.terminate(),this.sourceListenKeys_.forEach(function(e){Ps(e)}),this.sourceListenKeys_=null,super.disposeInternal()}renderDeclutter(){}}class gR extends Tl{constructor(e){const t=Object.assign({},e);super(t),this.styleVariables_=e.variables||{},this.parseResult_=$a(e.style,this.styleVariables_,e.filter),this.hitDetectionDisabled_=!!e.disableHitDetection}createRenderer(){const e=Object.keys(this.parseResult_.attributes).map(t=>({name:t,...this.parseResult_.attributes[t]}));return new sx(this,{vertexShader:this.parseResult_.builder.getSymbolVertexShader(),fragmentShader:this.parseResult_.builder.getSymbolFragmentShader(),hitDetectionEnabled:!this.hitDetectionDisabled_,uniforms:this.parseResult_.uniforms,attributes:e})}updateStyleVariables(e){Object.assign(this.styleVariables_,e),this.changed()}}function Xc(r,e){const t=`
    attribute vec2 ${xs.TEXTURE_COORD};
    uniform mat4 ${J.TILE_TRANSFORM};
    uniform float ${J.TEXTURE_PIXEL_WIDTH};
    uniform float ${J.TEXTURE_PIXEL_HEIGHT};
    uniform float ${J.TEXTURE_RESOLUTION};
    uniform float ${J.TEXTURE_ORIGIN_X};
    uniform float ${J.TEXTURE_ORIGIN_Y};
    uniform float ${J.DEPTH};

    varying vec2 v_textureCoord;
    varying vec2 v_mapCoord;

    void main() {
      v_textureCoord = ${xs.TEXTURE_COORD};
      v_mapCoord = vec2(
        ${J.TEXTURE_ORIGIN_X} + ${J.TEXTURE_RESOLUTION} * ${J.TEXTURE_PIXEL_WIDTH} * v_textureCoord[0],
        ${J.TEXTURE_ORIGIN_Y} - ${J.TEXTURE_RESOLUTION} * ${J.TEXTURE_PIXEL_HEIGHT} * v_textureCoord[1]
      );
      gl_Position = ${J.TILE_TRANSFORM} * vec4(${xs.TEXTURE_COORD}, ${J.DEPTH}, 1.0);
    }
  `,n={...Vl(),bandCount:e},i=[];if(r.color!==void 0){const h=W(n,r.color,_t);i.push(`color = ${h};`)}if(r.contrast!==void 0){const h=W(n,r.contrast,pe);i.push(`color.rgb = clamp((${h} + 1.0) * color.rgb - (${h} / 2.0), vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0));`)}if(r.exposure!==void 0){const h=W(n,r.exposure,pe);i.push(`color.rgb = clamp((${h} + 1.0) * color.rgb, vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0));`)}if(r.saturation!==void 0){const h=W(n,r.saturation,pe);i.push(`
      float saturation = ${h} + 1.0;
      float sr = (1.0 - saturation) * 0.2126;
      float sg = (1.0 - saturation) * 0.7152;
      float sb = (1.0 - saturation) * 0.0722;
      mat3 saturationMatrix = mat3(
        sr + saturation, sr, sr,
        sg, sg + saturation, sg,
        sb, sb, sb + saturation
      );
      color.rgb = clamp(saturationMatrix * color.rgb, vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0));
    `)}if(r.gamma!==void 0){const h=W(n,r.gamma,pe);i.push(`color.rgb = pow(color.rgb, vec3(1.0 / ${h}));`)}if(r.brightness!==void 0){const h=W(n,r.brightness,pe);i.push(`color.rgb = clamp(color.rgb + ${h}, vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0));`)}const s={},o=Object.keys(n.variables).length;if(o>1&&!r.variables)throw new Error(`Missing variables in style (expected ${n.variables})`);for(let h=0;h<o;++h){const f=n.variables[Object.keys(n.variables)[h]];if(!(f.name in r.variables))throw new Error(`Missing '${f.name}' in style variables`);const p=yo(f.name);s[p]=function(){let d=r.variables[f.name];return typeof d=="string"&&(d=kn(d)),d!==void 0?d:-9999999}}const a=Object.keys(s).map(function(h){return`uniform float ${h};`}),l=Math.ceil(e/4);a.push(`uniform sampler2D ${J.TILE_TEXTURE_ARRAY}[${l}];`),n.paletteTextures&&a.push(`uniform sampler2D ${ed}[${n.paletteTextures.length}];`);const u=Object.keys(n.functions).map(function(h){return n.functions[h]}),c=`
    #ifdef GL_FRAGMENT_PRECISION_HIGH
    precision highp float;
    #else
    precision mediump float;
    #endif

    varying vec2 v_textureCoord;
    varying vec2 v_mapCoord;
    uniform vec4 ${J.RENDER_EXTENT};
    uniform float ${J.TRANSITION_ALPHA};
    uniform float ${J.TEXTURE_PIXEL_WIDTH};
    uniform float ${J.TEXTURE_PIXEL_HEIGHT};
    uniform float ${J.RESOLUTION};
    uniform float ${J.ZOOM};

    ${a.join(`
`)}

    ${u.join(`
`)}

    void main() {
      if (
        v_mapCoord[0] < ${J.RENDER_EXTENT}[0] ||
        v_mapCoord[1] < ${J.RENDER_EXTENT}[1] ||
        v_mapCoord[0] > ${J.RENDER_EXTENT}[2] ||
        v_mapCoord[1] > ${J.RENDER_EXTENT}[3]
      ) {
        discard;
      }

      vec4 color = texture2D(${J.TILE_TEXTURE_ARRAY}[0],  v_textureCoord);

      ${i.join(`
`)}

      gl_FragColor = color;
      gl_FragColor.rgb *= gl_FragColor.a;
      gl_FragColor *= ${J.TRANSITION_ALPHA};
    }`;return{vertexShader:t,fragmentShader:c,uniforms:s,paletteTextures:n.paletteTextures}}class ja extends sm{constructor(e){e=e?Object.assign({},e):{};const t=e.style||{};delete e.style,super(e),this.sources_=e.sources,this.renderedSource_=null,this.renderedResolution_=NaN,this.style_=t,this.styleVariables_=this.style_.variables||{},this.handleSourceUpdate_(),this.addChangeListener(Oa.SOURCE,this.handleSourceUpdate_)}getSources(e,t){const n=this.getSource();return this.sources_?typeof this.sources_=="function"?this.sources_(e,t):this.sources_:n?[n]:[]}getRenderSource(){return this.renderedSource_||this.getSource()}getSourceState(){const e=this.getRenderSource();return e?e.getState():"undefined"}handleSourceUpdate_(){this.hasRenderer()&&this.getRenderer().clearCache();const e=this.getSource();if(e)if(e.getState()==="loading"){const t=()=>{e.getState()==="ready"&&(e.removeEventListener("change",t),this.setStyle(this.style_))};e.addEventListener("change",t)}else this.setStyle(this.style_)}getSourceBandCount_(){const e=Number.MAX_SAFE_INTEGER,t=this.getSources([-e,-e,e,e],e);return t&&t.length&&"bandCount"in t[0]?t[0].bandCount:4}createRenderer(){const e=Xc(this.style_,this.getSourceBandCount_());return new Lb(this,{vertexShader:e.vertexShader,fragmentShader:e.fragmentShader,uniforms:e.uniforms,cacheSize:this.getCacheSize(),paletteTextures:e.paletteTextures})}renderSources(e,t){const n=this.getRenderer();let i;for(let s=0,o=t.length;s<o;++s)this.renderedSource_=t[s],n.prepareFrame(e)&&(i=n.renderFrame(e));return i}render(e,t){this.rendered=!0;const n=e.viewState,i=this.getSources(e.extent,n.resolution);let s=!0;for(let a=0,l=i.length;a<l;++a){const u=i[a],c=u.getState();if(c=="loading"){const h=()=>{u.getState()=="ready"&&(u.removeEventListener("change",h),this.changed())};u.addEventListener("change",h)}s=s&&c=="ready"}const o=this.renderSources(e,i);if(this.getRenderer().renderComplete&&s)return this.renderedResolution_=n.resolution,o;if(this.renderedResolution_>.5*n.resolution){const a=this.getSources(e.extent,this.renderedResolution_).filter(l=>!i.includes(l));if(a.length>0)return this.renderSources(e,a)}return o}setStyle(e){if(this.styleVariables_=e.variables||{},this.style_=e,this.hasRenderer()){const t=Xc(this.style_,this.getSourceBandCount_());this.getRenderer().reset({vertexShader:t.vertexShader,fragmentShader:t.fragmentShader,uniforms:t.uniforms,paletteTextures:t.paletteTextures}),this.changed()}}updateStyleVariables(e){Object.assign(this.styleVariables_,e),this.changed()}}ja.prototype.dispose;class mR extends Tl{constructor(e){const t=Object.assign({},e);super(t),this.styleVariables_=e.variables||{},this.style_=e.style,this.hitDetectionDisabled_=!!e.disableHitDetection}createRenderer(){return new dd(this,{style:this.style_,variables:this.styleVariables_,disableHitDetection:this.hitDetectionDisabled_})}updateStyleVariables(e){Object.assign(this.styleVariables_,e),this.changed()}setStyle(e){this.style_=e,this.clearRenderer(),this.changed()}}function ox(r){const e=r.load||qn,t=r.imageExtent,n=r.crossOrigin??null;return()=>{const i=new Image;return i.crossOrigin=n,e(i,r.url).then(s=>{const o=nt(t)/s.width,a=Zt(t)/s.height;return{image:s,extent:t,resolution:o!==a?[o,a]:a,pixelRatio:1}})}}class ax extends Hn{constructor(e){const t=e.crossOrigin!==void 0?e.crossOrigin:null,n=e.imageLoadFunction!==void 0?e.imageLoadFunction:Sl;super({attributions:e.attributions,interpolate:e.interpolate,projection:ce(e.projection)}),this.url_=e.url,this.imageExtent_=e.imageExtent,this.image=null,this.image=new bf(this.imageExtent_,void 0,1,ox({url:e.url,imageExtent:e.imageExtent,crossOrigin:t,load:(i,s)=>(this.image.setImage(i),n(this.image,s),qn(i))})),this.image.addEventListener(gt.CHANGE,this.handleImageChange.bind(this))}getImageExtent(){return this.imageExtent_}getImageInternal(e,t,n,i){return zn(e,this.image.getExtent())?this.image:null}getUrl(){return this.url_}}function Jl(r,e,t,n){const i=document.createElement("script"),s="olc_"+me(e);function o(){delete window[s],i.parentNode.removeChild(i)}i.async=!0,i.src=r+(r.includes("?")?"&":"?")+"callback="+s;const a=setTimeout(function(){o(),t&&t()},1e4);window[s]=function(l){clearTimeout(a),o(),e(l)},document.head.appendChild(i)}class lx extends Error{constructor(e){const t="Unexpected response status: "+e.status;super(t),this.name="ResponseError",this.response=e}}class ux extends Error{constructor(e){super("Failed to issue request"),this.name="ClientError",this.client=e}}function pd(r){return new Promise(function(e,t){function n(o){const a=o.target;if(!a.status||a.status>=200&&a.status<300){let l;try{l=JSON.parse(a.responseText)}catch(u){const c="Error parsing response text as JSON: "+u.message;t(new Error(c));return}e(l);return}t(new lx(a))}function i(o){t(new ux(o.target))}const s=new XMLHttpRequest;s.addEventListener("load",n),s.addEventListener("error",i),s.open("GET",r),s.setRequestHeader("Accept","application/json"),s.send()})}function gd(r,e){return e.includes("://")?e:new URL(e,r).href}class Ql extends gn{constructor(e){if(super({attributions:e.attributions,cacheSize:e.cacheSize,crossOrigin:e.crossOrigin,interpolate:e.interpolate,projection:ce("EPSG:3857"),reprojectionErrorThreshold:e.reprojectionErrorThreshold,state:"loading",tileLoadFunction:e.tileLoadFunction,wrapX:e.wrapX!==void 0?e.wrapX:!0,transition:e.transition,zDirection:e.zDirection}),this.tileJSON_=null,this.tileSize_=e.tileSize,e.url)if(e.jsonp)Jl(e.url,this.handleTileJSONResponse.bind(this),this.handleTileJSONError.bind(this));else{const t=new XMLHttpRequest;t.addEventListener("load",this.onXHRLoad_.bind(this)),t.addEventListener("error",this.onXHRError_.bind(this)),t.open("GET",e.url),t.send()}else if(e.tileJSON)this.handleTileJSONResponse(e.tileJSON);else throw new Error("Either `url` or `tileJSON` options must be provided")}onXHRLoad_(e){const t=e.target;if(!t.status||t.status>=200&&t.status<300){let n;try{n=JSON.parse(t.responseText)}catch{this.handleTileJSONError();return}this.handleTileJSONResponse(n)}else this.handleTileJSONError()}onXHRError_(e){this.handleTileJSONError()}getTileJSON(){return this.tileJSON_}handleTileJSONResponse(e){const t=ce("EPSG:4326"),n=this.getProjection();let i;if(e.bounds!==void 0){const u=yl(t,n);i=un(e.bounds,u)}const s=mn(n),o=e.minzoom||0,a=e.maxzoom||22,l=jr({extent:s,maxZoom:a,minZoom:o,tileSize:this.tileSize_});if(this.tileGrid=l,this.tileUrlFunction=xf(e.tiles,l),e.attribution&&!this.getAttributions()){const u=i!==void 0?i:s;this.setAttributions(function(c){return zn(u,c.extent)?[e.attribution]:null})}this.tileJSON_=e,this.setState("ready")}handleTileJSONError(){this.setState("error")}}const cx=`
  attribute vec4 a_position;
  attribute vec4 a_texcoord;

  uniform mat4 u_matrix;
  uniform mat4 u_textureMatrix;

  varying vec2 v_texcoord;

  void main() {
    gl_Position = u_matrix * a_position;
    vec2 texcoord = (u_textureMatrix * a_texcoord).xy;
    v_texcoord = texcoord;
  }
`,hx=`
  precision mediump float;

  varying vec2 v_texcoord;

  uniform sampler2D u_texture;

  void main() {
    if (
      v_texcoord.x < 0.0 ||
      v_texcoord.y < 0.0 ||
      v_texcoord.x > 1.0 ||
      v_texcoord.y > 1.0
    ) {
      discard;
    }
    gl_FragColor = texture2D(u_texture, v_texcoord);
  }
`;class fx{constructor(e){this.gl_=e,this.program_=Va(e,hx,cx),this.positionLocation=e.getAttribLocation(this.program_,"a_position"),this.texcoordLocation=e.getAttribLocation(this.program_,"a_texcoord"),this.matrixLocation=e.getUniformLocation(this.program_,"u_matrix"),this.textureMatrixLocation=e.getUniformLocation(this.program_,"u_textureMatrix"),this.textureLocation=e.getUniformLocation(this.program_,"u_texture"),this.positionBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.positionBuffer),this.positions=[0,0,0,1,1,0,1,0,0,1,1,1],e.bufferData(e.ARRAY_BUFFER,new Float32Array(this.positions),e.STATIC_DRAW),this.texcoordBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.texcoordBuffer),this.texcoords=[0,0,0,1,1,0,1,0,0,1,1,1],e.bufferData(e.ARRAY_BUFFER,new Float32Array(this.texcoords),e.STATIC_DRAW)}drawImage(e,t,n,i,s,o,a,l,u,c,h,f,p){const d=this.gl_;l===void 0&&(l=i),u===void 0&&(u=s),o===void 0&&(o=t),a===void 0&&(a=n),c===void 0&&(c=o),h===void 0&&(h=a),f===void 0&&(f=d.canvas.width),p===void 0&&(p=d.canvas.height),d.bindTexture(d.TEXTURE_2D,e),d.useProgram(this.program_),d.bindBuffer(d.ARRAY_BUFFER,this.positionBuffer),d.enableVertexAttribArray(this.positionLocation),d.vertexAttribPointer(this.positionLocation,2,d.FLOAT,!1,0,0),d.bindBuffer(d.ARRAY_BUFFER,this.texcoordBuffer),d.enableVertexAttribArray(this.texcoordLocation),d.vertexAttribPointer(this.texcoordLocation,2,d.FLOAT,!1,0,0);let g=Ba(0,f,0,p,-1,1);g=ub(g,l,u,0),g=Nc(g,c,h,1),d.uniformMatrix4fv(this.matrixLocation,!1,g);let m=cb(i/t,s/n,0);m=Nc(m,o/t,a/n,1),d.uniformMatrix4fv(this.textureMatrixLocation,!1,m),d.uniform1i(this.textureLocation,0),d.drawArrays(d.TRIANGLES,0,this.positions.length/2)}}function Zc(r,e,t){const n=r.createShader(e);if(n===null)throw new Error("Shader compilation failed");if(r.shaderSource(n,t),r.compileShader(n),!r.getShaderParameter(n,r.COMPILE_STATUS)){const i=r.getShaderInfoLog(n);throw i===null?new Error("Shader info log creation failed"):new Error(i)}return n}function Va(r,e,t){const n=r.createProgram(),i=Zc(r,r.VERTEX_SHADER,t),s=Zc(r,r.FRAGMENT_SHADER,e);if(n===null)throw new Error("Program creation failed");if(r.attachShader(n,i),r.attachShader(n,s),r.linkProgram(n),!r.getProgramParameter(n,r.LINK_STATUS))throw r.getProgramInfoLog(n)===null?new Error("Program info log creation failed"):new Error;return n}const dx=`
  attribute vec4 a_position;

  uniform mat4 u_matrix;

  void main() {
     gl_Position = u_matrix * a_position;
  }
`,px=`
  precision mediump float;

  uniform vec4 u_val;
  void main() {
     gl_FragColor = u_val;
  }
`,gx=`
  attribute vec4 a_position;
  attribute vec2 a_texcoord;

  varying vec2 v_texcoord;

  uniform mat4 u_matrix;

  void main() {
     gl_Position = u_matrix * a_position;
     v_texcoord = a_texcoord;
  }
`,mx=`
  precision mediump float;

  varying vec2 v_texcoord;

  uniform sampler2D u_texture;

  void main() {
    if (v_texcoord.x < 0.0 || v_texcoord.x > 1.0 || v_texcoord.y < 0.0 || v_texcoord.y > 1.0) {
      discard;
    }
    gl_FragColor = texture2D(u_texture, v_texcoord);
  }
`;function yx(r,e,t,n){let i;return t&&t.length?i=t.shift():Zi?i=new OffscreenCanvas(r||300,e||300):i=document.createElement("canvas"),r&&(i.width=r),e&&(i.height=e),i.getContext("webgl",n)}function _x(r){const e=r.canvas;e.width=1,e.height=1,r.clear(r.COLOR_BUFFER_BIT|r.DEPTH_BUFFER_BIT|r.STENCIL_BUFFER_BIT)}const Wc=[];function bx(r,e,t,n,i,s,o,a,l,u,c,h,f,p){const d=Math.round(n*e),g=Math.round(n*t);r.canvas.width=d,r.canvas.height=g;let m,y;if(y=r.createTexture(),r.bindTexture(r.TEXTURE_2D,y),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),f?(r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.LINEAR)):(r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.NEAREST),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.NEAREST)),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,d,g,0,r.RGBA,c,null),m=r.createFramebuffer(),r.bindFramebuffer(r.FRAMEBUFFER,m),r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,y,0),m===null)throw new Error("Could not create framebuffer");if(y===null)throw new Error("Could not create texture");if(l.length===0)return{width:d,height:g,framebuffer:m,texture:y};const _=ji();l.forEach(function(S,I,N){Ng(_,S.extent)});let b,w,x;const E=1/i;{if(b=r.createTexture(),y===null)throw new Error("Could not create texture");w=Math.round(nt(_)*E),x=Math.round(Zt(_)*E);const S=r.getParameter(r.MAX_TEXTURE_SIZE),I=Math.max(w,x),N=I>S?S/I:1,z=Math.round(w*N),X=Math.round(x*N);r.bindTexture(r.TEXTURE_2D,b),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),f?(r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.LINEAR)):(r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.NEAREST),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.NEAREST)),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,z,X,0,r.RGBA,c,null);const C=r.createFramebuffer();r.bindFramebuffer(r.FRAMEBUFFER,C),r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,b,0);const M=new fx(r);l.forEach(function(U,se,H){const Y=(U.extent[0]-_[0])*E*N,le=-(U.extent[3]-_[3])*E*N,Te=nt(U.extent)*E*N,K=Zt(U.extent)*E*N;if(r.bindFramebuffer(r.FRAMEBUFFER,C),r.viewport(0,0,z,X),U.clipExtent){const O=(U.clipExtent[0]-_[0])*E*N,Le=-(U.clipExtent[3]-_[3])*E*N,Ie=nt(U.clipExtent)*E*N,Se=Zt(U.clipExtent)*E*N;r.enable(r.SCISSOR_TEST),r.scissor(f?O:Math.round(O),f?Le:Math.round(Le),f?Ie:Math.round(O+Ie)-Math.round(O),f?Se:Math.round(Le+Se)-Math.round(Le))}M.drawImage(U.texture,U.width,U.height,u,u,U.width-2*u,U.height-2*u,f?Y:Math.round(Y),f?le:Math.round(le),f?Te:Math.round(Y+Te)-Math.round(Y),f?K:Math.round(le+K)-Math.round(le),z,X),r.disable(r.SCISSOR_TEST)}),r.deleteFramebuffer(C)}const v=As(o),A=As(_),P=S=>{const I=(S[0][0]-v[0])/s*n,N=-(S[0][1]-v[1])/s*n,z=(S[1][0]-v[0])/s*n,X=-(S[1][1]-v[1])/s*n,C=(S[2][0]-v[0])/s*n,M=-(S[2][1]-v[1])/s*n;return{u1:z,v1:X,u0:I,v0:N,u2:C,v2:M}};r.bindFramebuffer(r.FRAMEBUFFER,m),r.viewport(0,0,d,g);{const S=[],I=[],N=Va(r,mx,gx);r.useProgram(N);const z=r.getUniformLocation(N,"u_texture");r.bindTexture(r.TEXTURE_2D,b),r.uniform1i(z,0),a.getTriangles().forEach(function(Y,le,Te){const K=Y.source,O=Y.target,{u1:Le,v1:Ie,u0:Se,v0:st,u2:Be,v2:He}=P(O),dr=(K[0][0]-A[0])/i/w,ct=-(K[0][1]-A[1])/i/x,yt=(K[1][0]-A[0])/i/w,$=-(K[1][1]-A[1])/i/x,Tr=(K[2][0]-A[0])/i/w,_n=-(K[2][1]-A[1])/i/x;S.push(Le,Ie,Se,st,Be,He),I.push(yt,$,dr,ct,Tr,_n)});const X=Ba(0,d,g,0,-1,1),C=r.getUniformLocation(N,"u_matrix");r.uniformMatrix4fv(C,!1,X);const M=r.getAttribLocation(N,"a_position"),U=r.createBuffer();r.bindBuffer(r.ARRAY_BUFFER,U),r.bufferData(r.ARRAY_BUFFER,new Float32Array(S),r.STATIC_DRAW),r.vertexAttribPointer(M,2,r.FLOAT,!1,0,0),r.enableVertexAttribArray(M);const se=r.getAttribLocation(N,"a_texcoord"),H=r.createBuffer();r.bindBuffer(r.ARRAY_BUFFER,H),r.bufferData(r.ARRAY_BUFFER,new Float32Array(I),r.STATIC_DRAW),r.vertexAttribPointer(se,2,r.FLOAT,!1,0,0),r.enableVertexAttribArray(se),r.drawArrays(r.TRIANGLES,0,S.length/2)}if(h){const S=Va(r,px,dx);r.useProgram(S);const I=Ba(0,d,g,0,-1,1),N=r.getUniformLocation(S,"u_matrix");r.uniformMatrix4fv(N,!1,I);const z=Array.isArray(h)?h:[0,0,0,255],X=r.getUniformLocation(S,"u_val");r.uniform4fv(X,z);const C=r.getAttribLocation(S,"a_position"),M=r.createBuffer();r.bindBuffer(r.ARRAY_BUFFER,M),r.vertexAttribPointer(C,2,r.FLOAT,!1,0,0),r.enableVertexAttribArray(C);const U=a.getTriangles().reduce(function(se,H){const Y=H.target,{u1:le,v1:Te,u0:K,v0:O,u2:Le,v2:Ie}=P(Y);return se.concat([le,Te,K,O,K,O,Le,Ie,Le,Ie,le,Te])},[]);r.bufferData(r.ARRAY_BUFFER,new Float32Array(U),r.STATIC_DRAW),r.drawArrays(r.LINES,0,U.length/2)}return{width:d,height:g,framebuffer:m,texture:y}}class xx extends vl{constructor(e){super({tileCoord:e.tileCoord,loader:()=>Promise.resolve(new Uint8ClampedArray(4)),interpolate:e.interpolate,transition:e.transition}),this.renderEdges_=e.renderEdges!==void 0?e.renderEdges:!1,this.pixelRatio_=e.pixelRatio,this.gutter_=e.gutter,this.reprojData_=null,this.reprojError_=null,this.reprojSize_=void 0,this.sourceTileGrid_=e.sourceTileGrid,this.targetTileGrid_=e.targetTileGrid,this.wrappedTileCoord_=e.wrappedTileCoord||e.tileCoord,this.sourceTiles_=[],this.sourcesListenerKeys_=null,this.sourceZ_=0;const t=e.sourceProj,n=t.getExtent(),i=e.sourceTileGrid.getExtent();this.clipExtent_=t.canWrapX()?i?$t(n,i):n:i;const s=this.targetTileGrid_.getTileCoordExtent(this.wrappedTileCoord_),o=this.targetTileGrid_.getExtent();let a=this.sourceTileGrid_.getExtent();const l=o?$t(s,o):s;if(nc(l)===0){this.state=ee.EMPTY;return}n&&(a?a=$t(a,n):a=n);const u=this.targetTileGrid_.getResolution(this.wrappedTileCoord_[0]),c=e.targetProj,h=am(t,c,l,u);if(!isFinite(h)||h<=0){this.state=ee.EMPTY;return}const f=e.errorThreshold!==void 0?e.errorThreshold:lm;if(this.triangulation_=new um(t,c,l,a,h*f,u,e.transformMatrix),this.triangulation_.getTriangles().length===0){this.state=ee.EMPTY;return}this.sourceZ_=this.sourceTileGrid_.getZForResolution(h);let p=this.triangulation_.calculateSourceExtent();if(a&&(t.canWrapX()?(p[1]=Fe(p[1],a[1],a[3]),p[3]=Fe(p[3],a[1],a[3])):p=$t(p,a)),!nc(p))this.state=ee.EMPTY;else{let d=0,g=0;t.canWrapX()&&(d=nt(n),g=Math.floor((p[0]-n[0])/d)),Dg(p.slice(),t,!0).forEach(y=>{const _=this.sourceTileGrid_.getTileRangeForExtentAndZ(y,this.sourceZ_),b=e.getTileFunction;for(let w=_.minX;w<=_.maxX;w++)for(let x=_.minY;x<=_.maxY;x++){const E=b(this.sourceZ_,w,x,this.pixelRatio_);if(E){const v=g*d;this.sourceTiles_.push({tile:E,offset:v})}}++g}),this.sourceTiles_.length===0&&(this.state=ee.EMPTY)}}getSize(){return this.reprojSize_}getData(){return this.reprojData_}getError(){return this.reprojError_}reproject_(){const e=[];let t=!1;if(this.sourceTiles_.forEach(w=>{var le;const x=w.tile;if(!x||x.getState()!==ee.LOADED)return;const E=x.getSize(),v=this.gutter_;let A;const P=Ca(x.getData());P?A=P:(t=!0,A=om(La(x.getData())));const S=[E[0]+2*v,E[1]+2*v],I=A instanceof Float32Array,N=S[0]*S[1],z=I?Float32Array:Uint8ClampedArray,X=new z(A.buffer),C=z.BYTES_PER_ELEMENT,M=C*X.length/N,U=X.byteLength/S[1],se=Math.floor(U/C/S[0]),H=this.sourceTileGrid_.getTileCoordExtent(x.tileCoord);H[0]+=w.offset,H[2]+=w.offset;const Y=(le=this.clipExtent_)==null?void 0:le.slice();Y&&(Y[0]+=w.offset,Y[2]+=w.offset),e.push({extent:H,clipExtent:Y,data:X,dataType:z,bytesPerPixel:M,pixelSize:S,bandCount:se})}),this.sourceTiles_.length=0,e.length===0){this.state=ee.ERROR,this.changed();return}const n=this.wrappedTileCoord_[0],i=this.targetTileGrid_.getTileSize(n),s=typeof i=="number"?i:i[0],o=typeof i=="number"?i:i[1],a=Math.round(s*this.pixelRatio_),l=Math.round(o*this.pixelRatio_),u=this.targetTileGrid_.getResolution(n),c=this.sourceTileGrid_.getResolution(this.sourceZ_),h=this.targetTileGrid_.getTileCoordExtent(this.wrappedTileCoord_),f=e[0].bandCount,p=new e[0].dataType(f*a*l),d=yx(a,l,Wc,{premultipliedAlpha:!1,antialias:!1});let g;const m=d.RGBA;let y;e[0].dataType==Float32Array?(y=d.FLOAT,d.getExtension("WEBGL_color_buffer_float"),d.getExtension("OES_texture_float"),d.getExtension("EXT_float_blend"),g=d.getExtension("OES_texture_float_linear")!==null&&this.interpolate):(y=d.UNSIGNED_BYTE,g=this.interpolate);const _=4,b=Math.ceil(f/_);for(let w=b-1;w>=0;--w){const x=[];for(let z=0,X=e.length;z<X;++z){const C=e[z],M=C.pixelSize,U=M[0],se=M[1],H=new C.dataType(_*U*se),Y=C.data;let le=w*_;for(let K=0,O=H.length;K<O;K+=_)H[K]=Y[le],H[K+1]=Y[le+1],H[K+2]=Y[le+2],H[K+3]=Y[le+3],le+=f;const Te=d.createTexture();d.bindTexture(d.TEXTURE_2D,Te),g?(d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MIN_FILTER,d.LINEAR),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MAG_FILTER,d.LINEAR)):(d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MIN_FILTER,d.NEAREST),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MAG_FILTER,d.NEAREST)),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_S,d.CLAMP_TO_EDGE),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_T,d.CLAMP_TO_EDGE),d.texImage2D(d.TEXTURE_2D,0,m,U,se,0,m,y,H),x.push({extent:C.extent,clipExtent:C.clipExtent,texture:Te,width:U,height:se})}const{framebuffer:E,width:v,height:A}=bx(d,s,o,this.pixelRatio_,c,u,h,this.triangulation_,x,this.gutter_,y,this.renderEdges_,g),P=v,S=A*_,I=new e[0].dataType(P*S);d.bindFramebuffer(d.FRAMEBUFFER,E),d.readPixels(0,0,v,A,d.RGBA,y,I);let N=w*_;for(let z=0,X=I.length;z<X;z+=_){const C=(P-1-(z/S|0))*S+z%S;p[N]=I[C],p[N+1]=I[C+1],p[N+2]=I[C+2],p[N+3]=I[C+3],N+=f}}if(_x(d),Wc.push(d.canvas),t){const w=zr(s,o),x=new ImageData(p,s);w.putImageData(x,0,0),this.reprojData_=w.canvas}else this.reprojData_=p;this.reprojSize_=[a,l],this.state=ee.LOADED,this.changed()}load(){if(this.state!==ee.IDLE&&this.state!==ee.ERROR)return;this.state=ee.LOADING,this.changed();let e=0;this.sourcesListenerKeys_=[],this.sourceTiles_.forEach(({tile:t})=>{const n=t.getState();if(n!==ee.IDLE&&n!==ee.LOADING)return;e++;const i=mr(t,gt.CHANGE,()=>{const s=t.getState();(s==ee.LOADED||s==ee.ERROR||s==ee.EMPTY)&&(Ps(i),e--,e===0&&(this.unlistenSources_(),this.reproject_()))});this.sourcesListenerKeys_.push(i)}),e===0?setTimeout(this.reproject_.bind(this),0):this.sourceTiles_.forEach(function({tile:t}){t.getState()==ee.IDLE&&t.load()})}unlistenSources_(){this.sourcesListenerKeys_.forEach(Ps),this.sourcesListenerKeys_=null}}class Ji extends Rl{constructor(e){const t=e.projection===void 0?"EPSG:3857":e.projection;let n=e.tileGrid;n===void 0&&t&&(n=jr({extent:mn(t),maxResolution:e.maxResolution,maxZoom:e.maxZoom,minZoom:e.minZoom,tileSize:e.tileSize})),super({cacheSize:.1,attributions:e.attributions,attributionsCollapsible:e.attributionsCollapsible,projection:t,tileGrid:n,state:e.state,wrapX:e.wrapX,transition:e.transition,interpolate:e.interpolate,key:e.key,zDirection:e.zDirection}),this.gutter_=e.gutter!==void 0?e.gutter:0,this.tileSize_=e.tileSize?Wt(e.tileSize):null,this.tileSizes_=null,this.tileLoadingKeys_={},this.loader_=e.loader,this.handleTileChange_=this.handleTileChange_.bind(this),this.bandCount=e.bandCount===void 0?4:e.bandCount,this.tileGridForProjection_={},this.crossOrigin_=e.crossOrigin||"anonymous",this.transformMatrix=null}setTileSizes(e){this.tileSizes_=e}getTileSize(e){if(this.tileSizes_)return this.tileSizes_[e];if(this.tileSize_)return this.tileSize_;const t=this.getTileGrid();return t?Wt(t.getTileSize(e)):[256,256]}getGutterForProjection(e){const t=this.getProjection();return(!t||bi(t,e))&&!this.transformMatrix?this.gutter_:0}setLoader(e){this.loader_=e}getReprojTile_(e,t,n,i,s,o){const a=this.tileGrid||this.getTileGridForProjection(s||i),l=Math.max.apply(null,a.getResolutions().map((d,g)=>{const m=Wt(a.getTileSize(g)),y=this.getTileSize(g);return Math.max(y[0]/m[0],y[1]/m[1])})),u=this.getTileGridForProjection(i),c=[e,t,n],h=this.getTileCoordForTileUrlFunction(c,i),f=Object.assign({sourceProj:s||i,sourceTileGrid:a,targetProj:i,targetTileGrid:u,tileCoord:c,wrappedTileCoord:h,pixelRatio:l,gutter:this.gutter_,getTileFunction:(d,g,m,y)=>this.getTile(d,g,m,y,void 0,o),transformMatrix:this.transformMatrix},this.tileOptions),p=new xx(f);return p.key=this.getKey(),p}getTile(e,t,n,i,s,o){var E;const a=this.getProjection();if(s&&(a&&!bi(a,s)||this.transformMatrix))return this.getReprojTile_(e,t,n,s,a,o);const l=this.getTileSize(e),u=this.loader_,c=new AbortController,h={signal:c.signal,crossOrigin:this.crossOrigin_},f=this.getTileCoordForTileUrlFunction([e,t,n]);if(!f)return null;const p=this.getKey(),d=cm(this,p,e,t,n);if(o&&o.containsKey(d))return o.get(d);const g=f[0],m=f[1],y=f[2],_=(E=this.getTileGrid())==null?void 0:E.getFullTileRange(g);_&&(h.maxY=_.getHeight()-1);function b(){return Ai(function(){return u(g,m,y,h)})}const w=Object.assign({tileCoord:[e,t,n],loader:b,size:l,controller:c},this.tileOptions),x=new vl(w);return x.key=this.getKey(),x.addEventListener(gt.CHANGE,this.handleTileChange_),o==null||o.set(d,x),x}handleTileChange_(e){const t=e.target,n=me(t),i=t.getState();let s;i==ee.LOADING?(this.tileLoadingKeys_[n]=!0,s=Zo.TILELOADSTART):n in this.tileLoadingKeys_&&(delete this.tileLoadingKeys_[n],s=i==ee.ERROR?Zo.TILELOADERROR:i==ee.LOADED?Zo.TILELOADEND:void 0),s&&this.dispatchEvent(new hm(s,t))}getTileGridForProjection(e){const t=this.getProjection();if(this.tileGrid&&(!t||bi(t,e))&&!this.transformMatrix)return this.tileGrid;const n=me(e);return n in this.tileGridForProjection_||(this.tileGridForProjection_[n]=fm(e)),this.tileGridForProjection_[n]}setTileGridForProjection(e,t){const n=ce(e);if(n){const i=me(n);i in this.tileGridForProjection_||(this.tileGridForProjection_[i]=t)}}}var vt=Uint8Array,Fn=Uint16Array,Ex=Int32Array,md=new vt([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),yd=new vt([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),wx=new vt([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),_d=function(r,e){for(var t=new Fn(31),n=0;n<31;++n)t[n]=e+=1<<r[n-1];for(var i=new Ex(t[30]),n=1;n<30;++n)for(var s=t[n];s<t[n+1];++s)i[s]=s-t[n]<<5|n;return{b:t,r:i}},bd=_d(md,2),xd=bd.b,vx=bd.r;xd[28]=258,vx[258]=28;var Tx=_d(yd,0),Sx=Tx.b,Xa=new Fn(32768);for(var Oe=0;Oe<32768;++Oe){var Pr=(Oe&43690)>>1|(Oe&21845)<<1;Pr=(Pr&52428)>>2|(Pr&13107)<<2,Pr=(Pr&61680)>>4|(Pr&3855)<<4,Xa[Oe]=((Pr&65280)>>8|(Pr&255)<<8)>>1}var Ei=function(r,e,t){for(var n=r.length,i=0,s=new Fn(e);i<n;++i)r[i]&&++s[r[i]-1];var o=new Fn(e);for(i=1;i<e;++i)o[i]=o[i-1]+s[i-1]<<1;var a;if(t){a=new Fn(1<<e);var l=15-e;for(i=0;i<n;++i)if(r[i])for(var u=i<<4|r[i],c=e-r[i],h=o[r[i]-1]++<<c,f=h|(1<<c)-1;h<=f;++h)a[Xa[h]>>l]=u}else for(a=new Fn(n),i=0;i<n;++i)r[i]&&(a[i]=Xa[o[r[i]-1]++]>>15-r[i]);return a},Qi=new vt(288);for(var Oe=0;Oe<144;++Oe)Qi[Oe]=8;for(var Oe=144;Oe<256;++Oe)Qi[Oe]=9;for(var Oe=256;Oe<280;++Oe)Qi[Oe]=7;for(var Oe=280;Oe<288;++Oe)Qi[Oe]=8;var Ed=new vt(32);for(var Oe=0;Oe<32;++Oe)Ed[Oe]=5;var Rx=Ei(Qi,9,1),Px=Ei(Ed,5,1),Jo=function(r){for(var e=r[0],t=1;t<r.length;++t)r[t]>e&&(e=r[t]);return e},Bt=function(r,e,t){var n=e/8|0;return(r[n]|r[n+1]<<8)>>(e&7)&t},Qo=function(r,e){var t=e/8|0;return(r[t]|r[t+1]<<8|r[t+2]<<16)>>(e&7)},Ax=function(r){return(r+7)/8|0},Ix=function(r,e,t){return(t==null||t>r.length)&&(t=r.length),new vt(r.subarray(e,t))},Cx=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],Et=function(r,e,t){var n=new Error(e||Cx[r]);if(n.code=r,Error.captureStackTrace&&Error.captureStackTrace(n,Et),!t)throw n;return n},eu=function(r,e,t,n){var i=r.length,s=0;if(!i||e.f&&!e.l)return t||new vt(0);var o=!t,a=o||e.i!=2,l=e.i;o&&(t=new vt(i*3));var u=function(dr){var ct=t.length;if(dr>ct){var yt=new vt(Math.max(ct*2,dr));yt.set(t),t=yt}},c=e.f||0,h=e.p||0,f=e.b||0,p=e.l,d=e.d,g=e.m,m=e.n,y=i*8;do{if(!p){c=Bt(r,h,1);var _=Bt(r,h+1,3);if(h+=3,_)if(_==1)p=Rx,d=Px,g=9,m=5;else if(_==2){var E=Bt(r,h,31)+257,v=Bt(r,h+10,15)+4,A=E+Bt(r,h+5,31)+1;h+=14;for(var P=new vt(A),S=new vt(19),I=0;I<v;++I)S[wx[I]]=Bt(r,h+I*3,7);h+=v*3;for(var N=Jo(S),z=(1<<N)-1,X=Ei(S,N,1),I=0;I<A;){var C=X[Bt(r,h,z)];h+=C&15;var b=C>>4;if(b<16)P[I++]=b;else{var M=0,U=0;for(b==16?(U=3+Bt(r,h,3),h+=2,M=P[I-1]):b==17?(U=3+Bt(r,h,7),h+=3):b==18&&(U=11+Bt(r,h,127),h+=7);U--;)P[I++]=M}}var se=P.subarray(0,E),H=P.subarray(E);g=Jo(se),m=Jo(H),p=Ei(se,g,1),d=Ei(H,m,1)}else Et(1);else{var b=Ax(h)+4,w=r[b-4]|r[b-3]<<8,x=b+w;if(x>i){l&&Et(0);break}a&&u(f+w),t.set(r.subarray(b,x),f),e.b=f+=w,e.p=h=x*8,e.f=c;continue}if(h>y){l&&Et(0);break}}a&&u(f+131072);for(var Y=(1<<g)-1,le=(1<<m)-1,Te=h;;Te=h){var M=p[Qo(r,h)&Y],K=M>>4;if(h+=M&15,h>y){l&&Et(0);break}if(M||Et(2),K<256)t[f++]=K;else if(K==256){Te=h,p=null;break}else{var O=K-254;if(K>264){var I=K-257,Le=md[I];O=Bt(r,h,(1<<Le)-1)+xd[I],h+=Le}var Ie=d[Qo(r,h)&le],Se=Ie>>4;Ie||Et(3),h+=Ie&15;var H=Sx[Se];if(Se>3){var Le=yd[Se];H+=Qo(r,h)&(1<<Le)-1,h+=Le}if(h>y){l&&Et(0);break}a&&u(f+131072);var st=f+O;if(f<H){var Be=s-H,He=Math.min(H,st);for(Be+f<0&&Et(3);f<He;++f)t[f]=n[Be+f]}for(;f<st;++f)t[f]=t[f-H]}}e.l=p,e.p=Te,e.b=f,e.f=c,p&&(c=1,e.m=g,e.d=d,e.n=m)}while(!c);return f!=t.length&&o?Ix(t,0,f):t.subarray(0,f)},Lx=new vt(0),Fx=function(r){(r[0]!=31||r[1]!=139||r[2]!=8)&&Et(6,"invalid gzip data");var e=r[3],t=10;e&4&&(t+=(r[10]|r[11]<<8)+2);for(var n=(e>>3&1)+(e>>4&1);n>0;n-=!r[t++]);return t+(e&2)},Mx=function(r){var e=r.length;return(r[e-4]|r[e-3]<<8|r[e-2]<<16|r[e-1]<<24)>>>0},Ox=function(r,e){return((r[0]&15)!=8||r[0]>>4>7||(r[0]<<8|r[1])%31)&&Et(6,"invalid zlib data"),(r[1]>>5&1)==1&&Et(6,"invalid zlib data: "+(r[1]&32?"need":"unexpected")+" dictionary"),(r[1]>>3&4)+2};function Nx(r,e){return eu(r,{i:2},e,e)}function Dx(r,e){var t=Fx(r);return t+8>r.length&&Et(6,"invalid gzip data"),eu(r.subarray(t,-8),{i:2},new vt(Mx(r)),e)}function Ux(r,e){return eu(r.subarray(Ox(r),-4),{i:2},e,e)}function Bx(r,e){return r[0]==31&&r[1]==139&&r[2]==8?Dx(r,e):(r[0]&15)!=8||r[0]>>4>7||(r[0]<<8|r[1])%31?Nx(r,e):Ux(r,e)}var Gx=typeof TextDecoder<"u"&&new TextDecoder,zx=0;try{Gx.decode(Lx,{stream:!0}),zx=1}catch{}var kx=Object.defineProperty,wi=Math.pow,Ae=(r,e)=>kx(r,"name",{value:e,configurable:!0}),Je=(r,e,t)=>new Promise((n,i)=>{var s=l=>{try{a(t.next(l))}catch(u){i(u)}},o=l=>{try{a(t.throw(l))}catch(u){i(u)}},a=l=>l.done?n(l.value):Promise.resolve(l.value).then(s,o);a((t=t.apply(r,e)).next())});Ae((r,e)=>{let t=!1,n="",i=L.GridLayer.extend({createTile:Ae((s,o)=>{let a=document.createElement("img"),l=new AbortController,u=l.signal;return a.cancel=()=>{l.abort()},t||(r.getHeader().then(c=>{c.tileType===1?console.error("Error: archive contains MVT vector tiles, but leafletRasterLayer is for displaying raster tiles. See https://github.com/protomaps/PMTiles/tree/main/js for details."):c.tileType===2?n="image/png":c.tileType===3?n="image/jpeg":c.tileType===4?n="image/webp":c.tileType===5&&(n="image/avif")}),t=!0),r.getZxy(s.z,s.x,s.y,u).then(c=>{if(c){let h=new Blob([c.data],{type:n}),f=window.URL.createObjectURL(h);a.src=f,a.cancel=void 0,o(void 0,a)}}).catch(c=>{if(c.name!=="AbortError")throw c}),a},"createTile"),_removeTile:Ae(function(s){let o=this._tiles[s];o&&(o.el.cancel&&o.el.cancel(),o.el.width=0,o.el.height=0,o.el.deleted=!0,L.DomUtil.remove(o.el),delete this._tiles[s],this.fire("tileunload",{tile:o.el,coords:this._keyToTileCoords(s)}))},"_removeTile")});return new i(e)},"leafletRasterLayer");var $x=Ae(r=>(e,t)=>{if(t instanceof AbortController)return r(e,t);let n=new AbortController;return r(e,n).then(i=>t(void 0,i.data,i.cacheControl||"",i.expires||""),i=>t(i)).catch(i=>t(i)),{cancel:Ae(()=>n.abort(),"cancel")}},"v3compat"),jx=class{constructor(e){this.tilev4=Ae((t,n)=>Je(this,null,function*(){if(t.type==="json"){let p=t.url.substr(10),d=this.tiles.get(p);if(d||(d=new Fi(p),this.tiles.set(p,d)),this.metadata)return{data:yield d.getTileJson(t.url)};let g=yield d.getHeader();return(g.minLon>=g.maxLon||g.minLat>=g.maxLat)&&console.error(`Bounds of PMTiles archive ${g.minLon},${g.minLat},${g.maxLon},${g.maxLat} are not valid.`),{data:{tiles:[`${t.url}/{z}/{x}/{y}`],minzoom:g.minZoom,maxzoom:g.maxZoom,bounds:[g.minLon,g.minLat,g.maxLon,g.maxLat]}}}let i=new RegExp(/pmtiles:\/\/(.+)\/(\d+)\/(\d+)\/(\d+)/),s=t.url.match(i);if(!s)throw new Error("Invalid PMTiles protocol URL");let o=s[1],a=this.tiles.get(o);a||(a=new Fi(o),this.tiles.set(o,a));let l=s[2],u=s[3],c=s[4],h=yield a.getHeader(),f=yield a==null?void 0:a.getZxy(+l,+u,+c,n.signal);if(f)return{data:new Uint8Array(f.data),cacheControl:f.cacheControl,expires:f.expires};if(h.tileType===1){if(this.errorOnMissingTile)throw new Error("Tile not found.");return{data:new Uint8Array}}return{data:null}}),"tilev4"),this.tile=$x(this.tilev4),this.tiles=new Map,this.metadata=(e==null?void 0:e.metadata)||!1,this.errorOnMissingTile=(e==null?void 0:e.errorOnMissingTile)||!1}add(e){this.tiles.set(e.source.getKey(),e)}get(e){return this.tiles.get(e)}};Ae(jx,"Protocol");function wd(r,e){return(e>>>0)*4294967296+(r>>>0)}Ae(wd,"toNum");function vd(r,e){let t=e.buf,n=t[e.pos++],i=(n&112)>>4;if(n<128||(n=t[e.pos++],i|=(n&127)<<3,n<128)||(n=t[e.pos++],i|=(n&127)<<10,n<128)||(n=t[e.pos++],i|=(n&127)<<17,n<128)||(n=t[e.pos++],i|=(n&127)<<24,n<128)||(n=t[e.pos++],i|=(n&1)<<31,n<128))return wd(r,i);throw new Error("Expected varint not more than 10 bytes")}Ae(vd,"readVarintRemainder");function Pn(r){let e=r.buf,t=e[r.pos++],n=t&127;return t<128||(t=e[r.pos++],n|=(t&127)<<7,t<128)||(t=e[r.pos++],n|=(t&127)<<14,t<128)||(t=e[r.pos++],n|=(t&127)<<21,t<128)?n:(t=e[r.pos],n|=(t&15)<<28,vd(n,r))}Ae(Pn,"readVarint");function tu(r,e,t,n){if(n===0){t===1&&(e[0]=r-1-e[0],e[1]=r-1-e[1]);let i=e[0];e[0]=e[1],e[1]=i}}Ae(tu,"rotate");function Td(r,e){let t=wi(2,r),n=e,i=e,s=e,o=[0,0],a=1;for(;a<t;)n=1&s/2,i=1&(s^n),tu(a,o,n,i),o[0]+=a*n,o[1]+=a*i,s=s/4,a*=2;return[r,o[0],o[1]]}Ae(Td,"idOnLevel");var Vx=[0,1,5,21,85,341,1365,5461,21845,87381,349525,1398101,5592405,22369621,89478485,357913941,1431655765,5726623061,22906492245,91625968981,366503875925,1466015503701,5864062014805,23456248059221,93824992236885,375299968947541,0x5555555555555];function Sd(r,e,t){if(r>26)throw new Error("Tile zoom level exceeds max safe number limit (26)");if(e>wi(2,r)-1||t>wi(2,r)-1)throw new Error("tile x/y outside zoom level bounds");let n=Vx[r],i=wi(2,r),s=0,o=0,a=0,l=[e,t],u=i/2;for(;u>0;)s=(l[0]&u)>0?1:0,o=(l[1]&u)>0?1:0,a+=u*u*(3*s^o),tu(u,l,s,o),u=u/2;return n+a}Ae(Sd,"zxyToTileId");function Xx(r){let e=0;for(let t=0;t<27;t++){let n=(1<<t)*(1<<t);if(e+n>r)return Td(t,r-e);e+=n}throw new Error("Tile zoom level exceeds max safe number limit (26)")}Ae(Xx,"tileIdToZxy");var Zx=(r=>(r[r.Unknown=0]="Unknown",r[r.None=1]="None",r[r.Gzip=2]="Gzip",r[r.Brotli=3]="Brotli",r[r.Zstd=4]="Zstd",r))(Zx||{});function bo(r,e){return Je(this,null,function*(){if(e===1||e===0)return r;if(e===2){if(typeof globalThis.DecompressionStream>"u")return Bx(new Uint8Array(r));let t=new Response(r).body;if(!t)throw new Error("Failed to read response stream");let n=t.pipeThrough(new globalThis.DecompressionStream("gzip"));return new Response(n).arrayBuffer()}throw new Error("Compression method not supported")})}Ae(bo,"defaultDecompress");var An=(r=>(r[r.Unknown=0]="Unknown",r[r.Mvt=1]="Mvt",r[r.Png=2]="Png",r[r.Jpeg=3]="Jpeg",r[r.Webp=4]="Webp",r[r.Avif=5]="Avif",r))(An||{});function Rd(r){return r===1?".mvt":r===2?".png":r===3?".jpg":r===4?".webp":r===5?".avif":""}Ae(Rd,"tileTypeExt");var Wx=127;function Pd(r,e){let t=0,n=r.length-1;for(;t<=n;){let i=n+t>>1,s=e-r[i].tileId;if(s>0)t=i+1;else if(s<0)n=i-1;else return r[i]}return n>=0&&(r[n].runLength===0||e-r[n].tileId<r[n].runLength)?r[n]:null}Ae(Pd,"findTile");var qx=class{constructor(e){this.file=e}getKey(){return this.file.name}getBytes(e,t){return Je(this,null,function*(){return{data:yield this.file.slice(e,e+t).arrayBuffer()}})}};Ae(qx,"FileSource");var Ad=class{constructor(e,t=new Headers){this.url=e,this.customHeaders=t,this.mustReload=!1;let n="";"navigator"in globalThis&&(n=globalThis.navigator.userAgent||"");let i=n.indexOf("Windows")>-1,s=/Chrome|Chromium|Edg|OPR|Brave/.test(n);this.chromeWindowsNoCache=!1,i&&s&&(this.chromeWindowsNoCache=!0)}getKey(){return this.url}setHeaders(e){this.customHeaders=e}getBytes(e,t,n,i){return Je(this,null,function*(){let s,o;n?o=n:(s=new AbortController,o=s.signal);let a=new Headers(this.customHeaders);a.set("range",`bytes=${e}-${e+t-1}`);let l;this.mustReload?l="reload":this.chromeWindowsNoCache&&(l="no-store");let u=yield fetch(this.url,{signal:o,cache:l,headers:a});if(e===0&&u.status===416){let f=u.headers.get("Content-Range");if(!f||!f.startsWith("bytes */"))throw new Error("Missing content-length on 416 response");let p=+f.substr(8);u=yield fetch(this.url,{signal:o,cache:"reload",headers:{range:`bytes=0-${p-1}`}})}let c=u.headers.get("Etag");if(c!=null&&c.startsWith("W/")&&(c=null),u.status===416||i&&c&&c!==i)throw this.mustReload=!0,new Za(`Server returned non-matching ETag ${i} after one retry. Check browser extensions and servers for issues that may affect correct ETag headers.`);if(u.status>=300)throw new Error(`Bad response code: ${u.status}`);let h=u.headers.get("Content-Length");if(u.status===200&&(!h||+h>t))throw s&&s.abort(),new Error("Server returned no content-length header or content-length exceeding request. Check that your storage backend supports HTTP Byte Serving.");return{data:yield u.arrayBuffer(),etag:c||void 0,cacheControl:u.headers.get("Cache-Control")||void 0,expires:u.headers.get("Expires")||void 0}})}};Ae(Ad,"FetchSource");var Hx=Ad;function Ot(r,e){let t=r.getUint32(e+4,!0),n=r.getUint32(e+0,!0);return t*wi(2,32)+n}Ae(Ot,"getUint64");function Id(r,e){let t=new DataView(r),n=t.getUint8(7);if(n>3)throw new Error(`Archive is spec version ${n} but this library supports up to spec version 3`);return{specVersion:n,rootDirectoryOffset:Ot(t,8),rootDirectoryLength:Ot(t,16),jsonMetadataOffset:Ot(t,24),jsonMetadataLength:Ot(t,32),leafDirectoryOffset:Ot(t,40),leafDirectoryLength:Ot(t,48),tileDataOffset:Ot(t,56),tileDataLength:Ot(t,64),numAddressedTiles:Ot(t,72),numTileEntries:Ot(t,80),numTileContents:Ot(t,88),clustered:t.getUint8(96)===1,internalCompression:t.getUint8(97),tileCompression:t.getUint8(98),tileType:t.getUint8(99),minZoom:t.getUint8(100),maxZoom:t.getUint8(101),minLon:t.getInt32(102,!0)/1e7,minLat:t.getInt32(106,!0)/1e7,maxLon:t.getInt32(110,!0)/1e7,maxLat:t.getInt32(114,!0)/1e7,centerZoom:t.getUint8(118),centerLon:t.getInt32(119,!0)/1e7,centerLat:t.getInt32(123,!0)/1e7,etag:e}}Ae(Id,"bytesToHeader");function ru(r){let e={buf:new Uint8Array(r),pos:0},t=Pn(e),n=[],i=0;for(let s=0;s<t;s++){let o=Pn(e);n.push({tileId:i+o,offset:0,length:0,runLength:1}),i+=o}for(let s=0;s<t;s++)n[s].runLength=Pn(e);for(let s=0;s<t;s++)n[s].length=Pn(e);for(let s=0;s<t;s++){let o=Pn(e);o===0&&s>0?n[s].offset=n[s-1].offset+n[s-1].length:n[s].offset=o-1}return n}Ae(ru,"deserializeIndex");var Cd=class extends Error{};Ae(Cd,"EtagMismatch");var Za=Cd;function nu(r,e){return Je(this,null,function*(){let t=yield r.getBytes(0,16384);if(new DataView(t.data).getUint16(0,!0)!==19792)throw new Error("Wrong magic number for PMTiles archive");let n=t.data.slice(0,Wx),i=Id(n,t.etag),s=t.data.slice(i.rootDirectoryOffset,i.rootDirectoryOffset+i.rootDirectoryLength),o=`${r.getKey()}|${i.etag||""}|${i.rootDirectoryOffset}|${i.rootDirectoryLength}`,a=ru(yield e(s,i.internalCompression));return[i,[o,a.length,a]]})}Ae(nu,"getHeaderAndRoot");function iu(r,e,t,n,i){return Je(this,null,function*(){let s=yield r.getBytes(t,n,void 0,i.etag),o=yield e(s.data,i.internalCompression),a=ru(o);if(a.length===0)throw new Error("Empty directory is invalid");return a})}Ae(iu,"getDirectory");var Yx=class{constructor(e=100,t=!0,n=bo){this.cache=new Map,this.maxCacheEntries=e,this.counter=1,this.decompress=n}getHeader(e){return Je(this,null,function*(){let t=e.getKey(),n=this.cache.get(t);if(n)return n.lastUsed=this.counter++,n.data;let i=yield nu(e,this.decompress);return i[1]&&this.cache.set(i[1][0],{lastUsed:this.counter++,data:i[1][2]}),this.cache.set(t,{lastUsed:this.counter++,data:i[0]}),this.prune(),i[0]})}getDirectory(e,t,n,i){return Je(this,null,function*(){let s=`${e.getKey()}|${i.etag||""}|${t}|${n}`,o=this.cache.get(s);if(o)return o.lastUsed=this.counter++,o.data;let a=yield iu(e,this.decompress,t,n,i);return this.cache.set(s,{lastUsed:this.counter++,data:a}),this.prune(),a})}prune(){if(this.cache.size>this.maxCacheEntries){let e=1/0,t;this.cache.forEach((n,i)=>{n.lastUsed<e&&(e=n.lastUsed,t=i)}),t&&this.cache.delete(t)}}invalidate(e){return Je(this,null,function*(){this.cache.delete(e.getKey())})}};Ae(Yx,"ResolvedValueCache");var Ld=class{constructor(e=100,t=!0,n=bo){this.cache=new Map,this.invalidations=new Map,this.maxCacheEntries=e,this.counter=1,this.decompress=n}getHeader(e){return Je(this,null,function*(){let t=e.getKey(),n=this.cache.get(t);if(n)return n.lastUsed=this.counter++,yield n.data;let i=new Promise((s,o)=>{nu(e,this.decompress).then(a=>{a[1]&&this.cache.set(a[1][0],{lastUsed:this.counter++,data:Promise.resolve(a[1][2])}),s(a[0]),this.prune()}).catch(a=>{o(a)})});return this.cache.set(t,{lastUsed:this.counter++,data:i}),i})}getDirectory(e,t,n,i){return Je(this,null,function*(){let s=`${e.getKey()}|${i.etag||""}|${t}|${n}`,o=this.cache.get(s);if(o)return o.lastUsed=this.counter++,yield o.data;let a=new Promise((l,u)=>{iu(e,this.decompress,t,n,i).then(c=>{l(c),this.prune()}).catch(c=>{u(c)})});return this.cache.set(s,{lastUsed:this.counter++,data:a}),a})}prune(){if(this.cache.size>=this.maxCacheEntries){let e=1/0,t;this.cache.forEach((n,i)=>{n.lastUsed<e&&(e=n.lastUsed,t=i)}),t&&this.cache.delete(t)}}invalidate(e){return Je(this,null,function*(){let t=e.getKey();if(this.invalidations.get(t))return yield this.invalidations.get(t);this.cache.delete(e.getKey());let n=new Promise((i,s)=>{this.getHeader(e).then(o=>{i(),this.invalidations.delete(t)}).catch(o=>{s(o)})});this.invalidations.set(t,n)})}};Ae(Ld,"SharedPromiseCache");var Kx=Ld,Fd=class{constructor(e,t,n){typeof e=="string"?this.source=new Hx(e):this.source=e,n?this.decompress=n:this.decompress=bo,t?this.cache=t:this.cache=new Kx}getHeader(){return Je(this,null,function*(){return yield this.cache.getHeader(this.source)})}getZxyAttempt(e,t,n,i){return Je(this,null,function*(){let s=Sd(e,t,n),o=yield this.cache.getHeader(this.source);if(e<o.minZoom||e>o.maxZoom)return;let a=o.rootDirectoryOffset,l=o.rootDirectoryLength;for(let u=0;u<=3;u++){let c=yield this.cache.getDirectory(this.source,a,l,o),h=Pd(c,s);if(h){if(h.runLength>0){let f=yield this.source.getBytes(o.tileDataOffset+h.offset,h.length,i,o.etag);return{data:yield this.decompress(f.data,o.tileCompression),cacheControl:f.cacheControl,expires:f.expires}}a=o.leafDirectoryOffset+h.offset,l=h.length}else return}throw new Error("Maximum directory depth exceeded")})}getZxy(e,t,n,i){return Je(this,null,function*(){try{return yield this.getZxyAttempt(e,t,n,i)}catch(s){if(s instanceof Za)return this.cache.invalidate(this.source),yield this.getZxyAttempt(e,t,n,i);throw s}})}getMetadataAttempt(){return Je(this,null,function*(){let e=yield this.cache.getHeader(this.source),t=yield this.source.getBytes(e.jsonMetadataOffset,e.jsonMetadataLength,void 0,e.etag),n=yield this.decompress(t.data,e.internalCompression),i=new TextDecoder("utf-8");return JSON.parse(i.decode(n))})}getMetadata(){return Je(this,null,function*(){try{return yield this.getMetadataAttempt()}catch(e){if(e instanceof Za)return this.cache.invalidate(this.source),yield this.getMetadataAttempt();throw e}})}getTileJson(e){return Je(this,null,function*(){let t=yield this.getHeader(),n=yield this.getMetadata(),i=Rd(t.tileType);return{tilejson:"3.0.0",scheme:"xyz",tiles:[`${e}/{z}/{x}/{y}${i}`],vector_layers:n.vector_layers,attribution:n.attribution,description:n.description,name:n.name,version:n.version,bounds:[t.minLon,t.minLat,t.maxLon,t.maxLat],center:[t.centerLon,t.centerLat,t.centerZoom],minzoom:t.minZoom,maxzoom:t.maxZoom}})}};Ae(Fd,"PMTiles");var Fi=Fd,Md=Object.defineProperty,qc=Object.getOwnPropertySymbols,Jx=Object.prototype.hasOwnProperty,Qx=Object.prototype.propertyIsEnumerable,Hc=(r,e,t)=>e in r?Md(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,js=(r,e)=>{for(var t in e||(e={}))Jx.call(e,t)&&Hc(r,t,e[t]);if(qc)for(var t of qc(e))Qx.call(e,t)&&Hc(r,t,e[t]);return r},xo=(r,e)=>Md(r,"name",{value:e,configurable:!0}),eE=(r,e,t)=>new Promise((n,i)=>{var s=l=>{try{a(t.next(l))}catch(u){i(u)}},o=l=>{try{a(t.throw(l))}catch(u){i(u)}},a=l=>l.done?n(l.value):Promise.resolve(l.value).then(s,o);a((t=t.apply(r,e)).next())}),Od=class extends Ji{constructor(e){super(js(js({},e),{state:"loading"})),this.loadImage=xo(n=>new Promise((i,s)=>{const o=new Image;o.addEventListener("load",()=>i(o)),o.addEventListener("error",()=>s(new Error("load failed"))),o.src=n}),"loadImage");const t=new Fi(e.url);t.getHeader().then(n=>{const i=e.projection===void 0?"EPSG:3857":e.projection;this.tileGrid=e.tileGrid||jr({extent:mn(i),maxResolution:e.maxResolution,minZoom:n.minZoom,maxZoom:n.maxZoom,tileSize:e.tileSize}),this.setLoader((s,o,a)=>eE(this,null,function*(){const l=yield t.getZxy(s,o,a);if(!l)return new Uint8Array;const u=URL.createObjectURL(new Blob([l.data])),c=yield this.loadImage(u);return URL.revokeObjectURL(u),c})),this.setState("ready")})}};xo(Od,"PMTilesRasterSource");var Yc=Od,Nd=class extends Yn{constructor(e){super(js(js({},e),{state:"loading",url:"pmtiles://{z}/{x}/{y}",format:e.format||new Pl})),this.tileLoadFunction=xo((t,n)=>{const i=t,s=new RegExp(/pmtiles:\/\/(\d+)\/(\d+)\/(\d+)/),o=n.match(s);if(!(o&&o.length>=4))throw Error("Could not parse tile URL");const a=+o[1],l=+o[2],u=+o[3];i.setLoader((c,h,f)=>{this.pmtiles_.getZxy(a,l,u).then(p=>{if(p){const d=i.getFormat();i.setFeatures(d.readFeatures(p.data,{extent:c,featureProjection:f})),i.setState(ee.LOADED)}else i.setFeatures([]),i.setState(ee.EMPTY)}).catch(p=>{i.setFeatures([]),i.setState(ee.ERROR)})})},"tileLoadFunction"),this.pmtiles_=new Fi(e.url),this.pmtiles_.getHeader().then(t=>{const n=e.projection||"EPSG:3857",i=e.extent||mn(n);this.tileGrid=e.tileGrid||jr({extent:i,maxResolution:e.maxResolution,maxZoom:e.maxZoom!==void 0?e.maxZoom:t.maxZoom,minZoom:t.minZoom,tileSize:e.tileSize||512}),this.setTileLoadFunction(this.tileLoadFunction),this.setState("ready")})}};xo(Nd,"PMTilesVectorSource");var tE=Nd;class rE extends gf{constructor(e){super(gt.ERROR),this.error=e}}function it(r){return(e,...t)=>nE(r,e,t)}function ri(r,e){return it(Dd(r,e).get)}const{apply:nE,getOwnPropertyDescriptor:Dd,getPrototypeOf:su,ownKeys:iE}=Reflect,{iterator:es,toStringTag:sE}=Symbol,oE=Object,{create:ou,defineProperty:aE}=oE,lE=Array,uE=lE.prototype,Ud=uE[es],cE=it(Ud),Bd=ArrayBuffer,hE=Bd.prototype;ri(hE,"byteLength");const Kc=typeof SharedArrayBuffer<"u"?SharedArrayBuffer:null;Kc&&ri(Kc.prototype,"byteLength");const Gd=su(Uint8Array);Gd.from;const mt=Gd.prototype;mt[es];it(mt.keys);it(mt.values);it(mt.entries);it(mt.set);it(mt.reverse);it(mt.fill);it(mt.copyWithin);it(mt.sort);it(mt.slice);it(mt.subarray);ri(mt,"buffer");ri(mt,"byteOffset");ri(mt,"length");ri(mt,sE);const fE=Uint8Array,zd=Uint16Array,au=Uint32Array,dE=Float32Array,Mi=su([][es]()),kd=it(Mi.next),pE=it(function*(){}().next),gE=su(Mi),mE=DataView.prototype,yE=it(mE.getUint16),lu=WeakMap,$d=lu.prototype,jd=it($d.get),_E=it($d.set),Vd=new lu,bE=ou(null,{next:{value:function(){const e=jd(Vd,this);return kd(e)}},[es]:{value:function(){return this}}});function xE(r){if(r[es]===Ud&&Mi.next===kd)return r;const e=ou(bE);return _E(Vd,e,cE(r)),e}const EE=new lu,wE=ou(gE,{next:{value:function(){const e=jd(EE,this);return pE(e)},writable:!0,configurable:!0}});for(const r of iE(Mi))r!=="next"&&aE(wE,r,Dd(Mi,r));const Xd=new Bd(4),vE=new dE(Xd),TE=new au(Xd),Jt=new zd(512),Qt=new fE(512);for(let r=0;r<256;++r){const e=r-127;e<-24?(Jt[r]=0,Jt[r|256]=32768,Qt[r]=24,Qt[r|256]=24):e<-14?(Jt[r]=1024>>-e-14,Jt[r|256]=1024>>-e-14|32768,Qt[r]=-e-1,Qt[r|256]=-e-1):e<=15?(Jt[r]=e+15<<10,Jt[r|256]=e+15<<10|32768,Qt[r]=13,Qt[r|256]=13):e<128?(Jt[r]=31744,Jt[r|256]=64512,Qt[r]=24,Qt[r|256]=24):(Jt[r]=31744,Jt[r|256]=64512,Qt[r]=13,Qt[r|256]=13)}const uu=new au(2048);for(let r=1;r<1024;++r){let e=r<<13,t=0;for(;!(e&8388608);)e<<=1,t-=8388608;e&=-8388609,t+=947912704,uu[r]=e|t}for(let r=1024;r<2048;++r)uu[r]=939524096+(r-1024<<13);const ni=new au(64);for(let r=1;r<31;++r)ni[r]=r<<23;ni[31]=1199570944;ni[32]=2147483648;for(let r=33;r<63;++r)ni[r]=2147483648+(r-32<<23);ni[63]=3347054592;const Zd=new zd(64);for(let r=1;r<64;++r)r!==32&&(Zd[r]=1024);function SE(r){const e=r>>10;return TE[0]=uu[Zd[e]+(r&1023)]+ni[e],vE[0]}function Wd(r,e,...t){return SE(yE(r,e,...xE(t)))}var cu={exports:{}};function qd(r,e,t){const n=t&&t.debug||!1;n&&console.log("[xml-utils] getting "+e+" in "+r);const i=typeof r=="object"?r.outer:r,s=i.slice(0,i.indexOf(">")+1),o=['"',"'"];for(let a=0;a<o.length;a++){const l=o[a],u=e+"\\="+l+"([^"+l+"]*)"+l;n&&console.log("[xml-utils] pattern:",u);const h=new RegExp(u).exec(s);if(n&&console.log("[xml-utils] match:",h),h)return h[1]}}cu.exports=qd;cu.exports.default=qd;var RE=cu.exports;const ea=Cf(RE);var hu={exports:{}},fu={exports:{}},du={exports:{}};function Hd(r,e,t){const i=new RegExp(e).exec(r.slice(t));return i?t+i.index:-1}du.exports=Hd;du.exports.default=Hd;var PE=du.exports,pu={exports:{}};function Yd(r,e,t){const i=new RegExp(e).exec(r.slice(t));return i?t+i.index+i[0].length-1:-1}pu.exports=Yd;pu.exports.default=Yd;var AE=pu.exports,gu={exports:{}};function Kd(r,e){const t=new RegExp(e,"g"),n=r.match(t);return n?n.length:0}gu.exports=Kd;gu.exports.default=Kd;var IE=gu.exports;const CE=PE,ta=AE,Jc=IE;function Jd(r,e,t){const n=t&&t.debug||!1,i=!(t&&typeof t.nested===!1),s=t&&t.startIndex||0;n&&console.log("[xml-utils] starting findTagByName with",e," and ",t);const o=CE(r,`<${e}[ 
>/]`,s);if(n&&console.log("[xml-utils] start:",o),o===-1)return;const a=r.slice(o+e.length);let l=ta(a,"^[^<]*[ /]>",0);const u=l!==-1&&a[l-1]==="/";if(n&&console.log("[xml-utils] selfClosing:",u),u===!1)if(i){let p=0,d=1,g=0;for(;(l=ta(a,"[ /]"+e+">",p))!==-1;){const m=a.substring(p,l+1);if(d+=Jc(m,"<"+e+`[ 
	>]`),g+=Jc(m,"</"+e+">"),g>=d)break;p=l}}else l=ta(a,"[ /]"+e+">",0);const c=o+e.length+l+1;if(n&&console.log("[xml-utils] end:",c),c===-1)return;const h=r.slice(o,c);let f;return u?f=null:f=h.slice(h.indexOf(">")+1,h.lastIndexOf("<")),{inner:f,outer:h,start:o,end:c}}fu.exports=Jd;fu.exports.default=Jd;var LE=fu.exports;const FE=LE;function Qd(r,e,t){const n=[],i=t&&t.debug||!1,s=t&&typeof t.nested=="boolean"?t.nested:!0;let o=t&&t.startIndex||0,a;for(;a=FE(r,e,{debug:i,startIndex:o});)s?o=a.start+1+e.length:o=a.end,n.push(a);return i&&console.log("findTagsByName found",n.length,"tags"),n}hu.exports=Qd;hu.exports.default=Qd;var ME=hu.exports;const OE=Cf(ME),vi={315:"Artist",258:"BitsPerSample",265:"CellLength",264:"CellWidth",320:"ColorMap",259:"Compression",33432:"Copyright",306:"DateTime",338:"ExtraSamples",266:"FillOrder",289:"FreeByteCounts",288:"FreeOffsets",291:"GrayResponseCurve",290:"GrayResponseUnit",316:"HostComputer",270:"ImageDescription",257:"ImageLength",256:"ImageWidth",271:"Make",281:"MaxSampleValue",280:"MinSampleValue",272:"Model",254:"NewSubfileType",274:"Orientation",262:"PhotometricInterpretation",284:"PlanarConfiguration",296:"ResolutionUnit",278:"RowsPerStrip",277:"SamplesPerPixel",305:"Software",279:"StripByteCounts",273:"StripOffsets",255:"SubfileType",263:"Threshholding",282:"XResolution",283:"YResolution",326:"BadFaxLines",327:"CleanFaxData",343:"ClipPath",328:"ConsecutiveBadFaxLines",433:"Decode",434:"DefaultImageColor",269:"DocumentName",336:"DotRange",321:"HalftoneHints",346:"Indexed",347:"JPEGTables",285:"PageName",297:"PageNumber",317:"Predictor",319:"PrimaryChromaticities",532:"ReferenceBlackWhite",339:"SampleFormat",340:"SMinSampleValue",341:"SMaxSampleValue",559:"StripRowCounts",330:"SubIFDs",292:"T4Options",293:"T6Options",325:"TileByteCounts",323:"TileLength",324:"TileOffsets",322:"TileWidth",301:"TransferFunction",318:"WhitePoint",344:"XClipPathUnits",286:"XPosition",529:"YCbCrCoefficients",531:"YCbCrPositioning",530:"YCbCrSubSampling",345:"YClipPathUnits",287:"YPosition",37378:"ApertureValue",40961:"ColorSpace",36868:"DateTimeDigitized",36867:"DateTimeOriginal",34665:"Exif IFD",36864:"ExifVersion",33434:"ExposureTime",41728:"FileSource",37385:"Flash",40960:"FlashpixVersion",33437:"FNumber",42016:"ImageUniqueID",37384:"LightSource",37500:"MakerNote",37377:"ShutterSpeedValue",37510:"UserComment",33723:"IPTC",34675:"ICC Profile",700:"XMP",42112:"GDAL_METADATA",42113:"GDAL_NODATA",34377:"Photoshop",33550:"ModelPixelScale",33922:"ModelTiepoint",34264:"ModelTransformation",34735:"GeoKeyDirectory",34736:"GeoDoubleParams",34737:"GeoAsciiParams",50674:"LercParameters"},er={};for(const r in vi)vi.hasOwnProperty(r)&&(er[vi[r]]=parseInt(r,10));const NE=[er.BitsPerSample,er.ExtraSamples,er.SampleFormat,er.StripByteCounts,er.StripOffsets,er.StripRowCounts,er.TileByteCounts,er.TileOffsets,er.SubIFDs],ra={1:"BYTE",2:"ASCII",3:"SHORT",4:"LONG",5:"RATIONAL",6:"SBYTE",7:"UNDEFINED",8:"SSHORT",9:"SLONG",10:"SRATIONAL",11:"FLOAT",12:"DOUBLE",13:"IFD",16:"LONG8",17:"SLONG8",18:"IFD8"},ie={};for(const r in ra)ra.hasOwnProperty(r)&&(ie[ra[r]]=parseInt(r,10));const dt={WhiteIsZero:0,BlackIsZero:1,RGB:2,Palette:3,CMYK:5,YCbCr:6,CIELab:8,ICCLab:9},DE={Unspecified:0},RR={AddCompression:1},PR={None:0,Deflate:1,Zstandard:2},UE={1024:"GTModelTypeGeoKey",1025:"GTRasterTypeGeoKey",1026:"GTCitationGeoKey",2048:"GeographicTypeGeoKey",2049:"GeogCitationGeoKey",2050:"GeogGeodeticDatumGeoKey",2051:"GeogPrimeMeridianGeoKey",2052:"GeogLinearUnitsGeoKey",2053:"GeogLinearUnitSizeGeoKey",2054:"GeogAngularUnitsGeoKey",2055:"GeogAngularUnitSizeGeoKey",2056:"GeogEllipsoidGeoKey",2057:"GeogSemiMajorAxisGeoKey",2058:"GeogSemiMinorAxisGeoKey",2059:"GeogInvFlatteningGeoKey",2060:"GeogAzimuthUnitsGeoKey",2061:"GeogPrimeMeridianLongGeoKey",2062:"GeogTOWGS84GeoKey",3072:"ProjectedCSTypeGeoKey",3073:"PCSCitationGeoKey",3074:"ProjectionGeoKey",3075:"ProjCoordTransGeoKey",3076:"ProjLinearUnitsGeoKey",3077:"ProjLinearUnitSizeGeoKey",3078:"ProjStdParallel1GeoKey",3079:"ProjStdParallel2GeoKey",3080:"ProjNatOriginLongGeoKey",3081:"ProjNatOriginLatGeoKey",3082:"ProjFalseEastingGeoKey",3083:"ProjFalseNorthingGeoKey",3084:"ProjFalseOriginLongGeoKey",3085:"ProjFalseOriginLatGeoKey",3086:"ProjFalseOriginEastingGeoKey",3087:"ProjFalseOriginNorthingGeoKey",3088:"ProjCenterLongGeoKey",3089:"ProjCenterLatGeoKey",3090:"ProjCenterEastingGeoKey",3091:"ProjCenterNorthingGeoKey",3092:"ProjScaleAtNatOriginGeoKey",3093:"ProjScaleAtCenterGeoKey",3094:"ProjAzimuthAngleGeoKey",3095:"ProjStraightVertPoleLongGeoKey",3096:"ProjRectifiedGridAngleGeoKey",4096:"VerticalCSTypeGeoKey",4097:"VerticalCitationGeoKey",4098:"VerticalDatumGeoKey",4099:"VerticalUnitsGeoKey"};function BE(r,e){const{width:t,height:n}=r,i=new Uint8Array(t*n*3);let s;for(let o=0,a=0;o<r.length;++o,a+=3)s=256-r[o]/e*256,i[a]=s,i[a+1]=s,i[a+2]=s;return i}function GE(r,e){const{width:t,height:n}=r,i=new Uint8Array(t*n*3);let s;for(let o=0,a=0;o<r.length;++o,a+=3)s=r[o]/e*256,i[a]=s,i[a+1]=s,i[a+2]=s;return i}function zE(r,e){const{width:t,height:n}=r,i=new Uint8Array(t*n*3),s=e.length/3,o=e.length/3*2;for(let a=0,l=0;a<r.length;++a,l+=3){const u=r[a];i[l]=e[u]/65536*256,i[l+1]=e[u+s]/65536*256,i[l+2]=e[u+o]/65536*256}return i}function kE(r){const{width:e,height:t}=r,n=new Uint8Array(e*t*3);for(let i=0,s=0;i<r.length;i+=4,s+=3){const o=r[i],a=r[i+1],l=r[i+2],u=r[i+3];n[s]=255*((255-o)/256)*((255-u)/256),n[s+1]=255*((255-a)/256)*((255-u)/256),n[s+2]=255*((255-l)/256)*((255-u)/256)}return n}function $E(r){const{width:e,height:t}=r,n=new Uint8ClampedArray(e*t*3);for(let i=0,s=0;i<r.length;i+=3,s+=3){const o=r[i],a=r[i+1],l=r[i+2];n[s]=o+1.402*(l-128),n[s+1]=o-.34414*(a-128)-.71414*(l-128),n[s+2]=o+1.772*(a-128)}return n}const jE=.95047,VE=1,XE=1.08883;function ZE(r){const{width:e,height:t}=r,n=new Uint8Array(e*t*3);for(let i=0,s=0;i<r.length;i+=3,s+=3){const o=r[i+0],a=r[i+1]<<24>>24,l=r[i+2]<<24>>24;let u=(o+16)/116,c=a/500+u,h=u-l/200,f,p,d;c=jE*(c*c*c>.008856?c*c*c:(c-16/116)/7.787),u=VE*(u*u*u>.008856?u*u*u:(u-16/116)/7.787),h=XE*(h*h*h>.008856?h*h*h:(h-16/116)/7.787),f=c*3.2406+u*-1.5372+h*-.4986,p=c*-.9689+u*1.8758+h*.0415,d=c*.0557+u*-.204+h*1.057,f=f>.0031308?1.055*f**(1/2.4)-.055:12.92*f,p=p>.0031308?1.055*p**(1/2.4)-.055:12.92*p,d=d>.0031308?1.055*d**(1/2.4)-.055:12.92*d,n[s]=Math.max(0,Math.min(1,f))*255,n[s+1]=Math.max(0,Math.min(1,p))*255,n[s+2]=Math.max(0,Math.min(1,d))*255}return n}const ep=new Map;function Vr(r,e){Array.isArray(r)||(r=[r]),r.forEach(t=>ep.set(t,e))}async function tp(r){const e=ep.get(r.Compression);if(!e)throw new Error(`Unknown compression method identifier: ${r.Compression}`);const t=await e();return new t(r)}Vr([void 0,1],()=>vr(()=>import("./raw.DxtaBMev.js"),__vite__mapDeps([0,1])).then(r=>r.default));Vr(5,()=>vr(()=>import("./lzw.BikwkTY2.js"),__vite__mapDeps([2,1])).then(r=>r.default));Vr(6,()=>{throw new Error("old style JPEG compression is not supported.")});Vr(7,()=>vr(()=>import("./jpeg.CbvpOiPg.js"),__vite__mapDeps([3,1])).then(r=>r.default));Vr([8,32946],()=>vr(()=>import("./deflate.B4_27dB1.js"),__vite__mapDeps([4,5,1])).then(r=>r.default));Vr(32773,()=>vr(()=>import("./packbits.D6Qr5eNi.js"),__vite__mapDeps([6,1])).then(r=>r.default));Vr(34887,()=>vr(()=>import("./lerc.BaubD7T4.js"),__vite__mapDeps([7,5,8,1,9,10,11,12,13,14,15])).then(async r=>(await r.zstd.init(),r)).then(r=>r.default));Vr(50001,()=>vr(()=>import("./webimage.CU41Mh7j.js"),__vite__mapDeps([16,1])).then(r=>r.default));function Eo(r,e,t,n=1){return new(Object.getPrototypeOf(r)).constructor(e*t*n)}function WE(r,e,t,n,i){const s=e/n,o=t/i;return r.map(a=>{const l=Eo(a,n,i);for(let u=0;u<i;++u){const c=Math.min(Math.round(o*u),t-1);for(let h=0;h<n;++h){const f=Math.min(Math.round(s*h),e-1),p=a[c*e+f];l[u*n+h]=p}}return l})}function Nn(r,e,t){return(1-t)*r+t*e}function qE(r,e,t,n,i){const s=e/n,o=t/i;return r.map(a=>{const l=Eo(a,n,i);for(let u=0;u<i;++u){const c=o*u,h=Math.floor(c),f=Math.min(Math.ceil(c),t-1);for(let p=0;p<n;++p){const d=s*p,g=d%1,m=Math.floor(d),y=Math.min(Math.ceil(d),e-1),_=a[h*e+m],b=a[h*e+y],w=a[f*e+m],x=a[f*e+y],E=Nn(Nn(_,b,g),Nn(w,x,g),c%1);l[u*n+p]=E}}return l})}function HE(r,e,t,n,i,s="nearest"){switch(s.toLowerCase()){case"nearest":return WE(r,e,t,n,i);case"bilinear":case"linear":return qE(r,e,t,n,i);default:throw new Error(`Unsupported resampling method: '${s}'`)}}function YE(r,e,t,n,i,s){const o=e/n,a=t/i,l=Eo(r,n,i,s);for(let u=0;u<i;++u){const c=Math.min(Math.round(a*u),t-1);for(let h=0;h<n;++h){const f=Math.min(Math.round(o*h),e-1);for(let p=0;p<s;++p){const d=r[c*e*s+f*s+p];l[u*n*s+h*s+p]=d}}}return l}function KE(r,e,t,n,i,s){const o=e/n,a=t/i,l=Eo(r,n,i,s);for(let u=0;u<i;++u){const c=a*u,h=Math.floor(c),f=Math.min(Math.ceil(c),t-1);for(let p=0;p<n;++p){const d=o*p,g=d%1,m=Math.floor(d),y=Math.min(Math.ceil(d),e-1);for(let _=0;_<s;++_){const b=r[h*e*s+m*s+_],w=r[h*e*s+y*s+_],x=r[f*e*s+m*s+_],E=r[f*e*s+y*s+_],v=Nn(Nn(b,w,g),Nn(x,E,g),c%1);l[u*n*s+p*s+_]=v}}}return l}function JE(r,e,t,n,i,s,o="nearest"){switch(o.toLowerCase()){case"nearest":return YE(r,e,t,n,i,s);case"bilinear":case"linear":return KE(r,e,t,n,i,s);default:throw new Error(`Unsupported resampling method: '${o}'`)}}function QE(r,e,t){let n=0;for(let i=e;i<t;++i)n+=r[i];return n}function Wa(r,e,t){switch(r){case 1:if(e<=8)return new Uint8Array(t);if(e<=16)return new Uint16Array(t);if(e<=32)return new Uint32Array(t);break;case 2:if(e===8)return new Int8Array(t);if(e===16)return new Int16Array(t);if(e===32)return new Int32Array(t);break;case 3:switch(e){case 16:case 32:return new Float32Array(t);case 64:return new Float64Array(t)}break}throw Error("Unsupported data format/bitsPerSample")}function ew(r,e){return(r===1||r===2)&&e<=32&&e%8===0?!1:!(r===3&&(e===16||e===32||e===64))}function tw(r,e,t,n,i,s,o){const a=new DataView(r),l=t===2?o*s:o*s*n,u=t===2?1:n,c=Wa(e,i,l),h=parseInt("1".repeat(i),2);if(e===1){let f;t===1?f=n*i:f=i;let p=s*f;p&7&&(p=p+7&-8);for(let d=0;d<o;++d){const g=d*p;for(let m=0;m<s;++m){const y=g+m*u*i;for(let _=0;_<u;++_){const b=y+_*i,w=(d*s+m)*u+_,x=Math.floor(b/8),E=b%8;if(E+i<=8)c[w]=a.getUint8(x)>>8-i-E&h;else if(E+i<=16)c[w]=a.getUint16(x)>>16-i-E&h;else if(E+i<=24){const v=a.getUint16(x)<<8|a.getUint8(x+2);c[w]=v>>24-i-E&h}else c[w]=a.getUint32(x)>>32-i-E&h}}}}return c.buffer}class rp{constructor(e,t,n,i,s,o){this.fileDirectory=e,this.geoKeys=t,this.dataView=n,this.littleEndian=i,this.tiles=s?{}:null,this.isTiled=!e.StripOffsets;const a=e.PlanarConfiguration;if(this.planarConfiguration=typeof a>"u"?1:a,this.planarConfiguration!==1&&this.planarConfiguration!==2)throw new Error("Invalid planar configuration.");this.source=o}getFileDirectory(){return this.fileDirectory}getGeoKeys(){return this.geoKeys}getWidth(){return this.fileDirectory.ImageWidth}getHeight(){return this.fileDirectory.ImageLength}getSamplesPerPixel(){return typeof this.fileDirectory.SamplesPerPixel<"u"?this.fileDirectory.SamplesPerPixel:1}getTileWidth(){return this.isTiled?this.fileDirectory.TileWidth:this.getWidth()}getTileHeight(){return this.isTiled?this.fileDirectory.TileLength:typeof this.fileDirectory.RowsPerStrip<"u"?Math.min(this.fileDirectory.RowsPerStrip,this.getHeight()):this.getHeight()}getBlockWidth(){return this.getTileWidth()}getBlockHeight(e){return this.isTiled||(e+1)*this.getTileHeight()<=this.getHeight()?this.getTileHeight():this.getHeight()-e*this.getTileHeight()}getBytesPerPixel(){let e=0;for(let t=0;t<this.fileDirectory.BitsPerSample.length;++t)e+=this.getSampleByteSize(t);return e}getSampleByteSize(e){if(e>=this.fileDirectory.BitsPerSample.length)throw new RangeError(`Sample index ${e} is out of range.`);return Math.ceil(this.fileDirectory.BitsPerSample[e]/8)}getReaderForSample(e){const t=this.fileDirectory.SampleFormat?this.fileDirectory.SampleFormat[e]:1,n=this.fileDirectory.BitsPerSample[e];switch(t){case 1:if(n<=8)return DataView.prototype.getUint8;if(n<=16)return DataView.prototype.getUint16;if(n<=32)return DataView.prototype.getUint32;break;case 2:if(n<=8)return DataView.prototype.getInt8;if(n<=16)return DataView.prototype.getInt16;if(n<=32)return DataView.prototype.getInt32;break;case 3:switch(n){case 16:return function(i,s){return Wd(this,i,s)};case 32:return DataView.prototype.getFloat32;case 64:return DataView.prototype.getFloat64}break}throw Error("Unsupported data format/bitsPerSample")}getSampleFormat(e=0){return this.fileDirectory.SampleFormat?this.fileDirectory.SampleFormat[e]:1}getBitsPerSample(e=0){return this.fileDirectory.BitsPerSample[e]}getArrayForSample(e,t){const n=this.getSampleFormat(e),i=this.getBitsPerSample(e);return Wa(n,i,t)}async getTileOrStrip(e,t,n,i,s){const o=Math.ceil(this.getWidth()/this.getTileWidth()),a=Math.ceil(this.getHeight()/this.getTileHeight());let l;const{tiles:u}=this;this.planarConfiguration===1?l=t*o+e:this.planarConfiguration===2&&(l=n*o*a+t*o+e);let c,h;this.isTiled?(c=this.fileDirectory.TileOffsets[l],h=this.fileDirectory.TileByteCounts[l]):(c=this.fileDirectory.StripOffsets[l],h=this.fileDirectory.StripByteCounts[l]);const f=(await this.source.fetch([{offset:c,length:h}],s))[0];let p;return u===null||!u[l]?(p=(async()=>{let d=await i.decode(this.fileDirectory,f);const g=this.getSampleFormat(),m=this.getBitsPerSample();return ew(g,m)&&(d=tw(d,g,this.planarConfiguration,this.getSamplesPerPixel(),m,this.getTileWidth(),this.getBlockHeight(t))),d})(),u!==null&&(u[l]=p)):p=u[l],{x:e,y:t,sample:n,data:await p}}async _readRaster(e,t,n,i,s,o,a,l,u){const c=this.getTileWidth(),h=this.getTileHeight(),f=this.getWidth(),p=this.getHeight(),d=Math.max(Math.floor(e[0]/c),0),g=Math.min(Math.ceil(e[2]/c),Math.ceil(f/c)),m=Math.max(Math.floor(e[1]/h),0),y=Math.min(Math.ceil(e[3]/h),Math.ceil(p/h)),_=e[2]-e[0];let b=this.getBytesPerPixel();const w=[],x=[];for(let A=0;A<t.length;++A)this.planarConfiguration===1?w.push(QE(this.fileDirectory.BitsPerSample,0,t[A])/8):w.push(0),x.push(this.getReaderForSample(t[A]));const E=[],{littleEndian:v}=this;for(let A=m;A<y;++A)for(let P=d;P<g;++P){let S;this.planarConfiguration===1&&(S=this.getTileOrStrip(P,A,0,s,u));for(let I=0;I<t.length;++I){const N=I,z=t[I];this.planarConfiguration===2&&(b=this.getSampleByteSize(z),S=this.getTileOrStrip(P,A,z,s,u));const X=S.then(C=>{const M=C.data,U=new DataView(M),se=this.getBlockHeight(C.y),H=C.y*h,Y=C.x*c,le=H+se,Te=(C.x+1)*c,K=x[N],O=Math.min(se,se-(le-e[3]),p-H),Le=Math.min(c,c-(Te-e[2]),f-Y);for(let Ie=Math.max(0,e[1]-H);Ie<O;++Ie)for(let Se=Math.max(0,e[0]-Y);Se<Le;++Se){const st=(Ie*c+Se)*b,Be=K.call(U,st+w[N],v);let He;i?(He=(Ie+H-e[1])*_*t.length+(Se+Y-e[0])*t.length+N,n[He]=Be):(He=(Ie+H-e[1])*_+Se+Y-e[0],n[N][He]=Be)}});E.push(X)}}if(await Promise.all(E),o&&e[2]-e[0]!==o||a&&e[3]-e[1]!==a){let A;return i?A=JE(n,e[2]-e[0],e[3]-e[1],o,a,t.length,l):A=HE(n,e[2]-e[0],e[3]-e[1],o,a,l),A.width=o,A.height=a,A}return n.width=o||e[2]-e[0],n.height=a||e[3]-e[1],n}async readRasters({window:e,samples:t=[],interleave:n,pool:i=null,width:s,height:o,resampleMethod:a,fillValue:l,signal:u}={}){const c=e||[0,0,this.getWidth(),this.getHeight()];if(c[0]>c[2]||c[1]>c[3])throw new Error("Invalid subsets");const h=c[2]-c[0],f=c[3]-c[1],p=h*f,d=this.getSamplesPerPixel();if(!t||!t.length)for(let _=0;_<d;++_)t.push(_);else for(let _=0;_<t.length;++_)if(t[_]>=d)return Promise.reject(new RangeError(`Invalid sample index '${t[_]}'.`));let g;if(n){const _=this.fileDirectory.SampleFormat?Math.max.apply(null,this.fileDirectory.SampleFormat):1,b=Math.max.apply(null,this.fileDirectory.BitsPerSample);g=Wa(_,b,p*t.length),l&&g.fill(l)}else{g=[];for(let _=0;_<t.length;++_){const b=this.getArrayForSample(t[_],p);Array.isArray(l)&&_<l.length?b.fill(l[_]):l&&!Array.isArray(l)&&b.fill(l),g.push(b)}}const m=i||await tp(this.fileDirectory);return await this._readRaster(c,t,g,n,m,s,o,a,u)}async readRGB({window:e,interleave:t=!0,pool:n=null,width:i,height:s,resampleMethod:o,enableAlpha:a=!1,signal:l}={}){const u=e||[0,0,this.getWidth(),this.getHeight()];if(u[0]>u[2]||u[1]>u[3])throw new Error("Invalid subsets");const c=this.fileDirectory.PhotometricInterpretation;if(c===dt.RGB){let y=[0,1,2];if(this.fileDirectory.ExtraSamples!==DE.Unspecified&&a){y=[];for(let _=0;_<this.fileDirectory.BitsPerSample.length;_+=1)y.push(_)}return this.readRasters({window:e,interleave:t,samples:y,pool:n,width:i,height:s,resampleMethod:o,signal:l})}let h;switch(c){case dt.WhiteIsZero:case dt.BlackIsZero:case dt.Palette:h=[0];break;case dt.CMYK:h=[0,1,2,3];break;case dt.YCbCr:case dt.CIELab:h=[0,1,2];break;default:throw new Error("Invalid or unsupported photometric interpretation.")}const f={window:u,interleave:!0,samples:h,pool:n,width:i,height:s,resampleMethod:o,signal:l},{fileDirectory:p}=this,d=await this.readRasters(f),g=2**this.fileDirectory.BitsPerSample[0];let m;switch(c){case dt.WhiteIsZero:m=BE(d,g);break;case dt.BlackIsZero:m=GE(d,g);break;case dt.Palette:m=zE(d,p.ColorMap);break;case dt.CMYK:m=kE(d);break;case dt.YCbCr:m=$E(d);break;case dt.CIELab:m=ZE(d);break;default:throw new Error("Unsupported photometric interpretation.")}if(!t){const y=new Uint8Array(m.length/3),_=new Uint8Array(m.length/3),b=new Uint8Array(m.length/3);for(let w=0,x=0;w<m.length;w+=3,++x)y[x]=m[w],_[x]=m[w+1],b[x]=m[w+2];m=[y,_,b]}return m.width=d.width,m.height=d.height,m}getTiePoints(){if(!this.fileDirectory.ModelTiepoint)return[];const e=[];for(let t=0;t<this.fileDirectory.ModelTiepoint.length;t+=6)e.push({i:this.fileDirectory.ModelTiepoint[t],j:this.fileDirectory.ModelTiepoint[t+1],k:this.fileDirectory.ModelTiepoint[t+2],x:this.fileDirectory.ModelTiepoint[t+3],y:this.fileDirectory.ModelTiepoint[t+4],z:this.fileDirectory.ModelTiepoint[t+5]});return e}getGDALMetadata(e=null){const t={};if(!this.fileDirectory.GDAL_METADATA)return null;const n=this.fileDirectory.GDAL_METADATA;let i=OE(n,"Item");e===null?i=i.filter(s=>ea(s,"sample")===void 0):i=i.filter(s=>Number(ea(s,"sample"))===e);for(let s=0;s<i.length;++s){const o=i[s];t[ea(o,"name")]=o.inner}return t}getGDALNoData(){if(!this.fileDirectory.GDAL_NODATA)return null;const e=this.fileDirectory.GDAL_NODATA;return Number(e.substring(0,e.length-1))}getOrigin(){const e=this.fileDirectory.ModelTiepoint,t=this.fileDirectory.ModelTransformation;if(e&&e.length===6)return[e[3],e[4],e[5]];if(t)return[t[3],t[7],t[11]];throw new Error("The image does not have an affine transformation.")}getResolution(e=null){const t=this.fileDirectory.ModelPixelScale,n=this.fileDirectory.ModelTransformation;if(t)return[t[0],-t[1],t[2]];if(n)return n[1]===0&&n[4]===0?[n[0],-n[5],n[10]]:[Math.sqrt(n[0]*n[0]+n[4]*n[4]),-Math.sqrt(n[1]*n[1]+n[5]*n[5]),n[10]];if(e){const[i,s,o]=e.getResolution();return[i*e.getWidth()/this.getWidth(),s*e.getHeight()/this.getHeight(),o*e.getWidth()/this.getWidth()]}throw new Error("The image does not have an affine transformation.")}pixelIsArea(){return this.geoKeys.GTRasterTypeGeoKey===1}getBoundingBox(e=!1){const t=this.getHeight(),n=this.getWidth();if(this.fileDirectory.ModelTransformation&&!e){const[i,s,o,a,l,u,c,h]=this.fileDirectory.ModelTransformation,p=[[0,0],[0,t],[n,0],[n,t]].map(([m,y])=>[a+i*m+s*y,h+l*m+u*y]),d=p.map(m=>m[0]),g=p.map(m=>m[1]);return[Math.min(...d),Math.min(...g),Math.max(...d),Math.max(...g)]}else{const i=this.getOrigin(),s=this.getResolution(),o=i[0],a=i[1],l=o+s[0]*n,u=a+s[1]*t;return[Math.min(o,l),Math.min(a,u),Math.max(o,l),Math.max(a,u)]}}}class rw{constructor(e){this._dataView=new DataView(e)}get buffer(){return this._dataView.buffer}getUint64(e,t){const n=this.getUint32(e,t),i=this.getUint32(e+4,t);let s;if(t){if(s=n+2**32*i,!Number.isSafeInteger(s))throw new Error(`${s} exceeds MAX_SAFE_INTEGER. Precision may be lost. Please report if you get this message to https://github.com/geotiffjs/geotiff.js/issues`);return s}if(s=2**32*n+i,!Number.isSafeInteger(s))throw new Error(`${s} exceeds MAX_SAFE_INTEGER. Precision may be lost. Please report if you get this message to https://github.com/geotiffjs/geotiff.js/issues`);return s}getInt64(e,t){let n=0;const i=(this._dataView.getUint8(e+(t?7:0))&128)>0;let s=!0;for(let o=0;o<8;o++){let a=this._dataView.getUint8(e+(t?o:7-o));i&&(s?a!==0&&(a=~(a-1)&255,s=!1):a=~a&255),n+=a*256**o}return i&&(n=-n),n}getUint8(e,t){return this._dataView.getUint8(e,t)}getInt8(e,t){return this._dataView.getInt8(e,t)}getUint16(e,t){return this._dataView.getUint16(e,t)}getInt16(e,t){return this._dataView.getInt16(e,t)}getUint32(e,t){return this._dataView.getUint32(e,t)}getInt32(e,t){return this._dataView.getInt32(e,t)}getFloat16(e,t){return Wd(this._dataView,e,t)}getFloat32(e,t){return this._dataView.getFloat32(e,t)}getFloat64(e,t){return this._dataView.getFloat64(e,t)}}class nw{constructor(e,t,n,i){this._dataView=new DataView(e),this._sliceOffset=t,this._littleEndian=n,this._bigTiff=i}get sliceOffset(){return this._sliceOffset}get sliceTop(){return this._sliceOffset+this.buffer.byteLength}get littleEndian(){return this._littleEndian}get bigTiff(){return this._bigTiff}get buffer(){return this._dataView.buffer}covers(e,t){return this.sliceOffset<=e&&this.sliceTop>=e+t}readUint8(e){return this._dataView.getUint8(e-this._sliceOffset,this._littleEndian)}readInt8(e){return this._dataView.getInt8(e-this._sliceOffset,this._littleEndian)}readUint16(e){return this._dataView.getUint16(e-this._sliceOffset,this._littleEndian)}readInt16(e){return this._dataView.getInt16(e-this._sliceOffset,this._littleEndian)}readUint32(e){return this._dataView.getUint32(e-this._sliceOffset,this._littleEndian)}readInt32(e){return this._dataView.getInt32(e-this._sliceOffset,this._littleEndian)}readFloat32(e){return this._dataView.getFloat32(e-this._sliceOffset,this._littleEndian)}readFloat64(e){return this._dataView.getFloat64(e-this._sliceOffset,this._littleEndian)}readUint64(e){const t=this.readUint32(e),n=this.readUint32(e+4);let i;if(this._littleEndian){if(i=t+2**32*n,!Number.isSafeInteger(i))throw new Error(`${i} exceeds MAX_SAFE_INTEGER. Precision may be lost. Please report if you get this message to https://github.com/geotiffjs/geotiff.js/issues`);return i}if(i=2**32*t+n,!Number.isSafeInteger(i))throw new Error(`${i} exceeds MAX_SAFE_INTEGER. Precision may be lost. Please report if you get this message to https://github.com/geotiffjs/geotiff.js/issues`);return i}readInt64(e){let t=0;const n=(this._dataView.getUint8(e+(this._littleEndian?7:0))&128)>0;let i=!0;for(let s=0;s<8;s++){let o=this._dataView.getUint8(e+(this._littleEndian?s:7-s));n&&(i?o!==0&&(o=~(o-1)&255,i=!1):o=~o&255),t+=o*256**s}return n&&(t=-t),t}readOffset(e){return this._bigTiff?this.readUint64(e):this.readUint32(e)}}const iw=typeof navigator<"u"&&navigator.hardwareConcurrency||2;class np{constructor(e=iw,t){this.workers=null,this._awaitingDecoder=null,this.size=e,this.messageId=0,e&&(this._awaitingDecoder=t?Promise.resolve(t):new Promise(n=>{vr(()=>import("./decoder.tqM1uIvc.js"),[]).then(i=>{n(i.create)})}),this._awaitingDecoder.then(n=>{this._awaitingDecoder=null,this.workers=[];for(let i=0;i<e;i++)this.workers.push({worker:n(),idle:!0})}))}async decode(e,t){return this._awaitingDecoder&&await this._awaitingDecoder,this.size===0?tp(e).then(n=>n.decode(e,t)):new Promise(n=>{const i=this.workers.find(a=>a.idle)||this.workers[Math.floor(Math.random()*this.size)];i.idle=!1;const s=this.messageId++,o=a=>{a.data.id===s&&(i.idle=!0,n(a.data.decoded),i.worker.removeEventListener("message",o))};i.worker.addEventListener("message",o),i.worker.postMessage({fileDirectory:e,buffer:t,id:s},[t])})}destroy(){this.workers&&(this.workers.forEach(e=>{e.worker.terminate()}),this.workers=null)}}const Qc=`\r
\r
`;function ip(r){if(typeof Object.fromEntries<"u")return Object.fromEntries(r);const e={};for(const[t,n]of r)e[t.toLowerCase()]=n;return e}function sw(r){const e=r.split(`\r
`).map(t=>{const n=t.split(":").map(i=>i.trim());return n[0]=n[0].toLowerCase(),n});return ip(e)}function ow(r){const[e,...t]=r.split(";").map(i=>i.trim()),n=t.map(i=>i.split("="));return{type:e,params:ip(n)}}function qa(r){let e,t,n;return r&&([,e,t,n]=r.match(/bytes (\d+)-(\d+)\/(\d+)/),e=parseInt(e,10),t=parseInt(t,10),n=parseInt(n,10)),{start:e,end:t,total:n}}function aw(r,e){let t=null;const n=new TextDecoder("ascii"),i=[],s=`--${e}`,o=`${s}--`;for(let a=0;a<10;++a)n.decode(new Uint8Array(r,a,s.length))===s&&(t=a);if(t===null)throw new Error("Could not find initial boundary");for(;t<r.byteLength;){const a=n.decode(new Uint8Array(r,t,Math.min(s.length+1024,r.byteLength-t)));if(a.length===0||a.startsWith(o))break;if(!a.startsWith(s))throw new Error("Part does not start with boundary");const l=a.substr(s.length+2);if(l.length===0)break;const u=l.indexOf(Qc),c=sw(l.substr(0,u)),{start:h,end:f,total:p}=qa(c["content-range"]),d=t+s.length+u+Qc.length,g=parseInt(f,10)+1-parseInt(h,10);i.push({headers:c,data:r.slice(d,d+g),offset:h,length:g,fileSize:p}),t=d+g+4}return i}class mu{async fetch(e,t=void 0){return Promise.all(e.map(n=>this.fetchSlice(n,t)))}async fetchSlice(e){throw new Error(`fetching of slice ${e} not possible, not implemented`)}get fileSize(){return null}async close(){}}class lw extends Map{constructor(e={}){if(super(),!(e.maxSize&&e.maxSize>0))throw new TypeError("`maxSize` must be a number greater than 0");if(typeof e.maxAge=="number"&&e.maxAge===0)throw new TypeError("`maxAge` must be a number greater than 0");this.maxSize=e.maxSize,this.maxAge=e.maxAge||Number.POSITIVE_INFINITY,this.onEviction=e.onEviction,this.cache=new Map,this.oldCache=new Map,this._size=0}_emitEvictions(e){if(typeof this.onEviction=="function")for(const[t,n]of e)this.onEviction(t,n.value)}_deleteIfExpired(e,t){return typeof t.expiry=="number"&&t.expiry<=Date.now()?(typeof this.onEviction=="function"&&this.onEviction(e,t.value),this.delete(e)):!1}_getOrDeleteIfExpired(e,t){if(this._deleteIfExpired(e,t)===!1)return t.value}_getItemValue(e,t){return t.expiry?this._getOrDeleteIfExpired(e,t):t.value}_peek(e,t){const n=t.get(e);return this._getItemValue(e,n)}_set(e,t){this.cache.set(e,t),this._size++,this._size>=this.maxSize&&(this._size=0,this._emitEvictions(this.oldCache),this.oldCache=this.cache,this.cache=new Map)}_moveToRecent(e,t){this.oldCache.delete(e),this._set(e,t)}*_entriesAscending(){for(const e of this.oldCache){const[t,n]=e;this.cache.has(t)||this._deleteIfExpired(t,n)===!1&&(yield e)}for(const e of this.cache){const[t,n]=e;this._deleteIfExpired(t,n)===!1&&(yield e)}}get(e){if(this.cache.has(e)){const t=this.cache.get(e);return this._getItemValue(e,t)}if(this.oldCache.has(e)){const t=this.oldCache.get(e);if(this._deleteIfExpired(e,t)===!1)return this._moveToRecent(e,t),t.value}}set(e,t,{maxAge:n=this.maxAge}={}){const i=typeof n=="number"&&n!==Number.POSITIVE_INFINITY?Date.now()+n:void 0;return this.cache.has(e)?this.cache.set(e,{value:t,expiry:i}):this._set(e,{value:t,expiry:i}),this}has(e){return this.cache.has(e)?!this._deleteIfExpired(e,this.cache.get(e)):this.oldCache.has(e)?!this._deleteIfExpired(e,this.oldCache.get(e)):!1}peek(e){if(this.cache.has(e))return this._peek(e,this.cache);if(this.oldCache.has(e))return this._peek(e,this.oldCache)}delete(e){const t=this.cache.delete(e);return t&&this._size--,this.oldCache.delete(e)||t}clear(){this.cache.clear(),this.oldCache.clear(),this._size=0}resize(e){if(!(e&&e>0))throw new TypeError("`maxSize` must be a number greater than 0");const t=[...this._entriesAscending()],n=t.length-e;n<0?(this.cache=new Map(t),this.oldCache=new Map,this._size=t.length):(n>0&&this._emitEvictions(t.slice(0,n)),this.oldCache=new Map(t.slice(n)),this.cache=new Map,this._size=0),this.maxSize=e}*keys(){for(const[e]of this)yield e}*values(){for(const[,e]of this)yield e}*[Symbol.iterator](){for(const e of this.cache){const[t,n]=e;this._deleteIfExpired(t,n)===!1&&(yield[t,n.value])}for(const e of this.oldCache){const[t,n]=e;this.cache.has(t)||this._deleteIfExpired(t,n)===!1&&(yield[t,n.value])}}*entriesDescending(){let e=[...this.cache];for(let t=e.length-1;t>=0;--t){const n=e[t],[i,s]=n;this._deleteIfExpired(i,s)===!1&&(yield[i,s.value])}e=[...this.oldCache];for(let t=e.length-1;t>=0;--t){const n=e[t],[i,s]=n;this.cache.has(i)||this._deleteIfExpired(i,s)===!1&&(yield[i,s.value])}}*entriesAscending(){for(const[e,t]of this._entriesAscending())yield[e,t.value]}get size(){if(!this._size)return this.oldCache.size;let e=0;for(const t of this.oldCache.keys())this.cache.has(t)||e++;return Math.min(this._size+e,this.maxSize)}entries(){return this.entriesAscending()}forEach(e,t=this){for(const[n,i]of this.entriesAscending())e.call(t,i,n,this)}get[Symbol.toStringTag](){return JSON.stringify([...this.entriesAscending()])}}async function uw(r){return new Promise(e=>setTimeout(e,r))}function cw(r,e){const t=Array.isArray(r)?r:Array.from(r),n=Array.isArray(e)?e:Array.from(e);return t.map((i,s)=>[i,n[s]])}class $n extends Error{constructor(e){super(e),Error.captureStackTrace&&Error.captureStackTrace(this,$n),this.name="AbortError"}}class hw extends Error{constructor(e,t){super(t),this.errors=e,this.message=t,this.name="AggregateError"}}const fw=hw;class dw{constructor(e,t,n=null){this.offset=e,this.length=t,this.data=n}get top(){return this.offset+this.length}}class eh{constructor(e,t,n){this.offset=e,this.length=t,this.blockIds=n}}class pw extends mu{constructor(e,{blockSize:t=65536,cacheSize:n=100}={}){super(),this.source=e,this.blockSize=t,this.blockCache=new lw({maxSize:n,onEviction:(i,s)=>{this.evictedBlocks.set(i,s)}}),this.evictedBlocks=new Map,this.blockRequests=new Map,this.blockIdsToFetch=new Set,this.abortedBlockIds=new Set}get fileSize(){return this.source.fileSize}async fetch(e,t){const n=[],i=[],s=[];this.evictedBlocks.clear();for(const{offset:f,length:p}of e){let d=f+p;const{fileSize:g}=this;g!==null&&(d=Math.min(d,g));const m=Math.floor(f/this.blockSize)*this.blockSize;for(let y=m;y<d;y+=this.blockSize){const _=Math.floor(y/this.blockSize);!this.blockCache.has(_)&&!this.blockRequests.has(_)&&(this.blockIdsToFetch.add(_),i.push(_)),this.blockRequests.has(_)&&n.push(this.blockRequests.get(_)),s.push(_)}}await uw(),this.fetchBlocks(t);const o=[];for(const f of i)this.blockRequests.has(f)&&o.push(this.blockRequests.get(f));await Promise.allSettled(n),await Promise.allSettled(o);const a=[],l=s.filter(f=>this.abortedBlockIds.has(f)||!this.blockCache.has(f));if(l.forEach(f=>this.blockIdsToFetch.add(f)),l.length>0&&t&&!t.aborted){this.fetchBlocks(null);for(const f of l){const p=this.blockRequests.get(f);if(!p)throw new Error(`Block ${f} is not in the block requests`);a.push(p)}await Promise.allSettled(a)}if(t&&t.aborted)throw new $n("Request was aborted");const u=s.map(f=>this.blockCache.get(f)||this.evictedBlocks.get(f)),c=u.filter(f=>!f);if(c.length)throw new fw(c,"Request failed");const h=new Map(cw(s,u));return this.readSliceData(e,h)}fetchBlocks(e){if(this.blockIdsToFetch.size>0){const t=this.groupBlocks(this.blockIdsToFetch),n=this.source.fetch(t,e);for(let i=0;i<t.length;++i){const s=t[i];for(const o of s.blockIds)this.blockRequests.set(o,(async()=>{try{const a=(await n)[i],l=o*this.blockSize,u=l-a.offset,c=Math.min(u+this.blockSize,a.data.byteLength),h=a.data.slice(u,c),f=new dw(l,h.byteLength,h,o);this.blockCache.set(o,f),this.abortedBlockIds.delete(o)}catch(a){if(a.name==="AbortError")a.signal=e,this.blockCache.delete(o),this.abortedBlockIds.add(o);else throw a}finally{this.blockRequests.delete(o)}})())}this.blockIdsToFetch.clear()}}groupBlocks(e){const t=Array.from(e).sort((o,a)=>o-a);if(t.length===0)return[];let n=[],i=null;const s=[];for(const o of t)i===null||i+1===o?(n.push(o),i=o):(s.push(new eh(n[0]*this.blockSize,n.length*this.blockSize,n)),n=[o],i=o);return s.push(new eh(n[0]*this.blockSize,n.length*this.blockSize,n)),s}readSliceData(e,t){return e.map(n=>{let i=n.offset+n.length;this.fileSize!==null&&(i=Math.min(this.fileSize,i));const s=Math.floor(n.offset/this.blockSize),o=Math.floor(i/this.blockSize),a=new ArrayBuffer(n.length),l=new Uint8Array(a);for(let u=s;u<=o;++u){const c=t.get(u),h=c.offset-n.offset,f=c.top-i;let p=0,d=0,g;h<0?p=-h:h>0&&(d=h),f<0?g=c.length-p:g=i-c.offset-p;const m=new Uint8Array(c.data,p,g);l.set(m,d)}return a})}}class yu{get ok(){return this.status>=200&&this.status<=299}get status(){throw new Error("not implemented")}getHeader(e){throw new Error("not implemented")}async getData(){throw new Error("not implemented")}}class _u{constructor(e){this.url=e}async request({headers:e,signal:t}={}){throw new Error("request is not implemented")}}class gw extends yu{constructor(e){super(),this.response=e}get status(){return this.response.status}getHeader(e){return this.response.headers.get(e)}async getData(){return this.response.arrayBuffer?await this.response.arrayBuffer():(await this.response.buffer()).buffer}}class mw extends _u{constructor(e,t){super(e),this.credentials=t}async request({headers:e,signal:t}={}){const n=await fetch(this.url,{headers:e,credentials:this.credentials,signal:t});return new gw(n)}}class yw extends yu{constructor(e,t){super(),this.xhr=e,this.data=t}get status(){return this.xhr.status}getHeader(e){return this.xhr.getResponseHeader(e)}async getData(){return this.data}}class _w extends _u{constructRequest(e,t){return new Promise((n,i)=>{const s=new XMLHttpRequest;s.open("GET",this.url),s.responseType="arraybuffer";for(const[o,a]of Object.entries(e))s.setRequestHeader(o,a);s.onload=()=>{const o=s.response;n(new yw(s,o))},s.onerror=i,s.onabort=()=>i(new $n("Request aborted")),s.send(),t&&(t.aborted&&s.abort(),t.addEventListener("abort",()=>s.abort()))})}async request({headers:e,signal:t}={}){return await this.constructRequest(e,t)}}const na={};class bw extends yu{constructor(e,t){super(),this.response=e,this.dataPromise=t}get status(){return this.response.statusCode}getHeader(e){return this.response.headers[e]}async getData(){return await this.dataPromise}}class xw extends _u{constructor(e){super(e),this.parsedUrl=na.parse(this.url),this.httpApi=(this.parsedUrl.protocol==="http:",na)}constructRequest(e,t){return new Promise((n,i)=>{const s=this.httpApi.get({...this.parsedUrl,headers:e},o=>{const a=new Promise(l=>{const u=[];o.on("data",c=>{u.push(c)}),o.on("end",()=>{const c=Buffer.concat(u).buffer;l(c)}),o.on("error",i)});n(new bw(o,a))});s.on("error",i),t&&(t.aborted&&s.destroy(new $n("Request aborted")),t.addEventListener("abort",()=>s.destroy(new $n("Request aborted"))))})}async request({headers:e,signal:t}={}){return await this.constructRequest(e,t)}}class bu extends mu{constructor(e,t,n,i){super(),this.client=e,this.headers=t,this.maxRanges=n,this.allowFullFile=i,this._fileSize=null}async fetch(e,t){return this.maxRanges>=e.length?this.fetchSlices(e,t):(this.maxRanges>0&&e.length>1,Promise.all(e.map(n=>this.fetchSlice(n,t))))}async fetchSlices(e,t){const n=await this.client.request({headers:{...this.headers,Range:`bytes=${e.map(({offset:i,length:s})=>`${i}-${i+s}`).join(",")}`},signal:t});if(n.ok)if(n.status===206){const{type:i,params:s}=ow(n.getHeader("content-type"));if(i==="multipart/byteranges"){const h=aw(await n.getData(),s.boundary);return this._fileSize=h[0].fileSize||null,h}const o=await n.getData(),{start:a,end:l,total:u}=qa(n.getHeader("content-range"));this._fileSize=u||null;const c=[{data:o,offset:a,length:l-a}];if(e.length>1){const h=await Promise.all(e.slice(1).map(f=>this.fetchSlice(f,t)));return c.concat(h)}return c}else{if(!this.allowFullFile)throw new Error("Server responded with full file");const i=await n.getData();return this._fileSize=i.byteLength,[{data:i,offset:0,length:i.byteLength}]}else throw new Error("Error fetching data.")}async fetchSlice(e,t){const{offset:n,length:i}=e,s=await this.client.request({headers:{...this.headers,Range:`bytes=${n}-${n+i}`},signal:t});if(s.ok)if(s.status===206){const o=await s.getData(),{total:a}=qa(s.getHeader("content-range"));return this._fileSize=a||null,{data:o,offset:n,length:i}}else{if(!this.allowFullFile)throw new Error("Server responded with full file");const o=await s.getData();return this._fileSize=o.byteLength,{data:o,offset:0,length:o.byteLength}}else throw new Error("Error fetching data.")}get fileSize(){return this._fileSize}}function xu(r,{blockSize:e,cacheSize:t}){return e===null?r:new pw(r,{blockSize:e,cacheSize:t})}function Ew(r,{headers:e={},credentials:t,maxRanges:n=0,allowFullFile:i=!1,...s}={}){const o=new mw(r,t),a=new bu(o,e,n,i);return xu(a,s)}function ww(r,{headers:e={},maxRanges:t=0,allowFullFile:n=!1,...i}={}){const s=new _w(r),o=new bu(s,e,t,n);return xu(o,i)}function vw(r,{headers:e={},maxRanges:t=0,allowFullFile:n=!1,...i}={}){const s=new xw(r),o=new bu(s,e,t,n);return xu(o,i)}function Ha(r,{forceXHR:e=!1,...t}={}){return typeof fetch=="function"&&!e?Ew(r,t):typeof XMLHttpRequest<"u"?ww(r,t):vw(r,t)}class Tw extends mu{constructor(e){super(),this.file=e}async fetchSlice(e,t){return new Promise((n,i)=>{const s=this.file.slice(e.offset,e.offset+e.length),o=new FileReader;o.onload=a=>n(a.target.result),o.onerror=i,o.onabort=i,o.readAsArrayBuffer(s),t&&t.addEventListener("abort",()=>o.abort())})}}function Sw(r){return new Tw(r)}function Ya(r){switch(r){case ie.BYTE:case ie.ASCII:case ie.SBYTE:case ie.UNDEFINED:return 1;case ie.SHORT:case ie.SSHORT:return 2;case ie.LONG:case ie.SLONG:case ie.FLOAT:case ie.IFD:return 4;case ie.RATIONAL:case ie.SRATIONAL:case ie.DOUBLE:case ie.LONG8:case ie.SLONG8:case ie.IFD8:return 8;default:throw new RangeError(`Invalid field type: ${r}`)}}function Rw(r){const e=r.GeoKeyDirectory;if(!e)return null;const t={};for(let n=4;n<=e[3]*4;n+=4){const i=UE[e[n]],s=e[n+1]?vi[e[n+1]]:null,o=e[n+2],a=e[n+3];let l=null;if(!s)l=a;else{if(l=r[s],typeof l>"u"||l===null)throw new Error(`Could not get value of geoKey '${i}'.`);typeof l=="string"?l=l.substring(a,a+o-1):l.subarray&&(l=l.subarray(a,a+o),o===1&&(l=l[0]))}t[i]=l}return t}function vn(r,e,t,n){let i=null,s=null;const o=Ya(e);switch(e){case ie.BYTE:case ie.ASCII:case ie.UNDEFINED:i=new Uint8Array(t),s=r.readUint8;break;case ie.SBYTE:i=new Int8Array(t),s=r.readInt8;break;case ie.SHORT:i=new Uint16Array(t),s=r.readUint16;break;case ie.SSHORT:i=new Int16Array(t),s=r.readInt16;break;case ie.LONG:case ie.IFD:i=new Uint32Array(t),s=r.readUint32;break;case ie.SLONG:i=new Int32Array(t),s=r.readInt32;break;case ie.LONG8:case ie.IFD8:i=new Array(t),s=r.readUint64;break;case ie.SLONG8:i=new Array(t),s=r.readInt64;break;case ie.RATIONAL:i=new Uint32Array(t*2),s=r.readUint32;break;case ie.SRATIONAL:i=new Int32Array(t*2),s=r.readInt32;break;case ie.FLOAT:i=new Float32Array(t),s=r.readFloat32;break;case ie.DOUBLE:i=new Float64Array(t),s=r.readFloat64;break;default:throw new RangeError(`Invalid field type: ${e}`)}if(e===ie.RATIONAL||e===ie.SRATIONAL)for(let a=0;a<t;a+=2)i[a]=s.call(r,n+a*o),i[a+1]=s.call(r,n+(a*o+4));else for(let a=0;a<t;++a)i[a]=s.call(r,n+a*o);return e===ie.ASCII?new TextDecoder("utf-8").decode(i):i}class Pw{constructor(e,t,n){this.fileDirectory=e,this.geoKeyDirectory=t,this.nextIFDByteOffset=n}}class fs extends Error{constructor(e){super(`No image at index ${e}`),this.index=e}}class sp{async readRasters(e={}){const{window:t,width:n,height:i}=e;let{resX:s,resY:o,bbox:a}=e;const l=await this.getImage();let u=l;const c=await this.getImageCount(),h=l.getBoundingBox();if(t&&a)throw new Error('Both "bbox" and "window" passed.');if(n||i){if(t){const[d,g]=l.getOrigin(),[m,y]=l.getResolution();a=[d+t[0]*m,g+t[1]*y,d+t[2]*m,g+t[3]*y]}const p=a||h;if(n){if(s)throw new Error("Both width and resX passed");s=(p[2]-p[0])/n}if(i){if(o)throw new Error("Both width and resY passed");o=(p[3]-p[1])/i}}if(s||o){const p=[];for(let d=0;d<c;++d){const g=await this.getImage(d),{SubfileType:m,NewSubfileType:y}=g.fileDirectory;(d===0||m===2||y&1)&&p.push(g)}p.sort((d,g)=>d.getWidth()-g.getWidth());for(let d=0;d<p.length;++d){const g=p[d],m=(h[2]-h[0])/g.getWidth(),y=(h[3]-h[1])/g.getHeight();if(u=g,s&&s>m||o&&o>y)break}}let f=t;if(a){const[p,d]=l.getOrigin(),[g,m]=u.getResolution(l);f=[Math.round((a[0]-p)/g),Math.round((a[1]-d)/m),Math.round((a[2]-p)/g),Math.round((a[3]-d)/m)],f=[Math.min(f[0],f[2]),Math.min(f[1],f[3]),Math.max(f[0],f[2]),Math.max(f[1],f[3])]}return u.readRasters({...e,window:f})}}class jn extends sp{constructor(e,t,n,i,s={}){super(),this.source=e,this.littleEndian=t,this.bigTiff=n,this.firstIFDOffset=i,this.cache=s.cache||!1,this.ifdRequests=[],this.ghostValues=null}async getSlice(e,t){const n=this.bigTiff?4048:1024;return new nw((await this.source.fetch([{offset:e,length:typeof t<"u"?t:n}]))[0],e,this.littleEndian,this.bigTiff)}async parseFileDirectoryAt(e){const t=this.bigTiff?20:12,n=this.bigTiff?8:2;let i=await this.getSlice(e);const s=this.bigTiff?i.readUint64(e):i.readUint16(e),o=s*t+(this.bigTiff?16:6);i.covers(e,o)||(i=await this.getSlice(e,o));const a={};let l=e+(this.bigTiff?8:2);for(let h=0;h<s;l+=t,++h){const f=i.readUint16(l),p=i.readUint16(l+2),d=this.bigTiff?i.readUint64(l+4):i.readUint32(l+4);let g,m;const y=Ya(p),_=l+(this.bigTiff?12:8);if(y*d<=(this.bigTiff?8:4))g=vn(i,p,d,_);else{const b=i.readOffset(_),w=Ya(p)*d;if(i.covers(b,w))g=vn(i,p,d,b);else{const x=await this.getSlice(b,w);g=vn(x,p,d,b)}}d===1&&NE.indexOf(f)===-1&&!(p===ie.RATIONAL||p===ie.SRATIONAL)?m=g[0]:m=g,a[vi[f]]=m}const u=Rw(a),c=i.readOffset(e+n+t*s);return new Pw(a,u,c)}async requestIFD(e){if(this.ifdRequests[e])return this.ifdRequests[e];if(e===0)return this.ifdRequests[e]=this.parseFileDirectoryAt(this.firstIFDOffset),this.ifdRequests[e];if(!this.ifdRequests[e-1])try{this.ifdRequests[e-1]=this.requestIFD(e-1)}catch(t){throw t instanceof fs?new fs(e):t}return this.ifdRequests[e]=(async()=>{const t=await this.ifdRequests[e-1];if(t.nextIFDByteOffset===0)throw new fs(e);return this.parseFileDirectoryAt(t.nextIFDByteOffset)})(),this.ifdRequests[e]}async getImage(e=0){const t=await this.requestIFD(e);return new rp(t.fileDirectory,t.geoKeyDirectory,this.dataView,this.littleEndian,this.cache,this.source)}async getImageCount(){let e=0,t=!0;for(;t;)try{await this.requestIFD(e),++e}catch(n){if(n instanceof fs)t=!1;else throw n}return e}async getGhostValues(){const e=this.bigTiff?16:8;if(this.ghostValues)return this.ghostValues;const t="GDAL_STRUCTURAL_METADATA_SIZE=",n=t.length+100;let i=await this.getSlice(e,n);if(t===vn(i,ie.ASCII,t.length,e)){const o=vn(i,ie.ASCII,n,e).split(`
`)[0],a=Number(o.split("=")[1].split(" ")[0])+o.length;a>n&&(i=await this.getSlice(e,a));const l=vn(i,ie.ASCII,a,e);this.ghostValues={},l.split(`
`).filter(u=>u.length>0).map(u=>u.split("=")).forEach(([u,c])=>{this.ghostValues[u]=c})}return this.ghostValues}static async fromSource(e,t,n){const i=(await e.fetch([{offset:0,length:1024}],n))[0],s=new rw(i),o=s.getUint16(0,0);let a;if(o===18761)a=!0;else if(o===19789)a=!1;else throw new TypeError("Invalid byte order value.");const l=s.getUint16(2,a);let u;if(l===42)u=!1;else if(l===43){if(u=!0,s.getUint16(4,a)!==8)throw new Error("Unsupported offset byte-size.")}else throw new TypeError("Invalid magic number.");const c=u?s.getUint64(8,a):s.getUint32(4,a);return new jn(e,a,u,c,t)}close(){return typeof this.source.close=="function"?this.source.close():!1}}class Aw extends sp{constructor(e,t){super(),this.mainFile=e,this.overviewFiles=t,this.imageFiles=[e].concat(t),this.fileDirectoriesPerFile=null,this.fileDirectoriesPerFileParsing=null,this.imageCount=null}async parseFileDirectoriesPerFile(){const e=[this.mainFile.parseFileDirectoryAt(this.mainFile.firstIFDOffset)].concat(this.overviewFiles.map(t=>t.parseFileDirectoryAt(t.firstIFDOffset)));return this.fileDirectoriesPerFile=await Promise.all(e),this.fileDirectoriesPerFile}async getImage(e=0){await this.getImageCount(),await this.parseFileDirectoriesPerFile();let t=0,n=0;for(let i=0;i<this.imageFiles.length;i++){const s=this.imageFiles[i];for(let o=0;o<this.imageCounts[i];o++){if(e===t){const a=await s.requestIFD(n);return new rp(a.fileDirectory,a.geoKeyDirectory,s.dataView,s.littleEndian,s.cache,s.source)}t++,n++}n=0}throw new RangeError("Invalid image index")}async getImageCount(){if(this.imageCount!==null)return this.imageCount;const e=[this.mainFile.getImageCount()].concat(this.overviewFiles.map(t=>t.getImageCount()));return this.imageCounts=await Promise.all(e),this.imageCount=this.imageCounts.reduce((t,n)=>t+n,0),this.imageCount}}async function op(r,e={},t){return jn.fromSource(Ha(r,e),t)}async function ap(r,e){return jn.fromSource(Sw(r),e)}async function lp(r,e=[],t={},n){const i=await jn.fromSource(Ha(r,t),n),s=await Promise.all(e.map(o=>jn.fromSource(Ha(o,t))));return new Aw(i,s)}const Iw="https://stac-extensions.github.io/label/v1.*/schema.json",up=new Or({color:"rgba(0,0,0,0)"});function cp(r,e,t="rgba(255,255,255,0.4)",n=5){let i=up;t&&(i=new Or({color:t}));const s=new Mr({color:r,width:e});return new nr({image:new Ef({fill:i,stroke:s,radius:n}),fill:i,stroke:s})}const Cw=cp("#3399CC",3),th=cp("#ff9933",2,null);function Lw(r,e){const t={url:r.getAbsoluteUrl()};let n=r,i=r.getBands();i.length===1&&(n=i[0],i=[]);const{minimum:s,maximum:o}=n.getMinMaxValues();if(typeof s=="number"&&(t.min=s),typeof o=="number"&&(t.max=o),typeof t.min!="number"&&typeof t.max!="number"&&i.length>1)for(const l of i){const{minimum:u,maximum:c}=l.getMinMaxValues();typeof u=="number"&&(typeof t.min>"u"||u<t.min)&&(t.min=u),typeof c=="number"&&(typeof t.max>"u"||c>t.max)&&(t.max=c)}const a=n.getNoDataValues();if(a.length>0)t.nodata=a[0];else if(i.length>1){let l;for(const u of i){const c=u.getNoDataValues();if(c.length>0){if(typeof l>"u")l=c[0];else if(l!==c[0]){l=void 0;break}}}typeof l<"u"&&(t.nodata=l)}if(e.length>0)t.bands=e;else{const l=r.findVisualBands();l&&(t.bands=[l.red.getIndex()+1,l.green.getIndex()+1,l.blue.getIndex()+1])}return t}async function hp(r){try{const{fromProjectionCode:e,fromEPSGCode:t}=await vr(async()=>{const{fromProjectionCode:n,fromEPSGCode:i}=await import("./OSM.aQ6pgj5c.js").then(s=>s.b_);return{fromProjectionCode:n,fromEPSGCode:i}},__vite__mapDeps([11,9,10,12]));return typeof e=="function"?await e(r):await t(r)}catch{return null}}async function rh(r,e=void 0){let t;if(dm()){const n=r.getMetadata("proj:code");n&&(t=await hp(n))}return t||e}function nh(r,e){const t=r.clone();return e.hasOnlyBounds()||t.setFill(up),t}function Fw(r){let e=r.href;if(e.includes("{s}"))if(Array.isArray(r["href:servers"])&&r["href:servers"].length>0){const t=Math.random()*r["href:servers"].length|0;e=e.replace("{s}",r["href:servers"][t])}else return null;return e}function ih(r){return typeof r=="string"||typeof r=="number"||typeof r=="boolean"}function Mw(r){return((r.fileDirectory.NewSubfileType||0)&4)===4}function Ow(r,e){if(!r)return!1;if(r===!0)return!0;if(e.getSamplesPerPixel()!==3)return!1;const t=e.fileDirectory.PhotometricInterpretation,n=dt;return t===n.CMYK||t===n.YCbCr||t===n.CIELab||t===n.ICCLab}const sh="STATISTICS_MAXIMUM",oh="STATISTICS_MINIMUM",ia=256;let sa;function Nw(){return sa||(sa=new np),sa}function Dw(r){try{return r.getBoundingBox(!0)}catch{return[0,0,r.getWidth(),r.getHeight()]}}function Uw(r){try{return r.getOrigin().slice(0,2)}catch{return[0,r.getHeight()]}}function Bw(r,e){try{return r.getResolution(e)}catch{return[e.getWidth()/r.getWidth(),e.getHeight()/r.getHeight()]}}async function ah(r,e,t,n){const i=r[e];if(i&&i!==32767){const s="EPSG:"+i;let o=ce(s);if(!o&&n&&(o=await hp(s)),!o){const a=Ta(r[t]);a&&(o=new Sa({code:s,units:a}))}return o||null}}async function Gw(r,e){const t=r.geoKeys;if(!t)return null;const n=await ah(t,"ProjectedCSTypeGeoKey","ProjLinearUnitsGeoKey",e);return n||await ah(t,"GeographicTypeGeoKey","GeogAngularUnitsGeoKey",e)}function zw(r){return r.getImageCount().then(function(e){const t=new Array(e);for(let n=0;n<e;++n)t[n]=r.getImage(n);return Promise.all(t)})}function kw(r,e){let t;return r.blob?t=ap(r.blob):r.overviews?t=lp(r.url,r.overviews,e):t=op(r.url,e),t.then(zw)}function mi(r,e,t,n,i){if(Array.isArray(r)){const s=r.length;if(!Array.isArray(e)||s!=e.length){const o=new Error(n);throw i(o),o}for(let o=0;o<s;++o)mi(r[o],e[o],t,n,i);return}if(e=e,Math.abs(r-e)>t*r)throw new Error(n)}function $w(r){return r instanceof Int8Array?-128:r instanceof Int16Array?-32768:r instanceof Int32Array?-2147483648:r instanceof Float32Array?12e-39:0}function jw(r){return r instanceof Int8Array?127:r instanceof Uint8Array||r instanceof Uint8ClampedArray?255:r instanceof Int16Array?32767:r instanceof Uint16Array?65535:r instanceof Int32Array?2147483647:r instanceof Uint32Array?4294967295:r instanceof Float32Array?34e37:255}let fp=class extends Ji{constructor(e){super({state:"loading",tileGrid:null,projection:e.projection||null,transition:e.transition,interpolate:e.interpolate!==!1,wrapX:e.wrapX}),this.sourceInfo_=e.sources;const t=this.sourceInfo_.length;this.sourceOptions_=e.sourceOptions,this.sourceImagery_=new Array(t),this.sourceMasks_=new Array(t),this.resolutionFactors_=new Array(t),this.samplesPerPixel_,this.nodataValues_,this.metadata_,this.normalize_=e.normalize!==!1,this.addAlpha_=!1,this.error_=null,this.convertToRGB_=e.convertToRGB||!1,this.loadMissingProjection_=e.loadMissingProjection||!1,this.setKey(this.sourceInfo_.map(s=>s.url).join(","));const n=this,i=new Array(t);for(let s=0;s<t;++s)i[s]=kw(this.sourceInfo_[s],this.sourceOptions_);Promise.all(i).then(function(s){return n.configure_(s)}).catch(function(s){ln(s),n.error_=s,n.setState("error")})}getError(){return this.error_}async determineProjection(e){const t=e[0];for(let n=t.length-1;n>=0;--n){const i=t[n],s=await Gw(i,this.loadMissingProjection_);if(s){this.projection=s;break}}}determineTransformMatrix(e){const t=e[0];for(let n=t.length-1;n>=0;--n){const s=t[n].fileDirectory.ModelTransformation;if(s){const[o,a,l,u,c,h,f,p]=s,d=an(an([1/Math.sqrt(o*o+c*c),0,0,-1/Math.sqrt(a*a+h*h),u,p],[o,c,a,h,0,0]),[1,0,0,1,-u,-p]);this.transformMatrix=d,this.addAlpha_=!0;break}}}async configure_(e){let t,n,i,s,o;const a=new Array(e.length),l=new Array(e.length),u=new Array(e.length);let c=0;const h=e.length;for(let m=0;m<h;++m){const y=[],_=[];e[m].forEach(P=>{Mw(P)?_.push(P):y.push(P)});const b=y.length;if(_.length>0&&_.length!==b)throw new Error(`Expected one mask per image found ${_.length} masks and ${b} images`);let w,x;const E=new Array(b),v=new Array(b),A=new Array(b);l[m]=new Array(b),u[m]=new Array(b);for(let P=0;P<b;++P){const S=y[P],I=S.getGDALNoData();u[m][P]=S.getGDALMetadata(0),l[m][P]=I;const N=this.sourceInfo_[m].bands;a[m]=N?N.length:S.getSamplesPerPixel();const z=b-(P+1);w||(w=Dw(S)),x||(x=Uw(S));const X=Bw(S,y[0]);A[z]=X[0];const C=[S.getTileWidth(),S.getTileHeight()];C[0]!==C[1]&&C[1]<ia&&(C[0]=ia,C[1]=ia),E[z]=C;const M=X[0]/Math.abs(X[1]);v[z]=[C[0],C[1]/M]}if(t?$t(t,w,t):t=w,!n)n=x;else{const P=`Origin mismatch for source ${m}, got [${x}] but expected [${n}]`;mi(n,x,0,P,this.viewRejector)}if(!o)o=A,this.resolutionFactors_[m]=1;else{o.length-c>A.length&&(c=o.length-A.length);const P=o[o.length-1]/A[A.length-1];this.resolutionFactors_[m]=P;const S=A.map(N=>N*=P),I=`Resolution mismatch for source ${m}, got [${S}] but expected [${o}]`;mi(o.slice(c,o.length),S,.02,I,this.viewRejector)}i?mi(i.slice(c,i.length),v,.01,`Tile size mismatch for source ${m}`,this.viewRejector):i=v,s?mi(s.slice(c,s.length),E,0,`Tile size mismatch for source ${m}`,this.viewRejector):s=E,this.sourceImagery_[m]=y.reverse(),this.sourceMasks_[m]=_.reverse()}for(let m=0,y=this.sourceImagery_.length;m<y;++m){const _=this.sourceImagery_[m];for(;_.length<o.length;)_.unshift(void 0)}this.getProjection()||await this.determineProjection(e),this.determineTransformMatrix(e),this.samplesPerPixel_=a,this.nodataValues_=l,this.metadata_=u;e:for(let m=0;m<h;++m){if(this.sourceInfo_[m].nodata!==void 0){this.addAlpha_=!0;break}if(this.sourceMasks_[m].length){this.addAlpha_=!0;break}const y=l[m],_=this.sourceInfo_[m].bands;if(_){for(let b=0;b<_.length;++b)if(y[_[b]-1]!==null){this.addAlpha_=!0;break e}continue}for(let b=0;b<y.length;++b)if(y[b]!==null){this.addAlpha_=!0;break e}}let f=this.addAlpha_?1:0;for(let m=0;m<h;++m)f+=a[m];this.bandCount=f;const p=new Kn({extent:t,minZoom:c,origin:n,resolutions:o,tileSizes:i});this.tileGrid=p,this.setTileSizes(s),this.setLoader(this.loadTile_.bind(this)),this.setState("ready");const d=1;o.length===2?o=[o[0],o[1],o[1]/2]:o.length===1&&(o=[o[0]*2,o[0],o[0]/2]);let g=t;if(this.transformMatrix){const m=Gn(Qe(),this.transformMatrix.slice()),y=uf(_=>hr(m,_));g=un(t,y)}this.viewResolver({showFullExtent:!0,projection:this.projection,resolutions:o,center:hf(Xt(g),this.projection),extent:cf(g,this.projection),zoom:d})}loadTile_(e,t,n,i){const s=this.getTileSize(e),o=this.sourceImagery_.length,a=new Array(o*2),l=this.nodataValues_,u=this.sourceInfo_,c=Nw();for(let h=0;h<o;++h){const f=u[h],p=this.resolutionFactors_[h],d=[Math.round(t*(s[0]*p)),Math.round(n*(s[1]*p)),Math.round((t+1)*(s[0]*p)),Math.round((n+1)*(s[1]*p))],g=this.sourceImagery_[h][e];let m;f.bands&&(m=f.bands.map(function(x){return x-1}));let y;"nodata"in f&&f.nodata!==null?y=f.nodata:m?y=m.map(function(x){return l[h][x]}):y=l[h];const _={window:d,width:s[0],height:s[1],samples:m,fillValue:y,pool:c,interleave:!1,signal:i.signal};Ow(this.convertToRGB_,g)?a[h]=g.readRGB(_):a[h]=g.readRasters(_);const b=o+h,w=this.sourceMasks_[h][e];if(!w){a[b]=Promise.resolve(null);continue}a[b]=w.readRasters({window:d,width:s[0],height:s[1],samples:[0],pool:c,interleave:!1})}return Promise.all(a).then(this.composeTile_.bind(this,s)).catch(function(h){throw ln(h),h})}composeTile_(e,t){const n=this.metadata_,i=this.sourceInfo_,s=this.sourceImagery_.length,o=this.bandCount,a=this.samplesPerPixel_,l=this.nodataValues_,u=this.normalize_,c=this.addAlpha_,h=e[0]*e[1],f=h*o;let p;u?p=new Uint8Array(f):p=new Float32Array(f);let d=0;for(let g=0;g<h;++g){let m=c;for(let y=0;y<s;++y){const _=i[y];let b=_.min,w=_.max,x,E;if(u){const v=n[y][0];b===void 0&&(v&&oh in v?b=parseFloat(v[oh]):b=$w(t[y][0])),w===void 0&&(v&&sh in v?w=parseFloat(v[sh]):w=jw(t[y][0])),x=255/(w-b),E=-b*x}for(let v=0;v<a[y];++v){const A=t[y][v][g];let P;if(u?P=Fe(x*A+E,0,255):P=A,!c)p[d]=P;else{let S=_.nodata;if(S===void 0){let N;_.bands?N=_.bands[v]-1:N=v,S=l[y][N]}const I=isNaN(S);(!I&&A!==S||I&&!isNaN(A))&&(m=!1,p[d]=P)}d++}if(!m){const v=s+y,A=t[v];A&&!A[0][g]&&(m=!0)}}c&&(m||(p[d]=255),d++)}return p}};fp.prototype.getView;class Me{constructor(e){this.name=e}toString(){return this.name}}Me.GeoTIFF=new Me("GeoTIFF");Me.ImageStatic=new Me("ImageStatic");Me.PMTilesRaster=new Me("PMTilesRaster");Me.PMTilesVector=new Me("PMTilesVector");Me.TileJSON=new Me("TileJSON");Me.TileWMS=new Me("TileWMS");Me.WMTS=new Me("WMTS");Me.XYZ=new Me("XYZ");class dp extends Af{constructor(e){const t={};if(["opacity","visible","zIndex","minResolution","maxResolution","minZoom","maxZoom","properties"].forEach(n=>t[n]=e[n]),super(t),this.getSourceOptions_=e.getSourceOptions,this.children_=null,this.childrenOptions_=e.childrenOptions||{},this.assets_=null,this.bands_=[],this.crossOrigin_=e.crossOrigin||null,this.displayFootprint_=e.displayFootprint!==!1,this.displayGeoTiffByDefault_=!!e.displayGeoTiffByDefault,this.displayPreview_=!!e.displayPreview,this.displayOverview_=e.displayOverview!==!1,this.displayWebMapLink_=e.displayWebMapLink||!1,this.buildTileUrlTemplate_=e.buildTileUrlTemplate||null,this.useTileLayerAsFallback_=e.useTileLayerAsFallback||!1,this.boundsStyle_=e.boundsStyle||Cw,this.collectionStyle_=e.collectionStyle||th,this.boundsLayer_=null,this.disableMigration_=e.disableMigration||!1,this.map_=null,this.eventQueue_=[],e.httpRequestFn&&(this.fetch_=e.httpRequestFn),e.data){try{this.configure_(e.data,e.url,e.children,e.assets,e.bands)}catch(n){this.handleError_(n)}return}if(!e.url)throw new Error("Either url or data must be provided");this.fetch_(e.url).then(n=>this.configure_(n,e.url,e.children,e.assets,e.bands)).catch(n=>this.handleError_(n))}async fetch_(e,t="json"){const n=await fetch(e);if(!n.ok)throw new Error(`Unexpected response from ${e}: ${n.status}`);return t==="json"?await n.json():t==="text"?await n.text():null}getBoundsLayer(){return this.boundsLayer_}isEmpty(){var e;if(this.getLayers().getLength()>1)return!1;const n=(e=this.getData())===null||e===void 0?void 0:e.getBoundingBox();return!n||ao(n)?!0:!this.boundsLayer_||!this.displayFootprint_}handleError_(e){this.dispatch_(new rE(e))}configure_(e,t=null,n=null,i=null,s=[]){let o;e instanceof os||e instanceof ci?o=e:(o=as(e,!this.disableMigration_),t&&t.includes("://")&&o.setAbsoluteUrl(t)),this.set("stac",o),this.bands_=s,this.boundsLayer_=this.addFootprint_();const a=()=>{this.boundsLayer_&&this.boundsLayer_.setStyle(nh(this.boundsStyle_,this))};this.getLayers().on("add",a),this.getLayers().on("remove",a);const l=c=>this.handleError_(c),u=[];n&&u.push(this.setChildren(n,null,!1).catch(l)),i&&u.push(this.setAssets(i,!1).catch(l)),Promise.all(u).then(()=>this.updateLayers().catch(l)),this.dispatch_("sourceready")}dispatch_(e){this.eventQueue_.push(e),this.flush_()}flush_(){if(this.map_){for(const e of this.eventQueue_)this.dispatchEvent(e);this.eventQueue_=[]}}setMap_(e){this.map_!==e&&(this.map_=e,this.flush_())}async addChildren_(e,t={}){const n=e.map(i=>{const s={data:i,crossOrigin:this.crossOrigin_,boundsStyle:this.collectionStyle_,displayGeoTiffByDefault:this.displayGeoTiffByDefault_,displayOverview:this.displayOverview_,displayPreview:this.displayPreview_,displayFootprint:this.displayFootprint_,useTileLayerAsFallback:this.useTileLayerAsFallback_,buildTileUrlTemplate:this.buildTileUrlTemplate_},o=new dp(Object.assign(s,t));return o.on("sourceready",()=>{o.map_&&this.setMap_(o.map_)}),this.addLayer_(o,null),o});return await Promise.all(n)}async addPreviewImage_(e){const t=await rh(e,"EPSG:4326"),n=e.getContext().getBoundingBoxes();if(n.length!==1)return;const i=n[0];let s={url:e.getAbsoluteUrl(),projection:t,imageExtent:tc(i,"EPSG:4326",t),crossOrigin:this.crossOrigin_};this.getSourceOptions_&&(s=await this.getSourceOptions_(Me.ImageStatic,s,e));const o=new Al({source:new ax(s)});return this.addLayer_(o,e),o}async addLayerForLink(e){const t=Fw(e);if(!t)return;const n={attributions:e.getMetadata("attribution")||this.getData().getMetadata("attribution"),crossOrigin:this.crossOrigin_,url:t},i=async(o,a)=>(this.getSourceOptions_&&(a=await this.getSourceOptions_(o,a,e)),a),s=[];switch(e.rel){case"pmtiles":const a=await new Fi(n.url).getHeader();let l;switch(a.tileType){case An.Mvt:l=new tE(await i(Me.PMTilesVector,n));break;case An.Avif:case An.Jpeg:case An.Png:case An.Webp:l=new Yc(await i(Me.PMTilesRaster,n));break;default:return}s.push(l);break;case"tilejson":s.push(new Ql(await i(Me.TileJSON,n)));break;case"wms":if(!Array.isArray(e["wms:layers"]))break;for(const h in e["wms:layers"]){const f=e["wms:layers"][h]||"";let p="";Array.isArray(e["wms:styles"])&&typeof e["wms:styles"][h]=="string"&&(p=e["wms:styles"][h]);const d=Object.assign({LAYERS:f,STYLES:p},e["wms:dimensions"]);typeof e["wms:transparent"]=="boolean"&&(d.TRANSPARENT=String(e["wms:transparent"])),typeof e.type=="string"&&e.type.startsWith("image/")&&(d.FORMAT=e.type);const g=await i(Me.TileWMS,Object.assign({},n,{params:d}));s.push(new mm(g))}break;case"wmts":const u=await this.getWmtsCapabilities_(t,e["wmts:encoding"]);if(!u)return;let c=[];Array.isArray(e["wmts:layer"])?c=e["wmts:layer"]:typeof e["wmts:layer"]=="string"&&(c=[e["wmts:layer"]]);for(const h of c){let f=Object.assign({},n,{layer:h,requestEncoding:e["wmts:encoding"]==="rest"?"REST":"KVP"});typeof e.type=="string"&&e.type.startsWith("image/")&&(f.format=e.type),f=await i(Me.WMTS,f);const p=pm(u,f);if(p!==null){if(typeof e.uriTemplate=="string"){let d=e.uriTemplate;const g=Wo(e.variables)?e.variables:{};for(const m in g){const y=g[m];let _;if(ih(y.const)?_=y.const:ih(y.default)?_=y.default:Array.isArray(y.enum)&&y.enum.length>0&&(_=y.enum[0]),typeof _<"u")d=d.replaceAll(`{${m}}`,String(_));else continue}delete p.urls,p.url=d}s.push(new gm(p))}}break;case"xyz":s.push(new Ms(await i(Me.XYZ,n)));break;default:return}return s.map(o=>{let a;return o instanceof Yn?a=new Mn({source:o,declutter:!0}):o instanceof Yc?a=new ja({source:o}):a=new Os({source:o}),this.addLayer_(a,e),a})}async addGeoTiff_(e){if(this.buildTileUrlTemplate_&&!this.useTileLayerAsFallback_)return await this.addTileLayerForImagery_(e);let n={sources:[Lw(e,this.bands_)],convertToRGB:"auto",loadMissingProjection:!0};const i=await rh(e);i&&(n.projection=i),this.getSourceOptions_&&(n=await this.getSourceOptions_(Me.GeoTIFF,n,e));const s=new fp(n),o=new Promise((a,l)=>{s.on("error",l),s.on("change",()=>{s.getState()==="error"?l(s.getError()):a()})});try{await o;const a=new ja({source:s});return this.addLayer_(a,e),a}catch(a){if(this.useTileLayerAsFallback_)return await this.addTileLayerForImagery_(e);this.handleError_(a)}}async addTileLayerForImagery_(e){let t=this.buildTileUrlTemplate_(e);t instanceof Promise&&(t=await t);let n={crossOrigin:this.crossOrigin_,url:t};this.getSourceOptions_&&(n=await this.getSourceOptions_(Me.XYZ,n,e));const i=new Os({source:new Ms(n)});return this.addLayer_(i,e),i}addLayer_(e,t=null,n=0){t&&e.set("stac",t),e.setZIndex(n),this.getLayers().push(e)}addFootprint_(){let e=null;const t=this.getData();if(t.isItemCollection()||t.isCollectionCollection()?e=Om(t.getBoundingBox()):e=t.toGeoJSON(),e){const n=this.createGeoJsonLayer_(e,nh(this.boundsStyle_,this),this.displayFootprint_);return n.set("bounds",!0),n.on("change",()=>this.setMap_(n.getMapInternal())),this.addLayer_(n,t,1),n}return null}async addGeoJson_(e){try{const t=await this.fetch_(e.getAbsoluteUrl()),n=this.createGeoJsonLayer_(t);return this.addLayer_(n,e),n}catch(t){this.handleError_(t)}}createGeoJsonLayer_(e,t=null,n=!0){const i=new Ra,s=new en({format:i,loader:(o,a,l)=>{e=Nm(e);const u=i.readFeatures(e,{featureProjection:l});s.addFeatures(u)}});return t||(t=th),new Vi({source:s,style:t,visible:n})}async addLabelExtension_(){const e=this.getData();if(!(e instanceof Ds))return;let t=e.getAssetsWithRoles(["labels","labels-vector"],!0),n;t.length>1&&(n=t.find(s=>s.roles.includes("labels-vector"))),n||(n=e.getAsset("vector_labels")),n||(t=e.getAssets().filter(s=>s.type===lc&&!s.roles),t.length===1&&(n=t[0]));const i=e.getLinksWithRels(["source"]);if(n&&i.length>0){const s=i.map(async a=>{try{const l=await this.fetch_(a.getAbsoluteUrl());return as(l)}catch(l){return this.handleError_(l),null}}),o=(await Promise.all(s)).filter(a=>a instanceof ci);await this.addChildren_(o,{displayFootprint:!1})}try{await this.addGeoJson_(n)}catch(s){this.handleError_(s)}}async updateLayers(e=!0){const t=this.getLayers();for(let s=t.getLength()-1;s>=0;s--){const o=t.item(s);o.get("stac")&&!o.get("bounds")&&t.removeAt(s)}const n=this.getData();if(Array.isArray(this.displayWebMapLink_)){const s=this.getWebMapLinks().map(async o=>await this.addLayerForLink(o));await Promise.all(s)}this.children_&&await this.addChildren_(this.children_,this.childrenOptions_);const i=this.getAssets();if(i){const s=i.map(async o=>{if(o){if(o.type===lc)return await this.addGeoJson_(o);if(o.isGeoTIFF())return await this.addGeoTiff_(o);if(o.canBrowserDisplayImage())return await this.addPreviewImage_(o)}});await Promise.all(s)}if(this.hasOnlyBounds()){if(n instanceof Ll)await this.addChildren_(n.getAll(),this.childrenOptions_);else if(n instanceof ci){if(n.isItem()&&n.supportsExtension(Iw)&&n.getMetadata("label:type")==="vector"){await this.addLabelExtension_(),e&&this.dispatch_("layersready");return}const s=this.getWebMapLinks();if(s.length>0)await this.addLayerForLink(s[0]);else{const o=n.getDefaultGeoTIFF(!0,!this.displayGeoTiffByDefault_);let a;if(o&&this.displayOverview_&&(a=await this.addGeoTiff_(o)),this.displayPreview_&&(!o||!a)){const l=n.getThumbnails(!0,"overview");l.length>0&&await this.addPreviewImage_(l[0])}}}}e&&this.dispatch_("layersready")}hasOnlyBounds(){const e=this.getBoundsLayer();return typeof this.getLayersArray().find(n=>n!==e)>"u"}getWebMapLinks(){const e=this.getData();if(e instanceof os)return[];let t=["xyz","tilejson","pmtiles","wmts","wms"];typeof this.displayWebMapLink_=="string"&&(t=[this.displayWebMapLink_]);let n=e.getLinksWithRels(t);return Array.isArray(this.displayWebMapLink_)?n=this.displayWebMapLink_.map(i=>{if(typeof i=="string"){const s=n.find(o=>o.id===i);return s||null}return i}).filter(i=>!!i):n.sort((i,s)=>{const o=t.indexOf(i.rel),a=t.indexOf(s.rel);return o-a}),n}async setAssets(e,t=!0){if(e!==this.assets_){if(Array.isArray(e)){const n=this.getData();this.assets_=e.map(i=>n instanceof ci&&typeof i=="string"?n.getAsset(i):i instanceof os?i:new os(i))}else this.assets_=null;t&&await this.updateLayers()}}async setChildren(e,t=null,n=!0){e instanceof Ff?this.children_=e.getAll():e instanceof Lf?this.children_=e.getAll():Wo(e)&&e.type==="FeatureCollection"?this.children_=as(e,!this.disableMigration_).getAll():Array.isArray(e)?this.children_=e.map(i=>i instanceof ci?i:as(i,!this.disableMigration_)):this.children_=null,this.children_&&this.children_.length===0&&(this.children_=null),this.children_&&Wo(t)&&(this.childrenOptions_=t),n&&await this.updateLayers()}getData(){return this.get("stac")}getChildren(){return this.children_}getAssets(){return this.assets_}getExtent(){if(!this.map_)return;const e=this.map_.getView();if(!e)return;let t;const n=this.getData();n&&(t=n.getBoundingBox());const i=this.getChildren();if(i){const s=i.map(o=>o.getBoundingBox());t=Cl(s)}if(t)return tc(t,"EPSG:4326",e.getProjection())}getLayerState(){const e=super.getLayerState();return e.extent=void 0,e}getAttributions(){const e=[],t=this.getData();if(t){const n=t.getMetadata("attribution");n&&n.push(n)}return e}getSource(){return null}async getWmtsCapabilities_(e,t="kvp"){try{const n=new URL(e);t!=="rest"&&(n.searchParams.set("service","wmts"),n.searchParams.set("request","GetCapabilities"));const i=await this.fetch_(n.toString(),"text");return new D0().read(i)}catch{return null}}}var Vw=8,Xw={version:{required:!0,type:"enum",values:[8]},name:{type:"string"},metadata:{type:"*"},center:{type:"array",value:"number"},centerAltitude:{type:"number"},zoom:{type:"number"},bearing:{type:"number",default:0,period:360,units:"degrees"},pitch:{type:"number",default:0,units:"degrees"},roll:{type:"number",default:0,units:"degrees"},state:{type:"state",default:{}},light:{type:"light"},sky:{type:"sky"},projection:{type:"projection"},terrain:{type:"terrain"},sources:{required:!0,type:"sources"},sprite:{type:"sprite"},glyphs:{type:"string"},transition:{type:"transition"},layers:{required:!0,type:"array",value:"layer"}},Zw={"*":{type:"source"}},Ww=["source_vector","source_raster","source_raster_dem","source_geojson","source_video","source_image"],qw={type:{required:!0,type:"enum",values:{vector:{}}},url:{type:"string"},tiles:{type:"array",value:"string"},bounds:{type:"array",value:"number",length:4,default:[-180,-85.051129,180,85.051129]},scheme:{type:"enum",values:{xyz:{},tms:{}},default:"xyz"},minzoom:{type:"number",default:0},maxzoom:{type:"number",default:22},attribution:{type:"string"},promoteId:{type:"promoteId"},volatile:{type:"boolean",default:!1},"*":{type:"*"}},Hw={type:{required:!0,type:"enum",values:{raster:{}}},url:{type:"string"},tiles:{type:"array",value:"string"},bounds:{type:"array",value:"number",length:4,default:[-180,-85.051129,180,85.051129]},minzoom:{type:"number",default:0},maxzoom:{type:"number",default:22},tileSize:{type:"number",default:512,units:"pixels"},scheme:{type:"enum",values:{xyz:{},tms:{}},default:"xyz"},attribution:{type:"string"},volatile:{type:"boolean",default:!1},"*":{type:"*"}},Yw={type:{required:!0,type:"enum",values:{"raster-dem":{}}},url:{type:"string"},tiles:{type:"array",value:"string"},bounds:{type:"array",value:"number",length:4,default:[-180,-85.051129,180,85.051129]},minzoom:{type:"number",default:0},maxzoom:{type:"number",default:22},tileSize:{type:"number",default:512,units:"pixels"},attribution:{type:"string"},encoding:{type:"enum",values:{terrarium:{},mapbox:{},custom:{}},default:"mapbox"},redFactor:{type:"number",default:1},blueFactor:{type:"number",default:1},greenFactor:{type:"number",default:1},baseShift:{type:"number",default:0},volatile:{type:"boolean",default:!1},"*":{type:"*"}},Kw={type:{required:!0,type:"enum",values:{geojson:{}}},data:{required:!0,type:"*"},maxzoom:{type:"number",default:18},attribution:{type:"string"},buffer:{type:"number",default:128,maximum:512,minimum:0},filter:{type:"*"},tolerance:{type:"number",default:.375},cluster:{type:"boolean",default:!1},clusterRadius:{type:"number",default:50,minimum:0},clusterMaxZoom:{type:"number"},clusterMinPoints:{type:"number"},clusterProperties:{type:"*"},lineMetrics:{type:"boolean",default:!1},generateId:{type:"boolean",default:!1},promoteId:{type:"promoteId"}},Jw={type:{required:!0,type:"enum",values:{video:{}}},urls:{required:!0,type:"array",value:"string"},coordinates:{required:!0,type:"array",length:4,value:{type:"array",length:2,value:"number"}}},Qw={type:{required:!0,type:"enum",values:{image:{}}},url:{required:!0,type:"string"},coordinates:{required:!0,type:"array",length:4,value:{type:"array",length:2,value:"number"}}},ev={id:{type:"string",required:!0},type:{type:"enum",values:{fill:{},line:{},symbol:{},circle:{},heatmap:{},"fill-extrusion":{},raster:{},hillshade:{},"color-relief":{},background:{}},required:!0},metadata:{type:"*"},source:{type:"string"},"source-layer":{type:"string"},minzoom:{type:"number",minimum:0,maximum:24},maxzoom:{type:"number",minimum:0,maximum:24},filter:{type:"filter"},layout:{type:"layout"},paint:{type:"paint"}},tv=["layout_fill","layout_line","layout_circle","layout_heatmap","layout_fill-extrusion","layout_symbol","layout_raster","layout_hillshade","layout_color-relief","layout_background"],rv={visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},nv={"fill-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},iv={"circle-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},sv={visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},ov={"line-cap":{type:"enum",values:{butt:{},round:{},square:{}},default:"butt",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"line-join":{type:"enum",values:{bevel:{},round:{},miter:{}},default:"miter",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"line-miter-limit":{type:"number",default:2,requires:[{"line-join":"miter"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"line-round-limit":{type:"number",default:1.05,requires:[{"line-join":"round"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"line-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},av={"symbol-placement":{type:"enum",values:{point:{},line:{},"line-center":{}},default:"point",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"symbol-spacing":{type:"number",default:250,minimum:1,units:"pixels",requires:[{"symbol-placement":"line"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"symbol-avoid-edges":{type:"boolean",default:!1,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"symbol-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"symbol-z-order":{type:"enum",values:{auto:{},"viewport-y":{},source:{}},default:"auto",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-allow-overlap":{type:"boolean",default:!1,requires:["icon-image",{"!":"icon-overlap"}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-overlap":{type:"enum",values:{never:{},always:{},cooperative:{}},requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-ignore-placement":{type:"boolean",default:!1,requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-optional":{type:"boolean",default:!1,requires:["icon-image","text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-rotation-alignment":{type:"enum",values:{map:{},viewport:{},auto:{}},default:"auto",requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-size":{type:"number",default:1,minimum:0,units:"factor of the original icon size",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit":{type:"enum",values:{none:{},width:{},height:{},both:{}},default:"none",requires:["icon-image","text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-text-fit-padding":{type:"array",value:"number",length:4,default:[0,0,0,0],units:"pixels",requires:["icon-image","text-field",{"icon-text-fit":["both","width","height"]}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"icon-image":{type:"resolvedImage",tokens:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-rotate":{type:"number",default:0,period:360,units:"degrees",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-padding":{type:"padding",default:[2],units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-keep-upright":{type:"boolean",default:!1,requires:["icon-image",{"icon-rotation-alignment":"map"},{"symbol-placement":["line","line-center"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-offset":{type:"array",value:"number",length:2,default:[0,0],requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-anchor":{type:"enum",values:{center:{},left:{},right:{},top:{},bottom:{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},default:"center",requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-pitch-alignment":{type:"enum",values:{map:{},viewport:{},auto:{}},default:"auto",requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-pitch-alignment":{type:"enum",values:{map:{},viewport:{},auto:{}},default:"auto",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-rotation-alignment":{type:"enum",values:{map:{},viewport:{},"viewport-glyph":{},auto:{}},default:"auto",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-field":{type:"formatted",default:"",tokens:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-font":{type:"array",value:"string",default:["Open Sans Regular","Arial Unicode MS Regular"],requires:["text-field"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-size":{type:"number",default:16,minimum:0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-max-width":{type:"number",default:10,minimum:0,units:"ems",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-line-height":{type:"number",default:1.2,units:"ems",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-letter-spacing":{type:"number",default:0,units:"ems",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-justify":{type:"enum",values:{auto:{},left:{},center:{},right:{}},default:"center",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-radial-offset":{type:"number",units:"ems",default:0,requires:["text-field"],"property-type":"data-driven",expression:{interpolated:!0,parameters:["zoom","feature"]}},"text-variable-anchor":{type:"array",value:"enum",values:{center:{},left:{},right:{},top:{},bottom:{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},requires:["text-field",{"symbol-placement":["point"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-variable-anchor-offset":{type:"variableAnchorOffsetCollection",requires:["text-field",{"symbol-placement":["point"]}],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-anchor":{type:"enum",values:{center:{},left:{},right:{},top:{},bottom:{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},default:"center",requires:["text-field",{"!":"text-variable-anchor"}],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-max-angle":{type:"number",default:45,units:"degrees",requires:["text-field",{"symbol-placement":["line","line-center"]}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-writing-mode":{type:"array",value:"enum",values:{horizontal:{},vertical:{}},requires:["text-field",{"symbol-placement":["point"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-rotate":{type:"number",default:0,period:360,units:"degrees",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-padding":{type:"number",default:2,minimum:0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-keep-upright":{type:"boolean",default:!0,requires:["text-field",{"text-rotation-alignment":"map"},{"symbol-placement":["line","line-center"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-transform":{type:"enum",values:{none:{},uppercase:{},lowercase:{}},default:"none",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-offset":{type:"array",value:"number",units:"ems",length:2,default:[0,0],requires:["text-field",{"!":"text-radial-offset"}],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-allow-overlap":{type:"boolean",default:!1,requires:["text-field",{"!":"text-overlap"}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-overlap":{type:"enum",values:{never:{},always:{},cooperative:{}},requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-ignore-placement":{type:"boolean",default:!1,requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-optional":{type:"boolean",default:!1,requires:["text-field","icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},lv={visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},uv={visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},cv={type:"array",value:"*"},hv={type:"enum",values:{"==":{},"!=":{},">":{},">=":{},"<":{},"<=":{},in:{},"!in":{},all:{},any:{},none:{},has:{},"!has":{}}},fv={type:"enum",values:{Point:{},LineString:{},Polygon:{}}},dv={type:"array",minimum:0,maximum:24,value:["number","color"],length:2},pv={type:"array",value:"*",minimum:1},gv={anchor:{type:"enum",default:"viewport",values:{map:{},viewport:{}},"property-type":"data-constant",transition:!1,expression:{interpolated:!1,parameters:["zoom"]}},position:{type:"array",default:[1.15,210,30],length:3,value:"number","property-type":"data-constant",transition:!0,expression:{interpolated:!0,parameters:["zoom"]}},color:{type:"color","property-type":"data-constant",default:"#ffffff",expression:{interpolated:!0,parameters:["zoom"]},transition:!0},intensity:{type:"number","property-type":"data-constant",default:.5,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0}},mv={"sky-color":{type:"color","property-type":"data-constant",default:"#88C6FC",expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"horizon-color":{type:"color","property-type":"data-constant",default:"#ffffff",expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"fog-color":{type:"color","property-type":"data-constant",default:"#ffffff",expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"fog-ground-blend":{type:"number","property-type":"data-constant",default:.5,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"horizon-fog-blend":{type:"number","property-type":"data-constant",default:.8,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"sky-horizon-blend":{type:"number","property-type":"data-constant",default:.8,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"atmosphere-blend":{type:"number","property-type":"data-constant",default:.8,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0}},yv={source:{type:"string",required:!0},exaggeration:{type:"number",minimum:0,default:1}},_v={type:{type:"projectionDefinition",default:"mercator","property-type":"data-constant",transition:!1,expression:{interpolated:!0,parameters:["zoom"]}}},bv=["paint_fill","paint_line","paint_circle","paint_heatmap","paint_fill-extrusion","paint_symbol","paint_raster","paint_hillshade","paint_color-relief","paint_background"],xv={"fill-antialias":{type:"boolean",default:!0,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"fill-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"fill-pattern"}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-outline-color":{type:"color",transition:!0,requires:[{"!":"fill-pattern"},{"fill-antialias":!0}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"fill-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["fill-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"fill-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"cross-faded-data-driven"}},Ev={"line-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"line-pattern"}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"line-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["line-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"line-width":{type:"number",default:1,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-gap-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-offset":{type:"number",default:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-blur":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-dasharray":{type:"array",value:"number",minimum:0,transition:!0,units:"line widths",requires:[{"!":"line-pattern"}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"cross-faded"},"line-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"cross-faded-data-driven"},"line-gradient":{type:"color",transition:!1,requires:[{"!":"line-dasharray"},{"!":"line-pattern"},{source:"geojson",has:{lineMetrics:!0}}],expression:{interpolated:!0,parameters:["line-progress"]},"property-type":"color-ramp"}},wv={"circle-radius":{type:"number",default:5,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-color":{type:"color",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-blur":{type:"number",default:0,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"circle-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["circle-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"circle-pitch-scale":{type:"enum",values:{map:{},viewport:{}},default:"map",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"circle-pitch-alignment":{type:"enum",values:{map:{},viewport:{}},default:"viewport",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"circle-stroke-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-stroke-color":{type:"color",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-stroke-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"}},vv={"heatmap-radius":{type:"number",default:30,minimum:1,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"heatmap-weight":{type:"number",default:1,minimum:0,transition:!1,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"heatmap-intensity":{type:"number",default:1,minimum:0,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"heatmap-color":{type:"color",default:["interpolate",["linear"],["heatmap-density"],0,"rgba(0, 0, 255, 0)",.1,"royalblue",.3,"cyan",.5,"lime",.7,"yellow",1,"red"],transition:!1,expression:{interpolated:!0,parameters:["heatmap-density"]},"property-type":"color-ramp"},"heatmap-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},Tv={"icon-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-color":{type:"color",default:"#000000",transition:!0,requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-color":{type:"color",default:"rgba(0, 0, 0, 0)",transition:!0,requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-blur":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"icon-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["icon-image","icon-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-color":{type:"color",default:"#000000",transition:!0,overridable:!0,requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-color":{type:"color",default:"rgba(0, 0, 0, 0)",transition:!0,requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-blur":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["text-field","text-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"}},Sv={"raster-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-hue-rotate":{type:"number",default:0,period:360,transition:!0,units:"degrees",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-brightness-min":{type:"number",default:0,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-brightness-max":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-saturation":{type:"number",default:0,minimum:-1,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-contrast":{type:"number",default:0,minimum:-1,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-resampling":{type:"enum",values:{linear:{},nearest:{}},default:"linear",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"raster-fade-duration":{type:"number",default:300,minimum:0,transition:!1,units:"milliseconds",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},Rv={"hillshade-illumination-direction":{type:"numberArray",default:335,minimum:0,maximum:359,transition:!1,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-illumination-altitude":{type:"numberArray",default:45,minimum:0,maximum:90,transition:!1,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-illumination-anchor":{type:"enum",values:{map:{},viewport:{}},default:"viewport",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-exaggeration":{type:"number",default:.5,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-shadow-color":{type:"colorArray",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-highlight-color":{type:"colorArray",default:"#FFFFFF",transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-accent-color":{type:"color",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-method":{type:"enum",values:{standard:{},basic:{},combined:{},igor:{},multidirectional:{}},default:"standard",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"}},Pv={"background-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"background-pattern"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"background-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"cross-faded"},"background-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},Av={duration:{type:"number",default:300,minimum:0,units:"milliseconds"},delay:{type:"number",default:0,minimum:0,units:"milliseconds"}},Iv={"*":{type:"string"}},Cv={$version:Vw,$root:Xw,sources:Zw,source:Ww,source_vector:qw,source_raster:Hw,source_raster_dem:Yw,source_geojson:Kw,source_video:Jw,source_image:Qw,layer:ev,layout:tv,layout_background:rv,layout_fill:nv,layout_circle:iv,layout_heatmap:sv,"layout_fill-extrusion":{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_line:ov,layout_symbol:av,layout_raster:lv,layout_hillshade:uv,"layout_color-relief":{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},filter:cv,filter_operator:hv,geometry_type:fv,function:{expression:{type:"expression"},stops:{type:"array",value:"function_stop"},base:{type:"number",default:1,minimum:0},property:{type:"string",default:"$zoom"},type:{type:"enum",values:{identity:{},exponential:{},interval:{},categorical:{}},default:"exponential"},colorSpace:{type:"enum",values:{rgb:{},lab:{},hcl:{}},default:"rgb"},default:{type:"*",required:!1}},function_stop:dv,expression:pv,light:gv,sky:mv,terrain:yv,projection:_v,paint:bv,paint_fill:xv,"paint_fill-extrusion":{"fill-extrusion-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"fill-extrusion-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"fill-extrusion-pattern"}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"fill-extrusion-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["fill-extrusion-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"fill-extrusion-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"cross-faded-data-driven"},"fill-extrusion-height":{type:"number",default:0,minimum:0,units:"meters",transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-base":{type:"number",default:0,minimum:0,units:"meters",transition:!0,requires:["fill-extrusion-height"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-vertical-gradient":{type:"boolean",default:!0,transition:!1,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"}},paint_line:Ev,paint_circle:wv,paint_heatmap:vv,paint_symbol:Tv,paint_raster:Sv,paint_hillshade:Rv,"paint_color-relief":{"color-relief-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"color-relief-color":{type:"color",transition:!1,expression:{interpolated:!0,parameters:["elevation"]},"property-type":"color-ramp"}},paint_background:Pv,transition:Av,"property-type":{"data-driven":{type:"property-type"},"cross-faded":{type:"property-type"},"cross-faded-data-driven":{type:"property-type"},"color-ramp":{type:"property-type"},"data-constant":{type:"property-type"},constant:{type:"property-type"}},promoteId:Iv};const Lv=["type","source","source-layer","minzoom","maxzoom","filter","layout"];function Fv(r,e){const t={};for(const n in r)n!=="ref"&&(t[n]=r[n]);return Lv.forEach(n=>{n in e&&(t[n]=e[n])}),t}function pp(r){r=r.slice();const e=Object.create(null);for(let t=0;t<r.length;t++)e[r[t].id]=r[t];for(let t=0;t<r.length;t++)"ref"in r[t]&&(r[t]=Fv(r[t],e[r[t].ref]));return r}class ir extends Error{constructor(e,t){super(t),this.message=t,this.key=e}}class Eu{constructor(e,t=[]){this.parent=e,this.bindings={};for(const[n,i]of t)this.bindings[n]=i}concat(e){return new Eu(this,e)}get(e){if(this.bindings[e])return this.bindings[e];if(this.parent)return this.parent.get(e);throw new Error(`${e} not found in scope.`)}has(e){return this.bindings[e]?!0:this.parent?this.parent.has(e):!1}}const wo={kind:"null"},B={kind:"number"},oe={kind:"string"},ne={kind:"boolean"},or={kind:"color"},vo={kind:"projectionDefinition"},tn={kind:"object"},Q={kind:"value"},Mv={kind:"error"},To={kind:"collator"},So={kind:"formatted"},Ro={kind:"padding"},Oi={kind:"colorArray"},Po={kind:"numberArray"},ts={kind:"resolvedImage"},Ao={kind:"variableAnchorOffsetCollection"};function Tt(r,e){return{kind:"array",itemType:r,N:e}}function Ue(r){if(r.kind==="array"){const e=Ue(r.itemType);return typeof r.N=="number"?`array<${e}, ${r.N}>`:r.itemType.kind==="value"?"array":`array<${e}>`}else return r.kind}const Ov=[wo,B,oe,ne,or,vo,So,tn,Tt(Q),Ro,Po,Oi,ts,Ao];function Ni(r,e){if(e.kind==="error")return null;if(r.kind==="array"){if(e.kind==="array"&&(e.N===0&&e.itemType.kind==="value"||!Ni(r.itemType,e.itemType))&&(typeof r.N!="number"||r.N===e.N))return null}else{if(r.kind===e.kind)return null;if(r.kind==="value"){for(const t of Ov)if(!Ni(t,e))return null}}return`Expected ${Ue(r)} but found ${Ue(e)} instead.`}function wu(r,e){return e.some(t=>t.kind===r.kind)}function rn(r,e){return e.some(t=>t==="null"?r===null:t==="array"?Array.isArray(r):t==="object"?r&&!Array.isArray(r)&&typeof r=="object":t===typeof r)}function Ar(r,e){return r.kind==="array"&&e.kind==="array"?r.itemType.kind===e.itemType.kind&&typeof r.N=="number":r.kind===e.kind}const gp=.96422,mp=1,yp=.82521,_p=4/29,Dn=6/29,bp=3*Dn*Dn,Nv=Dn*Dn*Dn,Dv=Math.PI/180,Uv=180/Math.PI;function xp(r){return r=r%360,r<0&&(r+=360),r}function Ep([r,e,t,n]){r=oa(r),e=oa(e),t=oa(t);let i,s;const o=aa((.2225045*r+.7168786*e+.0606169*t)/mp);r===e&&e===t?i=s=o:(i=aa((.4360747*r+.3850649*e+.1430804*t)/gp),s=aa((.0139322*r+.0971045*e+.7141733*t)/yp));const a=116*o-16;return[a<0?0:a,500*(i-o),200*(o-s),n]}function oa(r){return r<=.04045?r/12.92:Math.pow((r+.055)/1.055,2.4)}function aa(r){return r>Nv?Math.pow(r,1/3):r/bp+_p}function wp([r,e,t,n]){let i=(r+16)/116,s=isNaN(e)?i:i+e/500,o=isNaN(t)?i:i-t/200;return i=mp*ua(i),s=gp*ua(s),o=yp*ua(o),[la(3.1338561*s-1.6168667*i-.4906146*o),la(-.9787684*s+1.9161415*i+.033454*o),la(.0719453*s-.2289914*i+1.4052427*o),n]}function la(r){return r=r<=.00304?12.92*r:1.055*Math.pow(r,1/2.4)-.055,r<0?0:r>1?1:r}function ua(r){return r>Dn?r*r*r:bp*(r-_p)}function Bv(r){const[e,t,n,i]=Ep(r),s=Math.sqrt(t*t+n*n);return[Math.round(s*1e4)?xp(Math.atan2(n,t)*Uv):NaN,s,e,i]}function Gv([r,e,t,n]){return r=isNaN(r)?0:r*Dv,wp([t,Math.cos(r)*e,Math.sin(r)*e,n])}function zv([r,e,t,n]){r=xp(r),e/=100,t/=100;function i(s){const o=(s+r/30)%12,a=e*Math.min(t,1-t);return t-a*Math.max(-1,Math.min(o-3,9-o,1))}return[i(0),i(8),i(4),n]}const kv=Object.hasOwn||function(e,t){return Object.prototype.hasOwnProperty.call(e,t)};function vp(r,e){return kv(r,e)?r[e]:void 0}function $v(r){if(r=r.toLowerCase().trim(),r==="transparent")return[0,0,0,0];const e=vp(jv,r);if(e){const[i,s,o]=e;return[i/255,s/255,o/255,1]}if(r.startsWith("#")&&/^#(?:[0-9a-f]{3,4}|[0-9a-f]{6}|[0-9a-f]{8})$/.test(r)){const s=r.length<6?1:2;let o=1;return[ds(r.slice(o,o+=s)),ds(r.slice(o,o+=s)),ds(r.slice(o,o+=s)),ds(r.slice(o,o+s)||"ff")]}if(r.startsWith("rgb")){const i=/^rgba?\(\s*([\de.+-]+)(%)?(?:\s+|\s*(,)\s*)([\de.+-]+)(%)?(?:\s+|\s*(,)\s*)([\de.+-]+)(%)?(?:\s*([,\/])\s*([\de.+-]+)(%)?)?\s*\)$/,s=r.match(i);if(s){const[o,a,l,u,c,h,f,p,d,g,m,y]=s,_=[u||" ",f||" ",g].join("");if(_==="  "||_==="  /"||_===",,"||_===",,,"){const b=[l,h,d].join(""),w=b==="%%%"?100:b===""?255:0;if(w){const x=[In(+a/w,0,1),In(+c/w,0,1),In(+p/w,0,1),m?lh(+m,y):1];if(uh(x))return x}}return}}const t=/^hsla?\(\s*([\de.+-]+)(?:deg)?(?:\s+|\s*(,)\s*)([\de.+-]+)%(?:\s+|\s*(,)\s*)([\de.+-]+)%(?:\s*([,\/])\s*([\de.+-]+)(%)?)?\s*\)$/,n=r.match(t);if(n){const[i,s,o,a,l,u,c,h,f]=n,p=[o||" ",l||" ",c].join("");if(p==="  "||p==="  /"||p===",,"||p===",,,"){const d=[+s,In(+a,0,100),In(+u,0,100),h?lh(+h,f):1];if(uh(d))return zv(d)}}}function ds(r){return parseInt(r.padEnd(2,r),16)/255}function lh(r,e){return In(e?r/100:r,0,1)}function In(r,e,t){return Math.min(Math.max(e,r),t)}function uh(r){return!r.some(Number.isNaN)}const jv={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]};function nn(r,e,t){return r+t*(e-r)}function Di(r,e,t){return r.map((n,i)=>nn(n,e[i],t))}class ve{constructor(e,t,n,i=1,s=!0){this.r=e,this.g=t,this.b=n,this.a=i,s||(this.r*=i,this.g*=i,this.b*=i,i||this.overwriteGetter("rgb",[e,t,n,i]))}static parse(e){if(e instanceof ve)return e;if(typeof e!="string")return;const t=$v(e);if(t)return new ve(...t,!1)}get rgb(){const{r:e,g:t,b:n,a:i}=this,s=i||1/0;return this.overwriteGetter("rgb",[e/s,t/s,n/s,i])}get hcl(){return this.overwriteGetter("hcl",Bv(this.rgb))}get lab(){return this.overwriteGetter("lab",Ep(this.rgb))}overwriteGetter(e,t){return Object.defineProperty(this,e,{value:t}),t}toString(){const[e,t,n,i]=this.rgb;return`rgba(${[e,t,n].map(s=>Math.round(s*255)).join(",")},${i})`}static interpolate(e,t,n,i="rgb"){switch(i){case"rgb":{const[s,o,a,l]=Di(e.rgb,t.rgb,n);return new ve(s,o,a,l,!1)}case"hcl":{const[s,o,a,l]=e.hcl,[u,c,h,f]=t.hcl;let p,d;if(!isNaN(s)&&!isNaN(u)){let b=u-s;u>s&&b>180?b-=360:u<s&&s-u>180&&(b+=360),p=s+n*b}else isNaN(s)?isNaN(u)?p=NaN:(p=u,(a===1||a===0)&&(d=c)):(p=s,(h===1||h===0)&&(d=o));const[g,m,y,_]=Gv([p,d??nn(o,c,n),nn(a,h,n),nn(l,f,n)]);return new ve(g,m,y,_,!1)}case"lab":{const[s,o,a,l]=wp(Di(e.lab,t.lab,n));return new ve(s,o,a,l,!1)}}}}ve.black=new ve(0,0,0,1);ve.white=new ve(1,1,1,1);ve.transparent=new ve(0,0,0,0);ve.red=new ve(1,0,0,1);class vu{constructor(e,t,n){e?this.sensitivity=t?"variant":"case":this.sensitivity=t?"accent":"base",this.locale=n,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(e,t){return this.collator.compare(e,t)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}}const Vv=["bottom","center","top"];class Ka{constructor(e,t,n,i,s,o){this.text=e,this.image=t,this.scale=n,this.fontStack=i,this.textColor=s,this.verticalAlign=o}}class br{constructor(e){this.sections=e}static fromString(e){return new br([new Ka(e,null,null,null,null,null)])}isEmpty(){return this.sections.length===0?!0:!this.sections.some(e=>e.text.length!==0||e.image&&e.image.name.length!==0)}static factory(e){return e instanceof br?e:br.fromString(e)}toString(){return this.sections.length===0?"":this.sections.map(e=>e.text).join("")}}class jt{constructor(e){this.values=e.slice()}static parse(e){if(e instanceof jt)return e;if(typeof e=="number")return new jt([e,e,e,e]);if(Array.isArray(e)&&!(e.length<1||e.length>4)){for(const t of e)if(typeof t!="number")return;switch(e.length){case 1:e=[e[0],e[0],e[0],e[0]];break;case 2:e=[e[0],e[1],e[0],e[1]];break;case 3:e=[e[0],e[1],e[2],e[1]];break}return new jt(e)}}toString(){return JSON.stringify(this.values)}static interpolate(e,t,n){return new jt(Di(e.values,t.values,n))}}class Vt{constructor(e){this.values=e.slice()}static parse(e){if(e instanceof Vt)return e;if(typeof e=="number")return new Vt([e]);if(Array.isArray(e)){for(const t of e)if(typeof t!="number")return;return new Vt(e)}}toString(){return JSON.stringify(this.values)}static interpolate(e,t,n){return new Vt(Di(e.values,t.values,n))}}class St{constructor(e){this.values=e.slice()}static parse(e){if(e instanceof St)return e;if(typeof e=="string"){const n=ve.parse(e);return n?new St([n]):void 0}if(!Array.isArray(e))return;const t=[];for(const n of e){if(typeof n!="string")return;const i=ve.parse(n);if(!i)return;t.push(i)}return new St(t)}toString(){return JSON.stringify(this.values)}static interpolate(e,t,n,i="rgb"){const s=[];if(e.values.length!=t.values.length)throw new Error(`colorArray: Arrays have mismatched length (${e.values.length} vs. ${t.values.length}), cannot interpolate.`);for(let o=0;o<e.values.length;o++)s.push(ve.interpolate(e.values[o],t.values[o],n,i));return new St(s)}}class ke extends Error{constructor(e){super(e),this.name="RuntimeError"}toJSON(){return this.message}}const Xv=new Set(["center","left","right","top","bottom","top-left","top-right","bottom-left","bottom-right"]);class ar{constructor(e){this.values=e.slice()}static parse(e){if(e instanceof ar)return e;if(!(!Array.isArray(e)||e.length<1||e.length%2!==0)){for(let t=0;t<e.length;t+=2){const n=e[t],i=e[t+1];if(typeof n!="string"||!Xv.has(n)||!Array.isArray(i)||i.length!==2||typeof i[0]!="number"||typeof i[1]!="number")return}return new ar(e)}}toString(){return JSON.stringify(this.values)}static interpolate(e,t,n){const i=e.values,s=t.values;if(i.length!==s.length)throw new ke(`Cannot interpolate values of different length. from: ${e.toString()}, to: ${t.toString()}`);const o=[];for(let a=0;a<i.length;a+=2){if(i[a]!==s[a])throw new ke(`Cannot interpolate values containing mismatched anchors. from[${a}]: ${i[a]}, to[${a}]: ${s[a]}`);o.push(i[a]);const[l,u]=i[a+1],[c,h]=s[a+1];o.push([nn(l,c,n),nn(u,h,n)])}return new ar(o)}}class Xr{constructor(e){this.name=e.name,this.available=e.available}toString(){return this.name}static fromString(e){return e?new Xr({name:e,available:!1}):null}}class Gt{constructor(e,t,n){this.from=e,this.to=t,this.transition=n}static interpolate(e,t,n){return new Gt(e,t,n)}static parse(e){if(e instanceof Gt)return e;if(Array.isArray(e)&&e.length===3&&typeof e[0]=="string"&&typeof e[1]=="string"&&typeof e[2]=="number")return new Gt(e[0],e[1],e[2]);if(typeof e=="object"&&typeof e.from=="string"&&typeof e.to=="string"&&typeof e.transition=="number")return new Gt(e.from,e.to,e.transition);if(typeof e=="string")return new Gt(e,e,1)}}function Tp(r,e,t,n){return typeof r=="number"&&r>=0&&r<=255&&typeof e=="number"&&e>=0&&e<=255&&typeof t=="number"&&t>=0&&t<=255?typeof n>"u"||typeof n=="number"&&n>=0&&n<=1?null:`Invalid rgba value [${[r,e,t,n].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid rgba value [${(typeof n=="number"?[r,e,t,n]:[r,e,t]).join(", ")}]: 'r', 'g', and 'b' must be between 0 and 255.`}function Ui(r){if(r===null||typeof r=="string"||typeof r=="boolean"||typeof r=="number"||r instanceof Gt||r instanceof ve||r instanceof vu||r instanceof br||r instanceof jt||r instanceof Vt||r instanceof St||r instanceof ar||r instanceof Xr)return!0;if(Array.isArray(r)){for(const e of r)if(!Ui(e))return!1;return!0}else if(typeof r=="object"){for(const e in r)if(!Ui(r[e]))return!1;return!0}else return!1}function Ze(r){if(r===null)return wo;if(typeof r=="string")return oe;if(typeof r=="boolean")return ne;if(typeof r=="number")return B;if(r instanceof ve)return or;if(r instanceof Gt)return vo;if(r instanceof vu)return To;if(r instanceof br)return So;if(r instanceof jt)return Ro;if(r instanceof Vt)return Po;if(r instanceof St)return Oi;if(r instanceof ar)return Ao;if(r instanceof Xr)return ts;if(Array.isArray(r)){const e=r.length;let t;for(const n of r){const i=Ze(n);if(!t)t=i;else{if(t===i)continue;t=Q;break}}return Tt(t||Q,e)}else return tn}function Ti(r){const e=typeof r;return r===null?"":e==="string"||e==="number"||e==="boolean"?String(r):r instanceof ve||r instanceof Gt||r instanceof br||r instanceof jt||r instanceof Vt||r instanceof St||r instanceof ar||r instanceof Xr?r.toString():JSON.stringify(r)}class Vn{constructor(e,t){this.type=e,this.value=t}static parse(e,t){if(e.length!==2)return t.error(`'literal' expression requires exactly one argument, but found ${e.length-1} instead.`);if(!Ui(e[1]))return t.error("invalid value");const n=e[1];let i=Ze(n);const s=t.expectedType;return i.kind==="array"&&i.N===0&&s&&s.kind==="array"&&(typeof s.N!="number"||s.N===0)&&(i=s),new Vn(i,n)}evaluate(){return this.value}eachChild(){}outputDefined(){return!0}}const ps={string:oe,number:B,boolean:ne,object:tn};class zt{constructor(e,t){this.type=e,this.args=t}static parse(e,t){if(e.length<2)return t.error("Expected at least one argument.");let n=1,i;const s=e[0];if(s==="array"){let a;if(e.length>2){const u=e[1];if(typeof u!="string"||!(u in ps)||u==="object")return t.error('The item type argument of "array" must be one of string, number, boolean',1);a=ps[u],n++}else a=Q;let l;if(e.length>3){if(e[2]!==null&&(typeof e[2]!="number"||e[2]<0||e[2]!==Math.floor(e[2])))return t.error('The length argument to "array" must be a positive integer literal',2);l=e[2],n++}i=Tt(a,l)}else{if(!ps[s])throw new Error(`Types doesn't contain name = ${s}`);i=ps[s]}const o=[];for(;n<e.length;n++){const a=t.parse(e[n],n,Q);if(!a)return null;o.push(a)}return new zt(i,o)}evaluate(e){for(let t=0;t<this.args.length;t++){const n=this.args[t].evaluate(e);if(Ni(this.type,Ze(n))){if(t===this.args.length-1)throw new ke(`Expected value to be of type ${Ue(this.type)}, but found ${Ue(Ze(n))} instead.`)}else return n}throw new Error}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every(e=>e.outputDefined())}}const ch={"to-boolean":ne,"to-color":or,"to-number":B,"to-string":oe};class Dr{constructor(e,t){this.type=e,this.args=t}static parse(e,t){if(e.length<2)return t.error("Expected at least one argument.");const n=e[0];if(!ch[n])throw new Error(`Can't parse ${n} as it is not part of the known types`);if((n==="to-boolean"||n==="to-string")&&e.length!==2)return t.error("Expected one argument.");const i=ch[n],s=[];for(let o=1;o<e.length;o++){const a=t.parse(e[o],o,Q);if(!a)return null;s.push(a)}return new Dr(i,s)}evaluate(e){switch(this.type.kind){case"boolean":return!!this.args[0].evaluate(e);case"color":{let t,n;for(const i of this.args){if(t=i.evaluate(e),n=null,t instanceof ve)return t;if(typeof t=="string"){const s=e.parseColor(t);if(s)return s}else if(Array.isArray(t)&&(t.length<3||t.length>4?n=`Invalid rgba value ${JSON.stringify(t)}: expected an array containing either three or four numeric values.`:n=Tp(t[0],t[1],t[2],t[3]),!n))return new ve(t[0]/255,t[1]/255,t[2]/255,t[3])}throw new ke(n||`Could not parse color from value '${typeof t=="string"?t:JSON.stringify(t)}'`)}case"padding":{let t;for(const n of this.args){t=n.evaluate(e);const i=jt.parse(t);if(i)return i}throw new ke(`Could not parse padding from value '${typeof t=="string"?t:JSON.stringify(t)}'`)}case"numberArray":{let t;for(const n of this.args){t=n.evaluate(e);const i=Vt.parse(t);if(i)return i}throw new ke(`Could not parse numberArray from value '${typeof t=="string"?t:JSON.stringify(t)}'`)}case"colorArray":{let t;for(const n of this.args){t=n.evaluate(e);const i=St.parse(t);if(i)return i}throw new ke(`Could not parse colorArray from value '${typeof t=="string"?t:JSON.stringify(t)}'`)}case"variableAnchorOffsetCollection":{let t;for(const n of this.args){t=n.evaluate(e);const i=ar.parse(t);if(i)return i}throw new ke(`Could not parse variableAnchorOffsetCollection from value '${typeof t=="string"?t:JSON.stringify(t)}'`)}case"number":{let t=null;for(const n of this.args){if(t=n.evaluate(e),t===null)return 0;const i=Number(t);if(!isNaN(i))return i}throw new ke(`Could not convert ${JSON.stringify(t)} to number.`)}case"formatted":return br.fromString(Ti(this.args[0].evaluate(e)));case"resolvedImage":return Xr.fromString(Ti(this.args[0].evaluate(e)));case"projectionDefinition":return this.args[0].evaluate(e);default:return Ti(this.args[0].evaluate(e))}}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every(e=>e.outputDefined())}}const Zv=["Unknown","Point","LineString","Polygon"];class Sp{constructor(){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this._parseColorCache=new Map,this.availableImages=null,this.canonical=null}id(){return this.feature&&"id"in this.feature?this.feature.id:null}geometryType(){return this.feature?typeof this.feature.type=="number"?Zv[this.feature.type]:this.feature.type:null}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}parseColor(e){let t=this._parseColorCache.get(e);return t||(t=ve.parse(e),this._parseColorCache.set(e,t)),t}}class Io{constructor(e,t,n=[],i,s=new Eu,o=[]){this.registry=e,this.path=n,this.key=n.map(a=>`[${a}]`).join(""),this.scope=s,this.errors=o,this.expectedType=i,this._isConstant=t}parse(e,t,n,i,s={}){return t?this.concat(t,n,i)._parse(e,s):this._parse(e,s)}_parse(e,t){(e===null||typeof e=="string"||typeof e=="boolean"||typeof e=="number")&&(e=["literal",e]);function n(i,s,o){return o==="assert"?new zt(s,[i]):o==="coerce"?new Dr(s,[i]):i}if(Array.isArray(e)){if(e.length===0)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');const i=e[0];if(typeof i!="string")return this.error(`Expression name must be a string, but found ${typeof i} instead. If you wanted a literal array, use ["literal", [...]].`,0),null;const s=this.registry[i];if(s){let o=s.parse(e,this);if(!o)return null;if(this.expectedType){const a=this.expectedType,l=o.type;if((a.kind==="string"||a.kind==="number"||a.kind==="boolean"||a.kind==="object"||a.kind==="array")&&l.kind==="value")o=n(o,a,t.typeAnnotation||"assert");else if(a.kind==="projectionDefinition"&&["string","array"].includes(l.kind)||["color","formatted","resolvedImage"].includes(a.kind)&&["value","string"].includes(l.kind)||["padding","numberArray"].includes(a.kind)&&["value","number","array"].includes(l.kind)||a.kind==="colorArray"&&["value","string","array"].includes(l.kind)||a.kind==="variableAnchorOffsetCollection"&&["value","array"].includes(l.kind))o=n(o,a,t.typeAnnotation||"coerce");else if(this.checkSubtype(a,l))return null}if(!(o instanceof Vn)&&o.type.kind!=="resolvedImage"&&this._isConstant(o)){const a=new Sp;try{o=new Vn(o.type,o.evaluate(a))}catch(l){return this.error(l.message),null}}return o}return this.error(`Unknown expression "${i}". If you wanted a literal array, use ["literal", [...]].`,0)}else return typeof e>"u"?this.error("'undefined' value invalid. Use null instead."):typeof e=="object"?this.error('Bare objects invalid. Use ["literal", {...}] instead.'):this.error(`Expected an array, but found ${typeof e} instead.`)}concat(e,t,n){const i=typeof e=="number"?this.path.concat(e):this.path,s=n?this.scope.concat(n):this.scope;return new Io(this.registry,this._isConstant,i,t||null,s,this.errors)}error(e,...t){const n=`${this.key}${t.map(i=>`[${i}]`).join("")}`;this.errors.push(new ir(n,e))}checkSubtype(e,t){const n=Ni(e,t);return n&&this.error(n),n}}class Co{constructor(e,t){this.type=t.type,this.bindings=[].concat(e),this.result=t}evaluate(e){return this.result.evaluate(e)}eachChild(e){for(const t of this.bindings)e(t[1]);e(this.result)}static parse(e,t){if(e.length<4)return t.error(`Expected at least 3 arguments, but found ${e.length-1} instead.`);const n=[];for(let s=1;s<e.length-1;s+=2){const o=e[s];if(typeof o!="string")return t.error(`Expected string, but found ${typeof o} instead.`,s);if(/[^a-zA-Z0-9_]/.test(o))return t.error("Variable names must contain only alphanumeric characters or '_'.",s);const a=t.parse(e[s+1],s+1);if(!a)return null;n.push([o,a])}const i=t.parse(e[e.length-1],e.length-1,t.expectedType,n);return i?new Co(n,i):null}outputDefined(){return this.result.outputDefined()}}class Lo{constructor(e,t){this.type=t.type,this.name=e,this.boundExpression=t}static parse(e,t){if(e.length!==2||typeof e[1]!="string")return t.error("'var' expression requires exactly one string literal argument.");const n=e[1];return t.scope.has(n)?new Lo(n,t.scope.get(n)):t.error(`Unknown variable "${n}". Make sure "${n}" has been bound in an enclosing "let" expression before using it.`,1)}evaluate(e){return this.boundExpression.evaluate(e)}eachChild(){}outputDefined(){return!1}}class Tu{constructor(e,t,n){this.type=e,this.index=t,this.input=n}static parse(e,t){if(e.length!==3)return t.error(`Expected 2 arguments, but found ${e.length-1} instead.`);const n=t.parse(e[1],1,B),i=t.parse(e[2],2,Tt(t.expectedType||Q));if(!n||!i)return null;const s=i.type;return new Tu(s.itemType,n,i)}evaluate(e){const t=this.index.evaluate(e),n=this.input.evaluate(e);if(t<0)throw new ke(`Array index out of bounds: ${t} < 0.`);if(t>=n.length)throw new ke(`Array index out of bounds: ${t} > ${n.length-1}.`);if(t!==Math.floor(t))throw new ke(`Array index must be an integer, but found ${t} instead.`);return n[t]}eachChild(e){e(this.index),e(this.input)}outputDefined(){return!1}}class Su{constructor(e,t){this.type=ne,this.needle=e,this.haystack=t}static parse(e,t){if(e.length!==3)return t.error(`Expected 2 arguments, but found ${e.length-1} instead.`);const n=t.parse(e[1],1,Q),i=t.parse(e[2],2,Q);return!n||!i?null:wu(n.type,[ne,oe,B,wo,Q])?new Su(n,i):t.error(`Expected first argument to be of type boolean, string, number or null, but found ${Ue(n.type)} instead`)}evaluate(e){const t=this.needle.evaluate(e),n=this.haystack.evaluate(e);if(!n)return!1;if(!rn(t,["boolean","string","number","null"]))throw new ke(`Expected first argument to be of type boolean, string, number or null, but found ${Ue(Ze(t))} instead.`);if(!rn(n,["string","array"]))throw new ke(`Expected second argument to be of type array or string, but found ${Ue(Ze(n))} instead.`);return n.indexOf(t)>=0}eachChild(e){e(this.needle),e(this.haystack)}outputDefined(){return!0}}class Vs{constructor(e,t,n){this.type=B,this.needle=e,this.haystack=t,this.fromIndex=n}static parse(e,t){if(e.length<=2||e.length>=5)return t.error(`Expected 3 or 4 arguments, but found ${e.length-1} instead.`);const n=t.parse(e[1],1,Q),i=t.parse(e[2],2,Q);if(!n||!i)return null;if(!wu(n.type,[ne,oe,B,wo,Q]))return t.error(`Expected first argument to be of type boolean, string, number or null, but found ${Ue(n.type)} instead`);if(e.length===4){const s=t.parse(e[3],3,B);return s?new Vs(n,i,s):null}else return new Vs(n,i)}evaluate(e){const t=this.needle.evaluate(e),n=this.haystack.evaluate(e);if(!rn(t,["boolean","string","number","null"]))throw new ke(`Expected first argument to be of type boolean, string, number or null, but found ${Ue(Ze(t))} instead.`);let i;if(this.fromIndex&&(i=this.fromIndex.evaluate(e)),rn(n,["string"])){const s=n.indexOf(t,i);return s===-1?-1:[...n.slice(0,s)].length}else{if(rn(n,["array"]))return n.indexOf(t,i);throw new ke(`Expected second argument to be of type array or string, but found ${Ue(Ze(n))} instead.`)}}eachChild(e){e(this.needle),e(this.haystack),this.fromIndex&&e(this.fromIndex)}outputDefined(){return!1}}class Ru{constructor(e,t,n,i,s,o){this.inputType=e,this.type=t,this.input=n,this.cases=i,this.outputs=s,this.otherwise=o}static parse(e,t){if(e.length<5)return t.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if(e.length%2!==1)return t.error("Expected an even number of arguments.");let n,i;t.expectedType&&t.expectedType.kind!=="value"&&(i=t.expectedType);const s={},o=[];for(let u=2;u<e.length-1;u+=2){let c=e[u];const h=e[u+1];Array.isArray(c)||(c=[c]);const f=t.concat(u);if(c.length===0)return f.error("Expected at least one branch label.");for(const d of c){if(typeof d!="number"&&typeof d!="string")return f.error("Branch labels must be numbers or strings.");if(typeof d=="number"&&Math.abs(d)>Number.MAX_SAFE_INTEGER)return f.error(`Branch labels must be integers no larger than ${Number.MAX_SAFE_INTEGER}.`);if(typeof d=="number"&&Math.floor(d)!==d)return f.error("Numeric branch labels must be integer values.");if(!n)n=Ze(d);else if(f.checkSubtype(n,Ze(d)))return null;if(typeof s[String(d)]<"u")return f.error("Branch labels must be unique.");s[String(d)]=o.length}const p=t.parse(h,u,i);if(!p)return null;i=i||p.type,o.push(p)}const a=t.parse(e[1],1,Q);if(!a)return null;const l=t.parse(e[e.length-1],e.length-1,i);return!l||a.type.kind!=="value"&&t.concat(1).checkSubtype(n,a.type)?null:new Ru(n,i,a,s,o,l)}evaluate(e){const t=this.input.evaluate(e);return(Ze(t)===this.inputType&&this.outputs[this.cases[t]]||this.otherwise).evaluate(e)}eachChild(e){e(this.input),this.outputs.forEach(e),e(this.otherwise)}outputDefined(){return this.outputs.every(e=>e.outputDefined())&&this.otherwise.outputDefined()}}class Pu{constructor(e,t,n){this.type=e,this.branches=t,this.otherwise=n}static parse(e,t){if(e.length<4)return t.error(`Expected at least 3 arguments, but found only ${e.length-1}.`);if(e.length%2!==0)return t.error("Expected an odd number of arguments.");let n;t.expectedType&&t.expectedType.kind!=="value"&&(n=t.expectedType);const i=[];for(let o=1;o<e.length-1;o+=2){const a=t.parse(e[o],o,ne);if(!a)return null;const l=t.parse(e[o+1],o+1,n);if(!l)return null;i.push([a,l]),n=n||l.type}const s=t.parse(e[e.length-1],e.length-1,n);if(!s)return null;if(!n)throw new Error("Can't infer output type");return new Pu(n,i,s)}evaluate(e){for(const[t,n]of this.branches)if(t.evaluate(e))return n.evaluate(e);return this.otherwise.evaluate(e)}eachChild(e){for(const[t,n]of this.branches)e(t),e(n);e(this.otherwise)}outputDefined(){return this.branches.every(([e,t])=>t.outputDefined())&&this.otherwise.outputDefined()}}class Xs{constructor(e,t,n,i){this.type=e,this.input=t,this.beginIndex=n,this.endIndex=i}static parse(e,t){if(e.length<=2||e.length>=5)return t.error(`Expected 3 or 4 arguments, but found ${e.length-1} instead.`);const n=t.parse(e[1],1,Q),i=t.parse(e[2],2,B);if(!n||!i)return null;if(!wu(n.type,[Tt(Q),oe,Q]))return t.error(`Expected first argument to be of type array or string, but found ${Ue(n.type)} instead`);if(e.length===4){const s=t.parse(e[3],3,B);return s?new Xs(n.type,n,i,s):null}else return new Xs(n.type,n,i)}evaluate(e){const t=this.input.evaluate(e),n=this.beginIndex.evaluate(e);let i;if(this.endIndex&&(i=this.endIndex.evaluate(e)),rn(t,["string"]))return[...t].slice(n,i).join("");if(rn(t,["array"]))return t.slice(n,i);throw new ke(`Expected first argument to be of type array or string, but found ${Ue(Ze(t))} instead.`)}eachChild(e){e(this.input),e(this.beginIndex),this.endIndex&&e(this.endIndex)}outputDefined(){return!1}}function Rp(r,e){const t=r.length-1;let n=0,i=t,s=0,o,a;for(;n<=i;)if(s=Math.floor((n+i)/2),o=r[s],a=r[s+1],o<=e){if(s===t||e<a)return s;n=s+1}else if(o>e)i=s-1;else throw new ke("Input is not a number.");return 0}class Fo{constructor(e,t,n){this.type=e,this.input=t,this.labels=[],this.outputs=[];for(const[i,s]of n)this.labels.push(i),this.outputs.push(s)}static parse(e,t){if(e.length-1<4)return t.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if((e.length-1)%2!==0)return t.error("Expected an even number of arguments.");const n=t.parse(e[1],1,B);if(!n)return null;const i=[];let s=null;t.expectedType&&t.expectedType.kind!=="value"&&(s=t.expectedType);for(let o=1;o<e.length;o+=2){const a=o===1?-1/0:e[o],l=e[o+1],u=o,c=o+1;if(typeof a!="number")return t.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',u);if(i.length&&i[i.length-1][0]>=a)return t.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',u);const h=t.parse(l,c,s);if(!h)return null;s=s||h.type,i.push([a,h])}return new Fo(s,n,i)}evaluate(e){const t=this.labels,n=this.outputs;if(t.length===1)return n[0].evaluate(e);const i=this.input.evaluate(e);if(i<=t[0])return n[0].evaluate(e);const s=t.length;if(i>=t[s-1])return n[s-1].evaluate(e);const o=Rp(t,i);return n[o].evaluate(e)}eachChild(e){e(this.input);for(const t of this.outputs)e(t)}outputDefined(){return this.outputs.every(e=>e.outputDefined())}}function Wv(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}var ca,hh;function qv(){if(hh)return ca;hh=1,ca=r;function r(e,t,n,i){this.cx=3*e,this.bx=3*(n-e)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*t,this.by=3*(i-t)-this.cy,this.ay=1-this.cy-this.by,this.p1x=e,this.p1y=t,this.p2x=n,this.p2y=i}return r.prototype={sampleCurveX:function(e){return((this.ax*e+this.bx)*e+this.cx)*e},sampleCurveY:function(e){return((this.ay*e+this.by)*e+this.cy)*e},sampleCurveDerivativeX:function(e){return(3*this.ax*e+2*this.bx)*e+this.cx},solveCurveX:function(e,t){if(t===void 0&&(t=1e-6),e<0)return 0;if(e>1)return 1;for(var n=e,i=0;i<8;i++){var s=this.sampleCurveX(n)-e;if(Math.abs(s)<t)return n;var o=this.sampleCurveDerivativeX(n);if(Math.abs(o)<1e-6)break;n=n-s/o}var a=0,l=1;for(n=e,i=0;i<20&&(s=this.sampleCurveX(n),!(Math.abs(s-e)<t));i++)e>s?a=n:l=n,n=(l-a)*.5+a;return n},solve:function(e,t){return this.sampleCurveY(this.solveCurveX(e,t))}},ca}var Hv=qv(),Yv=Wv(Hv);class lr{constructor(e,t,n,i,s){this.type=e,this.operator=t,this.interpolation=n,this.input=i,this.labels=[],this.outputs=[];for(const[o,a]of s)this.labels.push(o),this.outputs.push(a)}static interpolationFactor(e,t,n,i){let s=0;if(e.name==="exponential")s=ha(t,e.base,n,i);else if(e.name==="linear")s=ha(t,1,n,i);else if(e.name==="cubic-bezier"){const o=e.controlPoints;s=new Yv(o[0],o[1],o[2],o[3]).solve(ha(t,1,n,i))}return s}static parse(e,t){let[n,i,s,...o]=e;if(!Array.isArray(i)||i.length===0)return t.error("Expected an interpolation type expression.",1);if(i[0]==="linear")i={name:"linear"};else if(i[0]==="exponential"){const u=i[1];if(typeof u!="number")return t.error("Exponential interpolation requires a numeric base.",1,1);i={name:"exponential",base:u}}else if(i[0]==="cubic-bezier"){const u=i.slice(1);if(u.length!==4||u.some(c=>typeof c!="number"||c<0||c>1))return t.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);i={name:"cubic-bezier",controlPoints:u}}else return t.error(`Unknown interpolation type ${String(i[0])}`,1,0);if(e.length-1<4)return t.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if((e.length-1)%2!==0)return t.error("Expected an even number of arguments.");if(s=t.parse(s,2,B),!s)return null;const a=[];let l=null;(n==="interpolate-hcl"||n==="interpolate-lab")&&t.expectedType!=Oi?l=or:t.expectedType&&t.expectedType.kind!=="value"&&(l=t.expectedType);for(let u=0;u<o.length;u+=2){const c=o[u],h=o[u+1],f=u+3,p=u+4;if(typeof c!="number")return t.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',f);if(a.length&&a[a.length-1][0]>=c)return t.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',f);const d=t.parse(h,p,l);if(!d)return null;l=l||d.type,a.push([c,d])}return!Ar(l,B)&&!Ar(l,vo)&&!Ar(l,or)&&!Ar(l,Ro)&&!Ar(l,Po)&&!Ar(l,Oi)&&!Ar(l,Ao)&&!Ar(l,Tt(B))?t.error(`Type ${Ue(l)} is not interpolatable.`):new lr(l,n,i,s,a)}evaluate(e){const t=this.labels,n=this.outputs;if(t.length===1)return n[0].evaluate(e);const i=this.input.evaluate(e);if(i<=t[0])return n[0].evaluate(e);const s=t.length;if(i>=t[s-1])return n[s-1].evaluate(e);const o=Rp(t,i),a=t[o],l=t[o+1],u=lr.interpolationFactor(this.interpolation,i,a,l),c=n[o].evaluate(e),h=n[o+1].evaluate(e);switch(this.operator){case"interpolate":switch(this.type.kind){case"number":return nn(c,h,u);case"color":return ve.interpolate(c,h,u);case"padding":return jt.interpolate(c,h,u);case"colorArray":return St.interpolate(c,h,u);case"numberArray":return Vt.interpolate(c,h,u);case"variableAnchorOffsetCollection":return ar.interpolate(c,h,u);case"array":return Di(c,h,u);case"projectionDefinition":return Gt.interpolate(c,h,u)}case"interpolate-hcl":switch(this.type.kind){case"color":return ve.interpolate(c,h,u,"hcl");case"colorArray":return St.interpolate(c,h,u,"hcl")}case"interpolate-lab":switch(this.type.kind){case"color":return ve.interpolate(c,h,u,"lab");case"colorArray":return St.interpolate(c,h,u,"lab")}}}eachChild(e){e(this.input);for(const t of this.outputs)e(t)}outputDefined(){return this.outputs.every(e=>e.outputDefined())}}function ha(r,e,t,n){const i=n-t,s=r-t;return i===0?0:e===1?s/i:(Math.pow(e,s)-1)/(Math.pow(e,i)-1)}class Bi{constructor(e,t){this.type=e,this.args=t}static parse(e,t){if(e.length<2)return t.error("Expected at least one argument.");let n=null;const i=t.expectedType;i&&i.kind!=="value"&&(n=i);const s=[];for(const a of e.slice(1)){const l=t.parse(a,1+s.length,n,void 0,{typeAnnotation:"omit"});if(!l)return null;n=n||l.type,s.push(l)}if(!n)throw new Error("No output type");return i&&s.some(a=>Ni(i,a.type))?new Bi(Q,s):new Bi(n,s)}evaluate(e){let t=null,n=0,i;for(const s of this.args)if(n++,t=s.evaluate(e),t&&t instanceof Xr&&!t.available&&(i||(i=t.name),t=null,n===this.args.length&&(t=i)),t!==null)break;return t}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every(e=>e.outputDefined())}}function fh(r,e){return r==="=="||r==="!="?e.kind==="boolean"||e.kind==="string"||e.kind==="number"||e.kind==="null"||e.kind==="value":e.kind==="string"||e.kind==="number"||e.kind==="value"}function Kv(r,e,t){return e===t}function Jv(r,e,t){return e!==t}function Qv(r,e,t){return e<t}function e1(r,e,t){return e>t}function t1(r,e,t){return e<=t}function r1(r,e,t){return e>=t}function Pp(r,e,t,n){return n.compare(e,t)===0}function n1(r,e,t,n){return!Pp(r,e,t,n)}function i1(r,e,t,n){return n.compare(e,t)<0}function s1(r,e,t,n){return n.compare(e,t)>0}function o1(r,e,t,n){return n.compare(e,t)<=0}function a1(r,e,t,n){return n.compare(e,t)>=0}function ii(r,e,t){const n=r!=="=="&&r!=="!=";return class Ap{constructor(s,o,a){this.type=ne,this.lhs=s,this.rhs=o,this.collator=a,this.hasUntypedArgument=s.type.kind==="value"||o.type.kind==="value"}static parse(s,o){if(s.length!==3&&s.length!==4)return o.error("Expected two or three arguments.");const a=s[0];let l=o.parse(s[1],1,Q);if(!l)return null;if(!fh(a,l.type))return o.concat(1).error(`"${a}" comparisons are not supported for type '${Ue(l.type)}'.`);let u=o.parse(s[2],2,Q);if(!u)return null;if(!fh(a,u.type))return o.concat(2).error(`"${a}" comparisons are not supported for type '${Ue(u.type)}'.`);if(l.type.kind!==u.type.kind&&l.type.kind!=="value"&&u.type.kind!=="value")return o.error(`Cannot compare types '${Ue(l.type)}' and '${Ue(u.type)}'.`);n&&(l.type.kind==="value"&&u.type.kind!=="value"?l=new zt(u.type,[l]):l.type.kind!=="value"&&u.type.kind==="value"&&(u=new zt(l.type,[u])));let c=null;if(s.length===4){if(l.type.kind!=="string"&&u.type.kind!=="string"&&l.type.kind!=="value"&&u.type.kind!=="value")return o.error("Cannot use collator to compare non-string types.");if(c=o.parse(s[3],3,To),!c)return null}return new Ap(l,u,c)}evaluate(s){const o=this.lhs.evaluate(s),a=this.rhs.evaluate(s);if(n&&this.hasUntypedArgument){const l=Ze(o),u=Ze(a);if(l.kind!==u.kind||!(l.kind==="string"||l.kind==="number"))throw new ke(`Expected arguments for "${r}" to be (string, string) or (number, number), but found (${l.kind}, ${u.kind}) instead.`)}if(this.collator&&!n&&this.hasUntypedArgument){const l=Ze(o),u=Ze(a);if(l.kind!=="string"||u.kind!=="string")return e(s,o,a)}return this.collator?t(s,o,a,this.collator.evaluate(s)):e(s,o,a)}eachChild(s){s(this.lhs),s(this.rhs),this.collator&&s(this.collator)}outputDefined(){return!0}}}const l1=ii("==",Kv,Pp),u1=ii("!=",Jv,n1),c1=ii("<",Qv,i1),h1=ii(">",e1,s1),f1=ii("<=",t1,o1),d1=ii(">=",r1,a1);class Mo{constructor(e,t,n){this.type=To,this.locale=n,this.caseSensitive=e,this.diacriticSensitive=t}static parse(e,t){if(e.length!==2)return t.error("Expected one argument.");const n=e[1];if(typeof n!="object"||Array.isArray(n))return t.error("Collator options argument must be an object.");const i=t.parse(n["case-sensitive"]===void 0?!1:n["case-sensitive"],1,ne);if(!i)return null;const s=t.parse(n["diacritic-sensitive"]===void 0?!1:n["diacritic-sensitive"],1,ne);if(!s)return null;let o=null;return n.locale&&(o=t.parse(n.locale,1,oe),!o)?null:new Mo(i,s,o)}evaluate(e){return new vu(this.caseSensitive.evaluate(e),this.diacriticSensitive.evaluate(e),this.locale?this.locale.evaluate(e):null)}eachChild(e){e(this.caseSensitive),e(this.diacriticSensitive),this.locale&&e(this.locale)}outputDefined(){return!1}}class Au{constructor(e,t,n,i,s){this.type=oe,this.number=e,this.locale=t,this.currency=n,this.minFractionDigits=i,this.maxFractionDigits=s}static parse(e,t){if(e.length!==3)return t.error("Expected two arguments.");const n=t.parse(e[1],1,B);if(!n)return null;const i=e[2];if(typeof i!="object"||Array.isArray(i))return t.error("NumberFormat options argument must be an object.");let s=null;if(i.locale&&(s=t.parse(i.locale,1,oe),!s))return null;let o=null;if(i.currency&&(o=t.parse(i.currency,1,oe),!o))return null;let a=null;if(i["min-fraction-digits"]&&(a=t.parse(i["min-fraction-digits"],1,B),!a))return null;let l=null;return i["max-fraction-digits"]&&(l=t.parse(i["max-fraction-digits"],1,B),!l)?null:new Au(n,s,o,a,l)}evaluate(e){return new Intl.NumberFormat(this.locale?this.locale.evaluate(e):[],{style:this.currency?"currency":"decimal",currency:this.currency?this.currency.evaluate(e):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(e):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(e):void 0}).format(this.number.evaluate(e))}eachChild(e){e(this.number),this.locale&&e(this.locale),this.currency&&e(this.currency),this.minFractionDigits&&e(this.minFractionDigits),this.maxFractionDigits&&e(this.maxFractionDigits)}outputDefined(){return!1}}class Iu{constructor(e){this.type=So,this.sections=e}static parse(e,t){if(e.length<2)return t.error("Expected at least one argument.");const n=e[1];if(!Array.isArray(n)&&typeof n=="object")return t.error("First argument must be an image or text section.");const i=[];let s=!1;for(let o=1;o<=e.length-1;++o){const a=e[o];if(s&&typeof a=="object"&&!Array.isArray(a)){s=!1;let l=null;if(a["font-scale"]&&(l=t.parse(a["font-scale"],1,B),!l))return null;let u=null;if(a["text-font"]&&(u=t.parse(a["text-font"],1,Tt(oe)),!u))return null;let c=null;if(a["text-color"]&&(c=t.parse(a["text-color"],1,or),!c))return null;let h=null;if(a["vertical-align"]){if(typeof a["vertical-align"]=="string"&&!Vv.includes(a["vertical-align"]))return t.error(`'vertical-align' must be one of: 'bottom', 'center', 'top' but found '${a["vertical-align"]}' instead.`);if(h=t.parse(a["vertical-align"],1,oe),!h)return null}const f=i[i.length-1];f.scale=l,f.font=u,f.textColor=c,f.verticalAlign=h}else{const l=t.parse(e[o],1,Q);if(!l)return null;const u=l.type.kind;if(u!=="string"&&u!=="value"&&u!=="null"&&u!=="resolvedImage")return t.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");s=!0,i.push({content:l,scale:null,font:null,textColor:null,verticalAlign:null})}}return new Iu(i)}evaluate(e){const t=n=>{const i=n.content.evaluate(e);return Ze(i)===ts?new Ka("",i,null,null,null,n.verticalAlign?n.verticalAlign.evaluate(e):null):new Ka(Ti(i),null,n.scale?n.scale.evaluate(e):null,n.font?n.font.evaluate(e).join(","):null,n.textColor?n.textColor.evaluate(e):null,n.verticalAlign?n.verticalAlign.evaluate(e):null)};return new br(this.sections.map(t))}eachChild(e){for(const t of this.sections)e(t.content),t.scale&&e(t.scale),t.font&&e(t.font),t.textColor&&e(t.textColor),t.verticalAlign&&e(t.verticalAlign)}outputDefined(){return!1}}class Cu{constructor(e){this.type=ts,this.input=e}static parse(e,t){if(e.length!==2)return t.error("Expected two arguments.");const n=t.parse(e[1],1,oe);return n?new Cu(n):t.error("No image name provided.")}evaluate(e){const t=this.input.evaluate(e),n=Xr.fromString(t);return n&&e.availableImages&&(n.available=e.availableImages.indexOf(t)>-1),n}eachChild(e){e(this.input)}outputDefined(){return!1}}class Lu{constructor(e){this.type=B,this.input=e}static parse(e,t){if(e.length!==2)return t.error(`Expected 1 argument, but found ${e.length-1} instead.`);const n=t.parse(e[1],1);return n?n.type.kind!=="array"&&n.type.kind!=="string"&&n.type.kind!=="value"?t.error(`Expected argument of type string or array, but found ${Ue(n.type)} instead.`):new Lu(n):null}evaluate(e){const t=this.input.evaluate(e);if(typeof t=="string")return[...t].length;if(Array.isArray(t))return t.length;throw new ke(`Expected value to be of type string or array, but found ${Ue(Ze(t))} instead.`)}eachChild(e){e(this.input)}outputDefined(){return!1}}const ur=8192;function p1(r,e){const t=g1(r[0]),n=y1(r[1]),i=Math.pow(2,e.z);return[Math.round(t*i*ur),Math.round(n*i*ur)]}function Fu(r,e){const t=Math.pow(2,e.z),n=(r[0]/ur+e.x)/t,i=(r[1]/ur+e.y)/t;return[m1(n),_1(i)]}function g1(r){return(180+r)/360}function m1(r){return r*360-180}function y1(r){return(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+r*Math.PI/360)))/360}function _1(r){return 360/Math.PI*Math.atan(Math.exp((180-r*360)*Math.PI/180))-90}function rs(r,e){r[0]=Math.min(r[0],e[0]),r[1]=Math.min(r[1],e[1]),r[2]=Math.max(r[2],e[0]),r[3]=Math.max(r[3],e[1])}function Gi(r,e){return!(r[0]<=e[0]||r[2]>=e[2]||r[1]<=e[1]||r[3]>=e[3])}function b1(r,e,t){return e[1]>r[1]!=t[1]>r[1]&&r[0]<(t[0]-e[0])*(r[1]-e[1])/(t[1]-e[1])+e[0]}function x1(r,e,t){const n=r[0]-e[0],i=r[1]-e[1],s=r[0]-t[0],o=r[1]-t[1];return n*o-s*i===0&&n*s<=0&&i*o<=0}function Oo(r,e,t,n){const i=[e[0]-r[0],e[1]-r[1]],s=[n[0]-t[0],n[1]-t[1]];return T1(s,i)===0?!1:!!(dh(r,e,t,n)&&dh(t,n,r,e))}function E1(r,e,t){for(const n of t)for(let i=0;i<n.length-1;++i)if(Oo(r,e,n[i],n[i+1]))return!0;return!1}function si(r,e,t=!1){let n=!1;for(const i of e)for(let s=0;s<i.length-1;s++){if(x1(r,i[s],i[s+1]))return t;b1(r,i[s],i[s+1])&&(n=!n)}return n}function w1(r,e){for(const t of e)if(si(r,t))return!0;return!1}function Ip(r,e){for(const t of r)if(!si(t,e))return!1;for(let t=0;t<r.length-1;++t)if(E1(r[t],r[t+1],e))return!1;return!0}function v1(r,e){for(const t of e)if(Ip(r,t))return!0;return!1}function T1(r,e){return r[0]*e[1]-r[1]*e[0]}function dh(r,e,t,n){const i=r[0]-t[0],s=r[1]-t[1],o=e[0]-t[0],a=e[1]-t[1],l=n[0]-t[0],u=n[1]-t[1],c=i*u-l*s,h=o*u-l*a;return c>0&&h<0||c<0&&h>0}function Mu(r,e,t){const n=[];for(let i=0;i<r.length;i++){const s=[];for(let o=0;o<r[i].length;o++){const a=p1(r[i][o],t);rs(e,a),s.push(a)}n.push(s)}return n}function Cp(r,e,t){const n=[];for(let i=0;i<r.length;i++){const s=Mu(r[i],e,t);n.push(s)}return n}function Lp(r,e,t,n){if(r[0]<t[0]||r[0]>t[2]){const i=n*.5;let s=r[0]-t[0]>i?-n:t[0]-r[0]>i?n:0;s===0&&(s=r[0]-t[2]>i?-n:t[2]-r[0]>i?n:0),r[0]+=s}rs(e,r)}function S1(r){r[0]=r[1]=1/0,r[2]=r[3]=-1/0}function ph(r,e,t,n){const i=Math.pow(2,n.z)*ur,s=[n.x*ur,n.y*ur],o=[];for(const a of r)for(const l of a){const u=[l.x+s[0],l.y+s[1]];Lp(u,e,t,i),o.push(u)}return o}function gh(r,e,t,n){const i=Math.pow(2,n.z)*ur,s=[n.x*ur,n.y*ur],o=[];for(const a of r){const l=[];for(const u of a){const c=[u.x+s[0],u.y+s[1]];rs(e,c),l.push(c)}o.push(l)}if(e[2]-e[0]<=i/2){S1(e);for(const a of o)for(const l of a)Lp(l,e,t,i)}return o}function R1(r,e){const t=[1/0,1/0,-1/0,-1/0],n=[1/0,1/0,-1/0,-1/0],i=r.canonicalID();if(e.type==="Polygon"){const s=Mu(e.coordinates,n,i),o=ph(r.geometry(),t,n,i);if(!Gi(t,n))return!1;for(const a of o)if(!si(a,s))return!1}if(e.type==="MultiPolygon"){const s=Cp(e.coordinates,n,i),o=ph(r.geometry(),t,n,i);if(!Gi(t,n))return!1;for(const a of o)if(!w1(a,s))return!1}return!0}function P1(r,e){const t=[1/0,1/0,-1/0,-1/0],n=[1/0,1/0,-1/0,-1/0],i=r.canonicalID();if(e.type==="Polygon"){const s=Mu(e.coordinates,n,i),o=gh(r.geometry(),t,n,i);if(!Gi(t,n))return!1;for(const a of o)if(!Ip(a,s))return!1}if(e.type==="MultiPolygon"){const s=Cp(e.coordinates,n,i),o=gh(r.geometry(),t,n,i);if(!Gi(t,n))return!1;for(const a of o)if(!v1(a,s))return!1}return!0}class sn{constructor(e,t){this.type=ne,this.geojson=e,this.geometries=t}static parse(e,t){if(e.length!==2)return t.error(`'within' expression requires exactly one argument, but found ${e.length-1} instead.`);if(Ui(e[1])){const n=e[1];if(n.type==="FeatureCollection"){const i=[];for(const s of n.features){const{type:o,coordinates:a}=s.geometry;o==="Polygon"&&i.push(a),o==="MultiPolygon"&&i.push(...a)}if(i.length){const s={type:"MultiPolygon",coordinates:i};return new sn(n,s)}}else if(n.type==="Feature"){const i=n.geometry.type;if(i==="Polygon"||i==="MultiPolygon")return new sn(n,n.geometry)}else if(n.type==="Polygon"||n.type==="MultiPolygon")return new sn(n,n)}return t.error("'within' expression requires valid geojson object that contains polygon geometry type.")}evaluate(e){if(e.geometry()!=null&&e.canonicalID()!=null){if(e.geometryType()==="Point")return R1(e,this.geometries);if(e.geometryType()==="LineString")return P1(e,this.geometries)}return!1}eachChild(){}outputDefined(){return!0}}class Fp{constructor(e=[],t=(n,i)=>n<i?-1:n>i?1:0){if(this.data=e,this.length=this.data.length,this.compare=t,this.length>0)for(let n=(this.length>>1)-1;n>=0;n--)this._down(n)}push(e){this.data.push(e),this._up(this.length++)}pop(){if(this.length===0)return;const e=this.data[0],t=this.data.pop();return--this.length>0&&(this.data[0]=t,this._down(0)),e}peek(){return this.data[0]}_up(e){const{data:t,compare:n}=this,i=t[e];for(;e>0;){const s=e-1>>1,o=t[s];if(n(i,o)>=0)break;t[e]=o,e=s}t[e]=i}_down(e){const{data:t,compare:n}=this,i=this.length>>1,s=t[e];for(;e<i;){let o=(e<<1)+1;const a=o+1;if(a<this.length&&n(t[a],t[o])<0&&(o=a),n(t[o],s)>=0)break;t[e]=t[o],e=o}t[e]=s}}function A1(r,e){if(r.length<=1)return[r];const n=[];let i,s;for(const o of r){const a=I1(o);a!==0&&(o.area=Math.abs(a),s===void 0&&(s=a<0),s===a<0?(i&&n.push(i),i=[o]):i.push(o))}return i&&n.push(i),n}function I1(r){let e=0;for(let t=0,n=r.length,i=n-1,s,o;t<n;i=t++)s=r[t],o=r[i],e+=(o.x-s.x)*(s.y+o.y);return e}const C1=6378.137,mh=1/298.257223563,yh=mh*(2-mh),_h=Math.PI/180;class Ou{constructor(e){const t=_h*C1*1e3,n=Math.cos(e*_h),i=1/(1-yh*(1-n*n)),s=Math.sqrt(i);this.kx=t*s*n,this.ky=t*s*i*(1-yh)}distance(e,t){const n=this.wrap(e[0]-t[0])*this.kx,i=(e[1]-t[1])*this.ky;return Math.sqrt(n*n+i*i)}pointOnLine(e,t){let n=1/0,i,s,o,a;for(let l=0;l<e.length-1;l++){let u=e[l][0],c=e[l][1],h=this.wrap(e[l+1][0]-u)*this.kx,f=(e[l+1][1]-c)*this.ky,p=0;(h!==0||f!==0)&&(p=(this.wrap(t[0]-u)*this.kx*h+(t[1]-c)*this.ky*f)/(h*h+f*f),p>1?(u=e[l+1][0],c=e[l+1][1]):p>0&&(u+=h/this.kx*p,c+=f/this.ky*p)),h=this.wrap(t[0]-u)*this.kx,f=(t[1]-c)*this.ky;const d=h*h+f*f;d<n&&(n=d,i=u,s=c,o=l,a=p)}return{point:[i,s],index:o,t:Math.max(0,Math.min(1,a))}}wrap(e){for(;e<-180;)e+=360;for(;e>180;)e-=360;return e}}const Ja=100,Qa=50;function Mp(r,e){return e[0]-r[0]}function Zs(r){return r[1]-r[0]+1}function wr(r,e){return r[1]>=r[0]&&r[1]<e}function el(r,e){if(r[0]>r[1])return[null,null];const t=Zs(r);if(e){if(t===2)return[r,null];const i=Math.floor(t/2);return[[r[0],r[0]+i],[r[0]+i,r[1]]]}if(t===1)return[r,null];const n=Math.floor(t/2)-1;return[[r[0],r[0]+n],[r[0]+n+1,r[1]]]}function tl(r,e){if(!wr(e,r.length))return[1/0,1/0,-1/0,-1/0];const t=[1/0,1/0,-1/0,-1/0];for(let n=e[0];n<=e[1];++n)rs(t,r[n]);return t}function rl(r){const e=[1/0,1/0,-1/0,-1/0];for(const t of r)for(const n of t)rs(e,n);return e}function bh(r){return r[0]!==-1/0&&r[1]!==-1/0&&r[2]!==1/0&&r[3]!==1/0}function Nu(r,e,t){if(!bh(r)||!bh(e))return NaN;let n=0,i=0;return r[2]<e[0]&&(n=e[0]-r[2]),r[0]>e[2]&&(n=r[0]-e[2]),r[1]>e[3]&&(i=r[1]-e[3]),r[3]<e[1]&&(i=e[1]-r[3]),t.distance([0,0],[n,i])}function Qr(r,e,t){const n=t.pointOnLine(e,r);return t.distance(r,n.point)}function Du(r,e,t,n,i){const s=Math.min(Qr(r,[t,n],i),Qr(e,[t,n],i)),o=Math.min(Qr(t,[r,e],i),Qr(n,[r,e],i));return Math.min(s,o)}function L1(r,e,t,n,i){if(!(wr(e,r.length)&&wr(n,t.length)))return 1/0;let o=1/0;for(let a=e[0];a<e[1];++a){const l=r[a],u=r[a+1];for(let c=n[0];c<n[1];++c){const h=t[c],f=t[c+1];if(Oo(l,u,h,f))return 0;o=Math.min(o,Du(l,u,h,f,i))}}return o}function F1(r,e,t,n,i){if(!(wr(e,r.length)&&wr(n,t.length)))return NaN;let o=1/0;for(let a=e[0];a<=e[1];++a)for(let l=n[0];l<=n[1];++l)if(o=Math.min(o,i.distance(r[a],t[l])),o===0)return o;return o}function M1(r,e,t){if(si(r,e,!0))return 0;let n=1/0;for(const i of e){const s=i[0],o=i[i.length-1];if(s!==o&&(n=Math.min(n,Qr(r,[o,s],t)),n===0))return n;const a=t.pointOnLine(i,r);if(n=Math.min(n,t.distance(r,a.point)),n===0)return n}return n}function O1(r,e,t,n){if(!wr(e,r.length))return NaN;for(let s=e[0];s<=e[1];++s)if(si(r[s],t,!0))return 0;let i=1/0;for(let s=e[0];s<e[1];++s){const o=r[s],a=r[s+1];for(const l of t)for(let u=0,c=l.length,h=c-1;u<c;h=u++){const f=l[h],p=l[u];if(Oo(o,a,f,p))return 0;i=Math.min(i,Du(o,a,f,p,n))}}return i}function xh(r,e){for(const t of r)for(const n of t)if(si(n,e,!0))return!0;return!1}function N1(r,e,t,n=1/0){const i=rl(r),s=rl(e);if(n!==1/0&&Nu(i,s,t)>=n)return n;if(Gi(i,s)){if(xh(r,e))return 0}else if(xh(e,r))return 0;let o=1/0;for(const a of r)for(let l=0,u=a.length,c=u-1;l<u;c=l++){const h=a[c],f=a[l];for(const p of e)for(let d=0,g=p.length,m=g-1;d<g;m=d++){const y=p[m],_=p[d];if(Oo(h,f,y,_))return 0;o=Math.min(o,Du(h,f,y,_,t))}}return o}function Eh(r,e,t,n,i,s){if(!s)return;const o=Nu(tl(n,s),i,t);o<e&&r.push([o,s,[0,0]])}function gs(r,e,t,n,i,s,o){if(!s||!o)return;const a=Nu(tl(n,s),tl(i,o),t);a<e&&r.push([a,s,o])}function Ws(r,e,t,n,i=1/0){let s=Math.min(n.distance(r[0],t[0][0]),i);if(s===0)return s;const o=new Fp([[0,[0,r.length-1],[0,0]]],Mp),a=rl(t);for(;o.length>0;){const l=o.pop();if(l[0]>=s)continue;const u=l[1],c=e?Qa:Ja;if(Zs(u)<=c){if(!wr(u,r.length))return NaN;if(e){const h=O1(r,u,t,n);if(isNaN(h)||h===0)return h;s=Math.min(s,h)}else for(let h=u[0];h<=u[1];++h){const f=M1(r[h],t,n);if(s=Math.min(s,f),s===0)return 0}}else{const h=el(u,e);Eh(o,s,n,r,a,h[0]),Eh(o,s,n,r,a,h[1])}}return s}function qs(r,e,t,n,i,s=1/0){let o=Math.min(s,i.distance(r[0],t[0]));if(o===0)return o;const a=new Fp([[0,[0,r.length-1],[0,t.length-1]]],Mp);for(;a.length>0;){const l=a.pop();if(l[0]>=o)continue;const u=l[1],c=l[2],h=e?Qa:Ja,f=n?Qa:Ja;if(Zs(u)<=h&&Zs(c)<=f){if(!wr(u,r.length)&&wr(c,t.length))return NaN;let p;if(e&&n)p=L1(r,u,t,c,i),o=Math.min(o,p);else if(e&&!n){const d=r.slice(u[0],u[1]+1);for(let g=c[0];g<=c[1];++g)if(p=Qr(t[g],d,i),o=Math.min(o,p),o===0)return o}else if(!e&&n){const d=t.slice(c[0],c[1]+1);for(let g=u[0];g<=u[1];++g)if(p=Qr(r[g],d,i),o=Math.min(o,p),o===0)return o}else p=F1(r,u,t,c,i),o=Math.min(o,p)}else{const p=el(u,e),d=el(c,n);gs(a,o,i,r,t,p[0],d[0]),gs(a,o,i,r,t,p[0],d[1]),gs(a,o,i,r,t,p[1],d[0]),gs(a,o,i,r,t,p[1],d[1])}}return o}function D1(r,e){const t=r.geometry(),n=t.flat().map(o=>Fu([o.x,o.y],r.canonical));if(t.length===0)return NaN;const i=new Ou(n[0][1]);let s=1/0;for(const o of e){switch(o.type){case"Point":s=Math.min(s,qs(n,!1,[o.coordinates],!1,i,s));break;case"LineString":s=Math.min(s,qs(n,!1,o.coordinates,!0,i,s));break;case"Polygon":s=Math.min(s,Ws(n,!1,o.coordinates,i,s));break}if(s===0)return s}return s}function U1(r,e){const t=r.geometry(),n=t.flat().map(o=>Fu([o.x,o.y],r.canonical));if(t.length===0)return NaN;const i=new Ou(n[0][1]);let s=1/0;for(const o of e){switch(o.type){case"Point":s=Math.min(s,qs(n,!0,[o.coordinates],!1,i,s));break;case"LineString":s=Math.min(s,qs(n,!0,o.coordinates,!0,i,s));break;case"Polygon":s=Math.min(s,Ws(n,!0,o.coordinates,i,s));break}if(s===0)return s}return s}function B1(r,e){const t=r.geometry();if(t.length===0||t[0].length===0)return NaN;const n=A1(t).map(o=>o.map(a=>a.map(l=>Fu([l.x,l.y],r.canonical)))),i=new Ou(n[0][0][0][1]);let s=1/0;for(const o of e)for(const a of n){switch(o.type){case"Point":s=Math.min(s,Ws([o.coordinates],!1,a,i,s));break;case"LineString":s=Math.min(s,Ws(o.coordinates,!0,a,i,s));break;case"Polygon":s=Math.min(s,N1(a,o.coordinates,i,s));break}if(s===0)return s}return s}function fa(r){return r.type==="MultiPolygon"?r.coordinates.map(e=>({type:"Polygon",coordinates:e})):r.type==="MultiLineString"?r.coordinates.map(e=>({type:"LineString",coordinates:e})):r.type==="MultiPoint"?r.coordinates.map(e=>({type:"Point",coordinates:e})):[r]}class on{constructor(e,t){this.type=B,this.geojson=e,this.geometries=t}static parse(e,t){if(e.length!==2)return t.error(`'distance' expression requires exactly one argument, but found ${e.length-1} instead.`);if(Ui(e[1])){const n=e[1];if(n.type==="FeatureCollection")return new on(n,n.features.map(i=>fa(i.geometry)).flat());if(n.type==="Feature")return new on(n,fa(n.geometry));if("type"in n&&"coordinates"in n)return new on(n,fa(n))}return t.error("'distance' expression requires valid geojson object that contains polygon geometry type.")}evaluate(e){if(e.geometry()!=null&&e.canonicalID()!=null){if(e.geometryType()==="Point")return D1(e,this.geometries);if(e.geometryType()==="LineString")return U1(e,this.geometries);if(e.geometryType()==="Polygon")return B1(e,this.geometries)}return NaN}eachChild(){}outputDefined(){return!0}}class ns{constructor(e){this.type=Q,this.key=e}static parse(e,t){if(e.length!==2)return t.error(`Expected 1 argument, but found ${e.length-1} instead.`);const n=e[1];return n==null?t.error("Global state property must be defined."):typeof n!="string"?t.error(`Global state property must be string, but found ${typeof e[1]} instead.`):new ns(n)}evaluate(e){var t;const n=(t=e.globals)===null||t===void 0?void 0:t.globalState;return!n||Object.keys(n).length===0?null:vp(n,this.key)}eachChild(){}outputDefined(){return!1}}const No={"==":l1,"!=":u1,">":h1,"<":c1,">=":d1,"<=":f1,array:zt,at:Tu,boolean:zt,case:Pu,coalesce:Bi,collator:Mo,format:Iu,image:Cu,in:Su,"index-of":Vs,interpolate:lr,"interpolate-hcl":lr,"interpolate-lab":lr,length:Lu,let:Co,literal:Vn,match:Ru,number:zt,"number-format":Au,object:zt,slice:Xs,step:Fo,string:zt,"to-boolean":Dr,"to-color":Dr,"to-number":Dr,"to-string":Dr,var:Lo,within:sn,distance:on,"global-state":ns};class Rt{constructor(e,t,n,i){this.name=e,this.type=t,this._evaluate=n,this.args=i}evaluate(e){return this._evaluate(e,this.args)}eachChild(e){this.args.forEach(e)}outputDefined(){return!1}static parse(e,t){const n=e[0],i=Rt.definitions[n];if(!i)return t.error(`Unknown expression "${n}". If you wanted a literal array, use ["literal", [...]].`,0);const s=Array.isArray(i)?i[0]:i.type,o=Array.isArray(i)?[[i[1],i[2]]]:i.overloads,a=o.filter(([u])=>!Array.isArray(u)||u.length===e.length-1);let l=null;for(const[u,c]of a){l=new Io(t.registry,Hs,t.path,null,t.scope);const h=[];let f=!1;for(let p=1;p<e.length;p++){const d=e[p],g=Array.isArray(u)?u[p-1]:u.type,m=l.parse(d,1+h.length,g);if(!m){f=!0;break}h.push(m)}if(!f){if(Array.isArray(u)&&u.length!==h.length){l.error(`Expected ${u.length} arguments, but found ${h.length} instead.`);continue}for(let p=0;p<h.length;p++){const d=Array.isArray(u)?u[p]:u.type,g=h[p];l.concat(p+1).checkSubtype(d,g.type)}if(l.errors.length===0)return new Rt(n,s,c,h)}}if(a.length===1)t.errors.push(...l.errors);else{const c=(a.length?a:o).map(([f])=>z1(f)).join(" | "),h=[];for(let f=1;f<e.length;f++){const p=t.parse(e[f],1+h.length);if(!p)return null;h.push(Ue(p.type))}t.error(`Expected arguments of type ${c}, but found (${h.join(", ")}) instead.`)}return null}static register(e,t){Rt.definitions=t;for(const n in t)e[n]=Rt}}function wh(r,[e,t,n,i]){e=e.evaluate(r),t=t.evaluate(r),n=n.evaluate(r);const s=i?i.evaluate(r):1,o=Tp(e,t,n,s);if(o)throw new ke(o);return new ve(e/255,t/255,n/255,s,!1)}function vh(r,e){return r in e}function da(r,e){const t=e[r];return typeof t>"u"?null:t}function G1(r,e,t,n){for(;t<=n;){const i=t+n>>1;if(e[i]===r)return!0;e[i]>r?n=i-1:t=i+1}return!1}function Wr(r){return{type:r}}Rt.register(No,{error:[Mv,[oe],(r,[e])=>{throw new ke(e.evaluate(r))}],typeof:[oe,[Q],(r,[e])=>Ue(Ze(e.evaluate(r)))],"to-rgba":[Tt(B,4),[or],(r,[e])=>{const[t,n,i,s]=e.evaluate(r).rgb;return[t*255,n*255,i*255,s]}],rgb:[or,[B,B,B],wh],rgba:[or,[B,B,B,B],wh],has:{type:ne,overloads:[[[oe],(r,[e])=>vh(e.evaluate(r),r.properties())],[[oe,tn],(r,[e,t])=>vh(e.evaluate(r),t.evaluate(r))]]},get:{type:Q,overloads:[[[oe],(r,[e])=>da(e.evaluate(r),r.properties())],[[oe,tn],(r,[e,t])=>da(e.evaluate(r),t.evaluate(r))]]},"feature-state":[Q,[oe],(r,[e])=>da(e.evaluate(r),r.featureState||{})],properties:[tn,[],r=>r.properties()],"geometry-type":[oe,[],r=>r.geometryType()],id:[Q,[],r=>r.id()],zoom:[B,[],r=>r.globals.zoom],"heatmap-density":[B,[],r=>r.globals.heatmapDensity||0],elevation:[B,[],r=>r.globals.elevation||0],"line-progress":[B,[],r=>r.globals.lineProgress||0],accumulated:[Q,[],r=>r.globals.accumulated===void 0?null:r.globals.accumulated],"+":[B,Wr(B),(r,e)=>{let t=0;for(const n of e)t+=n.evaluate(r);return t}],"*":[B,Wr(B),(r,e)=>{let t=1;for(const n of e)t*=n.evaluate(r);return t}],"-":{type:B,overloads:[[[B,B],(r,[e,t])=>e.evaluate(r)-t.evaluate(r)],[[B],(r,[e])=>-e.evaluate(r)]]},"/":[B,[B,B],(r,[e,t])=>e.evaluate(r)/t.evaluate(r)],"%":[B,[B,B],(r,[e,t])=>e.evaluate(r)%t.evaluate(r)],ln2:[B,[],()=>Math.LN2],pi:[B,[],()=>Math.PI],e:[B,[],()=>Math.E],"^":[B,[B,B],(r,[e,t])=>Math.pow(e.evaluate(r),t.evaluate(r))],sqrt:[B,[B],(r,[e])=>Math.sqrt(e.evaluate(r))],log10:[B,[B],(r,[e])=>Math.log(e.evaluate(r))/Math.LN10],ln:[B,[B],(r,[e])=>Math.log(e.evaluate(r))],log2:[B,[B],(r,[e])=>Math.log(e.evaluate(r))/Math.LN2],sin:[B,[B],(r,[e])=>Math.sin(e.evaluate(r))],cos:[B,[B],(r,[e])=>Math.cos(e.evaluate(r))],tan:[B,[B],(r,[e])=>Math.tan(e.evaluate(r))],asin:[B,[B],(r,[e])=>Math.asin(e.evaluate(r))],acos:[B,[B],(r,[e])=>Math.acos(e.evaluate(r))],atan:[B,[B],(r,[e])=>Math.atan(e.evaluate(r))],min:[B,Wr(B),(r,e)=>Math.min(...e.map(t=>t.evaluate(r)))],max:[B,Wr(B),(r,e)=>Math.max(...e.map(t=>t.evaluate(r)))],abs:[B,[B],(r,[e])=>Math.abs(e.evaluate(r))],round:[B,[B],(r,[e])=>{const t=e.evaluate(r);return t<0?-Math.round(-t):Math.round(t)}],floor:[B,[B],(r,[e])=>Math.floor(e.evaluate(r))],ceil:[B,[B],(r,[e])=>Math.ceil(e.evaluate(r))],"filter-==":[ne,[oe,Q],(r,[e,t])=>r.properties()[e.value]===t.value],"filter-id-==":[ne,[Q],(r,[e])=>r.id()===e.value],"filter-type-==":[ne,[oe],(r,[e])=>r.geometryType()===e.value],"filter-<":[ne,[oe,Q],(r,[e,t])=>{const n=r.properties()[e.value],i=t.value;return typeof n==typeof i&&n<i}],"filter-id-<":[ne,[Q],(r,[e])=>{const t=r.id(),n=e.value;return typeof t==typeof n&&t<n}],"filter->":[ne,[oe,Q],(r,[e,t])=>{const n=r.properties()[e.value],i=t.value;return typeof n==typeof i&&n>i}],"filter-id->":[ne,[Q],(r,[e])=>{const t=r.id(),n=e.value;return typeof t==typeof n&&t>n}],"filter-<=":[ne,[oe,Q],(r,[e,t])=>{const n=r.properties()[e.value],i=t.value;return typeof n==typeof i&&n<=i}],"filter-id-<=":[ne,[Q],(r,[e])=>{const t=r.id(),n=e.value;return typeof t==typeof n&&t<=n}],"filter->=":[ne,[oe,Q],(r,[e,t])=>{const n=r.properties()[e.value],i=t.value;return typeof n==typeof i&&n>=i}],"filter-id->=":[ne,[Q],(r,[e])=>{const t=r.id(),n=e.value;return typeof t==typeof n&&t>=n}],"filter-has":[ne,[Q],(r,[e])=>e.value in r.properties()],"filter-has-id":[ne,[],r=>r.id()!==null&&r.id()!==void 0],"filter-type-in":[ne,[Tt(oe)],(r,[e])=>e.value.indexOf(r.geometryType())>=0],"filter-id-in":[ne,[Tt(Q)],(r,[e])=>e.value.indexOf(r.id())>=0],"filter-in-small":[ne,[oe,Tt(Q)],(r,[e,t])=>t.value.indexOf(r.properties()[e.value])>=0],"filter-in-large":[ne,[oe,Tt(Q)],(r,[e,t])=>G1(r.properties()[e.value],t.value,0,t.value.length-1)],all:{type:ne,overloads:[[[ne,ne],(r,[e,t])=>e.evaluate(r)&&t.evaluate(r)],[Wr(ne),(r,e)=>{for(const t of e)if(!t.evaluate(r))return!1;return!0}]]},any:{type:ne,overloads:[[[ne,ne],(r,[e,t])=>e.evaluate(r)||t.evaluate(r)],[Wr(ne),(r,e)=>{for(const t of e)if(t.evaluate(r))return!0;return!1}]]},"!":[ne,[ne],(r,[e])=>!e.evaluate(r)],"is-supported-script":[ne,[oe],(r,[e])=>{const t=r.globals&&r.globals.isSupportedScript;return t?t(e.evaluate(r)):!0}],upcase:[oe,[oe],(r,[e])=>e.evaluate(r).toUpperCase()],downcase:[oe,[oe],(r,[e])=>e.evaluate(r).toLowerCase()],concat:[oe,Wr(Q),(r,e)=>e.map(t=>Ti(t.evaluate(r))).join("")],"resolved-locale":[oe,[To],(r,[e])=>e.evaluate(r).resolvedLocale()]});function z1(r){return Array.isArray(r)?`(${r.map(Ue).join(", ")})`:`(${Ue(r.type)}...)`}function Hs(r){if(r instanceof Lo)return Hs(r.boundExpression);if(r instanceof Rt&&r.name==="error")return!1;if(r instanceof Mo)return!1;if(r instanceof sn)return!1;if(r instanceof on)return!1;if(r instanceof ns)return!1;const e=r instanceof Dr||r instanceof zt;let t=!0;return r.eachChild(n=>{e?t=t&&Hs(n):t=t&&n instanceof Vn}),t?Uu(r)&&Gu(r,["zoom","heatmap-density","elevation","line-progress","accumulated","is-supported-script"]):!1}function Uu(r){if(r instanceof Rt){if(r.name==="get"&&r.args.length===1)return!1;if(r.name==="feature-state")return!1;if(r.name==="has"&&r.args.length===1)return!1;if(r.name==="properties"||r.name==="geometry-type"||r.name==="id")return!1;if(/^filter-/.test(r.name))return!1}if(r instanceof sn||r instanceof on)return!1;let e=!0;return r.eachChild(t=>{e&&!Uu(t)&&(e=!1)}),e}function Bu(r){if(r instanceof Rt&&r.name==="feature-state")return!1;let e=!0;return r.eachChild(t=>{e&&!Bu(t)&&(e=!1)}),e}function Gu(r,e){if(r instanceof Rt&&e.indexOf(r.name)>=0)return!1;let t=!0;return r.eachChild(n=>{t&&!Gu(n,e)&&(t=!1)}),t}function nl(r){return{result:"success",value:r}}function Cn(r){return{result:"error",value:r}}function k1(r){return r["property-type"]==="data-driven"||r["property-type"]==="cross-faded-data-driven"}function $1(r){return!!r.expression&&r.expression.parameters.indexOf("zoom")>-1}function j1(r){return!!r.expression&&r.expression.interpolated}function Op(r){return typeof r=="object"&&r!==null&&!Array.isArray(r)&&Ze(r)===tn}class V1{constructor(e,t){this.expression=e,this._warningHistory={},this._evaluator=new Sp,this._defaultValue=t?q1(t):null,this._enumValues=t&&t.type==="enum"?t.values:null}evaluateWithoutErrorHandling(e,t,n,i,s,o){return this._evaluator.globals=e,this._evaluator.feature=t,this._evaluator.featureState=n,this._evaluator.canonical=i,this._evaluator.availableImages=s||null,this._evaluator.formattedSection=o,this.expression.evaluate(this._evaluator)}evaluate(e,t,n,i,s,o){this._evaluator.globals=e,this._evaluator.feature=t||null,this._evaluator.featureState=n||null,this._evaluator.canonical=i,this._evaluator.availableImages=s||null,this._evaluator.formattedSection=o||null;try{const a=this.expression.evaluate(this._evaluator);if(a==null||typeof a=="number"&&a!==a)return this._defaultValue;if(this._enumValues&&!(a in this._enumValues))throw new ke(`Expected value to be one of ${Object.keys(this._enumValues).map(l=>JSON.stringify(l)).join(", ")}, but found ${JSON.stringify(a)} instead.`);return a}catch(a){return this._warningHistory[a.message]||(this._warningHistory[a.message]=!0,typeof console<"u"&&console.warn(a.message)),this._defaultValue}}}function X1(r){return Array.isArray(r)&&r.length>0&&typeof r[0]=="string"&&r[0]in No}function Np(r,e){const t=new Io(No,Hs,[],e?W1(e):void 0),n=t.parse(r,void 0,void 0,void 0,e&&e.type==="string"?{typeAnnotation:"coerce"}:void 0);return n?nl(new V1(n,e)):Cn(t.errors)}class Th{constructor(e,t){this.kind=e,this._styleExpression=t,this.isStateDependent=e!=="constant"&&!Bu(t.expression),this.globalStateRefs=Do(t.expression)}evaluateWithoutErrorHandling(e,t,n,i,s,o){return this._styleExpression.evaluateWithoutErrorHandling(e,t,n,i,s,o)}evaluate(e,t,n,i,s,o){return this._styleExpression.evaluate(e,t,n,i,s,o)}}class Sh{constructor(e,t,n,i){this.kind=e,this.zoomStops=n,this._styleExpression=t,this.isStateDependent=e!=="camera"&&!Bu(t.expression),this.globalStateRefs=Do(t.expression),this.interpolationType=i}evaluateWithoutErrorHandling(e,t,n,i,s,o){return this._styleExpression.evaluateWithoutErrorHandling(e,t,n,i,s,o)}evaluate(e,t,n,i,s,o){return this._styleExpression.evaluate(e,t,n,i,s,o)}interpolationFactor(e,t,n){return this.interpolationType?lr.interpolationFactor(this.interpolationType,e,t,n):0}}function Z1(r,e){const t=Np(r,e);if(t.result==="error")return t;const n=t.value.expression,i=Uu(n);if(!i&&!k1(e))return Cn([new ir("","data expressions not supported")]);const s=Gu(n,["zoom"]);if(!s&&!$1(e))return Cn([new ir("","zoom expressions not supported")]);const o=ws(n);if(!o&&!s)return Cn([new ir("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.')]);if(o instanceof ir)return Cn([o]);if(o instanceof lr&&!j1(e))return Cn([new ir("",'"interpolate" expressions cannot be used with this property')]);if(!o)return nl(i?new Th("constant",t.value):new Th("source",t.value));const a=o instanceof lr?o.interpolation:void 0;return nl(i?new Sh("camera",t.value,o.labels,a):new Sh("composite",t.value,o.labels,a))}function ws(r){let e=null;if(r instanceof Co)e=ws(r.result);else if(r instanceof Bi){for(const t of r.args)if(e=ws(t),e)break}else(r instanceof Fo||r instanceof lr)&&r.input instanceof Rt&&r.input.name==="zoom"&&(e=r);return e instanceof ir||r.eachChild(t=>{const n=ws(t);n instanceof ir?e=n:!e&&n?e=new ir("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.'):e&&n&&e!==n&&(e=new ir("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'))}),e}function Do(r,e=new Set){return r instanceof ns&&e.add(r.key),r.eachChild(t=>{Do(t,e)}),e}function W1(r){const e={color:or,string:oe,number:B,enum:oe,boolean:ne,formatted:So,padding:Ro,numberArray:Po,colorArray:Oi,projectionDefinition:vo,resolvedImage:ts,variableAnchorOffsetCollection:Ao};return r.type==="array"?Tt(e[r.value]||Q,r.length):e[r.type]}function q1(r){if(r.type==="color"&&Op(r.default))return new ve(0,0,0,0);switch(r.type){case"color":return ve.parse(r.default)||null;case"padding":return jt.parse(r.default)||null;case"numberArray":return Vt.parse(r.default)||null;case"colorArray":return St.parse(r.default)||null;case"variableAnchorOffsetCollection":return ar.parse(r.default)||null;case"projectionDefinition":return Gt.parse(r.default)||null;default:return r.default===void 0?null:r.default}}function Dp(r){if(r===!0||r===!1)return!0;if(!Array.isArray(r)||r.length===0)return!1;switch(r[0]){case"has":return r.length>=2&&r[1]!=="$id"&&r[1]!=="$type";case"in":return r.length>=3&&(typeof r[1]!="string"||Array.isArray(r[2]));case"!in":case"!has":case"none":return!1;case"==":case"!=":case">":case">=":case"<":case"<=":return r.length!==3||Array.isArray(r[1])||Array.isArray(r[2]);case"any":case"all":for(const e of r.slice(1))if(!Dp(e)&&typeof e!="boolean")return!1;return!0;default:return!0}}const H1={type:"boolean",default:!1,transition:!1,"property-type":"data-driven",expression:{interpolated:!1,parameters:["zoom","feature"]}};function Y1(r){if(r==null)return{filter:()=>!0,needGeometry:!1,getGlobalStateRefs:()=>new Set};Dp(r)||(r=Ys(r));const e=Np(r,H1);if(e.result==="error")throw new Error(e.value.map(t=>`${t.key}: ${t.message}`).join(", "));{const t=Up(r);return{filter:(n,i,s)=>e.value.evaluate(n,i,{},s),needGeometry:t,getGlobalStateRefs:()=>Do(e.value.expression)}}}function K1(r,e){return r<e?-1:r>e?1:0}function Up(r){if(!Array.isArray(r))return!1;if(r[0]==="within"||r[0]==="distance")return!0;for(let e=1;e<r.length;e++)if(Up(r[e]))return!0;return!1}function Ys(r){if(!r)return!0;const e=r[0];return r.length<=1?e!=="any":e==="=="?pa(r[1],r[2],"=="):e==="!="?ms(pa(r[1],r[2],"==")):e==="<"||e===">"||e==="<="||e===">="?pa(r[1],r[2],e):e==="any"?J1(r.slice(1)):e==="all"?["all"].concat(r.slice(1).map(Ys)):e==="none"?["all"].concat(r.slice(1).map(Ys).map(ms)):e==="in"?Rh(r[1],r.slice(2)):e==="!in"?ms(Rh(r[1],r.slice(2))):e==="has"?Ph(r[1]):e==="!has"?ms(Ph(r[1])):!0}function pa(r,e,t){switch(r){case"$type":return[`filter-type-${t}`,e];case"$id":return[`filter-id-${t}`,e];default:return[`filter-${t}`,r,e]}}function J1(r){return["any"].concat(r.map(Ys))}function Rh(r,e){if(e.length===0)return!1;switch(r){case"$type":return["filter-type-in",["literal",e]];case"$id":return["filter-id-in",["literal",e]];default:return e.length>200&&!e.some(t=>typeof t!=typeof e[0])?["filter-in-large",r,["literal",e.sort(K1)]]:["filter-in-small",r,["literal",e]]}}function Ph(r){switch(r){case"$type":return!0;case"$id":return["filter-has-id"];default:return["filter-has",r]}}function ms(r){return["!",r]}function zi(r){return typeof r=="object"?["literal",r]:r}function Q1(r,e){let t=r.stops;if(!t)return eT(r,e);const n=t&&typeof t[0][0]=="object",i=n||r.property!==void 0,s=n||!i;return t=t.map(o=>!i&&e.tokens&&typeof o[1]=="string"?[o[0],iT(o[1])]:[o[0],zi(o[1])]),n?tT(r,e,t):s?nT(r,e,t):il(r,e,t)}function eT(r,e){const t=["get",r.property];if(r.default===void 0)return e.type==="string"?["string",t]:t;if(e.type==="enum")return["match",t,Object.keys(e.values),t,r.default];{const n=[e.type==="color"?"to-color":e.type,t,zi(r.default)];return e.type==="array"&&n.splice(1,0,e.value,e.length||null),n}}function zu(r){switch(r.colorSpace){case"hcl":return"interpolate-hcl";case"lab":return"interpolate-lab";default:return"interpolate"}}function tT(r,e,t){const n={},i={},s=[];for(let a=0;a<t.length;a++){const l=t[a],u=l[0].zoom;n[u]===void 0&&(n[u]={zoom:u,type:r.type,property:r.property,default:r.default},i[u]=[],s.push(u)),i[u].push([l[0].value,l[1]])}if($u({},e)==="exponential"){const a=[zu(r),["linear"],["zoom"]];for(const l of s){const u=il(n[l],e,i[l]);Un(a,l,u,!1)}return a}else{const a=["step",["zoom"]];for(const l of s){const u=il(n[l],e,i[l]);Un(a,l,u,!0)}return ku(a),a}}function rT(r,e){if(r!==void 0)return r;if(e!==void 0)return e}function Ah(r,e){const t=zi(rT(r.default,e.default));return t===void 0&&e.type==="resolvedImage"?"":t}function il(r,e,t){const n=$u(r,e),i=["get",r.property];if(n==="categorical"&&typeof t[0][0]=="boolean"){const s=["case"];for(const o of t)s.push(["==",i,o[0]],o[1]);return s.push(Ah(r,e)),s}else if(n==="categorical"){const s=["match",i];for(const o of t)Un(s,o[0],o[1],!1);return s.push(Ah(r,e)),s}else if(n==="interval"){const s=["step",["number",i]];for(const o of t)Un(s,o[0],o[1],!0);return ku(s),r.default===void 0?s:["case",["==",["typeof",i],"number"],s,zi(r.default)]}else if(n==="exponential"){const s=r.base!==void 0?r.base:1,o=[zu(r),s===1?["linear"]:["exponential",s],["number",i]];for(const a of t)Un(o,a[0],a[1],!1);return r.default===void 0?o:["case",["==",["typeof",i],"number"],o,zi(r.default)]}else throw new Error(`Unknown property function type ${n}`)}function nT(r,e,t,n=["zoom"]){const i=$u(r,e);let s,o=!1;if(i==="interval")s=["step",n],o=!0;else if(i==="exponential"){const a=r.base!==void 0?r.base:1;s=[zu(r),a===1?["linear"]:["exponential",a],n]}else throw new Error(`Unknown zoom function type "${i}"`);for(const a of t)Un(s,a[0],a[1],o);return ku(s),s}function ku(r){r[0]==="step"&&r.length===3&&(r.push(0),r.push(r[3]))}function Un(r,e,t,n){r.length>3&&e===r[r.length-2]||(n&&r.length===2||r.push(e),r.push(t))}function $u(r,e){return r.type?r.type:e.expression.interpolated?"exponential":"interval"}function iT(r){const e=["concat"],t=/{([^{}]+)}/g;let n=0;for(let i=t.exec(r);i!==null;i=t.exec(r)){const s=r.slice(n,t.lastIndex-i[0].length);n=t.lastIndex,s.length>0&&e.push(s),e.push(["get",i[1]])}if(e.length===1)return r;if(n<r.length)e.push(r.slice(n));else if(e.length===2)return["to-string",e[1]];return e}const sT=Cv;var Ih={thin:100,hairline:100,"ultra-light":200,"extra-light":200,light:300,book:300,regular:400,normal:400,plain:400,roman:400,standard:400,medium:500,"semi-bold":600,"demi-bold":600,bold:700,"extra-bold":800,"ultra-bold":800,heavy:900,black:900,"heavy-black":900,fat:900,poster:900,"ultra-black":950,"extra-black":950},fi=" ",Ch=/(italic|oblique)$/i,Lh={};function sl(r,e,t){var n=Lh[r];if(!n){Array.isArray(r)||(r=[r]);for(var i=400,s="normal",o=[],a,l,u=0,c=r.length;u<c;++u){var h=r[u],f=h.split(" "),p=f[f.length-1].toLowerCase();p=="normal"||p=="italic"||p=="oblique"?(s=l?s:p,l=!0,f.pop(),p=f[f.length-1].toLowerCase()):Ch.test(p)&&(p=p.replace(Ch,""),s=l?s:f[f.length-1].replace(p,""),l=!0);for(var d in Ih){var g=f.length>1?f[f.length-2].toLowerCase():"";if(p==d||p==d.replace("-","")||g+"-"+p==d){i=a?i:Ih[d],f.pop(),g&&d.startsWith(g)&&f.pop();break}}!a&&typeof p=="number"&&(i=p,a=!0);var m=f.join(fi).replace("Klokantech Noto Sans","Noto Sans").replace("DIN Pro","Barlow").replace("Arial Unicode MS","Arial");m.indexOf(fi)!==-1&&(m='"'+m+'"'),o.push(m)}n=Lh[r]=[s,i,o]}return n[0]+fi+n[1]+fi+e+"px"+(t?"/"+t:"")+fi+n[2]}const Bp="https://api.mapbox.com";function ju(r){const e="mapbox://";return r.indexOf(e)!==0?"":r.slice(e.length)}function oT(r,e,t){if(typeof r=="string")return[{id:"default",url:Fh(r,e,t)}];for(const n of r)n.url=Fh(n.url,e,t);return r}function Fh(r,e,t){const n=ju(r);if(!n)return decodeURI(new URL(r,t).href);const i="sprites/";if(n.indexOf(i)!==0)throw new Error(`unexpected sprites url: ${r}`);const s=n.slice(i.length);return`${Bp}/styles/v1/${s}/sprite?access_token=${e}`}function Ks(r,e){const t=ju(r);if(!t)return decodeURI(new URL(r,location.href).href);const n="styles/";if(t.indexOf(n)!==0)throw new Error(`unexpected style url: ${r}`);const i=t.slice(n.length);return`${Bp}/styles/v1/${i}?&access_token=${e}`}const aT=["a","b","c","d"];function vs(r,e,t,n){const i=new URL(r,n||location.href),s=ju(r);if(!s)return e?(i.searchParams.has(t)||i.searchParams.set(t,e),[decodeURI(i.href)]):[decodeURI(i.href)];if(s==="mapbox.satellite"){const o=window.devicePixelRatio>=1.5?"@2x":"";return[`https://api.mapbox.com/v4/${s}/{z}/{x}/{y}${o}.webp?access_token=${e}`]}return aT.map(o=>`https://${o}.tiles.mapbox.com/v4/${s}/{z}/{x}/{y}.vector.pbf?access_token=${e}`)}const kt=Object.freeze({}),Mh={},Oh={};let lT=0;function Vu(r){return r.id||(r.id=lT++),r.id}function uT(r,e){return Vu(r)+"."+me(e)}function Gp(r){let e=Mh[r.id];return e||(e={},Mh[Vu(r)]=e),e}function cT(r){let e=Oh[r.id];return e||(e={},Oh[Vu(r)]=e),e}function ga(r){return r*Math.PI/180}const cr=function(){const r=[];for(let e=78271.51696402048;r.length<=24;e/=2)r.push(e);return r}();function Uo(r,e){if(typeof WorkerGlobalScope<"u"&&self instanceof WorkerGlobalScope&&typeof OffscreenCanvas<"u")return new OffscreenCanvas(r,e);const t=document.createElement("canvas");return t.width=r,t.height=e,t}function Xu(r,e){let t=0;const n=e.length;for(;t<n;++t)if(e[t]<r&&t+1<n){const s=e[t]/e[t+1];return t+Math.log(e[t]/r)/Math.log(s)}return n-1}function yi(r,e){const t=Math.floor(r),n=Math.pow(2,r-t);return e[t]/n}const Tn={};function Xn(r,e,t={},n){if(e in Tn)return n&&(n.url=Tn[e][0].url),Tn[e][1];const i=t.transformRequest&&t.transformRequest(e,r)||e,s=function(l){return delete Tn[e],Promise.reject(new Error("Error fetching source "+e))},o=function(l){return delete Tn[e],l.ok?l.json():Promise.reject(new Error("Error fetching source "+e))},a=Ai(()=>i).then(l=>l instanceof Response?(n&&(n.url=l.url),o(l)):(l instanceof Request||(l=new Request(l)),l.headers.get("Accept")||l.headers.set("Accept","application/json"),n&&(n.url=l.url),fetch(l).then(o).catch(s))).catch(s);return Tn[e]=[i,a],a}function zp(r,e){if(typeof r=="string")if(r.trim().startsWith("{"))try{const t=JSON.parse(r);return Promise.resolve(t)}catch(t){return Promise.reject(t)}else return r=Ks(r,e.accessToken),Xn("Style",r,e);else return Promise.resolve(r)}const Nh={};function kp(r,e,t={}){const n=[e,JSON.stringify(r)].toString();let i=Nh[n];if(!i||t.transformRequest){let s;t.transformRequest&&(s=(a,l)=>{const u=t.transformRequest&&t.transformRequest(l,"Tiles")||l;if(a instanceof ym)a.setLoader((c,h,f)=>{const p=function(d){d.arrayBuffer().then(g=>{const y=a.getFormat().readFeatures(g,{extent:c,featureProjection:f});a.setFeatures(y)})};Ai(()=>u).then(d=>{if(d instanceof Response)return p(d);fetch(d).then(p).catch(g=>a.setState(ee.ERROR))}).catch(d=>a.setState(ee.ERROR))});else{const c=a.getImage();Ai(()=>u).then(h=>{if(typeof h=="string"){c.src=h;return}const f=p=>p.blob().then(d=>{const g=URL.createObjectURL(d);c.addEventListener("load",()=>URL.revokeObjectURL(g)),c.addEventListener("error",()=>URL.revokeObjectURL(g)),c.src=g});if(h instanceof Response)return f(h);fetch(h).then(f).catch(p=>a.setState(ee.ERROR))}).catch(h=>a.setState(ee.ERROR))}});const o=r.url;if(o&&!r.tiles){const a=vs(o,t.accessToken,t.accessTokenParam||"access_token",e||location.href);if(o.startsWith("mapbox://"))i=Promise.resolve({tileJson:Object.assign({},r,{url:void 0,tiles:a}),tileLoadFunction:s});else{const l={};i=Xn("Source",a[0],t,l).then(function(u){return u.tiles=u.tiles.map(function(c){return u.scheme==="tms"&&(c=c.replace("{y}","{-y}")),vs(c,t.accessToken,t.accessTokenParam||"access_token",l.url)[0]}),Promise.resolve({tileJson:u,tileLoadFunction:s})})}}else r.tiles?(r=Object.assign({},r,{tiles:r.tiles.map(function(a){return r.scheme==="tms"&&(a=a.replace("{y}","{-y}")),vs(a,t.accessToken,t.accessTokenParam||"access_token",e||location.href)[0]})}),i=Promise.resolve({tileJson:Object.assign({},r),tileLoadFunction:s})):i=Promise.reject(new Error("source has no `tiles` nor `url`"));Nh[n]=i}return i}function Dh(r,e,t,n){const i=[2*t*e.pixelRatio+e.width,2*t*e.pixelRatio+e.height],s=Uo(i[0],i[1]),o=s.getContext("2d");o.drawImage(r,e.x,e.y,e.width,e.height,t*e.pixelRatio,t*e.pixelRatio,e.width,e.height);const a=o.getImageData(0,0,i[0],i[1]);o.globalCompositeOperation="destination-over",o.fillStyle=`rgba(${n.r*255},${n.g*255},${n.b*255},${n.a})`;const l=a.data;for(let u=0,c=a.width;u<c;++u)for(let h=0,f=a.height;h<f;++h){const p=(h*c+u)*4;l[p+3]>0&&o.arc(u,h,t*e.pixelRatio,0,2*Math.PI)}return o.fill(),s}function hT(r,e,t){const n=Math.max(0,Math.min(1,(t-r)/(e-r)));return n*n*(3-2*n)}function Uh(r,e,t){const n=Uo(e.width,e.height),i=n.getContext("2d");i.drawImage(r,e.x,e.y,e.width,e.height,0,0,e.width,e.height);const s=i.getImageData(0,0,e.width,e.height),o=s.data;for(let a=0,l=s.width;a<l;++a)for(let u=0,c=s.height;u<c;++u){const h=(u*l+a)*4,f=o[h+3]/255,p=.75,d=.1,g=hT(p-d,p+d,f);g>0?(o[h+0]=Math.round(255*t.r*g),o[h+1]=Math.round(255*t.g*g),o[h+2]=Math.round(255*t.b*g),o[h+3]=Math.round(255*g)):o[h+3]=0}return i.putImageData(s,0,0),n}const fT=Array(256).join("");function ol(r,e){if(e>=.05){let t="";const n=r.split(`
`),i=fT.slice(0,Math.round(e/.1));for(let s=0,o=n.length;s<o;++s)s>0&&(t+=`
`),t+=n[s].split("").join(i);return t}return r}let ma;function $p(){return ma||(ma=Uo(1,1).getContext("2d")),ma}function qr(r,e){return $p().measureText(r).width+(r.length-1)*e}const Js={};_m.on("propertychange",()=>{for(const r in Js)delete Js[r]});function al(r,e,t,n){if(r.indexOf(`
`)!==-1){const o=r.split(`
`),a=[];for(let l=0,u=o.length;l<u;++l)a.push(al(o[l],e,t,n));return a.join(`
`)}const i=t+","+e+","+r+","+n;let s=Js[i];if(!s){const o=r.split(" ");if(o.length>1){const a=$p();a.font=e;const u=a.measureText("M").width*t;let c="";const h=[];for(let f=0,p=o.length;f<p;++f){const d=o[f],g=c+(c?" ":"")+d;qr(g,n)<=u?c=g:(c&&h.push(c),c=d)}c&&h.push(c);for(let f=0,p=h.length;f<p&&p>1;++f){const d=h[f];if(qr(d,n)<u*.35){const g=f>0?qr(h[f-1],n):1/0,m=f<p-1?qr(h[f+1],n):1/0;h.splice(f,1),p-=1,g<m?(h[f-1]+=" "+d,f-=1):h[f]=d+" "+h[f]}}for(let f=0,p=h.length-1;f<p;++f){const d=h[f],g=h[f+1];if(qr(d,n)>u*.7&&qr(g,n)<u*.6){const m=d.split(" "),y=m.pop();qr(y,n)<u*.2&&(h[f]=m.join(" "),h[f+1]=y+" "+g),p-=1}}s=h.join(`
`)}else s=r;s=ol(s,n),Js[i]=s}return s}const dT=["Arial","Courier New","Times New Roman","Verdana","sans-serif","serif","monospace","cursive","fantasy"],Bh={};function pT(r,e="https://cdn.jsdelivr.net/npm/@fontsource/{font-family}/{fontweight}{-fontstyle}.css"){if(Zi)return r;let t;for(let n=0,i=r.length;n<i;++n){const s=r[n];if(s in Bh)continue;Bh[s]=!0;const a=sl(s,16).split(" ");t||(t=[]),t.push([a.slice(3).join(" ").replace(/"/g,""),a[1],a[0]])}return t&&(async()=>{await document.fonts.ready;for(let n=0,i=t.length;n<i;++n){const s=t[n],o=s[0];if(dT.includes(o))continue;const a=s[1],l=s[2];if(!(await document.fonts.load(`${l} ${a} 16px "${o}"`)).some(c=>c.family.replace(/^['"]|['"]$/g,"").toLowerCase()===o.toLowerCase()&&c.weight==a&&c.style===l)){const c=e.replace("{font-family}",o.replace(/ /g,"-").toLowerCase()).replace("{Font+Family}",o.replace(/ /g,"+")).replace("{fontweight}",a).replace("{-fontstyle}",l.replace("normal","").replace(/(.+)/,"-$1")).replace("{fontstyle}",l);if(!document.querySelector('link[href="'+c+'"]')){const h=document.createElement("link");h.href=c,h.rel="stylesheet",document.head.appendChild(h)}}}})(),r}const gT={Point:1,MultiPoint:1,LineString:2,MultiLineString:2,Polygon:3,MultiPolygon:3},mT={center:[.5,.5],left:[0,.5],right:[1,.5],top:[.5,0],bottom:[.5,1],"top-left":[0,0],"top-right":[1,0],"bottom-left":[0,1],"bottom-right":[1,1]},yT=function(r,e){const t=Z1(r,e);if(t.result==="error")throw new Error(t.value.map(n=>`${n.key}: ${n.message}`).join(", "));return t.value},It={zoom:0,distanceFromCenter:0};Rt.register(No,{...Rt.definitions,pitch:[{kind:"number"},[],r=>It.pitch||90],"distance-from-center":[{kind:"number"},[],r=>It.distanceFromCenter||0]});let ys,ya;function V(r,e,t,n,i,s){const o=r.id;i||(i={},console.warn("No functionCache provided to getValue()")),i[o]||(i[o]={});const a=i[o];if(!a[t]){let l=(r[e]||kt)[t];const u=sT[`${e}_${r.type}`][t];l===void 0&&(l=u.default);let c=X1(l);if(!c&&Op(l)&&(l=Q1(l,u),c=!0),c){const h=yT(l,u);a[t]=h.evaluate.bind(h)}else u.type=="color"&&(l=ve.parse(l)),a[t]=function(){return l}}return a[t](It,n,s)}function Gh(r,e,t,n){return V(r,"layout",`${t}-allow-overlap`,e,n)?V(r,"layout",`${t}-ignore-placement`,e,n)?"none":"obstacle":"declutter"}function _T(r,e,t,n){if(n||console.warn("No filterCache provided to evaluateFilter()"),!(r in n))try{n[r]=Y1(e).filter}catch(i){console.warn("Filter will evaluate to false: "+i.message),n[r]=function(){return!1}}return n[r](It,t)}function Cr(r,e){if(r){if(r.a===0||e===0)return;const t=r.a;return e=e===void 0?1:e,t===0?"transparent":"rgba("+Math.round(r.r*255/t)+","+Math.round(r.g*255/t)+","+Math.round(r.b*255/t)+","+t*e+")"}return r}const bT=/\{[^{}}]*\}/g;function _a(r,e){return r.replace(bT,function(t){return e[t.slice(1,-1)]||""})}function zh(r,e){let t=r.split(":")[0];return t===r&&(t="default"),e[t]}const xT={};function ET(r,e,t,n=cr,i=void 0,s=void 0,o=void 0,a=void 0){if(typeof e=="string"&&(e=JSON.parse(e)),e.version!=8)throw new Error("glStyle version 8 required.");xT[uT(e,r)]=Array.from(arguments);const l={};(typeof s=="string"||s instanceof Request||s instanceof Response||s instanceof Promise)&&(s={default:s});for(const x in s){const E=s[x];Ai(()=>E).then(async v=>{let A;if(typeof Image<"u"){const P=new Image;if(typeof v=="string")P.crossOrigin="anonymous",P.src=v;else{let S;v instanceof Request?S=await fetch(v):v instanceof Response&&(S=v);const I=await S.blob();A=URL.createObjectURL(I),P.src=A}P.addEventListener("load",function S(){P.removeEventListener("load",S),l[x]={image:P,size:[P.width,P.height]},r.changed(),A&&URL.revokeObjectURL(A)}),P.addEventListener("error",function S(){URL.revokeObjectURL(A),P.removeEventListener("error",S)})}else if(typeof WorkerGlobalScope<"u"&&self instanceof WorkerGlobalScope){const P=self;P.postMessage({action:"loadImage",src:v}),P.addEventListener("message",function(I){I.data.action==="imageLoaded"&&I.data.src===v&&(l[x]={image:I.data.image,size:[I.data.image.width,I.data.image.height]})})}})}const u=pp(e.layers),c={},h=[],f={},p={},d=Gp(e),g=cT(e);let m;for(let x=0,E=u.length;x<E;++x){const v=u[x],A=v.id;if(typeof t=="string"&&v.source==t||Array.isArray(t)&&t.indexOf(A)!==-1){const P=v["source-layer"];if(m){if(v.source!==m)throw new Error(`Layer "${A}" does not use source "${m}`)}else{m=v.source;const I=e.sources[m];if(!I)throw new Error(`Source "${m}" is not defined`);const N=I.type;if(N!=="vector"&&N!=="geojson")throw new Error(`Source "${m}" is not of type "vector" or "geojson", but "${N}"`)}let S=c[P];S||(S=[],c[P]=S),S.push({layer:v,index:x}),h.push(A)}}const y=new Mr,_=new Or,b=[],w=function(x,E,v){var se,H,Y;const A=((Y=(H=(se=r.getSource)==null?void 0:se.call(r))==null?void 0:H.format_)==null?void 0:Y.layerName_)??"mvt:layer",P=x.getProperties(),S=c[P[A]];if(!S)return;let I=n.indexOf(E);I==-1&&(I=Xu(E,n)),It.zoom=I,It.distanceFromCenter=0;const N=x.getGeometry(),z=gT[N.getType()],X=r.get("map");if(X&&X instanceof Ns&&z===1){const le=X.getSize();if(le){const Te=X.getView().getCenter(),K=Xt(N.getExtent());It.distanceFromCenter=wg(Te,K)/E/le[1]}}const C={id:x.getId(),properties:P,type:z},M=r.get("mapbox-featurestate")[x.getId()];let U=-1;for(let le=0,Te=S.length;le<Te;++le){const K=S[le],O=K.layer,Le=O.id;if(v!==void 0&&v!==Le)continue;const Ie=O.layout||kt,Se=O.paint||kt;if(Ie.visibility==="none"||"minzoom"in O&&I<O.minzoom||"maxzoom"in O&&I>=O.maxzoom)continue;const st=O.filter;if(!st||_T(Le,st,C,g)){let Be,He,dr,ct,yt,$;const Tr=K.index;if(z==3&&(O.type=="fill"||O.type=="fill-extrusion"))if(He=V(O,"paint",O.type+"-opacity",C,d,M),O.type+"-pattern"in Se){const Ge=V(O,"paint",O.type+"-pattern",C,d,M);if(Ge){const De=typeof Ge=="string"?_a(Ge,P):Ge.toString(),Ce=zh(De,l);if(i&&i[De]&&Ce){++U,$=b[U],(!$||!$.getFill()||$.getStroke()||$.getText())&&($=new nr({fill:new Or}),b[U]=$),dr=$.getFill(),$.setZIndex(Tr);const Re=De+"."+He;let We=p[Re];if(!We){const fe=i[De],be=Uo(fe.width,fe.height),Ye=be.getContext("2d");Ye.globalAlpha=He,Ye.drawImage(Ce.image,fe.x,fe.y,fe.width,fe.height,0,0,fe.width,fe.height),We=Ye.createPattern(be,"repeat"),p[Re]=We}dr.setColor(We)}}}else Be=Cr(V(O,"paint",O.type+"-color",C,d,M),He),O.type+"-outline-color"in Se&&(yt=Cr(V(O,"paint",O.type+"-outline-color",C,d,M),He)),yt||(yt=Be),(Be||yt)&&(++U,$=b[U],(!$||Be&&!$.getFill()||!Be&&$.getFill()||yt&&!$.getStroke()||!yt&&$.getStroke()||$.getText())&&($=new nr({fill:Be?new Or:void 0,stroke:yt?new Mr:void 0}),b[U]=$),Be&&(dr=$.getFill(),dr.setColor(Be)),yt&&(ct=$.getStroke(),ct.setColor(yt),ct.setWidth(.5)),$.setZIndex(Tr));if(z!=1&&O.type=="line"){"line-pattern"in Se?Be=void 0:Be=Cr(V(O,"paint","line-color",C,d,M),V(O,"paint","line-opacity",C,d,M));const Ge=V(O,"paint","line-width",C,d,M);Be&&Ge>0&&(++U,$=b[U],(!$||!$.getStroke()||$.getFill()||$.getText())&&($=new nr({stroke:new Mr}),b[U]=$),ct=$.getStroke(),ct.setLineCap(V(O,"layout","line-cap",C,d,M)),ct.setLineJoin(V(O,"layout","line-join",C,d,M)),ct.setMiterLimit(V(O,"layout","line-miter-limit",C,d,M)),ct.setColor(Be),ct.setWidth(Ge),ct.setLineDash(Se["line-dasharray"]?V(O,"paint","line-dasharray",C,d,M).map(function(De){return De*Ge}):null),$.setZIndex(Tr))}let _n=!1,_e=null,Ku=0,bn,ht,$o;if((z==1||z==2)&&"icon-image"in Ie){const Ge=V(O,"layout","icon-image",C,d,M);if(Ge){bn=typeof Ge=="string"?_a(Ge,P):Ge.toString();let De;const Ce=a?a(r,bn):void 0,Re=zh(bn,l);if(i&&i[bn]&&Re||Ce){const We=V(O,"layout","icon-rotation-alignment",C,d,M);if(z==2){const fe=x.getGeometry();if(fe.getFlatMidpoint||fe.getFlatMidpoints){const be=fe.getExtent();if(Math.sqrt(Math.max(Math.pow((be[2]-be[0])/E,2),Math.pow((be[3]-be[1])/E,2)))>150){const tt=fe.getType()==="MultiLineString"?fe.getFlatMidpoints():fe.getFlatMidpoint();if(ya||(ys=[NaN,NaN],ya=new af("Point",ys,[],2,{},void 0)),De=ya,ys[0]=tt[0],ys[1]=tt[1],V(O,"layout","symbol-placement",C,d,M)==="line"&&We==="map"){const Ut=fe.getStride(),ft=fe.getFlatCoordinates();for(let xt=0,$e=ft.length-Ut;xt<$e;xt+=Ut){const ot=ft[xt],Lt=ft[xt+1],je=ft[xt+Ut],Rr=ft[xt+Ut+1],sg=Math.min(ot,je),og=Math.max(ot,je),Vo=tt[0],ag=tt[1],lg=(Rr-Lt)*(Vo-ot)-(je-ot)*(ag-Lt);if(Math.abs(lg)<.001&&Vo<=og&&Vo>=sg){Ku=Math.atan2(Lt-Rr,je-ot);break}}}}}}if(z!==2||De){const fe=V(O,"layout","icon-size",C,d,M),be=Se["icon-color"]!==void 0?V(O,"paint","icon-color",C,d,M):null;if(!be||be.a!==0){const Ye=V(O,"paint","icon-halo-color",C,d,M),tt=V(O,"paint","icon-halo-width",C,d,M);let Yt=`${bn}.${fe}.${tt}.${Ye}`;if(be!==null&&(Yt+=`.${be}`),ht=f[Yt],!ht){const Ut=Gh(O,C,"icon",d);let ft;"icon-offset"in Ie&&(ft=V(O,"layout","icon-offset",C,d,M).slice(0),ft[0]*=fe,ft[1]*=-fe);let xt=be?[be.r*255,be.g*255,be.b*255,be.a]:void 0;if(Ce){const $e={color:xt,rotateWithView:We==="map",displacement:ft,declutterMode:Ut,scale:fe};typeof Ce=="string"?$e.src=Ce:($e.img=Ce,$e.imgSize=[Ce.width,Ce.height]),ht=new oc($e)}else{const $e=i[bn];let ot,Lt,je;if(tt)$e.sdf?(ot=Dh(Uh(Re.image,$e,be||[0,0,0,1]),{x:0,y:0,width:$e.width,height:$e.height,pixelRatio:$e.pixelRatio},tt,Ye),xt=void 0):ot=Dh(Re.image,$e,tt,Ye);else{if($e.sdf&&!Re.unSDFed){const Rr=Uh(Re.image,{x:0,y:0,width:Re.size[0],height:Re.size[1]},{r:1,g:1,b:1});Re.image=Rr,Re.unSDFed=!0}ot=Re.image,Lt=[$e.width,$e.height],je=[$e.x,$e.y]}ht=new oc({color:xt,img:ot,imgSize:Re.size,size:Lt,offset:je,rotateWithView:We==="map",scale:fe/$e.pixelRatio,displacement:ft,declutterMode:Ut})}f[Yt]=ht}}ht&&(++U,$=b[U],(!$||!$.getImage()||$.getFill()||$.getStroke())&&($=new nr,b[U]=$),$.setGeometry(De),ht.setRotation(Ku+ga(V(O,"layout","icon-rotate",C,d,M))),ht.setOpacity(V(O,"paint","icon-opacity",C,d,M)),ht.setAnchor(mT[V(O,"layout","icon-anchor",C,d,M)]),$.setImage(ht),_e=$.getText(),$.setText(void 0),$.setZIndex(Tr),_n=!0,$o=!1)}else $o=!0}}}if(z==1&&O.type==="circle"){++U,$=b[U],(!$||!$.getImage()||$.getFill()||$.getStroke())&&($=new nr,b[U]=$);const Ge="circle-radius"in Se?V(O,"paint","circle-radius",C,d,M):5,De=Cr(V(O,"paint","circle-stroke-color",C,d,M),V(O,"paint","circle-stroke-opacity",C,d,M)),Ce=V(O,"paint","circle-translate",C,d,M),Re=Cr(V(O,"paint","circle-color",C,d,M),V(O,"paint","circle-opacity",C,d,M)),We=V(O,"paint","circle-stroke-width",C,d,M),fe=Ge+"."+De+"."+Re+"."+We+"."+Ce[0]+"."+Ce[1];ht=f[fe],ht||(ht=new Ef({radius:Ge,displacement:[Ce[0],-Ce[1]],stroke:De&&We>0?new Mr({width:We,color:De}):void 0,fill:Re?new Or({color:Re}):void 0,declutterMode:"none"}),f[fe]=ht),$.setImage(ht),_e=$.getText(),$.setText(void 0),$.setGeometry(void 0),$.setZIndex(Tr),_n=!0}let et,ai,li,Sr,ui,jo;if("text-field"in Ie){Sr=Math.round(V(O,"layout","text-size",C,d,M));const Ge=V(O,"layout","text-font",C,d,M);li=V(O,"layout","text-line-height",C,d,M),ai=sl(o?o(Ge,e.metadata?e.metadata["ol:webfonts"]:void 0):Ge,Sr,li),ai.includes("sans-serif")||(ai+=",sans-serif"),ui=V(O,"layout","text-letter-spacing",C,d,M),jo=V(O,"layout","text-max-width",C,d,M);const De=V(O,"layout","text-field",C,d,M);typeof De=="object"&&De.sections?De.sections.length===1?et=De.toString():et=De.sections.reduce((Ce,Re,We)=>{const fe=Re.fontStack?Re.fontStack.split(","):Ge,be=sl(o?o(fe):fe,Sr*(Re.scale||1),li);let Ye=Re.text;if(Ye===`
`)return Ce.push(`
`,""),Ce;if(z==2)return Ce.push(ol(Ye,ui),be),Ce;Ye=al(Ye,be,jo,ui).split(`
`);for(let tt=0,Yt=Ye.length;tt<Yt;++tt)tt>0&&Ce.push(`
`,""),Ce.push(Ye[tt],be);return Ce},[]):et=_a(De,P).trim(),He=V(O,"paint","text-opacity",C,d,M)}if(et&&He&&!$o){_n||(++U,$=b[U],(!$||!$.getText()||$.getFill()||$.getStroke())&&($=new nr,b[U]=$),$.setImage(void 0),$.setGeometry(void 0));const Ge=Gh(O,C,"text",d);$.getText()||$.setText(_e),_e=$.getText(),(!_e||"getDeclutterMode"in _e&&_e.getDeclutterMode()!==Ge)&&(_e=new Ia({padding:[2,2,2,2],declutterMode:Ge}),$.setText(_e));const De=V(O,"layout","text-transform",C,d,M);De=="uppercase"?et=Array.isArray(et)?et.map((je,Rr)=>Rr%2?je:je.toUpperCase()):et.toUpperCase():De=="lowercase"&&(et=Array.isArray(et)?et.map((je,Rr)=>Rr%2?je:je.toLowerCase()):et.toLowerCase());const Ce=Array.isArray(et)?et:z==2?ol(et,ui):al(et,ai,jo,ui);if(_e.setText(Ce),_e.setFont(ai),_e.setRotation(ga(V(O,"layout","text-rotate",C,d,M))),typeof _e.setKeepUpright=="function"){const je=V(O,"layout","text-keep-upright",C,d,M);_e.setKeepUpright(je)}const Re=V(O,"layout","text-anchor",C,d,M),We=_n||z==1?"point":V(O,"layout","symbol-placement",C,d,M);let fe;if(We==="line-center"?(_e.setPlacement("line"),fe="center"):_e.setPlacement(We),We==="line"&&typeof _e.setRepeat=="function"){const je=V(O,"layout","symbol-spacing",C,d,M);_e.setRepeat(je*2)}_e.setOverflow(We==="point");let be=V(O,"paint","text-halo-width",C,d,M);const Ye=V(O,"layout","text-offset",C,d,M),tt=V(O,"paint","text-translate",C,d,M);let Yt=0,Ut=0;if(We=="point"){fe="center",Re.indexOf("left")!==-1?(fe="left",Ut=be):Re.indexOf("right")!==-1&&(fe="right",Ut=-be);const je=V(O,"layout","text-rotation-alignment",C,d,M);_e.setRotateWithView(je=="map")}else _e.setMaxAngle(ga(V(O,"layout","text-max-angle",C,d,M))*et.length/Ce.length),_e.setRotateWithView(!1);_e.setTextAlign(fe);let ft="middle";Re.indexOf("bottom")==0?(ft="bottom",Yt=-be-.5*(li-1)*Sr):Re.indexOf("top")==0&&(ft="top",Yt=be+.5*(li-1)*Sr),_e.setTextBaseline(ft);const xt=V(O,"layout","text-justify",C,d,M);_e.setJustify(xt==="auto"?void 0:xt),_e.setOffsetX(Ye[0]*Sr+Ut+tt[0]),_e.setOffsetY(Ye[1]*Sr+Yt+tt[1]),_.setColor(Cr(V(O,"paint","text-color",C,d,M),He)),_e.setFill(_);const $e=Cr(V(O,"paint","text-halo-color",C,d,M),He);if($e&&be>0){y.setColor($e),be*=2;const je=.5*Sr;y.setWidth(be<=je?be:je),_e.setStroke(y)}else _e.setStroke(void 0);const ot=V(O,"layout","text-padding",C,d,M),Lt=_e.getPadding();ot!==Lt[0]&&(Lt[0]=ot,Lt[1]=ot,Lt[2]=ot,Lt[3]=ot),$.setZIndex(Tr)}}}if(U>-1)return b.length=U+1,b};return r.setStyle(w),r.set("mapbox-layers",h),r.set("mapbox-source",m),r.set("mapbox-featurestate",r.get("mapbox-featurestate")||{}),w}function jp(r){return function(e){const t=e.buffers,n=e.meta,i=e.imageOps,s=e.width,o=e.height,a=t.length,l=t[0].byteLength;if(i){const f=new Array(a);for(let d=0;d<a;++d)f[d]=new ImageData(new Uint8ClampedArray(t[d]),s,o);return r(f,n).data.buffer}const u=new Uint8ClampedArray(l),c=new Array(a),h=new Array(a);for(let f=0;f<a;++f)c[f]=new Uint8ClampedArray(t[f]),h[f]=[0,0,0,0];for(let f=0;f<l;f+=4){for(let d=0;d<a;++d){const g=c[d];h[d][0]=g[f],h[d][1]=g[f+1],h[d][2]=g[f+2],h[d][3]=g[f+3]}const p=r(h,n);u[f]=p[0],u[f+1]=p[1],u[f+2]=p[2],u[f+3]=p[3]}return u.buffer}}function wT(r,e){const n=Object.keys(r.lib||{}).map(function(s){return"const "+s+" = "+r.lib[s].toString()+";"}).concat(["const __minion__ = ("+jp.toString()+")(",r.operation.toString(),");",'self.addEventListener("message", function(event) {',"  const buffer = __minion__(event.data);","  self.postMessage({buffer: buffer, meta: event.data.meta}, [buffer]);","});"]),i=new Worker(typeof Blob>"u"?"data:text/javascript;base64,"+Buffer.from(n.join(`
`),"binary").toString("base64"):URL.createObjectURL(new Blob(n,{type:"text/javascript"})));return i.addEventListener("message",e),i}function vT(r,e){const t=jp(r.operation);let n=!1;return{postMessage:function(i){setTimeout(function(){n||e({data:{buffer:t(i),meta:i.meta}})},0)},terminate:function(){n=!0}}}class TT extends df{constructor(e){super(),this.imageOps_=!!e.imageOps;let t;e.threads===0?t=0:this.imageOps_?t=1:t=e.threads||1;const n=new Array(t);if(t)for(let i=0;i<t;++i)n[i]=wT(e,this.onWorkerMessage_.bind(this,i));else n[0]=vT(e,this.onWorkerMessage_.bind(this,0));this.workers_=n,this.queue_=[],this.maxQueueLength_=e.queue||1/0,this.running_=0,this.dataLookup_={},this.job_=null}process(e,t,n){this.enqueue_({inputs:e,meta:t,callback:n}),this.dispatch_()}enqueue_(e){for(this.queue_.push(e);this.queue_.length>this.maxQueueLength_;)this.queue_.shift().callback(null,null)}dispatch_(){if(this.running_||this.queue_.length===0)return;const e=this.queue_.shift();this.job_=e;const t=e.inputs[0].width,n=e.inputs[0].height,i=e.inputs.map(function(l){return l.data.buffer}),s=this.workers_.length;if(this.running_=s,s===1){this.workers_[0].postMessage({buffers:i,meta:e.meta,imageOps:this.imageOps_,width:t,height:n},i);return}const o=e.inputs[0].data.length,a=4*Math.ceil(o/4/s);for(let l=0;l<s;++l){const u=l*a,c=[];for(let h=0,f=i.length;h<f;++h)c.push(i[h].slice(u,u+a));this.workers_[l].postMessage({buffers:c,meta:e.meta,imageOps:this.imageOps_,width:t,height:n},c)}}onWorkerMessage_(e,t){this.disposed||(this.dataLookup_[e]=t.data,--this.running_,this.running_===0&&this.resolveJob_())}resolveJob_(){const e=this.job_,t=this.workers_.length;let n,i;if(t===1)n=new Uint8ClampedArray(this.dataLookup_[0].buffer),i=this.dataLookup_[0].meta;else{const s=e.inputs[0].data.length;n=new Uint8ClampedArray(s),i=new Array(t);const o=4*Math.ceil(s/4/t);for(let a=0;a<t;++a){const l=this.dataLookup_[a].buffer,u=a*o;n.set(new Uint8ClampedArray(l),u),i[a]=this.dataLookup_[a].meta}}this.job_=null,this.dataLookup_={},e.callback(null,new ImageData(n,e.inputs[0].width,e.inputs[0].height),i),this.dispatch_()}disposeInternal(){for(let e=0;e<this.workers_.length;++e)this.workers_[e].terminate();this.workers_.length=0}}const kh={BEFOREOPERATIONS:"beforeoperations",AFTEROPERATIONS:"afteroperations"};class $h extends gf{constructor(e,t,n){super(e),this.extent=t.extent,this.resolution=t.viewState.resolution/t.pixelRatio,this.data=n}}class Vp extends Hn{constructor(e){super({projection:null}),this.on,this.once,this.un,this.processor_=null,this.operationType_=e.operationType!==void 0?e.operationType:"pixel",this.threads_=e.threads!==void 0?e.threads:1,this.layers_=PT(e.sources);const t=this.changed.bind(this);for(let n=0,i=this.layers_.length;n<i;++n)this.layers_[n].addEventListener(gt.CHANGE,t);this.useResolutions_=e.resolutions!==null,this.tileQueue_=new bm(function(){return 1},this.processSources_.bind(this)),this.requestedFrameState_,this.renderedImageCanvas_=null,this.renderedRevision_,this.frameState_={animate:!1,coordinateToPixelTransform:Qe(),declutter:null,extent:null,index:0,layerIndex:0,layerStatesArray:RT(this.layers_),pixelRatio:1,pixelToCoordinateTransform:Qe(),postRenderFunctions:[],size:[0,0],tileQueue:this.tileQueue_,time:Date.now(),usedTiles:{},viewState:{rotation:0},viewHints:[],wantedTiles:{},mapId:me(this),renderTargets:{}},this.setAttributions(function(n){var s;const i=[];for(let o=0,a=e.sources.length;o<a;++o){const l=e.sources[o],u=l instanceof Il?l:l.getSource();if(!u)continue;const c=(s=u.getAttributions())==null?void 0:s(n);typeof c=="string"?i.push(c):c!==void 0&&i.push(...c)}return i}),e.operation!==void 0&&this.setOperation(e.operation,e.lib)}setOperation(e,t){this.processor_&&this.processor_.dispose(),this.processor_=new TT({operation:e,imageOps:this.operationType_==="image",queue:1,lib:t,threads:this.threads_}),this.changed()}updateFrameState_(e,t,n){const i=Object.assign({},this.frameState_);i.viewState=Object.assign({},i.viewState);const s=Xt(e);i.size[0]=Math.ceil(nt(e)/t),i.size[1]=Math.ceil(Zt(e)/t),i.extent=[s[0]-i.size[0]*t/2,s[1]-i.size[1]*t/2,s[0]+i.size[0]*t/2,s[1]+i.size[1]*t/2],i.time=Date.now();const o=i.viewState;return o.center=s,o.projection=n,o.resolution=t,i}allSourcesReady_(){let e=!0,t;for(let n=0,i=this.layers_.length;n<i;++n)if(t=this.layers_[n].getSource(),!t||t.getState()!=="ready"){e=!1;break}return e}getImage(e,t,n,i){if(!this.allSourcesReady_())return null;this.tileQueue_.loadMoreTiles(16,16),t=this.findNearestResolution(t);const s=this.updateFrameState_(e,t,i);if(this.requestedFrameState_=s,this.renderedImageCanvas_){const o=this.renderedImageCanvas_.getResolution(),a=this.renderedImageCanvas_.getExtent();(t!==o||!Pi(s.extent,a))&&(this.renderedImageCanvas_=null)}return(!this.renderedImageCanvas_||this.getRevision()!==this.renderedRevision_)&&this.processSources_(),s.animate&&requestAnimationFrame(this.changed.bind(this)),this.renderedImageCanvas_}processSources_(){const e=this.requestedFrameState_,t=this.layers_.length,n=new Array(t);for(let s=0;s<t;++s){e.layerIndex=s,e.renderTargets={};const o=ST(this.layers_[s],e);if(o)n[s]=o;else return}const i={};this.dispatchEvent(new $h(kh.BEFOREOPERATIONS,e,i)),this.processor_.process(n,i,this.onWorkerComplete_.bind(this,e))}onWorkerComplete_(e,t,n,i){if(t||!n)return;const s=e.extent,o=e.viewState.resolution;if(o!==this.requestedFrameState_.viewState.resolution||!Pi(s,this.requestedFrameState_.extent))return;let a;if(this.renderedImageCanvas_)a=this.renderedImageCanvas_.getImage().getContext("2d");else{const l=Math.round(nt(s)/o),u=Math.round(Zt(s)/o);a=zr(l,u),this.renderedImageCanvas_=new Kl(s,o,1,a.canvas)}a.putImageData(n,0,0),e.animate?requestAnimationFrame(this.changed.bind(this)):this.changed(),this.renderedRevision_=this.getRevision(),this.dispatchEvent(new $h(kh.AFTEROPERATIONS,e,i))}getResolutions(e){if(!this.useResolutions_)return null;let t=super.getResolutions();if(!t)for(let n=0,i=this.layers_.length;n<i&&(t=this.layers_[n].getSource().getResolutions(e),!t);++n);return t}disposeInternal(){this.processor_&&this.processor_.dispose(),super.disposeInternal()}}Vp.prototype.dispose;let Hr=null;function ST(r,e){const t=r.getRenderer();if(!t)throw new Error("Unsupported layer type: "+r);if(!t.prepareFrame(e))return null;const n=e.size[0],i=e.size[1];if(n===0||i===0)return null;const s=t.renderFrame(e,null);let o;if(s instanceof HTMLCanvasElement)o=s;else{if(s&&(o=s.firstElementChild),!(o instanceof HTMLCanvasElement))throw new Error("Unsupported rendered element: "+o);if(o.width===n&&o.height===i)return o.getContext("2d").getImageData(0,0,n,i)}if(!Hr)Hr=zr(n,i,void 0,{willReadFrequently:!0});else{const a=Hr.canvas;a.width!==n||a.height!==i?Hr=zr(n,i,void 0,{willReadFrequently:!0}):Hr.clearRect(0,0,n,i)}return Hr.drawImage(o,0,0,n,i),Hr.getImageData(0,0,n,i)}function RT(r){return r.map(function(e){return e.getLayerState()})}function PT(r){const e=r.length,t=new Array(e);for(let n=0;n<e;++n)t[n]=AT(r[n]);return t}function AT(r){let e;return r instanceof Il?r instanceof Rl?e=new Os({source:r}):r instanceof Hn&&(e=new Al({source:r})):e=r,e}function IT(r,e){const t=r[0],n=t.width,i=t.height,s=t.data,o=new Uint8ClampedArray(s.length),a=e.resolution*2,l=n-1,u=i-1,c=[0,0,0,0],h=2*Math.PI,f=Math.PI/2,p=Math.PI*e.sunEl/180,d=Math.PI*e.sunAz/180,g=Math.cos(p),m=Math.sin(p),y=e.highlightColor,_=e.shadowColor,b=e.accentColor,w=e.encoding;let x,E,v,A,P,S,I,N,z,X,C,M,U,se,H,Y,le,Te,K,O,Le,Ie;function Se(st,Be="mapbox"){if(Be==="mapbox")return(st[0]*256*256+st[1]*256+st[2])*.1-1e4;if(Be==="terrarium")return st[0]*256+st[1]+st[2]/256-32768}for(E=0;E<=u;++E)for(P=E===0?0:E-1,S=E===u?u:E+1,x=0;x<=l;++x)v=x===0?0:x-1,A=x===l?l:x+1,I=(E*n+v)*4,c[0]=s[I],c[1]=s[I+1],c[2]=s[I+2],c[3]=s[I+3],N=e.vert*Se(c,w),I=(E*n+A)*4,c[0]=s[I],c[1]=s[I+1],c[2]=s[I+2],c[3]=s[I+3],z=e.vert*Se(c,w),X=(z-N)/a,I=(P*n+x)*4,c[0]=s[I],c[1]=s[I+1],c[2]=s[I+2],c[3]=s[I+3],N=e.vert*Se(c,w),I=(S*n+x)*4,c[0]=s[I],c[1]=s[I+1],c[2]=s[I+2],c[3]=s[I+3],z=e.vert*Se(c,w),C=(z-N)/a,U=Math.atan2(C,-X),U<0?U=f-U:U>f?U=h-U+f:U=f-U,M=Math.atan(Math.sqrt(X*X+C*C)),Ie=m*Math.cos(M)+g*Math.sin(M)*Math.cos(d-U),se=Math.cos(M),H=255*Ie,K=Math.min(Math.max(2*e.sunEl,0),1),O=1.875-e.opacity*1.75,Le=e.opacity!==.5?f*((Math.pow(O,M)-1)/(Math.pow(O,f)-1)):M,le={r:(1-se)*b.r*K*255,g:(1-se)*b.g*K*255,b:(1-se)*b.b*K*255,a:(1-se)*b.a*K*255},Y=Math.abs(((U+d)/Math.PI+.5)%2-1),Te={r:(y.r*(1-Y)+_.r*Y)*H,g:(y.g*(1-Y)+_.g*Y)*H,b:(y.b*(1-Y)+_.b*Y)*H,a:(y.a*(1-Y)+_.a*Y)*H},I=(E*n+x)*4,o[I]=le.r*(1-Y)+Te.r,o[I+1]=le.g*(1-Y)+Te.g,o[I+2]=le.b*(1-Y)+Te.b,o[I+3]=s[I+3]*e.opacity*K*Math.sin(Le);return new ImageData(o,n,i)}function CT(r,e=512){return r.getExtent()?jr({extent:r.getExtent(),tileSize:e,maxZoom:22}).getResolutions():cr}function Xp(r,e){return e.accessToken||(e=Object.assign({},e),new URL(r).searchParams.forEach((n,i)=>{e.accessToken=n,e.accessTokenParam=i})),e}function LT(r,e,t="",n={},i=void 0){let s,o,a,l,u=!0;return typeof t!="string"&&!Array.isArray(t)?(a=t,l=a.source||a.layers,n=a):l=t,typeof n=="string"?(s=n,a={}):(s=n.styleUrl,a=n),a.updateSource===!1&&(u=!1),i||(i=a.resolutions),!s&&typeof e=="string"&&!e.trim().startsWith("{")&&(s=e),s&&(s=s.startsWith("data:")?location.href:Ks(s,a.accessToken),a=Xp(s,a)),new Promise(function(c,h){zp(e,a).then(function(f){if(f.version!=8)return h(new Error("glStyle version 8 required."));if(!(r instanceof Vi||r instanceof Mn))return h(new Error("Can only apply to VectorLayer or VectorTileLayer"));const p=r instanceof Mn?"vector":"geojson";if(l?Array.isArray(l)?o=f.layers.find(function(w){return w.id===l[0]}).source:o=l:(o=f.layers.find(function(w){return w.source&&f.sources[w.source].type===p}).source,l=o),!o)return h(new Error(`No ${p} source found in the glStyle.`));function d(){if(!u)return Promise.resolve();if(r instanceof Mn)return qp(f.sources[o],s,a).then(function(v){const A=r.getSource();A?v!==A&&(A.setTileUrlFunction(v.getTileUrlFunction()),typeof A.setUrls=="function"&&typeof v.getUrls=="function"&&A.setUrls(v.getUrls()),A.format_||(A.format_=v.format_),A.getAttributions()||A.setAttributions(v.getAttributions()),A.getTileLoadFunction()===wm&&A.setTileLoadFunction(v.getTileLoadFunction()),bi(A.getProjection(),v.getProjection())&&(A.tileGrid=v.getTileGrid())):r.setSource(v);const P=r.getSource().getTileGrid();!isFinite(r.getMaxResolution())&&!isFinite(r.getMinZoom())&&P.getMinZoom()>0&&r.setMaxResolution(yi(Math.max(0,P.getMinZoom()-1e-12),P.getResolutions()))});const w=f.sources[o];let x=r.getSource();(!x||x.get("mapbox-source")!==w)&&(x=Kp(w,s,a));const E=r.getSource();return E?x!==E&&(E.getAttributions()||E.setAttributions(x.getAttributions()),E.format_||(E.format_=x.getFormat()),E.url_=x.getUrl()):r.setSource(x),Promise.resolve()}let g,m;const y={},_={};function b(){if(!m&&(!f.sprite||y)){if(a.projection&&!i){const v=ce(a.projection).getUnits();v!=="m"&&(i=cr.map(A=>A/Pa[v]))}let w;const x=r.getSource();x instanceof Yn&&x.format_ instanceof Pl&&(w=x.format_.layerName_),m=ET(r,f,l,i,y,_,(E,v=a.webfonts)=>pT(E,v),a.getImage,w),r.getStyle()?d().then(c).catch(h):h(new Error(`Nothing to show for source [${o}]`))}else m?(r.setStyle(m),d().then(c).catch(h)):h(new Error("Something went wrong trying to apply style."))}if(f.sprite){const w=oT(f.sprite,a.accessToken,s||location.href);g=Zi?1:window.devicePixelRatio>=1.5?.5:1;const x=g==.5?"@2x":"";Promise.all(w.map(function(E){const v=new URL(E.url);let A=v.origin+v.pathname+x+".json"+v.search;return new Promise(function(P,S){Xn("Sprite",A,a).then(P).catch(function(I){A=v.origin+v.pathname+".json"+v.search,Xn("Sprite",A,a).then(P).catch(S)})}).then(function(P){P===void 0&&h(new Error("No sprites found."));let S;if(S=v.origin+v.pathname+x+".png"+v.search,a.transformRequest){const I=a.transformRequest(S,"SpriteImage")||S;(I instanceof Request||I instanceof Promise)&&(S=I)}_[E.id]=S;for(const I in P){const N=E.id=="default"?I:`${E.id}:${I}`;y[N]=P[I]}}).catch(function(P){h(new Error(`Sprites cannot be loaded: ${A}: ${P.message}`))})})).then(b).catch(h)}else b()}).catch(h)})}function Zp(r,e){let t;return r.some(function(n){if(n.id==e)return t=n.source,!0}),t}function FT(r,e){const t=r.bounds;if(t){const n=Aa([t[0],t[1]],e),i=Aa([t[2],t[3]],e);return[n[0],n[1],i[0],i[1]]}return ce(e).getExtent()}function Wp(r,e,t){const n=new Ql({tileJSON:e,tileSize:r.tileSize||e.tileSize||512}),i=n.getTileJSON(),s=n.getTileGrid(),o=ce(t.projection||"EPSG:3857"),a=FT(i,o),l=o.getExtent(),u=i.minzoom||0,c=i.maxzoom||22,h={attributions:n.getAttributions(),projection:o,tileGrid:new Kn({origin:l?As(l):s.getOrigin(0),extent:a||s.getExtent(),minZoom:u,resolutions:CT(o,e.tileSize).slice(0,c+1),tileSize:s.getTileSize(0)})};return Array.isArray(i.tiles)?h.urls=i.tiles:h.url=i.tiles,h}function MT(r,e,t,n){const i={id:r.id,type:r.type},s=r.layout||{},o=r.paint||{};i.paint=o,It.zoom=Xu(e,t.resolutions||cr),It.distanceFromCenter=0;let a;const l=V(i,"paint","background-color",kt,n);return o["background-opacity"]!==void 0&&(a=V(i,"paint","background-opacity",kt,n)),s.visibility=="none"?void 0:Cr(l,a)}function OT(r,e,t){const n=Zi?{style:{}}:document.createElement("div");return n.className="ol-mapbox-style-background",n.style.position="absolute",n.style.width="100%",n.style.height="100%",new Tl({source:new Il({}),render(i){const s=MT(r,i.viewState.resolution,e,t);return n.style.backgroundColor=s,n}})}function qp(r,e,t){return new Promise(function(n,i){kp(r,e,t).then(function({tileJson:s,tileLoadFunction:o}){const a=Wp(r,s,t);a.tileLoadFunction=o,a.format=new Pl({layerName:"mvt:layer"});const l=new Yn(a);l.set("mapbox-source",r),n(l)}).catch(i)})}function NT(r,e,t){const n=new Mn({declutter:!0,visible:!1});return qp(r,e,t).then(function(i){n.setSource(i)}).catch(function(i){n.setSource(void 0)}),n}function Hp(r){return`{bbox-${(r?r.getCode():"EPSG:3857").toLowerCase().replace(/[^a-z0-9]/g,"-")}}`}function DT(r,e,t){return new Promise(function(n,i){kp(r,e,t).then(function({tileJson:s,tileLoadFunction:o}){const a=new Ql({interpolate:t.interpolate===void 0?!0:t.interpolate,transition:0,crossOrigin:"anonymous",tileJSON:s});a.tileGrid=Wp(r,s,t).tileGrid,t.projection&&(a.projection=ce(t.projection));const l=a.getTileUrlFunction();o&&a.setTileLoadFunction(o),a.setTileUrlFunction(function(u,c,h){const f=Hp(h);let p=l(u,c,h);if(p.indexOf(f)!=-1){const d=a.getTileGrid().getTileCoordExtent(u);p=p.replace(f,d.toString())}return p}),a.set("mapbox-source",r),n(a)}).catch(function(s){i(s)})})}function Yp(r,e,t){const n=new Os;return DT(r,e,t).then(function(i){n.setSource(i)}).catch(function(){n.setSource(void 0)}),n}function UT(r,e,t){const n=Yp(r,e,t);return new Al({source:new Vp({operationType:"image",operation:IT,sources:[n]})})}function Kp(r,e,t){const n=t.projection?new Ra({dataProjection:t.projection}):new Ra,i=r.data,s={};if(typeof i=="string"){const[a]=vs(i,t.accessToken,t.accessTokenParam||"access_token",e||location.href);if(/\{bbox-[0-9a-z-]+\}/.test(a)){const u=(h,f,p)=>{const d=Hp(p);return a.replace(d,`${h.join(",")}`)},c=new en({attributions:r.attribution,format:n,loader:(h,f,p,d,g)=>{const m=typeof u=="function"?u(h,f,p):u;Xn("GeoJSON",m,t).then(y=>{const _=c.getFormat().readFeatures(y,{featureProjection:p});c.addFeatures(_),d(_)}).catch(y=>{c.removeLoadedExtent(h),g()})},strategy:Em});return c.set("mapbox-source",r),c}const l=new en({attributions:r.attribution,format:n,url:a,loader:(u,c,h,f,p)=>{Xn("GeoJSON",a,t).then(d=>{const g=l.getFormat().readFeatures(d,{featureProjection:h});l.addFeatures(g),f(g)}).catch(d=>{l.removeLoadedExtent(u),p()})}});return l}s.features=n.readFeatures(i,{featureProjection:"EPSG:3857"});const o=new en(Object.assign({attributions:r.attribution,format:n},s));return o.set("mapbox-source",r),o}function BT(r,e,t){return new Vi({declutter:!0,source:Kp(r,e,t),visible:!1})}function GT(r,e,t){let n=null;return function(i){r.paint&&"raster-opacity"in r.paint&&i.frameState.viewState.zoom!==n&&(n=i.frameState.viewState.zoom,delete t[r.id],zT(r,e,n,t))}}function zT(r,e,t,n){It.zoom=t,It.distanceFromCenter=0;const i=V(r,"paint","raster-opacity",kt,n);e.setOpacity(i)}function kT(r,e){function t(){const n=e.get("mapbox-style");if(!n)return;const i=pp(n.layers),s=r.get("mapbox-layers"),o=i.filter(function(a){return s.includes(a.id)}).some(function(a){return!a.layout||!a.layout.visibility||a.layout.visibility==="visible"});r.get("visible")!==o&&r.setVisible(o)}r.on("change",t),t()}function $T(r,e,t,n){const i=Gp(r),s=r.layers,o=t.type,a=t.source||Zp(s,t.ref),l=r.sources[a];let u;if(o=="background")u=OT(t,n,i);else if(l.type=="vector")u=NT(l,e,n);else if(l.type=="raster")u=Yp(l,e,n),u.setVisible(t.layout?t.layout.visibility!=="none":!0),u.on("prerender",GT(t,u,i));else if(l.type=="geojson")u=BT(l,e,n);else if(l.type=="raster-dem"&&t.type=="hillshade"){const h=UT(l,e,n);u=h,h.getSource().on("beforeoperations",function(f){const p=f.data;p.resolution=vg(n.projection||"EPSG:3857",f.resolution,Xt(f.extent),"m"),It.zoom=Xu(f.resolution,n.resolutions||cr),It.distanceFromCenter=0,p.encoding=l.encoding,p.vert=5*V(t,"paint","hillshade-exaggeration",kt,i),p.sunAz=V(t,"paint","hillshade-illumination-direction",kt,i),p.sunEl=35,p.opacity=.3,p.highlightColor=V(t,"paint","hillshade-highlight-color",kt,i),p.shadowColor=V(t,"paint","hillshade-shadow-color",kt,i),p.accentColor=V(t,"paint","hillshade-accent-color",kt,i)}),u.setVisible(t.layout?t.layout.visibility!=="none":!0)}const c=a;return u&&u.set("mapbox-source",c),u}function jh(r,e,t,n){const i=[];let s=null;if(e instanceof Ns){if(s=e.getView(),!s.isDef()&&!s.getRotation()&&!s.getResolutions()){const h=n.projection?ce(n.projection):s.getProjection();s=new xm(Object.assign(s.getProperties(),{maxResolution:cr[0]/Pa[h.getUnits()],projection:n.projection||s.getProjection()})),e.setView(s)}"center"in r&&!s.getCenter()&&s.setCenter(Aa(r.center,s.getProjection())),"zoom"in r&&s.getZoom()===void 0&&s.setResolution(cr[0]/Pa[s.getProjection().getUnits()]/Math.pow(2,r.zoom)),(!s.getCenter()||s.getZoom()===void 0)&&s.fit(s.getProjection().getExtent(),{nearest:!0,size:e.getSize()})}e.set("mapbox-style",r),e.set("mapbox-metadata",{styleUrl:t,options:n});const o=r.layers;let a=[],l,u,c;for(let h=0,f=o.length;h<f;++h){const p=o[h],d=p.type;if(d=="heatmap"){console.debug(`layers[${h}].type "${d}" not supported`);continue}else c=p.source||Zp(o,p.ref),(!c||c!=u)&&(a.length&&(i.push(Vh(l,a,r,t,e,n)),a=[]),l=$T(r,t,p,n),l instanceof Vi||l instanceof Mn||(a=[]),u=l.get("mapbox-source")),a.push(p.id)}return i.push(Vh(l,a,r,t,e,n)),Promise.all(i)}function IR(r,e,t={}){let n,i;if(Zi){if(!(r instanceof Ns)&&!(r instanceof Af))throw new Error("ol-mapbox-style in a web worker requires a Map or a LayerGroup as first argument");i=r}else typeof r=="string"||r instanceof HTMLElement?i=new Ns({target:r}):i=r;if(typeof e=="string"){const s=e.startsWith("data:")?location.href:Ks(e,t.accessToken);t=Xp(s,t),n=new Promise(function(o,a){zp(e,t).then(function(l){jh(l,i,s,t).then(function(){o(i)}).catch(a)}).catch(function(l){a(new Error(`Could not load ${e}: ${l.message}`))})})}else n=new Promise(function(s,o){jh(e,i,!t.styleUrl||t.styleUrl.startsWith("data:")?location.href:Ks(t.styleUrl,t.accessToken),t).then(function(){s(i)}).catch(o)});return n}function Vh(r,e,t,n,i,s={}){let o=24,a=0;const l=t.layers;for(let u=0,c=l.length;u<c;++u){const h=l[u];e.indexOf(h.id)!==-1&&(o=Math.min("minzoom"in h?h.minzoom:0,o),a=Math.max("maxzoom"in h?h.maxzoom:24,a))}return new Promise(function(u,c){const h=function(){const p=r.getSource();if(!p||p.getState()==="error"){c(new Error("Error accessing data for source "+r.get("mapbox-source")));return}if("getTileGrid"in p){const d=p.getTileGrid();if(d){const g=d.getMinZoom();(o>0||g>0)&&r.setMaxResolution(Math.min(yi(Math.max(0,o-1e-12),cr),yi(Math.max(0,g-1e-12),d.getResolutions()))),a<24&&r.setMinResolution(yi(a,cr))}}else o>0&&r.setMaxResolution(yi(Math.max(0,o-1e-12),cr));p instanceof en||p instanceof Yn?LT(r,t,e,Object.assign({styleUrl:n},s)).then(function(){kT(r,i),u()}).catch(c):u()};r.set("mapbox-layers",e);const f=i.getLayers();f.getArray().indexOf(r)===-1&&f.push(r),r.getSource()?h():r.once("change:source",h)})}function jT(r){const e=r[0],t=new Array(e);let n=1<<e-1,i,s;for(i=0;i<e;++i)s=48,r[1]&n&&(s+=1),r[2]&n&&(s+=2),t[i]=String.fromCharCode(s),n>>=1;return t.join("")}const VT='<a class="ol-attribution-bing-tos" href="https://www.microsoft.com/maps/product/terms.html" target="_blank">Terms of Use</a>';class CR extends gn{constructor(e){const t=e.hidpi!==void 0?e.hidpi:!1;super({cacheSize:e.cacheSize,crossOrigin:"anonymous",interpolate:e.interpolate,projection:ce("EPSG:3857"),reprojectionErrorThreshold:e.reprojectionErrorThreshold,state:"loading",tileLoadFunction:e.tileLoadFunction,tilePixelRatio:t?2:1,wrapX:e.wrapX!==void 0?e.wrapX:!0,transition:e.transition,zDirection:e.zDirection}),this.hidpi_=t,this.culture_=e.culture!==void 0?e.culture:"en-us",this.maxZoom_=e.maxZoom!==void 0?e.maxZoom:-1,this.apiKey_=e.key,this.imagerySet_=e.imagerySet,this.placeholderTiles_=e.placeholderTiles;const n=(e.url||"https://dev.virtualearth.net/REST/v1/Imagery/Metadata/")+this.imagerySet_+"?uriScheme=https&include=ImageryProviders&key="+this.apiKey_+"&c="+this.culture_;fetch(n).then(i=>i.json()).then(i=>this.handleImageryMetadataResponse(i))}getApiKey(){return this.apiKey_}getImagerySet(){return this.imagerySet_}handleImageryMetadataResponse(e){if(e.statusCode!=200||e.statusDescription!="OK"||e.authenticationResultCode!="ValidCredentials"||e.resourceSets.length!=1||e.resourceSets[0].resources.length!=1){this.setState("error");return}const t=e.resourceSets[0].resources[0],n=this.maxZoom_==-1?t.zoomMax:this.maxZoom_,i=this.getProjection(),s=mn(i),o=this.hidpi_?2:1,a=t.imageWidth==t.imageHeight?t.imageWidth/o:[t.imageWidth/o,t.imageHeight/o],l=jr({extent:s,minZoom:t.zoomMin,maxZoom:n,tileSize:a});this.tileGrid=l;const u=this.culture_,c=this.hidpi_,h=this.placeholderTiles_;if(this.tileUrlFunction=wf(t.imageUrlSubdomains.map(function(f){const p=[0,0,0],d=t.imageUrl.replace("{subdomain}",f).replace("{culture}",u);return function(g,m,y){if(!g)return;Fa(g[0],g[1],g[2],p);const _=new URL(d.replace("{quadkey}",jT(p))),b=_.searchParams;return c&&(b.set("dpi","d1"),b.set("device","mobile")),h===!0?b.delete("n"):h===!1&&b.set("n","z"),_.toString()}})),t.imageryProviders){const f=yl(ce("EPSG:4326"),this.getProjection());this.setAttributions(p=>{const d=[],g=p.viewState,m=this.getTileGrid(),y=m.getZForResolution(g.resolution,this.zDirection),b=m.getTileCoordForCoordAndZ(g.center,y)[0];return t.imageryProviders.map(function(w){let x=!1;const E=w.coverageAreas;for(let v=0,A=E.length;v<A;++v){const P=E[v];if(b>=P.zoomMin&&b<=P.zoomMax){const S=P.bbox,I=[S[1],S[0],S[3],S[2]],N=un(I,f);if(zn(N,p.extent)){x=!0;break}}}x&&d.push(w.attribution)}),d.push(VT),d})}this.setState("ready")}}class LR extends Ms{constructor(e){super({attributions:e.attributions,cacheSize:e.cacheSize,crossOrigin:e.crossOrigin,maxZoom:e.maxZoom!==void 0?e.maxZoom:18,minZoom:e.minZoom,projection:e.projection,transition:e.transition,wrapX:e.wrapX,zDirection:e.zDirection}),this.account_=e.account,this.mapId_=e.map||"",this.config_=e.config||{},this.templateCache_={},this.initializeMap_()}getConfig(){return this.config_}updateConfig(e){Object.assign(this.config_,e),this.initializeMap_()}setConfig(e){this.config_=e||{},this.initializeMap_()}initializeMap_(){const e=JSON.stringify(this.config_);if(this.templateCache_[e]){this.applyTemplate_(this.templateCache_[e]);return}let t="https://"+this.account_+".carto.com/api/v1/map";this.mapId_&&(t+="/named/"+this.mapId_);const n=new XMLHttpRequest;n.addEventListener("load",this.handleInitResponse_.bind(this,e)),n.addEventListener("error",this.handleInitError_.bind(this)),n.open("POST",t),n.setRequestHeader("Content-type","application/json"),n.send(JSON.stringify(this.config_))}handleInitResponse_(e,t){const n=t.target;if(!n.status||n.status>=200&&n.status<300){let i;try{i=JSON.parse(n.responseText)}catch{this.setState("error");return}this.applyTemplate_(i),this.templateCache_[e]=i,this.setState("ready")}else this.setState("error")}handleInitError_(e){this.setState("error")}applyTemplate_(e){const t="https://"+e.cdn_url.https+"/"+this.account_+"/api/v1/map/"+e.layergroupid+"/{z}/{x}/{y}.png";this.setUrl(t)}}function XT(r){return((r.fileDirectory.NewSubfileType||0)&4)===4}function ZT(r,e){if(!r)return!1;if(r===!0)return!0;if(e.getSamplesPerPixel()!==3)return!1;const t=e.fileDirectory.PhotometricInterpretation,n=dt;return t===n.CMYK||t===n.YCbCr||t===n.CIELab||t===n.ICCLab}const Xh="STATISTICS_MAXIMUM",Zh="STATISTICS_MINIMUM",ba=256;let xa;function WT(){return xa||(xa=new np),xa}function qT(r){try{return r.getBoundingBox(!0)}catch{return[0,0,r.getWidth(),r.getHeight()]}}function HT(r){try{return r.getOrigin().slice(0,2)}catch{return[0,r.getHeight()]}}function YT(r,e){try{return r.getResolution(e)}catch{return[e.getWidth()/r.getWidth(),e.getHeight()/r.getHeight()]}}function KT(r){const e=r.geoKeys;if(!e)return null;if(e.ProjectedCSTypeGeoKey&&e.ProjectedCSTypeGeoKey!==32767){const t="EPSG:"+e.ProjectedCSTypeGeoKey;let n=ce(t);if(!n){const i=Ta(e.ProjLinearUnitsGeoKey);i&&(n=new Sa({code:t,units:i}))}return n}if(e.GeographicTypeGeoKey&&e.GeographicTypeGeoKey!==32767){const t="EPSG:"+e.GeographicTypeGeoKey;let n=ce(t);if(!n){const i=Ta(e.GeogAngularUnitsGeoKey);i&&(n=new Sa({code:t,units:i}))}return n}return null}function JT(r){return r.getImageCount().then(function(e){const t=new Array(e);for(let n=0;n<e;++n)t[n]=r.getImage(n);return Promise.all(t)})}function QT(r,e){let t;return r.blob?t=ap(r.blob):r.overviews?t=lp(r.url,r.overviews,e):t=op(r.url,e),t.then(JT)}function _i(r,e,t,n,i){if(Array.isArray(r)){const s=r.length;if(!Array.isArray(e)||s!=e.length){const o=new Error(n);throw i(o),o}for(let o=0;o<s;++o)_i(r[o],e[o],t,n,i);return}if(e=e,Math.abs(r-e)>t*r)throw new Error(n)}function eS(r){return r instanceof Int8Array?-128:r instanceof Int16Array?-32768:r instanceof Int32Array?-2147483648:r instanceof Float32Array?12e-39:0}function tS(r){return r instanceof Int8Array?127:r instanceof Uint8Array||r instanceof Uint8ClampedArray?255:r instanceof Int16Array?32767:r instanceof Uint16Array?65535:r instanceof Int32Array?2147483647:r instanceof Uint32Array?4294967295:r instanceof Float32Array?34e37:255}class rS extends Ji{constructor(e){super({state:"loading",tileGrid:null,projection:e.projection||null,transition:e.transition,interpolate:e.interpolate!==!1,wrapX:e.wrapX}),this.sourceInfo_=e.sources;const t=this.sourceInfo_.length;this.sourceOptions_=e.sourceOptions,this.sourceImagery_=new Array(t),this.sourceMasks_=new Array(t),this.resolutionFactors_=new Array(t),this.samplesPerPixel_,this.nodataValues_,this.metadata_,this.normalize_=e.normalize!==!1,this.addAlpha_=!1,this.error_=null,this.convertToRGB_=e.convertToRGB||!1,this.setKey(this.sourceInfo_.map(s=>s.url).join(","));const n=this,i=new Array(t);for(let s=0;s<t;++s)i[s]=QT(this.sourceInfo_[s],this.sourceOptions_);Promise.all(i).then(function(s){n.configure_(s)}).catch(function(s){ln(s),n.error_=s,n.setState("error")})}getError(){return this.error_}determineProjection(e){const t=e[0];for(let n=t.length-1;n>=0;--n){const i=t[n],s=KT(i);if(s){this.projection=s;break}}}determineTransformMatrix(e){const t=e[0];for(let n=t.length-1;n>=0;--n){const s=t[n].fileDirectory.ModelTransformation;if(s){const[o,a,l,u,c,h,f,p]=s,d=an(an([1/Math.sqrt(o*o+c*c),0,0,-1/Math.sqrt(a*a+h*h),u,p],[o,c,a,h,0,0]),[1,0,0,1,-u,-p]);this.transformMatrix=d,this.addAlpha_=!0;break}}}configure_(e){let t,n,i,s,o;const a=new Array(e.length),l=new Array(e.length),u=new Array(e.length);let c=0;const h=e.length;for(let m=0;m<h;++m){const y=[],_=[];e[m].forEach(P=>{XT(P)?_.push(P):y.push(P)});const b=y.length;if(_.length>0&&_.length!==b)throw new Error(`Expected one mask per image found ${_.length} masks and ${b} images`);let w,x;const E=new Array(b),v=new Array(b),A=new Array(b);l[m]=new Array(b),u[m]=new Array(b);for(let P=0;P<b;++P){const S=y[P],I=S.getGDALNoData();u[m][P]=S.getGDALMetadata(0),l[m][P]=I;const N=this.sourceInfo_[m].bands;a[m]=N?N.length:S.getSamplesPerPixel();const z=b-(P+1);w||(w=qT(S)),x||(x=HT(S));const X=YT(S,y[0]);A[z]=X[0];const C=[S.getTileWidth(),S.getTileHeight()];C[0]!==C[1]&&C[1]<ba&&(C[0]=ba,C[1]=ba),E[z]=C;const M=X[0]/Math.abs(X[1]);v[z]=[C[0],C[1]/M]}if(t?$t(t,w,t):t=w,!n)n=x;else{const P=`Origin mismatch for source ${m}, got [${x}] but expected [${n}]`;_i(n,x,0,P,this.viewRejector)}if(!o)o=A,this.resolutionFactors_[m]=1;else{o.length-c>A.length&&(c=o.length-A.length);const P=o[o.length-1]/A[A.length-1];this.resolutionFactors_[m]=P;const S=A.map(N=>N*=P),I=`Resolution mismatch for source ${m}, got [${S}] but expected [${o}]`;_i(o.slice(c,o.length),S,.02,I,this.viewRejector)}i?_i(i.slice(c,i.length),v,.01,`Tile size mismatch for source ${m}`,this.viewRejector):i=v,s?_i(s.slice(c,s.length),E,0,`Tile size mismatch for source ${m}`,this.viewRejector):s=E,this.sourceImagery_[m]=y.reverse(),this.sourceMasks_[m]=_.reverse()}for(let m=0,y=this.sourceImagery_.length;m<y;++m){const _=this.sourceImagery_[m];for(;_.length<o.length;)_.unshift(void 0)}this.getProjection()||this.determineProjection(e),this.determineTransformMatrix(e),this.samplesPerPixel_=a,this.nodataValues_=l,this.metadata_=u;e:for(let m=0;m<h;++m){if(this.sourceInfo_[m].nodata!==void 0){this.addAlpha_=!0;break}if(this.sourceMasks_[m].length){this.addAlpha_=!0;break}const y=l[m],_=this.sourceInfo_[m].bands;if(_){for(let b=0;b<_.length;++b)if(y[_[b]-1]!==null){this.addAlpha_=!0;break e}continue}for(let b=0;b<y.length;++b)if(y[b]!==null){this.addAlpha_=!0;break e}}let f=this.addAlpha_?1:0;for(let m=0;m<h;++m)f+=a[m];this.bandCount=f;const p=new Kn({extent:t,minZoom:c,origin:n,resolutions:o,tileSizes:i});this.tileGrid=p,this.setTileSizes(s),this.setLoader(this.loadTile_.bind(this)),this.setState("ready");const d=1;o.length===2?o=[o[0],o[1],o[1]/2]:o.length===1&&(o=[o[0]*2,o[0],o[0]/2]);let g=t;if(this.transformMatrix){const m=Gn(Qe(),this.transformMatrix.slice()),y=uf(_=>hr(m,_));g=un(t,y)}this.viewResolver({showFullExtent:!0,projection:this.projection,resolutions:o,center:hf(Xt(g),this.projection),extent:cf(g,this.projection),zoom:d})}loadTile_(e,t,n,i){const s=this.getTileSize(e),o=this.sourceImagery_.length,a=new Array(o*2),l=this.nodataValues_,u=this.sourceInfo_,c=WT();for(let h=0;h<o;++h){const f=u[h],p=this.resolutionFactors_[h],d=[Math.round(t*(s[0]*p)),Math.round(n*(s[1]*p)),Math.round((t+1)*(s[0]*p)),Math.round((n+1)*(s[1]*p))],g=this.sourceImagery_[h][e];let m;f.bands&&(m=f.bands.map(function(x){return x-1}));let y;"nodata"in f&&f.nodata!==null?y=f.nodata:m?y=m.map(function(x){return l[h][x]}):y=l[h];const _={window:d,width:s[0],height:s[1],samples:m,fillValue:y,pool:c,interleave:!1,signal:i.signal};ZT(this.convertToRGB_,g)?a[h]=g.readRGB(_):a[h]=g.readRasters(_);const b=o+h,w=this.sourceMasks_[h][e];if(!w){a[b]=Promise.resolve(null);continue}a[b]=w.readRasters({window:d,width:s[0],height:s[1],samples:[0],pool:c,interleave:!1})}return Promise.all(a).then(this.composeTile_.bind(this,s)).catch(function(h){throw ln(h),h})}composeTile_(e,t){const n=this.metadata_,i=this.sourceInfo_,s=this.sourceImagery_.length,o=this.bandCount,a=this.samplesPerPixel_,l=this.nodataValues_,u=this.normalize_,c=this.addAlpha_,h=e[0]*e[1],f=h*o;let p;u?p=new Uint8Array(f):p=new Float32Array(f);let d=0;for(let g=0;g<h;++g){let m=c;for(let y=0;y<s;++y){const _=i[y];let b=_.min,w=_.max,x,E;if(u){const v=n[y][0];b===void 0&&(v&&Zh in v?b=parseFloat(v[Zh]):b=eS(t[y][0])),w===void 0&&(v&&Xh in v?w=parseFloat(v[Xh]):w=tS(t[y][0])),x=255/(w-b),E=-b*x}for(let v=0;v<a[y];++v){const A=t[y][v][g];let P;if(u?P=Fe(x*A+E,0,255):P=A,!c)p[d]=P;else{let S=_.nodata;if(S===void 0){let N;_.bands?N=_.bands[v]-1:N=v,S=l[y][N]}const I=isNaN(S);(!I&&A!==S||I&&!isNaN(A))&&(m=!1,p[d]=P)}d++}if(!m){const v=s+y,A=t[v];A&&!A[0][g]&&(m=!0)}}c&&(m||(p[d]=255),d++)}return p}}rS.prototype.getView;const nS=22;class FR extends gn{constructor(e){const t=!!e.highDpi;super({attributionsCollapsible:e.attributionsCollapsible,cacheSize:e.cacheSize,crossOrigin:"anonymous",interpolate:e.interpolate,projection:"EPSG:3857",reprojectionErrorThreshold:e.reprojectionErrorThreshold,state:"loading",tileLoadFunction:e.tileLoadFunction,tilePixelRatio:t?2:1,wrapX:e.wrapX!==void 0?e.wrapX:!0,transition:e.transition,zDirection:e.zDirection}),this.apiKey_=e.key,this.error_=null;const n={mapType:e.mapType||"roadmap",language:e.language||"en-US",region:e.region||"US"};e.imageFormat&&(n.imageFormat=e.imageFormat),e.scale&&(n.scale=e.scale),t&&(n.highDpi=!0),e.layerTypes&&(n.layerTypes=e.layerTypes),e.styles&&(n.styles=e.styles),e.overlay===!0&&(n.overlay=!0),e.apiOptions&&(n.apiOptions=e.apiOptions),this.sessionTokenRequest_=n,this.sessionTokenValue_,this.sessionRefreshId_,this.previousViewportAttribution_,this.previousViewportExtent_;const i=e.url||"https://tile.googleapis.com/";this.createSessionUrl_=i+"v1/createSession",this.tileUrl_=i+"v1/2dtiles",this.attributionUrl_=i+"tile/v1/viewport",this.createSession_()}getError(){return this.error_}fetchSessionToken(e,t){return fetch(e,t)}async createSession_(){const e=this.createSessionUrl_+"?key="+this.apiKey_,t={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(this.sessionTokenRequest_)},n=await this.fetchSessionToken(e,t);if(!n.ok){try{const f=await n.json();this.error_=new Error(f.error.message)}catch{this.error_=new Error("Error fetching session token")}this.setState("error");return}const i=await n.json(),s=this.getTilePixelRatio(1),o=[i.tileWidth/s,i.tileHeight/s];this.tileGrid=jr({extent:mn(this.getProjection()),maxZoom:nS,tileSize:o});const a=i.session;this.sessionTokenValue_=a;const l=this.apiKey_,u=this.tileUrl_;this.tileUrlFunction=function(f,p,d){const g=f[0],m=f[1],y=f[2];return`${u}/${g}/${m}/${y}?session=${a}&key=${l}`};const c=parseInt(i.expiry,10)*1e3,h=Math.max(c-Date.now()-60*1e3,1);this.sessionRefreshId_=setTimeout(()=>this.createSession_(),h),this.setAttributions(this.fetchAttributions_.bind(this)),this.setState("ready")}async fetchAttributions_(e){if(e.viewHints[kr.ANIMATING]||e.viewHints[kr.INTERACTING]||e.animate)return this.previousViewportAttribution_;const[t,n]=rc(Ug(e.extent),e.viewState.projection),[i,s]=rc(Bg(e.extent),e.viewState.projection),l=`zoom=${this.getTileGrid().getZForResolution(e.viewState.resolution,this.zDirection)}&north=${s}&south=${n}&east=${i}&west=${t}`;if(this.previousViewportExtent_==l)return this.previousViewportAttribution_;this.previousViewportExtent_=l;const u=this.sessionTokenValue_,c=this.apiKey_,f=`${this.attributionUrl_}?session=${u}&key=${c}&${l}`;return this.previousViewportAttribution_=await fetch(f).then(p=>p.json()).then(p=>p.copyright),this.previousViewportAttribution_}disposeInternal(){clearTimeout(this.sessionRefreshId_),super.disposeInternal()}}let Jp=class extends wl{constructor(e,t,n,i,s,o,a){super(t,n,i,s,o,a),this.zoomifyImage_=null,this.tileSize_=e}getImage(){if(this.zoomifyImage_)return this.zoomifyImage_;const e=super.getImage();if(this.state==ee.LOADED){const t=this.tileSize_;if(e.width==t[0]&&e.height==t[1])return this.zoomifyImage_=e,e;const n=zr(t[0],t[1]);return n.drawImage(e,0,0),this.zoomifyImage_=n.canvas,n.canvas}return e}};class OR extends gn{constructor(e){const t=e.size,n=e.tierSizeCalculation!==void 0?e.tierSizeCalculation:"default",i=e.tilePixelRatio||1,s=t[0],o=t[1],a=[],l=e.tileSize||Ma;let u=l*i;switch(n){case"default":for(;s>u||o>u;)a.push([Math.ceil(s/u),Math.ceil(o/u)]),u+=u;break;case"truncated":let E=s,v=o;for(;E>u||v>u;)a.push([Math.ceil(E/u),Math.ceil(v/u)]),E>>=1,v>>=1;break;default:throw new Error("Unknown `tierSizeCalculation` configured")}a.push([1,1]),a.reverse();const c=[i],h=[0];for(let E=1,v=a.length;E<v;E++)c.push(i<<E),h.push(a[E-1][0]*a[E-1][1]+h[E-1]);c.reverse();const f=new Kn({tileSize:l,extent:e.extent||[0,-o,s,0],resolutions:c});let p=e.url;p&&!p.includes("{TileGroup}")&&!p.includes("{tileIndex}")&&(p+="{TileGroup}/{z}-{x}-{y}.jpg");const d=vf(p);let g=l*i;function m(E){return function(v,A,P){if(!v)return;const S=v[0],I=v[1],N=v[2],z=I+N*a[S][0],X=(z+h[S])/g|0,C={z:S,x:I,y:N,tileIndex:z,TileGroup:"TileGroup"+X};return E.replace(/\{(\w+?)\}/g,function(M,U){return C[U]})}}const y=wf(d.map(m)),_=Jp.bind(null,Wt(l*i));super({attributions:e.attributions,cacheSize:e.cacheSize,crossOrigin:e.crossOrigin,interpolate:e.interpolate,projection:e.projection,tilePixelRatio:i,reprojectionErrorThreshold:e.reprojectionErrorThreshold,tileClass:_,tileGrid:f,tileUrlFunction:y,transition:e.transition}),this.zDirection=e.zDirection;const b=f.getTileCoordForCoordAndResolution(Xt(f.getExtent()),c[c.length-1]),w=y(b,1,null),x=new Image;x.addEventListener("error",()=>{g=l,this.changed()}),x.src=w}}function di(r){return r.toLocaleString("en",{maximumFractionDigits:10})}class NR extends gn{constructor(e){const t=e||{};let n=t.url||"";n=n+(n.lastIndexOf("/")===n.length-1||n===""?"":"/");const i=t.version||Xe.VERSION2,s=t.sizes||[],o=t.size;Ct(o!=null&&Array.isArray(o)&&o.length==2&&!isNaN(o[0])&&o[0]>0&&!isNaN(o[1])&&o[1]>0,"Missing or invalid `size`");const a=o[0],l=o[1],u=t.tileSize,c=t.tilePixelRatio||1,h=t.format||"jpg",f=t.quality||(t.version==Xe.VERSION1?"native":"default");let p=t.resolutions||[];const d=t.supports||[],g=t.extent||[0,-l,a,0],m=s!=null&&Array.isArray(s)&&s.length>0,y=u!==void 0&&(typeof u=="number"&&Number.isInteger(u)&&u>0||Array.isArray(u)&&u.length>0),_=d!=null&&Array.isArray(d)&&(d.includes("regionByPx")||d.includes("regionByPct"))&&(d.includes("sizeByWh")||d.includes("sizeByH")||d.includes("sizeByW")||d.includes("sizeByPct"));let b,w,x;if(p.sort(function(P,S){return S-P}),y||_)if(u!=null&&(typeof u=="number"&&Number.isInteger(u)&&u>0?(b=u,w=u):Array.isArray(u)&&u.length>0&&((u.length==1||u[1]==null&&Number.isInteger(u[0]))&&(b=u[0],w=u[0]),u.length==2&&(Number.isInteger(u[0])&&Number.isInteger(u[1])?(b=u[0],w=u[1]):u[0]==null&&Number.isInteger(u[1])&&(b=u[1],w=u[1])))),(b===void 0||w===void 0)&&(b=Ma,w=Ma),p.length==0){x=Math.max(Math.ceil(Math.log(a/b)/Math.LN2),Math.ceil(Math.log(l/w)/Math.LN2));for(let P=x;P>=0;P--)p.push(Math.pow(2,P))}else{const P=Math.max(...p);x=Math.round(Math.log(P)/Math.LN2)}else if(b=a,w=l,p=[],m){s.sort(function(S,I){return S[0]-I[0]}),x=-1;const P=[];for(let S=0;S<s.length;S++){const I=a/s[S][0];if(p.length>0&&p[p.length-1]==I){P.push(S);continue}p.push(I),x++}if(P.length>0)for(let S=0;S<P.length;S++)s.splice(P[S]-S,1)}else p.push(1),s.push([a,l]),x=0;const E=new Kn({tileSize:[b,w],extent:g,origin:As(g),resolutions:p}),v=function(P,S,I){let N,z;const X=P[0];if(X>x)return;const C=P[1],M=P[2],U=p[X];if(!(C===void 0||M===void 0||U===void 0||C<0||Math.ceil(a/U/b)<=C||M<0||Math.ceil(l/U/w)<=M)){if(_||y){const se=C*b*U,H=M*w*U;let Y=b*U,le=w*U,Te=b,K=w;if(se+Y>a&&(Y=a-se),H+le>l&&(le=l-H),se+b*U>a&&(Te=Math.floor((a-se+U-1)/U)),H+w*U>l&&(K=Math.floor((l-H+U-1)/U)),se==0&&Y==a&&H==0&&le==l)N="full";else if(!_||d.includes("regionByPx"))N=se+","+H+","+Y+","+le;else if(d.includes("regionByPct")){const O=di(se/a*100),Le=di(H/l*100),Ie=di(Y/a*100),Se=di(le/l*100);N="pct:"+O+","+Le+","+Ie+","+Se}i==Xe.VERSION3&&(!_||d.includes("sizeByWh"))?z=Te+","+K:!_||d.includes("sizeByW")?z=Te+",":d.includes("sizeByH")?z=","+K:d.includes("sizeByWh")?z=Te+","+K:d.includes("sizeByPct")&&(z="pct:"+di(100/U))}else if(N="full",m){const se=s[X][0],H=s[X][1];i==Xe.VERSION3?se==a&&H==l?z="max":z=se+","+H:se==a?z="full":z=se+","}else z=i==Xe.VERSION3?"max":"full";return n+N+"/"+z+"/0/"+f+"."+h}},A=Jp.bind(null,Wt(u||256).map(function(P){return P*c}));super({attributions:t.attributions,attributionsCollapsible:t.attributionsCollapsible,cacheSize:t.cacheSize,crossOrigin:t.crossOrigin,interpolate:t.interpolate,projection:t.projection,reprojectionErrorThreshold:t.reprojectionErrorThreshold,state:t.state,tileClass:A,tileGrid:E,tilePixelRatio:t.tilePixelRatio,tileUrlFunction:v,transition:t.transition}),this.zDirection=t.zDirection}}function Qp(r,e,t,n,i,s){const o=i.getCode().split(/:(?=\d+$)/).pop(),a=t/n,l=[ic(nt(e)/a,ac),ic(Zt(e)/a,ac)];s.SIZE=l[0]+","+l[1],s.BBOX=e.join(","),s.BBOXSR=o,s.IMAGESR=o,s.DPI=Math.round(s.DPI?s.DPI*n:90*n);const u=r.replace(/MapServer\/?$/,"MapServer/export").replace(/ImageServer\/?$/,"ImageServer/exportImage");return Tf(u,s)}function iS(r){const e=r.load?r.load:qn,t=ce(r.projection||"EPSG:3857"),n=r.ratio??1.5,i=r.crossOrigin??null;return function(s,o,a){a=r.hidpi?a:1;const l={F:"image",FORMAT:"PNG32",TRANSPARENT:!0};Object.assign(l,r.params),s=Sf(s,o,a,n);const u=Qp(r.url,s,o,a,t,l),c=new Image;return c.crossOrigin=i,e(c,u).then(h=>{const f=nt(s)/h.width*a;return{image:h,extent:s,resolution:f,pixelRatio:a}})}}class DR extends Hn{constructor(e){e=e||{},super({attributions:e.attributions,interpolate:e.interpolate,projection:e.projection,resolutions:e.resolutions}),this.crossOrigin_=e.crossOrigin!==void 0?e.crossOrigin:null,this.hidpi_=e.hidpi!==void 0?e.hidpi:!0,this.url_=e.url,this.imageLoadFunction_=e.imageLoadFunction!==void 0?e.imageLoadFunction:Sl,this.params_=Object.assign({},e.params),this.imageSize_=[0,0],this.renderedRevision_=0,this.ratio_=e.ratio!==void 0?e.ratio:1.5,this.loaderProjection_=null}getParams(){return this.params_}getImageInternal(e,t,n,i){return this.url_===void 0?null:((!this.loader||this.loaderProjection_!==i)&&(this.loaderProjection_=i,this.loader=iS({crossOrigin:this.crossOrigin_,params:this.params_,projection:i,hidpi:this.hidpi_,url:this.url_,ratio:this.ratio_,load:(s,o)=>(this.image.setImage(s),this.imageLoadFunction_(this.image,o),qn(s))})),super.getImageInternal(e,t,n,i))}getImageLoadFunction(){return this.imageLoadFunction_}getUrl(){return this.url_}setImageLoadFunction(e){this.imageLoadFunction_=e,this.changed()}setUrl(e){e!=this.url_&&(this.url_=e,this.loader=null,this.changed())}setParams(e){this.params_=Object.assign({},e),this.changed()}updateParams(e){Object.assign(this.params_,e),this.changed()}changed(){this.image=null,super.changed()}}class UR extends Hn{constructor(e){e=e||{},super({attributions:e.attributions,interpolate:e.interpolate,projection:e.projection,resolutions:e.resolutions,state:e.state}),this.canvasFunction_=e.canvasFunction,this.canvas_=null,this.renderedRevision_=0,this.ratio_=e.ratio!==void 0?e.ratio:1.5}getImageInternal(e,t,n,i){t=this.findNearestResolution(t);let s=this.canvas_;if(s&&this.renderedRevision_==this.getRevision()&&s.getResolution()==t&&s.getPixelRatio()==n&&Ss(s.getExtent(),e))return s;e=e.slice(),pf(e,this.ratio_);const o=nt(e)/t,a=Zt(e)/t,l=[o*n,a*n],u=this.canvasFunction_.call(this,e,t,n,l,i);return u&&(s=new Kl(e,t,n,u)),this.canvas_=s,this.renderedRevision_=this.getRevision(),s}}function sS(r,e,t,n){const i=nt(r),s=Zt(r),o=e[0],a=e[1],l=.0254/n;return a*i>o*s?i*t/(o*l):s*t/(a*l)}function oS(r,e,t,n,i,s,o){const a=sS(t,n,s,o),l=Xt(t),u={OPERATION:i?"GETDYNAMICMAPOVERLAYIMAGE":"GETMAPIMAGE",VERSION:"2.0.0",LOCALE:"en",CLIENTAGENT:"ol/source/ImageMapGuide source",CLIP:"1",SETDISPLAYDPI:o,SETDISPLAYWIDTH:Math.round(n[0]),SETDISPLAYHEIGHT:Math.round(n[1]),SETVIEWSCALE:a,SETVIEWCENTERX:l[0],SETVIEWCENTERY:l[1]};return Object.assign(u,e),Tf(r,u)}function aS(r){const e=r.load||qn,t=r.useOverlay??!1,n=r.metersPerUnit||1,i=r.displayDpi||96,s=r.ratio??1,o=r.crossOrigin??null;return function(a,l,u){const c=new Image;c.crossOrigin=o,a=Sf(a,l,u,s);const h=nt(a)/l,f=Zt(a)/l,p=[h*u,f*u],d=oS(r.url,r.params,a,p,t,n,i);return e(c,d).then(g=>({image:g,extent:a,pixelRatio:u}))}}class BR extends Hn{constructor(e){super({interpolate:e.interpolate,projection:e.projection,resolutions:e.resolutions}),this.crossOrigin_=e.crossOrigin!==void 0?e.crossOrigin:null,this.displayDpi_=e.displayDpi!==void 0?e.displayDpi:96,this.params_=Object.assign({},e.params),this.url_=e.url,this.imageLoadFunction_=e.imageLoadFunction!==void 0?e.imageLoadFunction:Sl,this.hidpi_=e.hidpi!==void 0?e.hidpi:!0,this.metersPerUnit_=e.metersPerUnit!==void 0?e.metersPerUnit:1,this.ratio_=e.ratio!==void 0?e.ratio:1,this.useOverlay_=e.useOverlay!==void 0?e.useOverlay:!1,this.renderedRevision_=0,this.loaderProjection_=null}getParams(){return this.params_}getImageInternal(e,t,n,i){return this.url_===void 0?null:((!this.loader||this.loaderProjection_!==i)&&(this.loaderProjection_=i,this.loader=aS({crossOrigin:this.crossOrigin_,params:this.params_,hidpi:this.hidpi_,metersPerUnit:this.metersPerUnit_,url:this.url_,useOverlay:this.useOverlay_,ratio:this.ratio_,load:(s,o)=>(this.image.setImage(s),this.imageLoadFunction_(this.image,o),qn(s))})),super.getImageInternal(e,t,n,i))}getImageLoadFunction(){return this.imageLoadFunction_}setParams(e){this.params_=Object.assign({},e),this.changed()}updateParams(e){Object.assign(this.params_,e),this.changed()}setImageLoadFunction(e){this.imageLoadFunction_=e,this.changed()}changed(){this.image=null,super.changed()}}const lS=new Error("Image failed to load");function eg(r,e,t,n,i){return new Promise((s,o)=>{const a=new Image;a.crossOrigin=i.crossOrigin??null,a.addEventListener("load",()=>s(a)),a.addEventListener("error",()=>o(lS)),a.src=Rf(r,e,t,n,i.maxY)})}function Wh(r){return function(e,t,n,i){const s=vm(r,e,t,n);return eg(s,e,t,n,i)}}function uS(r){return function(e,t,n,i){const s=r(e,t,n,i);return eg(s,e,t,n,i)}}function qh(r){let e;if(Array.isArray(r))e=Wh(r);else if(typeof r=="string"){const t=vf(r);e=Wh(t)}else if(typeof r=="function")e=uS(r);else throw new Error("The url option must be a single template, an array of templates, or a function for getting a URL");return e}let Hh=0;function Yh(r){return Array.isArray(r)?r.join(`
`):typeof r=="string"?r:(++Hh,"url-function-key-"+Hh)}class cS extends Ji{constructor(e){e=e||{};let t=e.loader,n;e.url&&(t=qh(e.url),n=Yh(e.url));const i=t?e.state:"loading",s=e.wrapX===void 0?!0:e.wrapX;super({loader:t,key:n,attributions:e.attributions,attributionsCollapsible:e.attributionsCollapsible,maxZoom:e.maxZoom,minZoom:e.minZoom,tileSize:e.tileSize,gutter:e.gutter,maxResolution:e.maxResolution,projection:e.projection,tileGrid:e.tileGrid,state:i,wrapX:s,transition:e.transition,interpolate:e.interpolate!==!1,crossOrigin:e.crossOrigin,zDirection:e.zDirection})}setUrl(e){const t=qh(e);this.setLoader(t),this.setKey(Yh(e)),this.getState()!=="ready"&&this.setState("ready")}}const hS={"image/png":!0,"image/jpeg":!0,"image/gif":!0,"image/webp":!0},fS={"application/vnd.mapbox-vector-tile":!0,"application/geo+json":!0};function tg(r,e){if(!e.length)return r;const t=new URL(r,"file:/");if(t.pathname.split("/").includes("collections"))return ln('The "collections" query parameter cannot be added to collection endpoints'),r;const n=e.map(o=>encodeURIComponent(o)).join(",");t.searchParams.append("collections",n);const i=r.split("?")[0],s=decodeURIComponent(t.searchParams.toString());return`${i}?${s}`}function dS(r,e,t){let n,i;for(let s=0;s<r.length;++s){const o=r[s];if(o.rel==="item"){if(o.type===e){n=o.href;break}(hS[o.type]||!i&&o.type.startsWith("image/"))&&(i=o.href)}}if(!n)if(i)n=i;else throw new Error('Could not find "item" link');return t&&(n=tg(n,t)),n}function pS(r,e,t,n){let i,s;const o={};for(let a=0;a<r.length;++a){const l=r[a];if(o[l.type]=l.href,l.rel==="item"){if(l.type===e){i=l.href;break}fS[l.type]&&(s=l.href)}}if(!i&&t)for(let a=0;a<t.length;++a){const l=t[a];if(o[l]){i=o[l];break}}if(!i)if(s)i=s;else throw new Error('Could not find "item" link');return n&&(i=tg(i,n)),i}function Kh(r,e,t,n){let i=r.projection;if(!i&&(typeof e.crs=="string"?i=ce(e.crs):"uri"in e.crs&&(i=ce(e.crs.uri)),!i))throw new Error(`Unsupported CRS: ${JSON.stringify(e.crs)}`);const s=e.orderedAxes,a=!(s?s.slice(0,2).map(E=>E.replace(/E|X|Lon/i,"e").replace(/N|Y|Lat/i,"n")).join(""):i.getAxisOrientation()).startsWith("en"),l=e.tileMatrices,u={};for(let E=0;E<l.length;++E){const v=l[E];u[v.id]=v}const c={},h=[];if(n)for(let E=0;E<n.length;++E){const v=n[E],A=v.tileMatrix;h.push(A),c[A]=v}else for(let E=0;E<l.length;++E){const v=l[E].id;h.push(v)}const f=h.length,p=new Array(f),d=new Array(f),g=new Array(f),m=new Array(f),y=[-1/0,-1/0,1/0,1/0];for(let E=0;E<f;++E){const v=h[E],A=u[v],P=A.pointOfOrigin;a?p[E]=[P[1],P[0]]:p[E]=P,d[E]=A.cellSize,g[E]=[A.matrixWidth,A.matrixHeight],m[E]=[A.tileWidth,A.tileHeight];const S=c[v];if(S){const I=A.cellSize*A.tileWidth,N=p[E][0]+S.minTileCol*I,z=p[E][0]+(S.maxTileCol+1)*I,X=A.cellSize*A.tileHeight,C=A.cornerOfOrigin==="bottomLeft";let M,U;C?(M=p[E][1]+S.minTileRow*X,U=p[E][1]+(S.maxTileRow+1)*X):(M=p[E][1]-(S.maxTileRow+1)*X,U=p[E][1]-S.minTileRow*X),$t(y,[N,M,z,U],y)}}const _=new Kn({origins:p,resolutions:d,sizes:g,tileSizes:m,extent:n?y:void 0}),b=r.context,w=r.url;function x(E,v,A){if(!E)return;const P=h[E[0]],S=u[P],I=S.cornerOfOrigin==="bottomLeft",N={tileMatrix:P,tileCol:E[1],tileRow:I?-E[2]-1:E[2]};if(n){const X=c[S.id];if(N.tileCol<X.minTileCol||N.tileCol>X.maxTileCol||N.tileRow<X.minTileRow||N.tileRow>X.maxTileRow)return}Object.assign(N,{z:N.tileMatrix,x:N.tileCol,y:N.tileRow},b);const z=t.replace(/\{(\w+?)\}/g,function(X,C){return N[C]});return gd(w,z)}return{grid:_,projection:i,urlTemplate:t,urlFunction:x}}function gS(r,e){const t=e.tileMatrixSetLimits;let n;if(e.dataType==="map")n=dS(e.links,r.mediaType,r.collections);else if(e.dataType==="vector")n=pS(e.links,r.mediaType,r.supportedMediaTypes,r.collections);else throw new Error('Expected tileset data type to be "map" or "vector"');if(e.tileMatrixSet)return Kh(r,e.tileMatrixSet,n,t);const i=e.links.find(a=>a.rel==="http://www.opengis.net/def/rel/ogc/1.0/tiling-scheme");if(!i)throw new Error("Expected http://www.opengis.net/def/rel/ogc/1.0/tiling-scheme link or tileMatrixSet");const s=i.href,o=gd(r.url,s);return pd(o).then(function(a){return Kh(r,a,n,t)})}function rg(r){return pd(r.url).then(function(e){return gS(r,e)})}class GR extends gn{constructor(e){super({attributions:e.attributions,cacheSize:e.cacheSize,crossOrigin:e.crossOrigin,interpolate:e.interpolate,projection:e.projection,reprojectionErrorThreshold:e.reprojectionErrorThreshold,state:"loading",tileLoadFunction:e.tileLoadFunction,wrapX:e.wrapX!==void 0?e.wrapX:!0,transition:e.transition});const t={url:e.url,projection:this.getProjection(),mediaType:e.mediaType,context:e.context||null,collections:e.collections};rg(t).then(this.handleTileSetInfo_.bind(this)).catch(this.handleError_.bind(this))}handleTileSetInfo_(e){this.tileGrid=e.grid,this.projection=e.projection,this.setTileUrlFunction(e.urlFunction,e.urlTemplate),this.setState("ready")}handleError_(e){ln(e),this.setState("error")}}class zR extends Yn{constructor(e){super({attributions:e.attributions,attributionsCollapsible:e.attributionsCollapsible,cacheSize:e.cacheSize,format:e.format,overlaps:e.overlaps,projection:e.projection,tileClass:e.tileClass,transition:e.transition,wrapX:e.wrapX,zDirection:e.zDirection,state:"loading"});const t={url:e.url,projection:this.getProjection(),mediaType:e.mediaType,supportedMediaTypes:e.format.supportedMediaTypes,context:e.context||null,collections:e.collections};rg(t).then(this.handleTileSetInfo_.bind(this)).catch(this.handleError_.bind(this))}handleTileSetInfo_(e){this.tileGrid=e.grid,this.projection=e.projection,this.setTileUrlFunction(e.urlFunction,e.urlTemplate),this.setState("ready")}handleError_(e){ln(e),this.setState("error")}}const mS='&copy; <a href="https://www.stadiamaps.com/" target="_blank">Stadia Maps</a>',yS='&copy; <a href="https://openmaptiles.org/" target="_blank">OpenMapTiles</a>',_S='&copy; <a href="https://stamen.com/" target="_blank">Stamen Design</a>',bS={stamen_terrain:{extension:"png"},stamen_terrain_background:{extension:"png"},stamen_terrain_labels:{extension:"png"},stamen_terrain_lines:{extension:"png"},stamen_toner_background:{extension:"png"},stamen_toner:{extension:"png"},stamen_toner_labels:{extension:"png"},stamen_toner_lines:{extension:"png"},stamen_toner_lite:{extension:"png"},stamen_toner_dark:{extension:"png"},stamen_toner_blacklite:{extension:"png"},stamen_watercolor:{extension:"jpg"},alidade_smooth:{extension:"png"},alidade_smooth_dark:{extension:"png"},alidade_satellite:{extension:"png"},outdoors:{extension:"png"},osm_bright:{extension:"png"}},xS={stamen_terrain:{minZoom:0,maxZoom:18,retina:!0},stamen_toner:{minZoom:0,maxZoom:20,retina:!0},stamen_toner_dark:{minZoom:0,maxZoom:20,retina:!0},stamen_toner_blacklite:{minZoom:0,maxZoom:20,retina:!0},stamen_watercolor:{minZoom:1,maxZoom:18,retina:!1}};class kR extends Ms{constructor(e){const t=e.layer.indexOf("-"),n=t==-1?e.layer:e.layer.slice(0,t),i=xS[n]||{minZoom:0,maxZoom:20,retina:!0},s=bS[e.layer],o=e.apiKey?"?api_key="+e.apiKey:"",a=i.retina&&e.retina?"@2x":"",l=e.url!==void 0?e.url:"https://tiles.stadiamaps.com/tiles/"+e.layer+"/{z}/{x}/{y}"+a+"."+s.extension+o,u=[mS,yS,Tm];e.layer.startsWith("stamen_")&&u.splice(1,0,_S),super({attributions:u,cacheSize:e.cacheSize,crossOrigin:"anonymous",interpolate:e.interpolate,maxZoom:e.maxZoom!==void 0?e.maxZoom:i.maxZoom,minZoom:e.minZoom!==void 0?e.minZoom:i.minZoom,reprojectionErrorThreshold:e.reprojectionErrorThreshold,tileLoadFunction:e.tileLoadFunction,transition:e.transition,url:l,tilePixelRatio:a?2:1,wrapX:e.wrapX,zDirection:e.zDirection})}}class $R extends gn{constructor(e){e=e||{},super({attributions:e.attributions,cacheSize:e.cacheSize,crossOrigin:e.crossOrigin,interpolate:e.interpolate,projection:e.projection,reprojectionErrorThreshold:e.reprojectionErrorThreshold,tileGrid:e.tileGrid,tileLoadFunction:e.tileLoadFunction,url:e.url,urls:e.urls,wrapX:e.wrapX!==void 0?e.wrapX:!0,transition:e.transition,zDirection:e.zDirection}),this.params_=Object.assign({},e.params),this.hidpi_=e.hidpi!==void 0?e.hidpi:!0,this.tmpExtent_=ji(),this.setKey(this.getKeyForParams_())}getKeyForParams_(){let e=0;const t=[];for(const n in this.params_)t[e++]=n+"-"+this.params_[n];return t.join("/")}getParams(){return this.params_}getRequestUrl_(e,t,n,i,s,o){const a=this.urls;if(!a)return;let l;if(a.length==1)l=a[0];else{const u=Gg(Sm(e),a.length);l=a[u]}return Qp(l,n,(this.tileGrid||this.getTileGridForProjection(s)).getResolution(e[0]),i,s,o)}getTilePixelRatio(e){return this.hidpi_?e:1}setParams(e){this.params_=Object.assign({},e),this.setKey(this.getKeyForParams_())}updateParams(e){Object.assign(this.params_,e),this.setKey(this.getKeyForParams_())}tileUrlFunction(e,t,n){let i=this.getTileGrid();if(i||(i=this.getTileGridForProjection(n)),i.getResolutions().length<=e[0])return;t!=1&&!this.hidpi_&&(t=1);const s=i.getTileCoordExtent(e,this.tmpExtent_);let o=Wt(i.getTileSize(e[0]),this.tmpSize);t!=1&&(o=Rm(o,t,this.tmpSize));const a={F:"image",FORMAT:"PNG32",TRANSPARENT:!0};return Object.assign(a,this.params_),this.getRequestUrl_(e,o,s,t,n,a)}}class jR extends cS{constructor(e){e=e||{};const t=e.template||"z:{z} x:{x} y:{y}",n=e.source,i=e.color||"grey";super({transition:0,wrapX:e.wrapX!==void 0?e.wrapX:n!==void 0?n.getWrapX():void 0});const s=()=>{var a;this.projection=e.projection!==void 0?ce(e.projection):n!==void 0?n.getProjection():this.projection,this.tileGrid=e.tileGrid!==void 0?e.tileGrid:n!==void 0?n.getTileGrid():this.tileGrid,this.zDirection=e.zDirection!==void 0?e.zDirection:n!==void 0?n.zDirection:this.zDirection,n instanceof Ji&&(this.transformMatrix=((a=n.transformMatrix)==null?void 0:a.slice())||null);const o=this.tileGrid;o&&this.setTileSizes(o.getResolutions().map((l,u)=>Wt(o.getTileSize(u)).map(c=>Math.max(Math.floor(c),1)))),this.setLoader((l,u,c,h)=>{const f=Rf(t,l,u,c,h.maxY),[p,d]=this.getTileSize(l),g=zr(p,d);return g.strokeStyle=i,g.strokeRect(.5,.5,p+.5,d+.5),g.fillStyle=i,g.strokeStyle="white",g.textAlign="center",g.textBaseline="middle",g.font="24px sans-serif",g.lineWidth=4,g.strokeText(f,p/2,d/2,p),g.fillText(f,p/2,d/2,p),Promise.resolve(g.canvas)}),this.setState("ready")};if(n===void 0||n.getState()==="ready")s();else{const o=()=>{n.getState()==="ready"&&(n.removeEventListener(gt.CHANGE,o),s())};n.addEventListener(gt.CHANGE,o)}}}class ES extends Im{constructor(e,t,n,i,s,o){super(e,t),this.src_=n,this.extent_=i,this.preemptive_=s,this.grid_=null,this.keys_=null,this.data_=null,this.jsonp_=o}getImage(){return null}getData(e){if(!this.grid_||!this.keys_)return null;const t=(e[0]-this.extent_[0])/(this.extent_[2]-this.extent_[0]),n=(e[1]-this.extent_[1])/(this.extent_[3]-this.extent_[1]),i=this.grid_[Math.floor((1-n)*this.grid_.length)];if(typeof i!="string")return null;let s=i.charCodeAt(Math.floor(t*i.length));s>=93&&s--,s>=35&&s--,s-=32;let o=null;if(s in this.keys_){const a=this.keys_[s];this.data_&&a in this.data_?o=this.data_[a]:o=a}return o}forDataAtCoordinate(e,t,n){this.state==ee.EMPTY&&n===!0?(this.state=ee.IDLE,zg(this,gt.CHANGE,i=>{t(this.getData(e))}),this.loadInternal_()):n===!0?setTimeout(()=>{t(this.getData(e))},0):t(this.getData(e))}getKey(){return this.src_}handleError_(){this.state=ee.ERROR,this.changed()}handleLoad_(e){this.grid_=e.grid,this.keys_=e.keys,this.data_=e.data,this.state=ee.LOADED,this.changed()}loadInternal_(){if(this.state==ee.IDLE)if(this.state=ee.LOADING,this.jsonp_)Jl(this.src_,this.handleLoad_.bind(this),this.handleError_.bind(this));else{const e=new XMLHttpRequest;e.addEventListener("load",this.onXHRLoad_.bind(this)),e.addEventListener("error",this.onXHRError_.bind(this)),e.open("GET",this.src_),e.send()}}onXHRLoad_(e){const t=e.target;if(!t.status||t.status>=200&&t.status<300){let n;try{n=JSON.parse(t.responseText)}catch{this.handleError_();return}this.handleLoad_(n)}else this.handleError_()}onXHRError_(e){this.handleError_()}load(){this.preemptive_?this.loadInternal_():this.setState(ee.EMPTY)}}class VR extends Rl{constructor(e){if(super({projection:ce("EPSG:3857"),state:"loading",wrapX:e.wrapX!==void 0?e.wrapX:!0,zDirection:e.zDirection}),this.preemptive_=e.preemptive!==void 0?e.preemptive:!0,this.tileUrlFunction_=Pm,this.template_=void 0,this.jsonp_=e.jsonp||!1,this.tileCache_=new _f(512),e.url)if(this.jsonp_)Jl(e.url,this.handleTileJSONResponse.bind(this),this.handleTileJSONError.bind(this));else{const t=new XMLHttpRequest;t.addEventListener("load",this.onXHRLoad_.bind(this)),t.addEventListener("error",this.onXHRError_.bind(this)),t.open("GET",e.url),t.send()}else if(e.tileJSON)this.handleTileJSONResponse(e.tileJSON);else throw new Error("Either `url` or `tileJSON` options must be provided")}onXHRLoad_(e){const t=e.target;if(!t.status||t.status>=200&&t.status<300){let n;try{n=JSON.parse(t.responseText)}catch{this.handleTileJSONError();return}this.handleTileJSONResponse(n)}else this.handleTileJSONError()}onXHRError_(e){this.handleTileJSONError()}getTemplate(){return this.template_}forDataAtCoordinateAndResolution(e,t,n,i){if(this.tileGrid){const s=this.tileGrid.getZForResolution(t,this.zDirection),o=this.tileGrid.getTileCoordForCoordAndZ(e,s),a=this.getTile(o[0],o[1],o[2],1,this.getProjection());a.getState()==ee.IDLE&&a.load(),a.forDataAtCoordinate(e,n,i)}else i===!0?setTimeout(function(){n(null)},0):n(null)}handleTileJSONError(){this.setState("error")}handleTileJSONResponse(e){const t=ce("EPSG:4326"),n=this.getProjection();let i;if(e.bounds!==void 0){const c=yl(t,n);i=un(e.bounds,c)}const s=mn(n),o=e.minzoom||0,a=e.maxzoom||22,l=jr({extent:s,maxZoom:a,minZoom:o});this.tileGrid=l,this.template_=e.template;const u=e.grids;if(!u){this.setState("error");return}if(this.tileUrlFunction_=xf(u,l),e.attribution){const c=i!==void 0?i:s;this.setAttributions(function(h){return zn(c,h.extent)?[e.attribution]:null})}this.setState("ready")}getTile(e,t,n,i,s){const o=[e,t,n],a=this.getTileCoordForTileUrlFunction(o,s),l=this.tileUrlFunction_(a,i,s),u=`${this.getKey()},${Am(e,t,n)}`;if(this.tileCache_.containsKey(u))return this.tileCache_.get(u);this.tileCache_.expireCache();const c=new ES(o,l!==void 0?ee.IDLE:ee.EMPTY,l!==void 0?l:"",this.tileGrid.getTileCoordExtent(o),this.preemptive_,this.jsonp_);return this.tileCache_.set(u,c),c}}class XR extends en{constructor(e){e=e||{},super({attributions:e.attributions,wrapX:e.wrapX}),this.resolution=void 0,this.distance=e.distance!==void 0?e.distance:20,this.minDistance=e.minDistance||0,this.interpolationRatio=0,this.features=[],this.geometryFunction=e.geometryFunction||function(t){const n=t.getGeometry();return Ct(!n||n.getType()==="Point","The default `geometryFunction` can only handle `Point` or null geometries"),n},this.createCustomCluster_=e.createCluster,this.source=null,this.boundRefresh_=this.refresh.bind(this),this.updateDistance(this.distance,this.minDistance),this.setSource(e.source||null)}clear(e){this.features.length=0,super.clear(e)}getDistance(){return this.distance}getSource(){return this.source}loadFeatures(e,t,n){var i;(i=this.source)==null||i.loadFeatures(e,t,n),t!==this.resolution&&(this.resolution=t,this.refresh())}setDistance(e){this.updateDistance(e,this.minDistance)}setMinDistance(e){this.updateDistance(this.distance,e)}getMinDistance(){return this.minDistance}setSource(e){this.source&&this.source.removeEventListener(gt.CHANGE,this.boundRefresh_),this.source=e,e&&e.addEventListener(gt.CHANGE,this.boundRefresh_),this.refresh()}refresh(){this.clear(),this.cluster(),this.addFeatures(this.features)}updateDistance(e,t){const n=e===0?0:Math.min(t,e)/e,i=e!==this.distance||this.interpolationRatio!==n;this.distance=e,this.minDistance=t,this.interpolationRatio=n,i&&this.refresh()}cluster(){if(this.resolution===void 0||!this.source)return;const e=ji(),t=this.distance*this.resolution,n=this.source.getFeatures(),i={};for(let s=0,o=n.length;s<o;s++){const a=n[s];if(!(me(a)in i)){const l=this.geometryFunction(a);if(l){const u=l.getCoordinates();kg(u,e),xl(e,t,e);const c=this.source.getFeaturesInExtent(e).filter(function(h){const f=me(h);return f in i?!1:(i[f]=!0,!0)});this.features.push(this.createCluster(c,e))}}}}createCluster(e,t){const n=[0,0];for(let a=e.length-1;a>=0;--a){const l=this.geometryFunction(e[a]);l?Tg(n,l.getCoordinates()):e.splice(a,1)}Sg(n,1/e.length);const i=Xt(t),s=this.interpolationRatio,o=new sr([n[0]*(1-s)+i[0]*s,n[1]*(1-s)+i[1]*s]);return this.createCustomCluster_?this.createCustomCluster_(o,e):new qt({geometry:o,features:e})}}const yr=new Uint8Array([102,103,98,3,102,103,98,0]),Pt=4,pi=4,gi=4,is=4,Lr=new Int32Array(2),Jh=new Float32Array(Lr.buffer),Qh=new Float64Array(Lr.buffer),_s=new Uint16Array(new Uint8Array([1,0]).buffer)[0]===1;var ll;(function(r){r[r.UTF8_BYTES=1]="UTF8_BYTES",r[r.UTF16_STRING=2]="UTF16_STRING"})(ll||(ll={}));class Ht{constructor(e){this.bytes_=e,this.position_=0,this.text_decoder_=new TextDecoder}static allocate(e){return new Ht(new Uint8Array(e))}clear(){this.position_=0}bytes(){return this.bytes_}position(){return this.position_}setPosition(e){this.position_=e}capacity(){return this.bytes_.length}readInt8(e){return this.readUint8(e)<<24>>24}readUint8(e){return this.bytes_[e]}readInt16(e){return this.readUint16(e)<<16>>16}readUint16(e){return this.bytes_[e]|this.bytes_[e+1]<<8}readInt32(e){return this.bytes_[e]|this.bytes_[e+1]<<8|this.bytes_[e+2]<<16|this.bytes_[e+3]<<24}readUint32(e){return this.readInt32(e)>>>0}readInt64(e){return BigInt.asIntN(64,BigInt(this.readUint32(e))+(BigInt(this.readUint32(e+4))<<BigInt(32)))}readUint64(e){return BigInt.asUintN(64,BigInt(this.readUint32(e))+(BigInt(this.readUint32(e+4))<<BigInt(32)))}readFloat32(e){return Lr[0]=this.readInt32(e),Jh[0]}readFloat64(e){return Lr[_s?0:1]=this.readInt32(e),Lr[_s?1:0]=this.readInt32(e+4),Qh[0]}writeInt8(e,t){this.bytes_[e]=t}writeUint8(e,t){this.bytes_[e]=t}writeInt16(e,t){this.bytes_[e]=t,this.bytes_[e+1]=t>>8}writeUint16(e,t){this.bytes_[e]=t,this.bytes_[e+1]=t>>8}writeInt32(e,t){this.bytes_[e]=t,this.bytes_[e+1]=t>>8,this.bytes_[e+2]=t>>16,this.bytes_[e+3]=t>>24}writeUint32(e,t){this.bytes_[e]=t,this.bytes_[e+1]=t>>8,this.bytes_[e+2]=t>>16,this.bytes_[e+3]=t>>24}writeInt64(e,t){this.writeInt32(e,Number(BigInt.asIntN(32,t))),this.writeInt32(e+4,Number(BigInt.asIntN(32,t>>BigInt(32))))}writeUint64(e,t){this.writeUint32(e,Number(BigInt.asUintN(32,t))),this.writeUint32(e+4,Number(BigInt.asUintN(32,t>>BigInt(32))))}writeFloat32(e,t){Jh[0]=t,this.writeInt32(e,Lr[0])}writeFloat64(e,t){Qh[0]=t,this.writeInt32(e,Lr[_s?0:1]),this.writeInt32(e+4,Lr[_s?1:0])}getBufferIdentifier(){if(this.bytes_.length<this.position_+pi+gi)throw new Error("FlatBuffers: ByteBuffer is too short to contain an identifier.");let e="";for(let t=0;t<gi;t++)e+=String.fromCharCode(this.readInt8(this.position_+pi+t));return e}__offset(e,t){const n=e-this.readInt32(e);return t<this.readInt16(n)?this.readInt16(n+t):0}__union(e,t){return e.bb_pos=t+this.readInt32(t),e.bb=this,e}__string(e,t){e+=this.readInt32(e);const n=this.readInt32(e);e+=pi;const i=this.bytes_.subarray(e,e+n);return t===ll.UTF8_BYTES?i:this.text_decoder_.decode(i)}__union_with_string(e,t){return typeof e=="string"?this.__string(t):this.__union(e,t)}__indirect(e){return e+this.readInt32(e)}__vector(e){return e+this.readInt32(e)+pi}__vector_len(e){return this.readInt32(e+this.readInt32(e))}__has_identifier(e){if(e.length!=gi)throw new Error("FlatBuffers: file identifier must be length "+gi);for(let t=0;t<gi;t++)if(e.charCodeAt(t)!=this.readInt8(this.position()+pi+t))return!1;return!0}createScalarList(e,t){const n=[];for(let i=0;i<t;++i){const s=e(i);s!==null&&n.push(s)}return n}createObjList(e,t){const n=[];for(let i=0;i<t;++i){const s=e(i);s!==null&&n.push(s.unpack())}return n}}var xe,rt=((xe={})[xe.Byte=0]="Byte",xe[xe.UByte=1]="UByte",xe[xe.Bool=2]="Bool",xe[xe.Short=3]="Short",xe[xe.UShort=4]="UShort",xe[xe.Int=5]="Int",xe[xe.UInt=6]="UInt",xe[xe.Long=7]="Long",xe[xe.ULong=8]="ULong",xe[xe.Float=9]="Float",xe[xe.Double=10]="Double",xe[xe.String=11]="String",xe[xe.Json=12]="Json",xe[xe.DateTime=13]="DateTime",xe[xe.Binary=14]="Binary",xe);class Ke{constructor(){de(this,"bb",null);de(this,"bb_pos",0)}__init(e,t){return this.bb_pos=e,this.bb=t,this}static getRootAsColumn(e,t){return(t||new Ke).__init(e.readInt32(e.position())+e.position(),e)}static getSizePrefixedRootAsColumn(e,t){return e.setPosition(e.position()+is),(t||new Ke).__init(e.readInt32(e.position())+e.position(),e)}name(e){let t=this.bb.__offset(this.bb_pos,4);return t?this.bb.__string(this.bb_pos+t,e):null}type(){let e=this.bb.__offset(this.bb_pos,6);return e?this.bb.readUint8(this.bb_pos+e):rt.Byte}title(e){let t=this.bb.__offset(this.bb_pos,8);return t?this.bb.__string(this.bb_pos+t,e):null}description(e){let t=this.bb.__offset(this.bb_pos,10);return t?this.bb.__string(this.bb_pos+t,e):null}width(){let e=this.bb.__offset(this.bb_pos,12);return e?this.bb.readInt32(this.bb_pos+e):-1}precision(){let e=this.bb.__offset(this.bb_pos,14);return e?this.bb.readInt32(this.bb_pos+e):-1}scale(){let e=this.bb.__offset(this.bb_pos,16);return e?this.bb.readInt32(this.bb_pos+e):-1}nullable(){let e=this.bb.__offset(this.bb_pos,18);return!e||!!this.bb.readInt8(this.bb_pos+e)}unique(){let e=this.bb.__offset(this.bb_pos,20);return!!e&&!!this.bb.readInt8(this.bb_pos+e)}primaryKey(){let e=this.bb.__offset(this.bb_pos,22);return!!e&&!!this.bb.readInt8(this.bb_pos+e)}metadata(e){let t=this.bb.__offset(this.bb_pos,24);return t?this.bb.__string(this.bb_pos+t,e):null}static startColumn(e){e.startObject(11)}static addName(e,t){e.addFieldOffset(0,t,0)}static addType(e,t){e.addFieldInt8(1,t,rt.Byte)}static addTitle(e,t){e.addFieldOffset(2,t,0)}static addDescription(e,t){e.addFieldOffset(3,t,0)}static addWidth(e,t){e.addFieldInt32(4,t,-1)}static addPrecision(e,t){e.addFieldInt32(5,t,-1)}static addScale(e,t){e.addFieldInt32(6,t,-1)}static addNullable(e,t){e.addFieldInt8(7,+t,1)}static addUnique(e,t){e.addFieldInt8(8,+t,0)}static addPrimaryKey(e,t){e.addFieldInt8(9,+t,0)}static addMetadata(e,t){e.addFieldOffset(10,t,0)}static endColumn(e){let t=e.endObject();return e.requiredField(t,4),t}static createColumn(e,t,n,i,s,o,a,l,u,c,h,f){return Ke.startColumn(e),Ke.addName(e,t),Ke.addType(e,n),Ke.addTitle(e,i),Ke.addDescription(e,s),Ke.addWidth(e,o),Ke.addPrecision(e,a),Ke.addScale(e,l),Ke.addNullable(e,u),Ke.addUnique(e,c),Ke.addPrimaryKey(e,h),Ke.addMetadata(e,f),Ke.endColumn(e)}}var he,at=((he={})[he.Unknown=0]="Unknown",he[he.Point=1]="Point",he[he.LineString=2]="LineString",he[he.Polygon=3]="Polygon",he[he.MultiPoint=4]="MultiPoint",he[he.MultiLineString=5]="MultiLineString",he[he.MultiPolygon=6]="MultiPolygon",he[he.GeometryCollection=7]="GeometryCollection",he[he.CircularString=8]="CircularString",he[he.CompoundCurve=9]="CompoundCurve",he[he.CurvePolygon=10]="CurvePolygon",he[he.MultiCurve=11]="MultiCurve",he[he.MultiSurface=12]="MultiSurface",he[he.Curve=13]="Curve",he[he.Surface=14]="Surface",he[he.PolyhedralSurface=15]="PolyhedralSurface",he[he.TIN=16]="TIN",he[he.Triangle=17]="Triangle",he);class pt{constructor(){de(this,"bb",null);de(this,"bb_pos",0)}__init(e,t){return this.bb_pos=e,this.bb=t,this}static getRootAsGeometry(e,t){return(t||new pt).__init(e.readInt32(e.position())+e.position(),e)}static getSizePrefixedRootAsGeometry(e,t){return e.setPosition(e.position()+is),(t||new pt).__init(e.readInt32(e.position())+e.position(),e)}ends(e){let t=this.bb.__offset(this.bb_pos,4);return t?this.bb.readUint32(this.bb.__vector(this.bb_pos+t)+4*e):0}endsLength(){let e=this.bb.__offset(this.bb_pos,4);return e?this.bb.__vector_len(this.bb_pos+e):0}endsArray(){let e=this.bb.__offset(this.bb_pos,4);return e?new Uint32Array(this.bb.bytes().buffer,this.bb.bytes().byteOffset+this.bb.__vector(this.bb_pos+e),this.bb.__vector_len(this.bb_pos+e)):null}xy(e){let t=this.bb.__offset(this.bb_pos,6);return t?this.bb.readFloat64(this.bb.__vector(this.bb_pos+t)+8*e):0}xyLength(){let e=this.bb.__offset(this.bb_pos,6);return e?this.bb.__vector_len(this.bb_pos+e):0}xyArray(){let e=this.bb.__offset(this.bb_pos,6);return e?new Float64Array(this.bb.bytes().buffer,this.bb.bytes().byteOffset+this.bb.__vector(this.bb_pos+e),this.bb.__vector_len(this.bb_pos+e)):null}z(e){let t=this.bb.__offset(this.bb_pos,8);return t?this.bb.readFloat64(this.bb.__vector(this.bb_pos+t)+8*e):0}zLength(){let e=this.bb.__offset(this.bb_pos,8);return e?this.bb.__vector_len(this.bb_pos+e):0}zArray(){let e=this.bb.__offset(this.bb_pos,8);return e?new Float64Array(this.bb.bytes().buffer,this.bb.bytes().byteOffset+this.bb.__vector(this.bb_pos+e),this.bb.__vector_len(this.bb_pos+e)):null}m(e){let t=this.bb.__offset(this.bb_pos,10);return t?this.bb.readFloat64(this.bb.__vector(this.bb_pos+t)+8*e):0}mLength(){let e=this.bb.__offset(this.bb_pos,10);return e?this.bb.__vector_len(this.bb_pos+e):0}mArray(){let e=this.bb.__offset(this.bb_pos,10);return e?new Float64Array(this.bb.bytes().buffer,this.bb.bytes().byteOffset+this.bb.__vector(this.bb_pos+e),this.bb.__vector_len(this.bb_pos+e)):null}t(e){let t=this.bb.__offset(this.bb_pos,12);return t?this.bb.readFloat64(this.bb.__vector(this.bb_pos+t)+8*e):0}tLength(){let e=this.bb.__offset(this.bb_pos,12);return e?this.bb.__vector_len(this.bb_pos+e):0}tArray(){let e=this.bb.__offset(this.bb_pos,12);return e?new Float64Array(this.bb.bytes().buffer,this.bb.bytes().byteOffset+this.bb.__vector(this.bb_pos+e),this.bb.__vector_len(this.bb_pos+e)):null}tm(e){let t=this.bb.__offset(this.bb_pos,14);return t?this.bb.readUint64(this.bb.__vector(this.bb_pos+t)+8*e):BigInt(0)}tmLength(){let e=this.bb.__offset(this.bb_pos,14);return e?this.bb.__vector_len(this.bb_pos+e):0}type(){let e=this.bb.__offset(this.bb_pos,16);return e?this.bb.readUint8(this.bb_pos+e):at.Unknown}parts(e,t){let n=this.bb.__offset(this.bb_pos,18);return n?(t||new pt).__init(this.bb.__indirect(this.bb.__vector(this.bb_pos+n)+4*e),this.bb):null}partsLength(){let e=this.bb.__offset(this.bb_pos,18);return e?this.bb.__vector_len(this.bb_pos+e):0}static startGeometry(e){e.startObject(8)}static addEnds(e,t){e.addFieldOffset(0,t,0)}static createEndsVector(e,t){e.startVector(4,t.length,4);for(let n=t.length-1;n>=0;n--)e.addInt32(t[n]);return e.endVector()}static startEndsVector(e,t){e.startVector(4,t,4)}static addXy(e,t){e.addFieldOffset(1,t,0)}static createXyVector(e,t){e.startVector(8,t.length,8);for(let n=t.length-1;n>=0;n--)e.addFloat64(t[n]);return e.endVector()}static startXyVector(e,t){e.startVector(8,t,8)}static addZ(e,t){e.addFieldOffset(2,t,0)}static createZVector(e,t){e.startVector(8,t.length,8);for(let n=t.length-1;n>=0;n--)e.addFloat64(t[n]);return e.endVector()}static startZVector(e,t){e.startVector(8,t,8)}static addM(e,t){e.addFieldOffset(3,t,0)}static createMVector(e,t){e.startVector(8,t.length,8);for(let n=t.length-1;n>=0;n--)e.addFloat64(t[n]);return e.endVector()}static startMVector(e,t){e.startVector(8,t,8)}static addT(e,t){e.addFieldOffset(4,t,0)}static createTVector(e,t){e.startVector(8,t.length,8);for(let n=t.length-1;n>=0;n--)e.addFloat64(t[n]);return e.endVector()}static startTVector(e,t){e.startVector(8,t,8)}static addTm(e,t){e.addFieldOffset(5,t,0)}static createTmVector(e,t){e.startVector(8,t.length,8);for(let n=t.length-1;n>=0;n--)e.addInt64(t[n]);return e.endVector()}static startTmVector(e,t){e.startVector(8,t,8)}static addType(e,t){e.addFieldInt8(6,t,at.Unknown)}static addParts(e,t){e.addFieldOffset(7,t,0)}static createPartsVector(e,t){e.startVector(4,t.length,4);for(let n=t.length-1;n>=0;n--)e.addOffset(t[n]);return e.endVector()}static startPartsVector(e,t){e.startVector(4,t,4)}static endGeometry(e){return e.endObject()}static createGeometry(e,t,n,i,s,o,a,l,u){return pt.startGeometry(e),pt.addEnds(e,t),pt.addXy(e,n),pt.addZ(e,i),pt.addM(e,s),pt.addT(e,o),pt.addTm(e,a),pt.addType(e,l),pt.addParts(e,u),pt.endGeometry(e)}}class Dt{constructor(){de(this,"bb",null);de(this,"bb_pos",0)}__init(e,t){return this.bb_pos=e,this.bb=t,this}static getRootAsFeature(e,t){return(t||new Dt).__init(e.readInt32(e.position())+e.position(),e)}static getSizePrefixedRootAsFeature(e,t){return e.setPosition(e.position()+is),(t||new Dt).__init(e.readInt32(e.position())+e.position(),e)}geometry(e){let t=this.bb.__offset(this.bb_pos,4);return t?(e||new pt).__init(this.bb.__indirect(this.bb_pos+t),this.bb):null}properties(e){let t=this.bb.__offset(this.bb_pos,6);return t?this.bb.readUint8(this.bb.__vector(this.bb_pos+t)+e):0}propertiesLength(){let e=this.bb.__offset(this.bb_pos,6);return e?this.bb.__vector_len(this.bb_pos+e):0}propertiesArray(){let e=this.bb.__offset(this.bb_pos,6);return e?new Uint8Array(this.bb.bytes().buffer,this.bb.bytes().byteOffset+this.bb.__vector(this.bb_pos+e),this.bb.__vector_len(this.bb_pos+e)):null}columns(e,t){let n=this.bb.__offset(this.bb_pos,8);return n?(t||new Ke).__init(this.bb.__indirect(this.bb.__vector(this.bb_pos+n)+4*e),this.bb):null}columnsLength(){let e=this.bb.__offset(this.bb_pos,8);return e?this.bb.__vector_len(this.bb_pos+e):0}static startFeature(e){e.startObject(3)}static addGeometry(e,t){e.addFieldOffset(0,t,0)}static addProperties(e,t){e.addFieldOffset(1,t,0)}static createPropertiesVector(e,t){e.startVector(1,t.length,1);for(let n=t.length-1;n>=0;n--)e.addInt8(t[n]);return e.endVector()}static startPropertiesVector(e,t){e.startVector(1,t,1)}static addColumns(e,t){e.addFieldOffset(2,t,0)}static createColumnsVector(e,t){e.startVector(4,t.length,4);for(let n=t.length-1;n>=0;n--)e.addOffset(t[n]);return e.endVector()}static startColumnsVector(e,t){e.startVector(4,t,4)}static endFeature(e){return e.endObject()}static finishFeatureBuffer(e,t){e.finish(t)}static finishSizePrefixedFeatureBuffer(e,t){e.finish(t,void 0,!0)}static createFeature(e,t,n,i){return Dt.startFeature(e),Dt.addGeometry(e,t),Dt.addProperties(e,n),Dt.addColumns(e,i),Dt.endFeature(e)}}function Ea(r,e){let t=[];for(let n=0;n<r.length;n+=2){let i=[r[n],r[n+1]];e&&i.push(e[n>>1]),t.push(i)}return t}new TextEncoder;let ef=new TextDecoder;function wS(r,e){let t={};if(!e||e.length===0)return t;let n=r.propertiesArray();if(!n)return t;let i=new DataView(n.buffer,n.byteOffset),s=r.propertiesLength(),o=0;for(;o<s;){let a=i.getUint16(o,!0);o+=2;let l=e[a],u=l.name;switch(l.type){case rt.Bool:t[u]=!!i.getUint8(o),o+=1;break;case rt.Byte:t[u]=i.getInt8(o),o+=1;break;case rt.UByte:t[u]=i.getUint8(o),o+=1;break;case rt.Short:t[u]=i.getInt16(o,!0),o+=2;break;case rt.UShort:t[u]=i.getUint16(o,!0),o+=2;break;case rt.Int:t[u]=i.getInt32(o,!0),o+=4;break;case rt.UInt:t[u]=i.getUint32(o,!0),o+=4;break;case rt.Long:t[u]=Number(i.getBigInt64(o,!0)),o+=8;break;case rt.ULong:t[u]=Number(i.getBigUint64(o,!0)),o+=8;break;case rt.Float:t[u]=i.getFloat32(o,!0),o+=4;break;case rt.Double:t[u]=i.getFloat64(o,!0),o+=8;break;case rt.DateTime:case rt.String:{let c=i.getUint32(o,!0);o+=4,t[u]=ef.decode(n.subarray(o,o+c)),o+=c;break}case rt.Json:{let c=i.getUint32(o,!0);o+=4;let h=ef.decode(n.subarray(o,o+c));t[u]=JSON.parse(h),o+=c;break}case rt.Binary:{let c=i.getUint32(o,!0);o+=4,t[u]=n.subarray(o,o+c),o+=c;break}default:throw Error(`Unknown type ${l.type}`)}}return t}const Zu=new Uint8Array(0);function vS(){return this._source.cancel()}function TS(r,e){if(!r.length)return e;if(!e.length)return r;var t=new Uint8Array(r.length+e.length);return t.set(r),t.set(e,r.length),t}function SS(){var r=this,e=r._array.subarray(r._index);return r._source.read().then(function(t){return r._array=Zu,r._index=0,t.done?e.length>0?{done:!1,value:e}:{done:!0,value:void 0}:{done:!1,value:TS(e,t.value)}})}function RS(r){if((r|=0)<0)throw new Error("invalid length");var e=this,t=this._array.length-this._index;if(this._index+r<=this._array.length)return Promise.resolve(this._array.subarray(this._index,this._index+=r));var n=new Uint8Array(r);return n.set(this._array.subarray(this._index)),function i(){return e._source.read().then(function(s){return s.done?(e._array=Zu,e._index=0,t>0?n.subarray(0,t):null):t+s.value.length>=r?(e._array=s.value,e._index=r-t,n.set(s.value.subarray(0,r-t),t),n):(n.set(s.value,t),t+=s.value.length,i())})}()}function PS(r){return typeof r.slice=="function"?r:new Bo(typeof r.read=="function"?r:r.getReader())}function Bo(r){this._source=r,this._array=Zu,this._index=0}Bo.prototype.read=SS;Bo.prototype.slice=RS;Bo.prototype.cancel=vS;class Nt{constructor(){de(this,"bb",null);de(this,"bb_pos",0)}__init(e,t){return this.bb_pos=e,this.bb=t,this}static getRootAsCrs(e,t){return(t||new Nt).__init(e.readInt32(e.position())+e.position(),e)}static getSizePrefixedRootAsCrs(e,t){return e.setPosition(e.position()+is),(t||new Nt).__init(e.readInt32(e.position())+e.position(),e)}org(e){let t=this.bb.__offset(this.bb_pos,4);return t?this.bb.__string(this.bb_pos+t,e):null}code(){let e=this.bb.__offset(this.bb_pos,6);return e?this.bb.readInt32(this.bb_pos+e):0}name(e){let t=this.bb.__offset(this.bb_pos,8);return t?this.bb.__string(this.bb_pos+t,e):null}description(e){let t=this.bb.__offset(this.bb_pos,10);return t?this.bb.__string(this.bb_pos+t,e):null}wkt(e){let t=this.bb.__offset(this.bb_pos,12);return t?this.bb.__string(this.bb_pos+t,e):null}codeString(e){let t=this.bb.__offset(this.bb_pos,14);return t?this.bb.__string(this.bb_pos+t,e):null}static startCrs(e){e.startObject(6)}static addOrg(e,t){e.addFieldOffset(0,t,0)}static addCode(e,t){e.addFieldInt32(1,t,0)}static addName(e,t){e.addFieldOffset(2,t,0)}static addDescription(e,t){e.addFieldOffset(3,t,0)}static addWkt(e,t){e.addFieldOffset(4,t,0)}static addCodeString(e,t){e.addFieldOffset(5,t,0)}static endCrs(e){return e.endObject()}static createCrs(e,t,n,i,s,o,a){return Nt.startCrs(e),Nt.addOrg(e,t),Nt.addCode(e,n),Nt.addName(e,i),Nt.addDescription(e,s),Nt.addWkt(e,o),Nt.addCodeString(e,a),Nt.endCrs(e)}}class Qs{constructor(){de(this,"bb",null);de(this,"bb_pos",0)}__init(e,t){return this.bb_pos=e,this.bb=t,this}static getRootAsHeader(e,t){return(t||new Qs).__init(e.readInt32(e.position())+e.position(),e)}static getSizePrefixedRootAsHeader(e,t){return e.setPosition(e.position()+is),(t||new Qs).__init(e.readInt32(e.position())+e.position(),e)}name(e){let t=this.bb.__offset(this.bb_pos,4);return t?this.bb.__string(this.bb_pos+t,e):null}envelope(e){let t=this.bb.__offset(this.bb_pos,6);return t?this.bb.readFloat64(this.bb.__vector(this.bb_pos+t)+8*e):0}envelopeLength(){let e=this.bb.__offset(this.bb_pos,6);return e?this.bb.__vector_len(this.bb_pos+e):0}envelopeArray(){let e=this.bb.__offset(this.bb_pos,6);return e?new Float64Array(this.bb.bytes().buffer,this.bb.bytes().byteOffset+this.bb.__vector(this.bb_pos+e),this.bb.__vector_len(this.bb_pos+e)):null}geometryType(){let e=this.bb.__offset(this.bb_pos,8);return e?this.bb.readUint8(this.bb_pos+e):at.Unknown}hasZ(){let e=this.bb.__offset(this.bb_pos,10);return!!e&&!!this.bb.readInt8(this.bb_pos+e)}hasM(){let e=this.bb.__offset(this.bb_pos,12);return!!e&&!!this.bb.readInt8(this.bb_pos+e)}hasT(){let e=this.bb.__offset(this.bb_pos,14);return!!e&&!!this.bb.readInt8(this.bb_pos+e)}hasTm(){let e=this.bb.__offset(this.bb_pos,16);return!!e&&!!this.bb.readInt8(this.bb_pos+e)}columns(e,t){let n=this.bb.__offset(this.bb_pos,18);return n?(t||new Ke).__init(this.bb.__indirect(this.bb.__vector(this.bb_pos+n)+4*e),this.bb):null}columnsLength(){let e=this.bb.__offset(this.bb_pos,18);return e?this.bb.__vector_len(this.bb_pos+e):0}featuresCount(){let e=this.bb.__offset(this.bb_pos,20);return e?this.bb.readUint64(this.bb_pos+e):BigInt("0")}indexNodeSize(){let e=this.bb.__offset(this.bb_pos,22);return e?this.bb.readUint16(this.bb_pos+e):16}crs(e){let t=this.bb.__offset(this.bb_pos,24);return t?(e||new Nt).__init(this.bb.__indirect(this.bb_pos+t),this.bb):null}title(e){let t=this.bb.__offset(this.bb_pos,26);return t?this.bb.__string(this.bb_pos+t,e):null}description(e){let t=this.bb.__offset(this.bb_pos,28);return t?this.bb.__string(this.bb_pos+t,e):null}metadata(e){let t=this.bb.__offset(this.bb_pos,30);return t?this.bb.__string(this.bb_pos+t,e):null}static startHeader(e){e.startObject(14)}static addName(e,t){e.addFieldOffset(0,t,0)}static addEnvelope(e,t){e.addFieldOffset(1,t,0)}static createEnvelopeVector(e,t){e.startVector(8,t.length,8);for(let n=t.length-1;n>=0;n--)e.addFloat64(t[n]);return e.endVector()}static startEnvelopeVector(e,t){e.startVector(8,t,8)}static addGeometryType(e,t){e.addFieldInt8(2,t,at.Unknown)}static addHasZ(e,t){e.addFieldInt8(3,+t,0)}static addHasM(e,t){e.addFieldInt8(4,+t,0)}static addHasT(e,t){e.addFieldInt8(5,+t,0)}static addHasTm(e,t){e.addFieldInt8(6,+t,0)}static addColumns(e,t){e.addFieldOffset(7,t,0)}static createColumnsVector(e,t){e.startVector(4,t.length,4);for(let n=t.length-1;n>=0;n--)e.addOffset(t[n]);return e.endVector()}static startColumnsVector(e,t){e.startVector(4,t,4)}static addFeaturesCount(e,t){e.addFieldInt64(8,t,BigInt("0"))}static addIndexNodeSize(e,t){e.addFieldInt16(9,t,16)}static addCrs(e,t){e.addFieldOffset(10,t,0)}static addTitle(e,t){e.addFieldOffset(11,t,0)}static addDescription(e,t){e.addFieldOffset(12,t,0)}static addMetadata(e,t){e.addFieldOffset(13,t,0)}static endHeader(e){return e.endObject()}static finishHeaderBuffer(e,t){e.finish(t)}static finishSizePrefixedHeaderBuffer(e,t){e.finish(t,void 0,!0)}}function Go(r){let e=Qs.getRootAsHeader(r),t=e.featuresCount(),n=e.indexNodeSize(),i=[];for(let a=0;a<e.columnsLength();a++){let l=e.columns(a);if(!l)throw Error("Column unexpectedly missing");if(!l.name())throw Error("Column name unexpectedly missing");i.push({name:l.name(),type:l.type(),title:l.title(),description:l.description(),width:l.width(),precision:l.precision(),scale:l.scale(),nullable:l.nullable(),unique:l.unique(),primary_key:l.primaryKey()})}let s=e.crs(),o=s?{org:s.org(),code:s.code(),name:s.name(),description:s.description(),wkt:s.wkt(),code_string:s.codeString()}:null;return{geometryType:e.geometryType(),columns:i,envelope:null,featuresCount:Number(t),indexNodeSize:n,crs:o,title:e.title(),description:e.description(),metadata:e.metadata()}}const io=class io{constructor(){de(this,"_extraRequestThreshold",262144)}extraRequestThreshold(){return this._extraRequestThreshold}setExtraRequestThreshold(e){if(e<0)throw Error("extraRequestThreshold cannot be negative");this._extraRequestThreshold=e}};de(io,"global",new io);let eo=io;const AS=40,IS=16;function zo(r,e){e=Math.min(Math.max(+e,2),65535);let t=r,n=t;do n+=t=Math.ceil(t/e);while(t!==1);return 40*n}function CS(r,e){if(e<2)throw Error("Node size must be at least 2");if(r===0)throw Error("Number of items must be greater than 0");let t=r,n=t,i=[t];do n+=t=Math.ceil(t/e),i.push(t);while(t!==1);let s=[];for(let a of(t=n,i))s.push(t-a),t-=a;let o=[];for(let a=0;a<i.length;a++)o.push([s[a],s[a]+i[a]]);return o}async function*ng(r,e,t,n){class i{constructor(p,d){de(this,"_level");de(this,"nodes");this._level=d,this.nodes=p}level(){return this._level}startNodeIdx(){return this.nodes[0]}endNodeIdx(){return this.nodes[1]}extendEndNodeIdx(p){this.nodes[1]=p}toString(){return`[NodeRange level: ${this._level}, nodes: ${this.nodes[0]}-${this.nodes[1]}]`}}let{minX:s,minY:o,maxX:a,maxY:l}=t,u=CS(r,e),c=u[0][0],h=[new i([0,1],u.length-1)];for(;h.length!==0;){let f=h.shift(),p=f.startNodeIdx(),d=p>=c,g=(()=>{let[,_]=u[f.level()],b=Math.min(f.endNodeIdx()+e,_);return d&&b<_?b+1:b})(),m=g-p,y=new DataView(await n(40*p,40*m));for(let _=p;_<g;_++){let b=_-p,w=40*b;if(a<y.getFloat64(w+0,!0)||l<y.getFloat64(w+8,!0)||s>y.getFloat64(w+16,!0)||o>y.getFloat64(w+24,!0))continue;let x=y.getBigUint64(w+32,!0);if(d){let P=(()=>{if(_<r-1){let I=(b+1)*40;return y.getBigUint64(I+32,!0)-x}return null})(),S=_-c;yield[Number(x),S,Number(P)];continue}let E=eo.global.extraRequestThreshold()/40,v=h[h.length-1];if(v!==void 0&&v.level()===f.level()-1&&x<v.endNodeIdx()+E){v.extendEndNodeIdx(Number(x));continue}let A=(()=>{let P=f.level()-1;return new i([Number(x),Number(x)+1],P)})();v!==void 0&&(v.level(),A.level()),h.push(A)}}}class Wu{constructor(e,t,n,i){de(this,"bytes");de(this,"header");de(this,"headerLength");de(this,"indexLength");this.bytes=e,this.header=t,this.headerLength=n,this.indexLength=i}static open(e){if(!e.subarray(0,3).every((o,a)=>yr[a]===o))throw Error("Not a FlatGeobuf file");let t=new DataView(e.buffer).getUint32(8,!0);if(t>10485760||t<8)throw Error("Invalid header size");let n=e.subarray(12,12+t),i=Go(new Ht(n)),s=zo(i.featuresCount,i.indexNodeSize);return new Wu(e,i,t,s)}async*selectBbox(e){let t=this.lengthBeforeTree(),n=async(i,s)=>{let o=t+i;return this.bytes.slice(o,o+s).buffer};for await(let i of ng(this.header.featuresCount,this.header.indexNodeSize,e,n)){let[s,o]=i,a=this.readFeature(s);yield{id:o,feature:a}}}lengthBeforeTree(){return yr.length+Pt+this.headerLength}lengthBeforeFeatures(){return this.lengthBeforeTree()+this.indexLength}readFeature(e){let t=e+this.lengthBeforeFeatures(),n=new DataView(this.bytes.buffer).getUint32(t,!0),i=this.bytes.subarray(t+4,t+4+n),s=new Uint8Array(n+Pt);s.set(i,Pt);let o=new Ht(s);return o.setPosition(Pt),Dt.getRootAsFeature(o)}}/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */var ul=function(r,e){return ul=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var i in n)n.hasOwnProperty(i)&&(t[i]=n[i])},ul(r,e)};function LS(r,e){ul(r,e);function t(){this.constructor=r}r.prototype=e===null?Object.create(e):(t.prototype=e.prototype,new t)}function Zn(r,e,t,n){function i(s){return s instanceof t?s:new t(function(o){o(s)})}return new(t||(t=Promise))(function(s,o){function a(c){try{u(n.next(c))}catch(h){o(h)}}function l(c){try{u(n.throw(c))}catch(h){o(h)}}function u(c){c.done?s(c.value):i(c.value).then(a,l)}u((n=n.apply(r,[])).next())})}function $r(r,e){var t={label:0,sent:function(){if(s[0]&1)throw s[1];return s[1]},trys:[],ops:[]},n,i,s,o;return o={next:a(0),throw:a(1),return:a(2)},typeof Symbol=="function"&&(o[Symbol.iterator]=function(){return this}),o;function a(u){return function(c){return l([u,c])}}function l(u){if(n)throw new TypeError("Generator is already executing.");for(;t;)try{if(n=1,i&&(s=u[0]&2?i.return:u[0]?i.throw||((s=i.return)&&s.call(i),0):i.next)&&!(s=s.call(i,u[1])).done)return s;switch(i=0,s&&(u=[u[0]&2,s.value]),u[0]){case 0:case 1:s=u;break;case 4:return t.label++,{value:u[1],done:!1};case 5:t.label++,i=u[1],u=[0];continue;case 7:u=t.ops.pop(),t.trys.pop();continue;default:if(s=t.trys,!(s=s.length>0&&s[s.length-1])&&(u[0]===6||u[0]===2)){t=0;continue}if(u[0]===3&&(!s||u[1]>s[0]&&u[1]<s[3])){t.label=u[1];break}if(u[0]===6&&t.label<s[1]){t.label=s[1],s=u;break}if(s&&t.label<s[2]){t.label=s[2],t.ops.push(u);break}s[2]&&t.ops.pop(),t.trys.pop();continue}u=e.call(r,t)}catch(c){u=[6,c],i=0}finally{n=s=0}if(u[0]&5)throw u[1];return{value:u[0]?u[1]:void 0,done:!0}}}function oi(r){var e=typeof Symbol=="function"&&Symbol.iterator,t=e&&r[e],n=0;if(t)return t.call(r);if(r&&typeof r.length=="number")return{next:function(){return r&&n>=r.length&&(r=void 0),{value:r&&r[n++],done:!r}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function ki(r){return this instanceof ki?(this.v=r,this):new ki(r)}function FS(r,e,t){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var n=t.apply(r,e||[]),i,s=[];return i={},o("next"),o("throw"),o("return"),i[Symbol.asyncIterator]=function(){return this},i;function o(f){n[f]&&(i[f]=function(p){return new Promise(function(d,g){s.push([f,p,d,g])>1||a(f,p)})})}function a(f,p){try{l(n[f](p))}catch(d){h(s[0][3],d)}}function l(f){f.value instanceof ki?Promise.resolve(f.value.v).then(u,c):h(s[0][2],f)}function u(f){a("next",f)}function c(f){a("throw",f)}function h(f,p){f(p),s.shift(),s.length&&a(s[0][0],s[0][1])}}var ig=function(r){LS(e,r);function e(t){var n=r.call(this,t)||this;return Object.defineProperty(n,"name",{value:"RepeaterOverflowError",enumerable:!1}),typeof Object.setPrototypeOf=="function"?Object.setPrototypeOf(n,n.constructor.prototype):n.__proto__=n.constructor.prototype,typeof Error.captureStackTrace=="function"&&Error.captureStackTrace(n,n.constructor),n}return e}(Error);(function(){function r(e){if(e<0)throw new RangeError("Capacity may not be less than 0");this._c=e,this._q=[]}return Object.defineProperty(r.prototype,"empty",{get:function(){return this._q.length===0},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"full",{get:function(){return this._q.length>=this._c},enumerable:!1,configurable:!0}),r.prototype.add=function(e){if(this.full)throw new Error("Buffer full");this._q.push(e)},r.prototype.remove=function(){if(this.empty)throw new Error("Buffer empty");return this._q.shift()},r})();(function(){function r(e){if(e<1)throw new RangeError("Capacity may not be less than 1");this._c=e,this._q=[]}return Object.defineProperty(r.prototype,"empty",{get:function(){return this._q.length===0},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"full",{get:function(){return!1},enumerable:!1,configurable:!0}),r.prototype.add=function(e){for(;this._q.length>=this._c;)this._q.shift();this._q.push(e)},r.prototype.remove=function(){if(this.empty)throw new Error("Buffer empty");return this._q.shift()},r})();(function(){function r(e){if(e<1)throw new RangeError("Capacity may not be less than 1");this._c=e,this._q=[]}return Object.defineProperty(r.prototype,"empty",{get:function(){return this._q.length===0},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"full",{get:function(){return!1},enumerable:!1,configurable:!0}),r.prototype.add=function(e){this._q.length<this._c&&this._q.push(e)},r.prototype.remove=function(){if(this.empty)throw new Error("Buffer empty");return this._q.shift()},r})();function cl(r){r!=null&&typeof r.then=="function"&&r.then(no,no)}var wa=0,tf=1,dn=2,to=3,hl=4,ro=1024,no=function(){};function Bn(r){var e=r.err,t=Promise.resolve(r.execution).then(function(n){if(e!=null)throw e;return n});return r.err=void 0,r.execution=t.then(function(){},function(){}),r.pending===void 0?t:r.pending.then(function(){return t})}function Jr(r,e){var t=r.state>=to;return Promise.resolve(e).then(function(n){return!t&&r.state>=hl?Bn(r).then(function(i){return{value:i,done:!0}}):{value:n,done:t}})}function qu(r,e){var t,n;if(!(r.state>=dn))if(r.state=dn,r.onnext(),r.onstop(),r.err==null&&(r.err=e),r.pushes.length===0&&(typeof r.buffer>"u"||r.buffer.empty))Si(r);else try{for(var i=oi(r.pushes),s=i.next();!s.done;s=i.next()){var o=s.value;o.resolve()}}catch(a){t={error:a}}finally{try{s&&!s.done&&(n=i.return)&&n.call(i)}finally{if(t)throw t.error}}}function Si(r){var e,t;if(!(r.state>=to)){r.state<dn&&qu(r),r.state=to,r.buffer=void 0;try{for(var n=oi(r.nexts),i=n.next();!i.done;i=n.next()){var s=i.value,o=r.pending===void 0?Bn(r):r.pending.then(function(){return Bn(r)});s.resolve(Jr(r,o))}}catch(a){e={error:a}}finally{try{i&&!i.done&&(t=n.return)&&t.call(n)}finally{if(e)throw e.error}}r.pushes=[],r.nexts=[]}}function rf(r){r.state>=hl||(r.state<to&&Si(r),r.state=hl)}function MS(r,e){if(cl(e),r.pushes.length>=ro)throw new ig("No more than "+ro+" pending calls to push are allowed on a single repeater.");if(r.state>=dn)return Promise.resolve(void 0);var t=r.pending===void 0?Promise.resolve(e):r.pending.then(function(){return e});t=t.catch(function(l){r.state<dn&&(r.err=l),rf(r)});var n;if(r.nexts.length){var i=r.nexts.shift();i.resolve(Jr(r,t)),r.nexts.length?n=Promise.resolve(r.nexts[0].value):typeof r.buffer<"u"&&!r.buffer.full?n=Promise.resolve(void 0):n=new Promise(function(l){return r.onnext=l})}else typeof r.buffer<"u"&&!r.buffer.full?(r.buffer.add(t),n=Promise.resolve(void 0)):n=new Promise(function(l){return r.pushes.push({resolve:l,value:t})});var s=!0,o={},a=n.catch(function(l){if(s)throw l});return o.then=function(l,u){return s=!1,Promise.prototype.then.call(n,l,u)},o.catch=function(l){return s=!1,Promise.prototype.catch.call(n,l)},o.finally=n.finally.bind(n),r.pending=t.then(function(){return a}).catch(function(l){r.err=l,rf(r)}),o}function OS(r){var e=qu.bind(null,r),t=new Promise(function(n){return r.onstop=n});return e.then=t.then.bind(t),e.catch=t.catch.bind(t),e.finally=t.finally.bind(t),e}function NS(r){if(!(r.state>=tf)){r.state=tf;var e=MS.bind(null,r),t=OS(r);r.execution=new Promise(function(n){return n(r.executor(e,t))}),r.execution.catch(function(){return qu(r)})}}var bs=new WeakMap,ss=function(){function r(e,t){bs.set(this,{executor:e,buffer:t,err:void 0,state:wa,pushes:[],nexts:[],pending:void 0,execution:void 0,onnext:no,onstop:no})}return r.prototype.next=function(e){cl(e);var t=bs.get(this);if(t===void 0)throw new Error("WeakMap error");if(t.nexts.length>=ro)throw new ig("No more than "+ro+" pending calls to next are allowed on a single repeater.");if(t.state<=wa&&NS(t),t.onnext(e),typeof t.buffer<"u"&&!t.buffer.empty){var n=Jr(t,t.buffer.remove());if(t.pushes.length){var i=t.pushes.shift();t.buffer.add(i.value),t.onnext=i.resolve}return n}else if(t.pushes.length){var s=t.pushes.shift();return t.onnext=s.resolve,Jr(t,s.value)}else if(t.state>=dn)return Si(t),Jr(t,Bn(t));return new Promise(function(o){return t.nexts.push({resolve:o,value:e})})},r.prototype.return=function(e){cl(e);var t=bs.get(this);if(t===void 0)throw new Error("WeakMap error");return Si(t),t.execution=Promise.resolve(t.execution).then(function(){return e}),Jr(t,Bn(t))},r.prototype.throw=function(e){var t=bs.get(this);if(t===void 0)throw new Error("WeakMap error");return t.state<=wa||t.state>=dn||typeof t.buffer<"u"&&!t.buffer.empty?(Si(t),t.err==null&&(t.err=e),Jr(t,Bn(t))):this.next(Promise.reject(e))},r.prototype[Symbol.asyncIterator]=function(){return this},r.race=DS,r.merge=US,r.zip=BS,r.latest=GS,r}();function ko(r,e){var t,n,i=[],s=function(u){u!=null&&typeof u[Symbol.asyncIterator]=="function"?i.push(u[Symbol.asyncIterator]()):u!=null&&typeof u[Symbol.iterator]=="function"?i.push(u[Symbol.iterator]()):i.push(function(){return FS(this,arguments,function(){return $r(this,function(f){switch(f.label){case 0:return e.yieldValues?[4,ki(u)]:[3,3];case 1:return[4,f.sent()];case 2:f.sent(),f.label=3;case 3:return e.returnValues?[4,ki(u)]:[3,5];case 4:return[2,f.sent()];case 5:return[2]}})})}())};try{for(var o=oi(r),a=o.next();!a.done;a=o.next()){var l=a.value;s(l)}}catch(u){t={error:u}}finally{try{a&&!a.done&&(n=o.return)&&n.call(o)}finally{if(t)throw t.error}}return i}function DS(r){var e=this,t=ko(r,{returnValues:!0});return new ss(function(n,i){return Zn(e,void 0,void 0,function(){var s,o,a,l,u,c;return $r(this,function(h){switch(h.label){case 0:if(!t.length)return i(),[2];o=!1,i.then(function(){s(),o=!0}),h.label=1;case 1:h.trys.push([1,,5,7]),l=void 0,u=0,c=function(){var f,p,d,g,m,y;return $r(this,function(_){switch(_.label){case 0:f=u;try{for(p=(m=void 0,oi(t)),d=p.next();!d.done;d=p.next())g=d.value,Promise.resolve(g.next()).then(function(b){b.done?(i(),a===void 0&&(a=b)):u===f&&(u++,s(b))},function(b){return i(b)})}catch(b){m={error:b}}finally{try{d&&!d.done&&(y=p.return)&&y.call(p)}finally{if(m)throw m.error}}return[4,new Promise(function(b){return s=b})];case 1:return l=_.sent(),l===void 0?[3,3]:[4,n(l.value)];case 2:_.sent(),_.label=3;case 3:return[2]}})},h.label=2;case 2:return o?[3,4]:[5,c()];case 3:return h.sent(),[3,2];case 4:return[2,a&&a.value];case 5:return i(),[4,Promise.race(t.map(function(f){return f.return&&f.return()}))];case 6:return h.sent(),[7];case 7:return[2]}})})})}function US(r){var e=this,t=ko(r,{yieldValues:!0});return new ss(function(n,i){return Zn(e,void 0,void 0,function(){var s,o,a,l=this;return $r(this,function(u){switch(u.label){case 0:if(!t.length)return i(),[2];s=[],o=!1,i.then(function(){var c,h;o=!0;try{for(var f=oi(s),p=f.next();!p.done;p=f.next()){var d=p.value;d()}}catch(g){c={error:g}}finally{try{p&&!p.done&&(h=f.return)&&h.call(f)}finally{if(c)throw c.error}}}),u.label=1;case 1:return u.trys.push([1,,3,4]),[4,Promise.all(t.map(function(c,h){return Zn(l,void 0,void 0,function(){var f,p;return $r(this,function(d){switch(d.label){case 0:d.trys.push([0,,6,9]),d.label=1;case 1:return o?[3,5]:(Promise.resolve(c.next()).then(function(g){return s[h](g)},function(g){return i(g)}),[4,new Promise(function(g){s[h]=g})]);case 2:return f=d.sent(),f===void 0?[3,4]:f.done?(a=f,[2]):[4,n(f.value)];case 3:d.sent(),d.label=4;case 4:return[3,1];case 5:return[3,9];case 6:return p=c.return,p?[4,c.return()]:[3,8];case 7:p=d.sent(),d.label=8;case 8:return[7];case 9:return[2]}})})}))];case 2:return u.sent(),[2,a&&a.value];case 3:return i(),[7];case 4:return[2]}})})})}function BS(r){var e=this,t=ko(r,{returnValues:!0});return new ss(function(n,i){return Zn(e,void 0,void 0,function(){var s,o,a,l;return $r(this,function(u){switch(u.label){case 0:if(!t.length)return i(),[2,[]];o=!1,i.then(function(){s(),o=!0}),u.label=1;case 1:u.trys.push([1,,6,8]),u.label=2;case 2:return o?[3,5]:(Promise.all(t.map(function(c){return c.next()})).then(function(c){return s(c)},function(c){return i(c)}),[4,new Promise(function(c){return s=c})]);case 3:return a=u.sent(),a===void 0?[2]:(l=a.map(function(c){return c.value}),a.some(function(c){return c.done})?[2,l]:[4,n(l)]);case 4:return u.sent(),[3,2];case 5:return[3,8];case 6:return i(),[4,Promise.all(t.map(function(c){return c.return&&c.return()}))];case 7:return u.sent(),[7];case 8:return[2]}})})})}function GS(r){var e=this,t=ko(r,{yieldValues:!0,returnValues:!0});return new ss(function(n,i){return Zn(e,void 0,void 0,function(){var s,o,a,l,u,c=this;return $r(this,function(h){switch(h.label){case 0:if(!t.length)return i(),[2,[]];o=[],a=!1,i.then(function(){var f,p;s();try{for(var d=oi(o),g=d.next();!g.done;g=d.next()){var m=g.value;m()}}catch(y){f={error:y}}finally{try{g&&!g.done&&(p=d.return)&&p.call(d)}finally{if(f)throw f.error}}a=!0}),h.label=1;case 1:return h.trys.push([1,,5,7]),Promise.all(t.map(function(f){return f.next()})).then(function(f){return s(f)},function(f){return i(f)}),[4,new Promise(function(f){return s=f})];case 2:return l=h.sent(),l===void 0?[2]:(u=l.map(function(f){return f.value}),l.every(function(f){return f.done})?[2,u]:[4,n(u.slice())]);case 3:return h.sent(),[4,Promise.all(t.map(function(f,p){return Zn(c,void 0,void 0,function(){var d;return $r(this,function(g){switch(g.label){case 0:if(l[p].done)return[2,l[p].value];g.label=1;case 1:return a?[3,4]:(Promise.resolve(f.next()).then(function(m){return o[p](m)},function(m){return i(m)}),[4,new Promise(function(m){return o[p]=m})]);case 2:return d=g.sent(),d===void 0?[2,l[p].value]:d.done?[2,d.value]:(u[p]=d.value,[4,n(u.slice())]);case 3:return g.sent(),[3,1];case 4:return[2]}})})}))];case 4:return[2,h.sent()];case 5:return i(),[4,Promise.all(t.map(function(f){return f.return&&f.return()}))];case 6:return h.sent(),[7];case 7:return[2]}})})})}class Hu{constructor(e,t,n,i,s,o={}){de(this,"headerClient");de(this,"header");de(this,"headerLength");de(this,"indexLength");de(this,"nocache");de(this,"headers");this.headerClient=e,this.header=t,this.headerLength=n,this.indexLength=i,this.nocache=s,this.headers=o}static async open(e,t,n={}){let i,s=new nf(e,t,n),o=2024+(()=>{let c,h=0;for(c=0;c<3;c++)h+=IS**c*AS;return h})();if(!new Uint8Array(await s.getRange(0,8,o,"header")).subarray(0,3).every((c,h)=>yr[h]===c))throw Error("Not a FlatGeobuf file");if((i=new DataView(await s.getRange(8,4,o,"header")).getUint32(0,!0))>10485760||i<8)throw Error("Invalid header size");let a=await s.getRange(12,i,o,"header"),l=Go(new Ht(new Uint8Array(a)));if(l.indexNodeSize===0)throw Error("No index found, cannot read features filtered by bbox");let u=zo(l.featuresCount,l.indexNodeSize);return new Hu(s,l,i,u,t,n)}async*selectBbox(e){let t=this.lengthBeforeTree(),n=this.headerClient,i=async(l,u)=>n.getRange(t+l,u,0,"index"),s=[],o=[];for await(let l of ng(this.header.featuresCount,this.header.indexNodeSize,e,i)){let[u,c]=l,[,,h]=l;if(h||(h=4),o.length===0){o.push([u,h,c]);continue}let f=o[o.length-1];u-(f[0]+f[1])>eo.global.extraRequestThreshold()&&(s.push(o),o=[]),o.push([u,h,c])}this.headerClient.logUsage("header+index"),o.length>0&&s.push(o);let a=s.flatMap(l=>this.readFeatureBatch(l,this.nocache));yield*ss.merge(a)}lengthBeforeTree(){return yr.length+Pt+this.headerLength}lengthBeforeFeatures(){return this.lengthBeforeTree()+this.indexLength}buildFeatureClient(e){return new nf(this.headerClient.httpClient,e,this.headers)}async*readFeatureBatch(e,t){let[n]=e[0],[i,s]=e[e.length-1],o=this.buildFeatureClient(t),a=i+s-n;for(let[l,,u]of e){let c=await this.readFeature(o,l,a);yield{id:u,feature:c},a=0}o.logUsage("feature")}async readFeature(e,t,n){let i,s=t+this.lengthBeforeFeatures();i=new DataView(await e.getRange(s,4,n,"feature length")).getUint32(0,!0);let o=new Uint8Array(await e.getRange(s+4,i,n,"feature data")),a=new Uint8Array(i+Pt);a.set(o,Pt);let l=new Ht(a);return l.setPosition(Pt),Dt.getRootAsFeature(l)}}class nf{constructor(e,t,n={}){de(this,"httpClient");de(this,"bytesEverUsed",0);de(this,"bytesEverFetched",0);de(this,"buffer",new ArrayBuffer(0));de(this,"head",0);if(typeof e=="string")this.httpClient=new sf(e,t,n);else if(e instanceof sf)this.httpClient=e;else throw Error("Unknown source")}async getRange(e,t,n,i){this.bytesEverUsed+=t;let s=e-this.head,o=s+t;if(s>=0&&o<=this.buffer.byteLength)return this.buffer.slice(s,o);let a=Math.max(t,n);return this.bytesEverFetched+=a,this.buffer=await this.httpClient.getRange(e,a,i),this.head=e,this.buffer.slice(0,t)}logUsage(e){e.split(" ")[0],(100*this.bytesEverUsed/this.bytesEverFetched).toFixed(2)}}class sf{constructor(e,t,n={}){de(this,"url");de(this,"nocache");de(this,"headers");de(this,"requestsEverMade",0);de(this,"bytesEverRequested",0);this.url=e,this.nocache=t,this.headers=n}async getRange(e,t,n){this.requestsEverMade+=1,this.bytesEverRequested+=t;let i=`bytes=${e}-${e+t-1}`,s=new Headers(this.headers);return s.set("Range",i),this.nocache&&s.set("Cache-Control","no-cache, no-store"),await(await fetch(this.url,{headers:s})).arrayBuffer()}}async function*zS(r,e,t,n){if(!r.subarray(0,3).every((h,f)=>yr[f]===h))throw Error("Not a FlatGeobuf file");if(t){let h=Wu.open(r);for await(let f of h.selectBbox(t))yield e(f.id,f.feature,h.header);return}let i=new Ht(r),s=i.readUint32(yr.length);i.setPosition(yr.length+Pt);let o=Go(i),a=yr.length+Pt+s,{indexNodeSize:l,featuresCount:u}=o;l>0&&(a+=zo(u,l));let c=0;for(;a<i.capacity();){let h=i.readUint32(a);i.setPosition(a+Pt);let f=Dt.getRootAsFeature(i);yield e(c++,f,o),a+=Pt+h}}async function*kS(r,e,t){let n,i=PS(r),s=async p=>await i.slice(p),o=new Uint8Array(await s(8));if(!o.subarray(0,3).every((p,d)=>yr[d]===p))throw Error("Not a FlatGeobuf file");o=new Uint8Array(await s(4));let a=new Ht(o),l=a.readUint32(0);o=new Uint8Array(await s(l));let u=Go(a=new Ht(o)),{indexNodeSize:c,featuresCount:h}=u;if(c>0){let p=zo(h,c);await s(p)}let f=0;for(;n=await jS(s,u,e,f++);)yield n}async function*$S(r,e,t,n,i=!1,s={}){let o=await Hu.open(r,i,s);for await(let a of o.selectBbox(e))yield t(a.id,a.feature,o.header)}async function jS(r,e,t,n){let i=new Uint8Array(await r(4,"feature length"));if(i.byteLength===0)return;let s=new Ht(i),o=s.readUint32(0);i=new Uint8Array(await r(o,"feature data"));let a=new Uint8Array(o+4);return a.set(i,4),(s=new Ht(a)).setPosition(Pt),t(n,Dt.getRootAsFeature(s),e)}function fl(r,e){let t=e;if(t===at.Unknown&&(t=r.type()),t===at.GeometryCollection){let i=[];for(let s=0;s<r.partsLength();s++){let o=r.parts(s),a=o.type();i.push(fl(o,a))}return{type:at[t],geometries:i}}if(t===at.MultiPolygon){let i=[];for(let s=0;s<r.partsLength();s++)i.push(fl(r.parts(s),at.Polygon));return{type:at[t],coordinates:i.map(s=>s.coordinates)}}let n=function(i,s){let o=i.xyArray(),a=i.zArray();switch(s){case at.Point:{let l=Array.from(o);return a&&l.push(a[0]),l}case at.MultiPoint:case at.LineString:return Ea(o,a);case at.MultiLineString:case at.Polygon:return function(l,u,c){let h;if(!c||c.length===0)return[Ea(l,u)];let f=0,p=Array.from(c).map(d=>l.slice(f,f=d<<1));return u&&(f=0,h=Array.from(c).map(d=>u.slice(f,f=d))),p.map((d,g)=>Ea(d,h?h[g]:void 0))}(o,a,i.endsArray())}}(r,t);return{type:at[t],coordinates:n}}function Yu(r,e,t){let n=t.columns;return{type:"Feature",id:r,geometry:fl(e.geometry(),t.geometryType),properties:wS(e,n)}}async function*VS(r,e,t){yield*zS(r,Yu,e)}function XS(r,e){return kS(r,Yu)}function ZS(r,e,t,n=!1,i={}){return $S(r,e,Yu,t,n,i)}function ZR(r,e,t,n=!1,i={}){return r instanceof Uint8Array?VS(r,e):r instanceof ReadableStream?XS(r):ZS(r,e,t,n,i)}export{PR as A,CR as B,XR as C,Ji as D,rR as E,nR as G,dR as H,sR as I,RR as L,Qy as O,oR as P,Vp as R,dp as S,Ql as T,VR as U,pR as V,D0 as W,OR as Z,cR as a,uR as b,lR as c,aR as d,iR as e,Mf as f,IR as g,mR as h,ja as i,gR as j,fR as k,ZR as l,jR as m,$R as n,kR as o,zR as p,GR as q,cS as r,ax as s,BR as t,UR as u,DR as v,NR as w,FR as x,rS as y,LR as z};

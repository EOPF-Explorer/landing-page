var Ad=Object.defineProperty;var ed=h=>{throw TypeError(h)};var Pd=(h,t,s)=>t in h?Ad(h,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):h[t]=s;var td=(h,t,s)=>Pd(h,typeof t!="symbol"?t+"":t,s),Kc=(h,t,s)=>t.has(h)||ed("Cannot "+s);var mt=(h,t,s)=>(Kc(h,t,"read from private field"),s?s.call(h):t.get(h)),Nt=(h,t,s)=>t.has(h)?ed("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(h):t.set(h,s),Ht=(h,t,s,n)=>(Kc(h,t,"write to private field"),n?n.call(h,s):t.set(h,s),s),$t=(h,t,s)=>(Kc(h,t,"access private method"),s);import{c as i,b,A,a as addCommonStylesheet,e as eoxStyle}from"./addCommonStyleSheet.Eo9AKn5H.js";import{S as SimpleGeometry,c as createOrUpdate,i as intersects,f as forEachCorner,d as deflateCoordinate,r as rotate,B as BaseObject,a as identityTransform,g as getTransformFromProjections,b as get,t as toRadians,e as circular,h as BaseEvent,E as EventType$1,T as Target,l as listen,u as unlistenByKey,P as PASSIVE_EVENT_LISTENERS,V as VOID,C as CLASS_UNSELECTABLE,j as CLASS_CONTROL,k as CLASS_COLLAPSED,m as toPromise,n as equals,o as removeChildren,p as replaceNode,q as CLASS_HIDDEN,s as easeOut,v as Collection,w as linear,x as TRUE,W as WEBKIT,M as MAC,F as FALSE,y as scale,z as rotate$1,A as disable,D as Disposable,G as Polygon,H as clamp,I as abstract,J as compose,K as makeInverse,L as wrapX,N as getWidth,O as inView,Q as shared,R as ObjectEventType,U as checkedFonts,X as createMockDiv,Y as WORKER_OFFSCREEN_CANVAS,Z as RenderEvent,_ as RenderEventType,$ as BaseVectorLayer,a0 as replaceChildren,a1 as isCanvas,a2 as fromString,a3 as DEVICE_PIXEL_RATIO,a4 as create,a5 as TileQueue,a6 as View,a7 as CollectionEventType,a8 as toUserCoordinate,a9 as apply,aa as fromUserCoordinate,ab as getTilePriority,ac as ViewHint,ad as GroupEvent,ae as hasArea,af as getUid,ag as getForViewAndSize,ah as isEmpty,ai as equals$1,aj as createOrUpdateEmpty,ak as clone,al as warn,am as LayerGroup,an as assert,ao as Layer,ap as CLASS_SELECTABLE,aq as outerWidth,ar as outerHeight,as as containsExtent,at as round,au as DECIMALS,av as getHeight,aw as floor,ax as compareVersions,ay as appendParams,az as getRequestExtent,aA as decode,aB as ImageSource,aC as defaultImageLoadFunction,aD as calculateSourceResolution,aE as transform$1,aF as TileImage,aG as createEmpty,aH as buffer,aI as modulo,aJ as hash,aK as distance,aL as LineString,aM as MultiLineString,aN as MultiPolygon,aO as GeometryCollection,aP as squaredDistance,aQ as toFixed,aR as boundingExtent,aS as getBottomLeft,aT as getBottomRight,aU as getTopRight,aV as getTopLeft,aW as squaredDistance$1,aX as VectorLayer,aY as VectorSource,aZ as Feature,a_ as Point,a$ as getStrideForLayout,b0 as MultiPoint,b1 as createEditingStyle,b2 as RBush,b3 as VectorEventType,b4 as createOrUpdateFromCoordinate,b5 as equals$2,b6 as closestOnSegment,b7 as fromUserExtent,b8 as toUserExtent,b9 as squaredDistanceToSegment,ba as getLength,bb as getArea,bc as GeoJSON,bd as READ_FEATURES_OPTIONS,be as KML,bf as TopoJSON,bg as register,bh as fromEPSGCode,bi as transformExtent$1,bj as fromLonLat,bk as FeatureFormat,bl as Projection,bm as RenderFeature,bn as transformGeometryWithOptions,bo as Pbf,bp as inflateEnds,bq as CanvasTileLayerRenderer,br as TileState,bs as equivalent,bt as getIntersection,bu as getTransform,bv as BuilderGroup,bw as ExecutorGroup,bx as toSize,by as HIT_DETECT_RESOLUTION,bz as createHitDetectionImageData,bA as hitDetect,bB as DECLUTTER,bC as ascending,bD as multiply,bE as scale$1,bF as ZIndexContext,bG as renderFeature,bH as reset,bI as translate,bJ as getSquaredTolerance,bK as TileProperty,bL as TileLayer,bM as ImageLayer,bN as XYZ,bO as WMTS,bP as VectorTile,bQ as TileSource,bR as OSM,bS as extend,bT as getArea$1,bU as Style,bV as Stroke,bW as WMTSTileGrid,bX as createXYZ,bY as getPointResolution,bZ as METERS_PER_UNIT,b_ as CLASS_UNSUPPORTED,b$ as stopPropagation,c0 as ViewProperty,c1 as scaleFromCenter,c2 as fromExtent,c3 as listenOnce,c4 as Fill}from"./map.BaSrMuqw.js";import{p as proj4}from"./index.Du0sVlOV.js";import{g as getDefaultExportFromCjs}from"./commonjsHelpers.BosuxZz1.js";import{g as getElement}from"./getElement.CdRlZPdn.js";class Circle extends SimpleGeometry{constructor(t,s,n){super(),n!==void 0&&s===void 0?this.setFlatCoordinates(n,t):(s=s||0,this.setCenterAndRadius(t,s,n))}clone(){const t=new Circle(this.flatCoordinates.slice(),void 0,this.layout);return t.applyProperties(this),t}closestPointXY(t,s,n,o){const a=this.flatCoordinates,l=t-a[0],c=s-a[1],d=l*l+c*c;if(d<o){if(d===0)for(let u=0;u<this.stride;++u)n[u]=a[u];else{const u=this.getRadius()/Math.sqrt(d);n[0]=a[0]+u*l,n[1]=a[1]+u*c;for(let _=2;_<this.stride;++_)n[_]=a[_]}return n.length=this.stride,d}return o}containsXY(t,s){const n=this.flatCoordinates,o=t-n[0],a=s-n[1];return o*o+a*a<=this.getRadiusSquared_()}getCenter(){return this.flatCoordinates.slice(0,this.stride)}computeExtent(t){const s=this.flatCoordinates,n=s[this.stride]-s[0];return createOrUpdate(s[0]-n,s[1]-n,s[0]+n,s[1]+n,t)}getRadius(){return Math.sqrt(this.getRadiusSquared_())}getRadiusSquared_(){const t=this.flatCoordinates[this.stride]-this.flatCoordinates[0],s=this.flatCoordinates[this.stride+1]-this.flatCoordinates[1];return t*t+s*s}getType(){return"Circle"}intersectsExtent(t){const s=this.getExtent();if(intersects(t,s)){const n=this.getCenter();return t[0]<=n[0]&&t[2]>=n[0]||t[1]<=n[1]&&t[3]>=n[1]?!0:forEachCorner(t,this.intersectsCoordinate.bind(this))}return!1}setCenter(t){const s=this.stride,n=this.flatCoordinates[s]-this.flatCoordinates[0],o=t.slice();o[s]=o[0]+n;for(let a=1;a<s;++a)o[s+a]=t[a];this.setFlatCoordinates(this.layout,o),this.changed()}setCenterAndRadius(t,s,n){this.setLayout(n,t,0),this.flatCoordinates||(this.flatCoordinates=[]);const o=this.flatCoordinates;let a=deflateCoordinate(o,0,t,this.stride);o[a++]=o[0]+s;for(let l=1,c=this.stride;l<c;++l)o[a++]=o[l];o.length=a,this.changed()}getCoordinates(){return null}setCoordinates(t,s){}setRadius(t){this.flatCoordinates[this.stride]=this.flatCoordinates[0]+t,this.changed()}rotate(t,s){const n=this.getCenter(),o=this.getStride();this.setCenter(rotate(n,0,n.length,o,t,s,n)),this.changed()}}Circle.prototype.transform;const Property$1={ACCURACY:"accuracy",ACCURACY_GEOMETRY:"accuracyGeometry",ALTITUDE:"altitude",ALTITUDE_ACCURACY:"altitudeAccuracy",HEADING:"heading",POSITION:"position",PROJECTION:"projection",SPEED:"speed",TRACKING:"tracking",TRACKING_OPTIONS:"trackingOptions"},GeolocationErrorType={ERROR:"error"};class GeolocationError extends BaseEvent{constructor(t){super(GeolocationErrorType.ERROR),this.code=t.code,this.message=t.message}}class Geolocation extends BaseObject{constructor(t){super(),this.on,this.once,this.un,t=t||{},this.position_=null,this.transform_=identityTransform,this.watchId_=void 0,this.addChangeListener(Property$1.PROJECTION,this.handleProjectionChanged_),this.addChangeListener(Property$1.TRACKING,this.handleTrackingChanged_),t.projection!==void 0&&this.setProjection(t.projection),t.trackingOptions!==void 0&&this.setTrackingOptions(t.trackingOptions),this.setTracking(t.tracking!==void 0?t.tracking:!1)}disposeInternal(){this.setTracking(!1),super.disposeInternal()}handleProjectionChanged_(){const t=this.getProjection();t&&(this.transform_=getTransformFromProjections(get("EPSG:4326"),t),this.position_&&this.set(Property$1.POSITION,this.transform_(this.position_)))}handleTrackingChanged_(){if("geolocation"in navigator){const t=this.getTracking();t&&this.watchId_===void 0?this.watchId_=navigator.geolocation.watchPosition(this.positionChange_.bind(this),this.positionError_.bind(this),this.getTrackingOptions()):!t&&this.watchId_!==void 0&&(navigator.geolocation.clearWatch(this.watchId_),this.watchId_=void 0)}}positionChange_(t){const s=t.coords;this.set(Property$1.ACCURACY,s.accuracy),this.set(Property$1.ALTITUDE,s.altitude===null?void 0:s.altitude),this.set(Property$1.ALTITUDE_ACCURACY,s.altitudeAccuracy===null?void 0:s.altitudeAccuracy),this.set(Property$1.HEADING,s.heading===null?void 0:toRadians(s.heading)),this.position_?(this.position_[0]=s.longitude,this.position_[1]=s.latitude):this.position_=[s.longitude,s.latitude];const n=this.transform_(this.position_);this.set(Property$1.POSITION,n.slice()),this.set(Property$1.SPEED,s.speed===null?void 0:s.speed);const o=circular(this.position_,s.accuracy);o.applyTransform(this.transform_),this.set(Property$1.ACCURACY_GEOMETRY,o),this.changed()}positionError_(t){this.dispatchEvent(new GeolocationError(t))}getAccuracy(){return this.get(Property$1.ACCURACY)}getAccuracyGeometry(){return this.get(Property$1.ACCURACY_GEOMETRY)||null}getAltitude(){return this.get(Property$1.ALTITUDE)}getAltitudeAccuracy(){return this.get(Property$1.ALTITUDE_ACCURACY)}getHeading(){return this.get(Property$1.HEADING)}getPosition(){return this.get(Property$1.POSITION)}getProjection(){return this.get(Property$1.PROJECTION)}getSpeed(){return this.get(Property$1.SPEED)}getTracking(){return this.get(Property$1.TRACKING)}getTrackingOptions(){return this.get(Property$1.TRACKING_OPTIONS)}setProjection(t){this.set(Property$1.PROJECTION,get(t))}setTracking(t){this.set(Property$1.TRACKING,t)}setTrackingOptions(t){this.set(Property$1.TRACKING_OPTIONS,t)}}class Kinetic{constructor(t,s,n){this.decay_=t,this.minVelocity_=s,this.delay_=n,this.points_=[],this.angle_=0,this.initialVelocity_=0}begin(){this.points_.length=0,this.angle_=0,this.initialVelocity_=0}update(t,s){this.points_.push(t,s,Date.now())}end(){if(this.points_.length<6)return!1;const t=Date.now()-this.delay_,s=this.points_.length-3;if(this.points_[s+2]<t)return!1;let n=s-3;for(;n>0&&this.points_[n+2]>t;)n-=3;const o=this.points_[s+2]-this.points_[n+2];if(o<1e3/60)return!1;const a=this.points_[s]-this.points_[n],l=this.points_[s+1]-this.points_[n+1];return this.angle_=Math.atan2(l,a),this.initialVelocity_=Math.sqrt(a*a+l*l)/o,this.initialVelocity_>this.minVelocity_}getDistance(){return(this.minVelocity_-this.initialVelocity_)/this.decay_}getAngle(){return this.angle_}}class MapEvent extends BaseEvent{constructor(t,s,n){super(t),this.map=s,this.frameState=n!==void 0?n:null}}class MapBrowserEvent extends MapEvent{constructor(t,s,n,o,a,l){super(t,s,a),this.originalEvent=n,this.pixel_=null,this.coordinate_=null,this.dragging=o!==void 0?o:!1,this.activePointers=l}get pixel(){return this.pixel_||(this.pixel_=this.map.getEventPixel(this.originalEvent)),this.pixel_}set pixel(t){this.pixel_=t}get coordinate(){return this.coordinate_||(this.coordinate_=this.map.getCoordinateFromPixel(this.pixel)),this.coordinate_}set coordinate(t){this.coordinate_=t}preventDefault(){super.preventDefault(),"preventDefault"in this.originalEvent&&this.originalEvent.preventDefault()}stopPropagation(){super.stopPropagation(),"stopPropagation"in this.originalEvent&&this.originalEvent.stopPropagation()}}const MapBrowserEventType={SINGLECLICK:"singleclick",CLICK:EventType$1.CLICK,DBLCLICK:EventType$1.DBLCLICK,POINTERDRAG:"pointerdrag",POINTERMOVE:"pointermove",POINTERDOWN:"pointerdown",POINTERUP:"pointerup",POINTEROVER:"pointerover",POINTEROUT:"pointerout",POINTERENTER:"pointerenter",POINTERLEAVE:"pointerleave",POINTERCANCEL:"pointercancel"},EventType={POINTERMOVE:"pointermove",POINTERDOWN:"pointerdown",POINTERUP:"pointerup",POINTEROUT:"pointerout"};class MapBrowserEventHandler extends Target{constructor(t,s){super(t),this.map_=t,this.clickTimeoutId_,this.emulateClicks_=!1,this.dragging_=!1,this.dragListenerKeys_=[],this.moveTolerance_=s===void 0?1:s,this.down_=null;const n=this.map_.getViewport();this.activePointers_=[],this.trackedTouches_={},this.element_=n,this.pointerdownListenerKey_=listen(n,EventType.POINTERDOWN,this.handlePointerDown_,this),this.originalPointerMoveEvent_,this.relayedListenerKey_=listen(n,EventType.POINTERMOVE,this.relayMoveEvent_,this),this.boundHandleTouchMove_=this.handleTouchMove_.bind(this),this.element_.addEventListener(EventType$1.TOUCHMOVE,this.boundHandleTouchMove_,PASSIVE_EVENT_LISTENERS?{passive:!1}:!1)}emulateClick_(t){let s=new MapBrowserEvent(MapBrowserEventType.CLICK,this.map_,t);this.dispatchEvent(s),this.clickTimeoutId_!==void 0?(clearTimeout(this.clickTimeoutId_),this.clickTimeoutId_=void 0,s=new MapBrowserEvent(MapBrowserEventType.DBLCLICK,this.map_,t),this.dispatchEvent(s)):this.clickTimeoutId_=setTimeout(()=>{this.clickTimeoutId_=void 0;const n=new MapBrowserEvent(MapBrowserEventType.SINGLECLICK,this.map_,t);this.dispatchEvent(n)},250)}updateActivePointers_(t){const s=t,n=s.pointerId;if(s.type==MapBrowserEventType.POINTERUP||s.type==MapBrowserEventType.POINTERCANCEL){delete this.trackedTouches_[n];for(const o in this.trackedTouches_)if(this.trackedTouches_[o].target!==s.target){delete this.trackedTouches_[o];break}}else(s.type==MapBrowserEventType.POINTERDOWN||s.type==MapBrowserEventType.POINTERMOVE)&&(this.trackedTouches_[n]=s);this.activePointers_=Object.values(this.trackedTouches_)}handlePointerUp_(t){this.updateActivePointers_(t);const s=new MapBrowserEvent(MapBrowserEventType.POINTERUP,this.map_,t,void 0,void 0,this.activePointers_);this.dispatchEvent(s),this.emulateClicks_&&!s.defaultPrevented&&!this.dragging_&&this.isMouseActionButton_(t)&&this.emulateClick_(this.down_),this.activePointers_.length===0&&(this.dragListenerKeys_.forEach(unlistenByKey),this.dragListenerKeys_.length=0,this.dragging_=!1,this.down_=null)}isMouseActionButton_(t){return t.button===0}handlePointerDown_(t){this.emulateClicks_=this.activePointers_.length===0,this.updateActivePointers_(t);const s=new MapBrowserEvent(MapBrowserEventType.POINTERDOWN,this.map_,t,void 0,void 0,this.activePointers_);if(this.dispatchEvent(s),this.down_=new PointerEvent(t.type,t),Object.defineProperty(this.down_,"target",{writable:!1,value:t.target}),this.dragListenerKeys_.length===0){const n=this.map_.getOwnerDocument();this.dragListenerKeys_.push(listen(n,MapBrowserEventType.POINTERMOVE,this.handlePointerMove_,this),listen(n,MapBrowserEventType.POINTERUP,this.handlePointerUp_,this),listen(this.element_,MapBrowserEventType.POINTERCANCEL,this.handlePointerUp_,this)),this.element_.getRootNode&&this.element_.getRootNode()!==n&&this.dragListenerKeys_.push(listen(this.element_.getRootNode(),MapBrowserEventType.POINTERUP,this.handlePointerUp_,this))}}handlePointerMove_(t){if(this.isMoving_(t)){this.updateActivePointers_(t),this.dragging_=!0;const s=new MapBrowserEvent(MapBrowserEventType.POINTERDRAG,this.map_,t,this.dragging_,void 0,this.activePointers_);this.dispatchEvent(s)}}relayMoveEvent_(t){this.originalPointerMoveEvent_=t;const s=!!(this.down_&&this.isMoving_(t));this.dispatchEvent(new MapBrowserEvent(MapBrowserEventType.POINTERMOVE,this.map_,t,s))}handleTouchMove_(t){const s=this.originalPointerMoveEvent_;(!s||s.defaultPrevented)&&(typeof t.cancelable!="boolean"||t.cancelable===!0)&&t.preventDefault()}isMoving_(t){return this.dragging_||Math.abs(t.clientX-this.down_.clientX)>this.moveTolerance_||Math.abs(t.clientY-this.down_.clientY)>this.moveTolerance_}disposeInternal(){this.relayedListenerKey_&&(unlistenByKey(this.relayedListenerKey_),this.relayedListenerKey_=null),this.element_.removeEventListener(EventType$1.TOUCHMOVE,this.boundHandleTouchMove_),this.pointerdownListenerKey_&&(unlistenByKey(this.pointerdownListenerKey_),this.pointerdownListenerKey_=null),this.dragListenerKeys_.forEach(unlistenByKey),this.dragListenerKeys_.length=0,this.element_=null,super.disposeInternal()}}const MapEventType={POSTRENDER:"postrender",MOVESTART:"movestart",MOVEEND:"moveend",LOADSTART:"loadstart",LOADEND:"loadend"},MapProperty={LAYERGROUP:"layergroup",SIZE:"size",TARGET:"target",VIEW:"view"};class Control extends BaseObject{constructor(t){super();const s=t.element;s&&!t.target&&!s.style.pointerEvents&&(s.style.pointerEvents="auto"),this.element=s||null,this.target_=null,this.map_=null,this.listenerKeys=[],t.render&&(this.render=t.render),t.target&&this.setTarget(t.target)}disposeInternal(){var t;(t=this.element)==null||t.remove(),super.disposeInternal()}getMap(){return this.map_}setMap(t){var s;this.map_&&((s=this.element)==null||s.remove());for(let n=0,o=this.listenerKeys.length;n<o;++n)unlistenByKey(this.listenerKeys[n]);if(this.listenerKeys.length=0,this.map_=t,t){const n=this.target_??t.getOverlayContainerStopEvent();this.element&&n.appendChild(this.element),this.render!==VOID&&this.listenerKeys.push(listen(t,MapEventType.POSTRENDER,this.render,this)),t.render()}}render(t){}setTarget(t){this.target_=typeof t=="string"?document.getElementById(t):t}}class Attribution extends Control{constructor(t){t=t||{},super({element:document.createElement("div"),render:t.render,target:t.target}),this.ulElement_=document.createElement("ul"),this.collapsed_=t.collapsed!==void 0?t.collapsed:!0,this.userCollapsed_=this.collapsed_,this.overrideCollapsible_=t.collapsible!==void 0,this.collapsible_=t.collapsible!==void 0?t.collapsible:!0,this.collapsible_||(this.collapsed_=!1),this.attributions_=t.attributions;const s=t.className!==void 0?t.className:"ol-attribution",n=t.tipLabel!==void 0?t.tipLabel:"Attributions",o=t.expandClassName!==void 0?t.expandClassName:s+"-expand",a=t.collapseLabel!==void 0?t.collapseLabel:"›",l=t.collapseClassName!==void 0?t.collapseClassName:s+"-collapse";typeof a=="string"?(this.collapseLabel_=document.createElement("span"),this.collapseLabel_.textContent=a,this.collapseLabel_.className=l):this.collapseLabel_=a;const c=t.label!==void 0?t.label:"i";typeof c=="string"?(this.label_=document.createElement("span"),this.label_.textContent=c,this.label_.className=o):this.label_=c;const d=this.collapsible_&&!this.collapsed_?this.collapseLabel_:this.label_;this.toggleButton_=document.createElement("button"),this.toggleButton_.setAttribute("type","button"),this.toggleButton_.setAttribute("aria-expanded",String(!this.collapsed_)),this.toggleButton_.title=n,this.toggleButton_.appendChild(d),this.toggleButton_.addEventListener(EventType$1.CLICK,this.handleClick_.bind(this),!1);const u=s+" "+CLASS_UNSELECTABLE+" "+CLASS_CONTROL+(this.collapsed_&&this.collapsible_?" "+CLASS_COLLAPSED:"")+(this.collapsible_?"":" ol-uncollapsible"),_=this.element;_.className=u,_.appendChild(this.toggleButton_),_.appendChild(this.ulElement_),this.renderedAttributions_=[],this.renderedVisible_=!0}collectSourceAttributions_(t){const s=this.getMap().getAllLayers(),n=new Set(s.flatMap(o=>o.getAttributions(t)));if(this.attributions_!==void 0&&(Array.isArray(this.attributions_)?this.attributions_.forEach(o=>n.add(o)):n.add(this.attributions_)),!this.overrideCollapsible_){const o=!s.some(a=>{var l;return((l=a.getSource())==null?void 0:l.getAttributionsCollapsible())===!1});this.setCollapsible(o)}return Array.from(n)}async updateElement_(t){if(!t){this.renderedVisible_&&(this.element.style.display="none",this.renderedVisible_=!1);return}const s=await Promise.all(this.collectSourceAttributions_(t).map(o=>toPromise(()=>o))),n=s.length>0;if(this.renderedVisible_!=n&&(this.element.style.display=n?"":"none",this.renderedVisible_=n),!equals(s,this.renderedAttributions_)){removeChildren(this.ulElement_);for(let o=0,a=s.length;o<a;++o){const l=document.createElement("li");l.innerHTML=s[o],this.ulElement_.appendChild(l)}this.renderedAttributions_=s}}handleClick_(t){t.preventDefault(),this.handleToggle_(),this.userCollapsed_=this.collapsed_}handleToggle_(){this.element.classList.toggle(CLASS_COLLAPSED),this.collapsed_?replaceNode(this.collapseLabel_,this.label_):replaceNode(this.label_,this.collapseLabel_),this.collapsed_=!this.collapsed_,this.toggleButton_.setAttribute("aria-expanded",String(!this.collapsed_))}getCollapsible(){return this.collapsible_}setCollapsible(t){this.collapsible_!==t&&(this.collapsible_=t,this.element.classList.toggle("ol-uncollapsible"),this.userCollapsed_&&this.handleToggle_())}setCollapsed(t){this.userCollapsed_=t,!(!this.collapsible_||this.collapsed_===t)&&this.handleToggle_()}getCollapsed(){return this.collapsed_}render(t){this.updateElement_(t.frameState)}}class Rotate extends Control{constructor(t){t=t||{},super({element:document.createElement("div"),render:t.render,target:t.target});const s=t.className!==void 0?t.className:"ol-rotate",n=t.label!==void 0?t.label:"⇧",o=t.compassClassName!==void 0?t.compassClassName:"ol-compass";this.label_=null,typeof n=="string"?(this.label_=document.createElement("span"),this.label_.className=o,this.label_.textContent=n):(this.label_=n,this.label_.classList.add(o));const a=t.tipLabel?t.tipLabel:"Reset rotation",l=document.createElement("button");l.className=s+"-reset",l.setAttribute("type","button"),l.title=a,l.appendChild(this.label_),l.addEventListener(EventType$1.CLICK,this.handleClick_.bind(this),!1);const c=s+" "+CLASS_UNSELECTABLE+" "+CLASS_CONTROL,d=this.element;d.className=c,d.appendChild(l),this.callResetNorth_=t.resetNorth?t.resetNorth:void 0,this.duration_=t.duration!==void 0?t.duration:250,this.autoHide_=t.autoHide!==void 0?t.autoHide:!0,this.rotation_=void 0,this.autoHide_&&this.element.classList.add(CLASS_HIDDEN)}handleClick_(t){t.preventDefault(),this.callResetNorth_!==void 0?this.callResetNorth_():this.resetNorth_()}resetNorth_(){const s=this.getMap().getView();if(!s)return;const n=s.getRotation();n!==void 0&&(this.duration_>0&&n%(2*Math.PI)!==0?s.animate({rotation:0,duration:this.duration_,easing:easeOut}):s.setRotation(0))}render(t){const s=t.frameState;if(!s)return;const n=s.viewState.rotation;if(n!=this.rotation_){const o="rotate("+n+"rad)";if(this.autoHide_){const a=this.element.classList.contains(CLASS_HIDDEN);!a&&n===0?this.element.classList.add(CLASS_HIDDEN):a&&n!==0&&this.element.classList.remove(CLASS_HIDDEN)}this.label_.style.transform=o}this.rotation_=n}}class Zoom extends Control{constructor(t){t=t||{},super({element:document.createElement("div"),target:t.target});const s=t.className!==void 0?t.className:"ol-zoom",n=t.delta!==void 0?t.delta:1,o=t.zoomInClassName!==void 0?t.zoomInClassName:s+"-in",a=t.zoomOutClassName!==void 0?t.zoomOutClassName:s+"-out",l=t.zoomInLabel!==void 0?t.zoomInLabel:"+",c=t.zoomOutLabel!==void 0?t.zoomOutLabel:"–",d=t.zoomInTipLabel!==void 0?t.zoomInTipLabel:"Zoom in",u=t.zoomOutTipLabel!==void 0?t.zoomOutTipLabel:"Zoom out",_=document.createElement("button");_.className=o,_.setAttribute("type","button"),_.title=d,_.appendChild(typeof l=="string"?document.createTextNode(l):l),_.addEventListener(EventType$1.CLICK,this.handleClick_.bind(this,n),!1);const f=document.createElement("button");f.className=a,f.setAttribute("type","button"),f.title=u,f.appendChild(typeof c=="string"?document.createTextNode(c):c),f.addEventListener(EventType$1.CLICK,this.handleClick_.bind(this,-n),!1);const g=s+" "+CLASS_UNSELECTABLE+" "+CLASS_CONTROL,m=this.element;m.className=g,m.appendChild(_),m.appendChild(f),this.duration_=t.duration!==void 0?t.duration:250}handleClick_(t,s){s.preventDefault(),this.zoomByDelta_(t)}zoomByDelta_(t){const n=this.getMap().getView();if(!n)return;const o=n.getZoom();if(o!==void 0){const a=n.getConstrainedZoom(o+t);this.duration_>0?(n.getAnimating()&&n.cancelAnimations(),n.animate({zoom:a,duration:this.duration_,easing:easeOut})):n.setZoom(a)}}}function defaults$1(h){h=h||{};const t=new Collection;return(h.zoom!==void 0?h.zoom:!0)&&t.push(new Zoom(h.zoomOptions)),(h.rotate!==void 0?h.rotate:!0)&&t.push(new Rotate(h.rotateOptions)),(h.attribution!==void 0?h.attribution:!0)&&t.push(new Attribution(h.attributionOptions)),t}const InteractionProperty={ACTIVE:"active"};class Interaction extends BaseObject{constructor(t){super(),this.on,this.once,this.un,t&&t.handleEvent&&(this.handleEvent=t.handleEvent),this.map_=null,this.setActive(!0)}getActive(){return this.get(InteractionProperty.ACTIVE)}getMap(){return this.map_}handleEvent(t){return!0}setActive(t){this.set(InteractionProperty.ACTIVE,t)}setMap(t){this.map_=t}}function pan(h,t,s){const n=h.getCenterInternal();if(n){const o=[n[0]+t[0],n[1]+t[1]];h.animateInternal({duration:s!==void 0?s:250,easing:linear,center:h.getConstrainedCenter(o)})}}function zoomByDelta(h,t,s,n){const o=h.getZoom();if(o===void 0)return;const a=h.getConstrainedZoom(o+t),l=h.getResolutionForZoom(a);h.getAnimating()&&h.cancelAnimations(),h.animate({resolution:l,anchor:s,duration:n!==void 0?n:250,easing:easeOut})}class DoubleClickZoom extends Interaction{constructor(t){super(),t=t||{},this.delta_=t.delta?t.delta:1,this.duration_=t.duration!==void 0?t.duration:250}handleEvent(t){let s=!1;if(t.type==MapBrowserEventType.DBLCLICK){const n=t.originalEvent,o=t.map,a=t.coordinate,l=n.shiftKey?-this.delta_:this.delta_,c=o.getView();zoomByDelta(c,l,a,this.duration_),n.preventDefault(),s=!0}return!s}}function all(h){const t=arguments;return function(s){let n=!0;for(let o=0,a=t.length;o<a&&(n=n&&t[o](s),!!n);++o);return n}}const altKeyOnly=function(h){const t=h.originalEvent;return t.altKey&&!(t.metaKey||t.ctrlKey)&&!t.shiftKey},altShiftKeysOnly=function(h){const t=h.originalEvent;return t.altKey&&!(t.metaKey||t.ctrlKey)&&t.shiftKey},focus=function(h){const t=h.map.getTargetElement(),s=t.getRootNode(),n=h.map.getOwnerDocument().activeElement;return s instanceof ShadowRoot?s.host.contains(n):t.contains(n)},focusWithTabindex=function(h){const t=h.map.getTargetElement(),s=t.getRootNode();return(s instanceof ShadowRoot?s.host:t).hasAttribute("tabindex")?focus(h):!0},always=TRUE,mouseActionButton=function(h){const t=h.originalEvent;return"pointerId"in t&&t.button==0&&!(WEBKIT&&MAC&&t.ctrlKey)},never=FALSE,singleClick=function(h){return h.type==MapBrowserEventType.SINGLECLICK},noModifierKeys=function(h){const t=h.originalEvent;return!t.altKey&&!(t.metaKey||t.ctrlKey)&&!t.shiftKey},platformModifierKeyOnly=function(h){const t=h.originalEvent;return!t.altKey&&(MAC?t.metaKey:t.ctrlKey)&&!t.shiftKey},platformModifierKey=function(h){const t=h.originalEvent;return MAC?t.metaKey:t.ctrlKey},shiftKeyOnly=function(h){const t=h.originalEvent;return!t.altKey&&!(t.metaKey||t.ctrlKey)&&t.shiftKey},targetNotEditable=function(h){const t=h.originalEvent,s=t.target.tagName;return s!=="INPUT"&&s!=="SELECT"&&s!=="TEXTAREA"&&!t.target.isContentEditable},mouseOnly=function(h){const t=h.originalEvent;return"pointerId"in t&&t.pointerType=="mouse"},primaryAction=function(h){const t=h.originalEvent;return"pointerId"in t&&t.isPrimary&&t.button===0};class PointerInteraction extends Interaction{constructor(t){t=t||{},super(t),t.handleDownEvent&&(this.handleDownEvent=t.handleDownEvent),t.handleDragEvent&&(this.handleDragEvent=t.handleDragEvent),t.handleMoveEvent&&(this.handleMoveEvent=t.handleMoveEvent),t.handleUpEvent&&(this.handleUpEvent=t.handleUpEvent),t.stopDown&&(this.stopDown=t.stopDown),this.handlingDownUpSequence=!1,this.targetPointers=[]}getPointerCount(){return this.targetPointers.length}handleDownEvent(t){return!1}handleDragEvent(t){}handleEvent(t){if(!t.originalEvent)return!0;let s=!1;if(this.updateTrackedPointers_(t),this.handlingDownUpSequence){if(t.type==MapBrowserEventType.POINTERDRAG)this.handleDragEvent(t),t.originalEvent.preventDefault();else if(t.type==MapBrowserEventType.POINTERUP){const n=this.handleUpEvent(t);this.handlingDownUpSequence=n&&this.targetPointers.length>0}}else if(t.type==MapBrowserEventType.POINTERDOWN){const n=this.handleDownEvent(t);this.handlingDownUpSequence=n,s=this.stopDown(n)}else t.type==MapBrowserEventType.POINTERMOVE&&this.handleMoveEvent(t);return!s}handleMoveEvent(t){}handleUpEvent(t){return!1}stopDown(t){return t}updateTrackedPointers_(t){t.activePointers&&(this.targetPointers=t.activePointers)}}function centroid(h){const t=h.length;let s=0,n=0;for(let o=0;o<t;o++)s+=h[o].clientX,n+=h[o].clientY;return{clientX:s/t,clientY:n/t}}class DragPan extends PointerInteraction{constructor(t){super({stopDown:FALSE}),t=t||{},this.kinetic_=t.kinetic,this.lastCentroid=null,this.lastPointersCount_,this.panning_=!1;const s=t.condition?t.condition:all(noModifierKeys,primaryAction);this.condition_=t.onFocusOnly?all(focusWithTabindex,s):s,this.noKinetic_=!1}handleDragEvent(t){const s=t.map;this.panning_||(this.panning_=!0,s.getView().beginInteraction());const n=this.targetPointers,o=s.getEventPixel(centroid(n));if(n.length==this.lastPointersCount_){if(this.kinetic_&&this.kinetic_.update(o[0],o[1]),this.lastCentroid){const a=[this.lastCentroid[0]-o[0],o[1]-this.lastCentroid[1]],c=t.map.getView();scale(a,c.getResolution()),rotate$1(a,c.getRotation()),c.adjustCenterInternal(a)}}else this.kinetic_&&this.kinetic_.begin();this.lastCentroid=o,this.lastPointersCount_=n.length,t.originalEvent.preventDefault()}handleUpEvent(t){const s=t.map,n=s.getView();if(this.targetPointers.length===0){if(!this.noKinetic_&&this.kinetic_&&this.kinetic_.end()){const o=this.kinetic_.getDistance(),a=this.kinetic_.getAngle(),l=n.getCenterInternal(),c=s.getPixelFromCoordinateInternal(l),d=s.getCoordinateFromPixelInternal([c[0]-o*Math.cos(a),c[1]-o*Math.sin(a)]);n.animateInternal({center:n.getConstrainedCenter(d),duration:500,easing:easeOut})}return this.panning_&&(this.panning_=!1,n.endInteraction()),!1}return this.kinetic_&&this.kinetic_.begin(),this.lastCentroid=null,!0}handleDownEvent(t){if(this.targetPointers.length>0&&this.condition_(t)){const n=t.map.getView();return this.lastCentroid=null,n.getAnimating()&&n.cancelAnimations(),this.kinetic_&&this.kinetic_.begin(),this.noKinetic_=this.targetPointers.length>1,!0}return!1}}class DragRotate extends PointerInteraction{constructor(t){t=t||{},super({stopDown:FALSE}),this.condition_=t.condition?t.condition:altShiftKeysOnly,this.lastAngle_=void 0,this.duration_=t.duration!==void 0?t.duration:250}handleDragEvent(t){if(!mouseOnly(t))return;const s=t.map,n=s.getView();if(n.getConstraints().rotation===disable)return;const o=s.getSize(),a=t.pixel,l=Math.atan2(o[1]/2-a[1],a[0]-o[0]/2);if(this.lastAngle_!==void 0){const c=l-this.lastAngle_;n.adjustRotationInternal(-c)}this.lastAngle_=l}handleUpEvent(t){return mouseOnly(t)?(t.map.getView().endInteraction(this.duration_),!1):!0}handleDownEvent(t){return mouseOnly(t)&&mouseActionButton(t)&&this.condition_(t)?(t.map.getView().beginInteraction(),this.lastAngle_=void 0,!0):!1}}class RenderBox extends Disposable{constructor(t){super(),this.geometry_=null,this.element_=document.createElement("div"),this.element_.style.position="absolute",this.element_.style.pointerEvents="auto",this.element_.className="ol-box "+t,this.map_=null,this.startPixel_=null,this.endPixel_=null}disposeInternal(){this.setMap(null)}render_(){const t=this.startPixel_,s=this.endPixel_,n="px",o=this.element_.style;o.left=Math.min(t[0],s[0])+n,o.top=Math.min(t[1],s[1])+n,o.width=Math.abs(s[0]-t[0])+n,o.height=Math.abs(s[1]-t[1])+n}setMap(t){if(this.map_){this.map_.getOverlayContainer().removeChild(this.element_);const s=this.element_.style;s.left="inherit",s.top="inherit",s.width="inherit",s.height="inherit"}this.map_=t,this.map_&&this.map_.getOverlayContainer().appendChild(this.element_)}setPixels(t,s){this.startPixel_=t,this.endPixel_=s,this.createOrUpdateGeometry(),this.render_()}createOrUpdateGeometry(){if(!this.map_)return;const t=this.startPixel_,s=this.endPixel_,o=[t,[t[0],s[1]],s,[s[0],t[1]]].map(this.map_.getCoordinateFromPixelInternal,this.map_);o[4]=o[0].slice(),this.geometry_?this.geometry_.setCoordinates([o]):this.geometry_=new Polygon([o])}getGeometry(){return this.geometry_}}const DragBoxEventType={BOXSTART:"boxstart",BOXDRAG:"boxdrag",BOXEND:"boxend",BOXCANCEL:"boxcancel"};class DragBoxEvent extends BaseEvent{constructor(t,s,n){super(t),this.coordinate=s,this.mapBrowserEvent=n}}class DragBox extends PointerInteraction{constructor(t){super(),this.on,this.once,this.un,t=t??{},this.box_=new RenderBox(t.className||"ol-dragbox"),this.minArea_=t.minArea??64,t.onBoxEnd&&(this.onBoxEnd=t.onBoxEnd),this.startPixel_=null,this.condition_=t.condition??mouseActionButton,this.boxEndCondition_=t.boxEndCondition??this.defaultBoxEndCondition}defaultBoxEndCondition(t,s,n){const o=n[0]-s[0],a=n[1]-s[1];return o*o+a*a>=this.minArea_}getGeometry(){return this.box_.getGeometry()}handleDragEvent(t){this.startPixel_&&(this.box_.setPixels(this.startPixel_,t.pixel),this.dispatchEvent(new DragBoxEvent(DragBoxEventType.BOXDRAG,t.coordinate,t)))}handleUpEvent(t){if(!this.startPixel_)return!1;const s=this.boxEndCondition_(t,this.startPixel_,t.pixel);return s&&this.onBoxEnd(t),this.dispatchEvent(new DragBoxEvent(s?DragBoxEventType.BOXEND:DragBoxEventType.BOXCANCEL,t.coordinate,t)),this.box_.setMap(null),this.startPixel_=null,!1}handleDownEvent(t){return this.condition_(t)?(this.startPixel_=t.pixel,this.box_.setMap(t.map),this.box_.setPixels(this.startPixel_,this.startPixel_),this.dispatchEvent(new DragBoxEvent(DragBoxEventType.BOXSTART,t.coordinate,t)),!0):!1}onBoxEnd(t){}setActive(t){t||(this.box_.setMap(null),this.startPixel_&&(this.dispatchEvent(new DragBoxEvent(DragBoxEventType.BOXCANCEL,this.startPixel_,null)),this.startPixel_=null)),super.setActive(t)}setMap(t){this.getMap()&&(this.box_.setMap(null),this.startPixel_&&(this.dispatchEvent(new DragBoxEvent(DragBoxEventType.BOXCANCEL,this.startPixel_,null)),this.startPixel_=null)),super.setMap(t)}}class DragZoom extends DragBox{constructor(t){t=t||{};const s=t.condition?t.condition:shiftKeyOnly;super({condition:s,className:t.className||"ol-dragzoom",minArea:t.minArea}),this.duration_=t.duration!==void 0?t.duration:200,this.out_=t.out!==void 0?t.out:!1}onBoxEnd(t){const n=this.getMap().getView();let o=this.getGeometry();if(this.out_){const a=n.rotatedExtentForGeometry(o),l=n.getResolutionForExtentInternal(a),c=n.getResolution()/l;o=o.clone(),o.scale(c*c)}n.fitInternal(o,{duration:this.duration_,easing:easeOut})}}const Key={LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",DOWN:"ArrowDown"};class KeyboardPan extends Interaction{constructor(t){super(),t=t||{},this.defaultCondition_=function(s){return noModifierKeys(s)&&targetNotEditable(s)},this.condition_=t.condition!==void 0?t.condition:this.defaultCondition_,this.duration_=t.duration!==void 0?t.duration:100,this.pixelDelta_=t.pixelDelta!==void 0?t.pixelDelta:128}handleEvent(t){let s=!1;if(t.type==EventType$1.KEYDOWN){const n=t.originalEvent,o=n.key;if(this.condition_(t)&&(o==Key.DOWN||o==Key.LEFT||o==Key.RIGHT||o==Key.UP)){const l=t.map.getView(),c=l.getResolution()*this.pixelDelta_;let d=0,u=0;o==Key.DOWN?u=-c:o==Key.LEFT?d=-c:o==Key.RIGHT?d=c:u=c;const _=[d,u];rotate$1(_,l.getRotation()),pan(l,_,this.duration_),n.preventDefault(),s=!0}}return!s}}class KeyboardZoom extends Interaction{constructor(t){super(),t=t||{},this.condition_=t.condition?t.condition:function(s){return!platformModifierKey(s)&&targetNotEditable(s)},this.delta_=t.delta?t.delta:1,this.duration_=t.duration!==void 0?t.duration:100}handleEvent(t){let s=!1;if(t.type==EventType$1.KEYDOWN||t.type==EventType$1.KEYPRESS){const n=t.originalEvent,o=n.key;if(this.condition_(t)&&(o==="+"||o==="-")){const a=t.map,l=o==="+"?this.delta_:-this.delta_,c=a.getView();zoomByDelta(c,l,void 0,this.duration_),n.preventDefault(),s=!0}}return!s}}const DELTA_LINE_MULTIPLIER=40,DELTA_PAGE_MULTIPLIER=300;class MouseWheelZoom extends Interaction{constructor(t){t=t||{},super(t),this.totalDelta_=0,this.lastDelta_=0,this.maxDelta_=t.maxDelta!==void 0?t.maxDelta:1,this.duration_=t.duration!==void 0?t.duration:250,this.timeout_=t.timeout!==void 0?t.timeout:80,this.useAnchor_=t.useAnchor!==void 0?t.useAnchor:!0,this.constrainResolution_=t.constrainResolution!==void 0?t.constrainResolution:!1;const s=t.condition?t.condition:always;this.condition_=t.onFocusOnly?all(focusWithTabindex,s):s,this.lastAnchor_=null,this.startTime_=void 0,this.timeoutId_,this.mode_=void 0,this.trackpadEventGap_=400,this.trackpadTimeoutId_,this.deltaPerZoom_=300}endInteraction_(){this.trackpadTimeoutId_=void 0;const t=this.getMap();if(!t)return;t.getView().endInteraction(void 0,this.lastDelta_?this.lastDelta_>0?1:-1:0,this.lastAnchor_?t.getCoordinateFromPixel(this.lastAnchor_):null)}handleEvent(t){if(!this.condition_(t)||t.type!==EventType$1.WHEEL)return!0;const n=t.map,o=t.originalEvent;o.preventDefault(),this.useAnchor_&&(this.lastAnchor_=t.pixel);let a=o.deltaY;switch(o.deltaMode){case WheelEvent.DOM_DELTA_LINE:a*=DELTA_LINE_MULTIPLIER;break;case WheelEvent.DOM_DELTA_PAGE:a*=DELTA_PAGE_MULTIPLIER;break}if(a===0)return!1;this.lastDelta_=a;const l=Date.now();this.startTime_===void 0&&(this.startTime_=l),(!this.mode_||l-this.startTime_>this.trackpadEventGap_)&&(this.mode_=Math.abs(a)<4?"trackpad":"wheel");const c=n.getView();if(this.mode_==="trackpad"&&!(c.getConstrainResolution()||this.constrainResolution_))return this.trackpadTimeoutId_?clearTimeout(this.trackpadTimeoutId_):(c.getAnimating()&&c.cancelAnimations(),c.beginInteraction()),this.trackpadTimeoutId_=setTimeout(this.endInteraction_.bind(this),this.timeout_),c.adjustZoom(-a/this.deltaPerZoom_,this.lastAnchor_?n.getCoordinateFromPixel(this.lastAnchor_):null),this.startTime_=l,!1;this.totalDelta_+=a;const d=Math.max(this.timeout_-(l-this.startTime_),0);return clearTimeout(this.timeoutId_),this.timeoutId_=setTimeout(this.handleWheelZoom_.bind(this,n),d),!1}handleWheelZoom_(t){const s=t.getView();s.getAnimating()&&s.cancelAnimations();let n=-clamp(this.totalDelta_,-this.maxDelta_*this.deltaPerZoom_,this.maxDelta_*this.deltaPerZoom_)/this.deltaPerZoom_;(s.getConstrainResolution()||this.constrainResolution_)&&(n=n?n>0?1:-1:0),zoomByDelta(s,n,this.lastAnchor_?t.getCoordinateFromPixel(this.lastAnchor_):null,this.duration_),this.mode_=void 0,this.totalDelta_=0,this.lastAnchor_=null,this.startTime_=void 0,this.timeoutId_=void 0}setMouseAnchor(t){this.useAnchor_=t,t||(this.lastAnchor_=null)}}class PinchRotate extends PointerInteraction{constructor(t){t=t||{};const s=t;s.stopDown||(s.stopDown=FALSE),super(s),this.anchor_=null,this.lastAngle_=void 0,this.rotating_=!1,this.rotationDelta_=0,this.threshold_=t.threshold!==void 0?t.threshold:.3,this.duration_=t.duration!==void 0?t.duration:250}handleDragEvent(t){let s=0;const n=this.targetPointers[0],o=this.targetPointers[1],a=Math.atan2(o.clientY-n.clientY,o.clientX-n.clientX);if(this.lastAngle_!==void 0){const d=a-this.lastAngle_;this.rotationDelta_+=d,!this.rotating_&&Math.abs(this.rotationDelta_)>this.threshold_&&(this.rotating_=!0),s=d}this.lastAngle_=a;const l=t.map,c=l.getView();c.getConstraints().rotation!==disable&&(this.anchor_=l.getCoordinateFromPixelInternal(l.getEventPixel(centroid(this.targetPointers))),this.rotating_&&(l.render(),c.adjustRotationInternal(s,this.anchor_)))}handleUpEvent(t){return this.targetPointers.length<2?(t.map.getView().endInteraction(this.duration_),!1):!0}handleDownEvent(t){if(this.targetPointers.length>=2){const s=t.map;return this.anchor_=null,this.lastAngle_=void 0,this.rotating_=!1,this.rotationDelta_=0,this.handlingDownUpSequence||s.getView().beginInteraction(),!0}return!1}}class PinchZoom extends PointerInteraction{constructor(t){t=t||{};const s=t;s.stopDown||(s.stopDown=FALSE),super(s),this.anchor_=null,this.duration_=t.duration!==void 0?t.duration:400,this.lastDistance_=void 0,this.lastScaleDelta_=1}handleDragEvent(t){let s=1;const n=this.targetPointers[0],o=this.targetPointers[1],a=n.clientX-o.clientX,l=n.clientY-o.clientY,c=Math.sqrt(a*a+l*l);this.lastDistance_!==void 0&&(s=this.lastDistance_/c),this.lastDistance_=c;const d=t.map,u=d.getView();s!=1&&(this.lastScaleDelta_=s),this.anchor_=d.getCoordinateFromPixelInternal(d.getEventPixel(centroid(this.targetPointers))),d.render(),u.adjustResolutionInternal(s,this.anchor_)}handleUpEvent(t){if(this.targetPointers.length<2){const n=t.map.getView(),o=this.lastScaleDelta_>1?1:-1;return n.endInteraction(this.duration_,o),!1}return!0}handleDownEvent(t){if(this.targetPointers.length>=2){const s=t.map;return this.anchor_=null,this.lastDistance_=void 0,this.lastScaleDelta_=1,this.handlingDownUpSequence||s.getView().beginInteraction(),!0}return!1}}function defaults(h){h=h||{};const t=new Collection,s=new Kinetic(-.005,.05,100);return(h.altShiftDragRotate!==void 0?h.altShiftDragRotate:!0)&&t.push(new DragRotate),(h.doubleClickZoom!==void 0?h.doubleClickZoom:!0)&&t.push(new DoubleClickZoom({delta:h.zoomDelta,duration:h.zoomDuration})),(h.dragPan!==void 0?h.dragPan:!0)&&t.push(new DragPan({onFocusOnly:h.onFocusOnly,kinetic:s})),(h.pinchRotate!==void 0?h.pinchRotate:!0)&&t.push(new PinchRotate),(h.pinchZoom!==void 0?h.pinchZoom:!0)&&t.push(new PinchZoom({duration:h.zoomDuration})),(h.keyboard!==void 0?h.keyboard:!0)&&(t.push(new KeyboardPan),t.push(new KeyboardZoom({delta:h.zoomDelta,duration:h.zoomDuration}))),(h.mouseWheelZoom!==void 0?h.mouseWheelZoom:!0)&&t.push(new MouseWheelZoom({onFocusOnly:h.onFocusOnly,duration:h.zoomDuration})),(h.shiftDragZoom!==void 0?h.shiftDragZoom:!0)&&t.push(new DragZoom({duration:h.zoomDuration})),t}class MapRenderer extends Disposable{constructor(t){super(),this.map_=t}dispatchRenderEvent(t,s){abstract()}calculateMatrices2D(t){const s=t.viewState,n=t.coordinateToPixelTransform,o=t.pixelToCoordinateTransform;compose(n,t.size[0]/2,t.size[1]/2,1/s.resolution,-1/s.resolution,-s.rotation,-s.center[0],-s.center[1]),makeInverse(o,n)}forEachFeatureAtCoordinate(t,s,n,o,a,l,c,d){let u;const _=s.viewState;function f(P,E,S,M){return a.call(l,E,P?S:null,M)}const g=_.projection,m=wrapX(t.slice(),g),p=[[0,0]];if(g.canWrapX()&&o){const P=g.getExtent(),E=getWidth(P);p.push([-E,0],[E,0])}const x=s.layerStatesArray,y=x.length,w=[],C=[];for(let P=0;P<p.length;P++)for(let E=y-1;E>=0;--E){const S=x[E],M=S.layer;if(M.hasRenderer()&&inView(S,_)&&c.call(d,M)){const R=M.getRenderer(),k=M.getSource();if(R&&k){const B=k.getWrapX()?m:t,z=f.bind(null,S.managed);C[0]=B[0]+p[P][0],C[1]=B[1]+p[P][1],u=R.forEachFeatureAtCoordinate(C,s,n,z,w)}if(u)return u}}if(w.length===0)return;const T=1/w.length;return w.forEach((P,E)=>P.distanceSq+=E*T),w.sort((P,E)=>P.distanceSq-E.distanceSq),w.some(P=>u=P.callback(P.feature,P.layer,P.geometry)),u}hasFeatureAtCoordinate(t,s,n,o,a,l){return this.forEachFeatureAtCoordinate(t,s,n,o,TRUE,this,a,l)!==void 0}getMap(){return this.map_}renderFrame(t){abstract()}scheduleExpireIconCache(t){shared.canExpireCache()&&t.postRenderFunctions.push(expireIconCache)}}function expireIconCache(h,t){shared.expire()}class CompositeMapRenderer extends MapRenderer{constructor(t){super(t),this.fontChangeListenerKey_=listen(checkedFonts,ObjectEventType.PROPERTYCHANGE,t.redrawText,t),this.element_=WORKER_OFFSCREEN_CANVAS?createMockDiv():document.createElement("div");const s=this.element_.style;s.position="absolute",s.width="100%",s.height="100%",s.zIndex="0",this.element_.className=CLASS_UNSELECTABLE+" ol-layers";const n=t.getViewport();n&&n.insertBefore(this.element_,n.firstChild||null),this.children_=[],this.renderedVisible_=!0}dispatchRenderEvent(t,s){const n=this.getMap();if(n.hasListener(t)){const o=new RenderEvent(t,void 0,s);n.dispatchEvent(o)}}disposeInternal(){unlistenByKey(this.fontChangeListenerKey_),this.element_.remove(),super.disposeInternal()}renderFrame(t){if(!t){this.renderedVisible_&&(this.element_.style.display="none",this.renderedVisible_=!1);return}this.calculateMatrices2D(t),this.dispatchRenderEvent(RenderEventType.PRECOMPOSE,t);const s=t.layerStatesArray.sort((u,_)=>u.zIndex-_.zIndex);s.some(u=>u.layer instanceof BaseVectorLayer&&u.layer.getDeclutter())&&(t.declutter={});const o=t.viewState;this.children_.length=0;const a=[];let l=null;for(let u=0,_=s.length;u<_;++u){const f=s[u];t.layerIndex=u;const g=f.layer,m=g.getSourceState();if(!inView(f,o)||m!="ready"&&m!="undefined"){g.unrender();continue}const p=g.render(t,l);p&&(p!==l&&(this.children_.push(p),l=p),a.push(f))}this.declutter(t,a),replaceChildren(this.element_,this.children_);const d=this.getMap().getTargetElement();if(isCanvas(d)){const u=d.getContext("2d");for(const _ of this.children_){const f=_.firstElementChild||_,g=_.style.backgroundColor;if(g&&(!isCanvas(f)||f.width>0)&&(u.fillStyle=g,u.fillRect(0,0,d.width,d.height)),isCanvas(f)&&f.width>0){const m=_.style.opacity||f.style.opacity;u.globalAlpha=m===""?1:Number(m);const p=f.style.transform;if(p)u.setTransform(...fromString(p));else{const x=parseFloat(f.style.width)/f.width,y=parseFloat(f.style.height)/f.height;u.setTransform(x,0,0,y,0,0)}u.drawImage(f,0,0)}}u.globalAlpha=1,u.setTransform(1,0,0,1,0,0)}this.dispatchRenderEvent(RenderEventType.POSTCOMPOSE,t),this.renderedVisible_||(this.element_.style.display="",this.renderedVisible_=!0),this.scheduleExpireIconCache(t)}declutter(t,s){if(t.declutter){for(let n=s.length-1;n>=0;--n){const o=s[n],a=o.layer;a.getDeclutter()&&a.renderDeclutter(t,o)}s.forEach(n=>n.layer.renderDeferred(t))}}}function removeLayerMapProperty(h){if(h instanceof Layer){h.setMapInternal(null);return}h instanceof LayerGroup&&h.getLayers().forEach(removeLayerMapProperty)}function setLayerMapProperty(h,t){if(h instanceof Layer){h.setMapInternal(t);return}if(h instanceof LayerGroup){const s=h.getLayers().getArray();for(let n=0,o=s.length;n<o;++n)setLayerMapProperty(s[n],t)}}let Map$1=class extends BaseObject{constructor(t){super(),t=t||{},this.on,this.once,this.un;const s=createOptionsInternal(t);this.renderComplete_=!1,this.loaded_=!0,this.boundHandleBrowserEvent_=this.handleBrowserEvent.bind(this),this.maxTilesLoading_=t.maxTilesLoading!==void 0?t.maxTilesLoading:16,this.pixelRatio_=t.pixelRatio!==void 0?t.pixelRatio:DEVICE_PIXEL_RATIO,this.postRenderTimeoutHandle_,this.animationDelayKey_,this.animationDelay_=this.animationDelay_.bind(this),this.coordinateToPixelTransform_=create(),this.pixelToCoordinateTransform_=create(),this.frameIndex_=0,this.frameState_=null,this.previousExtent_=null,this.viewPropertyListenerKey_=null,this.viewChangeListenerKey_=null,this.layerGroupPropertyListenerKeys_=null,WORKER_OFFSCREEN_CANVAS||(this.viewport_=document.createElement("div"),this.viewport_.className="ol-viewport"+("ontouchstart"in window?" ol-touch":""),this.viewport_.style.position="relative",this.viewport_.style.overflow="hidden",this.viewport_.style.width="100%",this.viewport_.style.height="100%",this.overlayContainer_=document.createElement("div"),this.overlayContainer_.style.position="absolute",this.overlayContainer_.style.zIndex="0",this.overlayContainer_.style.width="100%",this.overlayContainer_.style.height="100%",this.overlayContainer_.style.pointerEvents="none",this.overlayContainer_.className="ol-overlaycontainer",this.viewport_.appendChild(this.overlayContainer_),this.overlayContainerStopEvent_=document.createElement("div"),this.overlayContainerStopEvent_.style.position="absolute",this.overlayContainerStopEvent_.style.zIndex="0",this.overlayContainerStopEvent_.style.width="100%",this.overlayContainerStopEvent_.style.height="100%",this.overlayContainerStopEvent_.style.pointerEvents="none",this.overlayContainerStopEvent_.className="ol-overlaycontainer-stopevent",this.viewport_.appendChild(this.overlayContainerStopEvent_)),this.mapBrowserEventHandler_=null,this.moveTolerance_=t.moveTolerance,this.keyboardEventTarget_=s.keyboardEventTarget,this.targetChangeHandlerKeys_=null,this.targetElement_=null,WORKER_OFFSCREEN_CANVAS||(this.resizeObserver_=new ResizeObserver(()=>this.updateSize())),this.controls=s.controls||(WORKER_OFFSCREEN_CANVAS?new Collection:defaults$1()),this.interactions=s.interactions||(WORKER_OFFSCREEN_CANVAS?new Collection:defaults({onFocusOnly:!0})),this.overlays_=s.overlays,this.overlayIdIndex_={},this.renderer_=null,this.postRenderFunctions_=[],this.tileQueue_=new TileQueue(this.getTilePriority.bind(this),this.handleTileChange_.bind(this)),this.addChangeListener(MapProperty.LAYERGROUP,this.handleLayerGroupChanged_),this.addChangeListener(MapProperty.VIEW,this.handleViewChanged_),this.addChangeListener(MapProperty.SIZE,this.handleSizeChanged_),this.addChangeListener(MapProperty.TARGET,this.handleTargetChanged_),this.setProperties(s.values);const n=this;t.view&&!(t.view instanceof View)&&t.view.then(function(o){n.setView(new View(o))}),this.controls.addEventListener(CollectionEventType.ADD,o=>{o.element.setMap(this)}),this.controls.addEventListener(CollectionEventType.REMOVE,o=>{o.element.setMap(null)}),this.interactions.addEventListener(CollectionEventType.ADD,o=>{o.element.setMap(this)}),this.interactions.addEventListener(CollectionEventType.REMOVE,o=>{o.element.setMap(null)}),this.overlays_.addEventListener(CollectionEventType.ADD,o=>{this.addOverlayInternal_(o.element)}),this.overlays_.addEventListener(CollectionEventType.REMOVE,o=>{const a=o.element.getId();a!==void 0&&delete this.overlayIdIndex_[a.toString()],o.element.setMap(null)}),this.controls.forEach(o=>{o.setMap(this)}),this.interactions.forEach(o=>{o.setMap(this)}),this.overlays_.forEach(this.addOverlayInternal_.bind(this))}addControl(t){this.getControls().push(t)}addInteraction(t){this.getInteractions().push(t)}addLayer(t){this.getLayerGroup().getLayers().push(t)}handleLayerAdd_(t){setLayerMapProperty(t.layer,this)}addOverlay(t){this.getOverlays().push(t)}addOverlayInternal_(t){const s=t.getId();s!==void 0&&(this.overlayIdIndex_[s.toString()]=t),t.setMap(this)}disposeInternal(){var t;this.controls.clear(),this.interactions.clear(),this.overlays_.clear(),(t=this.resizeObserver_)==null||t.disconnect(),this.setTarget(null),super.disposeInternal()}forEachFeatureAtPixel(t,s,n){if(!this.frameState_||!this.renderer_)return;const o=this.getCoordinateFromPixelInternal(t);n=n!==void 0?n:{};const a=n.hitTolerance!==void 0?n.hitTolerance:0,l=n.layerFilter!==void 0?n.layerFilter:TRUE,c=n.checkWrapped!==!1;return this.renderer_.forEachFeatureAtCoordinate(o,this.frameState_,a,c,s,null,l,null)}getFeaturesAtPixel(t,s){const n=[];return this.forEachFeatureAtPixel(t,function(o){n.push(o)},s),n}getAllLayers(){const t=[];function s(n){n.forEach(function(o){o instanceof LayerGroup?s(o.getLayers()):t.push(o)})}return s(this.getLayers()),t}hasFeatureAtPixel(t,s){if(!this.frameState_||!this.renderer_)return!1;const n=this.getCoordinateFromPixelInternal(t);s=s!==void 0?s:{};const o=s.layerFilter!==void 0?s.layerFilter:TRUE,a=s.hitTolerance!==void 0?s.hitTolerance:0,l=s.checkWrapped!==!1;return this.renderer_.hasFeatureAtCoordinate(n,this.frameState_,a,l,o,null)}getEventCoordinate(t){return this.getCoordinateFromPixel(this.getEventPixel(t))}getEventCoordinateInternal(t){return this.getCoordinateFromPixelInternal(this.getEventPixel(t))}getEventPixel(t){const n=this.viewport_.getBoundingClientRect(),o=this.getSize(),a=n.width/o[0],l=n.height/o[1],c="changedTouches"in t?t.changedTouches[0]:t;return[(c.clientX-n.left)/a,(c.clientY-n.top)/l]}getTarget(){return this.get(MapProperty.TARGET)}getTargetElement(){return this.targetElement_}getCoordinateFromPixel(t){return toUserCoordinate(this.getCoordinateFromPixelInternal(t),this.getView().getProjection())}getCoordinateFromPixelInternal(t){const s=this.frameState_;return s?apply(s.pixelToCoordinateTransform,t.slice()):null}getControls(){return this.controls}getOverlays(){return this.overlays_}getOverlayById(t){const s=this.overlayIdIndex_[t.toString()];return s!==void 0?s:null}getInteractions(){return this.interactions}getLayerGroup(){return this.get(MapProperty.LAYERGROUP)}setLayers(t){const s=this.getLayerGroup();if(t instanceof Collection){s.setLayers(t);return}const n=s.getLayers();n.clear(),n.extend(t)}getLayers(){return this.getLayerGroup().getLayers()}getLoadingOrNotReady(){const t=this.getLayerGroup().getLayerStatesArray();for(let s=0,n=t.length;s<n;++s){const o=t[s];if(!o.visible)continue;const a=o.layer.getRenderer();if(a&&!a.ready)return!0;const l=o.layer.getSource();if(l&&l.loading)return!0}return!1}getPixelFromCoordinate(t){const s=fromUserCoordinate(t,this.getView().getProjection());return this.getPixelFromCoordinateInternal(s)}getPixelFromCoordinateInternal(t){const s=this.frameState_;return s?apply(s.coordinateToPixelTransform,t.slice(0,2)):null}getRenderer(){return this.renderer_}getSize(){return this.get(MapProperty.SIZE)}getView(){return this.get(MapProperty.VIEW)}getViewport(){return this.viewport_}getOverlayContainer(){return this.overlayContainer_}getOverlayContainerStopEvent(){return this.overlayContainerStopEvent_}getOwnerDocument(){const t=this.getTargetElement();return t?t.ownerDocument:document}getTilePriority(t,s,n,o){return getTilePriority(this.frameState_,t,s,n,o)}handleBrowserEvent(t,s){s=s||t.type;const n=new MapBrowserEvent(s,this,t);this.handleMapBrowserEvent(n)}handleMapBrowserEvent(t){if(!this.frameState_)return;const s=t.originalEvent,n=s.type;if(n===EventType.POINTERDOWN||n===EventType$1.WHEEL||n===EventType$1.KEYDOWN){const o=this.getOwnerDocument(),a=this.viewport_.getRootNode?this.viewport_.getRootNode():o,l=s.target,c=a instanceof ShadowRoot?a.host===l?a.host.ownerDocument:a:a===o?o.documentElement:a;if(this.overlayContainerStopEvent_.contains(l)||!c.contains(l))return}if(t.frameState=this.frameState_,this.dispatchEvent(t)!==!1){const o=this.getInteractions().getArray().slice();for(let a=o.length-1;a>=0;a--){const l=o[a];if(l.getMap()!==this||!l.getActive()||!this.getTargetElement())continue;if(!l.handleEvent(t)||t.propagationStopped)break}}}handlePostRender(){const t=this.frameState_,s=this.tileQueue_;if(!s.isEmpty()){let o=this.maxTilesLoading_,a=o;if(t){const l=t.viewHints;if(l[ViewHint.ANIMATING]||l[ViewHint.INTERACTING]){const c=Date.now()-t.time>8;o=c?0:8,a=c?0:2}}s.getTilesLoading()<o&&(s.reprioritize(),s.loadMoreTiles(o,a))}t&&this.renderer_&&!t.animate&&(this.renderComplete_?(this.hasListener(RenderEventType.RENDERCOMPLETE)&&this.renderer_.dispatchRenderEvent(RenderEventType.RENDERCOMPLETE,t),this.loaded_===!1&&(this.loaded_=!0,this.dispatchEvent(new MapEvent(MapEventType.LOADEND,this,t)))):this.loaded_===!0&&(this.loaded_=!1,this.dispatchEvent(new MapEvent(MapEventType.LOADSTART,this,t))));const n=this.postRenderFunctions_;if(t)for(let o=0,a=n.length;o<a;++o)n[o](this,t);n.length=0}handleSizeChanged_(){this.getView()&&!this.getView().getAnimating()&&this.getView().resolveConstraints(0),this.render()}handleTargetChanged_(){var n,o;if(this.mapBrowserEventHandler_){for(let a=0,l=this.targetChangeHandlerKeys_.length;a<l;++a)unlistenByKey(this.targetChangeHandlerKeys_[a]);this.targetChangeHandlerKeys_=null,this.viewport_.removeEventListener(EventType$1.CONTEXTMENU,this.boundHandleBrowserEvent_),this.viewport_.removeEventListener(EventType$1.WHEEL,this.boundHandleBrowserEvent_),this.mapBrowserEventHandler_.dispose(),this.mapBrowserEventHandler_=null,this.viewport_.remove()}if(this.targetElement_&&!isCanvas(this.targetElement_)){(n=this.resizeObserver_)==null||n.unobserve(this.targetElement_);const a=this.targetElement_.getRootNode();a instanceof ShadowRoot&&this.resizeObserver_.unobserve(a.host),this.setSize(void 0)}const t=this.getTarget(),s=typeof t=="string"?document.getElementById(t):t;if(this.targetElement_=s,!s)this.renderer_&&(clearTimeout(this.postRenderTimeoutHandle_),this.postRenderTimeoutHandle_=void 0,this.postRenderFunctions_.length=0,this.renderer_.dispose(),this.renderer_=null),this.animationDelayKey_&&(cancelAnimationFrame(this.animationDelayKey_),this.animationDelayKey_=void 0);else{if(isCanvas(s)||s.appendChild(this.viewport_),this.renderer_||(this.renderer_=new CompositeMapRenderer(this)),!isCanvas(s)){this.mapBrowserEventHandler_=new MapBrowserEventHandler(this,this.moveTolerance_);for(const l in MapBrowserEventType)this.mapBrowserEventHandler_.addEventListener(MapBrowserEventType[l],this.handleMapBrowserEvent.bind(this));this.viewport_.addEventListener(EventType$1.CONTEXTMENU,this.boundHandleBrowserEvent_,!1),this.viewport_.addEventListener(EventType$1.WHEEL,this.boundHandleBrowserEvent_,PASSIVE_EVENT_LISTENERS?{passive:!1}:!1);let a;if(this.keyboardEventTarget_)a=this.keyboardEventTarget_;else{const l=s.getRootNode();a=l instanceof ShadowRoot?l.host:s}if(this.targetChangeHandlerKeys_=[listen(a,EventType$1.KEYDOWN,this.handleBrowserEvent,this),listen(a,EventType$1.KEYPRESS,this.handleBrowserEvent,this)],s instanceof HTMLElement){const l=s.getRootNode();l instanceof ShadowRoot&&this.resizeObserver_.observe(l.host),(o=this.resizeObserver_)==null||o.observe(s)}}this.updateSize()}}handleTileChange_(){this.render()}handleViewPropertyChanged_(){this.render()}handleViewChanged_(){this.viewPropertyListenerKey_&&(unlistenByKey(this.viewPropertyListenerKey_),this.viewPropertyListenerKey_=null),this.viewChangeListenerKey_&&(unlistenByKey(this.viewChangeListenerKey_),this.viewChangeListenerKey_=null);const t=this.getView();t&&(this.updateViewportSize_(this.getSize()),this.viewPropertyListenerKey_=listen(t,ObjectEventType.PROPERTYCHANGE,this.handleViewPropertyChanged_,this),this.viewChangeListenerKey_=listen(t,EventType$1.CHANGE,this.handleViewPropertyChanged_,this),t.resolveConstraints(0)),this.render()}handleLayerGroupChanged_(){this.layerGroupPropertyListenerKeys_&&(this.layerGroupPropertyListenerKeys_.forEach(unlistenByKey),this.layerGroupPropertyListenerKeys_=null);const t=this.getLayerGroup();t&&(this.handleLayerAdd_(new GroupEvent("addlayer",t)),this.layerGroupPropertyListenerKeys_=[listen(t,ObjectEventType.PROPERTYCHANGE,this.render,this),listen(t,EventType$1.CHANGE,this.render,this),listen(t,"addlayer",this.handleLayerAdd_,this),listen(t,"removelayer",this.handleLayerRemove_,this)]),this.render()}isRendered(){return!!this.frameState_}animationDelay_(){this.animationDelayKey_=void 0,this.renderFrame_(Date.now())}renderSync(){this.animationDelayKey_&&cancelAnimationFrame(this.animationDelayKey_),this.animationDelay_()}redrawText(){if(!this.frameState_)return;const t=this.frameState_.layerStatesArray;for(let s=0,n=t.length;s<n;++s){const o=t[s].layer;o.hasRenderer()&&o.getRenderer().handleFontsChanged()}}render(){this.renderer_&&this.animationDelayKey_===void 0&&(this.animationDelayKey_=requestAnimationFrame(this.animationDelay_))}removeControl(t){return this.getControls().remove(t)}removeInteraction(t){return this.getInteractions().remove(t)}removeLayer(t){return this.getLayerGroup().getLayers().remove(t)}handleLayerRemove_(t){removeLayerMapProperty(t.layer)}removeOverlay(t){return this.getOverlays().remove(t)}renderFrame_(t){const s=this.getSize(),n=this.getView(),o=this.frameState_;let a=null;if(s!==void 0&&hasArea(s)&&n&&n.isDef()){const l=n.getHints(this.frameState_?this.frameState_.viewHints:void 0),c=n.getState();if(a={animate:!1,coordinateToPixelTransform:this.coordinateToPixelTransform_,declutter:null,extent:getForViewAndSize(c.center,c.resolution,c.rotation,s),index:this.frameIndex_++,layerIndex:0,layerStatesArray:this.getLayerGroup().getLayerStatesArray(),pixelRatio:this.pixelRatio_,pixelToCoordinateTransform:this.pixelToCoordinateTransform_,postRenderFunctions:[],size:s,tileQueue:this.tileQueue_,time:t,usedTiles:{},viewState:c,viewHints:l,wantedTiles:{},mapId:getUid(this),renderTargets:{}},c.nextCenter&&c.nextResolution){const d=isNaN(c.nextRotation)?c.rotation:c.nextRotation;a.nextExtent=getForViewAndSize(c.nextCenter,c.nextResolution,d,s)}}this.frameState_=a,this.renderer_.renderFrame(a),a&&(a.animate&&this.render(),Array.prototype.push.apply(this.postRenderFunctions_,a.postRenderFunctions),o&&(!this.previousExtent_||!isEmpty(this.previousExtent_)&&!equals$1(a.extent,this.previousExtent_))&&(this.dispatchEvent(new MapEvent(MapEventType.MOVESTART,this,o)),this.previousExtent_=createOrUpdateEmpty(this.previousExtent_)),this.previousExtent_&&!a.viewHints[ViewHint.ANIMATING]&&!a.viewHints[ViewHint.INTERACTING]&&!equals$1(a.extent,this.previousExtent_)&&(this.dispatchEvent(new MapEvent(MapEventType.MOVEEND,this,a)),clone(a.extent,this.previousExtent_))),this.dispatchEvent(new MapEvent(MapEventType.POSTRENDER,this,a)),this.renderComplete_=(this.hasListener(MapEventType.LOADSTART)||this.hasListener(MapEventType.LOADEND)||this.hasListener(RenderEventType.RENDERCOMPLETE))&&!this.tileQueue_.getTilesLoading()&&!this.tileQueue_.getCount()&&!this.getLoadingOrNotReady(),this.postRenderTimeoutHandle_||(this.postRenderTimeoutHandle_=setTimeout(()=>{this.postRenderTimeoutHandle_=void 0,this.handlePostRender()},0))}setLayerGroup(t){const s=this.getLayerGroup();s&&this.handleLayerRemove_(new GroupEvent("removelayer",s)),this.set(MapProperty.LAYERGROUP,t)}setSize(t){this.set(MapProperty.SIZE,t)}setTarget(t){this.set(MapProperty.TARGET,t)}setView(t){if(!t||t instanceof View){this.set(MapProperty.VIEW,t);return}this.set(MapProperty.VIEW,new View);const s=this;t.then(function(n){s.setView(new View(n))})}updateSize(){const t=this.getTargetElement();let s;if(t){let o,a;if(isCanvas(t))o=t.width,a=t.height;else{const l=getComputedStyle(t);o=t.offsetWidth-parseFloat(l.borderLeftWidth)-parseFloat(l.paddingLeft)-parseFloat(l.paddingRight)-parseFloat(l.borderRightWidth),a=t.offsetHeight-parseFloat(l.borderTopWidth)-parseFloat(l.paddingTop)-parseFloat(l.paddingBottom)-parseFloat(l.borderBottomWidth)}!isNaN(o)&&!isNaN(a)&&(s=[Math.max(0,o),Math.max(0,a)],!hasArea(s)&&(t.offsetWidth||t.offsetHeight||t.getClientRects().length)&&warn("No map visible because the map container's width or height are 0."))}const n=this.getSize();s&&(!n||!equals(s,n))&&(this.setSize(s),this.updateViewportSize_(s))}updateViewportSize_(t){const s=this.getView();s&&s.setViewportSize(t)}};function createOptionsInternal(h){let t=null;h.keyboardEventTarget!==void 0&&(t=typeof h.keyboardEventTarget=="string"?document.getElementById(h.keyboardEventTarget):h.keyboardEventTarget);const s={},n=h.layers&&typeof h.layers.getLayers=="function"?h.layers:new LayerGroup({layers:h.layers});s[MapProperty.LAYERGROUP]=n,s[MapProperty.TARGET]=h.target,s[MapProperty.VIEW]=h.view instanceof View?h.view:new View;let o;h.controls!==void 0&&(Array.isArray(h.controls)?o=new Collection(h.controls.slice()):(assert(typeof h.controls.getArray=="function","Expected `controls` to be an array or an `ol/Collection.js`"),o=h.controls));let a;h.interactions!==void 0&&(Array.isArray(h.interactions)?a=new Collection(h.interactions.slice()):(assert(typeof h.interactions.getArray=="function","Expected `interactions` to be an array or an `ol/Collection.js`"),a=h.interactions));let l;return h.overlays!==void 0?Array.isArray(h.overlays)?l=new Collection(h.overlays.slice()):(assert(typeof h.overlays.getArray=="function","Expected `overlays` to be an array or an `ol/Collection.js`"),l=h.overlays):l=new Collection,{controls:o,interactions:a,keyboardEventTarget:t,overlays:l,values:s}}const Property={ELEMENT:"element",MAP:"map",OFFSET:"offset",POSITION:"position",POSITIONING:"positioning"};class Overlay extends BaseObject{constructor(t){super(),this.on,this.once,this.un,this.options=t,this.id=t.id,this.insertFirst=t.insertFirst!==void 0?t.insertFirst:!0,this.stopEvent=t.stopEvent!==void 0?t.stopEvent:!0,this.element=document.createElement("div"),this.element.className=t.className!==void 0?t.className:"ol-overlay-container "+CLASS_SELECTABLE,this.element.style.position="absolute",this.element.style.pointerEvents="auto",this.autoPan=t.autoPan===!0?{}:t.autoPan||void 0,this.rendered={transform_:"",visible:!0},this.mapPostrenderListenerKey=null,this.addChangeListener(Property.ELEMENT,this.handleElementChanged),this.addChangeListener(Property.MAP,this.handleMapChanged),this.addChangeListener(Property.OFFSET,this.handleOffsetChanged),this.addChangeListener(Property.POSITION,this.handlePositionChanged),this.addChangeListener(Property.POSITIONING,this.handlePositioningChanged),t.element!==void 0&&this.setElement(t.element),this.setOffset(t.offset!==void 0?t.offset:[0,0]),this.setPositioning(t.positioning||"top-left"),t.position!==void 0&&this.setPosition(t.position)}getElement(){return this.get(Property.ELEMENT)}getId(){return this.id}getMap(){return this.get(Property.MAP)||null}getOffset(){return this.get(Property.OFFSET)}getPosition(){return this.get(Property.POSITION)}getPositioning(){return this.get(Property.POSITIONING)}handleElementChanged(){removeChildren(this.element);const t=this.getElement();t&&this.element.appendChild(t)}handleMapChanged(){var s;this.mapPostrenderListenerKey&&((s=this.element)==null||s.remove(),unlistenByKey(this.mapPostrenderListenerKey),this.mapPostrenderListenerKey=null);const t=this.getMap();if(t){this.mapPostrenderListenerKey=listen(t,MapEventType.POSTRENDER,this.render,this),this.updatePixelPosition();const n=this.stopEvent?t.getOverlayContainerStopEvent():t.getOverlayContainer();this.insertFirst?n.insertBefore(this.element,n.childNodes[0]||null):n.appendChild(this.element),this.performAutoPan()}}render(){this.updatePixelPosition()}handleOffsetChanged(){this.updatePixelPosition()}handlePositionChanged(){this.updatePixelPosition(),this.performAutoPan()}handlePositioningChanged(){this.updatePixelPosition()}setElement(t){this.set(Property.ELEMENT,t)}setMap(t){this.set(Property.MAP,t)}setOffset(t){this.set(Property.OFFSET,t)}setPosition(t){this.set(Property.POSITION,t)}performAutoPan(){this.autoPan&&this.panIntoView(this.autoPan)}panIntoView(t){const s=this.getMap();if(!s||!s.getTargetElement()||!this.get(Property.POSITION))return;const n=this.getRect(s.getTargetElement(),s.getSize()),o=this.getElement(),a=this.getRect(o,[outerWidth(o),outerHeight(o)]);t=t||{};const l=t.margin===void 0?20:t.margin;if(!containsExtent(n,a)){const c=a[0]-n[0],d=n[2]-a[2],u=a[1]-n[1],_=n[3]-a[3],f=[0,0];if(c<0?f[0]=c-l:d<0&&(f[0]=Math.abs(d)+l),u<0?f[1]=u-l:_<0&&(f[1]=Math.abs(_)+l),f[0]!==0||f[1]!==0){const g=s.getView().getCenterInternal(),m=s.getPixelFromCoordinateInternal(g);if(!m)return;const p=[m[0]+f[0],m[1]+f[1]],x=t.animation||{};s.getView().animateInternal({center:s.getCoordinateFromPixelInternal(p),duration:x.duration,easing:x.easing})}}}getRect(t,s){const n=t.getBoundingClientRect(),o=n.left+window.pageXOffset,a=n.top+window.pageYOffset;return[o,a,o+s[0],a+s[1]]}setPositioning(t){this.set(Property.POSITIONING,t)}setVisible(t){this.rendered.visible!==t&&(this.element.style.display=t?"":"none",this.rendered.visible=t)}updatePixelPosition(){const t=this.getMap(),s=this.getPosition();if(!t||!t.isRendered()||!s){this.setVisible(!1);return}const n=t.getPixelFromCoordinate(s),o=t.getSize();this.updateRenderedPosition(n,o)}updateRenderedPosition(t,s){const n=this.element.style,o=this.getOffset(),a=this.getPositioning();this.setVisible(!0);const l=`${t[0]+o[0]}px`,c=`${t[1]+o[1]}px`;let d="0%",u="0%";a=="bottom-right"||a=="center-right"||a=="top-right"?d="-100%":(a=="bottom-center"||a=="center-center"||a=="top-center")&&(d="-50%"),a=="bottom-left"||a=="bottom-center"||a=="bottom-right"?u="-100%":(a=="center-left"||a=="center-center"||a=="center-right")&&(u="-50%");const _=`translate(${d}, ${u}) translate(${l}, ${c})`;this.rendered.transform_!=_&&(this.rendered.transform_=_,n.transform=_)}getOptions(){return this.options}}const DEFAULT_VERSION="1.3.0",GETFEATUREINFO_IMAGE_SIZE=[101,101];function getRequestUrl(h,t,s,n,o){o.WIDTH=s[0],o.HEIGHT=s[1];const a=n.getAxisOrientation(),l=compareVersions(o.VERSION,"1.3")>=0;o[l?"CRS":"SRS"]=n.getCode();const c=l&&a.startsWith("ne")?[t[1],t[0],t[3],t[2]]:t;return o.BBOX=c.join(","),appendParams(h,o)}function getImageSrc(h,t,s,n,o,a,l){a=Object.assign({REQUEST:"GetMap"},a);const c=t/s,d=[round(getWidth(h)/c,DECIMALS),round(getHeight(h)/c,DECIMALS)];if(s!=1)switch(l){case"geoserver":const _=90*s+.5|0;"FORMAT_OPTIONS"in a?a.FORMAT_OPTIONS+=";dpi:"+_:a.FORMAT_OPTIONS="dpi:"+_;break;case"mapserver":a.MAP_RESOLUTION=90*s;break;case"carmentaserver":case"qgis":a.DPI=90*s;break;default:throw new Error("Unknown `serverType` configured")}return getRequestUrl(o,h,d,n,a)}function getRequestParams(h,t){return Object.assign({REQUEST:t,SERVICE:"WMS",VERSION:DEFAULT_VERSION,FORMAT:"image/png",STYLES:"",TRANSPARENT:"TRUE"},h)}function createLoader(h){const t=h.hidpi===void 0?!0:h.hidpi,s=get(h.projection||"EPSG:3857"),n=h.ratio||1.5,o=h.load||decode,a=h.crossOrigin??null;return(l,c,d)=>{l=getRequestExtent(l,c,d,n),d!=1&&(!t||h.serverType===void 0)&&(d=1);const u=getImageSrc(l,c,d,s,h.url,getRequestParams(h.params,"GetMap"),h.serverType),_=new Image;return _.crossOrigin=a,o(_,u).then(f=>({image:f,extent:l,pixelRatio:d}))}}function getFeatureInfoUrl(h,t,s){if(h.url===void 0)return;const n=get(h.projection||"EPSG:3857"),o=getForViewAndSize(t,s,0,GETFEATUREINFO_IMAGE_SIZE),a={QUERY_LAYERS:h.params.LAYERS,INFO_FORMAT:"application/json"};Object.assign(a,getRequestParams(h.params,"GetFeatureInfo"),h.params);const l=floor((t[0]-o[0])/s,DECIMALS),c=floor((o[3]-t[1])/s,DECIMALS),d=compareVersions(a.VERSION,"1.3")>=0;return a[d?"I":"X"]=l,a[d?"J":"Y"]=c,getRequestUrl(h.url,o,GETFEATUREINFO_IMAGE_SIZE,n,a)}function getLegendUrl(h,t){if(h.url===void 0)return;const s={SERVICE:"WMS",VERSION:DEFAULT_VERSION,REQUEST:"GetLegendGraphic",FORMAT:"image/png"};if(t!==void 0){const n=get(h.projection||"EPSG:3857").getMetersPerUnit()||1,o=28e-5;s.SCALE=t*n/o}if(Object.assign(s,h.params),h.params!==void 0&&s.LAYER===void 0){const n=s.LAYERS;if(!(!Array.isArray(n)||n.length!==1))return;s.LAYER=n}return appendParams(h.url,s)}class ImageWMS extends ImageSource{constructor(t){t=t||{},super({attributions:t.attributions,interpolate:t.interpolate,projection:t.projection,resolutions:t.resolutions}),this.crossOrigin_=t.crossOrigin!==void 0?t.crossOrigin:null,this.url_=t.url,this.imageLoadFunction_=t.imageLoadFunction!==void 0?t.imageLoadFunction:defaultImageLoadFunction,this.params_=Object.assign({},t.params),this.serverType_=t.serverType,this.hidpi_=t.hidpi!==void 0?t.hidpi:!0,this.renderedRevision_=0,this.ratio_=t.ratio!==void 0?t.ratio:1.5,this.loaderProjection_=null}getFeatureInfoUrl(t,s,n,o){const a=get(n),l=this.getProjection();l&&l!==a&&(s=calculateSourceResolution(l,a,t,s),t=transform$1(t,a,l));const c={url:this.url_,params:{...this.params_,...o},projection:l||a};return getFeatureInfoUrl(c,t,s)}getLegendUrl(t,s){return getLegendUrl({url:this.url_,params:{...this.params_,...s}},t)}getParams(){return this.params_}getImageInternal(t,s,n,o){return this.url_===void 0?null:((!this.loader||this.loaderProjection_!==o)&&(this.loaderProjection_=o,this.loader=createLoader({crossOrigin:this.crossOrigin_,params:this.params_,projection:o,serverType:this.serverType_,hidpi:this.hidpi_,url:this.url_,ratio:this.ratio_,load:(a,l)=>(this.image.setImage(a),this.imageLoadFunction_(this.image,l),decode(a))})),super.getImageInternal(t,s,n,o))}getImageLoadFunction(){return this.imageLoadFunction_}getUrl(){return this.url_}setImageLoadFunction(t){this.imageLoadFunction_=t,this.changed()}setUrl(t){t!=this.url_&&(this.url_=t,this.loader=null,this.changed())}setParams(t){this.params_=Object.assign({},t),this.changed()}updateParams(t){Object.assign(this.params_,t),this.changed()}changed(){this.image=null,super.changed()}}class TileWMS extends TileImage{constructor(t){t=t||{};const s=Object.assign({},t.params);super({attributions:t.attributions,attributionsCollapsible:t.attributionsCollapsible,cacheSize:t.cacheSize,crossOrigin:t.crossOrigin,interpolate:t.interpolate,projection:t.projection,reprojectionErrorThreshold:t.reprojectionErrorThreshold,tileClass:t.tileClass,tileGrid:t.tileGrid,tileLoadFunction:t.tileLoadFunction,url:t.url,urls:t.urls,wrapX:t.wrapX!==void 0?t.wrapX:!0,transition:t.transition,zDirection:t.zDirection}),this.gutter_=t.gutter!==void 0?t.gutter:0,this.params_=s,this.v13_=!0,this.serverType_=t.serverType,this.hidpi_=t.hidpi!==void 0?t.hidpi:!0,this.tmpExtent_=createEmpty(),this.updateV13_(),this.setKey(this.getKeyForParams_())}getFeatureInfoUrl(t,s,n,o){const a=get(n),l=this.getProjection()||a;let c=this.getTileGrid();c||(c=this.getTileGridForProjection(l));const d=transform$1(t,a,l),u=calculateSourceResolution(l,a,t,s),_=c.getZForResolution(u,this.zDirection),f=c.getResolution(_),g=c.getTileCoordForCoordAndZ(d,_);if(c.getResolutions().length<=g[0])return;let m=c.getTileCoordExtent(g,this.tmpExtent_);const p=this.gutter_;p!==0&&(m=buffer(m,f*p,m));const x={QUERY_LAYERS:this.params_.LAYERS};Object.assign(x,getRequestParams(this.params_,"GetFeatureInfo"),o);const y=Math.floor((d[0]-m[0])/f),w=Math.floor((m[3]-d[1])/f);return x[this.v13_?"I":"X"]=y,x[this.v13_?"J":"Y"]=w,this.getRequestUrl_(g,m,1,l||a,x)}getLegendUrl(t,s){if(this.urls[0]===void 0)return;const n={SERVICE:"WMS",VERSION:DEFAULT_VERSION,REQUEST:"GetLegendGraphic",FORMAT:"image/png"};if(s===void 0||s.LAYER===void 0){const o=this.params_.LAYERS;if(!(!Array.isArray(o)||o.length===1))return;n.LAYER=o}if(t!==void 0){const o=this.getProjection()?this.getProjection().getMetersPerUnit():1,a=28e-5;n.SCALE=t*o/a}return Object.assign(n,s),appendParams(this.urls[0],n)}getGutter(){return this.gutter_}getParams(){return this.params_}getRequestUrl_(t,s,n,o,a){const l=this.urls;if(!l)return;let c;if(l.length==1)c=l[0];else{const d=modulo(hash(t),l.length);c=l[d]}return getImageSrc(s,(this.tileGrid||this.getTileGridForProjection(o)).getResolution(t[0]),n,o,c,a,this.serverType_)}getTilePixelRatio(t){return!this.hidpi_||this.serverType_===void 0?1:t}getKeyForParams_(){let t=0;const s=[];for(const n in this.params_)s[t++]=n+"-"+this.params_[n];return s.join("/")}setParams_(t){this.params_=t,this.updateV13_(),this.setKey(this.getKeyForParams_())}setParams(t){this.setParams_(Object.assign({},t))}updateParams(t){this.setParams_(Object.assign(this.params_,t))}updateV13_(){const t=this.params_.VERSION||DEFAULT_VERSION;this.v13_=compareVersions(t,"1.3")>=0}tileUrlFunction(t,s,n){let o=this.getTileGrid();if(o||(o=this.getTileGridForProjection(n)),o.getResolutions().length<=t[0])return;s!=1&&(!this.hidpi_||this.serverType_===void 0)&&(s=1);const a=o.getResolution(t[0]);let l=o.getTileCoordExtent(t,this.tmpExtent_);const c=this.gutter_;c!==0&&(l=buffer(l,a*c,l));const d=Object.assign({},getRequestParams(this.params_,"GetMap"));return this.getRequestUrl_(t,l,s,n,d)}}const olCss=':root,:host{--ol-background-color: white;--ol-accent-background-color: #F5F5F5;--ol-subtle-background-color: rgba(128, 128, 128, .25);--ol-partial-background-color: rgba(255, 255, 255, .75);--ol-foreground-color: #333333;--ol-subtle-foreground-color: #666666;--ol-brand-color: #00AAFF}.ol-box{box-sizing:border-box;border-radius:2px;border:1.5px solid var(--ol-background-color);background-color:var(--ol-partial-background-color)}.ol-mouse-position{top:8px;right:8px;position:absolute}.ol-scale-line{background:var(--ol-partial-background-color);border-radius:4px;bottom:8px;left:8px;padding:2px;position:absolute}.ol-scale-line-inner{border:1px solid var(--ol-subtle-foreground-color);border-top:none;color:var(--ol-foreground-color);font-size:10px;text-align:center;margin:1px;will-change:contents,width;transition:all .25s}.ol-scale-bar{position:absolute;bottom:8px;left:8px}.ol-scale-bar-inner{display:flex}.ol-scale-step-marker{width:1px;height:15px;background-color:var(--ol-foreground-color);float:right;z-index:10}.ol-scale-step-text{position:absolute;bottom:-5px;font-size:10px;z-index:11;color:var(--ol-foreground-color);text-shadow:-1.5px 0 var(--ol-partial-background-color),0 1.5px var(--ol-partial-background-color),1.5px 0 var(--ol-partial-background-color),0 -1.5px var(--ol-partial-background-color)}.ol-scale-text{position:absolute;font-size:12px;text-align:center;bottom:25px;color:var(--ol-foreground-color);text-shadow:-1.5px 0 var(--ol-partial-background-color),0 1.5px var(--ol-partial-background-color),1.5px 0 var(--ol-partial-background-color),0 -1.5px var(--ol-partial-background-color)}.ol-scale-singlebar{position:relative;height:10px;z-index:9;box-sizing:border-box;border:1px solid var(--ol-foreground-color)}.ol-scale-singlebar-even{background-color:var(--ol-subtle-foreground-color)}.ol-scale-singlebar-odd{background-color:var(--ol-background-color)}.ol-unsupported{display:none}.ol-viewport,.ol-unselectable{-webkit-touch-callout:none;-webkit-user-select:none;-moz-user-select:none;user-select:none;-webkit-tap-highlight-color:transparent}.ol-viewport canvas{all:unset;overflow:hidden}.ol-viewport{touch-action:pan-x pan-y}.ol-selectable{-webkit-touch-callout:default;-webkit-user-select:text;-moz-user-select:text;user-select:text}.ol-grabbing{cursor:-webkit-grabbing;cursor:-moz-grabbing;cursor:grabbing}.ol-grab{cursor:move;cursor:-webkit-grab;cursor:-moz-grab;cursor:grab}.ol-control{position:absolute;background-color:var(--ol-subtle-background-color);border-radius:4px}.ol-zoom{top:.5em;left:.5em}.ol-rotate{top:.5em;right:.5em;transition:opacity .25s linear,visibility 0s linear}.ol-rotate.ol-hidden{opacity:0;visibility:hidden;transition:opacity .25s linear,visibility 0s linear .25s}.ol-zoom-extent{top:4.643em;left:.5em}.ol-full-screen{right:.5em;top:.5em}.ol-control button{display:block;margin:1px;padding:0;color:var(--ol-subtle-foreground-color);font-weight:700;text-decoration:none;font-size:inherit;text-align:center;height:1.375em;width:1.375em;line-height:.4em;background-color:var(--ol-background-color);border:none;border-radius:2px}.ol-control button::-moz-focus-inner{border:none;padding:0}.ol-zoom-extent button{line-height:1.4em}.ol-compass{display:block;font-weight:400;will-change:transform}.ol-touch .ol-control button{font-size:1.5em}.ol-touch .ol-zoom-extent{top:5.5em}.ol-control button:hover,.ol-control button:focus{text-decoration:none;outline:1px solid var(--ol-subtle-foreground-color);color:var(--ol-foreground-color)}.ol-zoom .ol-zoom-in{border-radius:2px 2px 0 0}.ol-zoom .ol-zoom-out{border-radius:0 0 2px 2px}.ol-attribution{text-align:right;bottom:.5em;right:.5em;max-width:calc(100% - 1.3em);display:flex;flex-flow:row-reverse;align-items:center}.ol-attribution a{color:var(--ol-subtle-foreground-color);text-decoration:none}.ol-attribution ul{margin:0;padding:1px .5em;color:var(--ol-foreground-color);text-shadow:0 0 2px var(--ol-background-color);font-size:12px}.ol-attribution li{display:inline;list-style:none}.ol-attribution li:not(:last-child):after{content:" "}.ol-attribution img{max-height:2em;max-width:inherit;vertical-align:middle}.ol-attribution button{flex-shrink:0}.ol-attribution.ol-collapsed ul{display:none}.ol-attribution:not(.ol-collapsed){background:var(--ol-partial-background-color)}.ol-attribution.ol-uncollapsible{bottom:0;right:0;border-radius:4px 0 0}.ol-attribution.ol-uncollapsible img{margin-top:-.2em;max-height:1.6em}.ol-attribution.ol-uncollapsible button{display:none}.ol-zoomslider{top:4.5em;left:.5em;height:200px}.ol-zoomslider button{position:relative;height:10px}.ol-touch .ol-zoomslider{top:5.5em}.ol-overviewmap{left:.5em;bottom:.5em}.ol-overviewmap.ol-uncollapsible{bottom:0;left:0;border-radius:0 4px 0 0}.ol-overviewmap .ol-overviewmap-map,.ol-overviewmap button{display:block}.ol-overviewmap .ol-overviewmap-map{border:1px solid var(--ol-subtle-foreground-color);height:150px;width:150px}.ol-overviewmap:not(.ol-collapsed) button{bottom:0;left:0;position:absolute}.ol-overviewmap.ol-collapsed .ol-overviewmap-map,.ol-overviewmap.ol-uncollapsible button{display:none}.ol-overviewmap:not(.ol-collapsed){background:var(--ol-subtle-background-color)}.ol-overviewmap-box{border:1.5px dotted var(--ol-subtle-foreground-color)}.ol-overviewmap .ol-overviewmap-box:hover{cursor:move}.ol-overviewmap .ol-viewport:hover{cursor:pointer}';function getCoordinate(h,t){const s=h.length;return t<0?h[t+s]:t>=s?h[t-s]:h[t]}function interpolateCoordinate(h,t){const s=h.length;let n=Math.floor(t);const o=t-n;n>=s?n-=s:n<0&&(n+=s);let a=n+1;a>=s&&(a-=s);const l=h[n],c=l[0],d=l[1],u=h[a],_=u[0]-c,f=u[1]-d;return[c+_*o,d+f*o]}const sharedUpdateInfo={index:-1,endIndex:NaN,closestTargetDistance:1/0};function getTraceTargetUpdate(h,t,s,n){const o=h[0],a=h[1];let l=1/0,c=-1,d=NaN;for(let f=0;f<t.targets.length;++f){const g=t.targets[f],m=g.coordinates;let p=1/0,x;for(let y=0;y<m.length-1;++y){const w=m[y],C=m[y+1],T=getPointSegmentRelationship(o,a,w,C);T.squaredDistance<p&&(p=T.squaredDistance,x=y+T.along)}p<l&&(l=p,g.ring&&t.targetIndex===f&&(g.endIndex>g.startIndex?x<g.startIndex&&(x+=m.length):g.endIndex<g.startIndex&&x>g.startIndex&&(x-=m.length)),d=x,c=f)}const u=t.targets[c];let _=u.ring;if(t.targetIndex===c&&_){const f=interpolateCoordinate(u.coordinates,d),g=s.getPixelFromCoordinate(f),m=s.getPixelFromCoordinate(t.startCoord);distance(g,m)>n&&(_=!1)}if(_){const f=u.coordinates,g=f.length,m=u.startIndex,p=d;if(m<p){const x=getCumulativeSquaredDistance(f,m,p);getCumulativeSquaredDistance(f,m,p-g)<x&&(d-=g)}else{const x=getCumulativeSquaredDistance(f,m,p);getCumulativeSquaredDistance(f,m,p+g)<x&&(d+=g)}}return sharedUpdateInfo.index=c,sharedUpdateInfo.endIndex=d,sharedUpdateInfo.closestTargetDistance=l,sharedUpdateInfo}function getTraceTargets(h,t){const s=[];for(let n=0;n<t.length;++n){const a=t[n].getGeometry();appendGeometryTraceTargets(h,a,s)}return s}function appendGeometryTraceTargets(h,t,s){if(t instanceof LineString){appendTraceTarget(h,t.getCoordinates(),!1,s);return}if(t instanceof MultiLineString){const n=t.getCoordinates();for(let o=0,a=n.length;o<a;++o)appendTraceTarget(h,n[o],!1,s);return}if(t instanceof Polygon){const n=t.getCoordinates();for(let o=0,a=n.length;o<a;++o)appendTraceTarget(h,n[o],!0,s);return}if(t instanceof MultiPolygon){const n=t.getCoordinates();for(let o=0,a=n.length;o<a;++o){const l=n[o];for(let c=0,d=l.length;c<d;++c)appendTraceTarget(h,l[c],!0,s)}return}if(t instanceof GeometryCollection){const n=t.getGeometries();for(let o=0;o<n.length;++o)appendGeometryTraceTargets(h,n[o],s);return}}function appendTraceTarget(h,t,s,n){const o=h[0],a=h[1];for(let l=0,c=t.length-1;l<c;++l){const d=t[l],u=t[l+1],_=getPointSegmentRelationship(o,a,d,u);if(_.squaredDistance===0){const f=l+_.along;n.push({coordinates:t,ring:s,startIndex:f,endIndex:f});return}}}function getSquaredDistance(h,t){return squaredDistance(h[0],h[1],t[0],t[1])}function getCumulativeSquaredDistance(h,t,s){let n,o;t<s?(n=t,o=s):(n=s,o=t);const a=Math.ceil(n),l=Math.floor(o);if(a>l){const d=interpolateCoordinate(h,n),u=interpolateCoordinate(h,o);return getSquaredDistance(d,u)}let c=0;if(n<a){const d=interpolateCoordinate(h,n),u=getCoordinate(h,a);c+=getSquaredDistance(d,u)}if(l<o){const d=getCoordinate(h,l),u=interpolateCoordinate(h,o);c+=getSquaredDistance(d,u)}for(let d=a;d<l-1;++d){const u=getCoordinate(h,d),_=getCoordinate(h,d+1);c+=getSquaredDistance(u,_)}return c}const sharedRel={along:0,squaredDistance:0};function getPointSegmentRelationship(h,t,s,n){const o=s[0],a=s[1],l=n[0],c=n[1],d=l-o,u=c-a;let _=0,f=o,g=a;return(d!==0||u!==0)&&(_=clamp(((h-o)*d+(t-a)*u)/(d*d+u*u),0,1),f+=d*_,g+=u*_),sharedRel.along=_,sharedRel.squaredDistance=toFixed(squaredDistance(h,t,f,g),10),sharedRel}const DrawEventType={DRAWSTART:"drawstart",DRAWEND:"drawend",DRAWABORT:"drawabort"};class DrawEvent extends BaseEvent{constructor(t,s){super(t),this.feature=s}}class Draw extends PointerInteraction{constructor(t){const s=t;s.stopDown||(s.stopDown=FALSE),super(s),this.on,this.once,this.un,this.options_=t,this.shouldHandle_=!1,this.downPx_=null,this.downTimeout_,this.lastDragTime_,this.pointerType_,this.freehand_=!1,this.source_=t.source?t.source:null,this.features_=t.features?t.features:null,this.snapTolerance_=t.snapTolerance?t.snapTolerance:12,this.type_=t.type,this.mode_=getMode(this.type_),this.stopClick_=!!t.stopClick,this.ignoreNextUpEvent_=!1,this.minPoints_=t.minPoints?t.minPoints:this.mode_==="Polygon"?3:2,this.maxPoints_=this.mode_==="Circle"?2:t.maxPoints?t.maxPoints:1/0,this.finishCondition_=t.finishCondition?t.finishCondition:TRUE,this.geometryLayout_=t.geometryLayout?t.geometryLayout:"XY";let n=t.geometryFunction;if(!n){const o=this.mode_;if(o==="Circle")n=(a,l,c)=>{const d=l||new Circle([NaN,NaN]),u=fromUserCoordinate(a[0]),_=squaredDistance$1(u,fromUserCoordinate(a[a.length-1]));return d.setCenterAndRadius(u,Math.sqrt(_),this.geometryLayout_),d};else{let a;o==="Point"?a=Point:o==="LineString"?a=LineString:o==="Polygon"&&(a=Polygon),n=(l,c,d)=>(c?o==="Polygon"?l[0].length?c.setCoordinates([l[0].concat([l[0][0]])],this.geometryLayout_):c.setCoordinates([],this.geometryLayout_):c.setCoordinates(l,this.geometryLayout_):c=new a(l,this.geometryLayout_),c)}}this.geometryFunction_=n,this.dragVertexDelay_=t.dragVertexDelay!==void 0?t.dragVertexDelay:500,this.finishCoordinate_=null,this.sketchFeature_=null,this.sketchPoint_=null,this.sketchCoords_=null,this.sketchLine_=null,this.sketchLineCoords_=null,this.squaredClickTolerance_=t.clickTolerance?t.clickTolerance*t.clickTolerance:36,this.overlay_=new VectorLayer({source:new VectorSource({useSpatialIndex:!1,wrapX:t.wrapX?t.wrapX:!1}),style:t.style?t.style:getDefaultStyleFunction$1(),updateWhileInteracting:!0}),this.geometryName_=t.geometryName,this.condition_=t.condition?t.condition:noModifierKeys,this.freehandCondition_,t.freehand?this.freehandCondition_=always:this.freehandCondition_=t.freehandCondition?t.freehandCondition:shiftKeyOnly,this.traceCondition_,this.setTrace(t.trace||!1),this.traceState_={active:!1},this.traceSource_=t.traceSource||t.source||null,this.addChangeListener(InteractionProperty.ACTIVE,this.updateState_)}setTrace(t){let s;t?t===!0?s=always:s=t:s=never,this.traceCondition_=s}setMap(t){super.setMap(t),this.updateState_()}setFreehand(t){this.freehand_=t,this.freehand_?this.freehandCondition_=always:this.freehandCondition_=this.options_&&this.options_.freehandCondition?this.options_.freehandCondition:shiftKeyOnly}getOverlay(){return this.overlay_}getFreehand(){return this.freehand_}handleEvent(t){t.originalEvent.type===EventType$1.CONTEXTMENU&&t.originalEvent.preventDefault(),this.freehand_=this.mode_!=="Point"&&this.freehandCondition_(t);let s=t.type===MapBrowserEventType.POINTERMOVE,n=!0;return!this.freehand_&&this.lastDragTime_&&t.type===MapBrowserEventType.POINTERDRAG&&(Date.now()-this.lastDragTime_>=this.dragVertexDelay_?(this.downPx_=t.pixel,this.shouldHandle_=!this.freehand_,s=!0):this.lastDragTime_=void 0,this.shouldHandle_&&this.downTimeout_!==void 0&&(clearTimeout(this.downTimeout_),this.downTimeout_=void 0)),this.freehand_&&t.type===MapBrowserEventType.POINTERDRAG&&this.sketchFeature_!==null?(this.addToDrawing_(t.coordinate),n=!1):this.freehand_&&t.type===MapBrowserEventType.POINTERDOWN?n=!1:s&&this.getPointerCount()<2?(n=t.type===MapBrowserEventType.POINTERMOVE,n&&this.freehand_?(this.handlePointerMove_(t),this.shouldHandle_&&t.originalEvent.preventDefault()):(t.originalEvent.pointerType==="mouse"||t.type===MapBrowserEventType.POINTERDRAG&&this.downTimeout_===void 0)&&this.handlePointerMove_(t)):t.type===MapBrowserEventType.DBLCLICK&&(n=!1),super.handleEvent(t)&&n}handleDownEvent(t){return this.shouldHandle_=!this.freehand_,this.freehand_?(this.downPx_=t.pixel,this.finishCoordinate_||this.startDrawing_(t.coordinate),!0):this.condition_(t)?(this.lastDragTime_=Date.now(),this.downTimeout_=setTimeout(()=>{this.handlePointerMove_(new MapBrowserEvent(MapBrowserEventType.POINTERMOVE,t.map,t.originalEvent,!1,t.frameState))},this.dragVertexDelay_),this.downPx_=t.pixel,!0):(this.lastDragTime_=void 0,!1)}deactivateTrace_(){this.traceState_={active:!1}}toggleTraceState_(t){if(!this.traceSource_||!this.traceCondition_(t))return;if(this.traceState_.active){this.deactivateTrace_();return}const s=this.getMap(),n=s.getCoordinateFromPixel([t.pixel[0]-this.snapTolerance_,t.pixel[1]+this.snapTolerance_]),o=s.getCoordinateFromPixel([t.pixel[0]+this.snapTolerance_,t.pixel[1]-this.snapTolerance_]),a=boundingExtent([n,o]),l=this.traceSource_.getFeaturesInExtent(a);if(l.length===0)return;const c=getTraceTargets(t.coordinate,l);c.length&&(this.traceState_={active:!0,startCoord:t.coordinate.slice(),targets:c,targetIndex:-1})}addOrRemoveTracedCoordinates_(t,s){const n=t.startIndex<=t.endIndex,o=t.startIndex<=s;n===o?n&&s>t.endIndex||!n&&s<t.endIndex?this.addTracedCoordinates_(t,t.endIndex,s):(n&&s<t.endIndex||!n&&s>t.endIndex)&&this.removeTracedCoordinates_(s,t.endIndex):(this.removeTracedCoordinates_(t.startIndex,t.endIndex),this.addTracedCoordinates_(t,t.startIndex,s))}removeTracedCoordinates_(t,s){if(t===s)return;let n=0;if(t<s){const o=Math.ceil(t);let a=Math.floor(s);a===s&&(a-=1),n=a-o+1}else{const o=Math.floor(t);let a=Math.ceil(s);a===s&&(a+=1),n=o-a+1}n>0&&this.removeLastPoints_(n)}addTracedCoordinates_(t,s,n){if(s===n)return;const o=[];if(s<n){const a=Math.ceil(s);let l=Math.floor(n);l===n&&(l-=1);for(let c=a;c<=l;++c)o.push(getCoordinate(t.coordinates,c))}else{const a=Math.floor(s);let l=Math.ceil(n);l===n&&(l+=1);for(let c=a;c>=l;--c)o.push(getCoordinate(t.coordinates,c))}o.length&&this.appendCoordinates(o)}updateTrace_(t){const s=this.traceState_;if(!s.active)return;if(s.targetIndex===-1){const c=t.map.getPixelFromCoordinate(s.startCoord);if(distance(c,t.pixel)<this.snapTolerance_)return}const n=getTraceTargetUpdate(t.coordinate,s,this.getMap(),this.snapTolerance_);if(s.targetIndex!==n.index){if(s.targetIndex!==-1){const d=s.targets[s.targetIndex];this.removeTracedCoordinates_(d.startIndex,d.endIndex)}const c=s.targets[n.index];this.addTracedCoordinates_(c,c.startIndex,n.endIndex)}else{const c=s.targets[s.targetIndex];this.addOrRemoveTracedCoordinates_(c,n.endIndex)}s.targetIndex=n.index;const o=s.targets[s.targetIndex];o.endIndex=n.endIndex;const a=interpolateCoordinate(o.coordinates,o.endIndex),l=this.getMap().getPixelFromCoordinate(a);t.coordinate=a,t.pixel=[Math.round(l[0]),Math.round(l[1])]}handleDragEvent(t){this.ignoreNextUpEvent_=!0,super.handleDragEvent(t)}handleUpEvent(t){let s=!0;if(this.getPointerCount()===0){this.downTimeout_&&(clearTimeout(this.downTimeout_),this.downTimeout_=void 0),this.handlePointerMove_(t);const n=this.traceState_.active;if(this.ignoreNextUpEvent_||this.toggleTraceState_(t),this.shouldHandle_){const o=!this.finishCoordinate_;o&&this.startDrawing_(t.coordinate),!o&&this.freehand_?this.finishDrawing():!this.freehand_&&(!o||this.mode_==="Point")&&(this.atFinish_(t.pixel,n)?this.finishCondition_(t)&&this.finishDrawing():this.addToDrawing_(t.coordinate)),s=!1}else this.freehand_&&this.abortDrawing()}return this.ignoreNextUpEvent_=!1,!s&&this.stopClick_&&t.preventDefault(),s}handlePointerMove_(t){if(this.pointerType_=t.originalEvent.pointerType,this.downPx_&&(!this.freehand_&&this.shouldHandle_||this.freehand_&&!this.shouldHandle_)){const s=this.downPx_,n=t.pixel,o=s[0]-n[0],a=s[1]-n[1],l=o*o+a*a;if(this.shouldHandle_=this.freehand_?l>this.squaredClickTolerance_:l<=this.squaredClickTolerance_,!this.shouldHandle_)return}if(!this.finishCoordinate_){this.createOrUpdateSketchPoint_(t.coordinate.slice());return}this.updateTrace_(t),this.modifyDrawing_(t.coordinate)}atFinish_(t,s){let n=!1;if(this.sketchFeature_){let o=!1,a=[this.finishCoordinate_];const l=this.mode_;if(l==="Point")n=!0;else if(l==="Circle")n=this.sketchCoords_.length===2;else if(l==="LineString")o=!s&&this.sketchCoords_.length>this.minPoints_;else if(l==="Polygon"){const c=this.sketchCoords_;o=c[0].length>this.minPoints_,a=[c[0][0],c[0][c[0].length-2]],s?a=[c[0][0]]:a=[c[0][0],c[0][c[0].length-2]]}if(o){const c=this.getMap();for(let d=0,u=a.length;d<u;d++){const _=a[d],f=c.getPixelFromCoordinate(_),g=t[0]-f[0],m=t[1]-f[1],p=this.freehand_?1:this.snapTolerance_;if(n=Math.sqrt(g*g+m*m)<=p,n){this.finishCoordinate_=_;break}}}}return n}createOrUpdateSketchPoint_(t){this.sketchPoint_?this.sketchPoint_.getGeometry().setCoordinates(t):(this.sketchPoint_=new Feature(new Point(t)),this.updateSketchFeatures_())}createOrUpdateCustomSketchLine_(t){this.sketchLine_||(this.sketchLine_=new Feature);const s=t.getLinearRing(0);let n=this.sketchLine_.getGeometry();n?(n.setFlatCoordinates(s.getLayout(),s.getFlatCoordinates()),n.changed()):(n=new LineString(s.getFlatCoordinates(),s.getLayout()),this.sketchLine_.setGeometry(n))}startDrawing_(t){const s=this.getMap().getView().getProjection(),n=getStrideForLayout(this.geometryLayout_);for(;t.length<n;)t.push(0);this.finishCoordinate_=t,this.mode_==="Point"?this.sketchCoords_=t.slice():this.mode_==="Polygon"?(this.sketchCoords_=[[t.slice(),t.slice()]],this.sketchLineCoords_=this.sketchCoords_[0]):this.sketchCoords_=[t.slice(),t.slice()],this.sketchLineCoords_&&(this.sketchLine_=new Feature(new LineString(this.sketchLineCoords_)));const o=this.geometryFunction_(this.sketchCoords_,void 0,s);this.sketchFeature_=new Feature,this.geometryName_&&this.sketchFeature_.setGeometryName(this.geometryName_),this.sketchFeature_.setGeometry(o),this.updateSketchFeatures_(),this.dispatchEvent(new DrawEvent(DrawEventType.DRAWSTART,this.sketchFeature_))}modifyDrawing_(t){const s=this.getMap(),n=this.sketchFeature_.getGeometry(),o=s.getView().getProjection(),a=getStrideForLayout(this.geometryLayout_);let l,c;for(;t.length<a;)t.push(0);this.mode_==="Point"?c=this.sketchCoords_:this.mode_==="Polygon"?(l=this.sketchCoords_[0],c=l[l.length-1],this.atFinish_(s.getPixelFromCoordinate(t))&&(t=this.finishCoordinate_.slice())):(l=this.sketchCoords_,c=l[l.length-1]),c[0]=t[0],c[1]=t[1],this.geometryFunction_(this.sketchCoords_,n,o),this.sketchPoint_&&this.sketchPoint_.getGeometry().setCoordinates(t),n.getType()==="Polygon"&&this.mode_!=="Polygon"?this.createOrUpdateCustomSketchLine_(n):this.sketchLineCoords_&&this.sketchLine_.getGeometry().setCoordinates(this.sketchLineCoords_),this.updateSketchFeatures_()}addToDrawing_(t){const s=this.sketchFeature_.getGeometry(),n=this.getMap().getView().getProjection();let o,a;const l=this.mode_;return l==="LineString"||l==="Circle"?(this.finishCoordinate_=t.slice(),a=this.sketchCoords_,a.length>=this.maxPoints_&&(this.freehand_?a.pop():o=!0),a.push(t.slice()),this.geometryFunction_(a,s,n)):l==="Polygon"&&(a=this.sketchCoords_[0],a.length>=this.maxPoints_&&(this.freehand_?a.pop():o=!0),a.push(t.slice()),o&&(this.finishCoordinate_=a[0]),this.geometryFunction_(this.sketchCoords_,s,n)),this.createOrUpdateSketchPoint_(t.slice()),this.updateSketchFeatures_(),o?this.finishDrawing():this.sketchFeature_}removeLastPoints_(t){if(!this.sketchFeature_)return;const s=this.sketchFeature_.getGeometry(),n=this.getMap().getView().getProjection(),o=this.mode_;for(let a=0;a<t;++a){let l;if(o==="LineString"||o==="Circle"){if(l=this.sketchCoords_,l.splice(-2,1),l.length>=2){this.finishCoordinate_=l[l.length-2].slice();const c=this.finishCoordinate_.slice();l[l.length-1]=c,this.createOrUpdateSketchPoint_(c)}this.geometryFunction_(l,s,n),s.getType()==="Polygon"&&this.sketchLine_&&this.createOrUpdateCustomSketchLine_(s)}else if(o==="Polygon"){l=this.sketchCoords_[0],l.splice(-2,1);const c=this.sketchLine_.getGeometry();if(l.length>=2){const d=l[l.length-2].slice();l[l.length-1]=d,this.createOrUpdateSketchPoint_(d)}c.setCoordinates(l),this.geometryFunction_(this.sketchCoords_,s,n)}if(l.length===1){this.abortDrawing();break}}this.updateSketchFeatures_()}removeLastPoint(){this.removeLastPoints_(1)}finishDrawing(){const t=this.abortDrawing_();if(!t)return null;let s=this.sketchCoords_;const n=t.getGeometry(),o=this.getMap().getView().getProjection();return this.mode_==="LineString"?(s.pop(),this.geometryFunction_(s,n,o)):this.mode_==="Polygon"&&(s[0].pop(),this.geometryFunction_(s,n,o),s=n.getCoordinates()),this.type_==="MultiPoint"?t.setGeometry(new MultiPoint([s])):this.type_==="MultiLineString"?t.setGeometry(new MultiLineString([s])):this.type_==="MultiPolygon"&&t.setGeometry(new MultiPolygon([s])),this.dispatchEvent(new DrawEvent(DrawEventType.DRAWEND,t)),this.features_&&this.features_.push(t),this.source_&&this.source_.addFeature(t),t}abortDrawing_(){this.finishCoordinate_=null;const t=this.sketchFeature_;return this.sketchFeature_=null,this.sketchPoint_=null,this.sketchLine_=null,this.overlay_.getSource().clear(!0),this.deactivateTrace_(),t}abortDrawing(){const t=this.abortDrawing_();t&&this.dispatchEvent(new DrawEvent(DrawEventType.DRAWABORT,t))}appendCoordinates(t){const s=this.mode_,n=!this.sketchFeature_;n&&this.startDrawing_(t[0]);let o;if(s==="LineString"||s==="Circle")o=this.sketchCoords_;else if(s==="Polygon")o=this.sketchCoords_&&this.sketchCoords_.length?this.sketchCoords_[0]:[];else return;n&&o.shift(),o.pop();for(let l=0;l<t.length;l++)this.addToDrawing_(t[l]);const a=t[t.length-1];this.sketchFeature_=this.addToDrawing_(a),this.modifyDrawing_(a)}extend(t){const n=t.getGeometry();this.sketchFeature_=t,this.sketchCoords_=n.getCoordinates();const o=this.sketchCoords_[this.sketchCoords_.length-1];this.finishCoordinate_=o.slice(),this.sketchCoords_.push(o.slice()),this.sketchPoint_=new Feature(new Point(o)),this.updateSketchFeatures_(),this.dispatchEvent(new DrawEvent(DrawEventType.DRAWSTART,this.sketchFeature_))}updateSketchFeatures_(){const t=[];this.sketchFeature_&&t.push(this.sketchFeature_),this.sketchLine_&&t.push(this.sketchLine_),this.sketchPoint_&&t.push(this.sketchPoint_);const s=this.overlay_.getSource();s.clear(!0),s.addFeatures(t)}updateState_(){const t=this.getMap(),s=this.getActive();(!t||!s)&&this.abortDrawing(),this.overlay_.setMap(s?t:null)}}function getDefaultStyleFunction$1(){const h=createEditingStyle();return function(t,s){return h[t.getGeometry().getType()]}}function createBox(){return function(h,t,s){const n=boundingExtent([h[0],h[h.length-1]].map(function(a){return fromUserCoordinate(a)})),o=[[getBottomLeft(n),getBottomRight(n),getTopRight(n),getTopLeft(n),getBottomLeft(n)]];return t?t.setCoordinates(o):t=new Polygon(o),t}}function getMode(h){switch(h){case"Point":case"MultiPoint":return"Point";case"LineString":case"MultiLineString":return"LineString";case"Polygon":case"MultiPolygon":return"Polygon";case"Circle":return"Circle";default:throw new Error("Invalid type: "+h)}}const CIRCLE_CENTER_INDEX=0,CIRCLE_CIRCUMFERENCE_INDEX=1,tempExtent=[0,0,0,0],tempSegment=[],ModifyEventType={MODIFYSTART:"modifystart",MODIFYEND:"modifyend"};function getCoordinatesArray(h,t,s){let n;switch(t){case"LineString":n=h;break;case"MultiLineString":case"Polygon":n=h[s[0]];break;case"MultiPolygon":n=h[s[1]][s[0]];break}return n}class ModifyEvent extends BaseEvent{constructor(t,s,n){super(t),this.features=s,this.mapBrowserEvent=n}}class Modify extends PointerInteraction{constructor(t){super(t),this.on,this.once,this.un,this.boundHandleFeatureChange_=this.handleFeatureChange_.bind(this),this.condition_=t.condition?t.condition:primaryAction,this.defaultDeleteCondition_=function(n){return altKeyOnly(n)&&singleClick(n)},this.deleteCondition_=t.deleteCondition?t.deleteCondition:this.defaultDeleteCondition_,this.insertVertexCondition_=t.insertVertexCondition?t.insertVertexCondition:always,this.vertexFeature_=null,this.vertexSegments_=null,this.lastCoordinate_=[0,0],this.ignoreNextSingleClick_=!1,this.featuresBeingModified_=null,this.rBush_=new RBush,this.pixelTolerance_=t.pixelTolerance!==void 0?t.pixelTolerance:10,this.snappedToVertex_=!1,this.changingFeature_=!1,this.dragSegments_=[],this.overlay_=new VectorLayer({source:new VectorSource({useSpatialIndex:!1,wrapX:!!t.wrapX}),style:t.style?t.style:getDefaultStyleFunction(),updateWhileAnimating:!0,updateWhileInteracting:!0}),this.SEGMENT_WRITERS_={Point:this.writePointGeometry_.bind(this),LineString:this.writeLineStringGeometry_.bind(this),LinearRing:this.writeLineStringGeometry_.bind(this),Polygon:this.writePolygonGeometry_.bind(this),MultiPoint:this.writeMultiPointGeometry_.bind(this),MultiLineString:this.writeMultiLineStringGeometry_.bind(this),MultiPolygon:this.writeMultiPolygonGeometry_.bind(this),Circle:this.writeCircleGeometry_.bind(this),GeometryCollection:this.writeGeometryCollectionGeometry_.bind(this)},this.source_=null,this.traceSource_=t.traceSource||t.source||null,this.traceCondition_,this.setTrace(t.trace||!1),this.traceState_={active:!1},this.traceSegments_=null,this.hitDetection_=null;let s;if(t.features?s=t.features:t.source&&(this.source_=t.source,s=new Collection(this.source_.getFeatures()),this.source_.addEventListener(VectorEventType.ADDFEATURE,this.handleSourceAdd_.bind(this)),this.source_.addEventListener(VectorEventType.REMOVEFEATURE,this.handleSourceRemove_.bind(this))),!s)throw new Error("The modify interaction requires features, a source or a layer");t.hitDetection&&(this.hitDetection_=t.hitDetection),this.features_=s,this.features_.forEach(this.addFeature_.bind(this)),this.features_.addEventListener(CollectionEventType.ADD,this.handleFeatureAdd_.bind(this)),this.features_.addEventListener(CollectionEventType.REMOVE,this.handleFeatureRemove_.bind(this)),this.lastPointerEvent_=null,this.delta_=[0,0],this.snapToPointer_=t.snapToPointer===void 0?!this.hitDetection_:t.snapToPointer}setTrace(t){let s;t?t===!0?s=always:s=t:s=never,this.traceCondition_=s}addFeature_(t){const s=t.getGeometry();if(s){const o=this.SEGMENT_WRITERS_[s.getType()];o&&o(t,s)}const n=this.getMap();n&&n.isRendered()&&this.getActive()&&this.handlePointerAtPixel_(this.lastCoordinate_),t.addEventListener(EventType$1.CHANGE,this.boundHandleFeatureChange_)}willModifyFeatures_(t,s){if(!this.featuresBeingModified_){this.featuresBeingModified_=new Collection;const n=this.featuresBeingModified_.getArray();for(let o=0,a=s.length;o<a;++o){const l=s[o].feature;l&&!n.includes(l)&&this.featuresBeingModified_.push(l)}this.featuresBeingModified_.getLength()===0?this.featuresBeingModified_=null:this.dispatchEvent(new ModifyEvent(ModifyEventType.MODIFYSTART,this.featuresBeingModified_,t))}}removeFeature_(t){this.removeFeatureSegmentData_(t),this.vertexFeature_&&this.features_.getLength()===0&&(this.overlay_.getSource().removeFeature(this.vertexFeature_),this.vertexFeature_=null),t.removeEventListener(EventType$1.CHANGE,this.boundHandleFeatureChange_)}removeFeatureSegmentData_(t){const s=this.rBush_,n=[];s.forEach(function(o){t===o.feature&&n.push(o)});for(let o=n.length-1;o>=0;--o){const a=n[o];for(let l=this.dragSegments_.length-1;l>=0;--l)this.dragSegments_[l][0]===a&&this.dragSegments_.splice(l,1);s.remove(a)}}setActive(t){this.vertexFeature_&&!t&&(this.overlay_.getSource().removeFeature(this.vertexFeature_),this.vertexFeature_=null),super.setActive(t)}setMap(t){this.overlay_.setMap(t),super.setMap(t)}getOverlay(){return this.overlay_}handleSourceAdd_(t){t.feature&&this.features_.push(t.feature)}handleSourceRemove_(t){t.feature&&this.features_.remove(t.feature)}handleFeatureAdd_(t){this.addFeature_(t.element)}handleFeatureChange_(t){if(!this.changingFeature_){const s=t.target;this.removeFeature_(s),this.addFeature_(s)}}handleFeatureRemove_(t){this.removeFeature_(t.element)}writePointGeometry_(t,s){const n=s.getCoordinates(),o={feature:t,geometry:s,segment:[n,n]};this.rBush_.insert(s.getExtent(),o)}writeMultiPointGeometry_(t,s){const n=s.getCoordinates();for(let o=0,a=n.length;o<a;++o){const l=n[o],c={feature:t,geometry:s,depth:[o],index:o,segment:[l,l]};this.rBush_.insert(s.getExtent(),c)}}writeLineStringGeometry_(t,s){const n=s.getCoordinates();for(let o=0,a=n.length-1;o<a;++o){const l=n.slice(o,o+2),c={feature:t,geometry:s,index:o,segment:l};this.rBush_.insert(boundingExtent(l),c)}}writeMultiLineStringGeometry_(t,s){const n=s.getCoordinates();for(let o=0,a=n.length;o<a;++o){const l=n[o];for(let c=0,d=l.length-1;c<d;++c){const u=l.slice(c,c+2),_={feature:t,geometry:s,depth:[o],index:c,segment:u};this.rBush_.insert(boundingExtent(u),_)}}}writePolygonGeometry_(t,s){const n=s.getCoordinates();for(let o=0,a=n.length;o<a;++o){const l=n[o];for(let c=0,d=l.length-1;c<d;++c){const u=l.slice(c,c+2),_={feature:t,geometry:s,depth:[o],index:c,segment:u};this.rBush_.insert(boundingExtent(u),_)}}}writeMultiPolygonGeometry_(t,s){const n=s.getCoordinates();for(let o=0,a=n.length;o<a;++o){const l=n[o];for(let c=0,d=l.length;c<d;++c){const u=l[c];for(let _=0,f=u.length-1;_<f;++_){const g=u.slice(_,_+2),m={feature:t,geometry:s,depth:[c,o],index:_,segment:g};this.rBush_.insert(boundingExtent(g),m)}}}}writeCircleGeometry_(t,s){const n=s.getCenter(),o={feature:t,geometry:s,index:CIRCLE_CENTER_INDEX,segment:[n,n]},a={feature:t,geometry:s,index:CIRCLE_CIRCUMFERENCE_INDEX,segment:[n,n]},l=[o,a];o.featureSegments=l,a.featureSegments=l,this.rBush_.insert(createOrUpdateFromCoordinate(n),o);let c=s;this.rBush_.insert(c.getExtent(),a)}writeGeometryCollectionGeometry_(t,s){const n=s.getGeometriesArray();for(let o=0;o<n.length;++o){const a=n[o],l=this.SEGMENT_WRITERS_[a.getType()];l(t,a)}}createOrUpdateVertexFeature_(t,s,n,o){let a=this.vertexFeature_;return a?a.getGeometry().setCoordinates(t):(a=new Feature(new Point(t)),this.vertexFeature_=a,this.overlay_.getSource().addFeature(a)),a.set("features",s),a.set("geometries",n),a.set("existing",o),a}handleEvent(t){if(!t.originalEvent)return!0;this.lastPointerEvent_=t;let s;return!t.map.getView().getInteracting()&&t.type==MapBrowserEventType.POINTERMOVE&&!this.handlingDownUpSequence&&this.handlePointerMove_(t),this.vertexFeature_&&this.deleteCondition_(t)&&(t.type!=MapBrowserEventType.SINGLECLICK||!this.ignoreNextSingleClick_?s=this.removePoint():s=!0),t.type==MapBrowserEventType.SINGLECLICK&&(this.ignoreNextSingleClick_=!1),super.handleEvent(t)&&!s}findInsertVerticesAndUpdateDragSegments_(t){if(this.handlePointerAtPixel_(t),this.dragSegments_.length=0,this.featuresBeingModified_=null,!this.vertexFeature_)return;this.getMap().getView().getProjection();const n=[],o=this.vertexFeature_.getGeometry().getCoordinates(),a=boundingExtent([o]),l=this.rBush_.getInExtent(a),c={};l.sort(compareIndexes);for(let d=0,u=l.length;d<u;++d){const _=l[d],f=_.segment;let g=getUid(_.geometry);const m=_.depth;if(m&&(g+="-"+m.join("-")),c[g]||(c[g]=new Array(2)),_.geometry.getType()==="Circle"&&_.index===CIRCLE_CIRCUMFERENCE_INDEX){const p=closestOnSegmentData(t,_);equals$2(p,o)&&!c[g][0]&&(this.dragSegments_.push([_,0]),c[g][0]=_);continue}if(equals$2(f[0],o)&&!c[g][0]){this.dragSegments_.push([_,0]),c[g][0]=_;continue}if(equals$2(f[1],o)&&!c[g][1]){if(c[g][0]&&c[g][0].index===0){let p=_.geometry.getCoordinates();switch(_.geometry.getType()){case"LineString":case"MultiLineString":continue;case"MultiPolygon":p=p[m[1]];case"Polygon":if(_.index!==p[m[0]].length-2)continue;break}}this.dragSegments_.push([_,1]),c[g][1]=_;continue}getUid(f)in this.vertexSegments_&&!c[g][0]&&!c[g][1]&&n.push(_)}return n}deactivateTrace_(){this.traceState_={active:!1}}updateTrace_(t){const s=this.traceState_;if(!s.active)return;if(s.targetIndex===-1){const a=t.map.getPixelFromCoordinate(s.startCoord);if(distance(a,t.pixel)<this.pixelTolerance_)return}const n=getTraceTargetUpdate(t.coordinate,s,t.map,this.pixelTolerance_);if(s.targetIndex===-1&&Math.sqrt(n.closestTargetDistance)/t.map.getView().getResolution()>this.pixelTolerance_)return;if(s.targetIndex!==n.index){if(s.targetIndex!==-1){const l=s.targets[s.targetIndex];this.removeTracedCoordinates_(l.startIndex,l.endIndex)}else for(const l of this.traceSegments_){const c=l[0],d=c.geometry,u=l[1],_=d.getCoordinates();getCoordinatesArray(_,d.getType(),c.depth).splice(c.index+u,1),d.setCoordinates(_),u===0&&(c.index-=1)}const a=s.targets[n.index];this.addTracedCoordinates_(a,a.startIndex,n.endIndex)}else{const a=s.targets[s.targetIndex];this.addOrRemoveTracedCoordinates_(a,n.endIndex)}s.targetIndex=n.index;const o=s.targets[s.targetIndex];o.endIndex=n.endIndex}getTraceCandidates_(t){const s=this.getMap(),n=this.pixelTolerance_,o=s.getCoordinateFromPixel([t.pixel[0]-n,t.pixel[1]+n]),a=s.getCoordinateFromPixel([t.pixel[0]+n,t.pixel[1]-n]),l=boundingExtent([o,a]);return this.traceSource_.getFeaturesInExtent(l)}toggleTraceState_(t){if(!this.traceSource_||!this.traceCondition_(t))return;if(this.traceState_.active){this.deactivateTrace_(),this.traceSegments_=null;return}const s=this.getTraceCandidates_(t);if(s.length===0)return;const n=getTraceTargets(t.coordinate,s);n.length&&(this.traceState_={active:!0,startCoord:t.coordinate.slice(),targets:n,targetIndex:-1})}addOrRemoveTracedCoordinates_(t,s){const n=t.startIndex<=t.endIndex,o=t.startIndex<=s;n===o?n&&s>t.endIndex||!n&&s<t.endIndex?this.addTracedCoordinates_(t,t.endIndex,s):(n&&s<t.endIndex||!n&&s>t.endIndex)&&this.removeTracedCoordinates_(s,t.endIndex):(this.removeTracedCoordinates_(t.startIndex,t.endIndex),this.addTracedCoordinates_(t,t.startIndex,s))}removeTracedCoordinates_(t,s){if(t===s)return;let n=0;if(t<s){const o=Math.ceil(t);let a=Math.floor(s);a===s&&(a-=1),n=a-o+1}else{const o=Math.floor(t);let a=Math.ceil(s);a===s&&(a+=1),n=o-a+1}if(n>0)for(const o of this.traceSegments_){const a=o[0],l=a.geometry,c=o[1];let d=o[0].index+1;c===1&&(d-=n);const u=l.getCoordinates();getCoordinatesArray(u,l.getType(),a.depth).splice(d,n),l.setCoordinates(u),c===1&&(a.index-=n)}}addTracedCoordinates_(t,s,n){if(s===n)return;const o=[];if(s<n){const a=Math.ceil(s);let l=Math.floor(n);l===n&&(l-=1);for(let c=a;c<=l;++c)o.push(getCoordinate(t.coordinates,c))}else{const a=Math.floor(s);let l=Math.ceil(n);l===n&&(l+=1);for(let c=a;c>=l;--c)o.push(getCoordinate(t.coordinates,c))}if(o.length)for(const a of this.traceSegments_){const l=a[0],c=l.geometry,d=a[1],u=l.index+1;d===0&&o.reverse();const _=c.getCoordinates();getCoordinatesArray(_,c.getType(),l.depth).splice(u,0,...o),c.setCoordinates(_),d===1&&(l.index+=o.length)}}updateGeometry_(t,s){const n=s[0],o=n.depth;let a;const l=n.segment,c=n.geometry,d=s[1];for(;t.length<c.getStride();)t.push(l[d][t.length]);switch(c.getType()){case"Point":a=t,l[0]=t,l[1]=t;break;case"MultiPoint":a=c.getCoordinates(),a[n.index]=t,l[0]=t,l[1]=t;break;case"LineString":a=c.getCoordinates(),a[n.index+d]=t,l[d]=t;break;case"MultiLineString":a=c.getCoordinates(),a[o[0]][n.index+d]=t,l[d]=t;break;case"Polygon":a=c.getCoordinates(),a[o[0]][n.index+d]=t,l[d]=t;break;case"MultiPolygon":a=c.getCoordinates(),a[o[1]][o[0]][n.index+d]=t,l[d]=t;break;case"Circle":const u=c;if(l[0]=t,l[1]=t,n.index===CIRCLE_CENTER_INDEX)this.changingFeature_=!0,u.setCenter(t),this.changingFeature_=!1;else{this.changingFeature_=!0,this.getMap().getView().getProjection();let _=distance(fromUserCoordinate(u.getCenter()),fromUserCoordinate(t));u.setRadius(_),this.changingFeature_=!1}break}a&&this.setGeometryCoordinates_(c,a)}handleDragEvent(t){this.ignoreNextSingleClick_=!1,this.willModifyFeatures_(t,this.dragSegments_.map(([l])=>l));const s=[t.coordinate[0]+this.delta_[0],t.coordinate[1]+this.delta_[1]],n=[],o=[],a=this.traceState_.active&&!this.traceSegments_?this.traceState_.startCoord:null;if(a){this.traceSegments_=[];for(const l of this.dragSegments_){const c=l[0];distance(closestOnSegment(a,c.segment),a)/t.map.getView().getResolution()<1&&this.traceSegments_.push(l)}}for(let l=0,c=this.dragSegments_.length;l<c;++l){const d=this.dragSegments_[l],u=d[0],_=u.feature;n.includes(_)||n.push(_);const f=u.geometry;o.includes(f)||o.push(f),this.updateGeometry_(s,d)}this.updateTrace_(t),this.createOrUpdateVertexFeature_(s,n,o,!0)}handleDownEvent(t){if(!this.condition_(t))return!1;const s=t.coordinate,n=this.findInsertVerticesAndUpdateDragSegments_(s);if(n!=null&&n.length&&this.insertVertexCondition_(t)&&(this.willModifyFeatures_(t,n),this.vertexFeature_)){const o=this.vertexFeature_.getGeometry().getCoordinates();for(let a=n.length-1;a>=0;--a)this.insertVertex_(n[a],o);this.ignoreNextSingleClick_=!0}return!!this.vertexFeature_}handleUpEvent(t){for(let s=this.dragSegments_.length-1;s>=0;--s){const n=this.dragSegments_[s][0],o=n.geometry;if(o.getType()==="Circle"){const a=o,l=a.getCenter(),c=n.featureSegments[0],d=n.featureSegments[1];c.segment[0]=l,c.segment[1]=l,d.segment[0]=l,d.segment[1]=l,this.rBush_.update(createOrUpdateFromCoordinate(l),c);let u=a;this.rBush_.update(u.getExtent(),d)}else this.rBush_.update(boundingExtent(n.segment),n)}return this.featuresBeingModified_&&(this.toggleTraceState_(t),this.dispatchEvent(new ModifyEvent(ModifyEventType.MODIFYEND,this.featuresBeingModified_,t)),this.featuresBeingModified_=null),!1}handlePointerMove_(t){this.lastCoordinate_=t.coordinate,this.handlePointerAtPixel_(this.lastCoordinate_)}handlePointerAtPixel_(t){const s=this.getMap(),n=s.getPixelFromCoordinate(t);s.getView().getProjection();const o=function(c,d){return projectedDistanceToSegmentDataSquared(t,c)-projectedDistanceToSegmentDataSquared(t,d)};let a,l;if(this.hitDetection_){const c=typeof this.hitDetection_=="object"?d=>d===this.hitDetection_:void 0;s.forEachFeatureAtPixel(n,(d,u,_)=>{_&&_.getType()==="Point"&&(_=new Point(toUserCoordinate(_.getCoordinates())));const f=_||d.getGeometry();if(f&&f.getType()==="Point"&&d instanceof Feature&&this.features_.getArray().includes(d)){l=f;const g=d.getGeometry().getFlatCoordinates().slice(0,2);a=[{feature:d,geometry:l,segment:[g,g]}]}return!0},{layerFilter:c})}if(!a){const c=fromUserExtent(createOrUpdateFromCoordinate(t,tempExtent)),d=s.getView().getResolution()*this.pixelTolerance_,u=toUserExtent(buffer(c,d,tempExtent));a=this.rBush_.getInExtent(u)}if(a&&a.length>0){const c=a.sort(o)[0],d=c.segment;let u=closestOnSegmentData(t,c);const _=s.getPixelFromCoordinate(u);let f=distance(n,_);if(l||f<=this.pixelTolerance_){const g={};if(g[getUid(d)]=!0,this.snapToPointer_||(this.delta_[0]=u[0]-t[0],this.delta_[1]=u[1]-t[1]),c.geometry.getType()==="Circle"&&c.index===CIRCLE_CIRCUMFERENCE_INDEX)this.snappedToVertex_=!0,this.createOrUpdateVertexFeature_(u,[c.feature],[c.geometry],this.snappedToVertex_);else{const m=s.getPixelFromCoordinate(d[0]),p=s.getPixelFromCoordinate(d[1]),x=squaredDistance$1(_,m),y=squaredDistance$1(_,p);if(f=Math.sqrt(Math.min(x,y)),this.snappedToVertex_=f<=this.pixelTolerance_,!this.snappedToVertex_&&!this.insertVertexCondition_(this.lastPointerEvent_)){this.vertexFeature_&&(this.overlay_.getSource().removeFeature(this.vertexFeature_),this.vertexFeature_=null);return}this.snappedToVertex_&&(u=x>y?d[1]:d[0]),this.createOrUpdateVertexFeature_(u,[c.feature],[c.geometry],this.snappedToVertex_);const w={};w[getUid(c.geometry)]=!0;for(let C=1,T=a.length;C<T;++C){const P=a[C].segment;if(equals$2(d[0],P[0])&&equals$2(d[1],P[1])||equals$2(d[0],P[1])&&equals$2(d[1],P[0])){const E=getUid(a[C].geometry);E in w||(w[E]=!0,g[getUid(P)]=!0)}else break}}this.vertexSegments_=g;return}}this.vertexFeature_&&(this.overlay_.getSource().removeFeature(this.vertexFeature_),this.vertexFeature_=null)}insertVertex_(t,s){const n=t.segment,o=t.feature,a=t.geometry,l=t.depth,c=t.index;let d;for(;s.length<a.getStride();)s.push(0);switch(a.getType()){case"MultiLineString":d=a.getCoordinates(),d[l[0]].splice(c+1,0,s);break;case"Polygon":d=a.getCoordinates(),d[l[0]].splice(c+1,0,s);break;case"MultiPolygon":d=a.getCoordinates(),d[l[1]][l[0]].splice(c+1,0,s);break;case"LineString":d=a.getCoordinates(),d.splice(c+1,0,s);break;default:return!1}this.setGeometryCoordinates_(a,d);const u=this.rBush_;u.remove(t),this.updateSegmentIndices_(a,c,l,1);const _={segment:[n[0],s],feature:o,geometry:a,depth:l,index:c};u.insert(boundingExtent(_.segment),_),this.dragSegments_.push([_,1]);const f={segment:[s,n[1]],feature:o,geometry:a,depth:l,index:c+1};return u.insert(boundingExtent(f.segment),f),this.dragSegments_.push([f,0]),!0}updatePointer_(t){var s;return t&&this.findInsertVerticesAndUpdateDragSegments_(t),(s=this.vertexFeature_)==null?void 0:s.getGeometry().getCoordinates()}getPoint(){var s;const t=(s=this.vertexFeature_)==null?void 0:s.getGeometry().getCoordinates();return t?toUserCoordinate(t,this.getMap().getView().getProjection()):null}canRemovePoint(){if(!this.vertexFeature_||this.vertexFeature_.get("geometries").every(n=>n.getType()==="Circle"||n.getType().endsWith("Point")))return!1;const t=this.vertexFeature_.getGeometry().getCoordinates();return this.rBush_.getInExtent(boundingExtent([t])).some(({segment:n})=>equals$2(n[0],t)||equals$2(n[1],t))}removePoint(t){if(t&&(t=fromUserCoordinate(t,this.getMap().getView().getProjection()),this.updatePointer_(t)),!this.lastPointerEvent_||this.lastPointerEvent_&&this.lastPointerEvent_.type!=MapBrowserEventType.POINTERDRAG){const s=this.lastPointerEvent_;this.willModifyFeatures_(s,this.dragSegments_.map(([o])=>o));const n=this.removeVertex_();return this.featuresBeingModified_&&this.dispatchEvent(new ModifyEvent(ModifyEventType.MODIFYEND,this.featuresBeingModified_,s)),this.featuresBeingModified_=null,n}return!1}removeVertex_(){const t=this.dragSegments_,s={};let n=!1,o,a,l,c,d,u,_,f,g,m,p;for(d=t.length-1;d>=0;--d)l=t[d],m=l[0],p=getUid(m.feature),m.depth&&(p+="-"+m.depth.join("-")),p in s||(s[p]={}),l[1]===0?(s[p].right=m,s[p].index=m.index):l[1]==1&&(s[p].left=m,s[p].index=m.index+1);for(p in s){switch(g=s[p].right,_=s[p].left,u=s[p].index,f=u-1,_!==void 0?m=_:m=g,f<0&&(f=0),c=m.geometry,a=c.getCoordinates(),o=a,n=!1,c.getType()){case"MultiLineString":a[m.depth[0]].length>2&&(a[m.depth[0]].splice(u,1),n=!0);break;case"LineString":a.length>2&&(a.splice(u,1),n=!0);break;case"MultiPolygon":o=o[m.depth[1]];case"Polygon":o=o[m.depth[0]],o.length>4&&(u==o.length-1&&(u=0),o.splice(u,1),n=!0,u===0&&(o.pop(),o.push(o[0]),f=o.length-1));break}if(n){this.setGeometryCoordinates_(c,a);const x=[];if(_!==void 0&&(this.rBush_.remove(_),x.push(_.segment[0])),g!==void 0&&(this.rBush_.remove(g),x.push(g.segment[1])),_!==void 0&&g!==void 0){const y={depth:m.depth,feature:m.feature,geometry:m.geometry,index:f,segment:x};this.rBush_.insert(boundingExtent(y.segment),y)}this.updateSegmentIndices_(c,u,m.depth,-1),this.vertexFeature_&&(this.overlay_.getSource().removeFeature(this.vertexFeature_),this.vertexFeature_=null),t.length=0}}return n}canInsertPoint(){if(!this.vertexFeature_||this.vertexFeature_.get("geometries").every(n=>n.getType()==="Circle"||n.getType().endsWith("Point")))return!1;const t=this.vertexFeature_.getGeometry().getCoordinates();return this.rBush_.getInExtent(boundingExtent([t])).some(({segment:n})=>!(equals$2(n[0],t)||equals$2(n[1],t)))}insertPoint(t){var o;const s=t?fromUserCoordinate(t,this.getMap().getView().getProjection()):(o=this.vertexFeature_)==null?void 0:o.getGeometry().getCoordinates();return s?this.findInsertVerticesAndUpdateDragSegments_(s).reduce((a,l)=>a||this.insertVertex_(l,s),!1):!1}setGeometryCoordinates_(t,s){this.changingFeature_=!0,t.setCoordinates(s),this.changingFeature_=!1}updateSegmentIndices_(t,s,n,o){this.rBush_.forEachInExtent(t.getExtent(),function(a){a.geometry===t&&(n===void 0||a.depth===void 0||equals(a.depth,n))&&a.index>s&&(a.index+=o)})}}function compareIndexes(h,t){return h.index-t.index}function projectedDistanceToSegmentDataSquared(h,t,s){const n=t.geometry;if(n.getType()==="Circle"){let a=n;if(t.index===CIRCLE_CIRCUMFERENCE_INDEX){const l=squaredDistance$1(a.getCenter(),fromUserCoordinate(h)),c=Math.sqrt(l)-a.getRadius();return c*c}}const o=fromUserCoordinate(h);return tempSegment[0]=fromUserCoordinate(t.segment[0]),tempSegment[1]=fromUserCoordinate(t.segment[1]),squaredDistanceToSegment(o,tempSegment)}function closestOnSegmentData(h,t,s){const n=t.geometry;if(n.getType()==="Circle"&&t.index===CIRCLE_CIRCUMFERENCE_INDEX)return toUserCoordinate(n.getClosestPoint(fromUserCoordinate(h)));const o=fromUserCoordinate(h);return tempSegment[0]=fromUserCoordinate(t.segment[0]),tempSegment[1]=fromUserCoordinate(t.segment[1]),toUserCoordinate(closestOnSegment(o,tempSegment))}function getDefaultStyleFunction(){const h=createEditingStyle();return function(t,s){return h.Point}}const controlCss='.geolocation{top:85px;left:.5em}.geolocation button{background:var(--primary);color:var(--on-primary)}.geolocation button>svg{fill:var(--on-primary);min-inline-size:1.25rem!important;max-inline-size:1.25rem!important;min-block-size:1.25rem!important;max-block-size:1.25rem!important}.ol-touch.geolocation{top:100px}.loading-indicator{position:absolute;pointer-events:none!important;display:flex;align-items:center;justify-content:center;background-color:#0000}.loading-indicator.small{bottom:.5em;left:.5em;width:30px;height:30px}.loading-indicator.fullscreen{width:100%;height:100%}.disabled{filter:brightness(1.7);pointer-events:none}.ol-unselectable{pointer-events:none}.ol-control{background:none}.ol-control button,.ol-control button:hover,.ol-control button:focus{--_round: 32px;border-radius:var(--_round);background:var(--primary);color:var(--on-primary);width:32px;height:32px;cursor:pointer;border:none;outline:none;pointer-events:all;position:relative;font-size:1rem}.ol-control button:hover:after{background-size:15000%;opacity:.1;transition:background-size var(--speed2) linear;content:"";position:absolute;top:0;right:0;bottom:0;left:0;z-index:1;border-radius:inherit;inline-size:100%;block-size:100%;background-position:center;background-image:radial-gradient(circle,currentColor 1%,transparent 1%)}.ol-control button.ol-zoom-in,.ol-control button.ol-zoom-in:hover{border-top-left-radius:var(--_round);border-top-right-radius:var(--_round);border-bottom-left-radius:.5rem;border-bottom-right-radius:.5rem;margin-bottom:.125rem}.ol-control button.ol-zoom-out,.ol-control button.ol-zoom-out:hover{border-top-left-radius:.5rem;border-top-right-radius:.5rem;border-bottom-left-radius:var(--_round);border-bottom-right-radius:var(--_round)}';/**
 * @license
 * Copyright 2021 Google LLC
 * SPDX-License-Identifier: BSD-3-Clause
 */const r=(h,t,s)=>{for(const n of t)if(n[0]===h)return(0,n[1])();return s==null?void 0:s()};var Wc,id;class EOxMapCompare extends i{constructor(){super();Nt(this,Wc);this.value=50,this.enabled="true"}static get properties(){return{value:{attribute:"value",type:Number},enabled:{attribute:"enabled",type:String}}}render(){return b`
      <style>
        :host {
          display: block;
          --thumb-size: 3rem;
        }
        .eox-map-compare {
          --thumb-bgc: #fff;
          --thumb-w: var(--thumb-size);

          position: relative;
          height: 100%;
        }
        .eox-map-compare::after {
          content: "";
          display: block;
        }
        .eox-map-compare__first,
        .eox-map-compare__second {
          height: 100%;
          object-fit: cover;
          position: absolute;
          top: 0;
          width: 100%;
        }
        .eox-map-compare__first {
          clip-path: polygon(
            0% 0%,
            ${this.value}% 0%,
            ${this.value}% 100%,
            0% 100%
          );
        }
        .eox-map-compare__second {
          clip-path: polygon(
            100% 0%,
            ${this.value}% 0%,
            ${this.value}% 100%,
            100% 100%
          );
        }
        .eox-map-compare__range {
          background-color: transparent;
          box-sizing: border-box;
          font-family: inherit;
          height: 100%;
          margin: 0;
          outline: none;
          position: absolute;
          top: 0;
          width: 100%;
          pointer-events: none;
        }
        .eox-map-compare__range::-moz-range-thumb {
          cursor: ew-resize;
          height: 100%;
          width: var(--thumb-w);
          pointer-events: all;
          background: transparent;
          border: none;
        }
        .eox-map-compare__range::-webkit-slider-thumb {
          cursor: ew-resize;
          height: 100%;
          width: var(--thumb-w);
          pointer-events: all;
          position: relative;
          background: transparent;
          border: none;
        }
        .eox-map-compare__range::-moz-range-track {
          background: transparent;
          background-size: 100%;
          box-sizing: border-box;
        }
        .eox-map-compare__range::-webkit-slider-runnable-track {
          background: transparent;
          background-size: 100%;
          box-sizing: border-box;
          height: 100%;
        }
        .eox-map-compare__range,
        .eox-map-compare__range::-webkit-slider-runnable-track,
        .eox-map-compare__range::-webkit-slider-thumb {
          -webkit-appearance: none;
          appearance: none;
        }
        .slider-bar,
        .slider-thumb {
          position: absolute;
          box-shadow: 0 0.125rem 0.125rem 0 rgb(0 0 0 / 0.32);
        }
        .slider-bar {
          pointer-events: none;
          top: 0;
          width: 0.3rem;
          height: 100%;
          background-color: var(--thumb-bgc);
          z-index: 2;
          left: calc(${this.value}% - 0.15rem);
          -webkit-clip-path: inset(0 -5px 0 -5px);
          clip-path: inset(0 -5px 0 -5px);
        }
        .slider-thumb {
          pointer-events: none;
          top: calc(50% - var(--thumb-size) / 2);
          background: var(--primary);
          z-index: 3;
          width: var(--thumb-size);
          aspect-ratio: 1;
          left: calc(${this.value}% - var(--thumb-size) / 2);
          border-radius: 50%;
          padding: 0.7rem;
          color: var(--on-primary);
          display: flex;
          align-items: center;
          justify-content: center;
          box-sizing: border-box;
        }
        .slider-thumb svg {
          fill: currentColor;
        }
      </style>
      ${r(this.enabled,[["first",()=>b`<slot name="first"></slot>`],["second",()=>b`<slot name="second"></slot>`]],()=>b`
          <div class="eox-map-compare">
            <div class="eox-map-compare__first">
              <slot name="first"></slot>
            </div>
            <div class="eox-map-compare__second">
              <slot name="second"></slot>
            </div>
            <input
              type="range"
              class="eox-map-compare__range"
              min="0"
              max="100"
              value=${this.value}
              @input=${$t(this,Wc,id)}
            />
            <div class="slider-bar"></div>
            <div class="slider-thumb">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <title>arrow-left-right</title>
                <path
                  d="M6.45,17.45L1,12L6.45,6.55L7.86,7.96L4.83,11H19.17L16.14,7.96L17.55,6.55L23,12L17.55,17.45L16.14,16.04L19.17,13H4.83L7.86,16.04L6.45,17.45Z"
                />
              </svg>
            </div>
          </div>
        `)}
    `}}Wc=new WeakSet,id=function(s){this.value=parseInt(s.target.value)};customElements.define("eox-map-compare",EOxMapCompare);function addNewFeature(h,t,s,n=!1,o=!1,a=!0){const l=n?[h.feature]:h.features;o&&t.getSource().clear();const c=t.getSource().getFeatures();if(!t.get("multipleFeatures")&&(c.length||l.length>1))return console.error("Multiple features detected!");l.forEach(_=>{const f=_.getGeometry();if(f instanceof LineString){const m=getLength(f,{radius:6378137,projection:s.projection});_.set("measure",m)}else if(f instanceof Polygon){const m=getArea(f,{radius:6378137,projection:s.projection});_.set("measure",m)}const g=getUid(_);_.set("id",g),_.setId(g)}),!n&&l.length&&(t.getSource().addFeatures(l),s.map.getView().fit(t.getSource().getExtent(),{duration:a?750:0}));const d=new GeoJSON,u=JSON.parse(d.writeFeatures(l,READ_FEATURES_OPTIONS));(n||o)&&dispatchEvt(s,"drawend",h,u),dispatchEvt(s,"addfeatures",h,u)}function dispatchEvt(h,t,s,n){const o=new CustomEvent(t,{detail:{originalEvent:s,geoJSON:n}});h.dispatchEvent(o)}function cancelAnimation(h){h.setRotation(h.getRotation())}function getProj(h,t){const a=h.readFeatures(t)[0].getGeometry().getCoordinates();if(a&&a.length>0){const l=findFirstCoordinateValue(a);if(typeof l=="number")return l>=-180&&l<=180?"EPSG:4326":"EPSG:3857"}}function findFirstCoordinateValue(h){if(typeof h=="number")return h;if(Array.isArray(h)&&h.length>0)return findFirstCoordinateValue(h[0])}function parseTextToFeature(h,t,s,n=!1,o=!0){try{const a=getFormatReader(h);if(!a){console.error("Unsupported format or invalid data");return}const l=getProj(a,h),c=a.readFeatures(h,{dataProjection:l||READ_FEATURES_OPTIONS.dataProjection,featureProjection:s.projection});addNewFeature({features:c},t,s,!1,n,o)}catch(a){console.error("Error parsing data:",a)}}function getFormatReader(h){return isGeoJSON(h)?new GeoJSON:isKML(h)?new KML({extractStyles:!1}):isTopoJSON(h)?new TopoJSON:null}function isGeoJSON(h){try{const t=JSON.parse(h);return t.type==="FeatureCollection"||t.type==="Feature"}catch{return!1}}function isKML(h){return h.includes("<kml")&&h.includes("</kml>")}function isTopoJSON(h){try{const t=JSON.parse(h);return t.type==="Topology"&&t.objects}catch{return!1}}function registerProjection(h,t,s=void 0){proj4.defs(h,t),register(proj4),typeof s<"u"&&get(h).setExtent(s)}async function registerProjectionFromCode(h){return register(proj4),await fromEPSGCode(h)}function parseFeature(h){return new GeoJSON().writeFeaturesObject(h)}function transform(h,t,s=void 0){return s||(s="EPSG:4326"),transform$1(h,t,s)}function transformExtent(h,t,s=void 0){return s||(s="EPSG:4326"),transformExtent$1(h,t,s)}function addScrollInteractions(h,t=!1){t?(h.addInteraction(new MouseWheelZoom({condition:platformModifierKeyOnly})),"ontouchstart"in window||navigator.maxTouchPoints>0?h.addInteraction(new DragPan({condition:function(n){return this.getPointerCount()===2||platformModifierKeyOnly(n)}})):h.addInteraction(new DragPan)):(h.addInteraction(new MouseWheelZoom),h.addInteraction(new DragPan))}function removeDefaultScrollInteractions(h){h.getInteractions().getArray().forEach(t=>{(t instanceof MouseWheelZoom||t instanceof DragPan)&&h.removeInteraction(t)})}function coordinatesRoughlyEquals(h,t,s=.001){let n=!0;for(let o=h.length-1;o>=0;--o)if(!numbersRoughlyEquals(h[o],t[o],s)){n=!1;break}return n}function numbersRoughlyEquals(h,t,s=.001){return Math.abs(h-t)<s}function getCenterFromProperty(h){if(h){const t=h;return!equals$2(t,[0,0])&&t[0]>=-180&&t[0]<=180&&t[1]>=-90&&t[1]<=90?fromLonLat(t):t}return[0,0]}function addDraw(h,t,s){const n=Object.assign({},s);if(h.interactions[n.id])throw Error(`Interaction with id: ${n.id} already exists.`);n.modify=typeof n.modify=="boolean"?n.modify:!0;const o=t.getSource();n.type==="Box"&&(n.geometryFunction=createBox(),n.type="Circle");const a=new Draw({...n,source:o});n.active===!1&&a.setActive(!1),a.on("drawend",d=>{t.get("isDrawingEnabled")&&addNewFeature(d,t,h,!0)}),h.map.addInteraction(a),h.interactions[n.id]=a;const l=new Modify({source:o});l.setActive(n.modify),h.map.addInteraction(l),h.interactions[`${n.id}_modify`]=l;const c=()=>{h.getLayerById(t.get("id"))||(h.removeInteraction(n.id),h.removeInteraction(`${n.id}_modify`),h.map.getLayerGroup().un("change",c))};h.map.getLayerGroup().on("change",c)}class EOxMapTooltip extends i{static get properties(){return{feature:{attribute:!1,property:!0,type:Object},propertyTransform:{attribute:!1,property:!0,type:Function}}}constructor(){super(),this.feature=null,this.propertyTransform=(t,s)=>t}render(){return this.feature?b` <style>
            ul {
              margin: 0;
              padding: 1rem 1rem 1rem 2rem;
              border-radius: 0.5rem;
              max-width: 250px;
              font-size: small;
              background-color: var(--inverse-surface);
              color: var(--inverse-on-surface);
              box-shadow: 0 0.25rem 0.5rem 0 rgb(0 0 0 / 0.4);
              line-height: normal;
              white-space: normal;
            }
            span {
              font-weight: bold;
            }
          </style>
          <ul>
            ${Object.entries(this.feature.getProperties()).map(([t,s])=>this.propertyTransform({key:t,value:s},this.feature)).filter(t=>t).map(({key:t,value:s})=>b`<li><span>${t}</span>: ${s}</li>`)}
          </ul>`:A}}customElements.get("eox-map-tooltip")||customElements.define("eox-map-tooltip",EOxMapTooltip);class MVT extends FeatureFormat{constructor(t){super(),t=t||{},this.dataProjection=new Projection({code:"",units:"tile-pixels"}),this.featureClass=t.featureClass?t.featureClass:RenderFeature,this.geometryName_=t.geometryName,this.layerName_=t.layerName?t.layerName:"layer",this.layers_=t.layers?t.layers:null,this.idProperty_=t.idProperty,this.supportedMediaTypes=["application/vnd.mapbox-vector-tile","application/x-protobuf"]}readRawGeometry_(t,s,n,o){t.pos=s.geometry;const a=t.readVarint()+t.pos;let l=1,c=0,d=0,u=0,_=0,f=0;for(;t.pos<a;){if(!c){const g=t.readVarint();l=g&7,c=g>>3}if(c--,l===1||l===2)d+=t.readSVarint(),u+=t.readSVarint(),l===1&&_>f&&(o.push(_),f=_),n.push(d,u),_+=2;else if(l===7)_>f&&(n.push(n[f],n[f+1]),_+=2);else throw new Error("Invalid command found in the PBF")}_>f&&(o.push(_),f=_)}createFeature_(t,s,n){const o=s.type;if(o===0)return null;let a;const l=s.properties;let c;this.idProperty_?(c=l[this.idProperty_],delete l[this.idProperty_]):c=s.id,l[this.layerName_]=s.layer.name;const d=[],u=[];this.readRawGeometry_(t,s,d,u);const _=getGeometryType(o,u.length);if(this.featureClass===RenderFeature)a=new this.featureClass(_,d,u,2,l,c),a.transform(n.dataProjection);else{let f;if(_=="Polygon"){const p=inflateEnds(d,u);f=p.length>1?new MultiPolygon(d,"XY",p):new Polygon(d,"XY",u)}else f=_==="Point"?new Point(d,"XY"):_==="LineString"?new LineString(d,"XY"):_==="MultiPoint"?new MultiPoint(d,"XY"):_==="MultiLineString"?new MultiLineString(d,"XY",u):null;const g=this.featureClass;a=new g,this.geometryName_&&a.setGeometryName(this.geometryName_);const m=transformGeometryWithOptions(f,!1,n);a.setGeometry(m),c!==void 0&&a.setId(c),a.setProperties(l,!0)}return a}getType(){return"arraybuffer"}readFeatures(t,s){const n=this.layers_;s=this.adaptOptions(s);const o=get(s.dataProjection);o.setWorldExtent(s.extent),s.dataProjection=o;const a=new Pbf(t),l=a.readFields(layersPBFReader,{}),c=[];for(const d in l){if(n&&!n.includes(d))continue;const u=l[d],_=u?[0,0,u.extent,u.extent]:null;o.setExtent(_);for(let f=0,g=u.length;f<g;++f){const m=readRawFeature(a,u,f),p=this.createFeature_(a,m,s);p!==null&&c.push(p)}}return c}readProjection(t){return this.dataProjection}setLayers(t){this.layers_=t}}function layersPBFReader(h,t,s){if(h===3){const n={keys:[],values:[],features:[]},o=s.readVarint()+s.pos;s.readFields(layerPBFReader,n,o),n.length=n.features.length,n.length&&(t[n.name]=n)}}function layerPBFReader(h,t,s){if(h===15)t.version=s.readVarint();else if(h===1)t.name=s.readString();else if(h===5)t.extent=s.readVarint();else if(h===2)t.features.push(s.pos);else if(h===3)t.keys.push(s.readString());else if(h===4){let n=null;const o=s.readVarint()+s.pos;for(;s.pos<o;)h=s.readVarint()>>3,n=h===1?s.readString():h===2?s.readFloat():h===3?s.readDouble():h===4?s.readVarint64():h===5?s.readVarint():h===6?s.readSVarint():h===7?s.readBoolean():null;t.values.push(n)}}function featurePBFReader(h,t,s){if(h==1)t.id=s.readVarint();else if(h==2){const n=s.readVarint()+s.pos;for(;s.pos<n;){const o=t.layer.keys[s.readVarint()],a=t.layer.values[s.readVarint()];t.properties[o]=a}}else h==3?t.type=s.readVarint():h==4&&(t.geometry=s.pos)}function readRawFeature(h,t,s){h.pos=t.features[s];const n=h.readVarint()+h.pos,o={layer:t,type:0,properties:{}};return h.readFields(featurePBFReader,o,n),o}function getGeometryType(h,t){let s;return h===1?s=t===1?"Point":"MultiPoint":h===2?s=t===1?"LineString":"MultiLineString":h===3&&(s="Polygon"),s}const IMAGE_REPLAYS={image:["Polygon","Circle","LineString","Image","Text"],hybrid:["Polygon","LineString"],vector:[]},VECTOR_REPLAYS={hybrid:["Image","Text","Default"],vector:["Polygon","Circle","LineString","Image","Text","Default"]};class CanvasVectorTileLayerRenderer extends CanvasTileLayerRenderer{constructor(t,s){super(t,s),this.boundHandleStyleImageChange_=this.handleStyleImageChange_.bind(this),this.renderedLayerRevision_,this.renderedPixelToCoordinateTransform_=null,this.renderedRotation_,this.renderedOpacity_=1,this.tmpTransform_=create(),this.tileClipContexts_=null}enqueueTilesForNextExtent(){return this.getLayer().getRenderMode()!=="vector"}drawTile(t,s,n,o,a,l,c,d){this.updateExecutorGroup_(t,s.pixelRatio,s.viewState.projection),this.tileImageNeedsRender_(t)&&this.renderTileImage_(t,s),super.drawTile(t,s,n,o,a,l,c,d)}getTile(t,s,n,o){const a=this.getOrCreateTile(t,s,n,o);if(!a)return null;const l=o.viewState,c=l.resolution,d=o.viewHints,u=this.getLayer().getSource(),_=u.getTileGridForProjection(l.projection),f=!(d[ViewHint.ANIMATING]||d[ViewHint.INTERACTING]),g=_.getZForResolution(c,u.zDirection)===t;return f&&g?a.wantedResolution=c:a.wantedResolution||(a.wantedResolution=_.getResolution(t)),a}prepareFrame(t){const s=this.getLayer().getRevision();return this.renderedLayerRevision_!==s&&(this.renderedLayerRevision_=s,this.renderedTiles.length=0),super.prepareFrame(t)}updateExecutorGroup_(t,s,n){const o=this.getLayer(),a=o.getRevision(),l=o.getRenderOrder()||null,c=t.wantedResolution,d=t.getReplayState(o);if(!d.dirty&&d.renderedResolution===c&&d.renderedRevision==a&&d.renderedRenderOrder==l)return;const u=o.getSource(),_=!!o.getDeclutter(),f=u.getTileGrid(),m=u.getTileGridForProjection(n).getTileCoordExtent(t.wrappedTileCoord),p=u.getSourceTiles(s,n,t),x=getUid(o);delete t.hitDetectionImageData[x],t.executorGroups[x]=[],d.dirty=!1;for(let y=0,w=p.length;y<w;++y){const C=p[y];if(C.getState()!=TileState.LOADED)continue;const T=u.getProjection(),P=C.tileCoord;let E=f.getTileCoordExtent(P);n&&T&&!equivalent(n,T)&&(E=transformExtent$1(E,T,n,32));const S=getIntersection(m,E),M=buffer(S,o.getRenderBuffer()*c,this.tempExtent),R=equals$1(E,S)?null:M,k=new BuilderGroup(0,S,c,s),B=getSquaredTolerance(c,s),z=function(Ee,I){let N;const rt=Ee.getStyleFunction()||o.getStyleFunction();if(rt&&(N=rt(Ee,c)),N){const Zt=this.renderFeature(Ee,B,N,k,_,I);d.dirty=d.dirty||Zt}},O=C.getFeatures();l&&l!==d.renderedRenderOrder&&O.sort(l);for(let Ee=0,I=O.length;Ee<I;++Ee){let N=O[Ee];n&&C.projection&&!equivalent(n,C.projection)&&(N=N.clone(),N.getGeometry().applyTransform(getTransform(C.projection,n))),(!R||intersects(R,N.getGeometry().getExtent()))&&z.call(this,N,Ee)}const ze=k.finish(),D=o.getRenderMode()!=="vector"&&_&&p.length===1?null:S,re=new ExecutorGroup(D,c,s,u.getOverlaps(),ze,o.getRenderBuffer(),!0);t.executorGroups[x].push(re)}d.renderedRevision=a,d.renderedRenderOrder=l,d.renderedResolution=c}forEachFeatureAtCoordinate(t,s,n,o,a){var T,P;const l=s.viewState.resolution,c=s.viewState.rotation;n=n??0;const d=this.getLayer(),_=d.getSource().getTileGridForProjection(s.viewState.projection),f=boundingExtent([t]);buffer(f,l*n,f);const g={},m=function(E,S,M){let R=E.getId();R===void 0&&(R=getUid(E));const k=g[R];if(k){if(k!==!0&&M<k.distanceSq){if(M===0)return g[R]=!0,a.splice(a.lastIndexOf(k),1),o(E,d,S);k.geometry=S,k.distanceSq=M}}else{if(M===0)return g[R]=!0,o(E,d,S);a.push(g[R]={feature:E,layer:d,geometry:S,distanceSq:M,callback:o})}},p=this.renderedTiles,x=getUid(d),y=d.getDeclutter(),w=y?(P=(T=s.declutter)==null?void 0:T[y])==null?void 0:P.all().map(E=>E.value):null;let C;e:for(let E=0,S=p.length;E<S;++E){const M=p[E],R=_.getTileCoordExtent(M.wrappedTileCoord);if(!intersects(R,f))continue;const k=M.executorGroups[x];for(let B=0,z=k.length;B<z;++B)if(C=k[B].forEachFeatureAtCoordinate(t,l,c,n,m,w),C)break e}return C}getFeatures(t){return this.renderedTiles.length===0?Promise.resolve([]):new Promise((s,n)=>{const o=this.getLayer(),a=o.getSource(),l=this.renderedProjection,c=l.getExtent(),d=this.renderedResolution,u=a.getTileGridForProjection(l),_=apply(this.renderedPixelToCoordinateTransform_,t.slice()),f=u.getTileCoordForCoordAndResolution(_,d).toString(),g=this.renderedTiles.find(T=>T.tileCoord.toString()===f&&T.getState()===TileState.LOADED);if(!g||g.loadingSourceTiles>0){s([]);return}a.getWrapX()&&l.canWrapX()&&!containsExtent(c,u.getTileCoordExtent(g.tileCoord))&&wrapX(_,l);const m=getUid(o),p=u.getTileCoordExtent(g.wrappedTileCoord),x=getTopLeft(p),y=[(_[0]-x[0])/d,(x[1]-_[1])/d],w=g.getSourceTiles().reduce((T,P)=>T.concat(P.getFeatures()),[]);let C=g.hitDetectionImageData[m];if(!C){const T=toSize(u.getTileSize(u.getZForResolution(d,a.zDirection))),P=this.renderedRotation_,E=[this.getRenderTransform(u.getTileCoordCenter(g.wrappedTileCoord),d,0,HIT_DETECT_RESOLUTION,T[0]*HIT_DETECT_RESOLUTION,T[1]*HIT_DETECT_RESOLUTION,0)];C=createHitDetectionImageData(T,E,w,o.getStyleFunction(),u.getTileCoordExtent(g.wrappedTileCoord),g.getReplayState(o).renderedResolution,P),g.hitDetectionImageData[m]=C}s(hitDetect(y,w,C))})}getFeaturesInExtent(t){const s=[],n=this.getTileCache();if(n.getCount()===0)return s;const a=this.getLayer().getSource().getTileGridForProjection(this.frameState.viewState.projection),l=a.getZForResolution(this.renderedResolution),c={};return n.forEach(d=>{if(d.tileCoord[0]!==l||d.getState()!==TileState.LOADED)return;const u=d.getSourceTiles();for(let _=0,f=u.length;_<f;++_){const g=u[_],m=g.getKey();if(m in c)continue;c[m]=!0;const p=g.tileCoord;if(intersects(t,a.getTileCoordExtent(p))){const x=g.getFeatures();if(x)for(let y=0,w=x.length;y<w;++y){const C=x[y],T=C.getGeometry();intersects(t,T.getExtent())&&s.push(C)}}}}),s}handleFontsChanged(){const t=this.getLayer();t.getVisible()&&this.renderedLayerRevision_!==void 0&&t.changed()}handleStyleImageChange_(t){this.renderIfReadyAndVisible()}renderDeclutter(t,s){var g;const n=this.context,o=n.globalAlpha;n.globalAlpha=s.opacity;const a=t.viewHints,l=!(a[ViewHint.ANIMATING]||a[ViewHint.INTERACTING]),c=[this.context.canvas.width,this.context.canvas.height],d=this.getLayer().getDeclutter(),u=d?(g=t.declutter)==null?void 0:g[d]:void 0,_=getUid(this.getLayer()),f=this.renderedTiles;for(let m=0,p=f.length;m<p;++m){const x=f[m],y=x.executorGroups[_];if(y)for(let w=y.length-1;w>=0;--w)y[w].execute(this.context,c,this.getTileRenderTransform(x,t),t.viewState.rotation,l,DECLUTTER,u)}n.globalAlpha=o}renderDeferredInternal(t){const s=this.renderedTiles,n=getUid(this.getLayer()),o=s.reduce((d,u,_)=>(u.executorGroups[n].forEach(f=>d.push({executorGroup:f,index:_})),d),[]),a=o.map(({executorGroup:d})=>d.getDeferredZIndexContexts()),l={};for(let d=0,u=o.length;d<u;++d){const _=o[d].executorGroup.getDeferredZIndexContexts();for(const f in _)l[f]=!0}Object.keys(l).map(Number).sort(ascending).forEach(d=>{a.forEach((u,_)=>{u[d]&&(u[d].forEach(f=>{const{executorGroup:g,index:m}=o[_],p=g.getRenderedContext(),x=p.globalAlpha;p.globalAlpha=this.renderedOpacity_;const y=this.tileClipContexts_[m];y&&y.draw(p),f.draw(p),y&&p.restore(),p.globalAlpha=x,f.clear()}),u[d].length=0)})})}getTileRenderTransform(t,s){const n=s.pixelRatio,o=s.viewState,a=o.center,l=o.resolution,c=o.rotation,d=s.size,u=Math.round(d[0]*n),_=Math.round(d[1]*n),g=this.getLayer().getSource().getTileGridForProjection(s.viewState.projection),m=t.tileCoord,p=g.getTileCoordExtent(t.wrappedTileCoord),x=g.getTileCoordExtent(m,this.tempExtent)[0]-p[0];return multiply(scale$1(this.inversePixelTransform.slice(),1/n,1/n),this.getRenderTransform(a,l,c,n,u,_,x))}postRender(t,s){var E;const n=s.viewHints,o=!(n[ViewHint.ANIMATING]||n[ViewHint.INTERACTING]);this.renderedPixelToCoordinateTransform_=s.pixelToCoordinateTransform.slice(),this.renderedRotation_=s.viewState.rotation,this.renderedOpacity_=s.layerStatesArray[s.layerIndex].opacity;const a=this.getLayer(),l=a.getRenderMode(),c=t.globalAlpha;t.globalAlpha=this.renderedOpacity_;const d=a.getDeclutter(),u=d?VECTOR_REPLAYS[l].filter(S=>!DECLUTTER.includes(S)):VECTOR_REPLAYS[l],_=s.viewState,f=_.rotation,g=a.getSource(),p=g.getTileGridForProjection(_.projection).getZForResolution(_.resolution,g.zDirection),x=this.renderedTiles,y=[],w=[],C=[],T=getUid(a);let P=!0;for(let S=x.length-1;S>=0;--S){const M=x[S];P=P&&!M.getReplayState(a).dirty;const R=M.executorGroups[T].filter(re=>re.hasExecutors(u));if(R.length===0)continue;const k=this.getTileRenderTransform(M,s),B=M.tileCoord[0];let z=!1;const O=R[0].getClipCoords(k);let ze=t,D;if(O){D=new ZIndexContext,ze=D.getContext();for(let re=0,Ee=y.length;re<Ee;++re)if(p!==B&&B<w[re]){const I=y[re];intersects([O[0],O[3],O[4],O[7]],[I[0],I[3],I[4],I[7]])&&(z||(ze.save(),z=!0),ze.beginPath(),ze.moveTo(O[0],O[1]),ze.lineTo(O[2],O[3]),ze.lineTo(O[4],O[5]),ze.lineTo(O[6],O[7]),ze.moveTo(I[6],I[7]),ze.lineTo(I[4],I[5]),ze.lineTo(I[2],I[3]),ze.lineTo(I[0],I[1]),ze.clip())}y.push(O),w.push(B)}for(let re=0,Ee=R.length;re<Ee;++re)R[re].execute(t,[t.canvas.width,t.canvas.height],k,f,o,u,(E=s.declutter)==null?void 0:E[d]);z&&(ze===t?ze.restore():C[S]=D)}t.globalAlpha=c,this.ready=P,this.tileClipContexts_=C,s.declutter||this.renderDeferredInternal(s),super.postRender(t,s)}renderFeature(t,s,n,o,a,l){if(!n)return!1;let c=!1;if(Array.isArray(n))for(let d=0,u=n.length;d<u;++d)c=renderFeature(o,t,n[d],s,this.boundHandleStyleImageChange_,void 0,a,l)||c;else c=renderFeature(o,t,n,s,this.boundHandleStyleImageChange_,void 0,a,l);return c}tileImageNeedsRender_(t){const s=this.getLayer();if(s.getRenderMode()==="vector")return!1;const n=t.getReplayState(s),o=s.getRevision(),a=t.wantedResolution;return n.renderedTileResolution!==a||n.renderedTileRevision!==o}renderTileImage_(t,s){const n=this.getLayer(),o=t.getReplayState(n),a=n.getRevision(),l=t.executorGroups[getUid(n)];o.renderedTileRevision=a;const c=t.wrappedTileCoord,d=c[0],u=n.getSource();let _=s.pixelRatio;const g=s.viewState.projection,m=u.getTileGridForProjection(g),p=m.getResolution(t.tileCoord[0]),x=s.pixelRatio/t.wantedResolution*p,y=m.getResolution(d),w=t.getContext();_=Math.round(Math.max(_,x/_));const C=u.getTilePixelSize(d,_,g);w.canvas.width=C[0],w.canvas.height=C[1];const T=_/x;if(T!==1){const M=reset(this.tmpTransform_);scale$1(M,T,T),w.setTransform.apply(w,M)}const P=m.getTileCoordExtent(c,this.tempExtent),E=x/y,S=reset(this.tmpTransform_);scale$1(S,E,-E),translate(S,-P[0],-P[3]);for(let M=0,R=l.length;M<R;++M)l[M].execute(w,[w.canvas.width*T,w.canvas.height*T],S,0,!0,IMAGE_REPLAYS[n.getRenderMode()],null);o.renderedTileResolution=t.wantedResolution}}class VectorTileLayer extends BaseVectorLayer{constructor(t){t=t||{};const s=Object.assign({},t);delete s.preload;const n=t.cacheSize===void 0?0:t.cacheSize;delete t.cacheSize,delete s.useInterimTilesOnError,super(s),this.on,this.once,this.un,this.cacheSize_=n;const o=t.renderMode||"hybrid";assert(o=="hybrid"||o=="vector","`renderMode` must be `'hybrid'` or `'vector'`"),this.renderMode_=o,this.setPreload(t.preload?t.preload:0),this.setUseInterimTilesOnError(t.useInterimTilesOnError!==void 0?t.useInterimTilesOnError:!0),this.getBackground,this.setBackground}createRenderer(){return new CanvasVectorTileLayerRenderer(this,{cacheSize:this.cacheSize_})}getFeatures(t){return super.getFeatures(t)}getFeaturesInExtent(t){return this.getRenderer().getFeaturesInExtent(t)}getRenderMode(){return this.renderMode_}getPreload(){return this.get(TileProperty.PRELOAD)}getUseInterimTilesOnError(){return this.get(TileProperty.USE_INTERIM_TILES_ON_ERROR)}setPreload(t){this.set(TileProperty.PRELOAD,t)}setUseInterimTilesOnError(t){this.set(TileProperty.USE_INTERIM_TILES_ON_ERROR,t)}}var UID_LENGTH=16,UID=generateUID(),PLACE_HOLDER_REGEXP=new RegExp('(\\\\)?"@__(F|R|D|M|S|A|U|I|B|L)-'+UID+'-(\\d+)__@"',"g"),IS_NATIVE_CODE_REGEXP=/\{\s*\[native code\]\s*\}/g,IS_PURE_FUNCTION=/function.*?\(/,IS_ARROW_FUNCTION=/.*?=>.*?/,UNSAFE_CHARS_REGEXP=/[<>\/\u2028\u2029]/g,SCRIPT_CLOSE_REGEXP=/<\/script[^>]*>/gi,RESERVED_SYMBOLS=["*","async"],ESCAPED_CHARS={"<":"\\u003C",">":"\\u003E","/":"\\u002F","\u2028":"\\u2028","\u2029":"\\u2029"};function escapeUnsafeChars(h){return ESCAPED_CHARS[h]}function escapeFunctionBody(h){return h=h.replace(SCRIPT_CLOSE_REGEXP,function(t){return t.replace(/</g,"\\u003C").replace(/\//g,"\\u002F").replace(/>/g,"\\u003E")}),h=h.replace(/\u2028/g,"\\u2028"),h=h.replace(/\u2029/g,"\\u2029"),h}function generateUID(){for(var h=crypto.getRandomValues(new Uint8Array(UID_LENGTH)),t="",s=0;s<UID_LENGTH;++s)t+=h[s].toString(16);return t}function deleteFunctions(h){var t=[];for(var s in h)typeof h[s]=="function"&&t.push(s);for(var n=0;n<t.length;n++)delete h[t[n]]}var serializeJavascript=function h(t,s){s||(s={}),(typeof s=="number"||typeof s=="string")&&(s={space:s});var n=[],o=[],a=[],l=[],c=[],d=[],u=[],_=[],f=[],g=[];function m(y,w){if(s.ignoreFunction&&deleteFunctions(w),!w&&w!==void 0&&w!==BigInt(0))return w;var C=this[y],T=typeof C;if(T==="object"){if(C instanceof RegExp)return"@__R-"+UID+"-"+(o.push(C)-1)+"__@";if(C instanceof Date)return"@__D-"+UID+"-"+(a.push(C)-1)+"__@";if(C instanceof Map)return"@__M-"+UID+"-"+(l.push(C)-1)+"__@";if(C instanceof Set)return"@__S-"+UID+"-"+(c.push(C)-1)+"__@";if(C instanceof Array){var P=C.filter(function(){return!0}).length!==C.length;if(P)return"@__A-"+UID+"-"+(d.push(C)-1)+"__@"}if(C instanceof URL)return"@__L-"+UID+"-"+(g.push(C)-1)+"__@"}return T==="function"?"@__F-"+UID+"-"+(n.push(C)-1)+"__@":T==="undefined"?"@__U-"+UID+"-"+(u.push(C)-1)+"__@":T==="number"&&!isNaN(C)&&!isFinite(C)?"@__I-"+UID+"-"+(_.push(C)-1)+"__@":T==="bigint"?"@__B-"+UID+"-"+(f.push(C)-1)+"__@":w}function p(y,w){var C=y.toString();if(IS_NATIVE_CODE_REGEXP.test(C))throw new TypeError("Serializing native function: "+y.name);if(w&&w.unsafe!==!0&&(C=escapeFunctionBody(C)),IS_PURE_FUNCTION.test(C)||IS_ARROW_FUNCTION.test(C))return C;var T=C.indexOf("("),P=C.substr(0,T).trim().split(" ").filter(function(S){return S.length>0}),E=P.filter(function(S){return RESERVED_SYMBOLS.indexOf(S)===-1});return E.length>0?(P.indexOf("async")>-1?"async ":"")+"function"+(P.join("").indexOf("*")>-1?"*":"")+C.substr(T):C}if(s.ignoreFunction&&typeof t=="function"&&(t=void 0),t===void 0)return String(t);var x;return s.isJSON&&!s.space?x=JSON.stringify(t):x=JSON.stringify(t,s.isJSON?null:m,s.space),typeof x!="string"?String(x):(s.unsafe!==!0&&(x=x.replace(UNSAFE_CHARS_REGEXP,escapeUnsafeChars)),n.length===0&&o.length===0&&a.length===0&&l.length===0&&c.length===0&&d.length===0&&u.length===0&&_.length===0&&f.length===0&&g.length===0?x:x.replace(PLACE_HOLDER_REGEXP,function(y,w,C,T){if(w)return y;if(C==="D")return'new Date("'+a[T].toISOString()+'")';if(C==="R")return"new RegExp("+h(o[T].source)+', "'+o[T].flags+'")';if(C==="M")return"new Map("+h(Array.from(l[T].entries()),s)+")";if(C==="S")return"new Set("+h(Array.from(c[T].values()),s)+")";if(C==="A")return"Array.prototype.slice.call("+h(Object.assign({length:d[T].length},d[T]),s)+")";if(C==="U")return"undefined";if(C==="I")return _[T];if(C==="B")return'BigInt("'+f[T]+'")';if(C==="L")return"new URL("+h(g[T].toString(),s)+")";var P=n[T];return p(P,s)}))};const serialize=getDefaultExportFromCjs(serializeJavascript),basicOlFormats={GeoJSON,MVT},basicOlLayers={Group:LayerGroup,Image:ImageLayer,Tile:TileLayer,Vector:VectorLayer,VectorTile:VectorTileLayer},basicOlSources={ImageWMS,OSM,Tile:TileSource,TileWMS,Vector:VectorSource,VectorTile,WMTS,XYZ};function createLayer(h,t,s=!0){var l;const o={...window.eoxMapAdvancedOlLayers,...basicOlLayers}[t.type];if(!o)throw new Error(`Layer type ${t.type} not supported!`);const a=new o({...t,...t.type!=="MapboxStyle"&&t.source&&{source:createOlSourceFromDefinition(t.source)},...t.type==="Group"&&{layers:[]},...t.properties,style:void 0});if(a.set("_jsonDefinition",t,!0),t.type==="Group"){const c=t.layers.map(d=>createLayer(h,d));c.forEach(d=>d.set("_group",a,!0)),a.setLayers(new Collection(c))}if("style"in t&&a.setStyle(t.style),s&&((l=t.interactions)!=null&&l.length))for(let c=0;c<t.interactions.length;c++){const d=t.interactions[c];addInteraction(h,a,d)}return setSyncListeners(a,t),a}function createOlSourceFromDefinition(h){const s={...window.eoxMapAdvancedOlSources,...basicOlSources}[h.type];if(h&&!s)throw new Error(`Source type ${h.type} not supported!`);const n={...window.eoxMapAdvancedOlFormats,...basicOlFormats},o=generateTileGrid(h);return new s({...h,..."format"in h&&h.type!=="WMTS"&&{format:new n[typeof h.format=="object"?h.format.type:h.format]({...typeof h.format=="object"&&{...h.format}})},..."source"in h&&{source:createOlSourceFromDefinition(h.source)},..."tileGrid"in h&&{tileGrid:o},..."projection"in h&&{projection:get(h.projection)}})}function addInteraction(h,t,s){s.type==="draw"?addDraw(h,t,s.options):s.type==="select"?addSelect(h,t,s.options):s.type==="clusterExplode"&&addClusterExplode(h,t,s.options)}function updateLayer(h,t,s){var a,l,c,d;const n=s.get("_jsonDefinition");if(t.type!==n.type||t.type!=="MapboxStyle"&&((a=t.source)==null?void 0:a.type)!==((l=n.source)==null?void 0:l.type))throw new Error("Layers are not compatible to be updated");const o=createLayer(h,t,!1);if(t.type!=="MapboxStyle"&&serialize(t.source)!==serialize(n.source)&&s.setSource(o.getSource()),t.type==="MapboxStyle"&&serialize(t.properties.mapboxStyle)!==serialize(n.properties.mapboxStyle)&&(s.getLayers().clear(),s.applyMapboxStyle(t.properties.mapboxStyle,t.properties.applyOptions)),["Vector","VectorTile"].includes(t.type)&&serialize(t.style)!==serialize(n.style)&&s.setStyle(o.getStyle()),serialize(t.properties)!==serialize(n.properties)&&s.setProperties(t.properties),t.visible!==n.visible&&s.setVisible(t.visible),t.opacity&&t.opacity!==n.opacity&&s.setOpacity(t.opacity),serialize(t.interactions)!==serialize(n.interactions)&&((c=n.interactions)==null||c.forEach(u=>{const _=t.interactions.find(f=>{var g,m;return f.type===u.type&&((g=f.options)==null?void 0:g.id)===((m=u.options)==null?void 0:m.id)});_?_.type==="draw"?(h.interactions[_.options.id].setActive(_.options.active),h.interactions[`${_.options.id}_modify`].setActive(_.options.modify)):(h.selectInteractions[_.options.id]||h.interactions[_.options.id]).setActive(_.options.active):u.type==="select"?h.removeSelect(u.options.id):h.removeInteraction(u.options.id)}),(d=t.interactions)==null||d.forEach(u=>{n.interactions.find(f=>{var g,m;return f.type===u.type&&((g=f.options)==null?void 0:g.id)===((m=u.options)==null?void 0:m.id)})||addInteraction(h,s,u)})),t.type==="Group"){const u=t.layers.map(m=>{var p;return(p=m.properties)==null?void 0:p.id}),_=s.getLayers();_.getArray().slice().forEach(m=>{u.includes(m.get("id"))||_.remove(m)}),t.layers.forEach(m=>{const p=m.properties.id;if(_.getArray().map(x=>x.get("id")).includes(p))updateLayer(h,m,h.getLayerById(p));else{const x=createLayer(h,m);_.push(x)}});const g=u;_.getArray().sort((m,p)=>g.indexOf(m.get("id"))-g.indexOf(p.get("id"))),_.changed()}return setSyncListeners(s,t),s.set("_jsonDefinition",t,!0),s}const generateLayers=(h,t)=>t?[...t].map(s=>createLayer(h,s)):[];function setSyncListeners(h,t){h.on("change:opacity",()=>{t.opacity=h.getOpacity()}),h.on("change:visible",()=>{t.visible=h.getVisible()}),h.on("change:zIndex",()=>{t.zIndex=h.getZIndex()}),h.on("propertychange",s=>{s.key==="map"||s.key==="source"||t.properties&&(t.properties[s.key]=s.target.get(s.key))})}class EOxSelectInteraction{constructor(t,s,n){td(this,"panIntoFeature",(t,s)=>{const n=t instanceof Feature||t instanceof RenderFeature?t.getGeometry().getExtent():t;this.eoxMap.map.getView().fit(n,s||{duration:750})});var u,_,f;this.eoxMap=t,this.selectLayer=s,this.options=n,this.active=n.active||s.getVisible(),this.panIn=n.panIn||!1,this.tooltip=n.tooltip!==!1;const o=this.eoxMap.map.getOverlayById("eox-map-tooltip");let a;this.tooltip&&(o?(this.tooltipElement=o.getElement(),a=o):(this.tooltipElement=this.eoxMap.querySelector("eox-map-tooltip")||this.eoxMap.querySelector("[is=eox-map-tooltip]")||((u=n.overlay)==null?void 0:u.element),this.tooltipElement&&(a=new Overlay({element:this.tooltipElement,position:void 0,offset:[0,0],positioning:"top-left",className:"eox-map-tooltip",id:"eox-map-tooltip",...n.overlay}),this.eoxMap.map.addOverlay(a))));const l=()=>{a&&n.condition==="pointermove"&&a.setPosition(void 0)};t.map.on("change:target",g=>{var m,p;(m=g.oldValue)==null||m.removeEventListener("pointerleave",l),(p=g.target.getTargetElement())==null||p.addEventListener("pointerleave",l)}),(_=t.map.getTargetElement())==null||_.addEventListener("pointerleave",l);const c=g=>{var y,w,C,T;n!=null&&n.projection&&(proj4.defs((y=n.projection)==null?void 0:y.name)||(proj4.defs((w=n.projection)==null?void 0:w.name,(C=n==null?void 0:n.projection)==null?void 0:C.proj4_string),register(proj4)));const m=get(((T=n==null?void 0:n.projection)==null?void 0:T.name)||"EPSG:4326"),p=t.map.getView().getProjection().getCode(),x=transform$1(g.coordinate,p,m);return{lon:x[0].toFixed((n==null?void 0:n.precision)||2),lat:x[1].toFixed((n==null?void 0:n.precision)||2)}},d=g=>Object.values(g).every(m=>m===0);if(this.selectLayer instanceof VectorLayer||this.selectLayer instanceof VectorTileLayer){this.selectedFids=[];let g;if(this.options.layer)g=this.options.layer;else{const x=this.selectLayer.get("_jsonDefinition");g={...x,style:n.style,properties:{id:this.selectLayer.get("id")+"_select"},source:{type:x.type}}}g.renderMode="vector",delete g.interactions,this.selectStyleLayer=createLayer(t,g),this.selectStyleLayer.setSource(this.selectLayer.getSource()),this.selectStyleLayer.setMap(this.eoxMap.map);const m=this.selectStyleLayer.getStyleFunction();this.selectStyleLayer.setStyle((x,y)=>this.selectedFids.length&&this.selectedFids.includes(this.getId(x))?m(x,y):null),this.listener=x=>{if(!this.active||x.dragging)return;const y=this.eoxMap.map.getView().getZoom();if(y<this.selectLayer.getMinZoom()||y>this.selectLayer.getMaxZoom())return;const w=this.eoxMap.map.forEachFeatureAtPixel(x.pixel,E=>E,{layerFilter:E=>E===this.selectLayer}),C=w?[this.getId(w)]:[],T=this.selectedFids[0]!==C[0];if(this.selectedFids=C,T&&(this.selectStyleLayer.changed(),w&&this.panIn&&this.panIntoFeature(w)),a){const E=x.pixel[0]>this.eoxMap.offsetWidth/2?"right":"left",S=x.pixel[1]>this.eoxMap.offsetHeight/2?"bottom":"top";a.setPositioning(`${S}-${E}`),a.setPosition(w?x.coordinate:null),w&&this.tooltipElement&&(this.tooltipElement.feature=w)}const P=new CustomEvent("select",{detail:{id:n.id,originalEvent:x,feature:w}});this.eoxMap.dispatchEvent(P)},this.eoxMap.map.on(n.condition||"click",this.listener),this.selectLayer.on("change:opacity",()=>{this.selectStyleLayer.setOpacity(this.selectLayer.getOpacity())}),this.selectLayer.on("change:visible",()=>{const x=this.selectLayer.getVisible();this.selectStyleLayer.setVisible(x),this.setActive(x)}),this.changeSourceListener=()=>{this.selectStyleLayer.setSource(this.selectLayer.getSource())},this.selectLayer.on("change:source",this.changeSourceListener);const p=()=>{var x,y;t.getLayerById(s.get("id"))?((x=this.selectStyleLayer)==null||x.setMap(this.eoxMap.map),a==null||a.setMap(this.eoxMap.map)):((y=this.selectStyleLayer)==null||y.setMap(null),a==null||a.setMap(null))};t.map.getLayerGroup().on("change",p),this.pointerMoveListener=x=>{var y;x.dragging||(t.map.getTargetElement().style.cursor=t.map.hasFeatureAtPixel(x.pixel,{layerFilter:w=>{var C,T;return(T=(C=w.get("_jsonDefinition"))==null?void 0:C.interactions)==null?void 0:T.find(P=>{var E;return P.type=="select"&&((E=P.options)==null?void 0:E.condition)==="click"})},...n.atPixelOptions})?n.cursor||"pointer":(y=this.eoxMap.interactions.drawInteraction)!=null&&y.getActive()?"crosshair":"auto")},t.map.on("pointermove",this.pointerMoveListener)}(this.selectLayer.getSource()instanceof ImageWMS||this.selectLayer.getSource()instanceof TileWMS)&&(this.listener=g=>{if(!this.active||g.dragging)return;const m=t.map.getView().getResolution(),p=this.selectLayer.getSource().getFeatureInfoUrl(g.coordinate,m,t.map.getView().getProjection(),{INFO_FORMAT:"application/json"});p&&fetch(p).then(x=>x.text()).then(x=>{if(a){const y=g.pixel[0]>this.eoxMap.offsetWidth/2?"right":"left",w=g.pixel[1]>this.eoxMap.offsetHeight/2?"bottom":"top";a.setPositioning(`${w}-${y}`)}if(x&&this.tooltipElement){const y=JSON.parse(x);let w;y.type==="FeatureCollection"&&y.features.length>0?w=y.features[0]:y.type==="Feature"?(w=y,this.tooltipElement.innerHTML=`<pre>${JSON.stringify(w.properties,null,2)}</pre>`):a==null||a.setPosition(null),n!=null&&n.coordinates&&w&&Object.assign(w==null?void 0:w.properties,c(g));const C=new Feature({...w==null?void 0:w.properties});this.tooltipElement.feature=C,a.setPosition(w?g.coordinate:null)}})},n.condition=="click"&&this.eoxMap.map.on(n.condition,this.listener)),((f=this.selectLayer.getProperties())==null?void 0:f.type)==="WebGLTile"&&(this.listener=g=>{if(!this.active||g.dragging)return;const m=this.selectLayer.getData(g.pixel);if(m){if(a){const p=g.pixel[0]>this.eoxMap.offsetWidth/2?"right":"left",x=g.pixel[1]>this.eoxMap.offsetHeight/2?"bottom":"top";a.setPositioning(`${x}-${p}`),a.setPosition(g.coordinate);let y={};for(const[w,C]of m.entries()){const T=(w+1).toString();y[`band${T}`]=C}if(d(y))a==null||a.setPosition(null);else if(this.tooltipElement){n!=null&&n.coordinates&&Object.assign(y,c(g));const w=new Feature({...y});this.tooltipElement.feature=w,a.setPosition(Object.keys(y).length>0?g.coordinate:null)}}}else a==null||a.setPosition(null)},this.eoxMap.map.on(n.condition||"click",this.listener))}setActive(t){this.active=t}highlightById(t,s){if(this.selectedFids=t,t.length&&s){const n=createEmpty();if(this.selectLayer instanceof VectorLayer)for(let o=0;o<this.selectedFids.length;o++){const a=this.selectedFids[o],l=this.selectLayer.getSource().getFeatureById(a);l&&l.getGeometry()&&extend(n,l.getGeometry().getExtent())}else if(this.selectLayer instanceof VectorTileLayer){const o=this.eoxMap.map,a=this.selectLayer.getFeaturesInExtent(o.getView().calculateExtent(o.getSize()));for(let l=0;l<a.length;l++){const c=a[l];this.selectedFids.includes(this.getId(c))&&extend(n,c.getGeometry().getExtent())}}isEmpty(n)||this.panIntoFeature(n,s)}this.selectStyleLayer.changed()}remove(){this.eoxMap.map.un(this.options.condition||"click",this.listener),(this.selectLayer instanceof VectorLayer||this.selectLayer instanceof VectorTileLayer)&&(this.selectStyleLayer.setMap(null),delete this.eoxMap.selectInteractions[this.options.id],this.selectLayer.un("change:source",this.changeSourceListener),this.eoxMap.map.un("pointermove",this.pointerMoveListener))}getId(t){if(this.options.idProperty)return t.get(this.options.idProperty);if(t.getId()!==void 0)return t.getId();if(t.get("id")!==void 0)return t.get("id");if(getUid(t)!==void 0)return getUid(t);throw Error("No feature id found. Please provide which feature property should be taken instead using idProperty.")}}function addSelect(h,t,s){if(h.interactions[s.id])throw Error(`Interaction with id: ${s.id} already exists.`);return h.selectInteractions[s.id]=new EOxSelectInteraction(h,t,s),h.selectInteractions[s.id]}const circleDistanceMultiplier=1,circleFootSeparation=28,circleStartAngle=Math.PI/2;var Pc,Dc,Lc,Mt,Qc,Ic,Yc,Gc,sd,Jc;class EOxClusterExplodeInteraction extends Interaction{constructor(s,n,o){super(o);Nt(this,Mt);Nt(this,Pc,null);Nt(this,Dc,null);Nt(this,Lc,null);Nt(this,Yc,s=>new Promise(n=>{const o=this.eoxMap.map.getView().getZoom(),a={...mt(this,Pc).fitOptions};a.callback=l=>{var c,d;n(this.eoxMap.map.getView().getZoom()!==o),(d=(c=mt(this,Pc).fitOptions).callback)==null||d.call(c,l)},this.eoxMap.map.getView().fit(s,a)}));this.clusterLayer=n,this.eoxMap=s;const a={maxZoom:20,atPixelOptions:{},fitOptions:{duration:500,padding:[40,40,40,40]}},l=structuredClone(o);l.fitOptions&&(a.fitOptions={...a.fitOptions,...l.fitOptions},delete l.fitOptions),Ht(this,Pc,{...a,...l}),this.active=o.active||n.getVisible();const c=new VectorLayer;c.setStyle(o.style),Ht(this,Dc,c.getStyleFunction())}handleEvent(s){if(!this.getActive())return!0;if(s.type==="pointermove"){const n=this.eoxMap.map.hasFeatureAtPixel(s.pixel,{layerFilter:o=>o===this.clusterLayer,...mt(this,Pc).atPixelOptions});return this.eoxMap.map.getTargetElement().style.cursor=n?"pointer":"default",!n}if(s.type==="click"){const n=this.eoxMap.map.getFeaturesAtPixel(s.pixel,{layerFilter:c=>c===this.clusterLayer,...mt(this,Pc).atPixelOptions});if(n.length===0)return $t(this,Mt,Ic).call(this),!0;const o=n[0],a=o.get("features");if(a.length===1)return $t(this,Mt,Qc).call(this,s,a[0]),$t(this,Mt,Ic).call(this),!0;if(mt(this,Lc)&&mt(this,Lc)===o){const c=$t(this,Mt,sd).call(this,o,s.coordinate);$t(this,Mt,Qc).call(this,s,c.feature)}if(this.eoxMap.map.getView().getZoom()>mt(this,Pc).maxZoom-1)return $t(this,Mt,Gc).call(this,o),!1;const l=createEmpty();return a.forEach(c=>{extend(l,c.getGeometry().getExtent())}),getArea$1(l)<100?($t(this,Mt,Gc).call(this,o),!1):(mt(this,Yc).call(this,l).then(c=>{c||$t(this,Mt,Gc).call(this,o)}),!1)}return!0}setActive(s){s||($t(this,Mt,Ic).call(this),this.eoxMap.map.getTargetElement().style.cursor="default"),super.setActive(s)}setMap(s){s||($t(this,Mt,Ic).call(this),this.eoxMap.map.getTargetElement().style.cursor="default"),super.setMap(s)}remove(){this.setMap(null)}}Pc=new WeakMap,Dc=new WeakMap,Lc=new WeakMap,Mt=new WeakSet,Qc=function(s,n){const o=new CustomEvent("clusterSelect",{detail:{originalEvent:s,feature:n}});this.eoxMap.dispatchEvent(o)},Ic=function(){mt(this,Lc)&&(mt(this,Lc).setStyle(void 0),Ht(this,Lc,null))},Yc=new WeakMap,Gc=function(s){mt(this,Lc)&&$t(this,Mt,Ic).call(this);const n=s.getGeometry().getCoordinates(),o=s.get("features"),a=$t(this,Mt,Jc).call(this,o.length,n,this.eoxMap.map.getView().getResolution()).reduce((l,c,d)=>{const u=new Point(c),_=new LineString([n,c]);l.unshift(new Style({geometry:_,stroke:new Stroke({color:"rgba(50, 50, 50, 0.5)",width:2.5})}));const f=new Feature({...o[d].getProperties()}),g=mt(this,Dc).call(this,f,this.eoxMap.map.getView().getResolution());return g!=null&&g.length&&g.forEach(m=>{const p=m.clone();p.setGeometry(u),l.unshift(p)}),l},[]);s.setStyle(a),Ht(this,Lc,s)},sd=function(s,n){const o=s.get("features"),a=$t(this,Mt,Jc).call(this,o.length,s.getGeometry().getCoordinates(),this.eoxMap.map.getView().getResolution());let l=1/0,c;for(let d=0,u=a.length;d<u;++d){const _=(n[0]-a[d][0])**2+(n[1]-a[d][1])**2;_<l&&(c=d,l=_)}return{feature:o[c],coords:a[c]}},Jc=function(s,n,o){let l=circleDistanceMultiplier*circleFootSeparation*(2+s)/(Math.PI*2);const c=Math.PI*2/s,d=[];let u;l=Math.max(l,35)*o;for(let _=0;_<s;++_)u=circleStartAngle+_*c,d.push([n[0]+l*Math.cos(u),n[1]+l*Math.sin(u)]);return d};function addClusterExplode(h,t,s){if(h.interactions[s.id])throw Error(`Interaction with id: ${s.id} already exists.`);const n=new EOxClusterExplodeInteraction(h,t,s);h.interactions[s.id]=n,h.map.addInteraction(n)}function generateTileGrid(h){let t;if(!(!h||!("tileGrid"in h))){if(h.type==="WMTS"){const n=get("EPSG:3857").getExtent(),o=getWidth(n)/128,a=new Array(19),l=new Array(19);for(let c=0;c<19;++c)a[c]=o/Math.pow(2,c),l[c]=c;t=new WMTSTileGrid({resolutions:a,origin:getTopLeft(n),projection:h.tileGrid.projection||"EPSG:3857",matrixIds:l,...h.tileGrid})}else t=createXYZ({...h.tileGrid});return t}}function getLayerById(h,t){return getFlatLayersArray(h.map.getLayers().getArray()).find(n=>n.get("id")===t)}function getFlatLayersArray(h){const t=[];t.push(...h);let s=t.filter(n=>n instanceof LayerGroup);for(;s.length;){const n=[];for(let o=0;o<s.length;o++){const a=s[o].getLayers().getArray();t.push(...a),n.push(...a.filter(l=>l instanceof LayerGroup))}s=n}return t}function animateToStateMethod(h){const t=Object.assign({},h.animationOptions),s=h.map.getView();if(cancelAnimation(s),!t||!Object.keys(t).length){s.setCenter(h.center),s.setZoom(h.zoom);return}t.center=getCenterFromProperty(h.center),t.zoom=h.zoom,s.animate(t)}const UNITS_PROP="units",LEADING_DIGITS=[1,2,5],DEFAULT_DPI=25.4/.28;class ScaleLine extends Control{constructor(t){t=t||{};const s=document.createElement("div");s.style.pointerEvents="none",super({element:s,render:t.render,target:t.target}),this.on,this.once,this.un;const n=t.className!==void 0?t.className:t.bar?"ol-scale-bar":"ol-scale-line";this.innerElement_=document.createElement("div"),this.innerElement_.className=n+"-inner",this.element.className=n+" "+CLASS_UNSELECTABLE,this.element.appendChild(this.innerElement_),this.viewState_=null,this.minWidth_=t.minWidth!==void 0?t.minWidth:64,this.maxWidth_=t.maxWidth,this.renderedVisible_=!1,this.renderedWidth_=void 0,this.renderedHTML_="",this.addChangeListener(UNITS_PROP,this.handleUnitsChanged_),this.setUnits(t.units||"metric"),this.scaleBar_=t.bar||!1,this.scaleBarSteps_=t.steps||4,this.scaleBarText_=t.text||!1,this.dpi_=t.dpi||void 0}getUnits(){return this.get(UNITS_PROP)}handleUnitsChanged_(){this.updateElement_()}setUnits(t){this.set(UNITS_PROP,t)}setDpi(t){this.dpi_=t}updateElement_(){const t=this.viewState_;if(!t){this.renderedVisible_&&(this.element.style.display="none",this.renderedVisible_=!1);return}const s=t.center,n=t.projection,o=this.getUnits(),a=o=="degrees"?"degrees":"m";let l=getPointResolution(n,t.resolution,s,a);const c=this.minWidth_*(this.dpi_||DEFAULT_DPI)/DEFAULT_DPI,d=this.maxWidth_!==void 0?this.maxWidth_*(this.dpi_||DEFAULT_DPI)/DEFAULT_DPI:void 0;let u=c*l,_="";if(o=="degrees"){const T=METERS_PER_UNIT.degrees;u*=T,u<T/60?(_="″",l*=3600):u<T?(_="′",l*=60):_="°"}else if(o=="imperial")u<.9144?(_="in",l/=.0254):u<1609.344?(_="ft",l/=.3048):(_="mi",l/=1609.344);else if(o=="nautical")l/=1852,_="NM";else if(o=="metric")u<1e-6?(_="nm",l*=1e9):u<.001?(_="μm",l*=1e6):u<1?(_="mm",l*=1e3):u<1e3?_="m":(_="km",l/=1e3);else if(o=="us")u<.9144?(_="in",l*=39.37):u<1609.344?(_="ft",l/=.30480061):(_="mi",l/=1609.3472);else throw new Error("Invalid units");let f=3*Math.floor(Math.log(c*l)/Math.log(10)),g,m,p,x=0,y,w;for(;;){p=Math.floor(f/3);const T=Math.pow(10,p);if(g=LEADING_DIGITS[(f%3+3)%3]*T,m=Math.round(g/l),isNaN(m)){this.element.style.display="none",this.renderedVisible_=!1;return}if(d!==void 0&&m>=d){g=x,m=y,p=w;break}else if(m>=c)break;x=g,y=m,w=p,++f}const C=this.scaleBar_?this.createScaleBar(m,g,_):g.toFixed(p<0?-p:0)+" "+_;this.renderedHTML_!=C&&(this.innerElement_.innerHTML=C,this.renderedHTML_=C),this.renderedWidth_!=m&&(this.innerElement_.style.width=m+"px",this.renderedWidth_=m),this.renderedVisible_||(this.element.style.display="",this.renderedVisible_=!0)}createScaleBar(t,s,n){const o=this.getScaleForResolution(),a=o<1?Math.round(1/o).toLocaleString()+" : 1":"1 : "+Math.round(o).toLocaleString(),l=this.scaleBarSteps_,c=t/l,d=[this.createMarker("absolute")];for(let _=0;_<l;++_){const f=_%2===0?"ol-scale-singlebar-odd":"ol-scale-singlebar-even";d.push(`<div><div class="ol-scale-singlebar ${f}" style="width: ${c}px;"></div>`+this.createMarker("relative")+(_%2===0||l===2?this.createStepText(_,t,!1,s,n):"")+"</div>")}return d.push(this.createStepText(l,t,!0,s,n)),(this.scaleBarText_?`<div class="ol-scale-text" style="width: ${t}px;">`+a+"</div>":"")+d.join("")}createMarker(t){return`<div class="ol-scale-step-marker" style="position: ${t}; top: ${t==="absolute"?3:-10}px;"></div>`}createStepText(t,s,n,o,a){const c=(t===0?0:Math.round(o/this.scaleBarSteps_*t*100)/100)+(t===0?"":" "+a),d=t===0?-3:s/this.scaleBarSteps_*-1,u=t===0?0:s/this.scaleBarSteps_*2;return`<div class="ol-scale-step-text" style="margin-left: ${d}px;text-align: ${t===0?"left":"center"};min-width: ${u}px;left: ${n?s+"px":"unset"};">`+c+"</div>"}getScaleForResolution(){const t=getPointResolution(this.viewState_.projection,this.viewState_.resolution,this.viewState_.center,"m"),s=this.dpi_||DEFAULT_DPI,n=1e3/25.4;return t*n*s}render(t){const s=t.frameState;s?this.viewState_=s.viewState:this.viewState_=null,this.updateElement_()}}const events=["fullscreenchange","webkitfullscreenchange"],FullScreenEventType={ENTERFULLSCREEN:"enterfullscreen",LEAVEFULLSCREEN:"leavefullscreen"};class FullScreen extends Control{constructor(t){t=t||{},super({element:document.createElement("div"),target:t.target}),this.on,this.once,this.un,this.keys_=t.keys!==void 0?t.keys:!1,this.source_=t.source,this.isInFullscreen_=!1,this.boundHandleMapTargetChange_=this.handleMapTargetChange_.bind(this),this.cssClassName_=t.className!==void 0?t.className:"ol-full-screen",this.documentListeners_=[],this.activeClassName_=t.activeClassName!==void 0?t.activeClassName.split(" "):[this.cssClassName_+"-true"],this.inactiveClassName_=t.inactiveClassName!==void 0?t.inactiveClassName.split(" "):[this.cssClassName_+"-false"];const s=t.label!==void 0?t.label:"⤢";this.labelNode_=typeof s=="string"?document.createTextNode(s):s;const n=t.labelActive!==void 0?t.labelActive:"×";this.labelActiveNode_=typeof n=="string"?document.createTextNode(n):n;const o=t.tipLabel?t.tipLabel:"Toggle full-screen";this.button_=document.createElement("button"),this.button_.title=o,this.button_.setAttribute("type","button"),this.button_.appendChild(this.labelNode_),this.button_.addEventListener(EventType$1.CLICK,this.handleClick_.bind(this),!1),this.setClassName_(this.button_,this.isInFullscreen_),this.element.className=`${this.cssClassName_} ${CLASS_UNSELECTABLE} ${CLASS_CONTROL}`,this.element.appendChild(this.button_)}handleClick_(t){t.preventDefault(),this.handleFullScreen_()}handleFullScreen_(){const t=this.getMap();if(!t)return;const s=t.getOwnerDocument();if(isFullScreenSupported(s))if(isFullScreen(s))exitFullScreen(s);else{let n;this.source_?n=typeof this.source_=="string"?s.getElementById(this.source_):this.source_:n=t.getTargetElement(),this.keys_?requestFullScreenWithKeys(n):requestFullScreen(n)}}handleFullScreenChange_(){const t=this.getMap();if(!t)return;const s=this.isInFullscreen_;this.isInFullscreen_=isFullScreen(t.getOwnerDocument()),s!==this.isInFullscreen_&&(this.setClassName_(this.button_,this.isInFullscreen_),this.isInFullscreen_?(replaceNode(this.labelActiveNode_,this.labelNode_),this.dispatchEvent(FullScreenEventType.ENTERFULLSCREEN)):(replaceNode(this.labelNode_,this.labelActiveNode_),this.dispatchEvent(FullScreenEventType.LEAVEFULLSCREEN)),t.updateSize())}setClassName_(t,s){s?(t.classList.remove(...this.inactiveClassName_),t.classList.add(...this.activeClassName_)):(t.classList.remove(...this.activeClassName_),t.classList.add(...this.inactiveClassName_))}setMap(t){const s=this.getMap();s&&s.removeChangeListener(MapProperty.TARGET,this.boundHandleMapTargetChange_),super.setMap(t),this.handleMapTargetChange_(),t&&t.addChangeListener(MapProperty.TARGET,this.boundHandleMapTargetChange_)}handleMapTargetChange_(){const t=this.documentListeners_;for(let n=0,o=t.length;n<o;++n)unlistenByKey(t[n]);t.length=0;const s=this.getMap();if(s){const n=s.getOwnerDocument();isFullScreenSupported(n)?this.element.classList.remove(CLASS_UNSUPPORTED):this.element.classList.add(CLASS_UNSUPPORTED);for(let o=0,a=events.length;o<a;++o)t.push(listen(n,events[o],this.handleFullScreenChange_,this));this.handleFullScreenChange_()}}}function isFullScreenSupported(h){const t=h.body;return!!(t.webkitRequestFullscreen||t.requestFullscreen&&h.fullscreenEnabled)}function isFullScreen(h){return!!(h.webkitIsFullScreen||h.fullscreenElement)}function requestFullScreen(h){h.requestFullscreen?h.requestFullscreen():h.webkitRequestFullscreen&&h.webkitRequestFullscreen()}function requestFullScreenWithKeys(h){h.webkitRequestFullscreen?h.webkitRequestFullscreen():requestFullScreen(h)}function exitFullScreen(h){h.exitFullscreen?h.exitFullscreen():h.webkitExitFullscreen&&h.webkitExitFullscreen()}const Direction={VERTICAL:0,HORIZONTAL:1};class ZoomSlider extends Control{constructor(t){t=t||{},super({target:t.target,element:document.createElement("div"),render:t.render}),this.dragListenerKeys_=[],this.currentResolution_=void 0,this.direction_=Direction.VERTICAL,this.dragging_,this.heightLimit_=0,this.widthLimit_=0,this.startX_,this.startY_,this.thumbSize_=null,this.sliderInitialized_=!1,this.duration_=t.duration!==void 0?t.duration:200;const s=t.className!==void 0?t.className:"ol-zoomslider",n=document.createElement("button");n.setAttribute("type","button"),n.className=s+"-thumb "+CLASS_UNSELECTABLE;const o=this.element;o.className=s+" "+CLASS_UNSELECTABLE+" "+CLASS_CONTROL,o.appendChild(n),o.addEventListener(EventType.POINTERDOWN,this.handleDraggerStart_.bind(this),!1),o.addEventListener(EventType.POINTERMOVE,this.handleDraggerDrag_.bind(this),!1),o.addEventListener(EventType.POINTERUP,this.handleDraggerEnd_.bind(this),!1),o.addEventListener(EventType$1.CLICK,this.handleContainerClick_.bind(this),!1),n.addEventListener(EventType$1.CLICK,stopPropagation,!1)}setMap(t){super.setMap(t),t&&t.render()}initSlider_(){const t=this.element;let s=t.offsetWidth,n=t.offsetHeight;if(s===0&&n===0)return this.sliderInitialized_=!1;const o=getComputedStyle(t);s-=parseFloat(o.paddingRight)+parseFloat(o.paddingLeft),n-=parseFloat(o.paddingTop)+parseFloat(o.paddingBottom);const a=t.firstElementChild,l=getComputedStyle(a),c=a.offsetWidth+parseFloat(l.marginRight)+parseFloat(l.marginLeft),d=a.offsetHeight+parseFloat(l.marginTop)+parseFloat(l.marginBottom);return this.thumbSize_=[c,d],s>n?(this.direction_=Direction.HORIZONTAL,this.widthLimit_=s-c):(this.direction_=Direction.VERTICAL,this.heightLimit_=n-d),this.sliderInitialized_=!0}handleContainerClick_(t){const s=this.getMap().getView(),n=this.getRelativePosition_(t.offsetX-this.thumbSize_[0]/2,t.offsetY-this.thumbSize_[1]/2),o=this.getResolutionForPosition_(n),a=s.getConstrainedZoom(s.getZoomForResolution(o));s.animateInternal({zoom:a,duration:this.duration_,easing:easeOut})}handleDraggerStart_(t){if(!this.dragging_&&t.target===this.element.firstElementChild){const s=this.element.firstElementChild;if(this.getMap().getView().beginInteraction(),this.startX_=t.clientX-parseFloat(s.style.left),this.startY_=t.clientY-parseFloat(s.style.top),this.dragging_=!0,this.dragListenerKeys_.length===0){const n=this.handleDraggerDrag_,o=this.handleDraggerEnd_,a=this.getMap().getOwnerDocument();this.dragListenerKeys_.push(listen(a,EventType.POINTERMOVE,n,this),listen(a,EventType.POINTERUP,o,this))}}}handleDraggerDrag_(t){if(this.dragging_){const s=t.clientX-this.startX_,n=t.clientY-this.startY_,o=this.getRelativePosition_(s,n);this.currentResolution_=this.getResolutionForPosition_(o),this.getMap().getView().setResolution(this.currentResolution_)}}handleDraggerEnd_(t){this.dragging_&&(this.getMap().getView().endInteraction(),this.dragging_=!1,this.startX_=void 0,this.startY_=void 0,this.dragListenerKeys_.forEach(unlistenByKey),this.dragListenerKeys_.length=0)}setThumbPosition_(t){const s=this.getPositionForResolution_(t),n=this.element.firstElementChild;this.direction_==Direction.HORIZONTAL?n.style.left=this.widthLimit_*s+"px":n.style.top=this.heightLimit_*s+"px"}getRelativePosition_(t,s){let n;return this.direction_===Direction.HORIZONTAL?n=t/this.widthLimit_:n=s/this.heightLimit_,clamp(n,0,1)}getResolutionForPosition_(t){return this.getMap().getView().getResolutionForValueFunction()(1-t)}getPositionForResolution_(t){const s=this.getMap().getView().getValueForResolutionFunction();return clamp(1-s(t),0,1)}render(t){if(!t.frameState||!this.sliderInitialized_&&!this.initSlider_())return;const s=t.frameState.viewState.resolution;this.currentResolution_=s,this.setThumbPosition_(s)}}const MAX_RATIO=.75,MIN_RATIO=.1;class OverviewMap extends Control{constructor(t){t=t||{},super({element:document.createElement("div"),render:t.render,target:t.target}),this.boundHandleRotationChanged_=this.handleRotationChanged_.bind(this),this.collapsed_=t.collapsed!==void 0?t.collapsed:!0,this.collapsible_=t.collapsible!==void 0?t.collapsible:!0,this.collapsible_||(this.collapsed_=!1),this.rotateWithView_=t.rotateWithView!==void 0?t.rotateWithView:!1,this.viewExtent_=void 0;const s=t.className!==void 0?t.className:"ol-overviewmap",n=t.tipLabel!==void 0?t.tipLabel:"Overview map",o=t.collapseLabel!==void 0?t.collapseLabel:"‹";typeof o=="string"?(this.collapseLabel_=document.createElement("span"),this.collapseLabel_.textContent=o):this.collapseLabel_=o;const a=t.label!==void 0?t.label:"›";typeof a=="string"?(this.label_=document.createElement("span"),this.label_.textContent=a):this.label_=a;const l=this.collapsible_&&!this.collapsed_?this.collapseLabel_:this.label_,c=document.createElement("button");c.setAttribute("type","button"),c.title=n,c.appendChild(l),c.addEventListener(EventType$1.CLICK,this.handleClick_.bind(this),!1),this.ovmapDiv_=document.createElement("div"),this.ovmapDiv_.className="ol-overviewmap-map",this.view_=t.view;const d=new Map$1({view:t.view,controls:new Collection,interactions:new Collection});this.ovmap_=d,t.layers&&t.layers.forEach(function(w){d.addLayer(w)});const u=document.createElement("div");u.className="ol-overviewmap-box",u.style.boxSizing="border-box",this.boxOverlay_=new Overlay({position:[0,0],positioning:"center-center",element:u}),this.ovmap_.addOverlay(this.boxOverlay_);const _=s+" "+CLASS_UNSELECTABLE+" "+CLASS_CONTROL+(this.collapsed_&&this.collapsible_?" "+CLASS_COLLAPSED:"")+(this.collapsible_?"":" ol-uncollapsible"),f=this.element;f.className=_,f.appendChild(this.ovmapDiv_),f.appendChild(c);const g=this.boxOverlay_,m=this.boxOverlay_.getElement(),p=w=>({clientX:w.clientX,clientY:w.clientY}),x=function(w){const C=p(w),T=d.getEventCoordinate(C);g.setPosition(T)},y=w=>{const C=d.getEventCoordinateInternal(w),T=this.getMap();T.getView().setCenterInternal(C);const P=T.getOwnerDocument();P.removeEventListener("pointermove",x),P.removeEventListener("pointerup",y)};this.ovmapDiv_.addEventListener("pointerdown",w=>{const C=this.getMap().getOwnerDocument();w.target===m&&C.addEventListener("pointermove",x),C.addEventListener("pointerup",y)})}setMap(t){const s=this.getMap();if(t!==s){if(s){const n=s.getView();n&&this.unbindView_(n),this.ovmap_.setTarget(null)}if(super.setMap(t),t){this.ovmap_.setTarget(this.ovmapDiv_),this.listenerKeys.push(listen(t,ObjectEventType.PROPERTYCHANGE,this.handleMapPropertyChange_,this));const n=t.getView();n&&this.bindView_(n),this.ovmap_.isRendered()||this.updateBoxAfterOvmapIsRendered_()}}}handleMapPropertyChange_(t){if(t.key===MapProperty.VIEW){const s=t.oldValue;s&&this.unbindView_(s);const n=this.getMap().getView();this.bindView_(n)}else!this.ovmap_.isRendered()&&(t.key===MapProperty.TARGET||t.key===MapProperty.SIZE)&&this.ovmap_.updateSize()}bindView_(t){if(!this.view_){const s=new View({projection:t.getProjection()});this.ovmap_.setView(s)}t.addChangeListener(ViewProperty.ROTATION,this.boundHandleRotationChanged_),this.handleRotationChanged_(),t.isDef()&&(this.ovmap_.updateSize(),this.resetExtent_())}unbindView_(t){t.removeChangeListener(ViewProperty.ROTATION,this.boundHandleRotationChanged_)}handleRotationChanged_(){this.rotateWithView_&&this.ovmap_.getView().setRotation(this.getMap().getView().getRotation())}validateExtent_(){const t=this.getMap(),s=this.ovmap_;if(!t.isRendered()||!s.isRendered())return;const n=t.getSize(),a=t.getView().calculateExtentInternal(n);if(this.viewExtent_&&equals$1(a,this.viewExtent_))return;this.viewExtent_=a;const l=s.getSize(),d=s.getView().calculateExtentInternal(l),u=s.getPixelFromCoordinateInternal(getTopLeft(a)),_=s.getPixelFromCoordinateInternal(getBottomRight(a)),f=Math.abs(u[0]-_[0]),g=Math.abs(u[1]-_[1]),m=l[0],p=l[1];f<m*MIN_RATIO||g<p*MIN_RATIO||f>m*MAX_RATIO||g>p*MAX_RATIO?this.resetExtent_():containsExtent(d,a)||this.recenter_()}resetExtent_(){const t=this.getMap(),s=this.ovmap_,n=t.getSize(),a=t.getView().calculateExtentInternal(n),l=s.getView(),c=Math.log(MAX_RATIO/MIN_RATIO)/Math.LN2,d=1/(Math.pow(2,c/2)*MIN_RATIO);scaleFromCenter(a,d),l.fitInternal(fromExtent(a))}recenter_(){const t=this.getMap(),s=this.ovmap_,n=t.getView();s.getView().setCenterInternal(n.getCenterInternal())}updateBox_(){const t=this.getMap(),s=this.ovmap_;if(!t.isRendered()||!s.isRendered())return;const n=t.getSize(),o=t.getView(),a=s.getView(),l=this.rotateWithView_?0:-o.getRotation(),c=this.boxOverlay_,d=this.boxOverlay_.getElement(),u=o.getCenter(),_=o.getResolution(),f=a.getResolution(),g=n[0]*_/f,m=n[1]*_/f;if(c.setPosition(u),d){d.style.width=g+"px",d.style.height=m+"px";const p="rotate("+l+"rad)";d.style.transform=p}}updateBoxAfterOvmapIsRendered_(){this.ovmapPostrenderKey_||(this.ovmapPostrenderKey_=listenOnce(this.ovmap_,MapEventType.POSTRENDER,t=>{delete this.ovmapPostrenderKey_,this.updateBox_()}))}handleClick_(t){t.preventDefault(),this.handleToggle_()}handleToggle_(){this.element.classList.toggle(CLASS_COLLAPSED),this.collapsed_?replaceNode(this.collapseLabel_,this.label_):replaceNode(this.label_,this.collapseLabel_),this.collapsed_=!this.collapsed_;const t=this.ovmap_;if(!this.collapsed_){if(t.isRendered()){this.viewExtent_=void 0,t.render();return}t.updateSize(),this.resetExtent_(),this.updateBoxAfterOvmapIsRendered_()}}getCollapsible(){return this.collapsible_}setCollapsible(t){this.collapsible_!==t&&(this.collapsible_=t,this.element.classList.toggle("ol-uncollapsible"),!t&&this.collapsed_&&this.handleToggle_())}setCollapsed(t){!this.collapsible_||this.collapsed_===t||this.handleToggle_()}getCollapsed(){return this.collapsed_}getRotateWithView(){return this.rotateWithView_}setRotateWithView(t){this.rotateWithView_!==t&&(this.rotateWithView_=t,this.getMap().getView().getRotation()!==0&&(this.rotateWithView_?this.handleRotationChanged_():this.ovmap_.getView().setRotation(0),this.viewExtent_=void 0,this.validateExtent_(),this.updateBox_()))}getOverviewMap(){return this.ovmap_}render(t){this.validateExtent_(),this.updateBox_()}}class ZoomToExtent extends Control{constructor(t){t=t||{},super({element:document.createElement("div"),target:t.target}),this.extent=t.extent?t.extent:null,this.fitOptions=t.fitOptions||{};const s=t.className!==void 0?t.className:"ol-zoom-extent",n=t.label!==void 0?t.label:"E",o=t.tipLabel!==void 0?t.tipLabel:"Fit to extent",a=document.createElement("button");a.setAttribute("type","button"),a.title=o,a.appendChild(typeof n=="string"?document.createTextNode(n):n),a.addEventListener(EventType$1.CLICK,this.handleClick_.bind(this),!1);const l=s+" "+CLASS_UNSELECTABLE+" "+CLASS_CONTROL,c=this.element;c.className=l,c.appendChild(a)}handleClick_(t){t.preventDefault(),this.handleZoomToExtent()}handleZoomToExtent(){const s=this.getMap().getView(),n=this.extent?fromUserExtent(this.extent,s.getProjection()):s.getProjection().getExtent();s.fitInternal(fromExtent(n),this.fitOptions)}}const PROJECTION="projection",COORDINATE_FORMAT="coordinateFormat";class MousePosition extends Control{constructor(t){t=t||{};const s=document.createElement("div");s.className=t.className!==void 0?t.className:"ol-mouse-position",super({element:s,render:t.render,target:t.target}),this.on,this.once,this.un,this.addChangeListener(PROJECTION,this.handleProjectionChanged_),t.coordinateFormat&&this.setCoordinateFormat(t.coordinateFormat),t.projection&&this.setProjection(t.projection),this.renderOnMouseOut_=t.placeholder!==void 0,this.placeholder_=this.renderOnMouseOut_?t.placeholder:"&#160;",this.renderedHTML_=s.innerHTML,this.mapProjection_=null,this.transform_=null,this.wrapX_=t.wrapX!==!1}handleProjectionChanged_(){this.transform_=null}getCoordinateFormat(){return this.get(COORDINATE_FORMAT)}getProjection(){return this.get(PROJECTION)}handleMouseMove(t){const s=this.getMap();this.updateHTML_(s.getEventPixel(t))}handleMouseOut(t){this.updateHTML_(null)}setMap(t){if(super.setMap(t),t){const s=t.getViewport();this.listenerKeys.push(listen(s,EventType.POINTERMOVE,this.handleMouseMove,this)),this.renderOnMouseOut_&&this.listenerKeys.push(listen(s,EventType.POINTEROUT,this.handleMouseOut,this)),this.updateHTML_(null)}}setCoordinateFormat(t){this.set(COORDINATE_FORMAT,t)}setProjection(t){this.set(PROJECTION,get(t))}updateHTML_(t){let s=this.placeholder_;if(t&&this.mapProjection_){if(!this.transform_){const a=this.getProjection();a?this.transform_=getTransformFromProjections(this.mapProjection_,a):this.transform_=identityTransform}const o=this.getMap().getCoordinateFromPixelInternal(t);if(o){if(this.transform_(o,o),this.wrapX_){const l=this.getProjection()||this.mapProjection_;wrapX(o,l)}const a=this.getCoordinateFormat();a?s=a(o):s=o.toString()}}(!this.renderedHTML_||s!==this.renderedHTML_)&&(this.element.innerHTML=s,this.renderedHTML_=s)}render(t){const s=t.frameState;s?this.mapProjection_!=s.viewState.projection&&(this.mapProjection_=s.viewState.projection,this.transform_=null):this.mapProjection_=null}}class GeolocationControl extends Control{constructor(t){const s=t||{},n=document.createElement("div");n.className="geolocation ol-unselectable ol-control";const o=document.createElement("button");o.title="Show your location",o.innerHTML=s.buttonIcon?`
      <img src="${s.buttonIcon}" alt="Geolocation" />
    `:`
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><title>crosshairs-gps</title><path d="M12,8A4,4 0 0,1 16,12A4,4 0 0,1 12,16A4,4 0 0,1 8,12A4,4 0 0,1 12,8M3.05,13H1V11H3.05C3.5,6.83 6.83,3.5 11,3.05V1H13V3.05C17.17,3.5 20.5,6.83 20.95,11H23V13H20.95C20.5,17.17 17.17,20.5 13,20.95V23H11V20.95C6.83,20.5 3.5,17.17 3.05,13M12,5A7,7 0 0,0 5,12A7,7 0 0,0 12,19A7,7 0 0,0 19,12A7,7 0 0,0 12,5Z" /></svg>
    `,n.appendChild(o),super({element:n}),this._centerWhenReady=s.centerWhenReady,this._highAccuracy=s.highAccuracy,this._trackAccuracy=s.trackAccuracy,this._trackHeading=s.trackHeading,this._positionFeature=new Feature({geometry:new Point([NaN,NaN]),heading:0}),this._source=new VectorSource({features:[this._positionFeature]}),this._trackAccuracy&&(this._accuracyFeature=new Feature,this._accuracyFeature.setStyle(new Style({fill:new Fill({color:"rgba(0, 0, 0, 0.2)"}),stroke:new Stroke({width:2,color:"rgba(0, 0, 0, 0.7)"})})),this._source.addFeature(this._accuracyFeature)),this._layer=new VectorLayer({source:this._source}),s.style&&this._layer.setStyle(s.style),o.addEventListener("click",this.centerOnPosition.bind(this),!1)}setMap(t){this._layer.setMap(t),super.setMap(t),t&&this._centerWhenReady&&this.initGeolocation()}initGeolocation(){return new Promise((t,s)=>{const n=this.getMap();n&&(this._geolocation=new Geolocation({tracking:!0,trackingOptions:{enableHighAccuracy:this._highAccuracy},projection:n.getView().getProjection()})),this._centerWhenReady&&this._geolocation.once("change:position",o=>{n.getView().setCenter(o.target.getPosition())}),this._geolocation.on("error",o=>s(o)),this._geolocation.on("change:accuracyGeometry",()=>{this._trackAccuracy&&this._accuracyFeature.setGeometry(this._geolocation.getAccuracyGeometry())}),this._geolocation.on("change:heading",o=>{this._trackHeading&&this._highAccuracy&&this._positionFeature.set("heading",o.target.getHeading())}),this._geolocation.on("change:position",()=>{const o=this._geolocation.getPosition();this._positionFeature.getGeometry().setCoordinates(o||null),t(o)})})}getElement(){return this.element}async centerOnPosition(){var t,s;try{await this.initGeolocation();const n=(t=this._geolocation)==null?void 0:t.getPosition();n&&((s=this.getMap())==null||s.getView().setCenter(n))}catch(n){console.error(n)}}}class LoadingIndicatorControl extends Control{constructor(t){const s=t||{};s.opacity===void 0&&(s.opacity=1),s.type===void 0&&(s.type="small");const n=document.createElement("div");n.className="LoadingIndicator ol-unselectable ol-control",n.classList.add("loading-indicator"),n.style.opacity=String(s.opacity),s.spinnerSvg?n.innerHTML=s.spinnerSvg:n.innerHTML=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid" width="50" height="50" style="shape-rendering: auto; display: block; background: transparent;" xmlns:xlink="http://www.w3.org/1999/xlink"><g><circle stroke-dasharray="164.93361431346415 56.97787143782138" r="35" stroke-width="12" stroke="#1a467c" fill="none" cy="50" cx="50">
      <animateTransform keyTimes="0;1" values="0 50 50;360 50 50" dur="1.2222222222222223s" repeatCount="indefinite" type="rotate" attributeName="transform"></animateTransform>
      </circle></g></svg>`,s.type==="fullscreen"?n.classList.add("fullscreen"):n.classList.add("small"),super({element:n})}setMap(t){super.setMap(t),t&&(t.on("loadstart",()=>{this.getElement().style.visibility="visible"}),t.on("loadend",()=>{this.getElement().style.visibility="hidden"}))}getElement(){return this.element}}const availableControls={Zoom,Rotate,ScaleLine,FullScreen,ZoomSlider,Attribution,OverviewMap,ZoomToExtent,MousePosition,Geolocation:GeolocationControl,LoadingIndicator:LoadingIndicatorControl};function addOrUpdateControl(h,t,s,n){t&&t[s]?serialize(t[s])!==serialize(n)&&(h.removeControl(s),addControl(h,s,n)):addControl(h,s,n)}function addControl(h,t,s){const n=Object.assign({},s);s&&s.layers&&(n.layers=generateLayers(h,s.layers));const o=new availableControls[t](n);h.map.addControl(o),h.mapControls[t]=o}function setCenterMethod(h,t){let s;const n=(h==null?void 0:h.length)&&coordinatesRoughlyEquals(h,t.map.getView().getCenter());return h&&!n&&(!t.projection||t.projection==="EPSG:3857"?s=getCenterFromProperty(h):s=h),s}function setZoomExtentMethod(h,t){if(!h||!h.length)return;const s=t.map.getView();return cancelAnimation(s),setTimeout(()=>s.fit(h,t.animationOptions),0),h}function setControlsMethod(h,t,s){const n=h;if(t){const o=Object.keys(t),a=Object.keys(n);for(let l=0,c=o.length;l<c;l++){const d=o[l];a.includes(d)||s.removeControl(d)}}if(n){const o=Object.keys(h);for(let a=0,l=o.length;a<l;a++){const c=o[a];addOrUpdateControl(s,t,c,h[c])}}return n}function setLayersMethod(layers,oldLayers,EOxMap){const newLayers=eval("("+serialize(layers)+")");oldLayers&&oldLayers.forEach(h=>{var t,s;if(!((t=h.properties)!=null&&t.id)||!newLayers.find(n=>n.properties.id===h.properties.id)){const n=getLayerById(EOxMap,(s=h.properties)==null?void 0:s.id),a=n.get("_jsonDefinition").interactions;a==null||a.forEach(l=>{l.type==="select"?EOxMap.removeSelect(l.options.id):EOxMap.removeInteraction(l.options.id)}),EOxMap.map.removeLayer(n)}}),newLayers.forEach(h=>{EOxMap.addOrUpdateLayer(h)});const sortedIds=newLayers.map(h=>{var t;return(t=h.properties)==null?void 0:t.id});EOxMap.map.getLayers().getArray().sort((h,t)=>sortedIds.indexOf(h.get("id"))-sortedIds.indexOf(t.get("id")));let minMax=EOxMap.map.getLayers().getArray().reduce((h,t)=>{var s,n,o,a,l,c,d,u;return h.maxZoom=(n=(s=EOxMap.config)==null?void 0:s.view)!=null&&n.maxZoom?(a=(o=EOxMap.config)==null?void 0:o.view)==null?void 0:a.maxZoom:h.maxZoom===void 0||t.get("maxZoom")<h.maxZoom?t.get("maxZoom"):h.maxZoom,h.minZoom=(c=(l=EOxMap.config)==null?void 0:l.view)!=null&&c.minZoom?(u=(d=EOxMap.config)==null?void 0:d.view)==null?void 0:u.minZoom:h.minZoom===void 0||t.get("minZoom")>h.minZoom?t.get("minZoom"):h.minZoom,h},{minZoom:0,maxZoom:1/0});EOxMap.map.getLayers().getArray().map(h=>h.setMinZoom(h.get("minZoom")-1e-12));const currentMinZoom=EOxMap.map.getView().getMinZoom(),currentMaxZoom=EOxMap.map.getView().getMaxZoom();return currentMinZoom!==minMax.minZoom&&EOxMap.map.getView().setMinZoom(minMax.minZoom>=0?minMax.minZoom:0),currentMaxZoom!==minMax.maxZoom&&EOxMap.map.getView().setMaxZoom(minMax.maxZoom),EOxMap.map.on("moveend",()=>{var s;if(!((s=EOxMap==null?void 0:EOxMap.controls)!=null&&s.Zoom))return;const h=EOxMap.renderRoot.querySelector("button.ol-zoom-out"),t=EOxMap.renderRoot.querySelector("button.ol-zoom-in");EOxMap.map.getView().getZoom()>=minMax.maxZoom?t==null||t.classList.add("disabled"):t==null||t.classList.remove("disabled"),EOxMap.map.getView().getZoom()-1e-12<=minMax.minZoom?h==null||h.classList.add("disabled"):h==null||h.classList.remove("disabled")}),newLayers}function setPreventScrollMethod(h,t){return h?(removeDefaultScrollInteractions(t.map),addScrollInteractions(t.map,!0)):addScrollInteractions(t.map),h}function setConfigMethod(h,t){var s,n,o,a,l,c,d,u;return Object.assign(t,{...(h==null?void 0:h.animationOptions)!==void 0?{animationOptions:h.animationOptions}:{},projection:((s=h==null?void 0:h.view)==null?void 0:s.projection)||"EPSG:3857",layers:(h==null?void 0:h.layers)||[],controls:(h==null?void 0:h.controls)||{},...(h==null?void 0:h.preventScroll)!==void 0&&t.preventScroll===void 0?{preventScroll:h==null?void 0:h.preventScroll}:{},zoom:((n=h==null?void 0:h.view)==null?void 0:n.zoom)||0,center:((o=h==null?void 0:h.view)==null?void 0:o.center)||[0,0],zoomExtent:(a=h==null?void 0:h.view)==null?void 0:a.zoomExtent}),(l=h==null?void 0:h.view)!=null&&l.minZoom&&t.map.getView().setMinZoom((c=h==null?void 0:h.view)==null?void 0:c.minZoom),(d=h==null?void 0:h.view)!=null&&d.maxZoom&&t.map.getView().setMaxZoom((u=h==null?void 0:h.view)==null?void 0:u.maxZoom),h}function setProjectionMethod(h,t,s){let n=t;const o=s.map.getView();if(h&&get(h)&&h!==o.getProjection().getCode()){const a=transform$1(o.getCenter(),o.getProjection().getCode(),h),l=get(h),c=o.getResolution(),d=o.getProjection().getMetersPerUnit(),u=l.getMetersPerUnit(),_=getPointResolution(o.getProjection(),1/d,o.getCenter(),"m")*d,f=getPointResolution(l,1/u,a,"m")*u,g=c*_/f,m=new View({zoom:o.getZoom(),center:a,resolution:g,rotation:o.getRotation(),projection:h});["change:center","change:resolution","change:rotation","propertychange"].forEach(x=>{const y=o.getListeners(x);if(y!=null&&y.length)for(let w=y.length-1;w>=0;w--){const C=y[w];o.un(x,C),m.on(x,C)}}),s.map.setView(m),s.getFlatLayersArray(s.map.getLayers().getArray()).filter(x=>x instanceof VectorLayer).forEach(x=>x.getSource().refresh()),n=h,s.center=a}return n}function setSyncMethod(h,t){return h&&setTimeout(()=>{const s=getElement(h);s&&(t.clientHeight<1&&!s.zoom?s.map.setView(t.map.getView()):t.map.setView(s.map.getView()))}),h}function getLonLatCenterMethod(h){var t;if(h.projection==="globe"){const s=(t=h.globe)==null?void 0:t.planet.camera.getLonLat();return[(s==null?void 0:s.lon)??0,(s==null?void 0:s.lat)??0]}return h.projection==="EPSG:4326"?h.map.getView().getCenter():transform(h.map.getView().getCenter(),h.projection)}function getLonLatExtentMethod(h){var s;if(h.projection==="globe"){const n=(s=h.globe)==null?void 0:s.planet.camera.getLonLat();if(!n||typeof n.height>"u")return[-180,-90,180,90];const o=Math.log2(2705e4/n.height)+1,a=[n.lon,n.lat],l=new View({zoom:o,center:transform(a,"EPSG:4326",h.projection),projection:h.projection});return l.setCenter(transform(a,"EPSG:4326",h.projection)),transformExtent(l.calculateExtent(h.map.getSize()),h.projection)}const t=h.map.getView().calculateExtent(h.map.getSize());return h.projection==="EPSG:4326"?t:transformExtent(t,h.projection)}function getZoomExtentMethod(h){return h.map.getView().calculateExtent(h.map.getSize())}function addOrUpdateLayerMethod(h,t){var a;h.interactions||(h.interactions=[]);const s=(a=h.properties)==null?void 0:a.id,n=s?getLayerById(t,s):!1;let o;return n?(updateLayer(t,h,n),o=n):(o=createLayer(t,h),t.map.addLayer(o)),o}function removeInteractionMethod(h,t){t.map.removeInteraction(t.interactions[h]),delete t.interactions[h],t.interactions[`${h}_modify`]&&(t.map.removeInteraction(t.interactions[`${h}_modify`]),delete t.interactions[`${h}_modify`])}function removeSelectMethod(h,t){t.selectInteractions[h].remove(),delete t.selectInteractions[h]}function removeControlMethod(h,t){t.map.removeControl(t.mapControls[h]),delete t.mapControls[h]}function firstUpdatedMethod(h,t){t.map.once("change:target",n=>{n.target.getView().setCenter(t.center)});const s=t.renderRoot.querySelector("div#map");t.map.setTarget(s),h?t.map.getView().fit(h,t.animationOptions):animateToStateMethod(t),t.map.on("loadend",()=>{t.dispatchEvent(new CustomEvent("loadend",{detail:t.map}))}),t.dispatchEvent(new CustomEvent("mapmounted",{detail:t.map}))}const Xi=2*Math.PI,vo=Math.PI/2,or=Number.MAX_VALUE||17976931348623157e292,pn=Math.log(2),Ae=2147483647,xt=549755748352,Ct=-549755748352,j=Math.PI/180,J=180/Math.PI,Gr=2*J,Qt=.5*j,yo=Math.sqrt(.5),xo=1e-5,ne=1e-10,ar=1e-12,lr=1e-14;function Zi(h,t,s){return Math.max(t,Math.min(h,s))}function Ki(h){return!(h&h-1)}function $e(h,t=4096){--h;for(let s=1;s<32;s<<=1)h|=h>>s;return h+1>t?t:h+1}function Ni(h=0,t=1){return Math.floor(Math.random()*(t-h))+h}function bo(h,t){return(h%t+t)%t}function Ue(h){const t=bo(h,Xi);return Math.abs(t)<lr&&Math.abs(h)>lr?Xi:t}function si(h){const t=Math.abs(h);return t-Math.floor(t)}function wo(h,t,s){return s+h*(t-s)}function Hs(h){return h*h*h}function Vs(h){return h*h}function hr(h){return h-360*Math.floor(h/360)}Object.freeze(Object.defineProperty({__proto__:null,ARCSECONDS_TO_RADIANS:484813681109536e-20,DEG2RAD:function(h){return h*j},DEGREES:J,DEGREES_DOUBLE:Gr,DEGREES_TO_HOURS:1/15,EPS1:.1,EPS10:ne,EPS11:1e-11,EPS12:ar,EPS13:1e-13,EPS14:lr,EPS15:1e-15,EPS16:1e-16,EPS17:1e-17,EPS18:1e-18,EPS19:1e-19,EPS2:.01,EPS20:1e-20,EPS3:.001,EPS4:1e-4,EPS5:xo,EPS6:1e-6,EPS7:1e-7,EPS8:1e-8,EPS9:1e-9,HOURS_TO_DEGREES:15,HOURS_TO_RADIANS:.26179938779914946,LOG2:pn,MAX:xt,MAX32:Ae,MAX_FLOAT:or,MIN:Ct,PI_TWO:vo,RAD2DEG:function(h){return h*J},RADIANS:j,RADIANS_HALF:Qt,RADIANS_TO_HOURS:3.819718634205488,SQRT_HALF:yo,TWO_PI:Xi,W:3,X:0,Y:1,Z:2,bezier1v:function(h,t,s,n,o){return Hs(1-h)*t+3*Vs(1-h)*h*s+3*(1-h)*Vs(h)*n+Hs(h)*o},bezier3v:function(h,t,s,n,o){let a=1-h,l=h*h,c=a*a,d=c*a,u=l*h;return t.scaleTo(d).addA(s.scaleTo(3*c*h)).addA(n.scaleTo(3*a*l)).addA(o.scaleTo(u))},clamp:Zi,cube:Hs,degToDec:function(h,t,s,n){return n?h+t/60+s/3600:-h-t/60-s/3600},exp2:function(h){return Math.pow(2,h)},frac:si,getAngleBetweenAzimuths:function(h,t){return(((h=Ue(h))-(t=Ue(t)))%360+360+180)%360-180},isPowerOfTwo:Ki,lerp:wo,log:function(h,t){return Math.log(h)/Math.log(t)},log2:function(h){return Math.log(h)/pn},mod:bo,negativePItoPI:function(h){return Ue(h+Math.PI)-Math.PI},nextHighestPowerOfTwo:$e,norm_lon:function(h){return h>180?(h+180)%360-180:h<-180?(h-180)%360+180:h},pow2i:function(h){return 2<<h-1},random:function(h=0,t=1){return Math.random()*(t-h)+h},randomi:Ni,rev:hr,slice:function(h,t,s){return h*(t-s)},solve_iteration:function(h,t,s,n=50){let o=0,a=t;for(let l=0;l<n;l++)if(o=a,a=h(o),Math.abs(a-o)<s)return a;return a},solve_iteration_fixed:function(h,t,s){let n=0,o=t;for(let a=0;a<s;a++)n=o,o=h(n);return o},square:Vs,step:function(h,t){return t<h?0:1},zeroTwoPI:Ue},Symbol.toStringTag,{value:"Module"}));const Ba=.5*Math.PI,To=180/Math.PI,ka=2*To,Us=Math.PI/360,Ia=To*Ba;class L{constructor(t=0,s=0,n=0){this.lon=0,this.lat=0,this.height=0,this.lon=t,this.lat=s,this.height=n}isZero(){return this.lon===0&&this.lat===0&&this.height===0}static join(t){let s=[];for(let n=0;n<t.length;n++){let o=t[n];s[n]=new L(o[0],o[1],o[2])}return s}static createFromArray(t){return new L(t[0],t[1],t[2])}static toArray(t){return[t.lon,t.lat,t.height]}toArray(){return L.toArray(this)}static forwardMercator(t,s,n){return new L(t*Hi,Math.log(Math.tan((90+s)*Us))*We,n)}static forwardMercatorRes(t,s){return s.lon=t.lon*Hi,s.lat=Math.log(Math.tan((90+t.lat)*Us))*We,s.height=t.height,s}static inverseMercator(t,s,n=0){return new L(t*Co,ka*Math.atan(Math.exp(s*jr))-Ia,n)}set(t=0,s=0,n=0){return this.lon=t,this.lat=s,this.height=n,this}copy(t){return this.lon=t.lon,this.lat=t.lat,this.height=t.height,this}clone(){return new L(this.lon,this.lat,this.height)}forwardMercator(){return L.forwardMercator(this.lon,this.lat,this.height)}forwardMercatorEPS01(){let t=this.lat;return t>89.9?t=89.9:t<-89.9&&(t=-89.9),new L(this.lon*Hi,Math.log(Math.tan((90+t)*Us))*We)}inverseMercator(){return L.inverseMercator(this.lon,this.lat,this.height)}equal(t){return t.height?this.lon===t.lon&&this.lat===t.lat&&this.height===t.height:this.lon===t.lon&&this.lat===t.lat}}const Lt=2003750834e-2,Qi=2*Lt,jr=Math.PI/Lt,We=Lt/Math.PI,za=.5*Math.PI,Hi=Lt/180,Co=180/Lt,Eo=Math.PI/360,mn=Math.PI/180,Da=180/Math.PI,Ao=2*Lt,ri=1/Ao;function Ji(h){return new L(h.lon*Lt/180,Math.log(Math.tan((90+h.lat)*Eo))*We,h.height)}function ni(h){return h*Lt/180}function oi(h){return Math.log(Math.tan((90+h)*Eo))*We}function Lo(h){return Da*(2*Math.atan(Math.exp(h*jr))-za)}function Ze(h,t,s){let n=Qi/(1<<s),o=new L(h*n-2003750834e-2,Lt-t*n-n);return new U(o,new L(o.lon+n,o.lat+n))}const ct=Lo(Lt),Ot=-ct;Object.freeze(Object.defineProperty({__proto__:null,INV_POLE_BY_180:Co,MAX_LAT:ct,MIN_LAT:Ot,ONE_BY_POLE_DOUBLE:ri,PI_BY_POLE:jr,POLE:Lt,POLE2:Qi,POLE_BY_180:Hi,POLE_BY_PI:We,POLE_DOUBLE:Ao,forward:Ji,forwardArray:function(h){let t=[];for(let s=0;s<h.length;s++)t.push(h[s].forwardMercator());return t},forward_lat:oi,forward_lon:ni,getTileExtent:Ze,getTileX:function(h,t){return Math.floor((h+180)/360*Math.pow(2,t))},getTileY:function(h,t){return Math.floor(.5*(1-Math.log(Math.tan(h*mn)+1/Math.cos(h*mn))/Math.PI)*Math.pow(2,t))},inverse_lat:Lo,inverse_lon:function(h){return 180*h/Lt}},Symbol.toStringTag,{value:"Module"}));class U{constructor(t=new L,s=new L){this.southWest=t,this.northEast=s}static createFromArray(t){return new U(new L(t[0],t[1]),new L(t[2],t[3]))}static createByCoordinates(t){let s=xt,n=Ct,o=xt,a=Ct;for(let l=0;l<t.length;l++){const c=t[l];c.lon<s&&(s=c.lon),c.lon>n&&(n=c.lon),c.lat<o&&(o=c.lat),c.lat>a&&(a=c.lat)}return new U(new L(s,o),new L(n,a))}static createByCoordinatesArr(t){let s=xt,n=Ct,o=xt,a=Ct;for(let l=0;l<t.length;l++){const c=t[l];c[0]<s&&(s=c[0]),c[0]>n&&(n=c[0]),c[1]<o&&(o=c[1]),c[1]>a&&(a=c[1])}return new U(new L(s,o),new L(n,a))}static fromTile(t,s,n,o=4007501668e-2,a=4007501668e-2){const l=1<<n,c=o/l,d=a/l,u=.5*-o+t*c,_=.5*a-s*d,f=u+c;return new U(new L(u,_-d),new L(f,_))}setByCoordinates(t){let s=xt,n=Ct,o=xt,a=Ct;for(let l=0;l<t.length;l++){const c=t[l];c.lon<s&&(s=c.lon),c.lon>n&&(n=c.lon),c.lat<o&&(o=c.lat),c.lat>a&&(a=c.lat)}return this.southWest.lon=s,this.southWest.lat=o,this.northEast.lon=n,this.northEast.lat=a,this}isInside(t){const s=this.southWest,n=this.northEast;return t.lon>=s.lon&&t.lon<=n.lon&&t.lat>=s.lat&&t.lat<=n.lat}overlaps(t){const s=this.southWest,n=this.northEast;return s.lon<=t.northEast.lon&&n.lon>=t.southWest.lon&&s.lat<=t.northEast.lat&&n.lat>=t.southWest.lat}getWidth(){return this.northEast.lon-this.southWest.lon}getHeight(){return this.northEast.lat-this.southWest.lat}clone(){return new U(this.southWest.clone(),this.northEast.clone())}getCenter(){const t=this.southWest,s=this.northEast;return new L(t.lon+.5*(s.lon-t.lon),t.lat+.5*(s.lat-t.lat))}getNorthWest(){return new L(this.southWest.lon,this.northEast.lat)}getNorthEast(){return new L(this.northEast.lon,this.northEast.lat)}getSouthWest(){return new L(this.southWest.lon,this.southWest.lat)}getSouthEast(){return new L(this.northEast.lon,this.southWest.lat)}getNorth(){return this.northEast.lat}getEast(){return this.northEast.lon}getWest(){return this.southWest.lon}getSouth(){return this.southWest.lat}equals(t){return this.southWest.lon===t.southWest.lon&&this.southWest.lat===t.southWest.lat&&this.northEast.lon===t.northEast.lon&&this.northEast.lat===t.northEast.lat}forwardMercator(){return new U(this.southWest.forwardMercator(),this.northEast.forwardMercator())}inverseMercator(){return new U(this.southWest.inverseMercator(),this.northEast.inverseMercator())}getCartesianBounds(t){let s=xt,n=Ct,o=xt,a=Ct,l=xt,c=Ct;const d=[new L(this.southWest.lon,this.southWest.lat),new L(this.southWest.lon,this.northEast.lat),new L(this.northEast.lon,this.northEast.lat),new L(this.northEast.lon,this.southWest.lat)];for(let u=0;u<d.length;u++){const _=t.lonLatToCartesian(d[u]),f=_.x,g=_.y,m=_.z;f<s&&(s=f),f>n&&(n=f),g<o&&(o=g),g>a&&(a=g),m<l&&(l=m),m>c&&(c=m)}return[s,o,l,n,a,c]}toString(){return`[${this.southWest.lon.toFixed(5)}, ${this.southWest.lat.toFixed(5)}, ${this.northEast.lon.toFixed(5)}, ${this.northEast.lat.toFixed(5)}]`}}class Se{constructor(){this._m=[0,0,0,0,0,0,0,0,0]}set(t){return this._m[0]=t[0],this._m[1]=t[1],this._m[2]=t[2],this._m[3]=t[3],this._m[4]=t[4],this._m[5]=t[5],this._m[6]=t[6],this._m[7]=t[7],this._m[8]=t[8],this}clone(){let t=new Se;return t.set(this._m),t}copy(t){return this.set(t._m)}transposeTo(){let t=new Se,s=this._m;return t._m[0]=s[0],t._m[1]=s[3],t._m[2]=s[6],t._m[3]=s[1],t._m[4]=s[4],t._m[5]=s[7],t._m[6]=s[2],t._m[7]=s[5],t._m[8]=s[8],t}setIdentity(){return this._m[0]=1,this._m[1]=0,this._m[2]=0,this._m[3]=0,this._m[4]=1,this._m[5]=0,this._m[6]=0,this._m[7]=0,this._m[8]=1,this}mulVec(t){let s=t.x,n=t.y,o=t.z,a=this._m;return new v(a[0]*s+a[3]*n+a[6]*o,a[1]*s+a[4]*n+a[7]*o,a[2]*s+a[5]*n+a[8]*o)}getMat4(){let t=new tt,s=t._m,n=this._m;return s[0]=n[0],s[1]=n[1],s[2]=n[2],s[3]=0,s[4]=n[3],s[5]=n[4],s[6]=n[5],s[7]=0,s[8]=n[6],s[9]=n[7],s[10]=n[8],s[11]=0,s[12]=0,s[13]=0,s[14]=0,s[15]=1,t}}class et{constructor(t=0,s=0,n=0,o=0){this.x=t,this.y=s,this.z=n,this.w=o}static get identity(){return new et(0,0,0,1)}static fromVec(t){return new et(t[0],t[1],t[2],t[3])}toVec3(){return new v(this.x,this.y,this.z)}clone(){return new et(this.x,this.y,this.z,this.w)}equal(t){return this.x===t.x&&this.y===t.y&&this.z===t.z&&this.w===t.w}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this}toArray(){return[this.x,this.y,this.z,this.w]}toArray3(){return[this.x,this.y,this.z]}set(t,s,n,o){return this.x=t,this.y=s,this.z=n,this.w=o,this}addA(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this.w+=t.w,this}subA(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this.w-=t.w,this}scale(t){return this.x*=t,this.y*=t,this.z*=t,this.w*=t,this}affinity(){let t=1/this.w;return this.x*=t,this.y*=t,this.z*=t,this.w=1,this}scaleTo(t){return new et(this.x*t,this.y*t,this.z*t,this.w*t)}getStep(t){return new et(this.x<t?0:1,this.y<t?0:1,this.z<t?0:1,this.w<t?0:1)}getFrac(t){return new et(si(t.x),si(t.y),si(t.z),si(t.w))}dot(t){return t.x*this.x+t.y*this.y+t.z*this.z+t.w*this.w}isZero(){return!(this.x||this.y||this.z||this.w)}}class tt{constructor(){this._m=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]}static identity(){let t=new tt;return t._m[0]=1,t._m[1]=0,t._m[2]=0,t._m[3]=0,t._m[4]=0,t._m[5]=1,t._m[6]=0,t._m[7]=0,t._m[8]=0,t._m[9]=0,t._m[10]=1,t._m[11]=0,t._m[12]=0,t._m[13]=0,t._m[14]=0,t._m[15]=1,t}static getRotationAroundPoint(t,s=v.ZERO,n=v.UP){let o=tt.getRotation(t,n),a=new tt().setIdentity().translate(s),l=new tt().setIdentity().translate(s.negateTo());return a.mul(o).mul(l)}static getRotation(t,s=v.UP){return new tt().setRotation(s,t)}getPosition(){return new v(this._m[12],this._m[13],this._m[14])}getScaling(){let t=this._m[0],s=this._m[1],n=this._m[2],o=this._m[4],a=this._m[5],l=this._m[6],c=this._m[8],d=this._m[9],u=this._m[10];return new v(Math.sqrt(t*t+s*s+n*n),Math.sqrt(o*o+a*a+l*l),Math.sqrt(c*c+d*d+u*u))}getQuat(){let t=this.getScaling();const s=[0,0,0,1];let n=1/t.x,o=1/t.y,a=1/t.z,l=this._m[0]*n,c=this._m[1]*o,d=this._m[2]*a,u=this._m[4]*n,_=this._m[5]*o,f=this._m[6]*a,g=this._m[8]*n,m=this._m[9]*o,p=this._m[10]*a,x=l+_+p,y=0;return x>0?(y=2*Math.sqrt(x+1),s[3]=.25*y,s[0]=(f-m)/y,s[1]=(g-d)/y,s[2]=(c-u)/y):l>_&&l>p?(y=2*Math.sqrt(1+l-_-p),s[3]=(f-m)/y,s[0]=.25*y,s[1]=(c+u)/y,s[2]=(g+d)/y):_>p?(y=2*Math.sqrt(1+_-l-p),s[3]=(g-d)/y,s[0]=(c+u)/y,s[1]=.25*y,s[2]=(f+m)/y):(y=2*Math.sqrt(1+p-l-_),s[3]=(c-u)/y,s[0]=(g+d)/y,s[1]=(f+m)/y,s[2]=.25*y),new F(...s)}set(t){return this._m[0]=t[0],this._m[1]=t[1],this._m[2]=t[2],this._m[3]=t[3],this._m[4]=t[4],this._m[5]=t[5],this._m[6]=t[6],this._m[7]=t[7],this._m[8]=t[8],this._m[9]=t[9],this._m[10]=t[10],this._m[11]=t[11],this._m[12]=t[12],this._m[13]=t[13],this._m[14]=t[14],this._m[15]=t[15],this}clone(){let t=new tt;return t.set(this._m),t}copy(t){return this.set(t._m)}getMat3(){let t=new Se,s=this._m,n=t._m;return n[0]=s[0],n[1]=s[1],n[2]=s[2],n[3]=s[4],n[4]=s[5],n[5]=s[6],n[6]=s[8],n[7]=s[9],n[8]=s[10],t}mulVec3(t){let s=t.x,n=t.y,o=t.z;return new v(this._m[0]*s+this._m[4]*n+this._m[8]*o+this._m[12],this._m[1]*s+this._m[5]*n+this._m[9]*o+this._m[13],this._m[2]*s+this._m[6]*n+this._m[10]*o+this._m[14])}mulVec4(t){let s=t.x,n=t.y,o=t.z,a=t.w;return new et(this._m[0]*s+this._m[4]*n+this._m[8]*o+this._m[12]*a,this._m[1]*s+this._m[5]*n+this._m[9]*o+this._m[13]*a,this._m[2]*s+this._m[6]*n+this._m[10]*o+this._m[14]*a,this._m[3]*s+this._m[7]*n+this._m[11]*o+this._m[15]*a)}toInverseMatrix3(){let t=this._m,s=t[0],n=t[1],o=t[2],a=t[4],l=t[5],c=t[6],d=t[8],u=t[9],_=t[10],f=_*l-c*u,g=-_*a+c*d,m=u*a-l*d,p=s*f+n*g+o*m;if(!p)return;p=1/p;let x=new Se;return x._m[0]=f*p,x._m[1]=(-_*n+o*u)*p,x._m[2]=(c*n-o*l)*p,x._m[3]=g*p,x._m[4]=(_*s-o*d)*p,x._m[5]=(-c*s+o*a)*p,x._m[6]=m*p,x._m[7]=(-u*s+n*d)*p,x._m[8]=(l*s-n*a)*p,x}inverseTo(t=new tt){let s=this._m[0],n=this._m[1],o=this._m[2],a=this._m[3],l=this._m[4],c=this._m[5],d=this._m[6],u=this._m[7],_=this._m[8],f=this._m[9],g=this._m[10],m=this._m[11],p=this._m[12],x=this._m[13],y=this._m[14],w=this._m[15],C=s*c-n*l,T=s*d-o*l,P=s*u-a*l,E=n*d-o*c,S=n*u-a*c,M=o*u-a*d,R=_*x-f*p,k=_*y-g*p,B=_*w-m*p,z=f*y-g*x,O=f*w-m*x,ze=g*w-m*y,D=1/(C*ze-T*O+P*z+E*B-S*k+M*R);return t._m[0]=(c*ze-d*O+u*z)*D,t._m[1]=(-n*ze+o*O-a*z)*D,t._m[2]=(x*M-y*S+w*E)*D,t._m[3]=(-f*M+g*S-m*E)*D,t._m[4]=(-l*ze+d*B-u*k)*D,t._m[5]=(s*ze-o*B+a*k)*D,t._m[6]=(-p*M+y*P-w*T)*D,t._m[7]=(_*M-g*P+m*T)*D,t._m[8]=(l*O-c*B+u*R)*D,t._m[9]=(-s*O+n*B-a*R)*D,t._m[10]=(p*S-x*P+w*C)*D,t._m[11]=(-_*S+f*P-m*C)*D,t._m[12]=(-l*z+c*k-d*R)*D,t._m[13]=(s*z-n*k+o*R)*D,t._m[14]=(-p*E+x*T-y*C)*D,t._m[15]=(_*E-f*T+g*C)*D,t}transposeTo(){let t=new tt;return t._m[0]=this._m[0],t._m[1]=this._m[4],t._m[2]=this._m[8],t._m[3]=this._m[12],t._m[4]=this._m[1],t._m[5]=this._m[5],t._m[6]=this._m[9],t._m[7]=this._m[13],t._m[8]=this._m[2],t._m[9]=this._m[6],t._m[10]=this._m[10],t._m[11]=this._m[14],t._m[12]=this._m[3],t._m[13]=this._m[7],t._m[14]=this._m[11],t._m[15]=this._m[15],t}setIdentity(){return this._m[0]=1,this._m[1]=0,this._m[2]=0,this._m[3]=0,this._m[4]=0,this._m[5]=1,this._m[6]=0,this._m[7]=0,this._m[8]=0,this._m[9]=0,this._m[10]=1,this._m[11]=0,this._m[12]=0,this._m[13]=0,this._m[14]=0,this._m[15]=1,this}mul(t){let s=this._m[0],n=this._m[1],o=this._m[2],a=this._m[3],l=this._m[4],c=this._m[5],d=this._m[6],u=this._m[7],_=this._m[8],f=this._m[9],g=this._m[10],m=this._m[11],p=this._m[12],x=this._m[13],y=this._m[14],w=this._m[15],C=t._m[0],T=t._m[1],P=t._m[2],E=t._m[3],S=t._m[4],M=t._m[5],R=t._m[6],k=t._m[7],B=t._m[8],z=t._m[9],O=t._m[10],ze=t._m[11],D=t._m[12],re=t._m[13],Ee=t._m[14],I=t._m[15],N=new tt;return N._m[0]=C*s+T*l+P*_+E*p,N._m[1]=C*n+T*c+P*f+E*x,N._m[2]=C*o+T*d+P*g+E*y,N._m[3]=C*a+T*u+P*m+E*w,N._m[4]=S*s+M*l+R*_+k*p,N._m[5]=S*n+M*c+R*f+k*x,N._m[6]=S*o+M*d+R*g+k*y,N._m[7]=S*a+M*u+R*m+k*w,N._m[8]=B*s+z*l+O*_+ze*p,N._m[9]=B*n+z*c+O*f+ze*x,N._m[10]=B*o+z*d+O*g+ze*y,N._m[11]=B*a+z*u+O*m+ze*w,N._m[12]=D*s+re*l+Ee*_+I*p,N._m[13]=D*n+re*c+Ee*f+I*x,N._m[14]=D*o+re*d+Ee*g+I*y,N._m[15]=D*a+re*u+Ee*m+I*w,N}translate(t){let s=t.x,n=t.y,o=t.z,a=this._m;return a[12]=a[0]*s+a[4]*n+a[8]*o+a[12],a[13]=a[1]*s+a[5]*n+a[9]*o+a[13],a[14]=a[2]*s+a[6]*n+a[10]*o+a[14],a[15]=a[3]*s+a[7]*n+a[11]*o+a[15],this}translateToPosition(t){let s=this._m;return s[12]=t.x,s[13]=t.y,s[14]=t.z,this}rotate(t,s){let n=Math.cos(s),o=Math.sin(s),a=new tt,l=a._m;return l[0]=n+(1-n)*t.x*t.x,l[1]=(1-n)*t.y*t.x-o*t.z,l[2]=(1-n)*t.z*t.x+o*t.y,l[3]=0,l[4]=(1-n)*t.x*t.y+o*t.z,l[5]=n+(1-n)*t.y*t.y,l[6]=(1-n)*t.z*t.y-o*t.x,l[7]=0,l[8]=(1-n)*t.x*t.z-o*t.y,l[9]=(1-n)*t.y*t.z+o*t.x,l[10]=n+(1-n)*t.z*t.z,l[11]=0,l[12]=0,l[13]=0,l[14]=0,l[15]=1,this.mul(a)}setRotation(t,s){let n=Math.cos(s),o=Math.sin(s),a=this._m;return a[0]=n+(1-n)*t.x*t.x,a[1]=(1-n)*t.y*t.x-o*t.z,a[2]=(1-n)*t.z*t.x+o*t.y,a[3]=0,a[4]=(1-n)*t.x*t.y+o*t.z,a[5]=n+(1-n)*t.y*t.y,a[6]=(1-n)*t.z*t.y-o*t.x,a[7]=0,a[8]=(1-n)*t.x*t.z-o*t.y,a[9]=(1-n)*t.y*t.z+o*t.x,a[10]=n+(1-n)*t.z*t.z,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,this}rotateBetweenVectors(t,s){return F.getRotationBetweenVectors(t,s).getMat4()}scale(t){let s=this._m;return s[0]=s[0]*t.x,s[1]=s[1]*t.x,s[2]=s[2]*t.x,s[3]=s[3]*t.x,s[4]=s[4]*t.y,s[5]=s[5]*t.y,s[6]=s[6]*t.y,s[7]=s[7]*t.y,s[8]=s[8]*t.z,s[9]=s[9]*t.z,s[10]=s[10]*t.z,s[11]=s[11]*t.z,this}setPerspective(t,s,n,o,a,l){let c=s-t,d=o-n,u=a-l,_=2*a,f=this._m;return f[0]=_/c,f[1]=0,f[2]=0,f[3]=0,f[4]=0,f[5]=_/d,f[6]=0,f[7]=0,f[8]=(s+t)/c,f[9]=(o+n)/d,f[10]=(l+a)/u,f[11]=-1,f[12]=0,f[13]=0,f[14]=_*l/u,f[15]=0,this}setOrthographic(t,s,n,o,a,l){let c=1/(t-s),d=1/(n-o),u=1/(a-l),_=this._m;return _[0]=-2*c,_[1]=0,_[2]=0,_[3]=0,_[4]=0,_[5]=-2*d,_[6]=0,_[7]=0,_[8]=0,_[9]=0,_[10]=2*u,_[11]=0,_[12]=(t+s)*c,_[13]=(o+n)*d,_[14]=(l+a)*u,_[15]=1,this}eulerToMatrix(t,s,n){let o=Math.cos(t),a=Math.sin(t),l=Math.cos(s),c=Math.sin(s),d=Math.cos(n),u=Math.sin(n),_=o*c,f=a*c,g=this._m;return g[0]=l*d,g[1]=-l*u,g[2]=-c,g[4]=-f*d+o*u,g[5]=f*u+o*d,g[6]=-a*l,g[8]=_*d+a*u,g[9]=-_*u+a*d,g[10]=o*l,g[3]=g[7]=g[11]=g[12]=g[13]=g[14]=0,g[15]=1,this}}class F{constructor(t=0,s=0,n=0,o=0){this.x=t,this.y=s,this.z=n,this.w=o}static get IDENTITY(){return new F(0,0,0,1)}static xRotation(t){return t*=.5,new F(Math.sin(t),0,0,Math.cos(t))}static yRotation(t){return t*=.5,new F(0,Math.sin(t),0,Math.cos(t))}static zRotation(t){return t*=.5,new F(0,0,Math.sin(t),Math.cos(t))}static axisAngleToQuat(t,s=0){let n=t.getNormal(),o=.5*s,a=Math.sin(o);return new F(n.x*a,n.y*a,n.z*a,Math.cos(o))}static getLookRotation(t,s){let n=t.getNormal().negate(),o=s.cross(n).normalize(),a=n.cross(o),l=1+o.x+a.y+n.z;if(l>1e-6){let d=1/(2*Math.sqrt(l));return new F((n.y-a.z)*d,(o.z-n.x)*d,(a.x-o.y)*d,.25/d)}if(o.x>a.y&&o.x>n.z){let d=1/(2*Math.sqrt(1+o.x-a.y-n.z));return new F(.25/d,(a.x+o.y)*d,(o.z+n.x)*d,(n.y-a.z)*d)}if(a.y>n.z){let d=1/(2*Math.sqrt(1+a.y-o.x-n.z));return new F((a.x+o.y)*d,.25/d,(n.y+a.z)*d,(o.z-n.x)*d)}let c=1/(2*Math.sqrt(1+n.z-o.x-a.y));return new F((o.z+n.x)*c,(n.y+a.z)*c,.25/c,(a.x-o.y)*c)}static getLookAtSourceDest(t,s){let n=s.subA(t).normalize(),o=v.FORWARD.dot(n);if(Math.abs(o- -1)<1e-6)return F.axisAngleToQuat(v.UP,Math.PI);if(Math.abs(o-1)<1e-6)return new F(0,0,0,1);let a=Math.acos(o),l=v.FORWARD.cross(n).normalize();return F.axisAngleToQuat(l,a)}static getRotationBetweenVectors(t,s){let n=t.cross(s);return new F(n.x,n.y,n.z,1+t.dot(s)).normalize()}static getRotationBetweenVectorsRes(t,s,n){let o=t.cross(s);return n.set(o.x,o.y,o.z,1+t.dot(s)),n.normalize()}static getRotationBetweenVectorsUp(t,s,n){let o=t.dot(s);if(Math.abs(o+1)<1e-6)return F.axisAngleToQuat(n,Math.PI);if(Math.abs(o-1)<1e-6)return new F(0,0,0,1);let a=Math.acos(o),l=t.cross(s).normalize();return F.axisAngleToQuat(l,a)}isZero(){return this.x===0&&this.y===0&&this.z===0&&this.w===0}isNaN(){return isNaN(this.x)||isNaN(this.y)||isNaN(this.z)||isNaN(this.w)}clear(){return this.x=this.y=this.z=this.w=0,this}set(t,s,n,o){return this.x=t,this.y=s,this.z=n,this.w=o,this}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this}setIdentity(){return this.x=0,this.y=0,this.z=0,this.w=1,this}clone(){return new F(this.x,this.y,this.z,this.w)}add(t){return new F(this.x+t.x,this.y+t.y,this.z+t.z,this.w+t.w)}addRes(t,s){return s.set(this.x+t.x,this.y+t.y,this.z+t.z,this.w+t.w)}sub(t){return new F(this.x-t.x,this.y-t.y,this.z-t.z,this.w-t.w)}scaleTo(t){return new F(this.x*t,this.y*t,this.z*t,this.w*t)}scale(t){return this.x*=t,this.y*=t,this.z*=t,this.w*=t,this}toVec(){return[this.x,this.y,this.z,this.w]}get xyz(){return new v(this.x,this.y,this.z)}setLookRotation(t,s){let n=t.getNormal().negate(),o=s.cross(n).normalize(),a=n.cross(o),l=1+o.x+a.y+n.z;if(l>1e-6){let c=1/(2*Math.sqrt(l));this.x=(n.y-a.z)*c,this.y=(o.z-n.x)*c,this.z=(a.x-o.y)*c,this.w=.25/c}else if(o.x>a.y&&o.x>n.z){let c=1/(2*Math.sqrt(1+o.x-a.y-n.z));this.x=.25/c,this.y=(a.x+o.y)*c,this.z=(o.z+n.x)*c,this.w=(n.y-a.z)*c}else if(a.y>n.z){let c=1/(2*Math.sqrt(1+a.y-o.x-n.z));this.x=(a.x+o.y)*c,this.y=.25/c,this.z=(n.y+a.z)*c,this.w=(o.z-n.x)*c}else{let c=1/(2*Math.sqrt(1+n.z-o.x-a.y));this.x=(o.z+n.x)*c,this.y=(n.y+a.z)*c,this.z=.25/c,this.w=(a.x-o.y)*c}return this}setFromSphericalCoords(t,s,n){let o=Math.sin(n/2),a=Math.cos(n/2),l=Math.sin(t),c=Math.cos(t),d=Math.sin(s),u=Math.cos(s);return this.x=o*c*d,this.y=o*l,this.z=o*l*u,this.w=a,this}getSphericalCoords(){let t=this.w,s=Math.sqrt(1-t*t);Math.abs(s)<5e-4&&(s=1);let n,o=this.x/s,a=this.y/s,l=this.z/s,c=-Math.asin(a);return n=o*o+l*l<5e-4?0:Math.atan2(o,l),n<0&&(n+=360),{lat:c,lon:n,alpha:Math.acos(t)}}setFromAxisAngle(t,s){let n=t.getNormal(),o=.5*s,a=Math.sin(o);return this.set(n.x*a,n.y*a,n.z*a,Math.cos(o)),this}getAxisAngle(){let t,s,n=this.x,o=this.y,a=this.z,l=this.w,c=Math.sqrt(n*n+o*o+a*a);if(c>1e-7){let d=1/c;t=new v(n*d,o*d,a*d),s=l<0?2*Math.atan2(-c,-l):2*Math.atan2(c,l)}else t=new v(0,0,0),s=0;return{axis:t,angle:s}}getPitch(){let t=-2*(this.y*this.z-this.w*this.x);return Math.abs(t)>=1?Math.sign(t)*vo:Math.asin(t)}getYaw(){return-Math.atan2(2*(this.x*this.z+this.w*this.y),1-2*(this.y*this.y+this.x*this.x))}getRoll(){return Math.atan2(2*(this.x*this.y+this.w*this.z),1-2*(this.z*this.z+this.x*this.x))}setPitchYawRoll(t,s,n,o=F.IDENTITY){let a=F.xRotation(-t),l=F.yRotation(s),c=F.zRotation(-n);return this.copy(c.mul(a).mul(l).mul(o).conjugate())}setFromEulerAngles(t,s,n){let o=t*Qt,a=s*Qt,l=n*Qt,c=Math.cos(o),d=Math.cos(a),u=Math.cos(l),_=Math.sin(o),f=Math.sin(a),g=Math.sin(l),m=d*u,p=f*g;return this.w=c*m+_*p,this.x=_*m-c*p,this.y=c*f*u+_*d*g,this.z=c*d*g-_*f*u,this.normalize()}getEulerAngles(){let t=this.x,s=this.y,n=this.z,o=this.w,a=s*s,l=o*s-n*t;return l<-1?l=-1:l>1&&(l=1),{roll:Math.atan2(2*(o*t+s*n),1-2*(t*t+a)),pitch:Math.asin(2*l),yaw:Math.atan2(2*(o*n+t*s),1-2*(a+n*n))}}setFromMatrix4(t){let s,n,o,a,l,c=[],d=t._m,u=[1,2,0];return s=d[0]+d[5]+d[10],s>0?(n=Math.sqrt(s+1),this.w=n/2,n=.5/n,this.x=(d[6]-d[9])*n,this.y=(d[8]-d[2])*n,this.z=(d[1]-d[4])*n):(o=0,d[5]>d[0]&&(o=1),d[10]>d[5*o]&&(o=2),a=u[o],l=u[a],n=Math.sqrt(d[5*o]-(d[5*a]+d[5*l])+1),c[o]=.5*n,n!==0&&(n=.5/n),c[3]=(d[4*a+l]-d[4*l+a])*n,c[a]=(d[4*o+a]+d[4*a+o])*n,c[l]=(d[4*o+l]+d[4*l+o])*n,this.x=c[0],this.y=c[1],this.z=c[2],this.w=c[3]),this}getMat4(t=new tt){let s=this.x+this.x,n=this.y+this.y,o=this.z+this.z,a=this.w*s,l=this.w*n,c=this.w*o,d=this.x*s,u=this.x*n,_=this.x*o,f=this.y*n,g=this.y*o,m=this.z*o;return t.set([1-(f+m),u-c,_+l,0,u+c,1-(d+m),g-a,0,_-l,g+a,1-(d+f),0,0,0,0,1])}getMat3(){let t=new Se,s=t._m,n=this.x,o=this.y,a=this.z,l=this.w,c=n+n,d=o+o,u=a+a,_=n*c,f=n*d;n*=u;let g=o*d;return o*=u,a*=u,c*=l,d*=l,l*=u,s[0]=1-(g+a),s[1]=f-l,s[2]=n+d,s[3]=f+l,s[4]=1-(_+a),s[5]=o-c,s[6]=n-d,s[7]=o+c,s[8]=1-(_+g),t}mulVec3(t){let s=t.x,n=t.y,o=t.z,a=this.x,l=this.y,c=this.z,d=this.w,u=d*s+l*o-c*n,_=d*n+c*s-a*o,f=d*o+a*n-l*s;return s=-a*s-l*n-c*o,new v(u*d+s*-a+_*-c-f*-l,_*d+s*-l+f*-a-u*-c,f*d+s*-c+u*-l-_*-a)}mulVec3Res(t,s){let n=t.x,o=t.y,a=t.z,l=this.x,c=this.y,d=this.z,u=this.w,_=u*n+c*a-d*o,f=u*o+d*n-l*a,g=u*a+l*o-c*n;return n=-l*n-c*o-d*a,s.set(_*u+n*-l+f*-d-g*-c,f*u+n*-c+g*-l-_*-d,g*u+n*-d+_*-c-f*-l)}mul(t){let s=this.x,n=this.y,o=this.z,a=this.w,l=t.x,c=t.y,d=t.z,u=t.w;return new F(s*u+a*l+n*d-o*c,n*u+a*c+o*l-s*d,o*u+a*d+s*c-n*l,a*u-s*l-n*c-o*d)}mulRes(t,s){let n=this.x,o=this.y,a=this.z,l=this.w,c=t.x,d=t.y,u=t.z,_=t.w;return s.set(n*_+l*c+o*u-a*d,o*_+l*d+a*c-n*u,a*_+l*u+n*d-o*c,l*_-n*c-o*d-a*u)}mulA(t){let s=this.x,n=this.y,o=this.z,a=this.w,l=t.x,c=t.y,d=t.z,u=t.w;return this.x=s*u+a*l+n*d-o*c,this.y=n*u+a*c+o*l-s*d,this.z=o*u+a*d+s*c-n*l,this.w=a*u-s*l-n*c-o*d,this}conjugate(){return new F(-this.x,-this.y,-this.z,this.w)}inverse(){let t=1/this.magnitude2();return new F(-this.x*t,-this.y*t,-this.z*t,this.w*t)}magnitude(){let t=this.x,s=this.y,n=this.z,o=this.w;return Math.sqrt(t*t+s*s+n*n+o*o)}magnitude2(){let t=this.x,s=this.y,n=this.z,o=this.w;return t*t+s*s+n*n+o*o}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}normalize(){let t=this.x,s=this.y,n=this.z,o=this.w,a=Math.sqrt(t*t+s*s+n*n+o*o);return a===0?(this.x=0,this.y=0,this.z=0,this.w=0,this):(a=1/a,this.x=t*a,this.y=s*a,this.z=n*a,this.w=o*a,this)}isEqual(t){let s=this.dot(t);return Math.abs(s-1)<.001}slerp(t,s){let n,o,a,l,c,d=this.x,u=this.y,_=this.z,f=this.w,g=t.x,m=t.y,p=t.z,x=t.w;return o=d*g+u*m+_*p+f*x,o<0&&(o=-o,g=-g,m=-m,p=-p,x=-x),1-o>1e-6?(n=Math.acos(o),a=Math.sin(n),l=Math.sin((1-s)*n)/a,c=Math.sin(s*n)/a):(l=1-s,c=s),new F(l*d+c*g,l*u+c*m,l*_+c*p,l*f+c*x)}}class v{constructor(t=0,s=0,n=0){this.x=t,this.y=s,this.z=n}static get UP(){return new v(0,1,0)}static get DOWN(){return new v(0,-1,0)}static get RIGHT(){return new v(1,0,0)}static get LEFT(){return new v(-1,0,0)}static get FORWARD(){return new v(0,0,-1)}static get BACKWARD(){return new v(0,0,1)}static get ZERO(){return new v}static get UNIT_X(){return new v(1,0,0)}static get UNIT_Y(){return new v(0,1,0)}static get UNIT_Z(){return new v(0,0,1)}static get NORTH(){return v.UNIT_Z}static doubleToTwoFloats(t,s,n){let o=t.x,a=t.y,l=t.z;if(o>=0){let c=65536*Math.floor(o/65536);s.x=Math.fround(c),n.x=Math.fround(o-c)}else{let c=65536*Math.floor(-o/65536);s.x=Math.fround(-c),n.x=Math.fround(o+c)}if(a>=0){let c=65536*Math.floor(a/65536);s.y=Math.fround(c),n.y=Math.fround(a-c)}else{let c=65536*Math.floor(-a/65536);s.y=Math.fround(-c),n.y=Math.fround(a+c)}if(l>=0){let c=65536*Math.floor(l/65536);s.z=Math.fround(c),n.z=Math.fround(l-c)}else{let c=65536*Math.floor(-l/65536);s.z=Math.fround(-c),n.z=Math.fround(l+c)}}static doubleToTwoFloat32Array(t,s,n){let o=t.x,a=t.y,l=t.z;if(o>=0){let c=65536*Math.floor(o/65536);s[0]=Math.fround(c),n[0]=Math.fround(o-c)}else{let c=65536*Math.floor(-o/65536);s[0]=Math.fround(-c),n[0]=Math.fround(o+c)}if(a>=0){let c=65536*Math.floor(a/65536);s[1]=Math.fround(c),n[1]=Math.fround(a-c)}else{let c=65536*Math.floor(-a/65536);s[1]=Math.fround(-c),n[1]=Math.fround(a+c)}if(l>=0){let c=65536*Math.floor(l/65536);s[2]=Math.fround(c),n[2]=Math.fround(l-c)}else{let c=65536*Math.floor(-l/65536);s[2]=Math.fround(-c),n[2]=Math.fround(l+c)}}static fromVec(t){return new v(t[0],t[1],t[2])}static angle(t,s){let n=t.dot(s),o=t.cross(s).length();return Math.atan2(o,n)}static lerp(t,s,n){return new v(t.x+(s.x-t.x)*n,t.y+(s.y-t.y)*n,t.z+(s.z-t.z)*n)}static add(t,s){let n=new v(t.x,t.y,t.z);return n.addA(s),n}static sub(t,s){let n=new v(t.x,t.y,t.z);return n.subA(s),n}static scale(t,s){return t.scaleTo(s)}static mul(t,s){let n=new v(t.x,t.y,t.z);return n.mulA(s),n}static noncollinear(t,s){return!!(t.y*s.z-t.z*s.y||t.z*s.x-t.x*s.z||t.x*s.y-t.y*s.z)}static proj_b_to_plane(t,s,n){let o=t.sub(s.scaleTo(s.dot(t)/s.dot(s)));return n&&o.isZero()?new v(n.x,n.y,n.z):o}static proj_b_to_a(t,s){return s.scaleTo(s.dot(t)/s.dot(s))}static orthoNormalize(t,s){return(t=t.getNormal()).scale(s.dot(t)),s.subA(t).normalize()}static isOrthogonal(t,s,n=1e-6){const o=t.x*s.x+t.y*s.y+t.z*s.z;return Math.abs(o)<n}isOrthogonal(t,s=1e-6){const n=this.x*t.x+this.y*t.y+this.z*t.z;return Math.abs(n)<s}static div(t,s){let n=new v(t.x,t.y,t.z);return n.divA(s),n}static length2(t){return t.length2()}static dot(t,s){return t.dot(s)}toVec4(){return new et(this.x,this.y,this.z,1)}clone(){return new v(this.x,this.y,this.z)}toString(){return`(${this.x},${this.y},${this.z})`}isZero(){return!(this.x||this.y||this.z)}projToVec(t){return t.scaleTo(t.dot(this)/t.dot(t))}equal(t){return this.x===t.x&&this.y===t.y&&this.z===t.z}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}length2(){return this.x*this.x+this.y*this.y+this.z*this.z}getQuat(){return new F(this.x,this.y,this.z)}addA(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this}add(t){return new v(this.x+t.x,this.y+t.y,this.z+t.z)}addRes(t,s){return s.set(this.x+t.x,this.y+t.y,this.z+t.z)}subA(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this}sub(t){return new v(this.x-t.x,this.y-t.y,this.z-t.z)}scale(t){return this.x*=t,this.y*=t,this.z*=t,this}scaleTo(t){return new v(this.x*t,this.y*t,this.z*t)}mulA(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this}mul(t){return new v(this.x*t.x,this.y*t.y,this.z*t.z)}mulRes(t,s){return s.set(this.x*t.x,this.y*t.y,this.z*t.z)}divA(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this}div(t){return new v(this.x/t.x,this.y/t.y,this.z/t.z)}dot(t){return t.x*this.x+t.y*this.y+t.z*this.z}dotArr(t){return t[0]*this.x+t[1]*this.y+t[2]*this.z}cross(t){return new v(this.y*t.z-this.z*t.y,this.z*t.x-this.x*t.z,this.x*t.y-this.y*t.x)}clear(){return this.x=this.y=this.z=0,this}getNormal(){let t=new v;t.copy(this);let s=1/t.length();return t.x*=s,t.y*=s,t.z*=s,t}normal(){let t=new v;t.copy(this);let s=1/t.length();return t.x*=s,t.y*=s,t.z*=s,t}normalNegate(){let t=new v;t.copy(this);let s=-1/t.length();return t.x*=s,t.y*=s,t.z*=s,t}normalNegateScale(t){let s=new v;s.copy(this);let n=-t/s.length();return s.x*=n,s.y*=n,s.z*=n,s}normalScale(t){let s=new v;s.copy(this);let n=t/s.length();return s.x*=n,s.y*=n,s.z*=n,s}normalize(){let t=1/this.length();return this.x*=t,this.y*=t,this.z*=t,this}toVec(){return[this.x,this.y,this.z]}toArray(){return[this.x,this.y,this.z]}distance(t){let s=this.x-t.x,n=this.y-t.y,o=this.z-t.z;return Math.sqrt(s*s+n*n+o*o)}distance2(t){let s=this.x-t.x,n=this.y-t.y,o=this.z-t.z;return s*s+n*n+o*o}set(t,s,n){return this.x=t,this.y=s,this.z=n,this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}negateTo(){return new v(-this.x,-this.y,-this.z)}projToRay(t,s){let n=v.proj_b_to_a(v.sub(this,t),s);return n.addA(t),n}angle(t){return v.angle(this,t)}lerp(t,s){return new v(this.x+(t.x-this.x)*s,this.y+(t.y-this.y)*s,this.z+(t.z-this.z)*s)}smerp(t,s){let n=1-s;return new v(this.x*s+t.x*n,this.y*s+t.y*n,this.z*s+t.z*n)}static get LERP_DELTA(){return 1e-6}slerp(t,s){let n,o,a,l,c=new v;if(s<=0)return c.copy(this),c;if(s>=1)return c.copy(t),c;let d=this.dot(t);return 1-d>v.LERP_DELTA?(n=Math.acos(d),o=Math.sin(n),a=Math.sin((1-s)*n)/o,l=Math.sin(s*n)/o):(a=1-s,l=s),v.add(this.scaleTo(a),t.scale(l))}mulVecA(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this}getRotationTo(t,s){let n=this.clone(),o=t.clone();n.normalize(),o.normalize();let a=n.dot(o);if(a>=1)return F.IDENTITY.clone();if(a<-.999999){if(s.equal(v.ZERO)){let l=v.UNIT_X.cross(n);return l.isZero()&&(l=v.UNIT_Y.cross(n)),l.normalize(),F.axisAngleToQuat(l,Math.PI)}return F.axisAngleToQuat(s,Math.PI)}{let l=Math.sqrt(2*(1+a)),c=1/l,d=n.cross(o),u=new F(d.x*c,d.y*c,d.z*c,.5*l);return u.normalize(),u}}}class H{constructor(t=0,s=0){this.x=t,this.y=s}static get UP(){return new H(0,1)}static get DOWN(){return new H(0,-1)}static get RIGHT(){return new H(1,0)}static get LEFT(){return new H(-1,0)}static get ZERO(){return new H}static add(t,s){const n=new H(t.x,t.y);return n.addA(s),n}static sub(t,s){var n=new H(t.x,t.y);return n.subA(s),n}static scale(t,s){let n=new H(t.x,t.y);return n.scale(s),n}static mul(t,s){let n=new H(t.x,t.y);return n.mulA(s),n}static div(t,s){let n=new H(t.x,t.y);return n.divA(s),n}static proj_b_to_a(t,s){return s.scaleTo(s.dot(t)/s.dot(s))}static angle(t,s){return Math.acos(t.dot(s)/Math.sqrt(t.length2()*s.length2()))}static orthoNormalize(t,s){return(t=t.normal()).scale(s.dot(t)),s.sub(t).normalize()}static proj_b_to_plane(t,s,n){let o=t.sub(s.scaleTo(s.dot(t)/s.dot(s)));return n&&o.isZero()?new H(n.x,n.y):o}toVector3(){return new v(this.x,this.y,0)}clone(){return new H(this.x,this.y)}equal(t){return this.x===t.x&&this.y===t.y}copy(t){return this.x=t.x,this.y=t.y,this}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}length2(){return this.x*this.x+this.y*this.y}addA(t){return this.x+=t.x,this.y+=t.y,this}add(t){return new H(this.x+t.x,this.y+t.y)}subA(t){return this.x-=t.x,this.y-=t.y,this}sub(t){return new H(this.x-t.x,this.y-t.y)}scale(t){return this.x*=t,this.y*=t,this}scaleTo(t){return new H(this.x*t,this.y*t)}mulA(t){return this.x*=t.x,this.y*=t.y,this}mul(t){return new H(this.x*t.x,this.y*t.y)}divA(t){return this.x/=t.x,this.y/=t.y,this}dot(t){return t.x*this.x+t.y*this.y}dotArr(t){return t[0]*this.x+t[1]*this.y}cross(t){return this.x*t.y-this.y*t.x}clear(){return this.x=this.y=0,this}normal(){return this.getNormal()}getNormal(){let t=new H;t.copy(this);let s=1/t.length();return t.x*=s,t.y*=s,t}normalize(){let t=1/this.length();return this.x*=t,this.y*=t,this}toVec(){return[this.x,this.y]}distance(t){return H.sub(this,t).length()}set(t,s){return this.x=t,this.y=s,this}negate(){return this.x=-this.x,this.y=-this.y,this}negateTo(){return new H(-this.x,-this.y)}projToRay(t,s){let n=H.proj_b_to_a(H.sub(this,t),s);return n.add(t),n}angle(t){return H.angle(this,t)}lerp(t,s,n){let o=this.clone();return n<=0?o.copy(t):n>=1?o.copy(s):o=H.add(t,H.sub(s,t).scale(n)),o}static get LERP_DELTA(){return 1e-6}slerp(t,s){let n,o,a,l,c=new H;if(s<=0)return c.copy(this),c;if(s>=1)return c.copy(t),c;let d=this.dot(t);return 1-d>H.LERP_DELTA?(n=Math.acos(d),o=Math.sin(n),a=Math.sin((1-s)*n)/o,l=Math.sin(s*n)/o):(a=1-s,l=s),H.add(this.scale(a),t.scale(l))}isZero(){return!(this.x||this.y)}}const Po={aliceblue:"#f0f8ff",antiquewhite:"#faebd7",aqua:"#00ffff",aquamarine:"#7fffd4",azure:"#f0ffff",beige:"#f5f5dc",bisque:"#ffe4c4",black:"#000000",blanchedalmond:"#ffebcd",blue:"#0000ff",blueviolet:"#8a2be2",brown:"#a52a2a",burlywood:"#deb887",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",cornflowerblue:"#6495ed",cornsilk:"#fff8dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkgray:"#a9a9a9",darkgreen:"#006400",darkkhaki:"#bdb76b",darkmagenta:"#8b008b",darkolivegreen:"#556b2f",darkorange:"#ff8c00",darkorchid:"#9932cc",darkred:"#8b0000",darksalmon:"#e9967a",darkseagreen:"#8fbc8f",darkslateblue:"#483d8b",darkslategray:"#2f4f4f",darkturquoise:"#00ced1",darkviolet:"#9400d3",deeppink:"#ff1493",deepskyblue:"#00bfff",dimgray:"#696969",dodgerblue:"#1e90ff",firebrick:"#b22222",floralwhite:"#fffaf0",forestgreen:"#228b22",fuchsia:"#ff00ff",gainsboro:"#dcdcdc",ghostwhite:"#f8f8ff",gold:"#ffd700",goldenrod:"#daa520",gray:"#808080",green:"#008000",greenyellow:"#adff2f",honeydew:"#f0fff0",hotpink:"#ff69b4","indianred ":"#cd5c5c",indigo:"#4b0082",ivory:"#fffff0",khaki:"#f0e68c",lavender:"#e6e6fa",lavenderblush:"#fff0f5",lawngreen:"#7cfc00",lemonchiffon:"#fffacd",lightblue:"#add8e6",lightcoral:"#f08080",lightcyan:"#e0ffff",lightgoldenrodyellow:"#fafad2",lightgrey:"#d3d3d3",lightgreen:"#90ee90",lightpink:"#ffb6c1",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",lightskyblue:"#87cefa",lightslategray:"#778899",lightsteelblue:"#b0c4de",lightyellow:"#ffffe0",lime:"#00ff00",limegreen:"#32cd32",linen:"#faf0e6",magenta:"#ff00ff",maroon:"#800000",mediumaquamarine:"#66cdaa",mediumblue:"#0000cd",mediumorchid:"#ba55d3",mediumpurple:"#9370d8",mediumseagreen:"#3cb371",mediumslateblue:"#7b68ee",mediumspringgreen:"#00fa9a",mediumturquoise:"#48d1cc",mediumvioletred:"#c71585",midnightblue:"#191970",mintcream:"#f5fffa",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",navajowhite:"#ffdead",navy:"#000080",oldlace:"#fdf5e6",olive:"#808000",olivedrab:"#6b8e23",orange:"#ffa500",orangered:"#ff4500",orchid:"#da70d6",palegoldenrod:"#eee8aa",palegreen:"#98fb98",paleturquoise:"#afeeee",palevioletred:"#d87093",papayawhip:"#ffefd5",peachpuff:"#ffdab9",peru:"#cd853f",pink:"#ffc0cb",plum:"#dda0dd",powderblue:"#b0e0e6",purple:"#800080",rebeccapurple:"#663399",red:"#ff0000",rosybrown:"#bc8f8f",royalblue:"#4169e1",saddlebrown:"#8b4513",salmon:"#fa8072",sandybrown:"#f4a460",seagreen:"#2e8b57",seashell:"#fff5ee",sienna:"#a0522d",silver:"#c0c0c0",skyblue:"#87ceeb",slateblue:"#6a5acd",slategray:"#708090",snow:"#fffafa",springgreen:"#00ff7f",steelblue:"#4682b4",tan:"#d2b48c",teal:"#008080",thistle:"#d8bfd8",tomato:"#ff6347",turquoise:"#40e0d0",violet:"#ee82ee",wheat:"#f5deb3",white:"#ffffff",whitesmoke:"#f5f5f5",yellow:"#ffff00",yellowgreen:"#9acd32"};class qr{constructor(t=1,s=1){this._a=t,this._b=s,this._flattening=(t-s)/t,this._f=1/this._flattening,this._a2=t*t,this._b2=s*s;const n=Math.sqrt(this._a2-this._b2);this._e=n/t,this._e2=this._e*this._e,this._e22=this._e2*this._e2,this._k=n/s,this._k2=this._k*this._k,this._radii=new v(t,t,s),this._radii2=new v(this._a2,this._a2,this._b2),this._invRadii=new v(1/t,1/t,1/s),this._invRadii2=new v(1/this._a2,1/this._a2,1/this._b2)}rhumbDistanceTo(t,s){const n=t.lat*j,o=s.lat*j,a=o-n;let l=Math.abs(s.lon-t.lon)*j;Math.abs(l)>Math.PI&&(l=l>0?-(2*Math.PI-l):2*Math.PI+l);const c=Math.log(Math.tan(o/2+Math.PI/4)/Math.tan(n/2+Math.PI/4)),d=Math.abs(c)>1e-11?a/c:Math.cos(n);return Math.sqrt(a*a+d*d*l*l)*this._a}getIntermediatePointOnGreatCircle(t,s,n){if(n==0)return t.clone();if(n==1)return s.clone();const o=this.inverse(t,s),a=o.distance,l=o.initialAzimuth;return isNaN(l)?t:this.getGreatCircleDestination(t,l,a*n)}static getBearing(t,s){let n=t.lat*j,o=t.lon*j,a=s.lat*j,l=s.lon*j,c=Math.sin(l-o)*Math.cos(a),d=Math.cos(n)*Math.sin(a)-Math.sin(n)*Math.cos(a)*Math.cos(l-o);return Math.atan2(c,d)*J}getFlattening(){return this._flattening}getEquatorialSize(){return this._a}get equatorialSize(){return this._a}get equatorialSizeSqr(){return this._a2}getPolarSize(){return this._b}get polarSize(){return this._b}get polarSizeSqr(){return this._b2}lonLatToCartesian(t){return this.geodeticToCartesian(t.lon,t.lat,t.height)}lonLatToCartesianRes(t,s){return this.geodeticToCartesian(t.lon,t.lat,t.height,s)}geodeticToCartesian(t,s,n=0,o=new v){let a=j*s,l=j*t,c=Math.sin(a),d=this._a/Math.sqrt(1-this._e2*c*c),u=(d+n)*Math.cos(a);return o.x=u*Math.cos(l),o.y=u*Math.sin(l),o.z=(d*(1-this._e2)+n)*c,o}projToSurface(t){let s=t.x||0,n=t.y||0,o=t.z||0,a=Math.sqrt(s*s+n*n+o*o);if(a===0)return this.lonLatToCartesian(new L);let l=this._invRadii2.x,c=this._invRadii2.y,d=this._invRadii2.z,u=s*s*l,_=n*n*c,f=o*o*d,g=u+_+f,m=Math.sqrt(1/g),p=t.scaleTo(m);if(g<.1)return Number.isFinite(m)?p:new v;let x=(1-m)*a/p.mulA(this._invRadii2).length(),y=0,w=0,C=0;for(;;){y=1/(1+x*l),w=1/(1+x*c),C=1/(1+x*d);let T=y*y,P=w*w,E=C*C,S=u*T+_*P+f*E-1;if(Math.abs(S)<ar)break;x+=.5*S/(u*(T*y)*l+_*(P*w)*c+f*(E*C)*d)}return new v(s*y,n*w,o*C)}cartesianToLonLat(t){return this.cartesianToLonLatRes(t)}cartesianToLonLatRes(t,s=new L){let n=this.projToSurface(t),o=this.getSurfaceNormal3v(n),a=t.sub(n);return s.lon=Math.atan2(o.y,o.x)*J,s.lat=Math.asin(o.z)*J,s.height=Math.sign(a.dot(t))*a.length(),s}getSurfaceNormal3v(t){let s=this._invRadii2,n=t.x*s.x,o=t.y*s.y,a=t.z*s.z,l=1/Math.sqrt(n*n+o*o+a*a);return new v(n*l,o*l,a*l)}getGreatCircleDistance(t,s){return this.inverse(t,s).distance}getGreatCircleDestination(t,s,n){return this.direct(t,s,n).destination}inverse(t,s){let n=this._a,o=this._b,a=this._flattening;const l=t.lat*j,c=t.lon*j,d=s.lat*j,u=s.lon*j-c,_=(1-a)*Math.tan(l),f=1/Math.sqrt(1+_*_),g=_*f,m=(1-a)*Math.tan(d),p=1/Math.sqrt(1+m*m),x=m*p,y=Math.abs(u)>Math.PI/2||Math.abs(d-l)>Math.PI/2;let w=u,C=null,T=null,P=y?Math.PI:0,E=0,S=y?-1:1,M=null,R=1,k=1,B=null,z=0;do{if(C=Math.sin(w),T=Math.cos(w),M=(p*C)**2+(f*x-g*p*T)**2,Math.abs(M)<1e-24)break;E=Math.sqrt(M),S=g*x+f*p*T,P=Math.atan2(E,S);const I=f*p*C/E;k=1-I*I,R=k!=0?S-2*g*x/k:0;const N=a/16*k*(4+a*(4-3*k));B=w,w=u+(1-N)*a*I*(P+N*E*(R+N*S*(2*R*R-1)))}while(Math.abs(w-B)>ar&&++z<1e3);const O=k*(n*n-o*o)/(o*o),ze=O/1024*(256+O*(O*(74-47*O)-128)),D=o*(1+O/16384*(4096+O*(O*(320-175*O)-768)))*(P-ze*E*(R+ze/4*(S*(2*R*R-1)-ze/6*R*(4*E*E-3)*(4*R*R-3)))),re=Math.abs(M)<Number.EPSILON?0:Math.atan2(p*C,f*x-g*p*T),Ee=Math.abs(M)<Number.EPSILON?Math.PI:Math.atan2(f*C,-g*p+f*x*T);return{distance:D,initialAzimuth:Math.abs(D)<Number.EPSILON?NaN:Ue(re)*J,finalAzimuth:Math.abs(D)<Number.EPSILON?NaN:Ue(Ee)*J}}direct(t,s,n){let o=t.lon,a=t.lat,l=this._a,c=this._b,d=this._flattening,u=n,_=s*j,f=Math.sin(_),g=Math.cos(_),m=(1-d)*Math.tan(a*j),p=1/Math.sqrt(1+m*m),x=m*p,y=Math.atan2(m,g),w=p*f,C=1-w*w,T=C*(l*l-c*c)/(c*c),P=1+T/16384*(4096+T*(T*(320-175*T)-768)),E=T/1024*(256+T*(T*(74-47*T)-128)),S=u/(c*P),M=2*Math.PI,R=0,k=0,B=0,z=0;for(;Math.abs(S-M)>1e-12;)R=Math.cos(2*y+S),k=Math.sin(S),B=Math.cos(S),z=E*k*(R+E/4*(B*(2*R*R-1)-E/6*R*(4*k*k-3)*(4*R*R-3))),M=S,S=u/(c*P)+z;let O=x*k-p*B*g,ze=Math.atan2(x*B+p*k*g,(1-d)*Math.sqrt(w*w+O*O)),D=d/16*C*(4+d*(4-3*C)),re=Math.atan2(k*f,p*B-x*k*g)-(1-D)*d*w*(S+D*k*(R+D*B*(2*R*R-1))),Ee=Math.atan2(w,-O);return{destination:new L(o+re*J,ze*J),finalAzimuth:Ee*J}}hitRay(t,s){let n,o,a,l,c,d=this._invRadii.mul(t),u=this._invRadii.mul(s),_=d.dot(d),f=d.dot(u);if(_>1){if(f>=0)return;var g=f*f;if(n=_-1,o=u.dot(u),a=o*n,Math.abs(g-a)>1e-15&&g<a)return;if(g>a){l=f*f-a,c=-f+Math.sqrt(l);var m=c/o,p=n/c;return m<p?t.add(s.scaleTo(m)):t.add(s.scaleTo(p))}var x=Math.sqrt(n/o);return t.add(s.scaleTo(x))}return _<1?(n=_-1,o=u.dot(u),a=o*n,l=f*f-a,c=-f+Math.sqrt(l),t.add(s.scaleTo(c/o))):f<0?(o=u.dot(u),t.add(s.scaleTo(-f/o))):void 0}getNorthFrameRotation(t){let s=this.getSurfaceNormal3v(t),n=v.proj_b_to_plane(v.NORTH,s);return F.getLookRotation(n,s)}getBearingDestination(t,s=0,n=0){s*=j;var o=(t.lon+540)%360-180,a=t.lat*j,l=o*j,c=n/this._a,d=Math.asin(Math.sin(a)*Math.cos(c)+Math.cos(a)*Math.sin(c)*Math.cos(s));return new L((l+Math.atan2(Math.sin(s)*Math.sin(c)*Math.cos(a),Math.cos(c)-Math.sin(a)*Math.sin(d)))*J,d*J)}static getIntermediatePointOnGreatCircle(t,s,n){var o=t.lat*j,a=t.lon*j,l=s.lat*j,c=s.lon*j,d=Math.sin(o),u=Math.cos(o),_=Math.sin(a),f=Math.cos(a),g=Math.sin(l),m=Math.cos(l),p=Math.sin(c),x=Math.cos(c),y=l-o,w=c-a,C=Math.sin(y/2)*Math.sin(y/2)+Math.cos(o)*Math.cos(l)*Math.sin(w/2)*Math.sin(w/2),T=2*Math.atan2(Math.sqrt(C),Math.sqrt(1-C)),P=Math.sin((1-n)*T)/Math.sin(T),E=Math.sin(n*T)/Math.sin(T),S=P*u*f+E*m*x,M=P*u*_+E*m*p,R=P*d+E*g,k=Math.atan2(R,Math.sqrt(S*S+M*M)),B=Math.atan2(M,S);return new L((B*J+540)%360-180,k*J)}static getRhumbBearing(t,s){var n=(s.lon-t.lon)*j,o=Math.log(Math.tan(s.lat*j/2+Math.PI/4)/Math.tan(t.lat*j/2+Math.PI/4));return Math.abs(n)>Math.PI&&(n=n>0?-1*(2*Math.PI-n):2*Math.PI+n),(Math.atan2(n,o)*J+360)%360}getLonLatVisibilitySimple(t,s,n){const o=this.lonLatToCartesian(s),a=s.height,l=this.polarSize+a,c=Math.max(t.length()-this.polarSize,0),d=o.sub(t);let u;return u=c>0?Math.sqrt((l+c)**2-l**2):l,u>d.length()&&(!n||n.dot(d.normalize())>0)}}const So=new qr(6378137,6356752314245179e-9);function Vi(h,t){return h??t}function Gt(h){return h==null}function vn(h){return h===void 0}let Fa=0;function Yr(h){let t=h._openglobus_id;return t||(t=h._openglobus_id=++Fa),t}function ks(h){return typeof h=="string"||h instanceof String}function ke(h){return h.toString(16).padStart(2,"0")}function cr(h){let t,s,n;return h instanceof Array?(t=ke(h[0]),s=ke(h[1]),n=ke(h[2])):(t=ke(h.x),s=ke(h.y),n=ke(h.z)),`#${t}${s}${n}`}function he(h,t){let s=Po[h];if(s&&(h=s),h[0]==="#"){let n=/^#?([a-f\d])([a-f\d])([a-f\d])$/i,o=h.replace(n,function(l,c,d,u){return c+c+d+d+u+u}),a=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(o);return a?new et(parseInt(a[1],16)/255,parseInt(a[2],16)/255,parseInt(a[3],16)/255,Gt(t)?1:t):new et}{Gt(t)&&(t=1);let n=h.split(",");return new et(parseInt(n[0].split("(")[1])/255,parseInt(n[1])/255,parseInt(n[2])/255,Gt(n[3])?t:parseFloat(n[3]))}}function ve(h,t){let s=he(h,t);return new Float32Array([s.x,s.y,s.z,s.w])}function ts(h){let t=Po[h];if(t&&(h=t),h[0]==="#"){let s=/^#?([a-f\d])([a-f\d])([a-f\d])$/i,n=h.replace(s,function(a,l,c,d){return l+l+c+c+d+d}),o=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(n);return o?new v(parseInt(o[1],16)/255,parseInt(o[2],16)/255,parseInt(o[3],16)/255):new v}{let s=h.split(",");return new v(parseInt(s[0].split("(")[1])/255,parseInt(s[1])/255,parseInt(s[2])/255)}}function Dt(h,t){return h.replace(/{[^{}]+}/g,function(s){return t[s.replace(/[{}]+/g,"")]||""})}function di(h,t){return h.replace(/\$\{([^}]+)\}/g,(s,n)=>(t==null?void 0:t[n.trim()])??"")}function Wr(h){let t=document.createElement("div");t.innerHTML=h;let s=[];for(let n=0;n<t.childNodes.length;n++)s.push(t.childNodes[n]),t.removeChild(t.childNodes[n]);return s}function Ro(h,t,s,n){let o=document.getElementById(h);o||(o=document.createElement("div"),o.id=h,o.classList.add("defaultText"),document.body.appendChild(o)),o.innerHTML=t,o.style.left=`${s}px`,o.style.top=`${n}px`}function Mo(h){return typeof h=="number"}function Bo(h,t=""){return h?h.trim():t}function Yt(h,t){if(h){if(Mo(h))return new v(h,h,h);if(h instanceof v)return h.clone();if(h instanceof Array)return v.fromVec(h);if(h instanceof H)return new v(h.x,h.y,0)}else if(t)return t;return new v}function le(h,t){if(h){if(ks(h))return he(h);if(h instanceof Array)return et.fromVec(h);if(h instanceof et)return h.clone()}else if(t)return t;return new et(1,1,1,1)}function jt(h,t){if(h){if(ks(h))return ts(h);if(h instanceof Array)return v.fromVec(h);if(h instanceof v)return h.clone()}else if(t)return t;return new v(1,1,1)}function $r(h,t){if(h){if(h instanceof Array)return new U(vi(h[0]),vi(h[1]));if(h instanceof U)return h.clone()}else if(t)return t;return new U}function vi(h,t){if(h){if(h instanceof Array)return new L(h[0],h[1],h[2]);if(h instanceof L)return h.clone()}else if(t)return t;return new L}function Xr(h,t){let s=0,n=h.length-1;for(;s<=n;){let o=Math.floor(.5*(s+n));if(Math.abs(h[o]-t)<.001)return o;h[o]<t?s=o+1:n=o-1}return-1}function Re(h,t,s){let n=0,o=h.length-1;for(;n<=o;){let a=o+n>>1,l=s(t,h[a],a);if(l>0)n=a+1;else{if(!(l<0))return a;o=a-1}}return-n-1}function Zr(h,t,s){let n=Re(h,t,s);return n<0&&(n=~n),h.splice(n,0,t),n}function ko(h,t,s,n,o=!1){let a=new L(t.lon-h.lon,t.lat-h.lat),l=new L(n.lon-s.lon,n.lat-s.lat),c=-a.lat,d=+a.lon,u=-(c*h.lon+d*h.lat),_=-l.lat,f=+l.lon,g=-(_*s.lon+f*s.lat),m=_*h.lon+f*h.lat+g,p=_*t.lon+f*t.lat+g,x=c*s.lon+d*s.lat+u,y=c*n.lon+d*n.lat+u;if(o&&(m*p>0||x*y>0))return;let w=m/(m-p);return new L(h.lon+w*a.lon,h.lat+w*a.lat)}const Oa={string:function(h){return Gt(h)?h:h.toString()},date:function(h){return Gt(h)?h:new Date(1e3*h)},datetime:function(h){return Gt(h)?h:new Date(1e3*h)},time:function(h){return Gt(h)?h:parseInt(h)},integer:function(h){return Gt(h)?h:parseInt(h)},float:function(h){return Gt(h)?h:parseFloat(h)},boolean:function(h){if(h===null)return h;if(typeof h=="boolean")return h===!0;if(typeof h=="string"){if(h==="")return!1;if((h=h.replace(/^\s+|\s+$/g,"")).toLowerCase()==="true"||h.toLowerCase()==="yes")return!0;h=(h=h.replace(/,/g,".")).replace(/^\s*\-\s*/g,"-")}return!isNaN(h)&&parseFloat(h)!==0}};function yn(h,t=""){let s=1024,n=atob(h),o=n.length,a=Math.ceil(o/s),l=new Array(a);for(let c=0;c<a;++c){let d=c*s,u=Math.min(d+s,o),_=new Array(u-d);for(let f=d,g=0;f<u;++g,++f)_[g]=n[f].charCodeAt(0);l[c]=new Uint8Array(_)}return new Blob(l,{type:t})}function yi(h,t,s=!1){let n,o=0;return function(){const a=arguments;o?(s&&clearTimeout(n),n=setTimeout(()=>{Date.now()-o>=t&&(h.apply(null,a),o=Date.now())},t-(Date.now()-o))):(h.apply(null,a),o=Date.now())}}function it(h,t){let s=new h.constructor(h.length+t.length);return s.set(h,0),s.set(t,h.length),s}function bt(h=[],t=[]){if(ArrayBuffer.isView(h))return it(h,t);for(let s=0;s<t.length;s++)h.push(t[s]);return h}function st(h,t=Float32Array){if(ArrayBuffer.isView(h))return h;{const s=new t(h.length);return s.set(h,0),s}}function Ve(h){return ArrayBuffer.isView(h)?Array.from(h):h}function Et(h,t,s,n){if(ArrayBuffer.isView(h))return t<0&&(s=Math.abs(t),t+=h.length),ot(h,t,s,n);{let o;return o=t<0?h.splice(t):h.splice(t,s),n&&(n.result=o),h}}function ot(h,t,s,n){if(h.length===0)return h;const o=h.length-s,a=new h.constructor(o);return a.set(h.subarray(0,t)),a.set(h.subarray(t+s),t),n&&(n.result=h.subarray(t,t+s)),a}function Kr(h,t,s,n,o){const a=o+1,l=s+a,c=n+a;let d=new Float64Array(a*a*3),u=0;for(let _=s;_<l;_++)for(let f=n;f<c;f++){let g=3*(_*(t+1)+f);d[u++]=h[g],d[u++]=h[g+1],d[u++]=h[g+2]}return d}function Io(h,t,s,n,o){const a=o+1,l=s+a,c=n+a;let d=new Float32Array(a*a*3),u=0;for(let _=s;_<l;_++)for(let f=n;f<c;f++){let g=3*(_*(t+1)+f);d[u++]=h[g],d[u++]=h[g+1],d[u++]=h[g+2]}return d}function dr(h,t,s,n,o,a,l,c,d,u,_,f,g){const m=a+c+1,p=l+c+1;o+=1;let x=0,y=0;for(let w=a;w<m;w++)for(let C=l;C<p;C++){let T=w*o+C,P=3*T,E=h[P],S=h[P+1],M=h[P+2];n&&n[T]!==0?g[y]=1:(E<f.xmin&&(f.xmin=E),E>f.xmax&&(f.xmax=E),S<f.ymin&&(f.ymin=S),S>f.ymax&&(f.ymax=S),M<f.zmin&&(f.zmin=M),M>f.zmax&&(f.zmax=M)),y++,d[x]=E,_[x]=s[P],u[x++]=t[P],d[x]=S,_[x]=s[P+1],u[x++]=t[P+1],d[x]=M,_[x]=s[P+2],u[x++]=t[P+2]}}function Qr(h){return h.map(t=>Array.isArray(t)?Qr(t):t)}async function Ui(h){return new Promise(t=>{const s=new Image;return s.addEventListener("load",()=>{t(s)}),s.src=h,s.crossOrigin="",s})}function ur(h){return h.complete&&h.naturalHeight!==0}function Ge(h){return h>1e3?h-Math.floor(h)!=0?[(h/1e3).toFixed(2),"km"]:[(h/1e3).toFixed(0),"km"]:h>9?[Math.round(h).toString(),"m"]:h<=.01?["0","m"]:[h.toFixed(1),"m"]}function zo(h){let t=new URLSearchParams(location.search).get(h);if(t)return Number(t)}function _r(h,t=-1){if(t<0)return h.toString();const s=Math.pow(10,t);return(Math.round(h*s)/s).toString()}Object.freeze(Object.defineProperty({__proto__:null,base64StringToBlog:function(h){let t=h.split(";"),s=t[0].split(":")[1];return yn(t[1].split(",")[1],s)},base64toBlob:yn,binaryInsert:Zr,binarySearch:Re,binarySearchFast:Xr,blerp:function(h,t,s,n,o,a,l=0,c=1,d=0,u=1){return(s*(c-h)*(u-t)+n*(h-l)*(u-t)+o*(c-h)*(t-d)+a*(h-l)*(t-d))/((c-l)*(u-d))},blerp2:function(h,t,s,n,o,a){return s*(1-h)*(1-t)+n*h*(1-t)+o*(1-h)*t+a*h*t},castType:Oa,cloneArray:Qr,concatArrays:bt,concatTypedArrays:it,createColorRGB:jt,createColorRGBA:le,createExtent:$r,createLonLat:vi,createVector3:Yt,createVector4:function(h,t){if(h){if(h instanceof et)return h.clone();if(h instanceof Array)return et.fromVec(h)}else if(t)return t;return new et},defaultString:Bo,distanceFormat:function(h){return h>1e3?`${(h/1e3).toFixed(2)} km`:h>9?`${Math.round(h)} m`:`${h.toFixed(1)} m`},distanceFormatExt:Ge,extractElevationTiles:function(h,t,s){let n=Math.sqrt(t.length)-1,o=n+1,a=Math.sqrt(h.length/4),l=a/n,c=0,d=0;for(let u=0,_=0,f=h.length/4;u<f;u++){let g=h[4*u],m=Math.floor(u/a),p=u%a,x=Math.floor(p/n),y=Math.floor(m/n),w=s[y][x],C=m%n,T=p%n,P=(C+y)*o+T+x;if(w[P]=g,(m+y)%l==0&&(p+x)%l==0&&(t[_++]=g),(p+1)%n==0&&p!==a-1){c=h[4*(u+1)];let E=.5*(g+c);P=(C+y)*o+T+1,w[P]=E,(m+y)%l==0&&(t[_++]=E);let S=(C+y)*o+(T+1)%n;s[y][x+1][S]=E}if((m+1)%n==0&&m!==a-1){d=h[4*(u+a)];let E=.5*(g+d);P=(C+1)*o+T+x,w[P]=E,(p+x)%l==0&&(t[_++]=E);let S=(C+1)%n*o+T+x;s[y+1][x][S]=E}if((p+1)%n==0&&p!==a-1&&(m+1)%n==0&&m!==a-1){let E=.25*(g+c+d+h[4*(u+a+1)]);P=(C+1)*o+(T+1),w[P]=E,t[_++]=E;let S=(C+1)*o;s[y][x+1][S]=E;let M=n;s[y+1][x][M]=E;let R=0;s[y+1][x+1][R]=E}}},getDefault:Vi,getHTML:function(h,t){return Dt(h,t)},getLinesIntersection2v:function(h,t,s,n,o){let a=t.sub(h),l=n.sub(s),c=-a.y,d=+a.x,u=-(c*h.x+d*h.y),_=-l.y,f=+l.x,g=-(_*s.x+f*s.y),m=_*h.x+f*h.y+g,p=_*t.x+f*t.y+g,x=c*s.x+d*s.y+u,y=c*n.x+d*n.y+u;if(o&&(m*p>0||x*y>0))return;let w=m/(m-p);return new H(h.x+w*a.x,h.y+w*a.y)},getLinesIntersectionLonLat:ko,getMatrixSubArray32:Io,getMatrixSubArray64:Kr,getMatrixSubArrayBoundsExt:dr,getTileImageResolution:function(h,t,s,n=256,o=So){let a=Ze(h,t,s),l=a.getSouthWest().inverseMercator(),c=a.getNorthEast().inverseMercator();return[o.getGreatCircleDistance(l,new L(c.lon,l.lat))/n,o.getGreatCircleDistance(l,new L(l.lon,c.lat))/n]},getUrlParam:zo,htmlColorToFloat32Array:ve,htmlColorToRgb:ts,htmlColorToRgba:he,isEmpty:Gt,isImageLoaded:ur,isNumber:Mo,isString:ks,isUndef:vn,isUndefExt:function(h,t){return vn(h)?t:h},loadImage:Ui,makeArray:Ve,makeArrayTyped:st,parseHTML:Wr,print2d:Ro,rgbToStringHTML:cr,spliceArray:Et,spliceTypedArray:ot,stamp:Yr,stringTemplate:Dt,stringTemplate2:di,throttle:yi,toFixedMax:_r,xmlToJson:function h(t){let s={};if(t.nodeType===1){if(t.attributes.length>0){s["@attributes"]={};for(let n=0;n<t.attributes.length;n++){let o=t.attributes.item(n);s["@attributes"][o.nodeName]=o.nodeValue}}}else t.nodeType===3&&(s=t.nodeValue);if(t.hasChildNodes())for(let n=0;n<t.childNodes.length;n++){let o=t.childNodes.item(n),a=o.nodeName;if(s[a]===void 0)s[a]=h(o);else{if(s[a].push===void 0){let l=s[a];s[a]=[],s[a].push(l)}s[a].push(h(o))}}return s}},Symbol.toStringTag,{value:"Module"}));const Gi=1e3,fr=1/60,xn=1/24,xi=3600,gr=1/xi,Jr=43200,ji=1440,Na=1/ji,ee=86400,Ha=864e5,tn=11574074074074074e-24,oe=1/ee,es=2451545;function Do(h,t,s){let n=(t-14)/12|0,o=h+4800+n;return(1461*o/4|0)+(367*(t-2-12*n)/12|0)-(3*((o+100)/100|0)/4|0)+s-32075}function is(h){let t=Do(h.getUTCFullYear(),h.getUTCMonth()+1,h.getUTCDate()),s=h.getUTCHours()-12;s<0&&(s+=24);let n=h.getUTCSeconds()+s*xi+60*h.getUTCMinutes()+.001*h.getUTCMilliseconds();n>=Jr&&t--;let o=n*oe|0;return t+=o,n-=ee*o,n<0&&(t--,n+=ee),t+n*oe}function pr(h){let t=Oo,s=Re(t,h,function(o,a){return o-a.jd});s<0&&(s=~s),s>=t.length&&(s=t.length-1);let n=t[s].leapSeconds;return s!==0&&(t[s].jd-h)*ee>n&&(n=t[s-1].leapSeconds),h+n*oe}function Gs(h){let t=Oo,s=Re(t,h,function(o,a){return o-a.jd});if(s<0&&(s=~s),s>=t.length)return h-t[s-1].leapSeconds*oe;if(s===0)return h-t[0].leapSeconds*oe;let n=(t[s].jd-h)*ee;return n===0?h-t[s].leapSeconds*oe:n<=1?void 0:h-t[s-1].leapSeconds*oe}function mr(h){let t=0|h,s=(h-t)*ee;s>=Jr&&t++;let n=t+68569|0,o=4*n/146097|0;n=n-((146097*o+3)/4|0)|0;let a=4e3*(n+1)/1461001|0;n=n-(1461*a/4|0)+31|0;let l=80*n/2447|0,c=n-(2447*l/80|0)|0;n=l/11|0;let d=l+2-12*n|0,u=100*(o-49)+a+n|0,_=s*gr|0,f=s-_*xi,g=f*fr|0;f-=60*g;let m=0|f,p=(f-m)*Gi|0;return _+=12,_>23&&(_-=24),new Date(Date.UTC(u,d-1,c,_,g,m,p))}function Fo(h,t){return h+t*tn}function bn(h,t){return h+t*oe}function nt(h,t){return{jd:h,leapSeconds:t}}const Oo=[nt(24413175e-1,10),nt(24414995e-1,11),nt(24416835e-1,12),nt(24420485e-1,13),nt(24424135e-1,14),nt(24427785e-1,15),nt(24431445e-1,16),nt(24435095e-1,17),nt(24438745e-1,18),nt(24442395e-1,19),nt(24447865e-1,20),nt(24451515e-1,21),nt(24455165e-1,22),nt(24462475e-1,23),nt(24471615e-1,24),nt(24478925e-1,25),nt(24482575e-1,26),nt(24488045e-1,27),nt(24491695e-1,28),nt(24495345e-1,29),nt(24500835e-1,30),nt(24506305e-1,31),nt(24511795e-1,32),nt(24537365e-1,33),nt(24548325e-1,34),nt(24561095e-1,35),nt(24572045e-1,36)],Va=pr(es);Object.freeze(Object.defineProperty({__proto__:null,DAYS_PER_JULIAN_CENTURY:36525,DAYS_PER_JULIAN_YEAR:365.25,DateToTAI:function(h){return pr(is(h))},DateToUTC:is,HOURS_PER_DAY:24,J2000:es,J2000TAI:Va,MILLISECONDS_PER_DAY:Ha,MILLISECONDS_PER_SECOND:Gi,MINUTES_PER_DAY:ji,MINUTES_PER_HOUR:60,MODIFIED_JULIAN_DATE_DIFFERENCE:24000005e-1,ONE_BY_HOURS_PER_DAY:xn,ONE_BY_MILLISECONDS_PER_DAY:tn,ONE_BY_MINUTES_PER_DAY:Na,ONE_BY_SECONDS_PER_DAY:oe,ONE_BY_SECONDS_PER_HOUR:gr,ONE_BY_SECONDS_PER_MINUTE:fr,PICOSECOND:1e-9,SECONDS_PER_12_HOURS:Jr,SECONDS_PER_DAY:ee,SECONDS_PER_HOUR:xi,SECONDS_PER_MILLISECOND:.001,SECONDS_PER_MINUTE:60,T:function(h){return(h-es)/36525},TAItoDate:function(h){let t=Gs(h);return t||(t=Gs(bn(h,-1)),console.trace(`TAItoDate - can't convert ${h.toString()} to utc.`)),mr(t)},TAItoUTC:Gs,UTCtoDate:mr,UTCtoTAI:pr,addDays:function(h,t){return h+t},addHours:function(h,t){return h+t*xn},addMilliseconds:Fo,addMinutes:function(h,t){return h+t*ji},addSeconds:bn,daysToSeconds:function(h){return h*ee},getDayNumber:Do,getDays:function(h){return 0|h},getHours:function(h){let t=(h-(0|h))*ee,s=t*gr|0,n=t-s*xi,o=n*fr|0;n-=60*o;let a=0|n;return s+=12+o/60+a/3600+((n-a)*Gi|0)/1e3,s>23&&(s-=24),s},getMilliseconds:function(h){let t=h-(0|h);return t*=ee,(t-(0|t))*Gi|0},getMinutes:function(h){return(h-(0|h))*ji|0},getSeconds:function(h){return(h-(0|h))*ee},secondsToDays:function(h){return h*oe}},Symbol.toStringTag,{value:"Module"}));class No{constructor(t){this.vertices=[new v,new v,new v,new v,new v,new v,new v,new v],t&&this.setFromBoundsArr(t)}copy(t){for(let s=0,n=this.vertices.length;s<n;s++)this.vertices[s].copy(t.vertices[s])}setFromBoundsArr(t){let s=t[0],n=t[3],o=t[1],a=t[4],l=t[2],c=t[5],d=this.vertices;d[0].set(s,o,l),d[1].set(n,o,l),d[2].set(n,o,c),d[3].set(s,o,c),d[4].set(s,a,l),d[5].set(n,a,l),d[6].set(n,a,c),d[7].set(s,a,c)}setFromExtent(t,s){this.setFromBoundsArr(s.getCartesianBounds(t))}}class Ft{constructor(t=0,s){this.radius=t,this.center=s?s.clone():new v}setFromBounds(t){let s=new v(t[0],t[1],t[2]);this.center.set(s.x+.5*(t[3]-s.x),s.y+.5*(t[3]-s.y),s.z+.5*(t[5]-s.z)),this.radius=this.center.distance(s)}setFromExtent(t,s){this.setFromBounds(s.getCartesianBounds(t))}}Object.freeze(Object.defineProperty({__proto__:null,Box:No,Sphere:Ft},Symbol.toStringTag,{value:"Module"}));function lt(h,t){return new bi(h,t)}const cs=class rd{constructor(t,s){this.__id=rd.__counter__++,this._eventNames=[],t&&this.registerNames(t),this._sender=s||this,this._stopPropagation=!1,this._stampCache={}}bindSender(t){this._sender=t||this}registerNames(t){for(let s=0;s<t.length;s++)this[t[s]]={active:!0,handlers:[]},this._eventNames.push(t[s]);return this}_getStamp(t,s,n){return`${t}_${s}_${n}`}_stamp(t,s){let n=Yr(s),o=this._getStamp(t,this.__id,n);return!this._stampCache[o]&&(this._stampCache[o]=n,!0)}on(t,s,n,o=0){if(this._stamp(t,s)&&this[t]){let a=s.bind(n||this._sender);a._openglobus_id=s._openglobus_id,a._openglobus_priority=o,Zr(this[t].handlers,a,(l,c)=>(c._openglobus_priority||0)-(l._openglobus_priority||0))}}off(t,s){if(s){let n=this._getStamp(t,this.__id,s._openglobus_id);if(s._openglobus_id&&this._stampCache[n]){let o=this[t].handlers,a=o.length,l=-1;for(;a--;)if(o[a]._openglobus_id===s._openglobus_id){l=a;break}l!==-1&&(o.splice(l,1),this._stampCache[n]=void 0,delete this._stampCache[n])}}}dispatch(t,...s){let n=!0;if(t&&t.active&&!this._stopPropagation){let o=t.handlers.slice(0),a=o.length;for(;a--;)o[a](...s)===!1&&(n=!1)}return this._stopPropagation=!1,n}stopPropagation(){this._stopPropagation=!0}clear(){for(let t=0;t<this._eventNames.length;t++){let s=this[this._eventNames[t]];s.handlers.length=0,s.handlers=[]}this._eventNames.length=0,this._eventNames=[]}};cs.__counter__=0;let bi=cs;const Ua=["render"],Vt=class Os{constructor(t={}){this.__id=Os.__counter__++,this.events=lt(Ua),this.model=t.model||null,this.template=t.template||"",this.parent=t.parent||null,this._classList=t.classList||[],this.el=null,t.initRender&&this.render()}on(t,s,n,o){this.events.on(t,s,n,o)}off(t,s){this.events.off(t,s)}static getHTML(t,s){return Dt(t,s)}static parseHTML(t){return Wr(t)}static insertAfter(t,s){Array.isArray(t)||(t=[t]);for(let n=0;n<t.length;n++)s.parentNode&&s.parentNode.insertBefore(t[n],s.nextSibling);return t}static insertBefore(t,s){Array.isArray(t)||(t=[t]);for(let n=0;n<t.length;n++)s.parentNode&&s.parentNode.insertBefore(t[n],s);return t}insertBefore(t){this.el||this.render(),this.el&&(t instanceof HTMLElement&&t.parentNode&&Os.insertBefore(this.el,t),t instanceof Os&&t.el&&t.el.parentNode&&Os.insertBefore(this.el,t.el))}insertAfter(t){this.el||this.render(),this.el&&(t instanceof HTMLElement&&t.parentNode&&Os.insertAfter(this.el,t),t instanceof Os&&t.el&&t.el.parentNode&&Os.insertAfter(this.el,t.el))}isEqual(t){return t.__id===this.__id}appendTo(t,s=!1,n=!1){return t&&(this.el||(this.beforeRender(t),this.render()),this.el&&this.el.parentNode&&this.el.parentNode.removeChild(this.el),s&&(t.innerHTML=""),this.el&&(n&&t.childNodes[0]?Os.insertBefore(this.el,t.childNodes[0]):t.appendChild(this.el)),this.afterRender(t)),this}afterRender(t){}beforeRender(t){}stopPropagation(){this.events.stopPropagation()}renderTemplate(t){return Os.parseHTML(Os.getHTML(this.template,t||{}))[0]}render(t){this.el=this.renderTemplate(t);for(let s=0,n=this._classList.length;s<n;s++)this.el.classList.add(this._classList[s]);return this.events.dispatch(this.events.render,this),this}select(t){return this.el?this.el.querySelector(t):null}selectRemove(t){if(this.el){let s=this.select(t);if(s&&s.parentNode)return s.parentNode.removeChild(s),s}}selectAll(t,s){if(this.el){const n=this.el.querySelectorAll(t);if(s)for(let o=0,a=n.length;o<a;o++)s(n[o],o);return n}}remove(){this.el&&this.el.parentNode&&this.el.parentNode.removeChild(this.el)}};Vt.__counter__=0;let ut=Vt;const Ga=["click","mousedown","mouseup","touchstart","touchend","touchcancel"];class ce extends ut{constructor(t={}){super({template:Dt(`<div class="og-button" title="{title}">
       <div class="og-button-icon">{icon}</div>
       <div class="og-button-text">{text}</div>
    </div>`,{icon:t.icon||"",text:t.text||"",title:t.title||""}),...t}),this._onMouseDown=s=>{s.preventDefault(),this.events.dispatch(this.events.mousedown,this,s)},this._onMouseUp=s=>{s.preventDefault(),this.events.dispatch(this.events.mouseup,this,s)},this._onTouchStart=s=>{s.preventDefault(),this.events.dispatch(this.events.touchstart,this,s)},this._onTouchEnd=s=>{s.preventDefault(),this.events.dispatch(this.events.touchend,this,s)},this._onTouchCancel=s=>{s.preventDefault(),this.events.dispatch(this.events.touchcancel,this,s)},this._onMouseClick=s=>{this._mouseClickHandler(s)},this.events=this.events.registerNames(Ga),this.el=null,this.name=t.name||"",this.$icon=null,this.$text=null}render(t){return super.render(t),this.$icon=this.select(".og-button-icon"),this.$text=this.select(".og-button-text"),this.el.__og_button__=this,this._initEvents(),this}_initEvents(){this.el&&(this.el.addEventListener("click",this._onMouseClick),this.el.addEventListener("mousedown",this._onMouseDown),this.el.addEventListener("mouseup",this._onMouseUp),this.el.addEventListener("touchstart",this._onTouchStart),this.el.addEventListener("touchend",this._onTouchEnd),this.el.addEventListener("touchcancel",this._onTouchCancel))}_mouseClickHandler(t){t.preventDefault(),this.events.dispatch(this.events.click,this,t)}remove(){this._clearEvents(),super.remove()}_clearEvents(){this.el&&this.el.removeEventListener("click",this._onMouseClick)}}const ds=class nd{constructor(t={}){this.__id=nd.__counter__++,this._name=t.name||`_control_${this.__id.toString()}`,this.planet=null,this._initialized=!1,this.renderer=null,this.autoActivate=t.autoActivate||!1,this._active=!1,this._deferredActive=!0}get name(){return this._name}oninit(){}onadd(){}onremove(){}onactivate(){}ondeactivate(){}addTo(t){t&&(this.renderer=t,t.controls[this.name]=this,this.onadd&&this.onadd(),t.isInitialized()&&!this._initialized&&(this._initialized=!0,this.oninit&&this.oninit(),this.autoActivate&&this.activate()))}remove(){this.deactivate(),this.onremove&&this.onremove();let t=this.renderer,s=this.name;if(!t)return;let n=t.controls[s];n&&this.isEqual(n)&&delete t.controls[s],this.renderer=null,this._active=!1,this._initialized=!1}activate(){this._active||(this._initialized||(this._initialized=!0,this.oninit&&this.oninit()),this._deferredActive?(this._active=!0,this.onactivate&&this.onactivate()):this._deferredActive=!0)}deactivate(){this._active?(this._active=!1,this.ondeactivate&&this.ondeactivate()):this._initialized||(this._deferredActive=!1)}isActive(){return this._active}isEqual(t){return t.__id===this.__id}};ds.__counter__=0;let Q=ds;class Ho extends Q{constructor(t={}){super(t),this._heading=0,this._svg=null}oninit(){let t=new ce({classList:["og-map-button","og-compass-button"],icon:`<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<svg
   xmlns:dc="http://purl.org/dc/elements/1.1/"
   xmlns:cc="http://creativecommons.org/ns#"
   xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
   xmlns:svg="http://www.w3.org/2000/svg"
   xmlns="http://www.w3.org/2000/svg"
   xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd"
   xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"
   viewBox="0 0 110.6 110.3"
   version="1.1"
   id="svg21"
   sodipodi:docname="aaa.svg"
   inkscape:version="0.92.3 (2405546, 2018-03-11)">
  <metadata
     id="metadata11">
    <rdf:RDF>
      <cc:Work
         rdf:about="">
        <dc:format>image/svg+xml</dc:format>
        <dc:type
           rdf:resource="http://purl.org/dc/dcmitype/StillImage" />
      </cc:Work>
    </rdf:RDF>
  </metadata>
  <defs
     id="defs25" />
  <sodipodi:namedview
     pagecolor="#ffffff"
     bordercolor="#666666"
     borderopacity="1"
     objecttolerance="10"
     gridtolerance="10"
     guidetolerance="10"
     inkscape:pageopacity="0"
     inkscape:pageshadow="2"
     inkscape:window-width="1920"
     inkscape:window-height="1001"
     id="namedview23"
     showgrid="false"
     inkscape:zoom="9.4900968"
     inkscape:cx="28.376998"
     inkscape:cy="60.17054"
     inkscape:window-x="-9"
     inkscape:window-y="-9"
     inkscape:window-maximized="1"
     inkscape:current-layer="svg21" />
  <g
     id="Layer_2"
     data-name="Layer 2"
     transform="matrix(1,0,0,-1,0,110.3)">
    <g
       id="Слой_1"
       data-name="Слой 1">
      <g
         id="_Group_"
         data-name="&lt;Group&gt;">
        <g
           id="_Group_7"
           data-name="&lt;Group&gt;">
          <polygon
             id="_Path_7"
             data-name="&lt;Path&gt;"
             points="55.2,97.6 55.3,97.4 55.3,97.6 55.3,97.2 65.3,55.1 55.3,55.1 55.2,55.1 45.3,55.1 55.2,97.2 "
             style="fill:#ff2b45" />
          <polygon
             id="_Path_8"
             data-name="&lt;Path&gt;"
             points="55.3,12.7 55.3,12.9 55.2,12.7 55.2,13.1 45.3,55.1 55.2,55.1 55.3,55.1 65.3,55.1 55.3,13.1 "
             style="fill:#cecece;" />
        </g>
      </g>
    </g>
  </g>
</svg>`});t.appendTo(this.renderer.div),t.events.on("click",this._onClick,this),t.events.on("touchstart",this._onClick,this),this._svg=t.select("svg"),this.renderer.events.on("draw",this._draw,this)}_onClick(){const t=this.planet;let s=t.getCartesianFromPixelTerrain(this.renderer.handler.getCenter());s?t.flyCartesian(s.normal().scaleTo(s.length()+s.distance(t.camera.eye)),{amplitude:0,completeCallback:()=>{t.camera.look(s)}}):t.flyCartesian(t.camera.eye)}_draw(){this.setHeading(this.planet.camera.getHeading())}setHeading(t){this._heading!==t&&(this._heading=t,this._svg.style.transform=`rotateZ(${-t}deg)`)}}const Vo=`<svg className="svg-icon" style="width: 1em; height: 1em;vertical-align: middle;fill: currentColor; overflow: hidden;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
    <path d="M777.856 280.192l-33.92-33.952-231.872 231.872-231.84-231.872-33.984 33.888 231.872 231.904-231.84 231.84 33.888 33.984 231.904-231.904 231.84 231.872 33.952-33.888-231.872-231.904z"/>
</svg>`,ja=["resize","focus","visibility","dragstart","dragend"],us=class od extends ut{constructor(t={}){super({template:Dt(`<div class="og-ddialog" 
        style="display:{display}; resize:{resize}; width: {width}px; {height}; top: {top}px; left: {left}px; min-height: {minHeight}; max-height: {maxHeight}; min-width: {minWidth}; max-width: {maxWidth};">
       <div class="og-ddialog-header">
         <div class="og-ddialog-header__title">{title}</div>      
         <div class="og-ddialog-header__buttons"></div>      
        </div>
       <div class="og-ddialog-container"></div>
    </div>>`,{title:t.title||"",display:Vi(t.visible,!0)?"flex":"none",resize:Vi(t.resizable,!0)?"both":"none",width:t.width||300,height:t.height?`height: ${t.height||200}px`:"",left:t.left||0,top:t.top||0,minHeight:t.minHeight?`${t.minHeight}px`:"unset",maxHeight:t.maxHeight?`${t.maxHeight}px`:"unset",minWidth:t.minWidth?`${t.minWidth}px`:"unset",maxWidth:t.maxWidth?`${t.maxWidth}px`:"unset"}),...t}),this._onCloseBtnClick=()=>{this.close()},this._onMouseDownAll=()=>{this.bringToFront()},this._onMouseDown=s=>{s.preventDefault(),this._startDragging(),this._startPosX=s.clientX,this._startPosY=s.clientY,document.addEventListener("mousemove",this._onMouseMove),document.addEventListener("mouseup",this._onMouseUp)},this._onMouseMove=s=>{s.preventDefault();let n=this._startPosX-s.clientX,o=this._startPosY-s.clientY;this._startPosX=s.clientX,this._startPosY=s.clientY,this.setPosition(this.el.offsetLeft-n,this.el.offsetTop-o)},this._onMouseUp=()=>{this._clearDragging(),document.removeEventListener("mouseup",this._onMouseUp),document.removeEventListener("mousemove",this._onMouseMove)},this.events=this.events.registerNames(ja),this._width=t.width||300,this._height=t.height||200,this._startPosX=0,this._startPosY=0,this.$header=null,this.$title=null,this.$container=null,this.$buttons=null,this._closeBtn=new ce({icon:Vo,classList:["og-button-size__20"]}),this.useHide=t.useHide||!1,this._visibility=Vi(t.visible,!0),this._right=t.right!=null?t.right:null}setContainer(t){this.$container.innerHTML=t}get container(){return this.$container}get width(){return this.el?parseFloat(this.el.style.width):this._width}get height(){return this.el?parseFloat(this.el.style.height):this._height}bringToFront(){this.el.style.zIndex=String(od.__zIndex__++)}render(t){return super.render(t),this.bringToFront(),this.$header=this.select(".og-ddialog-header"),this.$title=this.select(".og-ddialog-header__title"),this.$container=this.select(".og-ddialog-container"),this.$buttons=this.select(".og-ddialog-header__buttons"),this._initEvents(),this._initButtons(),this._right!=null&&(this.el.style.visibility="hidden",new IntersectionObserver((s,n)=>{s.forEach(o=>{o.isIntersecting&&(this.el.style.visibility="visible",this.el.parentNode&&(this.setPosition(this.el.parentNode.clientWidth-this.el.clientWidth-this._right),n.disconnect()))})}).observe(this.el)),this}show(){this._visibility||(this._visibility=!0,this.el.style.display="flex",this.bringToFront(),this.events.dispatch(this.events.visibility,!0,this))}hide(){this._visibility&&(this._visibility=!1,this.el.style.display="none",this.events.dispatch(this.events.visibility,!1,this))}close(){this.useHide?this.hide():this.remove()}setVisibility(t){t?this.show():this.hide()}getVisibility(){return this._visibility}_initButtons(){this._closeBtn.events.on("click",this._onCloseBtnClick),this._closeBtn.appendTo(this.$buttons)}_initEvents(){this.$header.addEventListener("mousedown",this._onMouseDown),this.el.addEventListener("mousedown",this._onMouseDownAll)}setPosition(t,s){t!=null&&(this.el.style.left=`${t}px`),s!=null&&(this.el.style.top=`${s}px`)}_startDragging(){this.el.classList.contains("dragging")||(this.el.classList.add("dragging"),this.events.dispatch(this.events.dragstart,this))}_clearDragging(){this.el.classList.contains("dragging")&&(this.events.dispatch(this.events.dragend,this),this.el.classList.remove("dragging"))}remove(){this._clearDragging(),this._clearEvents(),super.remove()}_clearEvents(){this._closeBtn.events.off("click",this._onCloseBtnClick),document.removeEventListener("mouseup",this._onMouseUp),document.removeEventListener("mousemove",this._onMouseMove),this.$header.removeEventListener("mousedown",this._onMouseDown),this.el.removeEventListener("mousedown",this._onMouseDownAll)}};us.__zIndex__=0;let Kt=us;const qa=["change"];class dt extends ce{constructor(t){super({...t}),this._onMouseClick=s=>{this.preventClick||(this._mouseClickHandler(s),this.setActive(!this.isActive))},this.events=this.events.registerNames(qa),this._isActive=t.isActive||!1,this.preventClick=t.preventClick||!1}setActive(t,s=!1){t!==this._isActive&&(this._isActive=t,this._toggle(),s||this.events.dispatch(this.events.change,t,this))}_toggle(){this.el&&this.el.classList.toggle("og-button__active")}get isActive(){return this._isActive}render(t){return super.render(t),this._isActive&&this._toggle(),this}}const ui=[2,3,0,1],wn=[[-1,-1,0,1],[1,-1,3,-1],[2,3,-1,-1],[-1,0,-1,2]],Ya=[[2,3,0,1],[1,0,3,2],[2,3,0,1],[1,0,3,2]],Wa=[[0,1,0,0],[1,0,0,0],[0,1,0,1],[1,1,1,1]];class Uo{constructor(t,s){this.segment=t,this.layer=s,this.isReady=!1,this.isLoading=!1,this.texture=null,this.pickingMask=null,this.textureExists=!1,this.appliedNodeId=0,this.appliedNode=null,this.texOffset=[0,0,1,1],this.loadingAttempts=0,this._updateTexture=null,this._updatePickingMask=null,this.pickingReady=!1}abortLoading(){this.layer.abortMaterialLoading(this)}_createTexture(t){return this.layer._planet&&this.layer.createTexture(t,this.layer._internalFormat,this.isReady?this.texture:null)}applyImage(t){this.segment.initialized&&(this._updateTexture=null,this.texture=this._createTexture(t),this.isReady=!0,this.pickingReady=!0,this.textureExists=!0,this.isLoading=!1,this.appliedNodeId=this.segment.node.nodeId,this.texOffset=[0,0,1,1])}applyTexture(t,s){this.segment.initialized&&(this.texture=t,this._updateTexture=null,this.pickingMask=s||null,this._updatePickingMask=null,this.isReady=!0,this.pickingReady=!0,this.textureExists=!0,this.isLoading=!1,this.appliedNodeId=this.segment.node.nodeId,this.texOffset=[0,0,1,1])}textureNotExists(){this.segment.initialized&&(this.pickingReady=!0,this.isLoading=!1,this.isReady=!0,this.textureExists=!1)}clear(){this.loadingAttempts=0,this.layer.clearMaterial(this)}}const _s=class ad{constructor(t,s={}){if(this.isVector=!1,this.__id=ad.__counter__++,this._iconSrc=s.iconSrc||null,this.events=lt(Go,this),this.name=t||"noname",this.properties=s.properties||{},this.hideInLayerSwitcher=s.hideInLayerSwitcher||!1,this._hasImageryTiles=!0,this._opacity=s.opacity!=null?s.opacity:1,this.minZoom=s.minZoom||0,this.maxZoom=s.maxZoom!=null?s.maxZoom:50,this._planet=null,this.isVector=!1,this._attribution=s.attribution||"",this._zIndex=s.zIndex||0,this._isBaseLayer=s.isBaseLayer||!1,this._defaultTextures=s.defaultTextures||[null,null],this._visibility=s.visibility===void 0||s.visibility,this._fading=s.fading||!1,this._fadingFactor=this._opacity/30,this._fading?this._fadingOpacity=0:this._fadingOpacity=this._opacity,this._height=s.height||0,this._extent=new U,this.createTexture=null,this._textureFilter=s.textureFilter?s.textureFilter.trim().toUpperCase():"MIPMAP",this._isSRGB=s.isSRGB!=null&&s.isSRGB,this._internalFormat=null,this._extentMerc=new U,this.setExtent($r(s.extent,new U(new L(-180,-90),new L(180,90)))),this._pickingColor=new v,this._pickingEnabled=s.pickingEnabled===void 0||s.pickingEnabled,this._isPreloadDone=!1,this._preLoadZoomLevels=s.preLoadZoomLevels||[0,1],this._ambient=null,this._diffuse=null,this._specular=null,s.ambient){let n=jt(s.ambient,new v(.2,.2,.2));this._ambient=new Float32Array([n.x,n.y,n.z])}if(s.diffuse){let n=jt(s.diffuse,new v(.8,.8,.8));this._diffuse=new Float32Array([n.x,n.y,n.z])}if(s.specular){let n=jt(s.specular,new v(3e-4,3e-4,3e-4)),o=s.shininess||20;this._specular=new Float32Array([n.x,n.y,n.z,o])}this.nightTextureCoefficient=s.nightTextureCoefficient||1}get iconSrc(){return this._iconSrc}set iconSrc(t){this._iconSrc=t}set diffuse(t){if(t){let s=jt(t);this._diffuse=new Float32Array(s.toArray())}else this._diffuse=null}set ambient(t){if(t){let s=jt(t);this._ambient=new Float32Array(s.toArray())}else this._ambient=null}set specular(t){if(t){let s=jt(t);this._specular=new Float32Array([s.x,s.y,s.y,this._specular?this._specular[3]:0])}else this._specular=null}set shininess(t){this._specular&&(this._specular[3]=t)}static getTMS(t,s,n){return{x:t,y:(1<<n)-s-1,z:n}}static getTileIndex(t,s,n,o){return`${o}::${t}_${s}_${n}`}get instanceName(){return"Layer"}get rendererEvents(){return this.events}set opacity(t){t!==this._opacity&&(this._fading?t>this._opacity?this._fadingFactor=(t-this._opacity)/30:t<this._opacity&&(this._fadingFactor=(this._opacity-t)/30):this._fadingOpacity=t,this._opacity=t)}set pickingEnabled(t){this._pickingEnabled=t}get pickingEnabled(){return this._pickingEnabled}hasImageryTiles(){return this._hasImageryTiles}getID(){return this.__id}get id(){return this.__id}get _id(){return this.__id}isEqual(t){return t.__id===this.__id}_assignPlanet(t){this._planet=t,t._layers.push(this),t.renderer&&t.renderer.isInitialized()&&(this._isSRGB?this._internalFormat=t.renderer.handler.gl.SRGB8_ALPHA8:this._internalFormat=t.renderer.handler.gl.RGBA8,this.createTexture=t.renderer.handler.createTexture[this._textureFilter],this.events.on("visibilitychange",t._onLayerVisibilityChanged,t),this._isBaseLayer&&this._visibility&&t.setBaseLayer(this),t.events.dispatch(t.events.layeradd,this),this.events.dispatch(this.events.add,t),t.updateVisibleLayers(),this._bindPicking(),this._visibility&&this.hasImageryTiles()&&this._preLoad())}get isIdle(){return this._planet&&this._planet.quadTreeStrategy._terrainCompletedActivated||!1}_bindPicking(){this._planet&&this._planet.renderer&&this._planet.renderer.assignPickingColor(this)}addTo(t){this._planet||this._assignPlanet(t)}remove(){let t=this._planet;if(t){for(let s=0;s<t._layers.length;s++)if(this.isEqual(t._layers[s]))return t.renderer&&t.renderer.clearPickingColor(this),t._layers.splice(s,1),t.updateVisibleLayers(),this.clear(),t.events.dispatch(t.events.layerremove,this),this.events.dispatch(this.events.remove,t),this._planet=null,this._internalFormat=null,this.createTexture=null,this}return this}clear(){this._planet&&this._planet._clearLayerMaterial(this)}get planet(){return this._planet}setAttribution(t){this._attribution!==t&&(this._attribution=t,this._planet&&this._planet.updateAttributionsList())}getAttribution(){return this._attribution}setHeight(t){this._height=t,this._planet&&this._planet.updateVisibleLayers()}getHeight(){return this._height}setZIndex(t){this._zIndex=t,this._planet&&this._planet.updateVisibleLayers()}getZIndex(){return this._zIndex}bringToFront(){if(this._planet){let t=this._planet.visibleTileLayers,s=t[t.length-1];s.isEqual(this)||this.setZIndex(s.getZIndex()+1)}}isBaseLayer(){return this._isBaseLayer}setBaseLayer(t){this._isBaseLayer=t,this._planet&&(!t&&this._planet.baseLayer&&this.isEqual(this._planet.baseLayer)&&(this._planet.baseLayer=null),this._planet.updateVisibleLayers())}setVisibility(t){t!==this._visibility&&(this._visibility=t,this._planet&&(this._isBaseLayer&&t&&this._planet.setBaseLayer(this),this._planet.updateVisibleLayers(),!t||this._isPreloadDone||this.isVector||(this._isPreloadDone=!0,this._preLoad())),this.events.dispatch(this.events.visibilitychange,this))}_forceMaterialApply(t){let s=t.materials,n=s[this.__id];n||(n=s[this.__id]=this.createMaterial(t)),n.isReady||(t.quadTreeStrategy._renderCompleted=!1),this.applyMaterial(n,!0)}clearMaterial(t){}loadMaterial(t,s=!1){}applyMaterial(t,s=!1){return[0,0,1,1]}_preLoadRecursive(t,s){if(!(t.segment.tileZoom>s)){this._preLoadZoomLevels.includes(t.segment.tileZoom)&&this._forceMaterialApply(t.segment);for(let n=0,o=t.nodes.length;n<o;n++)t.nodes[n]&&this._preLoadRecursive(t.nodes[n],s)}}_preLoad(){if(this._planet&&this._preLoadZoomLevels.length){let t=this._planet,s=Math.max(...this._preLoadZoomLevels);for(let n=0,o=t.quadTreeStrategy.quadTreeList.length;n<o;n++)this._preLoadRecursive(t.quadTreeStrategy.quadTreeList[n],s)}}getVisibility(){return this._visibility}setExtent(t){let s=t.southWest.clone(),n=t.northEast.clone();s.lat<Ot&&(s.lat=Ot),n.lat>ct&&(n.lat=ct),this._extent=t.clone(),this._extentMerc=new U(s.forwardMercator(),n.forwardMercator()),this._correctFullExtent()}getExtent(){return this._extent}getExtentMerc(){return this._extentMerc}flyExtent(){var t;(t=this._planet)==null||t.flyExtent(this.getExtent())}viewExtent(){var t;(t=this._planet)==null||t.viewExtent(this.getExtent())}_correctFullExtent(){}get opacity(){return this._opacity}get screenOpacity(){return this._fading?this._fadingOpacity:this._opacity}_refreshFadingOpacity(t,s){let n=this._planet;return this._visibility&&n.getViewExtent().overlaps(this._extent)&&s>=this.minZoom&&t<=this.maxZoom?(this._fadingOpacity+=this._fadingFactor,(this._fadingFactor>0&&this._fadingOpacity>this._opacity||this._fadingFactor<0&&this._fadingOpacity<this._opacity)&&(this._fadingOpacity=this._opacity),!1):(this._fadingOpacity-=this._fadingFactor,this._fadingOpacity<=0&&(this._fadingOpacity=0),!1)}createMaterial(t){return new Uo(t,this)}redraw(){var t;(t=this._planet)==null||t.quadTreeStrategy.clearLayerMaterial(this)}abortMaterialLoading(t){}abortLoading(){}};_s.__counter__=0;let zt=_s;const Go=["visibilitychange","add","remove","mousemove","mouseenter","mouseleave","lclick","rclick","mclick","ldblclick","rdblclick","mdblclick","lup","rup","mup","ldown","rdown","mdown","lhold","rhold","mhold","mousewheel","touchmove","touchstart","touchend","doubletouch","touchleave","touchenter"],$a=["load","loadend"],Ut=class po extends zt{constructor(t,s){super(t,s),this.events=this.events.registerNames($a),this.animated=s.animated||!1,this.minNativeZoom=s.minNativeZoom||0,this.maxNativeZoom=s.maxNativeZoom||100,this._counter=0,this._pendingsQueue=[],this.drawTile=s.drawTile,this._onLoadend_=null}addTo(t){return this._onLoadend_=this._onLoadend.bind(this),this.events.on("loadend",this._onLoadend_,this),super.addTo(t)}remove(){return this.events.off("loadend",this._onLoadend_),this._onLoadend_=null,super.remove()}_onLoadend(){this._planet&&this._planet.quadTreeStrategy._terrainCompletedActivated&&this._planet.events.dispatch(this._planet.events.layerloadend,this)}get instanceName(){return"CanvasTiles"}get isIdle(){return super.isIdle&&this._counter===0}abortLoading(){this._pendingsQueue.forEach(t=>{this.abortMaterialLoading(t)}),this._pendingsQueue=[]}setVisibility(t){t!==this._visibility&&(super.setVisibility(t),t||this.abortLoading())}loadMaterial(t){let s=t.segment;this._isBaseLayer?t.texture=s.getDefaultTexture():t.texture=s.planet.transparentTexture,(this._planet.layerLock.isFree()||t.segment.tileZoom<2)&&(t.isReady=!1,t.isLoading=!0,po.__requestsCounter>=po.MAX_REQUESTS&&this._counter?this._pendingsQueue.push(t):this._exec(t))}_exec(t){po.__requestsCounter++,this._counter++;const s=this.events.load;s.handlers.length&&this.events.dispatch(s,t),requestAnimationFrame(()=>{this.drawTile(t,n=>{this._counter--,po.__requestsCounter--,this._correctCounter(),t.isLoading&&t.applyImage(n),this._dequeueRequest()})})}_correctCounter(){this._counter<0&&(this._counter=0),po.__requestsCounter<0&&(po.__requestsCounter=0)}abortMaterialLoading(t){t.isLoading&&(this._counter--,po.__requestsCounter--,this._correctCounter(),this._dequeueRequest()),t.isLoading=!1,t.isReady=!1}_dequeueRequest(){if(this._pendingsQueue.length){if(po.__requestsCounter<po.MAX_REQUESTS){const t=this._whilePendings();t&&this._exec(t)}}else this._counter===0&&this._planet&&this._planet.quadTreeStrategy._terrainCompletedActivated&&this.events.dispatch(this.events.loadend)}_whilePendings(){for(;this._pendingsQueue.length;){const t=this._pendingsQueue.pop();if(t&&t.segment&&t.segment.node){if(t.segment.initialized&&t.segment.node.getState()===1)return t;t.isLoading=!1}}return null}applyMaterial(t){if(t.isReady)return t.layer.animated&&requestAnimationFrame(()=>{this.drawTile(t,function(s){t.applyImage(s)})}),t.texOffset;if(t.segment.tileZoom<this.minNativeZoom)t.textureNotExists();else{let s=t.segment,n=s.node,o=!1,a=t.layer.maxNativeZoom;s.passReady&&!t.isLoading&&s.tileZoom<=a&&this.loadMaterial(t);let l=this._id,c=t;for(;n.parentNode;)if(n=n.parentNode,c=n.segment.materials[l],c&&c.textureExists){o=!0;break}if(s.passReady){if(n.segment.tileZoom===a)s.tileZoom>a&&t.textureNotExists();else if(n.segment.tileZoom<a){let d=s.node;for(;d.segment.tileZoom>a;)d=d.parentNode;let u=d.segment.materials[l];u?!u.isLoading&&!u.isReady&&this.loadMaterial(u):(u=d.segment.materials[t.layer._id]=t.layer.createMaterial(d.segment),this.loadMaterial(u))}}if(o){t.layer.animated&&requestAnimationFrame(()=>{t.segment&&this.drawTile(t,function(u){t.applyImage(u)})}),t.appliedNodeId=n.nodeId,t.texture=c.texture;let d=1/(2<<s.tileZoom-n.segment.tileZoom-1);t.texOffset[0]=s.tileX*d-n.segment.tileX,t.texOffset[1]=s.tileY*d-n.segment.tileY,t.texOffset[2]=d,t.texOffset[3]=d}else t.texture=s.planet.transparentTexture,t.texOffset[0]=0,t.texOffset[1]=0,t.texOffset[2]=1,t.texOffset[3]=1}return t.texOffset}clearMaterial(t){t.isReady&&(t.isReady=!1,t.textureExists&&t.texture&&!t.texture.default&&(t.segment.handler.gl.deleteTexture(t.texture),t.texture=null)),this.abortMaterialLoading(t),t.isLoading=!1,t.textureExists=!1,t.layer=null,t.segment=null}};Ut.MAX_REQUESTS=20,Ut.__requestsCounter=0;let ss=Ut;const Xa=["change"];class jo{constructor(t={}){this._onChange=(s,n)=>{if(s){n.preventClick=!0;for(let o=0;o<this._buttons.length;o++){let a=this._buttons[o];a.isEqual(n)||(a.setActive(!1),a.preventClick=!1)}this.events.dispatch(this.events.change,n)}},this.events=lt(Xa),this._buttons=t.buttons||[];for(let s=0;s<this._buttons.length;s++)this._bindButton(this._buttons[s])}_bindButton(t){t.events.on("change",this._onChange)}add(t){this._buttons.push(t),this._bindButton(t)}remove(t){for(let s=0;s<this._buttons.length;s++)if(this._buttons[s].isEqual(t))return this._buttons.splice(s),void t.events.off("change",this._onChange)}}class en{constructor(t=2,s){this._sourceId=0,this._source=new Map,this._pendingQueue=[],this._numWorkers=t,this._workerQueue=[],s&&this.setProgram(s)}check(){this._pendingQueue.length&&this.make(this._pendingQueue.pop())}setProgram(t){if(ks(t)){let s=new Blob([t],{type:"application/javascript"});for(let n=0;n<this._numWorkers;n++){let o=new Worker(URL.createObjectURL(s));o.onmessage=a=>{this._onMessage(a),this._workerQueue&&this._workerQueue.unshift(a.target),this.check()},this._workerQueue.push(o)}}else for(let s=0;s<this._numWorkers;s++){let n=new t;n.onmessage=o=>{this._onMessage(o),this._workerQueue&&this._workerQueue.unshift(o.target),this.check()},this._workerQueue.push(n)}}make(t){}_onMessage(t){}destroy(){for(let t=0;t<this._workerQueue.length;t++){const s=this._workerQueue[t];s.onmessage=null,s.terminate()}this._pendingQueue=[],this._workerQueue=[]}get pendingQueue(){return this._pendingQueue}}const qo=`(function(){"use strict";function n(i,f,u){let o=u.length,b=f*o;for(let A=0;A<o;A++)i[b+A]=u[A]}self.onmessage=function(i){var f=i.data.labelData,u=f[0],o=f[1],b=f[2],A=f[3],z=f[4],D=f[5],H=f[6],I=f[7],L=f[8],M=f[9],P=f[10],j=f[11],q=f[12],B=f[13],E=f[14],G=f[15],J=f[16],K=f[17],N=f[18],O=f[19],Q=f[20],R=f[21],S=f[22],T=f[23],U=f[24],Z=f[25],_=f[26],$=f[27],V=f[28],X=f[29];let w=new Float32Array(12*o),s=new Float32Array(24*o),y=new Float32Array(24*o),F=new Float32Array(18*o),g=new Float32Array(18*o),c=new Float32Array(6*o),d=new Float32Array(18*o),p=new Float32Array(24*o),x=new Float32Array(6*o),h=new Float32Array(18*o),v=new Float32Array(6*o),C=new Float32Array(6*o),m=new Float32Array(24*o),k=new Float32Array(18*o);for(let t=0;t<o;t++){n(w,t,b!==0?[0,0,0,-1,1,-1,1,-1,1,0,0,0]:[0,0,0,0,0,0,0,0,0,0,0,0]),n(s,t,[0,0,-1,0,0,0,-1,0,0,0,-1,0,0,0,-1,0,0,0,-1,0,0,0,-1,0]),n(y,t,[1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0]);var l,r=A,e=z,a=D;n(F,t,[r,e,a,r,e,a,r,e,a,r,e,a,r,e,a,r,e,a]),n(g,t,[r=H,e=I,a=L,r,e,a,r,e,a,r,e,a,r,e,a,r,e,a]),n(c,t,[r=M,r,r,r,r,r]),n(d,t,[r=P,e=j,a=q,r,e,a,r,e,a,r,e,a,r,e,a,r,e,a]),n(p,t,[r=B,e=E,a=G,l=J,r,e,a,l,r,e,a,l,r,e,a,l,r,e,a,l,r,e,a,l]),n(x,t,[r=K,r,r,r,r,r]),n(h,t,[r=N,e=O,a=Q,r,e,a,r,e,a,r,e,a,r,e,a,r,e,a]),n(v,t,[r=R,r,r,r,r,r]),n(C,t,[r=S,r,r,r,r,r]),n(m,t,[r=T,e=U,a=Z,l=_,r,e,a,l,r,e,a,l,r,e,a,l,r,e,a,l,r,e,a,l]),n(k,t,[r=$/255,e=V/255,a=X/255,r,e,a,r,e,a,r,e,a,r,e,a,r,e,a])}self.postMessage({id:u,vertexArr:w,texCoordArr:s,gliphParamArr:y,positionHighArr:F,positionLowArr:g,sizeArr:c,offsetArr:d,rgbaArr:p,rotationArr:x,alignedAxisArr:h,fontIndexArr:v,outlineArr:C,outlineColorArr:m,pickingColorArr:k},[w.buffer,s.buffer,y.buffer,F.buffer,g.buffer,c.buffer,d.buffer,p.buffer,x.buffer,h.buffer,v.buffer,C.buffer,m.buffer,k.buffer])}})();
//# sourceMappingURL=LabelWorker.worker-BT1uJgYn.js.map
`,Tn=typeof self<"u"&&self.Blob&&new Blob([qo],{type:"text/javascript;charset=utf-8"});function Za(h){let t;try{if(t=Tn&&(self.URL||self.webkitURL).createObjectURL(Tn),!t)throw"";const s=new Worker(t,{name:h==null?void 0:h.name});return s.addEventListener("error",()=>{(self.URL||self.webkitURL).revokeObjectURL(t)}),s}catch{return new Worker("data:text/javascript;charset=utf-8,"+encodeURIComponent(qo),{name:h==null?void 0:h.name})}finally{t&&(self.URL||self.webkitURL).revokeObjectURL(t)}}class Ka extends en{constructor(t=4){super(t,Za)}_onMessage(t){let s=this._source.get(t.data.id);s.label._lockId===-2?requestAnimationFrame(()=>{this.make({handler:s.handler,label:s.label})}):s.handler.workerCallback(t.data,s.label),this._source.delete(t.data.id)}make(t){let s=t.label;if(t.handler._entityCollection){let n=s.serializeWorkerData(this._sourceId);if(n)if(this._workerQueue.length){let o=this._workerQueue.pop();this._source.set(this._sourceId,t),s._lockId=this._sourceId,this._sourceId++,o.postMessage({labelData:n},[n.buffer])}else this._pendingQueue.push(t)}}}const fs=class ld{constructor(t={}){this.__id=ld.__counter__++,this._position=Yt(t.position),this._positionHigh=new v,this._positionLow=new v,v.doubleToTwoFloats(this._position,this._positionHigh,this._positionLow),this._rotation=t.rotation||0,this._color=le(t.color),this._alignedAxis=Yt(t.alignedAxis),this._offset=Yt(t.offset),this._visibility=t.visibility==null||t.visibility,this._entity=null,this._handler=null,this._handlerIndex=-1,this._isReady=!1,this._lockId=-1}setPosition(t,s,n){this._position.x=t,this._position.y=s,this._position.z=n,v.doubleToTwoFloats(this._position,this._positionHigh,this._positionLow),this._isReady&&this._handler?this._handler.setPositionArr(this._handlerIndex,this._positionHigh,this._positionLow):this._lockId!==-1&&(this._lockId=-2)}setPosition3v(t){this._position.x=t.x,this._position.y=t.y,this._position.z=t.z,v.doubleToTwoFloats(t,this._positionHigh,this._positionLow),this._isReady&&this._handler?this._handler.setPositionArr(this._handlerIndex,this._positionHigh,this._positionLow):this._lockId!==-1&&(this._lockId=-2)}getPosition(){return this._position}setOffset(t,s,n){this._offset.x=t,this._offset.y=s,n!=null&&(this._offset.z=n),this._isReady&&this._handler?this._handler.setOffsetArr(this._handlerIndex,this._offset):this._lockId!==-1&&(this._lockId=-2)}setOffset3v(t){this.setOffset(t.x,t.y,t.z)}getOffset(){return this._offset}setRotation(t){t!==this._rotation&&(this._rotation=t,this._isReady&&this._handler?this._handler.setRotationArr(this._handlerIndex,t):this._lockId!==-1&&(this._lockId=-2))}getRotation(){return this._rotation}setOpacity(t){t!==this._color.w&&(t!=null&&(this._color.w=t),this._isReady&&this._handler?this._handler.setRgbaArr(this._handlerIndex,this._color):this._lockId!==-1&&(this._lockId=-2))}setColor(t,s,n,o){o===this._color.w&&t===this._color.x&&s===this._color.y&&this._color.z===n||(this._color.x=t,this._color.y=s,this._color.z=n,o!=null&&(this._color.w=o),this._isReady&&this._handler?this._handler.setRgbaArr(this._handlerIndex,this._color):this._lockId!==-1&&(this._lockId=-2))}setColor4v(t){this.setColor(t.x,t.y,t.z,t.w)}setColorHTML(t){this.setColor4v(he(t))}getColor(){return this._color}setVisibility(t){t!==this._visibility&&(this._visibility=t,this._isReady&&this._handler?this._handler.setVisibility(this._handlerIndex,t):this._lockId!==-1&&(this._lockId=-2))}getVisibility(){return this._visibility}setAlignedAxis(t,s,n){this._alignedAxis.x=t,this._alignedAxis.y=s,this._alignedAxis.z=n,this._isReady&&this._handler?this._handler.setAlignedAxisArr(this._handlerIndex,this._alignedAxis):this._lockId!==-1&&(this._lockId=-2)}setAlignedAxis3v(t){this.setAlignedAxis(t.x,t.y,t.z)}getAlignedAxis(){return this._alignedAxis}remove(){this._entity=null,this._handler&&this._handler.remove(this)}setPickingColor3v(t){this._isReady&&this._handler?this._handler.setPickingColorArr(this._handlerIndex,t):this._lockId!==-1&&(this._lockId=-2)}serializeWorkerData(t){return this._handler?new Float32Array([]):null}};fs.__counter__=0;let rs=fs;class Qa extends rs{constructor(t={}){super(t),this._handler=null,this._src=t.src||null,this._image=t.image||null,this._scale=1,this._width=t.width||(t.size?t.size[0]:30),this._height=t.height||(t.size?t.size[1]:30)}setSrc(t){this._src=t;let s=this._handler;if(s&&t&&t.length){let n=s._entityCollection.renderNode;if(n&&n.renderer){let o=n.renderer.billboardsTextureAtlas,a=this;o.loadImage(t,function(l){l.__nodeIndex!=null&&o.get(l.__nodeIndex)?(a._image=l,s.setTexCoordArr(a._handlerIndex,o.get(a._image.__nodeIndex).texCoords)):(o.addImage(l),o.createTexture(),a._image=l,n.updateBillboardsTexCoords())})}}}getSrc(){return this._src}setImage(t){this.setSrc(t.src)}getImage(){return this._image}setSize(t,s){this._width=t,this._height=s,this._handler&&this._handler.setSizeArr(this._handlerIndex,t*this._scale,s*this._scale)}getSize(){return{width:this._width,height:this._height}}setWidth(t){this.setSize(t,this._height)}getWidth(){return this._width}setHeight(t){this.setSize(this._width,t)}getHeight(){return this._height}}var ai=(h=>(h[h.POINT=1]="POINT",h[h.LINESTRING=2]="LINESTRING",h[h.POLYGON=3]="POLYGON",h[h.MULTIPOLYGON=4]="MULTIPOLYGON",h[h.MULTILINESTRING=5]="MULTILINESTRING",h))(ai||{});const Ja={POINT:1,LINESTRING:2,POLYGON:3,MULTIPOLYGON:4,MULTILINESTRING:5},ue=class Sc{constructor(t={}){this.__id=Sc.__counter__++,this._entity=null,this._handler=null,this._handlerIndex=-1,this._polyVerticesHighMerc=[],this._polyVerticesLowMerc=[],this._polyVerticesLength=-1,this._polyIndexesLength=-1,this._polyVerticesHandlerIndex=-1,this._polyIndexesHandlerIndex=-1,this._lineVerticesHighMerc=[],this._lineVerticesLowMerc=[],this._lineVerticesLength=-1,this._lineOrdersLength=-1,this._lineIndexesLength=-1,this._lineColorsLength=-1,this._lineThicknessLength=-1,this._lineVerticesHandlerIndex=-1,this._lineOrdersHandlerIndex=-1,this._lineIndexesHandlerIndex=-1,this._lineThicknessHandlerIndex=-1,this._lineColorsHandlerIndex=-1,this._type=t.type&&Sc.getType(t.type)||1,this._coordinates=t.coordinates||[],this._extent=Sc.getExtent({type:t.type||"POINT",coordinates:t.coordinates||[]},this._coordinates),t.style=t.style||{},this._style={fillColor:le(t.style.fillColor,new et(.19,.62,.85,.4)),lineColor:le(t.style.lineColor,new et(.19,.62,.85,1)),strokeColor:le(t.style.strokeColor,new et(1,1,1,.95)),lineWidth:t.style.lineWidth||3,strokeWidth:t.style.strokeWidth||0},this._visibility=t.visibility||!0,this._pickingReady=!1}get id(){return this.__id}get type(){return this._type}static getType(t){return Ja[t.toUpperCase()]}static getExtent(t,s){let n=new U(new L(180,90),new L(-180,-90)),o=Sc.getType(t.type);if(o===1){let a=t.coordinates[0],l=t.coordinates[1];n.southWest.lon=a,n.southWest.lat=l,n.northEast.lon=a,n.northEast.lat=l,s&&(s[0]=a)&&(s[1]=l)}else if(o===2){let a=t.coordinates;for(let l=0;l<a.length;l++){let c=a[l][0],d=a[l][1];c<n.southWest.lon&&(n.southWest.lon=c),d<n.southWest.lat&&(n.southWest.lat=d),c>n.northEast.lon&&(n.northEast.lon=c),d>n.northEast.lat&&(n.northEast.lat=d),s&&(s[l]=[c,d])}}else if(o===3){let a=t.coordinates;for(let l=0;l<a.length;l++){let c=a[l];s&&(s[l]=[]);for(let d=0;d<c.length;d++){let u=c[d],_=u[0],f=u[1];_<n.southWest.lon&&(n.southWest.lon=_),f<n.southWest.lat&&(n.southWest.lat=f),_>n.northEast.lon&&(n.northEast.lon=_),f>n.northEast.lat&&(n.northEast.lat=f),s&&(s[l][d]=[_,f])}}}else if(o===4){let a=t.coordinates;for(let l=0;l<a.length;l++){let c=a[l];s&&(s[l]=[]);for(let d=0;d<c.length;d++){let u=c[d];s&&(s[l][d]=[]);for(let _=0;_<u.length;_++){let f=u[_],g=f[0],m=f[1];g<n.southWest.lon&&(n.southWest.lon=g),m<n.southWest.lat&&(n.southWest.lat=m),g>n.northEast.lon&&(n.northEast.lon=g),m>n.northEast.lat&&(n.northEast.lat=m),s&&(s[l][d][_]=[g,m])}}}}else if(o===5){let a=t.coordinates;for(let l=0;l<a.length;l++){let c=a[l];s&&(s[l]=[]);for(let d=0;d<c.length;d++){let u=c[d],_=u[0],f=u[1];_<n.southWest.lon&&(n.southWest.lon=_),f<n.southWest.lat&&(n.southWest.lat=f),_>n.northEast.lon&&(n.northEast.lon=_),f>n.northEast.lat&&(n.northEast.lat=f),s&&(s[l][d]=[_,f])}}}else n.southWest.lon=n.southWest.lat=n.northEast.lon=n.northEast.lat=0,s&&(s[0]=0)&&(s[1]=0);return n}setGeometry(t){let s=this._handler;return s&&(this.remove(),this._type=Sc.getType(t.type||"Point"),this._extent=Sc.getExtent(t,this._coordinates),s.add(this)),this}setFillColor(t,s,n,o=1){let a=this._style.fillColor;return(a.w===0&&o!==0||a.w!==0&&o===0)&&(this._pickingReady=!1),a.x=t,a.y=s,a.z=n,a.w=o,this._handler&&this._handler.setPolyColorArr(this,a),this}overlaps(t){return this._extent.overlaps(t)}setFillColor4v(t){return this.setFillColor(t.x,t.y,t.z,t.w)}setStrokeColor(t,s,n,o=1){let a=this._style.strokeColor;return(a.w===0&&o!==0||a.w!==0&&o===0)&&(this._pickingReady=!1),a.x=t,a.y=s,a.z=n,a.w=o,this._handler&&this._handler.setLineStrokeColorArr(this,a),this}setLineColor(t,s,n,o=1){let a=this._style.lineColor;return(a.w===0&&o!==0||a.w!==0&&o===0)&&(this._pickingReady=!1),a.x=t,a.y=s,a.z=n,a.w=o,this._handler&&this._handler.setLineColorArr(this,a),this}setStrokeColor4v(t){return this.setStrokeColor(t.x,t.y,t.z,t.w)}setLineColor4v(t){return this.setLineColor(t.x,t.y,t.z,t.w)}setStrokeOpacity(t){let s=this._style.strokeColor;return s.w=t,this.setStrokeColor(s.x,s.y,s.z,t)}setLineOpacity(t){let s=this._style.lineColor;return s.w=t,this.setLineColor(s.x,s.y,s.z,t)}setStrokeWidth(t){return this._style.strokeWidth=t,this._pickingReady=!1,this._handler&&this._handler.setLineStrokeArr(this,t),this}bringToFront(){return this._handler&&this._handler.bringToFront(this),this}setLineWidth(t){return this._style.lineWidth=t,this._pickingReady=!1,this._handler&&this._handler.setLineThicknessArr(this,t),this}setFillOpacity(t){let s=this._style.fillColor;return(s.w===0&&t!==0||s.w!==0&&t===0)&&(this._pickingReady=!1),s.w=t,this._handler&&this._handler.setPolyColorArr(this,s),this}setVisibility(t){return this._visibility=t,this._handler&&this._handler.setGeometryVisibility(this),this}getVisibility(){return this._visibility}remove(){this._handler&&this._handler.remove(this)}getExtent(){return this._extent.clone()}getType(){return this._type}};ue.__counter__=0;let vr=ue;class Jt{constructor(t,s){this.p0=t||new v,this.p1=s||new v}getMagnitude(){return this.p0.distance(this.p1)}getSphereIntersection(t){let s=this.p0,n=this.p1,o=t.center.x,a=t.center.y,l=t.center.z,c=s.x,d=s.y,u=s.z,_=n.x-c,f=n.y-d,g=n.z-u,m=_*_+f*f+g*g,p=2*(c*_+d*f+u*g-_*o-f*a-g*l),x=p*p-4*m*(c*c-2*c*o+o*o+d*d-2*d*a+a*a+u*u-2*u*l+l*l-t.radius*t.radius);if(x<0)return[];let y=(-p-Math.sqrt(x))/(2*m),w=new v(s.x*(1-y)+y*n.x,s.y*(1-y)+y*n.y,s.z*(1-y)+y*n.z);if(x==0)return[w];let C=(-p+Math.sqrt(x))/(2*m),T=new v(s.x*(1-C)+C*n.x,s.y*(1-C)+C*n.y,s.z*(1-C)+C*n.z);return Math.abs(y-.5)<Math.abs(C-.5)?[w,T]:[T,w]}intersects(t,s,n){let o=this.p0.sub(t.p0),a=t.p1.sub(t.p0);if(Math.abs(a.x)<ne&&Math.abs(a.y)<ne&&Math.abs(a.z)<ne)return!1;let l=this.p1.sub(this.p0);if(Math.abs(l.x)<ne&&Math.abs(l.y)<ne&&Math.abs(l.z)<ne)return!1;let c=o.x*a.x+o.y*a.y+o.z*a.z,d=a.x*l.x+a.y*l.y+a.z*l.z,u=o.x*l.x+o.y*l.y+o.z*l.z,_=a.x*a.x+a.y*a.y+a.z*a.z,f=(l.x*l.x+l.y*l.y+l.z*l.z)*_-d*d;if(Math.abs(f)<ne)return!1;let g=(c*d-u*_)/f;if(s.x=this.p0.x+g*l.x,s.y=this.p0.y+g*l.y,s.z=this.p0.z+g*l.z,n){let m=(c+d*g)/_;n.x=t.p0.x+m*a.x,n.y=t.p0.y+m*a.y,n.z=t.p0.z+m*a.z}return!0}getNearestDistancePoint(t,s){let n=this.p0,o=this.p1,a=this.getMagnitude(),l=((t.x-n.x)*(o.x-n.x)+(t.y-n.y)*(o.y-n.y)+(t.z-n.z)*(o.z-n.z))/(a*a);return s.x=n.x+l*(o.x-n.x),s.y=n.y+l*(o.y-n.y),s.z=n.z+l*(o.z-n.z),!(l<0||l>1)}}class vt{constructor(t,s){this.p=t?t.clone():new v,this.n=s?s.clone():this.p.isZero()?v.UP:this.p.getNormal()}setByPoints(t,s,n){let o=v.sub(s,t),a=v.sub(n,t);return this.n=o.cross(a),this.p.copy(t),this}static fromPoints(t,s,n){return new vt().setByPoints(t,s,n)}set(t,s){this.p.copy(t),this.n.copy(s)}getNormal(){return this.n.clone()}distance(t){let s=this.getProjection(t);return t.distance(s)}getProjection(t,s){return v.proj_b_to_plane(t,this.n,s)}getProjectionPoint(t,s){let n=t.sub(this.p),o=this.n,a=n.dot(o);return s?s.copy(o.scale(a)):s=o.scale(a),t.sub(s)}getIntersection(t,s,n){let o,a=t.n.cross(s.n),l=a.x>=0?a.x:-a.x,c=a.y>=0?a.y:-a.y,d=a.z>=0?a.z:-a.z;if(l+c+d<xo){let g=s.p.sub(t.p);return t.n.dot(g)==0?1:0}o=l>c?l>d?1:3:c>d?2:3;let u,_,f=new v;return u=-t.n.dot(t.p),_=-s.n.dot(s.p),o===1?(f.x=0,f.y=(_*t.n.z-u*s.n.z)/a.x,f.z=(u*s.n.y-_*t.n.y)/a.x):o===2?(f.x=(u*s.n.z-_*t.n.z)/a.y,f.y=0,f.z=(_*t.n.x-u*s.n.x)/a.y):o===3&&(f.x=(_*t.n.y-u*s.n.y)/a.z,f.y=(u*s.n.x-_*t.n.x)/a.z,f.z=0),n.p0.copy(f),n.p1.copy(f.add(a)),2}}let V=class mo{constructor(t=v.ZERO,s=v.ZERO){this.origin=t,this.direction=s}static get OUTSIDE(){return 0}static get INSIDE(){return 1}static get INPLANE(){return 2}static get AWAY(){return 3}set(t,s){return this.origin=t,this.direction=s,this}getPoint(t){return v.add(this.origin,this.direction.scaleTo(t))}hitTriangleRes(t,s,n,o){let a=s.sub(t),l=n.sub(t),c=a.cross(l),d=this.origin.sub(t),u=-c.dot(d),_=c.dot(this.direction);if(Math.abs(_)<ne)return u===0?(o.copy(this.origin),mo.INPLANE):mo.OUTSIDE;let f=u/_;if(o.copy(this.origin.add(this.direction.scaleTo(f))),f<0)return mo.AWAY;let g=a.dot(a),m=a.dot(l),p=l.dot(l),x=o.sub(t),y=x.dot(a),w=x.dot(l),C=m*m-g*p,T=(m*w-p*y)/C;if(T<0||T>1)return mo.OUTSIDE;let P=(m*y-g*w)/C;return P<0||T+P>1?mo.OUTSIDE:mo.INSIDE}hitPlaneRes(t,s){const n=this.direction.dot(t.n);if(Math.abs(n)<ne)return mo.OUTSIDE;const o=t.p.sub(this.origin).dot(t.n)/n;return o<0?mo.AWAY:(s.copy(this.getPoint(o)),mo.INSIDE)}hitSphere(t){const s=v.sub(this.origin,t.center),n=this.direction.dot(this.direction),o=2*s.dot(this.direction),a=o*o-4*n*(s.dot(s)-t.radius*t.radius);if(a<0)return null;const l=Math.sqrt(a);let c=(-o-l)/(2*n);return c<0&&(c=(-o+l)/(2*n)),c<0?null:v.add(this.origin,this.direction.scaleTo(c))}hitBox(t){}};function js(h){let t=h.split("/"),s=t[t.length-1],n=t[t.length-2];return`${n?n+"/":""}${s}`}class Cn{constructor(){this.objPositions=[],this.objTexcoords=[],this.objNormals=[],this.objVertexData=[this.objPositions,this.objTexcoords,this.objNormals],this.vertexData=[[],[],[]],this._materialLibs=[],this.geometries=[],this.geometry=null,this.materials={},this.material={},this.object="default",this.groups=["default"],this._path="",this.keywords={v:t=>{this.objPositions.push(t.map(parseFloat))},vn:t=>{this.objNormals.push(t.map(parseFloat))},vt:t=>{this.objTexcoords.push([parseFloat(t[0]),1-parseFloat(t[1])])},f:t=>{this.setGeometry();const s=t.length-2;for(let n=0;n<s;++n)this.addVertex(t[0]),this.addVertex(t[n+1]),this.addVertex(t[n+2])},s:()=>{},mtllib:(t,s)=>{this._materialLibs.push(s)},usemtl:(t,s)=>{this.newGeometry(),this.setGeometry(),this.geometry&&(this.geometry.material=s)},g:t=>{this.groups=t,this.newGeometry()},o:(t,s)=>{this.object=s,this.newGeometry()},newmtl:(t,s)=>{const n={};this.material=n,this.materials[s]=n},Ns:(t,s)=>{this.material.shininess=parseFloat(s)},Ni:(t,s)=>{},Ka:(t,s)=>{this.material.ambient=t.map(n=>parseFloat(n))},Kd:(t,s)=>{this.material.diffuse=t.map(n=>parseFloat(n))},Ks:(t,s)=>{this.material.specular=t.map(n=>parseFloat(n))},Ke:(t,s)=>{this.material.color=t.map(n=>parseFloat(n))},illum:(t,s)=>{this.material.illum=parseFloat(s)},d:(t,s)=>{this.material.opacity=parseFloat(s)},Tr:(t,s)=>{this.material.opacity=parseFloat(s)},Tf:(t,s)=>{},map_Ka:(t,s)=>{},map_Kd:(t,s)=>{this.material.colorTexture=`${this._path}/${js(s)}`},map_Bump:(t,s)=>{this.material.normalTexture=`${this._path}/${js(s)}`},map_Ns:(t,s)=>{this.material.metallicRoughnessTexture=`${this._path}/${js(s)}`}}}newGeometry(){this.geometry&&this.geometry.data.vertices.length&&(this.geometry=null)}setGeometry(){if(!this.geometry){const t=[],s=[],n=[];this.vertexData=[t,s,n],this.geometry={object:this.object,groups:this.groups,material:"",data:{vertices:t,texCoords:s,normals:n}},this.geometries.push(this.geometry)}}addVertex(t){let s=t.split("/");for(let n=0;n<s.length;n++){let o=s[n];if(!o)continue;let a=parseInt(o)-1,l=this.vertexData[n],c=l.length,d=this.objVertexData[n][a],u=d.length;this.vertexData[n].length=c+u;for(let _=0;_<u;_++)l[c+_]=d[_]}}_innerParser(t,s){const n=/(\w*)(?: )*(.*)/,o=t.split(`
`);for(let a=0;a<o.length;++a){const l=o[a].trim();if(l===""||l.startsWith("#"))continue;const c=n.exec(l);if(!c)continue;const[,d,u]=c,_=l.split(/\s+/).slice(1),f=this.keywords[d];f?f(_,u):console.warn(`Unknown keyword '${d}' in '${s}:${a}'`)}}get data(){return{geometries:this.geometries,materials:this.materials}}async load(t){this._path=t.substring(0,t.lastIndexOf("/"));const s=await fetch(t);if(!s.ok)throw new Error(`Unable to load '${t}'`);const n=s.body.getReader(),o=new TextDecoder;let{value:a,done:l}=await n.read(),c="";for(;!l;){const u=(c+o.decode(a,{stream:!0})).split(`
`);c=u.pop();for(const _ of u)this._innerParser(_,t);({value:a,done:l}=await n.read())}c&&this._innerParser(c,t),this._cleanupGeometryArrays();let d=this._materialLibs.map(u=>(u=`${this._path}/${u}`,fetch(u).then(_=>_.text()).then(_=>({text:_,filename:u}))));return await Promise.all(d).then(u=>{u.forEach(_=>this._innerParser(_.text,_.filename))}),this.data}async _readAndParse(t){const s=t.stream().getReader(),n=new TextDecoder;let{value:o,done:a}=await s.read(),l="";for(;!a;){const c=(l+n.decode(o,{stream:!0})).split(`
`);l=c.pop();for(const d of c)this._innerParser(d,t.name);({value:o,done:a}=await s.read())}l&&this._innerParser(l,t.name)}async readFile(t,s){return this._path="",await this._readAndParse(t),this._cleanupGeometryArrays(),s&&await this._readAndParse(s),this.data}_cleanupGeometryArrays(){for(const t of this.geometries)t.data=Object.fromEntries(Object.entries(t.data).filter(([s,n])=>n.length>0))}}function Ie(h){let t=new Float32Array([1,1,1]);if(h instanceof Array)t[0]=h[0],t[1]=h[1],t[2]=h[2];else if(typeof h=="string"){let s=ve(h);t[0]=s[0],t[1]=s[1],t[2]=s[2]}return t}class ${constructor(t={}){var s;if(this._name=t.name||"noname",this._vertices=t.vertices||[],this._numVertices=this._vertices.length/3,this._texCoords=t.texCoords||new Array(2*this._numVertices),this.color=(s=t.color)instanceof Array?new Float32Array(s):typeof s=="string"?ve(s):new Float32Array([.5,.5,.5,1]),this.ambient=Ie(t.ambient),this.diffuse=Ie(t.diffuse),this.specular=Ie(t.specular),this.shininess=t.shininess||100,this.colorTextureSrc=t.colorTextureSrc||null,this.colorTextureImage=t.colorTextureImage||null,this.normalTextureSrc=t.normalTextureSrc||null,this.normalTextureImage=t.normalTextureImage||null,this.metallicRoughnessTextureSrc=t.metallicRoughnessTextureSrc||null,this.metallicRoughnessTextureImage=t.metallicRoughnessTextureImage||null,t.scale){let n,o=t.scale;n=typeof o=="number"?new v(o,o,o):o,$.scale(this._vertices,n)}if(t.center&&$.centering(this._vertices),this.center=$.getCenter(this._vertices),t.indices)this._indices=t.indices,this._normals=t.normals||[];else{this._normals=t.normals||$.getNormals(this._vertices),this._indices=new Array(this._vertices.length/3);for(let n=0,o=this._indices.length;n<o;n++)this._indices[n]=n}}static getCenter(t){let s=xt,n=xt,o=xt,a=Ct,l=Ct,c=Ct;for(let d=0,u=t.length;d<u;d+=3){let _=t[d],f=t[d+1],g=t[d+2];_<s&&(s=_),f<n&&(n=f),g<o&&(o=g),_>a&&(a=_),f>l&&(l=f),g>c&&(c=g)}return new v(s+.5*(a-s),n+.5*(l-n),o+.5*(c-o))}static centering(t){let s=$.getCenter(t);for(let n=0,o=t.length;n<o;n+=3)t[n]-=s.x,t[n+1]-=s.y,t[n+2]-=s.z}setMaterial(t){return t.ambient&&(this.ambient=Ie(t.ambient)),t.diffuse&&(this.diffuse=Ie(t.diffuse)),t.specular&&(this.specular=Ie(t.specular)),t.shininess!==void 0&&(this.shininess=t.shininess),this}centering(){return $.centering(this._vertices),this}applyMat4(t){for(let s=0,n=this._vertices.length;s<n;s+=3){let o=new v(this._vertices[s],this._vertices[s+1],this._vertices[s+2]),a=new v(this._normals[s],this._normals[s+1],this._normals[s+2]);o=t.mulVec3(o),a=t.mulVec3(a),this._vertices[s]=o.x,this._vertices[s+1]=o.y,this._vertices[s+2]=o.z,this._normals[s]=a.x,this._normals[s+1]=a.y,this._normals[s+2]=a.z}return this}scale(t){return $.scale(this._vertices,t),this}translate(t){for(let s=0,n=this._vertices.length;s<n;s+=3)this._vertices[s]+=t.x,this._vertices[s+1]+=t.y,this._vertices[s+2]+=t.z;return this}get name(){return this._name}get vertices(){return this._vertices}get normals(){return this._normals}get indices(){return this._indices}get texCoords(){return this._texCoords}get numVertices(){return this._numVertices}static scale(t,s){for(let n=0;n<t.length;n+=3)t[n]*=s.x,t[n+1]*=s.y,t[n+2]*=s.z}static centroid(t){let s=1e3,n=1e3,o=1e3,a=-1e3,l=-1e3,c=-1e3;for(let d=0;d<t.length;d+=3){let u=t[d],_=t[d+1],f=t[d+2];u<s&&(s=u),_<n&&(n=_),f<o&&(o=f),u>a&&(a=u),_>l&&(l=_),f>c&&(c=f)}return[s+.5*(a-s),n+.5*(l-n),o+.5*(c-o)]}static translate(t,s){for(let n=0;n<t.length;n+=3)t[n]+=s[0],t[n+1]+=s[1],t[n+2]+=s[2]}static getNormals(t){let s=new Array(t.length);for(let n=0;n<t.length;n+=9){let o=n,a=n+3,l=n+6,c=t[o],d=t[o+1],u=t[o+2],_=t[a]-c,f=t[a+1]-d,g=t[a+2]-u,m=t[l]-c,p=t[l+1]-d,x=t[l+2]-u,y=f*x-g*p,w=g*m-_*x,C=_*p-f*m,T=Math.sqrt(y*y+w*w+C*C);y/=T,w/=T,C/=T,s[o]=y,s[o+1]=w,s[o+2]=C,s[a]=y,s[a+1]=w,s[a+2]=C,s[l]=y,s[l+1]=w,s[l+2]=C}return s}static createSphere(t=16,s=16,n=1,o=0,a=0,l=0){let c=[],d=[],u=[];for(let _=0;_<=s;_++){let f=_*Math.PI/s,g=Math.sin(f),m=Math.cos(f);for(let p=0;p<=t;p++){let x=2*p*Math.PI/t,y=Math.sin(x),w=Math.cos(x)*g+o,C=m+a,T=y*g+l;u.push(w),u.push(C),u.push(T),c.push(n*w),c.push(n*C),c.push(n*T)}}for(let _=0;_<s;_++)for(let f=0;f<t;f++){let g=_*(t+1)+f,m=g+t+1;d.push(g),d.push(g+1),d.push(m),d.push(m),d.push(g+1),d.push(m+1)}return new $({vertices:c,normals:u,indices:d})}static createDisc(t=1,s=0,n=8,o=!0,a=0,l=0,c=0,d=0){let u=[],_=[],f=[],g=2*Math.PI,m=o?1:-1,p=a;for(let y=1;y<=n;y++)u.push(l,s*m+c,d),f.push(0,m,0),a++;let x=a;for(let y=0;y<=n;y++){let w=y/n*g+0,C=Math.cos(w),T=Math.sin(w);u.push(t*T+l,s*m+c,t*C+d),f.push(0,m,0),a++}for(let y=0;y<n;y++){let w=p+y,C=x+y;o?_.push(C,C+1,w):_.push(C+1,C,w)}return new $({vertices:u,normals:f,indices:_})}static getFrustumScaleByCameraAngles(t,s,n){return new v(2*t*Math.tan(Qt*s),2*t*Math.tan(Qt*n),t)}static getFrustumScaleByCameraAspectRatio(t,s,n){let o=Gr*Math.atan(Math.tan(Qt*s)/n);return $.getFrustumScaleByCameraAngles(t,s,o)}static createFrustum(t=1,s=1,n=1,o=0,a=0,l=0){return new $({vertices:[0+o,0+a,0+l,-1*(s*=.5)+o,1*(n*=.5)+a,-1*t+l,1*s+o,1*n+a,-1*t+l,0+o,0+a,0+l,1*s+o,-1*n+a,-1*t+l,-1*s+o,-1*n+a,-1*t+l,0+o,0+a,0+l,1*s+o,1*n+a,-1*t+l,1*s+o,-1*n+a,-1*t+l,0+o,0+a,0+l,-1*s+o,-1*n+a,-1*t+l,-1*s+o,1*n+a,-1*t+l,0+o,0+a,0+l,1*s+o,1*n+a,-1*t+l,-1*s+o,1*n+a,-1*t+l,0+o,0+a,0+l,-1*s+o,-1*n+a,-1*t+l,1*s+o,-1*n+a,-1*t+l,0+o,0+a,0+l,1*s+o,-1*n+a,-1*t+l,1*s+o,1*n+a,-1*t+l,0+o,0+a,0+l,-1*s+o,1*n+a,-1*t+l,-1*s+o,-1*n+a,-1*t+l]})}static createCylinder(t=1,s=1,n=1,o=32,a=1,l=!0,c=!0,d=0,u=0,_=0){let f=[],g=[],m=[],p=2*Math.PI,x=0,y=[],w=new v,C=(s-t)/n;for(let T=0;T<=a;T++){let P=[],E=T/a,S=E*(s-t)+t;for(let M=0;M<=o;M++){let R=M/o*p+0,k=Math.sin(R),B=Math.cos(R);f.push(S*k+d,-E*n+n+u,S*B+_),w.set(k,C,B).normalize(),m.push(w.x,w.y,w.z),P.push(x++)}y.push(P)}for(let T=0;T<o;T++)for(let P=0;P<a;P++){let E=y[P][T],S=y[P+1][T],M=y[P+1][T+1],R=y[P][T+1];g.push(E,S,R),g.push(S,M,R)}if(t!==0&&l){let T=$.createDisc(t,n,o,!0,x,d,u,_);f.push(...T.vertices),m.push(...T.normals),g.push(...T.indices)}if(s!==0&&c){let T=$.createDisc(s,0,o,!1,x+(l?1+2*o:0),d,u,_);f.push(...T.vertices),m.push(...T.normals),g.push(...T.indices)}return new $({vertices:f,normals:m,indices:g})}static createCube(t=1,s=1,n=1,o=0,a=0,l=0){let c=.5*t+o,d=.5*s+a,u=.5*n+l;return new $({vertices:[-c,-d,u,c,-d,-u,c,-d,u,-c,-d,u,-c,-d,-u,c,-d,-u,-c,d,u,c,d,u,c,d,-u,-c,d,u,c,d,-u,-c,d,-u,-c,-d,u,c,-d,u,-c,d,u,-c,d,u,c,-d,u,c,d,u,-c,-d,-u,-c,d,-u,c,-d,-u,-c,d,-u,c,d,-u,c,-d,-u,c,-d,u,c,-d,-u,c,d,u,c,d,u,c,-d,-u,c,d,-u,-c,-d,u,-c,d,u,-c,-d,-u,-c,d,u,-c,d,-u,-c,-d,-u]})}static createPlane(t=1,s=1,n=0,o=0,a=0){let l=.5*t,c=.5*s;return new $({vertices:[-l+n,o,c+a,l+n,o,-c+a,l+n,o,c+a,-l+n,o,c+a,-l+n,o,-c+a,l+n,o,-c+a,-l+n,o,c+a,l+n,o,c+a,l+n,o,-c+a,-l+n,o,c+a,l+n,o,-c+a,-l+n,o,-c+a]})}static createArrow(t=0,s=2.1,n=-15){return new $({vertices:[0,s,0,7,0,6,0,0,n,0,0,t,7,0,6,0,s,0,-7,0,6,0,0,t,0,s,0,-7,0,6,0,s,0,0,0,n,-7,0,6,0,0,n,0,0,t,0,0,t,0,0,n,7,0,6]})}static async readFileObj(t,s,n){const o=await new Cn().readFile(t,s);let a=o.materials;return o.geometries.map(l=>{let c=a[l.material]||{};return new $({name:l.object,vertices:l.data.vertices,normals:l.data.normals,texCoords:l.data.texCoords,ambient:c.ambient,diffuse:c.diffuse,specular:c.specular,shininess:c.shininess,color:c.color,colorTextureSrc:n?`${n}/${c.colorTexture}`:c.colorTexture,normalTextureSrc:n?`${n}/${c.normalTexture}`:c.normalTexture,metallicRoughnessTextureSrc:n?`${n}/${c.metallicRoughnessTexture}`:c.metallicRoughnessTexture})})}static async loadObj(t){const s=await new Cn().load(t);let n=s.materials;return s.geometries.map(o=>{let a=n[o.material]||{};return new $({name:o.object,vertices:o.data.vertices,normals:o.data.normals,texCoords:o.data.texCoords,ambient:a.ambient,diffuse:a.diffuse,specular:a.specular,shininess:a.shininess,color:a.color,colorTextureSrc:a.colorTexture,normalTextureSrc:a.normalTexture,metallicRoughnessTextureSrc:a.metallicRoughnessTexture})})}merge(t){const s=this._vertices.length/3;let n=this._vertices.length;this._vertices.length=n+t._vertices.length;for(let o=0;o<t._vertices.length;o++)this._vertices[n+o]=t._vertices[o];n=this._normals.length,this._normals.length=n+t._normals.length;for(let o=0;o<t._normals.length;o++)this._normals[n+o]=t._normals[o];n=this._texCoords.length,this._texCoords.length=n+t._texCoords.length;for(let o=0;o<t._texCoords.length;o++)this._texCoords[n+o]=t._texCoords[o];n=this._indices.length,this._indices.length=n+t._indices.length;for(let o=0;o<t._indices.length;o++)this._indices[n+o]=t._indices[o]+s;return this._numVertices=this._vertices.length/3,this}static merge(t,s){let n=new $,o=s||t.length;for(let a=0;a<o;a++)n.merge(t[a]);return n}}const tl=new v(0,0,-1),gs=class hd{constructor(t){var s,n;this._handlerIndex=-1,this._tag=t.tag||"tag_"+hd.__counter__++,this._entity=null,this._position=Yt(t.position),this._rtcPositionHigh=new v,this._rtcPositionLow=new v,this._scale=Yt(t.scale,new v(1,1,1)),this._translate=Yt(t.translate,new v),this._localPosition=new v;const[o=.15,a=.15,l=.15,c=1]=(s=t.object3d)!=null&&s.color?Array.from(t.object3d.color):[];this._color=le(t.color,new et(o,a,l,c)),this._handler=null,this._handlerIndex=-1,this._tagData=null,this._tagDataIndex=-1;let d=t.object3d;t.object3d&&((n=t.object3d)==null?void 0:n.vertices.length)!==0||(d=new $),t.objSrc&&(this.setObjectSrc(t.objSrc),this._objectSrc=t.objSrc),this._object3d=d,this._visibility=t.visibility==null||t.visibility,this._children=[],this._direction=new v,this._qFrame=new F,this._qRot=F.IDENTITY}get tag(){return this._tag}getPosition(){return this._position}get object3d(){return this._object3d}get vertices(){return this._object3d.vertices}get normals(){return this._object3d.normals}get texCoords(){return this._object3d.texCoords}get indices(){return this._object3d.indices}setOpacity(t){this._color.w=t,this.setColor(this._color.x,this._color.y,this._color.z,t)}getOpacity(){return this._color.w}setColor(t,s,n,o){this._color.x=t,this._color.y=s,this._color.z=n,o!=null&&(this._color.w=o),this._handler&&this._handler.setRgbaArr(this._tagData,this._tagDataIndex,this._color)}setColor4v(t){this._color.x=t.x,this._color.y=t.y,this._color.z=t.z,t.w!=null&&(this._color.w=t.w),this._handler&&this._handler.setRgbaArr(this._tagData,this._tagDataIndex,this._color)}setVisibility(t){this._visibility=t,this._handler&&this._handler.setVisibility(this._tagData,this._tagDataIndex,t)}getVisibility(){return this._visibility}setPosition(t,s,n){this._position.x=t,this._position.y=s,this._position.z=n,this.updateRTCPosition(),this.updateRotation()}updateRTCPosition(){this._handler&&(this._handler.getRTCPosition(this._position,this._rtcPositionHigh,this._rtcPositionLow),this._handler.setRTCPositionArr(this._tagData,this._tagDataIndex,this._rtcPositionHigh,this._rtcPositionLow))}setPosition3v(t){this.setPosition(t.x,t.y,t.z)}setObject(t){this._object3d=t}setObjectSrc(t){this._objectSrc=t,this._handler&&this._handler.setObjectSrc(t,this.tag)}setColorHTML(t){this.setColor4v(he(t))}setScale(t){this._scale.x=this._scale.y=this._scale.z=t,this._handler&&this._handler.setScaleArr(this._tagData,this._tagDataIndex,this._scale)}setScale3v(t){this._scale.copy(t),this._handler&&this._handler.setScaleArr(this._tagData,this._tagDataIndex,t)}getScale(){return this._scale}setTranslate3v(t){this._translate.copy(t),this._handler&&this._handler.setTranslateArr(this._tagData,this._tagDataIndex,t)}getTranslate(){return this._translate.clone()}setLocalPosition3v(t){this._localPosition.copy(t),this._handler&&this._handler.setLocalPositionArr(this._tagData,this._tagDataIndex,t)}getLocalPosition(){return this._localPosition.clone()}remove(){this._entity=null,this._handler&&this._handler.remove(this)}setPickingColor3v(t){this._handler&&this._handler.setPickingColorArr(this._tagData,this._tagDataIndex,t)}setRotation(t){this._qRot.copy(t),this._qRot.mulVec3Res(tl,this._direction).normalize(),this.updateRotation()}getRotation(){return this._qRot}updateRotation(){this._handler&&this._handler.setQRotArr(this._tagData,this._tagDataIndex,this._qRot)}getDirection(){return this._direction.clone()}};gs.__counter__=0;let yr=gs;const _i={RIGHT:0,LEFT:1,CENTER:2},En={left:_i.LEFT,right:_i.RIGHT,center:_i.CENTER};class el extends rs{constructor(t={}){super(t),this._handler=null,this._text=t.text||"",this._face=Bo(t.face,"arial"),this._size=t.size||24,this._outline=t.outline!=null?t.outline:0,this._outlineColor=le(t.outlineColor,new et(0,0,0,1)),this._align=t.align&&En[t.align.trim().toLowerCase()]||_i.RIGHT,this._fontIndex=0,this._fontAtlas=null,this._isRTL=t.isRTL||!1,this._letterSpacing=t.letterSpacing||0}setText(t){this._text=t.toString(),this._isReady&&this._handler&&this._handler.setText(this._handlerIndex,t,this._fontIndex,this._align,this._letterSpacing,this._isRTL)}setLetterSpacing(t){this._letterSpacing=t,this._isReady&&this._handler&&this._handler.setText(this._handlerIndex,this._text,this._fontIndex,this._align,t,this._isRTL)}getLetterSpacing(){return this._letterSpacing}setRtl(t){this._isRTL=t,this._isReady&&this._handler&&this._handler.setText(this._handlerIndex,this._text,this._fontIndex,this._align,this._letterSpacing,this._isRTL)}getText(){return this._text}setAlign(t){this._align=En[t.trim().toLowerCase()],this._isReady&&this._handler?this._handler.setText(this._handlerIndex,this._text,this._fontIndex,this._align,this._letterSpacing,this._isRTL):this._lockId!==-1&&(this._lockId=-2)}getAlign(){return this._align}setFace(t){this._face=t.trim(),this.update()}getFace(){return this._face}setSize(t){t!==this._size&&(this._size=t,this._isReady&&this._handler?this._handler.setSizeArr(this._handlerIndex,t):this._lockId!==-1&&(this._lockId=-2))}getSize(){return this._size}setOutline(t){this._outline=t,this._isReady&&this._handler?this._handler.setOutlineArr(this._handlerIndex,t):this._lockId!==-1&&(this._lockId=-2)}getOutline(){return this._outline}setOpacity(t){super.setOpacity(t),this.setOutlineOpacity(t)}setOutlineColor(t,s,n,o){o===this._outlineColor.w&&t===this._outlineColor.x&&s===this._outlineColor.y&&n===this._outlineColor.z||(this._outlineColor.x=t,this._outlineColor.y=s,this._outlineColor.z=n,this._outlineColor.w=o,this._isReady&&this._handler?this._handler.setOutlineColorArr(this._handlerIndex,this._outlineColor):this._lockId!==-1&&(this._lockId=-2))}setOutlineColor4v(t){this.setOutlineColor(t.x,t.y,t.z,t.w)}setOutlineColorHTML(t){this.setOutlineColor4v(he(t))}getOutlineColor(){return this._outlineColor}setOutlineOpacity(t){t!==this._outlineColor.w&&(this._outlineColor.w=t,this._isReady&&this._handler?this._handler.setOutlineColorArr(this._handlerIndex,this._outlineColor):this._lockId!==-1&&(this._lockId=-2))}getOutlineOpacity(){return this._outlineColor.w}async update(){if(this._fontAtlas){const t=await this._fontAtlas.getFontIndex(this._face);this._applyFontIndex(t)}}_applyFontIndex(t){this._fontIndex=t,this._isReady&&this._handler?(this._handler.setFontIndexArr(this._handlerIndex,this._fontIndex),this._handler.setText(this._handlerIndex,this._text,this._fontIndex,this._align,this._letterSpacing,this._isRTL)):this._lockId!==-1&&(this._lockId=-2)}assignFontAtlas(t){this._fontAtlas||(this._fontAtlas=t),this.update()}serializeWorkerData(t){return this._handler?new Float32Array([t,this._handler._maxLetters,this.getVisibility()?1:0,this._positionHigh.x,this._positionHigh.y,this._positionHigh.z,this._positionLow.x,this._positionLow.y,this._positionLow.z,this._size,this._offset.x,this._offset.y,this._offset.z,this._color.x,this._color.y,this._color.z,this._color.w,this._rotation,this._alignedAxis.x,this._alignedAxis.y,this._alignedAxis.z,this._fontIndex,this._outline,this._outlineColor.x,this._outlineColor.y,this._outlineColor.z,this._outlineColor.w,this._entity._pickingColor.x,this._entity._pickingColor.y,this._entity._pickingColor.z]):null}}const ps=class cd{constructor(t={}){this.__id=cd.__counter__++,this.visibility=t.visibility==null||t.visibility,this.pointSize=t.pointSize||3,this.pickingScale=t.pickingScale||0,this._renderNode=null,this._entity=null,this._points=[],this._coordinatesData=[],this._colorData=[],this._pickingColorData=[],this._coordinatesBuffer=null,this._colorBuffer=null,this._pickingColorBuffer=null,this._handler=null,this._handlerIndex=-1,this._buffersUpdateCallbacks=[],this._buffersUpdateCallbacks[0]=this._createCoordinatesBuffer,this._buffersUpdateCallbacks[1]=this._createColorBuffer,this._buffersUpdateCallbacks[2]=this._createPickingColorBuffer,this._changedBuffers=new Array(this._buffersUpdateCallbacks.length),t.points&&this.setPoints(t.points)}clear(){this._points.length=0,this._points=[],this._coordinatesData.length=0,this._coordinatesData=[],this._colorData.length=0,this._colorData=[],this._pickingColorData.length=0,this._pickingColorData=[],this._deleteBuffers()}setVisibility(t){this.visibility=t}getVisibility(){return this.visibility}setRenderNode(t){this._renderNode=t,this._setPickingColors()}remove(){this._entity=null,this._handler&&this._handler.remove(this)}setPoints(t){this.clear();for(let s=0;s<t.length;s++){let n=t[s],o=new v(n[0],n[1],n[2]),a=new et(n[3],n[4],n[5],n[6]==null?255:n[6]);this._coordinatesData.push(o.x,o.y,o.z),this._colorData.push(a.x/255,a.y/255,a.z/255,a.w/255);let l={_entity:this._entity,_pickingColor:new v,_entityCollection:this._entity?this._entity._entityCollection:null,index:s,position:o,color:a,pointCloud:this,properties:n[7]||{}};this._points.push(l),this._renderNode&&this._renderNode.renderer&&(this._renderNode.renderer.assignPickingColor(l),this._pickingColorData.push(l._pickingColor.x/255,l._pickingColor.y/255,l._pickingColor.z/255,1))}this._changedBuffers[0]=!0,this._changedBuffers[1]=!0,this._changedBuffers[2]=!0}setPointPosition(t,s,n,o){this._changedBuffers[0]=!0}setPointColor(t,s,n,o,a){this._changedBuffers[1]=!0}addPoints(t){this._changedBuffers[0]=!0,this._changedBuffers[1]=!0,this._changedBuffers[2]=!0}addPoint(t,s){this._changedBuffers[0]=!0,this._changedBuffers[1]=!0,this._changedBuffers[2]=!0}getPoint(t){return this._points[t]}removePoint(t){this._changedBuffers[0]=!0,this._changedBuffers[1]=!0,this._changedBuffers[2]=!0}insertPoint(t,s){this._changedBuffers[0]=!0,this._changedBuffers[1]=!0,this._changedBuffers[2]=!0}draw(){if(this.visibility&&this._coordinatesData.length){this._update();let t=this._renderNode.renderer,s=t.handler.programs.pointCloud,n=s._program,o=t.handler.gl,a=n.attributes,l=n.uniforms;s.activate(),o.uniformMatrix4fv(l.projectionViewMatrix,!1,t.activeCamera.getProjectionViewMatrix()),o.uniform1f(l.opacity,this._handler._entityCollection._fadingOpacity),o.uniform1f(l.pointSize,this.pointSize),o.bindBuffer(o.ARRAY_BUFFER,this._coordinatesBuffer),o.vertexAttribPointer(a.coordinates,this._coordinatesBuffer.itemSize,o.FLOAT,!1,0,0),o.bindBuffer(o.ARRAY_BUFFER,this._colorBuffer),o.vertexAttribPointer(a.colors,this._colorBuffer.itemSize,o.FLOAT,!1,0,0),o.drawArrays(o.POINTS,0,this._coordinatesBuffer.numItems)}}drawPicking(){if(this.visibility&&this._coordinatesData.length){let t=this._renderNode.renderer,s=t.handler.programs.pointCloud,n=s._program,o=t.handler.gl,a=n.attributes,l=n.uniforms;s.activate(),o.uniformMatrix4fv(l.projectionViewMatrix,!1,t.activeCamera.getProjectionViewMatrix()),o.uniform1f(l.opacity,this._handler._entityCollection._fadingOpacity),o.uniform1f(l.pointSize,this.pointSize+this.pickingScale),o.bindBuffer(o.ARRAY_BUFFER,this._coordinatesBuffer),o.vertexAttribPointer(a.coordinates,this._coordinatesBuffer.itemSize,o.FLOAT,!1,0,0),o.bindBuffer(o.ARRAY_BUFFER,this._pickingColorBuffer),o.vertexAttribPointer(a.colors,this._pickingColorBuffer.itemSize,o.FLOAT,!1,0,0),o.drawArrays(o.POINTS,0,this._coordinatesBuffer.numItems)}}_update(){if(this._renderNode){let t=this._changedBuffers.length;for(;t--;)this._changedBuffers[t]&&(this._buffersUpdateCallbacks[t].call(this),this._changedBuffers[t]=!1)}}_deleteBuffers(){if(this._renderNode){let t=this._renderNode.renderer.handler.gl;t.deleteBuffer(this._coordinatesBuffer),t.deleteBuffer(this._colorBuffer),t.deleteBuffer(this._pickingColorBuffer)}this._coordinatesBuffer=null,this._colorBuffer=null,this._pickingColorBuffer=null}_createCoordinatesBuffer(){let t=this._renderNode.renderer.handler;t.gl.deleteBuffer(this._coordinatesBuffer),this._coordinatesBuffer=t.createArrayBuffer(new Float32Array(this._coordinatesData),3,this._coordinatesData.length/3)}_createColorBuffer(){let t=this._renderNode.renderer.handler;t.gl.deleteBuffer(this._colorBuffer),this._colorBuffer=t.createArrayBuffer(new Float32Array(this._colorData),4,this._colorData.length/4)}_createPickingColorBuffer(){let t=this._renderNode.renderer.handler;t.gl.deleteBuffer(this._pickingColorBuffer),this._pickingColorBuffer=t.createArrayBuffer(new Float32Array(this._pickingColorData),4,this._pickingColorData.length/4)}_setPickingColors(){if(this._renderNode&&this._renderNode.renderer){for(let t=0;t<this._points.length;t++){let s=this._points[t];s._entity=this._entity,s._entityCollection=this._entity._entityCollection,this._renderNode.renderer.assignPickingColor(s),this._pickingColorData.push(s._pickingColor.x/255,s._pickingColor.y/255,s._pickingColor.z/255,1)}this._changedBuffers[2]=!0}}};ps.__counter__=0;let xr=ps;const qe=class jc{constructor(t={}){this.__id=jc.__counter__++,this.__doubleToTwoFloats=v.doubleToTwoFloats,this.altitude=t.altitude||0,this.thickness=t.thickness||1.5,this._opacity=t.opacity!=null?t.opacity:1,this._defaultColor=ve(t.color||"#0000FF",t.opacity),this.visibility=t.visibility==null||t.visibility,this._closedLine=t.isClosed||!1,this._path3v=[],this._pathLengths=[],this._pathLonLat=[],this._pathLonLatMerc=[],this._pathColors=t.pathColors?Qr(t.pathColors):[],this._extent=new U,this._verticesHigh=[],this._verticesLow=[],this._orders=[],this._indexes=[],this._colors=[],this._texCoordArr=[],this._atlasTexCoords=[],this._verticesHighBuffer=null,this._verticesLowBuffer=null,this._ordersBuffer=null,this._indexesBuffer=null,this._colorsBuffer=null,this._texCoordBuffer=null,this._pickingColor=[0,0,0],this._renderNode=null,this._entity=null,this._handler=null,this._handlerIndex=-1,this._image=t.image||null,this._src=t.src||null,this._texOffset=t.texOffset||0,this._strokeSize=t.strokeSize!=null?t.strokeSize:32,this._buffersUpdateCallbacks=[],this._buffersUpdateCallbacks[0]=this._createVerticesBuffer,this._buffersUpdateCallbacks[1]=this._createIndexBuffer,this._buffersUpdateCallbacks[2]=this._createColorsBuffer,this._buffersUpdateCallbacks[3]=this._createTexCoordBuffer,this._changedBuffers=new Array(this._buffersUpdateCallbacks.length);let s=Yt(t.visibleSpherePosition).toArray(),n=t.visibleSphereRadius||0;this._visibleSphere=new Float32Array([...s,n]),t.pathLonLat?this.setPathLonLat(t.pathLonLat):t.path3v&&this.setPath3v(t.path3v),this._refresh()}get texOffset(){return this._texOffset}set texOffset(t){this._texOffset=t}get strokeSize(){return this._strokeSize}set strokeSize(t){this._strokeSize=t}setSrc(t){this._src=t;let s=this._handler;if(s){let n=s._entityCollection.renderNode;if(n&&n.renderer){let o=n.renderer.strokeTextureAtlas;t&&t.length?o.loadImage(t,a=>{if(a.__nodeIndex!=null&&o.get(a.__nodeIndex)){this._image=a;let l=o.get(a.__nodeIndex);this._setTexCoordArr(l.texCoords)}else o.addImage(a),o.createTexture(),this._image=a,n.updateStrokeTexCoords()}):(this.setTextureDisabled(),n.updateStrokeTexCoords())}}}getSrc(){return this._src}setImage(t){this.setSrc(t.src)}getImage(){return this._image}_setTexCoordArr(t){this._texCoordArr=[],this._atlasTexCoords=t,jc.setPathTexCoords(this._path3v,t,this._texCoordArr),this._changedBuffers[3]=!0}setTextureDisabled(){this._strokeSize=0}__appendLineData3v(t,s,n,o,a,l,c,d,u,_,f,g,m,p){var x=0,y=new v,w=new v;m&&(m.southWest.set(180,90),m.northEast.set(-180,-90)),d.length>0?(x=d[d.length-5]+9,d.push(x,x)):d.push(0,0);for(let z=0,O=t.length;z<O;z++){var C=t[z],T=s[z];if(_[z]=[],g[z]=[],f[z]=[],C.length===0)continue;var P,E=x;if(o)(P=C[C.length-1])instanceof Array&&(P=new v(P[0],P[1],P[2]));else{var S=C[0],M=C[1]||S;S instanceof Array&&(S=new v(S[0],S[1],S[2])),M instanceof Array&&(M=new v(M[0],M[1],M[2])),P=new v(S.x+S.x-M.x,S.y+S.y-M.y,S.z+S.z-M.z)}let ze=n;T&&T[0]&&(ze=T[0]),this.__doubleToTwoFloats(P,y,w),a.push(y.x,y.y,y.z,y.x,y.y,y.z,y.x,y.y,y.z,y.x,y.y,y.z),l.push(w.x,w.y,w.z,w.x,w.y,w.z,w.x,w.y,w.z,w.x,w.y,w.z);let D=ze[0],re=ze[1],Ee=ze[2],I=ze[3]!=null?ze[3]:1;z>0&&p.push(D,re,Ee,I,D,re,Ee,I,D,re,Ee,I,D,re,Ee,I),c.push(1,-1,2,-2);for(let N=0,rt=C.length;N<rt;N++){var R=C[N];if(R instanceof Array&&(R=new v(R[0],R[1],R[2])),f[z].push(R),u){var k=u.cartesianToLonLat(R);_[z].push(k),g[z].push(k.forwardMercator()),k.lon<m.southWest.lon&&(m.southWest.lon=k.lon),k.lat<m.southWest.lat&&(m.southWest.lat=k.lat),k.lon>m.northEast.lon&&(m.northEast.lon=k.lon),k.lat>m.northEast.lat&&(m.northEast.lat=k.lat)}T&&T[N]&&(ze=T[N]),D=ze[0],re=ze[1],Ee=ze[2],I=ze[3]!=null?ze[3]:1,this.__doubleToTwoFloats(R,y,w),a.push(y.x,y.y,y.z,y.x,y.y,y.z,y.x,y.y,y.z,y.x,y.y,y.z),l.push(w.x,w.y,w.z,w.x,w.y,w.z,w.x,w.y,w.z,w.x,w.y,w.z),p.push(D,re,Ee,I,D,re,Ee,I,D,re,Ee,I,D,re,Ee,I),c.push(1,-1,2,-2),d.push(x++,x++,x++,x++)}var B;if(o)(B=C[0])instanceof Array&&(B=new v(B[0],B[1],B[2])),d.push(E,E+1,E+1,E+1);else{let N=C[C.length-1],rt=C[C.length-2]||N;N instanceof Array&&(N=new v(N[0],N[1],N[2])),rt instanceof Array&&(rt=new v(rt[0],rt[1],rt[2])),B=new v(N.x+N.x-rt.x,N.y+N.y-rt.y,N.z+N.z-rt.z),d.push(x-1,x-1,x-1,x-1)}T&&T[C.length-1]&&(ze=T[C.length-1]),D=ze[0],re=ze[1],Ee=ze[2],I=ze[3]!=null?ze[3]:1,this.__doubleToTwoFloats(B,y,w),a.push(y.x,y.y,y.z,y.x,y.y,y.z,y.x,y.y,y.z,y.x,y.y,y.z),l.push(w.x,w.y,w.z,w.x,w.y,w.z,w.x,w.y,w.z,w.x,w.y,w.z),p.push(D,re,Ee,I,D,re,Ee,I,D,re,Ee,I,D,re,Ee,I),c.push(1,-1,2,-2),z<t.length-1&&t[z+1].length!==0&&(x+=8,d.push(x,x))}}__appendPoint3v(t,s,n,o,a,l,c,d,u,_,f,g,m,p){var x=new v,y=new v,w=_.length-4,C=_[w-1]+1;t.length===0?(t.push([]),n[0]||(n[0]=[])):n[t.length-1]||(n[t.length-1]=[]);var T=t[t.length-1],P=T.length;T.push(s);let E=o[0],S=o[1],M=o[2],R=o[3]!=null?o[3]:1,k=n[t.length-1];if(k[P]?(k[P][0]=E,k[P][1]=S,k[P][2]=M,k[P][3]=R):k.push(o),P===1){var B;if(a)(B=T[P-1])instanceof Array&&(B=new v(B[0],B[1],B[2]));else{let N=T[0],rt=T[1]||N;N instanceof Array&&(N=new v(N[0],N[1],N[2])),rt instanceof Array&&(rt=new v(rt[0],rt[1],rt[2])),B=new v(N.x+N.x-rt.x,N.y+N.y-rt.y,N.z+N.z-rt.z)}this.__doubleToTwoFloats(B,x,y);let I=l.length-36;l[I]=x.x,l[I+1]=x.y,l[I+2]=x.z,l[I+3]=x.x,l[I+4]=x.y,l[I+5]=x.z,l[I+6]=x.x,l[I+7]=x.y,l[I+8]=x.z,l[I+9]=x.x,l[I+10]=x.y,l[I+11]=x.z,c[I]=y.x,c[I+1]=y.y,c[I+2]=y.z,c[I+3]=y.x,c[I+4]=y.y,c[I+5]=y.z,c[I+6]=y.x,c[I+7]=y.y,c[I+8]=y.z,c[I+9]=y.x,c[I+10]=y.y,c[I+11]=y.z}var z=C;if(f){g.length===0&&g.push([]),m.length===0&&m.push([]);var O=g[g.length-1],ze=m[m.length-1];let I=f.cartesianToLonLat(s);O.push(I),ze.push(I.forwardMercator()),I.lon<p.southWest.lon&&(p.southWest.lon=I.lon),I.lat<p.southWest.lat&&(p.southWest.lat=I.lat),I.lon>p.northEast.lon&&(p.northEast.lon=I.lon),I.lat>p.northEast.lat&&(p.northEast.lat=I.lat)}this.__doubleToTwoFloats(s,x,y);let D=l.length-12;l[D]=x.x,l[D+1]=x.y,l[D+2]=x.z,l[D+3]=x.x,l[D+4]=x.y,l[D+5]=x.z,l[D+6]=x.x,l[D+7]=x.y,l[D+8]=x.z,l[D+9]=x.x,l[D+10]=x.y,l[D+11]=x.z,c[D]=y.x,c[D+1]=y.y,c[D+2]=y.z,c[D+3]=y.x,c[D+4]=y.y,c[D+5]=y.z,c[D+6]=y.x,c[D+7]=y.y,c[D+8]=y.z,c[D+9]=y.x,c[D+10]=y.y,c[D+11]=y.z;let re=d.length-16;var Ee;if(d[re]=E,d[re+1]=S,d[re+2]=M,d[re+3]=R,d[re+4]=E,d[re+5]=S,d[re+6]=M,d[re+7]=R,d[re+8]=E,d[re+9]=S,d[re+10]=M,d[re+11]=R,d[re+12]=E,d[re+13]=S,d[re+14]=M,d[re+15]=R,_[w]=C++,_[w+1]=C++,_[w+2]=C++,_[w+3]=C++,a)Ee=T[0],_.push(z,z+1,z+1,z+1);else{let I=T[T.length-1],N=T[T.length-2]||I;Ee=new v(I.x+I.x-N.x,I.y+I.y-N.y,I.z+I.z-N.z),_.push(C-1,C-1,C-1,C-1)}this.__doubleToTwoFloats(Ee,x,y),l.push(x.x,x.y,x.z,x.x,x.y,x.z,x.x,x.y,x.z,x.x,x.y,x.z),c.push(y.x,y.y,y.z,y.x,y.y,y.z,y.x,y.y,y.z,y.x,y.y,y.z),d.push(E,S,M,R,E,S,M,R,E,S,M,R,E,S,M,R),u.push(1,-1,2,-2)}static setPathTexCoords(t,s,n){let o=s[1],a=s[3]-o,l=new H(s[4],s[5]),c=new H(s[2],s[3]),d=new H(s[8],s[9]),u=new H(s[0],s[1]);for(let f=0,g=t.length;f<g;f++){var _=t[f];if(_.length!==0){f>0&&n.push(l.x,l.y,o,a,c.x,c.y,o,a,d.x,d.y,o,a,u.x,u.y,o,a);for(let m=0,p=_.length;m<p;m++)n.push(l.x,l.y,o,a,c.x,c.y,o,a,d.x,d.y,o,a,u.x,u.y,o,a);n.push(l.x,l.y,o,a,c.x,c.y,o,a,d.x,d.y,o,a,u.x,u.y,o,a)}}}static setPathColors(t,s,n,o){for(let c=0,d=t.length;c<d;c++){var a=t[c],l=s[c];if(a.length===0)continue;let u=n;l&&l[0]&&(u=l[0]);let _=u[0],f=u[1],g=u[2],m=u[3]!=null?u[3]:1;c>0&&o.push(_,f,g,m,_,f,g,m,_,f,g,m,_,f,g,m);for(let p=0,x=a.length;p<x;p++)l&&l[p]&&(u=l[p]),_=u[0],f=u[1],g=u[2],m=u[3]!=null?u[3]:1,o.push(_,f,g,m,_,f,g,m,_,f,g,m,_,f,g,m);l&&l[a.length-1]&&(u=l[a.length-1]),_=u[0],f=u[1],g=u[2],m=u[3]!=null?u[3]:1,o.push(_,f,g,m,_,f,g,m,_,f,g,m,_,f,g,m)}}__appendLineDataLonLat(t,s,n,o,a,l,c,d,u,_,f,g,m,p,x){var y=0,w=new v,C=new v;p&&(p.southWest.set(180,90),p.northEast.set(-180,-90)),d.length>0?(y=d[d.length-5]+9,d.push(y)):d.push(0);for(let B=0,z=t.length;B<z;B++){var T=t[B],P=s[B];if(f[B]=[],m[B]=[],g[B]=[],T.length===0)continue;var E,S=y;if(o){let I=T[T.length-1];E=I instanceof Array?_.lonLatToCartesian(new L(I[0],I[1],I[2])):_.lonLatToCartesian(I)}else{let I,N,rt=T[0];I=rt instanceof Array?_.lonLatToCartesian(new L(rt[0],rt[1],rt[2])):_.lonLatToCartesian(rt),rt=T[1],rt||(rt=T[0]),N=rt instanceof Array?_.lonLatToCartesian(new L(rt[0],rt[1],rt[2])):_.lonLatToCartesian(rt),E=new v(I.x+I.x-N.x,I.y+I.y-N.y,I.z+I.z-N.z)}let O=n;P&&P[0]&&(O=P[0]),this.__doubleToTwoFloats(E,w,C),a.push(w.x,w.y,w.z,w.x,w.y,w.z,w.x,w.y,w.z,w.x,w.y,w.z),l.push(C.x,C.y,C.z,C.x,C.y,C.z,C.x,C.y,C.z,C.x,C.y,C.z);let ze=O[0],D=O[1],re=O[2],Ee=O[3]!=null?O[3]:1;B>0&&x.push(ze,D,re,Ee,ze,D,re,Ee,ze,D,re,Ee,ze,D,re,Ee),c.push(1,-1,2,-2),u.push(0,0,0,0,1,0,0,0,1,0,0,0,1,1,0,0);for(let I=0,N=T.length;I<N;I++){var M=T[I];M instanceof Array&&(M=new L(M[0],M[1],M[2])),P&&P[I]&&(O=P[I]),ze=O[0],D=O[1],re=O[2],Ee=O[3]!=null?O[3]:1;var R=_.lonLatToCartesian(M);f[B].push(R),g[B].push(M),m[B].push(M.forwardMercator()),this.__doubleToTwoFloats(R,w,C),a.push(w.x,w.y,w.z,w.x,w.y,w.z,w.x,w.y,w.z,w.x,w.y,w.z),l.push(C.x,C.y,C.z,C.x,C.y,C.z,C.x,C.y,C.z,C.x,C.y,C.z),x.push(ze,D,re,Ee,ze,D,re,Ee,ze,D,re,Ee,ze,D,re,Ee),c.push(1,-1,2,-2),d.push(y++,y++,y++,y++),u.push(0,0,0,0,1,0,0,0,1,0,0,0,1,1,0,0),M.lon<p.southWest.lon&&(p.southWest.lon=M.lon),M.lat<p.southWest.lat&&(p.southWest.lat=M.lat),M.lon>p.northEast.lon&&(p.northEast.lon=M.lon),M.lat>p.northEast.lat&&(p.northEast.lat=M.lat)}var k;if(o){let I=T[0];k=I instanceof Array?_.lonLatToCartesian(new L(I[0],I[1],I[2])):_.lonLatToCartesian(I),d.push(S,S+1,S+1,S+1)}else{let I,N,rt=T[T.length-1];I=rt instanceof Array?_.lonLatToCartesian(new L(rt[0],rt[1],rt[2])):_.lonLatToCartesian(rt),rt=T[T.length-2],rt||(rt=T[0]),N=rt instanceof Array?_.lonLatToCartesian(new L(rt[0],rt[1],rt[2])):_.lonLatToCartesian(rt),k=new v(I.x+I.x-N.x,I.y+I.y-N.y,I.z+I.z-N.z),d.push(y-1,y-1,y-1,y-1)}P&&P[T.length-1]&&(O=P[T.length-1]),ze=O[0],D=O[1],re=O[2],Ee=O[3]!=null?O[3]:1,this.__doubleToTwoFloats(k,w,C),a.push(w.x,w.y,w.z,w.x,w.y,w.z,w.x,w.y,w.z,w.x,w.y,w.z),l.push(C.x,C.y,C.z,C.x,C.y,C.z,C.x,C.y,C.z,C.x,C.y,C.z),x.push(ze,D,re,Ee,ze,D,re,Ee,ze,D,re,Ee,ze,D,re,Ee),c.push(1,-1,2,-2),u.push(0,0,0,0,1,0,0,0,1,0,0,0,1,1,0,0),B<t.length-1&&t[B+1].length!==0&&(y+=8,d.push(y,y))}}_setEqualPath3v(t){var s=this._extent;s.southWest.set(180,90),s.northEast.set(-180,-90);var n=new v,o=new v,a=this._verticesHigh,l=this._verticesLow,c=this._pathLonLat,d=this._pathLonLatMerc,u=0,_=this._renderNode.ellipsoid;for(let C=0;C<t.length;C++){var f,g,m=t[C];f=this._closedLine?m[m.length-1]:new v(m[0].x+m[0].x-m[1].x,m[0].y+m[0].y-m[1].y,m[0].z+m[0].z-m[1].z),this.__doubleToTwoFloats(f,n,o),a[u]=n.x,l[u++]=o.x,a[u]=n.y,l[u++]=o.y,a[u]=n.z,l[u++]=o.z,a[u]=n.x,l[u++]=o.x,a[u]=n.y,l[u++]=o.y,a[u]=n.z,l[u++]=o.z,a[u]=n.x,l[u++]=o.x,a[u]=n.y,l[u++]=o.y,a[u]=n.z,l[u++]=o.z,a[u]=n.x,l[u++]=o.x,a[u]=n.y,l[u++]=o.y,a[u]=n.z,l[u++]=o.z;for(let T=0;T<m.length;T++){var p=m[T],x=this._path3v[C][T];if(x.x=p.x,x.y=p.y,x.z=p.z,_){var y=_.cartesianToLonLat(p);this._pathLonLat[C][T]=y,c[C][T]=y,d[C][T]=y.forwardMercator(),y.lon<s.southWest.lon&&(s.southWest.lon=y.lon),y.lat<s.southWest.lat&&(s.southWest.lat=y.lat),y.lon>s.northEast.lon&&(s.northEast.lon=y.lon),y.lat>s.northEast.lat&&(s.northEast.lat=y.lat)}this.__doubleToTwoFloats(p,n,o),a[u]=n.x,l[u++]=o.x,a[u]=n.y,l[u++]=o.y,a[u]=n.z,l[u++]=o.z,a[u]=n.x,l[u++]=o.x,a[u]=n.y,l[u++]=o.y,a[u]=n.z,l[u++]=o.z,a[u]=n.x,l[u++]=o.x,a[u]=n.y,l[u++]=o.y,a[u]=n.z,l[u++]=o.z,a[u]=n.x,l[u++]=o.x,a[u]=n.y,l[u++]=o.y,a[u]=n.z,l[u++]=o.z}if(this._closedLine)g=m[0];else{var w=m.length-1;g=new v(m[w].x+m[w].x-m[w-1].x,m[w].y+m[w].y-m[w-1].y,m[w].z+m[w].z-m[w-1].z)}this.__doubleToTwoFloats(g,n,o),a[u]=n.x,l[u++]=o.x,a[u]=n.y,l[u++]=o.y,a[u]=n.z,l[u++]=o.z,a[u]=n.x,l[u++]=o.x,a[u]=n.y,l[u++]=o.y,a[u]=n.z,l[u++]=o.z,a[u]=n.x,l[u++]=o.x,a[u]=n.y,l[u++]=o.y,a[u]=n.z,l[u++]=o.z,a[u]=n.x,l[u++]=o.x,a[u]=n.y,l[u++]=o.y,a[u]=n.z,l[u++]=o.z}}_setEqualPathLonLat(t){var s=this._extent;s.southWest.set(180,90),s.northEast.set(-180,-90);var n=new v,o=new v,a=this._verticesHigh,l=this._verticesLow,c=this._pathLonLat,d=this._pathLonLatMerc,u=this._path3v,_=0,f=this._renderNode.ellipsoid;for(let w=0;w<t.length;w++){var g,m,p=t[w];if(this._closedLine)g=f.lonLatToCartesian(p[p.length-1]);else{let C=f.lonLatToCartesian(p[0]),T=f.lonLatToCartesian(p[1]);g=new v(C.x+C.x-T.x,C.y+C.y-T.y,C.z+C.z-T.z)}this.__doubleToTwoFloats(g,n,o),a[_]=n.x,l[_++]=o.x,a[_]=n.y,l[_++]=o.y,a[_]=n.z,l[_++]=o.z,a[_]=n.x,l[_++]=o.x,a[_]=n.y,l[_++]=o.y,a[_]=n.z,l[_++]=o.z,a[_]=n.x,l[_++]=o.x,a[_]=n.y,l[_++]=o.y,a[_]=n.z,l[_++]=o.z,a[_]=n.x,l[_++]=o.x,a[_]=n.y,l[_++]=o.y,a[_]=n.z,l[_++]=o.z;for(let C=0;C<p.length;C++){var x=p[C],y=f.lonLatToCartesian(x);u[w][C]=y,d[w][C]=x.forwardMercator(),c[w][C]=x,this.__doubleToTwoFloats(y,n,o),a[_]=n.x,l[_++]=o.x,a[_]=n.y,l[_++]=o.y,a[_]=n.z,l[_++]=o.z,a[_]=n.x,l[_++]=o.x,a[_]=n.y,l[_++]=o.y,a[_]=n.z,l[_++]=o.z,a[_]=n.x,l[_++]=o.x,a[_]=n.y,l[_++]=o.y,a[_]=n.z,l[_++]=o.z,a[_]=n.x,l[_++]=o.x,a[_]=n.y,l[_++]=o.y,a[_]=n.z,l[_++]=o.z,x.lon<s.southWest.lon&&(s.southWest.lon=x.lon),x.lat<s.southWest.lat&&(s.southWest.lat=x.lat),x.lon>s.northEast.lon&&(s.northEast.lon=x.lon),x.lat>s.northEast.lat&&(s.northEast.lat=x.lat)}if(this._closedLine)m=f.lonLatToCartesian(p[0]);else{let C=f.lonLatToCartesian(p[p.length-1]),T=f.lonLatToCartesian(p[p.length-2]);m=new v(C.x+C.x-T.x,C.y+C.y-T.y,C.z+C.z-T.z)}this.__doubleToTwoFloats(m,n,o),a[_]=n.x,l[_++]=o.x,a[_]=n.y,l[_++]=o.y,a[_]=n.z,l[_++]=o.z,a[_]=n.x,l[_++]=o.x,a[_]=n.y,l[_++]=o.y,a[_]=n.z,l[_++]=o.z,a[_]=n.x,l[_++]=o.x,a[_]=n.y,l[_++]=o.y,a[_]=n.z,l[_++]=o.z,a[_]=n.x,l[_++]=o.x,a[_]=n.y,l[_++]=o.y,a[_]=n.z,l[_++]=o.z}}setPointLonLat(t,s,n){if(this._renderNode&&this._renderNode.ellipsoid){let d=this._pathLonLat,u=this._pathLonLatMerc;d[n][s]=t,u[n][s]=t.forwardMercator();var o=this._extent;o.southWest.set(180,90),o.northEast.set(-180,-90);for(let _=0;_<d.length;_++){var a=d[_];for(let f=0;f<a.length;f++){var l=a[f].lon,c=a[f].lat;l>o.northEast.lon&&(o.northEast.lon=l),c>o.northEast.lat&&(o.northEast.lat=c),l<o.southWest.lon&&(o.southWest.lon=l),c<o.southWest.lat&&(o.southWest.lat=c)}}this.setPoint3v(this._renderNode.ellipsoid.lonLatToCartesian(t),s,n,!0)}else{let d=this._pathLonLat[n];d[s].lon=t.lon,d[s].lat=t.lat,d[s].height=t.height}}setPoint3v(t,s=0,n=0,o=!1){if(this._renderNode){var a,l=new v,c=new v,d=this._verticesHigh,u=this._verticesLow,_=this._pathLonLat,f=this._pathLonLatMerc,g=0;a=12*this._pathLengths[n]+24*n;let E=this._path3v[n];E[s].x=t.x,E[s].y=t.y,E[s].z=t.z;let S=this._closedLine||E.length===1;var m;if((s===0||s===1)&&(m=S?E[E.length-1]:new v(E[0].x+E[0].x-E[1].x,E[0].y+E[0].y-E[1].y,E[0].z+E[0].z-E[1].z),g=a,this.__doubleToTwoFloats(m,l,c),d[g]=l.x,d[g+1]=l.y,d[g+2]=l.z,d[g+3]=l.x,d[g+4]=l.y,d[g+5]=l.z,d[g+6]=l.x,d[g+7]=l.y,d[g+8]=l.z,d[g+9]=l.x,d[g+10]=l.y,d[g+11]=l.z,u[g]=c.x,u[g+1]=c.y,u[g+2]=c.z,u[g+3]=c.x,u[g+4]=c.y,u[g+5]=c.z,u[g+6]=c.x,u[g+7]=c.y,u[g+8]=c.z,u[g+9]=c.x,u[g+10]=c.y,u[g+11]=c.z),!o&&this._renderNode.ellipsoid){var p=this._renderNode.ellipsoid.cartesianToLonLat(t);_[n][s]=p,f[n][s]=p.forwardMercator();var x=this._extent;x.southWest.set(180,90),x.northEast.set(-180,-90);for(let M=0;M<_.length;M++){var y=_[M];for(let R=0;R<y.length;R++){var w=y[R].lon,C=y[R].lat;w>x.northEast.lon&&(x.northEast.lon=w),C>x.northEast.lat&&(x.northEast.lat=C),w<x.southWest.lon&&(x.southWest.lon=w),C<x.southWest.lat&&(x.southWest.lat=C)}}}if(g=a+12*s+12,this.__doubleToTwoFloats(t,l,c),d[g]=l.x,d[g+1]=l.y,d[g+2]=l.z,d[g+3]=l.x,d[g+4]=l.y,d[g+5]=l.z,d[g+6]=l.x,d[g+7]=l.y,d[g+8]=l.z,d[g+9]=l.x,d[g+10]=l.y,d[g+11]=l.z,u[g]=c.x,u[g+1]=c.y,u[g+2]=c.z,u[g+3]=c.x,u[g+4]=c.y,u[g+5]=c.z,u[g+6]=c.x,u[g+7]=c.y,u[g+8]=c.z,u[g+9]=c.x,u[g+10]=c.y,u[g+11]=c.z,s===E.length-1||s===E.length-2){var T;if(S)T=E[0];else{var P=E.length-1;T=new v(E[P].x+E[P].x-E[P-1].x,E[P].y+E[P].y-E[P-1].y,E[P].z+E[P].z-E[P-1].z)}g=a+12*E.length+12,this.__doubleToTwoFloats(T,l,c),d[g]=l.x,d[g+1]=l.y,d[g+2]=l.z,d[g+3]=l.x,d[g+4]=l.y,d[g+5]=l.z,d[g+6]=l.x,d[g+7]=l.y,d[g+8]=l.z,d[g+9]=l.x,d[g+10]=l.y,d[g+11]=l.z,u[g]=c.x,u[g+1]=c.y,u[g+2]=c.z,u[g+3]=c.x,u[g+4]=c.y,u[g+5]=c.z,u[g+6]=c.x,u[g+7]=c.y,u[g+8]=c.z,u[g+9]=c.x,u[g+10]=c.y,u[g+11]=c.z}this._changedBuffers[0]=!0}else{let E=this._path3v[n];E[s].x=t.x,E[s].y=t.y,E[s].z=t.z}}_resizePathLengths(t=0){this._pathLengths[0]=0;for(let s=t+1,n=this._path3v.length;s<=n;s++)this._pathLengths[s]=this._pathLengths[s-1]+this._path3v[s-1].length}removeSegment(t){this._path3v.splice(t,1),this.setPath3v([].concat(this._path3v))}removePoint(t,s=0){this._path3v[s].splice(t,1),this._path3v[s].length===0&&this._path3v.splice(s,1),this.setPath3v([].concat(this._path3v))}insertPoint3v(t,s=0,n,o=0){let a=[].concat(this._path3v),l=a[o];if(l){let c=[].concat(this._pathColors);if(l.splice(s,0,t),n){let d=c[o];d||(d=new Array(l.length)),d.splice(s,0,n)}this.setPath3v(a,c)}else this.addPoint3v(t,o)}appendPoint3v(t,s,n){this._path3v.length!==0&&this._renderNode?(this._verticesHigh=Ve(this._verticesHigh),this._verticesLow=Ve(this._verticesLow),this._colors=Ve(this._colors),this._orders=Ve(this._orders),this._indexes=Ve(this._indexes),this.__appendPoint3v(this._path3v,t,this._pathColors,s||this._defaultColor,this._closedLine,this._verticesHigh,this._verticesLow,this._colors,this._orders,this._indexes,n?null:this._renderNode.ellipsoid,this._pathLonLat,this._pathLonLatMerc,this._extent),this._pathLengths[this._path3v.length]+=1,this._changedBuffers[0]=!0,this._changedBuffers[2]=!0,this._changedBuffers[1]=!0):(this._pathColors.push([s||this._defaultColor]),this.addPoint3v(t))}addPoint3v(t,s=0){s>=this._path3v.length&&this._path3v.push([]),this._path3v[s].push(t),this.setPath3v([].concat(this._path3v))}addPointLonLat(t,s=0){s>=this._pathLonLat.length&&this._pathLonLat.push([]),this._pathLonLat[s].push(t),this.setPathLonLat([].concat(this._pathLonLat))}clear(){this._clearData()}setPointColor(t,s=0,n=0){if(this._renderNode&&s<this._path3v[n].length){let o=this._pathColors[n];if(!o){if(!(this._path3v[n]&&s<this._path3v[n].length))return;this._pathColors[n]=new Array(this._path3v[n].length)}o[s]?(o[s][0]=t[0],o[s][1]=t[1],o[s][2]=t[2],o[s][3]=t[3]||1):o[s]=[t[0],t[1],t[2],t[3]||1];let a=this._colors,l=16*s+16*this._pathLengths[n]+32*n;a[l]=a[l+4]=a[l+8]=a[l+12]=t[0],a[l+1]=a[l+5]=a[l+9]=a[l+13]=t[1],a[l+2]=a[l+6]=a[l+10]=a[l+14]=t[2],a[l+3]=a[l+7]=a[l+11]=a[l+15]=t[3]||1,this._changedBuffers[2]=!0}else this._pathColors[n][s]=t}setOpacity(t){this._opacity=t}getOpacity(){return this._opacity}setAltitude(t){this.altitude=t}setThickness(t){this.thickness=t}getThickness(){return this.thickness}setVisibility(t){this.visibility=t}getVisibility(){return this.visibility}setRenderNode(t){t&&(this._renderNode=t,this._pathLonLat.length?this._createDataLonLat([].concat(this._pathLonLat)):this._createData3v([].concat(this._path3v)),this._refresh(),t.renderer&&t.renderer.isInitialized()&&this._update())}_clearData(){this._verticesHigh=null,this._verticesLow=null,this._orders=null,this._indexes=null,this._colors=null,this._texCoordArr=null,this._verticesHigh=[],this._verticesLow=[],this._orders=[],this._indexes=[],this._colors=[],this._texCoordArr=[],this._path3v.length=0,this._pathLonLat.length=0,this._pathLonLatMerc.length=0,this._path3v=[],this._pathLonLat=[],this._pathLonLatMerc=[]}_createData3v(t){this._clearData(),this.__appendLineData3v(t,this._pathColors,this._defaultColor,this._closedLine,this._verticesHigh,this._verticesLow,this._orders,this._indexes,this._renderNode.ellipsoid,this._pathLonLat,this._path3v,this._pathLonLatMerc,this._extent,this._colors),this._resizePathLengths(0)}_createDataLonLat(t){this._clearData(),this.__appendLineDataLonLat(t,this._pathColors,this._defaultColor,this._closedLine,this._verticesHigh,this._verticesLow,this._orders,this._indexes,this._texCoordArr,this._renderNode.ellipsoid,this._path3v,this._pathLonLat,this._pathLonLatMerc,this._extent,this._colors),this._resizePathLengths(0)}remove(){this._entity=null,this._pathColors.length=0,this._pathColors=[],this._verticesHigh=null,this._verticesLow=null,this._orders=null,this._indexes=null,this._colors=null,this._texCoordArr=null,this._verticesHigh=[],this._verticesLow=[],this._orders=[],this._indexes=[],this._colors=[],this._texCoordArr=[],this._deleteBuffers(),this._handler&&this._handler.remove(this)}setPickingColor3v(t){this._pickingColor[0]=t.x/255,this._pickingColor[1]=t.y/255,this._pickingColor[2]=t.z/255}getExtent(){return this._extent.clone()}getPath3v(){return this._path3v}getPathLonLat(){return this._pathLonLat}getPathColors(){return this._pathColors}setPathColors(t){t&&(this._colors=[],this._pathColors=[].concat(t),jc.setPathColors(this._pathLonLat,t,this._defaultColor,this._colors),this._changedBuffers[2]=!0)}setColorHTML(t){this._defaultColor=ve(t);let s=he(t),n=this._pathColors;for(let a=0,l=n.length;a<l;a++){let c=n[a];for(let d=0,u=c.length;d<u;d++)c[d][0]=s.x,c[d][1]=s.y,c[d][2]=s.z,c[d][3]=s.w}let o=this._colors;for(let a=0,l=o.length;a<l;a+=4)o[a]=s.x,o[a+1]=s.y,o[a+2]=s.z,o[a+3]=s.w;this._changedBuffers[2]=!0}setPathLonLatFast(t,s){this.setPathLonLat(t,s,!0)}setPath3vFast(t,s){this.setPath3v(t,s,!0)}setPathLonLat(t,s,n=!1){s&&(this._pathColors=[].concat(s)),this._renderNode&&this._renderNode.ellipsoid?n?(this._setEqualPathLonLat(t),this._changedBuffers[0]=!0,this._changedBuffers[2]=!0):(this._createDataLonLat(t),this._changedBuffers[0]=!0,this._changedBuffers[1]=!0,this._changedBuffers[2]=!0):this._pathLonLat=[].concat(t)}getSize(t=0){return this._path3v[t].length}setPath3v(t,s,n=!1){s&&(this._pathColors=[].concat(s)),this._renderNode?n?(this._setEqualPath3v(t),this._changedBuffers[0]=!0,this._changedBuffers[2]=!0):(this._createData3v(t),this._changedBuffers[0]=!0,this._changedBuffers[1]=!0,this._changedBuffers[2]=!0):this._path3v=[].concat(t)}draw(){if(this.visibility&&this._path3v.length){this._update();let t=this._renderNode.renderer,s=t.handler.programs.polyline_screen,n=s._program,o=t.handler.gl,a=n.attributes,l=n.uniforms,c=this._handler._entityCollection;s.activate(),o.disable(o.CULL_FACE),o.uniform1f(l.depthOffset,c.polygonOffsetUnits),o.uniformMatrix4fv(l.proj,!1,t.activeCamera.getProjectionMatrix()),o.uniformMatrix4fv(l.view,!1,t.activeCamera.getViewMatrix()),o.uniform3fv(l.rtcEyePositionHigh,this._handler._rtcEyePositionHigh),o.uniform3fv(l.rtcEyePositionLow,this._handler._rtcEyePositionLow),o.uniform4fv(l.visibleSphere,this._visibleSphere),o.uniform2fv(l.viewport,[t.handler.canvas.width,t.handler.canvas.height]),o.uniform1f(l.thickness,.5*this.thickness),o.uniform1f(l.opacity,this._opacity*c._fadingOpacity),o.uniform1f(l.texOffset,this._texOffset),o.uniform1f(l.strokeSize,this._strokeSize),o.bindBuffer(o.ARRAY_BUFFER,this._colorsBuffer),o.vertexAttribPointer(a.color,this._colorsBuffer.itemSize,o.FLOAT,!1,0,0),o.bindBuffer(o.ARRAY_BUFFER,this._texCoordBuffer),o.vertexAttribPointer(a.texCoord,this._texCoordBuffer.itemSize,o.FLOAT,!1,0,0);let d=this._verticesHighBuffer;o.bindBuffer(o.ARRAY_BUFFER,d),o.vertexAttribPointer(a.prevHigh,d.itemSize,o.FLOAT,!1,12,0),o.vertexAttribPointer(a.currentHigh,d.itemSize,o.FLOAT,!1,12,48),o.vertexAttribPointer(a.nextHigh,d.itemSize,o.FLOAT,!1,12,96),d=this._verticesLowBuffer,o.bindBuffer(o.ARRAY_BUFFER,d),o.vertexAttribPointer(a.prevLow,d.itemSize,o.FLOAT,!1,12,0),o.vertexAttribPointer(a.currentLow,d.itemSize,o.FLOAT,!1,12,48),o.vertexAttribPointer(a.nextLow,d.itemSize,o.FLOAT,!1,12,96),o.bindBuffer(o.ARRAY_BUFFER,this._ordersBuffer),o.vertexAttribPointer(a.order,this._ordersBuffer.itemSize,o.FLOAT,!1,4,0),o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,this._indexesBuffer),o.drawElements(o.TRIANGLE_STRIP,this._indexesBuffer.numItems,o.UNSIGNED_INT,0),o.enable(o.CULL_FACE)}}drawPicking(){if(this.visibility&&this._path3v.length){let t=this._renderNode.renderer,s=t.handler.programs.polyline_picking,n=s._program,o=t.handler.gl,a=n.attributes,l=n.uniforms,c=this._handler._entityCollection;s.activate(),o.disable(o.CULL_FACE),o.uniform1f(l.depthOffset,c.polygonOffsetUnits),o.uniformMatrix4fv(l.proj,!1,t.activeCamera.getProjectionMatrix()),o.uniformMatrix4fv(l.view,!1,t.activeCamera.getViewMatrix()),o.uniform4fv(l.color,[this._pickingColor[0],this._pickingColor[1],this._pickingColor[2],1]),o.uniform3fv(l.rtcEyePositionHigh,this._handler._rtcEyePositionHigh),o.uniform3fv(l.rtcEyePositionLow,this._handler._rtcEyePositionLow),o.uniform4fv(l.visibleSphere,this._visibleSphere),o.uniform2fv(l.viewport,[t.handler.canvas.width,t.handler.canvas.height]),o.uniform1f(l.thickness,.5*this.thickness*c.pickingScale[0]);let d=this._verticesHighBuffer;o.bindBuffer(o.ARRAY_BUFFER,d),o.vertexAttribPointer(a.prevHigh,d.itemSize,o.FLOAT,!1,12,0),o.vertexAttribPointer(a.currentHigh,d.itemSize,o.FLOAT,!1,12,48),o.vertexAttribPointer(a.nextHigh,d.itemSize,o.FLOAT,!1,12,96),d=this._verticesLowBuffer,o.bindBuffer(o.ARRAY_BUFFER,d),o.vertexAttribPointer(a.prevLow,d.itemSize,o.FLOAT,!1,12,0),o.vertexAttribPointer(a.currentLow,d.itemSize,o.FLOAT,!1,12,48),o.vertexAttribPointer(a.nextLow,d.itemSize,o.FLOAT,!1,12,96),o.bindBuffer(o.ARRAY_BUFFER,this._ordersBuffer),o.vertexAttribPointer(a.order,this._ordersBuffer.itemSize,o.FLOAT,!1,4,0),o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,this._indexesBuffer),o.drawElements(o.TRIANGLE_STRIP,this._indexesBuffer.numItems,o.UNSIGNED_INT,0),o.enable(o.CULL_FACE)}}_refresh(){let t=this._changedBuffers.length;for(;t--;)this._changedBuffers[t]=!0}_update(){if(this._renderNode){let t=this._changedBuffers.length;for(;t--;)this._changedBuffers[t]&&(this._buffersUpdateCallbacks[t].call(this),this._changedBuffers[t]=!1)}}_deleteBuffers(){if(this._renderNode){let t=this._renderNode.renderer.handler.gl;t.deleteBuffer(this._verticesHighBuffer),t.deleteBuffer(this._verticesLowBuffer),t.deleteBuffer(this._ordersBuffer),t.deleteBuffer(this._indexesBuffer),t.deleteBuffer(this._colorsBuffer),t.deleteBuffer(this._texCoordBuffer),this._verticesHighBuffer=null,this._verticesLowBuffer=null,this._ordersBuffer=null,this._indexesBuffer=null,this._colorsBuffer=null,this._texCoordBuffer=null}}_createVerticesBuffer(){let t=this._renderNode.renderer.handler,s=this._verticesHigh.length/3;this._verticesHighBuffer&&this._verticesHighBuffer.numItems===s||(t.gl.deleteBuffer(this._verticesHighBuffer),t.gl.deleteBuffer(this._verticesLowBuffer),this._verticesHighBuffer=t.createStreamArrayBuffer(3,s),this._verticesLowBuffer=t.createStreamArrayBuffer(3,s)),this._verticesHigh=st(this._verticesHigh),this._verticesLow=st(this._verticesLow),t.setStreamArrayBuffer(this._verticesHighBuffer,this._verticesHigh),t.setStreamArrayBuffer(this._verticesLowBuffer,this._verticesLow)}_createIndexBuffer(){let t=this._renderNode.renderer.handler;t.gl.deleteBuffer(this._ordersBuffer),t.gl.deleteBuffer(this._indexesBuffer),this._orders=st(this._orders),this._ordersBuffer=t.createArrayBuffer(this._orders,1,this._orders.length/2),this._indexes=st(this._indexes,Uint32Array),this._indexesBuffer=t.createElementArrayBuffer(this._indexes,1,this._indexes.length)}_createColorsBuffer(){let t=this._renderNode.renderer.handler;t.gl.deleteBuffer(this._colorsBuffer),this._colors=st(this._colors),this._colorsBuffer=t.createArrayBuffer(this._colors,4,this._colors.length/4)}_createTexCoordBuffer(){let t=this._renderNode.renderer.handler;t.gl.deleteBuffer(this._texCoordBuffer),this._texCoordArr=st(this._texCoordArr),this._texCoordBuffer=t.createArrayBuffer(this._texCoordArr,4,this._texCoordArr.length/4)}setVisibleSphere(t,s){this._handler&&(this._visibleSphere[0]=t.x-this._handler._relativeCenter.x,this._visibleSphere[1]=t.y-this._handler._relativeCenter.y,this._visibleSphere[2]=t.z-this._handler._relativeCenter.z),this._visibleSphere[3]=s}updateRTCPosition(){this._handler&&this._renderNode&&(this._visibleSphere[0]=this._visibleSphere[0]-this._handler._relativeCenter.x,this._visibleSphere[1]=this._visibleSphere[1]-this._handler._relativeCenter.y,this._visibleSphere[2]=this._visibleSphere[2]-this._handler._relativeCenter.z,this._setEqualPath3v(this._path3v)),this._changedBuffers[0]=!0}};qe.__counter__=0;let br=qe;const ms=class dd{constructor(t={}){this.__id=dd.__counter__++,this._thickness=t.thickness||2,this._startPosition=Yt(t.startPosition),this._startPositionHigh=new v,this._startPositionLow=new v,v.doubleToTwoFloats(this._startPosition,this._startPositionHigh,this._startPositionLow),this._endPosition=Yt(t.endPosition),this._endPositionHigh=new v,this._endPositionLow=new v,v.doubleToTwoFloats(this._endPosition,this._endPositionHigh,this._endPositionLow),this._startColor=le(t.startColor),this._endColor=le(t.endColor),this._visibility=t.visibility==null||t.visibility,this._entity=null,this._handler=null,this._handlerIndex=-1,this._image=t.image||null,this._src=t.src||null,this._texOffset=t.texOffset||0,this._strokeSize=t.strokeSize!=null?t.strokeSize:32}setStartPosition(t,s,n){this._startPosition.x=t,this._startPosition.y=s,this._startPosition.z=n,v.doubleToTwoFloats(this._startPosition,this._startPositionHigh,this._startPositionLow),this._handler&&this._handler.setStartPositionArr(this._handlerIndex,this._startPositionHigh,this._startPositionLow)}getLength(){return this._startPosition.distance(this._endPosition)}setSrc(t){this._src=t;let s=this._handler;if(s){let n=s._entityCollection.renderNode;if(n&&n.renderer){let o=n.renderer.strokeTextureAtlas;t&&t.length?o.loadImage(t,a=>{if(a.__nodeIndex!=null&&o.get(a.__nodeIndex)){this._image=a;let l=o.get(a.__nodeIndex);s.setTexCoordArr(this._handlerIndex,l.texCoords)}else o.addImage(a),o.createTexture(),this._image=a,n.updateStrokeTexCoords()}):(s.setTextureDisabled(this._handlerIndex),n.updateStrokeTexCoords())}}}getSrc(){return this._src}setImage(t){this.setSrc(t.src)}getImage(){return this._image}setStartPosition3v(t){this._startPosition.x=t.x,this._startPosition.y=t.y,this._startPosition.z=t.z,v.doubleToTwoFloats(this._startPosition,this._startPositionHigh,this._startPositionLow),this._handler&&this._handler.setStartPositionArr(this._handlerIndex,this._startPositionHigh,this._startPositionLow)}setEndPosition(t,s,n){this._endPosition.x=t,this._endPosition.y=s,this._endPosition.z=n,v.doubleToTwoFloats(this._endPosition,this._endPositionHigh,this._endPositionLow),this._handler&&this._handler.setEndPositionArr(this._handlerIndex,this._endPositionHigh,this._endPositionLow)}setEndPosition3v(t){this._endPosition.x=t.x,this._endPosition.y=t.y,this._endPosition.z=t.z,v.doubleToTwoFloats(this._endPosition,this._endPositionHigh,this._endPositionLow),this._handler&&this._handler.setEndPositionArr(this._handlerIndex,this._endPositionHigh,this._endPositionLow)}setThickness(t){this._thickness=t,this._handler&&this._handler.setThicknessArr(this._handlerIndex,t)}setColors4v(t,s){t&&(this._startColor.x=t.x,this._startColor.y=t.y,this._startColor.z=t.z,this._startColor.w=t.w),s&&(this._endColor.x=s.x,this._endColor.y=s.y,this._endColor.z=s.z,this._endColor.w=s.w),this._handler&&this._handler.setRgbaArr(this._handlerIndex,this._startColor,this._endColor)}setColorsHTML(t,s){t&&(this._startColor=he(t)),s&&(this._endColor=he(s)),this._handler&&this._handler.setRgbaArr(this._handlerIndex,this._startColor,this._endColor)}get texOffset(){return this._texOffset}set texOffset(t){this._texOffset=t,this._handler&&this._handler.setTexOffsetArr(this._handlerIndex,t)}get strokeSize(){return this._strokeSize}set strokeSize(t){this._strokeSize=t,this._handler&&this._handler.setStrokeSizeArr(this._handlerIndex,t)}getStartPosition(){return this._startPosition}getEndPosition(){return this._endPosition}setVisibility(t){this._visibility=t,this._handler&&this._handler.setVisibility(this._handlerIndex,t)}getVisibility(){return this._visibility}remove(){this._entity=null,this._handler&&this._handler.remove(this)}setPickingColor3v(t){this._handler&&this._handler.setPickingColorArr(this._handlerIndex,t)}};ms.__counter__=0;let wr=ms,ft=new v,gt=new v;const vs=class ud{constructor(t={}){if(this.__id=ud.__counter__++,this.visibility=t.visibility==null||t.visibility,this.color=new Float32Array([1,1,1,.5]),t.color){let s=le(t.color);this.setColor(s.x,s.y,s.z,s.w)}t.opacity&&this.setOpacity(t.opacity),this._renderNode=null,this._entity=null,this._verticesHighBuffer=null,this._verticesLowBuffer=null,this._indexBuffer=null,this._verticesHigh=[],this._verticesLow=[],this._indexes=[],this._path=[],this._pickingColor=new Float32Array(4),this._gridSize=1,this._handler=null,this._handlerIndex=-1,t.path&&this.setPath(t.path)}setPickingColor3v(t){this._pickingColor[0]=t.x/255,this._pickingColor[1]=t.y/255,this._pickingColor[2]=t.z/255,this._pickingColor[3]=1}clear(){this._path.length=0,this._path=[],this._verticesHigh.length=0,this._verticesHigh=[],this._verticesLow.length=0,this._verticesLow=[],this._indexes.length=0,this._indexes=[],this._deleteBuffers()}setColor4v(t){this.setColor(t.x,t.y,t.z,t.w)}setColorHTML(t){this.setColor4v(he(t))}setColor(t,s,n,o){o=o||this.color[3],this.color[0]=t,this.color[1]=s,this.color[2]=n,this.color[3]=o}setOpacity(t){this.color[3]=t||0}setVisibility(t){this.visibility=t}getVisibility(){return this.visibility}setRenderNode(t){this._renderNode=t,this._createBuffers()}remove(){this._entity=null,this._handler&&this._handler.remove(this)}draw(){if(this.visibility&&this._verticesHigh.length){let t=this._renderNode.renderer,s=t.handler.gl,n=t.handler.programs.strip,o=n._program,a=o.attributes,l=o.uniforms;n.activate(),s.disable(s.CULL_FACE),s.uniformMatrix4fv(l.viewMatrix,!1,t.activeCamera.getViewMatrix()),s.uniformMatrix4fv(l.projectionMatrix,!1,t.activeCamera.getProjectionMatrix()),s.uniform3fv(l.eyePositionHigh,t.activeCamera.eyeHigh),s.uniform3fv(l.eyePositionLow,t.activeCamera.eyeLow),s.uniform4fv(l.uColor,this.color),s.uniform1f(l.uOpacity,this._entity._entityCollection._fadingOpacity),s.bindBuffer(s.ARRAY_BUFFER,this._verticesHighBuffer),s.vertexAttribPointer(a.aVertexPositionHigh,this._verticesHighBuffer.itemSize,s.FLOAT,!1,0,0),s.bindBuffer(s.ARRAY_BUFFER,this._verticesLowBuffer),s.vertexAttribPointer(a.aVertexPositionLow,this._verticesLowBuffer.itemSize,s.FLOAT,!1,0,0),s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,this._indexBuffer),s.drawElements(t.handler.gl.TRIANGLE_STRIP,this._indexBuffer.numItems,s.UNSIGNED_INT,0),s.enable(s.CULL_FACE)}}drawPicking(){if(this.visibility&&this._verticesHigh.length){let t=this._renderNode.renderer,s=t.handler.gl,n=t.handler.programs.strip,o=n._program,a=o.attributes,l=o.uniforms;n.activate(),s.disable(s.CULL_FACE),s.uniformMatrix4fv(l.viewMatrix,!1,t.activeCamera.getViewMatrix()),s.uniformMatrix4fv(l.projectionMatrix,!1,t.activeCamera.getProjectionMatrix()),s.uniform3fv(l.eyePositionHigh,t.activeCamera.eyeHigh),s.uniform3fv(l.eyePositionLow,t.activeCamera.eyeLow),s.uniform1f(l.uOpacity,this._entity._entityCollection._fadingOpacity!=0?1:0),s.uniform4fv(l.uColor,this._pickingColor),s.bindBuffer(s.ARRAY_BUFFER,this._verticesHighBuffer),s.vertexAttribPointer(a.aVertexPositionHigh,this._verticesHighBuffer.itemSize,s.FLOAT,!1,0,0),s.bindBuffer(s.ARRAY_BUFFER,this._verticesLowBuffer),s.vertexAttribPointer(a.aVertexPositionLow,this._verticesLowBuffer.itemSize,s.FLOAT,!1,0,0),s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,this._indexBuffer),s.drawElements(t.handler.gl.TRIANGLE_STRIP,this._indexBuffer.numItems,s.UNSIGNED_INT,0),s.enable(s.CULL_FACE)}}_deleteBuffers(){if(this._renderNode&&this._renderNode.renderer){let t=this._renderNode.renderer.handler.gl;t.deleteBuffer(this._indexBuffer),t.deleteBuffer(this._verticesHighBuffer),t.deleteBuffer(this._verticesLowBuffer)}this._verticesHighBuffer=null,this._verticesLowBuffer=null,this._indexBuffer=null}_createBuffers(){if(this._renderNode&&this._renderNode.renderer&&this._renderNode.renderer.isInitialized()){let t=this._renderNode.renderer.handler.gl;t.deleteBuffer(this._indexBuffer),t.deleteBuffer(this._verticesHighBuffer),t.deleteBuffer(this._verticesLowBuffer),this._verticesHighBuffer=this._renderNode.renderer.handler.createArrayBuffer(new Float32Array(this._verticesHigh),3,this._verticesHigh.length/3),this._verticesLowBuffer=this._renderNode.renderer.handler.createArrayBuffer(new Float32Array(this._verticesLow),3,this._verticesLow.length/3),this._indexBuffer=this._renderNode.renderer.handler.createElementArrayBuffer(new Uint32Array(this._indexes),1,this._indexes.length)}}addEdge3v(t,s){let n=this._path.length;if(n===0)this._path.push([t.clone(),s.clone()]);else{let o=this._path[n-1][0],a=this._path[n-1][1];this._path.push([t.clone(),s.clone()]);let l=this._verticesHigh,c=this._verticesLow,d=this._gridSize,u=d+1,_=new v,f=this._verticesHigh.length/3,g=f,m=Math.abs(o.sub(a).normal().dot(t.sub(o).normal()));for(let p=0;p<u;p++){let x=p/d,y=o.lerp(t,x),w=a.lerp(s,x);for(let C=0;C<u;C++){let T=C/d,P=o.lerp(a,T),E=t.lerp(s,T);m!==1?new Jt(y,w).intersects(new Jt(P,E),_):_=E,g=f+p*u+C,v.doubleToTwoFloats(_,ft,gt);let S=3*g;l[S]=ft.x,l[S+1]=ft.y,l[S+2]=ft.z,c[S]=gt.x,c[S+1]=gt.y,c[S+2]=gt.z,p<d&&this._indexes.push(g,g+u)}p<d&&this._indexes.push(g+u,g+1)}this._createBuffers()}}setEdge3v(t,s,n){if(n!==this._path.length)if(this._path[n]){if(this._path[n][0]=t,this._path[n][1]=s,this._path.length>1){let o=this._gridSize,a=o+1,l=a*a,c=new v,d=this._verticesHigh,u=this._verticesLow;if(n===this._path.length-1){let _=this._path[n-1][0],f=this._path[n-1][1],g=this._verticesHigh.length/3-l,m=g,p=Math.abs(_.sub(f).normal().dot(t.sub(_).normal()));for(let x=0;x<a;x++){let y=x/o,w=_.lerp(t,y),C=f.lerp(s,y);for(let T=0;T<a;T++){let P=T/o,E=_.lerp(f,P),S=t.lerp(s,P);p!==1?new Jt(w,C).intersects(new Jt(E,S),c):c=S,m=g+x*a+T,v.doubleToTwoFloats(c,ft,gt);let M=3*m;d[M]=ft.x,d[M+1]=ft.y,d[M+2]=ft.z,u[M]=gt.x,u[M+1]=gt.y,u[M+2]=gt.z}}}else if(n===0){let _=0,f=t,g=s;t=this._path[1][0],s=this._path[1][1];for(let m=0;m<a;m++){let p=m/o,x=f.lerp(t,p),y=g.lerp(s,p);for(let w=0;w<a;w++){let C=w/o,T=f.lerp(g,C),P=t.lerp(s,C);new Jt(x,y).intersects(new Jt(T,P),c),_=m*a+w,v.doubleToTwoFloats(c,ft,gt);let E=3*_;d[E]=ft.x,d[E+1]=ft.y,d[E+2]=ft.z,u[E]=gt.x,u[E+1]=gt.y,u[E+2]=gt.z}}}else if(n>0&&n<this._path.length){let _=this._path[n-1][0],f=this._path[n-1][1],g=this._path[n+1][0],m=this._path[n+1][1],p=n*l,x=(n-1)*l,y=x;for(let w=0;w<a;w++){let C=w/o,T=_.lerp(t,C),P=s.lerp(m,C),E=t.lerp(g,C),S=f.lerp(s,C);for(let M=0;M<a;M++){let R=M/o,k=_.lerp(f,R),B=t.lerp(s,R);new Jt(T,S).intersects(new Jt(k,B),c);let z=w*a+M;y=x+z,v.doubleToTwoFloats(c,ft,gt);let O=3*y;d[O]=ft.x,d[O+1]=ft.y,d[O+2]=ft.z,u[O]=gt.x,u[O+1]=gt.y,u[O+2]=gt.z;let ze=g.lerp(m,R);B=t.lerp(s,R),new Jt(E,P).intersects(new Jt(B,ze),c),y=p+z,v.doubleToTwoFloats(c,ft,gt),O=3*y,d[O]=ft.x,d[O+1]=ft.y,d[O+2]=ft.z,u[O]=gt.x,u[O+1]=gt.y,u[O+2]=gt.z}}}this._createBuffers()}}else console.warn(`strip index ${n} is out of range`);else this.addEdge3v(t,s)}removeEdge(t){this._path.splice(t,1),this.setPath([].concat(this._path))}setGridSize(t){this._gridSize=t,this.setPath([].concat(this._path))}getPath(){return this._path}setPath(t){this._verticesHigh=[],this._verticesLow=[],this._indexes=[],this._path=[];for(let s=0;s<t.length;s++){let n=t[s][0],o=t[s][1];n instanceof Array&&(n=new v(n[0],n[1],n[2])),o instanceof Array&&(o=new v(o[0],o[1],o[2])),this.addEdge3v(n,o)}}insertEdge3v(t,s,n){if(n<this._path.length){let o=[].concat(this._path);o.splice(n,0,[t,s]),this.setPath(o)}else n===this._path.length&&this.addEdge3v(t,s)}};vs.__counter__=0;let Tr=vs;const ys=class _d{constructor(t={}){t.properties=t.properties||{},this.__id=_d.__counter__++,this._name=t.name||`entity:${this.__id}`,this.properties=t.properties||{},this.childEntities=[],this.parent=null,this.forceGlobalPosition=t.forceGlobalPosition||!1,this.forceGlobalRotation=t.forceGlobalRotation||!1,this.forceGlobalScale=t.forceGlobalScale||!1,this._cartesian=Yt(t.cartesian),this._rootCartesian=new v,this._localPosition=Yt(t.localPosition),this._absoluteLocalPosition=new v,this._lonLat=vi(t.lonlat),this._lonLatMerc=new L,this._altitude=t.altitude||0,this._visibility=t.visibility==null||t.visibility,this._entityCollection=null,this._entityCollectionIndex=-1,this._layer=null,this._layerIndex=-1,this._pickingColor=new v(0,0,0),this._independentPicking=t.independentPicking||!1,this._relativePosition=t.relativePosition||!1,this._pitchRad=t.pitch||0,this._yawRad=t.yaw||0,this._rollRad=t.roll||0,this._scale=Yt(t.scale,new v(1,1,1)),this._absoluteScale=new v,this._qFrame=F.IDENTITY,this._qRot=F.IDENTITY,this._absoluteQRot=F.IDENTITY,this._useDirectQuaternion=!1,this._featureConstructorArray={billboard:[Qa,this.setBillboard],label:[el,this.setLabel],polyline:[br,this.setPolyline],pointCloud:[xr,this.setPointCloud],geometry:[vr,this.setGeometry],geoObject:[yr,this.setGeoObject],strip:[Tr,this.setStrip],ray:[wr,this.setRay]},this.billboard=this._createOptionFeature("billboard",t.billboard),this.label=this._createOptionFeature("label",t.label),this.polyline=this._createOptionFeature("polyline",t.polyline),this.ray=this._createOptionFeature("ray",t.ray),this.pointCloud=this._createOptionFeature("pointCloud",t.pointCloud),this.geometry=this._createOptionFeature("geometry",t.geometry),this.geoObject=this._createOptionFeature("geoObject",t.geoObject),this.strip=this._createOptionFeature("strip",t.strip)}get name(){return this._name}set name(t){t!==this._name&&(this._name=t)}get isEmpty(){return!(this.strip||this.polyline||this.ray||this.geoObject||this.geometry||this.billboard||this.label||this.pointCloud)}get rootEntity(){let t=this;for(;t;){if(!t.parent)return t;t=t.parent}return this}set relativePosition(t){if(t!==this._relativePosition){let s=this.getAbsoluteCartesian(),n=this.getAbsolutePitch(),o=this.getAbsoluteYaw(),a=this.getAbsoluteRoll();this._relativePosition=t,this.parent&&this._rootCartesian.copy(this.parent._rootCartesian),t?this.parent&&(this.setAbsoluteCartesian3v(s),this.setAbsolutePitch(n),this.setAbsoluteYaw(o),this.setAbsoluteRoll(a)):(this.setCartesian3v(s),this.setPitch(n),this.setYaw(o),this.setRoll(a))}}get relativePosition(){return this._relativePosition}get entityCollection(){return this._entityCollection}get id(){return this.__id}isEqual(t){return this.__id===t.__id}get layerIndex(){return this._layerIndex}get instanceName(){return"Entity"}_createOptionFeature(t,s){if(s){let n=this._featureConstructorArray[t];return n[1].call(this,new n[0](s))}return null}getCollectionIndex(){return this._entityCollectionIndex}addTo(t){return t.add(this),this}remove(){return this._layer&&this._layer.removeEntity(this),this._entityCollection&&this._entityCollection.removeEntity(this),this}setVisibility(t){this._visibility=t,this.billboard&&this.billboard.setVisibility(t),this.geoObject&&this.geoObject.setVisibility(t),this.label&&this.label.setVisibility(t),this.polyline&&this.polyline.setVisibility(t),this.ray&&this.ray.setVisibility(t),this.geometry&&this.geometry.setVisibility(t);for(let s=0;s<this.childEntities.length;s++)this.childEntities[s].setVisibility(t)}getVisibility(){return this._visibility}setCartesian3v(t){this.setCartesian(t.x,t.y,t.z)}getScale(){return this._scale}setScale3v(t){this._scale.copy(t),this._updateAbsolutePosition();for(let s=0;s<this.childEntities.length;s++){let n=this.childEntities[s];n.forceGlobalScale?n.setScale3v(this._scale):n.setScale3v(this.childEntities[s].getScale())}}setScale(t){this.setScale3v(new v(t,t,t))}getAbsoluteRotation(){return this._absoluteQRot.clone()}getRotation(){return this._qRot}setLook3v(t){let s,n=new F,o=this.getAbsoluteCartesian();if(this._entityCollection){let a=this._entityCollection.renderNode.ellipsoid.getSurfaceNormal3v(o);s=n.setLookRotation(t.sub(o),a).conjugate()}else s=n.setLookRotation(t.sub(o),v.UP).conjugate();this.setAbsoluteRotation(s)}setLookLonLat(t){if(this._entityCollection){let s=this._entityCollection.renderNode.ellipsoid.lonLatToCartesian(t);this.setLook3v(s)}}setAbsoluteRotation(t){this._absoluteQRot.copy(t),this._updatePitchYawRoll()}setRotation(t){this._useDirectQuaternion=!1,this._pitchRad=t.getPitch(),this._yawRad=t.getYaw(),this._rollRad=t.getRoll(),this._updateAbsolutePosition()}setDirectQuaternionRotation(t){this._qRot.copy(t),this._useDirectQuaternion=!0,this._pitchRad=this._qRot.getPitch(),this._yawRad=this._qRot.getYaw(),this._rollRad=this._qRot.getRoll(),this._updateAbsolutePosition()}setPitch(t){this._useDirectQuaternion=!1,this._pitchRad=t,this._updateAbsolutePosition()}setYaw(t){this._useDirectQuaternion=!1,this._yawRad=t,this._updateAbsolutePosition()}setRoll(t){this._useDirectQuaternion=!1,this._rollRad=t,this._updateAbsolutePosition()}getPitch(){return this._pitchRad}getYaw(){return this._yawRad}getRoll(){return this._rollRad}setAbsolutePitch(t){this._relativePosition?(this._absoluteQRot.setPitchYawRoll(t,this.getAbsoluteYaw(),this.getAbsoluteRoll(),this._qFrame),this._updatePitchYawRoll()):this.setPitch(t)}setAbsoluteYaw(t){this._relativePosition?(this._absoluteQRot.setPitchYawRoll(this.getAbsolutePitch(),t,this.getAbsoluteRoll(),this._qFrame),this._updatePitchYawRoll()):this.setYaw(t)}setAbsoluteRoll(t){this._relativePosition?(this._absoluteQRot.setPitchYawRoll(this.getAbsolutePitch(),this.getAbsoluteYaw(),t,this._qFrame),this._updatePitchYawRoll()):this.setRoll(t)}getAbsolutePitch(){return this.parent&&this._relativePosition?this._qFrame.conjugate().inverse().mul(this._absoluteQRot).getPitch():this._pitchRad}getAbsoluteYaw(){return this.parent&&this._relativePosition?this._qFrame.conjugate().inverse().mul(this._absoluteQRot).getYaw():this._yawRad}getAbsoluteRoll(){return this.parent&&this._relativePosition?this._qFrame.conjugate().inverse().mul(this._absoluteQRot).getRoll():this._rollRad}_getScaleByDistance(){let t=1;if(this._entityCollection){let s=this._entityCollection.scaleByDistance,n=1;this._entityCollection.renderNode&&this._entityCollection.renderNode.renderer&&(n=this._entityCollection.renderNode.renderer.activeCamera.eye.distance(this._rootCartesian)),t=s[2]*Zi(n,s[0],s[1])/s[0]}return t}setAbsoluteCartesian(t,s,n){this.setAbsoluteCartesian3v(new v(t,s,n))}setAbsoluteCartesian3v(t){let s=t;if(this.parent&&this._relativePosition){let n=this._getScaleByDistance();s=t.sub(this.parent.getAbsoluteCartesian()).scale(1/n).divA(this.parent._absoluteScale),s=this.parent._absoluteQRot.conjugate().mulVec3(s)}this.setCartesian3v(s)}getAbsoluteCartesian(){if(this.parent&&this._relativePosition){let t=this._getScaleByDistance();return this._rootCartesian.add(this._absoluteLocalPosition.scaleTo(t))}return this._cartesian.clone()}setCartesian(t,s,n){this._cartesian.set(t,s,n),this._updateAbsolutePosition();for(let o=0;o<this.childEntities.length;o++){let a=this.childEntities[o];a._relativePosition?a.setCartesian3v(a.getCartesian()):a.forceGlobalPosition&&a.setCartesian(t,s,n)}this._updateLonLat()}_updatePitchYawRoll(){if(this.parent){this._qRot=this.parent._absoluteQRot.conjugate().mul(this._absoluteQRot),this._pitchRad=this._qRot.getPitch(),this._yawRad=this._qRot.getYaw(),this._rollRad=this._qRot.getRoll(),this.geoObject&&this.geoObject.setRotation(this._absoluteQRot);for(let t=0;t<this.childEntities.length;t++)this.childEntities[t]._updateAbsolutePosition()}}_updateAbsolutePosition(){let t=this.parent;if(t&&this._relativePosition){this._scale.mulRes(t._absoluteScale,this._absoluteScale),this._qFrame.copy(t._qFrame),this._rootCartesian.copy(t._rootCartesian),this._useDirectQuaternion||(t&&this.forceGlobalRotation?this._qRot.setPitchYawRoll(t._pitchRad,t._yawRad,t._rollRad):this._qRot.setPitchYawRoll(this._pitchRad,this._yawRad,this._rollRad)),t._absoluteQRot.mulRes(this._qRot,this._absoluteQRot);let s=t._absoluteQRot.mulVec3(this._cartesian.add(this._localPosition)).mulA(t._absoluteScale);t._absoluteLocalPosition.addRes(s,this._absoluteLocalPosition)}else this._qFrame=F.IDENTITY,this._entityCollection&&this._entityCollection.renderNode&&(this._qFrame=this._entityCollection.renderNode.getFrameRotation(this._cartesian)),this._useDirectQuaternion?this._qFrame.isEqual(F.IDENTITY)||(this._qRot=this._qRot.mul(this._qFrame)):t&&this.forceGlobalRotation?this._qRot.setPitchYawRoll(t._pitchRad,t._yawRad,t._rollRad,this._qFrame):this._qRot.setPitchYawRoll(this._pitchRad,this._yawRad,this._rollRad,this._qFrame),this._absoluteScale.copy(this._scale),this._absoluteQRot.copy(this._qRot),this._rootCartesian.copy(this._cartesian),this._absoluteLocalPosition.copy(this._localPosition);this.geoObject&&(this.geoObject.setScale3v(this._absoluteScale),this.geoObject.setRotation(this._absoluteQRot),this.geoObject.setPosition3v(this._rootCartesian),this.geoObject.setLocalPosition3v(this._absoluteLocalPosition)),this.billboard&&this.billboard.setPosition3v(this._rootCartesian),this.label&&this.label.setPosition3v(this._rootCartesian);for(let s=0,n=this.childEntities.length;s<n;s++)this.childEntities[s]._updateAbsolutePosition();this._updateLonLat()}_setCartesian3vSilent(t,s=!1){this._cartesian.copy(t),this._updateAbsolutePosition();for(let n=0;n<this.childEntities.length;n++)this.childEntities[n].setCartesian(this._cartesian.x,this._cartesian.y,this._cartesian.z);s||this._updateLonLat()}_updateLonLat(){let t=this._entityCollection;t&&t.renderNode&&t.renderNode.ellipsoid&&(this._lonLat=t.renderNode.ellipsoid.cartesianToLonLat(this.getAbsoluteCartesian()),Math.abs(this._lonLat.lat)<ct?this._lonLatMerc=this._lonLat.forwardMercator():this._lonLatMerc.lon=this._lonLatMerc.lat=0)}getLonLat(){return this._lonLat.clone()}setLonLat(t){let s=this._lonLat;s.lon=t.lon,s.lat=t.lat,s.height=t.height;let n=this._entityCollection;if(n&&n.renderNode&&n.renderNode.ellipsoid){Math.abs(s.lat)<ct&&(this._lonLatMerc=s.forwardMercator());let o=new v;n.renderNode.ellipsoid.lonLatToCartesianRes(s,o),this.setAbsoluteCartesian3v(o)}}setLonLat2(t,s,n){let o=this._lonLat;o.lon=t,o.lat=s,o.height=n??o.height;let a=this._entityCollection;if(a&&a.renderNode&&a.renderNode.ellipsoid){Math.abs(o.lat)<ct?this._lonLatMerc=o.forwardMercator():this._lonLatMerc.lon=this._lonLatMerc.lat=this._lonLatMerc.height=0;let l=new v;a.renderNode.ellipsoid.lonLatToCartesianRes(o,l),this.setAbsoluteCartesian3v(l)}}setAltitude(t){this._altitude=t}getAltitude(){return this._altitude}getCartesian(){return this._cartesian.clone()}setBillboard(t){return this.billboard&&this.billboard.remove(),this.billboard=t,this.billboard._entity=this,this.billboard.setPosition3v(this._cartesian),this.billboard.setVisibility(this._visibility),this._entityCollection&&this._entityCollection.billboardHandler.add(t),t}setLabel(t){return this.label&&this.label.remove(),this.label=t,this.label._entity=this,this.label.setPosition3v(this._cartesian),this.label.setVisibility(this._visibility),this._entityCollection&&this._entityCollection.labelHandler.add(t),t}setRay(t){return this.ray&&this.ray.remove(),this.ray=t,this.ray._entity=this,this.ray.setVisibility(this._visibility),this._entityCollection&&this._entityCollection.rayHandler.add(t),t}setPolyline(t){return this.polyline&&this.polyline.remove(),this.polyline=t,this.polyline._entity=this,this.polyline.setVisibility(this._visibility),this._entityCollection&&this._entityCollection.polylineHandler.add(t),t}setPointCloud(t){return this.pointCloud&&this.pointCloud.remove(),this.pointCloud=t,this.pointCloud._entity=this,this.pointCloud.setVisibility(this._visibility),this._entityCollection&&this._entityCollection.pointCloudHandler.add(t),t}setGeometry(t){this.geometry&&this.geometry.remove(),this.geometry=t,this.geometry._entity=this,this.geometry.setVisibility(this._visibility);let s=this._layer;return this._layer&&this._layer.removeEntity(this),s&&s.add(this),t}setGeoObject(t){return this.geoObject&&this.geoObject.remove(),this.geoObject=t,this.geoObject._entity=this,this.geoObject.setPosition3v(this._cartesian),this.geoObject.setVisibility(this._visibility),this._entityCollection&&this._entityCollection.geoObjectHandler.add(t),t}setStrip(t){return this.strip&&this.strip.remove(),this.strip=t,this.strip._entity=this,this.strip.setVisibility(this._visibility),this._entityCollection&&this._entityCollection.stripHandler.add(t),t}get layer(){return this._layer}get rendererEvents(){return this._layer?this._layer.events:this._entityCollection?this._entityCollection.events:null}appendChildren(t,s){for(let n=0;n<t.length;n++)s!==void 0&&(t[n].relativePosition=s),this.appendChild(t[n])}appendChild(t){t._entityCollection=this._entityCollection,t._independentPicking||(t._pickingColor=this._pickingColor),t.parent=this,this.childEntities.push(t),this._entityCollection&&this._entityCollection.appendChildEntity(t)}setPickingColor(){let t=this._pickingColor;this.billboard&&this.billboard.setPickingColor3v(t),this.label&&this.label.setPickingColor3v(t),this.polyline&&this.polyline.setPickingColor3v(t),this.ray&&this.ray.setPickingColor3v(t),this.strip&&this.strip.setPickingColor3v(t),this.geoObject&&this.geoObject.setPickingColor3v(t);for(let s=0;s<this.childEntities.length;s++)this.childEntities[s].setPickingColor()}getExtent(){let t,s=this._lonLat;t=this.billboard||this.label?new U(new L(s.lon,s.lat),new L(s.lon,s.lat)):new U(new L(180,90),new L(-180,-90));let n=t.southWest,o=t.northEast;if(this.polyline){let a=this.polyline.getExtent();a.southWest.lon<n.lon&&(n.lon=a.southWest.lon),a.southWest.lat<n.lat&&(n.lat=a.southWest.lat),a.northEast.lon>o.lon&&(o.lon=a.northEast.lon),a.northEast.lat>o.lat&&(o.lat=a.northEast.lat)}if(this.geometry){let a=this.geometry.getExtent();a.southWest.lon<n.lon&&(n.lon=a.southWest.lon),a.southWest.lat<n.lat&&(n.lat=a.southWest.lat),a.northEast.lon>o.lon&&(o.lon=a.northEast.lon),a.northEast.lat>o.lat&&(o.lat=a.northEast.lat)}for(let a=0;a<this.childEntities.length;a++){let l=this.childEntities[a].getExtent();l.southWest.lon<n.lon&&(n.lon=l.southWest.lon),l.southWest.lat<n.lat&&(n.lat=l.southWest.lat),l.northEast.lon>o.lon&&(o.lon=l.northEast.lon),l.northEast.lat>o.lat&&(o.lat=l.northEast.lat)}return t}};ys.__counter__=0;let G=ys;const xs=class fd{constructor(t){this.__id=fd.__counter__++,this._name=t||`nonameNode:${this.__id}`,this.topNode=this,this._dictionary={},this._dictionary[this._name]=this,this.childNodes=[],this.parentNode=null}get name(){return this._name}addNode(t){this.parentNode==null?t.topNode=this:t.topNode=this.topNode,t.parentNode=this,t._dictionary=this.topNode._dictionary,this.childNodes.push(t),this.topNode._dictionary[t.name]=t}destroy(){for(let t=0;t<this.childNodes.length;t++)this.childNodes[t].destroy();this._clear()}getNodeByName(t){return this._dictionary[t]}_clear(){this.parentNode=null,this.topNode=this,this.childNodes.length=0}isEqual(t){return t.__id===this.__id}};xs.__counter__=0;let Cr=xs;class de extends Cr{constructor(t){super(t),this.childNodes=[],this.renderer=null,this.drawMode=0,this.show=!0,this._isActive=!0,this.lightEnabled=!1,this._lightPosition=new Float32Array([100,100,100]),this._lightParams=new Float32Array(9),this._lightShininess=100,this.entityCollections=[],this._entityCollectionsByDepthOrder=[],this._pickingId=-1}getFrameRotation(t){return F.IDENTITY}addNode(t){super.addNode(t),this.renderer&&t.assign(this.renderer)}assign(t){this.renderer=t,this._pickingId=t.addPickingCallback(this,this._entityCollectionPickingCallback),this.initialize()}initialize(){if(this.renderer&&this.renderer.isInitialized()){for(let t=0;t<this.entityCollections.length;t++)this.entityCollections[t].bindRenderNode(this);this.init()}}init(){}onremove(){}remove(){let t=this.renderer,s=this.name;if(t){t.renderNodes[s]&&t.renderNodes[s].isEqual(this)&&(t.renderNodes[s]=null,delete t.renderNodes[s]);for(let n=0;n<t._renderNodesArr.length;n++)if(t._renderNodesArr[n].isEqual(this)){t._renderNodesArr.splice(n,1);break}t.removePickingCallback(this._pickingId),this._pickingId=-1,this.onremove&&this.onremove()}}addEntityCollection(t,s){t.renderNode||(t.renderNode=this,s||(this.entityCollections.push(t),this.updateEntityCollectionsDepthOrder()),this.ellipsoid&&t._updateGeodeticCoordinates(this.ellipsoid),t.bindRenderNode(this),t.events.dispatch(t.events.add,this))}removeEntityCollection(t){for(let s=0;s<this.entityCollections.length;s++)if(this.entityCollections[s].isEqual(t))return this.entityCollections.splice(s,1),void this.updateEntityCollectionsDepthOrder()}updateEntityCollectionsDepthOrder(){let t={0:[]};for(const s of this.entityCollections)s.getVisibility()&&(t[s.depthOrder]||(t[s.depthOrder]=[]),t[s.depthOrder].push(s));this._entityCollectionsByDepthOrder.length=0,this._entityCollectionsByDepthOrder=[],this._entityCollectionsByDepthOrder=Object.keys(t).sort((s,n)=>Number(s)-Number(n)).map(s=>t[Number(s)])}addLight(t){return t.addTo(this),this}preDrawNode(){this._isActive&&this._preDrawNodes()}drawNode(){this._isActive&&this._drawNodes()}isActive(){return this._isActive}setActive(t){this._isActive=t,this.renderer&&(this._isActive&&this._pickingId===-1?this._pickingId=this.renderer.addPickingCallback(this,this._entityCollectionPickingCallback):this._isActive||this._pickingId===-1||(this.renderer.removePickingCallback(this._pickingId),this._pickingId=-1));for(let s=0;s<this.childNodes.length;s++)this.childNodes[s].setActive(t)}setDrawMode(t){this.drawMode=t;for(let s=0;s<this.childNodes.length;s++)this.childNodes[s].setDrawMode(t)}updateBillboardsTexCoords(){for(let t=0;t<this.entityCollections.length;t++)this.entityCollections[t].billboardHandler.refreshTexCoordsArr()}updateStrokeTexCoords(){for(let t=0;t<this.entityCollections.length;t++){let s=this.entityCollections[t];s.rayHandler.refreshTexCoordsArr(),s.polylineHandler.refreshTexCoordsArr()}}frame(){}preFrame(){}_preDrawNodes(){for(let t=0;t<this.childNodes.length;t++)this.childNodes[t]._isActive&&this.childNodes[t]._preDrawNodes();if(this.show){this.preFrame();for(let t=0;t<this._entityCollectionsByDepthOrder.length;t++)this.drawEntityCollections(this._entityCollectionsByDepthOrder[t],t)}}_drawNodes(){for(let t=0;t<this.childNodes.length;t++)this.childNodes[t]._isActive&&this.childNodes[t]._drawNodes();this.show&&this.frame()}drawEntityCollections(t,s=0){this.renderer.enqueueEntityCollectionsToDraw(t,s)}drawPickingEntityCollections(t){if(t.length){let s=t.length;for(;s--;)t[s]._fadingOpacity&&t[s].billboardHandler.drawPicking();for(s=t.length;s--;)t[s]._fadingOpacity&&t[s].geoObjectHandler.drawPicking();for(s=t.length;s--;)t[s]._fadingOpacity&&t[s].labelHandler.drawPicking();for(s=t.length;s--;)t[s]._fadingOpacity&&t[s].rayHandler.drawPicking();for(s=t.length;s--;)t[s]._visibility&&t[s].polylineHandler.drawPicking();for(s=t.length;s--;)t[s]._visibility&&t[s].stripHandler.drawPicking()}}_entityCollectionPickingCallback(){}}const ie=new class{constructor(){this._container=document.createElement("div"),this._container.classList.add("ogConsole"),this._container.style.display="none",document.body&&document.body.appendChild(this._container),this._visibility=!1}getVisibility(){return this._visibility}setVisibility(h){this._visibility!=h&&(this._visibility=h,this._visibility?this.show():this.hide())}show(){this._container.parentNode||document.body&&document.body.appendChild(this._container),this._container.style.display="block",this._visibility=!0}hide(){this._container.style.display="none",this._visibility=!1}logErr(h){let t=document.createElement("div");t.classList.add("ogConsole-text"),t.classList.add("ogConsole-error"),t.innerHTML="error: "+h,console.trace(t.innerHTML),this._container.appendChild(t),this.show()}logWrn(h){let t=document.createElement("div");t.classList.add("ogConsole-text"),t.classList.add("ogConsole-warning"),t.innerHTML="warning: "+h,console.trace(t.innerHTML),this._container.appendChild(t),this.show()}log(h){let t=document.createElement("div");t.classList.add("ogConsole-text"),t.innerHTML=h,console.trace(h),this._container.appendChild(t),this.show()}};let fi=["FLOAT","DOUBLE","BOOL","INT","UINT","VEC2","VEC3","VEC4","DVEC2","DVEC3","DVEC4","BVEC2","BVEC3","BVEC4","IVEC2","IVEC3","IVEC4","UVEC2","UVEC3","UVEC4","MAT2","DMAT2","MAT3","DMAT3","MAT4","DMAT4","MAT2X3","MAT2X4","MAT3X2","MAT3X4","MAT4X2","MAT4X3","DMAT2X3","DMAT2X4","DMAT3X2","DMAT3X4","DMAT4X2","DMAT4X3","SAMPLER1D","SAMPLER2D","SAMPLER3D","SAMPLERCUBE","SAMPLER2DSHADOW","SAMPLER2DARRAY","INTXX","FLOATXX"];const ht={};for(let h=0;h<fi.length;h++)ht[fi[h]]=h;const Er={};for(let h=0;h<fi.length;h++)Er[fi[h].toLowerCase()]=ht[fi[h]];const Pt={u:[],a:[]};Pt.u[ht.MAT4]=function(h,t){h.gl.uniformMatrix4fv(t._pName,!1,t.value)},Pt.u[ht.MAT3]=function(h,t){h.gl.uniformMatrix3fv(t._pName,!1,t.value)},Pt.u[ht.FLOAT]=function(h,t){h.gl.uniform1f(t._pName,t.value)},Pt.u[ht.INT]=function(h,t){h.gl.uniform1i(t._pName,t.value)},Pt.u[ht.VEC2]=function(h,t){h.gl.uniform2fv(t._pName,t.value)},Pt.u[ht.VEC3]=function(h,t){h.gl.uniform3fv(t._pName,t.value)},Pt.u[ht.VEC4]=function(h,t){h.gl.uniform4fv(t._pName,t.value)},Pt.u[ht.SAMPLER2D]=function(h,t){let s=h.gl;s.activeTexture(s.TEXTURE0+h._textureID),s.bindTexture(s.TEXTURE_2D,t.value),s.uniform1i(t._pName,h._textureID),h._textureID++},Pt.u[ht.SAMPLERCUBE]=function(h,t){let s=h.gl;s.activeTexture(s.TEXTURE0+h._textureID),s.bindTexture(s.TEXTURE_CUBE_MAP,t.value),s.uniform1i(t._pName,h._textureID),h._textureID++},Pt.u[ht.SAMPLER2DARRAY]=function(h,t){let s=t.value,n=h.gl,o=s.length,a=new Int32Array(o);for(let l=0;l<o;l++)n.activeTexture(n.TEXTURE0+h._textureID+l),n.bindTexture(n.TEXTURE_2D,s[l]),a[l]=l;n.uniform1iv(t._pName,a)},Pt.u[ht.INTXX]=function(h,t){h.gl.uniform1iv(t._pName,t.value)},Pt.u[ht.FLOATXX]=function(h,t){h.gl.uniform1fv(t._pName,t.value)},Pt.a[ht.FLOAT]=function(h,t){h.gl.vertexAttrib1f(t._pName,t.value)},Pt.a[ht.VEC2]=function(h,t){h.gl.vertexAttrib2fv(t._pName,t.value)},Pt.a[ht.VEC3]=function(h,t){h.gl.vertexAttrib3fv(t._pName,t.value)};const il=["BYTE","SHORT","UNSIGNED_BYTE","UNSIGNED_SHORT","FLOAT","HALF_FLOAT"];class X{constructor(t,s){this.name=t,this._programController=null,this._attributes={};for(let n in s.attributes)typeof s.attributes[n]=="string"||typeof s.attributes[n]=="number"?this._attributes[n]={type:s.attributes[n]}:this._attributes[n]=s.attributes[n];this._uniforms={};for(let n in s.uniforms)typeof s.uniforms[n]=="string"||typeof s.uniforms[n]=="number"?this._uniforms[n]={type:s.uniforms[n]}:this._uniforms[n]=s.uniforms[n];this.vertexShader=s.vertexShader,this.fragmentShader=s.fragmentShader,this.gl=null,this._variables={},this._p=null,this._textureID=0,this._attribArrays=[],this._attribDivisor=[],this.attributes={},this.uniforms={},this.vertexAttribDivisor=null,this.drawElementsInstanced=null}static bindBuffer(t,s){let n=t.gl;n&&(n.bindBuffer(n.ARRAY_BUFFER,s.value),n.vertexAttribPointer(s._pName,s.value.itemSize,s.itemType,s.normalized,0,0))}use(){this.gl&&this.gl.useProgram(this._p)}set(t){this._textureID=0;for(let s in t)this._variables[s].value=t[s],this._variables[s].func(this,this._variables[s])}apply(){this._textureID=0;let t=this._variables;for(let s in t)t[s].func(this,t[s])}drawIndexBuffer(t,s){let n=this.gl;n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,s),n.drawElements(t,s.numItems,n.UNSIGNED_SHORT,0)}drawArrays(t,s){this.gl.drawArrays(t,0,s)}_getShaderCompileStatus(t,s){if(!this.gl)return!1;const n=this.gl instanceof WebGL2RenderingContext;return this.gl.shaderSource(t,function(o,a){if(!a)return o;const l=o.split(`
`),c=l.findIndex(d=>d.startsWith("#version"));return c!==-1?(l.splice(c+1,0,"#define WEBGL2"),l.join(`
`)):o}(s,n)),this.gl.compileShader(t),!!this.gl.getShaderParameter(t,this.gl.COMPILE_STATUS)||(ie.logErr(`Shader program "${this.name}":${this.gl.getShaderInfoLog(t)}.`),!1)}_createVertexShader(t){if(!this.gl)return;let s=this.gl.createShader(this.gl.VERTEX_SHADER);return s&&this._getShaderCompileStatus(s,t)?s:void 0}_createFragmentShader(t){if(!this.gl)return;let s=this.gl.createShader(this.gl.FRAGMENT_SHADER);return s&&this._getShaderCompileStatus(s,t)?s:void 0}disableAttribArrays(){let t=this.gl,s=this._attribArrays;for(let n=0,o=s.length;n<o;n++)t.disableVertexAttribArray(s[n]),this.vertexAttribDivisor(s[n],0)}enableAttribArrays(){let t=this.gl,s=this._attribArrays,n=this._attribDivisor;for(let o=0,a=s.length;o<a;o++)t.enableVertexAttribArray(s[o]),this.vertexAttribDivisor(s[o],n[o])}delete(){this.gl&&this.gl.deleteProgram(this._p)}createProgram(t){if(this.gl=t,this._p=this.gl.createProgram(),!this._p)return;let s=this._createFragmentShader(this.fragmentShader),n=this._createVertexShader(this.vertexShader);if(s&&n){if(t.attachShader(this._p,s),t.attachShader(this._p,n),t.linkProgram(this._p),!this.drawElementsInstanced)if(t.drawElementsInstanced)this.drawElementsInstanced=t.drawElementsInstanced.bind(t);else{let o=t.getExtension("ANGLE_instanced_arrays");o&&(this.drawElementsInstanced=o.drawElementsInstancedANGLE.bind(o))}if(!this.vertexAttribDivisor)if(t.vertexAttribDivisor)this.vertexAttribDivisor=t.vertexAttribDivisor.bind(t);else{let o=t.getExtension("ANGLE_instanced_arrays");o&&(this.vertexAttribDivisor=o.vertexAttribDivisorANGLE.bind(o))}if(!t.getProgramParameter(this._p,t.LINK_STATUS))return ie.logErr(`Shader program "${this.name}": initialization failed. ${t.getProgramInfoLog(this._p)}.`),void t.deleteProgram(this._p);this.use();for(let o in this._attributes){this._variables[o]=this._attributes[o],this._attributes[o].func=X.bindBuffer;let a=this._attributes[o].itemType,l=a?a.trim().toUpperCase():"FLOAT";if(il.indexOf(l)==-1?(ie.logErr(`Shader program "${this.name}": attribute '${o}', item type '${this._attributes[o].itemType}' not exists.`),this._attributes[o].itemType=t.FLOAT):this._attributes[o].itemType=t[l],this._attributes[o].normalized=this._attributes[o].normalized||!1,this._attributes[o].divisor=this._attributes[o].divisor||0,this._p[o]=t.getAttribLocation(this._p,o),this._p[o]==null)return ie.logErr(`Shader program "${this.name}":  attribute '${o}' not exists.`),void t.deleteProgram(this._p);let c=this._attributes[o].type;typeof c=="string"&&(c=Er[c.trim().toLowerCase()]);let d=this._attributes[o].divisor;if(c===ht.MAT4){let u=this._p[o];this._attribArrays.push(u,u+1,u+2,u+3),this._attribDivisor.push(d,d,d,d)}else this._attribArrays.push(this._p[o]),this._attribDivisor.push(d);t.enableVertexAttribArray(this._p[o]),this._attributes[o]._pName=this._p[o],this.attributes[o]=this._p[o]}for(let o in this._uniforms){if(typeof this._uniforms[o].type=="string"){let a=this._uniforms[o].type;this._uniforms[o].func=Pt.u[Er[a.trim().toLowerCase()]]}else this._uniforms[o].func=Pt.u[this._uniforms[o].type];if(this._variables[o]=this._uniforms[o],this._p[o]=t.getUniformLocation(this._p,o),this._p[o]==null)return ie.logErr(`Shader program "${this.name}": uniform '${o}' not exists.`),void t.deleteProgram(this._p);this._uniforms[o]._pName=this._p[o],this.uniforms[o]=this._p[o]}t.detachShader(this._p,s),t.detachShader(this._p,n),t.deleteShader(s),t.deleteShader(n)}}}const bs=class gd{constructor(t){this.__id=gd.__counter__++,this.pickingEnabled=!0,this._entityCollection=t,this._renderer=null,this._billboards=[],this._positionHighBuffer=null,this._positionLowBuffer=null,this._sizeBuffer=null,this._offsetBuffer=null,this._rgbaBuffer=null,this._rotationBuffer=null,this._texCoordBuffer=null,this._vertexBuffer=null,this._pickingColorBuffer=null,this._texCoordArr=new Float32Array([]),this._vertexArr=new Float32Array([]),this._positionHighArr=new Float32Array([]),this._positionLowArr=new Float32Array([]),this._sizeArr=new Float32Array([]),this._offsetArr=new Float32Array([]),this._rgbaArr=new Float32Array([]),this._rotationArr=new Float32Array([]),this._pickingColorArr=new Float32Array([]),this._buffersUpdateCallbacks=[],this._buffersUpdateCallbacks[0]=this.createPickingColorBuffer,this._buffersUpdateCallbacks[1]=this.createPositionBuffer,this._buffersUpdateCallbacks[2]=this.createSizeBuffer,this._buffersUpdateCallbacks[3]=this.createOffsetBuffer,this._buffersUpdateCallbacks[4]=this.createRgbaBuffer,this._buffersUpdateCallbacks[5]=this.createRotationBuffer,this._buffersUpdateCallbacks[6]=this.createTexCoordBuffer,this._buffersUpdateCallbacks[7]=this.createVertexBuffer,this._changedBuffers=new Array(this._buffersUpdateCallbacks.length)}isEqual(t){return t&&t.__id===this.__id}static concArr(t,s){for(let n=0;n<s.length;n++)t.push(s[n])}initProgram(){this._renderer&&this._renderer.handler&&(this._renderer.handler.programs.billboard||this._renderer.handler.addProgram(new X("billboard",{uniforms:{viewport:"vec2",u_texture:"sampler2d",projectionMatrix:"mat4",viewMatrix:"mat4",eyePositionHigh:"vec3",eyePositionLow:"vec3",planetRadius:"float",uScaleByDistance:"vec3",opacity:"float",depthOffset:"float"},attributes:{a_vertices:"vec2",a_texCoord:"vec2",a_positionsHigh:"vec3",a_positionsLow:"vec3",a_offset:"vec3",a_size:"vec2",a_rotation:"float",a_rgba:"vec4"},vertexShader:`precision highp float;
#define EMPTY - 1.0
#define RTL 1.0
vec2 project(vec4 p,vec2 viewport){return(0.5*p.xyz/p.w+0.5).xy*viewport;}mat2 rotate2d(float angle){return mat2(cos(angle),-sin(angle),sin(angle),cos(angle));}attribute vec2 a_vertices;attribute vec2 a_texCoord;attribute vec3 a_positionsHigh;attribute vec3 a_positionsLow;attribute vec3 a_offset;attribute vec2 a_size;attribute float a_rotation;attribute vec4 a_rgba;varying vec2 v_texCoords;varying vec4 v_rgba;uniform mat4 viewMatrix;uniform mat4 projectionMatrix;uniform vec3 eyePositionHigh;uniform vec3 eyePositionLow;uniform vec3 uScaleByDistance;uniform float opacity;uniform float planetRadius;uniform vec2 viewport;uniform float depthOffset;const vec3 ZERO3=vec3(0.0);void main(){vec3 a_positions=a_positionsHigh+a_positionsLow;vec3 cameraPos=eyePositionHigh+eyePositionLow;v_texCoords=a_texCoord;vec3 look=a_positions-cameraPos;float lookDist=length(look);v_rgba=a_rgba;if(opacity*step(lookDist,sqrt(dot(cameraPos,cameraPos)-planetRadius)+sqrt(dot(a_positions,a_positions)-planetRadius))==0.0){return;}float scd=(1.0-smoothstep(uScaleByDistance[0],uScaleByDistance[1],lookDist))*(1.0-step(uScaleByDistance[2],lookDist));mat4 viewMatrixRTE=viewMatrix;viewMatrixRTE[3]=vec4(0.0,0.0,0.0,1.0);vec3 highDiff=a_positionsHigh-eyePositionHigh;vec3 lowDiff=a_positionsLow-eyePositionLow;vec4 posRTE=viewMatrixRTE*vec4(highDiff+lowDiff,1.0);vec4 projPos=projectionMatrix*posRTE;float camSlope=dot(vec3(viewMatrix[0][2],viewMatrix[1][2],viewMatrix[2][2]),normalize(cameraPos));if(camSlope>0.5){float dist=dot(look,normalize(cameraPos));projPos.z+=dist*0.02;}else{projPos.z+=-(abs(projPos.z))*0.002;}projPos.z+=depthOffset+a_offset.z;vec2 screenPos=project(projPos,viewport);vec2 v=screenPos+rotate2d(a_rotation)*(a_vertices*a_size*scd+a_offset.xy);gl_Position=vec4((2.0*v/viewport-1.0)*projPos.w,projPos.z,projPos.w);}`,fragmentShader:"precision highp float;uniform sampler2D u_texture;varying vec2 v_texCoords;varying vec4 v_rgba;void main(){vec4 color=texture2D(u_texture,v_texCoords);if(color.a<0.1)discard;gl_FragColor=color*v_rgba;}"})),this._renderer.handler.programs.billboardPicking||this._renderer.handler.addProgram(new X("billboardPicking",{uniforms:{viewport:"vec2",projectionMatrix:"mat4",viewMatrix:"mat4",eyePositionHigh:"vec3",eyePositionLow:"vec3",planetRadius:"float",uScaleByDistance:"vec3",opacity:"float",depthOffset:"float"},attributes:{a_vertices:"vec2",a_positionsHigh:"vec3",a_positionsLow:"vec3",a_offset:"vec3",a_size:"vec2",a_rotation:"float",a_rgba:"vec4"},vertexShader:`precision highp float;
#define EMPTY - 1.0
#define RTL 1.0
vec2 project(vec4 p,vec2 viewport){return(0.5*p.xyz/p.w+0.5).xy*viewport;}mat2 rotate2d(float angle){return mat2(cos(angle),-sin(angle),sin(angle),cos(angle));}attribute vec2 a_vertices;attribute vec3 a_positionsHigh;attribute vec3 a_positionsLow;attribute vec3 a_offset;attribute vec2 a_size;attribute float a_rotation;attribute vec4 a_rgba;varying vec3 v_rgb;uniform mat4 viewMatrix;uniform mat4 projectionMatrix;uniform vec3 eyePositionHigh;uniform vec3 eyePositionLow;uniform vec3 uScaleByDistance;uniform float opacity;uniform float planetRadius;uniform vec2 viewport;uniform float depthOffset;const vec3 ZERO3=vec3(0.0);void main(){vec3 a_positions=a_positionsHigh+a_positionsLow;vec3 cameraPos=eyePositionHigh+eyePositionLow;vec3 look=a_positions-cameraPos;float lookDist=length(look);v_rgb=a_rgba.rgb;if(opacity*step(lookDist,sqrt(dot(cameraPos,cameraPos)-planetRadius)+sqrt(dot(a_positions,a_positions)-planetRadius))==0.0){return;}float scd=(1.0-smoothstep(uScaleByDistance[0],uScaleByDistance[1],lookDist))*(1.0-step(uScaleByDistance[2],lookDist));mat4 viewMatrixRTE=viewMatrix;viewMatrixRTE[3]=vec4(0.0,0.0,0.0,1.0);vec3 highDiff=a_positionsHigh-eyePositionHigh;vec3 lowDiff=a_positionsLow-eyePositionLow;vec4 posRTE=viewMatrixRTE*vec4(highDiff+lowDiff,1.0);vec4 projPos=projectionMatrix*posRTE;float camSlope=dot(vec3(viewMatrix[0][2],viewMatrix[1][2],viewMatrix[2][2]),normalize(cameraPos));if(camSlope>0.5){float dist=dot(look,normalize(cameraPos));projPos.z+=dist*0.02;}else{projPos.z+=-(abs(projPos.z))*0.002;}projPos.z+=depthOffset+a_offset.z;vec2 screenPos=project(projPos,viewport);vec2 v=screenPos+rotate2d(a_rotation)*(a_vertices*a_size*scd+a_offset.xy);gl_Position=vec4((2.0*v/viewport-1.0)*projPos.w,projPos.z,projPos.w);}`,fragmentShader:"precision highp float;varying vec3 v_rgb;void main(){gl_FragColor=vec4(v_rgb,1.0);}"})))}setRenderer(t){this._renderer=t,this.initProgram()}refresh(){let t=this._changedBuffers.length;for(;t--;)this._changedBuffers[t]=!0}_removeBillboards(){let t=this._billboards.length;for(;t--;){let s=this._billboards[t];s._handlerIndex=-1,s._handler=null,s._isReady=!1,s._lockId=-1}this._billboards.length=0,this._billboards=[]}clear(){this._texCoordArr=null,this._vertexArr=null,this._positionHighArr=null,this._positionLowArr=null,this._sizeArr=null,this._offsetArr=null,this._rgbaArr=null,this._rotationArr=null,this._pickingColorArr=null,this._texCoordArr=new Float32Array([]),this._vertexArr=new Float32Array([]),this._positionHighArr=new Float32Array([]),this._positionLowArr=new Float32Array([]),this._sizeArr=new Float32Array([]),this._offsetArr=new Float32Array([]),this._rgbaArr=new Float32Array([]),this._rotationArr=new Float32Array([]),this._pickingColorArr=new Float32Array([]),this._removeBillboards(),this._deleteBuffers(),this.refresh()}_deleteBuffers(){if(this._renderer){let t=this._renderer.handler.gl;t.deleteBuffer(this._positionHighBuffer),t.deleteBuffer(this._positionLowBuffer),t.deleteBuffer(this._sizeBuffer),t.deleteBuffer(this._offsetBuffer),t.deleteBuffer(this._rgbaBuffer),t.deleteBuffer(this._rotationBuffer),t.deleteBuffer(this._vertexBuffer),t.deleteBuffer(this._texCoordBuffer),t.deleteBuffer(this._pickingColorBuffer)}this._positionHighBuffer=null,this._positionLowBuffer=null,this._sizeBuffer=null,this._offsetBuffer=null,this._rgbaBuffer=null,this._rotationBuffer=null,this._vertexBuffer=null,this._texCoordBuffer=null,this._pickingColorBuffer=null}update(){if(this._renderer){let t=this._changedBuffers.length;for(;t--;)this._changedBuffers[t]&&(this._buffersUpdateCallbacks[t].call(this),this._changedBuffers[t]=!1)}}add(t){t._handlerIndex==-1&&(t._isReady=!0,t._handler=this,t._handlerIndex=this._billboards.length,this._billboards.push(t))}_displayPASS(){let t=this._renderer,s=t.handler;s.programs.billboard.activate();let n=s.programs.billboard._program,o=n.attributes,a=n.uniforms,l=s.gl,c=this._entityCollection;l.disable(l.CULL_FACE),l.uniform1f(a.depthOffset,c.polygonOffsetUnits),l.uniform1i(a.u_texture,0),l.uniformMatrix4fv(a.viewMatrix,!1,t.activeCamera.getViewMatrix()),l.uniformMatrix4fv(a.projectionMatrix,!1,t.activeCamera.getProjectionMatrix()),l.uniform3fv(a.eyePositionHigh,t.activeCamera.eyeHigh),l.uniform3fv(a.eyePositionLow,t.activeCamera.eyeLow),l.uniform3fv(a.uScaleByDistance,c.scaleByDistance),l.uniform1f(a.opacity,c._fadingOpacity),l.bindBuffer(l.ARRAY_BUFFER,this._texCoordBuffer),l.vertexAttribPointer(o.a_texCoord,this._texCoordBuffer.itemSize,l.FLOAT,!1,0,0),l.bindBuffer(l.ARRAY_BUFFER,this._vertexBuffer),l.vertexAttribPointer(o.a_vertices,this._vertexBuffer.itemSize,l.FLOAT,!1,0,0),l.bindBuffer(l.ARRAY_BUFFER,this._positionHighBuffer),l.vertexAttribPointer(o.a_positionsHigh,this._positionHighBuffer.itemSize,l.FLOAT,!1,0,0),l.bindBuffer(l.ARRAY_BUFFER,this._positionLowBuffer),l.vertexAttribPointer(o.a_positionsLow,this._positionLowBuffer.itemSize,l.FLOAT,!1,0,0),l.bindBuffer(l.ARRAY_BUFFER,this._rgbaBuffer),l.vertexAttribPointer(o.a_rgba,this._rgbaBuffer.itemSize,l.FLOAT,!1,0,0),l.bindBuffer(l.ARRAY_BUFFER,this._sizeBuffer),l.vertexAttribPointer(o.a_size,this._sizeBuffer.itemSize,l.FLOAT,!1,0,0),l.bindBuffer(l.ARRAY_BUFFER,this._offsetBuffer),l.vertexAttribPointer(o.a_offset,this._offsetBuffer.itemSize,l.FLOAT,!1,0,0),l.uniform1f(a.planetRadius,c.renderNode._planetRadius2||0),l.uniform2fv(a.viewport,[s.canvas.clientWidth,s.canvas.clientHeight]),l.bindBuffer(l.ARRAY_BUFFER,this._rotationBuffer),l.vertexAttribPointer(o.a_rotation,this._rotationBuffer.itemSize,l.FLOAT,!1,0,0),l.drawArrays(l.TRIANGLES,0,this._vertexBuffer.numItems),l.enable(l.CULL_FACE)}_pickingPASS(){let t=this._renderer,s=t.handler;s.programs.billboardPicking.activate();let n=s.programs.billboardPicking._program,o=n.attributes,a=n.uniforms,l=s.gl,c=this._entityCollection;l.disable(l.CULL_FACE),l.uniform1f(a.depthOffset,c.polygonOffsetUnits),l.uniformMatrix4fv(a.viewMatrix,!1,t.activeCamera.getViewMatrix()),l.uniformMatrix4fv(a.projectionMatrix,!1,t.activeCamera.getProjectionMatrix()),l.uniform3fv(a.eyePositionHigh,t.activeCamera.eyeHigh),l.uniform3fv(a.eyePositionLow,t.activeCamera.eyeLow),l.uniform3fv(a.uScaleByDistance,c.scaleByDistance),l.uniform1f(a.opacity,c._fadingOpacity),l.bindBuffer(l.ARRAY_BUFFER,this._vertexBuffer),l.vertexAttribPointer(o.a_vertices,this._vertexBuffer.itemSize,l.FLOAT,!1,0,0),l.bindBuffer(l.ARRAY_BUFFER,this._positionHighBuffer),l.vertexAttribPointer(o.a_positionsHigh,this._positionHighBuffer.itemSize,l.FLOAT,!1,0,0),l.bindBuffer(l.ARRAY_BUFFER,this._positionLowBuffer),l.vertexAttribPointer(o.a_positionsLow,this._positionLowBuffer.itemSize,l.FLOAT,!1,0,0),l.bindBuffer(l.ARRAY_BUFFER,this._pickingColorBuffer),l.vertexAttribPointer(o.a_rgba,this._pickingColorBuffer.itemSize,l.FLOAT,!1,0,0),l.bindBuffer(l.ARRAY_BUFFER,this._sizeBuffer),l.vertexAttribPointer(o.a_size,this._sizeBuffer.itemSize,l.FLOAT,!1,0,0),l.bindBuffer(l.ARRAY_BUFFER,this._offsetBuffer),l.vertexAttribPointer(o.a_offset,this._offsetBuffer.itemSize,l.FLOAT,!1,0,0),l.uniform1f(a.planetRadius,c.renderNode._planetRadius2||0),l.uniform2fv(a.viewport,[s.canvas.clientWidth,s.canvas.clientHeight]),l.bindBuffer(l.ARRAY_BUFFER,this._rotationBuffer),l.vertexAttribPointer(o.a_rotation,this._rotationBuffer.itemSize,l.FLOAT,!1,0,0),l.drawArrays(l.TRIANGLES,0,this._vertexBuffer.numItems),l.enable(l.CULL_FACE)}draw(){this._billboards.length&&(this.update(),this._displayPASS())}drawPicking(){this._billboards.length&&this.pickingEnabled&&this._pickingPASS()}reindexBillboardsArray(t){let s=this._billboards;for(let n=t;n<s.length;n++)s[n]._handlerIndex=n}_removeBillboard(t){let s=t._handlerIndex;this._billboards.splice(s,1);let n=24*s;this._rgbaArr=ot(this._rgbaArr,n,24),n=18*s,this._positionHighArr=ot(this._positionHighArr,n,18),this._positionLowArr=ot(this._positionLowArr,n,18),this._offsetArr=ot(this._offsetArr,n,18),this._pickingColorArr=ot(this._pickingColorArr,n,18),n=12*s,this._vertexArr=ot(this._vertexArr,n,12),this._sizeArr=ot(this._sizeArr,n,12),this._texCoordArr=ot(this._texCoordArr,n,12),n=6*s,this._rotationArr=ot(this._rotationArr,n,6),this.reindexBillboardsArray(s),this.refresh(),t._handlerIndex=-1,t._handler=null,t._isReady=!1,t._lockId=-1}setAlignedAxisArr(t,s){}remove(t){t._handler&&(t._isReady&&this.__id===t._handler.__id?this._removeBillboard(t):t._handler=null)}setPositionArr(t,s,n){let o=18*t,a=this._positionHighArr,l=s.x,c=s.y,d=s.z;a[o]=l,a[o+1]=c,a[o+2]=d,a[o+3]=l,a[o+4]=c,a[o+5]=d,a[o+6]=l,a[o+7]=c,a[o+8]=d,a[o+9]=l,a[o+10]=c,a[o+11]=d,a[o+12]=l,a[o+13]=c,a[o+14]=d,a[o+15]=l,a[o+16]=c,a[o+17]=d,a=this._positionLowArr,l=n.x,c=n.y,d=n.z,a[o]=l,a[o+1]=c,a[o+2]=d,a[o+3]=l,a[o+4]=c,a[o+5]=d,a[o+6]=l,a[o+7]=c,a[o+8]=d,a[o+9]=l,a[o+10]=c,a[o+11]=d,a[o+12]=l,a[o+13]=c,a[o+14]=d,a[o+15]=l,a[o+16]=c,a[o+17]=d,this._changedBuffers[1]=!0}setPickingColorArr(t,s){let n=18*t,o=this._pickingColorArr,a=s.x/255,l=s.y/255,c=s.z/255;o[n]=a,o[n+1]=l,o[n+2]=c,o[n+3]=a,o[n+4]=l,o[n+5]=c,o[n+6]=a,o[n+7]=l,o[n+8]=c,o[n+9]=a,o[n+10]=l,o[n+11]=c,o[n+12]=a,o[n+13]=l,o[n+14]=c,o[n+15]=a,o[n+16]=l,o[n+17]=c,this._changedBuffers[0]=!0}setSizeArr(t,s,n){let o=12*t,a=this._sizeArr,l=s,c=n;a[o]=l,a[o+1]=c,a[o+2]=l,a[o+3]=c,a[o+4]=l,a[o+5]=c,a[o+6]=l,a[o+7]=c,a[o+8]=l,a[o+9]=c,a[o+10]=l,a[o+11]=c,this._changedBuffers[2]=!0}setOffsetArr(t,s){let n=18*t,o=this._offsetArr,a=s.x,l=s.y,c=s.z;o[n]=a,o[n+1]=l,o[n+2]=c,o[n+3]=a,o[n+4]=l,o[n+5]=c,o[n+6]=a,o[n+7]=l,o[n+8]=c,o[n+9]=a,o[n+10]=l,o[n+11]=c,o[n+12]=a,o[n+13]=l,o[n+14]=c,o[n+15]=a,o[n+16]=l,o[n+17]=c,this._changedBuffers[3]=!0}setRgbaArr(t,s){let n=24*t,o=this._rgbaArr,a=s.x,l=s.y,c=s.z,d=s.w;o[n]=a,o[n+1]=l,o[n+2]=c,o[n+3]=d,o[n+4]=a,o[n+5]=l,o[n+6]=c,o[n+7]=d,o[n+8]=a,o[n+9]=l,o[n+10]=c,o[n+11]=d,o[n+12]=a,o[n+13]=l,o[n+14]=c,o[n+15]=d,o[n+16]=a,o[n+17]=l,o[n+18]=c,o[n+19]=d,o[n+20]=a,o[n+21]=l,o[n+22]=c,o[n+23]=d,this._changedBuffers[4]=!0}setRotationArr(t,s){let n=6*t,o=this._rotationArr;o[n]=s,o[n+1]=s,o[n+2]=s,o[n+3]=s,o[n+4]=s,o[n+5]=s,this._changedBuffers[5]=!0}setTexCoordArr(t,s){let n=12*t,o=this._texCoordArr;o[n]=s[0],o[n+1]=s[1],o[n+2]=s[2],o[n+3]=s[3],o[n+4]=s[4],o[n+5]=s[5],o[n+6]=s[6],o[n+7]=s[7],o[n+8]=s[8],o[n+9]=s[9],o[n+10]=s[10],o[n+11]=s[11],this._changedBuffers[6]=!0}setVisibility(t,s){let n;n=s?[-.5,.5,-.5,-.5,.5,-.5,.5,-.5,.5,.5,-.5,.5]:[0,0,0,0,0,0,0,0,0,0,0,0],this.setVertexArr(t,n)}setVertexArr(t,s){let n=12*t,o=this._vertexArr;o[n]=s[0],o[n+1]=s[1],o[n+2]=s[2],o[n+3]=s[3],o[n+4]=s[4],o[n+5]=s[5],o[n+6]=s[6],o[n+7]=s[7],o[n+8]=s[8],o[n+9]=s[9],o[n+10]=s[10],o[n+11]=s[11],this._changedBuffers[7]=!0}createPositionBuffer(){let t=this._renderer.handler,s=this._positionHighArr.length/3;this._positionHighBuffer&&this._positionHighBuffer.numItems===s||(t.gl.deleteBuffer(this._positionHighBuffer),t.gl.deleteBuffer(this._positionLowBuffer),this._positionHighBuffer=t.createStreamArrayBuffer(3,s),this._positionLowBuffer=t.createStreamArrayBuffer(3,s)),t.setStreamArrayBuffer(this._positionHighBuffer,this._positionHighArr),t.setStreamArrayBuffer(this._positionLowBuffer,this._positionLowArr)}createSizeBuffer(){let t=this._renderer.handler;t.gl.deleteBuffer(this._sizeBuffer),this._sizeBuffer=t.createArrayBuffer(this._sizeArr,2,this._sizeArr.length/2)}createOffsetBuffer(){let t=this._renderer.handler;t.gl.deleteBuffer(this._offsetBuffer),this._offsetBuffer=t.createArrayBuffer(this._offsetArr,3,this._offsetArr.length/3)}createRgbaBuffer(){let t=this._renderer.handler;t.gl.deleteBuffer(this._rgbaBuffer),this._rgbaBuffer=t.createArrayBuffer(this._rgbaArr,4,this._rgbaArr.length/4)}createRotationBuffer(){let t=this._renderer.handler;this._rotationBuffer&&this._rotationBuffer.numItems===this._rotationArr.length||(t.gl.deleteBuffer(this._rotationBuffer),this._rotationBuffer=t.createStreamArrayBuffer(1,this._rotationArr.length)),t.setStreamArrayBuffer(this._rotationBuffer,this._rotationArr)}createVertexBuffer(){let t=this._renderer.handler;t.gl.deleteBuffer(this._vertexBuffer),this._vertexBuffer=t.createArrayBuffer(this._vertexArr,2,this._vertexArr.length/2)}createTexCoordBuffer(){let t=this._renderer.handler;t.gl.deleteBuffer(this._texCoordBuffer),this._texCoordBuffer=t.createArrayBuffer(this._texCoordArr,2,this._texCoordArr.length/2)}createPickingColorBuffer(){let t=this._renderer.handler;t.gl.deleteBuffer(this._pickingColorBuffer),this._pickingColorBuffer=t.createArrayBuffer(this._pickingColorArr,3,this._pickingColorArr.length/3)}refreshTexCoordsArr(){}};bs.__counter__=0;let ns=bs;class sl extends ns{constructor(t){super(t),this._billboards=[]}add(t){if(t._handlerIndex==-1){super.add(t),this._addBillboardToArrays(t),this.refresh();let s=t.getSrc()||t.getImage()&&t.getImage().src;s&&t.setSrc(s)}}_addBillboardToArrays(t){t.getVisibility()?this._vertexArr=it(this._vertexArr,[-.5,.5,-.5,-.5,.5,-.5,.5,-.5,.5,.5,-.5,.5]):this._vertexArr=it(this._vertexArr,[0,0,0,0,0,0,0,0,0,0,0,0]),this._texCoordArr=it(this._texCoordArr,[0,0,0,0,0,0,0,0,0,0,0,0]);let s,n=t._positionHigh.x,o=t._positionHigh.y,a=t._positionHigh.z;this._positionHighArr=it(this._positionHighArr,[n,o,a,n,o,a,n,o,a,n,o,a,n,o,a,n,o,a]),n=t._positionLow.x,o=t._positionLow.y,a=t._positionLow.z,this._positionLowArr=it(this._positionLowArr,[n,o,a,n,o,a,n,o,a,n,o,a,n,o,a,n,o,a]),n=t._width,o=t._height,this._sizeArr=it(this._sizeArr,[n,o,n,o,n,o,n,o,n,o,n,o]),n=t._offset.x,o=t._offset.y,a=t._offset.z,this._offsetArr=it(this._offsetArr,[n,o,a,n,o,a,n,o,a,n,o,a,n,o,a,n,o,a]),n=t._color.x,o=t._color.y,a=t._color.z,s=t._color.w,this._rgbaArr=it(this._rgbaArr,[n,o,a,s,n,o,a,s,n,o,a,s,n,o,a,s,n,o,a,s,n,o,a,s]),n=t._rotation,this._rotationArr=it(this._rotationArr,[n,n,n,n,n,n]),n=t._entity._pickingColor.x/255,o=t._entity._pickingColor.y/255,a=t._entity._pickingColor.z/255,this._pickingColorArr=it(this._pickingColorArr,[n,o,a,n,o,a,n,o,a,n,o,a,n,o,a,n,o,a])}get billboards(){return this._billboards}refreshTexCoordsArr(){if(this._entityCollection&&this._renderer){let t=this._renderer.billboardsTextureAtlas;for(let s=0;s<this._billboards.length;s++){let n=this._billboards[s],o=n.getImage();if(o){let a=t.get(o.__nodeIndex);a&&this.setTexCoordArr(n._handlerIndex,a.texCoords)}}}}}class rl{constructor(t){this.isFree=!0,this._geoObjectHandler=t,this.geoObjects=[],this.numInstances=0,this._colorTexture=null,this._colorTextureSrc=null,this._colorTextureImage=null,this._normalTexture=null,this._normalTextureSrc=null,this._normalTextureImage=null,this._metallicRoughnessTexture=null,this._metallicRoughnessTextureSrc=null,this._metallicRoughnessTextureImage=null,this._sizeArr=[],this._translateArr=[],this._vertexArr=[],this._rtcPositionHighArr=[],this._rtcPositionLowArr=[],this._qRotArr=[],this._rgbaArr=[],this._normalsArr=[],this._indicesArr=[],this._pickingColorArr=[],this._visibleArr=[],this._texCoordArr=[],this._localPositionArr=[],this._sizeBuffer=null,this._translateBuffer=null,this._vertexBuffer=null,this._rtcPositionHighBuffer=null,this._rtcPositionLowBuffer=null,this._qRotBuffer=null,this._rgbaBuffer=null,this._normalsBuffer=null,this._indicesBuffer=null,this._pickingColorBuffer=null,this._visibleBuffer=null,this._texCoordBuffer=null,this._localPositionBuffer=null,this._materialParams=new Float32Array(9),this._materialShininess=0,this._buffersUpdateCallbacks=[],this._buffersUpdateCallbacks[Jo]=this.createPickingColorBuffer,this._buffersUpdateCallbacks[Xo]=this.createNormalsBuffer,this._buffersUpdateCallbacks[$o]=this.createRgbaBuffer,this._buffersUpdateCallbacks[Zo]=this.createIndicesBuffer,this._buffersUpdateCallbacks[Yo]=this.createVertexBuffer,this._buffersUpdateCallbacks[Qo]=this.createSizeBuffer,this._buffersUpdateCallbacks[ta]=this.createVisibleBuffer,this._buffersUpdateCallbacks[ea]=this.createTexCoordBuffer,this._buffersUpdateCallbacks[Ko]=this.createQRotBuffer,this._buffersUpdateCallbacks[ia]=this.createTranslateBuffer,this._buffersUpdateCallbacks[Wo]=this.createRTCPositionBuffer,this._buffersUpdateCallbacks[sa]=this.createLocalPositionBuffer,this._changedBuffers=new Array(this._buffersUpdateCallbacks.length)}setMaterialAmbient(t,s,n){this._materialParams[0]=t,this._materialParams[1]=s,this._materialParams[2]=n}setMaterialDiffuse(t,s,n){this._materialParams[3]=t,this._materialParams[4]=s,this._materialParams[5]=n}setMaterialSpecular(t,s,n){this._materialParams[6]=t,this._materialParams[7]=s,this._materialParams[8]=n}setMaterialShininess(t){this._materialShininess=t}setMaterialParams(t,s,n,o){this.setMaterialAmbient(t[0],t[1],t[2]),this.setMaterialDiffuse(s[0],s[1],s[2]),this.setMaterialSpecular(n[0],n[1],n[2]),this.setMaterialShininess(o)}drawOpaque(t){let s=t.gl,n=t.uniforms,o=t.attributes;s.bindBuffer(s.ARRAY_BUFFER,this._qRotBuffer),s.vertexAttribPointer(o.qRot,this._qRotBuffer.itemSize,s.FLOAT,!1,0,0),s.bindBuffer(s.ARRAY_BUFFER,this._sizeBuffer),s.vertexAttribPointer(o.aScale,this._sizeBuffer.itemSize,s.FLOAT,!1,0,0),s.bindBuffer(s.ARRAY_BUFFER,this._translateBuffer),s.vertexAttribPointer(o.aTranslate,this._translateBuffer.itemSize,s.FLOAT,!1,0,0),s.bindBuffer(s.ARRAY_BUFFER,this._localPositionBuffer),s.vertexAttribPointer(o.aLocalPosition,this._localPositionBuffer.itemSize,s.FLOAT,!1,0,0),s.bindBuffer(s.ARRAY_BUFFER,this._visibleBuffer),s.vertexAttribPointer(o.aDispose,this._visibleBuffer.itemSize,s.FLOAT,!1,0,0),s.uniform1f(n.uUseTexture,this._colorTexture?1:0),s.bindBuffer(s.ARRAY_BUFFER,this._rgbaBuffer),s.vertexAttribPointer(o.aColor,this._rgbaBuffer.itemSize,s.FLOAT,!1,0,0),s.uniform3fv(n.materialParams,this._materialParams),s.uniform1f(n.materialShininess,this._materialShininess),this._drawElementsInstanced(t)}drawTransparent(t){let s=t.gl,n=t.uniforms,o=t.attributes;s.bindBuffer(s.ARRAY_BUFFER,this._qRotBuffer),s.vertexAttribPointer(o.qRot,this._qRotBuffer.itemSize,s.FLOAT,!1,0,0),s.bindBuffer(s.ARRAY_BUFFER,this._sizeBuffer),s.vertexAttribPointer(o.aScale,this._sizeBuffer.itemSize,s.FLOAT,!1,0,0),s.bindBuffer(s.ARRAY_BUFFER,this._translateBuffer),s.vertexAttribPointer(o.aTranslate,this._translateBuffer.itemSize,s.FLOAT,!1,0,0),s.bindBuffer(s.ARRAY_BUFFER,this._localPositionBuffer),s.vertexAttribPointer(o.aLocalPosition,this._localPositionBuffer.itemSize,s.FLOAT,!1,0,0),s.bindBuffer(s.ARRAY_BUFFER,this._visibleBuffer),s.vertexAttribPointer(o.aDispose,this._visibleBuffer.itemSize,s.FLOAT,!1,0,0),s.uniform1f(n.uUseTexture,this._colorTexture?1:0),s.uniform3fv(n.materialParams,this._materialParams),s.uniform1f(n.materialShininess,this._materialShininess),s.bindBuffer(s.ARRAY_BUFFER,this._rgbaBuffer),s.vertexAttribPointer(o.aColor,this._rgbaBuffer.itemSize,s.FLOAT,!1,0,0),this._drawElementsInstanced(t)}_drawElementsInstanced(t){let s=t.gl,n=t.uniforms,o=t.attributes,a=this._geoObjectHandler._renderer;s.bindBuffer(s.ARRAY_BUFFER,this._rtcPositionHighBuffer),s.vertexAttribPointer(o.aRTCPositionHigh,this._rtcPositionHighBuffer.itemSize,s.FLOAT,!1,0,0),s.bindBuffer(s.ARRAY_BUFFER,this._rtcPositionLowBuffer),s.vertexAttribPointer(o.aRTCPositionLow,this._rtcPositionLowBuffer.itemSize,s.FLOAT,!1,0,0),s.bindBuffer(s.ARRAY_BUFFER,this._normalsBuffer),s.vertexAttribPointer(o.aVertexNormal,this._normalsBuffer.itemSize,s.FLOAT,!1,0,0),s.bindBuffer(s.ARRAY_BUFFER,this._vertexBuffer),s.vertexAttribPointer(o.aVertexPosition,this._vertexBuffer.itemSize,s.FLOAT,!1,0,0),s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,this._colorTexture||a.handler.defaultTexture),s.uniform1i(n.uTexture,0),s.bindBuffer(s.ARRAY_BUFFER,this._texCoordBuffer),s.vertexAttribPointer(o.aTexCoord,this._texCoordBuffer.itemSize,s.FLOAT,!1,0,0),s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,this._indicesBuffer),t.drawElementsInstanced(s.TRIANGLES,this._indicesBuffer.numItems,s.UNSIGNED_INT,0,this.numInstances)}async loadColorTexture(){if(this._geoObjectHandler._renderer){if(!this._colorTextureSrc)return this._colorTextureImage?(await this._colorTextureImage.decode(),void this._createColorTexture(this._colorTextureImage)):void 0;{const t=await Ui(this._colorTextureSrc);this._createColorTexture(t)}}}async loadNormalTexture(){if(this._geoObjectHandler._renderer){if(!this._normalTextureSrc)return this._normalTextureImage?(await this._normalTextureImage.decode(),void this._createNormalTexture(this._normalTextureImage)):void 0;{const t=await Ui(this._normalTextureSrc);this._createNormalTexture(t)}}}async loadMetallicRoughnessTexture(){if(this._geoObjectHandler._renderer){if(!this._metallicRoughnessTextureSrc)return this._metallicRoughnessTextureImage?(await this._metallicRoughnessTextureImage.decode(),void this._createMetallicRoughnessTexture(this._metallicRoughnessTextureImage)):void 0;{const t=await Ui(this._metallicRoughnessTextureSrc);this._createMetallicRoughnessTexture(t)}}}clear(){this.numInstances=0,this.geoObjects=[],this._sizeArr=[],this._translateArr=[],this._vertexArr=[],this._rtcPositionHighArr=[],this._rtcPositionLowArr=[],this._qRotArr=[],this._rgbaArr=[],this._normalsArr=[],this._indicesArr=[],this._pickingColorArr=[],this._visibleArr=[],this._texCoordArr=[],this._localPositionArr=[],this._deleteBuffers(),this.isFree=!1}_deleteBuffers(){if(this._geoObjectHandler&&this._geoObjectHandler._renderer){let t=this._geoObjectHandler._renderer.handler;if(t){t.deleteTexture(this._colorTexture),t.deleteTexture(this._normalTexture),t.deleteTexture(this._metallicRoughnessTexture);let s=t.gl;s&&(s.deleteBuffer(this._sizeBuffer),s.deleteBuffer(this._translateBuffer),s.deleteBuffer(this._vertexBuffer),s.deleteBuffer(this._rtcPositionHighBuffer),s.deleteBuffer(this._rtcPositionLowBuffer),s.deleteBuffer(this._qRotBuffer),s.deleteBuffer(this._rgbaBuffer),s.deleteBuffer(this._normalsBuffer),s.deleteBuffer(this._indicesBuffer),s.deleteBuffer(this._pickingColorBuffer),s.deleteBuffer(this._visibleBuffer),s.deleteBuffer(this._texCoordBuffer),s.deleteBuffer(this._localPositionBuffer))}this._colorTexture=null,this._normalTexture=null,this._metallicRoughnessTexture=null}this._sizeBuffer=null,this._translateBuffer=null,this._vertexBuffer=null,this._rtcPositionHighBuffer=null,this._rtcPositionLowBuffer=null,this._qRotBuffer=null,this._rgbaBuffer=null,this._normalsBuffer=null,this._indicesBuffer=null,this._pickingColorBuffer=null,this._visibleBuffer=null,this._texCoordBuffer=null,this._localPositionBuffer=null}createVertexBuffer(){const t=this._geoObjectHandler._renderer.handler;t.gl.deleteBuffer(this._vertexBuffer),this._vertexArr=st(this._vertexArr),this._vertexBuffer=t.createArrayBuffer(this._vertexArr,3,this._vertexArr.length/3)}createVisibleBuffer(){const t=this._geoObjectHandler._renderer.handler,s=this._visibleArr.length;this._visibleBuffer&&this._visibleBuffer.numItems===s||(t.gl.deleteBuffer(this._visibleBuffer),this._visibleBuffer=t.createStreamArrayBuffer(1,s)),this._visibleArr=st(this._visibleArr),t.setStreamArrayBuffer(this._visibleBuffer,this._visibleArr)}createSizeBuffer(){let t=this._geoObjectHandler._renderer.handler,s=this._sizeArr.length/3;this._sizeBuffer&&this._sizeBuffer.numItems===s||(t.gl.deleteBuffer(this._sizeBuffer),this._sizeBuffer=t.createStreamArrayBuffer(3,s)),this._sizeArr=st(this._sizeArr),t.setStreamArrayBuffer(this._sizeBuffer,this._sizeArr)}createTranslateBuffer(){let t=this._geoObjectHandler._renderer.handler,s=this._translateArr.length/3;this._translateBuffer&&this._translateBuffer.numItems===s||(t.gl.deleteBuffer(this._translateBuffer),this._translateBuffer=t.createStreamArrayBuffer(3,s)),this._translateArr=st(this._translateArr),t.setStreamArrayBuffer(this._translateBuffer,this._translateArr)}createLocalPositionBuffer(){let t=this._geoObjectHandler._renderer.handler,s=this._localPositionArr.length/3;this._localPositionBuffer&&this._localPositionBuffer.numItems===s||(t.gl.deleteBuffer(this._localPositionBuffer),this._localPositionBuffer=t.createStreamArrayBuffer(3,s)),this._localPositionArr=st(this._localPositionArr),t.setStreamArrayBuffer(this._localPositionBuffer,this._localPositionArr)}createTexCoordBuffer(){const t=this._geoObjectHandler._renderer.handler;t.gl.deleteBuffer(this._texCoordBuffer),this._texCoordArr=st(this._texCoordArr),this._texCoordBuffer=t.createArrayBuffer(this._texCoordArr,2,this._texCoordArr.length/2)}createRTCPositionBuffer(){let t=this._geoObjectHandler._renderer.handler,s=this._rtcPositionHighArr.length/3;this._rtcPositionHighBuffer&&this._rtcPositionHighBuffer.numItems===s||(t.gl.deleteBuffer(this._rtcPositionHighBuffer),t.gl.deleteBuffer(this._rtcPositionLowBuffer),this._rtcPositionHighBuffer=t.createStreamArrayBuffer(3,s),this._rtcPositionLowBuffer=t.createStreamArrayBuffer(3,s)),this._rtcPositionHighArr=st(this._rtcPositionHighArr),this._rtcPositionLowArr=st(this._rtcPositionLowArr),t.setStreamArrayBuffer(this._rtcPositionHighBuffer,this._rtcPositionHighArr),t.setStreamArrayBuffer(this._rtcPositionLowBuffer,this._rtcPositionLowArr)}createRgbaBuffer(){let t=this._geoObjectHandler._renderer.handler,s=this._rgbaArr.length/4;this._rgbaBuffer&&this._rgbaBuffer.numItems===s||(t.gl.deleteBuffer(this._rgbaBuffer),this._rgbaBuffer=t.createStreamArrayBuffer(4,s)),this._rgbaArr=st(this._rgbaArr),t.setStreamArrayBuffer(this._rgbaBuffer,this._rgbaArr)}createQRotBuffer(){let t=this._geoObjectHandler._renderer.handler,s=this._qRotArr.length/4;this._qRotBuffer&&this._qRotBuffer.numItems===s||(t.gl.deleteBuffer(this._qRotBuffer),this._qRotBuffer=t.createStreamArrayBuffer(4,s)),this._qRotArr=st(this._qRotArr),t.setStreamArrayBuffer(this._qRotBuffer,this._qRotArr)}createNormalsBuffer(){const t=this._geoObjectHandler._renderer.handler;t.gl.deleteBuffer(this._normalsBuffer),this._normalsArr=st(this._normalsArr),this._normalsBuffer=t.createArrayBuffer(this._normalsArr,3,this._normalsArr.length/3)}createIndicesBuffer(){const t=this._geoObjectHandler._renderer.handler;t.gl.deleteBuffer(this._indicesBuffer),this._indicesArr=st(this._indicesArr,Uint32Array),this._indicesBuffer=t.createElementArrayBuffer(this._indicesArr,1,this._indicesArr.length)}createPickingColorBuffer(){const t=this._geoObjectHandler._renderer.handler;t.gl.deleteBuffer(this._pickingColorBuffer),this._pickingColorArr=st(this._pickingColorArr),this._pickingColorBuffer=t.createArrayBuffer(this._pickingColorArr,3,this._pickingColorArr.length/3)}refresh(){let t=this._changedBuffers.length;for(;t--;)this._changedBuffers[t]=!0}update(){if(this._geoObjectHandler._renderer){let t=this._changedBuffers.length;for(;t--;)this._changedBuffers[t]&&(this._buffersUpdateCallbacks[t].call(this),this._changedBuffers[t]=!1);this.isFree=!0}}_createColorTexture(t){if(this._geoObjectHandler&&this._geoObjectHandler._renderer){let s=this._geoObjectHandler._renderer.handler;this._colorTexture=s.createTextureDefault(t,null,s.gl.REPEAT)}}_createNormalTexture(t){if(this._geoObjectHandler&&this._geoObjectHandler._renderer){let s=this._geoObjectHandler._renderer.handler;this._normalTexture=s.createTextureDefault(t,null,s.gl.REPEAT)}}_createMetallicRoughnessTexture(t){if(this._geoObjectHandler&&this._geoObjectHandler._renderer){let s=this._geoObjectHandler._renderer.handler;this._metallicRoughnessTexture=s.createTextureDefault(t,null,s.gl.REPEAT)}}}const Yo=0,Wo=1,$o=2,Xo=3,Zo=4,Ko=5,Qo=6,Jo=7,ta=8,ea=9,ia=10,sa=11;function Tt(h,t=0,s=0,n=1,...o){const a=t*s;for(let l=a,c=a+s;l<c;l++)h[l]=o[l%n];return h}const ws=class pd{constructor(t){this.__id=pd.__counter__++,this.pickingEnabled=!0,this._entityCollection=t,this._renderNode=null,this._renderer=null,this._geoObjects=[],this._instanceDataMap=new Map,this._instanceDataMapValues=[],this._dataTagUpdateQueue=[],this._relativeCenter=new v,this._rtcEyePositionHigh=new Float32Array([0,0,0]),this._rtcEyePositionLow=new Float32Array([0,0,0])}initProgram(){this._renderer&&(this._renderer.handler.programs.geo_object||this._renderer.handler.addProgram(new X("geo_object",{uniforms:{viewMatrix:"mat4",projectionMatrix:"mat4",uScaleByDistance:"vec3",eyePositionHigh:"vec3",eyePositionLow:"vec3",rtcEyePositionHigh:"vec3",rtcEyePositionLow:"vec3",sunPosition:"vec3",materialParams:"vec3",materialShininess:"float",uTexture:"sampler2d",uUseTexture:"float",useLighting:"float"},attributes:{aVertexPosition:"vec3",aVertexNormal:"vec3",aTexCoord:"vec2",aLocalPosition:{type:"vec3",divisor:1},aRTCPositionHigh:{type:"vec3",divisor:1},aRTCPositionLow:{type:"vec3",divisor:1},aColor:{type:"vec4",divisor:1},aScale:{type:"vec3",divisor:1},aTranslate:{type:"vec3",divisor:1},aDispose:{type:"float",divisor:1},qRot:{type:"vec4",divisor:1}},vertexShader:"precision highp float;vec3 qRotate(vec4 q,vec3 v){return v+2.0*cross(q.xyz,cross(q.xyz,v)+q.w*v);}attribute vec3 aVertexPosition;attribute vec3 aVertexNormal;attribute vec3 aRTCPositionHigh;attribute vec3 aRTCPositionLow;attribute vec4 aColor;attribute vec3 aScale;attribute vec3 aTranslate;attribute float aDispose;attribute float aUseTexture;attribute vec2 aTexCoord;attribute vec4 qRot;attribute vec3 aLocalPosition;uniform vec3 uScaleByDistance;uniform mat4 projectionMatrix;uniform mat4 viewMatrix;uniform vec3 eyePositionHigh;uniform vec3 eyePositionLow;uniform vec3 rtcEyePositionHigh;uniform vec3 rtcEyePositionLow;varying vec3 cameraPosition;varying vec3 vNormal;varying vec3 v_vertex;varying vec4 vColor;varying float vDispose;varying vec2 vTexCoords;void main(void){if(aDispose==0.0){return;}vColor=aColor;vTexCoords=aTexCoord;mat4 viewMatrixRTE=viewMatrix;viewMatrixRTE[3]=vec4(0.0,0.0,0.0,1.0);vec3 highDiff=aRTCPositionHigh-rtcEyePositionHigh;vec3 lowDiff=aRTCPositionLow-rtcEyePositionLow;cameraPosition=eyePositionHigh+eyePositionLow;highDiff=highDiff*step(1.0,length(highDiff));vec4 positionInViewSpace=viewMatrixRTE*vec4(highDiff+lowDiff,1.0);float lookLength=length(positionInViewSpace.xyz);vNormal=normalize(qRotate(qRot,aVertexNormal));float scd=uScaleByDistance[2]*clamp(lookLength,uScaleByDistance[0],uScaleByDistance[1])/uScaleByDistance[0];vec3 vert=qRotate(qRot,scd*(aVertexPosition*aScale+aTranslate))+scd*aLocalPosition;gl_Position=projectionMatrix*viewMatrixRTE*vec4(highDiff+lowDiff+vert,1.0);v_vertex=positionInViewSpace.xyz+vert;}",fragmentShader:"precision highp float;uniform vec3 sunPosition;uniform vec3 materialParams[3];uniform float materialShininess;uniform sampler2D uTexture;uniform float uUseTexture;uniform float useLighting;varying vec3 cameraPosition;varying vec3 v_vertex;varying vec4 vColor;varying vec3 vNormal;varying vec2 vTexCoords;void main(void){vec3 lightWeighting=vec3(1.0);if(useLighting!=0.0){vec3 normal=normalize(vNormal);vec3 light_dir=normalize(sunPosition);vec3 look_dir=normalize(cameraPosition-v_vertex);float diffuse=max(dot(normal,light_dir),0.0);vec3 refl_dir=reflect(-light_dir,normal);float refl=max(dot(refl_dir,look_dir),0.0);float specular=pow(refl,materialShininess)*step(1e-4,diffuse);lightWeighting=vColor.rgb*materialParams[0]+materialParams[1]*diffuse+materialParams[2]*specular;}else{lightWeighting=vColor.rgb;}if(uUseTexture>0.0){vec4 texColor=texture2D(uTexture,vTexCoords);gl_FragColor=vec4(texColor.rgb*lightWeighting,texColor.a);}else{gl_FragColor=vec4(lightWeighting,vColor.a);}}"})),this._renderer.handler.programs.geo_object_picking||this._renderer.handler.addProgram(new X("geo_object_picking",{uniforms:{viewMatrix:"mat4",projectionMatrix:"mat4",uScaleByDistance:"vec3",pickingScale:"vec3",rtcEyePositionHigh:"vec3",rtcEyePositionLow:"vec3"},attributes:{aVertexPosition:"vec3",aRTCPositionHigh:{type:"vec3",divisor:1},aRTCPositionLow:{type:"vec3",divisor:1},aPickingColor:{type:"vec3",divisor:1},aScale:{type:"vec3",divisor:1},aTranslate:{type:"vec3",divisor:1},aLocalPosition:{type:"vec3",divisor:1},aDispose:{type:"float",divisor:1},qRot:{type:"vec4",divisor:1}},vertexShader:"precision highp float;vec3 qRotate(vec4 q,vec3 v){return v+2.0*cross(q.xyz,cross(q.xyz,v)+q.w*v);}attribute vec3 aVertexPosition;attribute vec3 aRTCPositionHigh;attribute vec3 aRTCPositionLow;attribute vec3 aPickingColor;attribute vec3 aScale;attribute vec3 aTranslate;attribute float aDispose;attribute vec4 qRot;attribute vec3 aLocalPosition;uniform vec3 rtcEyePositionHigh;uniform vec3 rtcEyePositionLow;uniform vec3 uScaleByDistance;uniform mat4 projectionMatrix;uniform mat4 viewMatrix;uniform vec3 pickingScale;varying vec3 vColor;void main(void){if(aDispose==0.0){return;}vColor=aPickingColor;mat4 viewMatrixRTE=viewMatrix;viewMatrixRTE[3]=vec4(0.0,0.0,0.0,1.0);vec3 highDiff=aRTCPositionHigh-rtcEyePositionHigh;vec3 lowDiff=aRTCPositionLow-rtcEyePositionLow;highDiff=highDiff*step(1.0,length(highDiff));vec4 positionInViewSpace=viewMatrixRTE*vec4(highDiff+lowDiff,1.0);float lookLength=length(positionInViewSpace.xyz);float scd=uScaleByDistance[2]*clamp(lookLength,uScaleByDistance[0],uScaleByDistance[1])/uScaleByDistance[0];vec3 vert=qRotate(qRot,scd*pickingScale*(aVertexPosition*aScale+aTranslate))+scd*aLocalPosition;gl_Position=projectionMatrix*viewMatrixRTE*vec4(highDiff+lowDiff+vert,1.0);}",fragmentShader:"precision highp float;varying vec3 vColor;void main(){gl_FragColor=vec4(vColor,1.0);}"})),this._renderer.handler.programs.geo_object_depth||this._renderer.handler.addProgram(new X("geo_object_depth",{uniforms:{viewMatrix:"mat4",projectionMatrix:"mat4",uScaleByDistance:"vec3",rtcEyePositionHigh:"vec3",rtcEyePositionLow:"vec3",frustumPickingColor:"float"},attributes:{aVertexPosition:"vec3",aRTCPositionHigh:{type:"vec3",divisor:1},aRTCPositionLow:{type:"vec3",divisor:1},aScale:{type:"vec3",divisor:1},aTranslate:{type:"vec3",divisor:1},aDispose:{type:"float",divisor:1},qRot:{type:"vec4",divisor:1},aLocalPosition:{type:"vec3",divisor:1}},vertexShader:`#version 300 es
precision highp float;vec3 qRotate(vec4 q,vec3 v){return v+2.0*cross(q.xyz,cross(q.xyz,v)+q.w*v);}in vec3 aVertexPosition;in vec3 aRTCPositionHigh;in vec3 aRTCPositionLow;in vec3 aScale;in vec3 aTranslate;in float aDispose;in vec4 qRot;in vec3 aLocalPosition;uniform vec3 rtcEyePositionHigh;uniform vec3 rtcEyePositionLow;uniform vec3 uScaleByDistance;uniform mat4 projectionMatrix;uniform mat4 viewMatrix;void main(void){if(aDispose==0.0){return;}mat4 viewMatrixRTE=viewMatrix;viewMatrixRTE[3]=vec4(0.0,0.0,0.0,1.0);vec3 highDiff=aRTCPositionHigh-rtcEyePositionHigh;vec3 lowDiff=aRTCPositionLow-rtcEyePositionLow;highDiff=highDiff*step(1.0,length(highDiff));vec4 positionInViewSpace=viewMatrixRTE*vec4(highDiff+lowDiff,1.0);float lookLength=length(positionInViewSpace.xyz);float scd=uScaleByDistance[2]*clamp(lookLength,uScaleByDistance[0],uScaleByDistance[1])/uScaleByDistance[0];vec3 vert=qRotate(qRot,scd*(aVertexPosition*aScale+aTranslate))+scd*aLocalPosition;gl_Position=projectionMatrix*viewMatrixRTE*vec4(highDiff+lowDiff+vert,1.0);}`,fragmentShader:`#version 300 es
precision highp float;uniform float frustumPickingColor;layout(location=0)out vec4 frustumColor;layout(location=1)out vec4 depthColor;void main(){frustumColor=vec4(frustumPickingColor,frustumPickingColor,frustumPickingColor,1.0);depthColor=vec4(gl_FragCoord.z,gl_FragCoord.z,gl_FragCoord.z,1.0);}`})))}setRenderNode(t){this._renderNode=t,this._renderer=t.renderer,this.initProgram();for(let s=0;s<this._instanceDataMapValues.length;s++)this._instanceDataMapValues[s].loadColorTexture(),this._instanceDataMapValues[s].loadNormalTexture(),this._instanceDataMapValues[s].loadMetallicRoughnessTexture();for(let s=0;s<this._geoObjects.length;s++)this._geoObjects[s].updateRotation();this.update()}setColorTextureTag(t,s){const n=this._instanceDataMap.get(s);n&&(typeof t=="string"&&(n._colorTextureSrc=t,n._colorTextureImage=null),t instanceof HTMLImageElement&&(n._colorTextureSrc=null,n._colorTextureImage=t),this._instanceDataMap.set(s,n),n.loadColorTexture())}setNormalTextureTag(t,s){const n=this._instanceDataMap.get(s);n&&(typeof t=="string"&&(n._normalTextureSrc=t,n._normalTextureImage=null),t instanceof HTMLImageElement&&(n._normalTextureSrc=null,n._normalTextureImage=t),this._instanceDataMap.set(s,n),n.loadNormalTexture())}setMetallicRoughnessTextureTag(t,s){const n=this._instanceDataMap.get(s);n&&(typeof t=="string"&&(n._metallicRoughnessTextureSrc=t,n._metallicRoughnessTextureImage=null),t instanceof HTMLImageElement&&(n._metallicRoughnessTextureSrc=null,n._metallicRoughnessTextureImage=t),this._instanceDataMap.set(s,n),n.loadMetallicRoughnessTexture())}setObjectSrc(t,s){const n=this._instanceDataMap.get(s);t&&n&&n._objectSrc!==t&&(n._objectSrc=t,$.loadObj(t).then(o=>{this._updateInstanceData(o[0],s)}))}_updateInstanceData(t,s){const n=this._instanceDataMap.get(s);n&&(t.vertices.length!==n._vertexArr.length&&(n._vertexArr=t.vertices,n._changedBuffers[Yo]=!0),t.normals.length!==n._normalsArr.length&&(n._normalsArr=t.normals,n._changedBuffers[Xo]=!0),t.indices.length!==n._indicesArr.length&&(n._indicesArr=t.indices,n._changedBuffers[Zo]=!0),t.texCoords.length!==n._texCoordArr.length&&(n._texCoordArr=t.texCoords,n._changedBuffers[ea]=!0),n._colorTextureSrc=t.colorTextureSrc,n._normalTextureSrc=t.normalTextureSrc,n._metallicRoughnessTexture=t.metallicRoughnessTextureSrc,n._colorTextureImage=t.colorTextureImage,n._normalTextureImage=t.normalTextureImage,n._metallicRoughnessTextureImage=t.metallicRoughnessTextureImage,n.loadColorTexture(),n.loadNormalTexture(),n.loadMetallicRoughnessTexture(),this._updateTag(n),this._instanceDataMapValues=Array.from(this._instanceDataMap.values()))}_addGeoObjectToArray(t){const s=t.tag;let n=this._instanceDataMap.get(s);n||(n=new rl(this),this._instanceDataMap.set(s,n),this._instanceDataMapValues=Array.from(this._instanceDataMap.values()),n._vertexArr=t.vertices,n._normalsArr=t.normals,n._indicesArr=t.indices,n._texCoordArr=t.texCoords,n._colorTextureSrc=t.object3d.colorTextureSrc,n._normalTextureSrc=t.object3d.normalTextureSrc,n._metallicRoughnessTextureSrc=t.object3d.metallicRoughnessTextureSrc,n._colorTextureImage=t.object3d.colorTextureImage,n._normalTextureImage=t.object3d.normalTextureImage,n._metallicRoughnessTextureImage=t.object3d.metallicRoughnessTextureImage,n.setMaterialParams(t.object3d.ambient,t.object3d.diffuse,t.object3d.specular,t.object3d.shininess),n.loadColorTexture(),n.loadNormalTexture(),n.loadMetallicRoughnessTexture()),t._tagDataIndex=n.numInstances++,t._tagData=n,n.geoObjects.push(t);let o=3;n._visibleArr=bt(n._visibleArr,Tt([],0,1,1,t.getVisibility()?1:0)),this.getRTCPosition(t.getPosition(),t._rtcPositionHigh,t._rtcPositionLow);let a,l=t._rtcPositionHigh.x,c=t._rtcPositionHigh.y,d=t._rtcPositionHigh.z;n._rtcPositionHighArr=bt(n._rtcPositionHighArr,Tt([],0,o,o,l,c,d)),l=t._rtcPositionLow.x,c=t._rtcPositionLow.y,d=t._rtcPositionLow.z,n._rtcPositionLowArr=bt(n._rtcPositionLowArr,Tt([],0,o,o,l,c,d)),l=t._entity._pickingColor.x/255,c=t._entity._pickingColor.y/255,d=t._entity._pickingColor.z/255,n._pickingColorArr=bt(n._pickingColorArr,Tt([],0,o,o,l,c,d)),o=4,l=t._qRot.x,c=t._qRot.y,d=t._qRot.z,a=t._qRot.w,n._qRotArr=bt(n._qRotArr,Tt([],0,o,o,l,c,d,a)),l=t._color.x,c=t._color.y,d=t._color.z,a=t._color.w,n._rgbaArr=bt(n._rgbaArr,Tt([],0,o,o,l,c,d,a)),o=3;let u=t.getScale();l=u.x,c=u.y,d=u.z,n._sizeArr=bt(n._sizeArr,Tt([],0,o,o,l,c,d));let _=t.getTranslate();l=_.x,c=_.y,d=_.z,n._translateArr=bt(n._translateArr,Tt([],0,o,o,l,c,d));let f=t.getLocalPosition();l=f.x,c=f.y,d=f.z,n._localPositionArr=bt(n._localPositionArr,Tt([],0,o,o,l,c,d))}_bindCommon(){let t=this._renderer,s=t.handler.programs.geo_object._program.uniforms,n=t.handler.gl,o=this._entityCollection;n.uniform3fv(s.uScaleByDistance,o.scaleByDistance),n.uniform1f(s.useLighting,o._useLighting),n.uniform3fv(s.eyePositionHigh,t.activeCamera.eyeHigh),n.uniform3fv(s.eyePositionLow,t.activeCamera.eyeLow),n.uniform3fv(s.rtcEyePositionHigh,this._rtcEyePositionHigh),n.uniform3fv(s.rtcEyePositionLow,this._rtcEyePositionLow),n.uniformMatrix4fv(s.projectionMatrix,!1,t.activeCamera.getProjectionMatrix()),n.uniformMatrix4fv(s.viewMatrix,!1,t.activeCamera.getViewMatrix()),n.uniform3fv(s.sunPosition,this._renderNode._lightPosition)}_displayOpaquePASS(){let t=this._renderer.handler.programs.geo_object,s=t._program;t.activate(),this._bindCommon();for(let n=0;n<this._instanceDataMapValues.length;n++)this._instanceDataMapValues[n].drawOpaque(s)}_displayTransparentPASS(){let t=this._renderer.handler.programs.geo_object,s=t._program;t.activate(),this._bindCommon();for(let n=0;n<this._instanceDataMapValues.length;n++)this._instanceDataMapValues[n].drawTransparent(s)}_depthPASS(){let t=this._renderer,s=t.handler.programs.geo_object_depth,n=s._program,o=n.uniforms,a=n.attributes,l=t.handler.gl,c=this._entityCollection,d=t.activeCamera;s.activate(),l.uniform3fv(o.uScaleByDistance,c.scaleByDistance),l.uniform3fv(o.rtcEyePositionHigh,this._rtcEyePositionHigh),l.uniform3fv(o.rtcEyePositionLow,this._rtcEyePositionLow),l.uniformMatrix4fv(o.projectionMatrix,!1,t.activeCamera.getProjectionMatrix()),l.uniformMatrix4fv(o.viewMatrix,!1,t.activeCamera.getViewMatrix()),l.uniform1f(o.frustumPickingColor,d.frustumColorIndex);for(let u=0;u<this._instanceDataMapValues.length;u++){let _=this._instanceDataMapValues[u];l.bindBuffer(l.ARRAY_BUFFER,_._qRotBuffer),l.vertexAttribPointer(a.qRot,_._qRotBuffer.itemSize,l.FLOAT,!1,0,0),l.bindBuffer(l.ARRAY_BUFFER,_._sizeBuffer),l.vertexAttribPointer(a.aScale,_._sizeBuffer.itemSize,l.FLOAT,!1,0,0),l.bindBuffer(l.ARRAY_BUFFER,_._translateBuffer),l.vertexAttribPointer(a.aTranslate,_._translateBuffer.itemSize,l.FLOAT,!1,0,0),l.bindBuffer(l.ARRAY_BUFFER,_._localPositionBuffer),l.vertexAttribPointer(a.aLocalPosition,_._localPositionBuffer.itemSize,l.FLOAT,!1,0,0),l.bindBuffer(l.ARRAY_BUFFER,_._rtcPositionHighBuffer),l.vertexAttribPointer(a.aRTCPositionHigh,_._rtcPositionHighBuffer.itemSize,l.FLOAT,!1,0,0),l.bindBuffer(l.ARRAY_BUFFER,_._rtcPositionLowBuffer),l.vertexAttribPointer(a.aRTCPositionLow,_._rtcPositionLowBuffer.itemSize,l.FLOAT,!1,0,0),l.bindBuffer(l.ARRAY_BUFFER,_._visibleBuffer),l.vertexAttribPointer(a.aDispose,_._visibleBuffer.itemSize,l.FLOAT,!1,0,0),l.bindBuffer(l.ARRAY_BUFFER,_._vertexBuffer),l.vertexAttribPointer(a.aVertexPosition,_._vertexBuffer.itemSize,l.FLOAT,!1,0,0),l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,_._indicesBuffer),n.drawElementsInstanced(l.TRIANGLES,_._indicesBuffer.numItems,l.UNSIGNED_INT,0,_.numInstances)}}drawDepth(){this._geoObjects.length&&this._depthPASS()}drawPicking(){this._geoObjects.length&&this.pickingEnabled&&this._pickingPASS()}_pickingPASS(){let t=this._renderer,s=t.handler.programs.geo_object_picking,n=s._program,o=n.uniforms,a=n.attributes,l=t.handler.gl,c=this._entityCollection;s.activate(),l.uniform3fv(o.uScaleByDistance,c.scaleByDistance),l.uniform3fv(o.pickingScale,c.pickingScale),l.uniform3fv(o.rtcEyePositionHigh,this._rtcEyePositionHigh),l.uniform3fv(o.rtcEyePositionLow,this._rtcEyePositionLow),l.uniformMatrix4fv(o.projectionMatrix,!1,t.activeCamera.getProjectionMatrix()),l.uniformMatrix4fv(o.viewMatrix,!1,t.activeCamera.getViewMatrix());for(let d=0;d<this._instanceDataMapValues.length;d++){let u=this._instanceDataMapValues[d];l.bindBuffer(l.ARRAY_BUFFER,u._qRotBuffer),l.vertexAttribPointer(a.qRot,u._qRotBuffer.itemSize,l.FLOAT,!1,0,0),l.bindBuffer(l.ARRAY_BUFFER,u._sizeBuffer),l.vertexAttribPointer(a.aScale,u._sizeBuffer.itemSize,l.FLOAT,!1,0,0),l.bindBuffer(l.ARRAY_BUFFER,u._translateBuffer),l.vertexAttribPointer(a.aTranslate,u._translateBuffer.itemSize,l.FLOAT,!1,0,0),l.bindBuffer(l.ARRAY_BUFFER,u._localPositionBuffer),l.vertexAttribPointer(a.aLocalPosition,u._localPositionBuffer.itemSize,l.FLOAT,!1,0,0),l.bindBuffer(l.ARRAY_BUFFER,u._pickingColorBuffer),l.vertexAttribPointer(a.aPickingColor,u._pickingColorBuffer.itemSize,l.FLOAT,!1,0,0),l.bindBuffer(l.ARRAY_BUFFER,u._rtcPositionHighBuffer),l.vertexAttribPointer(a.aRTCPositionHigh,u._rtcPositionHighBuffer.itemSize,l.FLOAT,!1,0,0),l.bindBuffer(l.ARRAY_BUFFER,u._rtcPositionLowBuffer),l.vertexAttribPointer(a.aRTCPositionLow,u._rtcPositionLowBuffer.itemSize,l.FLOAT,!1,0,0),l.bindBuffer(l.ARRAY_BUFFER,u._visibleBuffer),l.vertexAttribPointer(a.aDispose,u._visibleBuffer.itemSize,l.FLOAT,!1,0,0),l.bindBuffer(l.ARRAY_BUFFER,u._vertexBuffer),l.vertexAttribPointer(a.aVertexPosition,u._vertexBuffer.itemSize,l.FLOAT,!1,0,0),l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,u._indicesBuffer),n.drawElementsInstanced(l.TRIANGLES,u._indicesBuffer.numItems,l.UNSIGNED_INT,0,u.numInstances)}}setQRotArr(t,s,n){Tt(t._qRotArr,s,4,4,n.x,n.y,n.z,n.w),t._changedBuffers[Ko]=!0,this._updateTag(t)}setVisibility(t,s,n){Tt(t._visibleArr,s,1,1,n?1:0),t._changedBuffers[ta]=!0,this._updateTag(t)}setRTCPositionArr(t,s,n,o){Tt(t._rtcPositionHighArr,s,3,3,n.x,n.y,n.z),Tt(t._rtcPositionLowArr,s,3,3,o.x,o.y,o.z),t._changedBuffers[Wo]=!0,this._updateTag(t)}setRgbaArr(t,s,n){Tt(t._rgbaArr,s,4,4,n.x,n.y,n.z,n.w),t._changedBuffers[$o]=!0,this._updateTag(t)}setPickingColorArr(t,s,n){Tt(t._pickingColorArr,s,3,3,n.x/255,n.y/255,n.z/255),t._changedBuffers[Jo]=!0,this._updateTag(t)}setScaleArr(t,s,n){Tt(t._sizeArr,s,3,3,n.x,n.y,n.z),t._changedBuffers[Qo]=!0,this._updateTag(t)}setTranslateArr(t,s,n){Tt(t._translateArr,s,3,3,n.x,n.y,n.z),t._changedBuffers[ia]=!0,this._updateTag(t)}setLocalPositionArr(t,s,n){Tt(t._localPositionArr,s,3,3,n.x,n.y,n.z),t._changedBuffers[sa]=!0,this._updateTag(t)}_updateTag(t){t.isFree&&(t.isFree=!1,this._dataTagUpdateQueue.push(t))}update(){for(let t=0,s=this._dataTagUpdateQueue.length;t<s;t++)this._dataTagUpdateQueue[t].update();this._dataTagUpdateQueue=[]}_removeAll(){let t=this._geoObjects.length;for(;t--;){const s=this._geoObjects[t];s._tagDataIndex=-1,s._tagData=null,s._handlerIndex=-1,s._handler=null}this._geoObjects.length=0,this._geoObjects=[];for(let s=0;s<this._instanceDataMapValues.length;s++)this._instanceDataMapValues[s].clear();this._instanceDataMap.clear(),this._instanceDataMapValues=[]}clear(){this._removeAll()}getRTCPosition(t,s,n){let o=t.sub(this._relativeCenter);v.doubleToTwoFloats(o,s,n)}setRelativeCenter(t){this._relativeCenter.copy(t);for(let s=0;s<this._instanceDataMapValues.length;s++){let n=this._instanceDataMapValues[s].geoObjects;for(let o=0;o<n.length;o++)n[o].updateRTCPosition()}}_updateRTCEyePosition(){let t=this._renderer;if(t.activeCamera.isFirstPass){let s=t.activeCamera.eye.sub(this._relativeCenter);v.doubleToTwoFloat32Array(s,this._rtcEyePositionHigh,this._rtcEyePositionLow)}}draw(){this._geoObjects.length&&(this._updateRTCEyePosition(),this.update(),this._displayOpaquePASS())}drawTransparent(){this._geoObjects.length&&this._displayTransparentPASS()}add(t){t._handlerIndex===-1&&(t._handler=this,t._handlerIndex=this._geoObjects.length,this._geoObjects.push(t),this._addGeoObjectToArray(t),t.updateRotation(),t._tagData.refresh(),this._updateTag(t._tagData),t.setObjectSrc(t._objectSrc))}remove(t){t._handler&&this.__id==t._handler.__id&&this._removeGeoObject(t)}_clearDataTagQueue(){this._dataTagUpdateQueue=[]}_removeGeoObject(t){let s=t._tagData,n=t.tag;s.numInstances--;let o=!1;if(s.numInstances===0){s.clear(),this._instanceDataMap.delete(n);for(let l=0;this._instanceDataMapValues.length;l++)if(this._instanceDataMapValues[l].numInstances===0){this._instanceDataMapValues.splice(l,1);break}this._clearDataTagQueue(),o=!0}this._geoObjects.splice(t._handlerIndex,1);for(let l=t._handlerIndex,c=this._geoObjects.length;l<c;l++){let d=this._geoObjects[l];d._handlerIndex=d._handlerIndex-1}let a=t._tagDataIndex;s.geoObjects.splice(a,1);for(let l=t._tagDataIndex,c=s.geoObjects.length;l<c;l++){let d=s.geoObjects[l];d._tagDataIndex=d._tagDataIndex-1}s._rgbaArr=Et(s._rgbaArr,4*a,4),s._rtcPositionHighArr=Et(s._rtcPositionHighArr,3*a,3),s._rtcPositionLowArr=Et(s._rtcPositionLowArr,3*a,3),s._qRotArr=Et(s._qRotArr,4*a,4),s._pickingColorArr=Et(s._pickingColorArr,3*a,3),s._sizeArr=Et(s._sizeArr,3*a,3),s._translateArr=Et(s._translateArr,3*a,3),s._localPositionArr=Et(s._localPositionArr,3*a,3),s._visibleArr=Et(s._visibleArr,a,1),t._handlerIndex=-1,t._handler=null,t._tagDataIndex=-1,t._tagData=null,o||(s.refresh(),this._updateTag(s))}};ws.__counter__=0;let Ar=ws;class nl extends ns{constructor(t,s=21){super(t),this._billboards=[],this._gliphParamBuffer=null,this._fontIndexBuffer=null,this._outlineBuffer=null,this._outlineColorBuffer=null,this._gliphParamArr=new Float32Array([]),this._fontIndexArr=new Float32Array([]),this._outlineArr=new Float32Array([]),this._outlineColorArr=new Float32Array([]),this._buffersUpdateCallbacks[8]=this.createFontIndexBuffer,this._buffersUpdateCallbacks[9]=this.createOutlineBuffer,this._buffersUpdateCallbacks[10]=this.createOutlineColorBuffer,this._changedBuffers=new Array(this._buffersUpdateCallbacks.length),this._maxLetters=s}initProgram(){this._renderer&&this._renderer.handler&&this._renderer.handler.gl&&(this._renderer.handler.programs.label||(this._renderer.handler.gl.type==="webgl2"?this._renderer.handler.addProgram(new X("label",{uniforms:{viewport:"vec2",fontTextureArr:"sampler2darray",sdfParamsArr:"vec4",projectionMatrix:"mat4",viewMatrix:"mat4",eyePositionHigh:"vec3",eyePositionLow:"vec3",planetRadius:"float",scaleByDistance:"vec3",opacity:"float",isOutlinePass:"int",depthOffset:"float"},attributes:{a_outline:"float",a_gliphParam:"vec4",a_vertices:"vec2",a_texCoord:"vec4",a_positionsHigh:"vec3",a_positionsLow:"vec3",a_size:"float",a_rotation:"float",a_rgba:"vec4",a_offset:"vec3",a_fontIndex:"float"},vertexShader:`#version 300 es
#define EMPTY - 1.0
#define RTL 1.0
vec2 project(vec4 p,vec2 viewport){return(0.5*p.xyz/p.w+0.5).xy*viewport;}mat2 rotate2d(float angle){return mat2(cos(angle),-sin(angle),sin(angle),cos(angle));}in float a_outline;in vec4 a_gliphParam;in vec2 a_vertices;in vec4 a_texCoord;in vec3 a_positionsHigh;in vec3 a_positionsLow;in vec3 a_offset;in float a_size;in float a_rotation;in vec4 a_rgba;in float a_fontIndex;out vec2 v_uv;out vec4 v_rgba;flat out int v_fontIndex;out vec4 v_outlineColor;flat out float v_outline;uniform vec2 viewport;uniform mat4 viewMatrix;uniform mat4 projectionMatrix;uniform vec3 eyePositionHigh;uniform vec3 eyePositionLow;uniform float planetRadius;uniform vec3 scaleByDistance;uniform float opacity;uniform float depthOffset;const vec3 ZERO3=vec3(0.0);void main(){if(a_texCoord.w==EMPTY){gl_Position=vec4(0.0);v_fontIndex=-1;return;}vec3 a_positions=a_positionsHigh+a_positionsLow;vec3 cameraPos=eyePositionHigh+eyePositionLow;v_outline=a_outline;v_fontIndex=int(a_fontIndex);v_uv=a_texCoord.xy;vec3 look=a_positions-cameraPos;float lookDist=length(look);v_rgba=a_rgba;if(opacity*step(lookDist,sqrt(dot(cameraPos,cameraPos)-planetRadius)+sqrt(dot(a_positions,a_positions)-planetRadius))==0.0){return;}float scd=(1.0-smoothstep(scaleByDistance[0],scaleByDistance[1],lookDist))*(1.0-step(scaleByDistance[2],lookDist));v_rgba.a*=opacity;mat4 viewMatrixRTE=viewMatrix;viewMatrixRTE[3]=vec4(0.0,0.0,0.0,1.0);vec3 highDiff=a_positionsHigh-eyePositionHigh;vec3 lowDiff=a_positionsLow-eyePositionLow;vec4 posRTE=viewMatrixRTE*vec4(highDiff+lowDiff,1.0);vec4 projPos=projectionMatrix*posRTE;float camSlope=dot(vec3(viewMatrix[0][2],viewMatrix[1][2],viewMatrix[2][2]),normalize(cameraPos));if(camSlope>0.5){float dist=dot(look,normalize(cameraPos));projPos.z+=dist*0.02;}else{projPos.z+=-(abs(projPos.z))*0.002;}projPos.z+=depthOffset+a_offset.z;vec2 screenPos=project(projPos,viewport);vec2 vert=a_vertices;vec4 gp=a_gliphParam;if(a_texCoord.w==RTL){vert.x=step(vert.x*0.5+1.0,1.0);gp.x=-a_gliphParam.x;gp.z=-(a_gliphParam.z+a_texCoord.z);}else{gp.z=a_gliphParam.z+a_texCoord.z;}vec2 v=screenPos+rotate2d(a_rotation)*((vert*gp.xy+gp.zw)*a_size*scd+a_offset.xy);gl_Position=vec4((2.0*v/viewport-1.0)*projPos.w,projPos.z,projPos.w);}`,fragmentShader:`#version 300 es
uniform int isOutlinePass;precision highp float;const int MAX_SIZE=11;uniform sampler2D fontTextureArr[MAX_SIZE];uniform vec4 sdfParamsArr[MAX_SIZE];flat in int v_fontIndex;in vec2 v_uv;in vec4 v_rgba;flat in float v_outline;in vec3 v_pickingColor;layout(location=0)out vec4 outScreen;float median(float r,float g,float b){return max(min(r,g),min(max(r,g),b));}float getDistance(){vec3 msdf;if(v_fontIndex==0){msdf=texture(fontTextureArr[0],v_uv).rgb;}else if(v_fontIndex==1){msdf=texture(fontTextureArr[1],v_uv).rgb;}else if(v_fontIndex==2){msdf=texture(fontTextureArr[2],v_uv).rgb;}else if(v_fontIndex==3){msdf=texture(fontTextureArr[3],v_uv).rgb;}else if(v_fontIndex==4){msdf=texture(fontTextureArr[4],v_uv).rgb;}else if(v_fontIndex==5){msdf=texture(fontTextureArr[5],v_uv).rgb;}else if(v_fontIndex==6){msdf=texture(fontTextureArr[6],v_uv).rgb;}else if(v_fontIndex==7){msdf=texture(fontTextureArr[7],v_uv).rgb;}else if(v_fontIndex==8){msdf=texture(fontTextureArr[8],v_uv).rgb;}else if(v_fontIndex==9){msdf=texture(fontTextureArr[9],v_uv).rgb;}else if(v_fontIndex==10){msdf=texture(fontTextureArr[10],v_uv).rgb;}return median(msdf.r,msdf.g,msdf.b);}void main(){if(v_fontIndex==-1){return;}vec4 sdfParams=sdfParamsArr[v_fontIndex];float sd=getDistance();vec2 dxdy=fwidth(v_uv)*sdfParams.xy;if(isOutlinePass==0){float dist=sd+min(0.001,0.5-1.0/sdfParams.w)-0.5;float opacity=clamp(dist*sdfParams.w/length(dxdy)+0.5,0.0,1.0);if(opacity<=0.1){discard;}outScreen=vec4(v_rgba.rgb,opacity*v_rgba.a);}else{float dist=sd+min(v_outline,0.5-1.0/sdfParams.w)-0.5;float opacity=clamp(dist*sdfParams.w/length(dxdy)+0.5,0.0,1.0);if(opacity<=0.1){discard;}outScreen=vec4(v_rgba.rgb,opacity*v_rgba.a);}}`})):this._renderer.handler.addProgram(new X("label",{uniforms:{viewport:"vec2",fontTextureArr:"sampler2darray",sdfParamsArr:"vec4",projectionMatrix:"mat4",viewMatrix:"mat4",eyePositionHigh:"vec3",eyePositionLow:"vec3",planetRadius:"float",scaleByDistance:"vec3",opacity:"float",isOutlinePass:"int",depthOffset:"float"},attributes:{a_outline:"float",a_gliphParam:"vec4",a_vertices:"vec2",a_texCoord:"vec4",a_positionsHigh:"vec3",a_positionsLow:"vec3",a_size:"float",a_rotation:"float",a_rgba:"vec4",a_offset:"vec3",a_fontIndex:"float"},vertexShader:`#define EMPTY - 1.0
#define RTL 1.0
vec2 project(vec4 p,vec2 viewport){return(0.5*p.xyz/p.w+0.5).xy*viewport;}mat2 rotate2d(float angle){return mat2(cos(angle),-sin(angle),sin(angle),cos(angle));}attribute float a_outline;attribute vec4 a_gliphParam;attribute vec2 a_vertices;attribute vec4 a_texCoord;attribute vec3 a_positionsHigh;attribute vec3 a_positionsLow;attribute vec3 a_offset;attribute float a_size;attribute float a_rotation;attribute vec4 a_rgba;attribute float a_fontIndex;varying float v_outline;varying vec2 v_uv;varying vec4 v_rgba;varying float v_fontIndex;uniform vec2 viewport;uniform mat4 viewMatrix;uniform mat4 projectionMatrix;uniform vec3 eyePositionHigh;uniform vec3 eyePositionLow;uniform float planetRadius;uniform vec3 scaleByDistance;uniform float opacity;uniform float depthOffset;const vec3 ZERO3=vec3(0.0);void main(){if(a_texCoord.w==EMPTY){gl_Position=vec4(0.0);v_fontIndex=-1.0;return;}vec3 a_positions=a_positionsHigh+a_positionsLow;vec3 cameraPos=eyePositionHigh+eyePositionLow;v_outline=a_outline;v_uv=vec2(a_texCoord.xy);v_rgba=a_rgba;v_fontIndex=a_fontIndex;vec3 look=a_positions-cameraPos;float lookDist=length(look);if(opacity*step(lookDist,sqrt(dot(cameraPos,cameraPos)-planetRadius)+sqrt(dot(a_positions,a_positions)-planetRadius))==0.0){return;}float scd=(1.0-smoothstep(scaleByDistance[0],scaleByDistance[1],lookDist))*(1.0-step(scaleByDistance[2],lookDist));v_rgba.a*=opacity;mat4 viewMatrixRTE=viewMatrix;viewMatrixRTE[3]=vec4(0.0,0.0,0.0,1.0);vec3 highDiff=a_positionsHigh-eyePositionHigh;vec3 lowDiff=a_positionsLow-eyePositionLow;vec4 posRTE=viewMatrixRTE*vec4(highDiff+lowDiff,1.0);vec4 projPos=projectionMatrix*posRTE;float camSlope=dot(vec3(viewMatrix[0][2],viewMatrix[1][2],viewMatrix[2][2]),normalize(cameraPos));if(camSlope>0.5){float dist=dot(look,normalize(cameraPos));projPos.z+=dist*0.02;}else{projPos.z+=-(abs(projPos.z))*0.002;}projPos.z+=depthOffset+a_offset.z;vec2 screenPos=project(projPos,viewport);vec2 vert=a_vertices;vec4 gp=a_gliphParam;if(a_texCoord.w==RTL){vert.x=step(vert.x*0.5+1.0,1.0);gp.x=-a_gliphParam.x;gp.z=-(a_gliphParam.z+a_texCoord.z);}else{gp.z=a_gliphParam.z+a_texCoord.z;}vec2 v=screenPos+rotate2d(a_rotation)*((vert*gp.xy+gp.zw)*a_size*scd+a_offset.xy);gl_Position=vec4((2.0*v/viewport-1.0)*projPos.w,projPos.z,projPos.w);}`,fragmentShader:`#extension GL_OES_standard_derivatives: enable
precision highp float;precision highp int;const int MAX_SIZE=11;uniform sampler2D fontTextureArr[MAX_SIZE];uniform vec4 sdfParamsArr[MAX_SIZE];uniform int isOutlinePass;varying float v_outline;varying vec2 v_uv;varying vec4 v_rgba;varying float v_fontIndex;float fontIndex;float median(float r,float g,float b){return max(min(r,g),min(max(r,g),b));}float getDistance(){vec3 msdf;if(fontIndex>=0.0&&fontIndex<1.0){msdf=texture2D(fontTextureArr[0],v_uv).rgb;}else if(fontIndex>=1.0&&fontIndex<2.0){msdf=texture2D(fontTextureArr[1],v_uv).rgb;}else if(fontIndex>=2.0&&fontIndex<3.0){msdf=texture2D(fontTextureArr[2],v_uv).rgb;}else if(fontIndex>=3.0&&fontIndex<4.0){msdf=texture2D(fontTextureArr[3],v_uv).rgb;}else if(fontIndex>=4.0&&fontIndex<5.0){msdf=texture2D(fontTextureArr[4],v_uv).rgb;}else if(fontIndex>=5.0&&fontIndex<6.0){msdf=texture2D(fontTextureArr[5],v_uv).rgb;}else if(fontIndex>=6.0&&fontIndex<7.0){msdf=texture2D(fontTextureArr[6],v_uv).rgb;}else if(fontIndex>=7.0&&fontIndex<8.0){msdf=texture2D(fontTextureArr[7],v_uv).rgb;}else if(fontIndex>=8.0&&fontIndex<9.0){msdf=texture2D(fontTextureArr[8],v_uv).rgb;}else if(fontIndex>=9.0&&fontIndex<10.0){msdf=texture2D(fontTextureArr[9],v_uv).rgb;}else if(fontIndex>=10.0&&fontIndex<11.0){msdf=texture2D(fontTextureArr[10],v_uv).rgb;}return median(msdf.r,msdf.g,msdf.b);}vec4 getSDFParams(){if(fontIndex>=0.0&&fontIndex<1.0){return sdfParamsArr[0];}else if(fontIndex>=1.0&&fontIndex<2.0){return sdfParamsArr[1];}else if(fontIndex>=2.0&&fontIndex<3.0){return sdfParamsArr[2];}else if(fontIndex>=3.0&&fontIndex<4.0){return sdfParamsArr[3];}else if(fontIndex>=4.0&&fontIndex<5.0){return sdfParamsArr[4];}else if(fontIndex>=5.0&&fontIndex<6.0){return sdfParamsArr[5];}else if(fontIndex>=6.0&&fontIndex<7.0){return sdfParamsArr[6];}else if(fontIndex>=7.0&&fontIndex<8.0){return sdfParamsArr[7];}else if(fontIndex>=8.0&&fontIndex<9.0){return sdfParamsArr[8];}else if(fontIndex>=9.0&&fontIndex<10.0){return sdfParamsArr[9];}else if(fontIndex>=10.0&&fontIndex<11.0){return sdfParamsArr[10];}}void main(){fontIndex=v_fontIndex+0.1;if(v_fontIndex<0.0){return;}vec4 sdfParams=getSDFParams();float sd=getDistance();vec2 dxdy=fwidth(v_uv)*sdfParams.xy;float dist=sd+min(0.001,0.5-1.0/sdfParams.w)-0.5;float opacity=clamp(dist*sdfParams.w/length(dxdy)+0.5,0.0,1.0);if(isOutlinePass==0){}else{float strokeDist=sd+min(v_outline,0.5-1.0/sdfParams.w)-0.5;float strokeAlpha=v_rgba.a*clamp(strokeDist*sdfParams.w/length(dxdy)+0.5,0.0,1.0);if(strokeAlpha<0.1){discard;}}}`}))),this._renderer.handler.programs.labelPicking||this._renderer.handler.addProgram(new X("labelPicking",{uniforms:{viewport:"vec2",projectionMatrix:"mat4",viewMatrix:"mat4",eyePositionHigh:"vec3",eyePositionLow:"vec3",planetRadius:"float",scaleByDistance:"vec3",opacity:"float",depthOffset:"float"},attributes:{a_gliphParam:"vec4",a_vertices:"vec2",a_texCoord:"vec4",a_positionsHigh:"vec3",a_positionsLow:"vec3",a_offset:"vec3",a_size:"float",a_rotation:"float",a_rgba:"vec4"},vertexShader:`#define EMPTY - 1.0
#define RTL 1.0
vec2 project(vec4 p,vec2 viewport){return(0.5*p.xyz/p.w+0.5).xy*viewport;}mat2 rotate2d(float angle){return mat2(cos(angle),-sin(angle),sin(angle),cos(angle));}attribute vec4 a_gliphParam;attribute vec2 a_vertices;attribute vec4 a_texCoord;attribute vec3 a_positionsHigh;attribute vec3 a_positionsLow;attribute vec3 a_offset;attribute float a_size;attribute float a_rotation;attribute vec4 a_rgba;varying vec4 v_rgba;uniform vec2 viewport;uniform mat4 viewMatrix;uniform mat4 projectionMatrix;uniform vec3 eyePositionHigh;uniform vec3 eyePositionLow;uniform float planetRadius;uniform vec3 scaleByDistance;uniform float opacity;uniform float depthOffset;const vec3 ZERO3=vec3(0.0);void main(){vec3 a_positions=a_positionsHigh+a_positionsLow;vec3 cameraPos=eyePositionHigh+eyePositionLow;v_rgba=a_rgba;if(a_texCoord.w==EMPTY){v_rgba.a=0.0;gl_Position=vec4(0.0);return;}vec3 look=a_positions-cameraPos;float lookDist=length(look);if(opacity*step(lookDist,sqrt(dot(cameraPos,cameraPos)-planetRadius)+sqrt(dot(a_positions,a_positions)-planetRadius))==0.0){return;}float scd=(1.0-smoothstep(scaleByDistance[0],scaleByDistance[1],lookDist))*(1.0-step(scaleByDistance[2],lookDist));v_rgba.a*=opacity;mat4 viewMatrixRTE=viewMatrix;viewMatrixRTE[3]=vec4(0.0,0.0,0.0,1.0);vec3 highDiff=a_positionsHigh-eyePositionHigh;vec3 lowDiff=a_positionsLow-eyePositionLow;vec4 posRTE=viewMatrixRTE*vec4(highDiff+lowDiff,1.0);vec4 projPos=projectionMatrix*posRTE;float camSlope=dot(vec3(viewMatrix[0][2],viewMatrix[1][2],viewMatrix[2][2]),normalize(cameraPos));if(camSlope>0.5){float dist=dot(look,normalize(cameraPos));projPos.z+=dist*0.02;}else{projPos.z+=-(abs(projPos.z))*0.002;}projPos.z+=depthOffset+a_offset.z;vec2 screenPos=project(projPos,viewport);vec2 vert=a_vertices;vec4 gp=a_gliphParam;if(a_texCoord.w==RTL){vert.x=step(vert.x*0.5+1.0,1.0);gp.x=-a_gliphParam.x;gp.z=-(a_gliphParam.z+a_texCoord.z);}else{gp.z=a_gliphParam.z+a_texCoord.z;}vec2 v=screenPos+rotate2d(a_rotation)*((vert*gp.xy+gp.zw)*a_size*scd+a_offset.xy);gl_Position=vec4((2.0*v/viewport-1.0)*projPos.w,projPos.z,projPos.w);}`,fragmentShader:"precision highp float;varying vec4 v_rgba;varying vec3 v_pickingColor;void main(){vec4 color=v_rgba;if(color.a<0.05){return;}gl_FragColor=vec4(v_rgba.rgb,v_rgba.a);}"})))}get labels(){return this._billboards}add(t){t._handler||(t._handler=this,this.assignFontAtlas(t),this.refresh())}updateFonts(){let t=[...this._billboards];this._billboards=[];for(let s=0;s<t.length;s++)this.assignFontAtlas(t[s])}_addLabelToArrays(t){this._renderer&&this._renderer.labelWorker.make({handler:this,label:t})}assignFontAtlas(t){this._entityCollection&&this._renderer?(t.assignFontAtlas(this._renderer.fontAtlas),this._addLabelToArrays(t)):this._billboards.push(t)}workerCallback(t,s){s._lockId!==-1&&s._handler&&this.isEqual(s._handler)&&(s._isReady=!0,s._lockId=-1,s._handlerIndex=this._billboards.length,this._billboards.push(s),this._vertexArr=it(this._vertexArr,t.vertexArr),this._texCoordArr=it(this._texCoordArr,t.texCoordArr),this._gliphParamArr=it(this._gliphParamArr,t.gliphParamArr),this._positionHighArr=it(this._positionHighArr,t.positionHighArr),this._positionLowArr=it(this._positionLowArr,t.positionLowArr),this._sizeArr=it(this._sizeArr,t.sizeArr),this._offsetArr=it(this._offsetArr,t.offsetArr),this._rgbaArr=it(this._rgbaArr,t.rgbaArr),this._rotationArr=it(this._rotationArr,t.rotationArr),this._fontIndexArr=it(this._fontIndexArr,t.fontIndexArr),this._outlineArr=it(this._outlineArr,t.outlineArr),this._outlineColorArr=it(this._outlineColorArr,t.outlineColorArr),this._pickingColorArr=it(this._pickingColorArr,t.pickingColorArr),s.update(),this.refresh())}clear(){this._texCoordArr=null,this._gliphParamArr=null,this._vertexArr=null,this._positionHighArr=null,this._positionLowArr=null,this._sizeArr=null,this._offsetArr=null,this._rgbaArr=null,this._rotationArr=null,this._fontIndexArr=null,this._outlineArr=null,this._outlineColorArr=null,this._texCoordArr=new Float32Array([]),this._gliphParamArr=new Float32Array([]),this._vertexArr=new Float32Array([]),this._positionHighArr=new Float32Array([]),this._positionLowArr=new Float32Array([]),this._sizeArr=new Float32Array([]),this._offsetArr=new Float32Array([]),this._rgbaArr=new Float32Array([]),this._rotationArr=new Float32Array([]),this._fontIndexArr=new Float32Array([]),this._outlineArr=new Float32Array([]),this._outlineColorArr=new Float32Array([]),this._removeBillboards(),this._deleteBuffers(),this.refresh()}_deleteBuffers(){if(this._renderer){let t=this._renderer.handler.gl;t.deleteBuffer(this._gliphParamBuffer),t.deleteBuffer(this._sizeBuffer),t.deleteBuffer(this._fontIndexBuffer),t.deleteBuffer(this._texCoordBuffer),t.deleteBuffer(this._outlineBuffer),t.deleteBuffer(this._outlineColorBuffer),t.deleteBuffer(this._positionHighBuffer),t.deleteBuffer(this._positionLowBuffer),t.deleteBuffer(this._sizeBuffer),t.deleteBuffer(this._offsetBuffer),t.deleteBuffer(this._rgbaBuffer),t.deleteBuffer(this._rotationBuffer),t.deleteBuffer(this._vertexBuffer),t.deleteBuffer(this._texCoordBuffer),t.deleteBuffer(this._pickingColorBuffer),this._gliphParamBuffer=null,this._sizeBuffer=null,this._fontIndexBuffer=null,this._texCoordBuffer=null,this._outlineBuffer=null,this._outlineColorBuffer=null,this._positionHighBuffer=null,this._positionLowBuffer=null,this._sizeBuffer=null,this._offsetBuffer=null,this._rgbaBuffer=null,this._rotationBuffer=null,this._vertexBuffer=null,this._texCoordBuffer=null,this._pickingColorBuffer=null}}_displayPASS(){let t=this._renderer,s=t.handler;s.programs.label.activate();let n=s.programs.label._program,o=n.attributes,a=n.uniforms,l=s.gl,c=this._entityCollection;l.disable(l.CULL_FACE),l.uniform1iv(a.fontTextureArr,t.fontAtlas.samplerArr),l.uniform4fv(a.sdfParamsArr,t.fontAtlas.sdfParamsArr),l.uniformMatrix4fv(a.viewMatrix,!1,t.activeCamera.getViewMatrix()),l.uniformMatrix4fv(a.projectionMatrix,!1,t.activeCamera.getProjectionMatrix()),l.uniform3fv(a.eyePositionHigh,t.activeCamera.eyeHigh),l.uniform3fv(a.eyePositionLow,t.activeCamera.eyeLow),l.uniform3fv(a.scaleByDistance,c.scaleByDistance),l.uniform1f(a.opacity,c._fadingOpacity),l.uniform1f(a.planetRadius,c.renderNode._planetRadius2||0),l.uniform2fv(a.viewport,[s.canvas.clientWidth,s.canvas.clientHeight]),l.bindBuffer(l.ARRAY_BUFFER,this._texCoordBuffer),l.vertexAttribPointer(o.a_texCoord,this._texCoordBuffer.itemSize,l.FLOAT,!1,0,0),l.bindBuffer(l.ARRAY_BUFFER,this._gliphParamBuffer),l.vertexAttribPointer(o.a_gliphParam,this._gliphParamBuffer.itemSize,l.FLOAT,!1,0,0),l.bindBuffer(l.ARRAY_BUFFER,this._vertexBuffer),l.vertexAttribPointer(o.a_vertices,this._vertexBuffer.itemSize,l.FLOAT,!1,0,0),l.bindBuffer(l.ARRAY_BUFFER,this._positionHighBuffer),l.vertexAttribPointer(o.a_positionsHigh,this._positionHighBuffer.itemSize,l.FLOAT,!1,0,0),l.bindBuffer(l.ARRAY_BUFFER,this._positionLowBuffer),l.vertexAttribPointer(o.a_positionsLow,this._positionLowBuffer.itemSize,l.FLOAT,!1,0,0),l.bindBuffer(l.ARRAY_BUFFER,this._sizeBuffer),l.vertexAttribPointer(o.a_size,this._sizeBuffer.itemSize,l.FLOAT,!1,0,0),l.bindBuffer(l.ARRAY_BUFFER,this._rotationBuffer),l.vertexAttribPointer(o.a_rotation,this._rotationBuffer.itemSize,l.FLOAT,!1,0,0),l.bindBuffer(l.ARRAY_BUFFER,this._offsetBuffer),l.vertexAttribPointer(o.a_offset,this._offsetBuffer.itemSize,l.FLOAT,!1,0,0),l.bindBuffer(l.ARRAY_BUFFER,this._fontIndexBuffer),l.vertexAttribPointer(o.a_fontIndex,this._fontIndexBuffer.itemSize,l.FLOAT,!1,0,0),l.uniform1i(a.isOutlinePass,1),l.uniform1f(a.depthOffset,c.polygonOffsetUnits),l.bindBuffer(l.ARRAY_BUFFER,this._outlineColorBuffer),l.vertexAttribPointer(o.a_rgba,this._outlineColorBuffer.itemSize,l.FLOAT,!1,0,0),l.bindBuffer(l.ARRAY_BUFFER,this._outlineBuffer),l.vertexAttribPointer(o.a_outline,this._outlineBuffer.itemSize,l.FLOAT,!1,0,0),l.drawArrays(l.TRIANGLES,0,this._vertexBuffer.numItems),l.depthFunc(l.EQUAL),l.uniform1i(a.isOutlinePass,0),l.uniform1f(a.depthOffset,c.polygonOffsetUnits),l.bindBuffer(l.ARRAY_BUFFER,this._rgbaBuffer),l.vertexAttribPointer(o.a_rgba,this._rgbaBuffer.itemSize,l.FLOAT,!1,0,0),l.drawArrays(l.TRIANGLES,0,this._vertexBuffer.numItems),l.depthFunc(l.LESS),l.enable(l.CULL_FACE)}_pickingPASS(){let t=this._renderer,s=t.handler;s.programs.labelPicking.activate();let n=s.programs.labelPicking._program,o=n.attributes,a=n.uniforms,l=s.gl,c=this._entityCollection,d=c.renderNode;l.disable(l.CULL_FACE),l.uniformMatrix4fv(a.viewMatrix,!1,t.activeCamera.getViewMatrix()),l.uniformMatrix4fv(a.projectionMatrix,!1,t.activeCamera.getProjectionMatrix()),l.uniform3fv(a.eyePositionHigh,t.activeCamera.eyeHigh),l.uniform3fv(a.eyePositionLow,t.activeCamera.eyeLow),l.uniform3fv(a.scaleByDistance,c.scaleByDistance),l.uniform1f(a.opacity,c._fadingOpacity),l.uniform1f(a.planetRadius,d._planetRadius2||0),l.uniform2fv(a.viewport,[s.canvas.clientWidth,s.canvas.clientHeight]),l.bindBuffer(l.ARRAY_BUFFER,this._texCoordBuffer),l.vertexAttribPointer(o.a_texCoord,this._texCoordBuffer.itemSize,l.FLOAT,!1,0,0),l.bindBuffer(l.ARRAY_BUFFER,this._gliphParamBuffer),l.vertexAttribPointer(o.a_gliphParam,this._gliphParamBuffer.itemSize,l.FLOAT,!1,0,0),l.bindBuffer(l.ARRAY_BUFFER,this._vertexBuffer),l.vertexAttribPointer(o.a_vertices,this._vertexBuffer.itemSize,l.FLOAT,!1,0,0),l.bindBuffer(l.ARRAY_BUFFER,this._positionHighBuffer),l.vertexAttribPointer(o.a_positionsHigh,this._positionHighBuffer.itemSize,l.FLOAT,!1,0,0),l.bindBuffer(l.ARRAY_BUFFER,this._positionLowBuffer),l.vertexAttribPointer(o.a_positionsLow,this._positionLowBuffer.itemSize,l.FLOAT,!1,0,0),l.bindBuffer(l.ARRAY_BUFFER,this._sizeBuffer),l.vertexAttribPointer(o.a_size,this._sizeBuffer.itemSize,l.FLOAT,!1,0,0),l.bindBuffer(l.ARRAY_BUFFER,this._rotationBuffer),l.vertexAttribPointer(o.a_rotation,this._rotationBuffer.itemSize,l.FLOAT,!1,0,0),l.bindBuffer(l.ARRAY_BUFFER,this._offsetBuffer),l.vertexAttribPointer(o.a_offset,this._offsetBuffer.itemSize,l.FLOAT,!1,0,0),l.bindBuffer(l.ARRAY_BUFFER,this._pickingColorBuffer),l.vertexAttribPointer(o.a_rgba,this._pickingColorBuffer.itemSize,l.FLOAT,!1,0,0),l.uniform1f(a.depthOffset,c.polygonOffsetUnits),l.drawArrays(l.TRIANGLES,0,this._vertexBuffer.numItems),l.enable(l.CULL_FACE)}_removeBillboard(t){let s=t._handlerIndex;this._billboards.splice(s,1);let n=24*this._maxLetters,o=s*n;this._rgbaArr=ot(this._rgbaArr,o,n),this._outlineColorArr=ot(this._outlineColorArr,o,n),this._texCoordArr=ot(this._texCoordArr,o,n),this._gliphParamArr=ot(this._gliphParamArr,o,n),n=18*this._maxLetters,o=s*n,this._positionHighArr=ot(this._positionHighArr,o,n),this._positionLowArr=ot(this._positionLowArr,o,n),this._offsetArr=ot(this._offsetArr,o,n),this._pickingColorArr=ot(this._pickingColorArr,o,n),n=12*this._maxLetters,o=s*n,this._vertexArr=ot(this._vertexArr,o,n),n=6*this._maxLetters,o=s*n,this._sizeArr=ot(this._sizeArr,o,n),this._rotationArr=ot(this._rotationArr,o,n),this._fontIndexArr=ot(this._fontIndexArr,o,n),this._outlineArr=ot(this._outlineArr,o,n),this.reindexBillboardsArray(s),this.refresh(),t._handlerIndex=-1,t._handler=null,t._isReady=!1}setText(t,s,n,o,a=0,l=!1){s=s.normalize("NFKC");let c=this._renderer.fontAtlas.atlasesArr[n];if(!c)return;let d=24*t*this._maxLetters,u=this._texCoordArr,_=this._gliphParamArr,f=0,g=Math.min(this._maxLetters,s.length),m=0;l&&(m=1);let p=0,x=c.kernings;for(f=0;f<g;f++){let y=d+24*f,w=s[f],C=c.get(w.charCodeAt(0))||c.get(32);if(!C)continue;let T=C.texCoords,P=C.metrics;u[y]=T[0],u[y+1]=T[1],u[y+2]=p,u[y+3]=m,u[y+4]=T[2],u[y+5]=T[3],u[y+6]=p,u[y+7]=m,u[y+8]=T[4],u[y+9]=T[5],u[y+10]=p,u[y+11]=m,u[y+12]=T[6],u[y+13]=T[7],u[y+14]=p,u[y+15]=m,u[y+16]=T[8],u[y+17]=T[9],u[y+18]=p,u[y+19]=m,u[y+20]=T[10],u[y+21]=T[11],u[y+22]=p,u[y+23]=m,_[y]=P.nWidth,_[y+1]=P.nHeight,_[y+2]=P.nXOffset,_[y+3]=P.nYOffset,_[y+4]=P.nWidth,_[y+5]=P.nHeight,_[y+6]=P.nXOffset,_[y+7]=P.nYOffset,_[y+8]=P.nWidth,_[y+9]=P.nHeight,_[y+10]=P.nXOffset,_[y+11]=P.nYOffset,_[y+12]=P.nWidth,_[y+13]=P.nHeight,_[y+14]=P.nXOffset,_[y+15]=P.nYOffset,_[y+16]=P.nWidth,_[y+17]=P.nHeight,_[y+18]=P.nXOffset,_[y+19]=P.nYOffset,_[y+20]=P.nWidth,_[y+21]=P.nHeight,_[y+22]=P.nXOffset,_[y+23]=P.nYOffset;let E=x[w.charCodeAt(0)];if(E&&s[f+1]){let S=E[s[f+1].charCodeAt(0)];p+=S?P.nAdvance+S+a:P.nAdvance+a}else p+=P.nAdvance+a}if(o===_i.CENTER)for(p*=-.5,f=0;f<g;f++){let y=d+24*f;u[y+2]+=p,u[y+6]+=p,u[y+10]+=p,u[y+14]+=p,u[y+18]+=p,u[y+22]+=p}for(;f<this._maxLetters;f++){let y=d+24*f;u[y+3]=-1,u[y+7]=-1,u[y+11]=-1,u[y+15]=-1,u[y+19]=-1,u[y+23]=-1}this._changedBuffers[6]=!0}setPositionArr(t,s,n){let o=18*t*this._maxLetters,a=this._positionHighArr,l=s.x,c=s.y,d=s.z,u=this._positionLowArr,_=n.x,f=n.y,g=n.z;for(let m=0;m<this._maxLetters;m++){let p=o+18*m;a[p]=l,a[p+1]=c,a[p+2]=d,a[p+3]=l,a[p+4]=c,a[p+5]=d,a[p+6]=l,a[p+7]=c,a[p+8]=d,a[p+9]=l,a[p+10]=c,a[p+11]=d,a[p+12]=l,a[p+13]=c,a[p+14]=d,a[p+15]=l,a[p+16]=c,a[p+17]=d,u[p]=_,u[p+1]=f,u[p+2]=g,u[p+3]=_,u[p+4]=f,u[p+5]=g,u[p+6]=_,u[p+7]=f,u[p+8]=g,u[p+9]=_,u[p+10]=f,u[p+11]=g,u[p+12]=_,u[p+13]=f,u[p+14]=g,u[p+15]=_,u[p+16]=f,u[p+17]=g}this._changedBuffers[1]=!0}setPickingColorArr(t,s){let n=18*t*this._maxLetters,o=this._pickingColorArr,a=s.x/255,l=s.y/255,c=s.z/255;for(let d=0;d<this._maxLetters;d++){let u=n+18*d;o[u]=a,o[u+1]=l,o[u+2]=c,o[u+3]=a,o[u+4]=l,o[u+5]=c,o[u+6]=a,o[u+7]=l,o[u+8]=c,o[u+9]=a,o[u+10]=l,o[u+11]=c,o[u+12]=a,o[u+13]=l,o[u+14]=c,o[u+15]=a,o[u+16]=l,o[u+17]=c}this._changedBuffers[0]=!0}setSizeArr(t,s){let n=6*t*this._maxLetters,o=this._sizeArr;for(let a=0;a<this._maxLetters;a++){let l=n+6*a;o[l]=s,o[l+1]=s,o[l+2]=s,o[l+3]=s,o[l+4]=s,o[l+5]=s}this._changedBuffers[2]=!0}setOffsetArr(t,s){let n=18*t*this._maxLetters,o=this._offsetArr,a=s.x,l=s.y,c=s.z;for(let d=0;d<this._maxLetters;d++){let u=n+18*d;o[u]=a,o[u+1]=l,o[u+2]=c,o[u+3]=a,o[u+4]=l,o[u+5]=c,o[u+6]=a,o[u+7]=l,o[u+8]=c,o[u+9]=a,o[u+10]=l,o[u+11]=c,o[u+12]=a,o[u+13]=l,o[u+14]=c,o[u+15]=a,o[u+16]=l,o[u+17]=c}this._changedBuffers[3]=!0}setRgbaArr(t,s){let n=24*t*this._maxLetters,o=this._rgbaArr,a=s.x,l=s.y,c=s.z,d=s.w;for(let u=0;u<this._maxLetters;u++){let _=n+24*u;o[_]=a,o[_+1]=l,o[_+2]=c,o[_+3]=d,o[_+4]=a,o[_+5]=l,o[_+6]=c,o[_+7]=d,o[_+8]=a,o[_+9]=l,o[_+10]=c,o[_+11]=d,o[_+12]=a,o[_+13]=l,o[_+14]=c,o[_+15]=d,o[_+16]=a,o[_+17]=l,o[_+18]=c,o[_+19]=d,o[_+20]=a,o[_+21]=l,o[_+22]=c,o[_+23]=d}this._changedBuffers[4]=!0}setOutlineColorArr(t,s){let n=24*t*this._maxLetters,o=this._outlineColorArr,a=s.x,l=s.y,c=s.z,d=s.w;for(let u=0;u<this._maxLetters;u++){let _=n+24*u;o[_]=a,o[_+1]=l,o[_+2]=c,o[_+3]=d,o[_+4]=a,o[_+5]=l,o[_+6]=c,o[_+7]=d,o[_+8]=a,o[_+9]=l,o[_+10]=c,o[_+11]=d,o[_+12]=a,o[_+13]=l,o[_+14]=c,o[_+15]=d,o[_+16]=a,o[_+17]=l,o[_+18]=c,o[_+19]=d,o[_+20]=a,o[_+21]=l,o[_+22]=c,o[_+23]=d}this._changedBuffers[10]=!0}setOutlineArr(t,s){let n=6*t*this._maxLetters,o=this._outlineArr;for(let a=0;a<this._maxLetters;a++){let l=n+6*a;o[l]=s,o[l+1]=s,o[l+2]=s,o[l+3]=s,o[l+4]=s,o[l+5]=s}this._changedBuffers[9]=!0}setRotationArr(t,s){let n=6*t*this._maxLetters,o=this._rotationArr;for(let a=0;a<this._maxLetters;a++){let l=n+6*a;o[l]=s,o[l+1]=s,o[l+2]=s,o[l+3]=s,o[l+4]=s,o[l+5]=s}this._changedBuffers[5]=!0}setVisibility(t,s){let n;n=s?[0,0,0,-1,1,-1,1,-1,1,0,0,0]:[0,0,0,0,0,0,0,0,0,0,0,0],this.setVertexArr(t,n)}setVertexArr(t,s){let n=12*t*this._maxLetters,o=this._vertexArr;for(let a=0;a<this._maxLetters;a++){let l=n+12*a;o[l]=s[0],o[l+1]=s[1],o[l+2]=s[2],o[l+3]=s[3],o[l+4]=s[4],o[l+5]=s[5],o[l+6]=s[6],o[l+7]=s[7],o[l+8]=s[8],o[l+9]=s[9],o[l+10]=s[10],o[l+11]=s[11]}this._changedBuffers[7]=!0}setFontIndexArr(t,s){let n=6*t*this._maxLetters,o=this._fontIndexArr;for(let a=0;a<this._maxLetters;a++){let l=n+6*a;o[l]=s,o[l+1]=s,o[l+2]=s,o[l+3]=s,o[l+4]=s,o[l+5]=s}this._changedBuffers[8]=!0}createSizeBuffer(){let t=this._renderer.handler;t.gl.deleteBuffer(this._sizeBuffer),this._sizeBuffer=t.createArrayBuffer(this._sizeArr,1,this._sizeArr.length)}createFontIndexBuffer(){let t=this._renderer.handler;t.gl.deleteBuffer(this._fontIndexBuffer),this._fontIndexBuffer=t.createArrayBuffer(this._fontIndexArr,1,this._fontIndexArr.length)}createTexCoordBuffer(){let t=this._renderer.handler;t.gl.deleteBuffer(this._texCoordBuffer),this._texCoordBuffer=t.createArrayBuffer(this._texCoordArr,4,this._texCoordArr.length/4),t.gl.deleteBuffer(this._gliphParamBuffer),this._gliphParamBuffer=t.createArrayBuffer(this._gliphParamArr,4,this._gliphParamArr.length/4)}createOutlineBuffer(){let t=this._renderer.handler;t.gl.deleteBuffer(this._outlineBuffer),this._outlineBuffer=t.createArrayBuffer(this._outlineArr,1,this._outlineArr.length)}createOutlineColorBuffer(){let t=this._renderer.handler;t.gl.deleteBuffer(this._outlineColorBuffer),this._outlineColorBuffer=t.createArrayBuffer(this._outlineColorArr,4,this._outlineColorArr.length/4)}setMaxLetters(t){this._maxLetters=t}}const Ts=class md{constructor(t){this.pickingEnabled=!0,this.__id=md.__counter__++,this.pickingEnabled=!0,this._entityCollection=t,this._renderer=null,this._pointClouds=[]}_initProgram(){this._renderer&&this._renderer.handler&&(this._renderer.handler.programs.pointCloud||this._renderer.handler.addProgram(new X("pointCloud",{uniforms:{projectionViewMatrix:"mat4",opacity:"float",pointSize:"float"},attributes:{coordinates:"vec3",colors:"vec3"},vertexShader:`attribute vec3 coordinates;
            attribute vec4 colors;
            uniform mat4 projectionViewMatrix;
            uniform float opacity;
            uniform float pointSize;
            varying vec4 color;
            void main() {
                color = colors;
                color.a *= opacity;
                gl_Position = projectionViewMatrix * vec4(coordinates, 1.0);
                gl_PointSize = pointSize;
            }`,fragmentShader:`precision highp float;
            varying vec4 color;
            void main(void) {
                gl_FragColor = color;
            }`})))}setRenderNode(t){this._renderer=t.renderer,this._initProgram();for(let s=0;s<this._pointClouds.length;s++)this._pointClouds[s].setRenderNode(t)}add(t){t._handlerIndex===-1&&(t._handler=this,t._handlerIndex=this._pointClouds.length,this._pointClouds.push(t),this._entityCollection&&this._entityCollection.renderNode&&t.setRenderNode(this._entityCollection.renderNode))}remove(t){let s=t._handlerIndex;s!==-1&&(t._deleteBuffers(),t._handlerIndex=-1,t._handler=null,this._pointClouds.splice(s,1),this._reindexPointCloudArray(s))}_reindexPointCloudArray(t){let s=this._pointClouds;for(let n=t;n<s.length;n++)s[n]._handlerIndex=n}draw(){let t=this._pointClouds.length;for(;t--;)this._pointClouds[t].draw()}drawPicking(){if(this.pickingEnabled){let t=this._pointClouds.length;for(;t--;)this._pointClouds[t].drawPicking()}}clear(){let t=this._pointClouds.length;for(;t--;)this._pointClouds[t]._deleteBuffers(),this._pointClouds[t]._handler=null,this._pointClouds[t]._handlerIndex=-1;this._pointClouds.length=0,this._pointClouds=[]}};Ts.__counter__=0;let Lr=Ts;const Cs=class vd{constructor(t){this.__id=vd.__counter__++,this._entityCollection=t,this._renderer=null,this._polylines=[],this.pickingEnabled=!0,this._relativeCenter=new v,this._rtcEyePositionHigh=new Float32Array([0,0,0]),this._rtcEyePositionLow=new Float32Array([0,0,0])}_initProgram(){this._renderer&&this._renderer.handler&&(this._renderer.handler.programs.polyline_screen||this._renderer.handler.addProgram(new X("polyline_screen",{uniforms:{viewport:"vec2",proj:"mat4",view:"mat4",rtcEyePositionHigh:"vec3",rtcEyePositionLow:"vec3",thickness:"float",opacity:"float",depthOffset:"float",visibleSphere:"vec4",texAtlas:"sampler2d",strokeSize:"float",texOffset:"float"},attributes:{prevHigh:"vec3",currentHigh:"vec3",nextHigh:"vec3",prevLow:"vec3",currentLow:"vec3",nextLow:"vec3",order:"float",color:"vec4",texCoord:"vec4"},vertexShader:`#version 300 es
precision highp float;in vec3 prevHigh;in vec3 currentHigh;in vec3 nextHigh;in vec3 prevLow;in vec3 currentLow;in vec3 nextLow;in vec4 texCoord;in float order;in vec4 color;uniform float thickness;uniform mat4 proj;uniform mat4 view;uniform vec2 viewport;uniform vec3 rtcEyePositionHigh;uniform vec3 rtcEyePositionLow;uniform float opacity;uniform float depthOffset;uniform float strokeSize;uniform float texOffset;out vec4 v_rgba;out vec3 vPos;out vec3 uCamPos;out vec4 vTexCoord;flat out float repeat;flat out float v_texOffset;const float NEAR=-1.0;vec2 getIntersection(vec2 start1,vec2 end1,vec2 start2,vec2 end2){vec2 dir=end2-start2;vec2 perp=vec2(-dir.y,dir.x);float d2=dot(perp,start2);float seg=dot(perp,start1)-d2;float prl=seg-dot(perp,end1)+d2;if(prl>-1.0&&prl<1.0){return start1;}float u=seg/prl;return start1+u*(end1-start1);}vec2 project(vec4 p){return(0.5*p.xyz/p.w+0.5).xy*viewport;}void main(){uCamPos=rtcEyePositionHigh+rtcEyePositionLow;vPos=currentHigh+currentLow;v_rgba=vec4(color.rgb,color.a*opacity);mat4 viewMatrixRTE=view;viewMatrixRTE[3]=vec4(0.0,0.0,0.0,1.0);vec3 highDiff,lowDiff;highDiff=currentHigh-rtcEyePositionHigh;highDiff=highDiff*step(1.0,length(highDiff));lowDiff=currentLow-rtcEyePositionLow;vec4 vCurrent=viewMatrixRTE*vec4(highDiff+lowDiff,1.0);highDiff=prevHigh-rtcEyePositionHigh;highDiff=highDiff*step(1.0,length(highDiff));lowDiff=prevLow-rtcEyePositionLow;vec4 vPrev=viewMatrixRTE*vec4(highDiff+lowDiff,1.0);highDiff=nextHigh-rtcEyePositionHigh;highDiff=highDiff*step(1.0,length(highDiff));lowDiff=nextLow-rtcEyePositionLow;vec4 vNext=viewMatrixRTE*vec4(highDiff+lowDiff,1.0);if(vCurrent.z>NEAR){if(vPrev.z<NEAR&&abs(order)==1.0){vCurrent=vPrev+(vCurrent-vPrev)*(NEAR-vPrev.z)/(vCurrent.z-vPrev.z);}else if(vNext.z<NEAR&&abs(order)==2.0){vCurrent=vNext+(vCurrent-vNext)*(NEAR-vNext.z)/(vCurrent.z-vNext.z);}}vec4 dCurrent=proj*vCurrent;vec2 _next=project(proj*vNext);vec2 _prev=project(proj*vPrev);vec2 _current=project(dCurrent);if(_prev==_current){if(_next==_current){_next=_current+vec2(1.0,0.0);_prev=_current-_next;}else{_prev=_current+normalize(_current-_next);}}if(_next==_current){_next=_current+normalize(_current-_prev);}vec2 sNext=_next,sCurrent=_current,sPrev=_prev;vec2 dirNext=normalize(sNext-sCurrent);vec2 dirPrev=normalize(sPrev-sCurrent);float dotNP=dot(dirNext,dirPrev);vec2 normalNext=normalize(vec2(-dirNext.y,dirNext.x));vec2 normalPrev=normalize(vec2(dirPrev.y,-dirPrev.x));float d=thickness*sign(order);vTexCoord=texCoord;vec2 m;if(dotNP>=0.99991){m=sCurrent-normalPrev*d;}else{m=getIntersection(sCurrent+normalPrev*d,sPrev+normalPrev*d,sCurrent+normalNext*d,sNext+normalNext*d);if(dotNP>0.5&&dot(dirNext+dirPrev,m-sCurrent)<0.0){float occw=order*sign(dirNext.x*dirPrev.y-dirNext.y*dirPrev.x);if(occw==-1.0){m=sCurrent+normalPrev*d;}else if(occw==1.0){m=sCurrent+normalNext*d;}else if(occw==-2.0){m=sCurrent+normalNext*d;}else if(occw==2.0){m=sCurrent+normalPrev*d;}}else if(distance(sCurrent,m)>min(distance(sCurrent,sNext),distance(sCurrent,sPrev))){m=sCurrent+normalNext*d;}}repeat=min(distance(sCurrent,sPrev),viewport.y)/strokeSize;v_texOffset=texOffset;gl_Position=vec4((2.0*m/viewport-1.0)*dCurrent.w,dCurrent.z+depthOffset,dCurrent.w);}`,fragmentShader:`#version 300 es
precision highp float;uniform sampler2D texAtlas;uniform vec4 visibleSphere;in vec3 uCamPos;in vec4 v_rgba;in vec3 vPos;in vec4 vTexCoord;flat in float repeat;flat in float v_texOffset;out vec4 fragColor;void main(){if(visibleSphere.w!=0.0){vec3 cam_dir=normalize(vPos-uCamPos);vec3 sph_dir=normalize(vPos-visibleSphere.xyz);if(dot(cam_dir,sph_dir)>0.11){discard;}}float height=vTexCoord.w;if(height==0.0){fragColor=vec4(v_rgba.rgb,v_rgba.a);}else{vec2 uv=vTexCoord.xy;float min=vTexCoord.z;float EPS=0.5/1024.0;float localY=fract((uv.y+v_texOffset-min)/height*repeat);uv.y=clamp(min+localY*height,min+EPS,min+height-EPS);vec4 color=texture(texAtlas,uv);color.a*=v_rgba.a;fragColor=color;}}`})),this._renderer.handler.programs.polyline_picking||this._renderer.handler.addProgram(new X("polyline_picking",{uniforms:{viewport:"vec2",proj:"mat4",view:"mat4",rtcEyePositionHigh:"vec3",rtcEyePositionLow:"vec3",color:"vec4",thickness:"float",depthOffset:"float",visibleSphere:"vec4"},attributes:{prevHigh:"vec3",currentHigh:"vec3",nextHigh:"vec3",prevLow:"vec3",currentLow:"vec3",nextLow:"vec3",order:"float"},vertexShader:"precision highp float;attribute vec3 prevHigh;attribute vec3 currentHigh;attribute vec3 nextHigh;attribute vec3 prevLow;attribute vec3 currentLow;attribute vec3 nextLow;attribute float order;uniform float thickness;uniform vec4 color;uniform mat4 proj;uniform mat4 view;uniform vec2 viewport;uniform vec3 rtcEyePositionHigh;uniform vec3 rtcEyePositionLow;uniform float depthOffset;varying vec4 vColor;varying vec3 vPos;varying vec3 uCamPos;const float NEAR=-1.0;vec2 getIntersection(vec2 start1,vec2 end1,vec2 start2,vec2 end2){vec2 dir=end2-start2;vec2 perp=vec2(-dir.y,dir.x);float d2=dot(perp,start2);float seg=dot(perp,start1)-d2;float prl=seg-dot(perp,end1)+d2;if(prl>-1.0&&prl<1.0){return start1;}float u=seg/prl;return start1+u*(end1-start1);}vec2 project(vec4 p){return(0.5*p.xyz/p.w+0.5).xy*viewport;}void main(){uCamPos=rtcEyePositionHigh+rtcEyePositionLow;vPos=currentHigh+currentLow;vColor=color;vec3 highDiff,lowDiff;mat4 viewMatrixRTE=view;viewMatrixRTE[3]=vec4(0.0,0.0,0.0,1.0);highDiff=currentHigh-rtcEyePositionHigh;highDiff=highDiff*step(1.0,length(highDiff));lowDiff=currentLow-rtcEyePositionLow;vec4 vCurrent=viewMatrixRTE*vec4(highDiff+lowDiff,1.0);highDiff=prevHigh-rtcEyePositionHigh;highDiff=highDiff*step(1.0,length(highDiff));lowDiff=prevLow-rtcEyePositionLow;vec4 vPrev=viewMatrixRTE*vec4(highDiff+lowDiff,1.0);highDiff=nextHigh-rtcEyePositionHigh;highDiff=highDiff*step(1.0,length(highDiff));lowDiff=nextLow-rtcEyePositionLow;vec4 vNext=viewMatrixRTE*vec4(highDiff+lowDiff,1.0);if(vCurrent.z>NEAR){if(vPrev.z<NEAR&&abs(order)==1.0){vCurrent=vPrev+(vCurrent-vPrev)*(NEAR-vPrev.z)/(vCurrent.z-vPrev.z);}else if(vNext.z<NEAR&&abs(order)==2.0){vCurrent=vNext+(vCurrent-vNext)*(NEAR-vNext.z)/(vCurrent.z-vNext.z);}}vec4 dCurrent=proj*vCurrent;vec2 _next=project(proj*vNext);vec2 _prev=project(proj*vPrev);vec2 _current=project(dCurrent);if(_prev==_current){if(_next==_current){_next=_current+vec2(1.0,0.0);_prev=_current-_next;}else{_prev=_current+normalize(_current-_next);}}if(_next==_current){_next=_current+normalize(_current-_prev);}vec2 sNext=_next,sCurrent=_current,sPrev=_prev;vec2 dirNext=normalize(sNext-sCurrent);vec2 dirPrev=normalize(sPrev-sCurrent);float dotNP=dot(dirNext,dirPrev);vec2 normalNext=normalize(vec2(-dirNext.y,dirNext.x));vec2 normalPrev=normalize(vec2(dirPrev.y,-dirPrev.x));float d=thickness*sign(order);vec2 m;if(dotNP>=0.99991){m=sCurrent-normalPrev*d;}else{m=getIntersection(sCurrent+normalPrev*d,sPrev+normalPrev*d,sCurrent+normalNext*d,sNext+normalNext*d);if(dotNP>0.5&&dot(dirNext+dirPrev,m-sCurrent)<0.0){float occw=order*sign(dirNext.x*dirPrev.y-dirNext.y*dirPrev.x);if(occw==-1.0){m=sCurrent+normalPrev*d;}else if(occw==1.0){m=sCurrent+normalNext*d;}else if(occw==-2.0){m=sCurrent+normalNext*d;}else if(occw==2.0){m=sCurrent+normalPrev*d;}}else if(distance(sCurrent,m)>min(distance(sCurrent,sNext),distance(sCurrent,sPrev))){m=sCurrent+normalNext*d;}}gl_Position=vec4((2.0*m/viewport-1.0)*dCurrent.w,dCurrent.z+depthOffset,dCurrent.w);}",fragmentShader:"precision highp float;uniform vec4 visibleSphere;varying vec3 uCamPos;varying vec4 vColor;varying vec3 vPos;void main(){if(visibleSphere.w!=0.0){vec3 cam_dir=normalize(vPos-uCamPos);vec3 sph_dir=normalize(vPos-visibleSphere.xyz);if(dot(cam_dir,sph_dir)>0.11){discard;}}gl_FragColor=vec4(vColor.rgb,vColor.a);}"})))}setRenderNode(t){this._renderer=t.renderer,this._initProgram();for(let s=0;s<this._polylines.length;s++)this._polylines[s].setRenderNode(t)}add(t){t._handlerIndex===-1&&(t._handler=this,t._handlerIndex=this._polylines.length,t.__doubleToTwoFloats=this.getRTCPosition.bind(this),this._polylines.push(t),this._entityCollection&&this._entityCollection.renderNode&&(t.setRenderNode(this._entityCollection.renderNode),t.updateRTCPosition()))}remove(t){let s=t._handlerIndex;s!==-1&&(t._deleteBuffers(),t._handlerIndex=-1,t._handler=null,this._polylines.splice(s,1),this.reindexPolylineArray(s))}reindexPolylineArray(t){let s=this._polylines;for(let n=t;n<s.length;n++)s[n]._handlerIndex=n}draw(){this._updateRTCEyePosition();let t=this._polylines.length;for(;t--;)this._polylines[t].draw()}drawPicking(){if(this.pickingEnabled){let t=this._polylines.length;for(;t--;)this._polylines[t].drawPicking()}}clear(){let t=this._polylines.length;for(;t--;)this._polylines[t]._deleteBuffers(),this._polylines[t]._handler=null,this._polylines[t]._handlerIndex=-1;this._polylines.length=0,this._polylines=[]}getRTCPosition(t,s,n){let o=t.sub(this._relativeCenter);v.doubleToTwoFloats(o,s,n)}setRelativeCenter(t){this._relativeCenter.copy(t);for(let s=0;s<this._polylines.length;s++)this._polylines[s].updateRTCPosition()}_updateRTCEyePosition(){let t=this._renderer;if(t.activeCamera.isFirstPass){let s=t.activeCamera.eye.sub(this._relativeCenter);v.doubleToTwoFloat32Array(s,this._rtcEyePositionHigh,this._rtcEyePositionLow)}}reloadTextures(){for(let t=0;t<this._polylines.length;t++){let s=this._polylines[t];s.setSrc(s.getSrc())}}get polylines(){return[...this._polylines]}refreshTexCoordsArr(){if(this._entityCollection&&this._renderer){let t=this._renderer.strokeTextureAtlas;for(let s=0;s<this._polylines.length;s++){let n=this._polylines[s],o=n.getImage();if(o){let a=t.get(o.__nodeIndex);a&&n._setTexCoordArr(a.texCoords)}}}}};Cs.__counter__=0;let Pr=Cs;const Es=class yd{constructor(t){this.__id=yd.__counter__++,this.pickingEnabled=!0,this._entityCollection=t,this._renderer=null,this._rays=[],this._vertexBuffer=null,this._startPositionHighBuffer=null,this._startPositionLowBuffer=null,this._endPositionHighBuffer=null,this._endPositionLowBuffer=null,this._thicknessBuffer=null,this._rgbaBuffer=null,this._pickingColorBuffer=null,this._texCoordBuffer=null,this._texOffsetBuffer=null,this._strokeSizeBuffer=null,this._vertexArr=[],this._startPositionHighArr=[],this._startPositionLowArr=[],this._endPositionHighArr=[],this._endPositionLowArr=[],this._thicknessArr=[],this._rgbaArr=[],this._pickingColorArr=[],this._texCoordArr=new Float32Array([]),this._texOffsetArr=new Float32Array([]),this._strokeSizeArr=new Float32Array([]),this._buffersUpdateCallbacks=[],this._buffersUpdateCallbacks[5]=this.createVertexBuffer,this._buffersUpdateCallbacks[1]=this.createStartPositionBuffer,this._buffersUpdateCallbacks[2]=this.createEndPositionBuffer,this._buffersUpdateCallbacks[4]=this.createThicknessBuffer,this._buffersUpdateCallbacks[3]=this.createRgbaBuffer,this._buffersUpdateCallbacks[0]=this.createPickingColorBuffer,this._buffersUpdateCallbacks[6]=this.createTexCoordBuffer,this._buffersUpdateCallbacks[7]=this.createTexOffsetBuffer,this._buffersUpdateCallbacks[8]=this.createStrokeSizeBuffer,this._changedBuffers=new Array(this._buffersUpdateCallbacks.length)}static concArr(t,s){for(let n=0;n<s.length;n++)t.push(s[n])}reloadTextures(){for(let t=0;t<this._rays.length;t++){let s=this._rays[t];s.setSrc(s.getSrc())}}get rays(){return[...this._rays]}initProgram(){this._renderer&&this._renderer.handler&&(this._renderer.handler.programs.rayScreen||this._renderer.handler.addProgram(new X("rayScreen",{uniforms:{projectionMatrix:"mat4",viewMatrix:"mat4",eyePositionHigh:"vec3",eyePositionLow:"vec3",resolution:"float",uOpacity:"float",texAtlas:"sampler2d",viewport:"vec2"},attributes:{a_vertices:"vec2",a_texCoord:"vec4",a_startPosHigh:"vec3",a_startPosLow:"vec3",a_endPosHigh:"vec3",a_endPosLow:"vec3",a_thickness:"float",a_rgba:"vec4",a_texOffset:"float",a_strokeSize:"float"},vertexShader:`#version 300 es
precision highp float;in vec4 a_rgba;in vec3 a_startPosHigh;in vec3 a_startPosLow;in vec3 a_endPosHigh;in vec3 a_endPosLow;in vec2 a_vertices;in float a_thickness;in vec4 a_texCoord;in float a_texOffset;in float a_strokeSize;out vec4 v_rgba;out vec4 v_texCoord;out float v_texOffset;flat out float repeat;uniform mat4 viewMatrix;uniform mat4 projectionMatrix;uniform vec3 eyePositionHigh;uniform vec3 eyePositionLow;uniform float resolution;uniform float uOpacity;uniform vec2 viewport;vec2 project(vec4 p){return(0.5*p.xyz/p.w+0.5).xy*viewport;}void main(){v_texOffset=a_texOffset;v_rgba=vec4(a_rgba.rgb,a_rgba.a*uOpacity);v_texCoord=a_texCoord;vec3 v=(a_endPosHigh-a_startPosHigh)+(a_endPosLow-a_startPosLow);vec3 look=(a_startPosHigh-eyePositionHigh)+(a_startPosLow-eyePositionLow)+v*a_vertices.y;vec3 up=normalize(v);vec3 right=normalize(cross(look,up));float dist=abs(dot(look,vec3(viewMatrix[0][2],viewMatrix[1][2],viewMatrix[2][2])));float focalSize=2.0*dist*resolution;vec3 vert=right*a_thickness*focalSize*a_vertices.x;vec3 highDiff;if(a_vertices.y==0.0){highDiff=a_startPosHigh-eyePositionHigh;vert+=a_startPosLow-eyePositionLow;}else{highDiff=a_endPosHigh-eyePositionHigh;vert+=a_endPosLow-eyePositionLow;}mat4 viewMatrixRTE=viewMatrix;viewMatrixRTE[3]=vec4(0.0,0.0,0.0,1.0);gl_Position=projectionMatrix*viewMatrixRTE*vec4(highDiff*step(1.0,length(highDiff))+vert,1.0);highDiff=a_startPosHigh-eyePositionHigh;highDiff=highDiff*step(1.0,length(highDiff));vec3 lowDiff=a_startPosLow-eyePositionLow;vec4 vStart=viewMatrixRTE*vec4(highDiff+lowDiff,1.0);highDiff=a_endPosHigh-eyePositionHigh;highDiff=highDiff*step(1.0,length(highDiff));lowDiff=a_endPosLow-eyePositionLow;vec4 vEnd=viewMatrixRTE*vec4(highDiff+lowDiff,1.0);vec2 nStart=project(projectionMatrix*vStart);vec2 nEnd=project(projectionMatrix*vEnd);repeat=min(distance(nStart,nEnd),viewport.y)/a_strokeSize;}`,fragmentShader:`#version 300 es
precision highp float;uniform sampler2D texAtlas;in vec4 v_rgba;in vec4 v_texCoord;in float v_texOffset;flat in float repeat;out vec4 fragColor;void main(){float height=v_texCoord.w;if(height==0.0){fragColor=v_rgba;}else{vec2 uv=v_texCoord.xy;float min=v_texCoord.z;float EPS=0.5/1024.0;float localY=fract((uv.y+v_texOffset-min)/height*repeat);uv.y=clamp(min+localY*height,min+EPS,min+height-EPS);vec4 color=texture(texAtlas,uv);fragColor=v_rgba*color;}}`})))}setRenderer(t){this._renderer=t,this.initProgram()}refresh(){let t=this._changedBuffers.length;for(;t--;)this._changedBuffers[t]=!0}_removeRays(){let t=this._rays.length;for(;t--;){let s=this._rays[t];s._handlerIndex=-1,s._handler=null}this._rays.length=0,this._rays=[]}clear(){this._vertexArr=null,this._startPositionHighArr=null,this._startPositionLowArr=null,this._endPositionHighArr=null,this._endPositionLowArr=null,this._thicknessArr=null,this._rgbaArr=null,this._texCoordArr=null,this._texOffsetArr=null,this._strokeSizeArr=null,this._vertexArr=new Float32Array([]),this._texCoordArr=new Float32Array([]),this._startPositionHighArr=new Float32Array([]),this._startPositionLowArr=new Float32Array([]),this._endPositionHighArr=new Float32Array([]),this._endPositionLowArr=new Float32Array([]),this._thicknessArr=new Float32Array([]),this._rgbaArr=new Float32Array([]),this._texOffsetArr=new Float32Array([]),this._strokeSizeArr=new Float32Array([]),this._removeRays(),this._deleteBuffers(),this.refresh()}_deleteBuffers(){if(this._renderer){let t=this._renderer.handler.gl;t&&(t.deleteBuffer(this._startPositionHighBuffer),t.deleteBuffer(this._startPositionLowBuffer),t.deleteBuffer(this._endPositionHighBuffer),t.deleteBuffer(this._endPositionLowBuffer),t.deleteBuffer(this._thicknessBuffer),t.deleteBuffer(this._rgbaBuffer),t.deleteBuffer(this._vertexBuffer),t.deleteBuffer(this._texCoordBuffer),t.deleteBuffer(this._texOffsetBuffer),t.deleteBuffer(this._strokeSizeBuffer)),this._startPositionHighBuffer=null,this._startPositionLowBuffer=null,this._endPositionHighBuffer=null,this._endPositionLowBuffer=null,this._thicknessBuffer=null,this._rgbaBuffer=null,this._vertexBuffer=null,this._texCoordBuffer=null,this._texOffsetBuffer=null,this._strokeSizeBuffer=null}}update(){if(this._renderer){let t=this._changedBuffers.length;for(;t--;)this._changedBuffers[t]&&(this._buffersUpdateCallbacks[t].call(this),this._changedBuffers[t]=!1)}}add(t){t._handlerIndex==-1&&(t._handler=this,t._handlerIndex=this._rays.length,this._rays.push(t),this._addRayToArrays(t),this.refresh())}_addRayToArrays(t){t.getVisibility()?this._vertexArr=bt(this._vertexArr,[-.5,1,-.5,0,.5,0,.5,0,.5,1,-.5,1]):this._vertexArr=bt(this._vertexArr,[0,0,0,0,0,0,0,0,0,0,0,0]);let s=t.texOffset;this._texOffsetArr=it(this._texOffsetArr,[s,s,s,s,s,s]),s=t.strokeSize,this._strokeSizeArr=it(this._strokeSizeArr,[s,s,s,s,s,s]),this._texCoordArr=it(this._texCoordArr,[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),s=t._startPositionHigh.x;let n=t._startPositionHigh.y,o=t._startPositionHigh.z;this._startPositionHighArr=bt(this._startPositionHighArr,[s,n,o,s,n,o,s,n,o,s,n,o,s,n,o,s,n,o]),s=t._startPositionLow.x,n=t._startPositionLow.y,o=t._startPositionLow.z,this._startPositionLowArr=bt(this._startPositionLowArr,[s,n,o,s,n,o,s,n,o,s,n,o,s,n,o,s,n,o]),s=t._endPositionHigh.x,n=t._endPositionHigh.y,o=t._endPositionHigh.z,this._endPositionHighArr=bt(this._endPositionHighArr,[s,n,o,s,n,o,s,n,o,s,n,o,s,n,o,s,n,o]),s=t._endPositionLow.x,n=t._endPositionLow.y,o=t._endPositionLow.z,this._endPositionLowArr=bt(this._endPositionLowArr,[s,n,o,s,n,o,s,n,o,s,n,o,s,n,o,s,n,o]),s=t._thickness,this._thicknessArr=bt(this._thicknessArr,[s,s,s,s,s,s]);let a=t._startColor.x,l=t._startColor.y,c=t._startColor.z,d=t._startColor.w,u=t._endColor.x,_=t._endColor.y,f=t._endColor.z,g=t._endColor.w;this._rgbaArr=bt(this._rgbaArr,[u,_,f,g,a,l,c,d,a,l,c,d,a,l,c,d,u,_,f,g,u,_,f,g]),s=t._entity._pickingColor.x/255,n=t._entity._pickingColor.y/255,o=t._entity._pickingColor.z/255,this._pickingColorArr=bt(this._pickingColorArr,[s,n,o,s,n,o,s,n,o,s,n,o,s,n,o,s,n,o])}_displayPASS(){let t=this._renderer,s=t.handler;s.programs.rayScreen.activate();let n=s.programs.rayScreen._program,o=n.attributes,a=n.uniforms,l=s.gl,c=this._entityCollection;l.disable(l.CULL_FACE),l.uniform1f(a.uOpacity,c._fadingOpacity),l.uniform1i(a.u_texAtlas,0),l.uniformMatrix4fv(a.viewMatrix,!1,t.activeCamera.getViewMatrix()),l.uniformMatrix4fv(a.projectionMatrix,!1,t.activeCamera.getProjectionMatrix()),l.uniform3fv(a.eyePositionHigh,t.activeCamera.eyeHigh),l.uniform3fv(a.eyePositionLow,t.activeCamera.eyeLow),l.uniform1f(a.resolution,t.activeCamera._tanViewAngle_hradOneByHeight),l.uniform2fv(a.viewport,[t.handler.canvas.width,t.handler.canvas.height]),l.bindBuffer(l.ARRAY_BUFFER,this._startPositionHighBuffer),l.vertexAttribPointer(o.a_startPosHigh,this._startPositionHighBuffer.itemSize,l.FLOAT,!1,0,0),l.bindBuffer(l.ARRAY_BUFFER,this._startPositionLowBuffer),l.vertexAttribPointer(o.a_startPosLow,this._startPositionLowBuffer.itemSize,l.FLOAT,!1,0,0),l.bindBuffer(l.ARRAY_BUFFER,this._endPositionHighBuffer),l.vertexAttribPointer(o.a_endPosHigh,this._endPositionHighBuffer.itemSize,l.FLOAT,!1,0,0),l.bindBuffer(l.ARRAY_BUFFER,this._endPositionLowBuffer),l.vertexAttribPointer(o.a_endPosLow,this._endPositionLowBuffer.itemSize,l.FLOAT,!1,0,0),l.bindBuffer(l.ARRAY_BUFFER,this._rgbaBuffer),l.vertexAttribPointer(o.a_rgba,this._rgbaBuffer.itemSize,l.FLOAT,!1,0,0),l.bindBuffer(l.ARRAY_BUFFER,this._thicknessBuffer),l.vertexAttribPointer(o.a_thickness,this._thicknessBuffer.itemSize,l.FLOAT,!1,0,0),l.bindBuffer(l.ARRAY_BUFFER,this._vertexBuffer),l.vertexAttribPointer(o.a_vertices,this._vertexBuffer.itemSize,l.FLOAT,!1,0,0),l.bindBuffer(l.ARRAY_BUFFER,this._texCoordBuffer),l.vertexAttribPointer(o.a_texCoord,this._texCoordBuffer.itemSize,l.FLOAT,!1,0,0),l.bindBuffer(l.ARRAY_BUFFER,this._texOffsetBuffer),l.vertexAttribPointer(o.a_texOffset,this._texOffsetBuffer.itemSize,l.FLOAT,!1,0,0),l.bindBuffer(l.ARRAY_BUFFER,this._strokeSizeBuffer),l.vertexAttribPointer(o.a_strokeSize,this._strokeSizeBuffer.itemSize,l.FLOAT,!1,0,0),l.drawArrays(l.TRIANGLES,0,this._vertexBuffer.numItems),l.enable(l.CULL_FACE)}_pickingPASS(){}draw(){this._rays.length&&(this.update(),this._displayPASS())}drawPicking(){this._rays.length&&this.pickingEnabled&&this._pickingPASS()}reindexRaysArray(t){let s=this._rays;for(let n=t;n<s.length;n++)s[n]._handlerIndex=n}_removeRay(t){let s=t._handlerIndex;this._rays.splice(s,1);let n=24*s;this._rgbaArr=Et(this._rgbaArr,n,24),this._texCoordArr=ot(this._texCoordArr,n,24),n=18*s,this._startPositionHighArr=Et(this._startPositionHighArr,n,18),this._startPositionLowArr=Et(this._startPositionLowArr,n,18),this._endPositionHighArr=Et(this._endPositionHighArr,n,18),this._endPositionLowArr=Et(this._endPositionLowArr,n,18),this._pickingColorArr=Et(this._pickingColorArr,n,18),n=12*s,this._vertexArr=Et(this._vertexArr,n,12),n=6*s,this._thicknessArr=Et(this._thicknessArr,n,6),this._texOffsetArr=ot(this._texOffsetArr,n,6),this._strokeSizeArr=ot(this._strokeSizeArr,n,6),this.reindexRaysArray(s),this.refresh(),t._handlerIndex=-1,t._handler=null}remove(t){t._handler&&this.__id===t._handler.__id&&this._removeRay(t)}setStartPositionArr(t,s,n){let o=18*t,a=this._startPositionHighArr,l=s.x,c=s.y,d=s.z;a[o]=l,a[o+1]=c,a[o+2]=d,a[o+3]=l,a[o+4]=c,a[o+5]=d,a[o+6]=l,a[o+7]=c,a[o+8]=d,a[o+9]=l,a[o+10]=c,a[o+11]=d,a[o+12]=l,a[o+13]=c,a[o+14]=d,a[o+15]=l,a[o+16]=c,a[o+17]=d,a=this._startPositionLowArr,l=n.x,c=n.y,d=n.z,a[o]=l,a[o+1]=c,a[o+2]=d,a[o+3]=l,a[o+4]=c,a[o+5]=d,a[o+6]=l,a[o+7]=c,a[o+8]=d,a[o+9]=l,a[o+10]=c,a[o+11]=d,a[o+12]=l,a[o+13]=c,a[o+14]=d,a[o+15]=l,a[o+16]=c,a[o+17]=d,this._changedBuffers[1]=!0}setEndPositionArr(t,s,n){let o=18*t,a=this._endPositionHighArr,l=s.x,c=s.y,d=s.z;a[o]=l,a[o+1]=c,a[o+2]=d,a[o+3]=l,a[o+4]=c,a[o+5]=d,a[o+6]=l,a[o+7]=c,a[o+8]=d,a[o+9]=l,a[o+10]=c,a[o+11]=d,a[o+12]=l,a[o+13]=c,a[o+14]=d,a[o+15]=l,a[o+16]=c,a[o+17]=d,a=this._endPositionLowArr,l=n.x,c=n.y,d=n.z,a[o]=l,a[o+1]=c,a[o+2]=d,a[o+3]=l,a[o+4]=c,a[o+5]=d,a[o+6]=l,a[o+7]=c,a[o+8]=d,a[o+9]=l,a[o+10]=c,a[o+11]=d,a[o+12]=l,a[o+13]=c,a[o+14]=d,a[o+15]=l,a[o+16]=c,a[o+17]=d,this._changedBuffers[2]=!0}setPickingColorArr(t,s){let n=18*t,o=this._pickingColorArr,a=s.x/255,l=s.y/255,c=s.z/255;o[n]=a,o[n+1]=l,o[n+2]=c,o[n+3]=a,o[n+4]=l,o[n+5]=c,o[n+6]=a,o[n+7]=l,o[n+8]=c,o[n+9]=a,o[n+10]=l,o[n+11]=c,o[n+12]=a,o[n+13]=l,o[n+14]=c,o[n+15]=a,o[n+16]=l,o[n+17]=c,this._changedBuffers[0]=!0}setRgbaArr(t,s,n){let o=24*t,a=this._rgbaArr,l=s.x,c=s.y,d=s.z,u=s.w,_=n.x,f=n.y,g=n.z,m=n.w;a[o]=_,a[o+1]=f,a[o+2]=g,a[o+3]=m,a[o+4]=l,a[o+5]=c,a[o+6]=d,a[o+7]=u,a[o+8]=l,a[o+9]=c,a[o+10]=d,a[o+11]=u,a[o+12]=l,a[o+13]=c,a[o+14]=d,a[o+15]=u,a[o+16]=_,a[o+17]=f,a[o+18]=g,a[o+19]=m,a[o+20]=_,a[o+21]=f,a[o+22]=g,a[o+23]=m,this._changedBuffers[3]=!0}setThicknessArr(t,s){let n=6*t,o=this._thicknessArr;o[n]=s,o[n+1]=s,o[n+2]=s,o[n+3]=s,o[n+4]=s,o[n+5]=s,this._changedBuffers[4]=!0}setVisibility(t,s){let n;n=s?[-.5,1,-.5,0,.5,0,.5,0,.5,1,-.5,1]:[0,0,0,0,0,0,0,0,0,0,0,0],this.setVertexArr(t,n)}setVertexArr(t,s){let n=12*t,o=this._vertexArr;o[n]=s[0],o[n+1]=s[1],o[n+2]=s[2],o[n+3]=s[3],o[n+4]=s[4],o[n+5]=s[5],o[n+6]=s[6],o[n+7]=s[7],o[n+8]=s[8],o[n+9]=s[9],o[n+10]=s[10],o[n+11]=s[11],this._changedBuffers[5]=!0}createStartPositionBuffer(){let t=this._renderer.handler;t.gl.deleteBuffer(this._startPositionHighBuffer),this._startPositionHighArr=st(this._startPositionHighArr),this._startPositionHighBuffer=t.createArrayBuffer(this._startPositionHighArr,3,this._startPositionHighArr.length/3,t.gl.DYNAMIC_DRAW),t.gl.deleteBuffer(this._startPositionLowBuffer),this._startPositionLowArr=st(this._startPositionLowArr),this._startPositionLowBuffer=t.createArrayBuffer(this._startPositionLowArr,3,this._startPositionLowArr.length/3,t.gl.DYNAMIC_DRAW)}createEndPositionBuffer(){let t=this._renderer.handler;t.gl.deleteBuffer(this._endPositionHighBuffer),this._endPositionHighArr=st(this._endPositionHighArr),this._endPositionHighBuffer=t.createArrayBuffer(this._endPositionHighArr,3,this._endPositionHighArr.length/3,t.gl.DYNAMIC_DRAW),t.gl.deleteBuffer(this._endPositionLowBuffer),this._endPositionLowArr=st(this._endPositionLowArr),this._endPositionLowBuffer=t.createArrayBuffer(this._endPositionLowArr,3,this._endPositionLowArr.length/3,t.gl.DYNAMIC_DRAW)}createRgbaBuffer(){let t=this._renderer.handler;t.gl.deleteBuffer(this._rgbaBuffer),this._rgbaArr=st(this._rgbaArr),this._rgbaBuffer=t.createArrayBuffer(this._rgbaArr,4,this._rgbaArr.length/4)}createThicknessBuffer(){let t=this._renderer.handler;t.gl.deleteBuffer(this._thicknessBuffer),this._thicknessArr=st(this._thicknessArr),this._thicknessBuffer=t.createArrayBuffer(this._thicknessArr,1,this._thicknessArr.length,t.gl.DYNAMIC_DRAW)}createVertexBuffer(){let t=this._renderer.handler;t.gl.deleteBuffer(this._vertexBuffer),this._vertexArr=st(this._vertexArr),this._vertexBuffer=t.createArrayBuffer(this._vertexArr,2,this._vertexArr.length/2,t.gl.DYNAMIC_DRAW)}createTexCoordBuffer(){let t=this._renderer.handler;t.gl.deleteBuffer(this._texCoordBuffer),this._texCoordBuffer=t.createArrayBuffer(this._texCoordArr,4,this._texCoordArr.length/4)}createTexOffsetBuffer(){let t=this._renderer.handler;t.gl.deleteBuffer(this._texOffsetBuffer),this._texOffsetBuffer=t.createArrayBuffer(this._texOffsetArr,1,this._texOffsetArr.length)}createStrokeSizeBuffer(){let t=this._renderer.handler;t.gl.deleteBuffer(this._strokeSizeBuffer),this._strokeSizeBuffer=t.createArrayBuffer(this._strokeSizeArr,1,this._strokeSizeArr.length)}createPickingColorBuffer(){let t=this._renderer.handler;t.gl.deleteBuffer(this._pickingColorBuffer),this._pickingColorArr=st(this._pickingColorArr),this._pickingColorBuffer=t.createArrayBuffer(this._pickingColorArr,3,this._pickingColorArr.length/3)}setTexCoordArr(t,s){let n=s[1],o=s[3]-n,a=24*t,l=this._texCoordArr;l[a]=s[0],l[a+1]=s[1],l[a+2]=n,l[a+3]=o,l[a+4]=s[2],l[a+5]=s[3],l[a+6]=n,l[a+7]=o,l[a+8]=s[4],l[a+9]=s[5],l[a+10]=n,l[a+11]=o,l[a+12]=s[6],l[a+13]=s[7],l[a+14]=n,l[a+15]=o,l[a+16]=s[8],l[a+17]=s[9],l[a+18]=n,l[a+19]=o,l[a+20]=s[10],l[a+21]=s[11],l[a+22]=n,l[a+23]=o,this._changedBuffers[6]=!0}setTextureDisabled(t){let s=24*t,n=this._texCoordArr;n[s+3]=0,n[s+7]=0,n[s+11]=0,n[s+15]=0,n[s+19]=0,n[s+23]=0,this._changedBuffers[6]=!0}setTexOffsetArr(t,s){let n=6*t,o=this._texOffsetArr;o[n]=s,o[n+1]=s,o[n+2]=s,o[n+3]=s,o[n+4]=s,o[n+5]=s,this._changedBuffers[7]=!0}setStrokeSizeArr(t,s){let n=6*t,o=this._strokeSizeArr;o[n]=s,o[n+1]=s,o[n+2]=s,o[n+3]=s,o[n+4]=s,o[n+5]=s,this._changedBuffers[8]=!0}refreshTexCoordsArr(){if(this._entityCollection&&this._renderer){let t=this._renderer.strokeTextureAtlas;for(let s=0;s<this._rays.length;s++){let n=this._rays[s],o=n.getImage();if(o){let a=t.get(o.__nodeIndex);a&&this.setTexCoordArr(n._handlerIndex,a.texCoords)}}}}};Es.__counter__=0;let Sr=Es;const As=class xd{constructor(t){this.__id=xd.__counter__++,this.pickingEnabled=!0,this._entityCollection=t,this._renderer=null,this._strips=[]}_initProgram(){this._renderer&&this._renderer.handler&&!this._renderer.handler.programs.strip&&this._renderer.handler.addProgram(new X("strip",{uniforms:{projectionMatrix:{type:"mat4"},viewMatrix:{type:"mat4"},eyePositionHigh:"vec3",eyePositionLow:"vec3",uColor:{type:"vec4"},uOpacity:{type:"float"}},attributes:{aVertexPositionHigh:{type:"vec3"},aVertexPositionLow:{type:"vec3"}},vertexShader:`attribute vec3 aVertexPositionHigh;
                        attribute vec3 aVertexPositionLow;
                        uniform mat4 projectionMatrix;
                        uniform mat4 viewMatrix;
                        uniform vec3 eyePositionHigh;
                        uniform vec3 eyePositionLow;
                        void main(void) {

                            vec3 highDiff = aVertexPositionHigh - eyePositionHigh;
                            vec3 lowDiff = aVertexPositionLow - eyePositionLow;

                            mat4 viewMatrixRTE = viewMatrix;
                            viewMatrixRTE[3] = vec4(0.0, 0.0, 0.0, 1.0);

                            gl_Position = projectionMatrix * viewMatrixRTE * vec4(highDiff * step(1.0, length(highDiff)) + lowDiff, 1.0);
                        }`,fragmentShader:`precision highp float;
                        uniform vec4 uColor;
                        uniform float uOpacity;
                        void main(void) {
                            gl_FragColor = vec4(uColor.rgb, uColor.a * uOpacity);
                        }`}))}setRenderNode(t){this._renderer=t.renderer,this._initProgram();for(let s=0;s<this._strips.length;s++)this._strips[s].setRenderNode(t)}add(t){t._handlerIndex===-1&&(t._handler=this,t._handlerIndex=this._strips.length,this._strips.push(t),this._entityCollection&&this._entityCollection.renderNode&&t.setRenderNode(this._entityCollection.renderNode))}remove(t){let s=t._handlerIndex;s!==-1&&(t._deleteBuffers(),t._handlerIndex=-1,t._handler=null,this._strips.splice(s,1),this.reindexStripArray(s))}reindexStripArray(t){let s=this._strips;for(let n=t;n<s.length;n++)s[n]._handlerIndex=n}draw(){let t=this._strips.length;for(;t--;)this._strips[t].draw()}drawPicking(){if(this.pickingEnabled){let t=this._strips.length;for(;t--;)this._strips[t].drawPicking()}}clear(){let t=this._strips.length;for(;t--;)this._strips[t]._deleteBuffers(),this._strips[t]._handler=null,this._strips[t]._handlerIndex=-1;this._strips.length=0,this._strips=[]}};As.__counter__=0;let Rr=As;const Ls=class bd{constructor(t={}){this._onChangeRelativeCenter=n=>{this.geoObjectHandler.setRelativeCenter(n),this.polylineHandler.setRelativeCenter(n)},this.__id=bd.__counter__++,this.renderNode=null,this._visibility=t.visibility==null||t.visibility,this.polygonOffsetUnits=t.polygonOffsetUnits!=null?t.polygonOffsetUnits:0,this.billboardHandler=new sl(this),this.labelHandler=new nl(this,t.labelMaxLetters),this.polylineHandler=new Pr(this),this.rayHandler=new Sr(this),this.pointCloudHandler=new Lr(this),this.stripHandler=new Rr(this),this.geoObjectHandler=new Ar(this),t.pickingEnabled!=null&&this.setPickingEnabled(t.pickingEnabled),this._entities=[],this.scaleByDistance=t.scaleByDistance||[1,1,1];let s=new Float32Array([1,1,1]);t.pickingScale!==void 0&&(t.pickingScale instanceof Array?(s[0]=t.pickingScale[0]||s[0],s[1]=t.pickingScale[1]||s[1],s[2]=t.pickingScale[2]||s[2]):typeof t.pickingScale=="number"&&(s[0]=t.pickingScale,s[1]=t.pickingScale,s[2]=t.pickingScale)),this._depthOrder=t.depthOrder||0,this.pickingScale=s,this._opacity=t.opacity==null?1:t.opacity,this._fadingOpacity=this._opacity,this.events=this.rendererEvents=lt(ol,this),this._useLighting=t.useLighting!=null?t.useLighting?1:0:1,t.entities&&this.addEntities(t.entities)}get depthOrder(){return this._depthOrder}set depthOrder(t){this._depthOrder=t,this.renderNode&&this.renderNode.updateEntityCollectionsDepthOrder()}isEmpty(){return this._entities.length==0}get id(){return this.__id}get useLighting(){return!!this._useLighting}set useLighting(t){this._useLighting=Number(t)}isEqual(t){return t!==null&&this.__id===t.__id}setVisibility(t){var s;this._visibility=t,this._fadingOpacity=this._opacity*(t?1:0),(s=this.renderNode)==null||s.updateEntityCollectionsDepthOrder(),this.events.dispatch(this.events.visibilitychange,this)}getVisibility(){return this._visibility}setOpacity(t){this._opacity=t}setPickingEnabled(t){this.billboardHandler.pickingEnabled=t,this.labelHandler.pickingEnabled=t,this.polylineHandler.pickingEnabled=t,this.rayHandler.pickingEnabled=t,this.pointCloudHandler.pickingEnabled=t,this.stripHandler.pickingEnabled=t,this.geoObjectHandler.pickingEnabled=t}getOpacity(){return this._opacity}setScaleByDistance(t,s,n){this.scaleByDistance[0]=t,this.scaleByDistance[1]=s,this.scaleByDistance[2]=n||Ae}appendChildEntity(t){this._addRecursively(t)}_addRecursively(t){let s=this.renderNode;s&&s.ellipsoid&&t._cartesian.isZero()&&!t.relativePosition&&t.setCartesian3v(s.ellipsoid.lonLatToCartesian(t._lonLat)),this._setPickingColor(t),t._updateAbsolutePosition(),t.setScale3v(t.getScale()),t.billboard&&this.billboardHandler.add(t.billboard),t.label&&this.labelHandler.add(t.label),t.polyline&&this.polylineHandler.add(t.polyline),t.ray&&this.rayHandler.add(t.ray),t.pointCloud&&this.pointCloudHandler.add(t.pointCloud),t.strip&&this.stripHandler.add(t.strip),t.geoObject&&this.geoObjectHandler.add(t.geoObject),this.events.dispatch(this.events.entityadd,t);for(let n=0;n<t.childEntities.length;n++)t.childEntities[n]._entityCollection=this,this._addRecursively(t.childEntities[n])}add(t){return t._entityCollection||(t._entityCollection=this,t._entityCollectionIndex=this._entities.length,this._entities.push(t),this._addRecursively(t)),this}addEntities(t){for(let s=0,n=t.length;s<n;s++)this.add(t[s]);return this}belongs(t){return this.isEqual(t._entityCollection)}_removeRecursively(t){t._entityCollection=null,t._entityCollectionIndex=-1,t.billboard&&this.billboardHandler.remove(t.billboard),t.label&&this.labelHandler.remove(t.label),t.polyline&&this.polylineHandler.remove(t.polyline),t.ray&&this.rayHandler.remove(t.ray),t.pointCloud&&this.pointCloudHandler.remove(t.pointCloud),t.strip&&this.stripHandler.remove(t.strip),t.geoObject&&this.geoObjectHandler.remove(t.geoObject);for(let s=0;s<t.childEntities.length;s++)this._removeRecursively(t.childEntities[s])}_removeEntity(t){if(t.parent){let s=t.parent.childEntities;for(let n=0,o=s.length;n<o;n++)if(s[n].isEqual(t)){s.splice(n,1);break}t.parent=null}else this._entities.splice(t._entityCollectionIndex,1),this.reindexEntitiesArray(t._entityCollectionIndex);this.renderNode&&this.renderNode.renderer&&(this.renderNode.renderer.clearPickingColor(t),t._pickingColor.clear()),this._removeRecursively(t)}removeEntity(t){this.belongs(t)&&(this._removeEntity(t),this.events.dispatch(this.events.entityremove,t))}_removeEntitySilent(t){this.belongs(t)&&this._removeEntity(t)}createPickingColors(t=this._entities){if(this.renderNode&&this.renderNode.renderer)for(let s=0;s<t.length;s++){let n=t[s];this._setPickingColor(n),this.createPickingColors(n.childEntities)}}_setPickingColor(t){this.renderNode&&this.renderNode.renderer&&(t._independentPicking||!t.parent?this.renderNode.renderer.assignPickingColor(t):t._pickingColor=t.parent._pickingColor,this.renderNode.renderer.assignPickingColor(t),t.setPickingColor())}reindexEntitiesArray(t){let s=this._entities;for(let n=t;n<s.length;n++)s[n]._entityCollectionIndex=n}addTo(t,s=!1){return this.renderNode||t.addEntityCollection(this,s),this}bindRenderNode(t){t.renderer&&t.renderer.isInitialized()&&(this.billboardHandler.setRenderer(t.renderer),this.labelHandler.setRenderer(t.renderer),this.rayHandler.setRenderer(t.renderer),this.geoObjectHandler.setRenderNode(t),this.polylineHandler.setRenderNode(t),this.pointCloudHandler.setRenderNode(t),this.stripHandler.setRenderNode(t),t.renderer.events.on("changerelativecenter",this._onChangeRelativeCenter),this.updateBillboardsTextureAtlas(),this.updateLabelsFontAtlas(),this.updateStrokeTextureAtlas(),this.createPickingColors())}_updateGeodeticCoordinates(t){let s=this._entities,n=s.length;for(;n--;){let o=s[n];o._lonLat&&o.setCartesian3v(t.lonLatToCartesian(o._lonLat))}}updateBillboardsTextureAtlas(){let t=this.billboardHandler.billboards;for(let s=0;s<t.length;s++)t[s].setSrc(t[s].getSrc())}updateLabelsFontAtlas(){this.renderNode&&this.labelHandler.updateFonts()}updateStrokeTextureAtlas(){this.rayHandler.reloadTextures(),this.polylineHandler.reloadTextures()}remove(){var t;this.renderNode&&(this.renderNode.removeEntityCollection(this),(t=this.renderNode.renderer)==null||t.events.off("changerelativecenter",this._onChangeRelativeCenter),this.renderNode=null,this.events.dispatch(this.events.remove,this))}getEntities(){return[].concat(this._entities)}each(t){let s=this._entities.length;for(;s--;){let n=this._entities[s];n&&t(n)}}clear(){this.billboardHandler.clear(),this.labelHandler.clear(),this.polylineHandler.clear(),this.rayHandler.clear(),this.pointCloudHandler.clear(),this.stripHandler.clear(),this.geoObjectHandler.clear();let t=this._entities.length;for(;t--;){let s=this._entities[t];this.renderNode&&this.renderNode.renderer&&(this.renderNode.renderer.clearPickingColor(s),s._pickingColor.clear()),this._clearEntity(s)}this._entities.length=0,this._entities=[]}_clearEntity(t){t._entityCollection=null,t._entityCollectionIndex=-1;for(let s=0;s<t.childEntities.length;s++)this._clearEntity(t.childEntities[s])}};Ls.__counter__=0;let se=Ls;const ol=["draw","drawend","add","remove","entityadd","entityremove","visibilitychange","mousemove","mouseenter","mouseleave","lclick","rclick","mclick","ldblclick","rdblclick","mdblclick","lup","rup","mup","ldown","rdown","mdown","lhold","rhold","mhold","mousewheel","touchmove","touchstart","touchend","doubletouch","touchleave","touchenter"];function ae(h,t){if(h>=0){let s=65536*Math.floor(h/65536);t[0]=Math.fround(s),t[1]=Math.fround(h-s)}else{let s=65536*Math.floor(-h/65536);t[0]=Math.fround(-s),t[1]=Math.fround(h+s)}return t}function An(h,t){if(h>=0){let s=65536*Math.floor(h/65536);t.x=Math.fround(s),t.y=Math.fround(h-s)}else{let s=65536*Math.floor(-h/65536);t.x=Math.fround(-s),t.y=Math.fround(h+s)}return t}function Ln(h,t,s){s=s||2;var n,o,a,l,c,d,u,_=t&&t.length,f=_?t[0]*s:h.length,g=Pn(h,0,f,s,!0),m=[];if(!g)return m;if(_&&(g=function(p,x,y,w){var C,T,P,E=[];for(C=0,T=x.length;C<T;C++)(P=Pn(p,x[C]*w,C<T-1?x[C+1]*w:p.length,w,!1))===P.next&&(P.steiner=!0),E.push(_l(P));for(E.sort(dl),C=0;C<E.length;C++)ul(E[C],y),y=wi(y,y.next);return y}(h,t,g,s)),h.length>80*s){n=a=h[0],o=l=h[1];for(let p=s;p<f;p+=s)(c=h[p])<n&&(n=c),(d=h[p+1])<o&&(o=d),c>a&&(a=c),d>l&&(l=d);u=Math.max(a-n,l-o)}return Ti(g,m,s,n,o,u),m}function Pn(h,t,s,n,o){var a,l;if(o===function(c,d,u,_){var f=0;for(let g=d,m=u-_;g<u;g+=_)f+=(c[m]-c[g])*(c[g+1]+c[m+1]),m=g;return f}(h,t,s,n)>0)for(a=t;a<s;a+=n)l=Sn(a,h[a],h[a+1],l);else for(a=s-n;a>=t;a-=n)l=Sn(a,h[a],h[a+1],l);return l&&Te(l,l.next)&&(Ei(l),l=l.next),l}function wi(h,t){if(!h)return h;t||(t=h);var s,n=h;do if(s=!1,n.steiner||!Te(n,n.next)&&It(n.prev,n,n.next)!==0)n=n.next;else{if(Ei(n),(n=t=n.prev)===n.next)return null;s=!0}while(s||n!==t);return t}function Ti(h,t,s,n,o,a,l){if(h){!l&&a&&function(_,f,g,m){var p=_;do p.z===null&&(p.z=Mr(p.x,p.y,f,g,m)),p.prevZ=p.prev,p.nextZ=p.next,p=p.next;while(p!==_);p.prevZ.nextZ=null,p.prevZ=null,function(x){var y,w,C,T,P,E,S,M,R=1;do{for(w=x,x=null,P=null,E=0;w;){for(E++,C=w,S=0,y=0;y<R&&(S++,C=C.nextZ);y++);for(M=R;S>0||M>0&&C;)S!==0&&(M===0||!C||w.z<=C.z)?(T=w,w=w.nextZ,S--):(T=C,C=C.nextZ,M--),P?P.nextZ=T:x=T,T.prevZ=P,P=T;w=C}P.nextZ=null,R*=2}while(E>1)}(p)}(h,n,o,a);for(var c,d,u=h;h.prev!==h.next;)if(c=h.prev,d=h.next,a?ll(h,n,o,a):al(h))t.push(c.i/s),t.push(h.i/s),t.push(d.i/s),Ei(h),h=d.next,u=d.next;else if((h=d)===u){l?l===1?Ti(h=hl(h,t,s),t,s,n,o,a,2):l===2&&cl(h,t,s,n,o,a):Ti(wi(h),t,s,n,o,a,1);break}}}function al(h){var t=h.prev,s=h,n=h.next;if(It(t,s,n)>=0)return!1;for(var o=h.next.next;o!==h.prev;){if(os(t.x,t.y,s.x,s.y,n.x,n.y,o.x,o.y)&&It(o.prev,o,o.next)>=0)return!1;o=o.next}return!0}function ll(h,t,s,n){var o=h.prev,a=h,l=h.next;if(It(o,a,l)>=0)return!1;for(var c=o.x<a.x?o.x<l.x?o.x:l.x:a.x<l.x?a.x:l.x,d=o.y<a.y?o.y<l.y?o.y:l.y:a.y<l.y?a.y:l.y,u=o.x>a.x?o.x>l.x?o.x:l.x:a.x>l.x?a.x:l.x,_=o.y>a.y?o.y>l.y?o.y:l.y:a.y>l.y?a.y:l.y,f=Mr(c,d,t,s,n),g=Mr(u,_,t,s,n),m=h.nextZ;m&&m.z<=g;){if(m!==h.prev&&m!==h.next&&os(o.x,o.y,a.x,a.y,l.x,l.y,m.x,m.y)&&It(m.prev,m,m.next)>=0)return!1;m=m.nextZ}for(m=h.prevZ;m&&m.z>=f;){if(m!==h.prev&&m!==h.next&&os(o.x,o.y,a.x,a.y,l.x,l.y,m.x,m.y)&&It(m.prev,m,m.next)>=0)return!1;m=m.prevZ}return!0}function hl(h,t,s){var n=h;do{var o=n.prev,a=n.next.next;!Te(o,a)&&ra(o,n,n.next,a)&&Ci(o,a)&&Ci(a,o)&&(t.push(o.i/s),t.push(n.i/s),t.push(a.i/s),Ei(n),Ei(n.next),n=h=a),n=n.next}while(n!==h);return n}function cl(h,t,s,n,o,a){var l=h;do{for(var c=l.next.next;c!==l.prev;){if(l.i!==c.i&&fl(l,c)){var d=na(l,c);return l=wi(l,l.next),d=wi(d,d.next),Ti(l,t,s,n,o,a),void Ti(d,t,s,n,o,a)}c=c.next}l=l.next}while(l!==h)}function dl(h,t){return h.x-t.x}function ul(h,t){if(t=function(n,o){var a,l=o,c=n.x,d=n.y,u=-1/0;do{if(d<=l.y&&d>=l.next.y&&l.next.y!==l.y){var _=l.x+(d-l.y)*(l.next.x-l.x)/(l.next.y-l.y);if(_<=c&&_>u){if(u=_,_===c){if(d===l.y)return l;if(d===l.next.y)return l.next}a=l.x<l.next.x?l:l.next}}l=l.next}while(l!==o);if(!a)return null;if(c===u)return a.prev;var f,g=a,m=a.x,p=a.y,x=1/0;for(l=a.next;l!==g;)c>=l.x&&l.x>=m&&c!==l.x&&os(d<p?c:u,d,m,p,d<p?u:c,d,l.x,l.y)&&((f=Math.abs(d-l.y)/(c-l.x))<x||f===x&&l.x>a.x)&&Ci(l,n)&&(a=l,x=f),l=l.next;return a}(h,t)){var s=na(t,h);wi(s,s.next)}}function Mr(h,t,s,n,o){return(h=1431655765&((h=858993459&((h=252645135&((h=16711935&((h=32767*(h-s)/o)|h<<8))|h<<4))|h<<2))|h<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-n)/o)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function _l(h){var t=h,s=h;do t.x<s.x&&(s=t),t=t.next;while(t!==h);return s}function os(h,t,s,n,o,a,l,c){return(o-l)*(t-c)-(h-l)*(a-c)>=0&&(h-l)*(n-c)-(s-l)*(t-c)>=0&&(s-l)*(a-c)-(o-l)*(n-c)>=0}function fl(h,t){return h.next.i!==t.i&&h.prev.i!==t.i&&!function(s,n){var o=s;do{if(o.i!==s.i&&o.next.i!==s.i&&o.i!==n.i&&o.next.i!==n.i&&ra(o,o.next,s,n))return!0;o=o.next}while(o!==s);return!1}(h,t)&&Ci(h,t)&&Ci(t,h)&&function(s,n){var o=s,a=!1,l=(s.x+n.x)/2,c=(s.y+n.y)/2;do o.y>c!=o.next.y>c&&o.next.y!==o.y&&l<(o.next.x-o.x)*(c-o.y)/(o.next.y-o.y)+o.x&&(a=!a),o=o.next;while(o!==s);return a}(h,t)}function It(h,t,s){return(t.y-h.y)*(s.x-t.x)-(t.x-h.x)*(s.y-t.y)}function Te(h,t){return h.x===t.x&&h.y===t.y}function ra(h,t,s,n){return!!(Te(h,t)&&Te(s,n)||Te(h,n)&&Te(s,t))||It(h,t,s)>0!=It(h,t,n)>0&&It(s,n,h)>0!=It(s,n,t)>0}function Ci(h,t){return It(h.prev,h,h.next)<0?It(h,t,h.next)>=0&&It(h,h.prev,t)>=0:It(h,t,h.prev)<0||It(h,h.next,t)<0}function na(h,t){var s=new Br(h.i,h.x,h.y),n=new Br(t.i,t.x,t.y),o=h.next,a=t.prev;return h.next=t,t.prev=h,s.next=o,o.prev=s,n.next=s,s.prev=n,a.next=n,n.prev=a,n}function Sn(h,t,s,n){var o=new Br(h,t,s);return n?(o.next=n.next,o.prev=n,n.next.prev=o,n.next=o):(o.prev=o,o.next=o),o}function Ei(h){h.next.prev=h.prev,h.prev.next=h.next,h.prevZ&&(h.prevZ.nextZ=h.nextZ),h.nextZ&&(h.nextZ.prevZ=h.prevZ)}function Br(h,t,s){this.i=h,this.x=t,this.y=s,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}function Rn(h){var t=h[0][0].length,s={vertices:[],holes:[],dimensions:t},n=0;for(let o=0;o<h.length;o++){for(let a=0;a<h[o].length;a++)for(let l=0;l<t;l++)s.vertices.push(h[o][a][l]);o>0&&(n+=h[o-1].length,s.holes.push(n))}return s}function qs(h,t,s){let n=h[0],o=h[1];if(n>=0){let a=65536*Math.floor(n/65536);t.x=Math.fround(a),s.x=Math.fround(n-a)}else{let a=65536*Math.floor(-n/65536);t.x=Math.fround(-a),s.x=Math.fround(n+a)}if(o>=0){let a=65536*Math.floor(o/65536);t.y=Math.fround(a),s.y=Math.fround(o-a)}else{let a=65536*Math.floor(-o/65536);t.y=Math.fround(-a),s.y=Math.fround(o+a)}}let q=new H,Y=new H,De=new H;const ge=class Bc{constructor(t){this.__id=Bc.__counter__++,this._layer=t,this._handler=null,this._geometries=[],this._updatedGeometryArr=[],this._updatedGeometry={},this._removeGeometryExtentArr=[],this._removeGeometryExtents={},this._polyVerticesHighMerc=[],this._polyVerticesLowMerc=[],this._polyColors=[],this._polyPickingColors=[],this._polyIndexes=[],this._lineVerticesHighMerc=[],this._lineVerticesLowMerc=[],this._lineOrders=[],this._lineIndexes=[],this._lineColors=[],this._linePickingColors=[],this._lineThickness=[],this._lineStrokes=[],this._lineStrokeColors=[],this._polyVerticesHighBufferMerc=null,this._polyVerticesLowBufferMerc=null,this._polyColorsBuffer=null,this._polyPickingColorsBuffer=null,this._polyIndexesBuffer=null,this._lineVerticesHighBufferMerc=null,this._lineVerticesLowBufferMerc=null,this._lineColorsBuffer=null,this._linePickingColorsBuffer=null,this._lineThicknessBuffer=null,this._lineStrokesBuffer=null,this._lineStrokeColorsBuffer=null,this._lineOrdersBuffer=null,this._lineIndexesBuffer=null,this._buffersUpdateCallbacks=[],this._buffersUpdateCallbacks[0]=this.createPolyVerticesBuffer,this._buffersUpdateCallbacks[1]=this.createPolyIndexesBuffer,this._buffersUpdateCallbacks[2]=this.createPolyColorsBuffer,this._buffersUpdateCallbacks[3]=this.createLineVerticesBuffer,this._buffersUpdateCallbacks[4]=this.createLineIndexesBuffer,this._buffersUpdateCallbacks[5]=this.createLineOrdersBuffer,this._buffersUpdateCallbacks[6]=this.createLineColorsBuffer,this._buffersUpdateCallbacks[7]=this.createLineThicknessBuffer,this._buffersUpdateCallbacks[8]=this.createLineStrokesBuffer,this._buffersUpdateCallbacks[9]=this.createLineStrokeColorsBuffer,this._buffersUpdateCallbacks[10]=this.createPolyPickingColorsBuffer,this._buffersUpdateCallbacks[11]=this.createLinePickingColorsBuffer,this._changedBuffers=new Array(this._buffersUpdateCallbacks.length)}static appendLineData(t,s,n,o,a,l,c,d,u,_,f,g,m,p,x,y,w,C){var T=0;f.length>0?(T=f[f.length-5]+9,f.push(T,T)):f.push(0,0);var P=a,E=[n.x,n.y,n.z,n.w],S=c,M=[l.x,l.y,l.z,l.w],R=[o.x,o.y,o.z,1];for(let B=0;B<t.length;B++){var k=t[B];if(k.length===0)continue;let z,O,ze=T;if(s)z=k[k.length-1];else{let D=k[0],re=k[1];re||(re=D),z=[D[0]+D[0]-re[0],D[1]+D[1]-re[1]]}qs(z,q,Y),d.push(q.x,q.y,q.x,q.y,q.x,q.y,q.x,q.y),u.push(Y.x,Y.y,Y.x,Y.y,Y.x,Y.y,Y.x,Y.y),w.push(q.x,q.y,q.x,q.y,q.x,q.y,q.x,q.y),C.push(Y.x,Y.y,Y.x,Y.y,Y.x,Y.y,Y.x,Y.y),_.push(1,-1,2,-2),p.push(P,P,P,P),y.push(S,S,S,S),g.push(E[0],E[1],E[2],E[3],E[0],E[1],E[2],E[3],E[0],E[1],E[2],E[3],E[0],E[1],E[2],E[3]),x.push(M[0],M[1],M[2],M[3],M[0],M[1],M[2],M[3],M[0],M[1],M[2],M[3],M[0],M[1],M[2],M[3]),m.push(R[0],R[1],R[2],R[3],R[0],R[1],R[2],R[3],R[0],R[1],R[2],R[3],R[0],R[1],R[2],R[3]);for(let D=0;D<k.length;D++)qs(k[D],q,Y),d.push(q.x,q.y,q.x,q.y,q.x,q.y,q.x,q.y),u.push(Y.x,Y.y,Y.x,Y.y,Y.x,Y.y,Y.x,Y.y),w.push(q.x,q.y,q.x,q.y,q.x,q.y,q.x,q.y),C.push(Y.x,Y.y,Y.x,Y.y,Y.x,Y.y,Y.x,Y.y),_.push(1,-1,2,-2),p.push(P,P,P,P),y.push(S,S,S,S),g.push(E[0],E[1],E[2],E[3],E[0],E[1],E[2],E[3],E[0],E[1],E[2],E[3],E[0],E[1],E[2],E[3]),x.push(M[0],M[1],M[2],M[3],M[0],M[1],M[2],M[3],M[0],M[1],M[2],M[3],M[0],M[1],M[2],M[3]),m.push(R[0],R[1],R[2],R[3],R[0],R[1],R[2],R[3],R[0],R[1],R[2],R[3],R[0],R[1],R[2],R[3]),f.push(T++,T++,T++,T++);if(s)O=k[0],f.push(ze,ze+1,ze+1,ze+1);else{let D=k[k.length-1],re=k[k.length-2];re||(re=D),O=[D[0]+D[0]-re[0],D[1]+D[1]-re[1]],f.push(T-1,T-1,T-1,T-1)}qs(O,q,Y),d.push(q.x,q.y,q.x,q.y,q.x,q.y,q.x,q.y),u.push(Y.x,Y.y,Y.x,Y.y,Y.x,Y.y,Y.x,Y.y),w.push(q.x,q.y,q.x,q.y,q.x,q.y,q.x,q.y),C.push(Y.x,Y.y,Y.x,Y.y,Y.x,Y.y,Y.x,Y.y),_.push(1,-1,2,-2),p.push(P,P,P,P),y.push(S,S,S,S),g.push(E[0],E[1],E[2],E[3],E[0],E[1],E[2],E[3],E[0],E[1],E[2],E[3],E[0],E[1],E[2],E[3]),x.push(M[0],M[1],M[2],M[3],M[0],M[1],M[2],M[3],M[0],M[1],M[2],M[3],M[0],M[1],M[2],M[3]),m.push(R[0],R[1],R[2],R[3],R[0],R[1],R[2],R[3],R[0],R[1],R[2],R[3],R[0],R[1],R[2],R[3]),B<t.length-1&&(T+=8,f.push(T,T))}}assignHandler(t){this._handler=t,this.refresh(),t.isInitialized()&&this.update()}add(t){if(t._handlerIndex===-1){t._handler=this,t._handlerIndex=this._geometries.length,this._geometries.push(t);let s=t._entity._pickingColor.scaleTo(1/255);if(t._polyVerticesHighMerc=[],t._polyVerticesLowMerc=[],t._lineVerticesHighMerc=[],t._lineVerticesLowMerc=[],t._coordinates[0].length){if(t.type===ai.POLYGON){let n=t._coordinates,o=[];for(let _=0;_<n.length;_++){o[_]=[];for(let f=0;f<n[_].length;f++)o[_][f]=[ni(n[_][f][0]),oi(n[_][f][1])]}let a=Rn(o),l=Ln(a.vertices,a.holes,2);t._polyVerticesHandlerIndex=this._polyVerticesHighMerc.length,t._polyIndexesHandlerIndex=this._polyIndexes.length;for(let _=0;_<l.length;_++)this._polyIndexes.push(l[_]+.5*t._polyVerticesHandlerIndex);let c=t._style.fillColor,d=[],u=[];for(let _=0;_<.5*a.vertices.length;_++)this._polyColors.push(c.x,c.y,c.z,c.w),this._polyPickingColors.push(s.x,s.y,s.z,1);for(let _=0;_<a.vertices.length;_++)An(a.vertices[_],De),d[_]=De.x,u[_]=De.y;t._polyVerticesHighMerc=d,t._polyVerticesLowMerc=u,this._polyVerticesHighMerc.push.apply(this._polyVerticesHighMerc,d),this._polyVerticesLowMerc.push.apply(this._polyVerticesLowMerc,u),t._polyVerticesLength=a.vertices.length,t._polyIndexesLength=l.length,t._lineVerticesHandlerIndex=this._lineVerticesHighMerc.length,t._lineOrdersHandlerIndex=this._lineOrders.length,t._lineIndexesHandlerIndex=this._lineIndexes.length,t._lineColorsHandlerIndex=this._lineColors.length,t._lineThicknessHandlerIndex=this._lineThickness.length,Bc.appendLineData(o,!0,t._style.lineColor,s,t._style.lineWidth,t._style.strokeColor,t._style.strokeWidth,this._lineVerticesHighMerc,this._lineVerticesLowMerc,this._lineOrders,this._lineIndexes,this._lineColors,this._linePickingColors,this._lineThickness,this._lineStrokeColors,this._lineStrokes,t._lineVerticesHighMerc,t._lineVerticesLowMerc),t._lineVerticesLength=this._lineVerticesHighMerc.length-t._lineVerticesHandlerIndex,t._lineOrdersLength=this._lineOrders.length-t._lineOrdersHandlerIndex,t._lineIndexesLength=this._lineIndexes.length-t._lineIndexesHandlerIndex,t._lineColorsLength=this._lineColors.length-t._lineColorsHandlerIndex,t._lineThicknessLength=this._lineThickness.length-t._lineThicknessHandlerIndex}else if(t.type===ai.MULTIPOLYGON){let n=t._coordinates,o=[],a=[];t._lineVerticesHandlerIndex=this._lineVerticesHighMerc.length,t._lineOrdersHandlerIndex=this._lineOrders.length,t._lineIndexesHandlerIndex=this._lineIndexes.length,t._lineColorsHandlerIndex=this._lineColors.length,t._lineThicknessHandlerIndex=this._lineThickness.length;for(let u=0;u<n.length;u++){let _=n[u],f=[];for(let p=0;p<_.length;p++){f[p]=[];for(let x=0;x<n[u][p].length;x++)f[p][x]=[ni(_[p][x][0]),oi(_[p][x][1])]}let g=Rn(f),m=Ln(g.vertices,g.holes,2);for(let p=0;p<m.length;p++)a.push(m[p]+.5*o.length);o.push.apply(o,g.vertices),Bc.appendLineData(f,!0,t._style.lineColor,s,t._style.lineWidth,t._style.strokeColor,t._style.strokeWidth,this._lineVerticesHighMerc,this._lineVerticesLowMerc,this._lineOrders,this._lineIndexes,this._lineColors,this._linePickingColors,this._lineThickness,this._lineStrokeColors,this._lineStrokes,t._lineVerticesHighMerc,t._lineVerticesLowMerc)}t._polyVerticesHandlerIndex=this._polyVerticesHighMerc.length,t._polyIndexesHandlerIndex=this._polyIndexes.length;for(let u=0;u<a.length;u++)this._polyIndexes.push(a[u]+.5*t._polyVerticesHandlerIndex);let l=t._style.fillColor,c=[],d=[];for(let u=0;u<.5*o.length;u++)this._polyColors.push(l.x,l.y,l.z,l.w),this._polyPickingColors.push(s.x,s.y,s.z,1);for(let u=0;u<o.length;u++)An(o[u],De),c[u]=De.x,d[u]=De.y;t._polyVerticesHighMerc=c,t._polyVerticesLowMerc=d,this._polyVerticesHighMerc.push.apply(this._polyVerticesHighMerc,c),this._polyVerticesLowMerc.push.apply(this._polyVerticesLowMerc,d),t._polyVerticesLength=o.length,t._polyIndexesLength=a.length,t._lineVerticesLength=this._lineVerticesHighMerc.length-t._lineVerticesHandlerIndex,t._lineOrdersLength=this._lineOrders.length-t._lineOrdersHandlerIndex,t._lineIndexesLength=this._lineIndexes.length-t._lineIndexesHandlerIndex,t._lineColorsLength=this._lineColors.length-t._lineColorsHandlerIndex,t._lineThicknessLength=this._lineThickness.length-t._lineThicknessHandlerIndex}else if(t.type===ai.LINESTRING){let n=t._coordinates,o=new Array(n.length);for(let a=0;a<n.length;a++)o[a]=[ni(n[a][0]),oi(n[a][1])];t._lineVerticesHandlerIndex=this._lineVerticesHighMerc.length,t._lineOrdersHandlerIndex=this._lineOrders.length,t._lineIndexesHandlerIndex=this._lineIndexes.length,t._lineColorsHandlerIndex=this._lineColors.length,t._lineThicknessHandlerIndex=this._lineThickness.length,Bc.appendLineData([o],!1,t._style.lineColor,s,t._style.lineWidth,t._style.strokeColor,t._style.strokeWidth,this._lineVerticesHighMerc,this._lineVerticesLowMerc,this._lineOrders,this._lineIndexes,this._lineColors,this._linePickingColors,this._lineThickness,this._lineStrokeColors,this._lineStrokes,t._lineVerticesHighMerc,t._lineVerticesLowMerc),t._lineVerticesLength=this._lineVerticesHighMerc.length-t._lineVerticesHandlerIndex,t._lineOrdersLength=this._lineOrders.length-t._lineOrdersHandlerIndex,t._lineIndexesLength=this._lineIndexes.length-t._lineIndexesHandlerIndex,t._lineColorsLength=this._lineColors.length-t._lineColorsHandlerIndex,t._lineThicknessLength=this._lineThickness.length-t._lineThicknessHandlerIndex}else if(t.type===ai.MULTILINESTRING){let n=t._coordinates,o=[];for(let a=0;a<n.length;a++){o[a]=[];for(let l=0;l<n[a].length;l++)o[a][l]=[ni(n[a][l][0]),oi(n[a][l][1])]}t._lineVerticesHandlerIndex=this._lineVerticesHighMerc.length,t._lineOrdersHandlerIndex=this._lineOrders.length,t._lineIndexesHandlerIndex=this._lineIndexes.length,t._lineColorsHandlerIndex=this._lineColors.length,t._lineThicknessHandlerIndex=this._lineThickness.length,Bc.appendLineData(o,!1,t._style.lineColor,s,t._style.lineWidth,t._style.strokeColor,t._style.strokeWidth,this._lineVerticesHighMerc,this._lineVerticesLowMerc,this._lineOrders,this._lineIndexes,this._lineColors,this._linePickingColors,this._lineThickness,this._lineStrokeColors,this._lineStrokes,t._lineVerticesHighMerc,t._lineVerticesLowMerc),t._lineVerticesLength=this._lineVerticesHighMerc.length-t._lineVerticesHandlerIndex,t._lineOrdersLength=this._lineOrders.length-t._lineOrdersHandlerIndex,t._lineIndexesLength=this._lineIndexes.length-t._lineIndexesHandlerIndex,t._lineColorsLength=this._lineColors.length-t._lineColorsHandlerIndex,t._lineThicknessLength=this._lineThickness.length-t._lineThicknessHandlerIndex}}this.setGeometryVisibility(t),!this._updatedGeometry[t.__id]&&this._updatedGeometryArr.push(t),this._updatedGeometry[t.__id]=!0,this.refresh()}}remove(t){const s=t._handlerIndex;if(s!==-1){this._geometries.splice(s,1),this._polyVerticesHighMerc.splice(t._polyVerticesHandlerIndex,t._polyVerticesLength),this._polyVerticesLowMerc.splice(t._polyVerticesHandlerIndex,t._polyVerticesLength),this._polyColors.splice(2*t._polyVerticesHandlerIndex,2*t._polyVerticesLength),this._polyPickingColors.splice(2*t._polyVerticesHandlerIndex,2*t._polyVerticesLength),this._polyIndexes.splice(t._polyIndexesHandlerIndex,t._polyIndexesLength);let n=.5*t._polyVerticesLength;for(let a=t._polyIndexesHandlerIndex;a<this._polyIndexes.length;a++)this._polyIndexes[a]-=n;this._lineVerticesHighMerc.splice(t._lineVerticesHandlerIndex,t._lineVerticesLength),this._lineVerticesLowMerc.splice(t._lineVerticesHandlerIndex,t._lineVerticesLength),this._lineOrders.splice(t._lineOrdersHandlerIndex,t._lineOrdersLength),this._lineColors.splice(t._lineColorsHandlerIndex,t._lineColorsLength),this._linePickingColors.splice(t._lineColorsHandlerIndex,t._lineColorsLength),this._lineStrokeColors.splice(t._lineColorsHandlerIndex,t._lineColorsLength),this._lineThickness.splice(t._lineThicknessHandlerIndex,t._lineThicknessLength),this._lineStrokes.splice(t._lineThicknessHandlerIndex,t._lineThicknessLength),this._lineIndexes.splice(t._lineIndexesHandlerIndex,t._lineIndexesLength),n=.5*t._lineVerticesLength;for(let a=t._lineIndexesHandlerIndex;a<this._lineIndexes.length;a++)this._lineIndexes[a]-=n;let o=this._geometries;for(let a=s;a<o.length;a++){let l=o[a];l._handlerIndex=a,l._polyVerticesHandlerIndex-=t._polyVerticesLength,l._polyIndexesHandlerIndex-=t._polyIndexesLength,l._lineVerticesHandlerIndex-=t._lineVerticesLength,l._lineOrdersHandlerIndex-=t._lineOrdersLength,l._lineColorsHandlerIndex-=t._lineColorsLength,l._lineThicknessHandlerIndex-=t._lineThicknessLength,l._lineIndexesHandlerIndex-=t._lineIndexesLength}t._pickingReady=!1,t._handler=null,t._handlerIndex=-1,t._polyVerticesHighMerc=[],t._polyVerticesLowMerc=[],t._polyVerticesLength=-1,t._polyIndexesLength=-1,t._polyVerticesHandlerIndex=-1,t._polyIndexesHandlerIndex=-1,t._lineVerticesHighMerc=[],t._lineVerticesLowMerc=[],t._lineVerticesLength=-1,t._lineOrdersLength=-1,t._lineIndexesLength=-1,t._lineColorsLength=-1,t._lineThicknessLength=-1,t._lineVerticesHandlerIndex=-1,t._lineOrdersHandlerIndex=-1,t._lineIndexesHandlerIndex=-1,t._lineThicknessHandlerIndex=-1,t._lineColorsHandlerIndex=-1,!this._removeGeometryExtents[t.__id]&&this._removeGeometryExtentArr.push(t.getExtent()),this._removeGeometryExtents[t.__id]=!0,this.refresh()}}_refreshRecursevely(t,s){if(s.ready){let n=this._layer._id;for(let o=0;o<s.nodes.length;o++){let a=s.nodes[o];if(t.overlaps(a.segment.getExtentLonLat())){this._refreshRecursevely(t,a);let l=a.segment.materials[n];l&&l.isReady&&(l.segment.node.getState()!==1?l.layer.clearMaterial(l):(l.pickingReady=l.pickingReady&&t._pickingReady,l.isReady=!1,l._updateTexture=l.texture,l._updatePickingMask=l.pickingMask),t._pickingReady=!0)}}}}_refreshRecursevelyExt(t,s){if(s.ready){let n=this._layer.__id;for(let o=0;o<s.nodes.length;o++){let a=s.nodes[o];if(t.overlaps(a.segment.getExtentLonLat())){this._refreshRecursevelyExt(t,a);let l=a.segment.materials[n];l&&l.isReady&&l.layer.clearMaterial(l)}}}}_refreshPlanetNode(t){let s,n=this._removeGeometryExtentArr;for(s=0;s<n.length;s++)this._refreshRecursevelyExt(n[s],t);let o=this._updatedGeometryArr;for(s=0;s<o.length;s++)this._refreshRecursevely(o[s],t)}_updatePlanet(){let t=this._layer._planet;if(t){let s=t.quadTreeStrategy.quadTreeList;for(let n=0;n<s.length;n++)this._refreshPlanetNode(s[n])}this._updatedGeometryArr.length=0,this._updatedGeometryArr=[],this._updatedGeometry={},this._removeGeometryExtentArr.length=0,this._removeGeometryExtentArr=[],this._removeGeometryExtents={}}refresh(){let t=this._changedBuffers.length;for(;t--;)this._changedBuffers[t]=!0}update(){if(this._handler){let t=!1,s=this._changedBuffers.length;for(;s--;)this._changedBuffers[s]&&(t=!0,this._buffersUpdateCallbacks[s].call(this),this._changedBuffers[s]=!1);t&&this._updatePlanet()}}setGeometryVisibility(t){let s=t.getVisibility()?1:0,n=this._polyVerticesHighMerc,o=this._polyVerticesLowMerc,a=t._polyVerticesLength,l=t._polyVerticesHandlerIndex;for(let c=0;c<a;c++)n[l+c]=t._polyVerticesHighMerc[c]*s,o[l+c]=t._polyVerticesLowMerc[c]*s;n=this._lineVerticesHighMerc,o=this._lineVerticesLowMerc,a=t._lineVerticesLength,l=t._lineVerticesHandlerIndex;for(let c=0;c<a;c++)n[l+c]=t._lineVerticesHighMerc[c]*s,o[l+c]=t._lineVerticesLowMerc[c]*s;this._changedBuffers[0]=!0,this._changedBuffers[3]=!0,!this._updatedGeometry[t.__id]&&this._updatedGeometryArr.push(t),this._updatedGeometry[t.__id]=!0}setPolyColorArr(t,s){let n=2*t._polyVerticesHandlerIndex,o=n+2*t._polyVerticesLength,a=this._polyColors;for(let l=n;l<o;l+=4)a[l]=s.x,a[l+1]=s.y,a[l+2]=s.z,a[l+3]=s.w;this._changedBuffers[2]=!0,!this._updatedGeometry[t.__id]&&this._updatedGeometryArr.push(t),this._updatedGeometry[t.__id]=!0}setLineStrokeColorArr(t,s){let n=t._lineColorsHandlerIndex,o=n+t._lineColorsLength,a=this._lineStrokeColors;for(let l=n;l<o;l+=4)a[l]=s.x,a[l+1]=s.y,a[l+2]=s.z,a[l+3]=s.w;this._changedBuffers[9]=!0,!this._updatedGeometry[t.__id]&&this._updatedGeometryArr.push(t),this._updatedGeometry[t.__id]=!0}setLineColorArr(t,s){let n=t._lineColorsHandlerIndex,o=n+t._lineColorsLength,a=this._lineColors;for(let l=n;l<o;l+=4)a[l]=s.x,a[l+1]=s.y,a[l+2]=s.z,a[l+3]=s.w;this._changedBuffers[6]=!0,!this._updatedGeometry[t.__id]&&this._updatedGeometryArr.push(t),this._updatedGeometry[t.__id]=!0}setLineStrokeArr(t,s){}setLineThicknessArr(t,s){let n=t._lineThicknessHandlerIndex,o=n+t._lineThicknessLength,a=this._lineThickness;for(let l=n;l<o;l++)a[l]=s;this._changedBuffers[7]=!0,!this._updatedGeometry[t.__id]&&this._updatedGeometryArr.push(t),this._updatedGeometry[t.__id]=!0}bringToFront(t){let s=this._polyIndexes.splice(t._polyIndexesHandlerIndex,t._polyIndexesLength),n=this._lineIndexes.splice(t._lineIndexesHandlerIndex,t._lineIndexesLength);this._geometries.splice(t._handlerIndex,1);let o=this._geometries;for(let a=t._handlerIndex;a<o.length;a++){let l=o[a];l._handlerIndex=a,l._polyIndexesHandlerIndex-=t._polyIndexesLength,l._lineIndexesHandlerIndex-=t._lineIndexesLength}t._polyIndexesHandlerIndex=this._polyIndexes.length,t._lineIndexesHandlerIndex=this._lineIndexes.length,t._handlerIndex=this._geometries.length,this._geometries.push(t),this._polyIndexes.push.apply(this._polyIndexes,s),this._lineIndexes.push.apply(this._lineIndexes,n),this._changedBuffers[1]=!0,this._changedBuffers[4]=!0,!this._updatedGeometry[t.__id]&&this._updatedGeometryArr.push(t),this._updatedGeometry[t.__id]=!0}createPolyVerticesBuffer(){let t=this._handler;t.gl.deleteBuffer(this._polyVerticesHighBufferMerc),this._polyVerticesHighBufferMerc=t.createArrayBuffer(new Float32Array(this._polyVerticesHighMerc),2,this._polyVerticesHighMerc.length/2),t.gl.deleteBuffer(this._polyVerticesLowBufferMerc),this._polyVerticesLowBufferMerc=t.createArrayBuffer(new Float32Array(this._polyVerticesLowMerc),2,this._polyVerticesLowMerc.length/2)}createPolyIndexesBuffer(){let t=this._handler;t.gl.deleteBuffer(this._polyIndexesBuffer),this._polyIndexesBuffer=t.createElementArrayBuffer(new Uint32Array(this._polyIndexes),1,this._polyIndexes.length)}createPolyColorsBuffer(){let t=this._handler;t.gl.deleteBuffer(this._polyColorsBuffer),this._polyColorsBuffer=t.createArrayBuffer(new Float32Array(this._polyColors),4,this._polyColors.length/4)}createPolyPickingColorsBuffer(){let t=this._handler;t.gl.deleteBuffer(this._polyPickingColorsBuffer),this._polyPickingColorsBuffer=t.createArrayBuffer(new Float32Array(this._polyPickingColors),4,this._polyPickingColors.length/4)}createLineVerticesBuffer(){let t=this._handler;t.gl.deleteBuffer(this._lineVerticesHighBufferMerc),this._lineVerticesHighBufferMerc=t.createArrayBuffer(new Float32Array(this._lineVerticesHighMerc),2,this._lineVerticesHighMerc.length/2),t.gl.deleteBuffer(this._lineVerticesLowBufferMerc),this._lineVerticesLowBufferMerc=t.createArrayBuffer(new Float32Array(this._lineVerticesLowMerc),2,this._lineVerticesLowMerc.length/2)}createLineIndexesBuffer(){let t=this._handler;t.gl.deleteBuffer(this._lineIndexesBuffer),this._lineIndexesBuffer=t.createElementArrayBuffer(new Uint32Array(this._lineIndexes),1,this._lineIndexes.length)}createLineOrdersBuffer(){let t=this._handler;t.gl.deleteBuffer(this._lineOrdersBuffer),this._lineOrdersBuffer=t.createArrayBuffer(new Float32Array(this._lineOrders),1,this._lineOrders.length/2)}createLineColorsBuffer(){let t=this._handler;t.gl.deleteBuffer(this._lineColorsBuffer),this._lineColorsBuffer=t.createArrayBuffer(new Float32Array(this._lineColors),4,this._lineColors.length/4)}createLinePickingColorsBuffer(){let t=this._handler;t.gl.deleteBuffer(this._linePickingColorsBuffer),this._linePickingColorsBuffer=t.createArrayBuffer(new Float32Array(this._linePickingColors),4,this._linePickingColors.length/4)}createLineThicknessBuffer(){let t=this._handler;t.gl.deleteBuffer(this._lineThicknessBuffer),this._lineThicknessBuffer=t.createArrayBuffer(new Float32Array(this._lineThickness),1,this._lineThickness.length)}createLineStrokesBuffer(){let t=this._handler;t.gl.deleteBuffer(this._lineStrokesBuffer),this._lineStrokesBuffer=t.createArrayBuffer(new Float32Array(this._lineStrokes),1,this._lineStrokes.length)}createLineStrokeColorsBuffer(){let t=this._handler;t.gl.deleteBuffer(this._lineStrokeColorsBuffer),this._lineStrokeColorsBuffer=t.createArrayBuffer(new Float32Array(this._lineStrokeColors),4,this._lineStrokeColors.length/4)}clear(){this._geometries=[],this._polyVerticesHighMerc=[],this._polyVerticesLowMerc=[],this._polyIndexes=[],this._polyColors=[],this._polyPickingColors=[],this._lineVerticesHighMerc=[],this._lineVerticesLowMerc=[],this._lineOrders=[],this._lineIndexes=[],this._lineColors=[],this._linePickingColors=[],this._lineThickness=[],this._lineStrokeColors=[],this._lineStrokes=[],this._deleteBuffers(),this._polyVerticesHighBufferMerc=null,this._polyVerticesLowBufferMerc=null,this._polyIndexesBuffer=null,this._polyColorsBuffer=null,this._polyPickingColorsBuffer=null,this._lineVerticesHighBufferMerc=null,this._lineVerticesLowBufferMerc=null,this._lineIndexesBuffer=null,this._lineOrdersBuffer=null,this._lineColorsBuffer=null,this._linePickingColorsBuffer=null,this._lineThicknessBuffer=null,this._lineStrokeColorsBuffer=null,this._lineStrokesBuffer=null,this._updatedGeometryArr=[],this._updatedGeometry={},this._removeGeometryExtentArr=[],this._removeGeometryExtents={},this.refresh()}_deleteBuffers(){if(this._layer._planet&&this._layer._planet.renderer){let t=this._layer._planet.renderer.handler.gl;t&&(t.deleteBuffer(this._polyVerticesHighBufferMerc),t.deleteBuffer(this._polyVerticesLowBufferMerc),t.deleteBuffer(this._polyIndexesBuffer),t.deleteBuffer(this._polyColorsBuffer),t.deleteBuffer(this._polyPickingColorsBuffer),t.deleteBuffer(this._lineVerticesHighBufferMerc),t.deleteBuffer(this._lineVerticesLowBufferMerc),t.deleteBuffer(this._lineIndexesBuffer),t.deleteBuffer(this._lineOrdersBuffer),t.deleteBuffer(this._lineColorsBuffer),t.deleteBuffer(this._linePickingColorsBuffer),t.deleteBuffer(this._lineThicknessBuffer),t.deleteBuffer(this._lineStrokeColorsBuffer),t.deleteBuffer(this._lineStrokesBuffer))}}};ge.__counter__=0;let kr=ge;class _t extends zt{constructor(t,s={}){super(t,s),this.events=this.events.registerNames(gl),this.isVector=!0,this._hasImageryTiles=!1,this.scaleByDistance=s.scaleByDistance||[Ae,Ae,Ae],this._useLighting=s.useLighting===void 0||s.useLighting;let n=new Float32Array([1,1,1]);s.pickingScale!==void 0&&(s.pickingScale instanceof Array?(n[0]=s.pickingScale[0]||n[0],n[1]=s.pickingScale[1]||n[1],n[2]=s.pickingScale[2]||n[2]):typeof s.pickingScale=="number"&&(n[0]=s.pickingScale,n[1]=s.pickingScale,n[2]=s.pickingScale)),this.pickingScale=n,this.async=s.async===void 0||s.async,this.clampToGround=s.clampToGround||!1,this.relativeToGround=s.relativeToGround||!1,this._entities=function(o){let a=[];for(let l=0;l<o.length;l++){let c=o[l];c.instanceName==="Entity"?a.push(c):a.push(new G(c))}return a}(s.entities||[]),this._labelMaxLetters=s.labelMaxLetters||24,this._stripEntityCollection=new se({pickingEnabled:this.pickingEnabled}),this._bindEventsDefault(this._stripEntityCollection),this._polylineEntityCollection=new se({pickingEnabled:this.pickingEnabled}),this._bindEventsDefault(this._polylineEntityCollection),this._geoObjectEntityCollection=new se({pickingEnabled:this.pickingEnabled,useLighting:this._useLighting}),this._bindEventsDefault(this._geoObjectEntityCollection),this._geometryHandler=new kr(this),this._nodeCapacity=s.nodeCapacity||60,this._entityCollectionsTreeStrategy=null,this.setEntities(this._entities),this.polygonOffsetUnits=s.polygonOffsetUnits!=null?s.polygonOffsetUnits:0,this.pickingEnabled=this._pickingEnabled,this._depthOrder=s.depthOrder||0}get depthOrder(){return this._depthOrder}set depthOrder(t){t!==this._depthOrder&&(this._depthOrder=t,this._planet&&this._planet.updateVisibleLayers())}get useLighting(){return this._useLighting}set useLighting(t){t!==this._useLighting&&(this._geoObjectEntityCollection.useLighting=t,this._useLighting=t)}get labelMaxLetters(){return this._labelMaxLetters}get instanceName(){return"Vector"}_bindPicking(){this._pickingColor.clear()}addTo(t){this._planet||(this._assignPlanet(t),this._geometryHandler.assignHandler(t.renderer.handler),this._polylineEntityCollection.addTo(t,!0),this._stripEntityCollection.addTo(t,!0),this._geoObjectEntityCollection.addTo(t,!0),this._polylineEntityCollection._layer=this,this._stripEntityCollection._layer=this,this._geoObjectEntityCollection._layer=this,this.setEntities(this._entities))}remove(){return super.remove(),this._polylineEntityCollection.remove(),this._stripEntityCollection.remove(),this._geoObjectEntityCollection.remove(),this._polylineEntityCollection._layer=void 0,this._stripEntityCollection._layer=void 0,this._geoObjectEntityCollection._layer=void 0,this}getEntities(){return[].concat(this._entities)}add(t){return t._layer||t._entityCollection||(t._layer=this,t._layerIndex=this._entities.length,this._entities.push(t),this._proceedEntity(t)),this}insert(t,s){if(!t._layer&&!t._entityCollection){t._layer=this,t._layerIndex=s,this._entities.splice(s,0,t);for(let n=s+1,o=this._entities.length;n<o;n++)this._entities[n]._layerIndex=n;this._proceedEntity(t)}return this}_proceedEntity(t){var s;let n=this._hasImageryTiles;t.strip&&this._stripEntityCollection.add(t),(t.polyline||t.ray)&&this._polylineEntityCollection.add(t),(t.geoObject||t.isEmpty)&&this._geoObjectEntityCollection.add(t),t.geometry&&(this._hasImageryTiles=!0,this._planet&&(this._planet.renderer.assignPickingColor(t),this._geometryHandler.add(t.geometry))),this._planet&&((t.billboard||t.label||t.geoObject||t.isEmpty)&&(t._cartesian.isZero()&&!t._lonLat.isZero()?t._setCartesian3vSilent(this._planet.ellipsoid.lonLatToCartesian(t._lonLat)):(t._lonLat=this._planet.ellipsoid.cartesianToLonLat(t._cartesian),Math.abs(t._lonLat.lat)<ct?t._lonLatMerc=t._lonLat.forwardMercator():t._lonLatMerc.lon=t._lonLatMerc.lat=t._lonLatMerc.height=0)),(t.billboard||t.label)&&((s=this._entityCollectionsTreeStrategy)==null||s.insertEntity(t))),this._planet&&this._hasImageryTiles!==n&&this._planet.updateVisibleLayers(),this.events.dispatch(this.events.entityadd,t)}addEntities(t){let s=t.length;for(;s--;)this.add(t[s]);return this}removeEntity(t){if(t._layer&&this.isEqual(t._layer)){if(t.parent||(this._entities.splice(t._layerIndex,1),this._reindexEntitiesArray(t._layerIndex)),t._layer=null,t._layerIndex=-1,t._entityCollection){t._entityCollection._removeEntitySilent(t);let s=t._nodePtr;for(;s;)s.count--,s=s.parentNode;t._nodePtr&&t._nodePtr.count===0&&t._nodePtr.deferredEntities.length===0&&(t._nodePtr.entityCollection=null)}else if(t._nodePtr&&t._nodePtr.deferredEntities.length){let s=t._nodePtr.deferredEntities,n=s.length;for(;n--;)if(s[n].id===t.id){s.splice(n,1);let o=t._nodePtr;for(;o;)o.count--,o=o.parentNode;break}}this._planet&&t.geometry&&(this._geometryHandler.remove(t.geometry),this._planet.renderer.clearPickingColor(t)),t._nodePtr=void 0,this.events.dispatch(this.events.entityremove,t)}return this}set pickingEnabled(t){var s;this._pickingEnabled=t,this._stripEntityCollection.setPickingEnabled(t),this._polylineEntityCollection.setPickingEnabled(t),this._geoObjectEntityCollection.setPickingEnabled(t),(s=this._entityCollectionsTreeStrategy)==null||s.setPickingEnabled(t)}_reindexEntitiesArray(t){const s=this._entities;for(let n=t;n<s.length;n++)s[n]._layerIndex=n}removeEntities(t){let s=t.length;for(;s--;)this.removeEntity(t[s]);return this}clear(){var t;super.clear();let s=new Array(this._entities.length);for(let o=0;o<s.length;o++)s[o]=this._entities[o];let n=this._entities.length;for(;n--;)this._entities[n].remove();this._entities.length=0,this._entities=[];for(let o=0;o<s.length;o++)this._entities[o]=s[o];(t=this._entityCollectionsTreeStrategy)==null||t.dispose(),this._entityCollectionsTreeStrategy=null,this._geometryHandler.clear()}each(t){let s=this._entities,n=s.length;for(;n--;)t(s[n],n)}setEntities(t){let s=new Array(t.length);for(let o=0,a=t.length;o<a;o++)s[o]=t[o];this.clear(),this._entities=new Array(s.length);let n=[];for(let o=0;o<s.length;o++){let a=s[o];a._layer=this,a._layerIndex=o;let l=!(a.strip||a.polyline||a.ray||a.geoObject||a.billboard||a.label);a.strip?this._stripEntityCollection.add(a):a.polyline||a.ray?this._polylineEntityCollection.add(a):a.geoObject||l?this._geoObjectEntityCollection.add(a):(a.billboard||a.label)&&n.push(a),a.geometry&&(this._hasImageryTiles=!0,this._planet&&(this._planet.renderer.assignPickingColor(a),this._geometryHandler.add(a.geometry))),this._entities[o]=a}return this._createEntityCollectionsTree(n),this}_createEntityCollectionsTree(t){this._planet&&(this._entityCollectionsTreeStrategy=this._planet.quadTreeStrategy.createEntityCollectionsTreeStrategy(this,this._nodeCapacity),this._entityCollectionsTreeStrategy.insertEntities(t))}_bindEventsDefault(t){let s=this.events;t.events.on("mousemove",n=>{s.dispatch(s.mousemove,n)}),t.events.on("mouseenter",n=>{s.dispatch(s.mouseenter,n)}),t.events.on("mouseleave",n=>{s.dispatch(s.mouseleave,n)}),t.events.on("lclick",n=>{s.dispatch(s.lclick,n)}),t.events.on("rclick",n=>{s.dispatch(s.rclick,n)}),t.events.on("mclick",n=>{s.dispatch(s.mclick,n)}),t.events.on("ldblclick",n=>{s.dispatch(s.ldblclick,n)}),t.events.on("rdblclick",n=>{s.dispatch(s.rdblclick,n)}),t.events.on("mdblclick",n=>{s.dispatch(s.mdblclick,n)}),t.events.on("lup",n=>{s.dispatch(s.lup,n)}),t.events.on("rup",n=>{s.dispatch(s.rup,n)}),t.events.on("mup",n=>{s.dispatch(s.mup,n)}),t.events.on("ldown",n=>{s.dispatch(s.ldown,n)}),t.events.on("rdown",n=>{s.dispatch(s.rdown,n)}),t.events.on("mdown",n=>{s.dispatch(s.mdown,n)}),t.events.on("lhold",n=>{s.dispatch(s.lhold,n)}),t.events.on("rhold",n=>{s.dispatch(s.rhold,n)}),t.events.on("mhold",n=>{s.dispatch(s.mhold,n)}),t.events.on("mousewheel",n=>{s.dispatch(s.mousewheel,n)}),t.events.on("touchmove",n=>{s.dispatch(s.touchmove,n)}),t.events.on("touchstart",n=>{s.dispatch(s.touchstart,n)}),t.events.on("touchend",n=>{s.dispatch(s.touchend,n)}),t.events.on("doubletouch",n=>{s.dispatch(s.doubletouch,n)}),t.events.on("touchleave",n=>{s.dispatch(s.touchleave,n)}),t.events.on("touchenter",n=>{s.dispatch(s.touchenter,n)})}_collectStripCollectionPASS(t){let s=this._stripEntityCollection;s._fadingOpacity=this._fadingOpacity,s.scaleByDistance=this.scaleByDistance,s.pickingScale=this.pickingScale,s.polygonOffsetUnits=this.polygonOffsetUnits,t.push(s)}_collectPolylineCollectionPASS(t){let s=this._polylineEntityCollection;if(s._fadingOpacity=this._fadingOpacity,s.scaleByDistance=this.scaleByDistance,s.pickingScale=this.pickingScale,s.polygonOffsetUnits=this.polygonOffsetUnits,t.push(s),this.clampToGround||this.relativeToGround){let n=Number(this.relativeToGround);const o=this._planet.quadTreeStrategy._renderedNodes,a=this._planet.getViewExtent();let l=s._entities,c=l.length,d=new v;for(;c--;){let u=l[c]._altitude||0,_=l[c].polyline;if(_&&a.overlaps(_._extent)){let f=_._pathLonLatMerc,g=f.length;for(;g--;){let m=f[g].length;for(;m--;){let p=f[g][m],x=o.length;for(;x--;){let y=o[x].segment;if(y._extent.isInside(p)){let w=_._path3v[g][m];y.getTerrainPoint(w,p,d);let C=n&&_.altitude||u;if(C){let T=this._planet.ellipsoid.getSurfaceNormal3v(d);_.setPoint3v(d.addA(T.scale(C)),m,g,!0)}else _.setPoint3v(d,m,g,!0);break}}}}}}}}_collectGeoObjectCollectionPASS(t){let s=this._geoObjectEntityCollection;s._fadingOpacity=this._fadingOpacity,s.scaleByDistance=this.scaleByDistance,s.pickingScale=this.pickingScale,s.polygonOffsetUnits=this.polygonOffsetUnits,t.push(s)}collectVisibleCollections(t){let s=this._planet;(this._fading&&this._fadingOpacity>0||this.minZoom<=s.quadTreeStrategy.maxCurrZoom&&this.maxZoom>=s.quadTreeStrategy.maxCurrZoom)&&(this._collectStripCollectionPASS(t),this._collectPolylineCollectionPASS(t),this._collectGeoObjectCollectionPASS(t),this._entityCollectionsTreeStrategy&&this._entityCollectionsTreeStrategy.collectVisibleEntityCollections(t))}loadMaterial(t){const s=t.segment;this._isBaseLayer?t.texture=s._isNorth?s.planet.solidTextureOne:s.planet.solidTextureTwo:t.texture=s.planet.transparentTexture,this._planet.layerLock.isFree()&&(t.isReady=!1,t.isLoading=!0,this._planet._vectorTileCreator.add(t))}abortMaterialLoading(t){t.isLoading=!1,t.isReady=!1}applyMaterial(t){if(t.isReady)return[0,0,1,1];{!t.isLoading&&this.loadMaterial(t);const s=t.segment;let n=s.node,o=!1,a=this.__id,l=t;for(;n.parentNode;){if(l&&l.isReady){o=!0;break}n=n.parentNode,l=n.segment.materials[a]}if(o){t.appliedNodeId=n.nodeId,t.texture=l.texture,t.pickingMask=l.pickingMask;const c=1/(2<<s.tileZoom-n.segment.tileZoom-1);return[s.tileX*c-n.segment.tileX,s.tileY*c-n.segment.tileY,c,c]}return t.textureExists&&t._updateTexture?(t.texture=t._updateTexture,t.pickingMask=t._updatePickingMask):(t.texture=s.planet.transparentTexture,t.pickingMask=s.planet.transparentTexture),t.pickingReady=!0,[0,0,1,1]}}clearMaterial(t){if(t.isReady){const s=t.segment.handler.gl;t.isReady=!1,t.pickingReady=!1;let n=t.texture;t.texture=null,n&&!n.default&&s.deleteTexture(n),n=t.pickingMask,t.pickingMask=null,n&&!n.default&&s.deleteTexture(n),n=t._updateTexture,t._updateTexture=null,n&&!n.default&&s.deleteTexture(n),n=t._updatePickingMask,t._updatePickingMask=null,n&&!n.default&&s.deleteTexture(n)}this.abortMaterialLoading(t),t.isLoading=!1,t.textureExists=!1}update(){this._geometryHandler.update(),this.events.dispatch(this.events.draw,this)}}const gl=["draw","entityadd","entityremove"],pl=["change","startpoint"],Mn=$.createCylinder(1,1,2,20,1,!0,!1,0,-.5,0),kt=200,gi=.3;class oa extends de{constructor(t){super(t.name),this._cornerDblClick=!1,this._onChange=s=>{if(s.geometryType==="POLYGON"){let n=this.getCoordinates(),o=new G({geometry:{type:s.geometryType,coordinates:[n],style:this._fillStyle}});this._geometryLayer.clear(),this._geometryLayer.add(o)}},this._onCornerMouseEnter=s=>{s.renderer.handler.canvas.style.cursor="pointer",this.hideGhostPointer()},this._onCornerMouseLeave=s=>{s.renderer.handler.canvas.style.cursor="default",this.showGhostPointer()},this._onCenterMouseEnter=s=>{s.renderer.handler.canvas.style.cursor="pointer",this.hideGhostPointer()},this._onCenterMouseLeave=s=>{s.renderer.handler.canvas.style.cursor="default",this._pickedCenter||this._pickedCorner||this.showGhostPointer()},this._onLup=s=>{this._planet.renderer.controls.mouseNavigation.activate(),(this._pickedCorner||this._pickedCenter)&&(this.events.dispatch(this.events.change,this),this.setGhostPointerPosition(this._planet.getCartesianFromPixelTerrain(s)),this.showGhostPointer(),this._pickedCorner=null,this._pickedCenter=null)},this._onCornerLdown=s=>{this._pickedCorner=this._getLdown(s)},this._onCenterLdown=s=>{this._pickedCenter=this._getLdown(s)},this._onMouseMove=s=>{this._pickedCenter?this._moveCenterPoint():this._pickedCorner?this._moveCornerPoint(s.pos):this.setGhostPointerPosition(this._planet.getCartesianFromPixelTerrain(s.pos))},this._onCornerLdblclick=s=>{this._cornerDblClick=!0;let n=this.getCoordinates();n.splice(s.pickingObject.layerIndex,1),this.setCoordinates(n)},this._onMouseDblClick=s=>{if(this._cornerDblClick)return void(this._cornerDblClick=!1);if(!this._showGhostPointer)return;let n=this._planet.getCartesianFromPixelTerrain(s);n&&(this._addNew(n),!this._isStartPoint&&this._cornerLayer.getEntities().length>2&&(this._isStartPoint=!0,this.events.dispatch(this.events.startpoint,this)),this.events.dispatch(this.events.change,this))},this.events=lt(pl),this._planet=null,this._initCoordinates=t.coordinates||[],this._pickedCorner=null,this._pickedCenter=null,this._startPos=null,this._startClick=new H,this._geometryLayer=new _t,this._cornerStyle={scale:.5,tag:"corners",color:"rgb(350, 350, 0)",object3d:Mn,...t.cornerStyle||{}},this._centerStyle={scale:.4,tag:"centers",color:"rgb(0, 350, 50)",object3d:Mn,...t.centerStyle||{}},this._outlineStyle={thickness:3.5,color:"rgb(0, 350, 50)",...t.outlineStyle||{}},this._fillStyle={fillColor:"rgba(0,146,247,0.2)",...t.fillStyle||{}},this._cornerLayer=new _t("corners",{pickingScale:3,pickingEnabled:!0,polygonOffsetUnits:-5,relativeToGround:!0,scaleByDistance:[100,4e6,1]}),this._centerLayer=new _t("centers",{pickingScale:3,pickingEnabled:!0,polygonOffsetUnits:-5,relativeToGround:!0,scaleByDistance:[100,4e6,1]}),this._outlineLayer=new _t("outline",{entities:[new G({polyline:{path3v:[],isClosed:!1,...this._outlineStyle}})],pickingEnabled:!1,polygonOffsetUnits:-5,relativeToGround:!0}),this._outlineLayer.getEntities()[0].polyline.altitude=gi,this._ghostCorner=new G({geoObject:this._cornerStyle}),this._ghostOutlineLayer=new _t("ghost-pointer",{pickingEnabled:!1,polygonOffsetUnits:-5,relativeToGround:!0,scaleByDistance:[100,4e6,1],opacity:.5}),this._showGhostPointer=!1,this._isStartPoint=!1,this._insertCornerIndex=-1}get geometryType(){return"POLYGON"}getCoordinates(){let t=this._cornerLayer.getEntities();return t.length>0?t.map(s=>{let n=s.getLonLat();return[n.lon,n.lat,n.height]}):this._initCoordinates}bindPlanet(t){this._planet=t}init(){this._initEvents(),this._initGhostLayerPointer(),this._initCoordinates.length&&this.setCoordinates(this._initCoordinates),this._planet.addLayer(this._outlineLayer),this._planet.addLayer(this._cornerLayer),this._planet.addLayer(this._centerLayer),this.showGhostPointer(),this.startNewPoint(),this._geometryLayer.addTo(this._planet),this.events.on("change",this._onChange,this)}onremove(){this._clearEvents(),this.hideGhostPointer(),this.stopNewPoint(),this.clear(),this._geometryLayer.remove()}clear(){this._geometryLayer.clear();let t=this._cornerLayer.getEntities(),s=t.length;for(;s--;)t[s].remove();let n=this._centerLayer.getEntities();for(s=n.length;s--;)n[s].remove();let o=this._outlineLayer.getEntities();for(s=o.length;s--;)o[s].polyline.clear(),s>0&&o[s].remove();this._clearGhostPointer()}setCoordinates(t){this.clear();for(let s=0;s<t.length;s++){let n=t[s],o=this._planet.ellipsoid.lonLatToCartesian(new L(n[0],n[1],n[2]));this._appendCart(o)}this.events.dispatch(this.events.change,this)}stopNewPoint(){this.renderer&&this.renderer.events.off("ldblclick",this._onMouseDblClick)}startNewPoint(){this.renderer.events.on("ldblclick",this._onMouseDblClick,this)}showGhostPointer(){this._showGhostPointer=!0,this._planet.addLayer(this._ghostOutlineLayer),this._insertCornerIndex=this._cornerLayer.getEntities().length}hideGhostPointer(){this._showGhostPointer=!1,this._ghostOutlineLayer.remove(),this._insertCornerIndex=-1}setGhostPointerPosition(t){t&&(this._ghostCorner.setCartesian3v(t),this._updateGhostOutlinePointer(t))}_getLdown(t){this._planet.renderer.controls.mouseNavigation.deactivate(),this._startClick.set(t.x,t.y);let s=t.pickingObject.getCartesian();return this._startPos=this._planet.getPixelFromCartesian(s),t.pickingObject}_initEvents(){this._cornerLayer.events.on("ldblclick",this._onCornerLdblclick,this),this._cornerLayer.events.on("ldown",this._onCornerLdown,this),this._centerLayer.events.on("ldown",this._onCenterLdown,this),this.renderer.events.on("lup",this._onLup,this),this.renderer.events.on("mousemove",this._onMouseMove,this),this._cornerLayer.events.on("mouseenter",this._onCornerMouseEnter,this),this._cornerLayer.events.on("mouseleave",this._onCornerMouseLeave,this),this._centerLayer.events.on("mouseenter",this._onCenterMouseEnter,this),this._centerLayer.events.on("mouseleave",this._onCenterMouseLeave,this)}_clearEvents(){this._cornerLayer.events.off("ldblclick",this._onCornerLdblclick),this._cornerLayer.events.off("ldown",this._onCornerLdown),this._centerLayer.events.off("ldown",this._onCenterLdown),this.renderer.events.off("lup",this._onLup),this.renderer.events.off("mousemove",this._onMouseMove),this._cornerLayer.events.off("mouseenter",this._onCornerMouseEnter),this._cornerLayer.events.off("mouseleave",this._onCornerMouseLeave),this._centerLayer.events.off("mouseenter",this._onCenterMouseEnter),this._centerLayer.events.off("mouseleave",this._onCenterMouseLeave)}_drawCorners(){let t=this._cornerLayer.getEntities();for(let s=0;s<t.length;s++){let n=t[s];this._checkTerrainCollision(n)}}_drawCenters(){let t=this._centerLayer.getEntities();for(let s=0;s<t.length;s++){let n=t[s];this._checkTerrainCollision(n)}}_drawGhostCorner(){this._showGhostPointer&&this._checkTerrainCollision(this._ghostCorner)}frame(){this._drawCorners(),this._drawCenters(),this._drawGhostCorner()}_checkTerrainCollision(t){let s=new v,n=this._planet.quadTreeStrategy._renderedNodes;for(let o=0;o<n.length;o++){let a=n[o].segment;if(a&&a._extentLonLat.isInside(t.getLonLat())){a.getEntityTerrainPoint(t,s),t.setCartesian3v(s);break}}}_moveCenterPoint(){let t=this.getCoordinates(),s=this._pickedCenter.layerIndex+1,n=this._pickedCenter.getLonLat(),o=[n.lon,n.lat,n.height];t.splice(s,0,o),this.setCoordinates(t),this._pickedCenter=null,this._pickedCorner=this._cornerLayer.getEntities()[s]}_addNew(t){if(this._insertCornerIndex===-1||this._cornerLayer.getEntities().length<2)this._appendCart(t);else{let s=this.getCoordinates(),n=this._insertCornerIndex,o=this._planet.ellipsoid.cartesianToLonLat(t),a=[o.lon,o.lat,o.height];s.splice(n,0,a),this.clear(),this.setCoordinates(s)}}_appendCart(t){let s=this._cornerLayer.getEntities(),n=s[s.length-1],o=new G({geoObject:this._cornerStyle});if(o.setCartesian3v(t),o.addTo(this._cornerLayer),this._checkTerrainCollision(o),n){let a=s[0].getCartesian(),l=n.getCartesian(),c=o.getCartesian().sub(l),d=o.getCartesian().sub(a),u=c.length(),_=d.length();c.normalize(),d.normalize();let f=[],g=[];for(let T=0;T<=kt;T++){let P=c.scaleTo(T*u/kt).addA(l);f.push(P);let E=d.scaleTo(T*_/kt).addA(a);g.push(E)}this._outlineLayer.getEntities()[0].polyline.setPath3v([g]);let m=new G({polyline:{path3v:[f],isClosed:!1,...this._outlineStyle}});m.polyline.altitude=gi,this._outlineLayer.add(m);let p=this._centerLayer.getEntities(),x=p[p.length-1],y=c.scaleTo(.5*u).addA(l),w=d.scaleTo(.5*_).addA(a),C=new G({geoObject:this._centerStyle});C.setCartesian3v(y),C.addTo(this._centerLayer),this._checkTerrainCollision(C),x.remove(),x.addTo(this._centerLayer),x.setCartesian3v(w)}else new G({geoObject:this._centerStyle}).addTo(this._centerLayer)}_clearGhostPointer(){const t=this._ghostOutlineLayer;t.getEntities()[0].polyline.clear(),t.getEntities()[1].polyline.clear()}_moveCornerPoint(t){let s=new H(t.x,t.y).sub(this._startClick),n=this._startPos.add(s),o=this._planet.getCartesianFromPixelTerrain(n);if(o){this._pickedCorner.setCartesian3v(o);let a=this._cornerLayer.getEntities();if(a.length){let l=this._pickedCorner.layerIndex,c=a.length,d=a[l===0?c-1:l-1].getCartesian(),u=a[(l+1)%c].getCartesian(),_=this._pickedCorner.getCartesian().sub(d),f=this._pickedCorner.getCartesian().sub(u),g=_.length(),m=f.length();_.normalize(),f.normalize();let p=[],x=[];for(let R=0;R<=kt;R++){let k=_.scaleTo(R*g/kt).addA(d);p.push(k);let B=f.scaleTo(R*m/kt).addA(u);x.push(B)}let y=this._outlineLayer.getEntities(),w=y[l].polyline,C=y[(l+1)%c].polyline;w==null||w.setPath3v([p]),C==null||C.setPath3v([x]);let T=this._centerLayer.getEntities(),P=T[l===0?c-1:l-1],E=T[l],S=_.scaleTo(.5*g).addA(d),M=f.scaleTo(.5*m).addA(u);P.setCartesian3v(S),this._checkTerrainCollision(P),E.setCartesian3v(M),this._checkTerrainCollision(E)}}}_updateGhostOutlinePointer(t){let s=this._cornerLayer.getEntities(),n=s.length;if(n>0){let o=0,a=xt;for(let B=0;B<n;B++){let z=s[B].getCartesian().distance(t);z<a&&(a=z,o=B)}let l=s[o].getCartesian(),c=s[(o+1)%n].getCartesian(),d=s[o===0?n-1:o-1].getCartesian().sub(l).normalize(),u=c.sub(l).normalize(),_=t.sub(l).normalize(),f=d.add(u).normalize(),g=_.cross(f),m=d.cross(u);g.dot(m)>0&&(o--,o<0&&(o=n-1));let p=new v;for(let B=0;B<n;B++)if(new Jt(s[B].getCartesian(),s[(B+1)%n].getCartesian()).getNearestDistancePoint(t,p)){let z=p.distance(t);z<a&&(a=z,o=B)}this._insertCornerIndex=(o+1)%n;let x=s[o%n].getCartesian(),y=s[(o+1)%n].getCartesian(),w=this._ghostCorner.getCartesian().sub(x),C=this._ghostCorner.getCartesian().sub(y),T=w.length(),P=C.length();w.normalize(),C.normalize();let E=[],S=[];for(let B=0;B<=kt;B++){let z=w.scaleTo(B*T/kt).addA(x);E.push(z);let O=C.scaleTo(B*P/kt).addA(y);S.push(O)}let M=this._ghostOutlineLayer.getEntities(),R=M[0].polyline,k=M[1].polyline;R==null||R.setPath3v([E]),k==null||k.setPath3v([S])}}_initGhostLayerPointer(){this._ghostOutlineLayer.setEntities([new G({polyline:{path3v:[],isClosed:!1,...this._outlineStyle}}),new G({polyline:{path3v:[],isClosed:!1,...this._outlineStyle}}),this._ghostCorner]);const t=this._ghostOutlineLayer;t.getEntities()[0].polyline.altitude=t.getEntities()[1].polyline.altitude=gi}}class Bn extends oa{constructor(t){super(t)}get geometryType(){return"LineString"}_addNew(t){this._appendCart(t)}_appendCart(t){let s=this._cornerLayer.getEntities(),n=s[s.length-1],o=new G({geoObject:this._cornerStyle});if(o.setCartesian3v(t),o.addTo(this._cornerLayer),this._checkTerrainCollision(o),n){let a=n.getCartesian(),l=o.getCartesian().sub(a),c=l.length();l.normalize();let d=[];for(let g=0;g<=kt;g++){let m=l.scaleTo(g*c/kt).addA(a);d.push(m)}let u=new G({polyline:{path3v:[d],isClosed:!1,...this._outlineStyle}});u.polyline.altitude=gi,this._outlineLayer.add(u);let _=l.scaleTo(.5*c).addA(a),f=new G({geoObject:this._centerStyle});f.setCartesian3v(_),f.addTo(this._centerLayer),this._checkTerrainCollision(f)}}_clearGhostPointer(){this._ghostOutlineLayer.getEntities()[0].polyline.clear()}_moveCorner(t,s,n){let o=this._cornerLayer.getEntities();if(o.length==0)return;o.length==1&&(t=s=n=0);let a=o[t].getCartesian(),l=this._pickedCorner.getCartesian().sub(a),c=l.length();l.normalize();let d=[];for(let f=0;f<=kt;f++){let g=l.scaleTo(f*c/kt).addA(a);d.push(g)}let u=this._outlineLayer.getEntities()[s].polyline;u==null||u.setPath3v([d]);let _=this._centerLayer.getEntities()[n];if(_){let f=l.scaleTo(.5*c).addA(a);_.setCartesian3v(f),this._checkTerrainCollision(_)}}_moveCornerPoint(t){let s=new H(t.x,t.y).sub(this._startClick),n=this._startPos.add(s),o=this._planet.getCartesianFromPixelTerrain(n);if(o){this._pickedCorner.setCartesian3v(o);let a=this._cornerLayer.getEntities();if(a.length){let l=this._pickedCorner.layerIndex;l===0?this._moveCorner(l+1,l+1,l):(l===a.length-1||this._moveCorner(l+1,l+1,l),this._moveCorner(l-1,l,l-1))}}}_updateGhostOutlinePointer(t){let s=this._cornerLayer.getEntities(),n=s.length;if(n>0){let o=n-1;this._insertCornerIndex=o;let a=s[o].getCartesian(),l=this._ghostCorner.getCartesian().sub(a),c=l.length();l.normalize();let d=[];for(let u=0;u<=kt;u++){let _=l.scaleTo(u*c/kt).addA(a);d.push(_)}this._ghostOutlineLayer.getEntities()[0].polyline.setPath3v([d])}}_initGhostLayerPointer(){this._ghostOutlineLayer.setEntities([new G({polyline:{path3v:[],isClosed:!1,...this._outlineStyle}}),this._ghostCorner]),this._ghostOutlineLayer.getEntities()[0].polyline.altitude=gi}}class kn extends Q{constructor(t={}){super(t),this._drawingScene=new Bn({name:`drawingScene:${this.__id}`,cornerStyle:t.cornerStyle||{},centerStyle:t.centerStyle||{},outlineStyle:t.outlineStyle||{},fillStyle:t.fillStyle||{}})}activatePolygonDrawing(){this.deactivate(),this._drawingScene=new oa({name:`polygonDrawingScene:${this.__id}`,cornerStyle:this._drawingScene._cornerStyle,centerStyle:this._drawingScene._centerStyle,outlineStyle:this._drawingScene._outlineStyle,fillStyle:this._drawingScene._fillStyle}),this.activate()}activateLineStringDrawing(){this.deactivate(),this._drawingScene=new Bn({name:`linestringDrawingScene:${this.__id}`,cornerStyle:this._drawingScene._cornerStyle,centerStyle:this._drawingScene._centerStyle,outlineStyle:this._drawingScene._outlineStyle,fillStyle:this._drawingScene._fillStyle}),this.activate()}oninit(){}onactivate(){this.planet&&this._drawingScene.bindPlanet(this.planet),this.renderer&&this.renderer.addNode(this._drawingScene)}ondeactivate(){this.renderer&&this.renderer.removeNode(this._drawingScene)}}const li={ell:0,msl:1,gnd:2},sn=.3048,ml=1/sn,vl=1/3.6,aa=.001*sn,yl=1/aa,xl=["m","km","ft","s","h","m/s","km/h","ft/s"],la=[0,2,0,0,0,0,0,0];let pt=[];function ha(h,t,s){return pt[h][t](s)}function Ir(h,t,s,n,o){return h?ha(t,s,n).toFixed(o||la[s]):"--"}function ca(h){return xl[h]}pt[0]=[],pt[0][0]=h=>h,pt[0][1]=h=>.001*h,pt[0][2]=h=>h*ml,pt[2]=[],pt[2][0]=h=>h*sn,pt[2][1]=h=>h*aa,pt[2][2]=h=>h,pt[1]=[],pt[1][0]=h=>1e3*h,pt[1][1]=h=>h,pt[1][2]=h=>h*yl,pt[5]=[],pt[5][5]=h=>h,pt[5][6]=h=>3.6*h,pt[5][7]=h=>3.28084*h,pt[6]=[],pt[6][5]=h=>h*vl,pt[6][6]=h=>h;const In=Object.freeze(Object.defineProperty({__proto__:null,ELL:0,GND:2,MSL:1,_tenth:la,convert:ha,convertExt:Ir,ft:2,fts:7,h:4,heightMode:li,km:1,kmh:6,m:0,ms:5,s:3,toString:ca},Symbol.toStringTag,{value:"Module"})),bl=[`<div class="og-lat-side"></div><div class="og-lat-val"></div>
    <div class="og-lon-side"></div><div class="og-lon-val"></div>
    <div class="og-height"></div>
    <div class="og-units-height"></div>`,`<div class="og-lat-side"></div><div class="og-lat-val"></div>
    <div class="og-lon-side"></div><div class="og-lon-val"></div>
    <div class="og-height"></div>
    <div class="og-units-height"></div>`];class da extends Q{constructor(t={}){super(t),this._type=t.type||0,this._TYPE_FUNC=[this._SHOW_DECIMAL,this._SHOW_DEGREE],this._showFn=null,this._el=null,this._latSideEl=null,this._lonSideEl=null,this._latValEl=null,this._lonValEl=null,this._heightEl=null,this._altUnitVal=t.altitudeUnit||"m",this._heightModeVal=t.heightMode||"ell",this._altUnit=In[this._altUnitVal],this._heightMode=li[this._heightModeVal],this._lonLat=null,this._centerMode=!1}_SHOW_DECIMAL(t){if(t){let s=t.lat,n=t.lon;this._latSideEl.innerHTML=s>=0?"N":"S",this._lonSideEl.innerHTML=n>=0?"E":"W",this._latValEl.innerHTML=Math.abs(s).toFixed(7)+"°",this._lonValEl.innerHTML=Math.abs(n).toFixed(7)+"°"}}_SHOW_DEGREE(t){if(t){let s=t.lat,n=t.lon;this._latSideEl.innerHTML=s>=0?"N":"S",this._lonSideEl.innerHTML=n>=0?"E":"W";let o=0,a=s<0?Math.ceil(s):Math.floor(s),l=Math.floor(o=60*Math.abs(s-a)),c=Math.floor(6e3*(o-l))/100;this._latValEl.innerHTML=Math.abs(a)+"°"+l+"'"+c.toFixed(0)+'"',a=n<0?Math.ceil(n):Math.floor(n),l=Math.floor(o=60*Math.abs(n-a)),c=Math.floor(6e3*(o-l))/100,this._lonValEl.innerHTML=Math.abs(a)+"°"+l+"'"+c.toFixed(0)+'"'}}_createCenterEl(){let t=document.createElement("div");return t.className="og-center-icon",t.innerHTML='<svg width="12" height="12"><g><path stroke-width="1" stroke-opacity="1" d="M6 0L6 12M0 6L12 6" stroke="#337ab7"></path></g></svg>',t}_updateUnits(){this._heightMode=li[this._heightModeVal],this._altUnit=In[this._altUnitVal],this._el.querySelector(".og-units-height").innerHTML=ca(this._altUnit),this._showHeight()}_refreshCoordinates(){this._type>=this._TYPE_FUNC.length&&(this._type=0);let t=this._el;t.innerHTML=bl[this._type],this._latSideEl=t.querySelector(".og-lat-side"),this._lonSideEl=t.querySelector(".og-lon-side"),this._latValEl=t.querySelector(".og-lat-val"),this._lonValEl=t.querySelector(".og-lon-val"),this._heightEl=t.querySelector(".og-height"),this._showFn=this._TYPE_FUNC[this._type],this._showFn(this._lonLat)}oninit(){this._el=document.createElement("div"),this._el.classList.add("og-coordinates"),this.renderer.div.appendChild(this._el),this._el.addEventListener("click",()=>{this._type++,this._refreshCoordinates(),this._updateUnits(),this._showHeight()}),this._centerMode?(this.renderer.div.appendChild(this._createCenterEl()),this.planet.camera.events.on("moveend",this._grabCoordinates,this),this.planet.camera.events.on("moveend",yi(()=>this._showHeight(),400,!0),this)):(this.renderer.events.on("mousemove",this._grabCoordinates,this),this.renderer.events.on("mousestop",yi(()=>this._showHeight(),400,!0),this)),this._refreshCoordinates(),this._updateUnits()}_grabCoordinates(t){let s,n=t.pos,o=this.renderer;s=this._centerMode?o.handler.getCenter():n,this._lonLat=this.planet.getLonLatFromPixelTerrain(s)||null,this._showFn(this._lonLat)}async _showHeight(){if(this._lonLat&&this.planet){let t=0;this._heightEl.style.opacity="0.7",this._heightMode===li.ell?(t=await this.planet.getHeightAboveELL(this._lonLat),t=Number(Ir(!0,0,this._altUnit,t))):this._heightMode===li.msl&&(t=await this.planet.getHeightDefault(this._lonLat),t=Number(Ir(!0,0,this._altUnit,t))),this._heightEl.style.opacity="1.0",this._heightEl.innerHTML=t.toString()}}}const wl=["loadend"];class Ai extends zt{constructor(t,s={}){super(t,s),this.events=this.events.registerNames(wl),this._projType=0,this._frameWidth=256,this._frameHeight=256,this._sourceReady=!1,this._sourceTexture=null,this._materialTexture=null,this._gridBufferLow=null,this._gridBufferHigh=null,this._extentWgs84ParamsHigh=new Float32Array(4),this._extentWgs84ParamsLow=new Float32Array(4),this._extentMercParamsHigh=new Float32Array(4),this._extentMercParamsLow=new Float32Array(4),this._refreshFrame=!0,this._frameCreated=!1,this._sourceCreated=!1,this._animate=!1,this._ready=!1,this._creationProceeding=!1,this._isRendering=!1,this._extentWgs84=new U,this._cornersWgs84=[],this._cornersMerc=[],this._isFullExtent=s.fullExtent?1:0,this.rendering=this._renderingProjType0.bind(this),this._onLoadend_=null,s.corners&&this.setCorners(s.corners)}get isIdle(){return super.isIdle&&this._ready}addTo(t){return this._onLoadend_=this._onLoadend.bind(this),this.events.on("loadend",this._onLoadend_,this),super.addTo(t)}_onLoadend(){this._planet&&this._planet.events.dispatch(this._planet.events.layerloadend,this)}remove(){return this.events.off("loadend",this._onLoadend_),this._onLoadend_=null,super.remove()}get instanceName(){return"BaseGeoImage"}getCornersLonLat(){let t=this._cornersWgs84;return[new L(t[0].lon,t[0].lat),new L(t[1].lon,t[1].lat),new L(t[2].lon,t[2].lat),new L(t[3].lon,t[3].lat)]}getCorners(){let t=this._cornersWgs84;return[[t[0].lon,t[0].lat],[t[1].lon,t[1].lat],[t[2].lon,t[2].lat],[t[3].lon,t[3].lat]]}setCorners(t){this.setCornersLonLat(L.join(t))}setCornersLonLat(t){this._refreshFrame=!0,this._cornersWgs84=[t[0].clone(),t[1].clone(),t[2].clone(),t[3].clone()];for(let n=0;n<this._cornersWgs84.length;n++)this._cornersWgs84[n].lat>=89.9&&(this._cornersWgs84[n].lat=89.9),this._cornersWgs84[n].lat<=-89.9&&(this._cornersWgs84[n].lat=-89.9);this._extent.setByCoordinates(this._cornersWgs84);let s=this._extent;s.southWest.lat>ct||s.northEast.lat<Ot?(this._projType=0,this.rendering=this._renderingProjType0):(this._projType=1,this.rendering=this._renderingProjType1),this._ready&&!this._creationProceeding&&this._planet._geoImageCreator.add(this)}_createFrame(){this._extentWgs84=this._extent.clone(),this._cornersMerc=[this._cornersWgs84[0].forwardMercatorEPS01(),this._cornersWgs84[1].forwardMercatorEPS01(),this._cornersWgs84[2].forwardMercatorEPS01(),this._cornersWgs84[3].forwardMercatorEPS01()],this._extentMerc=new U(this._extentWgs84.southWest.forwardMercatorEPS01(),this._extentWgs84.northEast.forwardMercatorEPS01());let t=new Float32Array(2);if(this._projType===0?(ae(this._extentWgs84.southWest.lon,t),this._extentWgs84ParamsHigh[0]=t[0],this._extentWgs84ParamsLow[0]=t[1],ae(this._extentWgs84.southWest.lat,t),this._extentWgs84ParamsHigh[1]=t[0],this._extentWgs84ParamsLow[1]=t[1],this._extentWgs84ParamsHigh[2]=2/this._extentWgs84.getWidth(),this._extentWgs84ParamsHigh[3]=2/this._extentWgs84.getHeight()):(ae(this._extentMerc.southWest.lon,t),this._extentMercParamsHigh[0]=t[0],this._extentMercParamsLow[0]=t[1],ae(this._extentMerc.southWest.lat,t),this._extentMercParamsHigh[1]=t[0],this._extentMercParamsLow[1]=t[1],this._extentMercParamsHigh[2]=2/this._extentMerc.getWidth(),this._extentMercParamsHigh[3]=2/this._extentMerc.getHeight()),this._planet){let s=this._planet.renderer.handler;s.gl.deleteTexture(this._materialTexture),this._materialTexture=s.createEmptyTexture_l(this._frameWidth,this._frameHeight);let n=this._planet._geoImageCreator.createGridBuffer(this._cornersWgs84,this._projType===1);this._gridBufferHigh=n[0],this._gridBufferLow=n[1],this._refreshFrame=!1}}abortMaterialLoading(t){this._creationProceeding=!1,t.isLoading=!1,t.isReady=!1}clear(){let t=this._planet;if(t){let s=t.renderer.handler.gl;this._creationProceeding&&t._geoImageCreator.remove(this),t._clearLayerMaterial(this),s&&(s.deleteBuffer(this._gridBufferHigh),s.deleteBuffer(this._gridBufferLow),s.deleteTexture(this._sourceTexture),this._materialTexture&&!this._materialTexture.default&&s.deleteTexture(this._materialTexture))}this._sourceTexture=null,this._materialTexture=null,this._gridBufferHigh=null,this._gridBufferLow=null,this._refreshFrame=!0,this._sourceCreated=!1,this._ready=!1,this._creationProceeding=!1}setVisibility(t){t!==this._visibility&&(super.setVisibility(t),this._planet&&this._sourceReady&&(t?this._planet._geoImageCreator.add(this):this._planet._geoImageCreator.remove(this)))}clearMaterial(t){t.texture=null,t.isLoading=!1,t.isReady=!1}applyMaterial(t){let s,n,o=t.segment;this._ready?t.applyTexture(this._materialTexture):(t.texture=this._planet.transparentTexture,!this._creationProceeding&&this.loadMaterial(t)),this._projType===0?(s=this._extentWgs84,n=o._extent):(s=this._extentMerc,n=o.getExtentMerc());let a=s.northEast.lon-s.southWest.lon,l=s.northEast.lat-s.southWest.lat;return[(n.southWest.lon-s.southWest.lon)/a,(s.northEast.lat-n.northEast.lat)/l,(n.northEast.lon-n.southWest.lon)/a,(n.northEast.lat-n.southWest.lat)/l]}get getFrameWidth(){return this._frameWidth}get getFrameHeight(){return this._frameHeight}_createSourceTexture(){}_renderingProjType1(){let t=this._planet,s=t.renderer.handler,n=s.gl,o=t._geoImageCreator;this._refreshFrame&&this._createFrame(),this._createSourceTexture();let a=o._framebuffer;a.setSize(this._frameWidth,this._frameHeight),a.activate(),s.programs.geoImageTransform.activate();let l=s.programs.geoImageTransform._program,c=l.attributes,d=l.uniforms;n.disable(n.CULL_FACE),a.bindOutputTexture(this._materialTexture),n.clearColor(0,0,0,0),n.clear(n.COLOR_BUFFER_BIT),n.uniform1i(d.isFullExtent,this._isFullExtent),n.bindBuffer(n.ARRAY_BUFFER,o._texCoordsBuffer),n.vertexAttribPointer(c.texCoords,2,n.UNSIGNED_SHORT,!0,0,0),n.bindBuffer(n.ARRAY_BUFFER,this._gridBufferHigh),n.vertexAttribPointer(c.cornersHigh,this._gridBufferHigh.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,this._gridBufferLow),n.vertexAttribPointer(c.cornersLow,this._gridBufferLow.itemSize,n.FLOAT,!1,0,0),n.uniform4fv(d.extentParamsHigh,this._extentMercParamsHigh),n.uniform4fv(d.extentParamsLow,this._extentMercParamsLow),n.activeTexture(n.TEXTURE0),n.bindTexture(n.TEXTURE_2D,this._sourceTexture),n.uniform1i(d.sourceTexture,0),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,o._indexBuffer),n.drawElements(n.TRIANGLE_STRIP,o._indexBuffer.numItems,n.UNSIGNED_INT,0),a.deactivate(),n.enable(n.CULL_FACE),this._ready=!0,this._creationProceeding=!1}_renderingProjType0(){let t=this._planet,s=t.renderer.handler,n=s.gl,o=t._geoImageCreator;this._refreshFrame&&this._createFrame(),this._createSourceTexture();let a=o._framebuffer;a.setSize(this._frameWidth,this._frameHeight),a.activate(),s.programs.geoImageTransform.activate();let l=s.programs.geoImageTransform._program,c=l.attributes,d=l.uniforms;n.disable(n.CULL_FACE),a.bindOutputTexture(this._materialTexture),n.clearColor(0,0,0,0),n.clear(n.COLOR_BUFFER_BIT),n.bindBuffer(n.ARRAY_BUFFER,o._texCoordsBuffer),n.vertexAttribPointer(c.texCoords,2,n.UNSIGNED_SHORT,!0,0,0),n.bindBuffer(n.ARRAY_BUFFER,this._gridBufferHigh),n.vertexAttribPointer(c.cornersHigh,this._gridBufferHigh.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,this._gridBufferLow),n.vertexAttribPointer(c.cornersLow,this._gridBufferLow.itemSize,n.FLOAT,!1,0,0),n.uniform4fv(d.extentParamsHigh,this._extentWgs84ParamsHigh),n.uniform4fv(d.extentParamsLow,this._extentWgs84ParamsLow),n.activeTexture(n.TEXTURE0),n.bindTexture(n.TEXTURE_2D,this._sourceTexture),n.uniform1i(d.sourceTexture,0),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,o._indexBuffer),n.drawElements(n.TRIANGLE_STRIP,o._indexBuffer.numItems,n.UNSIGNED_INT,0),a.deactivate(),n.enable(n.CULL_FACE),this._ready=!0,this._creationProceeding=!1}}const W={MB_LEFT:0,MB_RIGHT:2,MB_MIDDLE:1,KEY_CTRL:17,KEY_ALT:18,KEY_SHIFT:16,KEY_LEFT:37,KEY_UP:38,KEY_RIGHT:39,KEY_DOWN:40,KEY_PRINTSCREEN:44,KEY_A:65,KEY_D:68,KEY_E:69,KEY_Q:81,KEY_S:83,KEY_W:87,KEY_X:88,KEY_APOSTROPHE:192},Tl=["change","idle","play","pause","stop"];class Cl extends ut{constructor(t){super({template:Dt('<button title={title} class="og-layerSwitcher__layerButton">{icon}<div class="og-layerSwitcher__name">{name}</div></button>',{title:t.model.name,name:t.model.name,icon:t.model.iconSrc?`<img src="${t.model.iconSrc}" />`:""}),...t}),this._onVisibilityChange=s=>{this.el&&(this.model.getVisibility()?this.el.classList.add("og-layerSwitcher__visible"):this.el.classList.remove("og-layerSwitcher__visible"))},this._onClick=()=>{this.model.isBaseLayer()?this.model.setVisibility(!0):this.model.setVisibility(!this.model.getVisibility())},this._onDblClick=()=>{this.model.flyExtent()}}render(t){return super.render(t),this.model.events.on("visibilitychange",this._onVisibilityChange),this._onVisibilityChange(this.model),this.el.addEventListener("click",this._onClick),this.el.addEventListener("dblclick",this._onDblClick),this}remove(){super.remove(),this.model.events.off("visibilitychange",this._onVisibilityChange)}}const El=["change"];class Z extends ut{constructor(t={}){super({template:Dt(`<div class="og-slider">
      <div class="og-slider-label">{label}</div>
      <div class="og-slider-panel">
        <div class="og-slider-progress"></div>      
        <div class="og-slider-pointer"></div>
      </div>
      <input type="number"/>
    </div>`,{label:t.label||""})}),this._onResize=()=>{this._setOffset((this._value-this._min)*this.$panel.clientWidth/(this._max-this._min))},this._onMouseWheel=s=>{(s=s||window.event).preventDefault(),s.stopPropagation(),this.value=this._value+Math.sign(s.wheelDelta)*(this._max-this._min)/100},this._onMouseWheelFF=s=>{this._onMouseWheel(s)},this._onInput=s=>{(s=s||window.event).preventDefault(),s.stopPropagation(),this.value=parseFloat(s.target.value)},this._onMouseDown=s=>{(s=s||window.event).preventDefault(),this._startPosX=s.clientX,this.value=this._min+(this._max-this._min)*(s.offsetX/this.$panel.clientWidth),document.addEventListener("mousemove",this._onMouseMove),document.addEventListener("mouseup",this._onMouseUp)},this._onMouseMove=s=>{(s=s||window.event).preventDefault(),s.stopPropagation();let n=this.$panel.getBoundingClientRect(),o=Zi(s.clientX,n.left,n.right),a=this._startPosX-o;this._startPosX=o,this.value=this._value-a*(this._max-this._min)/this.$panel.clientWidth},this._onMouseUp=()=>{document.removeEventListener("mouseup",this._onMouseUp),document.removeEventListener("mousemove",this._onMouseMove)},this.events=this.events.registerNames(El),this._value=t.value||0,this._min=t.min||0,this._max=t.max||1,this._resizeObserver=new ResizeObserver(this._onResize),this._startPosX=0,this.$label=null,this.$pointer=null,this.$progress=null,this.$input=null,this.$panel=null}render(t){return super.render(t),this.$label=this.select(".og-slider-label"),this.$label.innerHTML===""&&(this.$label.style.display="none"),this.$pointer=this.select(".og-slider-pointer"),this.$progress=this.select(".og-slider-progress"),this.$panel=this.select(".og-slider-panel"),this.$input=this.select("input"),this._resizeObserver.observe(this.el),this._initEvents(),this}set value(t){t!==this._value&&(this._value=Zi(t,this._min,this._max),this.$input.value=this._value.toString(),this._setOffset((this._value-this._min)*this.$panel.clientWidth/(this._max-this._min)),this.events.dispatch(this.events.change,this._value,this))}get value(){return this._value}_initEvents(){this.$panel.addEventListener("mousedown",this._onMouseDown),this.$panel.addEventListener("mousewheel",this._onMouseWheel),this.$panel.addEventListener("wheel",this._onMouseWheelFF),this.$input.addEventListener("input",this._onInput)}_clearEvents(){this.$panel.removeEventListener("mousedown",this._onMouseDown),this.$panel.removeEventListener("mousewheel",this._onMouseWheel),this.$panel.removeEventListener("wheel",this._onMouseWheelFF),this.$input.removeEventListener("input",this._onInput)}_setOffset(t){t>=0&&t<=this.$panel.clientWidth&&(this.$pointer.style.left=this.$progress.style.width=100*t/this.$panel.clientWidth+"%")}remove(){this._clearEvents(),super.remove()}set max(t){this._max=t,this.events.stopPropagation(),this.value=this._value+Math.sign(e.wheelDelta)*(this._max-this._min)/100}get max(){return this._max}}const Al=["input"];let Ll=0;class zn extends ut{constructor(t={}){super({template:Dt(`<div class="og-color">
      <label for="{id}" class="og-color-label">{label}</label>
      <input type="color" name="{id}" value="{value}"/>
    </div>`,{id:"color-"+Ll++,label:t.label||"",value:t.value||"#000000"})}),this._onInput=s=>{this.value=s.target.value},this.events=this.events.registerNames(Al),this._value=t.value||"blue",this.$label=null,this.$input=null}render(t){return super.render(t),this.$label=this.select(".og-color-label"),this.$label.innerHTML===""&&(this.$label.style.display="none"),this.$input=this.select("input"),this._initEvents(),this}set value(t){t!==this._value&&(this._value=t,this.$input.value=this._value,this.events.dispatch(this.events.input,this._value,this))}get value(){return this._value}_initEvents(){this.$input.addEventListener("input",this._onInput)}_clearEvents(){this.$input.removeEventListener("input",this._onInput)}remove(){this._clearEvents(),super.remove()}}class zr{constructor(){this._lock=0}lock(t){this._lock|=1<<t.id}free(t){this._lock&=~(1<<t.id)}isFree(){return this._lock===0}isLocked(){return this._lock!==0}}const Ps=class wd{constructor(){this.__id=wd.__counter__++}get id(){return this.__id}};Ps.__counter__=0;let Me=Ps;class rn extends Q{constructor(t={}){super(t),this._deactivate=!1,this._shiftBusy=!1,this._name="mouseNavigation",this.grabbedPoint=new v,this._eye0=new v,this.pointOnEarth=new v,this.earthUp=new v,this.inertia=.007,this.grabbedSpheroid=new Ft,this.qRot=new F,this.scaleRot=0,this.distDiff=.3,this.stepsCount=8,this.stepsForward=null,this.stepIndex=0,this._lmbDoubleClickActive=!0,this.minSlope=t.minSlope||.1,this._wheelDirection=1,this._keyLock=new Me}static getMovePointsFromPixelTerrain(t,s,n,o,a,l,c){const d=[];let u=t.eye.clone(),_=t.getBackward(),f=t.getRight(),g=t.getUp(),m=s.getCartesianFromPixelTerrain(a);if(m||(m=s.getCartesianFromPixelTerrain(s.renderer.handler.getCenter())),m){c||(c=v.sub(m,t.eye).normalize());let p=o*t.eye.distance(m)/n;p*=l?-1.25:2;const x=_.scaleTo(p);if(c.dot(t.eye.normal().negate())>=.1){const y=new Ft;y.radius=m.length();let w=[],C=[],T=!1;for(let P=0;P<n;P++){u.addA(x);const E=new V(u,c).hitSphere(y);if(C[P]=u.clone(),!E){T=!0;break}w[P]=new tt().rotateBetweenVectors(m.normal(),E.normal())}if(T){u=t.eye.clone();for(let P=0;P<n;P++)d[P]={eye:u.addA(x).clone(),v:g,u:f,n:_}}else for(let P=0;P<n;P++){let E=w[P];d[P]={eye:E.mulVec3(C[P]),v:E.mulVec3(g),u:E.mulVec3(f),n:E.mulVec3(_)}}}else for(let y=0;y<n;y++)d[y]={eye:u.addA(c.scaleTo(-p)).clone(),v:g,u:f,n:_};return d}}onactivate(){this.renderer&&(this.renderer.events.on("mousewheel",this.onMouseWheel,this),this.renderer.events.on("lhold",this.onMouseLeftButtonDown,this),this.renderer.events.on("rhold",this.onMouseRightButtonDown,this),this.renderer.events.on("ldown",this.onMouseLeftButtonClick,this),this.renderer.events.on("lup",this.onMouseLeftButtonUp,this),this.renderer.events.on("rdown",this.onMouseRightButtonClick,this),this.renderer.events.on("draw",this.onDraw,this,-1e3),this.renderer.events.on("mousemove",this.onMouseMove,this),this.renderer.events.on("mouseleave",this.onMouseLeave,this),this.renderer.events.on("mouseenter",this.onMouseEnter,this),this._lmbDoubleClickActive&&this.renderer.events.on("ldblclick",this.onMouseLeftButtonDoubleClick,this))}ondeactivate(){this.renderer&&(this.renderer.events.off("mousewheel",this.onMouseWheel),this.renderer.events.off("lhold",this.onMouseLeftButtonDown),this.renderer.events.off("rhold",this.onMouseRightButtonDown),this.renderer.events.off("ldown",this.onMouseLeftButtonClick),this.renderer.events.off("lup",this.onMouseLeftButtonUp),this.renderer.events.off("rdown",this.onMouseRightButtonClick),this.renderer.events.off("draw",this.onDraw),this.renderer.events.off("ldblclick",this.onMouseLeftButtonDoubleClick),this.renderer.events.off("mouseleave",this.onMouseLeave),this.renderer.events.off("mouseenter",this.onMouseEnter))}activateDoubleClickZoom(){this._lmbDoubleClickActive||(this._lmbDoubleClickActive=!0,this.renderer&&this.renderer.events.on("ldblclick",this.onMouseLeftButtonDoubleClick,this))}deactivateDoubleClickZoom(){this._lmbDoubleClickActive&&(this._lmbDoubleClickActive=!1,this.renderer&&this.renderer.events.off("ldblclick",this.onMouseLeftButtonDoubleClick))}onMouseEnter(t){const s=this.renderer.events;s.isKeyPressed(W.KEY_ALT)&&s.releaseKeys(),s.updateButtonsStates(t.sys.buttons),s.mouseState.leftButtonDown?this.renderer.handler.canvas.classList.add("ogGrabbingPoiner"):this.renderer.handler.canvas.classList.remove("ogGrabbingPoiner")}onMouseLeave(){this.renderer.events.mouseState.leftButtonDown&&(this.scaleRot=0),this.renderer.handler.canvas.classList.remove("ogGrabbingPoiner")}onMouseWheel(t){this.stepIndex||(this.planet.stopFlying(),this.stopRotation(),this._deactivate=!0,this.lockPlanet(!0),this.stepsForward=rn.getMovePointsFromPixelTerrain(this.planet.camera,this.planet,this.stepsCount,this.distDiff,t.pos,t.wheelDelta>0,t.direction)||null,this._wheelDirection=t.wheelDelta,this.stepsForward&&(this.stepIndex=this.stepsCount))}oninit(){this.activate(),this.renderer&&(this.renderer.events.on("keyfree",W.KEY_ALT,this.onShiftFree,this),this.renderer.events.on("keyfree",W.KEY_PRINTSCREEN,this.onShiftFree,this))}onMouseLeftButtonDoubleClick(t){this.planet.stopFlying(),this.stopRotation();const s=this.planet.getCartesianFromPixelTerrain(t.pos);if(s){const n=this.planet.camera;let o=n.maxAltitude+this.planet.ellipsoid.polarSize,a=n.minAltitude+this.planet.ellipsoid.polarSize;const l=n.eye.length(),c=this.planet.ellipsoid.cartesianToLonLat(s);if(l>o||l<a)return void this.planet.flyLonLat(new L(c.lon,c.lat));this.renderer.events.isKeyPressed(W.KEY_ALT)?this.planet.flyLonLat(new L(c.lon,c.lat,2*n.eye.distance(s))):this.planet.flyLonLat(new L(c.lon,c.lat,.57*n.eye.distance(s)))}}onMouseLeftButtonClick(){this._active&&(this.renderer.handler.canvas.classList.add("ogGrabbingPoiner"),this.grabbedPoint=this.planet.getCartesianFromMouseTerrain(),this.grabbedPoint&&(this._eye0.copy(this.planet.camera.eye),this.grabbedSpheroid.radius=this.grabbedPoint.length(),this.stopRotation()))}stopRotation(){this.qRot.clear(),this.freePlanet()}onMouseLeftButtonUp(t){this.renderer.handler.canvas.classList.remove("ogGrabbingPoiner"),t.x===t.prev_x&&t.y===t.prev_y&&(this.scaleRot=0)}onMouseLeftButtonDown(t){if(this._active){if(!this.grabbedPoint)return;if(this.planet.stopFlying(),t.moving){let s=this.planet.camera;if(s.slope>.2){const n=new V(s.eye,t.direction).hitSphere(this.grabbedSpheroid);if(n){this.scaleRot=1,this.qRot=F.getRotationBetweenVectors(n.normal(),this.grabbedPoint.normal());let o=this.qRot;s.eye=o.mulVec3(s.eye),s.rotate(o)}}else{let n=this.grabbedPoint,o=v.add(n,s.getRight()),a=v.add(n,n.normal()),l=new v;new V(s.eye,t.direction).hitPlaneRes(vt.fromPoints(n,o,a),l)===V.INSIDE&&(s.eye=this._eye0.addA(l.subA(n).negate()))}}}}onMouseRightButtonClick(t){this.stopRotation(),this.planet.stopFlying(),this.pointOnEarth=this.planet.getCartesianFromPixelTerrain(t.pos),this.pointOnEarth&&(this.earthUp=this.pointOnEarth.normal())}onMouseRightButtonDown(t){const s=this.planet.camera;if(this.pointOnEarth&&t.moving){this.renderer.controlsBag.scaleRot=1;let n=.5/s.eye.distance(this.pointOnEarth)*s._lonLat.height*j;n>.007?n=.007:n<.003&&(n=.003),s.rotateHorizontal(n*(t.x-t.prev_x),!1,this.pointOnEarth,this.earthUp),s.rotateVertical(n*(t.y-t.prev_y),this.pointOnEarth,this.minSlope)}}onShiftFree(){this._shiftBusy=!1}onMouseMove(t){this._active&&this.renderer.events.isKeyPressed(W.KEY_ALT)&&(this._shiftBusy||(this._shiftBusy=!0,this.onMouseRightButtonClick(t)),this.onMouseRightButtonDown(t))}onDraw(){if(this._active){const t=this.renderer,s=this.planet.camera;let n=s.eye.clone();if(this.stepIndex){t.controlsBag.scaleRot=1;const o=this.stepsForward[this.stepsCount-this.stepIndex--];s.eye=o.eye,s._u=o.v,s._r=o.u,s._b=o.n,s._f.set(-s._b.x,-s._b.y,-s._b.z)}else this._deactivate&&(this._deactivate=!1,this.freePlanet());if(t.events.mouseState.leftButtonDown||!this.scaleRot)return;if(this.scaleRot-=this.inertia,this.scaleRot<=0)this.scaleRot=0;else{t.controlsBag.scaleRot=this.scaleRot;let o=this.qRot.slerp(F.IDENTITY,1-this.scaleRot*this.scaleRot*this.scaleRot).normalize();o.x||o.y||o.z||(this.scaleRot=0),s.eye=o.mulVec3(s.eye),s.rotate(o)}s.eye.distance(n)/s.getAltitude()>.01?this.lockPlanet():this.freePlanet()}}lockPlanet(t){this.planet.layerLock.lock(this._keyLock),!t&&this.planet.terrainLock.lock(this._keyLock),this.planet._normalMapCreator.lock(this._keyLock)}freePlanet(){this.planet.layerLock.free(this._keyLock),this.planet.terrainLock.free(this._keyLock),this.planet._normalMapCreator.free(this._keyLock)}}const Pl=["drag","zoom","rotate"],zi=.96;class Yi extends Q{constructor(t={}){super({name:"navigation",autoActivate:!0,...t}),this._freeMode=!1,this._shiftBusy=!1,this._hold=!1,this._onShiftFree=()=>{this._shiftBusy=!1},this._onCameraFly=()=>{this.stop()},this._onMouseMove=s=>{this._active&&this.renderer.events.isKeyPressed(W.KEY_ALT)&&(this._shiftBusy||(this._shiftBusy=!0,this._onRHold(s)),this._onRDown(s))},this._onMouseEnter=s=>{const n=this.renderer.events;n.isKeyPressed(W.KEY_ALT)&&n.releaseKeys(),n.updateButtonsStates(s.sys.buttons),n.mouseState.leftButtonDown?this.renderer.handler.canvas.classList.add("ogGrabbingPoiner"):this.renderer.handler.canvas.classList.remove("ogGrabbingPoiner")},this._onMouseLeave=()=>{this.renderer.events.mouseState.leftButtonDown&&this.vel.scale(0),this.renderer.handler.canvas.classList.remove("ogGrabbingPoiner")},this._onRHold=s=>{if((!this.disableRotation||!this.disableTilt)&&this._targetRotationPoint){this._velInertia=.6,this.disableRotation||(this.force_h=.5*(s.x-s.prev_x)),this.disableTilt||(this.force_v=.5*(s.y-s.prev_y));let n=this.planet.camera.getHeading();this._freeMode=!1,!isNaN(n)&&n>45&&n<340&&(this._freeMode=!0)}},this._onRDown=s=>{if((!this.disableRotation||!this.disableTilt)&&this.planet){this.planet.stopFlying();const n=this._getTargetPoint(s.pos);this._targetRotationPoint=n||null,n&&(this._targetZoomPoint=null,this._targetDragPoint=null,this.vel.set(0,0,0),this._tUp=n.getNormal(),this._tRad=this.planet.camera.eye.distance(n))}},this._onMouseWheel=s=>{if(this.planet){this._targetRotationPoint=null,this._targetDragPoint=null;let n=s.x,o=s.y,a=this.planet.camera;if(a.isOrthographic){n=.5*this.renderer.handler.getWidth(),o=.5*this.renderer.handler.getHeight();let u=this._getTargetPoint(new H(n,o));if(!u)return;this._targetZoomPoint=u,this._grabbedSphere.radius=this._targetZoomPoint.length();let _=a.eye.distance(u),f=new v,g=a.unproject(n,o,_,f);const m=f.sub(g.scaleTo(_));if(u=new V(m,g).hitSphere(this._grabbedSphere),!u)return;this._targetZoomPoint=u}else{let u=this._getTargetPoint(new H(n,o));if(!u)return;this._targetZoomPoint=u,this._grabbedSphere.radius=this._targetZoomPoint.length()}if(this._curPitch=a.getPitch(),this._curYaw=a.getYaw(),this._curRoll=a.getRoll(),Math.sign(s.wheelDelta)!==this._wheelDirection)return this.vel.scale(.3),this._currScreenPos.set(n,o),void(this._wheelDirection=Math.sign(s.wheelDelta));this._currScreenPos.set(n,o),this._wheelDirection=Math.sign(s.wheelDelta);let l=20;this._velInertia=.83,this._isTouchPad=s.isTouchPad,s.isTouchPad&&(this._velInertia=.63,l=17);let c=this._targetZoomPoint.sub(a.eye);c.length()>6e3&&this._wheelDirection>0&&a.eye.getNormal().negate().dot(c.normalize())<.3&&(l=4.3);let d=this.planet.camera.eye.distance(this._targetZoomPoint)*l;this.force=s.direction.scale(this._wheelDirection).normalize().scale(this._wheelDirection<0?1.3*d:d).scale(this.zoomSpeed),this.vel.set(0,0,0),this.force_roll=this._curRoll}},this._onLDown=s=>{this.stop(),this._targetRotationPoint=null,this._targetZoomPoint=null,this.planet&&(this.planet.stopFlying(),this._grabbedPoint=this._getTargetPoint(s.pos),this._grabbedPoint&&(this._targetDragPoint=this._grabbedPoint,this.planet.camera.isOrthographic?this._grabbedDist=this.renderer.getDistanceFromPixel(s.pos):this._grabbedDist=this.renderer.activeCamera.eye.distance(this._grabbedPoint),this.renderer.handler.canvas.classList.add("ogGrabbingPoiner"),this._grabbedSphere.radius=this._grabbedPoint.length(),this._eye0=this.planet.camera.eye.clone(),this._grabbedCameraHeight=this._eye0.length(),this._curPitch=this.planet.camera.getPitch(),this._curYaw=this.planet.camera.getYaw(),this._curRoll=this.planet.camera.getRoll(),this._currScreenPos.copy(s.pos)))},this._onLHold=s=>{if(this._grabbedPoint&&this.planet){let n=this.planet.camera;if(n.isOrthographic){const o=this._grabbedDist,a=new v,l=n.unproject(s.x,s.y,o,a),c=a.sub(l.scaleTo(o)),d=new V(c,l).hitSphere(this._grabbedSphere);if(!d)return;this._targetDragPoint=d;let u=F.getRotationBetweenVectors(this._targetDragPoint.getNormal(),this._grabbedPoint.getNormal()).mulVec3(n.eye);this.force=u.sub(n.eye).scale(this.dragInertia)}else if(n.slope>this.minSlope){this._grabbedDist=n.eye.distance(this._grabbedPoint);let o,a=n.unproject(s.x,s.y,this._grabbedDist),l=new V(n.eye,a).hitSphere(this._grabbedSphere);if(!l)return;if(this._targetDragPoint=l,this.freeMode)o=F.getRotationBetweenVectors(this._targetDragPoint.getNormal(),this._grabbedPoint.getNormal());else{let d=v.NORTH,u=Math.acos(l.dot(d)/this._grabbedSphere.radius)-Math.acos(this._grabbedPoint.dot(d)/this._grabbedSphere.radius),_=n.eyeNorm.dot(v.NORTH);(u>0&&_>=this.poleThreshold||u<0&&_<=-this.poleThreshold)&&(u=0);let f=F.axisAngleToQuat(d.cross(n.eyeNorm).normalize(),-u),g=v.proj_b_to_plane(l,d),m=v.proj_b_to_plane(this._grabbedPoint,d);o=F.getRotationBetweenVectors(g.getNormal(),m.getNormal()).mul(f)}let c=o.mulVec3(n.eye);this.force=c.sub(n.eye).scale(this.dragInertia)}else{let o=this._grabbedPoint,a=v.add(o,n.getRight()),l=v.add(o,o.getNormal()),c=new v;new V(n.eye,s.direction).hitPlaneRes(vt.fromPoints(o,a,l),c);let d=n.eye.add(c.subA(o).negate());this.force=d.sub(n.eye).scale(this.dragInertia),this._targetDragPoint=c}this.vel.set(0,0,0),this._currScreenPos.equal(s.pos)||this._currScreenPos.copy(s.pos),this._hold=!0}},this._onLUp=s=>{this._hold=!1,this.renderer.handler.canvas.classList.remove("ogGrabbingPoiner")},this.events=lt(Pl,this),this.force=new v,this.force_h=0,this.force_v=0,this.vel=new v,this.vel_h=0,this.vel_v=0,this.vel_roll=0,this.force_roll=0,this.mass=t.mass!=null?t.mass:1,this.inertia=t.inertia!=null?t.inertia:1,this._velInertia=zi,this.minSlope=t.minSlope!=null?t.minSlope:.35,this.dragInertia=t.dragInertia!=null?t.dragInertia:170,this.zoomSpeed=t.zoomSpeed!=null?t.zoomSpeed:1,this.poleThreshold=t.poleThreshold!=null?t.poleThreshold:.999,this.disableRotation=t.disableRotation!=null&&t.disableRotation,this.disableTilt=t.disableTilt!=null&&t.disableTilt,this._lookPos=void 0,this._grabbedPoint=null,this._grabbedDist=0,this._targetZoomPoint=null,this._targetDragPoint=null,this._targetRotationPoint=null,this._tUp=new v,this._tRad=0,this._rotHDir=0,this._rotVDir=0,this._wheelDirection=1,this._currScreenPos=new H,this._grabbedSphere=new Ft,this._rot=new F,this._curPitch=0,this._curYaw=0,this._curRoll=0,this._eye0=new v,this._newEye=new v,this._grabbedCameraHeight=0,this._isTouchPad=!1,this._freeMode=!1,this.mode=this._modeToNumber(t.mode||"adaptive")}oninit(){this.renderer&&(this.renderer.events.on("keyfree",W.KEY_ALT,this._onShiftFree),this.renderer.events.on("keyfree",W.KEY_PRINTSCREEN,this._onShiftFree))}onadd(){var t;(t=this.planet)!=null&&t.camera&&this.planet.camera.events.on("flystart",this._onCameraFly)}onremove(){var t;(t=this.planet)!=null&&t.camera&&this.planet.camera.events.off("flystart",this._onCameraFly)}onactivate(){super.onactivate();let t=this.renderer;t.events.on("mousewheel",this._onMouseWheel),t.events.on("rhold",this._onRHold),t.events.on("rdown",this._onRDown),t.events.on("lhold",this._onLHold),t.events.on("ldown",this._onLDown),t.events.on("lup",this._onLUp),t.events.on("draw",this.onDraw,this,-1e3),t.events.on("mousemove",this._onMouseMove),t.events.on("mouseleave",this._onMouseLeave),t.events.on("mouseenter",this._onMouseEnter)}ondeactivate(){super.ondeactivate();let t=this.renderer;t.events.off("mousewheel",this._onMouseWheel),t.events.off("rhold",this._onRHold),t.events.off("rdown",this._onRDown),t.events.off("lhold",this._onLHold),t.events.off("ldown",this._onLDown),t.events.off("lup",this._onLUp),t.events.off("draw",this.onDraw),t.events.off("mousemove",this._onMouseMove),t.events.off("mouseleave",this._onMouseLeave),t.events.off("mouseenter",this._onMouseEnter)}onDraw(){this._updateVel(),this._handleZoom(),this._handleDrag(),this._handleRotation()}_handleRotation(){if((!this.disableRotation||!this.disableTilt)&&this.planet&&this._targetRotationPoint){let t=this.planet.camera;if((this.disableRotation||this.vel_h===0)&&(this.disableTilt||this.vel_v===0))return;if(!this.disableRotation){let s=this.vel_h*this.dt;t.rotateHorizontal(s,!1,this._targetRotationPoint,this._tUp)}if(!this.disableTilt){let s=this.vel_v*this.dt;t.rotateVertical(s,this._targetRotationPoint,.1)}this.events.dispatch(this.events.rotate,this),this._curPitch=t.getPitch(),this._curYaw=t.getYaw(),this._curRoll=t.getRoll(),this._velInertia=zi}}_getTargetPoint(t){return this.planet?this.planet.camera.isOrthographic?this.renderer.getCartesianFromPixel(t)||null:this.planet.camera.getAltitude()>8e4?this.planet.getCartesianFromPixelEllipsoid(t)||null:this.planet.getCartesianFromPixelTerrain(t)||null:null}get freeMode(){return this.mode!==1&&(this.mode===0||this._freeMode)}setMode(t){this.mode=this._modeToNumber(t)}_modeToNumber(t){switch(t){case"lockNorth":return 1;case"free":return 0;default:return 2}}_handleDrag(){if(this.planet&&this._targetDragPoint&&this._grabbedPoint&&this.vel.length()>.1){this._velInertia=zi;let t=this.planet.camera;if(t.slope>this.minSlope){let s=this.vel.scaleTo(this.dt),n=v.proj_b_to_plane(s,t.eyeNorm),o=t.eye.add(n).normalize().scale(this._grabbedCameraHeight);if(this.freeMode){let a=F.getRotationBetweenVectors(t.eye.getNormal(),o.getNormal());t.rotate(a),t.eye.copy(o)}else{let a=o.getNormal().dot(v.NORTH),l=t.eyeNorm.dot(v.NORTH);(a>l&&a>=this.poleThreshold||a<l&&a<=-this.poleThreshold)&&this.vel.scale(.8),t.eye.copy(o),this._corrRoll(),t.setPitchYawRoll(this._curPitch,this._curYaw,this._curRoll)}}else{let s=this.vel.scaleTo(this.dt),n=t.eye.add(s);t.eye.copy(n),t.checkTerrainCollision(),this._corrRoll(),t.setPitchYawRoll(this._curPitch,this._curYaw,this._curRoll)}this.events.dispatch(this.events.drag,this)}}_corrRoll(){this.planet.camera.slope<.5&&(this._curRoll-=this.vel_roll*this.dt,this._curRoll<.01*Math.PI/180&&(this._curRoll=.01*Math.PI/180))}_handleZoom(){if(this._targetZoomPoint&&this.vel.length()>.1){let t=this.planet.camera,s=this._targetZoomPoint,n=t.eye.clone(),o=s.sub(t.eye).normalize(),a=this.vel.getNormal(),l=Math.sign(a.dot(t.getForward())),c=this.vel.scaleTo(this.dt);this._grabbedSphere.radius>n.length()&&(l*=-1);let d=t.getForward().scaleTo(l*c.length());n.addA(d),this.events.dispatch(this.events.zoom,this);let u=t.maxAltitude+this.planet.ellipsoid.getEquatorialSize();if(n.length()>u)return void n.copy(n.getNormal().scale(u));let _=new V(n,o).hitSphere(this._grabbedSphere);if(!_)return void this.vel.set(0,0,0);let f=F.getRotationBetweenVectors(_.getNormal(),s.getNormal());if(t.eye=f.mulVec3(n),t.rotate(f),!this.freeMode){this._corrRoll(),t.setPitchYawRoll(this._curPitch,this._curYaw,this._curRoll),t.update();let g=t.unproject2v(this._currScreenPos,t.eye.distance(this._targetZoomPoint)),m=s.sub(t.eye).normalize(),p=new v,x=new v,y=vt.fromPoints(s,s.add(t.getUp()),s.add(t.getRight()));new V(t.eye,g).hitPlaneRes(y,p),new V(t.eye,m).hitPlaneRes(y,x);let w=x.sub(p);t.eye=t.eye.add(w),this._corrRoll(),t.setPitchYawRoll(this._curPitch,this._curYaw,this._curRoll)}if(t.checkTerrainCollision(),t.isOrthographic){let g=t.getAltitude();g&&(t.focusDistance=Math.abs(g))}}}_updateVel(){let t=this.force.scale(1/this.mass);this.vel.addA(t),this.vel.scale(this.velocityInertia),this.vel.length()<.001&&this.vel.set(0,0,0),this.force.set(0,0,0),this._updateVel_h(),this._updateVel_v(),this._updateVel_roll()}_updateVel_h(){let t=this.force_h/this.mass;this.vel_h+=t,this.vel_h*=this.velocityInertia,Math.abs(this.vel_h)<.001&&(this.vel_h=0),this.force_h=0}_updateVel_v(){let t=this.force_v/this.mass;this.vel_v+=t,this.vel_v*=this.velocityInertia,Math.abs(this.vel_v)<.001&&(this.vel_v=0),this.force_v=0}_updateVel_roll(){let t=this.force_roll/this.mass;this.vel_roll+=t,this.vel_roll*=this.velocityInertia,this.force_roll=0}get dt(){return .001*this.renderer.handler.deltaTime}get velocityInertia(){return this._velInertia*this.inertia}stop(){this.vel.set(0,0,0),this.vel_h=0,this.vel_v=0,this._velInertia=zi,this._targetZoomPoint=null,this._grabbedPoint=null,this._targetRotationPoint=null,this._targetDragPoint=null}}const Dn=h=>h>1e3?`${(h/1e3).toFixed(1)} km`:h>9?`${Math.round(h)} m`:`${h.toFixed(1)} m`;let Sl=$.createCylinder(1.1,0,2.7,20,1,!0,!1,0,0,0);const Rl={text:"",size:11,color:"rgba(455,455,455,1.0)",outlineColor:"rgba(0,0,0,0.34)",outline:.23,align:"center",offset:[0,20,0]},Fn={scale:1,instanced:!0,tag:"ruler",color:"rgb(0,305,0)",object3d:Sl};class ua extends de{constructor(t={}){super(t.name),this._onCornerLdown=s=>{var n,o;if(!this._startLonLat){(o=(n=this.renderer)==null?void 0:n.controls.navigation)==null||o.deactivate(),this._startClick.set(s.x,s.y);let a=s.pickingObject.getCartesian();this._startPos=this._planet.getPixelFromCartesian(a),this._pickedCorner=s.pickingObject,s.pickingObject.properties.name=="start"?this._anchorLonLat=this._cornerEntity[1].getLonLat().clone():this._anchorLonLat=this._cornerEntity[0].getLonLat().clone()}},this._onLUp=()=>{var s;this._pickedCorner&&((s=this.renderer.controls.navigation)==null||s.activate(),this._pickedCorner=null,this._anchorLonLat=null)},this._onCornerLup=()=>{this._onLUp()},this._onCornerEnter=s=>{s.renderer.handler.canvas.style.cursor="pointer"},this._onCornerLeave=s=>{s.renderer.handler.canvas.style.cursor="default"},this._onLdblclick=()=>{this._preventClick=!0},this._onLclick=s=>{let n=this._planet.getLonLatFromPixelTerrain(s.pos);n&&(this._timeout=setTimeout(()=>{this._preventClick||(this._startLonLat?this._startLonLat=null:(this.setVisibility(!0),this._stopDrawing=!1,this._startLonLat=n)),this._preventClick=!1,this._stopDrawing=!1,clearTimeout(this._timeout)},200),this._startLonLat&&(this._stopDrawing=!0))},this._onMouseMove=s=>{if(this._startLonLat&&!this._stopDrawing){this._propsLabel.label.setVisibility(!0);let n=this._planet.getLonLatFromPixelTerrain(s.pos);if(!n)return;this._drawLine(this._startLonLat,n)}else if(this._pickedCorner){let n=this._planet.getLonLatFromPixelTerrain(s.pos);n&&(this._pickedCorner.properties.name==="start"?this._drawLine(n,this._anchorLonLat):this._drawLine(this._anchorLonLat,n))}},this.events=lt(Ml),this._ignoreTerrain=t.ignoreTerrain==null||t.ignoreTerrain,this._planet=t.planet||null,this._startLonLat=null,this._preventClick=!1,this._stopDrawing=!1,this._pickedCorner=null,this._startPos=null,this._startClick=new H,this._anchorLonLat=null,this._heading=0,this._trackLayer=new _t("track",{entities:[],pickingEnabled:!1,polygonOffsetUnits:-1,relativeToGround:!0,hideInLayerSwitcher:!0}),this._labelLayer=new _t("ruler-label",{entities:[],pickingEnabled:!1,polygonOffsetUnits:-100,relativeToGround:!0,hideInLayerSwitcher:!0}),this._cornersLayer=new _t("corners",{entities:[],pickingEnabled:!0,hideInLayerSwitcher:!0,scaleByDistance:[100,4e6,1],pickingScale:2}),this._propsLabel=new G({name:"propsLabel",label:Rl}),this._trackEntity=new G({polyline:{path3v:[],thickness:4.8,color:"rgb(255,131,0)",isClosed:!1}}),this._trackEntity.polyline.altitude=.01,this._cornerEntity=[new G({geoObject:Fn,properties:{name:"start"}}),new G({geoObject:Fn,properties:{name:"end"}})]}set ignoreTerrain(t){this._ignoreTerrain=t}bindPlanet(t){this._planet=t}_createCorners(){this._cornersLayer.addEntities(this._cornerEntity)}init(){this._createCorners(),this._trackLayer.addEntities([this._trackEntity]),this._labelLayer.addEntities([this._propsLabel]),this._planet.addLayer(this._labelLayer),this._planet.addLayer(this._trackLayer),this._planet.addLayer(this._cornersLayer),this._activate()}onremove(){this._deactivate()}_activate(){this._propsLabel.label.setVisibility(!1),this.setVisibility(!1),this.renderer.events.on("lclick",this._onLclick,this),this.renderer.events.on("mousemove",this._onMouseMove,this),this.renderer.events.on("ldblclick",this._onLdblclick,this),this.renderer.events.on("lup",this._onLUp,this),this._cornersLayer.events.on("mouseenter",this._onCornerEnter,this),this._cornersLayer.events.on("mouseleave",this._onCornerLeave,this),this._cornersLayer.events.on("ldown",this._onCornerLdown,this),this._cornersLayer.events.on("lup",this._onCornerLup,this)}_deactivate(){this._startLonLat=null,this._preventClick=!1,this._stopDrawing=!1,this._pickedCorner=null,this.renderer.events.off("lclick",this._onLclick),this.renderer.events.off("mousemove",this._onMouseMove),this.renderer.events.off("lup",this._onLUp),this._cornersLayer.events.off("mouseenter",this._onCornerEnter),this._cornersLayer.events.off("mouseleave",this._onCornerLeave),this._cornersLayer.events.off("ldown",this._onCornerLdown),this._cornersLayer.events.off("lup",this._onCornerLup),this.clear()}setVisibility(t){this._cornersLayer.setVisibility(t),this._trackLayer.setVisibility(t),this._labelLayer.setVisibility(t)}_drawLine(t,s,n){n||(n=this._planet.ellipsoid.lonLatToCartesian(t));let o=this._planet.ellipsoid.lonLatToCartesian(s),a=this._planet.ellipsoid.inverse(t,s),l=a.distance;this._heading=a.initialAzimuth;let c=[],d=o.sub(n),u=d.length();d.normalize();for(let _=0;_<120;_++){let f=d.scaleTo(_*u/120).addA(n);c.push(f)}c.push(o),this._trackEntity.polyline.setPath3v([c]),this._ignoreTerrain&&(this._propsLabel.setCartesian3v(c[Math.floor(c.length/2)]),this._propsLabel.label.setText(`${Dn(l)}, ${Math.round(this._heading)} deg`))}clear(){this._trackEntity.remove(),this._cornerEntity[0].remove(),this._cornerEntity[1].remove(),this._propsLabel.remove(),this._planet.removeLayer(this._trackLayer),this._planet.removeLayer(this._cornersLayer)}isCornersPositionChanged(){let t=this._trackEntity.polyline.getPath3v()[0];if(t){const s=t[0].clone(),n=t[t.length-1].clone();return this._cornerEntity[0].getCartesian().equal(s)&&this._cornerEntity[1].getCartesian().equal(n)}return!1}frame(){let t=this._trackEntity.polyline.getPath3v()[0];if(t){const s=t[0].clone(),n=t[t.length-1].clone();if(!this.isCornersPositionChanged()&&(this._cornerEntity[0].setCartesian3v(s),this._cornerEntity[1].setCartesian3v(n),!this._ignoreTerrain)){let o=0;for(let a=0,l=t.length-1;a<l;a++)o+=t[a+1].distance(t[a]);this._propsLabel.setCartesian3v(t[Math.floor(t.length/2)]),this._propsLabel.label.setText(`${Dn(o)}, ${Math.round(this._heading)} deg`)}}}get ellipsoid(){return this._planet?this._planet.ellipsoid:null}}const Ml=["add","remove","mousemove","mouseenter","mouseleave","lclick","rclick","mclick","ldblclick","rdblclick","mdblclick","lup","rup","mup","ldown","rdown","mdown","lhold","rhold","mhold","mousewheel","touchmove","touchstart","touchend","doubletouch","touchleave","touchenter"];class _a extends Q{constructor(t={}){super(t),this._rulerScene=new ua({name:`rulerScene:${this.__id}`,ignoreTerrain:t.ignoreTerrain})}set ignoreTerrain(t){this._rulerScene.ignoreTerrain=t}oninit(){this._rulerScene.bindPlanet(this.planet)}onactivate(){this.renderer&&this.renderer.addNode(this._rulerScene)}ondeactivate(){this.renderer&&this.renderer.removeNode(this._rulerScene)}}let Bl=$.createCylinder(1.1,0,2,6,1,!0,!0,0,0,0);const On={startColor:"rgb(255,131,0)",endColor:"rgb(255,131,0)",thickness:5},Ys={text:"",size:11,color:"rgba(455,455,455,1.0)",outlineColor:"rgba(0,0,0,0.34)",outline:.23,align:"center",offset:[0,18,0]},Nn={scale:1,instanced:!0,tag:"height-ruler",color:"rgb(255,131,0)",object3d:Bl};class kl extends ua{constructor(t={}){super(t),this._geoRulerLayer=new _t("rayHeightRuler",{entities:[],pickingEnabled:!1,polygonOffsetUnits:-2,relativeToGround:!1,hideInLayerSwitcher:!0}),this._rayV=new G({name:"verticalRay",ray:On}),this._rayH=new G({name:"heightRay",ray:On}),this._heightLabels=[new G({name:"startCornerLabel",label:{...Ys}}),new G({name:"endCornerLabel",label:{...Ys}}),new G({name:"deltaLabel",label:{...Ys}})]}setVisibility(t){super.setVisibility(t),this._geoRulerLayer.setVisibility(t)}get deltaLabel(){return this._heightLabels[2]}get startLabel(){return this._heightLabels[0]}get endLabel(){return this._heightLabels[1]}get corners(){return this._cornerEntity}get startCorner(){return this.corners[0]}get endCorner(){return this.corners[1]}get startCornerLonLat(){return this.startCorner.getLonLat()}get startCornerHeight(){return this.startCornerLonLat.height}get endCornerLonLat(){return this.endCorner.getLonLat()}get endCornerHeight(){return this.endCornerLonLat.height}get maxHeightCornerLonLat(){return this.startCornerHeight<=this.endCornerHeight?this.endCornerLonLat:this.startCornerLonLat}get minHeightCornerLonLat(){return this.startCornerHeight>this.endCornerHeight?this.endCornerLonLat:this.startCornerLonLat}get deltaHeight(){return Math.abs(this.startCornerHeight-this.endCornerHeight)}_drawLine(t,s,n){super._drawLine(t,s,n),this._updateHeightRaysAndLabels()}async _updateHeightRaysAndLabels(){const t=this.minHeightCornerLonLat.clone();t.height=this.maxHeightCornerLonLat.height,this._rayH.ray.setStartPosition3v(this._planet.ellipsoid.lonLatToCartesian(this.maxHeightCornerLonLat)),this._rayH.ray.setEndPosition3v(this._planet.ellipsoid.lonLatToCartesian(t)),this._rayV.ray.setStartPosition3v(this._planet.ellipsoid.lonLatToCartesian(this.minHeightCornerLonLat)),this._rayV.ray.setEndPosition3v(this._planet.ellipsoid.lonLatToCartesian(t)),t.height=this.minHeightCornerLonLat.height+this.deltaHeight/2,this.deltaLabel.setLonLat(t),this.startLabel.setLonLat(this.startCornerLonLat),this.endLabel.setLonLat(this.endCornerLonLat);const s=await this._planet.getHeightDefault(this.startCornerLonLat),n=await this._planet.getHeightDefault(this.endCornerLonLat);this.deltaLabel.label.setText(`Δ ${Math.abs(s-n).toFixed(1)} m`),this.startLabel.label.setText(`P1 ${s.toFixed(1)} m`),this.endLabel.label.setText(`P2 ${n.toFixed(1)} m`)}clear(){this._rayH.remove(),this._rayV.remove(),this.startCorner.remove(),this.endCorner.remove(),this.startLabel.remove(),this.endLabel.remove(),this.deltaLabel.remove(),super.clear(),this._planet.removeLayer(this._geoRulerLayer)}_createCorners(){this._cornerEntity=[new G({geoObject:Nn,properties:{name:"start"}}),new G({geoObject:Nn,properties:{name:"end"}})],this._cornersLayer.setEntities(this._cornerEntity)}init(){super.init(),this._createCorners(),this._labelLayer.addEntities(this._heightLabels),this._geoRulerLayer.addEntities([this._rayH,this._rayV]),this._planet.addLayer(this._geoRulerLayer)}frame(){super.frame(),this._updateHeightRaysAndLabels()}}class Hn extends _a{constructor(t={}){super(t),this._rulerScene=new kl({name:`heightRulerScene:${this.__id}`,ignoreTerrain:!1})}}const Ws=[.001,.005,.01,.05,.1,.2,.5,1,2,3,5,10,20,30,50,100,200,300,500,1e3,2e3,3e3,5e3,1e4,2e4,3e4,5e4,1e5,2e5,3e5,5e5,1e6,2e6,3e6,5e6,1e7];class fa extends Q{constructor(t={}){t.name&&t.name!==""||(t.name="scaleControl"),super(t),this._template=`<div class="og-scale-container">
      <div class="og-scale-label"></div>
      <div class="og-scale-ruler"></div>
    </div>`,this._minWidth=100,this._maxWidth=150,this._isCenter=t.isCenter==null||t.isCenter,this._mPx=0,this.currWidth=0,this._metersInMinSize=0,this.el=null,this._scaleLabelEl=null}_renderTemplate(){return Wr(this._template)[0]}oninit(){this.el=this._renderTemplate(),this._scaleLabelEl=this.el.querySelector(".og-scale-label"),this.renderer.div.appendChild(this.el),this._isCenter?(this.planet.camera.events.on("moveend",()=>{this._drawScreen(this.planet.renderer.handler.getCenter())}),!this.planet.terrain.isEmpty&&this.planet.terrain.events.on("loadend",()=>{this._drawScreen(this.planet.renderer.handler.getCenter())})):(this.renderer.events.on("mousemove",t=>{t.leftButtonHold||t.rightButtonHold||this._drawScreen(t.pos)}),this.planet.camera.events.on("moveend",()=>{let t=this.renderer.events.mouseState;t.leftButtonHold||t.rightButtonHold||this._drawScreen(t.pos)}))}_drawScreen(t){let s=this.planet.camera,n=t,o=this.planet.getDistanceFromPixel(n)||0;o===0&&(n=s.project3v(v.ZERO),o=this.planet.getDistanceFromPixel(n)||0);let a=s.getForward().scaleTo(o).addA(s.eye),l=o*Math.tan(s.viewAngle*j),c=a.add(s.getRight().scaleTo(l)),d=s.project3v(c);this._mPx=l/d.distance(n);let u=this._mPx*this._minWidth,_=Re(Ws,u,(m,p)=>m-p);_<0&&(_=~_);let f=Ws[_],g=(f-u)/(Ws[_+1]-f);this.currWidth=this._minWidth+g*(this._maxWidth-this._minWidth),this._scaleLabelEl.innerText=f>=1e3?f/1e3+" km":f>=1?`${f} m`:f>=.01?100*f+" cm":1e3*f+" mm",this._metersInMinSize=u,this.el.style.width=this.currWidth+"px"}}class ga extends Q{constructor(t={}){super({name:"SimpleSkyBackground",...t}),this._colorOne=new Float32Array([128/255,223/255,1]),this._colorTwo=new Float32Array([10/255,15/255,56/255])}get colorOne(){let t=this._colorOne;return cr([Math.round(255*t[0]),Math.round(255*t[1]),Math.round(255*t[2])])}get colorTwo(){let t=this._colorTwo;return cr([Math.round(255*t[0]),Math.round(255*t[1]),Math.round(255*t[2])])}set colorOne(t){let s=ts(t);this._colorOne[0]=s.x,this._colorOne[1]=s.y,this._colorOne[2]=s.z}set colorTwo(t){let s=ts(t);this._colorTwo[0]=s.x,this._colorTwo[1]=s.y,this._colorTwo[2]=s.z}oninit(){this.renderer.handler.addProgram(new X("simpleSkyBackground",{uniforms:{iResolution:"vec2",fov:"float",camPos:"vec3",earthRadius:"float",viewMatrix:"mat4",colorOne:"vec3",colorTwo:"vec3"},attributes:{corners:"vec3"},vertexShader:`attribute vec2 corners;
                        
            varying vec2 tc;
            
            void main(void) {
                gl_Position = vec4(corners, 0.0, 1.0);
                tc = corners * 0.5 + 0.5;
            }`,fragmentShader:`precision highp float;
            
            #define MAX 10e10
            #define PI 3.14159265359
            #define rad(x) x * PI / 180.
            #define ZERO vec3(0.0)          
           
            #define RED vec4(1.0, 0.0, 0.0, 1.0)
            #define GREEN vec4(0.0, 1.0, 0.0, 1.0)         
            
            uniform vec3 camPos;            
            uniform vec2 iResolution;
            uniform float fov;
            uniform float earthRadius;
            uniform mat4 viewMatrix;
            
            uniform vec3 colorOne;
            uniform vec3 colorTwo;
                         
            varying vec2 tc;
                        
            // compute the view ray in the camera coordinate
            vec3 computeView(vec2 uv){
                float w_h_ratio = iResolution.x / iResolution.y;   
                float h = tan(rad(fov/2.));
                return normalize(vec3(-w_h_ratio * h, -h, -1.) + vec3(uv.x * 2. * h * w_h_ratio, uv.y*2.*h, 0.));
            }

            // sphere of size ra centered at point ce
            vec2 sphIntersect( in vec3 ro, in vec3 rd, in vec3 ce, float ra )
            {
                vec3 oc = ro - ce;
                float b = dot( oc, rd );
                float c = dot( oc, oc ) - ra * ra;
                float h = b * b - c;
                if( h < 0.0 ) return vec2(MAX); // no intersection
                h = sqrt( h );
                return vec2( -b-h, -b+h );
            }
            
            mat3 transpose(mat3 matrix) {
                vec3 row0 = matrix[0];
                vec3 row1 = matrix[1];
                vec3 row2 = matrix[2];
                mat3 result = mat3(
                    vec3(row0.x, row1.x, row2.x),
                    vec3(row0.y, row1.y, row2.y),
                    vec3(row0.z, row1.z, row2.z)
                );
                return result;
            }
            
            float det(mat2 matrix) {
                return matrix[0].x * matrix[1].y - matrix[0].y * matrix[1].x;
            }
            
            mat3 inverse(mat3 matrix) {
                vec3 row0 = matrix[0];
                vec3 row1 = matrix[1];
                vec3 row2 = matrix[2];
            
                vec3 minors0 = vec3(
                    det(mat2(row1.y, row1.z, row2.y, row2.z)),
                    det(mat2(row1.z, row1.x, row2.z, row2.x)),
                    det(mat2(row1.x, row1.y, row2.x, row2.y))
                );
                vec3 minors1 = vec3(
                    det(mat2(row2.y, row2.z, row0.y, row0.z)),
                    det(mat2(row2.z, row2.x, row0.z, row0.x)),
                    det(mat2(row2.x, row2.y, row0.x, row0.y))
                );
                vec3 minors2 = vec3(
                    det(mat2(row0.y, row0.z, row1.y, row1.z)),
                    det(mat2(row0.z, row0.x, row1.z, row1.x)),
                    det(mat2(row0.x, row0.y, row1.x, row1.y))
                );
            
                mat3 adj = transpose(mat3(minors0, minors1, minors2));
            
                return (1.0 / dot(row0, minors0)) * adj;
            }
            
            void main(void) {
            
                vec3 dir = computeView(tc);
                dir = inverse(mat3(viewMatrix)) * dir;
                
                vec2 ER = sphIntersect(camPos, dir, vec3(0.0), earthRadius);
                
                float bigRadius = earthRadius * 2.5;
                vec3 bigCenter = normalize(camPos) * bigRadius * 1.3;                
                               
                vec2 BIG = sphIntersect(camPos, dir, bigCenter, bigRadius);
                
                float Ix = distance(camPos + dir * BIG.y, ZERO);               
                
                float maxI = sqrt(bigRadius * bigRadius + bigRadius * bigRadius);
                                   
                gl_FragColor = vec4(mix(colorOne, colorTwo, Ix / maxI), 1.0);
            }`})),this.activate()}onactivate(){super.onactivate(),this.planet.events.on("draw",this._drawBackground,this)}ondeactivate(){super.ondeactivate(),this.planet.events.off("draw",this._drawBackground)}_drawBackground(){let t=this.renderer.handler,s=t.programs.simpleSkyBackground,n=s._program,o=n.uniforms,a=t.gl,l=this.planet.camera;a.disable(a.DEPTH_TEST),s.activate(),a.bindBuffer(a.ARRAY_BUFFER,this.renderer.screenFramePositionBuffer),a.vertexAttribPointer(n.attributes.corners,2,a.FLOAT,!1,0,0),a.uniform3fv(o.camPos,[l.eye.x,l.eye.y,l.eye.z]),a.uniform2fv(o.iResolution,[t.getWidth(),t.getHeight()]),a.uniform1f(o.fov,l.getViewAngle()),a.uniform1f(o.earthRadius,this.planet.ellipsoid.getPolarSize()+1),a.uniform3fv(o.colorOne,this._colorOne),a.uniform3fv(o.colorTwo,this._colorTwo),a.uniformMatrix4fv(o.viewMatrix,!1,l.getViewMatrix()),a.drawArrays(a.TRIANGLE_STRIP,0,4),a.enable(a.DEPTH_TEST)}}const $s=14959787e4;function Xs(h){var t=h-es,s=282.9404+470935e-10*t,n=.016709-1151e-12*t,o=hr(356.047+.9856002585*t),a=23.4392911-3563e-10*t,l=o+J*n*Math.sin(o*j)*(1+n*Math.cos(o*j)),c=Math.cos(l*j)-n,d=Math.sin(l*j)*Math.sqrt(1-n*n),u=Math.sqrt(c*c+d*d),_=hr(Math.atan2(d,c)*J+s),f=c=u*Math.cos(_*j),g=(d=u*Math.sin(_*j))*Math.cos(a*j),m=d*Math.sin(a*j),p=Xi*(24*t/23.9344694-259.853/360);return F.zRotation(-p).mulVec3(new v(-f*$s,-g*$s,m*$s))}class Il{constructor(t){this._renderNode=null,this._position=t.position||new v,this._ambient=t.ambient||new v,this._diffuse=t.diffuse||new v(.8,.8,.8),this._specular=t.specular||new v(.18,.18,.18),this._shininess=t.shininess!=null?t.shininess:3.3,this._active=!0,this._tempAmbient=this._ambient.clone(),this._tempDiffuse=this._diffuse.clone(),this._tempSpecular=this._specular.clone(),this._tempShininess=this._shininess}isActive(){return this._active}setPosition3v(t){this.setPosition(t.x,t.y,t.z)}setPosition(t,s,n){this._position.x=t,this._position.y=s,this._position.z=n,this._renderNode&&(this._renderNode._lightPosition[0]=t,this._renderNode._lightPosition[1]=s,this._renderNode._lightPosition[2]=n)}getPosition(){return this._position.clone()}setAmbient3v(t){this.setAmbient(t.x,t.y,t.z)}setDiffuse3v(t){this.setDiffuse(t.x,t.y,t.z)}setSpecular3v(t){this.setSpecular(t.x,t.y,t.z)}setAmbient(t,s,n){this._ambient.set(t,s,n);const o=this._renderNode;o&&(o._lightParams[0]=t,o._lightParams[1]=s,o._lightParams[2]=n)}setDiffuse(t,s,n){this._diffuse.set(t,s,n);const o=this._renderNode;o&&(o._lightParams[3]=t,o._lightParams[4]=s,o._lightParams[5]=n)}setSpecular(t,s,n){this._specular.set(t,s,n);const o=this._renderNode;o&&(o._lightParams[6]=t,o._lightParams[7]=s,o._lightParams[8]=n)}setShininess(t){this._shininess=t;const s=this._renderNode;s&&(s._lightShininess=t)}addTo(t){this._renderNode=t,this.setShininess(this._shininess),this.setAmbient3v(this._ambient),this.setDiffuse3v(this._diffuse),this.setSpecular3v(this._specular)}}class Dr extends Q{constructor(t={}){super({autoActivate:!0,...t}),this._name="sun",this.activationHeight=t.activationHeight||12079e3,this.offsetVertical=t.offsetVertical||-5e6,this.offsetHorizontal=t.offsetHorizontal||5e6,this.sunlight=new Il({ambient:new v(.15,.15,.25),diffuse:new v(.9,.9,.8),specular:new v(.1,.1,.06),shininess:110}),this._currDate=0,this._prevDate=0,this._clockPtr=null,this._lightOn=!1,this._f=0,this._k=0,this._stopped=t.stopped||!1}oninit(){this.planet.lightEnabled=!0,this.sunlight.addTo(this.planet),this.renderer.events.on("draw",this._draw,this),this._clockPtr||(this._clockPtr=this.renderer.handler.defaultClock)}stop(){this._stopped=!0,this.deactivate()}start(){this._stopped=!1,this.activate()}onactivate(){super.onactivate(),this._stopped=!1}bindClock(t){this._clockPtr=t}_draw(){if(this._clockPtr)if(this._currDate=this._clockPtr.currentDate,this._stopped)this.sunlight.setPosition3v(Xs(this._currDate));else{let t=this.planet.camera;if(t.getHeight()<this.activationHeight||!this._active){this._lightOn=!0,this._f=1;let s=t.eye.normal(),n=t.getForward();n.scale(Math.sign(t.getUp().dot(s))),t.slope>.99&&(n=t.getUp());let o=v.proj_b_to_plane(n,s,n).normalize().scale(this.offsetVertical),a=v.proj_b_to_plane(t.getRight(),s,t.getRight()).normalize().scale(this.offsetHorizontal),l=o.add(a),c=t.eye.add(l);if(this._k>0){this._k-=.001;let d=F.getRotationBetweenVectors(this.sunlight._position.normal(),c.normal()).slerp(F.IDENTITY,this._k).normalize();this.sunlight.setPosition3v(d.mulVec3(this.sunlight._position))}else this.sunlight.setPosition3v(c)}else if(this._k=1,this._f>0){this._f-=.001;let s=F.getRotationBetweenVectors(this.sunlight._position.normal(),Xs(this._currDate).normal()).slerp(F.IDENTITY,this._f).normalize();this.sunlight.setPosition3v(s.mulVec3(this.sunlight._position))}else(Math.abs(this._currDate-this._prevDate)>34e-5&&this._active||this._lightOn)&&(this._lightOn=!1,this._prevDate=this._currDate,this.sunlight.setPosition3v(Xs(this._currDate)),this._f=0)}}}const zl=["inertiamove","drag","doubletapzoom"];class Vn{constructor(){this.x=0,this.y=0,this.prev_x=0,this.prev_y=0,this.grabbedPoint=null,this.grabbedSpheroid=new Ft,this._vec=new H,this._vecPrev=new H}get dY(){return this.y-this.prev_y}get dX(){return this.x-this.prev_x}get vec(){return this._vec.set(this.x,this.y)}get vecPrev(){return this._vecPrev.set(this.prev_x,this.prev_y)}}class pa extends Q{constructor(t={}){super(t),this._onCameraFly=()=>{this.stopRotation()},this._name="touchNavigation",this.events=lt(zl,this),this.grabbedPoint=new v,this.inertia=t.inertia!=null?t.inertia:.007,this.minSlope=t.minSlope!=null?t.minSlope:.1,this.jerkLimit=t.jerkLimit!=null?t.jerkLimit:.3,this.grabbedSpheroid=new Ft,this.planet=null,this.qRot=new F,this.scaleRot=0,this.rot=1,this._eye0=new v,this.pointOnEarth=null,this.earthUp=null,this.touches=[new Vn,new Vn],this._keyLock=new Me,this._touching=!1}oninit(){this.renderer&&(this.renderer.events.on("touchstart",this.onTouchStart,this),this.renderer.events.on("touchend",this.onTouchEnd,this),this.renderer.events.on("doubletouch",this.onDoubleTouch,this),this.renderer.events.on("touchcancel",this.onTouchCancel,this),this.renderer.events.on("touchmove",this.onTouchMove,this),this.renderer.events.on("draw",this.onDraw,this))}onadd(){var t;(t=this.planet)!=null&&t.camera&&this.planet.camera.events.on("flystart",this._onCameraFly)}onremove(){var t;(t=this.planet)!=null&&t.camera&&this.planet.camera.events.off("flystart",this._onCameraFly)}onTouchStart(t){const s=this.renderer.handler;if(this._touching=!0,t.sys.touches.length===2){const n=this.touches[0],o=this.touches[1];n.x=(t.sys.touches.item(0).clientX-t.sys.offsetLeft)*s.pixelRatio,n.y=(t.sys.touches.item(0).clientY-t.sys.offsetTop)*s.pixelRatio,n.prev_x=n.x,n.prev_y=n.y,n.grabbedPoint=this.planet.getCartesianFromPixelTerrain(new H(n.x,n.y))||null,o.x=(t.sys.touches.item(1).clientX-t.sys.offsetLeft)*s.pixelRatio,o.y=(t.sys.touches.item(1).clientY-t.sys.offsetTop)*s.pixelRatio,o.prev_x=o.x,o.prev_y=o.y,o.grabbedPoint=this.planet.getCartesianFromPixelTerrain(new H(o.x,o.y))||null,this.pointOnEarth=this.planet.getCartesianFromPixelTerrain(this.renderer.handler.getCenter())||null,this.pointOnEarth&&(this.earthUp=this.pointOnEarth.normal()),n.grabbedPoint&&o.grabbedPoint&&(n.grabbedSpheroid.radius=n.grabbedPoint.length(),o.grabbedSpheroid.radius=o.grabbedPoint.length(),this.stopRotation())}else t.sys.touches.length===1&&this._startTouchOne(t)}_startTouchOne(t){const s=this.touches[0],n=this.renderer.handler;s.x=(t.sys.touches.item(0).clientX-t.sys.offsetLeft)*n.pixelRatio,s.y=(t.sys.touches.item(0).clientY-t.sys.offsetTop)*n.pixelRatio,s.prev_x=s.x,s.prev_y=s.y,s.grabbedPoint=this.planet.getCartesianFromPixelTerrain(t)||null,this._eye0.copy(this.planet.camera.eye),s.grabbedPoint&&(s.grabbedSpheroid.radius=s.grabbedPoint.length(),this.stopRotation())}stopRotation(){this.qRot.clear(),this.planet.layerLock.free(this._keyLock),this.planet.terrainLock.free(this._keyLock),this.planet._normalMapCreator.free(this._keyLock)}onDoubleTouch(t){this.planet.stopFlying(),this.stopRotation();const s=this.planet.getCartesianFromPixelTerrain(t);if(s){const n=this.planet.ellipsoid.cartesianToLonLat(s);this.planet.flyLonLat(new L(n.lon,n.lat,.57*this.planet.camera.eye.distance(s))),this.events.dispatch(this.events.doubletapzoom,this)}}onTouchEnd(t){t.sys.touches.length===0&&(this._touching=!1),t.sys.touches.length===1&&this._startTouchOne(t),Math.abs(this.touches[0].x-this.touches[0].prev_x)<3&&Math.abs(this.touches[0].y-this.touches[0].prev_y)<3&&(this.scaleRot=0)}onTouchCancel(t){}onTouchMove(t){let s=this.planet.camera;const n=this.renderer.handler;if(t.sys.touches.length===2){this.renderer.controlsBag.scaleRot=1;let a=this.touches[0],l=this.touches[1];if(!a.grabbedPoint||!l.grabbedPoint)return;this.planet.stopFlying(),a.prev_x=a.x,a.prev_y=a.y,a.x=(t.sys.touches.item(0).clientX-t.sys.offsetLeft)*n.pixelRatio,a.y=(t.sys.touches.item(0).clientY-t.sys.offsetTop)*n.pixelRatio,l.prev_x=l.x,l.prev_y=l.y,l.x=(t.sys.touches.item(1).clientX-t.sys.offsetLeft)*n.pixelRatio,l.y=(t.sys.touches.item(1).clientY-t.sys.offsetTop)*n.pixelRatio;const c=a.vec.add(l.vec).scale(.5),d=this.planet.getCartesianFromPixelEllipsoid(c);if(d){this.pointOnEarth=d;const u=Math.atan2(a.prev_y-l.prev_y,a.prev_x-l.prev_x),_=Math.atan2(a.y-l.y,a.x-l.x)-u,f=s.eye.distance(this.pointOnEarth),g=a.vec.sub(l.vec),m=a.vecPrev.sub(l.vecPrev);let p=g.length()/m.length();const x=1+this.jerkLimit,y=1-this.jerkLimit;p=p>x?x:p<y?y:p;let w=f*-(1-p);s.eye.addA(s.getForward().scale(w)),s.rotateAround(-_,!1,this.pointOnEarth,this.earthUp);const C=a.vec.add(l.vec).scale(.5),T=a.vecPrev.add(l.vecPrev).scale(.5),P=C.sub(T).scale(-1);var o=.5/f*s._lonLat.height*j;o>.003&&(o=.003),s.rotateHorizontal(o*-P.x,!1,this.pointOnEarth,this.earthUp),s.rotateVertical(o*-P.y,this.pointOnEarth,this.minSlope),s.checkTerrainCollision(),s.update(),this.events.dispatch(this.events.drag,this)}this.scaleRot=0}else if(t.sys.touches.length===1){let a=this.touches[0];if(a.prev_x=a.x,a.prev_y=a.y,a.x=(t.sys.touches.item(0).clientX-t.sys.offsetLeft)*n.pixelRatio,a.y=(t.sys.touches.item(0).clientY-t.sys.offsetTop)*n.pixelRatio,!a.grabbedPoint)return;this.planet.stopFlying();let l=t.direction,c=new V(s.eye,l).hitSphere(a.grabbedSpheroid);if(c)if(s.slope>.2){this.qRot=F.getRotationBetweenVectors(c.normal(),a.grabbedPoint.normal());let d=this.qRot;s.eye=d.mulVec3(s.eye),s.rotate(d),s.checkTerrainCollision(),s.update(),this.events.dispatch(this.events.drag,this),this.scaleRot=1}else{let d=a.grabbedPoint,u=v.add(d,s.getUp()),_=v.add(d,d.getNormal()),f=s.unproject(a.x,a.y),g=new v;new V(s.eye,f).hitPlaneRes(vt.fromPoints(d,u,_),g)===V.INSIDE&&(s.eye=this._eye0.addA(g.subA(d).negate()),s.checkTerrainCollision(),s.update(),this.events.dispatch(this.events.drag,this),this.scaleRot=0)}}}onDraw(){const t=this.renderer;if(t.controlsBag.scaleRot=this.scaleRot,this._touching)return;let s=this.planet.camera,n=s.eye.clone();if(!t.events.mouseState.leftButtonDown&&this.scaleRot){if(this.scaleRot-=this.inertia,this.scaleRot<=0)this.scaleRot=0;else{t.controlsBag.scaleRot=this.scaleRot;let o=this.qRot.slerp(F.IDENTITY,1-this.scaleRot*this.scaleRot*this.scaleRot).normalize();o.x||o.y||o.z||(this.scaleRot=0),s.eye=o.mulVec3(s.eye),s.rotate(o),s.checkTerrainCollision(),s.update(),this.events.dispatch(this.events.inertiamove,this)}this.setLock(s.eye.distance(n)/s.getAltitude()>.01)}}setLock(t){t?(this.planet.layerLock.lock(this._keyLock),this.planet.terrainLock.lock(this._keyLock),this.planet._normalMapCreator.lock(this._keyLock)):(this.planet.layerLock.free(this._keyLock),this.planet.terrainLock.free(this._keyLock),this.planet._normalMapCreator.free(this._keyLock))}}class ma extends Q{constructor(t={}){super(t),this._keyLock=new Me,this._move=0,this._targetPoint=null}oninit(){let t=new ce({classList:["og-map-button","og-zoomin-button"],icon:'<?xml version="1.0"?><svg width=24 height=24 xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">    <path d="M 11 5 L 11 11 L 5 11 L 5 13 L 11 13 L 11 19 L 13 19 L 13 13 L 19 13 L 19 11 L 13 11 L 13 5 L 11 5 z"/></svg>'});t.appendTo(this.renderer.div);let s=new ce({classList:["og-map-button","og-zoomout-button"],icon:'<?xml version="1.0"?><svg width=24 height=24 xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">    <path d="M 5 11 L 5 13 L 19 13 L 19 11 L 5 11 z"/></svg>'});s.appendTo(this.renderer.div),t.events.on("mousedown",()=>this.zoomIn()),t.events.on("mouseup",()=>this.stopZoom()),s.events.on("mousedown",()=>this.zoomOut()),s.events.on("mouseup",()=>this.stopZoom()),t.events.on("touchstart",()=>this.zoomIn()),t.events.on("touchend",()=>this.stopZoom()),t.events.on("touchcancel",()=>this.stopZoom()),s.events.on("touchstart",()=>this.zoomOut()),s.events.on("touchend",()=>this.stopZoom()),s.events.on("touchcancel",()=>this.stopZoom()),this.renderer.events.on("draw",this._draw,this)}zoomIn(){this.planet.layerLock.lock(this._keyLock),this.planet.terrainLock.lock(this._keyLock),this.planet._normalMapCreator.lock(this._keyLock),this._targetPoint=this.renderer.getCenter(),this._move=1}zoomOut(){this.planet.layerLock.lock(this._keyLock),this.planet.terrainLock.lock(this._keyLock),this.planet._normalMapCreator.lock(this._keyLock),this._targetPoint=this.renderer.getCenter(),this._move=-1}stopZoom(){this._move=0,this.planet.layerLock.free(this._keyLock),this.planet.terrainLock.free(this._keyLock),this.planet._normalMapCreator.free(this._keyLock)}_draw(t){const s=this.planet.camera;if(this._move!==0){const n=this.planet.getCartesianFromPixelTerrain(t.getCenter());if(n){let o=.035*s.eye.distance(n);s.eye.addA(s.getForward().scale(this._move*o)),s.checkTerrainCollision(),s.update()}}}}class Dl extends de{constructor(t={}){var s,n;super(t.name),this._ignoreTerrain=!1,this.events=new bi(Fl),this._ignoreTerrain=t.ignoreTerrain==null||t.ignoreTerrain,this._onSelect=t.onSelect||null,this._autoSelectionHide=t.autoSelectionHide||!1,this._planet=t.planet||null,this._startLonLat=null,this._heading=0,this._propsLabel=new G({name:"propsLabel",label:{text:"",size:11,color:"rgba(455,455,455,1.0)",outlineColor:"rgba(0,0,0,0.34)",outline:.23,align:"center",offset:[0,18]}}),(n=(s=this._propsLabel)==null?void 0:s.label)==null||n.setVisibility(!1),this._trackEntity=new G({polyline:{path3v:[],thickness:3.8,color:"rgb(455,455,455)",isClosed:!1}}),this._trackEntity.polyline.altitude=.01;let o=$.createCylinder(1.1,0,2.7,20,1,!0,!1,0,0,0);this._cornerEntity=[new G({geoObject:{scale:1,instanced:!0,tag:"selection",color:"rgb(0,305,0)",object3d:o},properties:{name:"start"}}),new G({geoObject:{scale:1,instanced:!0,tag:"selection",color:"rgb(455,0,0)",object3d:o},properties:{name:"end"}})],this._trackLayer=new _t("track",{entities:[this._trackEntity,this._propsLabel],pickingEnabled:!1,polygonOffsetUnits:-1,relativeToGround:!0,hideInLayerSwitcher:!1}),this._cornersLayer=new _t("corners",{entities:[this._cornerEntity[0],this._cornerEntity[1]],pickingEnabled:!0,hideInLayerSwitcher:!0,scaleByDistance:[1,4e6,.01],pickingScale:2})}set ignoreTerrain(t){this._ignoreTerrain=t}bindPlanet(t){this._planet=t}init(){this._activate()}onremove(){this._deactivate()}_activate(){var t,s,n,o,a;(s=(t=this._propsLabel)==null?void 0:t.label)==null||s.setVisibility(!1),this._onMouseMove_=this._onMouseMove.bind(this),(n=this.renderer)==null||n.events.on("mousemove",this._onMouseMove_,this),this._onMouseLdown_=this._onMouseLdown.bind(this),(o=this.renderer)==null||o.events.on("ldown",this._onMouseLdown_,this),this._onMouseLup_=this._onMouseLup.bind(this),(a=this.renderer)==null||a.events.on("lup",this._onMouseLup_,this),this._planet.addLayer(this._trackLayer),this._planet.addLayer(this._cornersLayer)}_deactivate(){var t,s,n;this._startLonLat=null,this._trackLayer.remove(),this._cornersLayer.remove(),(t=this.renderer)==null||t.events.off("mousemove",this._onMouseMove_),(s=this.renderer)==null||s.events.off("ldown",this._onMouseLdown_),(n=this.renderer)==null||n.events.off("lup",this._onMouseLup_),this.clear(),this._onMouseMove_=null,this._onMouseLdown_=null,this._onMouseLup_=null}_onMouseLdown(t){var s,n,o,a,l,c;if(t.renderer.handler.canvas.classList.remove("ogGrabbingPoiner"),t.renderer.handler.canvas.style.cursor="pointer",!this._startLonLat){(s=this._propsLabel.label)==null||s.setVisibility(!1),(n=this._trackEntity.polyline)==null||n.setPath3v([]),(o=this._cornerEntity[0].geoObject)==null||o.setVisibility(!0),(a=this._cornerEntity[1].geoObject)==null||a.setVisibility(!0),(c=(l=this.renderer)==null?void 0:l.controls.navigation)==null||c.deactivate(),this._startLonLat=this._planet.getLonLatFromPixelTerrain(t);let d=this._planet.ellipsoid.lonLatToCartesian(this._startLonLat);this._cornerEntity[0].setCartesian3v(d),this._cornerEntity[1].setCartesian3v(d)}}_onMouseLup(t){var s,n,o;if(this._startLonLat){if(this._pickedCorner=null,this._anchorLonLat=null,(s=this._propsLabel.label)==null||s.setVisibility(!0),this._onSelect&&typeof this._onSelect=="function"){let a=this._cornerEntity[0].getLonLat(),l=this._cornerEntity[1].getLonLat(),c=[Math.min(a.lon,l.lon),Math.min(a.lat,l.lat),Math.max(a.lon,l.lon),Math.max(a.lat,l.lat)];this._onSelect(c)}this._autoSelectionHide&&this.clear(),this._startLonLat=null}t.renderer.handler.canvas.style.cursor="default",(o=(n=this.renderer)==null?void 0:n.controls.navigation)==null||o.activate()}_drawLine(t,s,n){var o;n||(n=this._planet.ellipsoid.lonLatToCartesian(t));let a=this._planet.ellipsoid.lonLatToCartesian(s),l=this._planet.ellipsoid.direct(t,s);this._heading=l.initialAzimuth;let c=[];this._cornerEntity[0].setCartesian3v(n),this._cornerEntity[1].setCartesian3v(a);let d=[n,this._planet.ellipsoid.lonLatToCartesian(new L(s.lon,t.lat,t.height)),a,this._planet.ellipsoid.lonLatToCartesian(new L(t.lon,s.lat,t.height)),n];c.push(n);let u=(_,f)=>{let g=f.sub(_),m=g.length();g.normalize();for(let p=0;p<120;p++){let x=g.scaleTo(p*m/120).addA(_);c.push(x)}};for(let _=0;_<d.length-1;_++)u(d[_],d[_+1]);(o=this._trackEntity.polyline)==null||o.setPath3v([c]),this._ignoreTerrain}_onMouseMove(t){var s;if(this._startLonLat){(s=this._propsLabel.label)==null||s.setVisibility(!0);let n=this._planet.getLonLatFromPixelTerrain(t);if(!n)return;this._drawLine(this._startLonLat,n)}}clear(){var t,s,n;(t=this._trackEntity.polyline)==null||t.clear(),(s=this._cornerEntity[0].geoObject)==null||s.setVisibility(!1),(n=this._cornerEntity[1].geoObject)==null||n.setVisibility(!1)}frame(){var t,s;let n=(t=this._trackEntity.polyline)==null?void 0:t.getPath3v()[0];if(n&&!this._ignoreTerrain){let a=0;for(let l=0,c=n.length-1;l<c;l++)a+=n[l+1].distance(n[l]);this._propsLabel.setCartesian3v(n[Math.floor(n.length/2)]),(s=this._propsLabel.label)==null||s.setText(`${o=a,o>1e3?`${(o/1e3).toFixed(1)} km`:o>9?`${Math.round(o)} m`:`${o.toFixed(1)} m`}, ${Math.round(this._heading)} deg`)}var o}get ellipsoid(){return this._planet?this._planet.ellipsoid:null}}const Fl=["add","remove","mousemove","mouseenter","mouseleave","lclick","rclick","mclick","ldblclick","rdblclick","mdblclick","lup","rup","mup","ldown","rdown","mdown","lhold","rhold","mhold","mousewheel","touchmove","touchstart","touchend","doubletouch","touchleave","touchenter"];function te(h,t){return new Date(+h+1e3*t)}function Ol(h,t=!0,s=!1){let n=Hl[h.getMonth()],o=h.getUTCDate(),a=h.getUTCFullYear();if(t){let l=h.getUTCHours().toString().padStart(2,"0"),c=h.getUTCMinutes().toString().padStart(2,"0"),d=h.getUTCSeconds().toString().padStart(2,"0");return s?`${n} ${o} ${a} ${l}:${c}:${d}.${h.getUTCMilliseconds().toString().padStart(3,"0")}`:`${n} ${o} ${a} ${l}:${c}:${d}`}return`${n} ${o} ${a}`}function Un(h,t=0,s=10,n=2,o="white"){h.lineWidth=n,h.strokeStyle=o,h.beginPath(),h.moveTo(t,0),h.lineTo(t,s),h.stroke()}function Nl(h,t,s,n,o="12px Arial",a="black",l="left",c="bottom",d=0){h.save(),h.translate(s,n),h.rotate(d*j),h.fillStyle=a,h.textBaseline=c,h.font=o,h.textAlign=l,h.fillText(t,0,0),h.restore()}const Zs=[[.001,10],[.002,10],[.005,10],[.01,10],[.02,10],[.05,10],[.1,10],[.25,10],[.5,5],[1,10],[2,10],[5,5],[10,10],[15,15],[30,6],[60,12],[120,12],[300,5],[600,10],[900,15],[1800,6],[3600,12],[7200,10],[14400,4],[21600,6],[43200,12],[86400,24],[172800,2],[345600,4],[604800,7],[1296e3,15],[2592e3,5],[5184e3,6],[7776e3,9],[15552e3,18],[31536e3,12],[63072e3,2],[126144e3,4],[15768e4,5],[31536e4,10],[63072e4,2],[126144e4,4],[15768e5,5],[31536e5,10],[63072e5,2],[126144e5,4],[15768e6,5],[31536e6,10]],Hl=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],Vl=["change","current"];class Ul{constructor(t={}){this.events=lt(Vl),this._current=t.current||new Date,this._rangeStart=t.rangeStart||new Date,this._rangeEnd=t.rangeEnd||te(this._rangeStart,3600),this._range=this._rangeEnd.getTime()-this._rangeStart.getTime(),this._minDate=t.minDate||null,this._maxDate=t.maxDate||null,this.multiplier=t.multiplier!=null?t.multiplier:1,this._requestAnimationFrameId=0,this._prevNow=0,this.dt=0}play(){this._requestAnimationFrameId||(this._prevNow=window.performance.now(),this._animationFrameCallback())}stop(){this._requestAnimationFrameId&&(window.cancelAnimationFrame(this._requestAnimationFrameId),this._requestAnimationFrameId=0)}stopped(){return this._requestAnimationFrameId==0}_animationFrameCallback(){this._requestAnimationFrameId=window.requestAnimationFrame(()=>{this._frame(),this._animationFrameCallback()})}_frame(){let t=window.performance.now();this.dt=t-this._prevNow,this._prevNow=t,this.current=new Date(this.currentTime+this.dt*this.multiplier)}get range(){return this._range}set(t,s){t===this._rangeStart&&s===this._rangeEnd||(this._rangeStart=t,this._rangeEnd=s,this._range=this._rangeEnd.getTime()-this._rangeStart.getTime(),this.events.dispatch(this.events.change,t,s))}get current(){return this._current}get rangeStart(){return this._rangeStart}get rangeEnd(){return this._rangeEnd}get rangeStartTime(){return this._rangeStart.getTime()}get rangeEndTime(){return this._rangeEnd.getTime()}get currentTime(){return this._current.getTime()}set current(t){t!==this._current&&(this._maxDate&&t>this._maxDate?this._current=this._maxDate:this._minDate&&t<this._minDate?this._current=this._minDate:this._current=t,this.events.dispatch(this.events.current,this._current))}set rangeStart(t){t!==this._rangeStart&&(this._rangeStart=t,this._range=this._rangeEnd.getTime()-this._rangeStart.getTime(),this.events.dispatch(this.events.change,t))}set rangeEnd(t){t!==this._rangeEnd&&(this._rangeEnd=t,this._range=this._rangeEnd.getTime()-this._rangeStart.getTime(),this.events.dispatch(this.events.change,t))}}const Fe=.001,Gl=["startdrag","stopdrag","startdragcurrent","stopdragcurrent","setcurrent","reset","play","playback","pause","visibility"],Gn="#bfbfbf";class jl extends ut{constructor(t={}){super({template:`<div class="og-timeline">

  <div class="og-timeline-top">
  </div>

  <div class="og-timeline-frame">
    <div class="og-timeline-current">
      <div class="og-timeline-current-spin">
        <div class="og-timeline-current-arrow"></div>
      </div>
    </div>
    <div class="og-timeline-scale"></div>
  </div>

  <div class="og-timeline-bottom">
    <div class="og-timeline-controls">
    </div>
  </div>

</div>`,model:new Ul({rangeStart:t.rangeStart,rangeEnd:t.rangeEnd,current:t.currentDate,minDate:t.minDate,maxDate:t.maxDate})}),this._onMouseWheel=s=>{if(this._isMouseOver){let n=this._canvasEl.getBoundingClientRect(),o=s.clientX-n.left,a=-(o-.5*this.clientWidth),l=this.model.rangeStartTime+this._millisecondsInPixel*o;this._zoom(l,a,Math.sign(s.wheelDelta))}else if(this._isCurrentMouseOver){let n=-((this.model.currentTime-this.model.rangeStartTime)/this._millisecondsInPixel-.5*this.clientWidth);this._zoom(this.model.currentTime,n,Math.sign(s.wheelDelta))}},this._onMouseWheelFF=s=>{this._onMouseWheel(s)},this._onMouseDown=s=>{this._isMouseOver?(this._isDragging=!0,document.body.classList.add("og-timeline-unselectable"),this._clickPosX=s.clientX,this._clickTime=Date.now(),this._clickRangeStart=this.model.rangeStart,this._clickRangeEnd=this.model.rangeEnd,this.events.dispatch(this.events.startdrag,s)):this._isCurrentMouseOver&&(this._isCurrentDragging=!0,document.body.classList.add("og-timeline-unselectable"),this._clickPosX=s.clientX,this._clickCurrentDate=this.model.current,this.events.dispatch(this.events.startdragcurrent,s))},this._onMouseUp=s=>{if(this._isDragging)if(this._isDragging=!1,document.body.classList.remove("og-timeline-unselectable"),this._clickPosX===s.clientX&&Date.now()-this._clickTime<this._clickDelay){let n=this._canvasEl.getBoundingClientRect(),o=new Date(this.model.rangeStartTime+(s.clientX-n.left)*this._millisecondsInPixel);this.model.current=o,this.events.dispatch(this.events.stopdrag,o),this.events.dispatch(this.events.setcurrent,o)}else this.events.dispatch(this.events.stopdrag,this.model.current);else this._isCurrentDragging&&(this._isCurrentDragging=!1,document.body.classList.remove("og-timeline-unselectable"),this.events.dispatch(this.events.stopdragcurrent,this.model.current))},this._onMouseEnter=()=>{this._isMouseOver=!0},this._onMouseOut=()=>{this._isMouseOver=!1},this._onCurrentMouseEnter=()=>{this._isCurrentMouseOver=!0},this._onCurrentMouseOut=()=>{this._isCurrentMouseOver=!1},this._onMouseMove=s=>{if(this._isDragging){let n=(this._clickPosX-s.clientX)*this._millisecondsInPixel*Fe;this.model.set(te(this._clickRangeStart,n),te(this._clickRangeEnd,n))}else if(this._isCurrentDragging){let n=(this._clickPosX-s.clientX)*this._millisecondsInPixel*Fe,o=te(this._clickCurrentDate,-n);o>=this.model.rangeStart&&o<=this.model.rangeEnd&&(this.model.current=te(this._clickCurrentDate,-n))}},this.events=this.events.registerNames(Gl),this.fillStyle=t.fillStyle||"rgba(64, 59, 59, 1.0)",this.$controls=null,this._frameEl=null,this._currentEl=null,this._canvasEl=document.createElement("canvas"),this._ctx=this._canvasEl.getContext("2d"),this._isMouseOver=!1,this._isDragging=!1,this._isCurrentDragging=!1,this._isCurrentMouseOver=!1,this._minWidth=330,this._canvasScale=2,this._millisecondsInPixel=0,this._clickPosX=0,this._clickRangeStart=new Date,this._clickRangeEnd=new Date,this._clickCurrentDate=new Date,this._clickTime=0,this._clickDelay=450,this._onResizeObserver_=this._onResizeObserver.bind(this),this._resizeObserver=new ResizeObserver(this._onResizeObserver_),this._pauseBtn=new dt({classList:["og-timeline-control_button"],icon:`<?xml version="1.0" ?><!DOCTYPE svg  PUBLIC '-//W3C//DTD SVG 1.1//EN'  'http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd'><svg enable-background="new 0 0 512 512" height="512px" version="1.1" viewBox="0 0 512 512" width="512px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><g id="Layer_6"><rect fill="#252525" height="320" width="60" x="153" y="96"/><rect fill="#252525" height="320" width="60" x="299" y="96"/></g></svg>`,name:"pause"}),this._playBtn=new dt({classList:["og-timeline-control_button"],icon:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M8 5v14l11-7z" style="fill: black;"/></svg>',name:"play"}),this._buttons=new jo({buttons:[this._pauseBtn,this._playBtn]}),this._visibility=!1}_onResizeObserver(){this.resize()}get canvasScale(){return this._canvasScale}set canvasScale(t){t!==this._canvasScale&&(this._canvasScale=t,this.resize())}resize(){this._resize(),this.draw()}afterRender(t){this.resize()}render(){return super.render(),this.$controls=this.select(".og-timeline-controls"),this._frameEl=this.select(".og-timeline-frame"),this._currentEl=this.select(".og-timeline-current"),this.select(".og-timeline-frame .og-timeline-scale").appendChild(this._canvasEl),this._resizeObserver.observe(this.el),this.model.events.on("change",()=>{this.draw()}),this.model.events.on("current",t=>{this._drawCurrent(),this.events.dispatch(this.events.setcurrent,t)}),this._canvasEl.addEventListener("mouseenter",this._onMouseEnter),this._canvasEl.addEventListener("mouseout",this._onMouseOut),this._currentEl.addEventListener("mouseenter",this._onCurrentMouseEnter),this._currentEl.addEventListener("mouseout",this._onCurrentMouseOut),document.body.addEventListener("mousemove",this._onMouseMove),document.body.addEventListener("mousedown",this._onMouseDown),document.body.addEventListener("mouseup",this._onMouseUp),document.body.addEventListener("wheel",this._onMouseWheelFF),this._playBtn.appendTo(this.$controls),this._pauseBtn.appendTo(this.$controls),this.model.stopped()?(this._pauseBtn.setActive(!0,!0),this._pauseBtn.preventClick=!0):(this._playBtn.setActive(!0,!0),this._playBtn.preventClick=!0),this._buttons.events.on("change",t=>{switch(t.name){case"play":this.play();break;case"pause":this.pause()}}),this.setVisibility(!0),this}setVisibility(t){t!==this._visibility&&(this._visibility=t,this.el&&(this.el.style.display=t?"block":"none"),this.events.dispatch(this.events.visibility,t))}reset(){this.model.stop(),this.events.dispatch(this.events.reset,this.model)}play(){this.model.multiplier=Math.abs(this.model.multiplier),this.model.play(),this.events.dispatch(this.events.play,this.model)}pause(){this.model.stop(),this.events.dispatch(this.events.pause,this.model)}playBack(){this.model.multiplier=-1*Math.abs(this.model.multiplier),this.model.play(),this.events.dispatch(this.events.playback,this.model)}_zoom(t,s,n){let o=(t-(this.model.rangeStartTime+.5*this.model.range))*Fe,a=te(this.model.rangeStart,o),l=te(this.model.rangeEnd,o),c=(l.getTime()-a.getTime())/20*Fe,d=te(a,c*n),u=te(l,-c*n),_=(u.getTime()-d.getTime())/this.clientWidth;if(_<31536e6&&_>.1){let f=_*s*Fe;this.model.set(te(d,f),te(u,f))}}get clientWidth(){return this._canvasEl?this._canvasEl.width/this._canvasScale:0}get clientHeight(){return this._canvasEl?this._canvasEl.height/this._canvasScale:0}_resize(){this._frameEl&&(this._canvasEl.width=this._frameEl.clientWidth*this._canvasScale,this._canvasEl.height=this._frameEl.clientHeight*this._canvasScale,this._canvasEl.style.width=`${this._frameEl.clientWidth}px`,this._canvasEl.style.height=`${this._frameEl.clientHeight}px`)}getOffsetByTime(t){return(t-this.model.rangeStartTime)/this._millisecondsInPixel}remove(){super.remove(),this.model.stop()}_clearCanvas(){this._ctx.fillStyle=this.fillStyle,this._ctx.fillRect(0,0,this.clientWidth*this._canvasScale,this.clientHeight*this._canvasScale)}_drawCurrent(){let t=(this.model.currentTime-this.model.rangeStartTime)/this._millisecondsInPixel;this.model.current<this.model.rangeStart||this.model.current>this.model.rangeEnd?this._currentEl.style.display="none":(this._currentEl.style.display="block",this._currentEl.style.transform=`translateX(${t}px)`)}draw(){this._millisecondsInPixel=this.model.range/this.clientWidth;let t=function(n){for(let o=0,a=Zs.length;o<a;o++)if(Zs[o][0]>n)return Zs[o-1]}(this._minWidth*this._millisecondsInPixel*Fe);if(t){this._clearCanvas();let n=1e3*t[0],o=n/this._millisecondsInPixel,a=t[1],l=(s=this.model.rangeStartTime)-s%n,c=t[0]<1,d=t[0]<86400;for(let u=l,_=this.model.rangeEndTime+n;u<_;u+=n){let f=this.getOffsetByTime(u);f>=0&&f<=this.clientWidth*this._canvasScale&&Un(this._ctx,f*this._canvasScale,10*this._canvasScale,2*this._canvasScale,Gn);for(let g=1;g<a;g++){let m=f+g*(o/a);m>=0&&m<=this.clientWidth*this._canvasScale&&Un(this._ctx,m*this._canvasScale,5*this._canvasScale,1*this._canvasScale,Gn)}Nl(this._ctx,Ol(new Date(u),d,c),f*this._canvasScale,26*this._canvasScale,"24px monospace","#bfbfbf","center")}this._drawCurrent()}var s}}function jn(h,t){const s=new Date(h);return s.setHours(s.getHours()+t),s}class pi{constructor(){this.resolve=()=>{},this.reject=()=>{},this.promise=new Promise((t,s)=>{this.resolve=t,this.reject=s}),Object.freeze(this)}}const ql=["startcollecting","profilecollected","clear"];class Yl{constructor(t={}){this.events=lt(ql),this.planet=t.planet||null,this._warningHeightLevel=5,this._pointsReady=!1,this._isWarning=!1,this._minX=0,this._planeDistance=this._maxX=1e3,this._minY=0,this._maxY=200,this._drawData=[[],[]],this._promiseArr=[],this._promiseCounter=0,this._pMaxY=0,this._pMinY=0,this._pDist=0,this._pTrackCoords=[],this._pGroundCoords=[],this._pIndex=0}bindPlanet(t){this.planet=t}setWarningHeightLevel(t=0){this._warningHeightLevel=t}setRange(t,s,n,o){this._minX=t,this._maxX=s,n&&(this._minY=n),o&&(this._maxY=o)}_getHeightAsync(t,s,n){let o=new pi;if(this.planet){let a=this.planet.terrain.geoid.getHeightLonLat(t);this.planet.terrain.getHeightAsync(t,l=>{this.planet&&n===this._promiseCounter?(l+=a,this._pGroundCoords[s][1]=l,this._pGroundCoords[s][2]=0,this._pGroundCoords[s][3]=t.height,l>this._pMaxY&&(this._pMaxY=l),l<this._pMinY&&(this._pMinY=l),this._updatePointType(s),o.resolve(l)):o.reject()})}else o.reject();return o.promise}_collectCoordsBetweenTwoTrackPoints(t,s,n,o,a,l){if(this.planet)for(let c=1;c<=s;c++){this._pDist+=1,this._pIndex++;let d=c*n,u=o.add(a.scaleTo(d)),_=this.planet.ellipsoid.cartesianToLonLat(u);this._pGroundCoords[this._pIndex]=[this._pDist,0,0,0,t],((f,g)=>{this._promiseArr.push(this._getHeightAsync(f,g,l))})(_,this._pIndex)}}_collectAllPoints(t,s){if(!this.planet||s!==this._promiseCounter)return;let n=new v,o=new v;for(let a=1,l=t.length;a<l;a++){let c=t[a-1],d=t[a];this.planet.ellipsoid.lonLatToCartesianRes(c,n),this.planet.ellipsoid.lonLatToCartesianRes(d,o);let u=o.sub(n),_=u.length(),f=this.planet.ellipsoid.getSurfaceNormal3v(n),g=v.proj_b_to_plane(u,f),m=g.length(),p=Math.floor(m/1),x=1*_/m;this._getGroundElevation(c,a-1,s),g.normalize(),u.normalize(),this._collectCoordsBetweenTwoTrackPoints(a-1,p,x,n,u,s),this._pDist+=m-1*p,this._pIndex++;let y=d.height;y>this._pMaxY&&(this._pMaxY=y),y<this._pMinY&&(this._pMinY=y),this._pTrackCoords[a]=[this._pDist,y,this._pIndex]}}_getGroundElevation(t,s,n){this._pGroundCoords[this._pIndex]=[this._pDist,0,0,0,s],this._promiseArr.push(this._getHeightAsync(t,this._pIndex,n))}_calcPointsAsync(t,s){return new Promise((n,o)=>{this._pTrackCoords=[[0,t[0].height,0]],this._pMaxY=t[0].height,this._pMinY=this._pMaxY,this._pDist=0,this._pGroundCoords=[],this._pIndex=0,this._promiseArr=[],this._collectAllPoints(t,s),this._getGroundElevation(t[t.length-1],t.length-1,s),Promise.all(this._promiseArr).then(()=>{n({dist:this._pDist,minY:this._pMinY,maxY:this._pMaxY,trackCoords:this._pTrackCoords,groundCoords:this._pGroundCoords})})})}get minX(){return this._minX}get planeDistance(){return this._planeDistance}get maxX(){return this._maxX}get minY(){return this._minY}get maxY(){return this._maxY}get pointsReady(){return this._pointsReady}get isWarningOrCollision(){return this._isWarning}get drawData(){return this._drawData}collectProfile(t){let s=new pi;return this.planet||s.reject(),this._pointsReady=!1,this._isWarning=!1,t&&t.length?(this.events.dispatch(this.events.startcollecting,this),this._promiseCounter++,(n=>{this._calcPointsAsync(t,n).then(o=>{n===this._promiseCounter&&(this._planeDistance=o.dist,this.setRange(0,o.dist,o.minY-.1*Math.abs(o.minY),o.maxY+.2*Math.abs(o.maxY)),this._pointsReady=!0,this._drawData=[o.trackCoords,o.groundCoords],this.events.dispatch(this.events.profilecollected,this._drawData,this),s.resolve(this._drawData))})})(this._promiseCounter),s.promise):(s.reject(),s.promise)}_updatePointType(t){this._pGroundCoords[t][3]>=this._pGroundCoords[t][1]&&this._pGroundCoords[t][3]<this._pGroundCoords[t][1]+this._warningHeightLevel-.1&&(this._pGroundCoords[t][2]=1),this._pGroundCoords[t][3]<=this._pGroundCoords[t][1]+1&&(this._pGroundCoords[t][2]=2),this._pGroundCoords[t][2]!==1&&this._pGroundCoords[t][2]!==2||(this._isWarning=!0)}_setPointsType(){this._isWarning=!1,this._pTrackCoords=this._drawData[0],this._pGroundCoords=this._drawData[1];for(let t=0;t<this._pGroundCoords.length;t++)this._updatePointType(t);this._drawData[1]=this._pGroundCoords,this.events.dispatch(this.events.profilecollected,this._drawData,this)}clear(){this._promiseCounter=0,this._pointsReady=!1,this._isWarning=!1,this._drawData=[[],[]],this._pMaxY=0,this._pMinY=0,this._pDist=0,this._pTrackCoords=[],this._pGroundCoords=[],this._pIndex=0,this.events.dispatch(this.events.clear,this._drawData,this)}}const va="rgb(198, 198, 198)",qn=[va,"rgb(255, 255, 0)","rgb(255, 0, 0)"],Wl=["startdrag","stopdrag","pointer","mouseenter","mouseleave","dblclick","tracklength","groundlength","warninglength","collisionlength"];class $l extends ut{constructor(t={}){super({template:`<div class="og-elevationprofile">
      <div class="og-elevationprofile-loading" style="display: none;">
        <div class="loadingio-spinner-bars-r354qqyl5v">
          <div class="ldio-p0v5a1f6oz">
            <div></div>
            <div></div>
            <div></div>
            <div></div>
          </div>
        </div> 
      </div>     
    </div>`,model:new Yl}),this._onMouseDblClick=s=>{let n,o=this.$canvas.getBoundingClientRect(),a=s.clientX-o.left,l=this._leftDistance+(this._rightDistance-this._leftDistance)*a/this.clientWidth,c=this.model.drawData[1],d=this.model.drawData[0];l<0?(n=1,l=0,a=(0-this._leftDistance)*this.clientWidth/(this._rightDistance-this._leftDistance)):l>this.model.planeDistance?(n=c.length-1,l=this.model.planeDistance,a=(l-this._leftDistance)*this.clientWidth/(this._rightDistance-this._leftDistance)):n=-1-Re(c,l,(w,C)=>w-C[0]);let u=c[n-1],_=c[n],f=(l-u[0])/(_[0]-u[0]),g=u[1]+f*(_[1]-u[1]),m=u[4],p=d[m],x=d[m+1];f=(l-p[0])/(x[0]-p[0]);let y=p[1]+f*(x[1]-p[1]);this.events.dispatch(this.events.dblclick,l,p,x,u,_,m,n-1,y-g)},this._onMouseEnter=s=>{this._isMouseOver=!0,this.events.dispatch(this.events.mouseenter,s)},this._onMouseOut=s=>{this._isMouseOver=!1,this.events.dispatch(this.events.mouseleave,s)},this._onMouseDown=s=>{this._isMouseOver&&(this._isDragging=!0,document.body.classList.add("og-timeline-unselectable"),this._clickPosX=s.clientX,this._customFrame||(this._leftDistance=this.model.minX,this._rightDistance=this.model.maxX),this._clickLeftDistance=this._leftDistance,this._clickRightDistance=this._rightDistance,this.events.dispatch(this.events.startdrag,s))},this._onMouseUp=s=>{this._isDragging&&(this._isDragging=!1,document.body.classList.remove("og-timeline-unselectable"),this.events.dispatch(this.events.stopdrag,s))},this._onCanvasMouseMove=s=>{if(this.model.pointsReady)if(this._isDragging)this.clearPointerCanvas();else{this._customFrame||(this._leftDistance=this.model.minX,this._rightDistance=this.model.maxX);let n=this.$pointerCanvas.getBoundingClientRect(),o=s.clientX-n.left;this.redrawPointerCanvas(o)}},this._onMouseMove=s=>{if(this._isDragging&&this.model.pointsReady){let n=(this._clickPosX-s.clientX)*this._canvasScale/this._pixelsInMeter_x;this.setFrame(this._clickLeftDistance+n,this._clickRightDistance+n)}},this._onMouseWheelFF=s=>{this._onMouseWheel(s)},this._onMouseWheel=s=>{if(this._isMouseOver&&this.model.pointsReady){this._customFrame||(this._leftDistance=this.model.minX,this._rightDistance=this.model.maxX),this._customFrame=!0;let n=Math.sign(s.wheelDelta)*(this._rightDistance-this._leftDistance)/20,o=this.$canvas.getBoundingClientRect(),a=s.clientX-o.left,l=a-.5*this.$canvas.clientWidth,c=l*this._canvasScale/this._pixelsInMeter_x,d=c+this._leftDistance+n,u=c+this._rightDistance-n;c=-l*(u-d)/this.clientWidth,this.setFrame(d+c,u+c),this.redrawPointerCanvas(a)}},this.events=this.events.registerNames(Wl),this.fillStyle=t.fillStyle||"rgb(63, 63, 63)",this._customFrame=!1,this._leftDistance=0,this._rightDistance=0,this._pixelsInMeter_x=0,this._pixelsInMeter_y=0,this._canvasScale=2,this.$canvas=document.createElement("canvas"),this.$canvas.style.position="absolute",this._ctx=this.$canvas.getContext("2d"),this.$pointerCanvas=document.createElement("canvas"),this.$pointerCanvas.style.pointerEvents="none",this.$pointerCanvas.style.position="absolute",this._pointerCtx=this.$pointerCanvas.getContext("2d"),this.$loading=null,this._isMouseOver=!1,this._isDragging=!1,this._clickPosX=0,this._clickLeftDistance=0,this._clickRightDistance=0,this._timeStartHandler=0,this._onResizeObserver_=this._onResizeObserver.bind(this),this._resizeObserver=new ResizeObserver(this._onResizeObserver_)}_onResizeObserver(){this.resize()}get canvasScale(){return this._canvasScale}set canvasScale(t){t!==this._canvasScale&&(this._canvasScale=t,this.resize())}resize(){this._resize(),this.draw()}render(){return super.render(),this._resizeObserver.observe(this.el),this.el.appendChild(this.$canvas),this.el.appendChild(this.$pointerCanvas),this.model.events.on("profilecollected",t=>{this._hideLoading(),this.clearPointerCanvas(),this.draw()}),this.model.events.on("startcollecting",()=>{clearTimeout(this._timeStartHandler),this._timeStartHandler=setTimeout(()=>{this._showLoading()},450)}),this.model.events.on("clear",()=>{this._customFrame=!1,this._leftDistance=0,this.clearCanvas(),this.clearPointerCanvas()}),this.$loading=this.select(".og-elevationprofile-loading"),this.$canvas.addEventListener("mouseenter",this._onMouseEnter),this.$canvas.addEventListener("mouseout",this._onMouseOut),this.$canvas.addEventListener("dblclick",this._onMouseDblClick),this.$canvas.addEventListener("mousemove",this._onCanvasMouseMove),document.body.addEventListener("mousemove",this._onMouseMove),document.body.addEventListener("mousedown",this._onMouseDown),document.body.addEventListener("mouseup",this._onMouseUp),document.body.addEventListener("wheel",this._onMouseWheelFF),this}_hideLoading(){clearTimeout(this._timeStartHandler),this.$loading.style.display="none"}_showLoading(){this.$loading.style.display="flex"}redrawPointerCanvas(t){this.clearPointerCanvas();let s,n=this._leftDistance+(this._rightDistance-this._leftDistance)*t/this.clientWidth,o=this.model.drawData[1],a=this.model.drawData[0];n<0?(s=1,n=0,t=(0-this._leftDistance)*this.clientWidth/(this._rightDistance-this._leftDistance)):n>this.model.planeDistance?(s=o.length-1,n=this.model.planeDistance,t=(n-this._leftDistance)*this.clientWidth/(this._rightDistance-this._leftDistance)):s=-1-Re(o,n,(C,T)=>C-T[0]);let l=o[s-1],c=o[s],d=(n-l[0])/(c[0]-l[0]),u=l[1]+d*(c[1]-l[1]),_=l[4],f=a[_],g=a[_+1];d=(n-f[0])/(g[0]-f[0]);let m=f[1]+d*(g[1]-f[1]),p=(this.model.maxY-m)*this._pixelsInMeter_y,x=(this.model.maxY-u)*this._pixelsInMeter_y;this.events.dispatch(this.events.pointer,n,f,g,l,c,_,s-1,m-u);let y=this._pointerCtx;y.lineWidth=3,y.strokeStyle="rgba(64,64,64,0.6)",y.beginPath(),y.moveTo(t*this._canvasScale,0),y.lineTo(t*this._canvasScale,this.clientHeight*this._canvasScale),y.stroke(),y.beginPath(),y.arc(t*this._canvasScale,x,4,0,2*Math.PI,!1),y.fillStyle="#FFB277",y.fill(),y.lineWidth=4,y.strokeStyle="#FFB277",y.stroke(),y.beginPath(),y.arc(t*this._canvasScale,p,4,0,2*Math.PI,!1),y.fillStyle="#FFB277",y.fill(),y.lineWidth=4,y.strokeStyle="#FFB277",y.stroke(),y.lineWidth=3,y.strokeStyle="#FFB277",y.beginPath(),y.moveTo(t*this._canvasScale,x),y.lineTo(t*this._canvasScale,p),y.stroke(),y.fillStyle="white",y.font=28/devicePixelRatio+"px Arial",y.textBaseline="middle",y.textAlign="left",y.fillText(`${Math.round(m-u).toString()} m`,(t+5)*this._canvasScale,x+.5*(p-x)),y.fillStyle="white",y.font=28/devicePixelRatio+"px Arial",y.textAlign="right";let w=Ge(n);y.fillText(`${w[0]} ${w[1]}`,(t-5)*this._canvasScale,(this.clientHeight-7)*this._canvasScale)}get clientWidth(){return this.$canvas?this.$canvas.width/this._canvasScale:0}get clientHeight(){return this.$canvas?this.$canvas.height/this._canvasScale:0}_resize(){this.el&&(this.$canvas.width=this.el.clientWidth*this._canvasScale,this.$canvas.height=this.el.clientHeight*this._canvasScale,this.$canvas.style.width=`${this.el.clientWidth}px`,this.$canvas.style.height=`${this.el.clientHeight}px`,this.$pointerCanvas.width=this.el.clientWidth*this._canvasScale,this.$pointerCanvas.height=this.el.clientHeight*this._canvasScale,this.$pointerCanvas.style.width=`${this.el.clientWidth}px`,this.$pointerCanvas.style.height=`${this.el.clientHeight}px`,this._customFrame&&(this._pixelsInMeter_x=this._canvasScale*this.clientWidth/(this._rightDistance-this._leftDistance)))}clearPointerCanvas(){this._pointerCtx.fillStyle="rgba(0,0,0,0)",this._pointerCtx.clearRect(0,0,this.clientWidth*this._canvasScale,this.clientHeight*this._canvasScale)}clearCanvas(){const t=this._ctx.createLinearGradient(0,0,0,this.clientHeight*this._canvasScale);t.addColorStop(0,"black"),t.addColorStop(1,this.fillStyle),this._ctx.fillStyle=t,this._ctx.fillRect(0,0,this.clientWidth*this._canvasScale,this.clientHeight*this._canvasScale)}setFrame(t,s){this._leftDistance=t,this._rightDistance=s,this._customFrame=!0,this._pixelsInMeter_x=this._canvasScale*this.clientWidth/(this._rightDistance-this._leftDistance),this.model.setRange(t,s),this.draw()}_updateUnits(){this._customFrame||(this._pixelsInMeter_x=this._canvasScale*this.clientWidth/(this.model.maxX-this.model.minX)),this._pixelsInMeter_y=this._canvasScale*this.clientHeight/(this.model.maxY-this.model.minY)}clear(){this.model.clear(),this.clearCanvas()}draw(){let t=this.model.drawData[0];if(t.length>1){this._updateUnits(),this.clearCanvas();let s=this.model.drawData[1];this._drawTrack(t,s),this._drawTerrain(s),this._drawWarningAndCollision(s),this._drawLabels(t,s)}else this.clearCanvas()}_drawLabels(t,s){let n=this._ctx;if(n){let o=t[0];const a=this.model.maxY;let l=(-this._leftDistance+o[0])*this._pixelsInMeter_x,c=(a-o[1])*this._pixelsInMeter_y;s[o[2]][1],this._pixelsInMeter_y,n.beginPath(),n.fillStyle="#F7F718",n.fillRect(l-4,c-4,8,8),n.stroke(),n.fillStyle="white",n.font=26/devicePixelRatio+"px Arial",n.textBaseline="bottom",n.textAlign="left",n.fillText(`${Math.round(o[1]-s[o[2]][1]).toString()} m`,l+1,c-10),n.stroke();for(let d=1,u=t.length;d<u;d++){let _=t[d];l=(-this._leftDistance+_[0])*this._pixelsInMeter_x,c=(a-_[1])*this._pixelsInMeter_y,s[_[2]][1],this._pixelsInMeter_y,n.beginPath(),n.fillStyle="#F7F718",n.fillRect(l-4,c-4,8,8),n.stroke(),n.fillStyle="white",n.fillText(`${Math.round(_[1]-s[_[2]][1]).toString()} m`,l+1,c-10),n.stroke()}}}_drawTrack(t,s){let n=t[0],o=this._ctx;if(o){const a=this.model.maxY;o.lineWidth=5,o.strokeStyle="rgb(0, 255, 50)",o.beginPath(),o.moveTo((-this._leftDistance+n[0])*this._pixelsInMeter_x,(a-n[1])*this._pixelsInMeter_y);let l=0;for(let _=1,f=t.length;_<f;_++){let g=t[_];o.lineTo((-this._leftDistance+g[0])*this._pixelsInMeter_x,(a-g[1])*this._pixelsInMeter_y);let m=t[_-1],p=g[0]-m[0],x=g[1]-m[1],y=p*p,w=x*x;l+=Math.sqrt(y+w)}o.stroke(),o.lineWidth=2,o.strokeStyle="rgba(255,255,255,0.7)",o.beginPath();let c=(-this._leftDistance+n[0])*this._pixelsInMeter_x,d=(a-n[1])*this._pixelsInMeter_y,u=(a-s[n[2]][1])*this._pixelsInMeter_y;o.moveTo(c,d),o.lineTo(c,u);for(let _=1,f=t.length;_<f;_++){let g=t[_];c=(-this._leftDistance+g[0])*this._pixelsInMeter_x,d=(a-g[1])*this._pixelsInMeter_y,u=(a-s[g[2]][1])*this._pixelsInMeter_y,o.strokeStyle="rgba(255,255,255,0.7)",o.moveTo(c,d),o.lineTo(c,u)}o.stroke(),this.events.dispatch(this.events.tracklength,l)}}_drawTerrain(t){let s=t[0],n=this._ctx;if(n){const o=this.model.maxY;n.lineWidth=5,n.strokeStyle=va,n.beginPath(),n.moveTo((-this._leftDistance+s[0])*this._pixelsInMeter_x,this.$canvas.height),n.lineTo((-this._leftDistance+s[0])*this._pixelsInMeter_x,(o-s[1])*this._pixelsInMeter_y);let a=0;for(let l=1,c=t.length;l<c;l++){let d=t[l];n.lineTo((-this._leftDistance+d[0])*this._pixelsInMeter_x,(o-d[1])*this._pixelsInMeter_y);let u=t[l-1],_=d[0]-u[0],f=d[1]-u[1],g=_*_,m=f*f;a+=Math.sqrt(g+m)}n.lineTo((-this._leftDistance+t[t.length-1][0])*this._pixelsInMeter_x,this.$canvas.height),n.closePath(),n.stroke(),n.save(),n.fillStyle="rgb(64, 68, 82)",n.globalAlpha=.5,n.fill(),n.restore(),n.globalAlpha=1,this.events.dispatch(this.events.groundlength,a)}}_drawWarningAndCollision(t){let s=this._ctx;if(s&&t.length>1){let n=this.model.maxY;s.lineWidth=5,s.beginPath();let o=0,a=0;for(let l=0,c=t.length-1;l<c;l++){let d=t[l],u=t[l+1];if(d[2]!==0&&u[2]!==0){let _=u[0]-d[0],f=u[1]-d[1],g=_*_,m=f*f;d[2]===2?(s.stroke(),s.beginPath(),s.strokeStyle=qn[2],a+=Math.sqrt(g+m)):d[2]===1&&(s.stroke(),s.beginPath(),s.strokeStyle=qn[1],o+=Math.sqrt(g+m)),s.moveTo((-this._leftDistance+d[0])*this._pixelsInMeter_x,(n-d[1])*this._pixelsInMeter_y),s.lineTo((-this._leftDistance+u[0])*this._pixelsInMeter_x,(n-u[1])*this._pixelsInMeter_y)}}s.stroke(),this.events.dispatch(this.events.warninglength,o),this.events.dispatch(this.events.collisionlength,a)}}}let Xl=$.createCylinder(.33,0,1,20,1,!0,!1,0,0,0),Zl=$.createCylinder(.33,.33,1.1,20,1,!0,!0,0,-.55,0);const Kl={startPosition:new v,endPosition:new v,startColor:"rgba(255,131,0,0.2)",endColor:"rgba(255,131,0,1.0)",thickness:2.7},Ql={src:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACACAYAAADDPmHLAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAAYdEVYdFNvZnR3YXJlAHBhaW50Lm5ldCA0LjEuNBNAaMQAAAiLSURBVHhe7Z0r0BxFEMcjIhAIRERERAQCgUAgEBEIBAIRiUAgIiIQiAgEIlUREQgEIgIREYFAIBCIiAgEIiIiAoGIoHimqPAKz5CP/t23/8vcbe89d/dmZ/pf9avLdZK72e6+ee3M7Imjo6Opc8o4b7xn3DIeGEOJz+Y7+C6+k+/2yjQZXOMEOGdcNe4anv4wvjV+m73bT3wGn8VneqIMlIUyeWXNGteYKTj4feNrI9W/xi/HfxxVfCffnYqyUcbJJINrzIjTxjvGV0aqn43fj/+YhSgLZUpFmd81uAbv2rLANWbAC8ZHxp+GxC8ufZ+rKGNaI1FLcC1ck3etB8U1HhCqzk8N6T/jENV7X6LsXIN008iqeXCNB+B54zND+tt4ePzHIsS1cE0SicA1e74YFdc4IgyjrhvqTP3TvJas9Bq59oP2EVzjCJw03jI0TCMBcurUDS1qBCU9PnjbwCeerwbFNQ4MVd9tQ5pyG7+v0mvHJ6N3FF3jgFwy1JPvmlipUfIFvmHY6/luEFzjANDO0fGRfm1eQ0+UzlriqzOG58tecY0985LxnYH+al5D3ZKP8Bm+83zaG66xRy4a6uzU3NZvK/nqkUEH0fNtL7jGHqBH+4EhTWEGL2ddMwYZJbjGPaGgHxuIDA7tJ/mQGdLek8A17sHTxucGiva+P6kGxbf42PP9TrjGHUmDH1V+/xokCVzjDkTwx1HvSeAat4R2SWP8CP7wko9ZmrZ3n8A1bok6fBH88SRf4/u9ksA1bgFr4ZDG+qHxpLuKLFD1YrMRrnFDLhjocfMaGl8aIjLh5sVoLa5xA140+lhxG+pHNAk7TRu7xjXQ+9TK3Jru4ecqxYB7B88YXsw6cY1rUKcv7ujlI907YLbQi1knrnEFavej05ef1ClkpZUXOxfX2AH3p6Pdz1/E6FnDi2EL19iBVu3Gbd18pdgwU+jFsIVrdHjDQHGDJ39pkojm2ovlAq5xCXqWWtETmo7uG2t3L7vGJTTbF73+6UhNARtVvZjOcY0JZ42Y45+uGK2t7BC6xoQbBoqO3/SkGpt5Gy+2M1xjw3MGGZRubgxNS5qv6dxw4hob9OuPsf90pWnizlrANRpM+sSvvwypFqBGb8W6ZWjgHjOKtn/6Ug3OMv1WrFsG4ykjqv3yxGiudbdw4U2DbvjEuL8cqSZv7TJaeNOg1b2h8nTHWIj3whuDSQOUHmcSKkPagr5wNE0afLhioOj8lSc16QvTw2nwYfk8vlB5YjnfPOZp8FX9x8kd5Uqju3kzkCYAPUQU1X+5UjPACaatBEiPcAmVrfmKIQU/Jn/qEpNCs82lSgCOL0U/Na+hcvVD8/qKMU8AjiZDsdGjfCnGl415AnyCJVSVZptIlAD3sISqEgt9ZwnAHSIU07/1SMv7T5EA7CpFPzavofKljuA5EkCbPmICqB4p1m+SAPQGQ3XqMgnAQwtCdeo6CRBTwPXqJgnAKpFQnbpDAsQcQL26RwLEzt96dZ8ECFWsSIDKFQlQuSIBKlckQOUiAThLJlSnZqOAmAeoV7N5gJgJrFd3SQCePBGqU7dIgLgbWK9mdwO1ITRUn66QADoQIlYE1SPF+gIJEGsC69PCmkDOk0WxKrgeaQf4aRIA9AiYUD2a7wuA2BlUn1gKOE8A9ouj2BtYvh42r4z+5gnATlEUHcHy9X3z+poxT4A4H6Aecfxv63wAiOXh9ah1QgioHxAnhJYr1fKz9h/SBOA0aRSnhJUrJQCP/m0lAMQ5geWr85xA0I2haAbKk4b4K08KVTMQ08LlSU37vPqHNPgiVgiVK5r4hXgvvGm4aKC4PVyOFMuNnhfABEFMCpWnjZ8YAjxfBkUiTF/q/LH0rxXrlqFBJ4friVOh6Uod+oUHRYiWIYFnzaG4QzhdqefPo/+9GK9MAJ42SQ0QtcB0pV//wtAvxTUmqBaIiaHpSff9Z0fCduEaE+gLxBNEpyliRuzctl+4xiU0Ioh5gelIsfrQ8GI6xzUuwdjxgRGalojZacOL6RzX6KDNI0wmhPKWev6tWT8P19jBFwaKDmG+0pD9tnHS8OK4gGvsgDuFUQPkr7UdvxTXuAI9Wk7nzYfykX6clwwvdi6ucQ3MKqEYFeQjxYKFvRtV/cI1roG9hDpdNNYPHl6KAWc9re31L+MaN4DHzMUUcT4iFi8bXqxW4ho3RP2Bx81raHw9al557J8Xo7W4xi24ZqAYHYwv+XztbN8qXOMW0OFQpzBuG48n+XrrTt8yrnFLWELGViMUSTC85GN8Ptvftw+ucQcYGTD7hCIJhpN8y8rtrXv8Hq5xR7hpdNdAkQT9Sz7Fx70EH1zjHlAl6Z5BdAz7k3xJLdta2bsPrnFP0j5BzBXsL/mwlzZ/GdfYA/RMbxgo5gl2l3yHL/fq7XfhGnskfSpp3DvYXKmvZs/5HwrX2DOcP6QVRVqoGOqWfMSmnFcNz6e94RoH4IyhziGLFeMmUlv4RItv8RU+83zZK65xIGjDOH9AnZoYKj6RfIFvrhqDtPcernFg2KTwpSHVvMQsvXa2bnNus+ezwXCNI6DaQOPbGoeLumZ8gC9G+9WnuMYRYeOJdh+hGiaP0mvkiF584PlmFFzjAWAxgzqJqMRESK+Ja91pAUffuMYDwvGlaSJQTU65j0DZ0+aNaztveNd+EFxjBjB3QPWYOm9Kh1WkZeUa2KDJNXnXelBcY0bQPnKs2fIj7nOsFZbLRJkp+0Hb+HW4xgzhMGuqTubEl2sC9igcYpqZ71zeH0HZKCNlpczetWSFa8wcJQO7lrtONiUQ3xh9TDbxGXxWVxNEGSjLZIKe4honxlnjdYMFqnSyhhxB8Nl8B9/Fd/LdXpkmg2ssANpdfpEsXacdZq6BJ6Tya+VZyWnnUsLG3/Fv+Lf8H/4vn8FnZd2W78bRif8BxMOwtJg5Ph4AAAAASUVORK5CYII=",color:"rgb(255,131,0)",size:[8,8]},Jl={text:"",face:"arial",size:10.5,color:"rgba(455,455,455,1.0)",outlineColor:"rgba(0,0,0,0.34)",outline:.23,align:"left",offset:[5,15,-5]},Yn={face:"arial",text:"",size:10.5,color:"rgba(455,455,455,1.0)",outlineColor:"rgba(0,0,0,0.34)",outline:.23,align:"right",offset:[-47,25,0]},th={instanced:!0,tag:"ground-pointer",color:"rgb(0,305,0)",object3d:Xl},eh={instanced:!0,tag:"head-pointer",color:"rgb(305,305,0)",object3d:Zl};class ih extends de{constructor(t={}){super("ElevationProfileScene"),this._onLClick=s=>{let n=this._planet.getCartesianFromPixelTerrain(s.pos);n&&this.addGroundPoint3vAsync(n)},this._onMouseMove=s=>{if(this._planet.getCartesianFromMouseTerrain(),this._pickedGroundEntity){let n=new H(s.x,s.y).sub(this._startClickPos),o=this._startEntityPos.add(n),a=this._planet.getCartesianFromPixelTerrain(o);a&&this.setGroundPointCartesian3v(this._pickedGroundEntity.properties.index,a)}else if(this._pickedHeadEntity){let n=this._planet.camera,o=this._pickedHeadEntity.properties.groundEntity.getCartesian(),a=this._planet.ellipsoid.getSurfaceNormal3v(o),l=o.add(a),c=o.add(n.getRight()),d=new v;if(new V(n.eye,s.direction).hitPlaneRes(vt.fromPoints(o,l,c),d)===V.INSIDE){let u=v.proj_b_to_a(d,o),_=u.sub(o).dot(o),f=o.add(a.scale(Math.sign(_)*u.distance(o)));this.setHeadPointCartesian3v(this._pickedHeadEntity.properties.index,f)}}},this._onLUp=s=>{},this._onGroundPointerEnter=s=>{s.renderer.handler.canvas.style.cursor="pointer"},this._onGroundPointerLeave=s=>{s.renderer.handler.canvas.style.cursor="default"},this._onGroundPointerLDown=s=>{this._clampToGround=!1,this.renderer.controls.navigation.deactivate(),this._pickedGroundEntity=s.pickingObject;const n=this._pickedGroundEntity.getCartesian();this._startClickPos.set(s.x,s.y),this._startEntityPos=this._planet.getPixelFromCartesian(n)},this._onGroundPointerLUp=s=>{this._clampToGround=!0,this.renderer.controls.navigation.activate(),this._pickedGroundEntity=null},this._onHeadPointerEnter=s=>{s.renderer.handler.canvas.style.cursor="pointer"},this._onHeadPointerLeave=s=>{s.renderer.handler.canvas.style.cursor="default"},this._onHeadPointerLDown=s=>{this.renderer.controls.navigation.deactivate(),this._pickedHeadEntity=s.pickingObject},this._onHeadPointerLUp=s=>{this.renderer.controls.navigation.activate(),this._pickedHeadEntity=null},this.events=lt(sh),this._planet=t.planet||null,this._pickedGroundEntity=null,this._pickedHeadEntity=null,this._startClickPos=new H,this._startEntityPos=new H,this._clampToGround=!0,this._trackLayer=new _t("track",{entities:[],pickingEnabled:!1,polygonOffsetUnits:-1,relativeToGround:!0,hideInLayerSwitcher:!0}),this._groundPointersLayer=new _t("ground-pointers",{entities:[],pickingEnabled:!0,hideInLayerSwitcher:!0,scaleByDistance:[1,5e3,.02],pickingScale:1.5}),this._headPointersLayer=new _t("head-pointers",{entities:[],pickingEnabled:!0,hideInLayerSwitcher:!0,scaleByDistance:[1,1e4,.02],pickingScale:1}),this._columnPointersLayer=new _t("column-pointers",{entities:[],pickingEnabled:!1,hideInLayerSwitcher:!0}),this._trackEntity=new G({polyline:{path3v:[],thickness:3.8,color:"rgba(0,305,0,0.8)",isClosed:!1}}),this._trackLayer=new _t("column-pointers",{entities:[this._trackEntity],pickingEnabled:!1,hideInLayerSwitcher:!0}),this._heightsLayer=new _t("heights-labels",{entities:[],pickingEnabled:!1,hideInLayerSwitcher:!0}),this._pointerHeadEntity=new G({cartesian:new v,billboard:Ql}),this._pointerLabelEntity=new G({cartesian:new v,label:Jl}),this._pointerRayEntity=new G({cartesian:new v,ray:Kl}),this._pointerLayer=new _t("pointer",{entities:[this._pointerHeadEntity,this._pointerLabelEntity,this._pointerRayEntity],pickingEnabled:!1,hideInLayerSwitcher:!0})}flyExtent(){let t=this._headPointersLayer.getEntities(),s=180,n=180,o=-180,a=-180,l=-1e6;if(t.length>1){for(let c=0;c<t.length;c++){let d=t[c].getLonLat();d.lon<s&&(s=d.lon),d.lat<n&&(n=d.lat),d.lon>o&&(o=d.lon),d.lat>a&&(a=d.lat),d.height>l&&(l=d.height)}this._planet.camera.flyExtent(new U(new L(s,n),new L(o,a)),l,{amplitude:0})}}get planet(){return this._planet}_createGroundPointer(t,s=10){let n=this.ellipsoid.getSurfaceNormal3v(t),o=t.add(n.scale(s)),a=new G({ray:{startPosition:t,endPosition:o,startColor:"rgba(255,255,255,0.2)",endColor:"rgba(355,355,355,1.0)",thickness:3.2}}),l=new G({cartesian:t,geoObject:th}),c=new G({cartesian:o,geoObject:eh,properties:{}}),d=new G({cartesian:o,label:Yn});d.appendChild(new G({cartesian:o,label:{...Yn,offset:[-47,45,0]}}));const u=this._groundPointersLayer.getEntities().length;return a.properties=l.properties=c.properties={index:u,altitude:s,lonLatEll:new L,headEntity:c,groundEntity:l,columnEntity:a,heightLabelEntity:d},{headEntity:c,groundEntity:l,columnEntity:a,heightLabelEntity:d}}setPointerCartesian3v(t,s){this._pointerLabelEntity.setCartesian3v(t),this._pointerLabelEntity.label.setText(`${Math.round(s).toString()} m`),this._pointerRayEntity.ray.setEndPosition3v(t);let n=this._planet.ellipsoid.getSurfaceNormal3v(t);this._pointerRayEntity.ray.setStartPosition3v(t.add(n.scale(-s))),this._pointerHeadEntity.setCartesian3v(t)}bindPlanet(t){this._planet=t}init(){this._activate()}onremove(){this._deactivate()}_activate(){this._planet.addLayer(this._trackLayer),this._planet.addLayer(this._groundPointersLayer),this._planet.addLayer(this._columnPointersLayer),this._planet.addLayer(this._headPointersLayer),this._planet.addLayer(this._heightsLayer),this._planet.addLayer(this._pointerLayer),this.renderer.events.on("ldblclick",this._onLClick),this.renderer.events.on("mousemove",this._onMouseMove),this.renderer.events.on("lup",this._onLUp),this._groundPointersLayer.events.on("mouseenter",this._onGroundPointerEnter),this._groundPointersLayer.events.on("mouseleave",this._onGroundPointerLeave),this._groundPointersLayer.events.on("ldown",this._onGroundPointerLDown),this._groundPointersLayer.events.on("lup",this._onGroundPointerLUp),this._headPointersLayer.events.on("mouseenter",this._onHeadPointerEnter),this._headPointersLayer.events.on("mouseleave",this._onHeadPointerLeave),this._headPointersLayer.events.on("ldown",this._onHeadPointerLDown),this._headPointersLayer.events.on("lup",this._onHeadPointerLUp),this.setPointerVisibility(!1)}getPointLonLat(t){let s=this._headPointersLayer.getEntities()[t];if(s)return s.getLonLat()}getPointsLonLat(){let t=this._headPointersLayer.getEntities(),s=new Array(t.length);for(let n=0,o=s.length;n<o;n++){let a=t[n];s[n]=a.getLonLat()}return s}getHeightMSL(t){return this._planet&&this._planet.terrain.geoid?this._planet.terrain.geoid.getHeightLonLat(t):0}getHeightELLAsync(t){return new Promise((s,n)=>{this._planet.terrain.getHeightAsync(t,o=>{if(this._planet){let a=this.getHeightMSL(t);s(o+a)}else n()})})}addPointLonLatArrayAsync(t,s=!1){if(!this._planet)throw new Error("Planet is not defined");let n=this._planet.ellipsoid;for(let a=0,l=t.length-1;a<l;a++){let c=n.lonLatToCartesian(t[a]),d=n.lonLatToCartesian(t[a+1]);if(c.distance(d)>1e5)throw new Error("Track is too long! 100 km is maximum.")}let o=new Array(t.length);for(let a=0,l=t.length;a<l;a++)o[a]=this.addPointLonLatAsync(t[a],!0);return Promise.all(o).then(()=>{s||this.events.dispatch(this.events.change,this)}),o}addPointLonLatAsync(t,s=!1){let n=this._planet.ellipsoid.lonLatToCartesian(t),o=this._planet.ellipsoid.getSurfaceNormal3v(n),a=new L(t.lon,t.lat),l=this._planet.ellipsoid.lonLatToCartesian(a),{headEntity:c,groundEntity:d,columnEntity:u,heightLabelEntity:_}=this._createGroundPointer(l);return this._groundPointersLayer.add(d),this._columnPointersLayer.add(u),this._headPointersLayer.add(c),this._heightsLayer.add(_),this._trackEntity.polyline.appendPoint3v(c.getCartesian()),d.properties.lonLatEll.lon=a.lon,d.properties.lonLatEll.lat=a.lat,d.properties.lonLatEll.height=a.height,new Promise(f=>{this.getHeightELLAsync(t).then(g=>{var m;d.properties.lonLatEll.height=g;let p,x=10;t.height===0?(p=n.add(o.scaleTo(g)),n=p.add(o.scaleTo(x))):(x=t.height-g,p=n.sub(o.scaleTo(x))),d.setCartesian3v(p),_.setCartesian3v(n),_.label.setText(`${g.toFixed(1)} m`),_.childEntities[0].label.setText(`${x.toFixed(1)} m`),c.properties.altitude=x,c.setCartesian3v(n),c.properties.columnEntity.ray.setStartPosition3v(p),c.properties.columnEntity.ray.setEndPosition3v(n),(m=this._trackEntity.polyline)==null||m.setPoint3v(n,c.properties.index),s||(this.events.dispatch(this.events.addpoint,c,this),this.events.dispatch(this.events.change,this)),f(c)})})}addGroundPointLonLatAsync(t,s=10,n=!1){let o=this._planet.ellipsoid.lonLatToCartesian(t);return this._addPoint(o,t,s,n)}addGroundPoint3vAsync(t,s=10,n=!1){let o=this._planet.ellipsoid.cartesianToLonLat(t);return this._addPoint(t,o,s,n)}_addPoint(t,s,n,o=!1){return new Promise((a,l)=>{let{headEntity:c,groundEntity:d,columnEntity:u,heightLabelEntity:_}=this._createGroundPointer(t,n);this._groundPointersLayer.add(d),this._columnPointersLayer.add(u),this._headPointersLayer.add(c),this._heightsLayer.add(_),this._trackEntity.polyline.appendPoint3v(c.getCartesian()),d.properties.lonLatEll.lon=s.lon,d.properties.lonLatEll.lat=s.lat,d.properties.lonLatEll.height=s.height,this.getHeightELLAsync(s).then(f=>{var g;d.properties.lonLatEll.height=s.height=f;let m=this._planet.ellipsoid.lonLatToCartesian(s),p=this._planet.ellipsoid.getSurfaceNormal3v(m),x=m.add(p.scale(n));_.setCartesian3v(x),_.label.setText(`${f.toFixed(1)} m`),_.childEntities[0].label.setText(`${n.toFixed(1)} m`),c.setCartesian3v(x),c.properties.columnEntity.ray.setEndPosition3v(x),(g=this._trackEntity.polyline)==null||g.setPoint3v(x,c.properties.index),o||(this.events.dispatch(this.events.addpoint,c,this),this.events.dispatch(this.events.change,this)),a(c)})})}setHeadPointCartesian3v(t,s){const n=this._headPointersLayer.getEntities()[t];if(n){let o=this._planet.ellipsoid.lonLatToCartesian(n.properties.lonLatEll),a=s.length()-o.length();a<=0&&(s=o,a=0),n.properties.altitude=a,n.setCartesian3v(s),n.properties.columnEntity.ray.setEndPosition3v(s),n.properties.heightLabelEntity.setCartesian3v(s),n.properties.heightLabelEntity.childEntities[0].label.setText(`${a.toFixed(1)} m`),this._trackEntity.polyline.setPoint3v(s,t),this.events.dispatch(this.events.change,this._pickedHeadEntity)}}setGroundPointCartesian3v(t,s){var n;let o=this._groundPointersLayer.getEntities()[t];if(o){let a=this._planet.ellipsoid.cartesianToLonLat(s);o.properties.lonLatEll.lon=a.lon,o.properties.lonLatEll.lat=a.lat,o.properties.lonLatEll.height=a.height;let l=this._planet.ellipsoid.getSurfaceNormal3v(s),c=o.properties.headEntity,d=o.properties.heightLabelEntity,u=o.properties.altitude;o.setCartesian3v(s);let _=s.add(l.scale(u));c.setCartesian3v(_),c.properties.columnEntity.ray.setStartPosition3v(s),c.properties.columnEntity.ray.setEndPosition3v(_),(n=this._trackEntity.polyline)==null||n.setPoint3v(_,c.properties.index),d.setCartesian3v(_),d.label.setText(`${a.height.toFixed(1)} m`),d.childEntities[0].label.setText(`${u.toFixed(1)} m`),this.events.dispatch(this.events.change,o.properties.headEntity)}}_deactivate(){this.renderer.events.off("ldblclick",this._onLClick),this.renderer.events.off("mousemove",this._onMouseMove),this.renderer.events.off("lup",this._onLUp),this._groundPointersLayer.events.off("mouseenter",this._onGroundPointerEnter),this._groundPointersLayer.events.off("mouseleave",this._onGroundPointerLeave),this._groundPointersLayer.events.off("ldown",this._onGroundPointerLDown),this._groundPointersLayer.events.off("lup",this._onGroundPointerLUp),this._headPointersLayer.events.off("mouseenter",this._onHeadPointerEnter),this._headPointersLayer.events.off("mouseleave",this._onHeadPointerLeave),this._headPointersLayer.events.off("ldown",this._onHeadPointerLDown),this._headPointersLayer.events.off("lup",this._onHeadPointerLUp),this._trackLayer.remove(),this._groundPointersLayer.remove(),this._headPointersLayer.remove(),this._columnPointersLayer.remove(),this._trackLayer.remove(),this._heightsLayer.remove(),this._pointerLayer.remove(),this.clear()}setPointerVisibility(t){this._pointerLayer.setVisibility(t)}setVisibility(t){this._groundPointersLayer.setVisibility(t),this._trackLayer.setVisibility(t),this._columnPointersLayer.setVisibility(t),this._headPointersLayer.setVisibility(t),this._trackLayer.setVisibility(t),this._heightsLayer.setVisibility(t),this._pointerLayer.setVisibility(t)}clear(){this._headPointersLayer.setEntities([]),this._groundPointersLayer.setEntities([]),this._columnPointersLayer.setEntities([]),this._heightsLayer.setEntities([]),this._trackEntity.polyline.setPath3v([])}frame(){if(this._clampToGround){let t=new v;const s=this._planet.quadTreeStrategy._renderedNodes,n=this._groundPointersLayer.getEntities();for(let o=0;o<n.length;o++){let a=n[o];for(let l=0;l<s.length;l++){let c=s[l];if(c.segment.isEntityInside(a)){c.segment.getEntityTerrainPoint(a,t),a.setCartesian3v(t),a.properties.columnEntity.ray.setStartPosition3v(t);break}}}}}get ellipsoid(){return this._planet?this._planet.ellipsoid:null}}const sh=["change","addpoint"],rh=["reset","list","location"];class nh extends ut{constructor(t={}){super({...t,template:'<div class="og-elevationprofile-buttons"></div>'}),this.events=this.events.registerNames(rh),this.pointListBtn=new dt({classList:["og-elevationprofile-button"],icon:'<?xml version="1.0" encoding="utf-8"?><svg width="800px" height="800px" viewBox="0 0 32 32" id="icon" xmlns="http://www.w3.org/2000/svg"><defs><style>.cls-1{fill:none;}</style></defs><title>list</title><rect x="10" y="6" width="18" height="2"/><rect x="10" y="24" width="18" height="2"/><rect x="10" y="15" width="18" height="2"/><rect x="4" y="15" width="2" height="2"/><rect x="4" y="6" width="2" height="2"/><rect x="4" y="24" width="2" height="2"/></svg>',title:"Point List"}),this.pointListBtn.events.on("change",s=>{this.events.dispatch(this.events.list,s)})}render(t){super.render(t);let s=new ce({classList:["og-elevationprofile-button"],icon:`<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<svg width="30" height="30" viewBox="0 0 30 30" version="1.1">
  <g transform="translate(0,-289.0625)">
    <path d="M 15 6 C 10.041282 6 6 10.04128 6 15 C 6 19.95872 10.041282 24 15 24 C 16.586491 24 18.07668 23.58246 19.373047 22.857422 L 17.888672 21.375 C 17.00816 21.772814 16.032235 22 15 22 C 11.122162 22 8 18.87784 8 15 C 8 11.12216 11.122162 8 15 8 C 18.877838 8 22 11.12216 22 15 L 19 15 L 23 20 L 27 15 L 24 15 C 24 10.04128 19.958718 6 15 6 z " transform="translate(0,289.0625)" />
  </g>
</svg>`,title:"Reset"});s.appendTo(this.el),s.events.on("click",()=>{this.model.clear(),this.events.dispatch(this.events.reset,this)}),this.pointListBtn.appendTo(this.el);let n=new ce({classList:["og-elevationprofile-button","og-elevationprofile-button__location"],icon:`<?xml version="1.0" encoding="utf-8"?>
<!-- Svg Vector Icons : http://www.onlinewebfonts.com/icon -->
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 256 256" enable-background="new 0 0 256 256" xml:space="preserve">
<metadata> Svg Vector Icons : http://www.onlinewebfonts.com/icon </metadata>
<g><g><path fill="#000000" d="M127,169.4c23.7,0,42.8-18.3,42.8-41s-19.2-41-42.8-41c-23.7,0-42.8,18.4-42.8,41S103.4,169.4,127,169.4z"/><path fill="#000000" d="M221.7,120.2c-3.8-44-40.9-78.9-87-82V15h-16.3v23.6c-44.8,4-80.3,38.5-84.1,81.7H10v15.6h24.3c3.8,43.1,39.3,77.4,84.1,81.7V241h16.3v-23.2c46-3.1,83.2-37.9,87-82H246v-15.6H221.7L221.7,120.2L221.7,120.2z M128,201.6c-42.5,0-76.7-33-76.7-73.4c0-40.4,34.5-73.4,76.7-73.4c42.5,0,76.7,33,76.7,73.4C204.7,168.5,170.5,201.6,128,201.6L128,201.6z"/></g></g>
</svg>`,title:"View bounds"});return n.appendTo(this.el),n.events.on("click",()=>{this.events.dispatch(this.events.location,this)}),this}}class oh extends Kt{constructor(t){super({title:"Points List",visible:!1,resizable:!0,useHide:!0,top:150,left:200,width:400,height:300,minHeight:100,minWidth:100,...t}),this._onApplyClick=()=>{try{this.model.clear();let s=JSON.parse(this.$textarea.value),n=new Array(s.length);for(let o=0;o<s.length;o++){let a=s[o];n[o]=new L(a[0],a[1],a[2])}this.model.addPointLonLatArrayAsync(n)}catch(s){console.error(s)}},this.$textarea=null}render(t){super.render(t);let s=new ut({template:`<div class="og-elevationprofile-list">
        <textarea placeholder="[[lon, lat, height], [lon, lat, height], ..., [lon, lat, height]]"></textarea>
        <div class="og-elevationprofile-list-buttons"></div>
    </div>`});s.appendTo(this.container);let n=new ce({classList:["og-elevationprofile-list-apply"],icon:"Apply"});return n.appendTo(s.select(".og-elevationprofile-list-buttons")),n.events.on("click",this._onApplyClick),this.$textarea=s.select("textarea"),this}}class ah extends ut{constructor(t={}){super({...t,template:`<div class="og-elevationprofile-legend">
        <div class="og-elevationprofile-legend__row og-elevationprofile-legend__track">
          <div class="og-elevationprofile-square"></div>
          <div class="og-elevationprofile-value">0</div>
          <div class="og-elevationprofile-units">m</div>
        </div>
        <div class="og-elevationprofile-legend__row og-elevationprofile-legend__ground">
          <div class="og-elevationprofile-square"></div>
          <div class="og-elevationprofile-value">0</div>
          <div class="og-elevationprofile-units">m</div>
        </div>
        <div class="og-elevationprofile-legend__row og-elevationprofile-legend__warning">        
          <div class="og-elevationprofile-square"></div>
          <div class="og-elevationprofile-value">0</div>
          <div class="og-elevationprofile-units">m</div>
        </div>
        <div class="og-elevationprofile-legend__row og-elevationprofile-legend__collision">
          <div class="og-elevationprofile-square"></div>
          <div class="og-elevationprofile-value">0</div>
          <div class="og-elevationprofile-units">m</div>
        </div>
      </div>`}),this.$groundValue=null,this.$trackValue=null,this.$warningValue=null,this.$collisionValue=null,this.$trackUnits=null,this.$groundUnits=null,this.$warningUnits=null,this.$collisionUnits=null}render(t){return super.render(t),this.$trackValue=this.select(".og-elevationprofile-legend__track .og-elevationprofile-value"),this.$groundValue=this.select(".og-elevationprofile-legend__ground .og-elevationprofile-value"),this.$warningValue=this.select(".og-elevationprofile-legend__warning .og-elevationprofile-value"),this.$collisionValue=this.select(".og-elevationprofile-legend__collision .og-elevationprofile-value"),this.$trackUnits=this.select(".og-elevationprofile-legend__track .og-elevationprofile-units"),this.$groundUnits=this.select(".og-elevationprofile-legend__ground .og-elevationprofile-units"),this.$warningUnits=this.select(".og-elevationprofile-legend__warning .og-elevationprofile-units"),this.$collisionUnits=this.select(".og-elevationprofile-legend__collision .og-elevationprofile-units"),this}clear(){this.$trackValue&&(this.$trackValue.innerText="0"),this.$trackUnits&&(this.$trackUnits.innerText="m"),this.$groundValue&&(this.$groundValue.innerText="0"),this.$groundUnits&&(this.$groundUnits.innerText="m"),this.$warningValue&&(this.$warningValue.innerText="0"),this.$warningUnits&&(this.$warningUnits.innerText="m"),this.$collisionValue&&(this.$collisionValue.innerText="0"),this.$collisionUnits&&(this.$collisionUnits.innerText="m")}setTrackLength(t){let s=Ge(t);this.$trackValue.innerText=s[0],this.$trackUnits.innerText=s[1]}setGroundLength(t){let s=Ge(t);this.$groundValue.innerText=s[0],this.$groundUnits.innerText=s[1]}setWarningLength(t){let s=Ge(t);this.$warningValue.innerText=s[0],this.$warningUnits.innerText=s[1]}setCollisionLength(t){let s=Ge(t);this.$collisionValue.innerText=s[0],this.$collisionUnits.innerText=s[1]}}const Xe="rgb(253,77,77)",nn="rgb(248,115,115)",as="rgb(73,73,239)",on="rgb(90,90,253)",ls="rgb(26,122,26)",an="rgb(55,191,55)",Wn="rgba(255,255,255,0.8)",Wi=.1,ya=new v(Wi,Wi,Wi),xa=.17,$n=.0095,lh=$.createCylinder($n,$n,.83).scale(ya),hh=$.createCylinder(0,.04,xa,16,16,!1,!0,0,-.17).scale(ya);class Ks extends G{constructor(t={}){super({independentPicking:!0,yaw:t.yaw||0,pitch:t.pitch||0,roll:t.roll||0,forceGlobalPosition:!0,geoObject:{color:t.color||Xe,scale:1,tag:"line",object3d:lh},properties:t.properties}),this._size=t.size!=null?t.size:1,this.appendChild(new G({yaw:t.yaw||0,pitch:t.pitch||0,roll:t.roll||0,forceGlobalPosition:!0,geoObject:{color:t.color||Xe,scale:1,tag:"tip",object3d:hh},properties:t.properties}))}setSize(t){this._size=t;const s=new v(1,(this._size-xa)/.83,1),n=new v(0,this._size*Wi,0);let o=this.childEntities[0];this.setScale3v(s),o.geoObject.setTranslate3v(n)}setColorHTML(t){let s=this.childEntities[0];this.geoObject.setColorHTML(t),s.geoObject.setColorHTML(t)}}class ch extends G{constructor(t={}){super(t),this._size=t.size!=null?t.size:1,this.childEntities=[],this._init()}_init(){let t=new Ks({color:Xe,yaw:0,pitch:0,roll:90*j,properties:{opName:"move_x",noEdit:!0,style:{color:Xe,selectColor:nn}}}),s=new Ks({color:as,yaw:0,pitch:0,roll:0,properties:{opName:"move_y",noEdit:!0,style:{color:as,selectColor:on}}}),n=new Ks({color:ls,yaw:0,pitch:90*j,roll:0,properties:{opName:"move_z",noEdit:!0,style:{color:ls,selectColor:an}}});this.appendChild(t),this.appendChild(s),this.appendChild(n),this.setSize(this._size)}setSize(t){this.childEntities[0].setSize(t),this.childEntities[1].setSize(t),this.childEntities[2].setSize(t)}setPitch(t){let s=this.childEntities[0],n=s.childEntities[0];s.setPitch(t),n.setPitch(t),s=this.childEntities[1],n=s.childEntities[0],s.setPitch(t),n.setPitch(t),s=this.childEntities[2],n=s.childEntities[0],s.setPitch(t+90),n.setPitch(t+90)}setYaw(t){let s=this.childEntities[0],n=s.childEntities[0];s.setYaw(t),n.setYaw(t),s=this.childEntities[1],n=s.childEntities[0],s.setYaw(t),n.setYaw(t),s=this.childEntities[2],n=s.childEntities[0],s.setYaw(t),n.setYaw(t)}setRoll(t){let s=this.childEntities[0],n=s.childEntities[0];s.setRoll(t+90),n.setRoll(t+90),s=this.childEntities[1],n=s.childEntities[0],s.setRoll(t),n.setRoll(t)}getY(){return this.childEntities[1].getAbsoluteRotation().mulVec3(v.UP).normalize()}}const dh=$.createPlane(1,1,-.5,0,.5);class uh extends G{constructor(t={}){super(t),this._init()}_init(){let t=new G({independentPicking:!0,scale:.025,forceGlobalPosition:!0,geoObject:{color:Wn,tag:"plane",object3d:dh},properties:{opName:"move_xz",noEdit:!0,style:{color:Wn,selectColor:"rgba(255,255,255,1.0)"}}});this.appendChild(t)}}const Li=360,Qs=.95,Xn=new Array(Li),Zn=new Array(Li),Kn=new Array(Li);class _h extends G{constructor(t={}){super(t),this._init()}_init(){const t=Li;let s=new G({independentPicking:!0,polyline:{path3v:[Array.from({length:t},(a,l)=>new v)],thickness:3.1,color:Xe,isClosed:!0},properties:{opName:"rotate_pitch",noEdit:!0,style:{color:Xe,selectColor:nn}}}),n=new G({independentPicking:!0,polyline:{path3v:[Array.from({length:t},(a,l)=>new v)],thickness:2.5,color:as,isClosed:!0},properties:{opName:"rotate_yaw",noEdit:!0,style:{color:as,selectColor:on}}}),o=new G({independentPicking:!0,polyline:{path3v:[Array.from({length:t},(a,l)=>new v)],thickness:2.5,color:ls,isClosed:!0},properties:{opName:"rotate_roll",noEdit:!0,style:{color:ls,selectColor:an}}});this.appendChild(s),this.appendChild(n),this.appendChild(o)}setCartesian3v(t,s=0){if(super.setCartesian3v(t),this._entityCollection&&this._entityCollection.renderNode){let n=this._entityCollection.renderNode,o=n.renderer.activeCamera,a=n.getFrameRotation(t).conjugate(),l=.15*o.eye.distance(t),c=F.xRotation(0),d=F.yRotation(s),u=F.zRotation(0).mul(c).mul(d).mul(n.getFrameRotation(t)).conjugate();for(let m=0,p=0,x=1;m<Li;m+=x,p++){let y=m*j,w=Math.cos(y),C=Math.sin(y),T=u.mulVec3(new v(0,C,w)).normalize().scale(l).add(t),P=a.mulVec3(new v(w,0,C)).normalize().scale(l).add(t),E=u.mulVec3(new v(w,C,0)).normalize().scale(l).add(t);Xn[p]=T,Zn[p]=P,Kn[p]=E}this.childEntities[0].polyline.setPath3v([Xn],void 0,!0),this.childEntities[1].polyline.setPath3v([Zn],void 0,!0),this.childEntities[2].polyline.setPath3v([Kn],void 0,!0);let _=u.mulVec3(new v(1,0,0)).normalize(),f=a.mulVec3(new v(0,1,0)).normalize(),g=u.mulVec3(new v(0,0,1)).normalize();this.childEntities[0].polyline.setVisibleSphere(t,Math.abs(_.dot(o.getForward()))>Qs?0:l),this.childEntities[1].polyline.setVisibleSphere(t,Math.abs(f.dot(o.getForward()))>Qs?0:l),this.childEntities[2].polyline.setVisibleSphere(t,Math.abs(g.dot(o.getForward()))>Qs?0:l)}}}class fh extends G{constructor(t={}){super({...t,forceGlobalPosition:!0}),this._init()}_init(){let t=[],s=[],n=[],o=ve(nn),a=ve(on),l=ve(an);for(let _=0;_<20;_++){let f=1;if(_<5){let g=_/5;f=.5*(1-Math.cos(Math.PI*g))}else if(_>15){let g=(_-15)/5;f=1-.5*(1-Math.cos(Math.PI*g))}s.push([l[0],l[1],l[2],f]),t.push([o[0],o[1],o[2],f]),n.push([a[0],a[1],a[2],f])}let c=new G({polyline:{path3v:[Array.from({length:20},(_,f)=>new v)],thickness:2.5,pathColors:[t],isClosed:!1}}),d=new G({polyline:{path3v:[Array.from({length:20},(_,f)=>new v)],thickness:2.5,pathColors:[n],isClosed:!1}}),u=new G({polyline:{path3v:[Array.from({length:20},(_,f)=>new v)],thickness:2.5,pathColors:[s],isClosed:!1}});this.appendChild(c),this.appendChild(d),this.appendChild(u)}setCartesian3v(t){if(super.setCartesian3v(t),this._entityCollection&&this._entityCollection.renderNode){let s=this._entityCollection.renderNode,n=.05*s.renderer.activeCamera.eye.distance(t);if(s.planet){let o=[],a=[],l=[],c=s.planet.ellipsoid.getSurfaceNormal3v(t),d=this._lonLat,u=10;for(let _=-10;_<u;_++)l.push(new L(d.lon,d.lat+_,d.height)),a.push(new L(d.lon+_,d.lat,d.height)),o.push(t.add(c.scaleTo(_*n)));this.childEntities[0].polyline.setPathLonLatFast([a]),this.childEntities[1].polyline.setPath3vFast([o]),this.childEntities[2].polyline.setPathLonLatFast([l])}else{let o=[],a=[],l=[],c=v.UNIT_Y,d=v.UNIT_X,u=v.UNIT_Z,_=10;for(let f=-10;f<_;f++)a.push(t.add(d.scaleTo(f*n))),l.push(t.add(c.scaleTo(f*n))),o.push(t.add(u.scaleTo(f*n)));this.childEntities[0].polyline.setPath3vFast([a]),this.childEntities[1].polyline.setPath3vFast([l]),this.childEntities[2].polyline.setPath3vFast([o])}}}}function Qn(h,t,s,n,o,a){let l=o.add(v.UP),c=o.add(h),d=new v;if(new V(t,s).hitPlaneRes(vt.fromPoints(o,l,c),d)===V.INSIDE){let u=v.proj_b_to_a(d,h);if(new V(t,n).hitPlaneRes(vt.fromPoints(o,l,c),d)===V.INSIDE){let _=v.proj_b_to_a(d,h).sub(u);a.copy(o.add(_))}}}class gh extends de{constructor(t={}){super(t.name||"GeoObjectEditorScene"),this._onAxisLayerMouseEnter=s=>{this.renderer.handler.canvas.style.cursor="pointer",s.pickingObject.setColorHTML(s.pickingObject.properties.style.selectColor)},this._onAxisLayerMouseLeave=s=>{this.renderer.handler.canvas.style.cursor="default",s.pickingObject.setColorHTML(s.pickingObject.properties.style.color)},this._onAxisLayerLUp=s=>{this._selectedMove=null,this._navActivate(),this._setAxisTrackVisibility(!1)},this._onAxisLayerLDown=s=>{this._clickPos=s.pos.clone(),this._selectedEntity&&(this._selectedEntityCart=this._selectedEntity.getAbsoluteCartesian(),this._setAxisTrackVisibility(!0)),this._selectedMove=s.pickingObject.properties.opName,this._navDeactivate()},this._onPlaneLayerMouseEnter=s=>{this.renderer.handler.canvas.style.cursor="pointer",s.pickingObject.geoObject.setColorHTML(s.pickingObject.properties.style.selectColor)},this._onPlaneLayerMouseLeave=s=>{this.renderer.handler.canvas.style.cursor="default",s.pickingObject.geoObject.setColorHTML(s.pickingObject.properties.style.color)},this._onPlaneLayerLUp=s=>{this._selectedMove=null,this._navActivate(),this._setAxisTrackVisibility(!1)},this._onPlaneLayerLDown=s=>{this._clickPos=s.pos.clone(),this._selectedEntity&&(this._selectedEntityCart=this._selectedEntity.getAbsoluteCartesian(),this._setAxisTrackVisibility(!0)),this._selectedMove=s.pickingObject.properties.opName,this._navDeactivate()},this._onRotateLayerMouseEnter=s=>{this.renderer.handler.canvas.style.cursor="pointer",s.pickingObject.polyline.setColorHTML(s.pickingObject.properties.style.selectColor)},this._onRotateLayerMouseLeave=s=>{this.renderer.handler.canvas.style.cursor="default",s.pickingObject.polyline.setColorHTML(s.pickingObject.properties.style.color)},this._onRotateLayerLUp=s=>{this._selectedMove=null,this._navActivate()},this._onRotateLayerLDown=s=>{this._clickPos=s.pos.clone(),this._selectedEntity&&(this._selectedEntityCart=this._selectedEntity.getAbsoluteCartesian(),this._selectedEntity&&(this._selectedEntityPitch=this._selectedEntity.getAbsolutePitch(),this._selectedEntityYaw=this._selectedEntity.getAbsoluteYaw(),this._selectedEntityRoll=this._selectedEntity.getAbsoluteRoll())),this._selectedMove=s.pickingObject.properties.opName,this._navDeactivate()},this._onMouseMove=s=>{this._selectedEntity&&this._selectedMove&&this._ops[this._selectedMove]&&this._ops[this._selectedMove](s)},this._onLclick=s=>{s.pickingObject&&s.pickingObject instanceof G&&this.select(s.pickingObject)},this._moveX=s=>{if(!this._selectedEntity)return;let n=this.renderer.activeCamera,o=this._selectedEntityCart,a=n.unproject(this._clickPos.x,this._clickPos.y),l=new v;if(this.planet){let c=new V(n.eye,a).hitSphere(new Ft(o.length(),new v)),d=new V(n.eye,s.direction).hitSphere(new Ft(o.length(),new v));if(!d)return;if(l=F.getRotationBetweenVectors(c.normal(),d.normal()).mulVec3(o),this.ellipsoid){let u=this.ellipsoid.cartesianToLonLat(o),_=this.ellipsoid.cartesianToLonLat(l);this.ellipsoid.lonLatToCartesianRes(new L(_.lon,u.lat,u.height),l)}}else Qn(v.UNIT_X,n.eye,a,s.direction,o,l);this._selectedEntity.setAbsoluteCartesian3v(l),this.events.dispatch(this.events.position,l,this._selectedEntity),this.events.dispatch(this.events.change,this._selectedEntity)},this._moveY=s=>{if(!this._selectedEntity)return;let n=this.renderer.activeCamera,o=this._selectedEntityCart,a=v.UP;this.planet&&(a=this._axisEntity.getY());let l=o.add(a),c=o.add(n.getRight()),d=new v,u=n.unproject(this._clickPos.x,this._clickPos.y);if(new V(n.eye,u).hitPlaneRes(vt.fromPoints(o,l,c),d)===V.INSIDE){let _=v.proj_b_to_a(d,a);if(new V(n.eye,s.direction).hitPlaneRes(vt.fromPoints(o,l,c),d)===V.INSIDE){let f=v.proj_b_to_a(d,a).sub(_),g=this._selectedEntityCart.add(f);this._selectedEntity.setAbsoluteCartesian3v(g),this.events.dispatch(this.events.position,d,this._selectedEntity),this.events.dispatch(this.events.change,this._selectedEntity)}}},this._moveZ=s=>{if(!this._selectedEntity)return;let n=this.renderer.activeCamera,o=this._selectedEntityCart,a=n.unproject(this._clickPos.x,this._clickPos.y),l=new v;if(this.planet){let c=new V(n.eye,a).hitSphere(new Ft(o.length(),new v)),d=new V(n.eye,s.direction).hitSphere(new Ft(o.length(),new v));if(!d)return;if(l=F.getRotationBetweenVectors(c.normal(),d.normal()).mulVec3(o),this.ellipsoid){let u=this.ellipsoid.cartesianToLonLat(o),_=this.ellipsoid.cartesianToLonLat(l);this.ellipsoid.lonLatToCartesianRes(new L(u.lon,_.lat,u.height),l)}}else Qn(v.UNIT_Z,n.eye,a,s.direction,o,l);this._selectedEntity.setAbsoluteCartesian3v(l),this.events.dispatch(this.events.position,l,this._selectedEntity),this.events.dispatch(this.events.change,this._selectedEntity)},this._moveXZ=s=>{if(!this._selectedEntity)return;let n=this.renderer.activeCamera,o=this._selectedEntityCart,a=n.unproject(this._clickPos.x,this._clickPos.y),l=new v;if(this.planet){let c=new V(n.eye,a).hitSphere(new Ft(o.length(),new v)),d=new V(n.eye,s.direction).hitSphere(new Ft(o.length(),new v));if(!d)return;if(l=F.getRotationBetweenVectors(c.normal(),d.normal()).mulVec3(o),this.ellipsoid){let u=this.ellipsoid.cartesianToLonLat(l),_=this._selectedEntity.getLonLat().height;this.ellipsoid.lonLatToCartesianRes(new L(u.lon,u.lat,_),l)}}else{let c=o.add(v.UNIT_X),d=o.add(v.UNIT_Z),u=new v,_=new v;if(new V(n.eye,a).hitPlaneRes(vt.fromPoints(o,c,d),u)===V.INSIDE&&new V(n.eye,s.direction).hitPlaneRes(vt.fromPoints(o,c,d),_)===V.INSIDE){let f=_.sub(u);l=o.add(f)}}this._selectedEntity.setAbsoluteCartesian3v(l),this.events.dispatch(this.events.position,l,this._selectedEntity),this.events.dispatch(this.events.change,this._selectedEntity)},this._moveXY=s=>{console.log("moveXY")},this._moveZY=s=>{console.log("moveZY")},this._rotatePitch=s=>{if(!this._selectedEntity)return;let n=this.renderer.activeCamera,o=this._selectedEntityCart,a=F.xRotation(0),l=F.yRotation(this._selectedEntity.getYaw()),c=F.zRotation(0).mul(a).mul(l).mul(this.getFrameRotation(o)).conjugate().mulVec3(new v(1,0,0)).normalize(),d=n.unproject(this._clickPos.x,this._clickPos.y),u=new vt(o,c),_=new v,f=new v;if(new V(n.eye,d).hitPlaneRes(u,_)===V.INSIDE&&new V(n.eye,s.direction).hitPlaneRes(u,f)===V.INSIDE){let g=_.sub(o).normalize(),m=f.sub(o).normalize(),p=Math.sign(g.cross(m).dot(c)),x=Math.acos(g.dot(m)),y=this._selectedEntityPitch+p*x;this._selectedEntity.setAbsolutePitch(y),this.events.dispatch(this.events.pitch,y,this._selectedEntity),this.events.dispatch(this.events.change,this._selectedEntity)}},this._rotateYaw=s=>{if(!this._selectedEntity)return;let n=this.renderer.activeCamera,o=this._selectedEntityCart,a=this.getFrameRotation(o).conjugate().mulVec3(new v(0,1,0)).normalize(),l=n.unproject(this._clickPos.x,this._clickPos.y),c=new vt(o,a),d=new v,u=new v;if(new V(n.eye,l).hitPlaneRes(c,d)===V.INSIDE&&new V(n.eye,s.direction).hitPlaneRes(c,u)===V.INSIDE){let _=d.sub(o).normalize(),f=u.sub(o).normalize(),g=Math.sign(f.cross(_).dot(a)),m=Math.acos(_.dot(f)),p=this._selectedEntityYaw+g*m;this._selectedEntity.setAbsoluteYaw(p),this.events.dispatch(this.events.yaw,p,this._selectedEntity),this.events.dispatch(this.events.change,this._selectedEntity)}},this._rotateRoll=s=>{if(!this._selectedEntity)return;let n=this.renderer.activeCamera,o=this._selectedEntityCart;this.getFrameRotation(o).conjugate();let a=F.xRotation(0),l=F.yRotation(this._selectedEntity.getYaw()),c=F.zRotation(0).mul(a).mul(l).mul(this.getFrameRotation(o)).conjugate().mulVec3(new v(0,0,1)).normalize(),d=n.unproject(this._clickPos.x,this._clickPos.y),u=new vt(o,c),_=new v,f=new v;if(new V(n.eye,d).hitPlaneRes(u,_)===V.INSIDE&&new V(n.eye,s.direction).hitPlaneRes(u,f)===V.INSIDE){let g=_.sub(o).normalize(),m=f.sub(o).normalize(),p=Math.sign(g.cross(m).dot(c)),x=Math.acos(g.dot(m)),y=this._selectedEntityRoll+p*x;this._selectedEntity.setAbsoluteRoll(y),this.events.dispatch(this.events.roll,y,this._selectedEntity),this.events.dispatch(this.events.change,this._selectedEntity)}},this._scale=s=>{this.events.dispatch(this.events.scale,1,this._selectedEntity),this.events.dispatch(this.events.change,this._selectedEntity)},this._scaleX=s=>{},this._scaleY=s=>{},this._scaleZ=s=>{},this.events=lt(ph),this._planet=t.planet||null,this._startPos=null,this._startClick=new H,this._axisEntity=new ch,this._planeEntity=new uh,this._rotateEntity=new _h,this._axisTrackEntity=new fh,this._moveLayer=new se({scaleByDistance:[.1,Ae,.1],useLighting:!1,pickingScale:[5,1.1,5],visibility:!1,depthOrder:1e3}),this._planeLayer=new se({scaleByDistance:[.1,Ae,.1],useLighting:!1,visibility:!1,depthOrder:1e3}),this._rotateLayer=new se({useLighting:!1,visibility:!1,depthOrder:1e3,pickingScale:5}),this._selectedEntity=null,this._clickPos=new H,this._selectedEntityCart=new v,this._selectedEntityPitch=0,this._selectedEntityYaw=0,this._selectedEntityRoll=0,this._selectedMove=null,this._axisTrackVisibility=!1,this._axisTrackLayer=new se({useLighting:!1,visibility:!1,pickingScale:5,pickingEnabled:!1,opacity:.6}),this._ops={move_x:this._moveX,move_y:this._moveY,move_z:this._moveZ,move_xz:this._moveXZ,move_xy:this._moveXY,move_zy:this._moveZY,rotate_pitch:this._rotatePitch,rotate_yaw:this._rotateYaw,rotate_roll:this._rotateRoll,scale:this._scale,scale_x:this._scaleX,scale_y:this._scaleY,scale_z:this._scaleZ}}get ellipsoid(){if(this._planet)return this._planet.ellipsoid}get planet(){return this._planet}bindPlanet(t){this._planet=t}init(){this.activate()}onremove(){this.deactivate()}_addAxisLayers(){this._moveLayer.addTo(this),this._planeLayer.addTo(this),this._rotateLayer.addTo(this),this._axisTrackLayer.addTo(this),this._moveLayer.add(this._axisEntity),this._moveLayer.events.on("mouseenter",this._onAxisLayerMouseEnter),this._moveLayer.events.on("mouseleave",this._onAxisLayerMouseLeave),this._moveLayer.events.on("lup",this._onAxisLayerLUp),this._moveLayer.events.on("ldown",this._onAxisLayerLDown),this._planeLayer.add(this._planeEntity),this._planeLayer.events.on("mouseenter",this._onPlaneLayerMouseEnter),this._planeLayer.events.on("mouseleave",this._onPlaneLayerMouseLeave),this._planeLayer.events.on("lup",this._onPlaneLayerLUp),this._planeLayer.events.on("ldown",this._onPlaneLayerLDown),this._rotateLayer.add(this._rotateEntity),this._rotateLayer.events.on("mouseenter",this._onRotateLayerMouseEnter),this._rotateLayer.events.on("mouseleave",this._onRotateLayerMouseLeave),this._rotateLayer.events.on("lup",this._onRotateLayerLUp),this._rotateLayer.events.on("ldown",this._onRotateLayerLDown),this._axisTrackLayer.add(this._axisTrackEntity)}_navActivate(){this.renderer&&(this.renderer.controls.navigation&&this.renderer.controls.navigation.activate(),this.renderer.controls.SimpleNavigation&&this.renderer.controls.SimpleNavigation.activate())}_navDeactivate(){this.renderer&&(this.renderer.controls.navigation&&this.renderer.controls.navigation.deactivate(),this.renderer.controls.SimpleNavigation&&this.renderer.controls.SimpleNavigation.deactivate())}_removeAxisLayers(){this._moveLayer.remove(),this._planeLayer.remove(),this._rotateLayer.remove()}activate(){this.renderer.events.on("lclick",this._onLclick),this.renderer.events.on("mousemove",this._onMouseMove),this._addAxisLayers()}deactivate(){this.renderer.events.off("lclick",this._onLclick),this.renderer.events.off("mousemove",this._onMouseMove),this._removeAxisLayers(),this.clear()}_setAxisTrackVisibility(t){t!==this._axisTrackVisibility&&(this._axisTrackVisibility=t,this._axisTrackLayer.setVisibility(t))}setVisibility(t){this._moveLayer.setVisibility(t),this._planeLayer.setVisibility(t),this._rotateLayer.setVisibility(t),this.unlockView()}readyToEdit(t){return!t.properties||!t.properties.noEdit}select(t){(!this._selectedEntity||this._selectedEntity&&!t.isEqual(this._selectedEntity))&&this.readyToEdit(t)&&(this._selectedEntity&&this.unselect(),this._selectedEntity=t,this.renderer&&this.renderer.setRelativeCenter(),this.setVisibility(!0),this.events.dispatch(this.events.select,this._selectedEntity))}unselect(){this.setVisibility(!1);let t=this._selectedEntity;this._selectedEntity=null,this.events.dispatch(this.events.unselect,t)}clear(){this.removeEntityCollection(this._moveLayer),this.removeEntityCollection(this._planeLayer),this.removeEntityCollection(this._rotateLayer)}frame(){if(this._selectedEntity){let t=this._selectedEntity.getAbsoluteCartesian();this._axisEntity.setCartesian3v(t),this._planeEntity.setCartesian3v(t),this._rotateEntity.setCartesian3v(t,this._selectedEntity.getAbsoluteYaw()),this._axisTrackEntity.setCartesian3v(t)}}getFrameRotation(t){return this._planet?this._planet.getFrameRotation(t):super.getFrameRotation(t)}getSelectedEntity(){return this._selectedEntity}lockView(){this.renderer&&this._selectedEntity&&this.renderer.controls.CameraLock.lockView(this._selectedEntity)}unlockView(){if(this.renderer&&this._selectedEntity){let t=this.renderer.controls.CameraLock;t&&t.unlockView()}}}const ph=["mousemove","mouseenter","mouseleave","lclick","rclick","mclick","ldblclick","rdblclick","mdblclick","lup","rup","mup","ldown","rdown","mdown","lhold","rhold","mhold","mousewheel","touchmove","touchstart","touchend","doubletouch","touchleave","touchenter","select","unselect","change","position","pitch","yaw","roll","scale"],mh=["change"];class yt extends ut{constructor(t={}){super({template:Dt(`<div class="og-input">
      <div class="og-input-label">{label}</div>
      <input type="{type}"/>
    </div>`,{label:t.label||"",type:t.type||"text"})}),this._onResize=()=>{},this._onMouseWheel=s=>{(s=s||window.event).preventDefault(),s.stopPropagation()},this._onMouseWheelFF=s=>{this._onMouseWheel(s)},this._onInput=s=>{(s=s||window.event).preventDefault(),s.stopPropagation(),this._setValue(s.target.value)},this.events=this.events.registerNames(mh),this._value=t.value||"",this._maxFixed=t.maxFixed!=null?t.maxFixed:-1,this.$label=null,this.$input=null}render(t){return super.render(t),this.$label=this.select(".og-input-label"),this.$label.innerHTML===""&&(this.$label.style.display="none"),this.$input=this.select("input"),this._initEvents(),this}set value(t){t!==this._value&&(this._value=typeof t=="number"?_r(t,this._maxFixed):t,this.$input&&(this.$input.value=this._value),this.events.dispatch(this.events.change,this._value,this))}_setValue(t){t!==this._value&&(this._value=typeof t=="number"?_r(t,this._maxFixed):t,this.events.dispatch(this.events.change,this._value,this))}get value(){return this._value}_initEvents(){this.el.addEventListener("mousewheel",this._onMouseWheel),this.el.addEventListener("wheel",this._onMouseWheelFF),this.$input.addEventListener("input",this._onInput)}_clearEvents(){this.el.removeEventListener("mousewheel",this._onMouseWheel),this.el.removeEventListener("wheel",this._onMouseWheelFF),this.$input.removeEventListener("input",this._onInput)}remove(){this._clearEvents(),super.remove()}set visibility(t){this.el&&(this.el.style.display=t?"":"none")}}const vh=["change"];class yh extends ut{constructor(t={}){super({template:Dt(`<div class="og-checkbox">
      <div class="og-input-label">{label}</div>
      <div class="og-checkbox-input">
        <input type="checkbox" {checked}/>
      </div>
    </div>`,{label:t.label||"",checked:t.checked?"checked":""})}),this._onResize=()=>{},this._onMouseWheel=s=>{(s=s||window.event).preventDefault(),s.stopPropagation()},this._onMouseWheelFF=s=>{this._onMouseWheel(s)},this._onClick=s=>{(s=s||window.event).stopPropagation(),this.checked=!this._checked},this._checked=t.checked||!1,this._disabled=t.disabled||!1,this.events=this.events.registerNames(vh),this.$label=null,this.$input=null}set disabled(t){this._disabled=t,this._updateDisabled()}_updateDisabled(){this.el&&(this._disabled?this.el.classList.add("og-input-disabled"):this.el.classList.remove("og-input-disabled"))}get disabled(){return this._disabled}render(t){return super.render(t),this.$label=this.select(".og-input-label"),this.$label.innerHTML===""&&(this.$label.style.display="none"),this.$input=this.select("input"),this.$input.checked=this._checked,this._updateDisabled(),this._initEvents(),this}set checked(t){t!==this._checked&&(this._checked=t,this.$input&&(this.$input.checked=this._checked),this.events.dispatch(this.events.change,this._checked,this))}get checked(){return this._checked}_initEvents(){this.el.addEventListener("mousewheel",this._onMouseWheel),this.el.addEventListener("wheel",this._onMouseWheelFF),this.$input.addEventListener("click",this._onClick)}_clearEvents(){this.el.removeEventListener("mousewheel",this._onMouseWheel),this.el.removeEventListener("wheel",this._onMouseWheelFF),this.$input.removeEventListener("click",this._onClick)}remove(){this._clearEvents(),super.remove()}set visibility(t){this.el&&(this.el.style.display=t?"":"none")}}class xh extends Kt{constructor(t){super({title:"GeoObject Properties",visible:!1,resizable:!0,useHide:!0,top:25,right:85,width:252,height:480,minHeight:100,minWidth:100,model:t.model}),this._onVisibility=s=>{this.model.setVisibility(s)},this._onSelect=s=>{this.show(),this._refresh(s)},this._onUnselect=s=>{this.hide()},this._onChangeRelativePosition=s=>{let n=this.model.getSelectedEntity();n&&(n.relativePosition=s,this._refresh(n))},this._onPosition=(s,n)=>{this._refresh(n)},this._onPitch=(s,n)=>{this._pitchView.stopPropagation(),this._pitchView.value=n.getPitch()*J,this._absolutePitchView.stopPropagation(),this._absolutePitchView.value=n.getAbsolutePitch()*J},this._onYaw=(s,n)=>{this._yawView.stopPropagation(),this._yawView.value=n.getYaw()*J,this._absoluteYawView.stopPropagation(),this._absoluteYawView.value=n.getAbsoluteYaw()*J},this._onRoll=(s,n)=>{this._rollView.stopPropagation(),this._rollView.value=n.getRoll()*J,this._absoluteRollView.stopPropagation(),this._absoluteRollView.value=n.getAbsoluteRoll()*J},this._onChangeLon=s=>{let n=this.model.getSelectedEntity();if(n){let o=n.getLonLat();n.setLonLat2(parseFloat(s),o.lat,o.height),this._refresh(n)}},this._onChangeLat=s=>{let n=this.model.getSelectedEntity();if(n){let o=n.getLonLat();n.setLonLat2(o.lon,parseFloat(s),o.height),this._refresh(n)}},this._onChangeHeight=s=>{let n=this.model.getSelectedEntity();if(n){let o=n.getLonLat();n.setLonLat2(o.lon,o.lat,parseFloat(s)),this._refresh(n)}},this._onChangeX=s=>{let n=this.model.getSelectedEntity();if(n){let o=n.getCartesian();n.setCartesian(parseFloat(s),o.y,o.z),this._refresh(n)}},this._onChangeY=s=>{let n=this.model.getSelectedEntity();if(n){let o=n.getCartesian();n.setCartesian(o.x,parseFloat(s),o.z),this._refresh(n)}},this._onChangeZ=s=>{let n=this.model.getSelectedEntity();if(n){let o=n.getCartesian();n.setCartesian(o.x,o.y,parseFloat(s)),this._refresh(n)}},this._onChangeAbsoluteX=s=>{let n=this.model.getSelectedEntity();if(n){let o=n.getAbsoluteCartesian();n.setAbsoluteCartesian(parseFloat(s),o.y,o.z),this._refresh(n)}},this._onChangeAbsoluteY=s=>{let n=this.model.getSelectedEntity();if(n){let o=n.getAbsoluteCartesian();n.setAbsoluteCartesian(o.x,parseFloat(s),o.z),this._refresh(n)}},this._onChangeAbsoluteZ=s=>{let n=this.model.getSelectedEntity();if(n){let o=n.getAbsoluteCartesian();n.setAbsoluteCartesian(o.x,o.y,parseFloat(s)),this._refresh(n)}},this._onChangePitch=s=>{let n=this.model.getSelectedEntity();n&&(n.setPitch(parseFloat(s)*j),this._refresh(n))},this._onChangeYaw=s=>{let n=this.model.getSelectedEntity();n&&(n.setYaw(parseFloat(s)*j),this._refresh(n))},this._onChangeRoll=s=>{let n=this.model.getSelectedEntity();n&&(n.setRoll(parseFloat(s)*j),this._refresh(n))},this._onChangeAbsolutePitch=s=>{let n=this.model.getSelectedEntity();n&&(n.setAbsolutePitch(parseFloat(s)*j),this._refresh(n))},this._onChangeAbsoluteYaw=s=>{let n=this.model.getSelectedEntity();n&&(n.setAbsoluteYaw(parseFloat(s)*j),this._refresh(n))},this._onChangeAbsoluteRoll=s=>{let n=this.model.getSelectedEntity();n&&(n.setAbsoluteRoll(parseFloat(s)*j),this._refresh(n))},this._onChangeScale=s=>{let n=this.model.getSelectedEntity();if(n){let o=parseFloat(s);n.setScale(o),this._scaleXView.stopPropagation(),this._scaleYView.stopPropagation(),this._scaleZView.stopPropagation(),this._scaleXView.value=o,this._scaleYView.value=o,this._scaleZView.value=o}},this._onChangeScaleX=s=>{let n=this.model.getSelectedEntity();if(n){let o=n.getScale();n.setScale3v(new v(parseFloat(s),o.y,o.z))}},this._onChangeScaleY=s=>{let n=this.model.getSelectedEntity();if(n){let o=n.getScale();n.setScale3v(new v(o.x,parseFloat(s),o.z))}},this._onChangeScaleZ=s=>{let n=this.model.getSelectedEntity();if(n){let o=n.getScale();n.setScale3v(new v(o.x,o.y,parseFloat(s)))}},this._onGround=()=>{let s=this.model.getSelectedEntity();s&&this.model.planet&&(this.model.planet.terrain?this.model.planet.terrain.getHeightAsync(s.getLonLat(),n=>{this._heightView.value=n}):this._heightView.value=0)},this._relativePositionView=new yh({label:"Relative position"}),this._lonView=new yt({label:"Lon",type:"number",min:-180,max:180,maxFixed:10}),this._latView=new yt({label:"Lat",type:"number",min:-90,max:90,maxFixed:10}),this._heightView=new yt({label:"Height",type:"number",maxFixed:4}),this._xView=new yt({label:"X",type:"number",maxFixed:10}),this._yView=new yt({label:"Y",type:"number"}),this._zView=new yt({label:"Z",type:"number"}),this._absXView=new yt({label:"Absolute X",type:"number",maxFixed:10}),this._absYView=new yt({label:"Absolute Y",type:"number"}),this._absZView=new yt({label:"Absolute Z",type:"number"}),this._pitchView=new yt({label:"Pitch",type:"number",maxFixed:2}),this._yawView=new yt({label:"Yaw",type:"number",maxFixed:2}),this._rollView=new yt({label:"Roll",type:"number",maxFixed:2}),this._absolutePitchView=new yt({label:"Absolute pitch",type:"number",maxFixed:2}),this._absoluteYawView=new yt({label:"Absolute yaw",type:"number",maxFixed:2}),this._absoluteRollView=new yt({label:"Absolute roll",type:"number",maxFixed:2}),this._scaleView=new yt({label:"Scale",type:"number",maxFixed:2}),this._scaleXView=new yt({label:"Scale X",type:"number",maxFixed:2}),this._scaleYView=new yt({label:"Scale Y",type:"number",maxFixed:2}),this._scaleZView=new yt({label:"Scale Z",type:"number",maxFixed:2}),this._groundBtn=new ce({text:"Ground",title:"Put on the ground",name:"ground",classList:["og-editor-ground_button"]})}render(t){var s;super.render(t),this._initSceneEvents();let n=document.createElement("div");n.classList.add("og-editor_toolbar"),(s=this.container)==null||s.appendChild(n);let o=new dt({classList:["og-editor_toolbar-button"],icon:`<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" id="filter-center-focus">
  <path d="M5 15H3v4c0 1.1.9 2 2 2h4v-2H5v-4zM5 5h4V3H5c-1.1 0-2 .9-2 2v4h2V5zm14-2h-4v2h4v4h2V5c0-1.1-.9-2-2-2zm0 16h-4v2h4c1.1 0 2-.9 2-2v-4h-2v4zM12 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
</svg>`,title:"Lock/Unlock camera view"});return o.appendTo(n),o.events.on("change",a=>{a?this.model.lockView():this.model.unlockView()}),this.events.on("visibility",a=>{a||(o.events.stopPropagation(),o.setActive(!1))}),this.events.on("visibility",this._onVisibility),this._relativePositionView.appendTo(this.container),this.model.planet&&(this._lonView.appendTo(this.container),this._latView.appendTo(this.container),this._heightView.appendTo(this.container)),this._xView.appendTo(this.container),this._yView.appendTo(this.container),this._zView.appendTo(this.container),this._absXView.appendTo(this.container),this._absYView.appendTo(this.container),this._absZView.appendTo(this.container),this._pitchView.appendTo(this.container),this._yawView.appendTo(this.container),this._rollView.appendTo(this.container),this._absolutePitchView.appendTo(this.container),this._absoluteYawView.appendTo(this.container),this._absoluteRollView.appendTo(this.container),this._scaleView.appendTo(this.container),this._scaleXView.appendTo(this.container),this._scaleYView.appendTo(this.container),this._scaleZView.appendTo(this.container),this.model.planet&&this._groundBtn.appendTo(this.container),this._relativePositionView.events.on("change",this._onChangeRelativePosition),this._lonView.events.on("change",this._onChangeLon),this._latView.events.on("change",this._onChangeLat),this._heightView.events.on("change",this._onChangeHeight),this._xView.events.on("change",this._onChangeX),this._yView.events.on("change",this._onChangeY),this._zView.events.on("change",this._onChangeZ),this._absXView.events.on("change",this._onChangeAbsoluteX),this._absYView.events.on("change",this._onChangeAbsoluteY),this._absZView.events.on("change",this._onChangeAbsoluteZ),this._pitchView.events.on("change",this._onChangePitch),this._yawView.events.on("change",this._onChangeYaw),this._rollView.events.on("change",this._onChangeRoll),this._absolutePitchView.events.on("change",this._onChangeAbsolutePitch),this._absoluteYawView.events.on("change",this._onChangeAbsoluteYaw),this._absoluteRollView.events.on("change",this._onChangeAbsoluteRoll),this._scaleView.events.on("change",this._onChangeScale),this._scaleXView.events.on("change",this._onChangeScaleX),this._scaleYView.events.on("change",this._onChangeScaleY),this._scaleZView.events.on("change",this._onChangeScaleZ),this._groundBtn.appendTo(this.container),this._groundBtn.events.on("click",this._onGround),this}remove(){super.remove(),this._clearSceneEvents()}_initSceneEvents(){this.model.events.on("select",this._onSelect),this.model.events.on("unselect",this._onUnselect),this.model.events.on("position",this._onPosition),this.model.events.on("pitch",this._onPitch),this.model.events.on("yaw",this._onYaw),this.model.events.on("roll",this._onRoll)}_clearSceneEvents(){this.model.events.off("select",this._onSelect),this.model.events.off("unselect",this._onUnselect),this.model.events.off("position",this._onPosition),this.model.events.off("pitch",this._onPitch),this.model.events.off("yaw",this._onYaw),this.model.events.off("roll",this._onRoll)}_refresh(t){t.parent?this._relativePositionView.disabled=!1:this._relativePositionView.disabled=!0,this._relativePositionView.checked=t.relativePosition;let s=t.getLonLat();this._lonView.stopPropagation(),this._latView.stopPropagation(),this._heightView.stopPropagation(),this._lonView.value=s.lon,this._latView.value=s.lat,this._heightView.value=s.height;let n=t.getCartesian();this._xView.stopPropagation(),this._yView.stopPropagation(),this._zView.stopPropagation(),this._xView.value=n.x,this._yView.value=n.y,this._zView.value=n.z,n=t.getAbsoluteCartesian(),this._absXView.stopPropagation(),this._absYView.stopPropagation(),this._absZView.stopPropagation(),this._absXView.value=n.x,this._absYView.value=n.y,this._absZView.value=n.z,this._pitchView.stopPropagation(),this._yawView.stopPropagation(),this._rollView.stopPropagation(),this._pitchView.value=t.getPitch()*J,this._yawView.value=t.getYaw()*J,this._rollView.value=t.getRoll()*J,this._absolutePitchView.stopPropagation(),this._absoluteYawView.stopPropagation(),this._absoluteRollView.stopPropagation(),this._absolutePitchView.value=t.getAbsolutePitch()*J,this._absoluteYawView.value=t.getAbsoluteYaw()*J,this._absoluteRollView.value=t.getAbsoluteRoll()*J,this._scaleView.stopPropagation();let o=t.getScale();o.x===o.y&&o.y===o.z?this._scaleView.value=o.x:this._scaleView.value=1,this._scaleXView.stopPropagation(),this._scaleYView.stopPropagation(),this._scaleZView.stopPropagation(),this._scaleXView.value=o.x,this._scaleYView.value=o.y,this._scaleZView.value=o.z}hide(){super.hide(),this.model.events.stopPropagation(),this.model.unselect()}}const bh=["lockview","unlockview"];class Jn extends Q{constructor(t={}){super(t),this._onLockViewDraw=()=>{this.renderer&&this._lockEntity&&(this._isFromTheBack||this.renderer.activeCamera.viewDistance(this._lockEntity.getAbsoluteCartesian(),this._lockDistance))},this._onMouseWheel=s=>{if(this.renderer&&this._lockEntity&&!this._isFromTheBack){let n=this.renderer.activeCamera.eye.distance(this._lockEntity.getAbsoluteCartesian());this._lockDistance-=.33*n*Math.sign(s.wheelDelta),this._lockDistance<.001&&(this._lockDistance=.001),this.renderer.activeCamera.viewDistance(this._lockEntity.getAbsoluteCartesian(),this._lockDistance)}},this._onMouseMove=s=>{if(this._lockEntity&&this.renderer&&(s.rightButtonDown||this.renderer.events.isKeyPressed(W.KEY_ALT))){let n=this._lockEntity.getAbsoluteCartesian(),o=this.renderer.activeCamera,a=.5/j;a>.007&&(a=.007),this.planet?o.rotateHorizontal(a*(s.x-s.prev_x),!1,n,n.isZero()?v.UP:n.normal()):o.rotateHorizontal(a*(s.x-s.prev_x),!1,n,v.UP),o.rotateVertical(a*(s.y-s.prev_y),n),this._viewDir=n.sub(o.eye).normalize()}},this.events=lt(bh),this._name="CameraLock",this.planet=t.planet||null,this._lockDistance=0,this._isFromTheBack=!1,this._lockEntity=null,this._viewDir=new v(0,0,0)}onactivate(){this.renderer}ondeactivate(){this.renderer&&this.unlockView()}oninit(){this.activate(),this.renderer}flyCartesian(t,s=120){if(!t.isZero()&&this.renderer)if(this.unlockView(),this.planet){let n=this.planet.camera;this.isVisibleDistance(t)&&n.flyDistance(t,s),n.eye.distance(t)<1e6?n.flyDistance(t,s):n.viewDistance(t,s)}else this.renderer.activeCamera.viewDistance(t,s)}lockView(t,s=!1){if(!this.renderer)return;this._lockDistance=this._getDistance(t,this._lockEntity),this._isFromTheBack=s,this._deactivateLockViewEvents(),this._lockEntity=t;let n=this.renderer.activeCamera;this.planet&&this.planet.camera.stopFlying(),n.viewDistance(t.getAbsoluteCartesian(),this._lockDistance),this._deactivateNav(),this._activateLockViewEvents(),this._viewDir=t.getAbsoluteCartesian().sub(n.eye).normalize(),this.events.dispatch(this.events.lockview,this._lockEntity,s)}_activateNav(){this.renderer&&this.renderer.controls.navigation&&this.renderer.controls.navigation.activate(),this.renderer&&this.renderer.controls.simpleNavigation&&this.renderer.controls.simpleNavigation.activate()}_deactivateNav(){this.renderer&&this.renderer.controls.navigation&&(this.renderer.controls.navigation.deactivate(),this.renderer.controls.navigation.stop()),this.renderer&&this.renderer.controls.simpleNavigation&&this.renderer.controls.simpleNavigation.deactivate()}unlockView(){this._lockEntity&&(this._deactivateLockViewEvents(),this._activateNav(),this.events.dispatch(this.events.unlockview,this._lockEntity),this._lockEntity=null)}_getCenterDist(){return this.renderer&&this.renderer.getDistanceFromPixel(this.renderer.handler.getCenter())||0}_getDistance(t,s){if(this.renderer){let n=t.getAbsoluteCartesian(),o=this.renderer.activeCamera,a=o.eye.distance(n);return s&&(a=o.eye.distance(s.getAbsoluteCartesian())),this.isVisibleDistance(n)?a:o.eye.distance(n)<1e6?this._getCenterDist():120}return 0}isVisibleDistance(t,s=0){if(this.planet){let n=this.planet.ellipsoid.equatorialSize,o=this.planet.camera.eye;return o.distance(t)<Math.sqrt(o.length2()-n*n)+s}return!0}get lockEntity(){return this._lockEntity}flyLonLat(t,s=120){if(this.planet){let n=this.planet.ellipsoid.lonLatToCartesian(t);this.flyCartesian(n,s)}}_activateLockViewEvents(){this.renderer&&(this.renderer.events.on("mousewheel",this._onMouseWheel),this.renderer.events.on("mousemove",this._onMouseMove),this.renderer.events.on("draw",this._onLockViewDraw))}_deactivateLockViewEvents(){this.renderer&&(this.renderer.events.off("mousewheel",this._onMouseWheel),this.renderer.events.off("mousemove",this._onMouseMove),this._lockEntity&&this.renderer.events.off("draw",this._onLockViewDraw))}}const wh=["click"];class Th extends ut{constructor(t){super({template:Dt(`<button class="og-object3d-collection__item">
        <div class="og-object3d-collection__item_name">{name}</div>
    </button>`,{name:t.model.name}),...t}),this.events=lt(wh)}render(t){var s;return super.render(t),(s=this.el)==null||s.addEventListener("click",n=>{this.events.dispatch(this.events.click,this.model,this,n)}),this}}const Ch=["select"];class Eh extends ut{constructor(t){super({template:'<div class="og-object3d-collection"></div>',model:t.model,...t}),this._onAdd=s=>{this._addItem(s)},this.events=lt(Ch),this._activeView=null}_addItem(t){let s=new Th({model:t});s.appendTo(this.el),s.events.on("click",n=>{var o,a;this._activeView&&((o=this._activeView.el)==null||o.classList.remove("active")),this._activeView=s,(a=this._activeView.el)==null||a.classList.add("active"),this.events.dispatch(this.events.select,n,s)})}render(t){super.render(t);let s=this.model.getItems();for(let n of s)this._addItem(n);return this._initEvents(),this}_initEvents(){this.model.events.on("add",this._onAdd)}}const Ah=["select"];class Lh extends Kt{constructor(t){super({classList:["og-object3d-manager"],title:"Object3D Collection",visible:!1,resizable:!0,useHide:!0,top:25,right:85,width:252,height:480,minHeight:100,minWidth:100}),this._onLoadClick=()=>{let s=new ut({initRender:!0,template:'<input type="file" accept=".obj,.mtl" multiple />'});s.el&&(s.el.addEventListener("change",n=>{const o=n.target;if(o.files){const a=Array.from(o.files),l=a.find(d=>d.name.toLowerCase().endsWith(".obj")),c=a.find(d=>d.name.toLowerCase().endsWith(".mtl"));l&&async function(d,u){return await $.readFileObj(d,u).then(_=>({name:d.name,objects:u?_:[$.merge(_)]}))}(l,c).then(this._addObject)}}),s.el.click())},this._addObject=s=>{this._object3dCollectionView.model.addItem(s)},this.events=lt(Ah),this._object3dCollectionView=new Eh({model:t.model})}render(t){var s;super.render(t);let n=document.createElement("div");n.classList.add("og-editor_toolbar"),(s=this.container)==null||s.appendChild(n);let o=new ce({classList:["og-editor_toolbar-button"],icon:'<svg class="svg-icon" style="vertical-align: middle;fill: currentColor;overflow: hidden;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"><path d="M426.666667 170.666667H170.666667c-47.146667 0-84.906667 38.186667-84.906667 85.333333L85.333333 768c0 47.146667 38.186667 85.333333 85.333334 85.333333h682.666666c47.146667 0 85.333333-38.186667 85.333334-85.333333V341.333333c0-47.146667-38.186667-85.333333-85.333334-85.333333H512l-85.333333-85.333333z"  /></svg>',title:"Load 3D object"});return o.appendTo(n),o.events.on("click",this._onLoadClick),this._object3dCollectionView.appendTo(this.container),this._object3dCollectionView.events.on("select",a=>{this.events.dispatch(this.events.select,a)}),this}}const Ph=["add","remove"];class ln{constructor(t={}){this.events=lt(Ph,this),this._items=ln.createItemsMap(t.collection||[])}static createItemsMap(t){let s=new Map;for(let n=0;n<t.length;n++)s.set(t[n].name,t[n]);return s}getItem(t){return this._items.get(t)}addItem(t,s=!1){this._items.has(t.name)&&!s||(this._items.set(t.name,t),this.events.dispatch(this.events.add,t))}getItems(){return Array.from(this._items,([t,s])=>s)}}class Fr extends Q{constructor(t={}){super({name:"CameraFrameComposer",autoActivate:!0,...t}),this._onPostdraw=()=>{for(let s=0,n=this._frameHandlers.length;s<n;s++)this._frameHandlers[s].frame()},this._cameraLayer=new se({scaleByDistance:[100,1e6,1],pickingEnabled:!1}),this._cameraScene=new de("CameraScene"),this._frameHandlers=t.frameHandlers||[]}get frameHandlers(){return[...this._frameHandlers]}add(t){t.addTo(this),this._cameraLayer.add(t.cameraEntity)}oninit(){super.oninit(),this._cameraLayer.addTo(this._cameraScene)}activate(){super.activate(),this.renderer&&(this.renderer.events.on("postdraw",this._onPostdraw),this.renderer.addNode(this._cameraScene))}deactivate(){super.deactivate(),this.renderer&&(this.renderer.events.off("postdraw",this._onPostdraw),this.renderer.removeNode(this._cameraScene))}}let Sh=$.createFrustum();class to{constructor(t){this.camera=t.camera,this.frameBuffer=t.frameBuffer,this.frameHandler=t.frameHandler||null,this._composer=null,this._composerIndex=-1,this.showFrustum=t.showFrustum==null||t.showFrustum,this.cameraEntity=new G({visibility:!0,scale:this.frustumScale,geoObject:{tag:"frustum",color:"rgba(0,255,0,0.20)",object3d:Sh}}),this.frameBuffer.init()}get frustumScale(){return $.getFrustumScaleByCameraAspectRatio(1e3,this.camera.getViewAngle(),this.camera.getAspectRatio())}addTo(t){this._composer||(this._composer=t,this._composerIndex=t.frameHandlers.length,this._composer._frameHandlers.push(this))}remove(){this._composer&&(this._composer._frameHandlers.splice(this._composerIndex,1),this._composer=null,this._composerIndex=-1)}frame(){if(this.frameHandler&&this.frameBuffer.handler.gl&&(this.frameHandler(this),this.showFrustum)){let t=this.camera,s=$.getFrustumScaleByCameraAngles(100,t.horizontalViewAngle,t.verticalViewAngle);this.cameraEntity.setScale3v(s),this.cameraEntity.setCartesian3v(t.eye),this.cameraEntity.setAbsolutePitch(t.getAbsolutePitch()),this.cameraEntity.setAbsoluteYaw(t.getAbsoluteYaw()),this.cameraEntity.setAbsoluteRoll(t.getAbsoluteRoll())}}}function Oe(h){let t=1/Math.sqrt(h[0]*h[0]+h[1]*h[1]+h[2]*h[2]);h[0]*=t,h[1]*=t,h[2]*=t,h[3]*=t}class eo{constructor(t={}){this._pickingColorU=new Float32Array([0,0,0]),this._f=[[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0]],this.projectionMatrix=new tt,this.inverseProjectionMatrix=new tt,this.projectionViewMatrix=new tt,this.projectionViewRTEMatrix=new tt,this.inverseProjectionViewMatrix=new tt,this.left=0,this.right=0,this.bottom=0,this.top=0,this.near=0,this.far=0,this.cameraFrustumIndex=t.cameraFrustumIndex!=null?t.cameraFrustumIndex:-1,this.setProjectionMatrix(t.fov||30,t.aspect||1,t.near||1,t.far||1e3)}getRightPlane(){return this._f[0]}getLeftPlane(){return this._f[1]}getBottomPlane(){return this._f[2]}getTopPlane(){return this._f[3]}getBackwardPlane(){return this._f[4]}getForwardPlane(){return this._f[5]}getProjectionViewMatrix(){return this.projectionViewMatrix._m}getProjectionViewRTEMatrix(){return this.projectionViewRTEMatrix._m}getProjectionMatrix(){return this.projectionMatrix._m}getInverseProjectionMatrix(){return this.inverseProjectionMatrix._m}setProjectionMatrix(t,s,n,o,a,l=10){if(a){let c=l*Math.tan(t*Qt),d=c*s;this._setFrustumParams(c,d,n,o),this.projectionMatrix.setOrthographic(this.left,this.right,this.bottom,this.top,this.near,this.far)}else{let c=n*Math.tan(t*Qt),d=c*s;this._setFrustumParams(c,d,n,o),this.projectionMatrix.setPerspective(this.left,this.right,this.bottom,this.top,this.near,this.far)}this.projectionMatrix.inverseTo(this.inverseProjectionMatrix)}_setFrustumParams(t,s,n,o){this.top=t,this.right=s,this.bottom=-this.top,this.left=-this.right,this.near=n,this.far=o}setProjectionViewRTEMatrix(t){this.projectionViewRTEMatrix=this.projectionMatrix.mul(t)}setViewMatrix(t){this.projectionViewMatrix=this.projectionMatrix.mul(t),this.projectionViewMatrix.inverseTo(this.inverseProjectionViewMatrix);let s=this.projectionViewMatrix._m;this._f[0][0]=s[3]-s[0],this._f[0][1]=s[7]-s[4],this._f[0][2]=s[11]-s[8],this._f[0][3]=s[15]-s[12],Oe(this._f[0]),this._f[1][0]=s[3]+s[0],this._f[1][1]=s[7]+s[4],this._f[1][2]=s[11]+s[8],this._f[1][3]=s[15]+s[12],Oe(this._f[1]),this._f[2][0]=s[3]+s[1],this._f[2][1]=s[7]+s[5],this._f[2][2]=s[11]+s[9],this._f[2][3]=s[15]+s[13],Oe(this._f[2]),this._f[3][0]=s[3]-s[1],this._f[3][1]=s[7]-s[5],this._f[3][2]=s[11]-s[9],this._f[3][3]=s[15]-s[13],Oe(this._f[3]),this._f[4][0]=s[3]-s[2],this._f[4][1]=s[7]-s[6],this._f[4][2]=s[11]-s[10],this._f[4][3]=s[15]-s[14],Oe(this._f[4]),this._f[5][0]=s[3]+s[2],this._f[5][1]=s[7]+s[6],this._f[5][2]=s[11]+s[10],this._f[5][3]=s[15]+s[14],Oe(this._f[5])}containsPoint(t){for(let s=0;s<6;s++)if(t.dotArr(this._f[s])+this._f[s][3]<=0)return!1;return!0}containsSphereBottomExc(t){let s=-t.radius,n=this._f;return!(t.center.dotArr(n[0])+n[0][3]<=s||t.center.dotArr(n[1])+n[1][3]<=s||t.center.dotArr(n[3])+n[3][3]<=s||t.center.dotArr(n[4])+n[4][3]<=s||t.center.dotArr(n[5])+n[5][3]<=s)}containsSphereButtom(t){let s=-t.radius,n=this._f;return!(t.center.dotArr(n[2])+n[2][3]<=s)}containsSphere(t){let s=-t.radius,n=this._f;return!(t.center.dotArr(n[0])+n[0][3]<=s||t.center.dotArr(n[1])+n[1][3]<=s||t.center.dotArr(n[2])+n[2][3]<=s||t.center.dotArr(n[3])+n[3][3]<=s||t.center.dotArr(n[4])+n[4][3]<=s||t.center.dotArr(n[5])+n[5][3]<=s)}containsSphere2(t,s){let n=-s;return!(t.dotArr(this._f[0])+this._f[0][3]<=n||t.dotArr(this._f[1])+this._f[1][3]<=n||t.dotArr(this._f[2])+this._f[2][3]<=n||t.dotArr(this._f[3])+this._f[3][3]<=n||t.dotArr(this._f[4])+this._f[4][3]<=n||t.dotArr(this._f[5])+this._f[5][3]<=n)}containsBox(t){let s,n,o=!0;for(let a=0;a<6;a++){s=0,n=0;for(let l=0;l<8&&(n===0||s===0);l++)t.vertices[l].dotArr(this._f[a])+this._f[a][3]<0?s++:n++;if(n===0)return!1;s>0&&(o=!0)}return o}}const K=class{};K.Linear=h=>h,K.QuadIn=h=>h*h,K.QuadOut=h=>1-(1-h)*(1-h),K.QuadInOut=h=>h<.5?2*h*h:1-Math.pow(-2*h+2,2)/2,K.CubicIn=h=>h*h*h,K.CubicOut=h=>1-Math.pow(1-h,3),K.CubicInOut=h=>h<.5?4*h*h*h:1-Math.pow(-2*h+2,3)/2,K.QuartIn=h=>h*h*h*h,K.QuartOut=h=>1-Math.pow(1-h,4),K.QuartInOut=h=>h<.5?8*h*h*h*h:1-Math.pow(-2*h+2,4)/2,K.QuintIn=h=>h*h*h*h*h,K.QuintOut=h=>1-Math.pow(1-h,5),K.QuintInOut=h=>h<.5?16*h*h*h*h*h:1-Math.pow(-2*h+2,5)/2,K.SineIn=h=>1-Math.cos(h*Math.PI/2),K.SineOut=h=>Math.sin(h*Math.PI/2),K.SineInOut=h=>-(Math.cos(Math.PI*h)-1)/2,K.ExpoIn=h=>h===0?0:Math.pow(2,10*h-10),K.ExpoOut=h=>h===1?1:1-Math.pow(2,-10*h),K.ExpoInOut=h=>h===0?0:h===1?1:h<.5?Math.pow(2,20*h-10)/2:(2-Math.pow(2,-20*h+10))/2,K.CircIn=h=>1-Math.sqrt(1-Math.pow(h,2)),K.CircOut=h=>Math.sqrt(1-Math.pow(h-1,2)),K.CircInOut=h=>h<.5?(1-Math.sqrt(1-Math.pow(2*h,2)))/2:(Math.sqrt(1-Math.pow(-2*h+2,2))+1)/2,K.BackIn=h=>2.70158*h*h*h-1.70158*h*h,K.BackOut=h=>1+2.70158*Math.pow(h-1,3)+1.70158*Math.pow(h-1,2),K.BackInOut=h=>{const t=2.5949095;return h<.5?Math.pow(2*h,2)*(7.189819*h-t)/2:(Math.pow(2*h-2,2)*((t+1)*(2*h-2)+t)+2)/2},K.ElasticIn=h=>{const t=2*Math.PI/3;return h===0?0:h===1?1:-Math.pow(2,10*h-10)*Math.sin((10*h-10.75)*t)},K.ElasticOut=h=>{const t=2*Math.PI/3;return h===0?0:h===1?1:Math.pow(2,-10*h)*Math.sin((10*h-.75)*t)+1},K.ElasticInOut=h=>{const t=2*Math.PI/4.5;return h===0?0:h===1?1:h<.5?-Math.pow(2,20*h-10)*Math.sin((20*h-11.125)*t)/2:Math.pow(2,-20*h+10)*Math.sin((20*h-11.125)*t)/2+1},K.BounceOut=h=>h<1/2.75?7.5625*h*h:h<2/2.75?7.5625*(h-=1.5/2.75)*h+.75:h<2.5/2.75?7.5625*(h-=2.25/2.75)*h+.9375:7.5625*(h-=2.625/2.75)*h+.984375,K.BounceIn=h=>1-K.BounceOut(1-h),K.BounceInOut=h=>h<.5?.5*(1-K.BounceOut(1-2*h)):.5*(K.BounceOut(2*h-1)+1);let Or=K;const Rh=["viewchange","moveend","flystart","flyend","flystop"],ba=Or.CubicInOut,Ss=class Cd{constructor(t={}){if(this.__id=Cd.__counter__++,this.events=lt(Rh,this),this._isOrthographic=t.isOrthographic??!1,this._focusDistance=t.focusDistance!=null?t.focusDistance:10,this._width=t.width||1,this._height=t.height||1,this.eye=t.eye||new v,this.eyeHigh=new Float32Array(3),this.eyeLow=new Float32Array(3),this._viewAngle=t.viewAngle||47,this._horizontalViewAngle=0,this._viewMatrix=new tt,this._viewMatrixRTE=new tt,this._normalMatrix=new Se,this._r=new v(1,0,0),this._u=new v(0,1,0),this._b=new v(0,0,1),this._f=this._b.negateTo(),this._pr=this._r.clone(),this._pu=this._u.clone(),this._pb=this._b.clone(),this._peye=this.eye.clone(),this.isMoving=!1,this._flight=null,this._completeCallback=null,this._frameCallback=null,this._flying=!1,this._tanViewAngle_hrad=0,this._tanViewAngle_hradOneByHeight=0,this.frustums=[],this.frustumColors=[],t.frustums)for(let s=0,n=t.frustums.length;s<n;s++){let o=t.frustums[s],a=new eo({fov:this._viewAngle,aspect:this.getAspectRatio(),near:o[0],far:o[1]});a.cameraFrustumIndex=this.frustums.length,this.frustums.push(a),this.frustumColors.push(a._pickingColorU[0],a._pickingColorU[1],a._pickingColorU[2])}else{let s=1,n=500,o=new eo({fov:this._viewAngle,aspect:this.getAspectRatio(),near:s,far:n});o.cameraFrustumIndex=this.frustums.length,this.frustums.push(o),this.frustumColors.push(o._pickingColorU[0],o._pickingColorU[1],o._pickingColorU[2])}this.FARTHEST_FRUSTUM_INDEX=this.frustums.length-1,this.currentFrustumIndex=0,this.frustumColorIndex=0,this.isFirstPass=!1,this._projSizeConst=0,this.set(t.eye||new v(0,0,1),t.look||new v,t.up||new v(0,1,0))}get isOrthographic(){return this._isOrthographic}set isOrthographic(t){this._isOrthographic!==t&&(this._isOrthographic=t,this.refresh())}get focusDistance(){return this._focusDistance}set focusDistance(t){t!==this._focusDistance&&(this._focusDistance=t,this._isOrthographic&&this.refresh())}get id(){return this.__id}flyCartesian(t,s={}){this.stopFlying(),s.look=s.look||v.ZERO,s.up=s.up||v.UP,s.duration=s.duration||800;const n=s.ease||ba;this._completeCallback=s.completeCallback||(()=>{}),this._frameCallback=s.frameCallback||(()=>{}),s.startCallback&&s.startCallback.call(this);let o=this.eye.clone(),a=this._u,l=this._b,c=s.up,d=t.clone(),u=v.sub(t,s.look),_=c.cross(u);u.normalize(),_.normalize();let f=u.cross(_);this._flight={fly:g=>{let m=1-n(g),p=o.smerp(d,m),x=a.smerp(f,m),y=v.add(p,l.smerp(u,m).negateTo()),w=new v(p.x-y.x,p.y-y.y,p.z-y.z),C=x.cross(w);w.normalize(),C.normalize();let T=w.cross(C);return{eye:p,n:w,u:C,v:T}},duration:s.duration,startedAt:Date.now()},this._flying=!0,this.events.dispatch(this.events.flystart,this)}stopFlying(){this._flying&&(this._flying=!1,this._flight=null,this._frameCallback=null,this.events.dispatch(this.events.flystop,this))}checkFly(){if(this._flying&&this._flight!==null){let t=Math.min((Date.now()-this._flight.startedAt)/this._flight.duration,1);const s=this._flight.fly(t);this.eye=s.eye,this._r=s.u,this._u=s.v,this._b=s.n,this._f.set(-this._b.x,-this._b.y,-this._b.z),this._frameCallback&&this._frameCallback(),this.update(),t>=1&&(this.stopFlying(),this._completeCallback&&(this.events.dispatch(this.events.flyend,this),this._completeCallback(),this._completeCallback=null))}}isFlying(){return this._flying}checkMoveEnd(){let t=this._r,s=this._u,n=this._b,o=this.eye;this._peye.equal(o)&&this._pr.equal(t)&&this._pu.equal(s)&&this._pb.equal(n)?(this.isMoving&&this.events.dispatch(this.events.moveend,this),this.isMoving=!1):this.isMoving=!0,this._pr.copy(t),this._pu.copy(s),this._pb.copy(n),this._peye.copy(o)}bindFrustumsPickingColors(t){for(let s=0;s<this.frustums.length;s++)t.assignPickingColor(this.frustums[s])}_init(t){this._setProj(this._viewAngle,this.getAspectRatio()),this.set(t.eye||new v(0,0,1),t.look||new v,t.up||new v(0,1,0))}getUp(){return this._u.clone()}getDown(){return this._u.negateTo()}getRight(){return this._r.clone()}getLeft(){return this._r.negateTo()}getForward(){return this._f.clone()}getBackward(){return this._b.clone()}update(){let t=this._r,s=this._u,n=this._b,o=this.eye;v.doubleToTwoFloat32Array(o,this.eyeHigh,this.eyeLow),this._viewMatrix.set([t.x,s.x,n.x,0,t.y,s.y,n.y,0,t.z,s.z,n.z,0,-o.dot(t),-o.dot(s),-o.dot(n),1]),this._viewMatrixRTE.set([t.x,s.x,n.x,0,t.y,s.y,n.y,0,t.z,s.z,n.z,0,0,0,0,1]);for(let a=0,l=this.frustums.length;a<l;a++)this.frustums[a].setViewMatrix(this._viewMatrix),this.frustums[a].setProjectionViewRTEMatrix(this._viewMatrixRTE);this.events.dispatch(this.events.viewchange,this)}refresh(){this._setProj(this._viewAngle,this.getAspectRatio()),this.update()}get width(){return this._width}get height(){return this._height}setViewportSize(t,s){this._width=t,this._height=s,this.refresh()}getAspectRatio(){return this._width/this._height}_setProj(t,s){this._viewAngle=t;for(let a=0,l=this.frustums.length;a<l;a++){let c=this.frustums[a];c.setProjectionMatrix(t,s,c.near,c.far,this._isOrthographic,this._focusDistance)}var n,o;this._horizontalViewAngle=(n=t,o=s,Gr*Math.atan(Math.tan(Qt*n)*o)),this._updateViewportParameters()}_updateViewportParameters(){this._tanViewAngle_hrad=Math.tan(this._viewAngle*Qt),this._tanViewAngle_hradOneByHeight=this._tanViewAngle_hrad*(1/this._height),this._projSizeConst=Math.min(this._width<512?512:this._width,this._height<512?512:this._height)/(this._viewAngle*j)}setViewAngle(t){this._viewAngle=t,this.refresh()}getViewAngle(){return this._viewAngle}get viewAngle(){return this._viewAngle}get verticalViewAngle(){return this._viewAngle}get horizontalViewAngle(){return this._horizontalViewAngle}set(t,s,n){return this.eye.x=t.x,this.eye.y=t.y,this.eye.z=t.z,s=s||this._b,n=n||this._u,this._b.x=t.x-s.x,this._b.y=t.y-s.y,this._b.z=t.z-s.z,this._r.copy(n.cross(this._b)),this._b.normalize(),this._r.normalize(),this._u.copy(this._b.cross(this._r)),this._f.set(-this._b.x,-this._b.y,-this._b.z),this}look(t,s){this._b.set(this.eye.x-t.x,this.eye.y-t.y,this.eye.z-t.z),this._r.copy((s||this._u).cross(this._b)),this._b.normalize(),this._f.set(-this._b.x,-this._b.y,-this._b.z),this._r.normalize(),this._u.copy(this._b.cross(this._r))}slide(t,s,n){this.eye.x+=t*this._r.x+s*this._u.x+n*this._b.x,this.eye.y+=t*this._r.y+s*this._u.y+n*this._b.y,this.eye.z+=t*this._r.z+s*this._u.z+n*this._b.z}setRoll(t){let s=Math.cos(t),n=Math.sin(t),o=this._r.clone();this._r.set(s*o.x-n*this._u.x,s*o.y-n*this._u.y,s*o.z-n*this._u.z),this._u.set(n*o.x+s*this._u.x,n*o.y+s*this._u.y,n*o.z+s*this._u.z)}setPitch(t){let s=Math.cos(t),n=Math.sin(t),o=this._b;this._b.set(s*o.x-n*this._u.x,s*o.y-n*this._u.y,s*o.z-n*this._u.z),this._u.set(n*o.x+s*this._u.x,n*o.y+s*this._u.y,n*o.z+s*this._u.z)}setYaw(t){let s=Math.cos(t),n=Math.sin(t),o=this._r;this._r.set(s*o.x-n*this._b.x,s*o.y-n*this._b.y,s*o.z-n*this._b.z),this._b.set(n*o.x+s*this._b.x,n*o.y+s*this._b.y,n*o.z+s*this._b.z)}setPitchYawRoll(t,s,n){let o=new F;o.setPitchYawRoll(t,s,n),this.setRotation(o)}getPitch(){return this.getRotation().getPitch()}getYaw(){return this.getRotation().getYaw()}getRoll(){return this.getRotation().getRoll()}getAbsolutePitch(){return this.getRotation().getPitch()}getAbsoluteYaw(){return this.getRotation().getYaw()}getAbsoluteRoll(){return this.getRotation().getRoll()}getRotation(){return F.getLookRotation(this._f,this._u).conjugate()}setRotation(t,s,n,o){t.mulVec3Res(s||new v(0,1,0),this._u),t.mulVec3Res(n||new v(1,0,0),this._r),t.mulVec3Res(o||new v(0,0,1),this._b),this._f.set(-this._b.x,-this._b.y,-this._b.z)}rotate(t){t.mulVec3Res(this._u,this._u),t.mulVec3Res(this._r,this._r),t.mulVec3Res(this._b,this._b),this._f.set(-this._b.x,-this._b.y,-this._b.z)}unproject2v(t,s,n){return this.unproject(t.x,t.y,s,n)}unproject(t,s,n,o){let a=.5*this._width,l=.5*this._height,c=(t-a)/a,d=-(s-l)/l,u=this.frustums[0];if(this.isOrthographic){if(n){let _=.5*(u.right-u.left)*c,f=.5*(u.top-u.bottom)*d,g=this.getUp().scale(f),m=this.getRight().scale(_),p=g.addA(m),x=this.eye.add(p),y=this.getForward(),w=x.addA(y.scaleTo(n));return o&&o.copy(w),w.sub(this.eye).normalize()}return this.getForward()}{let _=u.inverseProjectionViewMatrix,f=_.mulVec4(new et(c,d,-1,1)).affinity();return _.mulVec4(new et(c,d,0,1)).affinity().subA(f).toVec3().normalize()}}project3v(t){return this.project(t.x,t.y,t.z)}project(t,s,n){let o=this.frustums[0].projectionViewMatrix.mulVec4(new et(t,s,n,1));return new H((1+o.x/o.w)*this._width*.5,(1-o.y/o.w)*this._height*.5)}rotateAround(t,s=!1,n=v.ZERO,o=v.UP){o=s?this._u:o;let a=tt.getRotation(t,o),l=tt.getRotationAroundPoint(t,n,o);this.eye=l.mulVec3(this.eye),this._u=a.mulVec3(this._u).normalize(),this._r=a.mulVec3(this._r).normalize(),this._b=a.mulVec3(this._b).normalize(),this._f.set(-this._b.x,-this._b.y,-this._b.z)}rotateHorizontal(t,s,n,o){this.rotateAround(t,s,n,o)}rotateVertical(t,s){this.rotateAround(t,!1,s,this._r)}projectedSize(t,s){if(this.isOrthographic){const n=this.frustums[0].projectionMatrix._m;return s*(this._height*n[5]*.5)}return Math.atan(s/this.eye.distance(t))*this._projSizeConst}getViewMatrix(){return this._viewMatrix._m}getNormalMatrix(){return this._normalMatrix._m}setCurrentFrustum(t){this.currentFrustumIndex=t,this.frustumColorIndex=10*(t+1)/255,this.isFirstPass=t===this.FARTHEST_FRUSTUM_INDEX}getCurrentFrustum(){return this.currentFrustumIndex}containsSphere(t){for(let s=0;s<this.frustums.length;s++)if(this.frustums[s].containsSphere(t))return!0;return!1}get frustum(){return this.frustums[this.currentFrustumIndex]}getProjectionMatrix(){return this.frustum.projectionMatrix._m}getProjectionViewMatrix(){return this.frustum.projectionViewMatrix._m}getProjectionViewRTEMatrix(){return this.frustum.projectionViewRTEMatrix._m}getInverseProjectionViewMatrix(){return this.frustum.inverseProjectionViewMatrix._m}getInverseProjectionMatrix(){return this.frustum.inverseProjectionMatrix._m}viewDistance(t,s=1e4){let n=t.add(this.getBackward().scaleTo(s));this.set(n,t),this.update()}copy(t){this.eye.copy(t.eye),this._r.copy(t._r),this._u.copy(t._u),this._b.copy(t._b),this._f.copy(t._f),this._width=t.width,this._height=t.height,this.setViewAngle(t.viewAngle),this.update()}getAltitude(){return this.eye.y}};Ss.__counter__=0;let Pi=Ss;class wa extends Pi{constructor(t,s={}){super({...s,frustums:s.frustums||[[1,100.075],[100,1000.075],[1e3,101e4],[1e6,1e9]]}),this.planet=t,this.minAltitude=s.minAltitude||1,this.maxAltitude=s.maxAltitude||2e7,this._lonLat=this.planet.ellipsoid.cartesianToLonLat(this.eye),this._lonLatMerc=this._lonLat.forwardMercator(),this._terrainAltitude=this._lonLat.height,this._terrainPoint=new v,this._insideSegment=null,this.slope=0,this._keyLock=new Me,this._flight=null,this._completeCallback=null,this._frameCallback=null,this._flying=!1,this._checkTerrainCollision=!0,this.eyeNorm=this.eye.getNormal()}setTerrainCollisionActivity(t){this._checkTerrainCollision=t}update(){this.events.stopPropagation();let t=this.maxAltitude+this.planet.ellipsoid.getEquatorialSize();this.eye.length()>t&&this.eye.copy(this.eye.getNormal().scale(t)),super.update(),this.updateGeodeticPosition(),this.eyeNorm=this.eye.getNormal(),this.slope=this._b.dot(this.eyeNorm),this.events.dispatch(this.events.viewchange,this)}updateGeodeticPosition(){this.planet.ellipsoid.cartesianToLonLatRes(this.eye,this._lonLat),Math.abs(this._lonLat.lat)<=ct&&L.forwardMercatorRes(this._lonLat,this._lonLatMerc)}setAltitude(t){let s=this._terrainPoint,n=this.planet.ellipsoid.getSurfaceNormal3v(this.eye);this.eye.x=n.x*t+s.x,this.eye.y=n.y*t+s.y,this.eye.z=n.z*t+s.z,this._terrainAltitude=t}getAltitude(){return this._terrainAltitude}setLonLat(t,s,n){this.stopFlying(),this._lonLat.set(t.lon,t.lat,t.height||this._lonLat.height);let o=this.planet.ellipsoid,a=o.lonLatToCartesian(this._lonLat),l=s?o.lonLatToCartesian(s):v.ZERO;this.set(a,l,n||a.getNormal()),this.update()}getLonLat(){return this._lonLat}getHeight(){return this._lonLat.height}getExtentPosition(t,s){s=s||0;let n=t.getNorth(),o=t.getSouth(),a=t.getEast(),l=t.getWest();l>a&&(a+=360);let c=this.planet.ellipsoid,d=new L(a,n),u=c.lonLatToCartesian(d);d.lat=o;let _=c.lonLatToCartesian(d);d.lon=l;let f=c.lonLatToCartesian(d);d.lat=n;let g=c.lonLatToCartesian(d),m=v.sub(u,f).scale(.5).addA(f),p=m.length();p<1e-6&&(d.lon=.5*(a+l),d.lat=.5*(n+o),m=c.lonLatToCartesian(d)),g.subA(m),_.subA(m),u.subA(m),f.subA(m);let x=m.getNormal(),y=x.cross(v.NORTH).normalize(),w=y.cross(x).normalize(),C=Math.max(Math.abs(w.dot(g)),Math.abs(w.dot(_)),Math.abs(w.dot(u)),Math.abs(w.dot(f))),T=Math.max(Math.abs(y.dot(g)),Math.abs(y.dot(_)),Math.abs(y.dot(u)),Math.abs(y.dot(f))),P=Math.tan(this._viewAngle*j*.5),E=this.getAspectRatio()*P,S=Math.max(T/E,C/P);return m.normalize(),m.scale(p+S+s),m}viewExtent(t,s){this.stopFlying(),this.set(this.getExtentPosition(t,s),v.ZERO,v.NORTH),this.update()}flyExtent(t,s,n={}){n.look=v.ZERO,this.flyCartesian(this.getExtentPosition(t,s),n)}viewDistance(t,s=1e4){let n=this.eye.add(this.getForward().scaleTo(s)),o=F.getRotationBetweenVectors(n.getNormal(),t.getNormal());if(o.isZero()){let a=t.add(this.getBackward().scaleTo(s));this.set(a,t)}else{let a=t.add(o.mulVec3(this.getBackward()).scale(s)),l=o.mulVec3(this.getUp());this.set(a,t,l)}this.update()}flyLonLat(t,s={}){let n=new L(t.lon,t.lat,t.height||this._lonLat.height);this.flyCartesian(this.planet.ellipsoid.lonLatToCartesian(n),s)}flyDistance(t,s=1e4,n={}){let o=this.eye.add(this.getForward().scaleTo(s)),a=F.getRotationBetweenVectors(o.getNormal(),t.getNormal());if(a.isZero()){let l=t.add(this.getBackward().scaleTo(s));this.set(l,t)}else{let l=t.add(a.mulVec3(this.getBackward()).scale(s)),c=a.mulVec3(this.getUp());n.look=t,n.up=c,this.flyCartesian(l,n)}}flyCartesian(t,s={}){this.stopFlying(),s.preventLock||(this.planet.layerLock.lock(this._keyLock),this.planet.terrainLock.lock(this._keyLock),this.planet.normalMapCreator.lock(this._keyLock)),s.amplitude=s.amplitude!=null?s.amplitude:1,s.look=s.look||v.ZERO,s.up=s.up||v.NORTH,s.duration=s.duration||800;const n=s.ease||ba;this._completeCallback=s.completeCallback||(()=>{}),this._frameCallback=s.frameCallback||(()=>{}),s.startCallback&&s.startCallback.call(this),s.look instanceof L&&(s.look=this.planet.ellipsoid.lonLatToCartesian(s.look));let o=this.eye.clone(),a=this._u,l=this._b,c=this.planet.ellipsoid.cartesianToLonLat(t),d=s.up,u=this.planet.ellipsoid.lonLatToCartesian(new L(c.lon,c.lat,0)),_=v.sub(t,s.look),f=d.cross(_);_.normalize(),f.normalize();let g=_.cross(f),m=o.getNormal(),p=u.getNormal(),x=1-m.dot(p),y=s.amplitude*yo*Math.sqrt(x>0?x:0),w=6639613,C=Math.max(this._lonLat.height,c.height);C>w&&(w=C);let T=C+2.5*y*(w-C),P=v.ZERO;this._flight={fly:E=>{let S,M=n(E),R=1-M;if(M>=1)S=t.clone();else{let D=o.smerp(t,R).normalize(),re=this.planet.getRayIntersectionEllipsoid(new V(P,D)),Ee=this._lonLat.height*R*R*R+3*T*R*R*M+3*T*R*M*M+c.height*M*M*M;S=re.addA(D.scale(Ee))}let k=a.smerp(g,R),B=v.add(S,l.smerp(_,R).negateTo()),z=new v(S.x-B.x,S.y-B.y,S.z-B.z),O=k.cross(z);z.normalize(),O.normalize();let ze=z.cross(O);return{eye:S,n:z,u:O,v:ze}},duration:s.duration,startedAt:Date.now()},this._flying=!0,this.events.dispatch(this.events.flystart,this)}stopFlying(){this._flying&&(this.planet.layerLock.free(this._keyLock),this.planet.terrainLock.free(this._keyLock),this.planet.normalMapCreator.free(this._keyLock),super.stopFlying())}rotateLeft(t,s){this.rotateHorizontal(t,s!==!0,v.ZERO),this.update()}rotateRight(t,s){this.rotateHorizontal(-t,s!==!0,v.ZERO),this.update()}rotateUp(t){this.rotateVertical(t,v.ZERO),this.update()}rotateDown(t){this.rotateVertical(-t,v.ZERO),this.update()}rotateVertical(t,s,n=0){let o=new tt().setRotation(this._r,t),a=new tt().setIdentity().translate(s),l=new tt().setIdentity().translate(s.negateTo()),c=a.mul(o).mul(l).mulVec3(this.eye),d=o.mulVec3(this._u).normalize(),u=o.mulVec3(this._r).normalize(),_=o.mulVec3(this._b).normalize(),f=c.getNormal(),g=_.dot(f);if(!(d.dot(f)<=0))if(n){let m=g-this.slope;if(g<n&&m<0)return;(g>.1&&d.dot(f)>0||this.slope<=.1||this._u.dot(this.eye.getNormal())<=0)&&(this.eye=c,this._u=d,this._r=u,this._b=_,this._f.set(-_.x,-_.y,-_.z))}else this.eye=c,this._u=d,this._r=u,this._b=_,this._f.set(-_.x,-_.y,-_.z)}checkTerrainCollision(){if(this._terrainAltitude=this._lonLat.height,this._insideSegment&&this._insideSegment.planet)return this._terrainAltitude=this._insideSegment.getTerrainPoint(this.eye,this._insideSegment.getInsideLonLat(this),this._terrainPoint),this._terrainAltitude<this.minAltitude&&this._checkTerrainCollision&&this.setAltitude(this.minAltitude),this._terrainPoint}getSurfaceVisibleDistance(t){let s=this.planet.ellipsoid.equatorialSize;return s*Math.acos(s/(s+this._lonLat.height+t))}getHeading(){let t=this.eye.getNormal(),s=v.proj_b_to_plane(this.slope>=.97?this.getUp():this.getForward(),t).normalize(),n=v.proj_b_to_plane(v.NORTH,t).normalize(),o=Math.sign(t.dot(s.cross(n)))*Math.acos(s.dot(n))*J;return o<0?360+o:o}isVisible(t){let s=this.eye.length();return this.eye.distance(t)<Math.sqrt(s*s-this.planet.ellipsoid.equatorialSizeSqr)}getPitch(){return this.planet.getFrameRotation(this.eye).conjugate().inverse().mul(this.getRotation()).getPitch()}getYaw(){return this.planet.getFrameRotation(this.eye).conjugate().inverse().mul(this.getRotation()).getYaw()}getRoll(){return this.planet.getFrameRotation(this.eye).conjugate().inverse().mul(this.getRotation()).getRoll()}setPitch(t){let s=this.planet.getFrameRotation(this.eye),n=new F;n.setPitchYawRoll(t,this.getYaw(),this.getRoll(),s),this.setRotation(n)}setYaw(t){let s=this.planet.getFrameRotation(this.eye),n=new F;n.setPitchYawRoll(this.getPitch(),t,this.getRoll(),s),this.setRotation(n)}setRoll(t){let s=this.planet.getFrameRotation(this.eye),n=new F;n.setPitchYawRoll(this.getPitch(),this.getYaw(),t,s),this.setRotation(n)}setPitchYawRoll(t,s,n){let o=this.planet.getFrameRotation(this.eye),a=new F;a.setPitchYawRoll(t,s,n,o).conjugate(),this.setRotation(a)}}const Rs=class Td{constructor(t,s={}){this.handler=t,this.__id=Td.__counter__++,this._fbo=null,this._width=s.width||t.canvas.width,this._height=s.height||t.canvas.height,this._depthComponent=s.depthComponent!=null?s.depthComponent:"DEPTH_COMPONENT16",this._useDepth=s.useDepth==null||s.useDepth,this._active=!1,this._size=s.size||1,this._depthRenderbuffer=null,this._filter=s.filter||"NEAREST"}get width(){return this._width}get height(){return this._height}setSize(t,s,n=!1){this._width=t,this._height=s,this._active&&this.handler.gl.viewport(0,0,this._width,this._height),(this._useDepth||n)&&(this.destroy(),this.init())}init(){}destroy(){}isComplete(){let t=this.handler.gl;return t.checkFramebufferStatus(t.FRAMEBUFFER)===t.FRAMEBUFFER_COMPLETE}checkStatus(){let t=this.handler.gl;return t.checkFramebufferStatus(t.FRAMEBUFFER)}activate(){let t=this.handler.gl;t.bindFramebuffer(t.FRAMEBUFFER,null),t.bindFramebuffer(t.FRAMEBUFFER,this._fbo),t.viewport(0,0,this._width,this._height),this._active=!0;let s=this.handler.framebufferStack.current().data;return s&&(s._active=!1),this.handler.framebufferStack.push(this),this}deactivate(){let t=this.handler,s=t.gl;s.bindFramebuffer(s.FRAMEBUFFER,null),this._active=!1;let n=this.handler.framebufferStack.popPrev();n?(s.bindFramebuffer(s.FRAMEBUFFER,n._fbo),s.viewport(0,0,n._width,n._height)):s.viewport(0,0,t.canvas.width,t.canvas.height)}isEqual(t){return!!t&&this.__id===t.__id}};Rs.__counter__=0;let hs=Rs;class mi{constructor(t=256,s=256){this._canvas=document.createElement("canvas"),this._canvas.width=t,this._canvas.height=s,this._context=this._canvas.getContext("2d",{willReadFrequently:!0})}getCanvas(){return this._canvas}getContext(){return this._context}fillEmpty(){let t=this._context.getImageData(0,0,this._canvas.width,this._canvas.height),s=t.data;for(let n=0,o=s.length;n<o;n+=4)s[n]=s[n+1]=s[n+2]=s[n+3]=0;this._context.putImageData(t,0,0)}fill(t){this._context.fillStyle=t,this._context.fill()}getData(){return this._context.getImageData(0,0,this._canvas.width,this._canvas.height).data}fillColor(t){this._context.fillStyle=t,this._context.fillRect(0,0,this._canvas.width,this._canvas.height)}setData(t){let s=this._context.createImageData(this._canvas.width,this._canvas.height);s.data.set(t),this._context.putImageData(s,0,0)}resize(t,s){this._canvas.width=t,this._canvas.height=s,this._context=this._canvas.getContext("2d")}drawImage(t,s,n,o,a){this._context.drawImage(t,s||0,n||0,o||t.width,a||t.height)}getImage(){let t=new Image;return t.width=this.getWidth(),t.height=this.getHeight(),t.src=this._canvas.toDataURL("image/png"),t}getTextWidth(t){let s=this._context.measureText(t);return Math.round(s.width)}drawText(t,s=0,n=14,o="normal 14px Verdana",a="black"){this._context.fillStyle=a,this._context.font=o,this._context.fillText(t,s,n)}getWidth(){return this._canvas.width}getHeight(){return this._canvas.height}load(t,s){let n=new Image,o=this;n.onload=function(){o.resize(n.width,n.height),o._context.drawImage(n,0,0,n.width,n.height),s&&s(n)},n.src=t}openImage(){let t=this.getImage(),s="<!DOCTYPE html>";s+="<html>",s+="<head><title>Print</title></head>",s+="<body>",s+='<img src="'+t.src+'">',s+="</body>",s+="</html>";let n=window.open("","","width="+t.width+"px ,height="+t.height+"px");n&&(n.document.open(),n.document.write(s),n.document.close(),n.focus())}destroy(){this._canvas.width=1,this._canvas.height=1,this._canvas=null,this._context=null}}const io={UNSIGNED_BYTE:Uint8Array,FLOAT:Float32Array};class Rt extends hs{constructor(t,s={}){super(t,s),this.readPixelBuffersAsync=n=>{const o=this.handler.gl;if(this._skipFrame)return;this._skipFrame=!0;let a=this.width,l=this.height,c=this.pixelBuffers;this.activate();for(let f=0;f<c.length;f++){let g=c[f];o.bindBuffer(o.PIXEL_PACK_BUFFER,g.buffer),o.bufferData(o.PIXEL_PACK_BUFFER,g.data.byteLength,o.STREAM_READ),o.readBuffer(g.glAttachment),o.readPixels(0,0,a,l,o.RGBA,g.glType,0),o.bindBuffer(o.PIXEL_PACK_BUFFER,null)}this.deactivate();const d=o.fenceSync(o.SYNC_GPU_COMMANDS_COMPLETE,0);var u,_;o.flush(),(u=o,_=d,new Promise((f,g)=>{(function m(){const p=u.clientWaitSync(_,0,0);p==u.WAIT_FAILED?g():p==u.TIMEOUT_EXPIRED?requestAnimationFrame(m):f()})()})).then(()=>{this._skipFrame=!1,o.deleteSync(d);for(let f=0;f<c.length;f++){let g=c[f];g.data&&(o.bindBuffer(o.PIXEL_PACK_BUFFER,g.buffer),o.getBufferSubData(o.PIXEL_PACK_BUFFER,0,g.data))}o.bindBuffer(o.PIXEL_PACK_BUFFER,null),n&&n(this)})},this._targets=Rt.createTargets(s.targets),this._size=this._targets.length,this._renderbufferTarget=s.renderbufferTarget!=null?s.renderbufferTarget:"DEPTH_ATTACHMENT",this.textures=s.textures||new Array(this._size),this.pixelBuffers=[],this._skipFrame=!1}static createTargets(t){let s=0,n=0;return t?t.map(o=>{let a=o.attachment||"COLOR_ATTACHMENT";a==="COLOR_ATTACHMENT"&&(a="COLOR_ATTACHMENT"+s++);let l=o.type||"UNSIGNED_BYTE";return{internalFormat:o.internalFormat||"RGBA",format:o.format||"RGBA",type:l,attachment:a,filter:o.filter||"NEAREST",pixelBufferIndex:o.readAsync?n++:-1,TypeArrayConstructor:io[l]}}):[{internalFormat:"RGBA",format:"RGBA",type:"UNSIGNED_BYTE",attachment:"COLOR_ATTACHMENT0",filter:"NEAREST",pixelBufferIndex:-1,TypeArrayConstructor:io.UNSIGNED_BYTE}]}destroy(){let t=this.handler.gl;if(t){for(let s=0;s<this.textures.length;s++)t.deleteTexture(this.textures[s]);this.textures=new Array(this._size);for(let s=0;s<this.pixelBuffers.length;s++)this.pixelBuffers[s].data=null,t.deleteBuffer(this.pixelBuffers[s].buffer);this.pixelBuffers=[],t.deleteFramebuffer(this._fbo),t.deleteRenderbuffer(this._depthRenderbuffer),this._depthRenderbuffer=null,this._fbo=null,this._active=!1}}init(){let t=this.handler.gl;if(!t)return;this._fbo=t.createFramebuffer(),t.bindFramebuffer(t.FRAMEBUFFER,this._fbo);let s=[];for(let n=0;n<this._targets.length;n++){let o=this._targets[n],a=this.textures[n]||this.handler.createEmptyTexture2DExt(this._width,this._height,o.filter,o.internalFormat,o.format,o.type),l=t[o.attachment];a&&(this.bindOutputTexture(a,l),this.textures[n]=a),o.attachment!=="DEPTH_ATTACHMENT"&&s.push(l),o.pixelBufferIndex!==-1&&this._createPixelBuffer(o)}t.drawBuffers&&t.drawBuffers(s),this._useDepth&&(this._depthRenderbuffer=t.createRenderbuffer(),t.bindRenderbuffer(t.RENDERBUFFER,this._depthRenderbuffer),t.renderbufferStorage(t.RENDERBUFFER,t[this._depthComponent],this._width,this._height),t.framebufferRenderbuffer(t.FRAMEBUFFER,t[this._renderbufferTarget],t.RENDERBUFFER,this._depthRenderbuffer),t.bindRenderbuffer(t.RENDERBUFFER,null)),t.bindFramebuffer(t.FRAMEBUFFER,null)}getPixelBufferData(t=0){let s=this._targets[t].pixelBufferIndex;return s!==-1?this.pixelBuffers[s].data:null}_createPixelBuffer(t){let s=this.handler.gl,n=t.pixelBufferIndex,o=this.pixelBuffers[n];o||(o=this.pixelBuffers[n]={buffer:null,data:null,glType:-1,glAttachment:-1});let a=this.width*this.height*4;o.data=null,o.data=new t.TypeArrayConstructor(a),o.buffer=s.createBuffer(),s.bindBuffer(s.PIXEL_PACK_BUFFER,o.buffer),s.bufferData(s.PIXEL_PACK_BUFFER,a,s.STREAM_READ),s.bindBuffer(s.PIXEL_PACK_BUFFER,null),o.glType=s[t.type],o.glAttachment=s[t.attachment]}bindOutputTexture(t,s){let n=this.handler.gl;n.bindTexture(n.TEXTURE_2D,t),n.framebufferTexture2D(n.FRAMEBUFFER,s||n.COLOR_ATTACHMENT0,n.TEXTURE_2D,t,0),n.bindTexture(n.TEXTURE_2D,null)}readPixels(t,s,n,o=0,a=1,l=1){let c=this.handler.gl;c.bindFramebuffer(c.FRAMEBUFFER,this._fbo),c.readBuffer&&c.readBuffer(c.COLOR_ATTACHMENT0+o||0),c.readPixels(s*this._width,n*this._height,a,l,c.RGBA,c[this._targets[o].type],t),c.bindFramebuffer(c.FRAMEBUFFER,null)}readAllPixels(t,s=0){let n=this.handler.gl;n.bindFramebuffer(n.FRAMEBUFFER,this._fbo),n.readBuffer&&n.readBuffer(n.COLOR_ATTACHMENT0+s),n.readPixels(0,0,this._width,this._height,n.RGBA,n[this._targets[s].type],t),n.bindFramebuffer(n.FRAMEBUFFER,null)}getImage(){let t=new Uint8Array(4*this._width*this._height);this.readAllPixels(t);let s=new mi(this._width,this._height);return s.setData(t),s.getImage()}readData(t,s,n,o=0){const a=this.width,l=this.height,c=Math.floor(t*(a-1)),d=4*(Math.floor(s*(l-1))*a+c),u=this.pixelBuffers[o].data;u&&(n[0]=u[d],n[1]=u[d+1],n[2]=u[d+2],n[3]=u[d+3])}}const Mh=["tick","end","start","stop"],Ms=class Ed{constructor(t={}){this.__handler=null,this.active=!0,this.__id=Ed.__counter__++,this.events=lt(Mh,this),this.name=t.name||"",this.startDate=t.startDate||0,this.endDate=t.endDate||0;let s=t.currentDate||is(new Date);t.startDate&&s<t.startDate&&(s=t.startDate),t.endDate&&s>t.endDate&&(s=t.endDate),this.currentDate=s,this._multiplier=t.multiplier!==void 0?t.multiplier:1,this._running=1,this.deltaTicks=0,this.active=!0,this._intervalDelay=0,this._intervalStart=0,this._intervalCallback=null}clearInterval(){this._intervalDelay=0,this._intervalStart=0,this._intervalCallback=null}setInterval(t,s){this._intervalStart=this.currentDate,this._intervalDelay=t*tn,this._intervalCallback=s}setDate(t){let s=is(t);this.startDate&&s<this.startDate&&(s=this.startDate),this.endDate&&s>this.endDate&&(s=this.endDate),this.currentDate=s}getDate(){return mr(this.currentDate)}reset(){this.startDate&&(this.currentDate=this.startDate)}tick(t){let s=this._multiplier*this._running;if(this.deltaTicks=t*s,this.active){let n=Fo(this.currentDate,this.deltaTicks);s>0?this.endDate&&n>this.endDate?(this.currentDate=this.startDate,this.events.dispatch(this.events.end,this)):this.currentDate=n:this.startDate&&n<this.startDate?(this.currentDate=this.endDate,this.events.dispatch(this.events.end,this)):this.currentDate=n,this._intervalCallback&&this.currentDate-this._intervalStart>=this._intervalDelay&&(this._intervalStart=this.currentDate,this._intervalCallback(this)),this.events.dispatch(this.events.tick,this)}}isEqual(t){return this.__id===t.__id}start(){this._running===0&&(this._running=1,this.events.dispatch(this.events.start,this))}get multiplier(){return this._multiplier}set multiplier(t){this._multiplier=t}stop(){this._running===1&&(this._running=0,this.events.dispatch(this.events.stop,this))}};Ms.__counter__=0;let Nr=Ms;class Bh{constructor(t,s){s._programController=this,this._program=s,this._handler=t,this._activated=!1}initialize(){this._handler.gl&&this._program.createProgram(this._handler.gl)}getProgram(){return this._program}activate(){if(!this._activated){this._handler.activeProgram.deactivate(),this._handler.activeProgram=this;let t=this._program;this._activated=!0,t.enableAttribArrays(),t.use()}return this}remove(){let t=this._handler.programs;t[this._program.name]&&(this._activated&&this.deactivate(),this._program.delete(),delete t[this._program.name])}deactivate(){this._program.disableAttribArrays(),this._activated=!1}isActive(){return this._activated}set(t){return this.activate(),this._program.set(t),this}drawIndexBuffer(t,s){return this._program.drawIndexBuffer(t,s),this}drawArrays(t,s){return this._program.drawArrays(t,s),this}}let so=class{constructor(){this.next=null,this.prev=null,this.data=null}};class Js{constructor(t=256){this._current=new so,this._head=this._current;for(let s=0;s<t;s++){let n=new so;n.prev=this._current,this._current.next=n,this._current=n}this._current=this._head}current(){return this._current}push(t){this._current=this._current.next,this._current.data=t}pop(){let t=this._current.data;return this._current=this._current.prev,t}popPrev(){return this._current=this._current.prev,this._current.data}}const ro=["","WEBKIT_","MOZ_"],tr=["webgl2","webgl"];class Be{constructor(t,s={}){this.framebufferStack=new Js,this._requestAnimationFrameId=0,this.drawFrame=()=>{let n=window.performance.now(),o=this.deltaTime;this.deltaTime=.5*(n-this._lastAnimationFrameTime+this.prevDeltaTime),this.deltaTime>3?this.deltaTime=3:this.deltaTime<1&&(this.deltaTime=1),this.prevDeltaTime=o,this._lastAnimationFrameTime=n,this.defaultClock.tick(this.deltaTime);for(let l=0;l<this._clocks.length;l++)this._clocks[l].tick(this.deltaTime);let a=this.canvas;Math.floor(a.clientWidth*this._params.pixelRatio)===a.width&&Math.floor(a.clientHeight*this._params.pixelRatio)===a.height||(a.clientWidth===0||a.clientHeight===0?this.stop():document.hidden||(this.start(),this.setSize(a.clientWidth,a.clientHeight))),this._frameCallback()},this.events=lt(["visibilitychange","resize"]),this._throttledDrawFrame=this.drawFrame,this.defaultClock=new Nr,this._clocks=[],this.prevDeltaTime=0,this.deltaTime=0,this.canvas=null,this.gl=null,this.programs={},this.activeProgram=null,this._canvasSize=[0,0],this._params={anisotropy:s.anisotropy||4,width:s.width||256,height:s.height||256,pixelRatio:zo("og_dpi")||s.pixelRatio||1,extensions:s.extensions||[],context:s.context||{}},this.extensions={},this._canvasTarget=t,this._lastAnimationFrameTime=0,this._initialized=!1,this._frameCallback=function(){},this.transparentTexture=null,this.defaultTexture=null,this.framebufferStack=new Js,this.createTexture_n=this.createTexture_n_webgl2.bind(this),this.createTexture_l=this.createTexture_l_webgl2.bind(this),this.createTexture_mm=this.createTexture_mm_webgl2.bind(this),this.createTexture_a=this.createTexture_a_webgl2.bind(this),this.createTexture={NEAREST:this.createTexture_n,LINEAR:this.createTexture_l,MIPMAP:this.createTexture_mm,ANISOTROPIC:this.createTexture_a},this.createTextureDefault=this.createTexture_n,this.ONCANVASRESIZE=null,this._createCanvas(),(s.autoActivate||Gt(s.autoActivate))&&this.initialize()}set frameDelay(t){this._throttledDrawFrame=t===0?this.drawFrame:yi(this.drawFrame,t)}isInitialized(){return this._initialized}_createCanvas(){this._canvasTarget?this._canvasTarget instanceof HTMLElement?this.canvas=this._canvasTarget:this.canvas=document.getElementById(this._canvasTarget)||document.querySelector(this._canvasTarget):(this.canvas=document.createElement("canvas"),this.canvas.width=this._params.width,this.canvas.height=this._params.height)}static getExtension(t,s){if(!t)return;let n,o;for(n in ro)if(o=t.getExtension(ro[n]+s),o)return o}static getContext(t,s){let n=null;try{let o=new URLSearchParams(location.search).get("og_ver");if(o)n=t.getContext(o,s),n&&(n.type=o);else for(let a=0;a<tr.length;a++)if(n=t.getContext(tr[a],s),n){n.type=tr[a];break}}catch{ie.logErr("exception during the GL context initialization")}return n||ie.logErr("could not initialise WebGL"),n}setFrameCallback(t){t&&(this._frameCallback=t)}createEmptyTexture2DExt(t=1,s=1,n="NEAREST",o="RGBA",a="RGBA",l="UNSIGNED_BYTE",c="CLAMP_TO_EDGE",d=0){let u=this.gl,_=u.createTexture();return u.bindTexture(u.TEXTURE_2D,_),u.texImage2D(u.TEXTURE_2D,d,u[o.toUpperCase()],t,s,0,u[a.toUpperCase()],u[l.toUpperCase()],null),u.texParameteri(u.TEXTURE_2D,u.TEXTURE_MIN_FILTER,u[n.toUpperCase()]),u.texParameteri(u.TEXTURE_2D,u.TEXTURE_MAG_FILTER,u[n.toUpperCase()]),u.texParameteri(u.TEXTURE_2D,u.TEXTURE_WRAP_S,u[c.toUpperCase()]),u.texParameteri(u.TEXTURE_2D,u.TEXTURE_WRAP_T,u[c.toUpperCase()]),u.bindTexture(u.TEXTURE_2D,null),_}createEmptyTexture_n(t,s,n,o){let a=this.gl,l=a.createTexture();return a.bindTexture(a.TEXTURE_2D,l),a.texImage2D(a.TEXTURE_2D,0,n||a.RGBA,t,s,0,a.RGBA,a.UNSIGNED_BYTE,null),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.NEAREST),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.NEAREST),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,o||a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,o||a.CLAMP_TO_EDGE),a.bindTexture(a.TEXTURE_2D,null),l}createEmptyTexture_l(t,s,n,o){let a=this.gl,l=a.createTexture();return a.bindTexture(a.TEXTURE_2D,l),a.texImage2D(a.TEXTURE_2D,0,n||a.RGBA,t,s,0,a.RGBA,a.UNSIGNED_BYTE,null),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,o||a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,o||a.CLAMP_TO_EDGE),a.bindTexture(a.TEXTURE_2D,null),l}createTexture_n_webgl1(t,s,n,o=null){let a=this.gl;return o=o||a.createTexture(),a.bindTexture(a.TEXTURE_2D,o),a.texImage2D(a.TEXTURE_2D,0,s||a.RGBA,a.RGBA,a.UNSIGNED_BYTE,t),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.NEAREST),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.NEAREST),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,n||a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,n||a.CLAMP_TO_EDGE),a.bindTexture(a.TEXTURE_2D,null),o}createTexture_l_webgl1(t,s,n,o=null){let a=this.gl;return o=o||a.createTexture(),a.bindTexture(a.TEXTURE_2D,o),a.texImage2D(a.TEXTURE_2D,0,s||a.RGBA,a.RGBA,a.UNSIGNED_BYTE,t),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,n||a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,n||a.CLAMP_TO_EDGE),a.bindTexture(a.TEXTURE_2D,null),o}createTexture_mm_webgl1(t,s,n,o=null){let a=this.gl;return o=o||a.createTexture(),a.bindTexture(a.TEXTURE_2D,o),a.texImage2D(a.TEXTURE_2D,0,s||a.RGBA,a.RGBA,a.UNSIGNED_BYTE,t),a.generateMipmap(a.TEXTURE_2D),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR_MIPMAP_LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,n||a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,n||a.CLAMP_TO_EDGE),a.bindTexture(a.TEXTURE_2D,null),o}createTexture_a_webgl1(t,s,n,o=null){let a=this.gl;return o=o||a.createTexture(),a.bindTexture(a.TEXTURE_2D,o),a.texImage2D(a.TEXTURE_2D,0,s||a.RGBA,a.RGBA,a.UNSIGNED_BYTE,t),a.generateMipmap(a.TEXTURE_2D),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR_MIPMAP_LINEAR),a.texParameterf(a.TEXTURE_2D,this.extensions.EXT_texture_filter_anisotropic.TEXTURE_MAX_ANISOTROPY_EXT,this._params.anisotropy),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,n||a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,n||a.CLAMP_TO_EDGE),a.bindTexture(a.TEXTURE_2D,null),o}createTexture_n_webgl2(t,s,n,o=null){let a=this.gl;return o=o||a.createTexture(),a.bindTexture(a.TEXTURE_2D,o),a.texStorage2D(a.TEXTURE_2D,1,s||a.RGBA8,t.width,t.height),a.texSubImage2D(a.TEXTURE_2D,0,0,0,t.width,t.height,a.RGBA,a.UNSIGNED_BYTE,t),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.NEAREST),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.NEAREST),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,n||a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,n||a.CLAMP_TO_EDGE),a.bindTexture(a.TEXTURE_2D,null),o}createTexture_l_webgl2(t,s,n,o=null){let a=this.gl;return o=o||a.createTexture(),a.bindTexture(a.TEXTURE_2D,o),a.texStorage2D(a.TEXTURE_2D,1,s||a.RGBA8,t.width,t.height),a.texSubImage2D(a.TEXTURE_2D,0,0,0,t.width,t.height,a.RGBA,a.UNSIGNED_BYTE,t),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,n||a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,n||a.CLAMP_TO_EDGE),a.bindTexture(a.TEXTURE_2D,null),o}createTexture_mm_webgl2(t,s,n,o=null){let a=this.gl;return o=o||a.createTexture(),a.bindTexture(a.TEXTURE_2D,o),a.texStorage2D(a.TEXTURE_2D,2,s||a.RGBA8,t.width,t.height),a.texSubImage2D(a.TEXTURE_2D,0,0,0,t.width,t.height,a.RGBA,a.UNSIGNED_BYTE,t),a.generateMipmap(a.TEXTURE_2D),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR_MIPMAP_LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,n||a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,n||a.CLAMP_TO_EDGE),a.bindTexture(a.TEXTURE_2D,null),o}createTexture_a_webgl2(t,s,n,o=null){let a=this.gl;return o=o||a.createTexture(),a.bindTexture(a.TEXTURE_2D,o),a.texStorage2D(a.TEXTURE_2D,2,s||a.RGBA8,t.width,t.height),a.texSubImage2D(a.TEXTURE_2D,0,0,0,t.width,t.height,a.RGBA,a.UNSIGNED_BYTE,t),a.generateMipmap(a.TEXTURE_2D),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR_MIPMAP_LINEAR),a.texParameterf(a.TEXTURE_2D,this.extensions.EXT_texture_filter_anisotropic.TEXTURE_MAX_ANISOTROPY_EXT,this._params.anisotropy),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,n||a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,n||a.CLAMP_TO_EDGE),a.bindTexture(a.TEXTURE_2D,null),o}loadCubeMapTexture(t){let s=this.gl,n=s.createTexture();s.bindTexture(s.TEXTURE_CUBE_MAP,n),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_MIN_FILTER,s.LINEAR),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_MAG_FILTER,s.LINEAR);let o=[[t.px,s.TEXTURE_CUBE_MAP_POSITIVE_X],[t.nx,s.TEXTURE_CUBE_MAP_NEGATIVE_X],[t.py,s.TEXTURE_CUBE_MAP_POSITIVE_Y],[t.ny,s.TEXTURE_CUBE_MAP_NEGATIVE_Y],[t.pz,s.TEXTURE_CUBE_MAP_POSITIVE_Z],[t.nz,s.TEXTURE_CUBE_MAP_NEGATIVE_Z]],a=new mi;a.fillEmpty();let l=a.getImage();for(let c=0;c<o.length;c++){let d=o[c][1];s.bindTexture(s.TEXTURE_CUBE_MAP,n),s.texImage2D(d,0,s.RGBA,s.RGBA,s.UNSIGNED_BYTE,l)}for(let c=0;c<o.length;c++){let d=o[c][1],u=new Image;u.crossOrigin="",u.onload=function(_,f,g){return function(){s&&_&&(s.bindTexture(s.TEXTURE_CUBE_MAP,_),s.texImage2D(f,0,s.RGBA,s.RGBA,s.UNSIGNED_BYTE,g))}}(n,d,u),u.src=o[c][0]}return n}addProgram(t,s=!1){if(this.programs[t.name])console.warn(`Shader program: "${t.name}" already exists.`);else{let n=new Bh(this,t);this.programs[t.name]=n,this._initProgramController(n),s||(n._activated=!1)}return t}removeProgram(t){this.programs[t]&&this.programs[t].remove()}addPrograms(t){for(let s=0;s<t.length;s++)this.addProgram(t[s])}_initProgramController(t){this._initialized&&(t.initialize(),this.activeProgram?(t.deactivate(),this.activeProgram._program.enableAttribArrays(),this.activeProgram._program.use()):(this.activeProgram=t,t.activate()))}_initPrograms(){for(let t in this.programs)this._initProgramController(this.programs[t])}initializeExtension(t,s=!1){if(!this.extensions||!this.extensions[t]){let n=Be.getExtension(this.gl,t);n?this.extensions[t]=n:s&&console.warn("og.webgl.Handler: extension '"+t+"' doesn't initialize.")}return this.extensions&&this.extensions[t]}initialize(){if(this._initialized||!this.canvas||(this.gl=Be.getContext(this.canvas,this._params.context),!this.gl))return;this._initialized=!0,this._params.extensions.push("EXT_texture_filter_anisotropic"),this.gl.type==="webgl"?(this._params.extensions.push("OES_standard_derivatives"),this._params.extensions.push("OES_element_index_uint"),this._params.extensions.push("WEBGL_depth_texture"),this._params.extensions.push("ANGLE_instanced_arrays")):(this._params.extensions.push("EXT_color_buffer_float"),this._params.extensions.push("OES_texture_float_linear"));let t=this._params.extensions.length;for(;t--;)this.initializeExtension(this._params.extensions[t],!0);this.gl.type==="webgl"?(this.createTexture_n=this.createTexture_n_webgl1.bind(this),this.createTexture_l=this.createTexture_l_webgl1.bind(this),this.createTexture_mm=this.createTexture_mm_webgl1.bind(this),this.createTexture_a=this.createTexture_a_webgl1.bind(this)):(this.createTexture_n=this.createTexture_n_webgl2.bind(this),this.createTexture_l=this.createTexture_l_webgl2.bind(this),this.createTexture_mm=this.createTexture_mm_webgl2.bind(this),this.createTexture_a=this.createTexture_a_webgl2.bind(this)),this.createTexture.NEAREST=this.createTexture_n,this.createTexture.LINEAR=this.createTexture_l,this.createTexture.MIPMAP=this.createTexture_mm,this.createTexture.ANISOTROPIC=this.createTexture_a,this.extensions.EXT_texture_filter_anisotropic?this.createTextureDefault=this.createTexture_a:this.createTextureDefault=this.createTexture_mm,this._initPrograms(),this._setDefaults(),this.intersectionObserver=new IntersectionObserver(s=>{this._toggleVisibilityChange(s[s.length-1].isIntersecting)},{threshold:0}),this.intersectionObserver.observe(this.canvas),this.resizeObserver=new ResizeObserver(s=>{this._toggleVisibilityChange(s[0].contentRect.width!==0&&s[0].contentRect.height!==0)}),this.resizeObserver.observe(this.canvas),document.addEventListener("visibilitychange",()=>{this._toggleVisibilityChange(document.visibilityState==="visible")})}_toggleVisibilityChange(t){t?(this.start(),this.ONCANVASRESIZE&&this.ONCANVASRESIZE(),this.events.dispatch(this.events.visibilitychange,!0)):(this.events.dispatch(this.events.visibilitychange,!1),this.stop())}_setDefaults(){let t=this.gl;t&&this.canvas&&(t.depthFunc(t.LESS),t.enable(t.DEPTH_TEST),this.setSize(this.canvas.clientWidth||this._params.width,this.canvas.clientHeight||this._params.height),t.frontFace(t.CCW),t.cullFace(t.BACK),t.enable(t.CULL_FACE),t.disable(t.BLEND),this.createDefaultTexture({color:"rgba(0,0,0,0.0)"},s=>{this.transparentTexture=s}),this.createDefaultTexture({color:"rgba(255, 255, 255, 1.0)"},s=>{this.defaultTexture=s}))}getCanvasSize(){return this._canvasSize}createStreamArrayBuffer(t,s,n,o=4){let a=this.gl,l=a.createBuffer();return a.bindBuffer(a.ARRAY_BUFFER,l),a.bufferData(a.ARRAY_BUFFER,s*t*o,n||a.STREAM_DRAW),a.bindBuffer(a.ARRAY_BUFFER,null),l.itemSize=t,l.numItems=s,l}setStreamArrayBuffer(t,s,n=0){let o=this.gl;return o.bindBuffer(o.ARRAY_BUFFER,t),o.bufferSubData(o.ARRAY_BUFFER,n,s),o.bindBuffer(o.ARRAY_BUFFER,null),t}createArrayBuffer(t,s,n,o){let a=this.gl,l=a.createBuffer();return a.bindBuffer(a.ARRAY_BUFFER,l),a.bufferData(a.ARRAY_BUFFER,t,o||a.STATIC_DRAW),a.bindBuffer(a.ARRAY_BUFFER,null),l.itemSize=s,l.numItems=n||t.length/s,l}createArrayBufferLength(t,s){let n=this.gl,o=n.createBuffer();return n.bindBuffer(n.ARRAY_BUFFER,o),n.bufferData(n.ARRAY_BUFFER,t,s||n.STATIC_DRAW),n.bindBuffer(n.ARRAY_BUFFER,null),o.itemSize=1,o.numItems=t,o}createElementArrayBuffer(t,s,n,o){let a=this.gl,l=a.createBuffer();return a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,l),a.bufferData(a.ELEMENT_ARRAY_BUFFER,t,o||a.STATIC_DRAW),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,null),l.itemSize=s,l.numItems=n||t.length,l}setSize(t,s){this._params.width=t,this._params.height=s,this.canvas&&(this.canvas.width=t*this._params.pixelRatio,this.canvas.height=s*this._params.pixelRatio,this._canvasSize[0]=this.canvas.width,this._canvasSize[1]=this.canvas.height,this.gl&&this.gl.viewport(0,0,t,s),this.ONCANVASRESIZE&&this.ONCANVASRESIZE(this.canvas),this.events.dispatch(this.events.resize,this))}get pixelRatio(){return this._params.pixelRatio}set pixelRatio(t){this._params.pixelRatio=t,this.setSize(this._params.width,this._params.height)}getWidth(){return this.canvas?this.canvas.width:0}getHeight(){return this.canvas?this.canvas.height:0}getClientAspect(){return this.canvas?this.canvas.clientWidth/this.canvas.clientHeight:0}getCenter(){let t=this.canvas;return t?new H(Math.round(.5*t.width),Math.round(.5*t.height)):new H}clearFrame(){let t=this.gl;t.clearColor(0,0,0,1),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT)}start(){!this._requestAnimationFrameId&&this._initialized&&this._animationFrameCallback()}stop(){this._requestAnimationFrameId&&(window.cancelAnimationFrame(this._requestAnimationFrameId),this._requestAnimationFrameId=0)}isStopped(){return!this._requestAnimationFrameId}isWebGl2(){return!!this.gl&&this.gl.type==="webgl2"}_animationFrameCallback(){this._requestAnimationFrameId=window.requestAnimationFrame(()=>{this._throttledDrawFrame(),this._requestAnimationFrameId&&this._animationFrameCallback()})}createDefaultTexture(t,s){let n,o;if(t&&t.color)n=new mi(2,2),n.fillColor(t.color),o=this.createTexture_n(n.getCanvas()),o.default=!0,s(o);else if(t&&t.url){let a=new Image,l=this;a.onload=function(){o=l.createTextureDefault(a),o.default=!0,s(o)},a.src=t.url}else n=new mi(2,2),n.fillColor("#C5C5C5"),o=this.createTexture_n(n.getCanvas()),o.default=!0,s(o)}deleteTexture(t){t&&!t.default&&this.gl&&this.gl.deleteTexture(t)}destroy(){var t,s;(t=this.resizeObserver)==null||t.disconnect(),(s=this.intersectionObserver)==null||s.disconnect(),this.stop();for(let o in this.programs)this.removeProgram(o);let n=this.gl;if(n){n.deleteTexture(this.transparentTexture),this.transparentTexture=null,n.deleteTexture(this.defaultTexture),this.defaultTexture=null,this.framebufferStack=new Js;let o=n.getParameter(n.MAX_VERTEX_ATTRIBS),a=n.createBuffer();n.bindBuffer(n.ARRAY_BUFFER,a);for(let c=0;c<o;++c)n.disableVertexAttribArray(c),n.vertexAttribPointer(c,4,n.FLOAT,!1,0,0),n.vertexAttrib1f(c,0);n.deleteBuffer(a);let l=n.getParameter(n.MAX_TEXTURE_IMAGE_UNITS);for(let c=0;c<l;++c)n.activeTexture(n.TEXTURE0+c),n.bindTexture(n.TEXTURE_CUBE_MAP,null),n.bindTexture(n.TEXTURE_2D,null);n.activeTexture(n.TEXTURE0),n.useProgram(null),n.bindBuffer(n.ARRAY_BUFFER,null),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),n.bindFramebuffer(n.FRAMEBUFFER,null),n.bindRenderbuffer(n.RENDERBUFFER,null),n.disable(n.BLEND),n.disable(n.CULL_FACE),n.disable(n.DEPTH_TEST),n.disable(n.DITHER),n.disable(n.SCISSOR_TEST),n.blendColor(0,0,0,0),n.blendEquation(n.FUNC_ADD),n.blendFunc(n.ONE,n.ZERO),n.clearColor(0,0,0,0),n.clearDepth(1),n.clearStencil(-1)}this.canvas&&(this.canvas.parentNode&&this.canvas.parentNode.removeChild(this.canvas),this.canvas.width=1,this.canvas.height=1,this.canvas=null),this.gl=null,this._initialized=!1}addClock(t){t.__handler||(t.__handler=this,this._clocks.push(t))}addClocks(t){for(let s=0;s<t.length;s++)this.addClock(t[s])}removeClock(t){if(t.__handler){let s=this._clocks,n=s.length;for(;n--;)if(s[n].isEqual(t)){t.__handler=null,s.splice(n,1);break}}}}class Ta extends hs{constructor(t,s={}){super(t,s),this._internalFormat=s.internalFormat?s.internalFormat.toUpperCase():"RGBA8",this._msaa=s.msaa!=null?s.msaa:4,this._glFilter=0,this.renderbuffers=new Array(this._size)}destroy(){let t=this.handler.gl;if(t){for(let s=0;s<this.renderbuffers.length;s++)t.deleteRenderbuffer(this.renderbuffers[s]);this.renderbuffers=new Array(this._size),t.deleteFramebuffer(this._fbo),t.deleteRenderbuffer(this._depthRenderbuffer),this._depthRenderbuffer=null,this._fbo=null,this._active=!1}}init(){let t=this.handler.gl;if(!t)return;this._glFilter=t[this._filter],this._fbo=t.createFramebuffer(),t.bindFramebuffer(t.FRAMEBUFFER,this._fbo);let s=[];for(let n=0;n<this.renderbuffers.length;n++){let o=t.createRenderbuffer();t.bindRenderbuffer(t.RENDERBUFFER,o),this._msaa>0?t.renderbufferStorageMultisample(t.RENDERBUFFER,this._msaa,t[this._internalFormat],this._width,this._height):t.renderbufferStorage(t.RENDERBUFFER,t[this._internalFormat],this._width,this._height),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0+n,t.RENDERBUFFER,o),s.push(t.COLOR_ATTACHMENT0+n),this.renderbuffers[n]=o,t.bindRenderbuffer(t.RENDERBUFFER,null)}t.drawBuffers(s),this._useDepth&&(this._depthRenderbuffer=t.createRenderbuffer(),t.bindRenderbuffer(t.RENDERBUFFER,this._depthRenderbuffer),t.renderbufferStorageMultisample(t.RENDERBUFFER,this._msaa,t[this._depthComponent],this._width,this._height),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,this._depthRenderbuffer),t.bindRenderbuffer(t.RENDERBUFFER,null)),t.bindFramebuffer(t.FRAMEBUFFER,null)}blitTo(t,s=0){let n=this.handler.gl;n.bindFramebuffer(n.READ_FRAMEBUFFER,this._fbo),n.bindFramebuffer(n.DRAW_FRAMEBUFFER,t._fbo),n.readBuffer(n.COLOR_ATTACHMENT0+s),n.clearBufferfv(n.COLOR,0,[0,0,0,1]),n.blitFramebuffer(0,0,this._width,this._height,0,0,t._width,t._height,n.COLOR_BUFFER_BIT,this._glFilter),n.bindFramebuffer(n.FRAMEBUFFER,null),n.bindFramebuffer(n.READ_FRAMEBUFFER,null),n.bindFramebuffer(n.DRAW_FRAMEBUFFER,null)}}Object.freeze(Object.defineProperty({__proto__:null,Framebuffer:Rt,Handler:Be,Multisample:Ta,Program:X,types:ht},Symbol.toStringTag,{value:"Module"}));class Ca extends Ai{constructor(t,s={}){super(t,s),this._image=s.image||null,this._src=s.src||null,this._onLoad_=null}get instanceName(){return"GeoImage"}abortLoading(){this._image instanceof HTMLImageElement&&(this._image.src="")}setSrc(t){this._planet&&this._planet._geoImageCreator.remove(this),this._src=t,this._sourceReady=!1,this._sourceCreated=!1,this._image=new Image,this._image.crossOrigin="Anonymous",this._onLoad_=this._onLoad.bind(this),this._image.addEventListener("load",this._onLoad_),this._image.src=t}setImage(t){this._planet&&this._planet._geoImageCreator.remove(this),this._sourceCreated=!1,this._sourceReady=!1,this._image=t,this._image.crossOrigin="Anonymous",this._src=t.src,ur(this._image)?this._applyImage(this._image):(this._onLoad_=this._onLoad.bind(this),this._image.addEventListener("load",this._onLoad_))}_createSourceTexture(){!this._sourceCreated&&this._image&&(this._sourceTexture=this._planet.renderer.handler.createTexture_l(this._image),this._sourceCreated=!0)}_onLoad(t){this._applyImage(this._image),this._image instanceof HTMLImageElement&&this._image.removeEventListener("load",this._onLoad_),this._onLoad_=null}_applyImage(t){t&&(this._frameWidth=$e(2*t.width,4096),this._frameHeight=$e(3*t.height,4096),this._sourceReady=!0,this._planet&&this._planet._geoImageCreator.add(this))}loadMaterial(t){t.isLoading=!0,this._creationProceeding=!0,!this._sourceReady&&this._src?this._image?this._image instanceof HTMLImageElement&&(ur(this._image)?this._applyImage(this._image):(this._onLoad_=this._onLoad.bind(this),this._image.addEventListener("load",this._onLoad_))):(this._image=new Image,this._image.crossOrigin="Anonymous",this._onLoad_=this._onLoad.bind(this),this._image.addEventListener("load",this._onLoad_),this._image.src=this._src):this._planet&&this._planet._geoImageCreator.add(this)}abortMaterialLoading(t){this._image&&this._image instanceof HTMLImageElement&&(this._image.src=""),this._creationProceeding=!1,t.isLoading=!1,t.isReady=!1}}Object.freeze(Object.defineProperty({__proto__:null,AtmosphereConfig:class extends Q{constructor(h={}){super(h),this.$maxOpacity=null,this.$minOpacity=null,this.$rayleight=null,this.$mie=null,this.$height=null,this.$bottomRadius=null,this.$mieScatteringCoefficient=null,this.$mieExtinctionCoefficient=null,this.$rayleighScatteringCoefficientA=null,this.$rayleighScatteringCoefficientB=null,this.$rayleighScatteringCoefficientC=null,this.$ozoneAbsorptionCoefficientA=null,this.$ozoneAbsorptionCoefficientB=null,this.$ozoneAbsorptionCoefficientC=null,this.$sunAngularRadius=null,this.$sunIntensity=null,this.$groundAlbedo=null,this.$ozoneDensityHeight=null,this.$ozoneDensityWide=null,this._toggleBtn=new dt({classList:["og-map-button","og-atmosphere_button"],icon:`<?xml version="1.0" encoding="utf-8"?><!-- Uploaded to: SVG Repo, www.svgrepo.com, Generator: SVG Repo Mixer Tools -->
<svg width="800px" height="800px" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><path fill="#000000" d="M135.688 18.5c-6.798 74.842-23.842 85.39-107.907 59.656 84.85 52.022 73.57 64.954-6.843 96.938 87.743-10.27 103.29 4.89 70.75 87.594 17.805-27.56 32.5-44.498 46.282-54.47-11.813 28.26-18.345 59.274-18.345 91.813 0 84.184 43.71 157.96 109.656 200.376-41.624-43.834-67.686-102.7-67.686-167.875 0-134.923 109.45-244.405 244.375-244.405 30.92 0 60.76 5.762 88 16.25-38.584-26.87-85.517-42.625-136.064-42.625-55.257 0-106.14 18.802-146.562 50.375 4.627-18.783 17.39-38.073 41.03-60.906C190.18 90.942 153.53 95.634 135.69 18.5zm10.03 77.188c5.67.002 11.428 1.247 16.876 3.874 14.506 6.998 22.72 21.81 22 36.938-10.26 10.87-19.507 22.696-27.594 35.344-9.035 2.753-19.075 2.27-28.25-2.156-19.37-9.343-27.5-32.6-18.156-51.97 6.715-13.92 20.638-22.036 35.125-22.03z"/></svg>`}),this._dialog=new Kt({title:"Atmosphere Parameters",visible:!1,useHide:!0,top:60,left:60,width:720}),this._dialog.events.on("visibility",t=>{this._toggleBtn.setActive(t)}),this._panel=new ut({template:`<div class="og-atmosphere og-options-container">
         
         <div class="og-option og-atmosphere-maxOpacity"></div> 
         <div class="og-option og-atmosphere-minOpacity"></div>
         
       <div class="og-emptyline-2"></div>
         
         <div class="og-option og-atmosphere-rayleight"></div>
         <div class="og-option og-atmosphere-mie"></div>
         
       <div class="og-emptyline-2"></div>
                  
         <div class="og-option og-atmosphere-height"></div> 
         <div class="og-option og-atmosphere-bottomRadius"></div>
         
       <div class="og-emptyline-2"></div>
         
         <div class="og-option og-atmosphere-mieScatteringCoefficient"></div>  
         <div class="og-option og-atmosphere-mieExtinctionCoefficient"></div>
         
       <div class="og-emptyline-2"></div>
         
         <div class="og-option og-atmosphere-rayleighScatteringCoefficientA"></div>    
         <div class="og-option og-atmosphere-rayleighScatteringCoefficientB"></div>    
         <div class="og-option og-atmosphere-rayleighScatteringCoefficientC"></div>
         
       <div class="og-emptyline-2"></div>
         
         <div class="og-option og-atmosphere-ozoneAbsorptionCoefficientA"></div>    
         <div class="og-option og-atmosphere-ozoneAbsorptionCoefficientB"></div>    
         <div class="og-option og-atmosphere-ozoneAbsorptionCoefficientC"></div>
         
       <div class="og-emptyline-2"></div>
         
         <div class="og-option og-atmosphere-ozoneDensityHeight"></div>    
         <div class="og-option og-atmosphere-ozoneDensityWide"></div>    
         
       <div class="og-emptyline-2"></div>
         
         <div class="og-option og-atmosphere-sunAngularRadius"></div> 
         <div class="og-option og-atmosphere-sunIntensity"></div> 
         <div class="og-option og-atmosphere-groundAlbedo"></div>
       
    </div>`}),this._maxOpacity=new Z({label:"Max.opacity",max:5}),this._minOpacity=new Z({label:"Min.opacity",max:5}),this._rayleight=new Z({label:"Rayleight Scale",min:-10,max:10}),this._mie=new Z({label:"Mie Scale",min:-10,max:10}),this._height=new Z({label:"Height",max:1e6}),this._bottomRadius=new Z({label:"Polar Radius (BOTTOM_RADIUS)",max:31783761571225896e-9}),this._equatorialRadius=new Z({label:"Equatorial Radius (EQUATORIAL_RADIUS)",max:31890685}),this._mieScatteringCoefficient=new Z({label:"Mie Scattering Coefficient e-6",min:-39.96,max:39.96}),this._mieExtinctionCoefficient=new Z({label:"Mie Extinction Coef.e-6",min:4.44*-10,max:10*4.44}),this._rayleighScatteringCoefficientA=new Z({label:"Rayleight Scattering Coef A.e-6",min:5.802*-10,max:10*5.802}),this._rayleighScatteringCoefficientB=new Z({label:"Rayleight Scattering Coef B.e-6",min:13.558*-10,max:10*13.558}),this._rayleighScatteringCoefficientC=new Z({label:"Rayleight Scattering Coef C.e-6",min:-331,max:331}),this._ozoneAbsorptionCoefficientA=new Z({label:"Ozone absorbtion Coef A.e-6",min:-6.5,max:6.5}),this._ozoneAbsorptionCoefficientB=new Z({label:"Ozone absorbtion Coef B.e-6",min:-6.5,max:18.81}),this._ozoneAbsorptionCoefficientC=new Z({label:"Ozone absorbtion Coef C.e-6",min:.085*-10,max:10*.085}),this._ozoneDensityHeight=new Z({label:"Ozone Density Height",max:25e5}),this._ozoneDensityWide=new Z({label:"Ozone Density Wide",max:25e5}),this._sunAngularRadius=new Z({label:"Sun Angular Radius",max:4.685}),this._sunIntensity=new Z({label:"Sun Intensity",max:10}),this._groundAlbedo=new Z({label:"Ground Albedo (GROUND_ALBEDO)",max:.5}),this._parameters={ATMOS_HEIGHT:0,RAYLEIGH_SCALE:0,MIE_SCALE:0,GROUND_ALBEDO:0,BOTTOM_RADIUS:0,EQUATORIAL_RADIUS:0,rayleighScatteringCoefficient_0:0,rayleighScatteringCoefficient_1:0,rayleighScatteringCoefficient_2:0,mieScatteringCoefficient:0,mieExtinctionCoefficient:0,ozoneAbsorptionCoefficient_0:0,ozoneAbsorptionCoefficient_1:0,ozoneAbsorptionCoefficient_2:0,SUN_ANGULAR_RADIUS:0,SUN_INTENSITY:0,ozoneDensityHeight:0,ozoneDensityWide:0,disableSunDisk:!1}}oninit(){this._toggleBtn.appendTo(this.renderer.div),this._dialog.appendTo(this.renderer.div),this._panel.appendTo(this._dialog.container),this._panel.el&&(this.$height=this._panel.el.querySelector(".og-option.og-atmosphere-height"),this.$maxOpacity=this._panel.el.querySelector(".og-option.og-atmosphere-maxOpacity"),this.$minOpacity=this._panel.el.querySelector(".og-option.og-atmosphere-minOpacity"),this.$rayleight=this._panel.el.querySelector(".og-option.og-atmosphere-rayleight"),this.$mie=this._panel.el.querySelector(".og-option.og-atmosphere-mie"),this.$bottomRadius=this._panel.el.querySelector(".og-option.og-atmosphere-bottomRadius"),this.$mieScatteringCoefficient=this._panel.el.querySelector(".og-option.og-atmosphere-mieScatteringCoefficient"),this.$mieExtinctionCoefficient=this._panel.el.querySelector(".og-option.og-atmosphere-mieExtinctionCoefficient"),this.$rayleighScatteringCoefficientA=this._panel.el.querySelector(".og-option.og-atmosphere-rayleighScatteringCoefficientA"),this.$rayleighScatteringCoefficientB=this._panel.el.querySelector(".og-option.og-atmosphere-rayleighScatteringCoefficientB"),this.$rayleighScatteringCoefficientC=this._panel.el.querySelector(".og-option.og-atmosphere-rayleighScatteringCoefficientC"),this.$ozoneAbsorptionCoefficientA=this._panel.el.querySelector(".og-option.og-atmosphere-ozoneAbsorptionCoefficientA"),this.$ozoneAbsorptionCoefficientB=this._panel.el.querySelector(".og-option.og-atmosphere-ozoneAbsorptionCoefficientB"),this.$ozoneAbsorptionCoefficientC=this._panel.el.querySelector(".og-option.og-atmosphere-ozoneAbsorptionCoefficientC"),this.$sunAngularRadius=this._panel.el.querySelector(".og-option.og-atmosphere-sunAngularRadius"),this.$sunIntensity=this._panel.el.querySelector(".og-option.og-atmosphere-sunIntensity"),this.$groundAlbedo=this._panel.el.querySelector(".og-option.og-atmosphere-groundAlbedo"),this.$ozoneDensityHeight=this._panel.el.querySelector(".og-option.og-atmosphere-ozoneDensityHeight"),this.$ozoneDensityWide=this._panel.el.querySelector(".og-option.og-atmosphere-ozoneDensityWide")),this._toggleBtn.events.on("change",h=>{this._dialog.setVisibility(h)}),this._maxOpacity.appendTo(this.$maxOpacity),this._minOpacity.appendTo(this.$minOpacity),this._height.appendTo(this.$height),this._rayleight.appendTo(this.$rayleight),this._mie.appendTo(this.$mie),this._bottomRadius.appendTo(this.$bottomRadius),this._equatorialRadius.appendTo(this.$bottomRadius),this._mieScatteringCoefficient.appendTo(this.$mieScatteringCoefficient),this._mieExtinctionCoefficient.appendTo(this.$mieExtinctionCoefficient),this._rayleighScatteringCoefficientA.appendTo(this.$rayleighScatteringCoefficientA),this._rayleighScatteringCoefficientB.appendTo(this.$rayleighScatteringCoefficientB),this._rayleighScatteringCoefficientC.appendTo(this.$rayleighScatteringCoefficientC),this._ozoneAbsorptionCoefficientA.appendTo(this.$ozoneAbsorptionCoefficientA),this._ozoneAbsorptionCoefficientB.appendTo(this.$ozoneAbsorptionCoefficientB),this._ozoneAbsorptionCoefficientC.appendTo(this.$ozoneAbsorptionCoefficientC),this._sunAngularRadius.appendTo(this.$sunAngularRadius),this._sunIntensity.appendTo(this.$sunIntensity),this._groundAlbedo.appendTo(this.$groundAlbedo),this._ozoneDensityHeight.appendTo(this.$ozoneDensityHeight),this._ozoneDensityWide.appendTo(this.$ozoneDensityWide),this.planet&&(this._parameters=this.planet.atmosphereControl.parameters,this._bottomRadius.max=5*this.planet.ellipsoid.getPolarSize(),this._equatorialRadius.max=5*this.planet.ellipsoid.getEquatorialSize(),this._height.value=this._parameters.ATMOS_HEIGHT,this._rayleight.value=this._parameters.RAYLEIGH_SCALE,this._mie.value=this._parameters.MIE_SCALE,this._bottomRadius.value=this._parameters.BOTTOM_RADIUS,this._equatorialRadius.value=this._parameters.EQUATORIAL_RADIUS,this._mieScatteringCoefficient.value=this._parameters.mieScatteringCoefficient,this._mieExtinctionCoefficient.value=this._parameters.mieExtinctionCoefficient,this._rayleighScatteringCoefficientA.value=this._parameters.rayleighScatteringCoefficient_0,this._rayleighScatteringCoefficientB.value=this._parameters.rayleighScatteringCoefficient_1,this._rayleighScatteringCoefficientC.value=this._parameters.rayleighScatteringCoefficient_2,this._ozoneAbsorptionCoefficientA.value=this._parameters.ozoneAbsorptionCoefficient_0,this._ozoneAbsorptionCoefficientB.value=this._parameters.ozoneAbsorptionCoefficient_1,this._ozoneAbsorptionCoefficientC.value=this._parameters.ozoneAbsorptionCoefficient_2,this._sunAngularRadius.value=this._parameters.SUN_ANGULAR_RADIUS,this._sunIntensity.value=this._parameters.SUN_INTENSITY,this._groundAlbedo.value=this._parameters.GROUND_ALBEDO,this._ozoneDensityHeight.value=this._parameters.ozoneDensityHeight,this._ozoneDensityWide.value=this._parameters.ozoneDensityWide),this._minOpacity.value=this.planet.atmosphereMinOpacity,this._minOpacity.events.on("change",h=>{this.planet.atmosphereMinOpacity=h}),this._maxOpacity.value=this.planet.atmosphereMaxOpacity,this._maxOpacity.events.on("change",h=>{this.planet.atmosphereMaxOpacity=h}),this._rayleight.events.on("change",h=>{this._parameters.RAYLEIGH_SCALE=h,this._update()}),this._mie.events.on("change",h=>{this._parameters.MIE_SCALE=h,this._update()}),this._height.events.on("change",h=>{this._parameters.ATMOS_HEIGHT=h,this._update()}),this._bottomRadius.events.on("change",h=>{this._parameters.BOTTOM_RADIUS=h,this._update()}),this._equatorialRadius.events.on("change",h=>{this._parameters.EQUATORIAL_RADIUS=h,this._update()}),this._mieScatteringCoefficient.events.on("change",h=>{this._parameters.mieScatteringCoefficient=h,this._update()}),this._mieExtinctionCoefficient.events.on("change",h=>{this._parameters.mieExtinctionCoefficient=h,this._update()}),this._rayleighScatteringCoefficientA.events.on("change",h=>{this._parameters.rayleighScatteringCoefficient_0=h,this._update()}),this._rayleighScatteringCoefficientB.events.on("change",h=>{this._parameters.rayleighScatteringCoefficient_1=h,this._update()}),this._rayleighScatteringCoefficientC.events.on("change",h=>{this._parameters.rayleighScatteringCoefficient_2=h,this._update()}),this._ozoneAbsorptionCoefficientA.events.on("change",h=>{this._parameters.ozoneAbsorptionCoefficient_0=h,this._update()}),this._ozoneAbsorptionCoefficientB.events.on("change",h=>{this._parameters.ozoneAbsorptionCoefficient_1=h,this._update()}),this._ozoneAbsorptionCoefficientC.events.on("change",h=>{this._parameters.ozoneAbsorptionCoefficient_2=h,this._update()}),this._sunAngularRadius.events.on("change",h=>{this._parameters.SUN_ANGULAR_RADIUS=h,this._update()}),this._sunIntensity.events.on("change",h=>{this._parameters.SUN_INTENSITY=h,this._update()}),this._groundAlbedo.events.on("change",h=>{this._parameters.GROUND_ALBEDO=h,this._update()}),this._ozoneDensityHeight.events.on("change",h=>{this._parameters.ozoneDensityHeight=h,this._update()}),this._ozoneDensityWide.events.on("change",h=>{this._parameters.ozoneDensityWide=h,this._update()})}_update(){this.planet&&this.planet.atmosphereControl.setParameters(this._parameters)}},CameraDepthHandler:class extends Q{constructor(h){super(h),this._skipPreRender=!1,this._depthHandlerCallback=t=>{if(!this.planet)return;let s=t.frameBuffer;if(s.handler.gl,s.activate(),this._quadTreeStrategy){let c=t.camera;this._skipPreRender&&this._quadTreeStrategy.collectRenderNodes(c),this._skipPreRender=!0,console.log(this._quadTreeStrategy._renderedNodes)}s.deactivate(),s.readPixelBuffersAsync();let n=this.getLonLatFromPixelTerrain(1,1),o=this.getLonLatFromPixelTerrain(s.width-1,1),a=this.getLonLatFromPixelTerrain(s.width-1,s.height-1),l=this.getLonLatFromPixelTerrain(1,s.height-1);n&&o&&a&&l&&this.cameraGeoImage.setCorners([[n.lon,n.lat],[o.lon,o.lat],[a.lon,a.lat],[l.lon,l.lat]])},this._frameComposer=new Fr,this._frameHandler=null,this.cameraGeoImage=new Ca(`cameraGeoImage:${this.__id}`,{src:"test4.jpg",corners:[[0,1],[1,1],[1,0],[0,0]],visibility:!0,isBaseLayer:!1,opacity:.7}),this._quadTreeStrategy=null}_createCamera(){return this.planet?new wa(this.planet,{frustums:[[100,1e9]],width:640,height:480,viewAngle:45}):new Pi({frustums:[[100,1e9]],width:640,height:480,viewAngle:45})}get camera(){if(this._frameHandler)return this._frameHandler.camera}oninit(){if(super.oninit(),!this.renderer)return;this.renderer.handler.addProgram(new X("camera_depth",{uniforms:{projectionMatrix:"mat4",viewMatrix:"mat4",height:"float",eyePositionHigh:"vec3",eyePositionLow:"vec3"},attributes:{aVertexPositionHigh:"vec3",aVertexPositionLow:"vec3"},vertexShader:`#version 300 es
            
            precision highp float;

            in vec3 aVertexPositionHigh;
            in vec3 aVertexPositionLow;

            uniform mat4 projectionMatrix;
            uniform mat4 viewMatrix;
            uniform vec3 eyePositionHigh;
            uniform vec3 eyePositionLow;
            uniform float height;

            void main(void) {

                mat4 viewMatrixRTE = viewMatrix;
                viewMatrixRTE[3] = vec4(0.0, 0.0, 0.0, 1.0);

                mat4 m = projectionMatrix * viewMatrixRTE;

                vec3 nh = height * normalize(aVertexPositionHigh + aVertexPositionLow);

                vec3 eyePosition = eyePositionHigh + eyePositionLow;
                vec3 vertexPosition = aVertexPositionHigh + aVertexPositionLow;

                vec3 highDiff = aVertexPositionHigh - eyePositionHigh;
                vec3 lowDiff = aVertexPositionLow - eyePositionLow + nh;
                
                gl_Position =  m * vec4(highDiff * step(1.0, length(highDiff)) + lowDiff, 1.0);    
            }`,fragmentShader:`#version 300 es
            
            precision highp float;        

            layout(location = 0) out vec4 depthColor;

            void main(void) {
                depthColor = vec4(gl_FragCoord.z, gl_FragCoord.z, gl_FragCoord.z, 1.0);
            }`})),this.planet&&this.planet.addLayer(this.cameraGeoImage);let h=new Rt(this.renderer.handler,{width:640,height:480,targets:[{internalFormat:"RGBA16F",type:"FLOAT",attachment:"COLOR_ATTACHMENT",readAsync:!0}],useDepth:!0});if(this._frameHandler=new to({camera:this._createCamera(),frameBuffer:h,frameHandler:this._depthHandlerCallback}),this.renderer.controls.CameraFrameComposer?this._frameComposer=this.renderer.controls.CameraFrameComposer:this.renderer.addControl(this._frameComposer),this._frameComposer.add(this._frameHandler),this.planet){const t={planet:this.planet,maxEqualZoomAltitude:this.planet.quadTreeStrategy.maxEqualZoomAltitude,minEqualZoomAltitude:this.planet.quadTreeStrategy.minEqualZoomAltitude,minEqualZoomCameraSlope:this.planet.quadTreeStrategy.minEqualZoomCameraSlope,transitionOpacityEnabled:!1};this._quadTreeStrategy=new this.planet.quadTreeStrategyPrototype(t),this._quadTreeStrategy.init(this.camera),this._quadTreeStrategy.preRender(),this._quadTreeStrategy.clearRenderedNodes(),this._skipPreRender=!1,this._quadTreeStrategy.preLoad()}}get framebuffer(){if(this._frameHandler)return this._frameHandler.frameBuffer}getCartesianFromPixelTerrain(h,t){if(this._frameHandler){let s=this._frameHandler.frameBuffer,n=this._frameHandler.camera,o=function(c,d,u,_){let f=new H(c,d),g=f.x/_.width,m=(_.height-f.y)/_.height,p=new Float32Array(4),x=0;if(_.readData(g,m,p,0),p[0]===0)return 0;let y=p[0],w=u.frustums[0].inverseProjectionMatrix,C=new et(2*g-1,2*m-1,2*y-1,1),T=w.mulVec4(C),P=u.unproject(g*u.width,(1-m)*u.height);return x=-T.z/T.w/P.dot(u.getForward()),x}(h,t,n,s);if(o===0)return;let a=h/s.width,l=(s.height-t)/s.height;return n.unproject(a*n.width,(1-l)*n.height).scaleTo(o).addA(n.eye)}}getLonLatFromPixelTerrain(h,t){if(this.planet){let s=this.getCartesianFromPixelTerrain(h,t);if(s)return this.planet.ellipsoid.cartesianToLonLat(s)}}activate(){super.activate()}deactivate(){super.deactivate()}},CameraFrameComposer:Fr,CameraFrameHandler:to,CameraLock:Jn,CompassButton:Ho,Control:Q,DebugInfo:class extends Q{constructor(h={}){h.name&&h.name!==""||(h.name="DebugInfo"),super(h),this.el=null,this._watch=h.watch||[],this._toggleBtn=new dt({classList:["og-map-button","og-debuginfo_button"],icon:`<?xml version="1.0" encoding="iso-8859-1"?>
<!-- Uploaded to: SVG Repo, www.svgrepo.com, Generator: SVG Repo Mixer Tools -->
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg fill="#000000" version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" 
	 width="800px" height="800px" viewBox="0 0 932.179 932.179"
	 xml:space="preserve">
<g>
	<path d="M61.2,341.538c4.9,16.8,11.7,33,20.3,48.2l-24.5,30.9c-8,10.1-7.1,24.5,1.9,33.6l42.2,42.2c9.1,9.1,23.5,9.899,33.6,1.899
		l30.7-24.3c15.8,9.101,32.6,16.2,50.1,21.2l4.6,39.5c1.5,12.8,12.3,22.4,25.1,22.4h59.7c12.8,0,23.6-9.601,25.1-22.4l4.4-38.1
		c18.8-4.9,36.8-12.2,53.7-21.7l29.7,23.5c10.1,8,24.5,7.1,33.6-1.9l42.2-42.2c9.1-9.1,9.9-23.5,1.9-33.6l-23.1-29.3
		c9.6-16.601,17.1-34.3,22.1-52.8l35.6-4.1c12.801-1.5,22.4-12.3,22.4-25.1v-59.7c0-12.8-9.6-23.6-22.4-25.1l-35.1-4.1
		c-4.801-18.3-12-35.8-21.199-52.2l21.6-27.3c8-10.1,7.1-24.5-1.9-33.6l-42.1-42.1c-9.1-9.1-23.5-9.9-33.6-1.9l-26.5,21
		c-17.2-10.1-35.601-17.8-54.9-23l-4-34.3c-1.5-12.8-12.3-22.4-25.1-22.4h-59.7c-12.8,0-23.6,9.6-25.1,22.4l-4,34.3
		c-19.8,5.3-38.7,13.3-56.3,23.8l-27.5-21.8c-10.1-8-24.5-7.1-33.6,1.9l-42.2,42.2c-9.1,9.1-9.9,23.5-1.9,33.6l23,29.1
		c-9.2,16.6-16.2,34.3-20.8,52.7l-36.8,4.2c-12.8,1.5-22.4,12.3-22.4,25.1v59.7c0,12.8,9.6,23.6,22.4,25.1L61.2,341.538z
		 M277.5,180.038c54.4,0,98.7,44.3,98.7,98.7s-44.3,98.7-98.7,98.7c-54.399,0-98.7-44.3-98.7-98.7S223.1,180.038,277.5,180.038z"/>
	<path d="M867.699,356.238l-31.5-26.6c-9.699-8.2-24-7.8-33.199,0.9l-17.4,16.3c-14.699-7.1-30.299-12.1-46.4-15l-4.898-24
		c-2.5-12.4-14-21-26.602-20l-41.1,3.5c-12.6,1.1-22.5,11.4-22.9,24.1l-0.799,24.4c-15.801,5.7-30.701,13.5-44.301,23.3
		l-20.799-13.8c-10.602-7-24.701-5-32.9,4.7l-26.6,31.7c-8.201,9.7-7.801,24,0.898,33.2l18.201,19.399
		c-6.301,14.2-10.801,29.101-13.4,44.4l-26,5.3c-12.4,2.5-21,14-20,26.601l3.5,41.1c1.1,12.6,11.4,22.5,24.1,22.9l28.1,0.899
		c5.102,13.4,11.801,26.101,19.9,38l-15.699,23.7c-7,10.6-5,24.7,4.699,32.9l31.5,26.6c9.701,8.2,24,7.8,33.201-0.9l20.6-19.3
		c13.5,6.3,27.699,11,42.299,13.8l5.701,28.2c2.5,12.4,14,21,26.6,20l41.1-3.5c12.6-1.1,22.5-11.399,22.9-24.1l0.9-27.601
		c15-5.3,29.199-12.5,42.299-21.399l22.701,15c10.6,7,24.699,5,32.9-4.7l26.6-31.5c8.199-9.7,7.799-24-0.9-33.2l-18.301-19.399
		c6.701-14.2,11.602-29.2,14.4-44.601l25-5.1c12.4-2.5,21-14,20-26.601l-3.5-41.1c-1.1-12.6-11.4-22.5-24.1-22.9l-25.1-0.8
		c-5.201-14.6-12.201-28.399-20.9-41.2l13.699-20.6C879.4,378.638,877.4,364.438,867.699,356.238z M712.801,593.837
		c-44.4,3.801-83.602-29.3-87.301-73.699c-3.801-44.4,29.301-83.601,73.699-87.301c44.4-3.8,83.602,29.301,87.301,73.7
		C790.301,550.938,757.199,590.138,712.801,593.837z"/>
	<path d="M205,704.438c-12.6,1.3-22.3,11.899-22.4,24.6l-0.3,25.3c-0.2,12.7,9.2,23.5,21.8,25.101l18.6,2.399
		c3.1,11.301,7.5,22.101,13.2,32.301l-12,14.8c-8,9.899-7.4,24.1,1.5,33.2l17.7,18.1c8.9,9.1,23.1,10.1,33.2,2.3l14.899-11.5
		c10.5,6.2,21.601,11.101,33.2,14.5l2,19.2c1.3,12.6,11.9,22.3,24.6,22.4l25.301,0.3c12.699,0.2,23.5-9.2,25.1-21.8l2.3-18.2
		c12.601-3.101,24.601-7.8,36-14l14,11.3c9.9,8,24.101,7.4,33.201-1.5l18.1-17.7c9.1-8.899,10.1-23.1,2.301-33.2L496.6,818.438
		c6.6-11,11.701-22.7,15.201-35l16.6-1.7c12.6-1.3,22.299-11.9,22.4-24.6l0.299-25.301c0.201-12.699-9.199-23.5-21.799-25.1
		l-16.201-2.1c-3.1-12.2-7.699-24-13.699-35l10.1-12.4c8-9.9,7.4-24.1-1.5-33.2l-17.699-18.1c-8.9-9.101-23.102-10.101-33.201-2.3
		l-12.101,9.3c-11.399-6.9-23.6-12.2-36.399-15.8l-1.601-15.7c-1.3-12.601-11.899-22.3-24.6-22.4l-25.3-0.3
		c-12.7-0.2-23.5,9.2-25.101,21.8l-2,15.601c-13.199,3.399-25.899,8.6-37.699,15.399l-12.5-10.2c-9.9-8-24.101-7.399-33.201,1.5
		l-18.2,17.801c-9.1,8.899-10.1,23.1-2.3,33.199l10.7,13.801c-6.2,11-11.1,22.699-14.3,35L205,704.438z M368.3,675.837
		c36.3,0.4,65.399,30.301,65,66.601c-0.4,36.3-30.301,65.399-66.601,65c-36.3-0.4-65.399-30.3-65-66.601
		C302.1,704.538,332,675.438,368.3,675.837z"/>
</g>
</svg>`}),this._dialog=new Kt({title:"Debug Info",visible:!1,useHide:!0,top:120,left:60,width:480}),this._dialog.events.on("visibility",t=>{this._toggleBtn.setActive(t)}),this._canvasTiles=new ss("Tile grid",{visibility:!0,isBaseLayer:!1,hideInLayerSwitcher:!0,drawTile:function(t,s){let n,o=document.createElement("canvas"),a=o.getContext("2d");o.width=256,o.height=256,a.clearRect(0,0,o.width,o.height),a.beginPath(),a.rect(0,0,o.width,o.height),a.lineWidth=2,a.strokeStyle="black",a.stroke(),n=t.segment.tileZoom>14?"26":"32",a.fillStyle="black",a.font="normal "+n+"px Verdana",a.textAlign="center",a.fillText(t.segment.tileX+","+t.segment.tileY+","+t.segment.tileZoom,o.width/2,o.height/2),s(o)}})}addWatches(h){for(let t=0;t<h.length;t++)this.addWatch(h[t])}addWatch(h){this._watch.push(h);let t=document.createElement("div");t.classList.add("og-watch-line"),t.innerHTML=`<div class="og-watch-label">${h.label}</div><div class="og-watch-value"></div>`,h.valEl=t.querySelector(".og-watch-value"),this.el.appendChild(t)}oninit(){var h;this._toggleBtn.appendTo(this.renderer.div),this._dialog.appendTo(this.renderer.div),this._toggleBtn.events.on("change",l=>{this._dialog.setVisibility(l)}),this.el=document.createElement("div"),this.el.className="og-debug-info";let t=document.createElement("div");t.classList.add("og-debuginfo_controls"),this.el.appendChild(t);let s=this._watch;this._watch=[];for(let l=0;l<s.length;l++)this.addWatch(s[l]);(h=this._dialog.container)==null||h.appendChild(this.el),this.renderer.events.on("draw",this._frame,this);let n=this.planet;n&&this.addWatches([{label:"Nodes count",frame:()=>n.quadTreeStrategy._renderedNodes.length},{label:"Planet._fadingNodes",frame:()=>n.quadTreeStrategy._fadingNodes.size},{label:"createdNodes",frame:()=>n._createdNodesCount},{label:"indexesCache",frame:()=>n._indexesCacheToRemoveCounter},{label:"distBeforeMemClear",frame:()=>Math.round(n._distBeforeMemClear)},{label:"maxZoom/minZoom",frame:()=>n.quadTreeStrategy.maxCurrZoom+" / "+(n==null?void 0:n.quadTreeStrategy.minCurrZoom)},{label:"viewExtent",frame:()=>n.getViewExtent().toString()},{label:"Mouse distance, m",frame:()=>{let l=n.getCartesianFromMouseTerrain();return l?n.camera.eye.distance(l).toFixed(3):""}},{label:"lodSize",frame:()=>Math.round(n.quadTreeStrategy.lodSize)},{label:"deltaTime/FPS",frame:()=>`<div style="width:70px"><div style="width:20px; float: left;">
                        ${Math.round(n.renderer.handler.deltaTime)}
                        </div> <div style="float: left">
                        ${Math.round(1e3/n.renderer.handler.deltaTime)}
                        </div></div>`},{label:"-------------------------"},{label:"Pitch, deg",frame:()=>(n.camera.getPitch()*J).toFixed(2)},{label:"Yaw, deg",frame:()=>(n.camera.getYaw()*J).toFixed(2)},{label:"Roll, deg",frame:()=>(n.camera.getRoll()*J).toFixed(2)},{label:"Lon, Lat",frame:()=>`<div style="width:190px">${n.camera._lonLat.lon.toFixed(7)}, ${n.camera._lonLat.lon.toFixed(7)}</div>`},{label:"height/alt, m",frame:()=>`<div style="width:190px">${n.camera._lonLat.height.toFixed(2)+" / "+n.camera.getAltitude().toFixed(2)}</div>`},{label:"cam.slope",frame:()=>n.camera.slope.toFixed(3)},{label:"-------------------------"},{label:"_renderCompleted / renderCompletedActivated",frame:()=>`${n.quadTreeStrategy._renderCompleted} / ${n.quadTreeStrategy._renderCompletedActivated}`},{label:"_terrainCompleted / terrainCompletedActivated",frame:()=>`${n.quadTreeStrategy._terrainCompleted} / ${n.quadTreeStrategy._terrainCompletedActivated}`},{label:"PlainWorker",frame:()=>n._plainSegmentWorker.pendingQueue.length},{label:"TileLoader",frame:()=>`${n._tileLoader.loading} ${n._tileLoader.queue.length}`},{label:"TerrainLoader",frame:()=>n.terrain&&!n.terrain.isEmpty?`${n.terrain.loader.loading}  ${n.terrain.loader.queue.length}`:""},{label:"TerrainWorker",frame:()=>n._terrainWorker.pendingQueue.length},{label:"NormalMapCreator",frame:()=>n._normalMapCreator.queueSize},{label:"VectorTileCreator",frame:()=>n._vectorTileCreator.queueSize}]);let o=new dt({classList:["og-debuginfo_controls-button"],icon:`<?xml version="1.0" encoding="utf-8"?>
<!-- Uploaded to: SVG Repo, www.svgrepo.com, Generator: SVG Repo Mixer Tools -->
<svg fill="#000000" width="800px" height="800px" viewBox="-7.5 0 32 32" version="1.1" xmlns="http://www.w3.org/2000/svg">
<title>lock</title>
<path d="M14.625 15.156h2.094c0.281 0 0.5 0.25 0.5 0.531v11c0 0.281-0.219 0.5-0.5 0.5h-16.219c-0.281 0-0.5-0.219-0.5-0.5v-11c0-0.281 0.219-0.531 0.5-0.531h2.031v-5.125c0-2.875 1.844-5.25 4.688-5.25h2.688c2.875 0 4.719 2.375 4.719 5.25v5.125zM5.188 15.156h6.813v-4.875c0-1.594-1.313-2.938-2.938-2.938h-0.969c-1.594 0-2.906 1.344-2.906 2.938v4.875zM7.156 24h2.906l-0.719-3.156c0.5-0.25 0.844-0.781 0.844-1.375 0-0.906-0.719-1.594-1.594-1.594s-1.563 0.688-1.563 1.594c0 0.594 0.344 1.125 0.844 1.375z"></path>
</svg>`,title:"Lock/Unlock quad tree"});o.appendTo(t),o.events.on("change",l=>{l?n.lockQuadTree():n.unlockQuadTree()});let a=new dt({classList:["og-debuginfo_controls-button"],icon:`<?xml version="1.0"?>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
    <path d="M 4 4 L 4 8 L 8 8 L 8 4 L 4 4 z M 10 4 L 10 8 L 14 8 L 14 4 L 10 4 z M 16 4 L 16 8 L 20 8 L 20 4 L 16 4 z M 4 10 L 4 14 L 8 14 L 8 10 L 4 10 z M 10 10 L 10 14 L 14 14 L 14 10 L 10 10 z M 16 10 L 16 14 L 20 14 L 20 10 L 16 10 z M 4 16 L 4 20 L 8 20 L 8 16 L 4 16 z M 10 16 L 10 20 L 14 20 L 14 16 L 10 16 z M 16 16 L 16 20 L 20 20 L 20 16 L 16 16 z"/>
</svg>`,title:"Show/Hide grid"});a.appendTo(t),a.events.on("change",l=>{l?this.planet.addLayer(this._canvasTiles):this._canvasTiles.remove()})}_frame(){this._watch.forEach(h=>{h.valEl&&(h.valEl.innerHTML=h.frame?String(h.frame()):"")})}},DrawingControl:kn,DrawingSwitcher:class extends Q{constructor(h={}){super({name:"DrawingSwitcher",...h}),this.drawingControl=new kn(h)}oninit(){this.planet.addControl(this.drawingControl),this._createMenu()}onactivate(){this.drawingControl.activate()}ondeactivate(){this.drawingControl.deactivate()}_createMenu(){let h=new dt({classList:["og-map-button","og-drawing-default_button"],icon:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M4 0l16 12.279-6.951 1.17 4.325 8.817-3.596 1.734-4.35-8.879-5.428 4.702z"/></svg>',name:"default",isActive:!0}),t=new dt({classList:["og-map-button","og-drawing-polygon_button"],icon:`<?xml version="1.0" encoding="utf-8"?>
<!-- Generator: Adobe Illustrator 24.1.3, SVG Export Plug-In . SVG Version: 6.00 Build 0)  -->
<svg version="1.1" id="Layer_2" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 viewBox="0 0 1024 1024" style="enable-background:new 0 0 1024 1024;" xml:space="preserve">
<g>
	<path d="M926.03,321.16c-16.02,0-31.11,3.94-44.48,10.79l-263.43-191.4c2.69-8.94,4.18-18.4,4.18-28.2
		c0-54.02-43.95-97.97-97.97-97.97c-54.03,0-97.98,43.95-97.98,97.97c0,9.81,1.49,19.27,4.18,28.21L155.75,340.18
		c-16.22-11.91-36.16-19.03-57.78-19.03C43.95,321.16,0,365.11,0,419.13c0,52.58,41.67,95.5,93.71,97.75l102.63,315.86
		c-24.28,17.85-40.13,46.52-40.13,78.9c0,54.02,43.95,97.98,97.98,97.98c37.54,0,70.18-21.25,86.62-52.34h367.26
		c16.44,31.08,49.08,52.34,86.63,52.34c54.03,0,97.98-43.95,97.98-97.98c0-32.46-15.94-61.21-40.33-79.05l104.11-320.4
		c39.15-12.84,67.54-49.68,67.54-93.07C1024,365.11,980.05,321.16,926.03,321.16z M828.05,911.65c0,8.5-3.3,16.19-8.55,22.09
		c-6.11,6.85-14.9,11.26-24.79,11.26c-13.65,0-25.37-8.26-30.52-20.02c-1.79-4.09-2.82-8.58-2.82-13.33
		c0-18.39,14.95-33.35,33.34-33.35c2.93,0,5.72,0.5,8.43,1.21c13.27,3.49,23.21,14.91,24.59,28.9
		C827.83,909.5,828.05,910.54,828.05,911.65z M790.48,813.89c-45.63,1.96-83.27,35.16-91.87,78.77H350.28
		c-8.62-43.69-46.38-76.93-92.11-78.79L155.59,498.19c24.41-17.84,40.36-46.59,40.36-79.06c0-8.9-1.3-17.49-3.53-25.7L468.57,192.8
		c15.84,11.01,35.05,17.52,55.76,17.52c20.71,0,39.92-6.5,55.76-17.52l256.56,186.4c-5.48,12.21-8.59,25.7-8.59,39.93
		c0,41.02,25.36,76.17,61.21,90.75L790.48,813.89z M254.19,945c-10.11,0-19.07-4.62-25.19-11.75c-5.01-5.84-8.15-13.32-8.15-21.6
		c0-0.91,0.2-1.76,0.27-2.66c1.14-14.18,11.08-25.8,24.43-29.41c2.78-0.75,5.64-1.28,8.65-1.28c18.38,0,33.33,14.96,33.33,33.35
		c0,4.74-1.03,9.24-2.82,13.33C279.55,936.74,267.83,945,254.19,945z M64.88,421.49c-0.06-0.79-0.24-1.55-0.24-2.35
		c0-16.41,11.93-30.01,27.55-32.76c1.89-0.33,3.8-0.58,5.78-0.58c11.94,0,22.35,6.36,28.24,15.81c3.18,5.11,5.11,11.09,5.11,17.53
		c0,15.47-10.63,28.39-24.94,32.14c-2.7,0.71-5.48,1.2-8.4,1.2C80.4,452.47,66.11,438.76,64.88,421.49z M549.41,90.62
		c5.07,5.85,8.25,13.39,8.25,21.72c0,7.32-2.44,14.03-6.45,19.54c-6.07,8.33-15.82,13.81-26.88,13.81
		c-11.07,0-20.83-5.48-26.89-13.81c-4.01-5.51-6.45-12.22-6.45-19.54c0-8.33,3.17-15.86,8.24-21.71
		c6.12-7.07,15.04-11.64,25.1-11.64C534.38,79,543.29,83.57,549.41,90.62z M959.36,419.13c0,11.94-6.36,22.35-15.82,28.24
		c-5.1,3.18-11.07,5.1-17.52,5.1c-6.08,0-11.71-1.76-16.62-4.61c-9.71-5.64-16.33-15.94-16.64-27.89c-0.01-0.29-0.09-0.56-0.09-0.85
		c0-11.75,6.14-22.05,15.36-28c5.2-3.35,11.35-5.35,17.99-5.35C944.41,385.78,959.36,400.75,959.36,419.13z"/>
</g>
</svg>`,name:"polygon"}),s=new dt({classList:["og-map-button","og-drawing-linestring_button"],icon:`<?xml version="1.0" encoding="utf-8"?><!-- License: MIT. Made by Esri: https://github.com/Esri/calcite-ui-icons -->
    <svg width="800px" height="800px" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M21 6h.046l-5.25 9h-.944L10 9.455V7H7v2.926L1.862 18H0v3h3v-2.926L8.138 10h1.01L14 15.545V18h3v-3h-.046l5.25-9H24V3h-3zM8 8h1v1H8zM2 20H1v-1h1zm14-3h-1v-1h1zm7-13v1h-1V4z"/></svg>`,name:"linestring"});new jo({buttons:[h,t,s]}).events.on("change",n=>{switch(this.drawingControl.deactivate(),n.name){case"polygon":this.drawingControl.activatePolygonDrawing();break;case"linestring":this.drawingControl.activateLineStringDrawing()}}),h.appendTo(this.renderer.div),t.appendTo(this.renderer.div),s.appendTo(this.renderer.div)}},EarthCoordinates:da,ElevationProfileControl:class extends Q{constructor(h={}){super({name:"ElevationProfileControl",...h}),this._onSceneChange=()=>{this._collectProfileThrottled()},this._onElevationProfilePointer=(t,s,n,o,a,l,c,d)=>{let u=this._elevationProfileScene.getPointLonLat(l),_=this._elevationProfileScene.getPointLonLat(l+1),f=this.planet.ellipsoid.lonLatToCartesian(u),g=this.planet.ellipsoid.lonLatToCartesian(_),m=(t-s[0])/(n[0]-s[0]),p=g.sub(f);this._elevationProfileScene.setPointerCartesian3v(f.add(p.scale(m)),d)},this._onElevationProfileDblClick=(t,s,n,o,a,l,c,d)=>{let u=this._elevationProfileScene.getPointLonLat(l),_=this._elevationProfileScene.getPointLonLat(l+1),f=this.planet.ellipsoid.lonLatToCartesian(u),g=this.planet.ellipsoid.lonLatToCartesian(_),m=(t-s[0])/(n[0]-s[0]),p=g.sub(f),x=f.add(p.scale(m));this.planet.camera.flyDistance(x,this.planet.camera.eye.distance(x))},this._onElevationProfileMouseEnter=()=>{this._elevationProfileView.model.pointsReady&&this._elevationProfileScene.setPointerVisibility(!0)},this._onElevationProfileMouseLeave=()=>{},this._elevationProfileScene=new ih,this._elevationProfileView=new $l,this._elevationProfileLegend=new ah,this._elevationProfileButtonsView=new nh({model:this._elevationProfileView.model}),this._elevationProfileView.events.on("pointer",this._onElevationProfilePointer),this._elevationProfileView.events.on("dblclick",this._onElevationProfileDblClick),this._elevationProfileView.events.on("mouseenter",this._onElevationProfileMouseEnter),this._elevationProfileView.events.on("mouseleave",this._onElevationProfileMouseLeave),this._dialog=new Kt({title:"Elevation Profile",visible:!1,resizable:!0,useHide:!0,top:175,left:65,width:400,height:200,minHeight:100,minWidth:100}),this._graphView=new ut({template:`<div class="og-elevationprofile__container">
      <div class="og-elevationprofile__menu"></div>
      <div class="og-elevationprofile__graph"></div>
    </div>`}),this._poiListDialog=new oh({model:this._elevationProfileScene}),this._toggleBtn=new dt({classList:["og-map-button","og-elevationprofile_button"],icon:'<svg style="width: 2em; height: 2em;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"><path d="M128 896v-158.293333l331.946667-191.573334 160.853333 93.866667L896 480V896H128M896 381.44l-275.2 159.146667-160.853333-92.586667L128 640v-94.293333l331.946667-191.573334 160.853333 93.866667L896 288v93.44z" fill="" /></svg>'}),this._collectProfileThrottled=yi(()=>{let t=this._elevationProfileScene.getPointsLonLat();this._elevationProfileView.model.collectProfile(t)},250)}oninit(){this._dialog.appendTo(this.planet.renderer.div),this._graphView.appendTo(this._dialog.container),this._toggleBtn.appendTo(this.renderer.div),this._dialog.events.on("visibility",h=>{this._toggleBtn.setActive(h),h?(this.activate(),this._elevationProfileView.resize()):this.deactivate()}),this._toggleBtn.events.on("change",h=>{this._dialog.setVisibility(h)}),this._elevationProfileView.appendTo(this._graphView.select(".og-elevationprofile__graph")),this._elevationProfileView.model.bindPlanet(this.planet),this._elevationProfileView.model.events.on("clear",()=>{this._elevationProfileScene.clear(),this._elevationProfileLegend.clear()}),this._elevationProfileView.model.events.on("startcollecting",()=>{this._elevationProfileScene.setPointerVisibility(!1)}),this._elevationProfileView.events.on("tracklength",h=>{this._elevationProfileLegend.setTrackLength(h)}),this._elevationProfileView.events.on("groundlength",h=>{this._elevationProfileLegend.setGroundLength(h)}),this._elevationProfileView.events.on("warninglength",h=>{this._elevationProfileLegend.setWarningLength(h)}),this._elevationProfileView.events.on("collisionlength",h=>{this._elevationProfileLegend.setCollisionLength(h)}),this._poiListDialog.appendTo(this.planet.renderer.div),this._poiListDialog.events.on("visibility",h=>{this._elevationProfileButtonsView.pointListBtn.setActive(h,!0)}),this._elevationProfileLegend.appendTo(this._graphView.select(".og-elevationprofile__menu")),this._elevationProfileButtonsView.appendTo(this._graphView.select(".og-elevationprofile__menu")),this._elevationProfileButtonsView.events.on("list",h=>{this._poiListDialog.setVisibility(h)}),this._elevationProfileButtonsView.events.on("location",h=>{this._elevationProfileScene.flyExtent()}),this._elevationProfileButtonsView.events.on("reset",h=>{this._elevationProfileScene.setPointerVisibility(!1)}),this._elevationProfileScene.events.on("change",this._onSceneChange)}onactivate(){this.planet&&this._elevationProfileScene.bindPlanet(this.planet),this.renderer&&this.renderer.addNode(this._elevationProfileScene)}ondeactivate(){this._poiListDialog.setVisibility(!1),this._elevationProfileView.model.clear(),this.renderer&&this.renderer.removeNode(this._elevationProfileScene),this._dialog.hide()}},FramebufferPreview:class extends Q{constructor(h){super({autoActivate:!0,...h}),this._onDraw=()=>{if(this._framebuffer&&this._screenFramebuffer){let t=this.renderer,s=t.handler.gl;s.disable(s.BLEND),this._screenFramebuffer.activate();let n=this._program._programController,o=n._program;s.bindBuffer(s.ARRAY_BUFFER,t.screenFramePositionBuffer),s.vertexAttribPointer(o.attributes.corners,2,s.FLOAT,!1,0,0),n.activate(),s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,this._framebuffer.textures[this.framebufferCurrentTexture]),s.uniform1i(o.uniforms.inputTexture,0),s.drawArrays(s.TRIANGLE_STRIP,0,4),this._screenFramebuffer.deactivate(),s.enable(s.BLEND),this._screenFramebuffer.readPixelBuffersAsync(a=>{let l=a.getPixelBufferData();if(l){let c=a.width,d=a.height,u=this.$canvas.getContext("2d"),_=new Uint8ClampedArray(l.buffer,l.byteOffset,l.byteLength),f=new ImageData(_,c,d);createImageBitmap(f).then(g=>{u.clearRect(0,0,this.$canvas.width,this.$canvas.height),u.drawImage(g,0,0,this.$canvas.width,this.$canvas.height)})}})}},this._dialog=new Kt({title:h.title||"",width:580,height:340,left:100,top:100}),this.$canvas=function(t,s){let n=document.createElement("canvas");return n.width=t,n.height=s,n.style.position="absolute",n.style.width="100%",n.style.height="100%",n}(this._dialog.width,this._dialog.height),this._framebuffer=h.framebuffer||null,this._screenFramebuffer=null,this.framebufferCurrentTexture=0,this._program=function(t=0,s,n,o){return new X(`framebuffer_dialog_screen:${t.toString()}`,{uniforms:{inputTexture:"sampler2D"},attributes:{corners:"vec2"},vertexShader:`#version 300 es
            
            in vec2 corners;
            
            out vec2 tc;

            void main(void) {
                gl_Position = vec4(corners, 0.0, 1.0);
                tc = corners * 0.5 + 0.5;
                ${o?"tc.y = 1.0 - tc.y;":""}               
            }`,fragmentShader:`#version 300 es

            precision highp float;

            uniform sampler2D inputTexture;
           
            in vec2 tc;

            layout(location = 0) out vec4 fragColor;

            ${s||""}
            
            ${n||`void mainImage(out vec4 fragColor, in vec2 fragCoord) { 
                fragColor = texture(inputTexture, fragCoord);
            }`}
            
            void main(void) {                              
               mainImage(fragColor, tc);
            }`})}(this.__id,h.common,h.image,h.flippedUV)}bindFramebuffer(h){h.isEqual(this._framebuffer)||(this._framebuffer=h)}oninit(){var h,t;super.oninit(),this.renderer&&(this.renderer.handler.addProgram(this._program),this._screenFramebuffer=new Rt(this.renderer.handler,{width:(h=this._framebuffer)==null?void 0:h.width,height:(t=this._framebuffer)==null?void 0:t.height,useDepth:!1,targets:[{internalFormat:"RGBA",type:"UNSIGNED_BYTE",attachment:"COLOR_ATTACHMENT",readAsync:!0}]}),this._screenFramebuffer.init())}activate(){var h,t;super.activate(),this._dialog.appendTo(document.body),(h=this._dialog.container)==null||h.appendChild(this.$canvas),(t=this.renderer)==null||t.events.on("draw",this._onDraw)}deactivate(){var h;super.deactivate(),this._dialog.remove(),(h=this.renderer)==null||h.events.off("draw",this._onDraw)}},GeoImageDragControl:class extends Q{constructor(h={}){super(h),this._cornerIndex=-1,this._catchCorner=!1,this._toggleBtn=new dt({classList:["og-map-button","og-geoimagegrag_button"],icon:'<?xml version="1.0" encoding="UTF-8" standalone="no"?> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path d="M16 13l6.964 4.062-2.973.85 2.125 3.681-1.732 1-2.125-3.68-2.223 2.15L16 13zm-2-7h2v2h5a1 1 0 0 1 1 1v4h-2v-3H10v10h4v2H9a1 1 0 0 1-1-1v-5H6v-2h2V9a1 1 0 0 1 1-1h5V6zM4 14v2H2v-2h2zm0-4v2H2v-2h2zm0-4v2H2V6h2zm0-4v2H2V2h2zm4 0v2H6V2h2zm4 0v2h-2V2h2zm4 0v2h-2V2h2z" fill="#000"/></svg>'})}oninit(){this._toggleBtn.appendTo(this.renderer.div),this.planet.events.on("layeradd",h=>{this.isActive()&&this._bindLayer(h)},this),this._toggleBtn.events.on("change",h=>{h?this.activate():this.deactivate()})}onactivate(){super.onactivate();const h=this.planet;for(let t=0;t<h.layers.length;t++)this._bindLayer(h.layers[t])}ondeactivate(){super.ondeactivate();const h=this.planet;for(let t=0;t<h.layers.length;t++)this._unbindLayer(h.layers[t])}_bindLayer(h){h instanceof Ai&&(h.events.on("mousemove",this._onMouseMove,this),h.events.on("mouseleave",this._onMouseLeave,this),h.events.on("ldown",this._onLDown,this),h.events.on("lup",this._onLUp,this))}_unbindLayer(h){h instanceof Ai&&(h.events.off("mousemove",this._onMouseMove),h.events.off("mouseleave",this._onMouseLeave),h.events.off("ldown",this._onLDown),h.events.off("lup",this._onLUp))}_onLUp(h){this._catchCorner=!1,h.renderer.controls.navigation.activate()}_onLDown(h){this._cornerIndex!==-1&&(this._catchCorner=!0,h.renderer.controls.navigation.deactivate())}_onMouseLeave(){document.body.style.cursor="auto"}_onMouseMove(h){let t=h.pickingObject;const s=this.planet;if(this._catchCorner){let n=t.getCornersLonLat();n[this._cornerIndex]=s.getLonLatFromPixelTerrain(h),t.setCornersLonLat(n)}else{this._cornerIndex=-1;for(let n=0;n<t._cornersWgs84.length;n++){let o=s.getLonLatFromPixelTerrain(h);if(o&&s.ellipsoid.getGreatCircleDistance(t._cornersWgs84[n],o)/s.getDistanceFromPixel(h)<=.05){this._cornerIndex=n,document.body.style.cursor="move";break}document.body.style.cursor="auto"}}}},GeoObjectEditor:class extends Q{constructor(h={}){super(h),this._geoObjectEditopScene=new gh({name:`geoObjectEditorScene:${this.__id}`}),this._dialog=new xh({model:this._geoObjectEditopScene})}oninit(){this.renderer&&(this.renderer.addControl(new Jn({planet:this.planet})),this._geoObjectEditopScene.bindPlanet(this.planet),this._dialog.appendTo(this.renderer.div||document.body),this.activate())}onactivate(){this.renderer&&this.renderer.addNode(this._geoObjectEditopScene)}ondeactivate(){this.renderer&&this.renderer.removeNode(this._geoObjectEditopScene),this._dialog.hide()}},HeightRuler:Hn,KeyboardNavigation:class extends Q{constructor(h={}){h=h||{},super({name:"KeyboardNavigation",...h}),this.onCameraPitchUp=()=>{this._camera&&this._camera.setPitch(this._camera.getPitch()+.1*j)},this.onCameraPitchDown=()=>{this._camera&&this._camera.setPitch(this._camera.getPitch()-.1*j)},this.onCameraYawLeft=()=>{this._camera&&this._camera.setYaw(this._camera.getYaw()-.1*j)},this.onCameraYawRight=()=>{this._camera&&this._camera.setYaw(this._camera.getYaw()+.1*j)},this.onCameraMoveForward=()=>{this._camera&&this.force.addA(this._camera.getForward()).normalize()},this.onCameraMoveBackward=()=>{this._camera&&this.force.addA(this._camera.getBackward()).normalize()},this._camera=h.camera||null,this.speed=h.speed||10,this.force=new v,this.vel=new v,this.mass=1}bindCamera(h){this._camera=h}onactivate(){let h=this.renderer;h.events.on("keypress",W.KEY_S,this.onCameraMoveBackward,this),h.events.on("keypress",W.KEY_W,this.onCameraMoveForward,this),h.events.on("keypress",W.KEY_UP,this.onCameraPitchUp,this),h.events.on("keypress",W.KEY_DOWN,this.onCameraPitchDown,this),h.events.on("keypress",W.KEY_LEFT,this.onCameraYawLeft,this),h.events.on("keypress",W.KEY_RIGHT,this.onCameraYawRight,this),h.events.on("draw",this.onDraw,this,-1e3)}ondeactivate(){this.renderer}oninit(){this.activate()}get dt(){return .001*this.renderer.handler.deltaTime}onDraw(){if(this.renderer&&this._camera){let h=this.force.scale(1/this.mass);this.vel.addA(h),this.vel.scale(.96),this.force.set(0,0,0);let t=this._camera;t.eye=t.eye.add(this.vel.scaleTo(this.dt)),t.update()}}},LayerAnimation:class extends Q{constructor(h={}){super(h),this._currVisibleIndex=0,this._onViewchange=()=>{this._timeoutStart=performance.now()},this._onVisibilityChange=t=>{t||this.pause()},this._onLayerLoadend=t=>{let s=this._layersArr[this._currentIndex];if(s&&s.isEqual(t)){let n=this._getFrameIndex(this._currentIndex)*this._frameSize,o=this._currentIndex;for(let l=n;l<o;l++){let c=this._layersArr[l];c.opacity=0,c.setVisibility(!1)}s.opacity=1;let a=this._layersArr[this._currVisibleIndex];if(a){a.opacity=0,a.setVisibility(!1);let l=this._getFrameIndex(this._currVisibleIndex);this._getFrameIndex(this._currentIndex)!==l&&this._removeFrameFromPlanet(l)}this.events.dispatch(this.events.idle,s)}},this.events=lt(Tl),this._name=h.name||`layerAnimation-${this.__id}`,this._layersArr=h.layers?[].concat(h.layers):[],this._currentIndex=-1,this._playInterval=h.playInterval||120,this._playIntervalHandler=-1,this._playIndex=0,this._frameSize=h.frameSize||50,this.repeat=h.repeat==null||h.repeat,this.skipTimeout=h.skipTimeout||5e3,this._timeoutStart=0}_getFramesNum(){return Math.ceil(this._layersArr.length/this._frameSize)}_setFrame(h){for(let t=0,s=this._getFramesNum();t<s;t++)t!==h?this._removeFrameFromPlanet(t):this._appendFrameToPlanet(t)}_getFrameIndex(h){return Math.floor(h/this._frameSize)}_appendFrameToPlanet(h){if(this.planet){let t=h*this._frameSize,s=t+this._frameSize;for(let n=t,o=s>this._layersArr.length?this._layersArr.length:s;n<o;n++)this.planet.addLayer(this._layersArr[n])}}_removeFrameFromPlanet(h){if(this.planet){let t=h*this._frameSize,s=t+this._frameSize;for(let n=t,o=s>this._layersArr.length?this._layersArr.length:s;n<o;n++)this._layersArr[n].abortLoading(),this._layersArr[n].remove(),this._layersArr[n].setVisibility(!1)}}oninit(){super.oninit(),this.onactivate(),this._initLayers(),this.planet.events.on("layerloadend",this._onLayerLoadend),this._setCurrentIndexAsync(0,!1,!0)}onactivate(){super.onactivate(),this.planet.camera.events.on("viewchange",this._onViewchange),this.planet.renderer.handler.events.on("visibilitychange",this._onVisibilityChange)}ondeactivate(){super.ondeactivate(),this.planet.camera.events.off("viewchange",this._onViewchange);for(let h=0;h<this._layersArr.length;h++)this._layersArr[h].setVisibility(!1);this.planet.events.off("layerloadend",this._onLayerLoadend),this.planet.renderer.handler.events.off("visibilitychange",this._onVisibilityChange)}clear(){this.stop(),this._currentIndex=-1,this._currVisibleIndex=-1;let h=this._layersArr;this._layersArr=[];for(let t=0;t<h.length;t++)h[t].remove()}_initLayers(){if(this.planet){for(let h=0,t=this._layersArr.length;h<t;h++){let s=this._layersArr[h];s.setVisibility(!1),s.setBaseLayer(!1),s.opacity=0}this._appendFrameToPlanet(0)}}setLayers(h){this.clear(),this._layersArr=[].concat(h),this._initLayers()}appendLayer(h){var t;this._layersArr.push(h),h.setVisibility(!1),h.setBaseLayer(!1),h.opacity=0,(t=this.planet)==null||t.addLayer(h)}get isIdle(){let h=this._layersArr[this._currentIndex];return h&&h.isIdle||!h}get playInterval(){return this._playInterval}set playInterval(h){h!==this._playInterval&&(this._playInterval=h,this.isPlaying&&(this.pause(),this.play()))}get isPlaying(){return this._playIntervalHandler!==-1}get layers(){return this._layersArr}_checkEnd(){this._playIndex>this._layersArr.length&&(this.repeat?this._playIndex=0:this.pause())}play(){this.isPlaying||(this._currentIndex>=this._layersArr.length-1&&this.stop(),this._timeoutStart=performance.now(),this._playIntervalHandler=setInterval(()=>{this._checkEnd(),this._setCurrentIndexAsync(this._playIndex,!1,!1),requestAnimationFrame(()=>{(this.isIdle||performance.now()-this._timeoutStart>this.skipTimeout)&&(this._playIndex++,this._timeoutStart=performance.now())})},this._playInterval),this.events.dispatch(this.events.play))}stop(){this._playIndex>0&&(this._clearInterval(),this._playIndex=0,this.setCurrentIndex(0),this.events.dispatch(this.events.stop))}pause(){this.isPlaying&&(this._clearInterval(),this.events.dispatch(this.events.pause))}_clearInterval(){clearInterval(this._playIntervalHandler),this._playIntervalHandler=-1}setCurrentIndex(h,t=!1){this._setCurrentIndexAsync(h,!0,t)}_setCurrentIndexAsync(h,t=!1,s=!1){if(h!=this._currentIndex&&h>=0&&h<this._layersArr.length){let n=this._currentIndex;this._currentIndex=h,this._playIndex=h;let o=this._getFrameIndex(n),a=this._getFrameIndex(this._currentIndex),l=this._layersArr[n],c=this._layersArr[h],d=a!=o;d&&this._appendFrameToPlanet(a),l&&(l.isIdle?this._currVisibleIndex=n:(l.opacity=0,l.setVisibility(!1))),c&&(c.opacity=0,c.setVisibility(!0),requestAnimationFrame(()=>{if(c.isIdle||t){c.opacity=1,d&&this._removeFrameFromPlanet(o),l&&(l.opacity=0,l.setVisibility(!1));let u=this._layersArr[this._currVisibleIndex];u&&(u.opacity=0,u.setVisibility(!1))}}),s||this.events.dispatch(this.events.change,this._currentIndex,n))}}},LayerSwitcher:class extends Q{constructor(h={}){super({name:"LayerSwitcher",...h}),this.addLayer=t=>{if(!t.hideInLayerSwitcher){let s=this._createLayerButton(t);this._layerViews.push(s),t.isBaseLayer()?s.appendTo(this.$baseLayers):s.appendTo(this.$overlays)}},this.removeLayer=t=>{for(let s=0;s<this._layerViews.length;s++){let n=this._layerViews[s];if(n.model.isEqual(t)){n.remove(),this._layerViews.splice(s,1);break}}},this._dialog=new Kt({title:"Layer Switcher",top:15,useHide:!0,visible:!1,width:300,maxHeight:500}),this._panel=new ut({template:`<div class="og-layerSwitcher">
      <div class="og-layerSwitcher__title">Base Layers</div>
      <div class="og-layerSwitcher__list og-layerSwitcher__baseLayers"></div>        
        
      <div class="og-layerSwitcher__title">Overlays</div>
      <div class="og-layerSwitcher__list og-layerSwitcher__overlays"></div>
         
    </div>`}),this._toggleBtn=new dt({classList:["og-map-button","og-layerSwitcher_button"],icon:`<?xml version="1.0" encoding="utf-8"?>
<!-- Svg Vector Icons : http://www.onlinewebfonts.com/icon -->
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 1000 1000" enable-background="new 0 0 1000 1000" xml:space="preserve">
<metadata> Svg Vector Icons : http://www.onlinewebfonts.com/icon </metadata>
<g><path d="M500,573.5c-3.2,0-6.5-0.6-9.5-1.9L25,375.6c-9.1-3.8-15-12.7-15-22.6s5.9-18.8,15-22.6l465.5-196c6.1-2.5,12.9-2.5,19,0l465.5,196c9.1,3.8,15,12.7,15,22.6s-5.9,18.8-15,22.6l-465.5,196C506.5,572.9,503.2,573.5,500,573.5L500,573.5z M97.6,353L500,522.4L902.4,353L500,183.6L97.6,353L97.6,353z"/><path d="M500,720.5c-3.2,0-6.5-0.6-9.5-1.9L25,522.6c-12.4-5.2-18.3-19.6-13.1-32.1c5.2-12.5,19.6-18.3,32.1-13.1l456,192l456-192c12.4-5.2,26.9,0.6,32.1,13.1s-0.6,26.9-13.1,32.1l-465.5,196C506.5,719.9,503.2,720.5,500,720.5L500,720.5z"/><path d="M500,867.5c-3.2,0-6.5-0.6-9.5-1.9L25,669.6c-12.4-5.2-18.3-19.6-13.1-32.1c5.2-12.5,19.6-18.3,32.1-13.1l456,192l456-192c12.4-5.2,26.9,0.6,32.1,13.1c5.2,12.5-0.6,26.8-13.1,32.1l-465.5,196C506.5,866.9,503.2,867.5,500,867.5L500,867.5z"/></g>
</svg>`}),this.$baseLayers=null,this.$overlays=null,this._layerViews=[]}oninit(){this._toggleBtn.appendTo(this.renderer.div),this._dialog.appendTo(this.planet.renderer.div),this._panel.appendTo(this._dialog.container),this.$baseLayers=this._panel.el.querySelector(".og-layerSwitcher__baseLayers"),this.$overlays=this._panel.el.querySelector(".og-layerSwitcher__overlays"),this._dialog.setPosition(this.planet.renderer.div.clientWidth-this._dialog.width-67),this._dialog.events.on("visibility",h=>{this._toggleBtn.setActive(h)}),this._toggleBtn.events.on("change",h=>{this._dialog.setVisibility(h)}),this.planet.events.on("layeradd",this.addLayer,this),this.planet.events.on("layerremove",this.removeLayer,this),this._initLayers()}_initLayers(){let h=this.planet.layers;for(let t=0;t<h.length;t++)this.addLayer(h[t])}_createLayerButton(h){return new Cl({model:h})}onactivate(){}ondeactivate(){this._dialog.hide()}},Lighting:class extends Q{constructor(h={}){super(h),this._selectedLayer=null,this._toggleBtn=new dt({classList:["og-map-button","og-lighting_button"],icon:`<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="256" height="256" viewBox="0 0 256 256" xml:space="preserve">

<defs>
</defs>
<g style="stroke: none; stroke-width: 0; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; opacity: 1;" transform="translate(1.4065934065934016 1.4065934065934016) scale(2.81 2.81)" >
	<path d="M 45 68 c -12.682 0 -23 -10.317 -23 -23 c 0 -12.682 10.318 -23 23 -23 c 12.683 0 23 10.318 23 23 C 68 57.683 57.683 68 45 68 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round" />
	<path d="M 45 17.556 c -1.657 0 -3 -1.343 -3 -3 V 3 c 0 -1.657 1.343 -3 3 -3 c 1.657 0 3 1.343 3 3 v 11.556 C 48 16.212 46.657 17.556 45 17.556 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round" />
	<path d="M 45 90 c -1.657 0 -3 -1.343 -3 -3 V 75.444 c 0 -1.657 1.343 -3 3 -3 c 1.657 0 3 1.343 3 3 V 87 C 48 88.657 46.657 90 45 90 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round" />
	<path d="M 14.556 48 H 3 c -1.657 0 -3 -1.343 -3 -3 c 0 -1.657 1.343 -3 3 -3 h 11.556 c 1.657 0 3 1.343 3 3 C 17.556 46.657 16.212 48 14.556 48 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round" />
	<path d="M 87 48 H 75.444 c -1.657 0 -3 -1.343 -3 -3 c 0 -1.657 1.343 -3 3 -3 H 87 c 1.657 0 3 1.343 3 3 C 90 46.657 88.657 48 87 48 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round" />
	<path d="M 66.527 26.473 c -0.768 0 -1.535 -0.293 -2.121 -0.878 c -1.172 -1.172 -1.172 -3.071 0 -4.243 l 8.171 -8.171 c 1.172 -1.172 3.07 -1.171 4.242 0 c 1.172 1.172 1.172 3.071 0 4.243 l -8.171 8.171 C 68.063 26.18 67.295 26.473 66.527 26.473 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round" />
	<path d="M 15.302 77.698 c -0.768 0 -1.536 -0.293 -2.121 -0.879 c -1.172 -1.171 -1.172 -3.071 0 -4.242 l 8.171 -8.171 c 1.171 -1.172 3.071 -1.172 4.242 0 c 1.172 1.171 1.172 3.071 0 4.242 l -8.171 8.171 C 16.837 77.405 16.069 77.698 15.302 77.698 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round" />
	<path d="M 23.473 26.473 c -0.768 0 -1.536 -0.293 -2.121 -0.878 l -8.171 -8.171 c -1.172 -1.172 -1.172 -3.071 0 -4.243 c 1.172 -1.172 3.072 -1.171 4.243 0 l 8.171 8.171 c 1.172 1.172 1.172 3.071 0 4.243 C 25.008 26.18 24.24 26.473 23.473 26.473 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round" />
	<path d="M 74.698 77.698 c -0.768 0 -1.535 -0.293 -2.121 -0.879 l -8.171 -8.171 c -1.172 -1.171 -1.172 -3.071 0 -4.242 c 1.172 -1.172 3.07 -1.172 4.242 0 l 8.171 8.171 c 1.172 1.171 1.172 3.071 0 4.242 C 76.233 77.405 75.466 77.698 74.698 77.698 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round" />
</g>
</svg>`}),this._dialog=new Kt({title:"Lighting Parameters",visible:!1,useHide:!0,top:60,left:60,width:600}),this._dialog.events.on("visibility",t=>{this._toggleBtn.setActive(t)}),this._panel=new ut({template:`<div class="og-lighing og-options-container">

         <div class="og-option">
           <div class="og-suncontrol"></div>
         </div>        
         
         <div class="og-option og-atmosphere-opacity">
         </div>
         
         <div class="og-option og-simpleskybackground">
         </div>
         
        <div class="og-lighting-emptyline"></div>

         <div class="og-option og-gamma"></div>         
         <div class="og-option og-exposure"></div>
       
        <div class="og-lighting-emptyline"></div>

         <div class="og-option">
         <div class="og-layers">
           <div class="og-caption">Select layer:</div>
           <select id="layers"></select>
         </div>
         </div>

         <div class="og-option og-opacity">
         </div>
         
         <div class="og-option og-night">
         </div>
         
         <div class="og-lighting-emptyline"></div>

         <div class="og-option og-diffuse">
         </div>
      
         <div class="og-option og-ambient">
         </div>

         <div class="og-option og-specular">
         </div>        

    </div>`}),this.$gamma=null,this.$exposure=null,this.$night=null,this.$opacity=null,this.$diffuse=null,this.$ambient=null,this.$specular=null,this.$atmosphereOpacity=null,this.$simpleSkyBackground=null,this._atmosphereMaxOpacity=new Z({label:"Max.opacity",max:5}),this._atmosphereMinOpacity=new Z({label:"Min.opacity",max:5}),this._simpleSkyBackgroundColorOne=new zn({label:"Color One"}),this._simpleSkyBackgroundColorTwo=new zn({label:"Color Two"}),this._gamma=new Z({label:"Gamma",max:5}),this._exposure=new Z({label:"Exposure",max:5}),this._night=new Z({label:"Nightlight",max:5}),this._opacity=new Z({label:"Opacity",max:1}),this._diffuse_r=new Z({label:"Diffuse R",max:5}),this._diffuse_g=new Z({label:"Diffuse G",max:5}),this._diffuse_b=new Z({label:"Diffuse B",max:5}),this._ambient_r=new Z({label:"Ambient R",max:5}),this._ambient_g=new Z({label:"Ambient G",max:5}),this._ambient_b=new Z({label:"Ambient B",max:5}),this._specular_r=new Z({label:"Specular R",max:.2}),this._specular_g=new Z({label:"Specular G",max:.2}),this._specular_b=new Z({label:"Specular B",max:.2}),this._shininess=new Z({label:"Shininess",max:100})}bindLayer(h){this._selectedLayer=h,this._opacity.value=h.opacity,this._update()}oninit(){this._toggleBtn.appendTo(this.renderer.div),this._dialog.appendTo(this.renderer.div),this._panel.appendTo(this._dialog.container),this._panel.el&&(this.$atmosphereOpacity=this._panel.el.querySelector(".og-atmosphere-opacity"),this.$simpleSkyBackground=this._panel.el.querySelector(".og-simpleskybackground"),this.$gamma=this._panel.el.querySelector(".og-option.og-gamma"),this.$exposure=this._panel.el.querySelector(".og-option.og-exposure"),this.$opacity=this._panel.el.querySelector(".og-option.og-opacity"),this.$diffuse=this._panel.el.querySelector(".og-option.og-diffuse"),this.$ambient=this._panel.el.querySelector(".og-option.og-ambient"),this.$specular=this._panel.el.querySelector(".og-option.og-specular"),this.$night=this._panel.el.querySelector(".og-option.og-night")),this._toggleBtn.events.on("change",l=>{this._dialog.setVisibility(l)});let h=this._dialog.select(".og-suncontrol"),t=new dt({classList:["og-suncontrol-button"],isActive:!0,icon:'<?xml version="1.0" encoding="utf-8"?><svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 122.88 70.41" style="enable-background:new 0 0 122.88 70.41" xml:space="preserve"><g><path d="M60.91,19.12c6.95,0,13.24,2.95,17.8,7.72c4.55,4.77,7.37,11.37,7.37,18.64c0,1.94-0.2,3.83-0.58,5.65h31.61 c2.1,0,2.62,1.16,2.62,2.59c0,1.43-0.52,2.59-2.62,2.59H7.09c-2.1,0-2.62-1.16-2.62-2.59c0-1.43,0.52-2.59,2.62-2.59h29.23 c-0.38-1.82-0.58-3.71-0.58-5.65c0-7.28,2.82-13.87,7.37-18.64C47.67,22.08,53.96,19.12,60.91,19.12L60.91,19.12L60.91,19.12z M63.4,70.41c-2.1,0-2.62-1.16-2.62-2.59s0.52-2.59,2.62-2.59h56.86c2.1,0,2.62,1.16,2.62,2.59s-0.52,2.59-2.62,2.59H63.4 L63.4,70.41z M2.62,70.41c-2.1,0-2.62-1.16-2.62-2.59s0.52-2.59,2.62-2.59h29.51c2.1,0,2.62,1.16,2.62,2.59s-0.52,2.59-2.62,2.59 H2.62L2.62,70.41z M38.39,9.46c-0.78-1.35-0.32-3.07,1.03-3.85c1.35-0.78,3.07-0.32,3.85,1.03l3.62,6.27 c0.78,1.35,0.32,3.07-1.03,3.85c-1.35,0.78-3.07,0.32-3.85-1.03L38.39,9.46L38.39,9.46L38.39,9.46z M58.67,2.83 c0-1.56,1.27-2.83,2.83-2.83c1.56,0,2.83,1.27,2.83,2.83v7.24c0,1.56-1.27,2.83-2.83,2.83c-1.56,0-2.83-1.26-2.83-2.83V2.83 L58.67,2.83L58.67,2.83z M79.56,7.23c0.77-1.35,2.49-1.81,3.84-1.04c1.35,0.77,1.81,2.49,1.04,3.84l-3.62,6.27 c-0.77,1.35-2.49,1.81-3.84,1.04c-1.35-0.77-1.81-2.49-1.04-3.84L79.56,7.23L79.56,7.23L79.56,7.23z M95.45,21.48 c1.35-0.78,3.07-0.32,3.85,1.03c0.78,1.35,0.32,3.07-1.03,3.85L92,29.98c-1.35,0.78-3.07,0.32-3.85-1.03 c-0.78-1.35-0.32-3.07,1.03-3.85L95.45,21.48L95.45,21.48L95.45,21.48z M102.08,41.76c1.56,0,2.83,1.27,2.83,2.83 c0,1.56-1.27,2.83-2.83,2.83h-7.24c-1.56,0-2.83-1.26-2.83-2.83s1.26-2.83,2.83-2.83H102.08L102.08,41.76L102.08,41.76z M19.74,46.25c-1.56,0-2.83-1.27-2.83-2.83c0-1.56,1.27-2.83,2.83-2.83h7.24c1.56,0,2.83,1.26,2.83,2.83s-1.27,2.83-2.83,2.83 H19.74L19.74,46.25L19.74,46.25z M24.14,25.35c-1.35-0.77-1.81-2.49-1.04-3.84c0.77-1.35,2.49-1.81,3.84-1.04l6.27,3.62 c1.35,0.77,1.81,2.49,1.04,3.84c-0.77,1.35-2.49,1.81-3.84,1.04L24.14,25.35L24.14,25.35L24.14,25.35z"/></g></svg>',title:"Star/stop the Sun from following the camera"});t.appendTo(h);let s=new dt({classList:["og-suncontrol-button"],isActive:!0,icon:`<?xml version="1.0"?>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32">
    <path style="text-indent:0;text-align:start;line-height:normal;text-transform:none;block-progression:tb;-inkscape-font-specification:Sans" d="M 16 4 C 9.3844277 4 4 9.3844277 4 16 C 4 22.615572 9.3844277 28 16 28 C 22.615572 28 28 22.615572 28 16 C 28 9.3844277 22.615572 4 16 4 z M 16 6 C 16.389823 6 16.778223 6.0506339 17.15625 6.09375 C 18.631659 7.6568432 21 10.9245 21 16 C 21 21.0755 18.631659 24.343157 17.15625 25.90625 C 16.778223 25.949366 16.389823 26 16 26 C 10.465308 26 6 21.534692 6 16 C 6 10.465308 10.465308 6 16 6 z" overflow="visible" font-family="Sans"/>
</svg>
`,title:"Activate/deactivate the Sun current time positioning"});s.appendTo(h),t.events.on("change",l=>{const c=this.planet.renderer.controls.sun;l?c.start():c.stop()}),s.events.on("change",l=>{const c=this.planet.renderer.controls.sun;l?c.activate():c.deactivate()});let n=new dt({classList:["og-suncontrol-button"],isActive:this.planet.lightEnabled,icon:`<?xml version="1.0" encoding="utf-8"?>
<!-- Generated by IcoMoon.io -->
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="512" height="512" viewBox="0 0 512 512">
<g>
</g>
	<path d="M257.894 156.948c-53.258 0-96.42 43.561-96.42 97.26 0 53.719 43.161 97.249 96.42 97.249 53.197 0 96.379-43.53 96.379-97.25 0-53.698-43.182-97.26-96.379-97.26zM257.894 309.873c-30.464 0-55.163-24.945-55.163-55.665s24.699-55.624 55.163-55.624c30.423 0 55.101 24.904 55.101 55.624s-24.688 55.665-55.101 55.665z" fill="#000000" />
	<path d="M241.808 43.499h32.144v79.575h-32.144v-79.575z" fill="#000000" />
	<path d="M417.209 115.897l-22.723-22.917-55.757 56.279 22.723 22.907z" fill="#000000" />
	<path d="M389.468 238.407h78.899v32.389h-78.899v-32.389z" fill="#000000" />
	<path d="M396.012 416.86l22.723-22.917-55.767-56.259-22.712 22.897z" fill="#000000" />
	<path d="M242.473 388.915h32.144v79.575h-32.144v-79.575z" fill="#000000" />
	<path d="M96.266 396.073l22.722 22.938 55.778-56.289-22.692-22.928z" fill="#000000" />
	<path d="M43.633 240.537h78.879v32.43h-78.879v-32.43z" fill="#000000" />
	<path d="M115.394 93.051l-22.681 22.907 55.757 56.258 22.702-22.917z" fill="#000000" />
</svg>`,title:"Enable/disable planet lighting"});n.appendTo(h),n.events.on("change",l=>{this.planet.lightEnabled=l});let o=new dt({classList:["og-suncontrol-button"],isActive:this.planet.atmosphereEnabled,icon:`<?xml version="1.0" encoding="utf-8"?><!-- Uploaded to: SVG Repo, www.svgrepo.com, Generator: SVG Repo Mixer Tools -->
<svg width="800px" height="800px" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><path fill="#000000" d="M135.688 18.5c-6.798 74.842-23.842 85.39-107.907 59.656 84.85 52.022 73.57 64.954-6.843 96.938 87.743-10.27 103.29 4.89 70.75 87.594 17.805-27.56 32.5-44.498 46.282-54.47-11.813 28.26-18.345 59.274-18.345 91.813 0 84.184 43.71 157.96 109.656 200.376-41.624-43.834-67.686-102.7-67.686-167.875 0-134.923 109.45-244.405 244.375-244.405 30.92 0 60.76 5.762 88 16.25-38.584-26.87-85.517-42.625-136.064-42.625-55.257 0-106.14 18.802-146.562 50.375 4.627-18.783 17.39-38.073 41.03-60.906C190.18 90.942 153.53 95.634 135.69 18.5zm10.03 77.188c5.67.002 11.428 1.247 16.876 3.874 14.506 6.998 22.72 21.81 22 36.938-10.26 10.87-19.507 22.696-27.594 35.344-9.035 2.753-19.075 2.27-28.25-2.156-19.37-9.343-27.5-32.6-18.156-51.97 6.715-13.92 20.638-22.036 35.125-22.03z"/></svg>`,title:"Enable/disable atmosphere scattering"});o.appendTo(h),this.planet.atmosphereEnabled?(this.$atmosphereOpacity.style.display="block",this.$simpleSkyBackground.style.display="none"):(this.$atmosphereOpacity.style.display="none",this.$simpleSkyBackground.style.display="flex"),o.events.on("change",l=>{this.planet.atmosphereEnabled=l,this.planet.atmosphereEnabled?(this.$atmosphereOpacity.style.display="block",this.$simpleSkyBackground.style.display="none"):(this.$atmosphereOpacity.style.display="none",this.$simpleSkyBackground.style.display="flex")}),this._atmosphereMaxOpacity.appendTo(this.$atmosphereOpacity),this._atmosphereMinOpacity.appendTo(this.$atmosphereOpacity),this._simpleSkyBackgroundColorOne.appendTo(this.$simpleSkyBackground),this._simpleSkyBackgroundColorTwo.appendTo(this.$simpleSkyBackground),this._gamma.appendTo(this.$gamma),this._exposure.appendTo(this.$exposure),this._night.appendTo(this.$night),this._opacity.appendTo(this.$opacity),this._diffuse_r.appendTo(this.$diffuse),this._diffuse_g.appendTo(this.$diffuse),this._diffuse_b.appendTo(this.$diffuse),this._ambient_r.appendTo(this.$ambient),this._ambient_g.appendTo(this.$ambient),this._ambient_b.appendTo(this.$ambient),this._specular_r.appendTo(this.$specular),this._specular_g.appendTo(this.$specular),this._specular_b.appendTo(this.$specular),this._shininess.appendTo(this.$specular),this._gamma.value=this.planet.renderer.gamma,this._gamma.events.on("change",l=>{this.planet.renderer.gamma=l}),this._exposure.value=this.planet.renderer.exposure,this._exposure.events.on("change",l=>{this.planet.renderer.exposure=l}),this._atmosphereMinOpacity.value=this.planet.atmosphereMinOpacity,this._atmosphereMinOpacity.events.on("change",l=>{this.planet.atmosphereMinOpacity=l}),this._atmosphereMaxOpacity.value=this.planet.atmosphereMaxOpacity,this._atmosphereMaxOpacity.events.on("change",l=>{this.planet.atmosphereMaxOpacity=l,this.planet.renderer.controls.Atmosphere.opacity=l});let a=this.planet.renderer.controls.SimpleSkyBackground;a&&(this._simpleSkyBackgroundColorOne.value=a.colorOne,this._simpleSkyBackgroundColorTwo.value=a.colorTwo),this._simpleSkyBackgroundColorOne.events.on("input",l=>{let c=this.planet.renderer.controls.SimpleSkyBackground;c&&(c.colorOne=l)}),this._simpleSkyBackgroundColorTwo.events.on("input",l=>{let c=this.planet.renderer.controls.SimpleSkyBackground;c&&(c.colorTwo=l)}),this._panel.el.querySelector("#layers").addEventListener("change",l=>{const c=this.planet.getLayerByName(l.target.value);c&&this.bindLayer(c)}),this._night.events.on("change",l=>{this._selectedLayer&&(this._selectedLayer.nightTextureCoefficient=l)}),this._opacity.events.on("change",l=>{this._selectedLayer&&(this._selectedLayer.opacity=l)}),this._ambient_r.events.on("change",l=>{this._selectedLayer&&this._selectedLayer._ambient&&(this._selectedLayer._ambient[0]=l)}),this._ambient_g.events.on("change",l=>{this._selectedLayer&&this._selectedLayer._ambient&&(this._selectedLayer._ambient[1]=l)}),this._ambient_b.events.on("change",l=>{this._selectedLayer&&this._selectedLayer._ambient&&(this._selectedLayer._ambient[2]=l)}),this._diffuse_r.events.on("change",l=>{this._selectedLayer&&this._selectedLayer._diffuse&&(this._selectedLayer._diffuse[0]=l)}),this._diffuse_g.events.on("change",l=>{this._selectedLayer&&this._selectedLayer._diffuse&&(this._selectedLayer._diffuse[1]=l)}),this._diffuse_b.events.on("change",l=>{this._selectedLayer&&this._selectedLayer._diffuse&&(this._selectedLayer._diffuse[2]=l)}),this._specular_r.events.on("change",l=>{this._selectedLayer&&this._selectedLayer._specular&&(this._selectedLayer._specular[0]=l)}),this._specular_g.events.on("change",l=>{this._selectedLayer&&this._selectedLayer._specular&&(this._selectedLayer._specular[1]=l)}),this._specular_b.events.on("change",l=>{this._selectedLayer&&this._selectedLayer._specular&&(this._selectedLayer._specular[2]=l)}),this._shininess.events.on("change",l=>{this._selectedLayer&&this._selectedLayer._specular&&(this._selectedLayer._specular[3]=l)}),this.planet&&(this.planet.events.on("layeradd",this._onLayerAdd,this),this.planet.events.on("layerremove",this._onLayerRemove,this)),this._fetchLayers()}_update(){let h=this._selectedLayer;this._opacity.value=h&&h.opacity?h.opacity:0,this._night.value=h&&h.nightTextureCoefficient?h.nightTextureCoefficient:this.planet.nightTextureCoefficient;let t=h&&h._ambient?h._ambient:this.planet._ambient;this._ambient_r.value=t[0],this._ambient_g.value=t[1],this._ambient_b.value=t[2];let s=h&&h._diffuse?h._diffuse:this.planet._diffuse;this._diffuse_r.value=s[0],this._diffuse_g.value=s[1],this._diffuse_b.value=s[2];let n=h&&h._specular?h._specular:this.planet._specular;this._specular_r.value=n[0],this._specular_g.value=n[1],this._specular_b.value=n[2],this._shininess.value=n[3]}_fetchLayers(){if(this.planet)for(let h=0;h<this.planet.layers.length;h++)this._onLayerAdd(this.planet.layers[h])}_onLayerAdd(h){this.bindLayer(h);let t=document.createElement("option");t.value=h.name,t.innerText=h.name,this._panel.el.querySelector("#layers").appendChild(t),this._panel.el.querySelector("#layers").value=h.name}_onLayerRemove(h){}},Navigation:Yi,Object3dManager:class extends Q{constructor(h={}){super(h),this._onSelect=t=>{this._currentItem=t},this._onClick=t=>{if(!this.planet||!this._layer||!this._currentItem)return;let s=this.planet.getLonLatFromPixelTerrain(t.pos);if(s&&(this.renderer.setRelativeCenter(this.planet.camera.eye),this.renderer.events.isKeyPressed(W.KEY_CTRL))){let n=this._createEntity(this._currentItem,s);this._layer.add(n)}},this._layer=h.layer||null,this._currentItem=null,this._collection=new ln({collection:h.collection}),this._dialog=new Lh({model:this._collection})}oninit(){this.renderer&&(this._dialog.appendTo(this.renderer.div||document.body),this._dialog.events.on("select",this._onSelect),this.activate())}onactivate(){this._dialog.show(),this._initEvents()}ondeactivate(){this._dialog.hide(),this._clearEvents()}bindLayer(h){this._layer=h}_initEvents(){this.planet&&this.planet.renderer&&this.planet.renderer.events.on("lclick",this._onClick)}_clearEvents(){this.planet&&this.planet.renderer&&this.planet.renderer.events.off("lclick",this._onClick)}_createEntity(h,t){let s=h.name,n=h.scale,o=new G({lonlat:t,pitch:0,yaw:0,roll:0,scale:n});for(let a=0;a<h.objects.length;a++){let l=h.objects[a],c=new G({forceGlobalPosition:!0,forceGlobalRotation:!0,forceGlobalScale:!0,geoObject:{tag:`${s}:${a.toString()}`,object3d:l}});o.appendChild(c)}return o}},OldMouseNavigation:rn,Ruler:_a,RulerSwitcher:class extends Q{constructor(h={}){super({name:"RulerSwitcher",...h}),this.ruler=new Hn({ignoreTerrain:h.ignoreTerrain})}oninit(){this.planet.addControl(this.ruler),this._createMenuBtn()}onactivate(){this.ruler.activate()}ondeactivate(){this.ruler.deactivate()}_createMenuBtn(){let h=new dt({classList:["og-map-button","og-ruler_button"],icon:`<?xml version="1.0" encoding="iso-8859-1"?>
<!-- Uploaded to: SVG Repo, www.svgrepo.com, Generator: SVG Repo Mixer Tools -->
<svg fill="#000000" height="800px" width="800px" version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" 
	 viewBox="0 0 512 512" xml:space="preserve">
<g>
	<g>
		<path d="M369.151,0L0.001,369.15L142.85,512l369.149-369.15L369.151,0z M47.286,369.15l10.908-10.908l47.782,47.782l23.642-23.642
			L81.837,334.6l10.909-10.909l23.711,23.711L140.1,323.76l-23.711-23.711l10.909-10.909l23.711,23.711l23.642-23.642
			l-23.711-23.711l10.909-10.909l47.782,47.782l23.642-23.642l-47.782-47.782l10.908-10.908l23.71,23.71l23.642-23.642l-23.71-23.71
			l10.908-10.908l23.711,23.711l23.642-23.642l-23.711-23.711l10.909-10.909l47.782,47.782l23.642-23.642l-47.782-47.782
			l10.908-10.908l23.71,23.711l23.642-23.642l-23.711-23.71L334.6,81.837l23.711,23.71l23.642-23.642l-23.711-23.712l10.908-10.908
			l95.564,95.564L142.85,464.714L47.286,369.15z"/>
	</g>
</g>
</svg>`});h.appendTo(this.renderer.div),h.events.on("change",t=>{t?this.onactivate():this.ondeactivate()})}},ScaleControl:fa,Selection:class extends Q{constructor(h={}){super(h),this._selectorScene=new Dl({name:`selectionScene:${this.__id}`,ignoreTerrain:h.ignoreTerrain,onSelect:h.onSelect,autoSelectionHide:h.autoSelectionHide}),this._toggleBtn=new dt({classList:["og-map-button","og-selection_button"],icon:`<?xml version="1.0" encoding="utf-8"?><!-- Uploaded to: SVG Repo, www.svgrepo.com, Generator: SVG Repo Mixer Tools -->
<svg width="800px" height="800px" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="iconify iconify--gis" preserveAspectRatio="xMidYMid meet"><path d="M2.1 0v1.914H0v6h3V3h5.1V0h-6zm9 0v3h6V0h-6zm9 0v3h6V0h-6zm9 0v3h6V0h-6zm9 0v3h6V0h-6zm9 0v3h6V0h-6zm9 0v3h6V0h-6zm9 0v3h1.8v1.2h3V0h-4.8zm1.8 7.2v6h3v-6h-3zM0 10.913v6h3v-6H0zM66.9 16.2v6h3v-6h-3zM0 19.914v6h3v-6H0zM66.9 25.2v6h3v-6h-3zM0 28.914v6h3v-6H0zM66.9 34.2v6h3v-6h-3zM0 37.914v6h3v-6H0zM66.9 43.2v6h3v-6h-3zM0 46.914v6h3v-6H0zM66.9 52.2v6h3v-6h-3zM0 55.914v5.191h3.809v-3H3v-2.19H0zm6.809 2.191v3h6v-3h-6zm9 0v3h6v-3h-6zm9 0v3h6v-3h-6zm9 0v3h6v-3h-6zm9 0v3h6v-3h-6zm9 0v3h6v-3h-6zm9 0v3h6v-3h-6zm9.648 1.899a2.076 2.076 0 0 0-2.19 2.324l3.137 33.676c.2 1.635 2.135 2.399 3.397 1.34l6.623-5.371l2.969 5.142c1.707 2.958 4.417 3.684 7.375 1.977c2.957-1.708 3.684-4.417 1.976-7.375l-2.959-5.125l7.848-3.008c1.548-.564 1.855-2.62.539-3.611L71.576 60.416a2.073 2.073 0 0 0-1.119-.412z" fill="#000000"></path></svg>`})}set ignoreTerrain(h){this._selectorScene.ignoreTerrain=h}oninit(){this._toggleBtn.appendTo(this.renderer.div),this._toggleBtn.events.on("change",h=>{h?this.activate():this.deactivate()}),this._selectorScene.bindPlanet(this.planet)}onactivate(){this.renderer.addNode(this._selectorScene)}ondeactivate(){this.renderer.removeNode(this._selectorScene)}},ShowFps:class extends Q{constructor(h){super(h)}oninit(){let h=document.createElement("div");h.className="defaultText ",h.id="ogShowFpsControl",document.body.appendChild(h),this.renderer.events.on("draw",this._draw,this)}_draw(){Ro("ogShowFpsControl",(1e3/this.renderer.handler.deltaTime).toFixed(1),this.renderer.handler.canvas.clientWidth-60,0)}},SimpleNavigation:class extends Q{constructor(h={}){super({name:"SimpleNavigation",autoActivate:!0,...h}),this.focusVel=0,this.focusForce=0,this._nx=0,this._ny=0,this._onMouseLeftButtonDown=t=>{if(this._active&&this.renderer){if(this.stop(),this.renderer.handler.canvas.classList.add("ogGrabbingPoiner"),this._grabbedPoint=this.renderer.getCartesianFromPixel(t),this._grabbedScreenPoint.set(t.nx,t.ny),!this._grabbedPoint){let s=this.renderer.activeCamera,n=new v,o=new v(1,0,0),a=new v(0,0,1),l=new v;new V(s.eye,t.direction).hitPlaneRes(vt.fromPoints(n,o,a),l)===V.INSIDE&&(this._grabbedPoint=l)}this._grabbedPoint&&this._eye0.copy(this.renderer.activeCamera.eye)}},this._onMouseLeftButtonUp=t=>{this.renderer.handler.canvas.classList.remove("ogGrabbingPoiner"),t.x===t.prev_x&&(t.y,t.prev_y)},this._onMouseLeftButtonHold=t=>{if(this.renderer&&this._grabbedPoint&&t.moving){let s=this.renderer.activeCamera;if(s.isOrthographic){let n=t.nx-this._grabbedScreenPoint.x,o=t.ny-this._grabbedScreenPoint.y,a=s.frustum,l=-(a.right-a.left)*n,c=(a.top-a.bottom)*o,d=s.getUp().scale(c),u=s.getRight().scale(l);s.eye=this._eye0.add(u.add(d))}else{let n,o,a=Math.abs(s.getForward().dot(v.UP)),l=this._grabbedPoint;a>.7?(n=v.add(l,v.LEFT),o=v.add(l,s.getRight())):(n=v.add(l,s.getRight()),o=v.add(l,v.UP));let c=new v;new V(s.eye,t.direction).hitPlaneRes(vt.fromPoints(l,n,o),c)===V.INSIDE&&(s.eye=s.eye.add(l.sub(c)))}s.update()}},this._onRHold=t=>{if(this._lookPos&&t.moving&&this.renderer){const s=this.renderer.activeCamera;this.renderer.controlsBag.scaleRot=1;let n=.5/s.eye.distance(this._lookPos)*j;n>.007?n=.007:n<.003&&(n=.003),s.rotateHorizontal(n*(t.x-t.prev_x),!1,this._lookPos,this._up),s.rotateVertical(n*(t.y-t.prev_y),this._lookPos),s.update()}},this._onRDown=t=>{if(this.renderer)if(this.stop(),this._lookPos=this.renderer.getCartesianFromPixel(t.pos),this._lookPos)this._up=v.UP;else{const s=this.renderer.activeCamera;let n=new vt(v.ZERO,v.UP),o=new V(s.eye,t.direction);this._lookPos=new v,o.hitPlaneRes(n,this._lookPos),this._up=v.UP}},this._onMouseWheel=t=>{if(this.renderer){let s=this.renderer.activeCamera;if(s.isOrthographic){let n=s.frustums[0],o=-(n.right-n.left)*(.5-t.nx),a=(n.top-n.bottom)*(.5-t.ny),l=s.getUp().scale(a),c=s.getRight().scale(o),d=s.eye.add(c.add(l));this._wheelPos=d.add(s.getForward()),this._wheelDist=1,this._nx=t.nx,this._ny=t.ny,this.focusForce=.05*t.wheelDelta}else{let n=this.renderer.getCartesianFromPixel(t);if(!n){n=new v;let l=new vt(v.ZERO,v.UP);new V(s.eye,t.direction).hitPlaneRes(l,n)}let o=n.sub(s.eye).normalize(),a=8*s.eye.distance(n);this.force.addA(o.scale(t.wheelDelta)).normalize().scale(a)}}},this.onCameraMoveForward=()=>{this.force.addA(this.renderer.activeCamera.getForward()).normalize()},this.onCameraMoveBackward=()=>{this.force.addA(this.renderer.activeCamera.getBackward()).normalize()},this.onCameraStrifeLeft=()=>{this.force.addA(this.renderer.activeCamera.getLeft()).normalize()},this.onCameraStrifeRight=()=>{this.force.addA(this.renderer.activeCamera.getRight()).normalize()},this.onCameraLookUp=()=>{this.renderer.activeCamera.update()},this.onCameraLookDown=()=>{this.renderer.activeCamera.update()},this.onCameraTurnLeft=()=>{this.renderer.activeCamera.update()},this.onCameraTurnRight=()=>{this.renderer.activeCamera.update()},this.onCameraRollLeft=()=>{this.renderer.activeCamera.update()},this.onCameraRollRight=()=>{this.renderer.activeCamera.update()},this.speed=h.speed||1,this.force=new v,this.vel=new v,this.mass=1,this._lookPos=void 0,this._grabbedPoint=void 0,this._grabbedScreenPoint=new H,this._up=null,this._eye0=new v,this._wheelDist=0,this._wheelPos=new v}oninit(){}onactivate(){super.onactivate();let h=this.renderer;h.activeCamera.isOrthographic&&h.getDepthMinDistanceAsync().then(t=>{h.activeCamera.focusDistance=t}),h.events.on("mousewheel",this._onMouseWheel),h.events.on("keypress",W.KEY_W,this.onCameraMoveForward,this),h.events.on("keypress",W.KEY_S,this.onCameraMoveBackward,this),h.events.on("keypress",W.KEY_A,this.onCameraStrifeLeft,this),h.events.on("keypress",W.KEY_D,this.onCameraStrifeRight,this),h.events.on("keypress",W.KEY_UP,this.onCameraLookUp,this),h.events.on("keypress",W.KEY_DOWN,this.onCameraLookDown,this),h.events.on("keypress",W.KEY_LEFT,this.onCameraTurnLeft,this),h.events.on("keypress",W.KEY_RIGHT,this.onCameraTurnRight,this),h.events.on("keypress",W.KEY_Q,this.onCameraRollLeft,this),h.events.on("keypress",W.KEY_E,this.onCameraRollRight,this),h.events.on("rhold",this._onRHold,this),h.events.on("rdown",this._onRDown,this),h.events.on("lhold",this._onMouseLeftButtonHold),h.events.on("ldown",this._onMouseLeftButtonDown),h.events.on("lup",this._onMouseLeftButtonUp),h.events.on("draw",this.onDraw,this,-1e3)}ondeactivate(){super.ondeactivate();let h=this.renderer;h.events.off("mousewheel",this._onMouseWheel),h.events.off("keypress",W.KEY_W,this.onCameraMoveForward),h.events.off("keypress",W.KEY_S,this.onCameraMoveBackward),h.events.off("keypress",W.KEY_A,this.onCameraStrifeLeft),h.events.off("keypress",W.KEY_D,this.onCameraStrifeRight),h.events.off("keypress",W.KEY_UP,this.onCameraLookUp),h.events.off("keypress",W.KEY_DOWN,this.onCameraLookDown),h.events.off("keypress",W.KEY_LEFT,this.onCameraTurnLeft),h.events.off("keypress",W.KEY_RIGHT,this.onCameraTurnRight),h.events.off("keypress",W.KEY_Q,this.onCameraRollLeft),h.events.off("keypress",W.KEY_E,this.onCameraRollRight),h.events.off("rhold",this._onRHold),h.events.off("rdown",this._onRDown),h.events.off("lhold",this._onMouseLeftButtonHold),h.events.off("ldown",this._onMouseLeftButtonDown),h.events.off("lup",this._onMouseLeftButtonUp),h.events.off("draw",this.onDraw)}_handleMouseWheel(){let h=this.renderer.activeCamera;if(h.isOrthographic&&Math.abs(this.focusVel)>.01){h.eye=this._wheelPos.add(h.getBackward().scale(this._wheelDist)),h.focusDistance-=h.focusDistance*this.focusVel*this.dt;let t=h.frustums[0],s=(t.right-t.left)*(.5-this._nx),n=-(t.top-t.bottom)*(.5-this._ny),o=h.getUp().scale(n),a=h.getRight().scale(s);h.eye.addA(a.add(o)),h.update()}else this.vel.length()>.01&&(h.eye=h.eye.add(this.vel.scaleTo(this.dt)),h.update())}onDraw(){this._updateVel(),this._handleMouseWheel()}get dt(){return .001*this.renderer.handler.deltaTime}_updateVel(){let h=this.force.scale(1/this.mass);this.vel.addA(h),this.vel.scale(.77),this.force.set(0,0,0),this.focusVel+=this.focusForce,this.focusVel*=.77,this.focusForce=0}stop(){this.focusVel=0,this.vel.clear()}},SimpleSkyBackground:ga,Sun:Dr,TimelineControl:class extends Q{constructor(h={}){super({name:"timeline",...h});let t=h.current||new Date,s=h.rangeStart||jn(t,-12),n=h.rangeEnd||jn(t,12);this._timelineView=new jl({rangeStart:s,rangeEnd:n,currentDate:t}),this._toggleBtn=new dt({classList:["og-map-button","og-timeline_button"],icon:`<?xml version="1.0" encoding="utf-8"?>
<!-- Svg Vector Icons : http://www.onlinewebfonts.com/icon -->
    <!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 1000 1000" enable-background="new 0 0 1000 1000" xml:space="preserve">
    <metadata> Svg Vector Icons : http://www.onlinewebfonts.com/icon </metadata>
    <g><path d="M500,10C229.4,10,10,229.4,10,500s219.4,490,490,490s490-219.4,490-490S770.6,10,500,10z M800.3,800.3c-39,39-84.5,69.7-135,91C613,913.5,557.4,924.7,500,924.7s-112.9-11.2-165.3-33.3c-50.5-21.3-95.9-52-135-91c-39-39-69.7-84.5-91-135C86.5,612.9,75.3,557.4,75.3,500s11.2-112.9,33.3-165.3c21.3-50.5,52-95.9,91-135c39-39,84.5-69.7,135-91C387.1,86.5,442.6,75.3,500,75.3s112.9,11.2,165.3,33.3c50.5,21.3,95.9,52,135,91c39,39,69.7,84.5,91,135c22.1,52.3,33.3,107.9,33.3,165.3s-11.2,112.9-33.3,165.3C869.9,715.8,839.3,761.2,800.3,800.3z"/><path d="M761.3,532.7H532.7V304c0-18.1-14.6-32.7-32.7-32.7s-32.7,14.6-32.7,32.7v261.3l0,0c0,18.1,14.6,32.7,32.7,32.7h261.3c18.1,0,32.7-14.6,32.7-32.7l0,0C794,547.3,779.4,532.7,761.3,532.7z"/></g>
</svg>`}),this._dialog=new Kt({title:"Timeline",visible:!1,resizable:!0,useHide:!0,top:10,left:60,width:600,height:115,minHeight:115,maxHeight:110}),this._dialog.events.on("visibility",o=>{this._toggleBtn.setActive(o)})}oninit(){let h=this.renderer.div;this._toggleBtn.appendTo(h),this._dialog.appendTo(h),this._toggleBtn.events.on("change",t=>{this._dialog.setVisibility(t),t&&this._timelineView.resize()}),this._timelineView.appendTo(this._dialog.container),this._timelineView.events.on("setcurrent",t=>{this.renderer&&this.renderer.handler.defaultClock.setDate(t)}),this._timelineView.events.on("startdrag",()=>{var t;(t=this.planet)==null||t.sun.stop(),this.renderer&&this.renderer.controls.navigation.deactivate()}),this._timelineView.events.on("stopdrag",()=>{this.renderer&&this.renderer.controls.navigation.activate()}),this._timelineView.events.on("startdragcurrent",()=>{var t;(t=this.planet)==null||t.sun.stop(),this.renderer&&this.renderer.controls.navigation.deactivate()}),this._timelineView.events.on("stopdragcurrent",()=>{this.renderer&&this.renderer.controls.navigation.activate()})}},ToggleWireframe:class extends Q{constructor(h={}){super(h),this._isActive=!1,this.toogleWireframe=()=>{this.renderer&&this.renderer.handler.gl&&(this.planet.drawMode===this.renderer.handler.gl.LINE_STRIP?this.planet.setDrawMode(this.renderer.handler.gl.TRIANGLE_STRIP):this.planet.setDrawMode(this.renderer.handler.gl.LINE_STRIP))},this._isActive=h.isActive||!1}oninit(){this.renderer.events.on("charkeypress",W.KEY_X,this.toogleWireframe,this),this._isActive&&this.planet.setDrawMode(this.renderer.handler.gl.LINE_STRIP)}},TouchNavigation:pa,ZoomControl:ma},Symbol.toStringTag,{value:"Module"}));function Ke(h){return new Uint32Array(h)}function kh(h){let t=[],s=0,n=0,o=0;for(let a=1;a<h-1-1;a++){for(let l=1;l<h-1;l++)s=a*h+l,o=(a+1)*h,n=o+l,t.push(s,n);t.push(n,o+1)}return t.push(t[t.length-1],h*h-h),Ke(t)}function Ih(h,t){let s=[];const n=(h-1)/t,o=h*h-h;let a=0;for(let l=0;l<h-2;l++){l%n==0&&(a=l);let c=o-h*l-h+1,d=o-h*a;s.push(d,c)}return t===h-1&&(s.push(h),s.push(0)),Ke(s)}function zh(h,t){let s=[];const n=(h-1)/t;let o=0;for(let a=0;a<h-2;a++){a%n==0&&(o=a);let l=h+a+1,c=o;s.push(c,l)}return t===h-1&&(s.push(h-2),s.push(h-1)),Ke(s)}function Dh(h,t){let s=[];const n=(h-1)/t;let o=0;for(let a=0;a<h-2;a++){a%n==0&&(o=a);let l=h*(a+1)+h-2,c=h+h*o-1;s.push(c,l)}return t===h-1&&(s.push(h*(h-1)-1),s.push(h*h-1)),Ke(s)}function Fh(h,t){let s=[];const n=(h-1)/t;let o=0;const a=h*(h-1)-2,l=h*h-1;for(let c=0;c<h-2;c++){c%n==0&&(o=c);let d=a-c,u=l-o;s.push(u,d)}return t===h-1&&s.push(h*h-h+1),s.push(h*h-h),Ke(s)}function no(h){let t=[[],[],[],[]];for(let s=0;s<=h;s++){let n=Math.pow(2,s)+1;t[0][s]=[],t[3][s]=[],t[2][s]=[],t[1][s]=[];for(let o=0;o<=h;o++){let a=Math.pow(2,o);t[3][s][o]=Ih(n,a),t[0][s][o]=zh(n,a),t[1][s][o]=Dh(n,a),t[2][s][o]=Fh(n,a)}}return t}function oo(h){let t=[];for(let s=0;s<=h;s++){const n=Math.pow(2,s);t[s]=kh(n+1)}return t}function Oh(h){let t=new Uint16Array((h+1)*(h+1)*2),s=0;for(let n=0;n<=h;n++)for(let o=0;o<=h;o++)t[s++]=o/h*65535,t[s++]=n/h*65535;return t}let Nh=new class{constructor(h=0){this._maxGridSize=h,this.centerIndexesTable=oo(this._maxGridSize),this.skirtsIndexesTable=no(this._maxGridSize)}get maxGridSize(){return this._maxGridSize}init(){this.centerIndexesTable=oo(this._maxGridSize),this.skirtsIndexesTable=no(this._maxGridSize)}setMaxGridSize(h){this._maxGridSize=h,this.init()}createSegmentIndexes(h,t){if(h){let n=this.centerIndexesTable[h],o=this.skirtsIndexesTable[3][h][t[3]],a=this.skirtsIndexesTable[0][h][t[0]],l=this.skirtsIndexesTable[1][h][t[1]],c=this.skirtsIndexesTable[2][h][t[2]],d=(s=n.length+o.length+a.length+l.length+c.length,new Uint32Array(s));return d.set(n,0),d.set(o,n.length),d.set(a,n.length+o.length),d.set(l,n.length+o.length+a.length),d.set(c,n.length+o.length+a.length+l.length),d}var s;return Ke([0,2,1,3])}initTextureCoordsTable(h){let t=[];for(let s=0;s<=h;s++){const n=Math.pow(2,s);t[s]=Oh(n)}return t}};function $i(){return Nh}function ao(){return new X("drawnode_screen_wl",{uniforms:{projectionMatrix:"mat4",viewMatrix:"mat4",eyePositionHigh:"vec3",eyePositionLow:"vec3",height:"float",uGlobalTextureCoord:"vec4",uNormalMapBias:"vec3",samplerCount:"int",tileOffsetArr:"vec4",layerOpacityArr:"float",samplerArr:"sampler2darray",defaultTexture:"sampler2d",uNormalMap:"sampler2d",nightTexture:"sampler2d",specularTexture:"sampler2d",lightPosition:"vec3",diffuse:"vec3",ambient:"vec3",specular:"vec4",camHeight:"float",nightTextureCoefficient:"float"},attributes:{aVertexPositionHigh:"vec3",aVertexPositionLow:"vec3",aTextureCoord:"vec2"},vertexShader:"attribute vec3 aVertexPositionHigh;attribute vec3 aVertexPositionLow;attribute vec2 aTextureCoord;uniform mat4 projectionMatrix;uniform mat4 viewMatrix;uniform vec4 uGlobalTextureCoord;uniform vec3 uNormalMapBias;uniform vec3 eyePositionHigh;uniform vec3 eyePositionLow;uniform float height;varying vec4 vTextureCoord;varying vec3 v_vertex;varying vec3 cameraPosition;varying vec2 vGlobalTextureCoord;varying float v_height;void main(void){vec3 aVertexPosition=aVertexPositionHigh+aVertexPositionLow;vec3 nh=height*normalize(aVertexPosition);vTextureCoord.xy=aTextureCoord;vGlobalTextureCoord=uGlobalTextureCoord.xy+(uGlobalTextureCoord.zw-uGlobalTextureCoord.xy)*aTextureCoord;vTextureCoord.zw=uNormalMapBias.z*(aTextureCoord+uNormalMapBias.xy);cameraPosition=eyePositionHigh+eyePositionLow;vec3 highDiff=aVertexPositionHigh-eyePositionHigh;vec3 lowDiff=aVertexPositionLow-eyePositionLow+nh;mat4 viewMatrixRTE=viewMatrix;viewMatrixRTE[3]=vec4(0.0,0.0,0.0,1.0);v_height=height;v_vertex=aVertexPosition+nh;gl_Position=projectionMatrix*viewMatrixRTE*vec4(highDiff*step(1.0,length(highDiff))+lowDiff,1.0);}",fragmentShader:`precision highp float;float getLerpValue(in float min,in float max,in float between){return(clamp(between,min,max)-min)/(max-min);}vec3 aces(vec3 color){float a=2.51;float b=0.03;float c=2.43;float d=0.59;float e=0.14;return clamp((color*(a*color+b))/(color*(c*color+d)+e),0.0,1.0);}bool intersectSphere(vec3 rayOrigin,vec3 rayDirection,float radius,inout float t1,inout float t2){float b=dot(rayDirection,rayOrigin);float c=dot(rayOrigin,rayOrigin)-radius*radius;float d=b*b-c;if(d<-1e-6){return false;}d=max(d,0.0);t1=-b-sqrt(d);t2=-b+sqrt(d);if(t2<0.0){return false;}return true;}bool intersectSphere(vec3 rayOrigin,vec3 rayDirection,float radius,inout float t){float b=dot(rayDirection,rayOrigin);float c=dot(rayOrigin,rayOrigin)-radius*radius;float d=b*b-c;if(d<0.0){return false;}t=-b-sqrt(d);return true;}float intersectSphere(vec3 ro,vec3 rd,vec4 sph){vec3 oc=ro-sph.xyz;float b=dot(oc,rd);float c=dot(oc,oc)-sph.w*sph.w;float h=b*b-c;if(h<0.0)return-1.0;h=sqrt(h);return-b-h;}bool intersectEllipsoid(in vec3 ro,in vec3 rd,in vec3 ra,inout float t){vec3 ocn=ro/ra;vec3 rdn=rd/ra;float a=dot(rdn,rdn);float b=dot(ocn,rdn);float c=dot(ocn,ocn);float h=b*b-a*(c-1.0);if(h<0.0){return false;}t=(-b-sqrt(h))/a;return true;}bool intersectEllipsoid(in vec3 ro,in vec3 rd,in vec3 ra,inout float t1,inout float t2){vec3 ocn=ro/ra;vec3 rdn=rd/ra;float a=dot(rdn,rdn);float b=dot(ocn,rdn);float c=dot(ocn,ocn);float h=b*b-a*(c-1.0);if(h<0.0){return false;}h=sqrt(h);t1=(-b-h)/a;t2=(-b+h)/a;return true;}vec3 normalEllipsoid(in vec3 pos,in vec3 ra){return normalize(pos/(ra*ra));}
#ifdef WEBGL2
#define TEXTURE_FUNC texture
#else
#define TEXTURE_FUNC texture2D
#endif
#define SLICE_SIZE 5
#define blend(DEST, SAMPLER, OFFSET, OPACITY) src = TEXTURE_FUNC(SAMPLER, OFFSET.xy + vTextureCoord.xy * OFFSET.zw); DEST = DEST * (1.0 - src.a * OPACITY) + src * OPACITY;
#define blendPicking(DEST, OFFSET, SAMPLER, MASK, COLOR, OPACITY) tc = OFFSET.xy + vTextureCoord.xy * OFFSET.zw; t = TEXTURE_FUNC(SAMPLER, tc); p = TEXTURE_FUNC(MASK, tc); DEST = mix(DEST, vec4(max(COLOR.rgb, p.rgb), OPACITY), (t.a == 0.0 ? 0.0: 1.0) * COLOR.a);
const vec3 nightStep=10.0*vec3(0.58,0.48,0.25);uniform vec4 specular;uniform vec3 diffuse;uniform vec3 ambient;uniform sampler2D uNormalMap;uniform sampler2D nightTexture;uniform sampler2D specularTexture;uniform sampler2D defaultTexture;uniform sampler2D samplerArr[SLICE_SIZE];uniform vec4 tileOffsetArr[SLICE_SIZE];uniform vec3 lightPosition;uniform float layerOpacityArr[SLICE_SIZE];uniform int samplerCount;uniform float nightTextureCoefficient;uniform float camHeight;varying vec4 vTextureCoord;varying vec3 v_vertex;varying vec3 cameraPosition;varying vec2 vGlobalTextureCoord;varying float v_height;vec3 sunPos;void main(void){sunPos=lightPosition;vec3 texNormal=texture2D(uNormalMap,vTextureCoord.zw).rgb;vec3 normal=normalize((texNormal-0.5)*2.0);float minH=1200000.0;float maxH=minH*3.0;float nightCoef=getLerpValue(minH,maxH,camHeight)*nightTextureCoefficient;vec3 lightDir=normalize(sunPos);vec3 viewDir=normalize(cameraPosition-v_vertex);float overGround=1.0-step(0.1,v_height);float shininess=texture2D(specularTexture,vGlobalTextureCoord.st).r*255.0*overGround;vec3 reflectionDirection=reflect(-lightDir,normal);float reflection=max(dot(reflectionDirection,viewDir),0.0);vec3 spec=specular.rgb*pow(reflection,specular.w)*shininess;float diffuseLightWeighting=max(dot(normal,lightDir),0.0);vec4 nightImageColor=texture2D(nightTexture,vGlobalTextureCoord.st);vec3 night=nightStep*(.18-diffuseLightWeighting*3.0)*nightImageColor.rgb*nightCoef;night*=overGround*step(0.0,night);vec4 lightWeighting=vec4(ambient+diffuse*diffuseLightWeighting+night,1.0);gl_FragColor=texture2D(defaultTexture,vTextureCoord.xy);if(samplerCount==0){gl_FragColor=gl_FragColor*lightWeighting+vec4(spec,0.0);return;}vec4 src;blend(gl_FragColor,samplerArr[0],tileOffsetArr[0],layerOpacityArr[0]);if(samplerCount==1){gl_FragColor=gl_FragColor*lightWeighting+vec4(spec,0.0);return;}blend(gl_FragColor,samplerArr[1],tileOffsetArr[1],layerOpacityArr[1]);if(samplerCount==2){gl_FragColor=gl_FragColor*lightWeighting+vec4(spec,0.0);return;}blend(gl_FragColor,samplerArr[2],tileOffsetArr[2],layerOpacityArr[2]);if(samplerCount==3){gl_FragColor=gl_FragColor*lightWeighting+vec4(spec,0.0);return;}blend(gl_FragColor,samplerArr[3],tileOffsetArr[3],layerOpacityArr[3]);if(samplerCount==4){gl_FragColor=gl_FragColor*lightWeighting+vec4(spec,0.0);return;}blend(gl_FragColor,samplerArr[4],tileOffsetArr[4],layerOpacityArr[4]);gl_FragColor=gl_FragColor*lightWeighting+vec4(spec,0.0);}`})}function lo(h){return new X("drawnode_screen_wl",{uniforms:{projectionMatrix:"mat4",viewMatrix:"mat4",eyePositionHigh:"vec3",eyePositionLow:"vec3",height:"float",uGlobalTextureCoord:"vec4",uNormalMapBias:"vec3",samplerCount:"int",tileOffsetArr:"vec4",layerOpacityArr:"float",samplerArr:"sampler2darray",defaultTexture:"sampler2d",uNormalMap:"sampler2d",nightTexture:"sampler2d",specularTexture:"sampler2d",lightPosition:"vec3",diffuse:"vec3",ambient:"vec3",specular:"vec4",transmittanceTexture:"sampler2D",scatteringTexture:"sampler2D",camHeight:"float",nightTextureCoefficient:"float",maxMinOpacity:"vec2",transitionOpacity:"float"},attributes:{aVertexPositionHigh:"vec3",aVertexPositionLow:"vec3",aTextureCoord:"vec2"},vertexShader:`#version 300 es
precision highp float;in vec3 aVertexPositionHigh;in vec3 aVertexPositionLow;in vec2 aTextureCoord;uniform mat4 projectionMatrix;uniform mat4 viewMatrix;uniform vec4 uGlobalTextureCoord;uniform vec3 uNormalMapBias;uniform vec3 eyePositionHigh;uniform vec3 eyePositionLow;uniform float height;out vec4 vTextureCoord;out vec3 v_vertex;out vec3 cameraPosition;out vec2 vGlobalTextureCoord;out float v_height;void main(void){vec3 aVertexPosition=aVertexPositionHigh+aVertexPositionLow;vec3 nh=height*normalize(aVertexPosition);vTextureCoord.xy=aTextureCoord;vGlobalTextureCoord=uGlobalTextureCoord.xy+(uGlobalTextureCoord.zw-uGlobalTextureCoord.xy)*aTextureCoord;vTextureCoord.zw=uNormalMapBias.z*(aTextureCoord+uNormalMapBias.xy);cameraPosition=eyePositionHigh+eyePositionLow;vec3 highDiff=aVertexPositionHigh-eyePositionHigh;vec3 lowDiff=aVertexPositionLow-eyePositionLow+nh;mat4 viewMatrixRTE=viewMatrix;viewMatrixRTE[3]=vec4(0.0,0.0,0.0,1.0);v_height=height;v_vertex=aVertexPosition+nh;gl_Position=projectionMatrix*viewMatrixRTE*vec4(highDiff*step(1.0,length(highDiff))+lowDiff,1.0);}`,fragmentShader:di("#version 300 es\nprecision highp float;\n#ifdef WEBGL2\n#define TEXTURE_FUNC texture\n#else\n#define TEXTURE_FUNC texture2D\n#endif\n#define SLICE_SIZE 5\n#define blend(DEST, SAMPLER, OFFSET, OPACITY) src = TEXTURE_FUNC(SAMPLER, OFFSET.xy + vTextureCoord.xy * OFFSET.zw); DEST = DEST * (1.0 - src.a * OPACITY) + src * OPACITY;\n#define blendPicking(DEST, OFFSET, SAMPLER, MASK, COLOR, OPACITY) tc = OFFSET.xy + vTextureCoord.xy * OFFSET.zw; t = TEXTURE_FUNC(SAMPLER, tc); p = TEXTURE_FUNC(MASK, tc); DEST = mix(DEST, vec4(max(COLOR.rgb, p.rgb), OPACITY), (t.a == 0.0 ? 0.0: 1.0) * COLOR.a);\nconst vec3 nightStep=10.0*vec3(0.58,0.48,0.25);float getLerpValue(in float min,in float max,in float between){return(clamp(between,min,max)-min)/(max-min);}vec3 aces(vec3 color){float a=2.51;float b=0.03;float c=2.43;float d=0.59;float e=0.14;return clamp((color*(a*color+b))/(color*(c*color+d)+e),0.0,1.0);}bool intersectSphere(vec3 rayOrigin,vec3 rayDirection,float radius,inout float t1,inout float t2){float b=dot(rayDirection,rayOrigin);float c=dot(rayOrigin,rayOrigin)-radius*radius;float d=b*b-c;if(d<-1e-6){return false;}d=max(d,0.0);t1=-b-sqrt(d);t2=-b+sqrt(d);if(t2<0.0){return false;}return true;}bool intersectSphere(vec3 rayOrigin,vec3 rayDirection,float radius,inout float t){float b=dot(rayDirection,rayOrigin);float c=dot(rayOrigin,rayOrigin)-radius*radius;float d=b*b-c;if(d<0.0){return false;}t=-b-sqrt(d);return true;}float intersectSphere(vec3 ro,vec3 rd,vec4 sph){vec3 oc=ro-sph.xyz;float b=dot(oc,rd);float c=dot(oc,oc)-sph.w*sph.w;float h=b*b-c;if(h<0.0)return-1.0;h=sqrt(h);return-b-h;}bool intersectEllipsoid(in vec3 ro,in vec3 rd,in vec3 ra,inout float t){vec3 ocn=ro/ra;vec3 rdn=rd/ra;float a=dot(rdn,rdn);float b=dot(ocn,rdn);float c=dot(ocn,ocn);float h=b*b-a*(c-1.0);if(h<0.0){return false;}t=(-b-sqrt(h))/a;return true;}bool intersectEllipsoid(in vec3 ro,in vec3 rd,in vec3 ra,inout float t1,inout float t2){vec3 ocn=ro/ra;vec3 rdn=rd/ra;float a=dot(rdn,rdn);float b=dot(ocn,rdn);float c=dot(ocn,ocn);float h=b*b-a*(c-1.0);if(h<0.0){return false;}h=sqrt(h);t1=(-b-h)/a;t2=(-b+h)/a;return true;}vec3 normalEllipsoid(in vec3 pos,in vec3 ra){return normalize(pos/(ra*ra));}\n#define PI 3.1415926538\n#define ATMOS_HEIGHT float(${ATMOS_HEIGHT})\n#define RAYLEIGH_SCALE float(${RAYLEIGH_SCALE})\n#define MIE_SCALE float(${MIE_SCALE})\n#define SAMPLE_COUNT 16\n#define SQRT_SAMPLE_COUNT 4\nconst float GROUND_ALBEDO=float(${GROUND_ALBEDO})/PI;const float BOTTOM_RADIUS=float(${BOTTOM_RADIUS});const float TOP_RADIUS=BOTTOM_RADIUS+ATMOS_HEIGHT;const float EQUATORIAL_RADIUS=float(${EQUATORIAL_RADIUS});const vec3 bottomRadii=vec3(EQUATORIAL_RADIUS,EQUATORIAL_RADIUS,BOTTOM_RADIUS);const vec3 topRadii=bottomRadii+ATMOS_HEIGHT;const vec3 SPHERE_TO_ELLIPSOID_SCALE=vec3(BOTTOM_RADIUS)/bottomRadii;const vec2 rayleighMieHeights=vec2(RAYLEIGH_SCALE,MIE_SCALE)*ATMOS_HEIGHT;const vec3 rayleighScatteringCoefficient=vec3(float(${rayleighScatteringCoefficient_0}),float(${rayleighScatteringCoefficient_1}),float(${rayleighScatteringCoefficient_2}))*1e-6;const float mieScatteringCoefficient=float(${mieScatteringCoefficient})*1e-6;const float mieExtinctionCoefficient=float(${mieExtinctionCoefficient})*1e-6;const vec3 ozoneAbsorptionCoefficient=vec3(float(${ozoneAbsorptionCoefficient_0}),float(${ozoneAbsorptionCoefficient_1}),float(${ozoneAbsorptionCoefficient_2}))*1e-6;const float SUN_ANGULAR_RADIUS=float(${SUN_ANGULAR_RADIUS});const float SUN_INTENSITY=float(${SUN_INTENSITY});const float ozoneDensityHeight=float(${ozoneDensityHeight});const float ozoneDensityWide=float(${ozoneDensityWide});vec3 sunWithBloom(vec3 rayDir,vec3 sunDir){float minSunCosTheta=cos(SUN_ANGULAR_RADIUS);float cosTheta=dot(rayDir,sunDir);if(cosTheta>=minSunCosTheta)return vec3(1.0);float offset=minSunCosTheta-cosTheta;float gaussianBloom=exp(-offset*15000.0)*0.7;float invBloom=1.0/(0.09+offset*200.0)*0.01;return vec3(gaussianBloom+invBloom);}vec3 sunWithBloomScaled(vec3 rayDir,vec3 sunDir,float angularScale){float minSunCosTheta=cos(SUN_ANGULAR_RADIUS*angularScale);float cosTheta=dot(rayDir,sunDir);if(cosTheta>=minSunCosTheta)return vec3(1.0);float offset=minSunCosTheta-cosTheta;float gaussianBloom=exp(-offset*15000.0)*0.7;float invBloom=1.0/(0.09+offset*200.0)*0.01;return vec3(gaussianBloom+invBloom);}float rayleighPhase(float angle){return 3.0/(16.0*PI)*(1.0+(angle*angle));}float miePhase(float angle){float g=0.8;return 3.0/(8.0*PI)*((1.0-g*g)*(1.0+angle*angle))/((2.0+g*g)*pow(1.0+g*g-2.0*g*angle,1.5));}vec3 opticalDepth(float height,float angle){vec3 rayOrigin=vec3(0.0,BOTTOM_RADIUS+height,0.0);vec3 rayDirection=vec3(sqrt(1.0-angle*angle),angle,0.0);float t1,t2;intersectSphere(rayOrigin,rayDirection,TOP_RADIUS,t1,t2);float segmentLength=t2/float(SAMPLE_COUNT);float t=segmentLength*0.5;vec3 opticalDepth=vec3(0.0);for(int i=0;i<SAMPLE_COUNT;i++){vec3 position=rayOrigin+t*rayDirection;float height=length(position)-BOTTOM_RADIUS;opticalDepth.xy+=exp(-height/rayleighMieHeights)*segmentLength;opticalDepth.z+=(1.0-min(abs(height-ozoneDensityHeight)/ozoneDensityWide,1.0))*segmentLength;t+=segmentLength;}return opticalDepth;}vec3 transmittance(float height,float angle){vec3 opticalDepth=opticalDepth(height,angle);return exp(-(rayleighScatteringCoefficient*opticalDepth.x+mieExtinctionCoefficient*opticalDepth.y+ozoneAbsorptionCoefficient*opticalDepth.z));}uniform vec4 specular;uniform vec3 diffuse;uniform vec3 ambient;uniform vec3 lightPosition;uniform sampler2D uNormalMap;uniform sampler2D nightTexture;uniform sampler2D specularTexture;uniform sampler2D transmittanceTexture;uniform sampler2D scatteringTexture;uniform sampler2D defaultTexture;uniform sampler2D samplerArr[SLICE_SIZE];uniform vec4 tileOffsetArr[SLICE_SIZE];uniform float layerOpacityArr[SLICE_SIZE];uniform int samplerCount;uniform float nightTextureCoefficient;uniform vec2 maxMinOpacity;uniform float camHeight;uniform float transitionOpacity;in vec4 vTextureCoord;in vec3 v_vertex;in vec3 cameraPosition;in vec2 vGlobalTextureCoord;in float v_height;vec3 sunPos;layout(location=0)out vec4 diffuseColor;vec3 transmittanceFromTexture(float height,float angle){float u=(angle+1.0)*0.5;float v=height/ATMOS_HEIGHT;return texture(transmittanceTexture,vec2(u,v)).xyz;}vec3 multipleScatteringContributionFromTexture(float height,float angle){float u=(angle+1.0)*0.5;float v=height/ATMOS_HEIGHT;return texture(scatteringTexture,vec2(u,v)).xyz;}void getSunIlluminance(in vec3 point,in vec3 lightDir,out vec3 sunIlluminance){float mu_s=dot(normalize(point),lightDir);float height=length(point)-BOTTOM_RADIUS;sunIlluminance=SUN_INTENSITY*transmittanceFromTexture(height,mu_s);}void atmosGroundColor(out vec4 fragColor,in vec3 normal){vec3 cameraPosition=cameraPosition;if(length(cameraPosition*SPHERE_TO_ELLIPSOID_SCALE)<BOTTOM_RADIUS+1.0){cameraPosition=normalize(cameraPosition*SPHERE_TO_ELLIPSOID_SCALE)*(BOTTOM_RADIUS+1.0)/SPHERE_TO_ELLIPSOID_SCALE;}vec3 rayDirection=normalize(v_vertex-cameraPosition);vec3 lightDir=normalize(sunPos);rayDirection=normalize(rayDirection*SPHERE_TO_ELLIPSOID_SCALE);vec3 camPos=cameraPosition*SPHERE_TO_ELLIPSOID_SCALE;lightDir=normalize(lightDir*SPHERE_TO_ELLIPSOID_SCALE);vec3 light=vec3(0.0);vec3 transmittanceFromCameraToSpace=vec3(1.0);float offset=0.0;float distanceToSpace=0.0;intersectSphere(camPos,rayDirection,TOP_RADIUS,offset,distanceToSpace);vec3 rayOrigin=camPos;if(offset>0.0){rayOrigin+=rayDirection*offset;}float height=length(rayOrigin)-BOTTOM_RADIUS;float rayAngle=dot(rayOrigin,rayDirection)/length(rayOrigin);bool cameraBelow=rayAngle<0.0;transmittanceFromCameraToSpace=transmittanceFromTexture(height,cameraBelow ?-rayAngle : rayAngle);float phaseAngle=dot(lightDir,rayDirection);float rayleighPhase=rayleighPhase(phaseAngle);float miePhase=miePhase(phaseAngle);float distanceToGround=0.0;bool hitGround=intersectSphere(camPos,rayDirection,BOTTOM_RADIUS,distanceToGround)&&distanceToGround>0.0;if(length(v_vertex*SPHERE_TO_ELLIPSOID_SCALE)>BOTTOM_RADIUS){distanceToGround=distance(camPos,v_vertex*SPHERE_TO_ELLIPSOID_SCALE);}float segmentLength=(distanceToGround-max(offset,0.0))/float(SAMPLE_COUNT);float t=segmentLength*0.5;vec3 transmittanceCamera;vec3 transmittanceLight;for(int i=0;i<SAMPLE_COUNT;i++){vec3 position=rayOrigin+t*rayDirection;float height=length(position)-BOTTOM_RADIUS;vec3 up=position/length(position);float rayAngle=dot(up,rayDirection);float lightAngle=dot(up,lightDir);vec3 transmittanceToSpace=transmittanceFromTexture(height,cameraBelow ?-rayAngle : rayAngle);transmittanceCamera=cameraBelow ?(transmittanceToSpace/transmittanceFromCameraToSpace):(transmittanceFromCameraToSpace/transmittanceToSpace);transmittanceLight=transmittanceFromTexture(height,lightAngle);vec2 opticalDensity=exp(-height/rayleighMieHeights);vec3 scatteredLight=transmittanceLight*(rayleighScatteringCoefficient*opticalDensity.x*rayleighPhase+mieScatteringCoefficient*opticalDensity.y*miePhase);scatteredLight+=multipleScatteringContributionFromTexture(height,lightAngle)*(rayleighScatteringCoefficient*opticalDensity.x+mieScatteringCoefficient*opticalDensity.y);light+=transmittanceCamera*scatteredLight*segmentLength;t+=segmentLength;}light*=SUN_INTENSITY;vec3 hitPoint=camPos+rayDirection*distanceToGround;vec3 up=normalize(hitPoint);float diffuseAngle=max(dot(up,lightDir),0.0);float lightAngle=dot(normal,lightDir);vec3 tA=transmittanceCamera*GROUND_ALBEDO*SUN_INTENSITY;vec3 scatteringLight=multipleScatteringContributionFromTexture(height,lightAngle);vec3 diffuseTransmittanceLight=transmittanceLight*diffuseAngle;light+=tA*(scatteringLight+diffuseTransmittanceLight);fragColor=vec4(pow(light*8.0,vec3(1.0/2.2)),1.0);}void getAtmosFadingOpacity(out float opacity){float c=length(cameraPosition);float maxDist=sqrt(c*c-BOTTOM_RADIUS*BOTTOM_RADIUS);float minDist=c-BOTTOM_RADIUS;float vertDist=distance(cameraPosition,v_vertex);opacity=clamp(maxMinOpacity.y+(maxMinOpacity.x-maxMinOpacity.y)*getLerpValue(minDist,maxDist,vertDist),0.0,1.0);}void main(void){sunPos=lightPosition;vec3 texNormal=texture(uNormalMap,vTextureCoord.zw).rgb;vec3 normal=normalize((texNormal-0.5)*2.0);float minH=1200000.0;float maxH=minH*3.0;float nightCoef=getLerpValue(minH,maxH,camHeight)*nightTextureCoefficient;vec3 lightDir=normalize(sunPos);vec3 viewDir=normalize(cameraPosition-v_vertex);vec4 atmosColor;atmosGroundColor(atmosColor,normal);vec3 sunIlluminance;getSunIlluminance(v_vertex*SPHERE_TO_ELLIPSOID_SCALE,lightDir*SPHERE_TO_ELLIPSOID_SCALE,sunIlluminance);float overGround=1.0-step(0.1,v_height);float shininess=texture(specularTexture,vGlobalTextureCoord.st).r*255.0*overGround;vec3 reflectionDirection=reflect(-lightDir,normal);float reflection=max(dot(reflectionDirection,viewDir),0.0);vec3 spec=sunIlluminance*specular.rgb*pow(reflection,specular.w)*shininess;float diffuseLightWeighting=max(dot(normal,lightDir),0.0);vec4 nightImageColor=texture(nightTexture,vGlobalTextureCoord.st);vec3 night=nightStep*(.18-diffuseLightWeighting*3.0)*nightImageColor.rgb*nightCoef;night*=overGround*step(0.0,night);vec4 lightWeighting=vec4(ambient+sunIlluminance*diffuse*diffuseLightWeighting+night,1.0);float fadingOpacity;getAtmosFadingOpacity(fadingOpacity);getSunIlluminance(cameraPosition,viewDir*SPHERE_TO_ELLIPSOID_SCALE,sunIlluminance);spec*=sunIlluminance;diffuseColor=texture(defaultTexture,vTextureCoord.xy);if(samplerCount==0){diffuseColor=mix(diffuseColor*lightWeighting,atmosColor,fadingOpacity)+vec4(spec,0.0);diffuseColor*=transitionOpacity;return;}vec4 src;blend(diffuseColor,samplerArr[0],tileOffsetArr[0],layerOpacityArr[0]);if(samplerCount==1){diffuseColor=mix(diffuseColor*lightWeighting,atmosColor*diffuseColor.a,fadingOpacity)+vec4(spec,0.0);diffuseColor*=transitionOpacity;return;}blend(diffuseColor,samplerArr[1],tileOffsetArr[1],layerOpacityArr[1]);if(samplerCount==2){diffuseColor=mix(diffuseColor*lightWeighting,atmosColor*diffuseColor.a,fadingOpacity)+vec4(spec,0.0);diffuseColor*=transitionOpacity;return;}blend(diffuseColor,samplerArr[2],tileOffsetArr[2],layerOpacityArr[2]);if(samplerCount==3){diffuseColor=mix(diffuseColor*lightWeighting,atmosColor*diffuseColor.a,fadingOpacity)+vec4(spec,0.0);diffuseColor*=transitionOpacity;return;}blend(diffuseColor,samplerArr[3],tileOffsetArr[3],layerOpacityArr[3]);if(samplerCount==4){diffuseColor=mix(diffuseColor*lightWeighting,atmosColor*diffuseColor.a,fadingOpacity)+vec4(spec,0.0);diffuseColor*=transitionOpacity;return;}blend(diffuseColor,samplerArr[4],tileOffsetArr[4],layerOpacityArr[4]);diffuseColor=mix(diffuseColor*lightWeighting,atmosColor*diffuseColor.a,fadingOpacity)+vec4(spec,0.0);diffuseColor*=transitionOpacity;}",h)})}const er={ATMOS_HEIGHT:1e5,RAYLEIGH_SCALE:.08,MIE_SCALE:.012,GROUND_ALBEDO:.05,BOTTOM_RADIUS:6356752314245179e-9,EQUATORIAL_RADIUS:6378137,rayleighScatteringCoefficient_0:5.802,rayleighScatteringCoefficient_1:13.558,rayleighScatteringCoefficient_2:33.1,mieScatteringCoefficient:3.996,mieExtinctionCoefficient:4.44,ozoneAbsorptionCoefficient_0:.65,ozoneAbsorptionCoefficient_1:1.881,ozoneAbsorptionCoefficient_2:.085,SUN_ANGULAR_RADIUS:.004685,SUN_INTENSITY:1,ozoneDensityHeight:25e3,ozoneDensityWide:15e3,disableSunDisk:!1};var Hh="attribute vec2 corners;void main(void){gl_Position=vec4(corners,0.0,1.0);}",Vh="precision lowp float;float getLerpValue(in float min,in float max,in float between){return(clamp(between,min,max)-min)/(max-min);}vec3 aces(vec3 color){float a=2.51;float b=0.03;float c=2.43;float d=0.59;float e=0.14;return clamp((color*(a*color+b))/(color*(c*color+d)+e),0.0,1.0);}bool intersectSphere(vec3 rayOrigin,vec3 rayDirection,float radius,inout float t1,inout float t2){float b=dot(rayDirection,rayOrigin);float c=dot(rayOrigin,rayOrigin)-radius*radius;float d=b*b-c;if(d<-1e-6){return false;}d=max(d,0.0);t1=-b-sqrt(d);t2=-b+sqrt(d);if(t2<0.0){return false;}return true;}bool intersectSphere(vec3 rayOrigin,vec3 rayDirection,float radius,inout float t){float b=dot(rayDirection,rayOrigin);float c=dot(rayOrigin,rayOrigin)-radius*radius;float d=b*b-c;if(d<0.0){return false;}t=-b-sqrt(d);return true;}float intersectSphere(vec3 ro,vec3 rd,vec4 sph){vec3 oc=ro-sph.xyz;float b=dot(oc,rd);float c=dot(oc,oc)-sph.w*sph.w;float h=b*b-c;if(h<0.0)return-1.0;h=sqrt(h);return-b-h;}bool intersectEllipsoid(in vec3 ro,in vec3 rd,in vec3 ra,inout float t){vec3 ocn=ro/ra;vec3 rdn=rd/ra;float a=dot(rdn,rdn);float b=dot(ocn,rdn);float c=dot(ocn,ocn);float h=b*b-a*(c-1.0);if(h<0.0){return false;}t=(-b-sqrt(h))/a;return true;}bool intersectEllipsoid(in vec3 ro,in vec3 rd,in vec3 ra,inout float t1,inout float t2){vec3 ocn=ro/ra;vec3 rdn=rd/ra;float a=dot(rdn,rdn);float b=dot(ocn,rdn);float c=dot(ocn,ocn);float h=b*b-a*(c-1.0);if(h<0.0){return false;}h=sqrt(h);t1=(-b-h)/a;t2=(-b+h)/a;return true;}vec3 normalEllipsoid(in vec3 pos,in vec3 ra){return normalize(pos/(ra*ra));}\n#define PI 3.1415926538\n#define ATMOS_HEIGHT float(${ATMOS_HEIGHT})\n#define RAYLEIGH_SCALE float(${RAYLEIGH_SCALE})\n#define MIE_SCALE float(${MIE_SCALE})\n#define SAMPLE_COUNT 16\n#define SQRT_SAMPLE_COUNT 4\nconst float GROUND_ALBEDO=float(${GROUND_ALBEDO})/PI;const float BOTTOM_RADIUS=float(${BOTTOM_RADIUS});const float TOP_RADIUS=BOTTOM_RADIUS+ATMOS_HEIGHT;const float EQUATORIAL_RADIUS=float(${EQUATORIAL_RADIUS});const vec3 bottomRadii=vec3(EQUATORIAL_RADIUS,EQUATORIAL_RADIUS,BOTTOM_RADIUS);const vec3 topRadii=bottomRadii+ATMOS_HEIGHT;const vec3 SPHERE_TO_ELLIPSOID_SCALE=vec3(BOTTOM_RADIUS)/bottomRadii;const vec2 rayleighMieHeights=vec2(RAYLEIGH_SCALE,MIE_SCALE)*ATMOS_HEIGHT;const vec3 rayleighScatteringCoefficient=vec3(float(${rayleighScatteringCoefficient_0}),float(${rayleighScatteringCoefficient_1}),float(${rayleighScatteringCoefficient_2}))*1e-6;const float mieScatteringCoefficient=float(${mieScatteringCoefficient})*1e-6;const float mieExtinctionCoefficient=float(${mieExtinctionCoefficient})*1e-6;const vec3 ozoneAbsorptionCoefficient=vec3(float(${ozoneAbsorptionCoefficient_0}),float(${ozoneAbsorptionCoefficient_1}),float(${ozoneAbsorptionCoefficient_2}))*1e-6;const float SUN_ANGULAR_RADIUS=float(${SUN_ANGULAR_RADIUS});const float SUN_INTENSITY=float(${SUN_INTENSITY});const float ozoneDensityHeight=float(${ozoneDensityHeight});const float ozoneDensityWide=float(${ozoneDensityWide});vec3 sunWithBloom(vec3 rayDir,vec3 sunDir){float minSunCosTheta=cos(SUN_ANGULAR_RADIUS);float cosTheta=dot(rayDir,sunDir);if(cosTheta>=minSunCosTheta)return vec3(1.0);float offset=minSunCosTheta-cosTheta;float gaussianBloom=exp(-offset*15000.0)*0.7;float invBloom=1.0/(0.09+offset*200.0)*0.01;return vec3(gaussianBloom+invBloom);}vec3 sunWithBloomScaled(vec3 rayDir,vec3 sunDir,float angularScale){float minSunCosTheta=cos(SUN_ANGULAR_RADIUS*angularScale);float cosTheta=dot(rayDir,sunDir);if(cosTheta>=minSunCosTheta)return vec3(1.0);float offset=minSunCosTheta-cosTheta;float gaussianBloom=exp(-offset*15000.0)*0.7;float invBloom=1.0/(0.09+offset*200.0)*0.01;return vec3(gaussianBloom+invBloom);}float rayleighPhase(float angle){return 3.0/(16.0*PI)*(1.0+(angle*angle));}float miePhase(float angle){float g=0.8;return 3.0/(8.0*PI)*((1.0-g*g)*(1.0+angle*angle))/((2.0+g*g)*pow(1.0+g*g-2.0*g*angle,1.5));}vec3 opticalDepth(float height,float angle){vec3 rayOrigin=vec3(0.0,BOTTOM_RADIUS+height,0.0);vec3 rayDirection=vec3(sqrt(1.0-angle*angle),angle,0.0);float t1,t2;intersectSphere(rayOrigin,rayDirection,TOP_RADIUS,t1,t2);float segmentLength=t2/float(SAMPLE_COUNT);float t=segmentLength*0.5;vec3 opticalDepth=vec3(0.0);for(int i=0;i<SAMPLE_COUNT;i++){vec3 position=rayOrigin+t*rayDirection;float height=length(position)-BOTTOM_RADIUS;opticalDepth.xy+=exp(-height/rayleighMieHeights)*segmentLength;opticalDepth.z+=(1.0-min(abs(height-ozoneDensityHeight)/ozoneDensityWide,1.0))*segmentLength;t+=segmentLength;}return opticalDepth;}vec3 transmittance(float height,float angle){vec3 opticalDepth=opticalDepth(height,angle);return exp(-(rayleighScatteringCoefficient*opticalDepth.x+mieExtinctionCoefficient*opticalDepth.y+ozoneAbsorptionCoefficient*opticalDepth.z));}\n#define DISABLE_SUN_DISK ${ disableSunDisk }\nuniform mat4 viewMatrix;uniform vec3 sunPos;uniform vec3 camPos;uniform vec2 iResolution;uniform float fov;uniform float opacity;uniform float isOrthographic;uniform vec4 frustumParams;uniform sampler2D transmittanceTexture;uniform sampler2D scatteringTexture;float valueHSV(vec3 rgb){return max(max(rgb.r,rgb.g),rgb.b);}vec3 transmittanceFromTexture(float height,float angle){float u=(angle+1.0)*0.5;float v=height/ATMOS_HEIGHT;return texture2D(transmittanceTexture,vec2(u,v)).xyz;}vec3 multipleScatteringContributionFromTexture(float height,float angle){float u=(angle+1.0)*0.5;float v=height/ATMOS_HEIGHT;return texture2D(scatteringTexture,vec2(u,v)).xyz;}bool intersectEllipsoidToSphere(in vec3 ro,in vec3 rd,in vec3 ellRadii,in float sphereRadius,out float t1,out float t2){float offset=0.0,distanceToSpace=0.0;if(intersectEllipsoid(ro,rd,ellRadii,offset,distanceToSpace)){vec3 hitEll=ro+rd*offset;vec3 nEll=normalEllipsoid(hitEll,ellRadii);float t=0.0;bool intersectsSphere=intersectSphere(hitEll,nEll,sphereRadius,t);vec3 hitSphere=hitEll+nEll*t;t1=length(hitSphere-ro);hitEll=ro+rd*distanceToSpace;nEll=normalEllipsoid(hitEll,ellRadii);t=0.0;intersectsSphere=intersectSphere(hitEll,nEll,sphereRadius,t);hitSphere=hitEll+nEll*t;t2=length(hitSphere-ro);return true;}return false;}mat4 transpose(in mat4 m){vec4 i0=m[0];vec4 i1=m[1];vec4 i2=m[2];vec4 i3=m[3];mat4 outMatrix=mat4(vec4(i0.x,i1.x,i2.x,i3.x),vec4(i0.y,i1.y,i2.y,i3.y),vec4(i0.z,i1.z,i2.z,i3.z),vec4(i0.w,i1.w,i2.w,i3.w));return outMatrix;}void mainImage(out vec4 fragColor){vec3 cameraPosition=camPos;vec3 lightDirection=normalize(sunPos);vec2 uv=(2.0*gl_FragCoord.xy-iResolution.xy)/iResolution.y;vec3 rayDirection;if(isOrthographic!=0.0){float px=uv.x*iResolution.y/iResolution.x;float py=uv.y;float dx=0.5*frustumParams.x*px;float dy=0.5*frustumParams.y*py;mat4 viewMatrixT=transpose(viewMatrix);vec3 right=normalize(viewMatrixT[0].xyz);vec3 up=normalize(viewMatrixT[1].xyz);vec3 backward=normalize(viewMatrixT[2].xyz);vec3 forward=-backward;rayDirection=forward;cameraPosition=cameraPosition+right*dx+up*dy;}else{float fieldOfView=fov;float z=1.0/tan(fieldOfView*0.5*PI/180.0);rayDirection=normalize(vec3(uv,-z));vec4 rd=transpose(viewMatrix)*vec4(rayDirection,1.0);rayDirection=rd.xyz;}vec3 light=vec3(0.0);vec3 transmittanceFromCameraToSpace=vec3(1.0);float offset=0.0;float distanceToSpace=0.0;rayDirection=normalize(rayDirection*SPHERE_TO_ELLIPSOID_SCALE);cameraPosition*=SPHERE_TO_ELLIPSOID_SCALE;lightDirection=normalize(lightDirection*SPHERE_TO_ELLIPSOID_SCALE);if(length(cameraPosition)<BOTTOM_RADIUS+100.0){cameraPosition=normalize(cameraPosition)*(BOTTOM_RADIUS+100.0);}if(intersectSphere(cameraPosition,rayDirection,TOP_RADIUS,offset,distanceToSpace)){vec3 rayOrigin=cameraPosition;if(offset>0.0){rayOrigin=cameraPosition+rayDirection*offset;}float height=length(rayOrigin)-BOTTOM_RADIUS;float rayAngle=dot(rayOrigin,rayDirection)/length(rayOrigin);bool cameraBelow=rayAngle<0.0;transmittanceFromCameraToSpace=transmittanceFromTexture(height,cameraBelow ?-rayAngle : rayAngle);float phaseAngle=dot(lightDirection,rayDirection);float rayleighPhase=rayleighPhase(phaseAngle);float miePhase=miePhase(phaseAngle);float distanceToGround=0.0;bool hitGround=intersectSphere(cameraPosition,rayDirection,BOTTOM_RADIUS,distanceToGround)&&distanceToGround>0.0;if(intersectSphere(cameraPosition,rayDirection,BOTTOM_RADIUS-100000.0,distanceToGround)&&hitGround){fragColor=vec4(0.47,0.47,0.5,1.0);return;}float segmentLength=abs(((hitGround ? distanceToGround : distanceToSpace)-max(offset,0.0))/float(SAMPLE_COUNT));float t=segmentLength*0.5;vec3 transmittanceCamera;vec3 transmittanceLight;for(int i=0;i<SAMPLE_COUNT;i++){vec3 position=rayOrigin+t*rayDirection;float height=length(position)-BOTTOM_RADIUS;vec3 up=position/length(position);float rayAngle=dot(up,rayDirection);float lightAngle=dot(up,lightDirection);vec3 transmittanceToSpace=transmittanceFromTexture(height,cameraBelow ?-rayAngle : rayAngle);transmittanceCamera=cameraBelow ?(transmittanceToSpace/transmittanceFromCameraToSpace):(transmittanceFromCameraToSpace/transmittanceToSpace);transmittanceLight=transmittanceFromTexture(height,lightAngle);vec2 opticalDensity=exp(-height/rayleighMieHeights);vec3 scatteredLight=transmittanceLight*(rayleighScatteringCoefficient*opticalDensity.x*rayleighPhase+mieScatteringCoefficient*opticalDensity.y*miePhase);scatteredLight+=multipleScatteringContributionFromTexture(height,lightAngle)*(rayleighScatteringCoefficient*opticalDensity.x+mieScatteringCoefficient*opticalDensity.y);light+=transmittanceCamera*scatteredLight*segmentLength;t+=segmentLength;}light*=SUN_INTENSITY;if(hitGround){vec3 hitPoint=cameraPosition+rayDirection*distanceToGround;vec3 up=hitPoint/length(hitPoint);float diffuseAngle=max(dot(up,lightDirection),0.0);float lightAngle=dot(up,lightDirection);light+=transmittanceCamera*GROUND_ALBEDO*multipleScatteringContributionFromTexture(height,lightAngle)*SUN_INTENSITY;light+=transmittanceCamera*transmittanceLight*GROUND_ALBEDO*diffuseAngle*SUN_INTENSITY;}}\n#if !DISABLE_SUN_DISK\n{float distanceToGround=0.0;bool hitGround=intersectSphere(cameraPosition,rayDirection,BOTTOM_RADIUS,distanceToGround)&&distanceToGround>0.0;if(!hitGround){vec3 sunLum;if(isOrthographic!=0.0){float z=1.0/tan(fov*0.5*PI/180.0);vec3 viewRay=normalize(vec3(uv,-z));vec4 rd=transpose(viewMatrix)*vec4(viewRay,1.0);vec3 pseudoRayDirection=normalize(rd.xyz);const float sunOrthoAngularScale=2.0;sunLum=sunWithBloomScaled(pseudoRayDirection,lightDirection,sunOrthoAngularScale)*vec3(1.0,1.0,0.8);}else{sunLum=sunWithBloom(rayDirection,lightDirection)*vec3(1.0,1.0,0.8);}sunLum=smoothstep(0.002,1.0,sunLum);light+=sunLum*SUN_INTENSITY*transmittanceFromCameraToSpace;}}\n#endif\nvec4 color=vec4(pow(opacity*light*8.0,vec3(1.0/2.2)),valueHSV(light)*clamp(opacity,0.0,1.0));fragColor=color;}void main(void){mainImage(gl_FragColor);}";class Uh extends Q{constructor(t={}){super({name:"Atmosphere",...t}),this._transmittanceBuffer=null,this._scatteringBuffer=null,this.opacity=1;const s=t;this._parameters=JSON.parse(JSON.stringify({...er,...s}))}setParameters(t){this._parameters=JSON.parse(JSON.stringify(t)),this.initLookupTexturesShaders(),this.drawLookupTextures(),this.removeLookupTexturesShaders(),this.initPlanetAtmosphereShader()}get parameters(){return JSON.parse(JSON.stringify(this._parameters))}initPlanetAtmosphereShader(){var t;(t=this.planet)==null||t.initAtmosphereShader(this._parameters)}oninit(){this.renderer&&(this._initLookupTextures(),this.initLookupTexturesShaders(),this.drawLookupTextures(),this.removeLookupTexturesShaders(),this.initBackgroundShader(),this.activate())}initLookupTexturesShaders(){var t,s;this.renderer&&(this.renderer.handler.addProgram((t=this._parameters,new X("transmittance",{uniforms:{iResolution:"vec2"},attributes:{a_position:"vec2"},vertexShader:"attribute vec2 a_position;void main(void){gl_Position=vec4(a_position,0.0,1.0);}",fragmentShader:di("precision highp float;float getLerpValue(in float min,in float max,in float between){return(clamp(between,min,max)-min)/(max-min);}vec3 aces(vec3 color){float a=2.51;float b=0.03;float c=2.43;float d=0.59;float e=0.14;return clamp((color*(a*color+b))/(color*(c*color+d)+e),0.0,1.0);}bool intersectSphere(vec3 rayOrigin,vec3 rayDirection,float radius,inout float t1,inout float t2){float b=dot(rayDirection,rayOrigin);float c=dot(rayOrigin,rayOrigin)-radius*radius;float d=b*b-c;if(d<-1e-6){return false;}d=max(d,0.0);t1=-b-sqrt(d);t2=-b+sqrt(d);if(t2<0.0){return false;}return true;}bool intersectSphere(vec3 rayOrigin,vec3 rayDirection,float radius,inout float t){float b=dot(rayDirection,rayOrigin);float c=dot(rayOrigin,rayOrigin)-radius*radius;float d=b*b-c;if(d<0.0){return false;}t=-b-sqrt(d);return true;}float intersectSphere(vec3 ro,vec3 rd,vec4 sph){vec3 oc=ro-sph.xyz;float b=dot(oc,rd);float c=dot(oc,oc)-sph.w*sph.w;float h=b*b-c;if(h<0.0)return-1.0;h=sqrt(h);return-b-h;}bool intersectEllipsoid(in vec3 ro,in vec3 rd,in vec3 ra,inout float t){vec3 ocn=ro/ra;vec3 rdn=rd/ra;float a=dot(rdn,rdn);float b=dot(ocn,rdn);float c=dot(ocn,ocn);float h=b*b-a*(c-1.0);if(h<0.0){return false;}t=(-b-sqrt(h))/a;return true;}bool intersectEllipsoid(in vec3 ro,in vec3 rd,in vec3 ra,inout float t1,inout float t2){vec3 ocn=ro/ra;vec3 rdn=rd/ra;float a=dot(rdn,rdn);float b=dot(ocn,rdn);float c=dot(ocn,ocn);float h=b*b-a*(c-1.0);if(h<0.0){return false;}h=sqrt(h);t1=(-b-h)/a;t2=(-b+h)/a;return true;}vec3 normalEllipsoid(in vec3 pos,in vec3 ra){return normalize(pos/(ra*ra));}\n#define PI 3.1415926538\n#define ATMOS_HEIGHT float(${ATMOS_HEIGHT})\n#define RAYLEIGH_SCALE float(${RAYLEIGH_SCALE})\n#define MIE_SCALE float(${MIE_SCALE})\n#define SAMPLE_COUNT 16\n#define SQRT_SAMPLE_COUNT 4\nconst float GROUND_ALBEDO=float(${GROUND_ALBEDO})/PI;const float BOTTOM_RADIUS=float(${BOTTOM_RADIUS});const float TOP_RADIUS=BOTTOM_RADIUS+ATMOS_HEIGHT;const float EQUATORIAL_RADIUS=float(${EQUATORIAL_RADIUS});const vec3 bottomRadii=vec3(EQUATORIAL_RADIUS,EQUATORIAL_RADIUS,BOTTOM_RADIUS);const vec3 topRadii=bottomRadii+ATMOS_HEIGHT;const vec3 SPHERE_TO_ELLIPSOID_SCALE=vec3(BOTTOM_RADIUS)/bottomRadii;const vec2 rayleighMieHeights=vec2(RAYLEIGH_SCALE,MIE_SCALE)*ATMOS_HEIGHT;const vec3 rayleighScatteringCoefficient=vec3(float(${rayleighScatteringCoefficient_0}),float(${rayleighScatteringCoefficient_1}),float(${rayleighScatteringCoefficient_2}))*1e-6;const float mieScatteringCoefficient=float(${mieScatteringCoefficient})*1e-6;const float mieExtinctionCoefficient=float(${mieExtinctionCoefficient})*1e-6;const vec3 ozoneAbsorptionCoefficient=vec3(float(${ozoneAbsorptionCoefficient_0}),float(${ozoneAbsorptionCoefficient_1}),float(${ozoneAbsorptionCoefficient_2}))*1e-6;const float SUN_ANGULAR_RADIUS=float(${SUN_ANGULAR_RADIUS});const float SUN_INTENSITY=float(${SUN_INTENSITY});const float ozoneDensityHeight=float(${ozoneDensityHeight});const float ozoneDensityWide=float(${ozoneDensityWide});vec3 sunWithBloom(vec3 rayDir,vec3 sunDir){float minSunCosTheta=cos(SUN_ANGULAR_RADIUS);float cosTheta=dot(rayDir,sunDir);if(cosTheta>=minSunCosTheta)return vec3(1.0);float offset=minSunCosTheta-cosTheta;float gaussianBloom=exp(-offset*15000.0)*0.7;float invBloom=1.0/(0.09+offset*200.0)*0.01;return vec3(gaussianBloom+invBloom);}vec3 sunWithBloomScaled(vec3 rayDir,vec3 sunDir,float angularScale){float minSunCosTheta=cos(SUN_ANGULAR_RADIUS*angularScale);float cosTheta=dot(rayDir,sunDir);if(cosTheta>=minSunCosTheta)return vec3(1.0);float offset=minSunCosTheta-cosTheta;float gaussianBloom=exp(-offset*15000.0)*0.7;float invBloom=1.0/(0.09+offset*200.0)*0.01;return vec3(gaussianBloom+invBloom);}float rayleighPhase(float angle){return 3.0/(16.0*PI)*(1.0+(angle*angle));}float miePhase(float angle){float g=0.8;return 3.0/(8.0*PI)*((1.0-g*g)*(1.0+angle*angle))/((2.0+g*g)*pow(1.0+g*g-2.0*g*angle,1.5));}vec3 opticalDepth(float height,float angle){vec3 rayOrigin=vec3(0.0,BOTTOM_RADIUS+height,0.0);vec3 rayDirection=vec3(sqrt(1.0-angle*angle),angle,0.0);float t1,t2;intersectSphere(rayOrigin,rayDirection,TOP_RADIUS,t1,t2);float segmentLength=t2/float(SAMPLE_COUNT);float t=segmentLength*0.5;vec3 opticalDepth=vec3(0.0);for(int i=0;i<SAMPLE_COUNT;i++){vec3 position=rayOrigin+t*rayDirection;float height=length(position)-BOTTOM_RADIUS;opticalDepth.xy+=exp(-height/rayleighMieHeights)*segmentLength;opticalDepth.z+=(1.0-min(abs(height-ozoneDensityHeight)/ozoneDensityWide,1.0))*segmentLength;t+=segmentLength;}return opticalDepth;}vec3 transmittance(float height,float angle){vec3 opticalDepth=opticalDepth(height,angle);return exp(-(rayleighScatteringCoefficient*opticalDepth.x+mieExtinctionCoefficient*opticalDepth.y+ozoneAbsorptionCoefficient*opticalDepth.z));}uniform vec2 iResolution;void main(void){vec2 uv=gl_FragCoord.xy/iResolution.xy;float height=uv.y*ATMOS_HEIGHT;float angle=uv.x*2.0-1.0;gl_FragColor=vec4(transmittance(height,angle),1.0);}",t||er)}))),this.renderer.handler.addProgram((s=this._parameters,new X("scattering",{uniforms:{iResolution:"vec2",transmittanceTexture:"sampler2d"},attributes:{a_position:"vec2"},vertexShader:"attribute vec2 a_position;void main(void){gl_Position=vec4(a_position,0.0,1.0);}",fragmentShader:di("precision highp float;float getLerpValue(in float min,in float max,in float between){return(clamp(between,min,max)-min)/(max-min);}vec3 aces(vec3 color){float a=2.51;float b=0.03;float c=2.43;float d=0.59;float e=0.14;return clamp((color*(a*color+b))/(color*(c*color+d)+e),0.0,1.0);}bool intersectSphere(vec3 rayOrigin,vec3 rayDirection,float radius,inout float t1,inout float t2){float b=dot(rayDirection,rayOrigin);float c=dot(rayOrigin,rayOrigin)-radius*radius;float d=b*b-c;if(d<-1e-6){return false;}d=max(d,0.0);t1=-b-sqrt(d);t2=-b+sqrt(d);if(t2<0.0){return false;}return true;}bool intersectSphere(vec3 rayOrigin,vec3 rayDirection,float radius,inout float t){float b=dot(rayDirection,rayOrigin);float c=dot(rayOrigin,rayOrigin)-radius*radius;float d=b*b-c;if(d<0.0){return false;}t=-b-sqrt(d);return true;}float intersectSphere(vec3 ro,vec3 rd,vec4 sph){vec3 oc=ro-sph.xyz;float b=dot(oc,rd);float c=dot(oc,oc)-sph.w*sph.w;float h=b*b-c;if(h<0.0)return-1.0;h=sqrt(h);return-b-h;}bool intersectEllipsoid(in vec3 ro,in vec3 rd,in vec3 ra,inout float t){vec3 ocn=ro/ra;vec3 rdn=rd/ra;float a=dot(rdn,rdn);float b=dot(ocn,rdn);float c=dot(ocn,ocn);float h=b*b-a*(c-1.0);if(h<0.0){return false;}t=(-b-sqrt(h))/a;return true;}bool intersectEllipsoid(in vec3 ro,in vec3 rd,in vec3 ra,inout float t1,inout float t2){vec3 ocn=ro/ra;vec3 rdn=rd/ra;float a=dot(rdn,rdn);float b=dot(ocn,rdn);float c=dot(ocn,ocn);float h=b*b-a*(c-1.0);if(h<0.0){return false;}h=sqrt(h);t1=(-b-h)/a;t2=(-b+h)/a;return true;}vec3 normalEllipsoid(in vec3 pos,in vec3 ra){return normalize(pos/(ra*ra));}\n#define PI 3.1415926538\n#define ATMOS_HEIGHT float(${ATMOS_HEIGHT})\n#define RAYLEIGH_SCALE float(${RAYLEIGH_SCALE})\n#define MIE_SCALE float(${MIE_SCALE})\n#define SAMPLE_COUNT 16\n#define SQRT_SAMPLE_COUNT 4\nconst float GROUND_ALBEDO=float(${GROUND_ALBEDO})/PI;const float BOTTOM_RADIUS=float(${BOTTOM_RADIUS});const float TOP_RADIUS=BOTTOM_RADIUS+ATMOS_HEIGHT;const float EQUATORIAL_RADIUS=float(${EQUATORIAL_RADIUS});const vec3 bottomRadii=vec3(EQUATORIAL_RADIUS,EQUATORIAL_RADIUS,BOTTOM_RADIUS);const vec3 topRadii=bottomRadii+ATMOS_HEIGHT;const vec3 SPHERE_TO_ELLIPSOID_SCALE=vec3(BOTTOM_RADIUS)/bottomRadii;const vec2 rayleighMieHeights=vec2(RAYLEIGH_SCALE,MIE_SCALE)*ATMOS_HEIGHT;const vec3 rayleighScatteringCoefficient=vec3(float(${rayleighScatteringCoefficient_0}),float(${rayleighScatteringCoefficient_1}),float(${rayleighScatteringCoefficient_2}))*1e-6;const float mieScatteringCoefficient=float(${mieScatteringCoefficient})*1e-6;const float mieExtinctionCoefficient=float(${mieExtinctionCoefficient})*1e-6;const vec3 ozoneAbsorptionCoefficient=vec3(float(${ozoneAbsorptionCoefficient_0}),float(${ozoneAbsorptionCoefficient_1}),float(${ozoneAbsorptionCoefficient_2}))*1e-6;const float SUN_ANGULAR_RADIUS=float(${SUN_ANGULAR_RADIUS});const float SUN_INTENSITY=float(${SUN_INTENSITY});const float ozoneDensityHeight=float(${ozoneDensityHeight});const float ozoneDensityWide=float(${ozoneDensityWide});vec3 sunWithBloom(vec3 rayDir,vec3 sunDir){float minSunCosTheta=cos(SUN_ANGULAR_RADIUS);float cosTheta=dot(rayDir,sunDir);if(cosTheta>=minSunCosTheta)return vec3(1.0);float offset=minSunCosTheta-cosTheta;float gaussianBloom=exp(-offset*15000.0)*0.7;float invBloom=1.0/(0.09+offset*200.0)*0.01;return vec3(gaussianBloom+invBloom);}vec3 sunWithBloomScaled(vec3 rayDir,vec3 sunDir,float angularScale){float minSunCosTheta=cos(SUN_ANGULAR_RADIUS*angularScale);float cosTheta=dot(rayDir,sunDir);if(cosTheta>=minSunCosTheta)return vec3(1.0);float offset=minSunCosTheta-cosTheta;float gaussianBloom=exp(-offset*15000.0)*0.7;float invBloom=1.0/(0.09+offset*200.0)*0.01;return vec3(gaussianBloom+invBloom);}float rayleighPhase(float angle){return 3.0/(16.0*PI)*(1.0+(angle*angle));}float miePhase(float angle){float g=0.8;return 3.0/(8.0*PI)*((1.0-g*g)*(1.0+angle*angle))/((2.0+g*g)*pow(1.0+g*g-2.0*g*angle,1.5));}vec3 opticalDepth(float height,float angle){vec3 rayOrigin=vec3(0.0,BOTTOM_RADIUS+height,0.0);vec3 rayDirection=vec3(sqrt(1.0-angle*angle),angle,0.0);float t1,t2;intersectSphere(rayOrigin,rayDirection,TOP_RADIUS,t1,t2);float segmentLength=t2/float(SAMPLE_COUNT);float t=segmentLength*0.5;vec3 opticalDepth=vec3(0.0);for(int i=0;i<SAMPLE_COUNT;i++){vec3 position=rayOrigin+t*rayDirection;float height=length(position)-BOTTOM_RADIUS;opticalDepth.xy+=exp(-height/rayleighMieHeights)*segmentLength;opticalDepth.z+=(1.0-min(abs(height-ozoneDensityHeight)/ozoneDensityWide,1.0))*segmentLength;t+=segmentLength;}return opticalDepth;}vec3 transmittance(float height,float angle){vec3 opticalDepth=opticalDepth(height,angle);return exp(-(rayleighScatteringCoefficient*opticalDepth.x+mieExtinctionCoefficient*opticalDepth.y+ozoneAbsorptionCoefficient*opticalDepth.z));}uniform sampler2D transmittanceTexture;uniform vec2 iResolution;vec3 transmittanceFromTexture(float height,float angle){float u=(angle+1.0)*0.5;float v=height/ATMOS_HEIGHT;return texture2D(transmittanceTexture,vec2(u,v)).xyz;}void main(void){vec2 uv=gl_FragCoord.xy/iResolution.xy;float height=uv.y*ATMOS_HEIGHT;float angle=uv.x*2.0-1.0;vec3 rayOrigin=vec3(0.0,BOTTOM_RADIUS+height,0.0);vec3 up=rayOrigin/length(rayOrigin);vec3 lightDirection=vec3(sqrt(1.0-angle*angle),angle,0.0);const float isotropicPhase=1.0/(4.0*PI);vec3 light=vec3(0.0);vec3 lightTransferFactor=vec3(0.0);for(int i=0;i<SQRT_SAMPLE_COUNT;i++){for(int j=0;j<SQRT_SAMPLE_COUNT;j++){float u=((0.5+float(i))/float(SQRT_SAMPLE_COUNT))*2.0-1.0;float v=(0.5+float(j))/float(SQRT_SAMPLE_COUNT);float r=sqrt(1.0-u*u);float theta=2.0*PI*v;vec3 rayDirection=vec3(cos(theta)*r,sin(theta)*r,u);float rayAngle=dot(up,rayDirection);bool cameraBelow=rayAngle<0.0;vec3 transmittanceFromCameraToSpace=transmittanceFromTexture(height,cameraBelow ?-rayAngle : rayAngle);float offset=0.0;float distanceToSpace=0.0;intersectSphere(rayOrigin,rayDirection,TOP_RADIUS,offset,distanceToSpace);float distanceToGround=0.0;bool hitGround=intersectSphere(rayOrigin,rayDirection,BOTTOM_RADIUS,distanceToGround)&&distanceToGround>0.0;float segmentLength=(hitGround ? distanceToGround : distanceToSpace)/float(SAMPLE_COUNT);float t=segmentLength*0.5;vec3 transmittanceCamera;vec3 transmittanceLight;for(int k=0;k<SAMPLE_COUNT;k++){vec3 position=rayOrigin+t*rayDirection;float height=length(position)-BOTTOM_RADIUS;vec3 up=position/length(position);float rayAngle=dot(up,rayDirection);float lightAngle=dot(up,lightDirection);float distanceToGround;float shadow=intersectSphere(position,lightDirection,BOTTOM_RADIUS,distanceToGround)&&distanceToGround>=0.0 ? 0.0 : 1.0;vec3 transmittanceToSpace=transmittanceFromTexture(height,cameraBelow ?-rayAngle : rayAngle);transmittanceCamera=cameraBelow ?(transmittanceToSpace/transmittanceFromCameraToSpace):(transmittanceFromCameraToSpace/transmittanceToSpace);transmittanceLight=transmittanceFromTexture(height,lightAngle);vec2 opticalDensity=exp(-height/rayleighMieHeights);vec3 scatteredLight=transmittanceLight*(rayleighScatteringCoefficient*opticalDensity.x+mieScatteringCoefficient*opticalDensity.y)*isotropicPhase;light+=shadow*transmittanceCamera*scatteredLight*segmentLength;lightTransferFactor+=transmittanceCamera*(rayleighScatteringCoefficient*opticalDensity.x+mieScatteringCoefficient*opticalDensity.y)*segmentLength;t+=segmentLength;}if(hitGround){vec3 hitPoint=rayOrigin+rayDirection*distanceToGround;vec3 normal=normalize(hitPoint);float diffuseAngle=max(dot(normal,lightDirection),0.0);light+=transmittanceCamera*transmittanceLight*GROUND_ALBEDO*diffuseAngle;}}}light/=float(SAMPLE_COUNT);lightTransferFactor/=float(SAMPLE_COUNT);vec3 color=light/(1.0-lightTransferFactor);gl_FragColor=vec4(color,1.0);}",s||er)}))))}initBackgroundShader(){var t;this.renderer&&this.renderer.handler.addProgram((t=this._parameters,new X("atmosphereBackground",{uniforms:{iResolution:"vec2",fov:"float",camPos:"vec3",viewMatrix:"mat4",transmittanceTexture:"sampler2D",scatteringTexture:"sampler2D",sunPos:"vec3",opacity:"float",isOrthographic:"float",frustumParams:"vec4"},attributes:{corners:"vec3"},vertexShader:Hh,fragmentShader:di(Vh,{...t,disableSunDisk:t!=null&&t.disableSunDisk?1:0})})))}removeBackgroundShader(){this.renderer&&this.renderer.handler.removeProgram("atmosphereBackground")}removeLookupTexturesShaders(){var t,s;if(this.renderer){let n=this.renderer.handler;(t=this._scatteringBuffer)!=null&&t.isComplete()&&n.removeProgram("scattering"),(s=this._transmittanceBuffer)!=null&&s.isComplete()&&n.removeProgram("transmittance")}}onactivate(){super.onactivate(),this.planet&&this.planet.events.on("draw",this._drawBackground,this)}ondeactivate(){super.ondeactivate(),this.planet&&this.planet.events.off("draw",this._drawBackground)}_initLookupTextures(){this._transmittanceBuffer=new Rt(this.renderer.handler,{width:1024,height:1024,useDepth:!1,targets:[{filter:"LINEAR",type:"FLOAT",internalFormat:"RGBA16F"}]}),this._transmittanceBuffer.init(),this._scatteringBuffer=new Rt(this.renderer.handler,{width:1024,height:1024,useDepth:!1,targets:[{filter:"LINEAR",type:"FLOAT",internalFormat:"RGBA16F"}]}),this._scatteringBuffer.init()}_renderLookupTextures(){if(!this.renderer)return;let t=this.renderer.screenFramePositionBuffer,s=this.renderer.handler,n=s.gl;if(this._transmittanceBuffer){this._transmittanceBuffer.activate();let o=s.programs.transmittance,a=o._program.attributes,l=o._program.uniforms;o.activate(),n.clearColor(0,0,0,1),n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT),n.uniform2fv(l.iResolution,[this._transmittanceBuffer.width,this._transmittanceBuffer.height]),n.bindBuffer(n.ARRAY_BUFFER,t),n.vertexAttribPointer(a.a_position,t.itemSize,n.FLOAT,!1,0,0),n.drawArrays(n.TRIANGLE_STRIP,0,t.numItems),this._transmittanceBuffer.deactivate()}if(this._scatteringBuffer&&this._transmittanceBuffer){this._scatteringBuffer.activate();let o=s.programs.scattering,a=o._program.attributes,l=o._program.uniforms;o.activate(),n.clearColor(0,0,0,1),n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT),n.uniform2fv(l.iResolution,[this._scatteringBuffer.width,this._scatteringBuffer.height]),n.activeTexture(n.TEXTURE0),n.bindTexture(n.TEXTURE_2D,this._transmittanceBuffer.textures[0]),n.uniform1i(l.transmittanceTexture,0),n.bindBuffer(n.ARRAY_BUFFER,t),n.vertexAttribPointer(a.a_position,t.itemSize,n.FLOAT,!1,0,0),n.drawArrays(n.TRIANGLE_STRIP,0,t.numItems),this._scatteringBuffer.deactivate()}}drawLookupTextures(){this._renderLookupTextures()}_drawBackground(){let t=this.renderer.handler,s=t.programs.atmosphereBackground,n=s._program,o=n.uniforms,a=t.gl,l=this.renderer,c=this.planet.camera;a.disable(a.DEPTH_TEST),l.enableBlendOneSrcAlpha(),s.activate(),a.bindBuffer(a.ARRAY_BUFFER,l.screenFramePositionBuffer),a.vertexAttribPointer(n.attributes.corners,2,a.FLOAT,!1,0,0),a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,this._transmittanceBuffer.textures[0]),a.uniform1i(o.transmittanceTexture,0),a.activeTexture(a.TEXTURE1),a.bindTexture(a.TEXTURE_2D,this._scatteringBuffer.textures[0]),a.uniform1i(o.scatteringTexture,1),a.uniformMatrix4fv(o.viewMatrix,!1,c.getViewMatrix());let d=this.planet.sunPos;a.uniform3fv(o.sunPos,[d.x,d.y,d.z]),a.uniform3fv(o.camPos,[c.eye.x,c.eye.y,c.eye.z]),a.uniform2fv(o.iResolution,[l.sceneFramebuffer.width,l.sceneFramebuffer.height]),a.uniform1f(o.fov,c.getViewAngle()),a.uniform1f(o.opacity,this.opacity);let u=c.frustum;a.uniform1f(o.isOrthographic,c.isOrthographic?1:0),a.uniform4fv(o.frustumParams,[u.right-u.left,u.top-u.bottom,u.right,u.top]),a.drawArrays(a.TRIANGLE_STRIP,0,4),a.enable(a.DEPTH_TEST),l.enableBlendDefault()}}const Ea="degrees",Gh="m";let jh=0;class hn{constructor(t){this.id=jh++,this.code=t.code,this.units=t.units}equal(t){return t.id===this.id}}const cn=new hn({code:"epsg:3857",units:Gh});class qh{constructor(t){this.segment=t,this.layers=[],this.tileOffsetArr=new Float32Array(t.planet.SLICE_SIZE_4),this.layerOpacityArr=new Float32Array(t.planet.SLICE_SIZE)}clear(){this.layers=null,this.tileOffsetArr=null,this.layerOpacityArr=null}append(t,s){let n=this.layers.length;this.layers.push(t),this.layerOpacityArr[n]=t.screenOpacity;let o=4*n,a=t.applyMaterial(s);this.tileOffsetArr[o]=a[0],this.tileOffsetArr[o+1]=a[1],this.tileOffsetArr[o+2]=a[2],this.tileOffsetArr[o+3]=a[3]}}function At(h,t,s){return Math.floor(Math.abs(s-h)/t)}function Si(h,t,s,n){let o=1/(1<<s),a=n.getWidth()*o,l=n.getHeight()*o,c=n.southWest.lon+h*a,d=n.northEast.lat-t*l;return new U(new L(c,d-l),new L(c+a,d))}const Le=20,Pe=300;let ye=new v,xe=new v,ir=new v,Qe=new v,Je=new v,sr=new v,ti=new V,Di=new V;const hi=new Array(4);hi[0]=0,hi[1]=1,hi[2]=1,hi[3]=0;const ci=new Array(4);ci[0]=!1,ci[1]=!0,ci[2]=!1,ci[3]=!0;class Aa{constructor(t,s,n,o){this.isPole=!1,this._tileGroup=0,this._projection=cn,this.node=t,this.quadTreeStrategy=s,this.planet=s.planet,this.handler=s.planet.renderer.handler,this.bsphere=new Ft,this._plainRadius=0,this.bbox=new No,this._sw=new v,this._nw=new v,this._se=new v,this._ne=new v,this.centerNormal=new v,this._extent=this._extentMerc=o,this._extentLonLat=new U,this.gridSize=this.planet.terrain.gridSizeByZoom[n],this.fileGridSize=0,this.tileZoom=n,this.powTileZoom=1<<n,this.tileX=0,this.tileXE=0,this.tileXW=0,this.tileYN=0,this.tileYS=0,this.tileY=0,this.tileIndex="",this.elevationData=null,this._assignTileIndexes(),this.materials=[],this.plainReady=!1,this.initialized=!1,this.normalMapReady=!1,this.terrainReady=!1,this.terrainIsLoading=!1,this.terrainExists=!1,this.passReady=!1,this.plainVertices=null,this.plainVerticesHigh=null,this.plainVerticesLow=null,this.plainNormals=null,this.terrainVertices=null,this.terrainVerticesHigh=null,this.terrainVerticesLow=null,this.noDataVertices=null,this.tempVertices=null,this.tempVerticesHigh=null,this.tempVerticesLow=null,this.normalMapTexture=null,this.normalMapTextureBias=new Float32Array(3),this.normalMapVertices=null,this.normalMapVerticesHigh=null,this.normalMapVerticesLow=null,this.normalMapNormals=null,this.vertexNormalBuffer=null,this.vertexPositionBuffer=null,this.vertexPositionBufferHigh=null,this.vertexPositionBufferLow=null,this.vertexTextureCoordBuffer=null,this._globalTextureCoordinates=new Float32Array(4),this._inTheQueue=!1,this._appliedNeighborsZoom=[0,0,0,0],this._slices=[],this._indexBuffer=null,this.readyToEngage=!1,this.plainProcessing=!1,this.normalMapTexturePtr=null,this._transitionOpacity=1,this._transitionTimestamp=0}checkZoom(){return this.tileZoom<this.planet.terrain._maxNodeZoom}getEntityTerrainPoint(t,s){return this.getTerrainPoint(t._cartesian,this.getInsideLonLat(t),s)}getInsideLonLat(t){return t._lonLatMerc}isEntityInside(t){return this._extentLonLat.isInside(t._lonLat)}getTerrainPoint(t,s,n){let o=this.tempVertices;if(o&&o.length){let a=this.planet.ellipsoid.getSurfaceNormal3v(t);ti.set(t,a.negateTo());let l=this._extent.northEast,c=this._extent.southWest,d=Math.sqrt(o.length/3)-1,u=l.lon,_=l.lat,f=c.lon,g=c.lat,m=(u-f)/d,p=(_-g)/d,x=s.lon-f,y=s.lat-g,w=Math.floor(x/m),C=Math.floor(d-y/p),T=3*((d+1)*C+w),P=3*((d+1)*(C+1)+w);ir.set(o[T],o[T+1],o[T+2]),Qe.set(o[T+3],o[T+4],o[T+5]),Je.set(o[P],o[P+1],o[P+2]);let E=ti.hitTriangleRes(ir,Qe,Je,n);return E===V.INSIDE?t.distance(n):E===V.AWAY&&(Di.set(t,a),Di.hitTriangleRes(ir,Qe,Je,n)===V.INSIDE)?-t.distance(n):(sr.set(o[P+3],o[P+4],o[P+5]),E=ti.hitTriangleRes(Qe,sr,Je,n),E===V.INSIDE?t.distance(n):E===V.AWAY&&(Di.set(t,a),Di.hitTriangleRes(Qe,sr,Je,n)===V.INSIDE)||E===V.AWAY?-t.distance(n):t.distance(n))}return t.distance(this.planet.ellipsoid.hitRay(ti.origin,ti.direction))}projectNative(t){return t.forwardMercator()}loadTerrain(t=!1){this.tileZoom<this.planet.terrain.minZoom||this.planet.terrain.isEmpty?(this.terrainIsLoading=!0,this.elevationsNotExists(),this._inTheQueue||this.planet._normalMapCreator.queue(this)):this.tileZoom>this.planet.terrain.maxZoom?this.elevationsNotExists():this.terrainIsLoading||this.terrainReady||this.planet.terrain.loadTerrain(this,t)}elevationsExists(t){if(this.plainReady&&this.terrainIsLoading){let s=new Float32Array(t.length);s.set(t),this.elevationData=new Float32Array(t.length),this.elevationData.set(t),this.planet._terrainWorker.make({segment:this,elevations:s}),this.plainVerticesHigh=null,this.plainVerticesLow=null,this.normalMapVerticesHigh=null,this.normalMapVerticesLow=null,this.planet.terrain.equalizeVertices||(this.tempVerticesHigh=null,this.tempVerticesLow=null)}}elevationsNotExists(){if(this.planet&&this.tileZoom<=this.planet.terrain.maxNativeZoom){if(this.plainReady&&this.terrainIsLoading){this.terrainIsLoading=!1;let t=this.node;t.appliedTerrainNodeId=this.node.nodeId,t.equalizedSideWithNodeId[0]=t.equalizedSideWithNodeId[1]=t.equalizedSideWithNodeId[2]=t.equalizedSideWithNodeId[3]=t.appliedTerrainNodeId,this.planet.lightEnabled&&!this._inTheQueue&&this.planet._normalMapCreator.queue(this),this.readyToEngage=!0}this.terrainVertices=this.plainVertices,this.terrainVerticesHigh=this.plainVerticesHigh,this.terrainVerticesLow=this.plainVerticesLow,this.tempVertices=this.terrainVertices,this.tempVerticesHigh=this.terrainVerticesHigh,this.tempVerticesLow=this.terrainVerticesLow,this.noDataVertices=null,this.fileGridSize=Math.sqrt(this.terrainVertices.length/3)-1,this.gridSize=this.fileGridSize,this.terrainReady=!0,this.terrainExists=!1}else if(this.plainReady&&this.terrainIsLoading){this.terrainIsLoading=!1;let t=this.node;t.appliedTerrainNodeId=this.node.nodeId,t.equalizedSideWithNodeId[0]=t.equalizedSideWithNodeId[1]=t.equalizedSideWithNodeId[2]=t.equalizedSideWithNodeId[3]=t.appliedTerrainNodeId,this.readyToEngage=!0,this.terrainReady=!0,this.passReady=!0,this.terrainExists=!1}}_checkEqualization(t,s){return s&&s.segment&&this.tileZoom>=s.segment.tileZoom&&this.node.equalizedSideWithNodeId[t]!==s.equalizedSideWithNodeId[ui[t]]}equalize(){if(this.tileZoom<2||this.gridSize<2)return;this.readyToEngage=!0;let t=this.node.neighbors,s=this.tempVertices,n=this.tempVerticesHigh,o=this.tempVerticesLow,a=this.gridSize,l=a+1,c=t[0][0];if(this._checkEqualization(0,c)){this.node.equalizedSideWithNodeId[0]=c.equalizedSideWithNodeId[2],this.readyToEngage=!0;let d=this.node.getOffsetOppositeNeighbourSide(c,0),u=c.segment.tempVertices,_=c.segment.tempVerticesHigh,f=c.segment.tempVerticesLow,g=c.segment.gridSize,m=g+1,p=1/(1<<this.tileZoom-c.segment.tileZoom),x=Math.max(a/(g*p),1),y=Math.max(g*p/a,1);for(let w=0,C=d*g;w<l;w+=x,C+=y){const T=3*w,P=3*(m*g+C);s[T]=u[P],s[T+1]=u[P+1],s[T+2]=u[P+2],n[T]=_[P],n[T+1]=_[P+1],n[T+2]=_[P+2],o[T]=f[P],o[T+1]=f[P+1],o[T+2]=f[P+2]}}if(c=t[1][0],this._checkEqualization(1,c)){this.node.equalizedSideWithNodeId[1]=c.equalizedSideWithNodeId[3],this.readyToEngage=!0;let d=this.node.getOffsetOppositeNeighbourSide(c,1),u=c.segment.tempVertices,_=c.segment.tempVerticesHigh,f=c.segment.tempVerticesLow,g=c.segment.gridSize,m=g+1,p=1/(1<<this.tileZoom-c.segment.tileZoom),x=Math.max(a/(g*p),1),y=Math.max(g*p/a,1);for(let w=0,C=d*g;w<l;w+=x,C+=y){const T=3*(l*w+a),P=m*C*3;s[T]=u[P],s[T+1]=u[P+1],s[T+2]=u[P+2],n[T]=_[P],n[T+1]=_[P+1],n[T+2]=_[P+2],o[T]=f[P],o[T+1]=f[P+1],o[T+2]=f[P+2]}}if(c=t[2][0],this._checkEqualization(2,c)){this.node.equalizedSideWithNodeId[2]=c.equalizedSideWithNodeId[0],this.readyToEngage=!0;let d=this.node.getOffsetOppositeNeighbourSide(c,2),u=c.segment.tempVertices,_=c.segment.tempVerticesHigh,f=c.segment.tempVerticesLow,g=c.segment.gridSize,m=1/(1<<this.tileZoom-c.segment.tileZoom),p=Math.max(a/(g*m),1),x=Math.max(g*m/a,1);for(let y=0,w=d*g;y<l;y+=p,w+=x){const C=3*(l*a+y),T=3*w;s[C]=u[T],s[C+1]=u[T+1],s[C+2]=u[T+2],n[C]=_[T],n[C+1]=_[T+1],n[C+2]=_[T+2],o[C]=f[T],o[C+1]=f[T+1],o[C+2]=f[T+2]}}if(c=t[3][0],this._checkEqualization(3,c)){this.node.equalizedSideWithNodeId[3]=c.equalizedSideWithNodeId[1],this.readyToEngage=!0;let d=this.node.getOffsetOppositeNeighbourSide(c,3),u=c.segment.tempVertices,_=c.segment.tempVerticesHigh,f=c.segment.tempVerticesLow,g=c.segment.gridSize,m=g+1,p=1/(1<<this.tileZoom-c.segment.tileZoom),x=Math.max(a/(g*p),1),y=Math.max(g*p/a,1);for(let w=0,C=d*g;w<l;w+=x,C+=y){const T=l*w*3,P=3*(m*C+g);s[T]=u[P],s[T+1]=u[P+1],s[T+2]=u[P+2],n[T]=_[P],n[T+1]=_[P+1],n[T+2]=_[P+2],o[T]=f[P],o[T+1]=f[P+1],o[T+2]=f[P+2]}}}engage(){this.readyToEngage=!1,this.createCoordsBuffers(this.tempVerticesHigh,this.tempVerticesLow,this.gridSize)}_terrainWorkerCallback(t){if(this.plainReady){this.readyToEngage=!0,this.normalMapNormals=null,this.normalMapVertices=null,this.normalMapVerticesHigh=null,this.normalMapVerticesLow=null,this.terrainVertices=null,this.terrainVerticesHigh=null,this.terrainVerticesLow=null,this.noDataVertices=null,this.tempVertices=null,this.tempVerticesHigh=null,this.tempVerticesLow=null,this.normalMapNormals=t.normalMapNormals,this.normalMapVertices=t.normalMapVertices,this.normalMapVerticesHigh=t.normalMapVerticesHigh,this.normalMapVerticesLow=t.normalMapVerticesLow,this.terrainVertices=t.terrainVertices,this.terrainVerticesHigh=t.terrainVerticesHigh,this.terrainVerticesLow=t.terrainVerticesLow,this.noDataVertices=t.noDataVertices,this.tempVertices=this.terrainVertices,this.tempVerticesHigh=this.terrainVerticesHigh,this.tempVerticesLow=this.terrainVerticesLow,this.setBoundingVolumeArr(t.bounds),this.gridSize=Math.sqrt(this.terrainVertices.length/3)-1;let s=this.node;if(s.appliedTerrainNodeId=s.nodeId,s.equalizedSideWithNodeId[0]=s.equalizedSideWithNodeId[1]=s.equalizedSideWithNodeId[2]=s.equalizedSideWithNodeId[3]=s.appliedTerrainNodeId,this.terrainReady=!0,this.terrainIsLoading=!1,this.terrainExists=!0,!this.normalMapTexturePtr){const n=this.planet._normalMapCreator;this.normalMapTexturePtr=this.planet.renderer.handler.createEmptyTexture_l(n.width,n.height)}this.planet.lightEnabled&&this.planet._normalMapCreator.queue(this)}}_normalMapEdgeEqualize(t){let s=this.node.neighbors,n=s[t],o=n&&n[0],a=this.planet.terrain.maxZoom;this.tileZoom===a&&n&&!(s[0].length||s[1].length||s[2].length||s[3].length)&&(o=this.node.getEqualNeighbor(t));let l=o&&o.segment,c=this;if(o&&l&&l.terrainReady&&l.terrainExists&&l.tileZoom<=a&&c._appliedNeighborsZoom[t]!==l.tileZoom){c._appliedNeighborsZoom[t]=l.tileZoom;let d=c.normalMapNormals,u=l.normalMapNormals;if(!d||!u)return;let _=c.normalMapNormals,f=l.normalMapNormals,g=Math.sqrt(d.length/3),m=g-1;const p=m*hi[t];let x,y,w,C;if(c.tileZoom===l.tileZoom){const T=m-p;if(ci[t])for(let P=0;P<g;P++){let E=3*(P*g+p),S=3*(P*g+T);x=_[E]+f[S],y=_[E+1]+f[S+1],w=_[E+2]+f[S+2],C=1/Math.sqrt(x*x+y*y+w*w),u[S]=d[E]=x*C,u[S+1]=d[E+1]=y*C,u[S+2]=d[E+2]=w*C}else for(let P=0;P<g;P++){let E=3*(p*g+P),S=3*(T*g+P);x=_[E]+f[S],y=_[E+1]+f[S+1],w=_[E+2]+f[S+2],C=1/Math.sqrt(x*x+y*y+w*w),u[S]=d[E]=x*C,u[S+1]=d[E+1]=y*C,u[S+2]=d[E+2]=w*C}l._inTheQueue||l._appliedNeighborsZoom[ui[t]]===c.tileZoom||(l._appliedNeighborsZoom[ui[t]]=c.tileZoom,c.planet._normalMapCreator.queue(l))}}}applyTerrain(t){t?this.elevationsExists(t):this.elevationsNotExists()}deleteBuffers(){const t=this.handler.gl;t.deleteBuffer(this.vertexNormalBuffer),t.deleteBuffer(this.vertexPositionBuffer),t.deleteBuffer(this.vertexPositionBufferHigh),t.deleteBuffer(this.vertexPositionBufferLow),this.vertexNormalBuffer=null,this.vertexPositionBuffer=null,this.vertexPositionBufferHigh=null,this.vertexPositionBufferLow=null,this.vertexTextureCoordBuffer=null}deleteMaterials(){let t=this.materials;for(let s=0;s<t.length;s++){let n=t[s];n&&n.clear()}this.materials.length=0}deleteElevations(){this.terrainExists=!1,this.terrainReady=!1,this.terrainIsLoading=!1,this.normalMapVertices=null,this.normalMapVerticesHigh=null,this.normalMapVerticesLow=null,this.normalMapNormals=null,this.tempVertices=null,this.tempVerticesHigh=null,this.tempVerticesLow=null,this.terrainVertices=null,this.terrainVerticesHigh=null,this.terrainVerticesLow=null,this.noDataVertices=null,this.plainVertices=null,this.plainVerticesHigh=null,this.plainVerticesLow=null,this.plainNormals=null,this.normalMapReady&&(this.handler.gl.deleteTexture(this.normalMapTexture),this.normalMapReady=!1),this._appliedNeighborsZoom=[0,0,0,0],this.normalMapTextureBias[0]=0,this.normalMapTextureBias[1]=0,this.normalMapTextureBias[2]=1,this._inTheQueue=!1}clearSegment(){this.plainReady=!1,this.initialized=!1,this.deleteBuffers(),this.deleteMaterials(),this.deleteElevations()}childrenInitialized(){let t=this.node.nodes;return t.length===4&&t[0].segment.initialized&&t[1].segment.initialized&&t[2].segment.initialized&&t[3].segment.initialized}destroySegment(){this.clearSegment();let t=this._slices.length;for(;t--;)this._slices[t].clear();this._slices=null,this.node=null,this.planet=null,this.handler=null,this.bbox=null,this.bsphere=null,this._extent=null,this.materials=null,this.plainVertices=null,this.plainVerticesHigh=null,this.plainVerticesLow=null,this.plainNormals=null,this.terrainVertices=null,this.terrainVerticesHigh=null,this.terrainVerticesLow=null,this.noDataVertices=null,this.tempVertices=null,this.tempVerticesHigh=null,this.tempVerticesLow=null,this.normalMapTextureBias=null,this.normalMapTexture=null,this.normalMapVertices=null,this.normalMapVerticesHigh=null,this.normalMapVerticesLow=null,this.normalMapNormals=null,this.vertexNormalBuffer=null,this.vertexPositionBuffer=null,this.vertexPositionBufferHigh=null,this.vertexPositionBufferLow=null,this.vertexTextureCoordBuffer=null,this._projection=null,this._appliedNeighborsZoom=null,this._globalTextureCoordinates=null}_setExtentLonLat(){this._extentLonLat=this._extent.inverseMercator()}_createExtentNormals(){const t=this.planet.ellipsoid,s=this._extentLonLat,n=t.geodeticToCartesian(s.southWest.lon,s.southWest.lat),o=t.geodeticToCartesian(s.northEast.lon,s.northEast.lat),a=t.geodeticToCartesian(s.southWest.lon,s.northEast.lat),l=t.geodeticToCartesian(s.northEast.lon,s.southWest.lat);this._sw.copy(n),this._nw.copy(a),this._ne.copy(o),this._se.copy(l)}createBoundsByExtent(){this._createExtentNormals(),this.setBoundingVolume3v(this._sw,this._ne)}createBoundsByParent(){let t=this.node;for(;t.parentNode&&!t.segment.terrainReady;)t=t.parentNode;let s=1<<this.tileZoom-t.segment.tileZoom,n=this.tileX-t.segment.tileX*s,o=this.tileY-t.segment.tileY*s;if(t.segment.terrainReady&&t.segment.tileZoom>=this.planet.terrain.minZoom){let a=t.segment.gridSize/s;if(a>=1){this.bsphere.center.x=t.segment.bsphere.center.x,this.bsphere.center.y=t.segment.bsphere.center.y,this.bsphere.center.z=t.segment.bsphere.center.z,this.bsphere.radius=t.segment.bsphere.radius;let l=a*o,c=a*n,d=t.segment.gridSize+1,u=3*((l+a)*d+c),_=3*(l*d+c),f=3*(l*d+c+a),g=3*((l+a)*d+c+a),m=t.segment.tempVertices,p=new v(m[u],m[u+1],m[u+2]),x=new v(m[f],m[f+1],m[f+2]),y=new v(m[_],m[_+1],m[_+2]),w=new v(m[g],m[g+1],m[g+2]);this._sw.copy(p),this._nw.copy(y),this._ne.copy(x),this._se.copy(w)}else{let l,c=t.segment,d=Math.floor(a*o),u=Math.floor(a*n),_=1/a,f=o-_*d,g=n-_*u;l=c.gridSize===1?c.tempVertices:Kr(c.tempVertices,c.gridSize,d,u,1);let m,p,x=new v(l[0],l[1],l[2]),y=new v(l[9],l[10],l[11]),w=new v(l[3]-l[0],l[4]-l[1],l[5]-l[2]),C=new v(l[6]-l[0],l[7]-l[1],l[8]-l[2]),T=new v(l[3]-l[9],l[4]-l[10],l[5]-l[11]),P=new v(l[6]-l[9],l[7]-l[10],l[8]-l[11]),E=f,S=g;m=E+S<_?v.add(w.scaleTo(S/_),C.scaleTo(E/_)).addA(x):v.add(P.scaleTo(1-S/_),T.scaleTo(1-E/_)).addA(y),E=f+1,S=g+1,p=E+S<_?v.add(w.scaleTo(S/_),C.scaleTo(E/_)).addA(x):v.add(P.scaleTo(1-S/_),T.scaleTo(1-E/_)).addA(y),this._createExtentNormals(),this.setBoundingVolume3v(m,p)}}else this.createBoundsByExtent()}setBoundingSphere(t,s,n,o){this.bsphere.center.x=t,this.bsphere.center.y=s,this.bsphere.center.z=n,this.bsphere.radius=this.bsphere.center.distance(o)}setBoundingVolume(t,s,n,o,a,l){this.bbox.setFromBoundsArr([t,s,n,o,a,l]);let c=t+.5*(o-t),d=s+.5*(a-s),u=n+.5*(l-n);this.bsphere.center.set(c,d,u),this.bsphere.radius=this.bsphere.center.distance(new v(t,s,n))}setBoundingVolume3v(t,s){this.bbox.setFromBoundsArr([t.x,t.y,t.z,s.x,s.y,s.z]);let n=t.x+.5*(s.x-t.x),o=t.y+.5*(s.y-t.y),a=t.z+.5*(s.z-t.z);this.bsphere.center.set(n,o,a),this.bsphere.radius=this.bsphere.center.distance(new v(t.x,t.y,t.z))}setBoundingVolumeArr(t){this.bbox.setFromBoundsArr(t);let s=t[0]+.5*(t[3]-t[0]),n=t[1]+.5*(t[4]-t[1]),o=t[2]+.5*(t[5]-t[2]);this.bsphere.center.set(s,n,o),this.bsphere.radius=this.bsphere.center.distance(new v(t[0],t[1],t[2]))}createCoordsBuffers(t,s,n){const o=(n+1)*(n+1),a=this.handler;this.vertexPositionBufferHigh&&this.vertexPositionBufferHigh.numItems===o?(a.setStreamArrayBuffer(this.vertexPositionBufferHigh,t),a.setStreamArrayBuffer(this.vertexPositionBufferLow,s)):(a.gl.deleteBuffer(this.vertexPositionBufferHigh),a.gl.deleteBuffer(this.vertexPositionBufferLow),this.vertexTextureCoordBuffer=this.planet._textureCoordsBufferCache[Math.log2(n)],this.vertexPositionBufferHigh=a.createArrayBuffer(t,3,o),this.vertexPositionBufferLow=a.createArrayBuffer(s,3,o))}_addViewExtent(){const t=this._extentLonLat;let s=this.quadTreeStrategy._viewExtent;t.southWest.lon<s.southWest.lon&&(s.southWest.lon=t.southWest.lon),t.northEast.lon>s.northEast.lon&&(s.northEast.lon=t.northEast.lon),t.southWest.lat<s.southWest.lat&&(s.southWest.lat=t.southWest.lat),t.northEast.lat>s.northEast.lat&&(s.northEast.lat=t.northEast.lat)}_assignTileIndexes(){this._tileGroup=0;const t=this.tileZoom,s=this._extent,n=Lt;this.tileX=At(s.getCenter().lon,s.getWidth(),-2003750834e-2),this.tileY=At(s.getCenter().lat,s.getHeight(),n);const o=this.powTileZoom;this.tileXE=(this.tileX+1)%o,this.tileXW=(o+this.tileX-1)%o,this.tileYN=this.tileY-1,this.tileYS=this.tileY+1,this.tileIndex=zt.getTileIndex(this.tileX,this.tileY,t,this._tileGroup)}initialize(){const t=this.planet,s=this.node;if(this.gridSize=t.terrain.gridSizeByZoom[this.tileZoom]||t.terrain.plainGridSize,s.sideSizeLog2[0]=s.sideSizeLog2[1]=s.sideSizeLog2[2]=s.sideSizeLog2[3]=Math.log2(this.gridSize),this.tileZoom<=t.terrain.maxZoom){const n=this.planet._normalMapCreator;this.normalMapTexturePtr=t.renderer.handler.createEmptyTexture_l(n.width,n.height)}this.normalMapTexture=this.planet.transparentTexture,this._assignGlobalTextureCoordinates(),this.initialized=!0}_assignGlobalTextureCoordinates(){const t=this._extent;this._globalTextureCoordinates[0]=(t.southWest.lon+Lt)*ri,this._globalTextureCoordinates[1]=(Lt-t.northEast.lat)*ri,this._globalTextureCoordinates[2]=(t.northEast.lon+Lt)*ri,this._globalTextureCoordinates[3]=(Lt-t.southWest.lat)*ri}createPlainSegmentAsync(){let t=this.planet,s=t.terrain;s.isReady()&&!this.plainReady&&this.tileZoom<=s.maxZoom&&(this.plainProcessing=!0,t._plainSegmentWorker.make(this))}_plainSegmentWorkerCallback(t){this.plainProcessing=!1,this.initialized&&!this.terrainReady&&(this.plainReady=!0,this.plainVertices=t.plainVertices,this.plainVerticesHigh=t.plainVerticesHigh,this.plainVerticesLow=t.plainVerticesLow,this.plainNormals=t.plainNormals,this._plainRadius=t.plainRadius,this.normalMapNormals=t.normalMapNormals,this.normalMapVertices=t.normalMapVertices,this.normalMapVerticesHigh=t.normalMapVerticesHigh,this.normalMapVerticesLow=t.normalMapVerticesLow,this.fileGridSize=Math.sqrt(t.normalMapVertices.length/3)-1)}createPlainSegment(){this.initialize(),this._createPlainVertices(),this.readyToEngage=!0}_projToDeg(t,s){return L.inverseMercator(t,s)}_createPlainVertices(){const t=this.planet.terrain.gridSizeByZoom[this.tileZoom],s=this.planet.terrain.plainGridSize,n=Math.max(s,t),o=this._extent,a=o.getWidth()/n,l=o.getHeight()/n,c=o.southWest.lon,d=o.northEast.lat,u=Math.max(s/t,1),_=n+1,f=this.planet.ellipsoid._invRadii2,g=_*_,m=(t+1)*(t+1)*3;let p=0,x=0;this.plainNormals=new Float32Array(m),this.plainVertices=new Float64Array(m),this.plainVerticesHigh=new Float32Array(m),this.plainVerticesLow=new Float32Array(m),this.normalMapNormals=new Float32Array(3*g),this.normalMapVertices=new Float64Array(3*g),this.normalMapVerticesHigh=new Float32Array(3*g),this.normalMapVerticesLow=new Float32Array(3*g);let y=this.plainVertices,w=this.plainVerticesHigh,C=this.plainVerticesLow,T=this.plainNormals,P=this.normalMapVertices,E=this.normalMapVerticesHigh,S=this.normalMapVerticesLow,M=this.normalMapNormals;for(let R=0;R<g;R++){let k=R%_,B=~~(R/_),z=this.planet.ellipsoid.lonLatToCartesian(this._projToDeg(c+k*a,d-B*l)),O=z.x*f.x,ze=z.y*f.y,D=z.z*f.z,re=1/Math.sqrt(O*O+ze*ze+D*D),Ee=O*re,I=ze*re,N=D*re;v.doubleToTwoFloats(z,ye,xe),P[x]=z.x,E[x]=ye.x,S[x]=xe.x,M[x++]=Ee,P[x]=z.y,E[x]=ye.y,S[x]=xe.y,M[x++]=I,P[x]=z.z,E[x]=ye.z,S[x]=xe.z,M[x++]=N,B%u==0&&k%u==0&&(y[p]=z.x,w[p]=ye.x,C[p]=xe.x,T[p++]=Ee,y[p]=z.y,w[p]=ye.y,C[p]=xe.y,T[p++]=I,y[p]=z.z,w[p]=ye.z,C[p]=xe.z,T[p++]=N)}this.terrainVertices=y,this.terrainVerticesHigh=w,this.terrainVerticesLow=C,this.plainReady=!0}getMaterialByLayer(t){return this.materials[t.__id]}_getLayerExtentOffset(t){const s=t._extentMerc,n=this._extent,o=s.northEast.lon-s.southWest.lon,a=s.northEast.lat-s.southWest.lat;return[(n.southWest.lon-s.southWest.lon)/o,(s.northEast.lat-n.northEast.lat)/a,(n.northEast.lon-n.southWest.lon)/o,(n.northEast.lat-n.southWest.lat)/a]}initSlice(t){let s=this._slices[t];return s?s.layers=[]:s=this._slices[t]=new qh(this),s}screenRendering(t,s,n,o,a=!1,l){const c=this.handler.gl,d=t.attributes,u=t.uniforms,_=this.materials,f=this.planet,g=this.quadTreeStrategy;let m,p;s&&s.length?(p=s[0],m=p._height):m=0,c.activeTexture(c.TEXTURE0+f.SLICE_SIZE+2),c.bindTexture(c.TEXTURE_2D,o||this.getDefaultTexture()),c.uniform1i(u.defaultTexture,f.SLICE_SIZE+2);let x=0,y=0,w=!1,C=this.initSlice(n);for(this._indexBuffer=this._getIndexBuffer();p;){if(this.layerOverlap(p)&&(p._fading&&p._fadingOpacity>0||(p.minZoom>=g.minCurrZoom||p.maxZoom>=g.minCurrZoom)&&(p.minZoom<=g.maxCurrZoom||p.maxZoom<=g.maxCurrZoom))){w=!0;let T=_[p.__id];T||(T=_[p.__id]=p.createMaterial(this)),T.isReady||(g._renderCompleted=!1),C.append(p,T),f._samplerArr[x]=x,c.activeTexture(c.TEXTURE0+x),c.bindTexture(c.TEXTURE_2D,T.texture||f.transparentTexture),x++}y++,p=s[y]}!w&&a||(c.uniform1f(u.transitionOpacity,l||this._transitionOpacity>1?1:this._transitionOpacity),c.uniform1i(u.samplerCount,x),c.uniform1f(u.height,m),c.uniform1iv(u.samplerArr,f._samplerArr),c.uniform4fv(u.tileOffsetArr,C.tileOffsetArr),c.uniform1fv(u.layerOpacityArr,C.layerOpacityArr),f.lightEnabled&&(c.activeTexture(c.TEXTURE0+f.SLICE_SIZE+3),c.bindTexture(c.TEXTURE_2D,this.normalMapTexture||f.transparentTexture),c.uniform1i(u.uNormalMap,f.SLICE_SIZE+3),c.uniform3fv(u.uNormalMapBias,this.normalMapTextureBias),c.uniform4fv(u.uGlobalTextureCoord,this._globalTextureCoordinates)),c.bindBuffer(c.ARRAY_BUFFER,this.vertexPositionBufferHigh),c.vertexAttribPointer(d.aVertexPositionHigh,this.vertexPositionBufferHigh.itemSize,c.FLOAT,!1,0,0),c.bindBuffer(c.ARRAY_BUFFER,this.vertexPositionBufferLow),c.vertexAttribPointer(d.aVertexPositionLow,this.vertexPositionBufferLow.itemSize,c.FLOAT,!1,0,0),c.bindBuffer(c.ARRAY_BUFFER,this.vertexTextureCoordBuffer),c.vertexAttribPointer(d.aTextureCoord,2,c.UNSIGNED_SHORT,!0,0,0),c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,this._indexBuffer),c.drawElements(f.drawMode,this._indexBuffer.numItems,c.UNSIGNED_INT,0))}increaseTransitionOpacity(){this._transitionOpacity+=(window.performance.now()-this._transitionTimestamp)/this.planet.transitionTime,this._transitionTimestamp=window.performance.now(),this._transitionOpacity>2&&(this._transitionOpacity=2);let t=this.node._fadingNodes.length;for(;t--;){let s=this.node._fadingNodes[t];if(!s.segment){this._transitionOpacity=1;break}s.segment._transitionOpacity>0&&!this.quadTreeStrategy._fadingNodes.has(s.__id)&&(this.quadTreeStrategy._fadingNodes.set(s.__id,s),s.segment._transitionOpacity=2-this._transitionOpacity,s.segment._transitionOpacity===0&&this.node._fadingNodes.splice(t,1))}}fadingTransitionOpacity(){this._transitionOpacity-=.01,this._transitionTimestamp=window.performance.now(),this._transitionOpacity<0&&(this._transitionOpacity=0)}colorPickingRendering(t,s,n,o,a=!1){const l=this.handler.gl,c=t.attributes,d=t.uniforms;let u,_=this.materials,f=this.planet;u=s&&s.length?s[0]._height:0;let g=!1,m=this._slices[n],p=m.layers.length;for(let x=0;x<p;x++){g=!0;let y=m.layers[x],w=4*x;f._pickingColorArr[w]=y._pickingColor.x/255,f._pickingColorArr[w+1]=y._pickingColor.y/255,f._pickingColorArr[w+2]=y._pickingColor.z/255,f._pickingColorArr[w+3]=Number(y._pickingEnabled),f._samplerArr[x]=x,l.activeTexture(l.TEXTURE0+x),l.bindTexture(l.TEXTURE_2D,_[y.__id].texture||this.planet.transparentTexture),f._pickingMaskArr[x]=x+f.SLICE_SIZE,l.activeTexture(l.TEXTURE0+x+f.SLICE_SIZE),l.bindTexture(l.TEXTURE_2D,_[y.__id].pickingMask||this.planet.transparentTexture)}!g&&a||(l.uniform1i(d.samplerCount,p),l.uniform1f(d.height,u),l.uniform1iv(d.samplerArr,f._samplerArr),l.uniform1iv(d.pickingMaskArr,f._pickingMaskArr),l.uniform4fv(d.pickingColorArr,f._pickingColorArr),l.uniform4fv(d.tileOffsetArr,m.tileOffsetArr),l.uniform1fv(d.layerOpacityArr,m.layerOpacityArr),l.bindBuffer(l.ARRAY_BUFFER,this.vertexPositionBufferHigh),l.vertexAttribPointer(c.aVertexPositionHigh,this.vertexPositionBufferHigh.itemSize,l.FLOAT,!1,0,0),l.bindBuffer(l.ARRAY_BUFFER,this.vertexPositionBufferLow),l.vertexAttribPointer(c.aVertexPositionLow,this.vertexPositionBufferLow.itemSize,l.FLOAT,!1,0,0),l.bindBuffer(l.ARRAY_BUFFER,this.vertexTextureCoordBuffer),l.vertexAttribPointer(c.aTextureCoord,2,l.UNSIGNED_SHORT,!0,0,0),l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,this._indexBuffer),l.drawElements(l.TRIANGLE_STRIP,this._indexBuffer.numItems,l.UNSIGNED_INT,0))}depthRendering(t,s){const n=this.handler.gl,o=t.attributes,a=t.uniforms;var l;l=s&&s.length?s[0]._height:0,n.uniform1f(a.height,l),n.bindBuffer(n.ARRAY_BUFFER,this.vertexPositionBufferHigh),n.vertexAttribPointer(o.aVertexPositionHigh,this.vertexPositionBufferHigh.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,this.vertexPositionBufferLow),n.vertexAttribPointer(o.aVertexPositionLow,this.vertexPositionBufferLow.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,this._indexBuffer),n.drawElements(n.TRIANGLE_STRIP,this._indexBuffer.numItems,n.UNSIGNED_INT,0)}_getIndexBuffer(){const t=this.node.sideSizeLog2;let s=this.planet._indexesCache[Math.log2(this.gridSize)][t[0]][t[1]][t[2]][t[3]];if(!s.buffer){let n=$i().createSegmentIndexes(Math.log2(this.gridSize),[t[0],t[1],t[2],t[3]]);s.buffer=this.planet.renderer.handler.createElementArrayBuffer(n,1),this.planet._indexesCacheToRemoveCounter++}return s.buffer}layerOverlap(t){return this._extent.overlaps(t._extentMerc)}getDefaultTexture(){return this.planet.solidTextureOne}getExtentLonLat(){return this._extentLonLat}getExtentMerc(){return this._extentMerc}getExtent(){return this._extent}getNeighborSide(t){if(this.tileY===t.tileY){if(this.tileX===t.tileXE)return 3;if(this.tileX===t.tileXW)return 1}else if(this.tileX===t.tileX){if(this.tileY===t.tileYS)return 0;if(this.tileY===t.tileYN)return 2}return-1}}let Fi=new v,Oi=new v;const be=[new H(0,0),new H(1,0),new H(0,1),new H(1,1)],Yh=Math.sqrt(be.length)-1;let at={xmin:0,ymin:0,zmin:0,xmax:0,ymax:0,zmax:0},Wh=0;class qt{constructor(t,s,n,o,a,l){s.planet._createdNodesCount++,this.__id=Wh++,this.SegmentPrototype=t,this.quadTreeStrategy=s,this.parentNode=o,this.partId=n,this.nodeId=n+(o?4*o.nodeId+1:0),this.state=null,this.prevState=null,this.appliedTerrainNodeId=-1,this.sideSizeLog2=[0,0,0,0],this.ready=!1,this.neighbors=[[],[],[],[]],this.equalizedSideWithNodeId=[this.nodeId,this.nodeId,this.nodeId,this.nodeId],this.nodes=[],this.segment=new t(this,s,a,l),this._cameraInside=!1,this.inFrustum=0,this._fadingNodes=[],this.createBounds()}createChildNodes(){this.ready=!0;const t=this.quadTreeStrategy,s=this.segment,n=s._extent,o=s.tileZoom+1,a=.5*n.getWidth(),l=.5*n.getHeight(),c=n.northEast,d=n.southWest,u=new L(d.lon+a,d.lat+l),_=this.nodes;_[0]=new qt(this.SegmentPrototype,t,0,this,o,new U(new L(d.lon,d.lat+l),new L(d.lon+a,c.lat))),_[1]=new qt(this.SegmentPrototype,t,1,this,o,new U(u,new L(c.lon,c.lat))),_[2]=new qt(this.SegmentPrototype,t,2,this,o,new U(new L(d.lon,d.lat),u)),_[3]=new qt(this.SegmentPrototype,t,3,this,o,new U(new L(d.lon+a,d.lat),new L(c.lon,d.lat+l)))}createBounds(){let t=this.segment;t._setExtentLonLat(),t.tileZoom===0?t.setBoundingSphere(0,0,0,new v(0,0,t.planet.ellipsoid.equatorialSize)):t.tileZoom<t.planet.terrain.minZoom?t.createBoundsByExtent():t.createBoundsByParent();let s=t.bsphere.center.x,n=t.bsphere.center.y,o=t.bsphere.center.z,a=1/Math.sqrt(s*s+n*n+o*o);t.centerNormal.x=s*a,t.centerNormal.y=n*a,t.centerNormal.z=o*a}getState(){if(this.state===-1)return this.state;let t=this.parentNode;for(;t;){if(t.state!==2)return 0;t=t.parentNode}return this.state}getEqualNeighbor(t){let s=this,n=wn[t][s.partId];if(n!==-1)return s.parentNode.nodes[n];{let o=[];for(;s.parentNode;)if(o.push(s.partId),n=wn[t][s.partId],s=s.parentNode,n!==-1){let a=o.length;for(t=ui[t];s&&a--;)n=Ya[t][o[a]],s=s.nodes[n];return s}}}traverseNodes(t,s,n,o,a){this.ready||this.createChildNodes();let l=this.nodes;l[0].renderTree(t,s,n,o,a),l[1].renderTree(t,s,n,o,a),l[2].renderTree(t,s,n,o,a),l[3].renderTree(t,s,n,o,a)}renderTree(t,s,n,o,a){if(this.quadTreeStrategy._renderedNodes.length>=1e3)return;(!s||a&&this.segment.tileZoom>a.segment.tileZoom)&&(this.prevState=this.state),this.state=2,this.clearNeighbors();let l=this.segment,c=this.quadTreeStrategy.planet;if(this._cameraInside=!1,!this.parentNode||this.parentNode._cameraInside){let _;_=l._projection.id===cn.id?l._extent.isInside(t._lonLatMerc):l._extent.isInside(t._lonLat),_&&(t._insideSegment=l,this._cameraInside=!0)}this.inFrustum=0;let d=t.frustums,u=d.length;if(l.tileZoom<6)for(let _=0;_<u;_++)d[_].containsSphere(l.bsphere)&&(this.inFrustum|=1<<_);else for(let _=0;_<u;_++)l.terrainReady?d[_].containsBox(l.bbox)&&(this.inFrustum|=1<<_):d[_].containsSphere(l.bsphere)&&(this.inFrustum|=1<<_);if(this.inFrustum||this._cameraInside||l.tileZoom<3){let _=Math.abs(t._lonLat.height),f=t.eye.length2()-c.ellipsoid.polarSizeSqr,g=10687647287563281e-5*c._heightFactor;f=f<g?g:f;let m=l.tileZoom<2||l.tileZoom>19||l.tileZoom<6&&!l.terrainReady;if(t.isOrthographic){let p=t.getForward();m=m||p.dot(l._sw.getNormal())<-0||p.dot(l._nw.getNormal())<-0||p.dot(l._ne.getNormal())<-0||p.dot(l._se.getNormal())<-0}else m=m||t.eye.distance2(l._sw)<f||t.eye.distance2(l._nw)<f||t.eye.distance2(l._ne)<f||t.eye.distance2(l._se)<f;(this.inFrustum&&(m||_>1e4)||this._cameraInside)&&this.quadTreeStrategy.collectVisibleNode(this),l.tileZoom<2?this.traverseNodes(t,s,n,o,a):l.terrainReady&&(!s&&t.projectedSize(l.bsphere.center,l._plainRadius)<this.quadTreeStrategy.lodSize||s&&(l.tileZoom===s||!m))?m?(l.passReady=!0,this.renderNode(this.inFrustum,!this.inFrustum,n,o)):this.state=0:l.terrainReady&&l.checkZoom()&&(!s||t.projectedSize(l.bsphere.center,l.bsphere.radius)>this.quadTreeStrategy._maxLodSize)?this.traverseNodes(t,s,l,o,a):m?(l.passReady=!!s&&l.terrainReady,this.renderNode(this.inFrustum,!this.inFrustum,n,o)):this.state=0}else this.state=0}renderNode(t,s,n,o){let a=this.segment;a.terrainReady||(a.initialized||a.initialize(),this.whileTerrainLoading(n),a.plainProcessing||a.createPlainSegmentAsync(),a.plainReady&&!o&&a.loadTerrain()),a.planet.lightEnabled&&!a.normalMapReady&&this.whileNormalMapCreating(),s?this.state=-1:(!this._cameraInside&&a.tileZoom>this.quadTreeStrategy.maxCurrZoom&&(this.quadTreeStrategy.maxCurrZoom=a.tileZoom),a.tileZoom<this.quadTreeStrategy.minCurrZoom&&(this.quadTreeStrategy.minCurrZoom=a.tileZoom),a._addViewExtent(),this.addToRender(t))}childrenPrevStateEquals(t){let s=this.nodes;return s.length===4&&s[0].prevState===t&&s[1].prevState===t&&s[2].prevState===t&&s[3].prevState===t}isFading(){let t=this.nodes;return this.state===2&&this.segment._transitionOpacity>0&&t.length===4&&t[0].state===1&&t[1].state===1&&t[2].state===1&&t[3].state===1}_collectFadingNodes(){if(this.segment.tileZoom<3)this.segment._transitionOpacity=1;else if(this.prevState!==1){this.segment._transitionOpacity=0,this._fadingNodes=[];let t=window.performance.now();if(this.segment._transitionTimestamp=t,this.parentNode){if(this.parentNode.prevState===1){let s=this.parentNode.parentNode;for(;s;){if(s.isFading()){for(let n=0;n<s.nodes.length;n++)s.nodes[n].segment._transitionOpacity=1,s.nodes[n]._fadingNodes=[];s.segment._transitionOpacity=0;break}s=s.parentNode}this.parentNode.whileTerrainLoading(),this._fadingNodes.push(this.parentNode),this.parentNode.segment._transitionOpacity=2,this.parentNode.segment._transitionTimestamp=t}else if(this.segment.childrenInitialized()&&this.childrenPrevStateEquals(1))for(let s=0;s<this.nodes.length;s++){let n=this.nodes[s];n.whileTerrainLoading(),this._fadingNodes.push(n),n.segment._transitionOpacity=2,n.segment._transitionTimestamp=t,n.prevState=n.state,n.state=0}}}}clearNeighbors(){this.neighbors&&(this.neighbors[0]=this.neighbors[1]=this.neighbors[2]=this.neighbors[3]=null,this.neighbors[0]=[],this.neighbors[1]=[],this.neighbors[2]=[],this.neighbors[3]=[])}_refreshTransitionOpacity(){if(this._fadingNodes.length===0)this.segment._transitionOpacity=1;else if(this._fadingNodes.length!==4||this.childrenPrevStateEquals(1)){for(let t=0;t<this._fadingNodes.length;t++)this.segment._transitionOpacity<1&&this._fadingNodes[t].segment._transitionOpacity===0&&(this._fadingNodes[t].segment._transitionOpacity=0,this.segment._transitionOpacity=1);this.segment.increaseTransitionOpacity()}else this.segment._transitionOpacity=1,this._fadingNodes=[]}addToRender(t){this.state=1;let s=this.quadTreeStrategy._renderedNodes;this.quadTreeStrategy._transitionOpacityEnabled?Zr(s,this,(a,l)=>a.segment.tileZoom-l.segment.tileZoom):(this.getRenderedNodesNeighbors(s),s.push(this)),this.segment.terrainReady||(this.quadTreeStrategy._renderCompleted=!1,this.quadTreeStrategy._terrainCompleted=!1);let n=0,o=this.quadTreeStrategy._renderedNodesInFrustum;for(;t;)1&t&&o[n].push(this),n++,t>>=1}applyNeighbor(t,s){const n=ui[s];if(this.neighbors[s].length===0||t.neighbors[n].length===0){const o=this.segment,a=t.segment,l=o.gridSize/(a.gridSize*Math.pow(2,a.tileZoom-o.tileZoom));let c=o.gridSize,d=a.gridSize;l>1?(c=Math.ceil(o.gridSize/l),d=a.gridSize):l<1&&(c=o.gridSize,d=Math.ceil(a.gridSize*l)),this.sideSizeLog2[s]=Math.log2(c),t.sideSizeLog2[n]=Math.log2(d)}this.neighbors[s].push(t),t.neighbors[n].push(this)}getRenderedNodesNeighbors(t){for(let s=t.length-1;s>=0;--s){let n=t[s],o=this.getCommonSide(n);o!==-1&&this.applyNeighbor(n,o)}}getCommonSide(t){const s=this.segment,n=t.segment;if(s.tileZoom===n.tileZoom&&s._tileGroup===n._tileGroup)return s.getNeighborSide(n);{const o=s._extentLonLat,a=n._extentLonLat;let l=o.northEast,c=o.southWest,d=a.northEast,u=a.southWest,_=l.lon,f=l.lat,g=c.lon,m=c.lat,p=d.lon,x=d.lat,y=u.lon,w=u.lat;if(s._tileGroup===n._tileGroup){if(_===y&&(f<=x&&m>=w||f>=x&&m<=w))return 1;if(g===p&&(f<=x&&m>=w||f>=x&&m<=w))return 3;if(f===w&&(g>=y&&_<=p||g<=y&&_>=p))return 0;if(m===x&&(g>=y&&_<=p||g<=y&&_>=p))return 2;if(n.tileX===0&&y===-_&&(f<=x&&m>=w||f>=x&&m<=w))return 1;if(s.tileX===0&&g===-p&&(f<=x&&m>=w||f>=x&&m<=w))return 3}if(s._tileGroup===0&&n._tileGroup===20&&s.tileY===0&&n.tileY===n.powTileZoom-1&&(g>=y&&_<=p||g<=y&&_>=p))return 0;if(s._tileGroup===0&&n._tileGroup===Pe&&s.tileY===s.powTileZoom-1&&n.tileY===0&&(g>=y&&_<=p||g<=y&&_>=p))return 2;if(s._tileGroup===Pe&&n._tileGroup===0&&s.tileY===0&&n.tileY===n.powTileZoom-1&&(g>=y&&_<=p||g<=y&&_>=p))return 0;if(s._tileGroup===20&&n._tileGroup===0&&s.tileY===s.powTileZoom-1&&n.tileY===0&&(g>=y&&_<=p||g<=y&&_>=p))return 2}return-1}whileNormalMapCreating(){const t=this.segment;t.terrainIsLoading||!t.terrainExists||t._inTheQueue||t.planet._normalMapCreator.queue(t);let s=this;for(;s.parentNode&&!s.segment.normalMapReady;)s=s.parentNode;const n=2<<t.tileZoom-s.segment.tileZoom-1;t.normalMapTexture=s.segment.normalMapTexture,t.normalMapTextureBias[0]=t.tileX-s.segment.tileX*n,t.normalMapTextureBias[1]=t.tileY-s.segment.tileY*n,t.normalMapTextureBias[2]=1/n}whileTerrainLoading(t){const s=this.segment;let n=this;if(t&&t.terrainReady)n=t.node;else for(;n.parentNode&&!n.segment.terrainReady;)n=n.parentNode;if(n.segment.terrainReady&&this.appliedTerrainNodeId!==n.nodeId){let o=2<<s.tileZoom-n.segment.tileZoom-1,a=s.tileX-n.segment.tileX*o,l=s.tileY-n.segment.tileY*o;const c=n.segment;let d,u,_,f;this.appliedTerrainNodeId=n.nodeId,this.equalizedSideWithNodeId[0]=this.equalizedSideWithNodeId[1]=this.equalizedSideWithNodeId[2]=this.equalizedSideWithNodeId[3]=this.appliedTerrainNodeId;let g=n.segment.gridSize/o,m=n.segment.fileGridSize/o;if(at.xmin=xt,at.xmax=Ct,at.ymin=xt,at.ymax=Ct,at.zmin=xt,at.zmax=Ct,g>=1){s.gridSize=g;let p=(g+1)*(g+1)*3;d=new Float64Array(p),u=new Float32Array(p),_=new Float32Array(p),c.noDataVertices&&(f=new Uint8Array(p/3)),dr(c.terrainVertices,c.terrainVerticesHigh,c.terrainVerticesLow,c.noDataVertices,c.gridSize,g*l,g*a,g,d,u,_,at,f)}else if(m>=1&&n.segment.terrainExists){s.gridSize=m;let p=(m+1)*(m+1)*3;d=new Float64Array(p),u=new Float32Array(p),_=new Float32Array(p),c.noDataVertices&&(f=new Uint8Array(p/3)),dr(c.normalMapVertices,c.normalMapVerticesHigh,c.normalMapVerticesLow,c.noDataVertices,n.segment.fileGridSize,m*l,m*a,m,d,u,_,at,f)}else{s.gridSize=Yh;let p,x=Math.floor(g*l),y=Math.floor(g*a);p=c.gridSize===1?c.terrainVertices:Kr(c.terrainVertices,c.gridSize,x,y,1);let w=1/g,C=l-w*x,T=a-w*y,P=new v(p[0],p[1],p[2]),E=new v(p[9],p[10],p[11]),S=new v(p[3]-p[0],p[4]-p[1],p[5]-p[2]),M=new v(p[6]-p[0],p[7]-p[1],p[8]-p[2]),R=new v(p[3]-p[9],p[4]-p[10],p[5]-p[11]),k=new v(p[6]-p[9],p[7]-p[10],p[8]-p[11]),B=new v;d=new Float64Array(3*be.length),u=new Float32Array(3*be.length),_=new Float32Array(3*be.length);for(let z=0;z<be.length;z++){let O=be[z].y+C,ze=be[z].x+T,D=ze*g,re=O*g;B=O+ze<w?S.scaleTo(D).addA(M.scaleTo(re)).addA(P):k.scaleTo(1-D).addA(R.scaleTo(1-re)).addA(E),v.doubleToTwoFloats(B,Fi,Oi);let Ee=3*z;d[Ee]=B.x,d[Ee+1]=B.y,d[Ee+2]=B.z,u[Ee]=Fi.x,u[Ee+1]=Fi.y,u[Ee+2]=Fi.z,_[Ee]=Oi.x,_[Ee+1]=Oi.y,_[Ee+2]=Oi.z,B.x<at.xmin&&(at.xmin=B.x),B.x>at.xmax&&(at.xmax=B.x),B.y<at.ymin&&(at.ymin=B.y),B.y>at.ymax&&(at.ymax=B.y),B.z<at.zmin&&(at.zmin=B.z),B.z>at.zmax&&(at.zmax=B.z)}}if(s.readyToEngage=!0,s.terrainVertices=d,s.terrainVerticesHigh=u,s.terrainVerticesLow=_,s.tempVertices=d,s.tempVerticesHigh=u,s.tempVerticesLow=_,s.noDataVertices=f,s.setBoundingVolume(at.xmin,at.ymin,at.zmin,at.xmax,at.ymax,at.zmax),s.tileZoom>s.planet.terrain.maxZoom&&n.segment.tileZoom>=s.planet.terrain.maxZoom&&(s._plainRadius=n.segment._plainRadius/o,s.terrainReady=!0,s.terrainIsLoading=!1,s.terrainVertices=d,s.terrainVerticesHigh=u,s.terrainVerticesLow=_,s.passReady=!0,this.appliedTerrainNodeId=this.nodeId,this.equalizedSideWithNodeId[0]=this.equalizedSideWithNodeId[1]=this.equalizedSideWithNodeId[2]=this.equalizedSideWithNodeId[3]=this.appliedTerrainNodeId,n.segment.terrainExists)){s.normalMapVertices=d,s.fileGridSize=Math.sqrt(d.length/3)-1;let p=Math.sqrt(c.normalMapNormals.length/3)-1,x=p/o;s.normalMapNormals=p>1?Io(c.normalMapNormals,p,x*l,x*a,x):c.normalMapNormals}}}destroy(){this.prevState=this.state=0,this.segment.destroySegment();let t=this.neighbors;for(let s=0,n=t.length;s<n;s++){let o=t[s];if(o)for(let a=0;a<o.length;a++){let l=o[a];l&&l.neighbors&&l.clearNeighbors()}}this.neighbors=null,this.parentNode=null,this.sideSizeLog2=null,this.segment=null}clearTree(){const t=this.getState();if(t===0||t===1)this.destroyBranches();else for(let s=0;s<this.nodes.length;s++)this.nodes[s]&&this.nodes[s].clearTree()}clearBranches(){for(let t=0;t<this.nodes.length;t++)this.nodes[t].clearBranches(),this.nodes[t].segment.deleteMaterials()}destroyBranches(){if(this.ready){let t,s=[];for(t=0;t<this.nodes.length;t++)s[t]=this.nodes[t];for(this.ready=!1,this.nodes=[],t=0;t<s.length;t++)s[t].destroyBranches(),s[t].destroy(),s[t]=null;s.length=0,s=null}}traverseTree(t){if(t(this),this.ready)for(let s=0;s<this.nodes.length;s++)this.nodes[s].traverseTree(t)}getOffsetOppositeNeighbourSide(t,s){let n=this,o=t.segment.tileZoom,a=0;for(;n.segment.tileZoom>o;)a+=Wa[n.partId][s]/(1<<n.segment.tileZoom-o),n=n.parentNode;return a}}class dn{constructor(t=2048){this._size=t,this._array=new Array(this._size),this._popIndex=Math.floor(.5*this._size),this._shiftIndex=this._popIndex,this.length=0}reset(){this._popIndex=Math.floor(.5*this._size),this._shiftIndex=this._popIndex,this.length=0}clear(){this._array.length=0,this._array=new Array(this._size),this._popIndex=Math.floor(.5*this._size),this._shiftIndex=this._popIndex,this.length=0}push(t){this.length++,this._array[this._popIndex++]=t}pop(){if(this.length){this.length--;let t=this._array[--this._popIndex];return this._array[this._popIndex]=null,this._array[this._popIndex-1]||(this._popIndex=Math.floor(.5*this._size),this._shiftIndex=this._popIndex),t}}unshift(t){this.length++,this._array[--this._shiftIndex]=t}shift(){if(this.length){this.length--;let t=this._array[this._shiftIndex];return this._array[this._shiftIndex++]=null,this._array[this._shiftIndex]||(this._popIndex=Math.floor(.5*this._size),this._shiftIndex=this._popIndex),t}}forEach(t){for(let s=this._shiftIndex;s<this._popIndex;s++)t(this._array[s])}}class un{constructor(t,s,n){this.quadTreeStrategy=t,this._layer=s,this._nodeCapacity=n,this._secondPASS=[],this._counter=0,this._deferredEntitiesPendingQueue=new dn,this._renderingNodes={}}insertEntity(t,s=!1){}setPickingEnabled(t){}dispose(){}insertEntities(t){}collectVisibleEntityCollections(t){}_queueDeferredNode(t){this._layer.getVisibility()&&(t._inTheQueue=!0,this._counter>=1?this._deferredEntitiesPendingQueue.push(t):this._execDeferredNode(t))}_execDeferredNode(t){this._counter++,requestAnimationFrame(()=>{if(t.applyCollection(),this._counter--,this._deferredEntitiesPendingQueue.length&&this._counter<1)for(;this._deferredEntitiesPendingQueue.length;){let s=this._deferredEntitiesPendingQueue.pop();if(s._inTheQueue=!1,s.isVisible())return void this._execDeferredNode(s)}})}}class Is{constructor(t){this._skipPreRender=!1,this.events=lt($h),this.name=t.name||"",this.projection=t.proj||cn,this.planet=t.planet,this._quadTreeList=[],this._visibleNodes={},this._renderedNodes=[],this._renderedNodesInFrustum=[],this._fadingNodes=new Map,this._fadingNodesInFrustum=[],this._fadingOpaqueSegments=[],this.minCurrZoom=xt,this.maxCurrZoom=Ct,this._viewExtent=new U(new L(180,180),new L(-180,-180)),this._lodSize=256,this._curLodSize=256,this._minLodSize=512,this._maxLodSize=256,this.maxEqualZoomAltitude=t.maxEqualZoomAltitude||15e6,this.minEqualZoomAltitude=t.minEqualZoomAltitude||1e4,this.minEqualZoomCameraSlope=t.minEqualZoomCameraSlope||.8,this._renderCompleted=!1,this._renderCompletedActivated=!1,this._terrainCompleted=!1,this._terrainCompletedActivated=!1,this._transitionOpacityEnabled=t.transitionOpacityEnabled==null||t.transitionOpacityEnabled}get lodSize(){return this._lodSize}setLodSize(t,s,n){this._maxLodSize=n||this._maxLodSize,this._minLodSize=s||this._minLodSize,this._curLodSize=t,this._renderCompletedActivated=!1,this._terrainCompletedActivated=!1}createEntityCollectionsTreeStrategy(t,s){return new un(this,t,s)}destroyBranches(){this._renderCompletedActivated=!1,this._terrainCompletedActivated=!1;for(let t=0,s=this._quadTreeList.length;t<s;t++)this._quadTreeList[t].destroyBranches()}clearLayerMaterial(t,s=!1){let n=t.__id;for(let o=0,a=this._quadTreeList.length;o<a;o++)this._quadTreeList[o].traverseTree(l=>{if(s&&this._renderedNodes.includes(l))return;let c=l.segment.materials;c[n]&&(c[n].clear(),c[n]=null)})}get terrainReady(){return this._terrainCompleted&&this._terrainCompletedActivated}_checkRendercompleted(){this._renderCompleted?this._renderCompletedActivated||(this._renderCompletedActivated=!0,this.events.dispatch(this.events.rendercompleted,!0)):this._renderCompletedActivated=!1,this._renderCompleted=!0,this._terrainCompleted?this._terrainCompletedActivated||(this._terrainCompletedActivated=!0,this.events.dispatch(this.events.terraincompleted,!0)):this._terrainCompletedActivated=!1,this._terrainCompleted=!0}_initEvents(){this.planet.renderer.events.on("resize",()=>{this._renderCompletedActivated=!1,this._terrainCompletedActivated=!1}),this.planet.renderer.events.on("postdraw",()=>{this._checkRendercompleted()})}init(t){this._initEvents(),this._renderedNodesInFrustum=new Array(t.frustums.length);for(let s=0,n=this._renderedNodesInFrustum.length;s<n;s++)this._renderedNodesInFrustum[s]=[];this.preRender(),this.clearRenderedNodes(),this.preLoad()}clearRenderedNodes(){this._clearRenderedNodeList(),this._clearRenderNodesInFrustum()}_clearRenderedNodeList(){this._renderedNodes.length=0,this._renderedNodes=[]}_clearRenderNodesInFrustum(){for(let t=0,s=this._renderedNodesInFrustum.length;t<s;t++)this._renderedNodesInFrustum[t].length=0,this._renderedNodesInFrustum[t]=[]}_collectRenderedNodesMaxZoom(t){if(t.isOrthographic||t.slope>this.minEqualZoomCameraSlope&&t._lonLat.height<this.maxEqualZoomAltitude&&t._lonLat.height>this.minEqualZoomAltitude){this.minCurrZoom=this.maxCurrZoom;let s=this._renderedNodes,n=this._renderedNodesInFrustum,o=[];this._clearRenderNodesInFrustum(),this._renderedNodes=[];for(let a=0,l=s.length;a<l;a++){let c=s[a],d=c.segment.centerNormal.dot(t.getBackward());if(c.segment.tileZoom===this.maxCurrZoom||d<.81){this._renderedNodes.push(c);let u=0,_=c.inFrustum;for(;_;)1&_&&n[u].push(c),u++,_>>=1}else o.push(c)}for(let a=0,l=o.length;a<l;a++)o[a].renderTree(t,this.maxCurrZoom,null,!1,o[a])}}set transitionOpacityEnabled(t){this._transitionOpacityEnabled=t}get transitionOpacityEnabled(){return this._transitionOpacityEnabled}collectRenderNodes(t){if(this._skipPreRender&&(this._lodSize=wo(t.slope<0?0:t.slope,this._curLodSize,this._minLodSize),t._insideSegment=null,this._clearRenderedNodeList(),this._clearRenderNodesInFrustum(),this._viewExtent.southWest.set(180,180),this._viewExtent.northEast.set(-180,-180),this.minCurrZoom=xt,this.maxCurrZoom=Ct,this._collectRenderNodes(t),this._collectRenderedNodesMaxZoom(t),this._fadingNodes.clear(),this._transitionOpacityEnabled)){let s=[];for(let n=0;n<this._renderedNodes.length;n++){let o=this._renderedNodes[n];if(o._collectFadingNodes(),o._refreshTransitionOpacity(),o.segment._transitionOpacity>=1)o.clearNeighbors(),o.getRenderedNodesNeighbors(s),s.push(o);else for(let a=0;a<o._fadingNodes.length;a++){let l=o._fadingNodes[a];l.segment&&l.segment._transitionOpacity>=1&&(l.clearNeighbors(),l.getRenderedNodesNeighbors(s),s.push(l))}}}this._skipPreRender=!0}preRender(){this._skipPreRender=!1;for(let t=0;t<this._quadTreeList.length;t++){let s=this._quadTreeList[t];s.createChildNodes(),s.segment.createPlainSegment();for(let n=0;n<s.nodes.length;n++)s.nodes[n].segment.createPlainSegment()}}preLoad(){for(let t=0;t<this._quadTreeList.length;t++){let s=this._quadTreeList[t];s.segment.passReady=!0,s.renderNode(1),this.planet.normalMapCreator.drawSingle(s.segment);for(let n=0;n<s.nodes.length;n++)s.nodes[n].segment.passReady=!0,s.nodes[n].renderNode(1),this.planet._normalMapCreator.drawSingle(s.nodes[n].segment)}}_clearVisibleNodes(){this._visibleNodes={}}_collectRenderNodes(t){this._clearVisibleNodes();for(let s=0;s<this._quadTreeList.length;s++)this._quadTreeList[s].renderTree(t,0,null)}clear(){for(let t=0;t<this._quadTreeList.length;t++)this._quadTreeList[t].clearTree()}get quadTreeList(){return this._quadTreeList}getTileXY(t,s){let n,o,a=s,l=1<<a;return n=At(t.lon,360/l,-180),o=At(t.lat,180/l,90),[n,o,a,0]}getLonLatTileOffset(t,s,n,o,a){let l;l=Si(s,n,o,U.createFromArray([-180,-90,180,90]));let c=l.getWidth()/(a-1),d=l.getHeight()/(a-1);return[a-Math.ceil((t.lat-l.southWest.lat)/d)-1,Math.floor((t.lon-l.southWest.lon)/c)]}collectVisibleNode(t){this._visibleNodes[t.nodeId]=t}}const $h=["rendercompleted","terraincompleted"],zs=new hn({code:"epsg:4326",units:Ea}),ho=(90-ct)/Math.pow(2,7);class Hr extends Aa{constructor(t,s,n,o){super(t,s,n,o),this._projection=zs,this._extentLonLat=this._extent,this._extentMerc=new U(o.southWest.forwardMercatorEPS01(),o.northEast.forwardMercatorEPS01()),this._isNorth=this._extent.northEast.lat>0,this.isPole=!0}_setExtentLonLat(){this._extentLonLat=this._extent}projectNative(t){return t}getInsideLonLat(t){return t._lonLat}_getMaxZoom(){let t;if(this._isNorth){let s=Math.floor((90-this._extent.northEast.lat)/ho);t=Math.floor(s/16)+7}else{let s=Math.floor((Ot-this._extent.northEast.lat)/ho);t=12-Math.floor(s/16)}return t}checkZoom(){return super.checkZoom()&&this.tileZoom<=this._getMaxZoom()}_assignTileIndexes(){this._assignTileXIndexes(this._extent),this._assignTileYIndexes(this._extent),this.tileIndex=zt.getTileIndex(this.tileX,this.tileY,this.tileZoom,this._tileGroup)}_assignTileXIndexes(t){this.tileX=At(t.getCenter().lon,t.getWidth(),-180);let s=1<<this.tileZoom;this.tileXE=(this.tileX+1)%s,this.tileXW=(s+this.tileX-1)%s}_assignTileYIndexes(t){const s=t.getCenter().lat;s>0?(this._tileGroup=20,this.tileY=At(s,t.getHeight(),90)):(this._tileGroup=Pe,this.tileY=At(s,t.getHeight(),Ot)),this.tileYN=this.tileY-1,this.tileYS=this.tileY+1}_projToDeg(t,s){return new L(t,s)}_assignGlobalTextureCoordinates(){const t=this._extent;this._globalTextureCoordinates[0]=(t.southWest.lon+180)/360,this._globalTextureCoordinates[1]=(90-t.northEast.lat)/180,this._globalTextureCoordinates[2]=(t.northEast.lon+180)/360,this._globalTextureCoordinates[3]=(90-t.southWest.lat)/180}_getLayerExtentOffset(t){const s=t._extent,n=this._extent,o=s.northEast.lon-s.southWest.lon,a=s.northEast.lat-s.southWest.lat;return[(n.southWest.lon-s.southWest.lon)/o,(s.northEast.lat-n.northEast.lat)/a,(n.northEast.lon-n.southWest.lon)/o,(n.northEast.lat-n.southWest.lat)/a]}layerOverlap(t){return this._extent.overlaps(t._extent)}getDefaultTexture(){return this._isNorth?this.planet.solidTextureOne:this.planet.solidTextureTwo}getExtentLonLat(){return this._extent}}class pe{constructor(t,s,n,o,a,l){this.strategy=t,this.layer=t._layer,this.parentNode=n,this.childNodes=[],this.partId=s,this.nodeId=s+(n?4*n.nodeId+1:0),this.state=null,this.extent=o,this.count=0,this.deferredEntities=[],this.entityCollection=null,this.zoom=l,this._inTheQueue=!1,this.bsphere=new Ft,a&&this._setExtentBounds()}insertEntity(t,s=!1){this.buildTree([t],s)}_addEntitiesToCollection(t,s=!1){if(t.length){const n=this.layer,o=n._planet;let a=this.entityCollection;a||(a=new se({pickingEnabled:n._pickingEnabled,labelMaxLetters:n.labelMaxLetters}),a._layer=this.layer,a.addTo(o,!0),a._quadNode=this,n._bindEventsDefault(a),this.entityCollection=a),s||!n.async?this.entityCollection.addEntities(t):this.deferredEntities.push.apply(this.deferredEntities,t)}}_setExtentBounds(){this.nodeId?this.bsphere.setFromExtent(this.layer._planet.ellipsoid,this.extent.inverseMercator()):(this.bsphere.radius=this.layer._planet.ellipsoid.equatorialSize,this.bsphere.center=new v)}__setLonLat__(t){return t._lonLat.isZero()&&!t._cartesian.isZero()&&(t._lonLat=this.layer._planet.ellipsoid.cartesianToLonLat(t._cartesian)),Math.abs(t._lonLat.lat)<ct?t._lonLatMerc=t._lonLat.forwardMercator():t._lonLatMerc=new L,t._lonLatMerc}buildTree(t,s=!1){if(this.count+=t.length,t.length>this.layer._nodeCapacity){const n=this.childNodes;n.length||this.createChildNodes();let o=[],a=[],l=[],c=[],d=t.length;for(;d--;){const u=t[d];n[0].isInside(u)?(u._nodePtr=n[0],o.push(u)):n[1].isInside(u)?(u._nodePtr=n[1],a.push(u)):n[2].isInside(u)?(u._nodePtr=n[2],l.push(u)):n[3].isInside(u)&&(u._nodePtr=n[3],c.push(u))}o.length&&n[0].buildTree(o,s),a.length&&n[1].buildTree(a,s),l.length&&n[2].buildTree(l,s),c.length&&n[3].buildTree(c,s)}else this._addEntitiesToCollection(t,s)}isInside(t){return!!t._lonLatMerc&&this.extent.isInside(t._lonLatMerc)}createChildNodes(){const t=this.strategy,s=this.extent,n=.5*s.getWidth(),o=.5*s.getHeight(),a=s.northEast,l=s.southWest,c=new L(l.lon+n,l.lat+o),d=this.childNodes,u=this.layer._planet,_=this.zoom+1;d[0]=new pe(t,0,this,new U(new L(l.lon,l.lat+o),new L(l.lon+n,a.lat)),u,_),d[1]=new pe(t,1,this,new U(c,new L(a.lon,a.lat)),u,_),d[2]=new pe(t,2,this,new U(new L(l.lon,l.lat),c),u,_),d[3]=new pe(t,3,this,new U(new L(l.lon+n,l.lat),new L(a.lon,l.lat+o)),u,_)}collectRenderCollectionsPASS1(t,s){const n=t[this.nodeId];if(n){const o=this.childNodes;this.entityCollection?this.renderCollection(s,t):o.length&&(n.state===1?this.strategy._secondPASS.push(this):(o[0].collectRenderCollectionsPASS1(t,s),o[1].collectRenderCollectionsPASS1(t,s),o[2].collectRenderCollectionsPASS1(t,s),o[3].collectRenderCollectionsPASS1(t,s)))}}collectRenderCollectionsPASS2(t,s,n){const o=this.layer._planet.camera,a=o.eye.distance(this.bsphere.center)-this.bsphere.radius<3570*Math.sqrt(o._lonLat.height)||o._lonLat.height>1e4;if(this.count>0&&a&&o.containsSphere(this.bsphere)){const l=this.childNodes;this.entityCollection?this.renderCollection(s,t,n):l.length&&(l[0].collectRenderCollectionsPASS2(t,s,n),l[1].collectRenderCollectionsPASS2(t,s,n),l[2].collectRenderCollectionsPASS2(t,s,n),l[3].collectRenderCollectionsPASS2(t,s,n))}}applyCollection(){this.entityCollection.addEntities(this.deferredEntities),this.deferredEntities.length=0,this.deferredEntities=[],this._inTheQueue=!1}traverseTree(t){const s=this.childNodes;this.entityCollection?t(this):s.length&&(s[0].traverseTree(t),s[1].traverseTree(t),s[2].traverseTree(t),s[3].traverseTree(t))}renderCollection(t,s,n){const o=this.strategy;o._renderingNodes[this.nodeId]=!0,this.deferredEntities.length&&!this._inTheQueue&&(this.layer.async?o._queueDeferredNode(this):this.applyCollection());let a=this.entityCollection,l=this.layer;if(a._fadingOpacity=l._fadingOpacity,a.scaleByDistance=l.scaleByDistance,a.pickingScale=l.pickingScale,a.polygonOffsetUnits=l.polygonOffsetUnits,t.push(a),l.clampToGround||l.relativeToGround){const c=a._entities;let d=c.length;if(s[this.nodeId]&&s[this.nodeId].state===1)for(;d--;){let u=c[d];this.alignEntityToTheGround(u,s[this.nodeId].segment)}else if(n)for(;d--;){let u=c[d];this.alignEntityToTheGround(u,s[n].segment)}else{const u=this.strategy.quadTreeStrategy._renderedNodes;for(;d--;){let _=c[d],f=u.length;for(;f--;)if(u[f].segment.isEntityInside(_)){this.alignEntityToTheGround(_,u[f].segment);break}}}}}alignEntityToTheGround(t,s){let n=new v;s.getEntityTerrainPoint(t,n);let o=Number(this.layer.relativeToGround)&&t._altitude||0;if(o){let a=this.layer._planet.ellipsoid.getSurfaceNormal3v(n);t._setCartesian3vSilent(n.addA(a.scale(o)))}else t._setCartesian3vSilent(n)}isVisible(){return!!this.strategy._renderingNodes[this.nodeId]}}class Ce extends pe{constructor(t,s,n,o,a,l){super(t,s,n,o,a,l),this.strategy=t,this.isNorth=!1}createChildNodes(){const t=this.strategy,s=this.extent,n=.5*s.getWidth(),o=.5*s.getHeight(),a=s.northEast,l=s.southWest,c=new L(l.lon+n,l.lat+o),d=this.childNodes,u=this.layer._planet,_=this.zoom+1;d[0]=new Ce(t,0,this,new U(new L(l.lon,l.lat+o),new L(l.lon+n,a.lat)),u,_),d[1]=new Ce(t,1,this,new U(c,new L(a.lon,a.lat)),u,_),d[2]=new Ce(t,2,this,new U(new L(l.lon,l.lat),c),u,_),d[3]=new Ce(t,3,this,new U(new L(l.lon+n,l.lat),new L(a.lon,l.lat+o)),u,_)}_setExtentBounds(){this.extent.northEast.lat>0&&(this.isNorth=!0),this.bsphere.setFromExtent(this.layer._planet.ellipsoid,this.extent)}__setLonLat__(t){return t._lonLat.isZero()&&(t._lonLat=this.layer._planet.ellipsoid.cartesianToLonLat(t._cartesian)),t._lonLat}isVisible(){return!(!this.isNorth||!this.strategy._renderingNodesNorth[this.nodeId])||!!this.strategy._renderingNodesSouth[this.nodeId]}isInside(t){return this.extent.isInside(t._lonLat)}renderCollection(t,s,n){this.isNorth?this.strategy._renderingNodesNorth[this.nodeId]=!0:this.strategy._renderingNodesSouth[this.nodeId]=!0,this.deferredEntities.length&&!this._inTheQueue&&(this.layer.async?this.strategy._queueDeferredNode(this):this.applyCollection());const o=this.entityCollection;o._fadingOpacity=this.layer._fadingOpacity,o.scaleByDistance=this.layer.scaleByDistance,o.pickingScale=this.layer.pickingScale,o.isEmpty()||t.push(o)}}class Xh extends un{constructor(t,s,n){super(t,s,n);let o=s._planet;this._entityCollectionsTree=new pe(this,0,null,U.createFromArray([-2003750834e-2,-2003750834e-2,2003750834e-2,2003750834e-2]),o,0),this._entityCollectionsTreeNorth=new Ce(this,0,null,U.createFromArray([-180,ct,180,90]),o,0),this._entityCollectionsTreeSouth=new Ce(this,0,null,U.createFromArray([-180,-90,180,Ot]),o,0),this._renderingNodes={},this._renderingNodesNorth={},this._renderingNodesSouth={}}insertEntity(t,s=!1){t._lonLat.lat>ct?(this._entityCollectionsTreeNorth.__setLonLat__(t),this._entityCollectionsTreeNorth.insertEntity(t,s)):t._lonLat.lat<Ot?(this._entityCollectionsTreeSouth.__setLonLat__(t),this._entityCollectionsTreeSouth.insertEntity(t,s)):(this._entityCollectionsTree.__setLonLat__(t),this._entityCollectionsTree.insertEntity(t,s))}setPickingEnabled(t){this._entityCollectionsTree&&this._entityCollectionsTree.traverseTree(s=>{s.entityCollection.setPickingEnabled(t)}),this._entityCollectionsTreeNorth&&this._entityCollectionsTreeNorth.traverseTree(s=>{s.entityCollection.setPickingEnabled(t)}),this._entityCollectionsTreeSouth&&this._entityCollectionsTreeSouth.traverseTree(s=>{s.entityCollection.setPickingEnabled(t)})}dispose(){this._entityCollectionsTree=null,this._entityCollectionsTreeNorth=null,this._entityCollectionsTreeSouth=null,this._renderingNodes={},this._renderingNodesNorth={},this._renderingNodesSouth={}}insertEntities(t){let s=[],n=[],o=[];for(let a=0,l=t.length;a<l;a++){let c=t[a];c._lonLat.lat>ct?(s.push(c),this._entityCollectionsTreeNorth.__setLonLat__(c)):c._lonLat.lat<Ot?(n.push(c),this._entityCollectionsTreeSouth.__setLonLat__(c)):(o.push(c),this._entityCollectionsTree.__setLonLat__(c))}this._entityCollectionsTree.buildTree(o),this._entityCollectionsTreeNorth.buildTree(s),this._entityCollectionsTreeSouth.buildTree(n)}collectVisibleEntityCollections(t){this._renderingNodes={},this._renderingNodesNorth={},this._renderingNodesSouth={};let s=this._layer._planet.quadTreeStrategy;this._secondPASS=[],this._entityCollectionsTree.collectRenderCollectionsPASS1(s._visibleNodes,t);let n=this._secondPASS.length;for(;n--;)this._secondPASS[n].collectRenderCollectionsPASS2(s._visibleNodes,t,this._secondPASS[n].nodeId);for(this._secondPASS=[],this._entityCollectionsTreeNorth.collectRenderCollectionsPASS1(s._visibleNodesNorth,t),n=this._secondPASS.length;n--;)this._secondPASS[n].collectRenderCollectionsPASS2(s._visibleNodesNorth,t,this._secondPASS[n].nodeId);for(this._secondPASS=[],this._entityCollectionsTreeSouth.collectRenderCollectionsPASS1(s._visibleNodesSouth,t),n=this._secondPASS.length;n--;)this._secondPASS[n].collectRenderCollectionsPASS2(s._visibleNodesSouth,t,this._secondPASS[n].nodeId)}}class La extends Is{constructor(t){super({name:"Earth",...t}),this._visibleNodesNorth={},this._visibleNodesSouth={}}collectVisibleNode(t){let s=t.segment._tileGroup;s===20?this._visibleNodesNorth[t.nodeId]=t:s===Pe?this._visibleNodesSouth[t.nodeId]=t:this._visibleNodes[t.nodeId]=t}_clearVisibleNodes(){super._clearVisibleNodes(),this._visibleNodesNorth={},this._visibleNodesSouth={}}createEntityCollectionsTreeStrategy(t,s){return new Xh(this,t,s)}init(t){this._quadTreeList=[new qt(Aa,this,0,null,0,U.createFromArray([-2003750834e-2,-2003750834e-2,2003750834e-2,2003750834e-2])),new qt(Hr,this,0,null,0,U.createFromArray([-180,ct,180,90])),new qt(Hr,this,0,null,0,U.createFromArray([-180,-90,180,Ot]))],super.init(t)}getTileXY(t,s){let n,o,a=function(d,u=ct){return d>u?20:d<-u?Pe:0}(t.lat,ct),l=s,c=1<<l;if(a===20)n=At(t.lon,360/c,-180),o=At(t.lat,(90-ct)/c,90);else if(a===Pe)n=At(t.lon,360/c,-180),o=At(t.lat,(90-ct)/c,Ot);else{let d=Ji(t);n=At(d.lon,Qi/c,-2003750834e-2),o=At(d.lat,Qi/c,Lt)}return[n,o,l,a]}getLonLatTileOffset(t,s,n,o,a){let l,c=t;t.lat>ct?l=Si(s,n,o,U.createFromArray([-180,ct,180,90])):t.lat<Ot?l=Si(s,n,o,U.createFromArray([-180,-90,180,Ot])):(c=Ji(t),l=Ze(s,n,o));let d=l.getWidth()/(a-1),u=l.getHeight()/(a-1);return[a-Math.ceil((c.lat-l.southWest.lat)/u)-1,Math.floor((c.lon-l.southWest.lon)/d)]}}class Pa{constructor(t={}){this.model=t.model||null,this.src=t.src||null,this._cached_ix=0,this._cached_iy=0,this._v00=0,this._v01=0,this._v10=0,this._v11=0,this._t=0}static loadModel(t){return t?fetch(t,{}).then(s=>{if(!s.ok)throw Error("Geoid model file: HTTP error "+s.status);return s.arrayBuffer()}).then(s=>{if(s)return new Uint8Array(s);throw Error("Geoid model file: no data from "+t)}).then(function(s){if(s[0]!==80||s[1]!==53||(s[2]!==13||s[3]!==10)&&s[2]!==10)throw new Error("Geoid model file: no PGM header");var n,o,a=s[2]===13?4:3,l=null,c=null;function d(){let f=a;for(var g=a;;g++){if(g>=s.length)throw new Error("Geoid model file: missing newline in header");if(s[g]===10){a=g+1;break}}return g>f&&s[g-1]===13&&g--,String.fromCharCode.apply(null,s.slice(f,g))}for(;(o=d())[0]==="#";)if(n=o.match(/^# Offset (.*)$/)){if(l=parseInt(n[1],10),!isFinite(l))throw new Error("Geoid model file: bad offset "+n[1])}else if((n=o.match(/^# Scale (.*)$/))&&(c=parseFloat(n[1]),!isFinite(c)))throw new Error("Geoid model file: bad scale "+n[1]);let u=0,_=0;if((n=o.match(/^\s*(\d+)\s+(\d+)\s*$/))&&(u=parseInt(n[1],10),_=parseInt(n[2],10)),!(n&&u>=0&&_>=0))throw new Error("Geoid model file: bad PGM width&height line");if(parseInt(d())!=65535)throw new Error("Geoid model file: PGM file must have 65535 gray levels");if(l===null)throw new Error("Geoid model file: PGM file does not contain offset");if(c===null)throw new Error("Geoid model file: PGM file does not contain scale");if(u<2||_<2)throw new Error("Geoid model file: Raster size too small");if(s.length-a!=u*_*2)throw new Error("Geoid model file: File has the wrong length");return{scale:c,offset:l,width:u,height:_,rlonres:u/360,rlatres:(_-1)/180,i:a,rawfile:s}}):new Promise(s=>{s(null)})}setModel(t){this.model=t}_rawval(t,s){let n=this.model;s<0?(s=-s,t+=n.width/2):s>=n.height&&(s=2*(n.height-1)-s,t+=n.width/2),t<0?t+=n.width:t>=n.width&&(t-=n.width);let o=2*(s*n.width+t)+n.i;return n.rawfile[o]<<8|n.rawfile[o+1]}getHeightLonLat(t){return this.getHeight(t.lon,t.lat)}getHeight(t,s){if(!this.model)return 0;let n=this.model;t<0&&(t+=360);let o=(90-s)*n.rlatres,a=t*n.rlonres,l=Math.floor(o),c=Math.floor(a);a-=c,o-=l,l===n.height-1&&l--,this._cached_ix===c&&this._cached_iy===l||(this._cached_ix=c,this._cached_iy=l,this._v00=this._rawval(c,l),this._v01=this._rawval(c+1,l),this._v10=this._rawval(c,l+1),this._v11=this._rawval(c+1,l+1));let d=(1-o)*((1-a)*this._v00+a*this._v01)+o*((1-a)*this._v10+a*this._v11);return n.offset+n.scale*d}}class Zh{constructor(t,s=5){this.MAX_FRAMES=s,this._gridSize=64,this._planet=t,this._framebuffer=null,this._framebufferMercProj=null,this._texCoordsBuffer=null,this._indexBuffer=null,this._currentFrame=0,this._queue=[],this._animate=[],this._quadTexCoordsBuffer=null,this._quadVertexBuffer=null}init(){this._initShaders(),this._initBuffers()}createGridBuffer(t,s=!1){let n=this._gridSize,o=new L((t[3].lon-t[0].lon)/n,(t[3].lat-t[0].lat)/n),a=new L((t[2].lon-t[1].lon)/n,(t[2].lat-t[1].lat)/n),l=new L((t[1].lon-t[0].lon)/n,(t[1].lat-t[0].lat)/n),c=new L((t[2].lon-t[3].lon)/n,(t[2].lat-t[3].lat)/n);const d=(n+1)*(n+1)*2,u=d/2;let _=new Float32Array(d),f=new Float32Array(d),g=new Array(u),m=0,p=0,x=0,y=new Float32Array(2);for(let w=0;w<=n;w++){let C=new L(t[0].lon+w*o.lon,t[0].lat+w*o.lat),T=new L(t[1].lon+w*a.lon,t[1].lat+w*a.lat);for(let P=0;P<=n;P++){let E=ko(C,T,new L(t[0].lon+P*l.lon,t[0].lat+P*l.lat),new L(t[3].lon+P*c.lon,t[3].lat+P*c.lat));ae(E.lon,y),_[m++]=y[0],f[p++]=y[1],ae(E.lat,y),_[m++]=y[0],f[p++]=y[1],g[x++]=E}}if(s)for(let w=0;w<u;w++){let C=g[w].forwardMercator();ae(C.lon,y),_[2*w]=y[0],f[2*w]=y[1],ae(C.lat,y),_[2*w+1]=y[0],f[2*w+1]=y[1]}return[this._planet.renderer.handler.createArrayBuffer(_,2,u),this._planet.renderer.handler.createArrayBuffer(f,2,u)]}frame(){let t=this.MAX_FRAMES;for(;t--&&this._queue.length;){const s=this._queue.shift();s._isRendering=!1,s.rendering(),s.events.dispatch(s.events.loadend)}for(t=this._animate.length;t--;)this._animate[t].rendering()}add(t){t._isRendering||(t._isRendering=!0,t._animate?this._animate.push(t):this._queue.push(t))}remove(t){if(t._isRendering){let s;t._creationProceeding=!1,t._isRendering=!1,s=t._animate?this._animate:this._queue;for(let n=0;n<s.length;n++)if(s[n].isEqual(t))return void s.splice(n,1)}}_initBuffers(){let t=this._planet.renderer.handler;this._framebuffer=new Rt(t,{width:2,height:2,useDepth:!1}),this._framebuffer.init(),this._framebufferMercProj=new Rt(t,{width:2,height:2,useDepth:!1}),this._framebufferMercProj.init();let s=Math.log2(this._gridSize);this._texCoordsBuffer=this._planet._textureCoordsBufferCache[s],this._indexBuffer=this._planet._indexesCache[s][s][s][s][s].buffer,this._quadTexCoordsBuffer=t.createArrayBuffer(new Float32Array([0,1,1,1,0,0,1,0]),2,4),this._quadVertexBuffer=t.createArrayBuffer(new Float32Array([-1,1,1,1,-1,-1,1,-1]),2,4)}_initShaders(){this._planet.renderer.handler.addProgram(new X("geoImageTransform",{uniforms:{sourceTexture:"sampler2d",extentParamsHigh:"vec4",extentParamsLow:"vec4",isFullExtent:"bool"},attributes:{cornersHigh:"vec2",cornersLow:"vec2",texCoords:"vec2"},vertexShader:`attribute vec2 cornersHigh; 
                     attribute vec2 cornersLow;
                      attribute vec2 texCoords; 
                      uniform vec4 extentParamsHigh; 
                      uniform vec4 extentParamsLow; 
                      varying vec2 v_texCoords;
                      void main() {                                                             
                          v_texCoords = texCoords; 
                          vec2 highDiff = cornersHigh - extentParamsHigh.xy;
                          vec2 lowDiff = cornersLow - extentParamsLow.xy;                                        
                          gl_Position = vec4((-1.0 + (highDiff * step(1.0, length(highDiff)) + lowDiff) * extentParamsHigh.zw) * vec2(1.0, -1.0), 0.0, 1.0); 
                      }`,fragmentShader:`precision highp float;
                        uniform sampler2D sourceTexture;
                        uniform bool isFullExtent;
                        varying vec2 v_texCoords;
                        void main () {
                            if(!isFullExtent && (v_texCoords.x <= 0.001 || v_texCoords.x >= 0.999 ||
                                v_texCoords.y <= 0.001 || v_texCoords.y >= 0.999)) {
                                discard;
                            }
                            gl_FragColor = texture2D(sourceTexture, v_texCoords);
                        }`}))}}const Kh=["loadend","layerloadend"];class Sa{constructor(t=24){this.MAX_REQUESTS=t,this.events=lt(Kh),this._loading=0,this._queue=[],this._senderRequestCounter=[],this._promises={json:s=>s.json(),blob:s=>s.blob(),arrayBuffer:s=>s.arrayBuffer(),imageBitmap:s=>s.blob().then(n=>createImageBitmap(n,{premultiplyAlpha:"premultiply"})),text:s=>s.text()}}load(t,s){t.sender&&(this._senderRequestCounter[t.sender.__id]||(this._senderRequestCounter[t.sender.__id]={sender:t.sender,counter:0,__requestCounterFrame__:0}),this._senderRequestCounter[t.sender.__id].counter++),this._queue.push({params:t,callback:s}),this._exec()}fetch(t){return fetch(t.src,t.options||{}).then(s=>{if(!s.ok)throw Error(`Unable to load '${t.src}'`);return this._promises[t.type||"blob"](s)}).then(s=>({status:"ready",data:s})).catch(s=>({status:"error",msg:s.toString()}))}getRequestCounter(t){if(t){let s=this._senderRequestCounter[t.__id];if(s)return s.counter}return 0}isIdle(t){return t.isIdle}_checkLoadend(t,s){t.counter===0&&(!s._planet||s.quadTreeStrategy&&s.quadTreeStrategy._terrainCompletedActivated)?(s.events.dispatch(s.events.loadend,s),this.events.dispatch(this.events.layerloadend,s),t.__requestCounterFrame__=0):t.__requestCounterFrame__=requestAnimationFrame(()=>{this._checkLoadend(t,s)})}_handleResponse(t,s){t.callback(s);let n=t.params.sender;if(n&&(n.events.loadend.handlers.length||this.events.layerloadend.handlers.length)){let o=this._senderRequestCounter[n.__id];o&&o.counter>0&&(o.counter--,cancelAnimationFrame(o.__requestCounterFrame__),o.__requestCounterFrame__=requestAnimationFrame(()=>{this._checkLoadend(o,n)}))}this._exec()}_exec(){if(this._queue.length>0&&this._loading<this.MAX_REQUESTS){let t=this._queue.pop();if(!t)return;let s=t.params;if(!s.filter||s.filter(s))return this._loading++,fetch(s.src,s.options||{}).then(n=>{if(!n.ok)throw Error(`Unable to load '${s.src}'`);return this._promises[s.type||"blob"](n)}).then(n=>{this._loading--,this._handleResponse(t,{status:"ready",data:n})}).catch(n=>{this._loading--,this._handleResponse(t,{status:"error",msg:n.toString()})});this._handleResponse(t,{status:"abort"})}else this._loading===0&&this.events.dispatch(this.events.loadend)}abort(t){this._senderRequestCounter[t.__id]&&(this._senderRequestCounter[t.__id].counter=0,cancelAnimationFrame(this._senderRequestCounter[t.__id].__requestCounterFrame__),this._senderRequestCounter[t.__id].__requestCounterFrame__=0);for(let s=0,n=this._queue.length;s<n;s++){let o=this._queue[s];o&&o.params.sender&&t.isEqual(o.params.sender)&&(o.callback({status:"abort"}),this._queue[s]=null)}}abortAll(){for(let t=0,s=this._queue.length;t<s;t++){let n=this._queue[t];if(n){let o=n.params.sender;o&&this._senderRequestCounter[o.__id]&&(this._senderRequestCounter[o.__id].counter=0,cancelAnimationFrame(this._senderRequestCounter[o.__id].__requestCounterFrame__),this._senderRequestCounter[o.__id].__requestCounterFrame__=0),n.callback({status:"abort"}),this._queue[t]=null}}this._queue=[]}get loading(){return this._loading}get queue(){return this._queue}}class Qh{constructor(t,s={}){this._minTabelSize=s.minTableSize||1,this._maxTableSize=s.maxTableSize||8,this._planet=t,this._handler=null,this._verticesBufferArray=[],this._indexBufferArray=[],this._positionBuffer=null,this._framebuffer=null,this._normalMapVerticesTexture=null,this._width=s.width||128,this._height=s.height||128,this._queue=new dn(1024),this._lock=new zr}get width(){return this._width}get height(){return this._height}init(){this._maxTableSize=this._planet.maxGridSize||8,this._handler=this._planet.renderer.handler;const t=new X("normalMapBlur",{attributes:{a_position:"vec2"},uniforms:{s_texture:"sampler2d"},vertexShader:`attribute vec2 a_position;
                       attribute vec2 a_texCoord;

                      varying vec2 blurCoordinates[5];

                      void main() {
                          vec2 vt = a_position * 0.5 + 0.5; 
                           
                          gl_Position = vec4(a_position, 0.0, 1.0);
                          blurCoordinates[0] = vt;
                          blurCoordinates[1] = vt + ${1/this._width*1.407333};
                          blurCoordinates[2] = vt - ${1/this._height*1.407333};
                          blurCoordinates[3] = vt + ${1/this._width*3.294215};
                          blurCoordinates[4] = vt - ${1/this._height*3.294215};
                }`,fragmentShader:`precision lowp float;
                        uniform sampler2D s_texture;                        
                        varying vec2 blurCoordinates[5];                        

                        void main() {
                            lowp vec4 sum = vec4(0.0);
                            //if(blurCoordinates[0].x <= 0.01 || blurCoordinates[0].x >= 0.99 ||
                            //    blurCoordinates[0].y <= 0.01 || blurCoordinates[0].y >= 0.99){
                            //    sum = texture2D(s_texture, blurCoordinates[0]);
                            //} else {
                                sum += texture2D(s_texture, blurCoordinates[0]) * 0.204164;
                                sum += texture2D(s_texture, blurCoordinates[1]) * 0.304005;
                                sum += texture2D(s_texture, blurCoordinates[2]) * 0.304005;
                                sum += texture2D(s_texture, blurCoordinates[3]) * 0.093913;
                                sum += texture2D(s_texture, blurCoordinates[4]) * 0.093913;
                            //}
                            gl_FragColor = sum;
                        }`}),s=new X("normalMap",{attributes:{a_position:"vec2",a_normal:"vec3"},uniforms:{},vertexShader:`attribute vec2 a_position;
                      attribute vec3 a_normal;
                      
                      varying vec3 v_color;
                      
                      void main() {
                          gl_Position = vec4(a_position, 0, 1);
                          v_color = normalize(a_normal) * 0.5 + 0.5;
                      }`,fragmentShader:`precision highp float;
                        
                        varying vec3 v_color;
                        
                        void main () {
                            gl_FragColor = vec4(v_color, 1.0);
                        }`});this._handler.addProgram(t),this._handler.addProgram(s),this._framebuffer=new Rt(this._handler,{width:this._width,height:this._height,useDepth:!1}),this._framebuffer.init(),this._normalMapVerticesTexture=this._handler.createEmptyTexture_l(this._width,this._height);for(let o=this._minTabelSize;o<=this._maxTableSize;o++){const a=1<<o,l=a/2;let c=new Float32Array((a+1)*(a+1)*2);for(let d=0;d<=a;d++)for(let u=0;u<=a;u++){let _=2*(d*(a+1)+u);c[_]=u/l-1,c[_+1]=d/l-1}this._verticesBufferArray[a]=this._handler.createArrayBuffer(c,2,c.length/2),this._indexBufferArray[a]=this._planet._indexesCache[Math.log2(a)][Math.log2(a)][Math.log2(a)][Math.log2(a)][Math.log2(a)].buffer}const n=new Float32Array([-1,-1,1,-1,-1,1,1,1]);this._positionBuffer=this._handler.createArrayBuffer(n,2,n.length/2)}_drawNormalMapBlur(t){let s=t.normalMapNormals;if(t.node&&t.node.getState()!==0&&s&&s.length){const n=s.length/3,o=Math.sqrt(n)-1;let a=this._verticesBufferArray[o];if(a){t.planet.terrain.equalizeNormals&&(t._normalMapEdgeEqualize(0),t._normalMapEdgeEqualize(2),t._normalMapEdgeEqualize(3),t._normalMapEdgeEqualize(1));let l=t.normalMapTexturePtr;const c=this._handler,d=c.gl;let u=c.createArrayBuffer(s,3,n,d.DYNAMIC_DRAW);const _=this._framebuffer;let f=c.programs.normalMap,g=f._program.attributes;return _.bindOutputTexture(this._normalMapVerticesTexture),f.activate(),d.bindBuffer(d.ARRAY_BUFFER,a),d.vertexAttribPointer(g.a_position,a.itemSize,d.FLOAT,!1,0,0),d.bindBuffer(d.ARRAY_BUFFER,u),d.vertexAttribPointer(g.a_normal,u.itemSize,d.FLOAT,!1,0,0),d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,this._indexBufferArray[o]),d.drawElements(d.TRIANGLE_STRIP,this._indexBufferArray[o].numItems,d.UNSIGNED_INT,0),d.deleteBuffer(u),_.bindOutputTexture(l),f=c.programs.normalMapBlur,f.activate(),d.bindBuffer(d.ARRAY_BUFFER,this._positionBuffer),d.vertexAttribPointer(f._program.attributes.a_position,this._positionBuffer.itemSize,d.FLOAT,!1,0,0),d.activeTexture(d.TEXTURE0),d.bindTexture(d.TEXTURE_2D,this._normalMapVerticesTexture),d.uniform1i(f._program.uniforms.s_texture,0),d.drawArrays(d.TRIANGLE_STRIP,0,this._positionBuffer.numItems),!0}return!0}return!1}_drawNormalMapNoBlur(t){let s=t.normalMapNormals;if(t.node&&t.node.getState()!==0&&s&&s.length){const n=s.length/3,o=Math.sqrt(n)-1;let a=this._verticesBufferArray[o];if(a){t.planet.terrain.equalizeNormals&&(t._normalMapEdgeEqualize(0),t._normalMapEdgeEqualize(2),t._normalMapEdgeEqualize(3),t._normalMapEdgeEqualize(1));let l=t.normalMapTexturePtr;const c=this._handler,d=c.gl;let u=c.createArrayBuffer(s,3,n,d.DYNAMIC_DRAW);const _=this._framebuffer,f=c.programs.normalMap,g=f._program.attributes;return _.bindOutputTexture(l),f.activate(),d.bindBuffer(d.ARRAY_BUFFER,a),d.vertexAttribPointer(g.a_position,a.itemSize,d.FLOAT,!1,0,0),d.bindBuffer(d.ARRAY_BUFFER,u),d.vertexAttribPointer(g.a_normal,u.itemSize,d.FLOAT,!1,0,0),d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,this._indexBufferArray[o]),d.drawElements(d.TRIANGLE_STRIP,this._indexBufferArray[o].numItems,d.UNSIGNED_INT,0),d.deleteBuffer(u),!0}return!0}return!1}_drawNormalMap(t){return t.planet.terrain.isBlur(t)?this._drawNormalMapBlur(t):this._drawNormalMapNoBlur(t)}drawSingle(t){const s=this._handler.gl;this._framebuffer.activate(),s.disable(s.CULL_FACE),s.disable(s.DEPTH_TEST),s.disable(s.BLEND),t.terrainReady&&this._drawNormalMap(t)&&(t.normalMapReady=!0,t.normalMapTexture=t.normalMapTexturePtr,t.normalMapTextureBias[0]=0,t.normalMapTextureBias[1]=0,t.normalMapTextureBias[2]=1),t._inTheQueue=!1,s.enable(s.DEPTH_TEST),s.enable(s.CULL_FACE),s.enable(s.BLEND),this._framebuffer.deactivate()}frame(){if(this._queue.length){const t=this._handler.gl;this._framebuffer.activate(),t.disable(t.CULL_FACE),t.disable(t.DEPTH_TEST),t.disable(t.BLEND);let s=0,n=window.performance.now();for(;this._lock.isFree()&&this._queue.length&&s<.25;){const o=this._queue.shift();o.terrainReady&&this._drawNormalMap(o)&&(o.normalMapReady=!0,o.normalMapTexture=o.normalMapTexturePtr,o.normalMapTextureBias[0]=0,o.normalMapTextureBias[1]=0,o.normalMapTextureBias[2]=1),o._inTheQueue=!1,s=window.performance.now()-n}t.enable(t.BLEND),t.enable(t.DEPTH_TEST),t.enable(t.CULL_FACE),this._framebuffer.deactivate()}}get queueSize(){return this._queue.length}queue(t){t._inTheQueue=!0,this._queue.push(t)}unshift(t){t._inTheQueue=!0,this._queue.unshift(t)}remove(t){}clear(){for(;this._queue.length;)this._queue.pop()._inTheQueue=!1}lock(t){this._lock.lock(t)}free(t){this._lock.free(t)}}const _n=new hn({code:"equi",units:Ea}),Ra=`(function(){"use strict";let l=null,K=null,O=null,Q=null,S=null,T=null,U=null;function P(a,t){t<0?(t=-t,a+=l.width/2):t>=l.height&&(t=2*(l.height-1)-t,a+=l.width/2),a<0?a+=l.width:a>=l.width&&(a-=l.width);var n=2*(t*l.width+a)+l.i;return l.rawfile[n]<<8|l.rawfile[n+1]}const sa=.5*Math.PI,W=2003750834e-2,ia=Math.PI/W,ua=180/W,X=180/Math.PI,Ma=X*sa,Y=Math.PI/180,da=2*X;let k=0,Z=0,_=null;const B=function(a,t,n){this.x=a,this.y=t,this.z=n};var $=function(a,t,n,o){let f=function(c,C){if(!l)return 0;c<0&&(c+=360);var w=(90-C)*l.rlatres,M=c*l.rlonres,u=Math.floor(w),d=Math.floor(M);M-=d,w-=u,u===l.height-1&&u--,K===d&&O===u||(K=d,O=u,Q=P(d,u),S=P(d+1,u),T=P(d,u+1),U=P(d+1,u+1));let L=null;return L=(1-w)*((1-M)*Q+M*S)+w*((1-M)*T+M*U),l.offset+l.scale*L}(a,t)*n,h=Y*t,r=Y*a,m=Math.sin(h),x=Z/Math.sqrt(1-k*m*m),H=(x+f)*Math.cos(h);o.x=H*Math.cos(r),o.y=H*Math.sin(r),o.z=(x*(1-k)+f)*m},ma=function(a,t,n,o){$(a*ua,da*Math.atan(Math.exp(t*ia))-Ma,n,o)},e=new B(0,0,0),p=new B(0,0,0),y=new B(0,0,0),pa=function(a,t,n){let o=a.x,f=a.y,h=a.z;var r;o>=0?(r=65536*Math.floor(o/65536),t.x=Math.fround(r),n.x=Math.fround(o-r)):(r=65536*Math.floor(-o/65536),t.x=Math.fround(-r),n.x=Math.fround(o+r)),f>=0?(r=65536*Math.floor(f/65536),t.y=Math.fround(r),n.y=Math.fround(f-r)):(r=65536*Math.floor(-f/65536),t.y=Math.fround(-r),n.y=Math.fround(f+r)),h>=0?(r=65536*Math.floor(h/65536),t.z=Math.fround(r),n.z=Math.fround(h-r)):(r=65536*Math.floor(-h/65536),t.z=Math.fround(-r),n.z=Math.fround(h+r))};self.onmessage=function(a){if(a.data.model)l=a.data.model,l.rawfile=a.data.rawfile;else if(a.data.params){let t=549755748352,n=-549755748352,o=549755748352,f=-549755748352,h=549755748352,r=-549755748352;k=a.data.params[8],Z=a.data.params[9];let m=a.data.params[2],x=a.data.params[3],H=a.data.params[10],c=a.data.params[11],C=a.data.params[12],w=a.data.params[13];_=a.data.params[1]===0?ma:$;let M=Math.max(x,m),u=(a.data.params[6]-a.data.params[4])/M,d=(a.data.params[7]-a.data.params[5])/M,L=a.data.params[4],ya=a.data.params[7],aa=Math.max(x/m,1),N=M+1;const z=N*N,R=(m+1)*(m+1)*3;let b=new Float32Array(R),A=new Float64Array(R),F=new Float32Array(R),g=new Float32Array(R),V=new Float32Array(3*z),q=new Float64Array(3*z),v=new Float32Array(3*z),I=new Float32Array(3*z),s=0,i=0;for(let j=0;j<z;j++){let la=j%N,na=~~(j/N);_(L+la*u,ya-na*d,w,e);let D=e.x*H,E=e.y*c,G=e.z*C,J=1/Math.sqrt(D*D+E*E+G*G),oa=D*J,fa=E*J,ha=G*J;pa(e,p,y),q[i]=e.x,v[i]=p.x,I[i]=y.x,V[i++]=oa,q[i]=e.y,v[i]=p.y,I[i]=y.y,V[i++]=fa,q[i]=e.z,v[i]=p.z,I[i]=y.z,V[i++]=ha,na%aa==0&&la%aa==0&&(A[s]=e.x,F[s]=p.x,g[s]=y.x,b[s++]=oa,A[s]=e.y,F[s]=p.y,g[s]=y.y,b[s++]=fa,A[s]=e.z,F[s]=p.z,g[s]=y.z,b[s++]=ha,e.x<t&&(t=e.x),e.x>n&&(n=e.x),e.y<o&&(o=e.y),e.y>f&&(f=e.y),e.z<h&&(h=e.z),e.z>r&&(r=e.z))}let ta=.5*(n-t),ra=.5*(f-o),ea=.5*(r-h),wa=Math.sqrt(ta*ta+ra*ra+ea*ea);self.postMessage({id:a.data.params[0],plainVertices:A,plainVerticesHigh:F,plainVerticesLow:g,plainNormals:b,normalMapNormals:V,normalMapVertices:q,normalMapVerticesHigh:v,normalMapVerticesLow:I,plainRadius:wa},[A.buffer,F.buffer,g.buffer,b.buffer,V.buffer,q.buffer,v.buffer,I.buffer])}}})();
//# sourceMappingURL=PlainSegmentWorker.worker-CT1cj8jj.js.map
`,co=typeof self<"u"&&self.Blob&&new Blob([Ra],{type:"text/javascript;charset=utf-8"});function Jh(h){let t;try{if(t=co&&(self.URL||self.webkitURL).createObjectURL(co),!t)throw"";const s=new Worker(t,{name:h==null?void 0:h.name});return s.addEventListener("error",()=>{(self.URL||self.webkitURL).revokeObjectURL(t)}),s}catch{return new Worker("data:text/javascript;charset=utf-8,"+encodeURIComponent(Ra),{name:h==null?void 0:h.name})}finally{t&&(self.URL||self.webkitURL).revokeObjectURL(t)}}class tc extends en{constructor(t=2){super(t,Jh)}_onMessage(t){this._source.get(t.data.id)._plainSegmentWorkerCallback(t.data),t.data.plainVertices=null,t.data.plainVerticesHigh=null,t.data.plainVerticesLow=null,t.data.plainNormals=null,t.data.normalMapNormals=null,t.data.normalMapVertices=null,t.data.normalMapVerticesHigh=null,t.data.normalMapVerticesLow=null,this._source.delete(t.data.id)}setGeoid(t){if(t.model){let s=t.model,n={scale:s.scale,offset:s.offset,width:s.width,height:s.height,rlonres:s.rlonres,rlatres:s.rlatres,i:s.i};this._workerQueue.forEach(o=>{let a=new Uint8Array(s.rawfile.length);a.set(s.rawfile),o.postMessage({model:n,rawfile:a},[a.buffer])})}else this._workerQueue.forEach(s=>{s.postMessage({model:null})})}make(t){if(t.initialized)if(this._workerQueue.length){let s=this._workerQueue.pop();this._source.set(this._sourceId,t);let n=t._projection.id===zs.id||t._projection.id===_n.id?1:0,o=new Float64Array([this._sourceId,n,t.planet.terrain.gridSizeByZoom[t.tileZoom],t.planet.terrain.plainGridSize,t._extent.southWest.lon,t._extent.southWest.lat,t._extent.northEast.lon,t._extent.northEast.lat,t.planet.ellipsoid._e2,t.planet.ellipsoid.equatorialSize,t.planet.ellipsoid._invRadii2.x,t.planet.ellipsoid._invRadii2.y,t.planet.ellipsoid._invRadii2.z,t.planet._heightFactor]);this._sourceId++,s.postMessage({params:o},[o.buffer])}else this._pendingQueue.push(t);else this.check()}}const Ma=`(function(){"use strict";function H(r,e){return function(z,b){let v=0,N=z.length-1;for(;v<=N;){let n=Math.floor(.5*(v+N));if(Math.abs(z[n]-b)<.001)return n;z[n]<b?v=n+1:N=n-1}return-1}(r,e)!==-1}var y=function(r,e,z){this.x=r,this.y=e,this.z=z},Y=function(r,e,z){let b=r.x,v=r.y,N=r.z;var n;b>=0?(n=65536*Math.floor(b/65536),e.x=Math.fround(n),z.x=Math.fround(b-n)):(n=65536*Math.floor(-b/65536),e.x=Math.fround(-n),z.x=Math.fround(b+n)),v>=0?(n=65536*Math.floor(v/65536),e.y=Math.fround(n),z.y=Math.fround(v-n)):(n=65536*Math.floor(-v/65536),e.y=Math.fround(-n),z.y=Math.fround(v+n)),N>=0?(n=65536*Math.floor(N/65536),e.z=Math.fround(n),z.z=Math.fround(N-n)):(n=65536*Math.floor(-N/65536),e.z=Math.fround(-n),z.z=Math.fround(N+n))};y.prototype.sub=function(r){return new y(this.x-r.x,this.y-r.y,this.z-r.z)},y.prototype.add=function(r){return new y(this.x+r.x,this.y+r.y,this.z+r.z)},y.prototype.cross=function(r){return new y(this.y*r.z-this.z*r.y,this.z*r.x-this.x*r.z,this.x*r.y-this.y*r.x)},y.prototype.normalize=function(r){var e=this.x,z=this.y,b=this.z,v=1/Math.sqrt(e*e+z*z+b*b);return this.x=e*v,this.y=z*v,this.z=b*v,this},y.prototype.distance=function(r){return this.sub(r).length()},y.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)};var x=new y(0,0,0),i=new y(0,0,0),t=new y(0,0,0);self.onmessage=function(r){var e=r.data.elevations,z=r.data.this_plainVertices,b=r.data.this_plainNormals,v=r.data.this_normalMapVertices,N=r.data.this_normalMapNormals,n=r.data.heightFactor,Dr=r.data.gridSize,D=r.data.noDataValues,Hr=r.data.id,Q=549755748352,W=-549755748352,T=549755748352,$=-549755748352,Z=549755748352,X=-549755748352;const J=Math.sqrt(e.length)-1,K=J+1,R=K*K,C=Dr,vr=J/C,L=C+1,tr=n;var a,d,p,m,yr,sr,S=0,xr=0,U=L*L*3,h=new Float64Array(U),j=new Float32Array(U),k=new Float32Array(U),lr=new Uint8Array(L*L),u=v,g=N;if(J>=C){a=new Float32Array(3*R),d=new Float64Array(3*R),p=new Float32Array(3*R),m=new Float32Array(3*R);for(let f=0;f<R;f++){var Ar=f%K,Fr=~~(f/K),ur=f,o=3*ur,rr=e[ur];H(D,rr)&&(rr=0);var Mr=tr*rr,s=new y(u[o]+Mr*g[o],u[o+1]+Mr*g[o+1],u[o+2]+Mr*g[o+2]);if(Y(s,i,t),d[o]=s.x,d[o+1]=s.y,d[o+2]=s.z,p[o]=i.x,p[o+1]=i.y,p[o+2]=i.z,m[o]=t.x,m[o+1]=t.y,m[o+2]=t.z,Fr%vr==0&&Ar%vr==0){let A=new y(u[o],u[o+1],u[o+2]),V=new y(u[o+3],u[o+4],u[o+5]),F=e[ur+1];H(D,F)&&(F=0);let q=!1;if(D.length===0){let _=A.distance(V);q=Math.abs(rr-F)/_>10||rr<-5e3}q?lr[xr]=1:(lr[xr]=0,s.x<Q&&(Q=s.x),s.x>W&&(W=s.x),s.y<T&&(T=s.y),s.y>$&&($=s.y),s.z<Z&&(Z=s.z),s.z>X&&(X=s.z)),j[S]=i.x,k[S]=t.x,h[S++]=s.x,j[S]=i.y,k[S]=t.y,h[S++]=s.y,j[S]=i.z,k[S]=t.z,h[S++]=s.z,xr++}if(Fr!==J&&Ar!==J){var gr=f+1,M=3*gr,B=e[gr];H(D,B)&&(B=0);var cr=tr*B,ar=new y(u[M]+cr*g[M],u[M+1]+cr*g[M+1],u[M+2]+cr*g[M+2]);Y(ar,i,t),d[M]=ar.x,d[M+1]=ar.y,d[M+2]=ar.z,p[M]=i.x,p[M+1]=i.y,p[M+2]=i.z,m[M]=t.x,m[M+1]=t.y,m[M+2]=t.z;var Vr=f+K,c=3*Vr;H(D,B=e[Vr])&&(B=0);var wr=tr*B,nr=new y(u[c]+wr*g[c],u[c+1]+wr*g[c+1],u[c+2]+wr*g[c+2]);Y(nr,i,t),d[c]=nr.x,d[c+1]=nr.y,d[c+2]=nr.z,p[c]=i.x,p[c+1]=i.y,p[c+2]=i.z,m[c]=t.x,m[c+1]=t.y,m[c+2]=t.z;var qr=f+K+1,w=3*qr;H(D,B=e[qr])&&(B=0);var dr=tr*B,er=new y(u[w]+dr*g[w],u[w+1]+dr*g[w+1],u[w+2]+dr*g[w+2]);Y(er,i,t),d[w]=er.x,d[w+1]=er.y,d[w+2]=er.z,p[w]=i.x,p[w+1]=i.y,p[w+2]=i.z,m[w]=t.x,m[w+1]=t.y,m[w+2]=t.z;var Lr=ar.sub(s),Sr=nr.sub(s),Nr=er.sub(s),hr=Sr.cross(Nr).normalize(),zr=Nr.cross(Lr).normalize(),O=zr.add(hr).normalize();a[o]+=O.x,a[o+1]+=O.y,a[o+2]+=O.z,a[M]+=zr.x,a[M+1]+=zr.y,a[M+2]+=zr.z,a[c]+=hr.x,a[c+1]+=hr.y,a[c+2]+=hr.z,a[w]+=O.x,a[w+1]+=O.y,a[w+2]+=O.z}}}else{a=new Float32Array(U),d=new Float64Array(U),p=new Float32Array(U),m=new Float32Array(U),a=new Float32Array(U);var E=C/J,_r=U/3,pr=J+1;for(let f=0;f<_r;f++){let A=Math.floor(f/L),V=f%L,F=A%E,q=V%E,_=Math.floor(A/E)*pr+Math.floor(V/E);V===C&&(_-=1,q=E),A===C&&(_-=pr,F=E);let mr=_+1,fr=_+pr,br=fr+1,or=e[_],ir=e[mr],P=e[fr],G=e[br];H(D,or)&&(or=0),H(D,ir)&&(ir=0),H(D,P)&&(P=0),H(D,G)&&(G=0);let I=or*(1-(yr=q/E))*(1-(sr=F/E))+ir*yr*(1-sr)+P*(1-yr)*sr+G*yr*sr,l=3*f;x.x=z[l]+I*b[l],x.y=z[l+1]+I*b[l+1],x.z=z[l+2]+I*b[l+2],Y(x,i,t),h[l]=x.x,h[l+1]=x.y,h[l+2]=x.z,j[l]=i.x,j[l+1]=i.y,j[l+2]=i.z,k[l]=t.x,k[l+1]=t.y,k[l+2]=t.z,x.x<Q&&(Q=x.x),x.x>W&&(W=x.x),x.y<T&&(T=x.y),x.y>$&&($=x.y),x.z<Z&&(Z=x.z),x.z>X&&(X=x.z)}d.set(h),p.set(j),m.set(k);for(let f=0;f<_r;f++)if(~~(f/L)!==C&&f%L!==C){let A=3*f,V=A+3,F=A+3*L,q=F+3,_=new y(h[A],h[A+1],h[A+2]),mr=new y(h[V],h[V+1],h[V+2]),fr=new y(h[F],h[F+1],h[F+2]),br=new y(h[q],h[q+1],h[q+2]),or=mr.sub(_).normalize(),ir=fr.sub(_).normalize(),P=br.sub(_).normalize(),G=ir.cross(P).normalize(),I=P.cross(or).normalize(),l=I.add(G).normalize();a[A]+=l.x,a[A+1]+=l.y,a[A+2]+=l.z,a[V]+=I.x,a[V+1]+=I.y,a[V+2]+=I.z,a[F]+=G.x,a[F+1]+=G.y,a[F+2]+=G.z,a[q]+=l.x,a[q+1]+=l.y,a[q+2]+=l.z}}self.postMessage({id:Hr,normalMapNormals:a,normalMapVertices:d,normalMapVerticesHigh:p,normalMapVerticesLow:m,terrainVertices:h,terrainVerticesHigh:j,terrainVerticesLow:k,noDataVertices:lr,bounds:[Q,T,Z,W,$,X]},[a.buffer,d.buffer,p.buffer,m.buffer,h.buffer,j.buffer,k.buffer,lr.buffer])}})();
//# sourceMappingURL=TerrainWorker.worker-DmikdfB2.js.map
`,uo=typeof self<"u"&&self.Blob&&new Blob([Ma],{type:"text/javascript;charset=utf-8"});function ec(h){let t;try{if(t=uo&&(self.URL||self.webkitURL).createObjectURL(uo),!t)throw"";const s=new Worker(t,{name:h==null?void 0:h.name});return s.addEventListener("error",()=>{(self.URL||self.webkitURL).revokeObjectURL(t)}),s}catch{return new Worker("data:text/javascript;charset=utf-8,"+encodeURIComponent(Ma),{name:h==null?void 0:h.name})}finally{t&&(self.URL||self.webkitURL).revokeObjectURL(t)}}class ic extends en{constructor(t=2){super(t,ec)}_onMessage(t){this._source.get(t.data.id).segment._terrainWorkerCallback(t.data),this._source.delete(t.data.id),t.data.normalMapNormals=null,t.data.normalMapVertices=null,t.data.normalMapVerticesHigh=null,t.data.normalMapVerticesLow=null,t.data.terrainVertices=null,t.data.terrainVerticesHigh=null,t.data.terrainVerticesLow=null}make(t){if(t.segment.plainReady&&t.segment.terrainIsLoading)if(this._workerQueue.length){const s=this._workerQueue.pop();this._source.set(this._sourceId,t);let n=t.segment;s.postMessage({elevations:t.elevations,this_plainVertices:n.plainVertices,this_plainNormals:n.plainNormals,this_normalMapVertices:n.normalMapVertices,this_normalMapNormals:n.normalMapNormals,heightFactor:n.planet._heightFactor,gridSize:n.planet.terrain.gridSizeByZoom[n.tileZoom],noDataValues:n.planet.terrain.noDataValues,id:this._sourceId},[t.elevations.buffer,n.plainVertices.buffer,n.plainNormals.buffer,n.normalMapVertices.buffer,n.normalMapNormals.buffer]),this._sourceId++}else this._pendingQueue.push(t);else this.check()}}let Ne=new Float32Array(2);class sc{constructor(t,s=256,n=256){this._width=s,this._height=n,this._planet=t,this._framebuffer=null,this._queue=[],this._handler=null}init(){this._handler=this._planet.renderer.handler,this._handler.programs.vectorTileLineRasterization||this._handler.addProgram(new X("vectorTileLineRasterization",{uniforms:{viewport:"vec2",thicknessOutline:"float",alpha:"float",extentParamsHigh:"vec4",extentParamsLow:"vec4"},attributes:{prevHigh:"vec2",currentHigh:"vec2",nextHigh:"vec2",prevLow:"vec2",currentLow:"vec2",nextLow:"vec2",order:"float",color:"vec4",thickness:"float"},vertexShader:`attribute vec2 prevHigh;
                attribute vec2 currentHigh;
                attribute vec2 nextHigh;

                attribute vec2 prevLow;
                attribute vec2 currentLow;
                attribute vec2 nextLow;

                attribute float order;
                attribute float thickness;
                attribute vec4 color;
                uniform float thicknessOutline;
                uniform vec2 viewport;
                uniform vec4 extentParamsHigh;
                uniform vec4 extentParamsLow;
                varying vec4 vColor;
                
                vec2 proj(vec2 coordHigh, vec2 coordLow) {
                    vec2 highDiff = coordHigh - extentParamsHigh.xy;
                    vec2 lowDiff = coordLow - extentParamsLow.xy;                    
                    return vec2(-1.0 + (highDiff * step(1.0, length(highDiff)) + lowDiff) * extentParamsHigh.zw) * vec2(1.0, -1.0);
                }
                
                void main(){
                    vColor = color;

                    vec2 vNext = proj(nextHigh, nextLow),
                         vCurrent = proj(currentHigh, currentLow),
                         vPrev = proj(prevHigh, prevLow);

                    vec2 _next = vNext;
                    vec2 _prev = vPrev;
                    vec2 _current = vCurrent;

                    if(_prev == _current){
                        if(_next == _current){
                            _next = _current + vec2(1.0, 0.0);
                            _prev = _current - _next;
                        }else{
                            _prev = _current + normalize(_current - _next);
                        }
                    }

                    if(_next == _current){
                        _next = _current + normalize(_current - _prev);
                    }

                    vec2 sNext = _next;
                    vec2 sCurrent = _current;
                    vec2 sPrev = _prev;
                    
                    vec2 dirNext = normalize(sNext - sCurrent);
                    vec2 dirPrev = normalize(sPrev - sCurrent);
                    float dotNP = dot(dirNext, dirPrev);
                    
                    vec2 normalNext = normalize(vec2(-dirNext.y, dirNext.x));
                    vec2 normalPrev = normalize(vec2(dirPrev.y, -dirPrev.x));
                    vec2 d = (thickness + thicknessOutline) * 0.5 * sign(order) / viewport;
                    
                    vec2 m;
                    if(dotNP >= 0.99991){
                        m = sCurrent - normalPrev * d;
                    }else{
                        vec2 dir = normalPrev + normalNext;
                        m = sCurrent + dir * d / (dirNext.x * dir.y - dirNext.y * dir.x);
                        
                        if( dotNP > 0.5 && dot(dirNext + dirPrev, m - sCurrent) < 0.0 ){
                            float occw = order * sign(dirNext.x * dirPrev.y - dirNext.y * dirPrev.x);
                            if(occw == -1.0){
                                m = sCurrent + normalPrev * d;
                            }else if(occw == 1.0){
                                m = sCurrent + normalNext * d;
                            }else if(occw == -2.0){
                                m = sCurrent + normalNext * d;
                            }else if(occw == 2.0){
                                m = sCurrent + normalPrev * d;
                            }
                        }else if(distance(sCurrent, m) > min(distance(sCurrent, sNext), distance(sCurrent, sPrev))){
                            m = sCurrent + normalNext * d;
                        }
                    }
                    gl_Position = vec4(m.x, m.y, 0.0, 1.0);
                }`,fragmentShader:`precision highp float;
                uniform float alpha;
                varying vec4 vColor;
                void main() {
                    gl_FragColor = vec4(vColor.rgb, alpha * vColor.a);
                }`})),this._handler.programs.vectorTilePolygonRasterization||this._handler.addProgram(new X("vectorTilePolygonRasterization",{uniforms:{extentParamsHigh:"vec4",extentParamsLow:"vec4"},attributes:{coordinatesHigh:"vec2",coordinatesLow:"vec2",colors:"vec4"},vertexShader:`attribute vec2 coordinatesHigh;
                attribute vec2 coordinatesLow; 
                attribute vec4 colors; 
                uniform vec4 extentParamsHigh; 
                uniform vec4 extentParamsLow; 
                varying vec4 color;

                vec2 proj(vec2 coordHigh, vec2 coordLow) {
                    vec2 highDiff = coordHigh - extentParamsHigh.xy;
                    vec2 lowDiff = coordLow - extentParamsLow.xy;
                    return vec2(-1.0 + (highDiff * step(1.0, length(highDiff)) + lowDiff) * extentParamsHigh.zw) * vec2(1.0, -1.0);
                }

                void main() { 
                    color = colors;
                    gl_Position = vec4(proj(coordinatesHigh, coordinatesLow), 0.0, 1.0); 
                }`,fragmentShader:`precision highp float;
                varying vec4 color;
                void main () {  
                    gl_FragColor = color; 
                }`})),this._framebuffer=new Rt(this._handler,{width:this._width,height:this._height,useDepth:!1}),this._framebuffer.init()}frame(){if(this._planet.layerLock.isFree()&&this._queue.length){let t=this._handler,s=t.gl;s.disable(s.CULL_FACE),s.disable(s.DEPTH_TEST);let n=t.programs.vectorTileLineRasterization,o=t.programs.vectorTilePolygonRasterization,a=this._width,l=this._height,c=a,d=l,u=c<<1,_=d<<1,f=new Float32Array(4),g=new Float32Array(4),m=this._framebuffer.activate(),p=0,x=window.performance.now();for(;this._queue.length&&p<25;){let y=this._queue.shift();if(y.isLoading&&y.segment.node.getState()===1){let w=y.layer._pickingEnabled;y.segment.tileZoom<4?(c=u,d=_):(c=a,d=l);let C=y._updateTexture||t.createEmptyTexture_l(c,d),T=w?y._updatePickingMask||t.createEmptyTexture_n(c,d):null;y.applyTexture(C,T),m.setSize(c,d),m.bindOutputTexture(C),s.clearColor(0,0,0,0),s.clear(s.COLOR_BUFFER_BIT);let P=y.segment.getExtentMerc();ae(P.southWest.lon,Ne),f[0]=Ne[0],g[0]=Ne[1],ae(P.southWest.lat,Ne),f[1]=Ne[0],g[1]=Ne[1],f[2]=2/P.getWidth(),f[3]=2/P.getHeight(),o.activate();let E=o._program,S=E.attributes,M=E.uniforms,R=y.layer._geometryHandler;s.uniform4fv(M.extentParamsHigh,f),s.uniform4fv(M.extentParamsLow,g),s.bindBuffer(s.ARRAY_BUFFER,R._polyVerticesHighBufferMerc),s.vertexAttribPointer(S.coordinatesHigh,R._polyVerticesHighBufferMerc.itemSize,s.FLOAT,!1,0,0),s.bindBuffer(s.ARRAY_BUFFER,R._polyVerticesLowBufferMerc),s.vertexAttribPointer(S.coordinatesLow,R._polyVerticesLowBufferMerc.itemSize,s.FLOAT,!1,0,0),s.bindBuffer(s.ARRAY_BUFFER,R._polyColorsBuffer),s.vertexAttribPointer(S.colors,R._polyColorsBuffer.itemSize,s.FLOAT,!1,0,0),s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,R._polyIndexesBuffer),s.drawElements(s.TRIANGLES,R._polyIndexesBuffer.numItems,s.UNSIGNED_INT,0),w&&(m.bindOutputTexture(T),s.clearColor(0,0,0,0),s.clear(s.COLOR_BUFFER_BIT),s.bindBuffer(s.ARRAY_BUFFER,R._polyPickingColorsBuffer),s.vertexAttribPointer(S.colors,R._polyPickingColorsBuffer.itemSize,s.FLOAT,!1,0,0),s.drawElements(s.TRIANGLES,R._polyIndexesBuffer.numItems,s.UNSIGNED_INT,0)),m.bindOutputTexture(C),n.activate(),E=n._program,S=E.attributes,M=E.uniforms,s.uniform2fv(M.viewport,[c,d]),s.uniform4fv(M.extentParamsHigh,f),s.uniform4fv(M.extentParamsLow,g);let k=R._lineVerticesHighBufferMerc;s.bindBuffer(s.ARRAY_BUFFER,k),s.vertexAttribPointer(S.prevHigh,k.itemSize,s.FLOAT,!1,8,0),s.vertexAttribPointer(S.currentHigh,k.itemSize,s.FLOAT,!1,8,32),s.vertexAttribPointer(S.nextHigh,k.itemSize,s.FLOAT,!1,8,64),k=R._lineVerticesLowBufferMerc,s.bindBuffer(s.ARRAY_BUFFER,k),s.vertexAttribPointer(S.prevLow,k.itemSize,s.FLOAT,!1,8,0),s.vertexAttribPointer(S.currentLow,k.itemSize,s.FLOAT,!1,8,32),s.vertexAttribPointer(S.nextLow,k.itemSize,s.FLOAT,!1,8,64),s.bindBuffer(s.ARRAY_BUFFER,R._lineOrdersBuffer),s.vertexAttribPointer(S.order,R._lineOrdersBuffer.itemSize,s.FLOAT,!1,4,0),s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,R._lineIndexesBuffer),s.bindBuffer(s.ARRAY_BUFFER,R._lineStrokesBuffer),s.vertexAttribPointer(S.thickness,R._lineStrokesBuffer.itemSize,s.FLOAT,!1,0,0),s.bindBuffer(s.ARRAY_BUFFER,R._lineStrokeColorsBuffer),s.vertexAttribPointer(S.color,R._lineStrokeColorsBuffer.itemSize,s.FLOAT,!1,0,0),s.uniform1f(M.thicknessOutline,2),s.uniform1f(M.alpha,.54),s.drawElements(s.TRIANGLE_STRIP,R._lineIndexesBuffer.numItems,s.UNSIGNED_INT,0),s.uniform1f(M.thicknessOutline,1),s.uniform1f(M.alpha,1),s.drawElements(s.TRIANGLE_STRIP,R._lineIndexesBuffer.numItems,s.UNSIGNED_INT,0),s.bindBuffer(s.ARRAY_BUFFER,R._lineThicknessBuffer),s.vertexAttribPointer(S.thickness,R._lineThicknessBuffer.itemSize,s.FLOAT,!1,0,0),s.bindBuffer(s.ARRAY_BUFFER,R._lineColorsBuffer),s.vertexAttribPointer(S.color,R._lineColorsBuffer.itemSize,s.FLOAT,!1,0,0),s.uniform1f(M.thicknessOutline,2),s.uniform1f(M.alpha,.54),s.drawElements(s.TRIANGLE_STRIP,R._lineIndexesBuffer.numItems,s.UNSIGNED_INT,0),s.uniform1f(M.thicknessOutline,1),s.uniform1f(M.alpha,1),s.drawElements(s.TRIANGLE_STRIP,R._lineIndexesBuffer.numItems,s.UNSIGNED_INT,0),w&&(m.bindOutputTexture(T),s.uniform1f(M.thicknessOutline,8),s.bindBuffer(s.ARRAY_BUFFER,R._linePickingColorsBuffer),s.vertexAttribPointer(S.color,R._linePickingColorsBuffer.itemSize,s.FLOAT,!1,0,0),s.drawElements(s.TRIANGLE_STRIP,R._lineIndexesBuffer.numItems,s.UNSIGNED_INT,0))}else y.isLoading=!1;p=window.performance.now()-x}s.enable(s.DEPTH_TEST),s.enable(s.CULL_FACE),m.deactivate()}}add(t){this._queue.push(t)}remove(t){}get queueSize(){return this._queue.length}}class Ri extends de{constructor(t={}){super(t.name),this._minDistanceBeforeMemClear=0,this._renderingFadingNodes=(c,d,u,_,f,g,m,p)=>{let x=g===0,y=this.terrain.equalizeVertices;for(let w=0,C=_._fadingNodes.length;w<C;w++){let T=_._fadingNodes[w].segment;c._fadingNodes.has(_._fadingNodes[0].__id)&&!d.has(T.node.__id)&&(d.set(T.node.__id,!0),T._transitionOpacity<1?m.push(T):x?(y&&T.equalize(),T.readyToEngage&&T.engage(),T.screenRendering(u,f,g),p.push(T)):T.screenRendering(u,f,g,this.transparentTexture,!0))}},this._renderingFadingNodesNoDepth=(c,d,u,_,f,g,m)=>{let p=g===0,x=this.terrain.equalizeVertices,y=u.gl;y.disable(y.DEPTH_TEST);for(let w=0,C=_._fadingNodes.length;w<C;w++){let T=_._fadingNodes[w].segment;c._fadingNodes.has(_._fadingNodes[0].__id)&&!d.has(T.node.__id)&&(d.set(T.node.__id,!0),p?(x&&T.equalize(),T.readyToEngage&&T.engage(),T.screenRendering(u,f,g),m.push(T)):T.screenRendering(u,f,g,this.transparentTexture,!0))}y.enable(y.DEPTH_TEST)},this._createdNodesCount=0,this.transitionTime=580,this.ellipsoid=t.ellipsoid||So,this._atmosphere=new Uh(t.atmosphereParameters),this.lightEnabled=!0,this._planetRadius2=(this.ellipsoid.getPolarSize()-1e4)*(this.ellipsoid.getPolarSize()-1e4),this._layers=[],this._updateLayers=!1,this.visibleTileLayers=[],this.visibleVectorLayers=[],this._visibleVectorLayersByDepthOrder=[],this._visibleTileLayerSlices=[],this._visibleEntityCollections=[[]],this.baseLayer=null,this.terrain=null,this.camera=new wa(this,{frustums:t.frustums,eye:new v(25e6,0,0),look:v.ZERO,up:v.NORTH,minAltitude:t.minAltitude,maxAltitude:t.maxAltitude}),this.mousePositionOnEarth=new v,this.emptyTexture=null,this.transparentTexture=null,this.defaultTexture=null,this._initialViewExtent=null,this.layerLock=new zr,this.terrainLock=new zr,this._heightFactor=1,this._indexesCache=[],this._indexesCacheToRemove=[],this._indexesCacheToRemoveCounter=0,this._textureCoordsBufferCache=[];const s={planet:this,maxEqualZoomAltitude:t.maxEqualZoomAltitude,minEqualZoomAltitude:t.minEqualZoomAltitude,minEqualZoomCameraSlope:t.minEqualZoomCameraSlope,transitionOpacityEnabled:t.transitionOpacityEnabled};this.quadTreeStrategyPrototype=t.quadTreeStrategyPrototype||La,this.quadTreeStrategy=new this.quadTreeStrategyPrototype(s),this._nightTexture=null,this._specularTexture=null;let n=jt(t.ambient,new v(.2,.2,.3)),o=jt(t.diffuse,new v(1,1,1)),a=jt(t.specular,new v(63e-5,55e-5,32e-5)),l=t.shininess||18;this._ambient=new Float32Array([n.x,n.y,n.z]),this._diffuse=new Float32Array([o.x,o.y,o.z]),this._specular=new Float32Array([a.x,a.y,a.z,l]),this._maxGridSize=Math.log2(t.maxGridSize||256),this.SLICE_SIZE=4,this.SLICE_SIZE_4=4*this.SLICE_SIZE,this.SLICE_SIZE_3=3*this.SLICE_SIZE,this._maxNodes=t.maxNodesCount||200,this._pickingColorArr=new Float32Array(this.SLICE_SIZE_4),this._samplerArr=new Int32Array(this.SLICE_SIZE),this._pickingMaskArr=new Int32Array(this.SLICE_SIZE),this._geoImageCreator=new Zh(this),this._vectorTileCreator=new sc(this,t.vectorTileSize,t.vectorTileSize),this._normalMapCreator=new Qh(this),this._terrainWorker=new ic(3),this._plainSegmentWorker=new tc(3),this._tileLoader=new Sa(t.maxLoadingRequests||12),this._memKey=new Me,this.events=lt(rc),this._distBeforeMemClear=0,this._prevCamEye=new v,this._initialized=!1,this._collectRenderNodesIsActive=!0,this.nightTextureCoefficient=2,this._renderScreenNodesPASS=this._renderScreenNodesPASSNoAtmos,this._renderScreenNodesWithHeightPASS=this._renderScreenNodesWithHeightPASSNoAtmos,this._atmosphereEnabled=t.atmosphereEnabled||!1,this._atmosphereMaxMinOpacity=new Float32Array([.95,.28]),this.solidTextureOne=null,this.solidTextureTwo=null,this._nightTextureSrc=t.nightTextureSrc||null,this._specularTextureSrc=t.specularTextureSrc||null,this._transparentBackground=t.transparentBackground||!1}get terrainReady(){return this.quadTreeStrategy.terrainReady}get maxGridSize(){return this._maxGridSize}getNorthFrameRotation(t){return this.getFrameRotation(t)}getFrameRotation(t){return this.ellipsoid.getNorthFrameRotation(t)}set atmosphereMaxOpacity(t){this._atmosphereMaxMinOpacity[0]=t}get atmosphereMaxOpacity(){return this._atmosphereMaxMinOpacity[0]}set atmosphereMinOpacity(t){this._atmosphereMaxMinOpacity[1]=t}get atmosphereMinOpacity(){return this._atmosphereMaxMinOpacity[1]}set atmosphereEnabled(t){t!=this._atmosphereEnabled&&(this._atmosphereEnabled=t,this._initializeAtmosphere())}get atmosphereEnabled(){return this._atmosphereEnabled}set diffuse(t){let s=jt(t);this._diffuse=new Float32Array(s.toArray())}set ambient(t){let s=jt(t);this._ambient=new Float32Array(s.toArray())}set specular(t){let s=jt(t);this._specular=new Float32Array([s.x,s.y,s.y,this._specular[3]])}set shininess(t){this._specular[3]=t}get normalMapCreator(){return this._normalMapCreator}get layers(){return[...this._layers]}get sun(){if(this.renderer&&this.renderer.controls.sun)return this.renderer.controls.sun}get sunPos(){return this.sun.sunlight.getPosition()}addControl(t){t.planet=this,t.addTo(this.renderer)}addControls(t){for(let s=0;s<t.length;s++)this.addControl(t[s])}getLayerByName(t){for(let s=0,n=this._layers.length;s<n;s++)if(t===this._layers[s].name)return this._layers[s]}addLayer(t){t.addTo(this)}_onLayerVisibilityChanged(t){this.events.dispatch(this.events.layervisibilitychange,t)}addLayers(t){for(let s=0,n=t.length;s<n;s++)this.addLayer(t[s])}removeLayer(t){t.remove()}_clearLayerMaterial(t){this.quadTreeStrategy.clearLayerMaterial(t)}setBaseLayer(t){this.baseLayer?this.baseLayer.isEqual(t)||(this.baseLayer.setVisibility(!1),this.baseLayer=t,t.setVisibility(!0),this.events.dispatch(this.events.baselayerchange,t)):(this.baseLayer=t,this.baseLayer.setVisibility(!0),this.events.dispatch(this.events.baselayerchange,t))}setHeightFactor(t){this._heightFactor!==t&&(this._heightFactor=t,this.quadTreeStrategy.destroyBranches(),this.quadTreeStrategy.clearRenderedNodes())}getHeightFactor(){return this._heightFactor}setTerrain(t){this._initialized&&this.memClear(),this.terrain&&(this.terrain.abortLoading(),this.terrain.clearCache(),this.terrain._planet=null),this.terrain=t,this.terrain._planet=this,this.quadTreeStrategy.destroyBranches(),t._geoid.model?(this._plainSegmentWorker.setGeoid(t.getGeoid()),t._isReady=!0):Pa.loadModel(t.geoid.src).then(s=>{t.geoid.setModel(s),this._plainSegmentWorker.setGeoid(t.getGeoid()),t._isReady=!0}).catch(s=>{console.warn(s)})}initAtmosphereShader(t){if(this.renderer&&this.renderer.handler&&this._atmosphereEnabled){let s=this.renderer.handler;s.isWebGl2()?(s.removeProgram("drawnode_screen_wl"),s.addProgram(lo(t))):console.warn("Atmosphere WebGL2 only")}}get atmosphereControl(){return this._atmosphere}_initializeAtmosphere(){if(!this.renderer)return;let t=this.renderer.handler;t.removeProgram("drawnode_screen_wl"),this._atmosphereEnabled?(this._renderScreenNodesPASS=this._renderScreenNodesPASSAtmos,this._renderScreenNodesWithHeightPASS=this._renderScreenNodesWithHeightPASSAtmos,this.renderer.controls.Atmosphere||this.addControl(this._atmosphere),this._atmosphere.activate(),t.isWebGl2()?t.addProgram(lo(this._atmosphere.parameters)):t.addProgram(ao()),this._transparentBackground||this.renderer.controls.SimpleSkyBackground&&this.renderer.controls.SimpleSkyBackground.deactivate()):(this._renderScreenNodesPASS=this._renderScreenNodesPASSNoAtmos,this._renderScreenNodesWithHeightPASS=this._renderScreenNodesWithHeightPASSNoAtmos,this._atmosphere.deactivate(),this._transparentBackground||(this.renderer.controls.SimpleSkyBackground?this.renderer.controls.SimpleSkyBackground.activate():this.addControl(new ga)),t.isWebGl2()?t.addProgram(new X("drawnode_screen_wl",{uniforms:{projectionMatrix:"mat4",viewMatrix:"mat4",eyePositionHigh:"vec3",eyePositionLow:"vec3",height:"float",uGlobalTextureCoord:"vec4",uNormalMapBias:"vec3",samplerCount:"int",tileOffsetArr:"vec4",layerOpacityArr:"float",samplerArr:"sampler2darray",defaultTexture:"sampler2d",uNormalMap:"sampler2d",nightTexture:"sampler2d",specularTexture:"sampler2d",lightPosition:"vec3",diffuse:"vec3",ambient:"vec3",specular:"vec4",camHeight:"float",nightTextureCoefficient:"float",transitionOpacity:"float"},attributes:{aVertexPositionHigh:"vec3",aVertexPositionLow:"vec3",aTextureCoord:"vec2"},vertexShader:`#version 300 es
precision highp float;in vec3 aVertexPositionHigh;in vec3 aVertexPositionLow;in vec2 aTextureCoord;uniform mat4 projectionMatrix;uniform mat4 viewMatrix;uniform vec4 uGlobalTextureCoord;uniform vec3 uNormalMapBias;uniform vec3 eyePositionHigh;uniform vec3 eyePositionLow;uniform float height;out vec4 vTextureCoord;out vec3 v_vertex;out vec3 cameraPosition;out vec2 vGlobalTextureCoord;out float v_height;void main(void){vec3 aVertexPosition=aVertexPositionHigh+aVertexPositionLow;vec3 nh=height*normalize(aVertexPosition);vTextureCoord.xy=aTextureCoord;vGlobalTextureCoord=uGlobalTextureCoord.xy+(uGlobalTextureCoord.zw-uGlobalTextureCoord.xy)*aTextureCoord;vTextureCoord.zw=uNormalMapBias.z*(aTextureCoord+uNormalMapBias.xy);cameraPosition=eyePositionHigh+eyePositionLow;vec3 highDiff=aVertexPositionHigh-eyePositionHigh;vec3 lowDiff=aVertexPositionLow-eyePositionLow+nh;mat4 viewMatrixRTE=viewMatrix;viewMatrixRTE[3]=vec4(0.0,0.0,0.0,1.0);v_height=height;v_vertex=aVertexPosition+nh;gl_Position=projectionMatrix*viewMatrixRTE*vec4(highDiff*step(1.0,length(highDiff))+lowDiff,1.0);}`,fragmentShader:`#version 300 es
precision highp float;float getLerpValue(in float min,in float max,in float between){return(clamp(between,min,max)-min)/(max-min);}vec3 aces(vec3 color){float a=2.51;float b=0.03;float c=2.43;float d=0.59;float e=0.14;return clamp((color*(a*color+b))/(color*(c*color+d)+e),0.0,1.0);}bool intersectSphere(vec3 rayOrigin,vec3 rayDirection,float radius,inout float t1,inout float t2){float b=dot(rayDirection,rayOrigin);float c=dot(rayOrigin,rayOrigin)-radius*radius;float d=b*b-c;if(d<-1e-6){return false;}d=max(d,0.0);t1=-b-sqrt(d);t2=-b+sqrt(d);if(t2<0.0){return false;}return true;}bool intersectSphere(vec3 rayOrigin,vec3 rayDirection,float radius,inout float t){float b=dot(rayDirection,rayOrigin);float c=dot(rayOrigin,rayOrigin)-radius*radius;float d=b*b-c;if(d<0.0){return false;}t=-b-sqrt(d);return true;}float intersectSphere(vec3 ro,vec3 rd,vec4 sph){vec3 oc=ro-sph.xyz;float b=dot(oc,rd);float c=dot(oc,oc)-sph.w*sph.w;float h=b*b-c;if(h<0.0)return-1.0;h=sqrt(h);return-b-h;}bool intersectEllipsoid(in vec3 ro,in vec3 rd,in vec3 ra,inout float t){vec3 ocn=ro/ra;vec3 rdn=rd/ra;float a=dot(rdn,rdn);float b=dot(ocn,rdn);float c=dot(ocn,ocn);float h=b*b-a*(c-1.0);if(h<0.0){return false;}t=(-b-sqrt(h))/a;return true;}bool intersectEllipsoid(in vec3 ro,in vec3 rd,in vec3 ra,inout float t1,inout float t2){vec3 ocn=ro/ra;vec3 rdn=rd/ra;float a=dot(rdn,rdn);float b=dot(ocn,rdn);float c=dot(ocn,ocn);float h=b*b-a*(c-1.0);if(h<0.0){return false;}h=sqrt(h);t1=(-b-h)/a;t2=(-b+h)/a;return true;}vec3 normalEllipsoid(in vec3 pos,in vec3 ra){return normalize(pos/(ra*ra));}
#ifdef WEBGL2
#define TEXTURE_FUNC texture
#else
#define TEXTURE_FUNC texture2D
#endif
#define SLICE_SIZE 5
#define blend(DEST, SAMPLER, OFFSET, OPACITY) src = TEXTURE_FUNC(SAMPLER, OFFSET.xy + vTextureCoord.xy * OFFSET.zw); DEST = DEST * (1.0 - src.a * OPACITY) + src * OPACITY;
#define blendPicking(DEST, OFFSET, SAMPLER, MASK, COLOR, OPACITY) tc = OFFSET.xy + vTextureCoord.xy * OFFSET.zw; t = TEXTURE_FUNC(SAMPLER, tc); p = TEXTURE_FUNC(MASK, tc); DEST = mix(DEST, vec4(max(COLOR.rgb, p.rgb), OPACITY), (t.a == 0.0 ? 0.0: 1.0) * COLOR.a);
const vec3 nightStep=10.0*vec3(0.58,0.48,0.25);uniform vec4 specular;uniform vec3 diffuse;uniform vec3 ambient;uniform sampler2D uNormalMap;uniform sampler2D nightTexture;uniform sampler2D specularTexture;uniform sampler2D defaultTexture;uniform sampler2D samplerArr[SLICE_SIZE];uniform vec4 tileOffsetArr[SLICE_SIZE];uniform vec3 lightPosition;uniform float layerOpacityArr[SLICE_SIZE];uniform int samplerCount;uniform float nightTextureCoefficient;uniform float transitionOpacity;uniform float camHeight;in vec4 vTextureCoord;in vec3 v_vertex;in vec3 cameraPosition;in vec2 vGlobalTextureCoord;in float v_height;vec3 sunPos;layout(location=0)out vec4 diffuseColor;void main(void){sunPos=lightPosition;vec3 texNormal=texture(uNormalMap,vTextureCoord.zw).rgb;vec3 normal=normalize((texNormal-0.5)*2.0);float minH=1200000.0;float maxH=minH*3.0;float nightCoef=getLerpValue(minH,maxH,camHeight)*nightTextureCoefficient;vec3 lightDir=normalize(sunPos);vec3 viewDir=normalize(cameraPosition-v_vertex);float overGround=1.0-step(0.1,v_height);float shininess=texture(specularTexture,vGlobalTextureCoord.st).r*255.0*overGround;vec3 reflectionDirection=reflect(-lightDir,normal);float reflection=max(dot(reflectionDirection,viewDir),0.0);vec3 spec=specular.rgb*pow(reflection,specular.w)*shininess;float diffuseLightWeighting=max(dot(normal,lightDir),0.0);vec4 nightImageColor=texture(nightTexture,vGlobalTextureCoord.st);vec3 night=nightStep*(.18-diffuseLightWeighting*3.0)*nightImageColor.rgb*nightCoef;night*=overGround*step(0.0,night);vec4 lightWeighting=vec4(ambient+diffuse*diffuseLightWeighting+night,1.0);diffuseColor=texture(defaultTexture,vTextureCoord.xy);if(samplerCount==0){diffuseColor=diffuseColor*lightWeighting+vec4(spec,0.0);diffuseColor*=transitionOpacity;return;}vec4 src;blend(diffuseColor,samplerArr[0],tileOffsetArr[0],layerOpacityArr[0]);if(samplerCount==1){diffuseColor=diffuseColor*lightWeighting+vec4(spec,0.0);diffuseColor*=transitionOpacity;return;}blend(diffuseColor,samplerArr[1],tileOffsetArr[1],layerOpacityArr[1]);if(samplerCount==2){diffuseColor=diffuseColor*lightWeighting+vec4(spec,0.0);diffuseColor*=transitionOpacity;return;}blend(diffuseColor,samplerArr[2],tileOffsetArr[2],layerOpacityArr[2]);if(samplerCount==3){diffuseColor=diffuseColor*lightWeighting+vec4(spec,0.0);diffuseColor*=transitionOpacity;return;}blend(diffuseColor,samplerArr[3],tileOffsetArr[3],layerOpacityArr[3]);if(samplerCount==4){diffuseColor=diffuseColor*lightWeighting+vec4(spec,0.0);diffuseColor*=transitionOpacity;return;}blend(diffuseColor,samplerArr[4],tileOffsetArr[4],layerOpacityArr[4]);diffuseColor=diffuseColor*lightWeighting+vec4(spec,0.0);diffuseColor*=transitionOpacity;}`})):t.addProgram(ao()))}_initializeShaders(){if(!this.renderer)throw new Error("Renderer is not initialized");let t=this.renderer,s=t.handler;s.addProgram(new X("drawnode_screen_nl",{uniforms:{projectionMatrix:"mat4",viewMatrix:"mat4",eyePositionHigh:"vec3",eyePositionLow:"vec3",samplerCount:"int",tileOffsetArr:"vec4",layerOpacityArr:"float",samplerArr:"sampler2darray",defaultTexture:"sampler2d",height:"float"},attributes:{aVertexPositionHigh:"vec3",aVertexPositionLow:"vec3",aTextureCoord:"vec2"},vertexShader:"precision highp float;attribute vec3 aVertexPositionHigh;attribute vec3 aVertexPositionLow;attribute vec2 aTextureCoord;uniform mat4 projectionMatrix;uniform mat4 viewMatrix;uniform vec3 eyePositionHigh;uniform vec3 eyePositionLow;uniform float height;varying vec2 vTextureCoord;void main(void){vTextureCoord=aTextureCoord;vec3 nh=height*normalize(aVertexPositionHigh+aVertexPositionLow);mat4 viewMatrixRTE=viewMatrix;viewMatrixRTE[3]=vec4(0.0,0.0,0.0,1.0);mat4 m=projectionMatrix*viewMatrixRTE;vec3 highDiff=aVertexPositionHigh-eyePositionHigh;vec3 lowDiff=aVertexPositionLow-eyePositionLow+nh;gl_Position=m*vec4(highDiff*step(1.0,length(highDiff))+lowDiff,1.0);}",fragmentShader:`precision highp float;
#ifdef WEBGL2
#define TEXTURE_FUNC texture
#else
#define TEXTURE_FUNC texture2D
#endif
#define SLICE_SIZE 5
#define blend(DEST, SAMPLER, OFFSET, OPACITY) src = TEXTURE_FUNC(SAMPLER, OFFSET.xy + vTextureCoord.xy * OFFSET.zw); DEST = DEST * (1.0 - src.a * OPACITY) + src * OPACITY;
#define blendPicking(DEST, OFFSET, SAMPLER, MASK, COLOR, OPACITY) tc = OFFSET.xy + vTextureCoord.xy * OFFSET.zw; t = TEXTURE_FUNC(SAMPLER, tc); p = TEXTURE_FUNC(MASK, tc); DEST = mix(DEST, vec4(max(COLOR.rgb, p.rgb), OPACITY), (t.a == 0.0 ? 0.0: 1.0) * COLOR.a);
const vec3 nightStep=10.0*vec3(0.58,0.48,0.25);uniform vec4 tileOffsetArr[SLICE_SIZE];uniform float layerOpacityArr[SLICE_SIZE];uniform sampler2D defaultTexture;uniform sampler2D samplerArr[SLICE_SIZE];uniform int samplerCount;varying vec2 vTextureCoord;void main(void){gl_FragColor=texture2D(defaultTexture,vTextureCoord);if(samplerCount==0)return;vec4 src;blend(gl_FragColor,samplerArr[0],tileOffsetArr[0],layerOpacityArr[0]);if(samplerCount==1)return;blend(gl_FragColor,samplerArr[1],tileOffsetArr[1],layerOpacityArr[1]);if(samplerCount==2)return;blend(gl_FragColor,samplerArr[2],tileOffsetArr[2],layerOpacityArr[2]);if(samplerCount==3)return;blend(gl_FragColor,samplerArr[3],tileOffsetArr[3],layerOpacityArr[3]);if(samplerCount==4)return;blend(gl_FragColor,samplerArr[4],tileOffsetArr[4],layerOpacityArr[4]);}`})),s.addProgram(new X("drawnode_colorPicking",{uniforms:{projectionMatrix:"mat4",viewMatrix:"mat4",eyePositionHigh:"vec3",eyePositionLow:"vec3",samplerCount:"int",tileOffsetArr:"vec4",samplerArr:"sampler2darray",pickingMaskArr:"sampler2darray",pickingColorArr:"vec4",height:"float"},attributes:{aVertexPositionHigh:"vec3",aVertexPositionLow:"vec3",aTextureCoord:"vec2"},vertexShader:"precision highp float;attribute vec3 aVertexPositionHigh;attribute vec3 aVertexPositionLow;attribute vec2 aTextureCoord;uniform mat4 projectionMatrix;uniform mat4 viewMatrix;uniform vec3 eyePositionHigh;uniform vec3 eyePositionLow;uniform float height;varying vec2 vTextureCoord;void main(void){vTextureCoord=aTextureCoord;mat4 viewMatrixRTE=viewMatrix;viewMatrixRTE[3]=vec4(0.0,0.0,0.0,1.0);mat4 m=projectionMatrix*viewMatrixRTE;vec3 nh=height*normalize(aVertexPositionHigh+aVertexPositionLow);vec3 highDiff=aVertexPositionHigh-eyePositionHigh;vec3 lowDiff=aVertexPositionLow-eyePositionLow+nh;gl_Position=m*vec4(highDiff*step(1.0,length(highDiff))+lowDiff,1.0);}",fragmentShader:`precision highp float;
#ifdef WEBGL2
#define TEXTURE_FUNC texture
#else
#define TEXTURE_FUNC texture2D
#endif
#define SLICE_SIZE 5
#define blend(DEST, SAMPLER, OFFSET, OPACITY) src = TEXTURE_FUNC(SAMPLER, OFFSET.xy + vTextureCoord.xy * OFFSET.zw); DEST = DEST * (1.0 - src.a * OPACITY) + src * OPACITY;
#define blendPicking(DEST, OFFSET, SAMPLER, MASK, COLOR, OPACITY) tc = OFFSET.xy + vTextureCoord.xy * OFFSET.zw; t = TEXTURE_FUNC(SAMPLER, tc); p = TEXTURE_FUNC(MASK, tc); DEST = mix(DEST, vec4(max(COLOR.rgb, p.rgb), OPACITY), (t.a == 0.0 ? 0.0: 1.0) * COLOR.a);
const vec3 nightStep=10.0*vec3(0.58,0.48,0.25);uniform vec4 tileOffsetArr[SLICE_SIZE];uniform vec4 pickingColorArr[SLICE_SIZE];uniform sampler2D samplerArr[SLICE_SIZE];uniform sampler2D pickingMaskArr[SLICE_SIZE];uniform int samplerCount;varying vec2 vTextureCoord;void main(void){gl_FragColor=vec4(0.0);if(samplerCount==0)return;vec2 tc;vec4 t;vec4 p;blendPicking(gl_FragColor,tileOffsetArr[0],samplerArr[0],pickingMaskArr[0],pickingColorArr[0],1.0);if(samplerCount==1)return;blendPicking(gl_FragColor,tileOffsetArr[1],samplerArr[1],pickingMaskArr[1],pickingColorArr[1],1.0);if(samplerCount==2)return;blendPicking(gl_FragColor,tileOffsetArr[2],samplerArr[2],pickingMaskArr[2],pickingColorArr[2],1.0);if(samplerCount==3)return;blendPicking(gl_FragColor,tileOffsetArr[3],samplerArr[3],pickingMaskArr[3],pickingColorArr[3],1.0);if(samplerCount==4)return;blendPicking(gl_FragColor,tileOffsetArr[4],samplerArr[4],pickingMaskArr[4],pickingColorArr[4],1.0);}`})),s.addProgram(new X("drawnode_depth",{uniforms:{projectionMatrix:"mat4",viewMatrix:"mat4",height:"float",eyePositionHigh:"vec3",eyePositionLow:"vec3",frustumPickingColor:"float"},attributes:{aVertexPositionHigh:"vec3",aVertexPositionLow:"vec3"},vertexShader:`#version 300 es
precision highp float;in vec3 aVertexPositionHigh;in vec3 aVertexPositionLow;uniform mat4 projectionMatrix;uniform mat4 viewMatrix;uniform vec3 eyePositionHigh;uniform vec3 eyePositionLow;uniform float height;void main(void){mat4 viewMatrixRTE=viewMatrix;viewMatrixRTE[3]=vec4(0.0,0.0,0.0,1.0);mat4 m=projectionMatrix*viewMatrixRTE;vec3 nh=height*normalize(aVertexPositionHigh+aVertexPositionLow);vec3 eyePosition=eyePositionHigh+eyePositionLow;vec3 vertexPosition=aVertexPositionHigh+aVertexPositionLow;vec3 highDiff=aVertexPositionHigh-eyePositionHigh;vec3 lowDiff=aVertexPositionLow-eyePositionLow+nh;gl_Position=m*vec4(highDiff*step(1.0,length(highDiff))+lowDiff,1.0);}`,fragmentShader:`#version 300 es
precision highp float;uniform float frustumPickingColor;layout(location=0)out vec4 frustumColor;layout(location=1)out vec4 depthColor;void main(void){frustumColor=vec4(frustumPickingColor,frustumPickingColor,frustumPickingColor,1.0);depthColor=vec4(gl_FragCoord.z,gl_FragCoord.z,gl_FragCoord.z,1.0);}`})),t.addPickingCallback(this,this._renderColorPickingFramebufferPASS),t.addDepthCallback(this,()=>{this.renderDepthFramebuffer(this.camera,this.quadTreeStrategy)})}_onLayerLoadend(t){this.events.dispatch(this.events.layerloadend,t)}init(){this._tileLoader.events.on("layerloadend",this._onLayerLoadend,this),$i().setMaxGridSize(this._maxGridSize);const t=this._maxGridSize;let s=0;for(let o=0;o<=t;o++){!this._indexesCache[o]&&(this._indexesCache[o]=new Array(t));for(let a=0;a<=t;a++){!this._indexesCache[o][a]&&(this._indexesCache[o][a]=new Array(t));for(let l=0;l<=t;l++){!this._indexesCache[o][a][l]&&(this._indexesCache[o][a][l]=new Array(t));for(let c=0;c<=t;c++){!this._indexesCache[o][a][l][c]&&(this._indexesCache[o][a][l][c]=new Array(t));for(let d=0;d<=t;d++){let u={buffer:null};if(o>=1&&o===a&&o===l&&o===c&&o===d){let _=$i().createSegmentIndexes(o,[a,l,c,d]);u.buffer=this.renderer.handler.createElementArrayBuffer(_,1)}else this._indexesCacheToRemove[s++]=u;this._indexesCache[o][a][l][c][d]=u}}}}}this.renderer.events.on("drawtransparent",()=>{this._renderScreenNodesWithHeightPASS()}),this._textureCoordsBufferCache=[];let n=$i().initTextureCoordsTable(t+1);for(let o=0;o<=t;o++)this._textureCoordsBufferCache[o]=this.renderer.handler.createArrayBuffer(n[o],2,(1+(1<<o))*(1+(1<<o)));if(this.renderer.handler.createDefaultTexture(null,o=>{this.solidTextureOne=o,this.solidTextureTwo=o}),this.transparentTexture=this.renderer.handler.transparentTexture,this.drawMode=this.renderer.handler.gl.TRIANGLE_STRIP,this._initializeShaders(),this._initializeAtmosphere(),this._updateVisibleLayers(),this._nightTextureSrc){let o=new Image;o.crossOrigin="Anonymous",o.onload=()=>{this._nightTexture=this.renderer.handler.createTextureDefault(o),this._nightTexture.default=!0},o.src=this._nightTextureSrc}if(this._specularTextureSrc){let o=new Image;o.crossOrigin="Anonymous",o.onload=()=>{this._specularTexture=this.renderer.handler.createTextureDefault(o),this._specularTexture.default=!0},o.src=this._specularTextureSrc}this._geoImageCreator.init(),this._vectorTileCreator.init(),this._normalMapCreator.init(),this.renderer.events.on("draw",this._globalPreDraw,this,-100),this.quadTreeStrategy.init(this.camera),this.initLayers(),this._initialized=!0,this._initialViewExtent&&this.viewExtent(this._initialViewExtent),this.renderer.activeCamera=this.camera,this.camera.bindFrustumsPickingColors(this.renderer),this.camera.update()}initLayers(){let t=[...this._layers];for(let s=0;s<t.length;s++)this.removeLayer(t[s]),this.addLayer(t[s])}_clearIndexesCache(){this._indexesCacheToRemoveCounter=0;let t=this._indexesCacheToRemove,s=this.renderer.handler.gl;for(let n=0,o=t.length;n<o;n++){let a=t[n];s.deleteBuffer(a.buffer),a.buffer=null}}createDefaultTextures(t,s){this.renderer.handler.gl.deleteTexture(this.solidTextureOne),this.renderer.handler.gl.deleteTexture(this.solidTextureTwo),this.renderer.handler.createDefaultTexture(t,n=>{this.solidTextureOne=n}),this.renderer.handler.createDefaultTexture(s,n=>{this.solidTextureTwo=n})}_getLayerAttributionHTML(t){return`<div class="og-attribution__layer">${t.getAttribution()}</div>`}updateAttributionsList(){let t="";for(let s=0,n=this._layers.length;s<n;s++){let o=this._layers[s];o.getVisibility()&&o.getAttribution().length&&(t+=this._getLayerAttributionHTML(o))}this._applyAttribution(t)}updateVisibleLayers(){this._updateLayers=!0}_updateVisibleLayers(){this.visibleTileLayers=[],this.visibleTileLayers.length=0,this.visibleVectorLayers=[],this.visibleVectorLayers.length=0;let t="";for(let s=0,n=this._layers.length;s<n;s++){let o=this._layers[s];o.getVisibility()?(o.isBaseLayer()&&(this.createDefaultTextures(o._defaultTextures[0],o._defaultTextures[1]),this.baseLayer=o),o.hasImageryTiles()&&this.visibleTileLayers.push(o),o.isVector&&this.visibleVectorLayers.push(o),o.getAttribution().length&&(t+=this._getLayerAttributionHTML(o))):o._fading&&o._fadingOpacity>0&&(o.hasImageryTiles()&&this.visibleTileLayers.push(o),o.isVector&&this.visibleVectorLayers.push(o))}this._applyAttribution(t),this._sortLayers()}_applyAttribution(t){this.renderer&&this.renderer.div&&(t.length?this.renderer.div.attributions.innerHTML!==t&&(this.renderer.div.attributions.innerHTML=t):this.renderer.div.attributions.innerHTML="")}_sortLayers(){this.visibleVectorLayers.sort((s,n)=>s.getZIndex()-n.getZIndex()||s.getHeight()-n.getHeight());let t={0:[]};for(const s of this.visibleVectorLayers)t[s.depthOrder]||(t[s.depthOrder]=[]),t[s.depthOrder].push(s);if(this._visibleVectorLayersByDepthOrder.length=0,this._visibleVectorLayersByDepthOrder=[],this._visibleVectorLayersByDepthOrder=Object.keys(t).sort((s,n)=>Number(s)-Number(n)).map(s=>t[Number(s)]),this._visibleTileLayerSlices=[],this._visibleTileLayerSlices.length=0,this.visibleTileLayers.length){this.visibleTileLayers.sort((o,a)=>o.getHeight()-a.getHeight()||o.getZIndex()-a.getZIndex());let s=-1,n=this.visibleTileLayers[0].getHeight();for(let o=0,a=this.visibleTileLayers.length;o<a;o++)o%this.SLICE_SIZE!=0&&this.visibleTileLayers[o].getHeight()===n||(s++,this._visibleTileLayerSlices[s]=[],n=this.visibleTileLayers[o].getHeight()),this._visibleTileLayerSlices[s].push(this.visibleTileLayers[o])}}_renderScreenNodesPASSNoAtmos(){let t=this.camera,s=this._setUniformsNoAtmos(t);this._renderingScreenNodes(this.quadTreeStrategy,s,t,this.quadTreeStrategy._renderedNodesInFrustum[t.currentFrustumIndex])}_renderScreenNodesPASSAtmos(){let t=this.camera,s=this._setUniformsAtmos(t);this._renderingScreenNodes(this.quadTreeStrategy,s,t,this.quadTreeStrategy._renderedNodesInFrustum[t.currentFrustumIndex])}_renderScreenNodesWithHeightPASSNoAtmos(){let t=this.camera,s=this._setUniformsNoAtmos(t);this._renderingScreenNodesWithHeight(this.quadTreeStrategy,s,t,this.quadTreeStrategy._renderedNodesInFrustum[t.currentFrustumIndex])}_renderScreenNodesWithHeightPASSAtmos(){let t=this.camera,s=this._setUniformsAtmos(t);this._renderingScreenNodesWithHeight(this.quadTreeStrategy,s,t,this.quadTreeStrategy._renderedNodesInFrustum[t.currentFrustumIndex])}_globalPreDraw(){let t=this.camera;this._distBeforeMemClear+=this._prevCamEye.distance(t.eye),this._prevCamEye.copy(t.eye),this._createdNodesCount>this._maxNodes&&this._distBeforeMemClear>this._minDistanceBeforeMemClear&&(this.terrain.clearCache(),this.memClear()),this._indexesCacheToRemoveCounter>600&&this._clearIndexesCache()}preFrame(){this._updateLayers&&(this._updateLayers=!1,this._updateVisibleLayers()),this.camera.isFirstPass&&(this.camera.update(),this._collectRenderNodesIsActive&&this.quadTreeStrategy.collectRenderNodes(this.camera),this._normalMapCreator.frame(),this._geoImageCreator.frame(),this._vectorTileCreator.frame(),this.camera.checkTerrainCollision(),this.camera.update(),this.events.dispatch(this.events.draw,this),this._collectVectorLayerCollections());for(let t=0;t<this._visibleEntityCollections.length;t++)this.drawEntityCollections(this._visibleEntityCollections[t],t)}frame(){this._renderScreenNodesPASS()}lockQuadTree(){this._collectRenderNodesIsActive=!1,this.camera.setTerrainCollisionActivity(!1)}unlockQuadTree(){this._collectRenderNodesIsActive=!0,this.camera.setTerrainCollisionActivity(!0)}_setUniformsNoAtmos(t){let s,n,o=this.renderer,a=o.handler,l=a.gl;return l.enable(l.CULL_FACE),o.enableBlendOneSrcAlpha(),this.lightEnabled?(a.programs.drawnode_screen_wl.activate(),s=a.programs.drawnode_screen_wl._program,n=s.uniforms,l.uniform3fv(n.lightPosition,this._lightPosition),l.uniformMatrix4fv(n.viewMatrix,!1,t.getViewMatrix()),l.uniformMatrix4fv(n.projectionMatrix,!1,t.getProjectionMatrix()),this.baseLayer?(l.uniform3fv(n.diffuse,this.baseLayer._diffuse||this._diffuse),l.uniform3fv(n.ambient,this.baseLayer._ambient||this._ambient),l.uniform4fv(n.specular,this.baseLayer._specular||this._specular),l.uniform1f(n.nightTextureCoefficient,this.baseLayer.nightTextureCoefficient||this.nightTextureCoefficient)):(l.uniform3fv(n.diffuse,this._diffuse),l.uniform3fv(n.ambient,this._ambient),l.uniform4fv(n.specular,this._specular),l.uniform1f(n.nightTextureCoefficient,this.nightTextureCoefficient)),l.activeTexture(l.TEXTURE0+this.SLICE_SIZE),l.bindTexture(l.TEXTURE_2D,this._nightTexture||this.transparentTexture),l.uniform1i(n.nightTexture,this.SLICE_SIZE),l.activeTexture(l.TEXTURE0+this.SLICE_SIZE+1),l.bindTexture(l.TEXTURE_2D,this._specularTexture||this.transparentTexture),l.uniform1i(n.specularTexture,this.SLICE_SIZE+1),l.uniform1f(n.camHeight,t.getHeight())):(a.programs.drawnode_screen_nl.activate(),s=a.programs.drawnode_screen_nl._program,n=s.uniforms,l.uniformMatrix4fv(n.viewMatrix,!1,t.getViewMatrix()),l.uniformMatrix4fv(n.projectionMatrix,!1,t.getProjectionMatrix())),l.uniform3fv(n.eyePositionHigh,t.eyeHigh),l.uniform3fv(n.eyePositionLow,t.eyeLow),s}_setUniformsAtmos(t){let s,n,o=this.renderer,a=o.handler,l=a.gl;return l.enable(l.CULL_FACE),o.enableBlendOneSrcAlpha(),this.lightEnabled?(a.programs.drawnode_screen_wl.activate(),s=a.programs.drawnode_screen_wl._program,n=s.uniforms,l.uniform3fv(n.lightPosition,this._lightPosition),l.uniformMatrix4fv(n.viewMatrix,!1,t.getViewMatrix()),l.uniformMatrix4fv(n.projectionMatrix,!1,t.getProjectionMatrix()),this.baseLayer?(l.uniform3fv(n.diffuse,this.baseLayer._diffuse||this._diffuse),l.uniform3fv(n.ambient,this.baseLayer._ambient||this._ambient),l.uniform4fv(n.specular,this.baseLayer._specular||this._specular),l.uniform1f(n.nightTextureCoefficient,this.baseLayer.nightTextureCoefficient||this.nightTextureCoefficient)):(l.uniform3fv(n.diffuse,this._diffuse),l.uniform3fv(n.ambient,this._ambient),l.uniform4fv(n.specular,this._specular),l.uniform1f(n.nightTextureCoefficient,this.nightTextureCoefficient)),l.uniform2fv(n.maxMinOpacity,this._atmosphereMaxMinOpacity),l.activeTexture(l.TEXTURE0+this.SLICE_SIZE),l.bindTexture(l.TEXTURE_2D,this._nightTexture||this.transparentTexture),l.uniform1i(n.nightTexture,this.SLICE_SIZE),l.activeTexture(l.TEXTURE0+this.SLICE_SIZE+1),l.bindTexture(l.TEXTURE_2D,this._specularTexture||this.transparentTexture),l.uniform1i(n.specularTexture,this.SLICE_SIZE+1),l.activeTexture(l.TEXTURE0+this.SLICE_SIZE+4),l.bindTexture(l.TEXTURE_2D,o.controls.Atmosphere._transmittanceBuffer.textures[0]),l.uniform1i(n.transmittanceTexture,this.SLICE_SIZE+4),l.activeTexture(l.TEXTURE0+this.SLICE_SIZE+5),l.bindTexture(l.TEXTURE_2D,o.controls.Atmosphere._scatteringBuffer.textures[0]),l.uniform1i(n.scatteringTexture,this.SLICE_SIZE+5),l.uniform1f(n.camHeight,t.getHeight())):(a.programs.drawnode_screen_nl.activate(),s=a.programs.drawnode_screen_nl._program,n=s.uniforms,l.uniformMatrix4fv(n.viewMatrix,!1,t.getViewMatrix()),l.uniformMatrix4fv(n.projectionMatrix,!1,t.getProjectionMatrix())),l.uniform3fv(n.eyePositionHigh,t.eyeHigh),l.uniform3fv(n.eyePositionLow,t.eyeLow),s}static __refreshLayersFadingOpacity__(t,s,n){for(let o=t.length-1;o>=0;--o){let a=t[o];a._fading&&a._refreshFadingOpacity(s,n)&&t.splice(o,1)}}_renderingScreenNodes(t,s,n,o){let a=this._visibleTileLayerSlices;a.length&&n.isFirstPass&&Ri.__refreshLayersFadingOpacity__(a[0],t.minCurrZoom,t.maxCurrZoom);let l=new Map,c=[],d=this.terrain.equalizeVertices,u=o.length;if(t._fadingOpaqueSegments=[],n.slope>.8||!this.terrain||this.terrain.isEmpty)for(;u--;){let _=o[u],f=_.segment;this._renderingFadingNodesNoDepth(t,l,s,_,a[0],0,t._fadingOpaqueSegments),d&&f.equalize(),f.readyToEngage&&f.engage(),f.screenRendering(s,a[0],0)}else{for(;u--;){let _=o[u],f=_.segment;this._renderingFadingNodes(t,l,s,_,a[0],0,c,t._fadingOpaqueSegments),f._transitionOpacity<1?c.push(f):(d&&f.equalize(),f.readyToEngage&&f.engage(),f.screenRendering(s,a[0],0))}for(let _=0;_<c.length;_++){let f=c[_];d&&f.equalize(),f.readyToEngage&&f.engage(),f.screenRendering(s,a[0],0)}}}_renderingScreenNodesWithHeight(t,s,n,o){let a=this.renderer.handler.gl;a.enable(a.POLYGON_OFFSET_FILL),a.disable(a.CULL_FACE);let l=new Map,c=[],d=this._visibleTileLayerSlices;for(let u=1,_=d.length;u<_;u++){n.isFirstPass&&Ri.__refreshLayersFadingOpacity__(d[u],t.minCurrZoom,t.maxCurrZoom),a.polygonOffset(0,-u);let f=o.length;for(;f--;){let g=o[f];this._renderingFadingNodes(t,l,s,g,d[u],u,c),g.segment._transitionOpacity<1?g.segment.initSlice(u):g.segment.screenRendering(s,d[u],u,this.transparentTexture,!0)}}a.disable(a.POLYGON_OFFSET_FILL),a.enable(a.CULL_FACE)}_renderColorPickingFramebufferPASS(){let t,s=this.renderer,n=s.handler,o=n.gl;n.programs.drawnode_colorPicking.activate(),t=n.programs.drawnode_colorPicking._program;let a=t.uniforms,l=s.activeCamera;o.enable(o.CULL_FACE),o.uniformMatrix4fv(a.viewMatrix,!1,l.getViewMatrix()),o.uniformMatrix4fv(a.projectionMatrix,!1,l.getProjectionMatrix()),o.uniform3fv(a.eyePositionHigh,l.eyeHigh),o.uniform3fv(a.eyePositionLow,l.eyeLow);let c=this.quadTreeStrategy._renderedNodesInFrustum[l.getCurrentFrustum()],d=this._visibleTileLayerSlices,u=c.length;for(;u--;)c[u].segment._transitionOpacity>=1&&c[u].segment.colorPickingRendering(t,d[0],0);for(let _=0;_<this.quadTreeStrategy._fadingOpaqueSegments.length;++_)this.quadTreeStrategy._fadingOpaqueSegments[_].colorPickingRendering(t,d[0],0);o.enable(o.POLYGON_OFFSET_FILL);for(let _=1,f=d.length;_<f;_++)for(u=c.length,o.polygonOffset(0,-_);u--;)c[u].segment.colorPickingRendering(t,d[_],_,this.transparentTexture,!0);o.disable(o.POLYGON_OFFSET_FILL)}renderDepthFramebuffer(t,s){let n,o=this.renderer.handler,a=o.gl;o.programs.drawnode_depth.activate(),n=o.programs.drawnode_depth._program;let l=n.uniforms;a.disable(a.BLEND),a.disable(a.POLYGON_OFFSET_FILL),a.uniformMatrix4fv(l.viewMatrix,!1,t.getViewMatrix()),a.uniformMatrix4fv(l.projectionMatrix,!1,t.getProjectionMatrix()),a.uniform3fv(l.eyePositionHigh,t.eyeHigh),a.uniform3fv(l.eyePositionLow,t.eyeLow),a.uniform1f(l.frustumPickingColor,t.frustumColorIndex);let c=s._renderedNodesInFrustum[t.getCurrentFrustum()],d=this._visibleTileLayerSlices,u=c.length;for(;u--;)c[u].segment._transitionOpacity>=1&&c[u].segment.depthRendering(n,d[0]);for(let _=0;_<s._fadingOpaqueSegments.length;++_)s._fadingOpaqueSegments[_].depthRendering(n,d[0]);a.enable(a.BLEND)}_collectVectorLayerCollections(){let t=this._visibleVectorLayersByDepthOrder.length;this._visibleEntityCollections.length=0,this._visibleEntityCollections=new Array(t);for(let s=0;s<this._visibleEntityCollections.length;s++)this._visibleEntityCollections[s]=[];for(;t--;){let s=this._visibleVectorLayersByDepthOrder[t],n=s.length;for(;n--;){let o=s[n];o._fading&&o._refreshFadingOpacity(this.quadTreeStrategy.minCurrZoom,this.quadTreeStrategy.maxCurrZoom)&&(s.splice(n,1),s.length===0&&this._visibleVectorLayersByDepthOrder.splice(t,1)),o.collectVisibleCollections(this._visibleEntityCollections[t]),o.update()}}}memClear(){this._distBeforeMemClear=0,this.camera._insideSegment=null,this.layerLock.lock(this._memKey),this.terrainLock.lock(this._memKey),this._normalMapCreator.lock(this._memKey),this._normalMapCreator.clear(),this.terrain.abortLoading(),this._tileLoader.abortAll(),this.quadTreeStrategy.clear(),this.layerLock.free(this._memKey),this.terrainLock.free(this._memKey),this._normalMapCreator.free(this._memKey),this._createdNodesCount=0}getRayIntersectionEllipsoid(t){return this.ellipsoid.hitRay(t.origin,t.direction)}getCartesianFromPixelEllipsoid(t){let s=this.renderer.activeCamera;return this.ellipsoid.hitRay(s.eye,s.unproject(t.x,t.y))}getLonLatFromPixelEllipsoid(t){let s=this.getCartesianFromPixelEllipsoid(t);if(s)return this.ellipsoid.cartesianToLonLat(s)}getCartesianFromMouseTerrain(){let t=this.renderer.events.mouseState,s=this.getDistanceFromPixel(t);if(s)return t.direction.scaleTo(s).addA(this.renderer.activeCamera.eye)}getCartesianFromPixelTerrain(t){let s=this.getDistanceFromPixel(t);if(s)return(t.direction||this.renderer.activeCamera.unproject(t.x,t.y)).scaleTo(s).addA(this.renderer.activeCamera.eye)}getLonLatFromPixelTerrain(t){let s=this.getCartesianFromPixelTerrain(t);if(s)return this.ellipsoid.cartesianToLonLat(s)}getPixelFromCartesian(t){return this.renderer.activeCamera.project3v(t)}getPixelFromLonLat(t){let s=this.ellipsoid.lonLatToCartesian(t);if(s)return this.renderer.activeCamera.project3v(s)}getDistanceFromPixelEllipsoid(t){let s=this.getCartesianFromPixelEllipsoid(t);if(s)return s.distance(this.renderer.activeCamera.eye)}getDistanceFromPixel(t){return this.renderer.getDistanceFromPixel(t)||this.getDistanceFromPixelEllipsoid(t)||0}viewExtent(t){this.camera?this.camera.viewExtent(t):this._initialViewExtent=t}viewExtentArr(t){this.viewExtent(new U(new L(t[0],t[1]),new L(t[2],t[3])))}getExtent(){if(this.renderer){let t=this.renderer.handler.getWidth(),s=this.renderer.handler.getHeight(),n=[this.getLonLatFromPixelTerrain(new H(0,0)),this.getLonLatFromPixelTerrain(new H(t,0)),this.getLonLatFromPixelTerrain(new H(t,s)),this.getLonLatFromPixelTerrain(new H(0,s))];if(n[0]&&n[1]&&n[2]&&n[3]){let o=n[0].lon,a=n[2].lat,l=n[1].lon,c=n[0].lat;for(let d=0;d<n.length;d++)n[d].lon>l&&(l=n[d].lon),n[d].lat>c&&(c=n[d].lat),n[d].lon<o&&(o=n[d].lon),n[d].lat<a&&(a=n[d].lat);return new U(new L(o,a),new L(l,c))}}return this.quadTreeStrategy._viewExtent}getViewExtent(){return this.quadTreeStrategy._viewExtent}viewLonLat(t,s,n){this.camera.setLonLat(t,s,n)}flyExtent(t,s,n={}){this.camera.flyExtent(t,s,n)}flyCartesian(t,s){this.camera.flyCartesian(t,s)}flyLonLat(t,s={}){this.camera.flyLonLat(t,s)}stopFlying(){this.camera.stopFlying()}updateBillboardsTexCoords(){for(let s=0;s<this.entityCollections.length;s++)this.entityCollections[s].billboardHandler.refreshTexCoordsArr();let t={};for(let s=0;s<this._layers.length;s++){let n=this._layers[s];n instanceof _t&&n.each(function(o){o._entityCollection&&!t[o._entityCollection.id]&&(o._entityCollection.billboardHandler.refreshTexCoordsArr(),t[o._entityCollection.id]=!0)})}}getEntityTerrainPoint(t,s){let n=this.quadTreeStrategy._renderedNodes,o=n.length;for(;o--;)if(n[o].segment.isEntityInside(t))return n[o].segment.getEntityTerrainPoint(t,s)}async getHeightDefault(t){return new Promise(s=>{this.terrain?this.terrain.getHeightAsync(t.clone(),n=>{s(n)}):s(0)})}async getHeightAboveELL(t){return new Promise(s=>{this.terrain?this.terrain.getHeightAsync(t.clone(),n=>{s(n+this.terrain.geoid.getHeightLonLat(t))}):s(0)})}onremove(){this.memClear(),this.quadTreeStrategy.destroyBranches(),this.quadTreeStrategy.clearRenderedNodes()}destroy(){var t;this._terrainWorker.destroy(),this._plainSegmentWorker.destroy(),(t=this.renderer)==null||t.destroy(),this.onremove(),super.destroy()}}const rc=["draw","layeradd","baselayerchange","layerremove","layervisibilitychange","rendercompleted","terraincompleted","layerloadend"];class fn extends de{constructor(t){super("skybox"),this.params=t,this.vertexPositionBuffer=null,this.texture=null}static createDefault(t){return new fn({nx:t+"skybox/gal/_nx.jpg",px:t+"skybox/gal/_px.jpg",py:t+"skybox/gal/_py.jpg",ny:t+"skybox/gal/_ny.jpg",pz:t+"skybox/gal/_pz.jpg",nz:t+"skybox/gal/_nz.jpg"})}init(){this.renderer.handler.addProgram(new X("skybox",{uniforms:{projectionViewMatrix:{type:ht.MAT4},uSampler:{type:ht.SAMPLERCUBE},pos:{type:ht.VEC3}},attributes:{aVertexPosition:{type:ht.VEC3,enableArray:!0}},vertexShader:`attribute vec3 aVertexPosition;
            uniform mat4 projectionViewMatrix;
            uniform vec3 pos;
            varying vec3 vTextureCoord;
            void main(void) {
                vTextureCoord = aVertexPosition;
                gl_Position = projectionViewMatrix * vec4(aVertexPosition + pos, 1.0);
            }`,fragmentShader:`precision lowp float;
            varying vec3 vTextureCoord;
            uniform samplerCube uSampler;
            void main(void) {
                gl_FragColor = textureCube(uSampler, vTextureCoord);
            }`})),this.texture=this.renderer.handler.loadCubeMapTexture(this.params),this._createBuffers(),this.drawMode=this.renderer.handler.gl.TRIANGLES}preFrame(){let t=this.renderer.handler,s=t.gl,n=this.renderer.activeCamera;s.disable(s.DEPTH_TEST),t.programs.skybox.activate();let o=t.programs.skybox._program,a=o.uniforms;if(n.isOrthographic){const c=n.frustum.near,d=n.frustum.far,u=n.getAspectRatio(),_=c*Math.tan(n.viewAngle*Qt),f=_*u,g=new tt().setPerspective(-f,f,-_,_,c,d),m=new tt().set(n.getViewMatrix());s.uniformMatrix4fv(a.projectionViewMatrix,!1,g.mul(m)._m)}else s.uniformMatrix4fv(a.projectionViewMatrix,!1,n.getProjectionViewMatrix());s.uniform3fv(a.pos,n.eye.toArray()),s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_CUBE_MAP,this.texture),s.uniform1i(a.uSampler,0);let l=this.vertexPositionBuffer;s.bindBuffer(s.ARRAY_BUFFER,l),s.vertexAttribPointer(o.attributes.aVertexPosition,l.itemSize,s.FLOAT,!1,0,0),s.drawArrays(this.drawMode,0,l.numItems),s.enable(s.DEPTH_TEST)}_createBuffers(){const t=new Float32Array([-1e8,1e8,-1e8,-1e8,-1e8,-1e8,1e8,-1e8,-1e8,1e8,-1e8,-1e8,1e8,1e8,-1e8,-1e8,1e8,-1e8,-1e8,-1e8,1e8,-1e8,-1e8,-1e8,-1e8,1e8,-1e8,-1e8,1e8,-1e8,-1e8,1e8,1e8,-1e8,-1e8,1e8,1e8,-1e8,-1e8,1e8,-1e8,1e8,1e8,1e8,1e8,1e8,1e8,1e8,1e8,1e8,-1e8,1e8,-1e8,-1e8,-1e8,-1e8,1e8,-1e8,1e8,1e8,1e8,1e8,1e8,1e8,1e8,1e8,1e8,-1e8,1e8,-1e8,-1e8,1e8,-1e8,1e8,-1e8,1e8,1e8,-1e8,1e8,1e8,1e8,1e8,1e8,1e8,-1e8,1e8,1e8,-1e8,1e8,-1e8,-1e8,-1e8,-1e8,-1e8,-1e8,1e8,1e8,-1e8,-1e8,1e8,-1e8,-1e8,-1e8,-1e8,1e8,1e8,-1e8,1e8]);this.vertexPositionBuffer=this.renderer.handler.createArrayBuffer(t,3,t.length/3)}}Object.freeze(Object.defineProperty({__proto__:null,Axes:class extends de{constructor(h=100){super("Axes"),this.size=h,this.axesBuffer=null,this.axesColorBuffer=null}init(){this.createAxesBuffer(this.size),this.drawMode=this.renderer.handler.gl.LINES,this.renderer.handler.addProgram(new X("axesShader",{uniforms:{projectionViewMatrix:"mat4"},attributes:{aVertexPosition:"vec3",aVertexColor:"vec4"},vertexShader:`attribute vec3 aVertexPosition;
            attribute vec4 aVertexColor;
            uniform mat4 projectionViewMatrix;
            varying vec4 vColor;
            void main(void) {
                gl_Position = projectionViewMatrix * vec4(aVertexPosition, 1.0);
                vColor = aVertexColor;
            }`,fragmentShader:`precision highp float;
            varying vec4 vColor;
            void main(void) {
                gl_FragColor = vColor;
            }`}))}frame(){this.renderer.handler.programs.axesShader.activate().set({projectionViewMatrix:this.renderer.activeCamera.getProjectionViewMatrix(),aVertexPosition:this.axesBuffer,aVertexColor:this.axesColorBuffer}),this.renderer.handler.programs.axesShader.drawArrays(this.drawMode,this.axesBuffer.numItems)}createAxesBuffer(h){const t=[0,0,0,h-1,0,0,0,0,0,0,h-1,0,0,0,0,0,0,h-1];this.axesBuffer=this.renderer.handler.createArrayBuffer(new Float32Array(t),3,6),this.axesColorBuffer=this.renderer.handler.createArrayBuffer(new Float32Array([1,0,0,1,1,0,0,1,0,0,1,1,0,0,1,1,0,1,0,1,0,1,0,1]),4,6)}},Planet:Ri,RenderNode:de,SkyBox:fn},Symbol.toStringTag,{value:"Module"}));const Bs=class Ld{constructor(t={}){this.__id=Ld.__counter__++,this.equalizeVertices=t.equalizeVertices||!1,this.equalizeNormals=!1,this.isEmpty=!0,this.name=t.name||"empty",this.minZoom=t.minZoom||2,this.maxZoom=t.maxZoom||19,this.maxNativeZoom=t.maxNativeZoom||this.maxZoom,this.gridSizeByZoom=t.gridSizeByZoom||[64,32,16,8,4,4,4,4,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2],this._maxNodeZoom=this.gridSizeByZoom.length-1,this.plainGridSize=2,this.noDataValues=[],this._planet=null,this._geoid=t.geoid||new Pa({src:t.geoidSrc||null}),this._isReady=!1}setUrlRewriteCallback(t){}get isIdle(){return!0}isEqual(t){return t.__id===this.__id}static checkNoDataValue(t,s){return Xr(t,s)!==-1}isBlur(t){return!1}set maxNodeZoom(t){t>this.gridSizeByZoom.length-1&&(t=this.gridSizeByZoom.length-1),this._maxNodeZoom=t}get maxNodeZoom(){return this._maxNodeZoom}set geoid(t){this._geoid=t}get geoid(){return this._geoid}getGeoid(){return this._geoid}handleSegmentTerrain(t){t.terrainIsLoading=!1,t.terrainReady=!0,t.terrainExists=!0}isReady(){return this._isReady}abortLoading(){}clearCache(){}getHeightAsync(t,s){return s(0),!0}loadTerrain(t,s=!1){}};Bs.__counter__=0;let Mi=Bs;class gn extends Mi{constructor(t="",s={}){super({geoidSrc:"https://openglobus.org/geoid/egm84-30.pgm",maxNativeZoom:s.maxNativeZoom||14,...s}),this._s=s.subdomains||["a","b","c"],this.events=lt(nc,this),this._requestCount=0,this._requestsPeerSubdomain=4,this.isEmpty=!1,this.equalizeNormals=!0,this.name=t||"openglobus",this.url=s.url||"https://{s}.srtm3.openglobus.org/{z}/{y}/{x}.ddm",this.gridSizeByZoom=s.gridSizeByZoom||[64,32,32,16,16,8,8,8,16,16,16,32,32,32,32,16,8,4,2,2,2,2,2,2],this._heightFactor=s.heightFactor!=null?s.heightFactor:1,this.noDataValues=s.noDataValues||[];for(let n=0;n<this.noDataValues.length;n++)this.noDataValues[n]*=this._heightFactor;this.plainGridSize=s.plainGridSize||32,this._extent=$r(s.extent,new U(new L(-180,-90),new L(180,90))),this._dataType="arrayBuffer",this._maxNodeZoom=this.gridSizeByZoom.length-1,this._elevationCache={},this._fetchCache={},this._cache=s.cache||"default",this._loader=new Sa,this._urlRewriteCallback=s.urlRewrite||null}get loader(){return this._loader}clearCache(){for(let t in this._elevationCache)this._elevationCache[t].heights=null,this._elevationCache[t].extent=null,delete this._elevationCache[t];this._elevationCache=null,this._elevationCache={};for(let t in this._fetchCache)this._fetchCache[t]=null,delete this._fetchCache[t];this._fetchCache=null,this._fetchCache={}}isBlur(t){return t.tileZoom>=6}setElevationCache(t,s){this._elevationCache[t]=s}getElevationCache(t){return this._elevationCache[t]}getHeightAsync(t,s,n,o){if(!t||t.lat>ct||t.lat<Ot)return s(0),!0;o=o==null||o;const[a,l,c,d]=this._planet.quadTreeStrategy.getTileXY(t,n||this.maxZoom);let u=zt.getTileIndex(a,l,c,d),_=this.getElevationCache(u),f=Ji(t);if(_)return _.heights?s(this._getGroundHeightMerc(f,_)):s(0),!0;{let g=this._fetchCache[u];g||(g=this._loader.fetch({src:this._urlRewriteCallback&&this._urlRewriteCallback(a,l,c,d)||this.buildURL(a,l,c,d),type:this._dataType,options:{cache:this._cache}}),this._fetchCache[u]=g),g.then(m=>{let p=Ze(a,l,c);if(m.status==="ready"){let x={heights:this._createHeights(m.data,null,d,a,l,c,p),extent:p};this.setElevationCache(u,x),s(this._getGroundHeightMerc(f,x))}else if(m.status==="error"){if(o&&c>this.maxNativeZoom)return o=!1,void this.getHeightAsync(t,s,this.maxNativeZoom,!1);this.setElevationCache(u,{heights:null,extent:p}),s(0)}else this._fetchCache[u]=null,delete this._fetchCache[u]})}return!1}_getGroundHeightMerc(t,s){if(!s.extent||!s.heights)return 0;let n=s.extent.getWidth(),o=Math.sqrt(s.heights.length),a=n/(o-1),l=o-Math.ceil((t.lat-s.extent.southWest.lat)/a)-1,c=Math.floor((t.lon-s.extent.southWest.lon)/a),d=(l+1)*o+c,u=d+1,_=l*o+c,f=_+1,g=s.heights[d],m=s.heights[u],p=s.heights[_],x=s.heights[f],y=new v(s.extent.southWest.lon+a*c,g,s.extent.northEast.lat-a*l-a),w=new v(y.x+a,m,y.z),C=new v(y.x,p,y.z+a),T=new v(y.x+a,x,y.z+a),P=new v(t.lon,1e5,t.lat),E=new V(P,new v(0,-1,0)),S=new v,M=E.hitTriangleRes(y,w,C,S);return M===V.INSIDE?S.y:(M=E.hitTriangleRes(w,T,C,S),M===V.INSIDE?S.y:0)}abortLoading(){this._loader.abortAll()}setUrl(t){this.url=t}setName(t){this.name=t}isReadyToLoad(t){return t._tileGroup===0&&this._extent.overlaps(t.getExtentLonLat())}loadTerrain(t,s=!1){if(this._planet.terrainLock.isFree())if(t.terrainReady=!1,t.terrainIsLoading=!0,this.isReadyToLoad(t)){let n=this.getElevationCache(t.tileIndex);n?this._applyElevationsData(t,n.heights):this._loader.load({sender:this,src:this._getHTTPRequestString(t),segment:t,type:this._dataType,options:{cache:this._cache},filter:()=>t.plainReady&&t.node.getState()!==0||s},o=>{if(o.status==="ready"){let a=this._createHeights(o.data,t,t._tileGroup,t.tileX,t.tileY,t.tileZoom,t.getExtent(),t.tileZoom===this.maxZoom);this.setElevationCache(t.tileIndex,{heights:a,extent:t.getExtent()}),this._applyElevationsData(t,a)}else o.status==="abort"?t.terrainIsLoading=!1:o.status==="error"?this._applyElevationsData(t,null):t.terrainIsLoading=!1})}else t.elevationsNotExists();else t.terrainIsLoading=!1}_getSubdomain(){return this._requestCount++,this._s[Math.floor(this._requestCount%(this._requestsPeerSubdomain*this._s.length)/this._requestsPeerSubdomain)]}buildURL(t,s,n,o){return Dt(this.url,{s:this._getSubdomain(),x:t.toString(),y:s.toString(),z:n.toString()})}_createUrl(t){return this.buildURL(t.tileX,t.tileY,t.tileZoom,t._tileGroup)}_getHTTPRequestString(t){return this._urlRewriteCallback&&this._urlRewriteCallback(t.tileX,t.tileY,t.tileZoom,t._tileGroup)||this._createUrl(t)}setUrlRewriteCallback(t){this._urlRewriteCallback=t}_createHeights(t,s,n,o,a,l,c,d){if(this._heightFactor!==1){let u=new Float32Array(t);for(let _=0,f=u.length;_<f;_++)u[_]=u[_]*this._heightFactor;return u}return new Float32Array(t)}_applyElevationsData(t,s){if(t){let n=this.events.load;n.handlers.length&&this.events.dispatch(n,{elevations:s,segment:t}),t.applyTerrain(s)}}}const nc=["load","loadend"];class Ds extends zt{constructor(t,s={}){super(t,s),this.events=this.events.registerNames(oc),this.url=s.url||"",this._s=s.subdomains||["a","b","c"],this.minNativeZoom=s.minNativeZoom||0,this.maxNativeZoom=s.maxNativeZoom||19,this._urlRewriteCallback=s.urlRewrite||null,this._requestsPeerSubdomains=4,this._requestCount=0,this._cache=s.cache||"default"}get isIdle(){return super.isIdle&&this._planet._tileLoader.getRequestCounter(this)===0}get instanceName(){return"XYZ"}abortLoading(){this._planet&&this._planet._tileLoader.abort(this)}setVisibility(t){t!==this._visibility&&(super.setVisibility(t),t||this.abortLoading())}remove(){return this.abortLoading(),super.remove(),this}setUrl(t){this.url=t}_checkSegment(t){return t._projection.id===this._planet.quadTreeStrategy.projection.id}loadMaterial(t,s=!1){let n=t.segment;this._isBaseLayer?t.texture=n.getDefaultTexture():t.texture=n.planet.transparentTexture,(this._planet.layerLock.isFree()||t.segment.tileZoom<2)&&(t.isReady=!1,t.isLoading=!0,this._checkSegment(n)?(t.loadingAttempts++,this._planet._tileLoader.load({sender:this,src:this._getHTTPRequestString(t.segment),type:"imageBitmap",filter:()=>n.initialized&&n.node.getState()===1||s,options:{cache:this._cache}},o=>{if(o.status==="ready"){if(t.isLoading){let a=this.events.load;a.handlers.length&&this.events.dispatch(a,t),t.applyImage(o.data),o.data=null}}else o.status==="abort"?t.isLoading=!1:o.status==="error"&&t.isLoading&&t.textureNotExists()})):t.textureNotExists())}_createUrl(t){return Dt(this.url,{s:this._getSubdomain(),x:t.tileX.toString(),y:t.tileY.toString(),z:t.tileZoom.toString()})}_getSubdomain(){return this._requestCount++,this._s[Math.floor(this._requestCount%(this._requestsPeerSubdomains*this._s.length)/this._requestsPeerSubdomains)]}_getHTTPRequestString(t){return this._urlRewriteCallback?this._urlRewriteCallback(t,this.url):this._createUrl(t)}setUrlRewriteCallback(t){this._urlRewriteCallback=t}applyMaterial(t,s=!1){if(t.isReady)return t.texOffset;if(t.segment.tileZoom<this.minNativeZoom)t.textureNotExists();else{let n=t.segment,o=n.node,a=!1,l=this.__id,c=t;for(;o.parentNode;)if(o=o.parentNode,c=o.segment.materials[l],c&&c.textureExists){a=!0;break}if(n.passReady){let d=t.layer.maxNativeZoom;if(o.segment.tileZoom===d)t.textureNotExists();else if(t.segment.tileZoom<=d)!t.isLoading&&!t.isReady&&this.loadMaterial(t,s);else{let u=n.node;for(;u.segment.tileZoom>t.layer.maxNativeZoom;)u=u.parentNode;let _=u.segment.materials[t.layer.__id];_?!_.isLoading&&!_.isReady&&this.loadMaterial(_,!0):(_=u.segment.materials[t.layer.__id]=t.layer.createMaterial(u.segment),this.loadMaterial(_,!0))}}if(a){t.appliedNode=o,t.appliedNodeId=o.nodeId,t.texture=c.texture;let d=1/(2<<n.tileZoom-o.segment.tileZoom-1);t.texOffset[0]=n.tileX*d-o.segment.tileX,t.texOffset[1]=n.tileY*d-o.segment.tileY,t.texOffset[2]=d,t.texOffset[3]=d}else t.texture=n.planet.transparentTexture,t.texOffset[0]=0,t.texOffset[1]=0,t.texOffset[2]=1,t.texOffset[3]=1}return t.texOffset}clearMaterial(t){t.isReady&&t.textureExists&&(!t.texture.default&&t.segment.handler.gl.deleteTexture(t.texture),t.texture=null),t.isReady=!1,t.textureExists=!1,t.isLoading=!1}_correctFullExtent(){let t=this._extent,s=this._extentMerc;t.northEast.lat===90&&(s.northEast.lat=2008750834e-2),t.northEast.lon===180&&(s.northEast.lon=2008750834e-2),t.southWest.lat===-90&&(s.southWest.lat=-2008750834e-2),t.southWest.lon===-180&&(s.southWest.lon=-2008750834e-2)}}const oc=["load","loadend"];class me extends Ds{constructor(t,s){super(t,s),this._extra=new URLSearchParams(s.extra).toString(),s.extent||this.setExtent(new U(new L(-180,-90),new L(180,90))),this.layers=s.layers,this.imageWidth=s.imageWidth||256,this.imageHeight=s.imageHeight||256,this._getBbox=me.get_bbox_v1_1_1,this._version="",this.setVersion(s.version)}static createRequestUrl(t,s,n="image/png",o="1.1.1",a="GetMap",l,c,d=256,u=256,_){return`${t}?LAYERS=${s}&FORMAT=${n}&SERVICE=WMS&VERSION=${o}&REQUEST=${a}&SRS=${l}&BBOX=${c}&WIDTH=${d}&HEIGHT=${u}`+(_?`&${_}`:"")}static get_bbox_v1_1_1(t){return`${t.getWest()},${t.getSouth()},${t.getEast()},${t.getNorth()}`}static get_bbox_v1_3_0(t,s){return s==="epsg:4326"?`${t.getSouth()},${t.getWest()},${t.getNorth()},${t.getEast()}`:`${t.getWest()},${t.getSouth()},${t.getEast()},${t.getNorth()}`}_checkSegment(t){return!0}get instanceName(){return"WMS"}_createUrl(t){return me.createRequestUrl(this.url,this.layers,"image/png",this._version,"GetMap",t._projection.code,this._getBbox(t.getExtent(),t._projection.code),this.imageWidth,this.imageHeight,this._extra)}setVersion(t){this._version=t||"1.1.1",this._version==="1.1.1"?this._getBbox=me.get_bbox_v1_1_1:t==="1.3.0"&&(this._getBbox=me.get_bbox_v1_3_0)}_correctFullExtent(){const t=this._extent,s=this._extentMerc;t.northEast.lat===90&&(s.northEast.lat=2008750834e-2),t.northEast.lon===180&&(s.northEast.lon=2008750834e-2),t.southWest.lat===-90&&(s.southWest.lat=-2008750834e-2),t.southWest.lon===-180&&(s.southWest.lon=-2008750834e-2)}}class je extends gn{constructor(t={}){super("BilTerrain",t),this.equalizeVertices=!0,this.equalizeNormals=!0,this.minZoom=t.minZoom||2,this.maxZoom=t.maxZoom||14,this.noDataValues=t.noDataValues||[-9999,32767],this.url=t.url||"",this._format="application/bil16",this._layers=t.layers||"",this._imageSize=t.imageSize||256,this.plainGridSize=t.plainGridSize!=null?t.plainGridSize:Ki(this._imageSize)?this._imageSize/2:$e(this._imageSize)/2,this._dataType="arrayBuffer"}isBlur(t){return t.tileZoom>=18}_createUrl(t){return me.createRequestUrl(this.url,this._layers,this._format,"1.1.1","GetMap",t._projection.code,me.get_bbox_v1_1_1(t.getExtent()),this._imageSize,this._imageSize)}_createHeights(t,s,n,o,a,l,c,d){let u=new Int16Array(t);if(!Ki(this._imageSize)){let x=new Float32Array(u.length);return function(y,w){for(let C=0,T=w.length;C<T;C++)w[C]=y[C]}(u,x),x}let _=(this.plainGridSize+1)*(this.plainGridSize+1),f=new Array(4);for(let x=0;x<4;x++){f[x]=[];for(let y=0;y<4;y++)f[x][y]=new Float32Array(_)}let g=new Float32Array(_);(function(x,y,w,C){let T=Math.sqrt(w.length)-1,P=T+1,E=Math.sqrt(x.length),S=E/T,M=0,R=0;for(let k=0,B=0,z=x.length;k<z;k++){let O=x[k],ze=je.checkNoDataValue(y,O),D=!1,re=!1,Ee=Math.floor(k/E),I=k%E,N=Math.floor(I/T),rt=Math.floor(Ee/T),Zt=C[rt][N],Bt=Ee%T,ki=I%T,Wt=(Bt+rt)*P+ki+N;if(Zt[Wt]=O,(Ee+rt)%S==0&&(I+N)%S==0&&(w[B++]=O),(I+1)%T==0&&I!==E-1){M=x[k],D=je.checkNoDataValue(y,M);let wt=O;ze||D||(wt=.5*(O+M)),Wt=(Bt+rt)*P+ki+1,Zt[Wt]=wt,(Ee+rt)%S==0&&(w[B++]=wt);let Fs=(Bt+rt)*P+(ki+1)%T;C[rt][N+1][Fs]=wt}if((Ee+1)%T==0&&Ee!==E-1){R=x[k+E],re=je.checkNoDataValue(y,R);let wt=O;ze||re||(wt=.5*(O+R)),Wt=(Bt+1)*P+ki+N,Zt[Wt]=wt,(I+N)%S==0&&(w[B++]=wt);let Fs=(Bt+1)%T*P+ki+N;C[rt+1][N][Fs]=wt}if((I+1)%T==0&&I!==E-1&&(Ee+1)%T==0&&Ee!==E-1){let wt=x[k+E+1],Fs=je.checkNoDataValue(y,wt),qi=O;ze||D||re||Fs||(qi=.25*(O+M+R+wt)),Wt=(Bt+1)*P+(ki+1),Zt[Wt]=qi,w[B++]=qi;let $c=(Bt+1)*P;C[rt][N+1][$c]=qi;let Zc=T;C[rt+1][N][Zc]=qi;let Xc=0;C[rt+1][N+1][Xc]=qi}}})(u,this.noDataValues,g,f);let m=zt.getTileIndex(o,a,l,n);this.setElevationCache(m,{heights:g,extent:c});let p=this._imageSize/this.plainGridSize;for(let x=0;x<p;x++)for(let y=0;y<p;y++){let w=2*o+y,C=2*a+x,T=l+1,P=zt.getTileIndex(w,C,T,n);this.setElevationCache(P,{heights:f[x][y],extent:Ze(w,C,T)})}return g}}class St extends gn{constructor(t,s={}){super(t||"RgbTerrain",{equalizeVertices:s.equalizeVertices==null||s.equalizeVertices,maxZoom:s.maxZoom||17,noDataValues:s.noDataValues||[s.minHeight!=null?s.minHeight:-1e4],plainGridSize:s.plainGridSize||128,url:s.url!=null?s.url:`//api.mapbox.com/v4/mapbox.terrain-rgb/{z}/{x}/{y}.pngraw?access_token=${s.key||"<key>"}`,gridSizeByZoom:s.gridSizeByZoom||[64,32,16,8,8,8,16,16,16,32,32,32,32,32,32,64,64,64,32,32,16,8],...s}),this.equalizeNormals=s.equalizeNormals||!1,this._dataType="imageBitmap",this._imageSize=s.imageSize||256,this._ctx=this._createTemporalCanvas(this._imageSize),this._imageDataCache={},this._minHeight=s.minHeight||-1e4,this._resolution=s.resolution||.1}static checkNoDataValue(t,s){return s>5e4||Xr(t,s)!==-1}rgb2Height(t,s,n){return t===255?this._minHeight:this._minHeight+this._resolution*(256*t*256+256*s+n)}isBlur(t){return t.tileZoom>=16}_createTemporalCanvas(t){let s=document.createElement("canvas");return s.width=t,s.height=t,s.getContext("2d",{willReadFrequently:!0})}_createHeights(t,s,n,o,a,l,c,d){this._ctx.clearRect(0,0,this._imageSize,this._imageSize),this._ctx.drawImage(t,0,0);let u=this._ctx.getImageData(0,0,this._imageSize,this._imageSize).data;const _=t.width;let f=0,g=0,m=0,p=null,x=!1;if(s&&s.tileZoom>this.maxNativeZoom){let E=s.node;for(;E&&!E.segment.terrainExists;)E=E.parentNode;E&&(f=E.segment.tileX,g=E.segment.tileY,m=E.segment.tileZoom,p=E.segment.elevationData,x=m<=8)}if(!Ki(this._imageSize)&&_===this._imageSize){let E=new Float32Array(_*_);return this.extractElevationTilesRgbNonPowerOfTwo(u,E,this._heightFactor),E}if(this._imageSize===this.plainGridSize){let E=(this.plainGridSize+1)*(this.plainGridSize+1),S=new Float32Array(E),[M,R,k]=s?rr(s.tileX,s.tileY,s.tileZoom,f,g,m):[0,0,0];return this.extractElevationSimple(u,this.noDataValues,p,M,R,k,x,S,this._heightFactor,this._imageSize),S}let y=(this.plainGridSize+1)*(this.plainGridSize+1),w=_/this.plainGridSize,C=new Float32Array(y),T=new Array(w);for(let E=0;E<w;E++){T[E]=[];for(let S=0;S<w;S++)T[E][S]=new Float32Array(y)}if(d)this.extractElevationTilesRgbNoChildren(u,this._heightFactor,this.noDataValues,p,f,g,m,s?s.tileX:0,s?s.tileY:0,s?s.tileZoom:0,x,C);else{this.extractElevationTilesRgb(u,this._heightFactor,this.noDataValues,p,f,g,m,s?s.tileX:0,s?s.tileY:0,s?s.tileZoom:0,x,C,T);for(let E=0;E<w;E++)for(let S=0;S<w;S++){let[M,R,k]=[2*o+S,2*a+E,l+1],B=zt.getTileIndex(M,R,k,n);this.setElevationCache(B,{heights:T[E][S],extent:Ze(M,R,k)})}}let P=zt.getTileIndex(o,a,l,n);return this.setElevationCache(P,{heights:C,extent:c}),C}getHeightAsync(t,s,n){if((n=n??this.maxZoom)===0)return s(0),!0;const o=this._planet.quadTreeStrategy,[a,l,c,d]=o.getTileXY(t,n),[u,_]=o.getLonLatTileOffset(t,a,l,c,this._imageSize),f=4*(u*this._imageSize+_),g=zt.getTileIndex(a,l,c,d);if(this._imageDataCache[g]){let p=this._imageDataCache[g],x=this._heightFactor*this.rgb2Height(p[f],p[f+1],p[f+2]);return St.checkNoDataValue(this.noDataValues,x)?this.getHeightAsync(t,s,n-1):(s(this._heightFactor*this.rgb2Height(p[f],p[f+1],p[f+2])),!0)}let m=this._fetchCache[g];return m||(m=this._loader.fetch({src:this._urlRewriteCallback&&this._urlRewriteCallback(a,l,c,d)||this.buildURL(a,l,c,d),type:this._dataType,options:{cache:this._cache}}),this._fetchCache[g]=m),m.then(p=>{if(p.status==="ready"){this._ctx.clearRect(0,0,this._imageSize,this._imageSize),this._ctx.drawImage(p.data,0,0);let x=this._ctx.getImageData(0,0,256,256).data;this._imageDataCache[g]=x;let y=this._heightFactor*this.rgb2Height(x[f],x[f+1],x[f+2]);if(St.checkNoDataValue(this.noDataValues,y))return this.getHeightAsync(t,s,n-1);s(this._heightFactor*this.rgb2Height(x[f],x[f+1],x[f+2]))}else{if(p.status==="error")return this.getHeightAsync(t,s,n-1);this._fetchCache[g]=null,delete this._fetchCache[g]}}),!1}extractElevationSimple(t,s,n=null,o,a,l,c,d,u=1,_){for(let g=0,m=_*_;g<m;g++){let p=g%_,x=Math.floor(g/_),y=4*g,w=u*this.rgb2Height(t[y],t[y+1],t[y+2]);(St.checkNoDataValue(s,w)||w===0)&&n&&(w=Xt(l,o,a,n,x,p,c)),d[x*(_+1)+p]=w}for(let g=0,m=_;g<m;g++){let p=_-1,x=4*(g*_+p),y=u*this.rgb2Height(t[x],t[x+1],t[x+2]);(St.checkNoDataValue(s,y)||y===0)&&n&&(y=Xt(l,o,a,n,g,p,c)),d[g*(_+1)+_]=y}for(let g=0,m=_;g<m;g++){let p=_-1,x=4*(p*_+g),y=u*this.rgb2Height(t[x],t[x+1],t[x+2]);(St.checkNoDataValue(s,y)||y===0)&&n&&(y=Xt(l,o,a,n,p,g,c)),d[_*(_+1)+g]=y}let f=u*this.rgb2Height(t[t.length-4],t[t.length-3],t[t.length-2]);(St.checkNoDataValue(s,f)||f===0)&&n&&(f=Xt(l,o,a,n,_-1,_-1,c)),d[d.length-1]=f}extractElevationTilesRgbNonPowerOfTwo(t,s,n=1){for(let o=0,a=s.length;o<a;o++){let l=4*o;s[o]=n*this.rgb2Height(t[l],t[l+1],t[l+2])}}extractElevationTilesRgb(t,s,n,o=null,a,l,c,d,u,_,f,g,m){let p=Math.sqrt(g.length)-1,x=p+1,y=Math.sqrt(t.length/4),w=y/p,C=0,T=0,P=0,[E,S,M]=rr(d,u,_,a,l,c);for(let R=0,k=0,B=t.length/4;R<B;R++){let z=4*R,O=s*this.rgb2Height(t[z],t[z+1],t[z+2]),ze=St.checkNoDataValue(n,O),D=!1,re=!1,Ee=Math.floor(R/y),I=R%y;(ze||O===0)&&o&&(O=Xt(M,E,S,o,Math.floor(Ee/w),Math.floor(I/w),f));let N=Math.floor(I/p),rt=Math.floor(Ee/p),Zt=m[rt][N],Bt=Ee%p,ki=I%p,Wt=(Bt+rt)*x+ki+N;if(Zt[Wt]=O,(Ee+rt)%w==0&&(I+N)%w==0&&(g[k++]=O),(I+1)%p==0&&I!==y-1){C=s*this.rgb2Height(t[z+4],t[z+5],t[z+6]),D=St.checkNoDataValue(n,C),(D||C===0)&&o&&(C=Xt(M,E,S,o,Math.floor(Ee/w),Math.floor((I+1)/w),f));let wt=O;ze||D||(wt=.5*(O+C)),Wt=(Bt+rt)*x+ki+1,Zt[Wt]=wt,(Ee+rt)%w==0&&(g[k++]=wt);let Fs=(Bt+rt)*x+(ki+1)%p;m[rt][N+1][Fs]=wt}if((Ee+1)%p==0&&Ee!==y-1){P=4*y,T=s*this.rgb2Height(t[z+P],t[z+P+1],t[z+P+2]),re=St.checkNoDataValue(n,T),(re||T===0)&&o&&(T=Xt(M,E,S,o,Math.floor((Ee+1)/w),Math.floor(I/w),f));let wt=.5*(O+T);ze||re||(wt=.5*(O+T)),Wt=(Bt+1)*x+ki+N,Zt[Wt]=wt,(I+N)%w==0&&(g[k++]=wt);let Fs=(Bt+1)%p*x+ki+N;m[rt+1][N][Fs]=wt}if((I+1)%p==0&&I!==y-1&&(Ee+1)%p==0&&Ee!==y-1){let wt=s*this.rgb2Height(t[z+P+4],t[z+P+5],t[z+P+6]),Fs=St.checkNoDataValue(n,wt);(Fs||wt===0)&&o&&(wt=Xt(M,E,S,o,Math.floor((Ee+1)/w),Math.floor((I+1)/w),f));let qi=O;ze||D||re||Fs||(qi=.25*(O+C+T+wt)),Wt=(Bt+1)*x+(ki+1),Zt[Wt]=qi,g[k++]=qi;let $c=(Bt+1)*x;m[rt][N+1][$c]=qi;let Zc=p;m[rt+1][N][Zc]=qi;let Xc=0;m[rt+1][N+1][Xc]=qi}}}extractElevationTilesRgbNoChildren(t,s,n,o=null,a,l,c,d,u,_,f,g){let m=Math.sqrt(g.length)-1,p=m+1,x=Math.sqrt(t.length/4),y=x/m,w=0,C=0,T=0,[P,E,S]=rr(d,u,_,a,l,c);for(let M=0,R=0,k=t.length/4;M<k;M++){let B=4*M,z=s*this.rgb2Height(t[B],t[B+1],t[B+2]),O=St.checkNoDataValue(n,z),ze=!1,D=!1,re=Math.floor(M/x),Ee=M%x;(O||z===0)&&o&&(z=Xt(S,P,E,o,Math.floor(R/p),R%p,f));let I=Math.floor(Ee/m),N=Math.floor(re/m);if((re+N)%y==0&&(Ee+I)%y==0&&(g[R++]=z),(Ee+1)%m==0&&Ee!==x-1){w=s*this.rgb2Height(t[B+4],t[B+5],t[B+6]),ze=St.checkNoDataValue(n,w),(ze||w===0)&&o&&(w=Xt(S,P,E,o,Math.floor(R/p),R%p,f));let rt=z;O||ze||(rt=.5*(z+w)),(re+N)%y==0&&(g[R++]=rt)}if((re+1)%m==0&&re!==x-1){T=4*x,C=s*this.rgb2Height(t[B+T],t[B+T+1],t[B+T+2]),D=St.checkNoDataValue(n,C),(D||C===0)&&o&&(C=Xt(S,P,E,o,Math.floor(R/p),R%p,f));let rt=.5*(z+C);O||D||(rt=.5*(z+C)),(Ee+I)%y==0&&(g[R++]=rt)}if((Ee+1)%m==0&&Ee!==x-1&&(re+1)%m==0&&re!==x-1){let rt=s*this.rgb2Height(t[B+T+4],t[B+T+5],t[B+T+6]),Zt=St.checkNoDataValue(n,rt);(Zt||rt===0)&&o&&(rt=Xt(S,P,E,o,Math.floor(R/p),R%p,f));let Bt=z;O||ze||D||Zt||(Bt=.25*(z+w+C+rt)),g[R++]=Bt}}}}function rr(h,t,s,n,o,a){let l=2<<s-a-1;return[h-l*n,t-l*o,1/l]}function Xt(h,t,s,n,o,a,l){let c=Math.sqrt(n.length),d=n[Math.floor(s*h*c+o*h)*c+Math.floor(t*h*c+a*h)];return l&&d>0?0:d}const ac={[Le]:"north",[Pe]:"south"},lc=(h,t,s,n)=>{let o=ac[n];if(o)return`https://terrain.openglobus.org/poles/${o}/${s}/${h}/${t}.png`};class hc extends St{constructor(t,s){super(t||"GlobusEarthRgb",{maxNativeZoom:6,maxZoom:17,url:"https://{s}.terrain.openglobus.org/all/{z}/{x}/{y}.png",urlRewrite:lc,...s})}isReadyToLoad(t){return this._extent.overlaps(t.getExtentLonLat())}}Object.freeze(Object.defineProperty({__proto__:null,BilTerrain:je,EmptyTerrain:Mi,GlobusRgbTerrain:hc,GlobusTerrain:gn,RgbTerrain:St},Symbol.toStringTag,{value:"Module"}));class cc extends Ai{constructor(t,s={}){super(t,s),this._sourceTexture=s.texture||null,s.texture&&(this._sourceReady=!0,this._sourceCreated=!0),this._frameWidth=s.frameWidth!=null?$e(s.frameWidth):256,this._frameHeight=s.frameHeight!=null?$e(s.frameHeight):256,this._animate=!0}get instanceName(){return"GeoTexture2d"}loadMaterial(t){this._planet._geoImageCreator.add(this)}bindTexture(t){this._sourceReady=!0,this._sourceCreated=!0,this._sourceTexture=t}setSize(t,s){this._frameWidth=t,this._frameHeight=s,this._frameCreated=!1}abortMaterialLoading(t){this._creationProceeding=!1,t.isLoading=!1,t.isReady=!1}}class dc extends Ai{constructor(t,s={}){super(t,s),this._animate=!0,this._video=s.videoElement||null,this._src=s.src||null}get instanceName(){return"GeoVideo"}setSrc(t){this._planet&&this._planet._geoImageCreator.remove(this),this._src=t,this._sourceReady=!1}setVideoElement(t){this._planet&&this._planet._geoImageCreator.remove(this),this._video=t,this._src=t.src,this._sourceReady=!1}setVisibility(t){t!=this._visibility&&(super.setVisibility(t),this._planet&&(t?(this._sourceReady&&this._planet._geoImageCreator.add(this),this._video&&this._video.play()):(this._sourceReady&&this._planet._geoImageCreator.remove(this),this._video&&this._video.pause())))}_createSourceTexture(){let t=this._planet.renderer.handler.gl;this._sourceCreated?(t.bindTexture(t.TEXTURE_2D,this._sourceTexture),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,this._video)):(this._sourceTexture=this._planet.renderer.handler.createTexture_n_webgl1(this._video),this._sourceCreated=!0)}_onCanPlay(t){this._frameWidth=t.videoWidth,this._frameHeight=t.videoHeight,t.width=t.videoWidth,t.height=t.videoHeight,t.play(),this._sourceReady=!0,this._planet._geoImageCreator.add(this)}_onError(t){let s="unknown error";switch(t.error.code){case 1:s="video loading aborted";break;case 2:s="network loading error";break;case 3:s="video decoding failed / corrupted data or unsupported codec";break;case 4:s="video not supported"}console.warn(`Error: ${s} error-code=${t.error.code})`)}loadMaterial(t){if(t.isLoading=!0,this._creationProceeding=!0,!this._sourceReady&&this._src){if(this._video){if(this._video.readyState===this._video.HAVE_ENOUGH_DATA)this._onCanPlay(this._video);else if(this._video.src){let s=this;this._video.addEventListener("canplay",function(n){s._onCanPlay(this)})}}else{this._video=document.createElement("video"),this._video.crossOrigin="Anonymous";let s=this;this._video.addEventListener("canplay",function(){s._onCanPlay(this)}),this._video.addEventListener("error",function(){s._onError(this)})}this._video.autoplay=!0,this._video.loop=!0,this._video.src=this._src,this._video.muted=!0,this._video.setAttribute("playsinline","true"),this._video.setAttribute("webkit-playsinline","true")}else this._planet._geoImageCreator.add(this)}abortMaterialLoading(t){this._video&&(this._video.src=""),this._creationProceeding=!1,t.isLoading=!1,t.isReady=!1}}class uc extends _t{constructor(t,s={}){super(t,s),this._billboard=s.billboard||{src:"https://openglobus.org/examples/billboards/carrot.png"},this._color=s.color||"#6689db"}get instanceName(){return"KML"}_extractCoordonatesFromKml(t){return Array.from(t.getElementsByTagName("coordinates")).map(s=>s.textContent.trim()).map(s=>s.replace(/\n/g," ").replace(/\t/g," ").replace(/ +/g," ").split(" ").map(n=>n.split(",").map(parseFloat)))}_AGBRtoRGBA(t){if(!t||t.length!=8)return;const s=parseInt(t.slice(0,2),16)/255,n=parseInt(t.slice(2,4),16),o=parseInt(t.slice(4,6),16);return`rgba(${parseInt(t.slice(6,8),16)},${o},${n},${s})`}_parseKMLcoordinates(t){return t.innerHTML.trim().replace(/\n/g," ").replace(/\t/g," ").replace(/ +/g," ").split(" ").map(s=>s.split(",").map(parseFloat))}_kmlPlacemarkToEntity(t,s){if(!t)return;const n=Array.from(t.getElementsByTagName("name")),o=n&&n.length>0?n[0].innerHTML.trim():"",{iconHeading:a,iconURL:l,iconColor:c,lineWidth:d,lineColor:u}=this._extractStyle(t),_=[];for(const f of t.getElementsByTagName("coordinates")){const g=this._parseKMLcoordinates(f)||[[0,0,0]];for(const m of g){const[p,x,y]=m;_.push(new L(p,x,y)),p<s.southWest.lon&&(s.southWest.lon=p),x<s.southWest.lat&&(s.southWest.lat=x),p>s.northEast.lon&&(s.northEast.lon=p),x>s.northEast.lat&&(s.northEast.lat=x)}}if(_.length===1){const f=.01745329*a;return new G({name:o,lonlat:_[0],billboard:{src:l,size:[24,24],color:c,rotation:f},properties:{color:c,heading:a}})}return new G({name:o,polyline:{pathLonLat:[_],thickness:d,color:u,isClosed:!1},properties:{name:o}})}_extractStyle(t){let s,n,o,a,l;const c=t.getElementsByTagName("Style")[0];if(c){let d=c.getElementsByTagName("IconStyle")[0];if(d){let _=d.getElementsByTagName("color")[0];_&&(s=this._AGBRtoRGBA(_.innerHTML.trim()));let f=d.getElementsByTagName("heading")[0];if(f){const m=parseFloat(f.innerHTML.trim());m>=0&&m<=360&&(n=m%360)}let g=d.getElementsByTagName("Icon")[0];if(g){let m=g.getElementsByTagName("href")[0];m&&(o=m.innerHTML.trim())}}let u=c.getElementsByTagName("LineStyle")[0];if(u){let _=u.getElementsByTagName("color")[0];_&&(a=this._AGBRtoRGBA(_.innerHTML.trim()));let f=u.getElementsByTagName("width")[0];f!==void 0&&(l=parseFloat(f.innerHTML.trim()))}}return s||(s="#FFFFFF"),n||(n=0),o||(o="https://openglobus.org/examples/billboards/carrot.png"),a||(a="#FFFFFF"),l||(l=1),{iconHeading:n,iconURL:o,iconColor:s,lineWidth:l,lineColor:a}}_parseKML(t,s,n){if(n||(n=[]),t.documentElement.nodeName!=="kml")return n;for(const o of t.getElementsByTagName("Placemark")){const a=this._kmlPlacemarkToEntity(o,s);a&&n.push(a)}return n}_convertKMLintoEntities(t){const s=new U(new L(180,90),new L(-180,-90));return{entities:this._parseKML(t,s),extent:s}}_convertCoordonatesIntoEntities(t,s,n){const o=new U(new L(180,90),new L(-180,-90)),a=c=>{const d=c[0],u=c[1];d<o.southWest.lon&&(o.southWest.lon=d),u<o.southWest.lat&&(o.southWest.lat=u),d>o.northEast.lon&&(o.northEast.lon=d),u>o.northEast.lat&&(o.northEast.lat=u)},l=[];return t.forEach(c=>c.forEach(d=>l.push(d))),{entities:l.map(c=>{if(c.length===1){const d=c[0],u=new G({lonlat:d,billboard:n});return a(d),u}if(c.length>1){const d=c.map(u=>(a(u),new L(u[0],u[1],u[2])));return new G({polyline:{pathLonLat:[d],thickness:3,color:s,isClosed:!1}})}}),extent:o}}_getXmlContent(t){return new Promise(s=>{const n=new FileReader;n.onload=async o=>s(new DOMParser().parseFromString(o.target.result,"text/xml")),n.readAsText(t)})}_expandExtents(t,s){return t?(s.southWest.lon<t.southWest.lon&&(t.southWest.lon=s.southWest.lon),s.southWest.lat<t.southWest.lat&&(t.southWest.lat=s.southWest.lat),s.northEast.lon>t.northEast.lon&&(t.northEast.lon=s.northEast.lon),s.northEast.lat>t.northEast.lat&&(t.northEast.lat=s.northEast.lat),t):s}async addKmlFromFiles(t,s,n){if(!Array.isArray(t))return null;const o=(await Promise.all(t.map(this._getXmlContent))).map(this._extractCoordonatesFromKml),{entities:a,extent:l}=this._convertCoordonatesIntoEntities(o,s||this._color,n||this._billboard);return this._extent=this._expandExtents(this._extent,l),a.forEach(this.add.bind(this)),{entities:a,extent:l}}setColor(t){this._color=t,this._billboard.color=t}_getKmlFromUrl(t){return new Promise((s,n)=>{const o=new XMLHttpRequest;o.open("GET",t,!0),o.responseType="document",o.overrideMimeType("text/xml"),o.onload=()=>{o.readyState===o.DONE&&o.status===200?s(o.responseXML):n(new Error("no valid kml file"))},o.send()})}async addKmlFromUrl(t,s,n){const o=await this._getKmlFromUrl(t),{entities:a,extent:l}=this._convertKMLintoEntities(o);return this._extent=this._expandExtents(this._extent,l),a.forEach(this.add.bind(this)),{entities:a,extent:l}}}class _c extends Ds{constructor(t,s={}){super(t||"OpenStreetMap",{iconSrc:"https://tile.openstreetmap.org/8/138/95.png",url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",attribution:"Data @ OpenStreetMap contributors, ODbL",isBaseLayer:!0,maxNativeZoom:19,defaultTextures:[{color:"#AAD3DF"},{color:"#F2EFE9"}],isSRGB:!1,shininess:18,specular:[63e-5,55e-5,32e-5],ambient:[.2,.2,.3],diffuse:[.9,.9,.7],...s})}}function fc(h,t,s){var n="";for(let l=s;l>0;l--){var o=0,a=1<<l-1;h&a&&o++,t&a&&(o+=2),n+=o.toString()}return n}class gc extends Ds{constructor(t,s={}){super(t||"Bing",{iconSrc:"https://ecn.t0.tiles.virtualearth.net/tiles/a120.jpeg?n=z&g=7146",subdomains:["t0","t1","t2","t3"],url:"https://ecn.{s}.tiles.virtualearth.net/tiles/a{quad}.jpeg?n=z&g=7146",isBaseLayer:!0,textureFilter:"LINEAR",maxNativeZoom:17,defaultTextures:[{color:"#001522"},{color:"#E4E6F3"}],attribution:'<div style="transform: scale(0.8); margin-top:-2px;"><a href="https://www.bing.com" target="_blank"><img style="position: relative; top: 2px;" title="Bing Imagery" src="https://sandcastle.cesium.com/CesiumUnminified/Assets/Images/bing_maps_credit.png"></a> © 2021 Microsoft Corporation</div>',urlRewrite:(n,o)=>Dt(o,{s:this._getSubdomain(),quad:fc(n.tileX,n.tileY,n.tileZoom)}),specular:[63e-5,55e-5,32e-5],ambient:[.35,.35,.35],diffuse:[1.5,1.5,1.5],shininess:20,nightTextureCoefficient:2.7,...s})}}Object.freeze(Object.defineProperty({__proto__:null,Bing:gc,CanvasTiles:ss,GeoImage:Ca,GeoTexture2d:cc,GeoVideo:dc,KML:uc,LAYER_EVENTS:Go,Layer:zt,Material:Uo,OpenStreetMap:_c,Vector:_t,WMS:me,XYZ:Ds},Symbol.toStringTag,{value:"Module"}));const nr=function(h,t){return+(h.priority<t.priority)};class pc{constructor(){this._currentlyPressedKeys={},this._pressedKeysCallbacks={},this._unpressedKeysCallbacks={},this._charkeysCallbacks={},this._anykeyCallback=null,this._event=null,this._active=!0,this._stampCache={},document.onkeydown=t=>{this._event=t,this._active&&this.handleKeyDown()},document.onkeyup=t=>{this._event=t,this._active&&this.handleKeyUp()}}getcurrentlyPressedKeys(){return this._currentlyPressedKeys}getPressedKeysCallbacks(){return this._pressedKeysCallbacks}getUnpressedKeysCallbacks(){return this._unpressedKeysCallbacks}getCharkeysCallbacks(){return this._charkeysCallbacks}removeEvent(t,s,n){let o=this._getStamp(t,s,n._openglobus_id);n._openglobus_id&&this._stampCache[o]&&(delete this._stampCache[o],t==="keypress"?this._removeCallback(this._pressedKeysCallbacks[s],n):t==="keyfree"?this._removeCallback(this._unpressedKeysCallbacks[s],n):t==="charkeypress"&&this._removeCallback(this._charkeysCallbacks[s],n))}_removeCallback(t,s){for(let n=0;n<t.length;n++)t[n].callback._openglobus_id===s._openglobus_id&&t.splice(n,1)}_getStamp(t,s,n){return`${t}_${s}_${n}`}_stamp(t,s,n){const o=Yr(n),a=this._getStamp(t,s,o);return!this._stampCache[a]&&(this._stampCache[a]=o,!0)}setActivity(t){this._active=t}releaseKeys(){this._currentlyPressedKeys={}}addEvent(t,s,n,o,a){if(this._stamp(t,s,n))switch(a===void 0&&(a=1600),t){case"keyfree":this._unpressedKeysCallbacks[s]||(this._unpressedKeysCallbacks[s]=[]),this._unpressedKeysCallbacks[s].push({callback:n,sender:o,priority:a}),this._unpressedKeysCallbacks[s].sort(nr);break;case"keypress":s==null?this._anykeyCallback={callback:n,sender:o||this}:(this._pressedKeysCallbacks[s]||(this._pressedKeysCallbacks[s]=[]),this._pressedKeysCallbacks[s].push({callback:n,sender:o,priority:a}),this._pressedKeysCallbacks[s].sort(nr));break;case"charkeypress":this._charkeysCallbacks[s]||(this._charkeysCallbacks[s]=[]),this._charkeysCallbacks[s].push({callback:n,sender:o,priority:a}),this._charkeysCallbacks[s].sort(nr)}}isKeyPressed(t){return this._currentlyPressedKeys[t]}handleKeyDown(){this._anykeyCallback&&this._anykeyCallback.callback.call(this._anykeyCallback.sender,this._event),this._currentlyPressedKeys[this._event.keyCode]=!0;for(let t in this._charkeysCallbacks)if(String.fromCharCode(this._event.keyCode)===String.fromCharCode(Number(t))){let s=this._charkeysCallbacks[t];for(let n=0;n<s.length;n++)s[n].callback.call(s[n].sender,this._event)}this._event.keyCode!=W.KEY_ALT&&this._event.keyCode!=W.KEY_SHIFT||this._event.preventDefault()}handleKeyUp(){if(this._currentlyPressedKeys[this._event.keyCode]||this._event.keyCode===W.KEY_PRINTSCREEN){for(let t in this._unpressedKeysCallbacks)if(this._currentlyPressedKeys[t]||this._event.keyCode===W.KEY_PRINTSCREEN&&Number(t)===W.KEY_PRINTSCREEN){let s=this._unpressedKeysCallbacks[t];for(let n=0;n<s.length;n++)s[n].callback.call(s[n].sender,this._event)}}this._currentlyPressedKeys[this._event.keyCode]=!1}handleEvents(){for(let t in this._pressedKeysCallbacks)if(this._currentlyPressedKeys[t]){let s=this._pressedKeysCallbacks[t];for(let n=0;n<s.length;n++)s[n].callback.call(s[n].sender,this._event)}}}class mc{constructor(t){this._htmlObject=t}setEvent(t,s,n){switch(t){case"mousewheel":this._htmlObject.addEventListener("wheel",o=>{let a=o.deltaY||o.detail||o.wheelDelta||0;var l;o.wheelDelta==null&&(o.wheelDelta=-120*a),o.isTouchPad=(l=o).deltaMode===0&&Math.abs(l.deltaY)<50,n.call(s,o),o.preventDefault()},!1);break;case"mousedown":this._htmlObject.addEventListener("mousedown",function(o){let a=this.getBoundingClientRect();n.call(s,o,{button:o.button,clientX:o.clientX-a.left,clientY:o.clientY-a.top})}),this._htmlObject.addEventListener("contextmenu",function(o){return o.preventDefault(),!1});break;case"mouseup":this._htmlObject.addEventListener("mouseup",function(o){let a=this.getBoundingClientRect();n.call(s,o,{button:o.button,clientX:o.clientX-a.left,clientY:o.clientY-a.top})});break;case"mousemove":this._htmlObject.addEventListener("mousemove",function(o){let a=this.getBoundingClientRect();n.call(s,o,{clientX:o.clientX-a.left,clientY:o.clientY-a.top})});break;case"mouseleave":this._htmlObject.addEventListener("mouseleave",function(o){n.call(s,o)});break;case"mouseout":this._htmlObject.addEventListener("mouseout",function(o){n.call(s,o)});break;case"mouseover":this._htmlObject.addEventListener("mouseover",function(o){n.call(s,o)});break;case"mouseenter":this._htmlObject.addEventListener("mouseenter",function(o){n.call(s,o)})}}}class vc{constructor(t){this._htmlObject=t}setEvent(t,s,n){switch(t){case"touchcancel":this._htmlObject.addEventListener("touchcancel",function(o){o.preventDefault();const a=this.getBoundingClientRect(),l=Object.assign(o,{offsetLeft:a.left,offsetTop:a.top});n.call(s,l)});break;case"touchstart":this._htmlObject.addEventListener("touchstart",function(o){o.preventDefault();const a=this.getBoundingClientRect(),l=Object.assign(o,{offsetLeft:a.left,offsetTop:a.top});n.call(s,l)});break;case"touchend":this._htmlObject.addEventListener("touchend",function(o){o.preventDefault();const a=this.getBoundingClientRect(),l=Object.assign(o,{offsetLeft:a.left,offsetTop:a.top});n.call(s,l)});break;case"touchmove":this._htmlObject.addEventListener("touchmove",function(o){o.preventDefault();const a=this.getBoundingClientRect(),l=Object.assign(o,{offsetLeft:a.left,offsetTop:a.top});n.call(s,l)})}}}let _e=new Uint8Array(4),ei=new Uint8Array(4),ii=new Uint8Array(4);class yc extends bi{constructor(t){super(xc),this.renderer=t,this._touchHandler=new vc(t.handler.canvas),this._mouseHandler=new mc(t.handler.canvas),this._keyboardHandler=new pc,this._active=!0,this.clickRadius=15,this.mouseState={clientX:0,clientY:0,pos:new H,x:0,y:0,nx:0,ny:0,prev_x:0,prev_y:0,direction:new v,leftButtonUp:!1,rightButtonUp:!1,middleButtonUp:!1,leftButtonDown:!1,rightButtonDown:!1,middleButtonDown:!1,leftButtonHold:!1,rightButtonHold:!1,middleButtonHold:!1,leftButtonDoubleClick:!1,rightButtonDoubleClick:!1,middleButtonDoubleClick:!1,leftButtonClick:!1,rightButtonClick:!1,middleButtonClick:!1,moving:!1,justStopped:!1,doubleClickDelay:500,clickDelay:200,wheelDelta:0,sys:null,pickingObject:null,renderer:t,isTouchPad:!1},this.touchState={touching:!1,moving:!1,touchEnd:!1,touchStart:!1,touchCancel:!1,doubleTouch:!1,doubleTouchDelay:550,doubleTouchRadius:10,clientX:0,clientY:0,pos:new H,x:0,y:0,nx:0,ny:0,prev_x:0,prev_y:0,direction:new v,sys:null,pickingObject:null,renderer:t},this._isMouseInside=!0,this._entityPickingEventsActive=!0,this._dblTchCoords=new H,this._oneTouchStart=!1,this._dblTchBegins=0,this._mousestopThread=null,this._ldblClkBegins=0,this._rdblClkBegins=0,this._mdblClkBegins=0,this._lClkBegins=0,this._rClkBegins=0,this._mClkBegins=0,this._lclickX=0,this._lclickY=0,this._rclickX=0,this._rclickY=0,this._mclickX=0,this._mclickY=0}pointerEvent(){let t=this.mouseState;return t.moving||t.justStopped||t.wheelDelta!==0}get active(){return this._active}set active(t){this._active=t,this._keyboardHandler.setActivity(t)}handleEvents(){this._active&&(this.mouseState.direction=this.renderer.activeCamera.unproject(this.mouseState.x,this.mouseState.y),this.touchState.direction=this.renderer.activeCamera.unproject(this.touchState.x,this.touchState.y),this._keyboardHandler.handleEvents(),this.handleMouseEvents(),this.handleTouchEvents(),this.entityPickingEvents())}on(t,s,n,o,a){t==="keypress"||t==="charkeypress"||t==="keyfree"?this._keyboardHandler.addEvent(t,s,n,o,a):super.on(t,s,n,o)}off(t,s,n){t==="keypress"||t==="charkeypress"||t==="keyfree"?this._keyboardHandler.removeEvent(t,s,n):super.off(t,s)}isKeyPressed(t){return this._keyboardHandler.isKeyPressed(t)}releaseKeys(){this._keyboardHandler.releaseKeys()}initialize(){this._mouseHandler.setEvent("mouseup",this,this.onMouseUp),this._mouseHandler.setEvent("mousemove",this,this.onMouseMove),this._mouseHandler.setEvent("mousedown",this,this.onMouseDown),this._mouseHandler.setEvent("mousewheel",this,this.onMouseWheel),this._mouseHandler.setEvent("mouseleave",this,this.onMouseLeave),this._mouseHandler.setEvent("mouseenter",this,this.onMouseEnter),this._touchHandler.setEvent("touchstart",this,this.onTouchStart),this._touchHandler.setEvent("touchend",this,this.onTouchEnd),this._touchHandler.setEvent("touchcancel",this,this.onTouchCancel),this._touchHandler.setEvent("touchmove",this,this.onTouchMove)}onMouseWheel(t){this.mouseState.isTouchPad=t.isTouchPad||!1,this.mouseState.sys=t,this.mouseState.wheelDelta=t.wheelDelta||0}updateButtonsStates(t){let s=this.mouseState;1&t&&s.leftButtonDown?s.leftButtonDown=!0:(s.leftButtonHold=!1,s.leftButtonDown=!1),2&t&&s.rightButtonDown?s.rightButtonDown=!0:(s.rightButtonHold=!1,s.rightButtonDown=!1),4&t&&s.middleButtonDown?s.middleButtonDown=!0:(s.middleButtonHold=!1,s.middleButtonDown=!1)}onMouseMove(t,s){let n=this.mouseState;this.updateButtonsStates(t.buttons),n.sys=t;let o=s.clientX,a=s.clientY,l=this.clickRadius;if(Math.abs(this._lclickX-o)>=l&&Math.abs(this._lclickY-a)>=l&&(this._ldblClkBegins=0,this._lClkBegins=0),Math.abs(this._rclickX-o)>=l&&Math.abs(this._rclickY-a)>=l&&(this._rdblClkBegins=0,this._rClkBegins=0),Math.abs(this._mclickX-o)>=l&&Math.abs(this._mclickY-a)>=l&&(this._mdblClkBegins=0,this._mClkBegins=0),n.clientX===s.clientX&&n.clientY===s.clientY)return;n.clientX=s.clientX,n.clientY=s.clientY;let c=this.renderer.handler;n.pos.x=n.x=s.clientX*c.pixelRatio,n.pos.y=n.y=s.clientY*c.pixelRatio,n.nx=n.x/c.canvas.width,n.ny=n.y/c.canvas.height,n.moving=!0,clearTimeout(this._mousestopThread),this._mousestopThread=setTimeout(function(){n.justStopped=!0},100)}onMouseLeave(t){this._isMouseInside=!1,this.mouseState.sys=t,this.dispatch(this.mouseleave,this.mouseState)}onMouseEnter(t){this._isMouseInside=!0,this.mouseState.sys=t,this.dispatch(this.mouseenter,this.mouseState)}onMouseDown(t,s){s.button===W.MB_LEFT?(this._lClkBegins=window.performance.now(),this._lclickX=s.clientX,this._lclickY=s.clientY,this.mouseState.sys=t,this.mouseState.leftButtonDown=!0):s.button===W.MB_RIGHT?(this._rClkBegins=window.performance.now(),this._rclickX=s.clientX,this._rclickY=s.clientY,this.mouseState.sys=t,this.mouseState.rightButtonDown=!0):s.button===W.MB_MIDDLE&&(this._mClkBegins=window.performance.now(),this._mclickX=s.clientX,this._mclickY=s.clientY,this.mouseState.sys=t,this.mouseState.middleButtonDown=!0)}onMouseUp(t,s){let n=this.mouseState;n.sys=t;let o=window.performance.now();s.button===W.MB_LEFT?(n.leftButtonDown=!1,n.leftButtonUp=!0,Math.abs(this._lclickX-s.clientX)<this.clickRadius&&Math.abs(this._lclickY-s.clientY)<this.clickRadius&&o-this._lClkBegins<=n.clickDelay&&(this._ldblClkBegins?(window.performance.now()-this._ldblClkBegins<=n.doubleClickDelay&&(n.leftButtonDoubleClick=!0),this._ldblClkBegins=0):this._ldblClkBegins=window.performance.now(),n.leftButtonClick=!0,this._lClkBegins=0)):s.button===W.MB_RIGHT?(n.rightButtonDown=!1,n.rightButtonUp=!0,Math.abs(this._rclickX-s.clientX)<this.clickRadius&&Math.abs(this._rclickY-s.clientY)<this.clickRadius&&o-this._rClkBegins<=n.clickDelay&&(this._rdblClkBegins?(window.performance.now()-this._rdblClkBegins<=n.doubleClickDelay&&(n.rightButtonDoubleClick=!0),this._rdblClkBegins=0):this._rdblClkBegins=window.performance.now(),n.rightButtonClick=!0,this._rClkBegins=0)):s.button===W.MB_MIDDLE&&(n.middleButtonDown=!1,n.middleButtonUp=!0,Math.abs(this._mclickX-s.clientX)<this.clickRadius&&Math.abs(this._mclickY-s.clientY)<this.clickRadius&&o-this._mClkBegins<=n.clickDelay)&&(this._mdblClkBegins?(window.performance.now()-this._mdblClkBegins<=n.doubleClickDelay&&(n.middleButtonDoubleClick=!0),this._mdblClkBegins=0):this._mdblClkBegins=window.performance.now(),n.middleButtonClick=!0,this._mClkBegins=0)}onTouchStart(t){let s=this.touchState;s.sys=t,s.clientX=t.touches.item(0).clientX-t.offsetLeft,s.clientY=t.touches.item(0).clientY-t.offsetTop;let n=this.renderer.handler;s.pos.x=s.x=s.clientX*n.pixelRatio,s.pos.y=s.y=s.clientY*n.pixelRatio,s.nx=s.x/n.canvas.width,s.ny=s.y/n.canvas.height,s.prev_x=s.x,s.prev_y=s.y,s.touchStart=!0,s.touching=!0,t.touches.length===1?(this._dblTchCoords.x=s.x,this._dblTchCoords.y=s.y,this._oneTouchStart=!0):this._oneTouchStart=!1}onTouchEnd(t){let s=this.touchState;s.sys=t,s.touchEnd=!0,t.touches.length===0&&(s.prev_x=s.x,s.prev_y=s.y,this._oneTouchStart)&&(this._dblTchBegins&&(window.performance.now()-this._dblTchBegins<=s.doubleTouchDelay&&(s.doubleTouch=!0),this._dblTchBegins=0),this._dblTchBegins=window.performance.now(),this._oneTouchStart=!1)}onTouchCancel(t){let s=this.touchState;s.sys=t,s.touchCancel=!0}onTouchMove(t){let s=this.touchState;s.clientX=t.touches.item(0).clientX-t.offsetLeft,s.clientY=t.touches.item(0).clientY-t.offsetTop;let n=this.renderer.handler;s.x=s.clientX*n.pixelRatio,s.y=s.clientY*n.pixelRatio,s.nx=s.x/n.canvas.width,s.ny=s.y/n.canvas.height,s.sys=t,s.moving=!0;let o=s.x-s.prev_x,a=s.y-s.prev_y;(Math.abs(o)>9||Math.abs(a)>9)&&(this._dblTchBegins=0,this._oneTouchStart=!1)}entityPickingEvents(){let t=this.touchState,s=this.mouseState;if(this._isMouseInside!==this._entityPickingEventsActive&&(this._entityPickingEventsActive=this._isMouseInside,!this._entityPickingEventsActive)){let o=this.renderer,a=_e,l=o.getPickingObjectArr(a);if(l){let c=l.rendererEvents;s.pickingObject=l,c&&c.dispatch(c.mouseleave,s),t.pickingObject=l,c&&c.dispatch(c.touchleave,t)}_e[0]=_e[1]=_e[2]=_e[3]=ii[0]=ii[1]=ii[2]=ii[3]=ei[0]=ei[1]=ei[2]=ei[3]=0}if(this._isMouseInside&&!(s.leftButtonHold||s.rightButtonHold||s.middleButtonHold)){let o=this.renderer,a=_e,l=ii,c=ei;t.x||t.y?o.readPickingColor(t.nx,1-t.ny,c):o.readPickingColor(s.nx,1-s.ny,c),l[0]=a[0],l[1]=a[1],l[2]=a[2],a[0]=c[0],a[1]=c[1],a[2]=c[2],s.pickingObject=null,t.pickingObject=null;let d=o.getPickingObjectArr(a);if(s.pickingObject=d,t.pickingObject=d,a[0]!==l[0]||a[1]!==l[1]||a[2]!==l[2])if((n=a)[0]||n[1]||n[2]){if((u=>!!(u[0]||u[1]||u[2]))(l)){let u=o.getPickingObjectArr(l);if(u){let _=u.rendererEvents;s.pickingObject=u,_&&_.dispatch(_.mouseleave,s),t.pickingObject=u,_&&_.dispatch(_.touchleave,t)}}if(d){let u=d.rendererEvents;s.pickingObject=d,u&&u.dispatch(u.mouseenter,s),t.pickingObject=d,u&&u.dispatch(u.touchenter,t)}}else{let u=o.getPickingObjectArr(l);if(u){let _=u.rendererEvents;s.pickingObject=u,_&&_.dispatch(_.mouseleave,s),t.pickingObject=u,_&&_.dispatch(_.touchleave,t)}}}var n}handleMouseEvents(){let t=this,s=this.mouseState,n=s.pickingObject,o=null;s.leftButtonClick&&(n&&(o=n.rendererEvents,o&&o.dispatch(o.lclick,s)),this.dispatch(t.lclick,s),s.leftButtonClick=!1),s.rightButtonClick&&(n&&(o=n.rendererEvents,o&&o.dispatch(o.rclick,s)),this.dispatch(t.rclick,s),s.rightButtonClick=!1),s.middleButtonClick&&(n&&(o=n.rendererEvents,o&&o.dispatch(o.mclick,s)),this.dispatch(t.mclick,s),s.middleButtonClick=!1),s.leftButtonDown&&(s.leftButtonHold?(n&&(o=n.rendererEvents,o&&o.dispatch(o.lhold,s)),this.dispatch(t.lhold,s)):(s.leftButtonHold=!0,n&&(o=n.rendererEvents,o&&o.dispatch(o.ldown,s)),this.dispatch(t.ldown,s))),s.rightButtonDown&&(s.rightButtonHold?(n&&(o=n.rendererEvents,o&&o.dispatch(o.rhold,s)),this.dispatch(t.rhold,s)):(s.rightButtonHold=!0,n&&(o=n.rendererEvents,o&&o.dispatch(o.rdown,s)),this.dispatch(t.rdown,s))),s.middleButtonDown&&(s.middleButtonHold?(n&&(o=n.rendererEvents,o&&o.dispatch(o.mhold,s)),this.dispatch(t.mhold,s)):(s.middleButtonHold=!0,n&&(o=n.rendererEvents,o&&o.dispatch(o.mdown,s)),this.dispatch(t.mdown,s))),s.leftButtonUp&&(n&&(o=n.rendererEvents,o&&o.dispatch(o.lup,s)),this.dispatch(t.lup,s),s.leftButtonUp=!1,s.leftButtonHold=!1),s.rightButtonUp&&(n&&(o=n.rendererEvents,o&&o.dispatch(o.rup,s)),this.dispatch(t.rup,s),s.rightButtonUp=!1,s.rightButtonHold=!1),s.middleButtonUp&&(n&&(o=n.rendererEvents,o&&o.dispatch(o.mup,s)),this.dispatch(t.mup,s),s.middleButtonUp=!1,s.middleButtonHold=!1),s.leftButtonDoubleClick&&(n&&(o=n.rendererEvents,o&&o.dispatch(o.ldblclick,s)),this.dispatch(t.ldblclick,s),s.leftButtonDoubleClick=!1),s.rightButtonDoubleClick&&(n&&(o=n.rendererEvents,o&&o.dispatch(o.rdblclick,s)),this.dispatch(t.rdblclick,s),s.rightButtonDoubleClick=!1),s.middleButtonDoubleClick&&(n&&(o=n.rendererEvents,o&&o.dispatch(o.mdblclick,s)),this.dispatch(t.mdblclick,s),s.middleButtonDoubleClick=!1),s.wheelDelta&&(n&&(o=n.rendererEvents,o&&o.dispatch(o.mousewheel,s)),this.dispatch(t.mousewheel,s)),s.moving&&(n&&(o=n.rendererEvents,o&&o.dispatch(o.mousemove,s)),this.dispatch(t.mousemove,s),s.prev_x=s.x,s.prev_y=s.y),s.justStopped&&this.dispatch(t.mousestop,s)}handleTouchEvents(){let t=this,s=this.touchState,n=s.pickingObject,o=null;if(s.touchCancel&&(this.dispatch(t.touchcancel,s),s.touchCancel=!1),s.touchStart){let a=this.renderer;a.readPickingColor(s.nx,1-s.ny,_e);let l=a.getPickingObjectArr(_e);n=s.pickingObject=l,n&&(o=n.rendererEvents,o&&o.dispatch(o.touchstart,s)),this.dispatch(t.touchstart,s),s.touchStart=!1}s.doubleTouch&&(n&&(o=n.rendererEvents,o&&o.dispatch(o.doubletouch,s)),this.dispatch(t.doubletouch,s),s.doubleTouch=!1),s.touchEnd&&(n&&(o=n.rendererEvents,o&&o.dispatch(o.touchend,s)),this.dispatch(t.touchend,s),s.x=0,s.y=0,s.touchEnd=!1,s.touching=!1),s.moving&&(n&&(o=n.rendererEvents,o&&o.dispatch(o.touchmove,s)),this.dispatch(t.touchmove,s),s.prev_x=s.x,s.prev_y=s.y)}}const xc=["projchanged","changerelativecenter","draw","drawtransparent","postdraw","resize","resizeend","mouseenter","mouseleave","mousemove","mousestop","lclick","rclick","mclick","ldblclick","rdblclick","mdblclick","lup","rup","mup","ldown","rdown","mdown","lhold","rhold","mhold","mousewheel","touchstart","touchend","touchcancel","touchmove","doubletouch","touchleave","touchenter"];class Ii{constructor(t=0,s=0,n=0,o=0){this.left=t,this.right=n,this.top=s,this.bottom=o}set(t=0,s=0,n=0,o=0){this.left=t,this.right=n,this.top=s,this.bottom=o}clone(){return new Ii(this.left,this.top,this.right,this.bottom)}getWidth(){return Math.abs(this.right-this.left)}getHeight(){return Math.abs(this.bottom-this.top)}getSquare(){return this.getHeight()*this.getWidth()}getDiagonal(){let t=this.getWidth(),s=this.getHeight();return Math.sqrt(s*s+t*t)}fit(t,s){return this.getWidth()===t&&this.getHeight()===s}isInside(t,s){return t>=this.left&&t<=this.right&&s>=this.top&&s<=this.bottom}}class bc{constructor(){this.imagesCache={},this._counter=0,this._pendingsQueue=new dn,this._imageIndexCounter=0}load(t,s){if(this.imagesCache[t])s(this.imagesCache[t]);else{let n={src:t,success:s};this._counter>=1?this._pendingsQueue.unshift(n):this._exec(n)}}_exec(t){this._counter++;const s=this;let n=new Image;n.crossOrigin="",n.onload=function(){s.imagesCache[t.src]=n,n.__nodeIndex=s._imageIndexCounter++,t.success(n),s._dequeueRequest()},n.onerror=function(){s._dequeueRequest()},n.src=t.src}_dequeueRequest(){if(this._counter--,this._pendingsQueue.length&&this._counter<1)for(;this._pendingsQueue.length;){let t=this._pendingsQueue.pop();if(t){if(!this.imagesCache[t.src]){this._exec(t);break}this._counter<=0?this._counter=0:this._counter--,t.success(this.imagesCache[t.src])}}}}class Vr{constructor(t=1024,s=1024){this.nodes=new Map,this.texture=null,this.canvas=new mi(t,s),this.clearCanvas(),this._handler=null,this._images=[],this._btree=null,this._imagesCacheManager=new bc,this.borderSize=4}getImage(){return this.canvas.getImage()}getCanvas(){return this.canvas.getCanvas()}clearCanvas(){this.canvas.fillEmpty()}assignHandler(t){this._handler=t,this.createTexture()}getDiagonal(t){let s=t.atlasWidth||t.width,n=t.atlasHeight||t.height;return Math.sqrt(s*s+n*n)}addImage(t,s=!1){if(t.width&&t.height)return this._images.push(t),this._makeAtlas(s),t.__nodeIndex!=null?this.get(t.__nodeIndex):void 0}_completeNode(t,s){if(s){let n=this.canvas.getWidth(),o=this.canvas.getHeight(),a=s.image,l=s.rect,c=Math.round(.5*this.borderSize);this.canvas.drawImage(a,l.left+c,l.top+c,a.atlasWidth||0,a.atlasHeight||0);let d=s.texCoords;d[0]=(l.left+c)/n,d[1]=(l.top+c)/o,d[2]=(l.left+c)/n,d[3]=(l.bottom-c)/o,d[4]=(l.right-c)/n,d[5]=(l.bottom-c)/o,d[6]=(l.right-c)/n,d[7]=(l.bottom-c)/o,d[8]=(l.right-c)/n,d[9]=(l.top+c)/o,d[10]=(l.left+c)/n,d[11]=(l.top+c)/o,t.set(a.__nodeIndex,s)}}_makeAtlas(t=!1){if(t&&this._btree){let s=this._images[this._images.length-1];this._completeNode(this.nodes,this._btree.insert(s))}else{let s=this._images.slice(0);s.sort(function(o,a){return(a.atlasWidth||a.width)-(o.atlasWidth||o.width)||(a.atlasHeight||a.height)-(o.atlasHeight||o.height)}),this._btree=new Bi(new Ii(0,0,this.canvas.getWidth(),this.canvas.getHeight())),this._btree.atlas=this,this.clearCanvas();let n=new Map;for(let o=0;o<s.length;o++)this._completeNode(n,this._btree.insert(s[o]));this.nodes=null,this.nodes=n}}get(t){return this.nodes.get(t)}set(t,s){this.nodes.set(t,s)}createTexture(t,s){this._handler&&(this._handler.gl.deleteTexture(this.texture),t&&(this.canvas.resize(t.width,t.height),this.canvas.drawImage(t,0,0,t.width,t.height)),this.texture=this._handler.createTexture_l(this.canvas.getCanvas(),s))}loadImage(t,s){this._imagesCacheManager.load(t,s)}getImageTexCoordinates(t){if(t.__nodeIndex!=null){let s=this.get(t.__nodeIndex);if(s)return s.texCoords}}}class Bi{constructor(t,s){this.childNodes=null,this.image=null,this.rect=t||new Ii,this.texCoords=s||[],this.atlas=null}insert(t){if(this.childNodes)return this.childNodes[0].insert(t)||this.childNodes[1].insert(t);{if(this.image!=null)return;let s=this.rect;const n=(t.atlasWidth||t.width)+this.atlas.borderSize,o=(t.atlasHeight||t.height)+this.atlas.borderSize;return n>s.getWidth()||o>s.getHeight()?void 0:s.fit(n,o)?(this.image=t,this):(this.childNodes=new Array(2),this.childNodes[0]=new Bi,this.childNodes[0].atlas=this.atlas,this.childNodes[1]=new Bi,this.childNodes[1].atlas=this.atlas,s.getWidth()-n>s.getHeight()-o?(this.childNodes[0].rect.set(s.left,s.top,s.left+n,s.bottom),this.childNodes[1].rect.set(s.left+n,s.top,s.right,s.bottom)):(this.childNodes[0].rect.set(s.left,s.top,s.right,s.top+o),this.childNodes[1].rect.set(s.left,s.top+o,s.right,s.bottom)),this.childNodes[0].insert(t))}}}class _o extends Vr{constructor(t,s){super(t,s),this.width=0,this.height=0,this.gliphSize=0,this.distanceRange=0,this.nodes=new Map,this.kernings={}}get(t){return this.nodes.get(t)}}class wc extends Bi{constructor(t,s){super(t,s),this.emptySize=1,this.metrics={id:0,char:"",width:0,height:0,x:0,y:0,chnl:0,index:0,page:0,xadvance:0,xoffset:0,yoffset:0,nChar:"",nCode:0,nWidth:0,nHeight:0,nAdvance:0,nXOffset:0,nYOffset:0}}}class Tc{constructor(t){this.atlasesArr=[],this.atlasIndexes={},this.atlasIndexesDeferred={},this.tokenImageSize=64,this.samplerArr=new Uint32Array(11),this.sdfParamsArr=new Float32Array(44),this._handler=null,this.catalogSrc=t||"./"}assignHandler(t){this._handler=t}getFontIndex(t){let s=this.getFullIndex(t);return this.atlasIndexes[s]||this.loadFont(t,this.catalogSrc,`${t}.json`),this.atlasIndexesDeferred[s]||(this.atlasIndexesDeferred[s]=new pi),this.atlasIndexesDeferred[s].promise}getFullIndex(t){return t.trim().toLowerCase()}_applyFontDataToAtlas(t,s,n=0){let o=s.chars;t.height=s.common.scaleH,t.width=s.common.scaleW,t.gliphSize=s.info.size,t.distanceRange=s.distanceField.distanceRange;let a=t.width,l=t.height,c=t.gliphSize;this.sdfParamsArr[4*n]=a,this.sdfParamsArr[4*n+1]=l,this.sdfParamsArr[4*n+2]=c,this.sdfParamsArr[4*n+3]=t.distanceRange;let d={};for(let u=0;u<o.length;u++){let _=o[u],f=_.char;d[_.id]=f;let g=new Ii(_.x,_.y,_.x+_.width,_.y+_.height),m=new Array(12);m[0]=g.left/a,m[1]=g.top/l,m[2]=g.left/a,m[3]=g.bottom/l,m[4]=g.right/a,m[5]=g.bottom/l,m[6]=g.right/a,m[7]=g.bottom/l,m[8]=g.right/a,m[9]=g.top/l,m[10]=g.left/a,m[11]=g.top/l;let p=new wc(g,m),x=_.char.normalize("NFKC"),y=x.charCodeAt(0),w=p.metrics;w.id=_.id,w.char=_.char,w.width=_.width,w.height=_.height,w.x=_.x,w.y=_.y,w.chnl=_.chnl,w.index=_.index,w.page=_.page,w.xadvance=_.xadvance,w.xoffset=_.xoffset,w.yoffset=_.yoffset,w.nChar=x,w.nCode=y,w.nWidth=p.metrics.width/c,w.nHeight=p.metrics.height/c,w.nAdvance=p.metrics.xadvance/c,w.nXOffset=p.metrics.xoffset/c,w.nYOffset=1-p.metrics.yoffset/c,p.emptySize=1,t.nodes.set(x.charCodeAt(0),p)}t.kernings={};for(let u=0;u<s.kernings.length;u++){let _=s.kernings[u],f=_.first,g=_.second;t.kernings[f]||(t.kernings[f]={}),t.kernings[f][g]=_.amount/c}}initFont(t,s,n){let o=this.atlasesArr.length,a=this.getFullIndex(t);this.atlasIndexes[a]=o;let l=this.atlasIndexesDeferred[a];l||(l=this.atlasIndexesDeferred[a]=new pi),this.samplerArr[this.atlasesArr.length]=o;let c=new _o;c.height=0,c.width=0,c.gliphSize=0,c.distanceRange=0,c.kernings={},c.assignHandler(this._handler),this.atlasesArr[o]=c,this._applyFontDataToAtlas(c,s,o);let d=new Image;d.onload=()=>{this._createTexture(c,d),l.resolve(o)},d.src=n}_createTexture(t,s){t.createTexture(s)}loadFont(t,s,n){let o=this.atlasesArr.length,a=this.getFullIndex(t);this.atlasIndexes[a]=o;let l=this.atlasIndexesDeferred[a];l||(l=this.atlasIndexesDeferred[a]=new pi),this.samplerArr[this.atlasesArr.length]=o;let c=new _o;c.height=0,c.width=0,c.gliphSize=0,c.distanceRange=0,c.kernings={},c.assignHandler(this._handler),this.atlasesArr[o]=c,fetch(`${s}/${n}`).then(d=>{if(!d.ok)throw Error(`Unable to load "${s}/${n}"`);return d.json()}).then(d=>{this._applyFontDataToAtlas(c,d,o);let u=new Image;u.onload=()=>{this._createTexture(c,u),l.resolve(o)},u.src=`${s}/${d.pages[0]}`,u.crossOrigin="Anonymous"}).catch(d=>(l.reject(),{status:"error",msg:d.toString()}))}}let Cc=0,Ec=0,He=new Float32Array(2);class Ac{constructor(t,s={}){var n,o;if(this.div=null,this.handler=t instanceof Be?t:new Be(t,{pixelRatio:s.dpi||window.devicePixelRatio+.15,autoActivate:!0}),this.clearColor=new Float32Array(s.clearColor||[0,0,0,1]),this.exposure=s.exposure||3.01,this.gamma=s.gamma||.47,this.whitepoint=1,this.brightThreshold=.9,this._renderNodesArr=[],this.renderNodes={},this.activeCamera=new Pi({width:(n=this.handler.canvas)==null?void 0:n.width,height:(o=this.handler.canvas)==null?void 0:o.height,eye:new v(0,0,0),look:new v(0,0,-1),up:new v(0,1,0)}),this.events=new yc(this),this.controls={},s.controls)for(let c in s.controls)this.controls[s.controls[c].name]=s.controls[c];this.controlsBag={},this.colorObjects=new Map,this._pickingCallbacks=[],this.pickingFramebuffer=null,this._depthCallbacks=[],this.depthFramebuffer=null,this._depthRefreshRequired=!1;let a=new URLSearchParams(location.search),l=a.get("og_msaa");this._msaa=l?Number(a.get("og_msaa")):s.msaa!=null?s.msaa:0,this._internalFormat="RGBA16F",this._format="RGBA",this._type="FLOAT",this.sceneFramebuffer=null,this.blitFramebuffer=null,this.toneMappingFramebuffer=null,this._initialized=!1,this.billboardsTextureAtlas=new Vr,this.fontAtlas=new Tc(s.fontsSrc),this.strokeTextureAtlas=new Vr,this._entityCollections=[[]],this._currentOutput="screen",this._fnScreenFrame=null,this.labelWorker=new Ka(4),this.screenDepthFramebuffer=null,this.screenFramePositionBuffer=null,this.screenTexture={},this.outputTexture=null,this._readPickingBuffer=this._readPickingBuffer_webgl2,(s.autoActivate||Gt(s.autoActivate))&&this.start()}enableBlendOneSrcAlpha(){let t=this.handler.gl;t.enable(t.BLEND),t.blendEquation(t.FUNC_ADD),t.blendFunc(t.ONE,t.ONE_MINUS_SRC_ALPHA)}enableBlendDefault(){let t=this.handler.gl;t.enable(t.BLEND),t.blendEquation(t.FUNC_ADD),t.blendFuncSeparate(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA,t.ONE,t.ONE)}setRelativeCenter(t){this.events.dispatch(this.events.changerelativecenter,t||this.activeCamera.eye)}setEventsActivity(t){this.events.active=t}addDepthCallback(t,s){let n=Ec++;return this._depthCallbacks.push({id:n,callback:s,sender:t}),n}removeDepthCallback(t){for(let s=0;s<this._depthCallbacks.length;s++)if(t===this._depthCallbacks[s].id){this._depthCallbacks.splice(s,1);break}}addPickingCallback(t,s){let n=Cc++;return this._pickingCallbacks.push({id:n,callback:s,sender:t}),n}removePickingCallback(t){for(let s=0;s<this._pickingCallbacks.length;s++)if(t===this._pickingCallbacks[s].id){this._pickingCallbacks.splice(s,1);break}}getPickingObject(t,s,n){return this.colorObjects.get(`${t}_${s}_${n}`)}getPickingObjectArr(t){return this.colorObjects.get(`${t[0]}_${t[1]}_${t[2]}`)}getPickingObject3v(t){return this.colorObjects.get(`${t.x}_${t.y}_${t.z}`)}assignPickingColor(t){if(!t._pickingColor||t._pickingColor.isZero()){let s=0,n=0,o=0,a="0_0_0";for(;!(s||n||o)||this.colorObjects.has(a);)s=Ni(1,255),n=Ni(1,255),o=Ni(1,255),a=`${s}_${n}_${o}`;t._pickingColor?t._pickingColor.set(s,n,o):t._pickingColor=new v(s,n,o),t._pickingColorU=new Float32Array([s/255,n/255,o/255]),this.colorObjects.set(a,t)}}clearPickingColor(t){if(t._pickingColor&&!t._pickingColor.isZero()){let s=t._pickingColor;s.isZero()||(this.colorObjects.delete(`${s.x}_${s.y}_${s.z}`),s.x=s.y=s.z=0)}}getWidth(){return this.handler.canvas.clientWidth}getHeight(){return this.handler.canvas.clientHeight}getCenter(){let t=this.handler.canvas;return new H(Math.round(.5*t.width),Math.round(.5*t.height))}getClientCenter(){let t=this.handler.canvas;return new H(Math.round(.5*t.clientWidth),Math.round(.5*t.clientHeight))}addControl(t){t.addTo(this)}addControls(t){for(let s=0;s<t.length;s++)t[s].addTo(this)}removeControl(t){t.remove()}isInitialized(){return this._initialized}initialize(){if(!this._initialized){if(this._initialized=!0,this.handler.initialize(),this.billboardsTextureAtlas.assignHandler(this.handler),this.fontAtlas.assignHandler(this.handler),this.strokeTextureAtlas.assignHandler(this.handler),this.handler.setFrameCallback(()=>{this.draw()}),this.events.initialize(),this.events.on("charkeypress",W.KEY_APOSTROPHE,function(){ie.setVisibility(!ie.getVisibility())}),this.handler.addProgram(new X("screenFrame",{uniforms:{texture:"sampler2d"},attributes:{corners:"vec3"},vertexShader:`attribute vec2 corners;
            
            varying vec2 tc;
            void main(void) {
                gl_Position = vec4(corners, 0.0, 1.0);
                tc = corners * 0.5 + 0.5;
            }`,fragmentShader:`precision highp float;
            uniform sampler2D texture;
            
            varying vec2 tc;
            
            void main(void) {
                gl_FragColor = texture2D( texture, tc );
            }`})),this.pickingFramebuffer=new Rt(this.handler,{width:640,height:480,targets:[{readAsync:!0}]}),this.pickingFramebuffer.init(),this.depthFramebuffer=new Rt(this.handler,{width:640,height:480,targets:[{internalFormat:"RGBA",type:"UNSIGNED_BYTE",attachment:"COLOR_ATTACHMENT",readAsync:!0},{internalFormat:"RGBA16F",type:"FLOAT",attachment:"COLOR_ATTACHMENT",readAsync:!0}],useDepth:!0}),this.depthFramebuffer.init(),this.screenDepthFramebuffer=new Rt(this.handler,{useDepth:!1}),this.screenDepthFramebuffer.init(),this.handler.gl.type==="webgl")this._readPickingBuffer=this._readPickingBuffer_webgl1,this.sceneFramebuffer=new Rt(this.handler),this.sceneFramebuffer.init(),this._fnScreenFrame=this._screenFrameNoMSAA,this.screenTexture={screen:this.sceneFramebuffer.textures[0],picking:this.pickingFramebuffer.textures[0],depth:this.screenDepthFramebuffer.textures[0]};else{let t=this.getMaxMSAA(this._internalFormat);this._msaa>t&&(this._msaa=t),this.handler.addPrograms([new X("toneMapping",{uniforms:{hdrBuffer:"sampler2d",exposure:"float",gamma:"float",whitepoint:"float"},attributes:{corners:"vec3"},vertexShader:`#version 300 es
in vec2 corners;out vec2 tc;void main(void){gl_Position=vec4(corners,0.0,1.0);tc=corners*0.5+0.5;}`,fragmentShader:`#version 300 es
precision highp float;
#ifndef saturate
#define saturate(a) clamp(a, 0.0, 1.0)
#endif
uniform sampler2D hdrBuffer;uniform float whitepoint;uniform float exposure;uniform float gamma;vec3 LinearToneMapping(vec3 color){return exposure*color;}vec3 ReinhardToneMapping2(vec3 color){return vec3(1.0)-exp(-color*exposure);}vec3 ReinhardToneMapping(vec3 color){color*=exposure;return saturate(color/(vec3(1.0)+color));}
#define Uncharted2Helper(x) max(((x * (0.15 * x + 0.10 * 0.50) + 0.20 * 0.02) / (x * (0.15 * x + 0.50) + 0.20 * 0.30)) - 0.02 / 0.30, vec3(0.0))
vec3 Uncharted2ToneMapping(vec3 color){color*=exposure;return saturate(Uncharted2Helper(color)/Uncharted2Helper(vec3(whitepoint)));}vec3 OptimizedCineonToneMapping(vec3 color){color*=exposure;color=max(vec3(0.0),color-0.004);return pow((color*(6.2*color+0.5))/(color*(6.2*color+1.7)+0.06),vec3(2.2));}vec3 ACESFilmicToneMapping(vec3 color){color*=exposure;return saturate((color*(2.51*color+0.03))/(color*(2.43*color+0.59)+0.14));}in vec2 tc;layout(location=0)out vec4 fragColor;void main(void){vec4 hdrColor=texture(hdrBuffer,tc);float oneByGamma=gamma/gamma;float oneByWhitePoint=whitepoint/whitepoint;vec3 mapped=ReinhardToneMapping2(hdrColor.rgb)*oneByGamma*oneByWhitePoint;mapped=pow(mapped,vec3(1.0/gamma));fragColor=vec4(mapped,hdrColor.a);}`})]),this.handler.addPrograms([new X("depth",{uniforms:{depthTexture:"sampler2D"},attributes:{corners:"vec2"},vertexShader:`#version 300 es
            
            in vec2 corners;
            
            out vec2 tc;

            void main(void) {
                gl_Position = vec4(corners, 0.0, 1.0);
                tc = corners * 0.5 + 0.5;
            }`,fragmentShader:`#version 300 es

            precision highp float;

            uniform sampler2D depthTexture;
           
            in vec2 tc;

            layout(location = 0) out vec4 fragColor;

            float LinearizeDepth(in vec2 uv)
            {
                return texture(depthTexture, tc).r;
            }
            
            void main(void) {
                float c = LinearizeDepth(tc);
                fragColor = vec4(c, c, c, 1.0);
            }`})]),this.sceneFramebuffer=new Ta(this.handler,{size:1,msaa:this._msaa,internalFormat:this._internalFormat,filter:"LINEAR"}),this.sceneFramebuffer.init(),this.blitFramebuffer=new Rt(this.handler,{size:1,useDepth:!1,targets:[{internalFormat:this._internalFormat,format:this._format,type:this._type,filter:"NEAREST"}]}),this.blitFramebuffer.init(),this.toneMappingFramebuffer=new Rt(this.handler,{useDepth:!1}),this.toneMappingFramebuffer.init(),this._fnScreenFrame=this._screenFrameMSAA,this.screenTexture={screen:this.toneMappingFramebuffer.textures[0],picking:this.pickingFramebuffer.textures[0],depth:this.screenDepthFramebuffer.textures[0],frustum:this.depthFramebuffer.textures[0]}}this.handler.ONCANVASRESIZE=()=>{this._resizeStart(),this.events.dispatch(this.events.resize,this.handler.canvas),this._resizeEnd(),this.events.dispatch(this.events.resizeend,this.handler.canvas)},this.screenFramePositionBuffer=this.handler.createArrayBuffer(new Float32Array([1,1,-1,1,1,-1,-1,-1]),2,4),this.outputTexture=this.screenTexture.screen,this._initializeRenderNodes(),this._initializeControls()}}_initializeControls(){let t=this.controls;this.controls={};for(let s in t)this.addControl(t[s])}resize(){this._resizeEnd()}setCurrentScreen(t){this._currentOutput=t,this.screenTexture[t]&&(this.outputTexture=this.screenTexture[t])}_resizeStart(){let t=this.handler.canvas;this.activeCamera.setViewportSize(t.width,t.height),this.sceneFramebuffer.setSize(.5*t.width,.5*t.height),this.blitFramebuffer&&this.blitFramebuffer.setSize(.5*t.width,.5*t.height,!0)}_resizeEnd(){let t=this.handler.canvas;this.activeCamera.setViewportSize(t.width,t.height),this.sceneFramebuffer.setSize(t.width,t.height),this.blitFramebuffer&&this.blitFramebuffer.setSize(t.width,t.height,!0),this.toneMappingFramebuffer&&this.toneMappingFramebuffer.setSize(t.width,t.height,!0),this.screenDepthFramebuffer&&this.screenDepthFramebuffer.setSize(t.clientWidth,t.clientHeight,!0),this.handler.gl.type==="webgl"?(this.screenTexture.screen=this.sceneFramebuffer.textures[0],this.screenTexture.picking=this.pickingFramebuffer.textures[0],this.screenTexture.depth=this.screenDepthFramebuffer.textures[0],this.screenTexture.frustum=this.depthFramebuffer.textures[0]):(this.screenTexture.screen=this.toneMappingFramebuffer.textures[0],this.screenTexture.picking=this.pickingFramebuffer.textures[0],this.screenTexture.depth=this.screenDepthFramebuffer.textures[0],this.screenTexture.frustum=this.depthFramebuffer.textures[0]),this.setCurrentScreen(this._currentOutput)}removeNode(t){t.remove()}addNode(t){this.renderNodes[t.name]?ie.logWrn(`Node name ${t.name} already exists.`):(t.assign(this),this._renderNodesArr.unshift(t),this.renderNodes[t.name]=t)}_initializeRenderNodes(){for(let t=0;t<this._renderNodesArr.length;t++)this._renderNodesArr[t].initialize()}addNodeBefore(t,s){if(this.renderNodes[t.name])ie.logWrn(`Node name ${t.name} already exists.`);else{t.assign(this),this.renderNodes[t.name]=t;for(let n=0;n<this._renderNodesArr.length;n++)if(this._renderNodesArr[n].isEqual(s)){this._renderNodesArr.splice(n,0,t);break}this._renderNodesArr.unshift(t)}}addNodes(t){for(let s=0;s<t.length;s++)this.addNode(t[s])}getMaxMSAA(t){let s=this.handler.gl;return s.getInternalformatParameter(s.RENDERBUFFER,s[t],s.SAMPLES)[0]}getMSAA(){return this._msaa}enqueueEntityCollectionsToDraw(t,s=0){this._entityCollections[s]||(this._entityCollections[s]=[]),this._entityCollections[s].push(...t)}markForDepthRefresh(){this._depthRefreshRequired=!0}_drawEntityCollections(t){let s=this._entityCollections[t];if(s.length){let n=this.handler.gl;this.enableBlendDefault();let o=s.length;for(;o--;)s[o]._fadingOpacity&&s[o].pointCloudHandler.draw();for(o=s.length;o--;){let l=s[o];s[o]._fadingOpacity&&(l.events.dispatch(l.events.draw,l),s[o].geoObjectHandler.draw())}for(n.activeTexture(n.TEXTURE0),n.bindTexture(n.TEXTURE_2D,this.billboardsTextureAtlas.texture),o=s.length;o--;){let l=s[o];l._fadingOpacity&&l.billboardHandler.draw()}let a=this.fontAtlas.atlasesArr;for(o=0;o<a.length;o++)n.activeTexture(n.TEXTURE0+o),n.bindTexture(n.TEXTURE_2D,a[o].texture);for(o=s.length;o--;)s[o]._fadingOpacity&&s[o].labelHandler.draw();for(n.activeTexture(n.TEXTURE0),n.bindTexture(n.TEXTURE_2D,this.strokeTextureAtlas.texture),o=s.length;o--;)s[o]._fadingOpacity&&s[o].rayHandler.draw();for(o=s.length;o--;)s[o]._fadingOpacity&&s[o].polylineHandler.draw();for(o=s.length;o--;)s[o]._fadingOpacity&&s[o].stripHandler.draw()}}_drawPickingEntityCollections(t){let s=this._entityCollections[t];if(s.length){let n=s.length;for(;n--;)s[n]._fadingOpacity&&s[n].billboardHandler.drawPicking();for(n=s.length;n--;)s[n]._fadingOpacity&&s[n].geoObjectHandler.drawPicking();for(n=s.length;n--;)s[n]._fadingOpacity&&s[n].labelHandler.drawPicking();for(n=s.length;n--;)s[n]._fadingOpacity&&s[n].rayHandler.drawPicking();for(n=s.length;n--;)s[n]._visibility&&s[n].polylineHandler.drawPicking();for(n=s.length;n--;)s[n]._visibility&&s[n].stripHandler.drawPicking()}}_drawDepthEntityCollections(t){let s=this._entityCollections[t];if(s.length){let n=s.length;for(;n--;)s[n]._fadingOpacity&&s[n].geoObjectHandler.drawDepth()}}_clearEntityCollectionQueue(t){this._entityCollections[t].length=0,this._entityCollections[t]=[]}draw(){this.activeCamera.checkMoveEnd();let t=this.events,s=t.pointerEvent(),n=!t.mouseState.leftButtonDown&&!t.mouseState.rightButtonDown,o=t.touchState.touchStart||t.touchState.touchEnd;const a=s&&n||o||this._depthRefreshRequired;this._depthRefreshRequired=!1,t.handleEvents();let l=this.sceneFramebuffer;l.activate();let c=this.handler.gl;c.clearColor(this.clearColor[0],this.clearColor[1],this.clearColor[2],this.clearColor[3]),c.clear(c.COLOR_BUFFER_BIT|c.DEPTH_BUFFER_BIT),this.enableBlendDefault(),t.dispatch(t.draw,this),this.activeCamera.checkFly();let d=this.activeCamera.frustums,u=this._renderNodesArr,_=d.length;for(;_--;){this.activeCamera.setCurrentFrustum(_),c.clear(c.DEPTH_BUFFER_BIT);let f=u.length;for(;f--;)u[f].preDrawNode();for(f=u.length;f--;)this.enableBlendDefault(),u[f].drawNode();this._drawEntityCollections(0),t.dispatch(t.drawtransparent,this),a&&this._drawPickingBuffer(0),this._drawDepthBuffer(0),this._clearEntityCollectionQueue(0)}for(let f=1;f<this._entityCollections.length;f++){c.clear(c.DEPTH_BUFFER_BIT);let g=d.length;for(;g--;)this.activeCamera.setCurrentFrustum(g),this._drawEntityCollections(f),a&&this._drawPickingBuffer(f),this._drawDepthBuffer(f);this._clearEntityCollectionQueue(f)}l.deactivate(),this.blitFramebuffer&&l.blitTo(this.blitFramebuffer,0),a&&(this._readPickingBuffer(),this._readDepthBuffer()),this._fnScreenFrame(),t.dispatch(t.postdraw,this),t.mouseState.wheelDelta=0,t.mouseState.justStopped=!1,t.mouseState.moving=!1,t.touchState.moving=!1}getImageDataURL(t="image/png",s=1){return this.draw(),this.handler.canvas?this.handler.canvas.toDataURL(t,s):""}_screenFrameMSAA(){let t=this.handler,s=t.programs.toneMapping,n=s._program,o=t.gl;o.disable(o.DEPTH_TEST),o.bindBuffer(o.ARRAY_BUFFER,this.screenFramePositionBuffer),o.vertexAttribPointer(n.attributes.corners,2,o.FLOAT,!1,0,0),this.toneMappingFramebuffer.activate(),o.clearColor(0,0,0,0),o.clear(o.COLOR_BUFFER_BIT),s.activate(),o.activeTexture(o.TEXTURE0),o.bindTexture(o.TEXTURE_2D,this.blitFramebuffer.textures[0]),o.uniform1i(n.uniforms.hdrBuffer,0),o.uniform1f(n.uniforms.gamma,this.gamma),o.uniform1f(n.uniforms.exposure,this.exposure),o.uniform1f(n.uniforms.whitepoint,this.whitepoint),o.drawArrays(o.TRIANGLE_STRIP,0,4),this.toneMappingFramebuffer.deactivate(),s=t.programs.screenFrame,n=s._program,s.activate(),o.activeTexture(o.TEXTURE0),o.bindTexture(o.TEXTURE_2D,this.outputTexture),o.uniform1i(n.uniforms.texture,0),o.drawArrays(o.TRIANGLE_STRIP,0,4),o.enable(o.DEPTH_TEST)}_screenFrameNoMSAA(){let t=this.handler,s=t.programs.screenFrame,n=s._program,o=t.gl;o.disable(o.DEPTH_TEST),s.activate(),o.activeTexture(o.TEXTURE0),o.bindTexture(o.TEXTURE_2D,this.outputTexture),o.uniform1i(n.uniforms.texture,0),o.bindBuffer(o.ARRAY_BUFFER,this.screenFramePositionBuffer),o.vertexAttribPointer(n.attributes.corners,2,o.FLOAT,!1,0,0),o.drawArrays(o.TRIANGLE_STRIP,0,4),o.enable(o.DEPTH_TEST)}_drawPickingBuffer(t){this.pickingFramebuffer.activate();let s=this.handler.gl;if(this.activeCamera.isFirstPass&&t===0?(s.clearColor(0,0,0,1),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT)):s.clear(s.DEPTH_BUFFER_BIT),s.disable(s.BLEND),t===0){let n=this._pickingCallbacks;for(let o=0,a=n.length;o<a;o++)n[o].callback.call(n[o].sender)}this._drawPickingEntityCollections(t),s.enable(s.BLEND),this.pickingFramebuffer.deactivate()}_drawDepthBuffer(t){this.depthFramebuffer.activate();let s=this.handler,n=s.gl;if(n.disable(n.BLEND),this.activeCamera.isFirstPass&&t===0?(n.clearColor(0,0,0,1),n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT)):n.clear(n.DEPTH_BUFFER_BIT),t===0){let o=this._depthCallbacks,a=o.length;for(;a--;)o[a].callback.call(o[a].sender)}if(this._drawDepthEntityCollections(t),this.depthFramebuffer.deactivate(),this._currentOutput==="depth"||this._currentOutput==="frustum"){this.screenDepthFramebuffer.activate();let o=s.programs.depth,a=o._program;n.bindBuffer(n.ARRAY_BUFFER,this.screenFramePositionBuffer),n.vertexAttribPointer(a.attributes.corners,2,n.FLOAT,!1,0,0),o.activate(),n.activeTexture(n.TEXTURE0),n.bindTexture(n.TEXTURE_2D,this.depthFramebuffer.textures[1]),n.uniform1i(a.uniforms.depthTexture,0),n.drawArrays(n.TRIANGLE_STRIP,0,4),this.screenDepthFramebuffer.deactivate()}n.enable(n.BLEND)}_readDepthBuffer(t){this.depthFramebuffer.readPixelBuffersAsync(t)}_readPickingBuffer_webgl1(){this.pickingFramebuffer.readPixelBuffersAsync()}_readPickingBuffer_webgl2(){this.pickingFramebuffer.readPixelBuffersAsync()}readPickingColor(t,s,n){var o;let a=this.pickingFramebuffer.width,l=this.pickingFramebuffer.height;t=Math.round(t*a);let c=4*((s=Math.round(s*l))*a+t),d=(o=this.pickingFramebuffer)==null?void 0:o.pixelBuffers[0].data;d&&(n[0]=d[c],n[1]=d[c+1],n[2]=d[c+2])}readDepth(t,s,n){let o=new Float32Array(4),a=new Uint8Array(4);this.depthFramebuffer.readData(t,s,a,0),this.depthFramebuffer.readData(t,s,o,1),n[0]=o[0],n[1]=Math.round(a[0]/10)-1}getDistanceFromPixel(t){let s=this.activeCamera,n=this.handler.canvas,o=t.x/n.width,a=(n.height-t.y)/n.height;if(He[0]=He[1]=0,this.readDepth(o,a,He),He[1]===-1)return;let l=He[0],c=s.frustums[He[1]];if(!c)return;let d=new et(2*o-1,2*a-1,2*l-1,1),u=c.inverseProjectionMatrix.mulVec4(d),_=-u.z/u.w;if(s.isOrthographic)return _;let f=t.direction||s.unproject(t.x,t.y);return _/Math.max(1e-6,f.dot(s.getForward()))}getCartesianFromPixel(t){let s=this.getDistanceFromPixel(t);if(s){if(this.activeCamera.isOrthographic){let n=new v;return this.activeCamera.unproject(t.x,t.y,s,n),n}return(t.direction||this.activeCamera.unproject(t.x,t.y)).scaleTo(s).addA(this.activeCamera.eye)}}getCartesianFromPixelAsync(t){return new Promise((s,n)=>{this._readDepthBuffer(()=>{s(this.getCartesianFromPixel(t))})})}getDepthMinDistance(){let t=this.handler.canvas,s=t.width,n=t.height,o=or,a=n*s,l=new H;for(let c=0;c<a;c++){l.x=c%s,l.y=Math.floor(c/s);let d=this.getDistanceFromPixel(l);d&&d<o&&(o=d)}return o<or?o:0}getDepthMinDistanceAsync(){return new Promise((t,s)=>{this._readDepthBuffer(()=>{t(this.getDepthMinDistance())})})}async setOrthographicProjection(t){if(t!==this.activeCamera.isOrthographic){let s=await this.getDepthMinDistanceAsync();s&&t&&(this.activeCamera.focusDistance=s),this.activeCamera.isOrthographic=t,this.events.dispatch(this.events.projchanged,this.activeCamera)}}start(){this._initialized||this.initialize(),this.handler.start()}destroy(){this.labelWorker.destroy();for(let t in this.controls)this.controls[t].remove();for(let t=0;t<this._renderNodesArr.length;t++)this._renderNodesArr[t].remove();this.div=null,this._renderNodesArr=[],this.renderNodes={},this.controls={},this.controlsBag={},this.colorObjects.clear(),this._pickingCallbacks=[],this.pickingFramebuffer=null,this._tempPickingPix_=null,this._depthCallbacks=[],this.depthFramebuffer=null,this.sceneFramebuffer=null,this.blitFramebuffer=null,this.toneMappingFramebuffer=null,this._entityCollections=[[]],this.handler.ONCANVASRESIZE=null,this.handler.destroy(),this._initialized=!1}}const fo="/res",Ye=class qc{constructor(t){this.$target=null,this._instanceID=`__globus${qc.__counter__++?qc.__counter__:""}__`,window[this._instanceID]=this,this._canvas=document.createElement("canvas"),this._canvas.id=`canvas${this._instanceID}`,this._canvas.style.width="100%",this._canvas.style.height="100%",this._canvas.style.display="block",this._canvas.style.opacity="0.0",this._canvas.style.transition="opacity 150ms",this.$inner=document.createElement("div"),this.$inner.classList.add("og-inner"),this.$inner.appendChild(this._canvas),this.$inner.attributions=document.createElement("div"),t.attributionContainer?t.attributionContainer.appendChild(this.$inner.attributions):(this.$inner.attributions.classList.add("og-attribution"),this.$inner.appendChild(this.$inner.attributions)),t.target&&this.attachTo(t.target);const s=c=>{c.preventDefault()};this._canvas.onmouseenter=function(){document.addEventListener("mousewheel",s,{capture:!1,passive:!1})},this._canvas.onmouseleave=function(){document.removeEventListener("mousewheel",s)},this.renderer=new Ac(new Be(this._canvas,{autoActivate:!1,pixelRatio:t.dpi||window.devicePixelRatio+.15,context:{alpha:t.transparentBackground,antialias:!1,premultipliedAlpha:!0,preserveDrawingBuffer:!1}}),{autoActivate:!1,msaa:t.msaa,fontsSrc:t.fontsSrc,gamma:t.gamma,exposure:t.exposure,...t.transparentBackground&&{clearColor:[0,0,0,0]}}),this.renderer.div=this.$inner,t.skybox&&this.renderer.addNode(t.skybox),this._planetName=t.name?t.name:"globus_planet_"+qc.__counter__,this.planet=new Ri({name:this._planetName,frustums:t.frustums,ellipsoid:t.ellipsoid,maxGridSize:t.maxGridSize,nightTextureSrc:t.nightTextureSrc===null?null:t.nightTextureSrc||`${t.resourcesSrc||fo}/night.png`,specularTextureSrc:t.specularTextureSrc===null?null:t.specularTextureSrc||`${t.resourcesSrc||fo}/spec.png`,minAltitude:t.minAltitude,maxAltitude:t.maxAltitude||15e6,maxEqualZoomAltitude:t.maxEqualZoomAltitude,minEqualZoomAltitude:t.minEqualZoomAltitude,minEqualZoomCameraSlope:t.minEqualZoomCameraSlope,quadTreeStrategyPrototype:t.quadTreeStrategyPrototype,maxLoadingRequests:t.maxLoadingRequests,atmosphereEnabled:t.atmosphereEnabled,transitionOpacityEnabled:t.transitionOpacityEnabled,atmosphereParameters:t.atmosphereParameters,minDistanceBeforeMemClear:t.minDistanceBeforeMemClear,vectorTileSize:t.vectorTileSize,maxNodesCount:t.maxNodesCount,transparentBackground:t.transparentBackground}),t.terrain?Array.isArray(t.terrain)?this.planet.setTerrain(t.terrain[0]):this.planet.setTerrain(t.terrain):this.planet.setTerrain(new Mi),this.renderer.addNode(this.planet),t.controls?this.planet.addControls(t.controls):this.planet.addControls([new ma,new Yi,new pa,new da,new fa,new Ho,new Fr]);const n=this.renderer.controls;let o,a;for(let c in n)n[c]instanceof Dr&&(o=n[c]),n[c]instanceof Yi&&(a=n[c]);o?this.sun=o:(this.sun=new Dr,this.planet.addControl(this.sun)),t.sun&&(t.sun.active===void 0||t.sun.active||this.sun.deactivate(),t.sun.stopped===!0&&this.sun.stop()),a?this.navigation=a:(this.navigation=new Yi,this.planet.addControl(this.navigation)),t.navigation&&(t.navigation.active===void 0||t.navigation.active||this.navigation.deactivate(),t.navigation.inertia!==void 0&&(this.navigation.inertia=t.navigation.inertia),t.navigation.dragInertia!==void 0&&(this.navigation.dragInertia=t.navigation.dragInertia),t.navigation.minSlope!==void 0&&(this.navigation.minSlope=t.navigation.minSlope),t.navigation.mass!==void 0&&(this.navigation.mass=t.navigation.mass),t.navigation.zoomSpeed!==void 0&&(this.navigation.zoomSpeed=t.navigation.zoomSpeed),t.navigation.mode!==void 0&&this.navigation.setMode(t.navigation.mode),t.navigation.poleThreshold!==void 0&&(this.navigation.poleThreshold=t.navigation.poleThreshold),t.navigation.disableRotation!==void 0&&(this.navigation.disableRotation=t.navigation.disableRotation),t.navigation.disableTilt!==void 0&&(this.navigation.disableTilt=t.navigation.disableTilt)),t.layers&&this.planet.addLayers(t.layers);let l=t.viewExtent;l&&(l instanceof Array?this.planet.viewExtentArr(l):this.planet.viewExtent(l)),(t.autoActivate||Gt(t.autoActivate))&&this.start()}start(){this.renderer.start(),this.fadeIn()}fadeIn(){this._canvas.style.opacity="1.0"}fadeOut(){this._canvas.style.opacity="0"}attachTo(t,s){let n;this.detach(),n=t instanceof HTMLElement?t:document.getElementById(t)||document.querySelector(t),n?(this.$target=n,s&&this.$target.firstChild?this.$target.insertBefore(this.$inner,this.$target.firstChild):n.appendChild(this.$inner)):console.warn(`Target container not found. Provided target: ${t}`)}detach(){this.$target&&(this.$target.removeChild(this.$inner),this.$target=null)}destroy(){this.detach(),this.planet.layers.forEach(t=>t.remove()),this.planet.destroy(),this.renderer.destroy(),window[this._instanceID]=null}};Ye.__counter__=0;let go=Ye;new qr(3396200,3389508);new qr(1737400,1737400);var we=(h=>(h[h.byte=5120]="byte",h[h.ubyte=5121]="ubyte",h[h.short=5122]="short",h[h.ushort=5123]="ushort",h[h.uint=5125]="uint",h[h.float=5126]="float",h))(we||{}),fe=(h=>(h.scalar="SCALAR",h.vec2="VEC2",h.vec3="VEC3",h.vec4="VEC4",h.mat2="MAT2",h.mat3="MAT3",h.mat4="MAT4",h))(fe||{}),Ur=(h=>(h[h.points=0]="points",h[h.lines=1]="lines",h[h.lineLoop=2]="lineLoop",h[h.lineStrip=3]="lineStrip",h[h.triangles=4]="triangles",h[h.triangleStrip=5]="triangleStrip",h[h.triangleFan=6]="triangleFan",h))(Ur||{});(globalThis.og??(globalThis.og={})).version="0.28.4";const createMapPool=(h,t,s)=>{const o=getFlatLayersArray(t.map.getLayers().getArray()).filter(a=>a.get("type")!=="Group").map(a=>a.get("_jsonDefinition")).filter(Boolean);return Array.from({length:h},()=>{const a=document.createElement("eox-map");return Object.assign(a.style,{width:"256px",height:"256px",position:"absolute",top:"-9999px",left:"-9999px"}),Object.assign(a,{projection:"EPSG:3857",layers:o}),s.appendChild(a),{tileMap:a,tileQueue:[],loadNextTile(){const l=this.tileQueue[0];requestTileFromMap(a,l.layerId,l,this)}}})};async function requestTileFromMap(h,t,s,n){const o=h.map;if(!o){h.addEventListener("mapmounted",()=>requestTileFromMap(h,t,s,n),{once:!0});return}o.getLayers().forEach(c=>{c.setVisible(c.get("id")===t)});const l=createXYZ().getTileCoordExtent([s.tile.z,s.tile.x,s.tile.y]);o.getView().fit(l,{callback:()=>{o.once("rendercomplete",function(){const c=document.createElement("canvas"),d=o.getSize();c.width=d[0],c.height=d[1];const u=c.getContext("2d");Array.prototype.forEach.call(o.getViewport().querySelectorAll(".ol-layer canvas, canvas.ol-layer"),function(_){if(_.width>0){const f=_.parentNode.style.opacity||_.style.opacity;u.globalAlpha=f===""?1:Number(f);let g;const m=_.style.transform;m?g=m.match(/^matrix\(([^(]*)\)$/)[1].split(",").map(Number):g=[parseFloat(_.style.width)/_.width,0,0,parseFloat(_.style.height)/_.height,0,0],CanvasRenderingContext2D.prototype.setTransform.apply(u,g);const p=_.parentNode.style.backgroundColor;p&&(u.fillStyle=p,u.fillRect(0,0,_.width,_.height)),u.drawImage(_,0,0)}}),u.globalAlpha=1,u.setTransform(1,0,0,1,0,0),s.callback(c),n.tileQueue.shift(),n.tileQueue.length&&n.loadNextTile()}),o.renderSync()}})}function distributeTileToIdealMap(h,t,s,n){const{x:o,y:a,z:l}=s,c={layerId:t,tile:s,callback:n};let d=0,u=null;for(let _=0;_<h.length;_++){const f=h[_];if(!f.tileQueue.length){u=f;break}const g=f.tileQueue[f.tileQueue.length-1],m=Math.abs(g.tile.x-o)+Math.abs(g.tile.y-a)+Math.abs(g.tile.z-l);(d===0||m<d)&&(d=m,u=f)}return u.tileQueue.push(c),u}let globus;const createGlobe=({EOxMap:h,target:t,mapPool:s})=>{globus=new go({target:t,layers:h.getFlatLayersArray(h.map.getLayers().getArray()).filter(c=>c.get("type")!=="Group").map(c=>createGlobusLayer(c,s)).filter(c=>c!==void 0),sun:{active:!1},atmosphereEnabled:!1,transparentBackground:!0,resourcesSrc:"https://cdn.jsdelivr.net/npm/@openglobus/og@0.27.21/lib/res",fontsSrc:"https://cdn.jsdelivr.net/npm/@openglobus/og@0.27.21/lib/res/fonts"});const n=2105e4/Math.pow(2,h.map.getView().getZoom()-1),o=h.map.getView().getCenter(),a=transform(o,h.map.getView().getProjection().getCode(),"EPSG:4326");globus.planet.camera.setLonLat(new L(a[0],a[1],n),new L(a[0],a[1],0),v.NORTH);const l=document.createElement("style");return l.textContent=`
    .og-inner {
      height: 100%;
    }
    .og-inner *:not(canvas) {
      display: none !important;
    }
  `,t.appendChild(l),globus},refreshGlobe=()=>{globus&&globus.planet.layers.forEach(h=>{h instanceof ss&&(h.abortLoading(),h.animated=!0,setTimeout(()=>h.animated=!1,200))})},createGlobusLayer=(h,t)=>{const s=h.getSource&&h.getSource(),n=h.get("id");if(s instanceof OSM)return new _c(n,{isBaseLayer:h.get("base"),visibility:h.getVisible(),opacity:h.getOpacity()});if(s instanceof XYZ)return new Ds(n,{isBaseLayer:h.get("base"),url:s.getUrls()[0],visibility:h.getVisible(),opacity:h.getOpacity()});if(s instanceof TileWMS){const o=s.getParams(),l=s.getUrls()[0],c=o.LAYERS||o.layers||"default";return new me(n,{isBaseLayer:h.get("base"),layers:c,url:l,visibility:h.getVisible(),opacity:h.getOpacity(),version:o.VERSION||o.Version||"1.1.1",extra:{...o}})}if(s instanceof VectorSource&&s.getUrl()){let o;if(fetch(s.getUrl().toString()).then(a=>a.json()).then(a=>{const l=a.crs;if(l&&(l.type=="name"?o=get(l.properties.name):l.type==="EPSG"&&(o=get("EPSG:"+l.properties.code))),o&&equivalent(o,get("EPSG:4326"))||!l){const u=globus.planet.getLayerByName(n);u&&globus.planet.removeLayer(u);const _=new _t(n,{visibility:h.getVisible(),opacity:h.getOpacity(),isBaseLayer:h.get("base")});_.addTo(globus.planet);var c=a.features;for(let f=0;f<c.length;f++){var d=c[f];_.add(new G({geometry:{type:d.geometry.type,coordinates:d.geometry.coordinates}}))}return _}else return}),o&&equivalent(o,get("EPSG:4326")))return}return new ss(n,{opacity:h.getOpacity(),visibility:h.getVisible(),async drawTile(o,a){if(!o.segment)return;const l={x:o.segment.tileX,y:o.segment.tileY,z:o.segment.tileZoom},c=distributeTileToIdealMap(t,h.get("id"),l,d=>{var u;(u=o.segment)!=null&&u.initialized&&a(d)});c.tileQueue.length===1&&c.loadNextTile()}})},enableGlobe=h=>{var t;if(h.shadowRoot){let s=h.shadowRoot.querySelector("#globe");s||(s=document.createElement("div"),s.id="globe",s.style.width="100%",s.style.height="100%",s.style.display="block",(t=h.renderRoot)==null||t.appendChild(s)),h.registerProjectionFromCode("EPSG:3857"),h.globe=window.eoxMapGlobe.create({EOxMap:h,target:s}),h.shadowRoot.querySelector("#map").style.display="none",h.globeEnabled=!0}},disableGlobe=h=>{if(h.globe){const t=h.globe,s=t.planet;let n=s.getCartesianFromPixelTerrain(t.renderer.handler.getCenter());const o=n?n.normal().scaleTo(n.length()+n.distance(s.camera.eye)):s.camera.eye;s.flyCartesian(o,{amplitude:0,completeCallback:()=>{n&&s.camera.look(n);const a=t.planet.camera.getLonLat(),l=Math.log2(2105e4/a.height)+1,c=[a.lon,a.lat],d=transform(c,"EPSG:4326",h.OLprojection);h.map.getView().setCenter(d),h.map.getView().setZoom(l),h.globe=null;const u=h.shadowRoot.querySelector("#globe");u&&(u.style.display="none",u.remove());const _=h.shadowRoot.querySelector("#map");_&&(_.style.display=""),h.globeEnabled=!1}})}};function debounce(h,t){let s;return function(...o){const a=()=>{clearTimeout(s),h(...o)};clearTimeout(s),s=setTimeout(a,t)}}const setupLayerListeners=(h,t,s)=>{const n=debounce(()=>{refreshGlobe()},200);h.on("change",()=>{if(h.styleVariables_){const o=h.get("id"),a=h.styleVariables_;if(!o||!a)return;s.forEach(l=>{l.tileQueue.length=0;const c=getLayerById(l.tileMap,o);c&&c.updateStyleVariables&&c.updateStyleVariables(a)}),n()}}),h.on("propertychange",({key:o})=>{const a=t.planet.getLayerByName(h.get("id"));if(a)switch(o){case"visible":a.setVisibility(h.getVisible());break;case"opacity":a.opacity=h.getOpacity();break}})},processLayers=(h,t,s)=>{h.forEach(n=>{n.get("id")&&setupLayerListeners(n,t,s),n.getLayers&&processLayers(n.getLayers().getArray(),t,s)})};addCommonStylesheet();var Fc,kc,Rc,Oc,zc,Nc,Vc,Hc,Uc,Mc,Ns;class EOxMap extends i{constructor(){super();Nt(this,Fc);Nt(this,kc);Nt(this,Rc);Nt(this,Oc);Nt(this,zc);Nt(this,Nc);Nt(this,Vc);Nt(this,Hc,[0,0]);Nt(this,Uc,0);Nt(this,Mc,!1);Nt(this,Ns,"EPSG:3857");this.map=new Map$1({controls:[],interactions:defaults({altShiftDragRotate:!1,pinchRotate:!1}),layers:[],view:new View({center:[0,0],zoom:0,projection:mt(this,Ns)})}),this.interactions={},this.selectInteractions={},this.mapControls={},this.globe=null}static get properties(){return{map:{attribute:!1,state:!0},config:{attribute:!1,type:Object},center:{attribute:!1,type:Array},layers:{attribute:!1,type:Array},zoom:{attribute:!1,type:Number},animationOptions:{attribute:!1,type:Object},controls:{attribute:!1,type:Object},interactions:{attribute:!1,type:Object},lonLatCenter:{attribute:!1,type:Array},lonLatExtent:{attribute:!1,type:Array},mapControls:{attribute:!1,state:!0,type:Object},preventScroll:{attribute:"prevent-scroll",type:Boolean},projection:{attribute:"projection",type:String},selectInteractions:{attribute:!1,state:!0,type:Object},sync:{attribute:"sync",type:String},zoomExtent:{attribute:!1,type:Array}}}set center(s){const n=setCenterMethod(s,this);n!==void 0&&(Ht(this,Hc,n),animateToStateMethod(this))}get center(){return mt(this,Hc)}set config(s){Ht(this,zc,setConfigMethod(s,this))}get config(){return mt(this,zc)}get lonLatCenter(){return getLonLatCenterMethod(this)}get lonLatExtent(){return getLonLatExtentMethod(this)}set zoom(s){s!==void 0&&(Ht(this,Uc,s),animateToStateMethod(this))}get zoom(){return mt(this,Uc)}set zoomExtent(s){Ht(this,Fc,setZoomExtentMethod(s,this))}get zoomExtent(){return getZoomExtentMethod(this)}set controls(s){Ht(this,kc,setControlsMethod(s,mt(this,kc),this))}get controls(){return mt(this,kc)}set layers(s){Ht(this,Rc,setLayersMethod(s,mt(this,Rc),this)),this.dispatchEvent(new CustomEvent("layerschanged",{detail:{layers:mt(this,Rc)}}))}get layers(){return mt(this,Rc)}set preventScroll(s){Ht(this,Oc,setPreventScrollMethod(s,this))}get preventScroll(){return mt(this,Oc)}set animationOptions(s){Ht(this,Nc,s)}get animationOptions(){return mt(this,Nc)}set projection(s){s==="globe"?(mt(this,Ns)!=="EPSG:3857"&&Ht(this,Ns,setProjectionMethod("EPSG:3857",mt(this,Ns),this)),setTimeout(()=>{enableGlobe(this)})):(mt(this,Mc)&&setTimeout(()=>{disableGlobe(this)}),Ht(this,Ns,setProjectionMethod(s,mt(this,Ns),this)))}get projection(){return mt(this,Mc)?"globe":mt(this,Ns)}get OLprojection(){return mt(this,Ns)}get globeEnabled(){return mt(this,Mc)}set globeEnabled(s){Ht(this,Mc,s)}set sync(s){Ht(this,Vc,setSyncMethod(s,this))}get sync(){return mt(this,Vc)}addOrUpdateLayer(s){return addOrUpdateLayerMethod(s,this)}removeInteraction(s){removeInteractionMethod(s,this)}removeSelect(s){removeSelectMethod(s,this)}removeControl(s){removeControlMethod(s,this)}getLayerById(s){return getLayerById(this,s)}firstUpdated(){firstUpdatedMethod(mt(this,Fc),this)}parseFeature(s){return parseFeature(s)}parseTextToFeature(s,n,o,a,l){parseTextToFeature(s,n,o,a,l)}registerProjectionFromCode(s){return registerProjectionFromCode(s)}registerProjection(s,n,o=void 0){registerProjection(s,n,o)}getFlatLayersArray(s){return getFlatLayersArray(s)}render(){return b`
      <style>
        :host {
          display: block;
          height: 100%;
        }
        .eox-map-tooltip {
          pointer-events: none !important;
        }
        ${olCss}
        ${eoxStyle}
        ${controlCss}
      </style>
      <div id="map" style="width: 100%; height: 100%"></div>
      <slot></slot>
    `}}Fc=new WeakMap,kc=new WeakMap,Rc=new WeakMap,Oc=new WeakMap,zc=new WeakMap,Nc=new WeakMap,Vc=new WeakMap,Hc=new WeakMap,Uc=new WeakMap,Mc=new WeakMap,Ns=new WeakMap;customElements.define("eox-map",EOxMap);const main=Object.freeze(Object.defineProperty({__proto__:null,EOxMap,buffer,transform,transformExtent},Symbol.toStringTag,{value:"Module"}));export{createGlobe as a,createMapPool as c,main as m,processLayers as p,refreshGlobe as r,transformExtent as t};

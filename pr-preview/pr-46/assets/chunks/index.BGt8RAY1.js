import{J as No,F as Re,g as K,i as Mo,t as me,d as Oo,l as Do,c as hr,L as Vr,M as Zt,a as vt,b as Lr,P as ut,e as Be,f as Ie,X as vr,m as G,h as O,p as A,j as hi,k as dr,G as Go,n as Uo,o as et,q as fr,r as os,s as k,u as y,v as ie,w as H,x as Le,O as At,y as Je,z as Bt,A as as,B as gr,C as pr,D as F,E as _,H as v,I as Ar,K as fe,N as ye,Q as di,R as ls,S as mr,T as ot,U as Bo,V as cs,W as ke,Y as ve,Z as te,_ as zo,$ as it,a0 as Qi,a1 as be,a2 as Ge,a3 as $o,a4 as fi,a5 as Xo,a6 as ko,a7 as _r,a8 as jo,a9 as zt,aa as Wo,ab as Zo,ac as Ho,ad as Yr,ae as en,af as Ur,ag as tn,ah as rn,ai as lt,aj as gi,ak as Vo,al as Yo,am as qo,an as Ue,ao as $t,ap as pi,aq as Ze,ar as lr,as as wt,at as Ee,au as ue,av as bt,aw as St,ax as Ko,ay as Q,az as us,aA as _e,aB as mi,aC as Jo,aD as Qo,aE as Te,aF as V,aG as _i,aH as Fe,aI as ea,aJ as Ei,aK as qr,aL as Kr,aM as nt,aN as ta,aO as Jr,aP as Br,aQ as ra,aR as Qr,aS as hs,aT as ia,aU as Tt,aV as na,aW as nn,aX as sa,aY as yi,aZ as oa,a_ as ds,a$ as Ve,b0 as Ht,b1 as aa,b2 as la,b3 as Y,b4 as Xt,b5 as kt,b6 as Se,b7 as ht,b8 as gt,b9 as ca,ba as j,bb as sn,bc as ua,bd as ha,be as da,bf as fs,bg as fa,bh as jt,bi as ga,bj as Vt,bk as We,bl as Qe,bm as pa,bn as st,bo as Cr,bp as xi,bq as Er,br as gs,bs as ct,bt as ma,bu as _a,bv as ps,bw as Me,bx as Ea,by as ya,bz as Ti,bA as xa,bB as Ta,bC as Ra,bD as qe,bE as Yt,bF as qt,bG as Ri,bH as Si,bI as ms,bJ as Sa,bK as Pa,bL as ei,bM as on,bN as wa,bO as ba,bP as La,bQ as va,bR as Aa,bS as Pi,bT as Ca,bU as Ia,bV as Fa,bW as Na,bX as zr,bY as Wt,bZ as wi,b_ as Ma,b$ as _s,c0 as Es,c1 as an,c2 as ln,c3 as bi,c4 as cn,c5 as Oa,c6 as Da,c7 as ti,c8 as ys,c9 as un,ca as yr,cb as xs,cc as Ct,cd as hn,ce as pt,cf as Li,cg as Ga,ch as Ts,ci as Ua,cj as Ba,ck as vi,cl as za,cm as $a,cn as Xa,co as ka,cp as ja,cq as Wa,cr as Za,cs as Rs,ct as Ha,cu as Va,cv as Ya,cw as qa,cx as Ka,cy as Ja,cz as Qa,cA as el,cB as tl,cC as rl,cD as il,cE as nl,cF as sl}from"./map.Ch-ahxIj.js";import{a as ol,S as al,f as ll,b as cl,c as ul,P as hl,p as dl,d as fl}from"./geojson.DV7QvQMW.js";import{p as gl}from"./index.Du0sVlOV.js";import{F as pl,o as $r,g as ml,s as dn}from"./open.CkUt4LTq.js";import"./index.OUYS7i6-.js";import"./XYZ.zMTP1uvH.js";import"./Tile.-LbONiFy.js";import"./Layer.BBoFQbFB.js";import"./Vector.HAw8Ogek.js";import"./DataTile.2Hs0Wrd9.js";import"./item.Bx-rtsOD.js";import"./commonjsHelpers.BosuxZz1.js";import"./framework.DprU-PA3.js";import"./index.BYzJOi-i.js";const _l={Point:Tl,LineString:Rl,Polygon:bl,MultiPoint:Pl,MultiLineString:Sl,MultiPolygon:wl},El={Point:Ll,LineString:vl,Polygon:Al,MultiPoint:Il,MultiLineString:Cl,MultiPolygon:Fl};class yl extends No{constructor(e){e=e||{},super(),this.geometryName_=e.geometryName}readFeatureFromObject(e,t,r){const n=e,s=fn(n.geometry,t),o=new Re;if(this.geometryName_&&o.setGeometryName(this.geometryName_),o.setGeometry(s),n.attributes){o.setProperties(n.attributes,!0);const a=n.attributes[r];a!==void 0&&o.setId(a)}return o}readFeaturesFromObject(e,t){if(t=t||{},e.features){const r=e,n=[],s=r.features;for(let o=0,a=s.length;o<a;++o)n.push(this.readFeatureFromObject(s[o],t,e.objectIdFieldName));return n}return[this.readFeatureFromObject(e,t)]}readGeometryFromObject(e,t){return fn(e,t)}readProjectionFromObject(e){if(e.spatialReference&&e.spatialReference.wkid!==void 0){const r=e.spatialReference.wkid;return K("EPSG:"+r)}return null}writeGeometryObject(e,t){return gn(e,this.adaptOptions(t))}writeFeatureObject(e,t){t=this.adaptOptions(t);const r={};if(!e.hasProperties())return r.attributes={},r;const n=e.getProperties(),s=e.getGeometry();if(s){r.geometry=gn(s,t);const o=t&&(t.dataProjection||t.featureProjection);o&&(r.geometry.spatialReference={wkid:Number(K(o).getCode().split(":").pop())}),delete n[e.getGeometryName()]}return Mo(n)?r.attributes={}:r.attributes=n,r}writeFeaturesObject(e,t){t=this.adaptOptions(t);const r=[];for(let n=0,s=e.length;n<s;++n)r.push(this.writeFeatureObject(e[n],t));return{features:r}}}function fn(i,e){if(!i)return null;let t;if(typeof i.x=="number"&&typeof i.y=="number")t="Point";else if(i.points)t="MultiPoint";else if(i.paths)i.paths.length===1?t="LineString":t="MultiLineString";else if(i.rings){const n=i,s=It(n),o=xl(n.rings,s);o.length===1?(t="Polygon",i=Object.assign({},i,{rings:o[0]})):(t="MultiPolygon",i=Object.assign({},i,{rings:o}))}const r=_l[t];return me(r(i),!1,e)}function xl(i,e){const t=[],r=[],n=[];let s,o;for(s=0,o=i.length;s<o;++s)t.length=0,Oo(t,0,i[s],e.length),Do(t,0,t.length,e.length)?r.push([i[s]]):n.push(i[s]);for(;n.length;){const a=n.shift();let l=!1;for(s=r.length-1;s>=0;s--){const c=r[s][0];if(hr(new Vr(c).getExtent(),new Vr(a).getExtent())){r[s].push(a),l=!0;break}}l||r.push([a.reverse()])}return r}function Tl(i){let e;return i.m!==void 0&&i.z!==void 0?e=new Ie([i.x,i.y,i.z,i.m],"XYZM"):i.z!==void 0?e=new Ie([i.x,i.y,i.z],"XYZ"):i.m!==void 0?e=new Ie([i.x,i.y,i.m],"XYM"):e=new Ie([i.x,i.y]),e}function Rl(i){const e=It(i);return new Be(i.paths[0],e)}function Sl(i){const e=It(i);return new vt(i.paths,e)}function It(i){let e="XY";return i.hasZ===!0&&i.hasM===!0?e="XYZM":i.hasZ===!0?e="XYZ":i.hasM===!0&&(e="XYM"),e}function Pl(i){const e=It(i);return new Lr(i.points,e)}function wl(i){const e=It(i);return new Zt(i.rings,e)}function bl(i){const e=It(i);return new ut(i.rings,e)}function Ll(i,e){const t=i.getCoordinates();let r;const n=i.getLayout();if(n==="XYZ")r={x:t[0],y:t[1],z:t[2]};else if(n==="XYM")r={x:t[0],y:t[1],m:t[2]};else if(n==="XYZM")r={x:t[0],y:t[1],z:t[2],m:t[3]};else if(n==="XY")r={x:t[0],y:t[1]};else throw new Error("Invalid geometry layout");return r}function Kt(i){const e=i.getLayout();return{hasZ:e==="XYZ"||e==="XYZM",hasM:e==="XYM"||e==="XYZM"}}function vl(i,e){const t=Kt(i);return{hasZ:t.hasZ,hasM:t.hasM,paths:[i.getCoordinates()]}}function Al(i,e){const t=Kt(i);return{hasZ:t.hasZ,hasM:t.hasM,rings:i.getCoordinates(!1)}}function Cl(i,e){const t=Kt(i);return{hasZ:t.hasZ,hasM:t.hasM,paths:i.getCoordinates()}}function Il(i,e){const t=Kt(i);return{hasZ:t.hasZ,hasM:t.hasM,points:i.getCoordinates()}}function Fl(i,e){const t=Kt(i),r=i.getCoordinates(!1),n=[];for(let s=0;s<r.length;s++)for(let o=r[s].length-1;o>=0;o--)n.push(r[s][o]);return{hasZ:t.hasZ,hasM:t.hasM,rings:n}}function gn(i,e){const t=El[i.getType()];return t(me(i,!0,e),e)}const He="http://www.opengis.net/gml",Nl=/^\s*$/;class N extends vr{constructor(e){super(),e=e||{},this.featureType=e.featureType,this.featureNS=e.featureNS,this.srsName=e.srsName,this.schemaLocation="",this.FEATURE_COLLECTION_PARSERS={},this.FEATURE_COLLECTION_PARSERS[this.namespace]={featureMember:O(this.readFeaturesInternal),featureMembers:G(this.readFeaturesInternal)},this.supportedMediaTypes=["application/gml+xml"]}readFeaturesInternal(e,t){const r=e.localName;let n=null;if(r=="FeatureCollection")n=A([],this.FEATURE_COLLECTION_PARSERS,e,t,this);else if(r=="featureMembers"||r=="featureMember"||r=="member"){const s=t[0];let o=s.featureType,a=s.featureNS;const l="p",c="p0";if(!o&&e.childNodes){o=[],a={};for(let f=0,g=e.childNodes.length;f<g;++f){const d=e.childNodes[f];if(d.nodeType===1){const p=d.nodeName.split(":").pop();if(!o.includes(p)){let m="",E=0;const x=d.namespaceURI;for(const T in a){if(a[T]===x){m=T;break}++E}m||(m=l+E,a[m]=x),o.push(m+":"+p)}}}r!="featureMember"&&(s.featureType=o,s.featureNS=a)}if(typeof a=="string"){const f=a;a={},a[c]=f}const h={},u=Array.isArray(o)?o:[o];for(const f in a){const g={};for(let d=0,p=u.length;d<p;++d)(u[d].includes(":")?u[d].split(":")[0]:c)===f&&(g[u[d].split(":").pop()]=r=="featureMembers"?O(this.readFeatureElement,this):G(this.readFeatureElement,this));h[a[f]]=g}r=="featureMember"||r=="member"?n=A(void 0,h,e,t):n=A([],h,e,t)}return n===null&&(n=[]),n}readGeometryOrExtent(e,t){const r=t[0];return r.srsName=e.firstElementChild.getAttribute("srsName"),r.srsDimension=e.firstElementChild.getAttribute("srsDimension"),A(null,this.GEOMETRY_PARSERS,e,t,this)}readExtentElement(e,t){const r=t[0],n=this.readGeometryOrExtent(e,t);return n?hi(n,r):void 0}readGeometryElement(e,t){const r=t[0],n=this.readGeometryOrExtent(e,t);return n?me(n,!1,r):void 0}readFeatureElementInternal(e,t,r){let n;const s={};for(let l=e.firstElementChild;l;l=l.nextElementSibling){let c;const h=l.localName;l.childNodes.length===0||l.childNodes.length===1&&(l.firstChild.nodeType===3||l.firstChild.nodeType===4)?(c=dr(l,!1),Nl.test(c)&&(c=void 0)):(r&&(c=h==="boundedBy"?this.readExtentElement(l,t):this.readGeometryElement(l,t)),c?h!=="boundedBy"&&(n=h):c=this.readFeatureElementInternal(l,t,!1));const u=l.attributes.length;if(u>0&&!(c instanceof Go)){c={_content_:c};for(let f=0;f<u;f++){const g=l.attributes[f].name;c[g]=l.attributes[f].value}}s[h]?(s[h]instanceof Array||(s[h]=[s[h]]),s[h].push(c)):s[h]=c}if(!r)return s;const o=new Re(s);n&&o.setGeometryName(n);const a=e.getAttribute("fid")||Uo(e,this.namespace,"id");return a&&o.setId(a),o}readFeatureElement(e,t){return this.readFeatureElementInternal(e,t,!0)}readPoint(e,t){const r=this.readFlatCoordinatesFromNode(e,t);if(r)return new Ie(r,"XYZ")}readMultiPoint(e,t){const r=A([],this.MULTIPOINT_PARSERS,e,t,this);if(r)return new Lr(r)}readMultiLineString(e,t){const r=A([],this.MULTILINESTRING_PARSERS,e,t,this);if(r)return new vt(r)}readMultiPolygon(e,t){const r=A([],this.MULTIPOLYGON_PARSERS,e,t,this);if(r)return new Zt(r)}pointMemberParser(e,t){et(this.POINTMEMBER_PARSERS,e,t,this)}lineStringMemberParser(e,t){et(this.LINESTRINGMEMBER_PARSERS,e,t,this)}polygonMemberParser(e,t){et(this.POLYGONMEMBER_PARSERS,e,t,this)}readLineString(e,t){const r=this.readFlatCoordinatesFromNode(e,t);if(r)return new Be(r,"XYZ")}readFlatLinearRing(e,t){const r=A(null,this.GEOMETRY_FLAT_COORDINATES_PARSERS,e,t,this);if(r)return r}readLinearRing(e,t){const r=this.readFlatCoordinatesFromNode(e,t);if(r)return new Vr(r,"XYZ")}readPolygon(e,t){const r=A([null],this.FLAT_LINEAR_RINGS_PARSERS,e,t,this);if(r&&r[0]){const n=r[0],s=[n.length];let o,a;for(o=1,a=r.length;o<a;++o)fr(n,r[o]),s.push(n.length);return new ut(n,"XYZ",s)}}readFlatCoordinatesFromNode(e,t){return A(null,this.GEOMETRY_FLAT_COORDINATES_PARSERS,e,t,this)}readGeometryFromNode(e,t){const r=this.readGeometryElement(e,[this.getReadOptions(e,t||{})]);return r||null}readFeaturesFromNode(e,t){const r={featureType:this.featureType,featureNS:this.featureNS};return r&&Object.assign(r,this.getReadOptions(e,t)),this.readFeaturesInternal(e,[r])||[]}readProjectionFromNode(e){return K(this.srsName?this.srsName:e.firstElementChild.getAttribute("srsName"))}}N.prototype.namespace=He;N.prototype.FLAT_LINEAR_RINGS_PARSERS={"http://www.opengis.net/gml":{}};N.prototype.GEOMETRY_FLAT_COORDINATES_PARSERS={"http://www.opengis.net/gml":{}};N.prototype.GEOMETRY_PARSERS={"http://www.opengis.net/gml":{}};N.prototype.MULTIPOINT_PARSERS={"http://www.opengis.net/gml":{pointMember:O(N.prototype.pointMemberParser),pointMembers:O(N.prototype.pointMemberParser)}};N.prototype.MULTILINESTRING_PARSERS={"http://www.opengis.net/gml":{lineStringMember:O(N.prototype.lineStringMemberParser),lineStringMembers:O(N.prototype.lineStringMemberParser)}};N.prototype.MULTIPOLYGON_PARSERS={"http://www.opengis.net/gml":{polygonMember:O(N.prototype.polygonMemberParser),polygonMembers:O(N.prototype.polygonMemberParser)}};N.prototype.POINTMEMBER_PARSERS={"http://www.opengis.net/gml":{Point:O(N.prototype.readFlatCoordinatesFromNode)}};N.prototype.LINESTRINGMEMBER_PARSERS={"http://www.opengis.net/gml":{LineString:O(N.prototype.readLineString)}};N.prototype.POLYGONMEMBER_PARSERS={"http://www.opengis.net/gml":{Polygon:O(N.prototype.readPolygon)}};N.prototype.RING_PARSERS={"http://www.opengis.net/gml":{LinearRing:G(N.prototype.readFlatLinearRing)}};const Ml=He+" http://schemas.opengis.net/gml/2.1.2/feature.xsd",Ol={MultiLineString:"lineStringMember",MultiCurve:"curveMember",MultiPolygon:"polygonMember",MultiSurface:"surfaceMember"};class W extends N{constructor(e){e=e||{},super(e),this.FEATURE_COLLECTION_PARSERS[He].featureMember=O(this.readFeaturesInternal),this.schemaLocation=e.schemaLocation?e.schemaLocation:Ml}readFlatCoordinates(e,t){const r=dr(e,!1).replace(/^\s*|\s*$/g,""),s=t[0].srsName;let o="enu";if(s){const c=K(s);c&&(o=c.getAxisOrientation())}const a=r.trim().split(/\s+/),l=[];for(let c=0,h=a.length;c<h;c++){const u=a[c].split(/,+/),f=parseFloat(u[0]),g=parseFloat(u[1]),d=u.length===3?parseFloat(u[2]):0;o.startsWith("en")?l.push(f,g,d):l.push(g,f,d)}return l}readBox(e,t){const r=A([null],this.BOX_PARSERS_,e,t,this);return os(r[1][0],r[1][1],r[1][3],r[1][4])}innerBoundaryIsParser(e,t){const r=A(void 0,this.RING_PARSERS,e,t,this);r&&t[t.length-1].push(r)}outerBoundaryIsParser(e,t){const r=A(void 0,this.RING_PARSERS,e,t,this);if(r){const n=t[t.length-1];n[0]=r}}GEOMETRY_NODE_FACTORY_(e,t,r){const n=t[t.length-1],s=n.multiSurface,o=n.surface,a=n.multiCurve;return Array.isArray(e)?r="Envelope":(r=e.getType(),r==="MultiPolygon"&&s===!0?r="MultiSurface":r==="Polygon"&&o===!0?r="Surface":r==="MultiLineString"&&a===!0&&(r="MultiCurve")),k("http://www.opengis.net/gml",r)}writeFeatureElement(e,t,r){const n=t.getId();n&&e.setAttribute("fid",n);const s=r[r.length-1],o=s.featureNS,a=t.getGeometryName();s.serializers||(s.serializers={},s.serializers[o]={});const l=[],c=[];if(t.hasProperties()){const u=t.getProperties();for(const f in u){const g=u[f];g!=null&&(l.push(f),c.push(g),f==a||typeof g.getSimplifiedGeometry=="function"?f in s.serializers[o]||(s.serializers[o][f]=y(this.writeGeometryElement,this)):f in s.serializers[o]||(s.serializers[o][f]=y(H)))}}const h=Object.assign({},s);h.node=e,ie(h,s.serializers,Le(void 0,o),c,r,l)}writeCurveOrLineString(e,t,r){const s=r[r.length-1].srsName;if(e.nodeName!=="LineStringSegment"&&s&&e.setAttribute("srsName",s),e.nodeName==="LineString"||e.nodeName==="LineStringSegment"){const o=this.createCoordinatesNode_(e.namespaceURI);e.appendChild(o),this.writeCoordinates_(o,t,r)}else if(e.nodeName==="Curve"){const o=k(e.namespaceURI,"segments");e.appendChild(o),this.writeCurveSegments_(o,t,r)}}writeLineStringOrCurveMember(e,t,r){const n=this.GEOMETRY_NODE_FACTORY_(t,r);n&&(e.appendChild(n),this.writeCurveOrLineString(n,t,r))}writeMultiCurveOrLineString(e,t,r){const n=r[r.length-1],s=n.hasZ,o=n.srsName,a=n.curve;o&&e.setAttribute("srsName",o);const l=t.getLineStrings();ie({node:e,hasZ:s,srsName:o,curve:a},this.LINESTRINGORCURVEMEMBER_SERIALIZERS,this.MULTIGEOMETRY_MEMBER_NODE_FACTORY_,l,r,void 0,this)}writeGeometryElement(e,t,r){const n=r[r.length-1],s=Object.assign({},n);s.node=e;let o;Array.isArray(t)?o=hi(t,n):o=me(t,!0,n),ie(s,this.GEOMETRY_SERIALIZERS,this.GEOMETRY_NODE_FACTORY_,[o],r,void 0,this)}createCoordinatesNode_(e){const t=k(e,"coordinates");return t.setAttribute("decimal","."),t.setAttribute("cs",","),t.setAttribute("ts"," "),t}writeCoordinates_(e,t,r){const n=r[r.length-1],s=n.hasZ,o=n.srsName,a=t.getCoordinates(),l=a.length,c=new Array(l);for(let h=0;h<l;++h){const u=a[h];c[h]=this.getCoords_(u,o,s)}H(e,c.join(" "))}writeCurveSegments_(e,t,r){const n=k(e.namespaceURI,"LineStringSegment");e.appendChild(n),this.writeCurveOrLineString(n,t,r)}writeSurfaceOrPolygon(e,t,r){const n=r[r.length-1],s=n.hasZ,o=n.srsName;if(e.nodeName!=="PolygonPatch"&&o&&e.setAttribute("srsName",o),e.nodeName==="Polygon"||e.nodeName==="PolygonPatch"){const a=t.getLinearRings();ie({node:e,hasZ:s,srsName:o},this.RING_SERIALIZERS,this.RING_NODE_FACTORY_,a,r,void 0,this)}else if(e.nodeName==="Surface"){const a=k(e.namespaceURI,"patches");e.appendChild(a),this.writeSurfacePatches_(a,t,r)}}RING_NODE_FACTORY_(e,t,r){const n=t[t.length-1],s=n.node,o=n.exteriorWritten;return o===void 0&&(n.exteriorWritten=!0),k(s.namespaceURI,o!==void 0?"innerBoundaryIs":"outerBoundaryIs")}writeSurfacePatches_(e,t,r){const n=k(e.namespaceURI,"PolygonPatch");e.appendChild(n),this.writeSurfaceOrPolygon(n,t,r)}writeRing(e,t,r){const n=k(e.namespaceURI,"LinearRing");e.appendChild(n),this.writeLinearRing(n,t,r)}getCoords_(e,t,r){let s=(t?K(t).getAxisOrientation():"enu").startsWith("en")?e[0]+","+e[1]:e[1]+","+e[0];if(r){const o=e[2]||0;s+=","+o}return s}writePoint(e,t,r){const n=r[r.length-1],s=n.hasZ,o=n.srsName;o&&e.setAttribute("srsName",o);const a=this.createCoordinatesNode_(e.namespaceURI);e.appendChild(a);const l=t.getCoordinates(),c=this.getCoords_(l,o,s);H(a,c)}writeMultiPoint(e,t,r){const n=r[r.length-1],s=n.hasZ,o=n.srsName;o&&e.setAttribute("srsName",o);const a=t.getPoints();ie({node:e,hasZ:s,srsName:o},this.POINTMEMBER_SERIALIZERS,Le("pointMember"),a,r,void 0,this)}writePointMember(e,t,r){const n=k(e.namespaceURI,"Point");e.appendChild(n),this.writePoint(n,t,r)}writeLinearRing(e,t,r){const s=r[r.length-1].srsName;s&&e.setAttribute("srsName",s);const o=this.createCoordinatesNode_(e.namespaceURI);e.appendChild(o),this.writeCoordinates_(o,t,r)}writeMultiSurfaceOrPolygon(e,t,r){const n=r[r.length-1],s=n.hasZ,o=n.srsName,a=n.surface;o&&e.setAttribute("srsName",o);const l=t.getPolygons();ie({node:e,hasZ:s,srsName:o,surface:a},this.SURFACEORPOLYGONMEMBER_SERIALIZERS,this.MULTIGEOMETRY_MEMBER_NODE_FACTORY_,l,r,void 0,this)}writeSurfaceOrPolygonMember(e,t,r){const n=this.GEOMETRY_NODE_FACTORY_(t,r);n&&(e.appendChild(n),this.writeSurfaceOrPolygon(n,t,r))}writeEnvelope(e,t,r){const s=r[r.length-1].srsName;s&&e.setAttribute("srsName",s);const o=["lowerCorner","upperCorner"],a=[t[0]+" "+t[1],t[2]+" "+t[3]];ie({node:e},this.ENVELOPE_SERIALIZERS,At,a,r,o,this)}MULTIGEOMETRY_MEMBER_NODE_FACTORY_(e,t,r){const n=t[t.length-1].node;return k("http://www.opengis.net/gml",Ol[n.nodeName])}}W.prototype.GEOMETRY_FLAT_COORDINATES_PARSERS={"http://www.opengis.net/gml":{coordinates:G(W.prototype.readFlatCoordinates)}};W.prototype.FLAT_LINEAR_RINGS_PARSERS={"http://www.opengis.net/gml":{innerBoundaryIs:W.prototype.innerBoundaryIsParser,outerBoundaryIs:W.prototype.outerBoundaryIsParser}};W.prototype.BOX_PARSERS_={"http://www.opengis.net/gml":{coordinates:O(W.prototype.readFlatCoordinates)}};W.prototype.GEOMETRY_PARSERS={"http://www.opengis.net/gml":{Point:G(N.prototype.readPoint),MultiPoint:G(N.prototype.readMultiPoint),LineString:G(N.prototype.readLineString),MultiLineString:G(N.prototype.readMultiLineString),LinearRing:G(N.prototype.readLinearRing),Polygon:G(N.prototype.readPolygon),MultiPolygon:G(N.prototype.readMultiPolygon),Box:G(W.prototype.readBox)}};W.prototype.GEOMETRY_SERIALIZERS={"http://www.opengis.net/gml":{Curve:y(W.prototype.writeCurveOrLineString),MultiCurve:y(W.prototype.writeMultiCurveOrLineString),Point:y(W.prototype.writePoint),MultiPoint:y(W.prototype.writeMultiPoint),LineString:y(W.prototype.writeCurveOrLineString),MultiLineString:y(W.prototype.writeMultiCurveOrLineString),LinearRing:y(W.prototype.writeLinearRing),Polygon:y(W.prototype.writeSurfaceOrPolygon),MultiPolygon:y(W.prototype.writeMultiSurfaceOrPolygon),Surface:y(W.prototype.writeSurfaceOrPolygon),MultiSurface:y(W.prototype.writeMultiSurfaceOrPolygon),Envelope:y(W.prototype.writeEnvelope)}};W.prototype.LINESTRINGORCURVEMEMBER_SERIALIZERS={"http://www.opengis.net/gml":{lineStringMember:y(W.prototype.writeLineStringOrCurveMember),curveMember:y(W.prototype.writeLineStringOrCurveMember)}};W.prototype.RING_SERIALIZERS={"http://www.opengis.net/gml":{outerBoundaryIs:y(W.prototype.writeRing),innerBoundaryIs:y(W.prototype.writeRing)}};W.prototype.POINTMEMBER_SERIALIZERS={"http://www.opengis.net/gml":{pointMember:y(W.prototype.writePointMember)}};W.prototype.SURFACEORPOLYGONMEMBER_SERIALIZERS={"http://www.opengis.net/gml":{surfaceMember:y(W.prototype.writeSurfaceOrPolygonMember),polygonMember:y(W.prototype.writeSurfaceOrPolygonMember)}};W.prototype.ENVELOPE_SERIALIZERS={"http://www.opengis.net/gml":{lowerCorner:y(H),upperCorner:y(H)}};const Dl=He+" http://schemas.opengis.net/gml/3.1.1/profiles/gmlsfProfile/1.0.0/gmlsf.xsd",Gl={MultiLineString:"lineStringMember",MultiCurve:"curveMember",MultiPolygon:"polygonMember",MultiSurface:"surfaceMember"};class b extends N{constructor(e){e=e||{},super(e),this.surface_=e.surface!==void 0?e.surface:!1,this.curve_=e.curve!==void 0?e.curve:!1,this.multiCurve_=e.multiCurve!==void 0?e.multiCurve:!0,this.multiSurface_=e.multiSurface!==void 0?e.multiSurface:!0,this.schemaLocation=e.schemaLocation?e.schemaLocation:Dl,this.hasZ=e.hasZ!==void 0?e.hasZ:!1}readMultiCurve(e,t){const r=A([],this.MULTICURVE_PARSERS,e,t,this);if(r)return new vt(r)}readFlatCurveRing(e,t){const r=A([],this.MULTICURVE_PARSERS,e,t,this),n=[];for(let s=0,o=r.length;s<o;++s)fr(n,r[s].getFlatCoordinates());return n}readMultiSurface(e,t){const r=A([],this.MULTISURFACE_PARSERS,e,t,this);if(r)return new Zt(r)}curveMemberParser(e,t){et(this.CURVEMEMBER_PARSERS,e,t,this)}surfaceMemberParser(e,t){et(this.SURFACEMEMBER_PARSERS,e,t,this)}readPatch(e,t){return A([null],this.PATCHES_PARSERS,e,t,this)}readSegment(e,t){return A([],this.SEGMENTS_PARSERS,e,t,this)}readPolygonPatch(e,t){return A([null],this.FLAT_LINEAR_RINGS_PARSERS,e,t,this)}readLineStringSegment(e,t){return A([null],this.GEOMETRY_FLAT_COORDINATES_PARSERS,e,t,this)}interiorParser(e,t){const r=A(void 0,this.RING_PARSERS,e,t,this);r&&t[t.length-1].push(r)}exteriorParser(e,t){const r=A(void 0,this.RING_PARSERS,e,t,this);if(r){const n=t[t.length-1];n[0]=r}}readSurface(e,t){const r=A([null],this.SURFACE_PARSERS,e,t,this);if(r&&r[0]){const n=r[0],s=[n.length];let o,a;for(o=1,a=r.length;o<a;++o)fr(n,r[o]),s.push(n.length);return new ut(n,"XYZ",s)}}readCurve(e,t){const r=A([null],this.CURVE_PARSERS,e,t,this);if(r)return new Be(r,"XYZ")}readEnvelope(e,t){const r=A([null],this.ENVELOPE_PARSERS,e,t,this);return os(r[1][0],r[1][1],r[2][0],r[2][1])}readFlatPos(e,t){let r=dr(e,!1);const n=/^\s*([+\-]?\d*\.?\d+(?:[eE][+\-]?\d+)?)\s*/,s=[];let o;for(;o=n.exec(r);)s.push(parseFloat(o[1])),r=r.substr(o[0].length);if(r!=="")return;const l=t[0].srsName;if((l?K(l).getAxisOrientation():"enu")==="neu")for(let u=0,f=s.length;u<f;u+=3){const g=s[u],d=s[u+1];s[u]=d,s[u+1]=g}const h=s.length;if(h==2&&s.push(0),h!==0)return s}readFlatPosList(e,t){const r=dr(e,!1).replace(/^\s*|\s*$/g,""),n=t[0],s=n.srsName,o=n.srsDimension,a=s?K(s).getAxisOrientation():"enu",l=r.split(/\s+/);let c=2;e.getAttribute("srsDimension")?c=Je(e.getAttribute("srsDimension")):e.getAttribute("dimension")?c=Je(e.getAttribute("dimension")):e.parentNode.getAttribute("srsDimension")?c=Je(e.parentNode.getAttribute("srsDimension")):o&&(c=Je(o));const h=a.startsWith("en");let u,f,g;const d=[];for(let p=0,m=l.length;p<m;p+=c)u=parseFloat(l[p]),f=parseFloat(l[p+1]),g=c===3?parseFloat(l[p+2]):0,h?d.push(u,f,g):d.push(f,u,g);return d}writePos_(e,t,r){const n=r[r.length-1],s=n.hasZ,o=s?"3":"2";e.setAttribute("srsDimension",o);const a=n.srsName,l=a?K(a).getAxisOrientation():"enu",c=t.getCoordinates();let h=l.startsWith("en")?c[0]+" "+c[1]:c[1]+" "+c[0];if(s){const u=c[2]||0;h+=" "+u}H(e,h)}getCoords_(e,t,r){let s=(t?K(t).getAxisOrientation():"enu").startsWith("en")?e[0]+" "+e[1]:e[1]+" "+e[0];if(r){const o=e[2]||0;s+=" "+o}return s}writePosList_(e,t,r){const n=r[r.length-1],s=n.hasZ,o=s?"3":"2";e.setAttribute("srsDimension",o);const a=n.srsName,l=t.getCoordinates(),c=l.length,h=new Array(c);let u;for(let f=0;f<c;++f)u=l[f],h[f]=this.getCoords_(u,a,s);H(e,h.join(" "))}writePoint(e,t,r){const s=r[r.length-1].srsName;s&&e.setAttribute("srsName",s);const o=k(e.namespaceURI,"pos");e.appendChild(o),this.writePos_(o,t,r)}writeEnvelope(e,t,r){const s=r[r.length-1].srsName;s&&e.setAttribute("srsName",s);const o=["lowerCorner","upperCorner"],a=[t[0]+" "+t[1],t[2]+" "+t[3]];ie({node:e},this.ENVELOPE_SERIALIZERS,At,a,r,o,this)}writeLinearRing(e,t,r){const s=r[r.length-1].srsName;s&&e.setAttribute("srsName",s);const o=k(e.namespaceURI,"posList");e.appendChild(o),this.writePosList_(o,t,r)}RING_NODE_FACTORY_(e,t,r){const n=t[t.length-1],s=n.node,o=n.exteriorWritten;return o===void 0&&(n.exteriorWritten=!0),k(s.namespaceURI,o!==void 0?"interior":"exterior")}writeSurfaceOrPolygon(e,t,r){const n=r[r.length-1],s=n.hasZ,o=n.srsName;if(e.nodeName!=="PolygonPatch"&&o&&e.setAttribute("srsName",o),e.nodeName==="Polygon"||e.nodeName==="PolygonPatch"){const a=t.getLinearRings();ie({node:e,hasZ:s,srsName:o},this.RING_SERIALIZERS,this.RING_NODE_FACTORY_,a,r,void 0,this)}else if(e.nodeName==="Surface"){const a=k(e.namespaceURI,"patches");e.appendChild(a),this.writeSurfacePatches_(a,t,r)}}writeCurveOrLineString(e,t,r){const s=r[r.length-1].srsName;if(e.nodeName!=="LineStringSegment"&&s&&e.setAttribute("srsName",s),e.nodeName==="LineString"||e.nodeName==="LineStringSegment"){const o=k(e.namespaceURI,"posList");e.appendChild(o),this.writePosList_(o,t,r)}else if(e.nodeName==="Curve"){const o=k(e.namespaceURI,"segments");e.appendChild(o),this.writeCurveSegments_(o,t,r)}}writeMultiSurfaceOrPolygon(e,t,r){const n=r[r.length-1],s=n.hasZ,o=n.srsName,a=n.surface;o&&e.setAttribute("srsName",o);const l=t.getPolygons();ie({node:e,hasZ:s,srsName:o,surface:a},this.SURFACEORPOLYGONMEMBER_SERIALIZERS,this.MULTIGEOMETRY_MEMBER_NODE_FACTORY_,l,r,void 0,this)}writeMultiPoint(e,t,r){const n=r[r.length-1],s=n.srsName,o=n.hasZ;s&&e.setAttribute("srsName",s);const a=t.getPoints();ie({node:e,hasZ:o,srsName:s},this.POINTMEMBER_SERIALIZERS,Le("pointMember"),a,r,void 0,this)}writeMultiCurveOrLineString(e,t,r){const n=r[r.length-1],s=n.hasZ,o=n.srsName,a=n.curve;o&&e.setAttribute("srsName",o);const l=t.getLineStrings();ie({node:e,hasZ:s,srsName:o,curve:a},this.LINESTRINGORCURVEMEMBER_SERIALIZERS,this.MULTIGEOMETRY_MEMBER_NODE_FACTORY_,l,r,void 0,this)}writeRing(e,t,r){const n=k(e.namespaceURI,"LinearRing");e.appendChild(n),this.writeLinearRing(n,t,r)}writeSurfaceOrPolygonMember(e,t,r){const n=this.GEOMETRY_NODE_FACTORY_(t,r);n&&(e.appendChild(n),this.writeSurfaceOrPolygon(n,t,r))}writePointMember(e,t,r){const n=k(e.namespaceURI,"Point");e.appendChild(n),this.writePoint(n,t,r)}writeLineStringOrCurveMember(e,t,r){const n=this.GEOMETRY_NODE_FACTORY_(t,r);n&&(e.appendChild(n),this.writeCurveOrLineString(n,t,r))}writeSurfacePatches_(e,t,r){const n=k(e.namespaceURI,"PolygonPatch");e.appendChild(n),this.writeSurfaceOrPolygon(n,t,r)}writeCurveSegments_(e,t,r){const n=k(e.namespaceURI,"LineStringSegment");e.appendChild(n),this.writeCurveOrLineString(n,t,r)}writeGeometryElement(e,t,r){const n=r[r.length-1],s=Object.assign({},n);s.node=e;let o;Array.isArray(t)?o=hi(t,n):o=me(t,!0,n),ie(s,this.GEOMETRY_SERIALIZERS,this.GEOMETRY_NODE_FACTORY_,[o],r,void 0,this)}writeFeatureElement(e,t,r){const n=t.getId();n&&e.setAttribute("fid",n);const s=r[r.length-1],o=s.featureNS,a=t.getGeometryName();s.serializers||(s.serializers={},s.serializers[o]={});const l=[],c=[];if(t.hasProperties()){const u=t.getProperties();for(const f in u){const g=u[f];g!=null&&(l.push(f),c.push(g),f==a||typeof g.getSimplifiedGeometry=="function"?f in s.serializers[o]||(s.serializers[o][f]=y(this.writeGeometryElement,this)):f in s.serializers[o]||(s.serializers[o][f]=y(H)))}}const h=Object.assign({},s);h.node=e,ie(h,s.serializers,Le(void 0,o),c,r,l)}writeFeatureMembers_(e,t,r){const n=r[r.length-1],s=n.featureType,o=n.featureNS,a={};a[o]={},a[o][s]=y(this.writeFeatureElement,this);const l=Object.assign({},n);l.node=e,ie(l,a,Le(s,o),t,r)}MULTIGEOMETRY_MEMBER_NODE_FACTORY_(e,t,r){const n=t[t.length-1].node;return k(this.namespace,Gl[n.nodeName])}GEOMETRY_NODE_FACTORY_(e,t,r){const n=t[t.length-1],s=n.multiSurface,o=n.surface,a=n.curve,l=n.multiCurve;return Array.isArray(e)?r="Envelope":(r=e.getType(),r==="MultiPolygon"&&s===!0?r="MultiSurface":r==="Polygon"&&o===!0?r="Surface":r==="LineString"&&a===!0?r="Curve":r==="MultiLineString"&&l===!0&&(r="MultiCurve")),k(this.namespace,r)}writeGeometryNode(e,t){t=this.adaptOptions(t);const r=k(this.namespace,"geom"),n={node:r,hasZ:this.hasZ,srsName:this.srsName,curve:this.curve_,surface:this.surface_,multiSurface:this.multiSurface_,multiCurve:this.multiCurve_};return t&&Object.assign(n,t),this.writeGeometryElement(r,e,[n]),r}writeFeaturesNode(e,t){t=this.adaptOptions(t);const r=k(this.namespace,"featureMembers");r.setAttributeNS(Bt,"xsi:schemaLocation",this.schemaLocation);const n={srsName:this.srsName,hasZ:this.hasZ,curve:this.curve_,surface:this.surface_,multiSurface:this.multiSurface_,multiCurve:this.multiCurve_,featureNS:this.featureNS,featureType:this.featureType};return t&&Object.assign(n,t),this.writeFeatureMembers_(r,e,[n]),r}}b.prototype.GEOMETRY_FLAT_COORDINATES_PARSERS={"http://www.opengis.net/gml":{pos:G(b.prototype.readFlatPos),posList:G(b.prototype.readFlatPosList),coordinates:G(W.prototype.readFlatCoordinates)}};b.prototype.FLAT_LINEAR_RINGS_PARSERS={"http://www.opengis.net/gml":{interior:b.prototype.interiorParser,exterior:b.prototype.exteriorParser}};b.prototype.GEOMETRY_PARSERS={"http://www.opengis.net/gml":{Point:G(N.prototype.readPoint),MultiPoint:G(N.prototype.readMultiPoint),LineString:G(N.prototype.readLineString),MultiLineString:G(N.prototype.readMultiLineString),LinearRing:G(N.prototype.readLinearRing),Polygon:G(N.prototype.readPolygon),MultiPolygon:G(N.prototype.readMultiPolygon),Surface:G(b.prototype.readSurface),MultiSurface:G(b.prototype.readMultiSurface),Curve:G(b.prototype.readCurve),MultiCurve:G(b.prototype.readMultiCurve),Envelope:G(b.prototype.readEnvelope)}};b.prototype.MULTICURVE_PARSERS={"http://www.opengis.net/gml":{curveMember:O(b.prototype.curveMemberParser),curveMembers:O(b.prototype.curveMemberParser)}};b.prototype.MULTISURFACE_PARSERS={"http://www.opengis.net/gml":{surfaceMember:O(b.prototype.surfaceMemberParser),surfaceMembers:O(b.prototype.surfaceMemberParser)}};b.prototype.CURVEMEMBER_PARSERS={"http://www.opengis.net/gml":{LineString:O(N.prototype.readLineString),Curve:O(b.prototype.readCurve)}};b.prototype.SURFACEMEMBER_PARSERS={"http://www.opengis.net/gml":{Polygon:O(N.prototype.readPolygon),Surface:O(b.prototype.readSurface)}};b.prototype.SURFACE_PARSERS={"http://www.opengis.net/gml":{patches:G(b.prototype.readPatch)}};b.prototype.CURVE_PARSERS={"http://www.opengis.net/gml":{segments:G(b.prototype.readSegment)}};b.prototype.ENVELOPE_PARSERS={"http://www.opengis.net/gml":{lowerCorner:O(b.prototype.readFlatPosList),upperCorner:O(b.prototype.readFlatPosList)}};b.prototype.PATCHES_PARSERS={"http://www.opengis.net/gml":{PolygonPatch:G(b.prototype.readPolygonPatch)}};b.prototype.SEGMENTS_PARSERS={"http://www.opengis.net/gml":{LineStringSegment:as(b.prototype.readLineStringSegment)}};N.prototype.RING_PARSERS={"http://www.opengis.net/gml":{LinearRing:G(N.prototype.readFlatLinearRing),Ring:G(b.prototype.readFlatCurveRing)}};b.prototype.writeFeatures;b.prototype.RING_SERIALIZERS={"http://www.opengis.net/gml":{exterior:y(b.prototype.writeRing),interior:y(b.prototype.writeRing)}};b.prototype.ENVELOPE_SERIALIZERS={"http://www.opengis.net/gml":{lowerCorner:y(H),upperCorner:y(H)}};b.prototype.SURFACEORPOLYGONMEMBER_SERIALIZERS={"http://www.opengis.net/gml":{surfaceMember:y(b.prototype.writeSurfaceOrPolygonMember),polygonMember:y(b.prototype.writeSurfaceOrPolygonMember)}};b.prototype.POINTMEMBER_SERIALIZERS={"http://www.opengis.net/gml":{pointMember:y(b.prototype.writePointMember)}};b.prototype.LINESTRINGORCURVEMEMBER_SERIALIZERS={"http://www.opengis.net/gml":{lineStringMember:y(b.prototype.writeLineStringOrCurveMember),curveMember:y(b.prototype.writeLineStringOrCurveMember)}};b.prototype.GEOMETRY_SERIALIZERS={"http://www.opengis.net/gml":{Curve:y(b.prototype.writeCurveOrLineString),MultiCurve:y(b.prototype.writeMultiCurveOrLineString),Point:y(b.prototype.writePoint),MultiPoint:y(b.prototype.writeMultiPoint),LineString:y(b.prototype.writeCurveOrLineString),MultiLineString:y(b.prototype.writeMultiCurveOrLineString),LinearRing:y(b.prototype.writeLinearRing),Polygon:y(b.prototype.writeSurfaceOrPolygon),MultiPolygon:y(b.prototype.writeMultiSurfaceOrPolygon),Surface:y(b.prototype.writeSurfaceOrPolygon),MultiSurface:y(b.prototype.writeMultiSurfaceOrPolygon),Envelope:y(b.prototype.writeEnvelope)}};const Ai=b;Ai.prototype.writeFeatures;Ai.prototype.writeFeaturesNode;const ae=[null,"http://www.topografix.com/GPX/1/0","http://www.topografix.com/GPX/1/1"],Ul="http://www.topografix.com/GPX/1/1 http://www.topografix.com/GPX/1/1/gpx.xsd",Bl={rte:Ss,trk:Ps,wpt:ws},zl=F(ae,{rte:O(Ss),trk:O(Ps),wpt:O(ws)}),$l=F(ae,{text:_(v,"linkText"),type:_(v,"linkType")}),Xl=F(ae,{name:_(v),email:pc,link:Jt}),kl=F(ae,{name:_(v),desc:_(v),author:_(dc),copyright:_(fc),link:Jt,time:_(Ar),keywords:_(v),bounds:gc,extensions:Ir}),jl=F(ae,{year:_(fe),license:_(v)}),Wl=F(ae,{rte:y(yc),trk:y(xc),wpt:y(Rc)});class Zl extends vr{constructor(e){super(),e=e||{},this.dataProjection=K("EPSG:4326"),this.readExtensions_=e.readExtensions}handleReadExtensions_(e){e||(e=[]);for(let t=0,r=e.length;t<r;++t){const n=e[t];if(this.readExtensions_){const s=n.get("extensionsNode_")||null;this.readExtensions_(n,s)}n.set("extensionsNode_",void 0)}}readMetadata(e){return e?typeof e=="string"?this.readMetadataFromDocument(gr(e)):pr(e)?this.readMetadataFromDocument(e):this.readMetadataFromNode(e):null}readMetadataFromDocument(e){for(let t=e.firstChild;t;t=t.nextSibling)if(t.nodeType===Node.ELEMENT_NODE){const r=this.readMetadataFromNode(t);if(r)return r}return null}readMetadataFromNode(e){if(!ae.includes(e.namespaceURI))return null;for(let t=e.firstElementChild;t;t=t.nextElementSibling)if(ae.includes(t.namespaceURI)&&t.localName==="metadata")return A({},kl,t,[]);return null}readFeatureFromNode(e,t){if(!ae.includes(e.namespaceURI))return null;const r=Bl[e.localName];if(!r)return null;const n=r(e,[this.getReadOptions(e,t)]);return n?(this.handleReadExtensions_([n]),n):null}readFeaturesFromNode(e,t){if(!ae.includes(e.namespaceURI))return[];if(e.localName=="gpx"){const r=A([],zl,e,[this.getReadOptions(e,t)]);return r?(this.handleReadExtensions_(r),r):[]}return[]}writeFeaturesNode(e,t){t=this.adaptOptions(t);const r=k("http://www.topografix.com/GPX/1/1","gpx");return r.setAttributeNS("http://www.w3.org/2000/xmlns/","xmlns:xsi",Bt),r.setAttributeNS(Bt,"xsi:schemaLocation",Ul),r.setAttribute("version","1.1"),r.setAttribute("creator","OpenLayers"),ie({node:r},Wl,hc,e,[t]),r}}const Hl=F(ae,{name:_(v),cmt:_(v),desc:_(v),src:_(v),link:Jt,number:_(fe),extensions:Ir,type:_(v),rtept:mc}),Vl=F(ae,{ele:_(ye),time:_(Ar)}),Yl=F(ae,{name:_(v),cmt:_(v),desc:_(v),src:_(v),link:Jt,number:_(fe),type:_(v),extensions:Ir,trkseg:Ec}),ql=F(ae,{trkpt:_c}),Kl=F(ae,{ele:_(ye),time:_(Ar)}),Jl=F(ae,{ele:_(ye),time:_(Ar),magvar:_(ye),geoidheight:_(ye),name:_(v),cmt:_(v),desc:_(v),src:_(v),link:Jt,sym:_(v),type:_(v),fix:_(v),sat:_(fe),hdop:_(ye),vdop:_(ye),pdop:_(ye),ageofdgpsdata:_(ye),dgpsid:_(fe),extensions:Ir}),Ql=["text","type"],ec=F(ae,{text:y(H),type:y(H)}),tc=F(ae,["name","cmt","desc","src","link","number","type","rtept"]),rc=F(ae,{name:y(H),cmt:y(H),desc:y(H),src:y(H),link:y(Fi),number:y(mr),type:y(H),rtept:ls(y(Ni))}),ic=F(ae,["ele","time"]),nc=F(ae,["name","cmt","desc","src","link","number","type","trkseg"]),sc=F(ae,{name:y(H),cmt:y(H),desc:y(H),src:y(H),link:y(Fi),number:y(mr),type:y(H),trkseg:ls(y(Tc))}),oc=Le("trkpt"),ac=F(ae,{trkpt:y(Ni)}),lc=F(ae,["ele","time","magvar","geoidheight","name","cmt","desc","src","link","sym","type","fix","sat","hdop","vdop","pdop","ageofdgpsdata","dgpsid"]),cc=F(ae,{ele:y(ot),time:y(Bo),magvar:y(ot),geoidheight:y(ot),name:y(H),cmt:y(H),desc:y(H),src:y(H),link:y(Fi),sym:y(H),type:y(H),fix:y(H),sat:y(mr),hdop:y(ot),vdop:y(ot),pdop:y(ot),ageofdgpsdata:y(ot),dgpsid:y(mr)}),uc={Point:"wpt",LineString:"rte",MultiLineString:"trk"};function hc(i,e,t){const r=i.getGeometry();if(r){const n=uc[r.getType()];if(n){const s=e[e.length-1].node;return k(s.namespaceURI,n)}}}function Ci(i,e,t,r){return i.push(parseFloat(t.getAttribute("lon")),parseFloat(t.getAttribute("lat"))),"ele"in r?(i.push(r.ele),delete r.ele,e.hasZ=!0):i.push(0),"time"in r?(i.push(r.time),delete r.time,e.hasM=!0):i.push(0),i}function Ii(i,e,t){let r="XY",n=2;if(i.hasZ&&i.hasM?(r="XYZM",n=4):i.hasZ?(r="XYZ",n=3):i.hasM&&(r="XYM",n=3),n!==4){for(let s=0,o=e.length/4;s<o;s++)e[s*n]=e[s*4],e[s*n+1]=e[s*4+1],i.hasZ&&(e[s*n+2]=e[s*4+2]),i.hasM&&(e[s*n+2]=e[s*4+3]);if(e.length=e.length/4*n,t)for(let s=0,o=t.length;s<o;s++)t[s]=t[s]/4*n}return r}function dc(i,e){const t=A({},Xl,i,e);if(t)return t}function fc(i,e){const t=A({},jl,i,e);if(t){const r=i.getAttribute("author");return r!==null&&(t.author=r),t}}function gc(i,e){const t=e[e.length-1],r=i.getAttribute("minlat"),n=i.getAttribute("minlon"),s=i.getAttribute("maxlat"),o=i.getAttribute("maxlon");n!==null&&r!==null&&o!==null&&s!==null&&(t.bounds=[[parseFloat(n),parseFloat(r)],[parseFloat(o),parseFloat(s)]])}function pc(i,e){const t=e[e.length-1],r=i.getAttribute("id"),n=i.getAttribute("domain");r!==null&&n!==null&&(t.email=`${r}@${n}`)}function Jt(i,e){const t=e[e.length-1],r=i.getAttribute("href");r!==null&&(t.link=r),et($l,i,e)}function Ir(i,e){const t=e[e.length-1];t.extensionsNode_=i}function mc(i,e){const t=A({},Vl,i,e);if(t){const r=e[e.length-1],n=r.flatCoordinates,s=r.layoutOptions;Ci(n,s,i,t)}}function _c(i,e){const t=A({},Kl,i,e);if(t){const r=e[e.length-1],n=r.flatCoordinates,s=r.layoutOptions;Ci(n,s,i,t)}}function Ec(i,e){const t=e[e.length-1];et(ql,i,e);const r=t.flatCoordinates;t.ends.push(r.length)}function Ss(i,e){const t=e[0],r=A({flatCoordinates:[],layoutOptions:{}},Hl,i,e);if(!r)return;const n=r.flatCoordinates;delete r.flatCoordinates;const s=r.layoutOptions;delete r.layoutOptions;const o=Ii(s,n),a=new Be(n,o);me(a,!1,t);const l=new Re(a);return l.setProperties(r,!0),l}function Ps(i,e){const t=e[0],r=A({flatCoordinates:[],ends:[],layoutOptions:{}},Yl,i,e);if(!r)return;const n=r.flatCoordinates;delete r.flatCoordinates;const s=r.ends;delete r.ends;const o=r.layoutOptions;delete r.layoutOptions;const a=Ii(o,n,s),l=new vt(n,a,s);me(l,!1,t);const c=new Re(l);return c.setProperties(r,!0),c}function ws(i,e){const t=e[0],r=A({},Jl,i,e);if(!r)return;const n={},s=Ci([],n,i,r),o=Ii(n,s),a=new Ie(s,o);me(a,!1,t);const l=new Re(a);return l.setProperties(r,!0),l}function Fi(i,e,t){i.setAttribute("href",e);const n=t[t.length-1].properties,s=[n.linkText,n.linkType];ie({node:i},ec,At,s,t,Ql)}function Ni(i,e,t){const r=t[t.length-1],s=r.node.namespaceURI,o=r.properties;switch(i.setAttributeNS(null,"lat",String(e[1])),i.setAttributeNS(null,"lon",String(e[0])),r.geometryLayout){case"XYZM":e[3]!==0&&(o.time=e[3]);case"XYZ":e[2]!==0&&(o.ele=e[2]);break;case"XYM":e[2]!==0&&(o.time=e[2]);break}const l=i.nodeName=="rtept"?ic[s]:lc[s],c=di(o,l);ie({node:i,properties:o},cc,At,c,t,l)}function yc(i,e,t){const r=t[0],n=e.getProperties(),s={node:i};s.properties=n;const o=e.getGeometry();if(o.getType()=="LineString"){const h=me(o,!0,r);s.geometryLayout=h.getLayout(),n.rtept=h.getCoordinates()}const a=t[t.length-1].node,l=tc[a.namespaceURI],c=di(n,l);ie(s,rc,At,c,t,l)}function xc(i,e,t){const r=t[0],n=e.getProperties(),s={node:i};s.properties=n;const o=e.getGeometry();if(o.getType()=="MultiLineString"){const h=me(o,!0,r);n.trkseg=h.getLineStrings()}const a=t[t.length-1].node,l=nc[a.namespaceURI],c=di(n,l);ie(s,sc,At,c,t,l)}function Tc(i,e,t){const r={node:i};r.geometryLayout=e.getLayout(),r.properties={},ie(r,ac,oc,e.getCoordinates(),t)}function Rc(i,e,t){const r=t[0],n=t[t.length-1];n.properties=e.getProperties();const s=e.getGeometry();if(s.getType()=="Point"){const o=me(s,!0,r);n.geometryLayout=o.getLayout(),Ni(i,o.getCoordinates(),t)}}class Mi extends cs{constructor(){super()}getType(){return"text"}readFeature(e,t){return this.readFeatureFromText(ir(e),this.adaptOptions(t))}readFeatureFromText(e,t){return ke()}readFeatures(e,t){return this.readFeaturesFromText(ir(e),this.adaptOptions(t))}readFeaturesFromText(e,t){return ke()}readGeometry(e,t){return this.readGeometryFromText(ir(e),this.adaptOptions(t))}readGeometryFromText(e,t){return ke()}readProjection(e){return this.readProjectionFromText(ir(e))}readProjectionFromText(e){return this.dataProjection}writeFeature(e,t){return this.writeFeatureText(e,this.adaptOptions(t))}writeFeatureText(e,t){return ke()}writeFeatures(e,t){return this.writeFeaturesText(e,this.adaptOptions(t))}writeFeaturesText(e,t){return ke()}writeGeometry(e,t){return this.writeGeometryText(e,this.adaptOptions(t))}writeGeometryText(e,t){return ke()}}function ir(i){return typeof i=="string"?i:""}const Sc=/^B(\d{2})(\d{2})(\d{2})(\d{2})(\d{5})([NS])(\d{3})(\d{5})([EW])([AV])(\d{5})(\d{5})/,Pc=/^H.([A-Z]{3}).*?:(.*)/,wc=/^HFDTE(\d{2})(\d{2})(\d{2})/,bc=/^HFDTEDATE:(\d{2})(\d{2})(\d{2}),(\d{2})/,Lc=/\r\n|\r|\n/;class vc extends Mi{constructor(e){super(),e=e||{},this.dataProjection=K("EPSG:4326"),this.altitudeMode_=e.altitudeMode?e.altitudeMode:"none",this.lad_=!1,this.lod_=!1,this.ladStart_=0,this.ladStop_=0,this.lodStart_=0,this.lodStop_=0}readFeatureFromText(e,t){const r=this.altitudeMode_,n=e.split(Lc),s={},o=[];let a=2e3,l=0,c=1,h=-1,u,f;for(u=0,f=n.length;u<f;++u){const m=n[u];let E;if(m.charAt(0)=="B"){if(E=Sc.exec(m),E){const x=parseInt(E[1],10),T=parseInt(E[2],10),S=parseInt(E[3],10);let P=parseInt(E[4],10)+parseInt(E[5],10)/6e4;this.lad_&&(P+=parseInt(m.slice(this.ladStart_,this.ladStop_),10)/6e4/10**(this.ladStop_-this.ladStart_)),E[6]=="S"&&(P=-P);let R=parseInt(E[7],10)+parseInt(E[8],10)/6e4;if(this.lod_&&(R+=parseInt(m.slice(this.lodStart_,this.lodStop_),10)/6e4/10**(this.lodStop_-this.lodStart_)),E[9]=="W"&&(R=-R),o.push(R,P),r!="none"){let I;r=="gps"?I=parseInt(E[11],10):r=="barometric"?I=parseInt(E[12],10):I=0,o.push(I)}let L=Date.UTC(a,l,c,x,T,S);L<h&&(L=Date.UTC(a,l,c+1,x,T,S)),o.push(L/1e3),h=L}}else if(m.charAt(0)=="H")E=bc.exec(m),E?(c=parseInt(E[1],10),l=parseInt(E[2],10)-1,a=2e3+parseInt(E[3],10)):(E=wc.exec(m),E?(c=parseInt(E[1],10),l=parseInt(E[2],10)-1,a=2e3+parseInt(E[3],10)):(E=Pc.exec(m),E&&(s[E[1]]=E[2].trim())));else if(m.charAt(0)=="I"){const x=parseInt(m.slice(1,3),10);for(let T=0;T<x;T++){const S=m.slice(7+T*7,10+T*7);if(S==="LAD"||S==="LOD"){const P=parseInt(m.slice(3+T*7,5+T*7),10)-1,R=parseInt(m.slice(5+T*7,7+T*7),10);S==="LAD"?(this.lad_=!0,this.ladStart_=P,this.ladStop_=R):S==="LOD"&&(this.lod_=!0,this.lodStart_=P,this.lodStop_=R)}}}}if(o.length===0)return null;const g=r=="none"?"XYM":"XYZM",d=new Be(o,g),p=new Re(me(d,!1,t));return p.setProperties(s,!0),p}readFeaturesFromText(e,t){const r=this.readFeatureFromText(e,t);return r?[r]:[]}}const ge={VERSION1:"version1",VERSION2:"version2",VERSION3:"version3"},dt={};dt[ge.VERSION1]={level0:{supports:[],formats:[],qualities:["native"]},level1:{supports:["regionByPx","sizeByW","sizeByH","sizeByPct"],formats:["jpg"],qualities:["native"]},level2:{supports:["regionByPx","regionByPct","sizeByW","sizeByH","sizeByPct","sizeByConfinedWh","sizeByWh"],formats:["jpg","png"],qualities:["native","color","grey","bitonal"]}};dt[ge.VERSION2]={level0:{supports:[],formats:["jpg"],qualities:["default"]},level1:{supports:["regionByPx","sizeByW","sizeByH","sizeByPct"],formats:["jpg"],qualities:["default"]},level2:{supports:["regionByPx","regionByPct","sizeByW","sizeByH","sizeByPct","sizeByConfinedWh","sizeByDistortedWh","sizeByWh"],formats:["jpg","png"],qualities:["default","bitonal"]}};dt[ge.VERSION3]={level0:{supports:[],formats:["jpg"],qualities:["default"]},level1:{supports:["regionByPx","regionSquare","sizeByW","sizeByH","sizeByWh"],formats:["jpg"],qualities:["default"]},level2:{supports:["regionByPx","regionSquare","regionByPct","sizeByW","sizeByH","sizeByPct","sizeByConfinedWh","sizeByWh"],formats:["jpg","png"],qualities:["default"]}};dt.none={none:{supports:[],formats:[],qualities:[]}};const Ac=/^https?:\/\/library\.stanford\.edu\/iiif\/image-api\/(?:1\.1\/)?compliance\.html#level[0-2]$/,pn=/^https?:\/\/iiif\.io\/api\/image\/2\/level[0-2](?:\.json)?$/,Cc=/(^https?:\/\/iiif\.io\/api\/image\/3\/level[0-2](?:\.json)?$)|(^level[0-2]$)/;function Ic(i){let e=i.getComplianceLevelSupportedFeatures();return e===void 0&&(e=dt[ge.VERSION1].level0),{url:i.imageInfo["@id"]===void 0?void 0:i.imageInfo["@id"].replace(/\/?(?:info\.json)?$/g,""),supports:e.supports,formats:[...e.formats,i.imageInfo.formats===void 0?[]:i.imageInfo.formats],qualities:[...e.qualities,i.imageInfo.qualities===void 0?[]:i.imageInfo.qualities],resolutions:i.imageInfo.scale_factors,tileSize:i.imageInfo.tile_width!==void 0?i.imageInfo.tile_height!==void 0?[i.imageInfo.tile_width,i.imageInfo.tile_height]:[i.imageInfo.tile_width,i.imageInfo.tile_width]:i.imageInfo.tile_height!=null?[i.imageInfo.tile_height,i.imageInfo.tile_height]:void 0}}function Fc(i){const e=i.getComplianceLevelSupportedFeatures(),t=Array.isArray(i.imageInfo.profile)&&i.imageInfo.profile.length>1,r=t&&i.imageInfo.profile[1].supports?i.imageInfo.profile[1].supports:[],n=t&&i.imageInfo.profile[1].formats?i.imageInfo.profile[1].formats:[],s=t&&i.imageInfo.profile[1].qualities?i.imageInfo.profile[1].qualities:[];return{url:i.imageInfo["@id"].replace(/\/?(?:info\.json)?$/g,""),sizes:i.imageInfo.sizes===void 0?void 0:i.imageInfo.sizes.map(function(o){return[o.width,o.height]}),tileSize:i.imageInfo.tiles===void 0?void 0:[i.imageInfo.tiles.map(function(o){return o.width})[0],i.imageInfo.tiles.map(function(o){return o.height===void 0?o.width:o.height})[0]],resolutions:i.imageInfo.tiles===void 0?void 0:i.imageInfo.tiles.map(function(o){return o.scaleFactors})[0],supports:[...e.supports,...r],formats:[...e.formats,...n],qualities:[...e.qualities,...s]}}function Nc(i){const e=i.getComplianceLevelSupportedFeatures(),t=i.imageInfo.extraFormats===void 0?e.formats:[...e.formats,...i.imageInfo.extraFormats],r=i.imageInfo.preferredFormats!==void 0&&Array.isArray(i.imageInfo.preferredFormats)&&i.imageInfo.preferredFormats.length>0?i.imageInfo.preferredFormats.filter(function(n){return["jpg","png","gif"].includes(n)}).reduce(function(n,s){return n===void 0&&t.includes(s)?s:n},void 0):void 0;return{url:i.imageInfo.id,sizes:i.imageInfo.sizes===void 0?void 0:i.imageInfo.sizes.map(function(n){return[n.width,n.height]}),tileSize:i.imageInfo.tiles===void 0?void 0:[i.imageInfo.tiles.map(function(n){return n.width})[0],i.imageInfo.tiles.map(function(n){return n.height})[0]],resolutions:i.imageInfo.tiles===void 0?void 0:i.imageInfo.tiles.map(function(n){return n.scaleFactors})[0],supports:i.imageInfo.extraFeatures===void 0?e.supports:[...e.supports,...i.imageInfo.extraFeatures],formats:t,qualities:i.imageInfo.extraQualities===void 0?e.qualities:[...e.qualities,...i.imageInfo.extraQualities],preferredFormat:r}}const Fr={};Fr[ge.VERSION1]=Ic;Fr[ge.VERSION2]=Fc;Fr[ge.VERSION3]=Nc;class Mc{constructor(e){this.setImageInfo(e)}setImageInfo(e){typeof e=="string"?this.imageInfo=JSON.parse(e):this.imageInfo=e}getImageApiVersion(){if(this.imageInfo===void 0)return;let e=this.imageInfo["@context"]||"ol-no-context";typeof e=="string"&&(e=[e]);for(let t=0;t<e.length;t++)switch(e[t]){case"http://library.stanford.edu/iiif/image-api/1.1/context.json":case"http://iiif.io/api/image/1/context.json":return ge.VERSION1;case"http://iiif.io/api/image/2/context.json":return ge.VERSION2;case"http://iiif.io/api/image/3/context.json":return ge.VERSION3;case"ol-no-context":if(this.getComplianceLevelEntryFromProfile(ge.VERSION1)&&this.imageInfo.identifier)return ge.VERSION1;break}ve(!1,"Cannot determine IIIF Image API version from provided image information JSON")}getComplianceLevelEntryFromProfile(e){if(!(this.imageInfo===void 0||this.imageInfo.profile===void 0))switch(e===void 0&&(e=this.getImageApiVersion()),e){case ge.VERSION1:if(Ac.test(this.imageInfo.profile))return this.imageInfo.profile;break;case ge.VERSION3:if(Cc.test(this.imageInfo.profile))return this.imageInfo.profile;break;case ge.VERSION2:if(typeof this.imageInfo.profile=="string"&&pn.test(this.imageInfo.profile))return this.imageInfo.profile;if(Array.isArray(this.imageInfo.profile)&&this.imageInfo.profile.length>0&&typeof this.imageInfo.profile[0]=="string"&&pn.test(this.imageInfo.profile[0]))return this.imageInfo.profile[0];break}}getComplianceLevelFromProfile(e){const t=this.getComplianceLevelEntryFromProfile(e);if(t===void 0)return;const r=t.match(/level[0-2](?:\.json)?$/g);return Array.isArray(r)?r[0].replace(".json",""):void 0}getComplianceLevelSupportedFeatures(){if(this.imageInfo===void 0)return;const e=this.getImageApiVersion(),t=this.getComplianceLevelFromProfile(e);return t===void 0?dt.none.none:dt[e][t]}getTileSourceOptions(e){const t=e||{},r=this.getImageApiVersion();if(r===void 0)return;const n=r===void 0?void 0:Fr[r](this);if(n!==void 0)return{url:n.url,version:r,size:[this.imageInfo.width,this.imageInfo.height],sizes:n.sizes,format:t.format!==void 0&&n.formats.includes(t.format)?t.format:n.preferredFormat!==void 0?n.preferredFormat:"jpg",supports:n.supports,quality:t.quality&&n.qualities.includes(t.quality)?t.quality:n.qualities.includes("native")?"native":"default",resolutions:Array.isArray(n.resolutions)?n.resolutions.sort(function(s,o){return o-s}):void 0,tileSize:n.tileSize}}}class Oi{read(e){if(!e)return null;if(typeof e=="string"){const t=gr(e);return this.readFromDocument(t)}return pr(e)?this.readFromDocument(e):this.readFromNode(e)}readFromDocument(e){for(let t=e.firstChild;t;t=t.nextSibling)if(t.nodeType==Node.ELEMENT_NODE)return this.readFromNode(t);return null}readFromNode(e){ke()}}const Oc="http://www.w3.org/1999/xlink";function Ft(i){return i.getAttributeNS(Oc,"href")}const Pe=[null,"http://www.opengis.net/ows/1.1"],Dc=F(Pe,{ServiceIdentification:_(ou),ServiceProvider:_(lu),OperationsMetadata:_(nu)});class bs extends Oi{constructor(){super()}readFromNode(e){const t=A({},Dc,e,[]);return t||null}}const Gc=F(Pe,{DeliveryPoint:_(v),City:_(v),AdministrativeArea:_(v),PostalCode:_(v),Country:_(v),ElectronicMailAddress:_(v)}),Uc=F(Pe,{Value:te(cu)}),Bc=F(Pe,{AllowedValues:_(Kc)}),zc=F(Pe,{Phone:_(su),Address:_(qc)}),$c=F(Pe,{HTTP:_(ru)}),Xc=F(Pe,{Get:te(tu),Post:void 0}),kc=F(Pe,{DCP:_(eu)}),jc=F(Pe,{Operation:iu}),Wc=F(Pe,{Voice:_(v),Facsimile:_(v)}),Zc=F(Pe,{Constraint:te(Jc)}),Hc=F(Pe,{IndividualName:_(v),PositionName:_(v),ContactInfo:_(Qc)}),Vc=F(Pe,{Abstract:_(v),AccessConstraints:_(v),Fees:_(v),Title:_(v),ServiceTypeVersion:_(v),ServiceType:_(v)}),Yc=F(Pe,{ProviderName:_(v),ProviderSite:_(Ft),ServiceContact:_(au)});function qc(i,e){return A({},Gc,i,e)}function Kc(i,e){return A({},Uc,i,e)}function Jc(i,e){const t=i.getAttribute("name");if(t)return A({name:t},Bc,i,e)}function Qc(i,e){return A({},zc,i,e)}function eu(i,e){return A({},$c,i,e)}function tu(i,e){const t=Ft(i);if(t)return A({href:t},Zc,i,e)}function ru(i,e){return A({},Xc,i,e)}function iu(i,e){const t=i.getAttribute("name"),r=A({},kc,i,e);if(!r)return;const n=e[e.length-1];n[t]=r}function nu(i,e){return A({},jc,i,e)}function su(i,e){return A({},Wc,i,e)}function ou(i,e){return A({},Vc,i,e)}function au(i,e){return A({},Hc,i,e)}function lu(i,e){return A({},Yc,i,e)}function cu(i,e){return v(i)}function mn(i,e,t,r,n,s){n!==void 0?(n=n,s=s!==void 0?s:0):(n=[],s=0);let o=e;for(;o<t;){const a=i[o++];n[s++]=i[o++],n[s++]=a;for(let l=2;l<r;++l)n[s++]=i[o++]}return n.length=s,n}class uu extends Mi{constructor(e){super(),e=e||{},this.dataProjection=K("EPSG:4326"),this.factor_=e.factor?e.factor:1e5,this.geometryLayout_=e.geometryLayout?e.geometryLayout:"XY"}readFeatureFromText(e,t){const r=this.readGeometryFromText(e,t);return new Re(r)}readFeaturesFromText(e,t){return[this.readFeatureFromText(e,t)]}readGeometryFromText(e,t){const r=zo(this.geometryLayout_),n=du(e,r,this.factor_);mn(n,0,n.length,r,n);const s=new Be(n,this.geometryLayout_);return me(s,!1,this.adaptOptions(t))}writeFeatureText(e,t){const r=e.getGeometry();if(r)return this.writeGeometryText(r,t);throw new Error("Expected `feature` to have a geometry")}writeFeaturesText(e,t){return this.writeFeatureText(e[0],t)}writeGeometryText(e,t){e=me(e,!0,this.adaptOptions(t));const r=e.getFlatCoordinates(),n=e.getStride();return mn(r,0,r.length,n,r),hu(r,n,this.factor_)}}function hu(i,e,t){t=t||1e5;const r=new Array(e).fill(0);for(let n=0,s=i.length;n<s;)for(let o=0;o<e;++o,++n){const a=i[n]*t,l=a<0?Math.ceil(a-.5):Math.round(a),c=l-r[o];r[o]=l,i[n]=c}return fu(i)}function du(i,e,t){t=t||1e5;const r=new Array(e).fill(0),n=gu(i);for(let s=0,o=n.length;s<o;)for(let a=0;a<e;++a,++s)r[a]+=n[s],n[s]=r[a]/t;return n}function fu(i){for(let e=0,t=i.length;e<t;++e){const r=i[e];i[e]=r<0?~(r<<1):r<<1}return pu(i)}function gu(i){const e=mu(i);for(let t=0,r=e.length;t<r;++t){const n=e[t];e[t]=n&1?~(n>>1):n>>1}return e}function pu(i){let e="";for(let t=0,r=i.length;t<r;++t)e+=_u(i[t]);return e}function mu(i){const e=[];let t=0,r=0;for(let n=0,s=i.length;n<s;++n){const o=i.charCodeAt(n)-63;t|=(o&31)<<r,o<32?(e.push(t),t=0,r=0):r+=5}return e}function _u(i){let e,t="";for(;i>=32;)e=(32|i&31)+63,t+=String.fromCharCode(e),i>>=5;return e=i+63,t+=String.fromCharCode(e),t}class q extends b{constructor(e){e=e||{},super(e),this.schemaLocation=e.schemaLocation?e.schemaLocation:this.namespace+" http://schemas.opengis.net/gml/3.2.1/gml.xsd"}writeGeometryElement(e,t,r){const n=r[r.length-1];r[r.length-1]=Object.assign({multiCurve:!0,multiSurface:!0},n),super.writeGeometryElement(e,t,r)}}q.prototype.namespace="http://www.opengis.net/gml/3.2";q.prototype.GEOMETRY_FLAT_COORDINATES_PARSERS={"http://www.opengis.net/gml/3.2":{pos:G(b.prototype.readFlatPos),posList:G(b.prototype.readFlatPosList),coordinates:G(W.prototype.readFlatCoordinates)}};q.prototype.FLAT_LINEAR_RINGS_PARSERS={"http://www.opengis.net/gml/3.2":{interior:b.prototype.interiorParser,exterior:b.prototype.exteriorParser}};q.prototype.GEOMETRY_PARSERS={"http://www.opengis.net/gml/3.2":{Point:G(N.prototype.readPoint),MultiPoint:G(N.prototype.readMultiPoint),LineString:G(N.prototype.readLineString),MultiLineString:G(N.prototype.readMultiLineString),LinearRing:G(N.prototype.readLinearRing),Polygon:G(N.prototype.readPolygon),MultiPolygon:G(N.prototype.readMultiPolygon),Surface:G(q.prototype.readSurface),MultiSurface:G(b.prototype.readMultiSurface),Curve:G(q.prototype.readCurve),MultiCurve:G(b.prototype.readMultiCurve),Envelope:G(q.prototype.readEnvelope)}};q.prototype.MULTICURVE_PARSERS={"http://www.opengis.net/gml/3.2":{curveMember:O(b.prototype.curveMemberParser),curveMembers:O(b.prototype.curveMemberParser)}};q.prototype.MULTISURFACE_PARSERS={"http://www.opengis.net/gml/3.2":{surfaceMember:O(b.prototype.surfaceMemberParser),surfaceMembers:O(b.prototype.surfaceMemberParser)}};q.prototype.CURVEMEMBER_PARSERS={"http://www.opengis.net/gml/3.2":{LineString:O(N.prototype.readLineString),Curve:O(b.prototype.readCurve)}};q.prototype.SURFACEMEMBER_PARSERS={"http://www.opengis.net/gml/3.2":{Polygon:O(N.prototype.readPolygon),Surface:O(b.prototype.readSurface)}};q.prototype.SURFACE_PARSERS={"http://www.opengis.net/gml/3.2":{patches:G(b.prototype.readPatch)}};q.prototype.CURVE_PARSERS={"http://www.opengis.net/gml/3.2":{segments:G(b.prototype.readSegment)}};q.prototype.ENVELOPE_PARSERS={"http://www.opengis.net/gml/3.2":{lowerCorner:O(b.prototype.readFlatPosList),upperCorner:O(b.prototype.readFlatPosList)}};q.prototype.PATCHES_PARSERS={"http://www.opengis.net/gml/3.2":{PolygonPatch:G(b.prototype.readPolygonPatch)}};q.prototype.SEGMENTS_PARSERS={"http://www.opengis.net/gml/3.2":{LineStringSegment:as(b.prototype.readLineStringSegment)}};q.prototype.MULTIPOINT_PARSERS={"http://www.opengis.net/gml/3.2":{pointMember:O(N.prototype.pointMemberParser),pointMembers:O(N.prototype.pointMemberParser)}};q.prototype.MULTILINESTRING_PARSERS={"http://www.opengis.net/gml/3.2":{lineStringMember:O(N.prototype.lineStringMemberParser),lineStringMembers:O(N.prototype.lineStringMemberParser)}};q.prototype.MULTIPOLYGON_PARSERS={"http://www.opengis.net/gml/3.2":{polygonMember:O(N.prototype.polygonMemberParser),polygonMembers:O(N.prototype.polygonMemberParser)}};q.prototype.POINTMEMBER_PARSERS={"http://www.opengis.net/gml/3.2":{Point:O(N.prototype.readFlatCoordinatesFromNode)}};q.prototype.LINESTRINGMEMBER_PARSERS={"http://www.opengis.net/gml/3.2":{LineString:O(N.prototype.readLineString)}};q.prototype.POLYGONMEMBER_PARSERS={"http://www.opengis.net/gml/3.2":{Polygon:O(N.prototype.readPolygon)}};q.prototype.RING_PARSERS={"http://www.opengis.net/gml/3.2":{LinearRing:G(N.prototype.readFlatLinearRing),Ring:G(q.prototype.readFlatCurveRing)}};q.prototype.RING_SERIALIZERS={"http://www.opengis.net/gml/3.2":{exterior:y(b.prototype.writeRing),interior:y(b.prototype.writeRing)}};q.prototype.ENVELOPE_SERIALIZERS={"http://www.opengis.net/gml/3.2":{lowerCorner:y(H),upperCorner:y(H)}};q.prototype.SURFACEORPOLYGONMEMBER_SERIALIZERS={"http://www.opengis.net/gml/3.2":{surfaceMember:y(b.prototype.writeSurfaceOrPolygonMember),polygonMember:y(b.prototype.writeSurfaceOrPolygonMember)}};q.prototype.POINTMEMBER_SERIALIZERS={"http://www.opengis.net/gml/3.2":{pointMember:y(b.prototype.writePointMember)}};q.prototype.LINESTRINGORCURVEMEMBER_SERIALIZERS={"http://www.opengis.net/gml/3.2":{lineStringMember:y(b.prototype.writeLineStringOrCurveMember),curveMember:y(b.prototype.writeLineStringOrCurveMember)}};q.prototype.GEOMETRY_SERIALIZERS={"http://www.opengis.net/gml/3.2":{Curve:y(b.prototype.writeCurveOrLineString),MultiCurve:y(b.prototype.writeMultiCurveOrLineString),Point:y(q.prototype.writePoint),MultiPoint:y(b.prototype.writeMultiPoint),LineString:y(b.prototype.writeCurveOrLineString),MultiLineString:y(b.prototype.writeMultiCurveOrLineString),LinearRing:y(b.prototype.writeLinearRing),Polygon:y(b.prototype.writeSurfaceOrPolygon),MultiPolygon:y(b.prototype.writeMultiSurfaceOrPolygon),Surface:y(b.prototype.writeSurfaceOrPolygon),MultiSurface:y(b.prototype.writeMultiSurfaceOrPolygon),Envelope:y(b.prototype.writeEnvelope)}};class Ls{constructor(e){this.tagName_=e}getTagName(){return this.tagName_}}class Eu extends Ls{constructor(e,t){super(e),this.conditions=t,ve(this.conditions.length>=2,"At least 2 conditions are required")}}class yu extends Eu{constructor(e){super("And",Array.prototype.slice.call(arguments))}}class xu extends Ls{constructor(e,t,r){if(super("BBOX"),this.geometryName=e,this.extent=t,t.length!==4)throw new Error("Expected an extent with four values ([minX, minY, maxX, maxY])");this.srsName=r}}function Tu(i){const e=[null].concat(Array.prototype.slice.call(arguments));return new(Function.prototype.bind.apply(yu,e))}function Ru(i,e,t){return new xu(i,e,t)}const _n={"http://www.opengis.net/gml":{boundedBy:_(N.prototype.readExtentElement,"bounds")},"http://www.opengis.net/wfs/2.0":{member:O(N.prototype.readFeaturesInternal)}},Su={"http://www.opengis.net/wfs":{totalInserted:_(fe),totalUpdated:_(fe),totalDeleted:_(fe)},"http://www.opengis.net/wfs/2.0":{totalInserted:_(fe),totalUpdated:_(fe),totalDeleted:_(fe)}},Pu={"http://www.opengis.net/wfs":{TransactionSummary:_(yn,"transactionSummary"),InsertResults:_(Tn,"insertIds")},"http://www.opengis.net/wfs/2.0":{TransactionSummary:_(yn,"transactionSummary"),InsertResults:_(Tn,"insertIds")}},wu={"http://www.opengis.net/wfs":{PropertyName:y(H)},"http://www.opengis.net/wfs/2.0":{PropertyName:y(H)}},vs={"http://www.opengis.net/wfs":{Insert:y(Rn),Update:y(Pn),Delete:y(Sn),Property:y(wn),Native:y(bn)},"http://www.opengis.net/wfs/2.0":{Insert:y(Rn),Update:y(Pn),Delete:y(Sn),Property:y(wn),Native:y(bn)}},As="feature",Di="http://www.w3.org/2000/xmlns/",Gi={"2.0.0":"http://www.opengis.net/ogc/1.1","1.1.0":"http://www.opengis.net/ogc","1.0.0":"http://www.opengis.net/ogc"},ri={"2.0.0":"http://www.opengis.net/wfs/2.0","1.1.0":"http://www.opengis.net/wfs","1.0.0":"http://www.opengis.net/wfs"},Ui={"2.0.0":"http://www.opengis.net/fes/2.0","1.1.0":"http://www.opengis.net/fes","1.0.0":"http://www.opengis.net/fes"},En={"2.0.0":"http://www.opengis.net/wfs/2.0 http://schemas.opengis.net/wfs/2.0/wfs.xsd","1.1.0":"http://www.opengis.net/wfs http://schemas.opengis.net/wfs/1.1.0/wfs.xsd","1.0.0":"http://www.opengis.net/wfs http://schemas.opengis.net/wfs/1.0.0/wfs.xsd"},Bi={"2.0.0":q,"1.1.0":b,"1.0.0":W},bu="1.1.0";class Lu extends vr{constructor(e){super(),e=e||{},this.version_=e.version?e.version:bu,this.featureType_=e.featureType,this.featureNS_=e.featureNS,this.gmlFormat_=e.gmlFormat?e.gmlFormat:new Bi[this.version_],this.schemaLocation_=e.schemaLocation?e.schemaLocation:En[this.version_]}getFeatureType(){return this.featureType_}setFeatureType(e){this.featureType_=e}readFeaturesFromNode(e,t){const r={node:e};Object.assign(r,{featureType:this.featureType_,featureNS:this.featureNS_}),Object.assign(r,this.getReadOptions(e,t||{}));const n=[r];let s;this.version_==="2.0.0"?s=_n:s=this.gmlFormat_.FEATURE_COLLECTION_PARSERS;let o=A([],s,e,n,this.gmlFormat_);return o||(o=[]),o}readTransactionResponse(e){if(e){if(typeof e=="string"){const t=gr(e);return this.readTransactionResponseFromDocument(t)}return pr(e)?this.readTransactionResponseFromDocument(e):this.readTransactionResponseFromNode(e)}}readFeatureCollectionMetadata(e){if(e){if(typeof e=="string"){const t=gr(e);return this.readFeatureCollectionMetadataFromDocument(t)}return pr(e)?this.readFeatureCollectionMetadataFromDocument(e):this.readFeatureCollectionMetadataFromNode(e)}}readFeatureCollectionMetadataFromDocument(e){for(let t=e.firstChild;t;t=t.nextSibling)if(t.nodeType==Node.ELEMENT_NODE)return this.readFeatureCollectionMetadataFromNode(t)}readFeatureCollectionMetadataFromNode(e){const t={},r=Je(e.getAttribute("numberOfFeatures"));return t.numberOfFeatures=r,A(t,_n,e,[],this.gmlFormat_)}readTransactionResponseFromDocument(e){for(let t=e.firstChild;t;t=t.nextSibling)if(t.nodeType==Node.ELEMENT_NODE)return this.readTransactionResponseFromNode(t)}readTransactionResponseFromNode(e){return A({},Pu,e,[])}writeGetFeature(e){const t=k(ri[this.version_],"GetFeature");t.setAttribute("service","WFS"),t.setAttribute("version",this.version_),e.handle&&t.setAttribute("handle",e.handle),e.outputFormat&&t.setAttribute("outputFormat",e.outputFormat),e.maxFeatures!==void 0&&t.setAttribute("maxFeatures",String(e.maxFeatures)),e.resultType&&t.setAttribute("resultType",e.resultType),e.startIndex!==void 0&&t.setAttribute("startIndex",String(e.startIndex)),e.count!==void 0&&t.setAttribute("count",String(e.count)),e.viewParams!==void 0&&t.setAttribute("viewParams",e.viewParams),t.setAttributeNS(Bt,"xsi:schemaLocation",this.schemaLocation_);const r={node:t};if(Object.assign(r,{version:this.version_,srsName:e.srsName,featureNS:e.featureNS?e.featureNS:this.featureNS_,featurePrefix:e.featurePrefix,propertyNames:e.propertyNames?e.propertyNames:[]}),ve(Array.isArray(e.featureTypes),"`options.featureTypes` must be an Array"),typeof e.featureTypes[0]=="string"){let n=e.filter;e.bbox&&(ve(e.geometryName,"`options.geometryName` must also be provided when `options.bbox` is set"),n=this.combineBboxAndFilter(e.geometryName,e.bbox,e.srsName,n)),Object.assign(r,{geometryName:e.geometryName,filter:n}),Dn(t,e.featureTypes,[r])}else e.featureTypes.forEach(n=>{const s=this.combineBboxAndFilter(n.geometryName,n.bbox,e.srsName,e.filter);Object.assign(r,{geometryName:n.geometryName,filter:s}),Dn(t,[n.name],[r])});return t}combineBboxAndFilter(e,t,r,n){const s=Ru(e,t,r);return n?Tu(n,s):s}writeTransaction(e,t,r,n){const s=[],o=n.version?n.version:this.version_,a=k(ri[o],"Transaction");a.setAttribute("service","WFS"),a.setAttribute("version",o);let l;n&&(l=n.gmlOptions?n.gmlOptions:{},n.handle&&a.setAttribute("handle",n.handle)),a.setAttributeNS(Bt,"xsi:schemaLocation",En[o]);const c=vu(a,l,o,n);return e&&nr("Insert",e,s,c),t&&nr("Update",t,s,c),r&&nr("Delete",r,s,c),n.nativeElements&&nr("Native",n.nativeElements,s,c),a}readProjectionFromDocument(e){for(let t=e.firstChild;t;t=t.nextSibling)if(t.nodeType==Node.ELEMENT_NODE)return this.readProjectionFromNode(t);return null}readProjectionFromNode(e){if(e.firstElementChild&&e.firstElementChild.firstElementChild){e=e.firstElementChild.firstElementChild;for(let t=e.firstElementChild;t;t=t.nextElementSibling)if(!(t.childNodes.length===0||t.childNodes.length===1&&t.firstChild.nodeType===3)){const r=[{}];return this.gmlFormat_.readGeometryElement(t,r),K(r.pop().srsName)}}return null}}function vu(i,e,t,r){const n=r.featurePrefix?r.featurePrefix:As;let s;return t==="1.0.0"?s=2:t==="1.1.0"?s=3:t==="2.0.0"&&(s=3.2),Object.assign({node:i},{version:t,featureNS:r.featureNS,featureType:r.featureType,featurePrefix:n,gmlVersion:s,hasZ:r.hasZ,srsName:r.srsName},e)}function nr(i,e,t,r){ie(r,vs,Le(i),e,t)}function yn(i,e){return A({},Su,i,e)}const Au={"http://www.opengis.net/ogc":{FeatureId:O(function(i,e){return i.getAttribute("fid")})},"http://www.opengis.net/ogc/1.1":{FeatureId:O(function(i,e){return i.getAttribute("fid")})}};function xn(i,e){et(Au,i,e)}const Cu={"http://www.opengis.net/wfs":{Feature:xn},"http://www.opengis.net/wfs/2.0":{Feature:xn}};function Tn(i,e){return A([],Cu,i,e)}function Rn(i,e,t){const r=t[t.length-1],n=r.featureType,s=r.featureNS,o=r.gmlVersion,a=k(s,n);i.appendChild(a),o===2?W.prototype.writeFeatureElement(a,e,t):o===3?b.prototype.writeFeatureElement(a,e,t):q.prototype.writeFeatureElement(a,e,t)}function Cs(i,e,t){const n=t[t.length-1].version,s=Gi[n],o=k(s,"Filter"),a=k(s,"FeatureId");o.appendChild(a),a.setAttribute("fid",e),i.appendChild(o)}function zi(i,e){i=i||As;const t=i+":";return e.startsWith(t)?e:t+e}function Sn(i,e,t){const r=t[t.length-1];ve(e.getId()!==void 0,"Features must have an id set");const n=r.featureType,s=r.featurePrefix,o=r.featureNS,a=zi(s,n);i.setAttribute("typeName",a),i.setAttributeNS(Di,"xmlns:"+s,o);const l=e.getId();l!==void 0&&Cs(i,l,t)}function Pn(i,e,t){const r=t[t.length-1];ve(e.getId()!==void 0,"Features must have an id set");const n=r.version,s=r.featureType,o=r.featurePrefix,a=r.featureNS,l=zi(o,s),c=e.getGeometryName();i.setAttribute("typeName",l),i.setAttributeNS(Di,"xmlns:"+o,a);const h=e.getId();if(h!==void 0){const u=e.getKeys(),f=[];for(let g=0,d=u.length;g<d;g++){const p=e.get(u[g]);if(p!==void 0){let m=u[g];p&&typeof p.getSimplifiedGeometry=="function"&&(m=c),f.push({name:m,value:p})}}ie({version:n,gmlVersion:r.gmlVersion,node:i,hasZ:r.hasZ,srsName:r.srsName},vs,Le("Property"),f,t),Cs(i,h,t)}}function wn(i,e,t){const r=t[t.length-1],n=r.version,s=ri[n],a=k(s,n==="2.0.0"?"ValueReference":"Name"),l=r.gmlVersion;if(i.appendChild(a),H(a,e.name),e.value!==void 0&&e.value!==null){const c=k(s,"Value");i.appendChild(c),e.value&&typeof e.value.getSimplifiedGeometry=="function"?l===2?W.prototype.writeGeometryElement(c,e.value,t):l===3?b.prototype.writeGeometryElement(c,e.value,t):q.prototype.writeGeometryElement(c,e.value,t):H(c,e.value)}}function bn(i,e,t){e.vendorId&&i.setAttribute("vendorId",e.vendorId),e.safeToIgnore!==void 0&&i.setAttribute("safeToIgnore",String(e.safeToIgnore)),e.value!==void 0&&H(i,e.value)}const Nr={"http://www.opengis.net/wfs":{Query:y(Ln)},"http://www.opengis.net/wfs/2.0":{Query:y(Ln)},"http://www.opengis.net/ogc":{During:y(Cn),And:y(sr),Or:y(sr),Not:y(In),BBOX:y(vn),Contains:y(Ke),Intersects:y(Ke),Within:y(Ke),DWithin:y(An),PropertyIsEqualTo:y(Ae),PropertyIsNotEqualTo:y(Ae),PropertyIsLessThan:y(Ae),PropertyIsLessThanOrEqualTo:y(Ae),PropertyIsGreaterThan:y(Ae),PropertyIsGreaterThanOrEqualTo:y(Ae),PropertyIsNull:y(Fn),PropertyIsBetween:y(Nn),PropertyIsLike:y(Mn)},"http://www.opengis.net/fes/2.0":{During:y(Cn),And:y(sr),Or:y(sr),Not:y(In),BBOX:y(vn),Contains:y(Ke),Disjoint:y(Ke),Intersects:y(Ke),ResourceId:y(Fu),Within:y(Ke),DWithin:y(An),PropertyIsEqualTo:y(Ae),PropertyIsNotEqualTo:y(Ae),PropertyIsLessThan:y(Ae),PropertyIsLessThanOrEqualTo:y(Ae),PropertyIsGreaterThan:y(Ae),PropertyIsGreaterThanOrEqualTo:y(Ae),PropertyIsNull:y(Fn),PropertyIsBetween:y(Nn),PropertyIsLike:y(Mn)}};function Ln(i,e,t){const r=t[t.length-1],n=r.version,s=r.featurePrefix,o=r.featureNS,a=r.propertyNames,l=r.srsName;let c;s?c=zi(s,e):c=e;let h;n==="2.0.0"?h="typeNames":h="typeName",i.setAttribute(h,c),l&&i.setAttribute("srsName",l),o&&i.setAttributeNS(Di,"xmlns:"+s,o);const u=Object.assign({},r);u.node=i,ie(u,wu,Le("PropertyName"),a,t);const f=r.filter;if(f){const g=k(Mr(n),"Filter");i.appendChild(g),Iu(g,f,t)}}function Iu(i,e,t){const r=t[t.length-1],n={node:i};Object.assign(n,{context:r}),ie(n,Nr,Le(e.getTagName()),[e],t)}function vn(i,e,t){const r=t[t.length-1],s=r.context.version;r.srsName=e.srsName;const o=Bi[s];Nt(s,i,e.geometryName),o.prototype.writeGeometryElement(i,e.extent,t)}function Fu(i,e,t){i.setAttribute("rid",e.rid)}function Ke(i,e,t){const r=t[t.length-1],s=r.context.version;r.srsName=e.srsName;const o=Bi[s];Nt(s,i,e.geometryName),o.prototype.writeGeometryElement(i,e.geometry,t)}function An(i,e,t){const s=t[t.length-1].context.version;Ke(i,e,t);const o=k(Mr(s),"Distance");H(o,e.distance.toString()),s==="2.0.0"?o.setAttribute("uom",e.unit):o.setAttribute("units",e.unit),i.appendChild(o)}function Cn(i,e,t){const s=t[t.length-1].context.version;xr(Ui[s],"ValueReference",i,e.propertyName);const o=k(He,"TimePeriod");i.appendChild(o);const a=k(He,"begin");o.appendChild(a),On(a,e.begin);const l=k(He,"end");o.appendChild(l),On(l,e.end)}function sr(i,e,t){const n=t[t.length-1].context,s={node:i};Object.assign(s,{context:n});const o=e.conditions;for(let a=0,l=o.length;a<l;++a){const c=o[a];ie(s,Nr,Le(c.getTagName()),[c],t)}}function In(i,e,t){const n=t[t.length-1].context,s={node:i};Object.assign(s,{context:n});const o=e.condition;ie(s,Nr,Le(o.getTagName()),[o],t)}function Ae(i,e,t){const s=t[t.length-1].context.version;e.matchCase!==void 0&&i.setAttribute("matchCase",e.matchCase.toString()),Nt(s,i,e.propertyName),Tr(s,i,""+e.expression)}function Fn(i,e,t){const s=t[t.length-1].context.version;Nt(s,i,e.propertyName)}function Nn(i,e,t){const s=t[t.length-1].context.version,o=Mr(s);Nt(s,i,e.propertyName);const a=k(o,"LowerBoundary");i.appendChild(a),Tr(s,a,""+e.lowerBoundary);const l=k(o,"UpperBoundary");i.appendChild(l),Tr(s,l,""+e.upperBoundary)}function Mn(i,e,t){const s=t[t.length-1].context.version;i.setAttribute("wildCard",e.wildCard),i.setAttribute("singleChar",e.singleChar),i.setAttribute("escapeChar",e.escapeChar),e.matchCase!==void 0&&i.setAttribute("matchCase",e.matchCase.toString()),Nt(s,i,e.propertyName),Tr(s,i,""+e.pattern)}function xr(i,e,t,r){const n=k(i,e);H(n,r),t.appendChild(n)}function Tr(i,e,t){xr(Mr(i),"Literal",e,t)}function Nt(i,e,t){i==="2.0.0"?xr(Ui[i],"ValueReference",e,t):xr(Gi[i],"PropertyName",e,t)}function On(i,e){const t=k(He,"TimeInstant");i.appendChild(t);const r=k(He,"timePosition");t.appendChild(r),H(r,e)}function Dn(i,e,t){const r=t[t.length-1],n=Object.assign({},r);n.node=i,ie(n,Nr,Le("Query"),e,t)}function Mr(i){let e;return i==="2.0.0"?e=Ui[i]:e=Gi[i],e}const re={POINT:1,LINE_STRING:2,POLYGON:3,MULTI_POINT:4,MULTI_LINE_STRING:5,MULTI_POLYGON:6,GEOMETRY_COLLECTION:7,POLYHEDRAL_SURFACE:15,TIN:16,TRIANGLE:17};class Gn{constructor(e){this.view_=e,this.pos_=0,this.initialized_=!1,this.isLittleEndian_=!1,this.hasZ_=!1,this.hasM_=!1,this.srid_=null,this.layout_="XY"}readUint8(){return this.view_.getUint8(this.pos_++)}readUint32(e){return this.view_.getUint32((this.pos_+=4)-4,e!==void 0?e:this.isLittleEndian_)}readDouble(e){return this.view_.getFloat64((this.pos_+=8)-8,e!==void 0?e:this.isLittleEndian_)}readPoint(){const e=[];return e.push(this.readDouble()),e.push(this.readDouble()),this.hasZ_&&e.push(this.readDouble()),this.hasM_&&e.push(this.readDouble()),e}readLineString(){const e=this.readUint32(),t=[];for(let r=0;r<e;r++)t.push(this.readPoint());return t}readPolygon(){const e=this.readUint32(),t=[];for(let r=0;r<e;r++)t.push(this.readLineString());return t}readWkbHeader(e){const r=this.readUint8()>0,n=this.readUint32(r),s=Math.floor((n&268435455)/1e3),o=!!(n&2147483648)||s===1||s===3,a=!!(n&1073741824)||s===2||s===3,l=!!(n&536870912),c=(n&268435455)%1e3,h=["XY",o?"Z":"",a?"M":""].join(""),u=l?this.readUint32(r):null;if(e!==void 0&&e!==c)throw new Error("Unexpected WKB geometry type "+c);if(this.initialized_){if(this.isLittleEndian_!==r)throw new Error("Inconsistent endian");if(this.layout_!==h)throw new Error("Inconsistent geometry layout");if(u&&this.srid_!==u)throw new Error("Inconsistent coordinate system (SRID)")}else this.isLittleEndian_=r,this.hasZ_=o,this.hasM_=a,this.layout_=h,this.srid_=u,this.initialized_=!0;return c}readWkbPayload(e){switch(e){case re.POINT:return this.readPoint();case re.LINE_STRING:return this.readLineString();case re.POLYGON:case re.TRIANGLE:return this.readPolygon();case re.MULTI_POINT:return this.readMultiPoint();case re.MULTI_LINE_STRING:return this.readMultiLineString();case re.MULTI_POLYGON:case re.POLYHEDRAL_SURFACE:case re.TIN:return this.readMultiPolygon();case re.GEOMETRY_COLLECTION:return this.readGeometryCollection();default:throw new Error("Unsupported WKB geometry type "+e+" is found")}}readWkbBlock(e){return this.readWkbPayload(this.readWkbHeader(e))}readWkbCollection(e,t){const r=this.readUint32(),n=[];for(let s=0;s<r;s++){const o=e.call(this,t);o&&n.push(o)}return n}readMultiPoint(){return this.readWkbCollection(this.readWkbBlock,re.POINT)}readMultiLineString(){return this.readWkbCollection(this.readWkbBlock,re.LINE_STRING)}readMultiPolygon(){return this.readWkbCollection(this.readWkbBlock,re.POLYGON)}readGeometryCollection(){return this.readWkbCollection(this.readGeometry)}readGeometry(){const e=this.readWkbHeader(),t=this.readWkbPayload(e);switch(e){case re.POINT:return new Ie(t,this.layout_);case re.LINE_STRING:return new Be(t,this.layout_);case re.POLYGON:case re.TRIANGLE:return new ut(t,this.layout_);case re.MULTI_POINT:return new Lr(t,this.layout_);case re.MULTI_LINE_STRING:return new vt(t,this.layout_);case re.MULTI_POLYGON:case re.POLYHEDRAL_SURFACE:case re.TIN:return new Zt(t,this.layout_);case re.GEOMETRY_COLLECTION:return new it(t);default:return null}}getSrid(){return this.srid_}}class Nu{constructor(e){e=e||{},this.layout_=e.layout,this.isLittleEndian_=e.littleEndian!==!1,this.isEWKB_=e.ewkb!==!1,this.writeQueue_=[],this.nodata_=Object.assign({X:0,Y:0,Z:0,M:0},e.nodata)}writeUint8(e){this.writeQueue_.push([1,e])}writeUint32(e){this.writeQueue_.push([4,e])}writeDouble(e){this.writeQueue_.push([8,e])}writePoint(e,t){const r=Object.assign.apply(null,t.split("").map((n,s)=>({[n]:e[s]})));for(const n of this.layout_)this.writeDouble(n in r?r[n]:this.nodata_[n])}writeLineString(e,t){this.writeUint32(e.length);for(let r=0;r<e.length;r++)this.writePoint(e[r],t)}writePolygon(e,t){this.writeUint32(e.length);for(let r=0;r<e.length;r++)this.writeLineString(e[r],t)}writeWkbHeader(e,t){e%=1e3,this.layout_.includes("Z")&&(e+=this.isEWKB_?2147483648:1e3),this.layout_.includes("M")&&(e+=this.isEWKB_?1073741824:2e3),this.isEWKB_&&Number.isInteger(t)&&(e|=536870912),this.writeUint8(this.isLittleEndian_?1:0),this.writeUint32(e),this.isEWKB_&&Number.isInteger(t)&&this.writeUint32(t)}writeMultiPoint(e,t){this.writeUint32(e.length);for(let r=0;r<e.length;r++)this.writeWkbHeader(1),this.writePoint(e[r],t)}writeMultiLineString(e,t){this.writeUint32(e.length);for(let r=0;r<e.length;r++)this.writeWkbHeader(2),this.writeLineString(e[r],t)}writeMultiPolygon(e,t){this.writeUint32(e.length);for(let r=0;r<e.length;r++)this.writeWkbHeader(3),this.writePolygon(e[r],t)}writeGeometryCollection(e){this.writeUint32(e.length);for(let t=0;t<e.length;t++)this.writeGeometry(e[t])}findMinimumLayout(e,t="XYZM"){const r=(n,s)=>n===s?n:n==="XYZM"?s:s==="XYZM"?n:"XY";if(e instanceof Qi)return r(e.getLayout(),t);if(e instanceof it){const n=e.getGeometriesArray();for(let s=0;s<n.length&&t!=="XY";s++)t=this.findMinimumLayout(n[s],t)}return t}writeGeometry(e,t){const r={Point:re.POINT,LineString:re.LINE_STRING,Polygon:re.POLYGON,MultiPoint:re.MULTI_POINT,MultiLineString:re.MULTI_LINE_STRING,MultiPolygon:re.MULTI_POLYGON,GeometryCollection:re.GEOMETRY_COLLECTION},n=e.getType(),s=r[n];if(!s)throw new Error("GeometryType "+n+" is not supported");this.layout_||(this.layout_=this.findMinimumLayout(e)),this.writeWkbHeader(s,t),e instanceof Qi?{Point:this.writePoint,LineString:this.writeLineString,Polygon:this.writePolygon,MultiPoint:this.writeMultiPoint,MultiLineString:this.writeMultiLineString,MultiPolygon:this.writeMultiPolygon}[n].call(this,e.getCoordinates(),e.getLayout()):e instanceof it&&this.writeGeometryCollection(e.getGeometriesArray())}getBuffer(){const e=this.writeQueue_.reduce((s,o)=>s+o[0],0),t=new ArrayBuffer(e),r=new DataView(t);let n=0;return this.writeQueue_.forEach(s=>{switch(s[0]){case 1:r.setUint8(n,s[1]);break;case 4:r.setUint32(n,s[1],this.isLittleEndian_);break;case 8:r.setFloat64(n,s[1],this.isLittleEndian_);break}n+=s[0]}),t}}class Mu extends cs{constructor(e){super(),e=e||{},this.splitCollection=!!e.splitCollection,this.viewCache_=null,this.hex_=e.hex!==!1,this.littleEndian_=e.littleEndian!==!1,this.ewkb_=e.ewkb!==!1,this.layout_=e.geometryLayout,this.nodataZ_=e.nodataZ||0,this.nodataM_=e.nodataM||0,this.srid_=e.srid}getType(){return this.hex_?"text":"arraybuffer"}readFeature(e,t){return new Re({geometry:this.readGeometry(e,t)})}readFeatures(e,t){let r=[];const n=this.readGeometry(e,t);return this.splitCollection&&n instanceof it?r=n.getGeometriesArray():r=[n],r.map(s=>new Re({geometry:s}))}readGeometry(e,t){const r=Un(e);if(!r)return null;const s=new Gn(r).readGeometry();return this.viewCache_=r,t=this.getReadOptions(e,t),this.viewCache_=null,me(s,!1,t)}readProjection(e){const t=this.viewCache_||Un(e);if(!t)return;const r=new Gn(t);return r.readWkbHeader(),r.getSrid()&&K("EPSG:"+r.getSrid())||void 0}writeFeature(e,t){return this.writeGeometry(e.getGeometry(),t)}writeFeatures(e,t){return this.writeGeometry(new it(e.map(r=>r.getGeometry())),t)}writeGeometry(e,t){t=this.adaptOptions(t);const r=new Nu({layout:this.layout_,littleEndian:this.littleEndian_,ewkb:this.ewkb_,nodata:{Z:this.nodataZ_,M:this.nodataM_}});let n=Number.isInteger(this.srid_)?Number(this.srid_):null;if(this.srid_!==!1&&!Number.isInteger(this.srid_)){const o=t.dataProjection&&K(t.dataProjection);if(o){const a=o.getCode();a.startsWith("EPSG:")&&(n=Number(a.substring(5)))}}r.writeGeometry(me(e,!0,t),n);const s=r.getBuffer();return this.hex_?Ou(s):s}}function Ou(i){const e=new Uint8Array(i);return Array.from(e.values()).map(t=>(t<16?"0":"")+Number(t).toString(16).toUpperCase()).join("")}function Du(i){const e=new Uint8Array(i.length/2);for(let t=0;t<i.length/2;t++)e[t]=parseInt(i.substr(t*2,2),16);return new DataView(e.buffer)}function Un(i){return typeof i=="string"?Du(i):ArrayBuffer.isView(i)?i instanceof DataView?i:new DataView(i.buffer,i.byteOffset,i.byteLength):i instanceof ArrayBuffer?new DataView(i):null}const Gu={POINT:Ie,LINESTRING:Be,POLYGON:ut,MULTIPOINT:Lr,MULTILINESTRING:vt,MULTIPOLYGON:Zt},Is="EMPTY",Fs="Z",Ns="M",Uu="ZM",ee={START:0,TEXT:1,LEFT_PAREN:2,RIGHT_PAREN:3,NUMBER:4,COMMA:5,EOF:6},Bu={Point:"POINT",LineString:"LINESTRING",Polygon:"POLYGON",MultiPoint:"MULTIPOINT",MultiLineString:"MULTILINESTRING",MultiPolygon:"MULTIPOLYGON",GeometryCollection:"GEOMETRYCOLLECTION",Circle:"CIRCLE"};class zu{constructor(e){this.wkt=e,this.index_=-1}isAlpha_(e){return e>="a"&&e<="z"||e>="A"&&e<="Z"}isNumeric_(e,t){return t=t!==void 0?t:!1,e>="0"&&e<="9"||e=="."&&!t}isWhiteSpace_(e){return e==" "||e=="	"||e=="\r"||e==`
`}nextChar_(){return this.wkt.charAt(++this.index_)}nextToken(){const e=this.nextChar_(),t=this.index_;let r=e,n;if(e=="(")n=ee.LEFT_PAREN;else if(e==",")n=ee.COMMA;else if(e==")")n=ee.RIGHT_PAREN;else if(this.isNumeric_(e)||e=="-")n=ee.NUMBER,r=this.readNumber_();else if(this.isAlpha_(e))n=ee.TEXT,r=this.readText_();else{if(this.isWhiteSpace_(e))return this.nextToken();if(e==="")n=ee.EOF;else throw new Error("Unexpected character: "+e)}return{position:t,value:r,type:n}}readNumber_(){let e;const t=this.index_;let r=!1,n=!1;do e=="."?r=!0:(e=="e"||e=="E")&&(n=!0),e=this.nextChar_();while(this.isNumeric_(e,r)||!n&&(e=="e"||e=="E")||n&&(e=="-"||e=="+"));return parseFloat(this.wkt.substring(t,this.index_--))}readText_(){let e;const t=this.index_;do e=this.nextChar_();while(this.isAlpha_(e));return this.wkt.substring(t,this.index_--).toUpperCase()}}class $u{constructor(e){this.lexer_=e,this.token_={position:0,type:ee.START},this.layout_="XY"}consume_(){this.token_=this.lexer_.nextToken()}isTokenType(e){return this.token_.type==e}match(e){const t=this.isTokenType(e);return t&&this.consume_(),t}parse(){return this.consume_(),this.parseGeometry_()}parseGeometryLayout_(){let e="XY";const t=this.token_;if(this.isTokenType(ee.TEXT)){const r=t.value;r===Fs?e="XYZ":r===Ns?e="XYM":r===Uu&&(e="XYZM"),e!=="XY"&&this.consume_()}return e}parseGeometryCollectionText_(){if(this.match(ee.LEFT_PAREN)){const e=[];do e.push(this.parseGeometry_());while(this.match(ee.COMMA));if(this.match(ee.RIGHT_PAREN))return e}throw new Error(this.formatErrorMessage_())}parsePointText_(){if(this.match(ee.LEFT_PAREN)){const e=this.parsePoint_();if(this.match(ee.RIGHT_PAREN))return e}throw new Error(this.formatErrorMessage_())}parseLineStringText_(){if(this.match(ee.LEFT_PAREN)){const e=this.parsePointList_();if(this.match(ee.RIGHT_PAREN))return e}throw new Error(this.formatErrorMessage_())}parsePolygonText_(){if(this.match(ee.LEFT_PAREN)){const e=this.parseLineStringTextList_();if(this.match(ee.RIGHT_PAREN))return e}throw new Error(this.formatErrorMessage_())}parseMultiPointText_(){if(this.match(ee.LEFT_PAREN)){let e;if(this.token_.type==ee.LEFT_PAREN?e=this.parsePointTextList_():e=this.parsePointList_(),this.match(ee.RIGHT_PAREN))return e}throw new Error(this.formatErrorMessage_())}parseMultiLineStringText_(){if(this.match(ee.LEFT_PAREN)){const e=this.parseLineStringTextList_();if(this.match(ee.RIGHT_PAREN))return e}throw new Error(this.formatErrorMessage_())}parseMultiPolygonText_(){if(this.match(ee.LEFT_PAREN)){const e=this.parsePolygonTextList_();if(this.match(ee.RIGHT_PAREN))return e}throw new Error(this.formatErrorMessage_())}parsePoint_(){const e=[],t=this.layout_.length;for(let r=0;r<t;++r){const n=this.token_;if(this.match(ee.NUMBER))e.push(n.value);else break}if(e.length==t)return e;throw new Error(this.formatErrorMessage_())}parsePointList_(){const e=[this.parsePoint_()];for(;this.match(ee.COMMA);)e.push(this.parsePoint_());return e}parsePointTextList_(){const e=[this.parsePointText_()];for(;this.match(ee.COMMA);)e.push(this.parsePointText_());return e}parseLineStringTextList_(){const e=[this.parseLineStringText_()];for(;this.match(ee.COMMA);)e.push(this.parseLineStringText_());return e}parsePolygonTextList_(){const e=[this.parsePolygonText_()];for(;this.match(ee.COMMA);)e.push(this.parsePolygonText_());return e}isEmptyGeometry_(){const e=this.isTokenType(ee.TEXT)&&this.token_.value==Is;return e&&this.consume_(),e}formatErrorMessage_(){return"Unexpected `"+this.token_.value+"` at position "+this.token_.position+" in `"+this.lexer_.wkt+"`"}parseGeometry_(){const e=this.token_;if(this.match(ee.TEXT)){const t=e.value;this.layout_=this.parseGeometryLayout_();const r=this.isEmptyGeometry_();if(t=="GEOMETRYCOLLECTION"){if(r)return new it([]);const o=this.parseGeometryCollectionText_();return new it(o)}const n=Gu[t];if(!n)throw new Error("Invalid geometry type: "+t);let s;if(r)t=="POINT"?s=[NaN,NaN]:s=[];else switch(t){case"POINT":{s=this.parsePointText_();break}case"LINESTRING":{s=this.parseLineStringText_();break}case"POLYGON":{s=this.parsePolygonText_();break}case"MULTIPOINT":{s=this.parseMultiPointText_();break}case"MULTILINESTRING":{s=this.parseMultiLineStringText_();break}case"MULTIPOLYGON":{s=this.parseMultiPolygonText_();break}}return new n(s,this.layout_)}throw new Error(this.formatErrorMessage_())}}class Xu extends Mi{constructor(e){super(),e=e||{},this.splitCollection_=e.splitCollection!==void 0?e.splitCollection:!1}parse_(e){const t=new zu(e);return new $u(t).parse()}readFeatureFromText(e,t){const r=this.readGeometryFromText(e,t),n=new Re;return n.setGeometry(r),n}readFeaturesFromText(e,t){let r=[];const n=this.readGeometryFromText(e,t);this.splitCollection_&&n.getType()=="GeometryCollection"?r=n.getGeometriesArray():r=[n];const s=[];for(let o=0,a=r.length;o<a;++o){const l=new Re;l.setGeometry(r[o]),s.push(l)}return s}readGeometryFromText(e,t){const r=this.parse_(e);return me(r,!1,t)}writeFeatureText(e,t){const r=e.getGeometry();return r?this.writeGeometryText(r,t):""}writeFeaturesText(e,t){if(e.length==1)return this.writeFeatureText(e[0],t);const r=[];for(let s=0,o=e.length;s<o;++s)r.push(e[s].getGeometry());const n=new it(r);return this.writeGeometryText(n,t)}writeGeometryText(e,t){return Ds(me(e,!0,t))}}function Ms(i){const e=i.getCoordinates();return e.length===0?"":e.join(" ")}function ku(i){const e=[],t=i.getPoints();for(let r=0,n=t.length;r<n;++r)e.push("("+Ms(t[r])+")");return e.join(",")}function ju(i){const e=[],t=i.getGeometries();for(let r=0,n=t.length;r<n;++r)e.push(Ds(t[r]));return e.join(",")}function $i(i){const e=i.getCoordinates(),t=[];for(let r=0,n=e.length;r<n;++r)t.push(e[r].join(" "));return t.join(",")}function Wu(i){const e=[],t=i.getLineStrings();for(let r=0,n=t.length;r<n;++r)e.push("("+$i(t[r])+")");return e.join(",")}function Os(i){const e=[],t=i.getLinearRings();for(let r=0,n=t.length;r<n;++r)e.push("("+$i(t[r])+")");return e.join(",")}function Zu(i){const e=[],t=i.getPolygons();for(let r=0,n=t.length;r<n;++r)e.push("("+Os(t[r])+")");return e.join(",")}function Hu(i){const e=i.getLayout();let t="";return(e==="XYZ"||e==="XYZM")&&(t+=Fs),(e==="XYM"||e==="XYZM")&&(t+=Ns),t}const Vu={Point:Ms,LineString:$i,Polygon:Os,MultiPoint:ku,MultiLineString:Wu,MultiPolygon:Zu,GeometryCollection:ju};function Ds(i){const e=i.getType(),t=Vu[e],r=t(i);let n=Bu[e];if(typeof i.getFlatCoordinates=="function"){const s=Hu(i);s.length>0&&(n+=" "+s)}return r.length===0?n+" "+Is:n+"("+r+")"}const pe=[null,"http://www.opengis.net/wms","http://www.opengis.net/sld"];function Qt(i){return $o(i[0].version,"1.3")>=0}const Yu=F(pe,{Service:_(_h),Capability:_(mh)}),qu=F(pe,{Request:_(bh),Exception:_(Th),Layer:_(Rh),UserDefinedSymbolization:_(gh)});class Ku extends Oi{constructor(){super(),this.version=void 0}readFromNode(e){this.version=e.getAttribute("version").trim();const t=A({version:this.version},Yu,e,[]);return t||null}}const Gs={Name:_(v),Title:_(v),Abstract:_(v),KeywordList:_(ks),OnlineResource:_(Ft),ContactInformation:_(Eh),Fees:_(v),AccessConstraints:_(v)},Ju=F(pe,Gs),Qu=F(pe,{...Gs,LayerLimit:_(fe),MaxWidth:_(fe),MaxHeight:_(fe)}),eh=F(pe,{ContactPersonPrimary:_(yh),ContactPosition:_(v),ContactAddress:_(xh),ContactVoiceTelephone:_(v),ContactFacsimileTelephone:_(v),ContactElectronicMailAddress:_(v)}),th=F(pe,{ContactPerson:_(v),ContactOrganization:_(v)}),rh=F(pe,{AddressType:_(v),Address:_(v),City:_(v),StateOrProvince:_(v),PostCode:_(v),Country:_(v)}),ih=F(pe,{Format:O(v)}),Us={Name:_(v),Title:_(v),Abstract:_(v),KeywordList:_(ks),BoundingBox:te($s),Dimension:te(Sh),Attribution:_(fh),AuthorityURL:te(Ah),Identifier:te(v),MetadataURL:te(Ch),DataURL:te(Ye),FeatureListURL:te(Ye),Style:te(Ih),Layer:te(Or)},Bs=F(pe,{...Us,SRS:te(v),Extent:_(Ph),ScaleHint:te(wh),LatLonBoundingBox:_((i,e)=>$s(i,e,!1)),Layer:te(Or)}),zs=F(pe,{...Us,CRS:te(v),EX_GeographicBoundingBox:_(ph),MinScaleDenominator:_(ye),MaxScaleDenominator:_(ye),Layer:te(Or)}),nh=F(pe,{Title:_(v),OnlineResource:_(Ft),LogoURL:_(Xs)}),sh=F(pe,{westBoundLongitude:_(ye),eastBoundLongitude:_(ye),southBoundLatitude:_(ye),northBoundLatitude:_(ye)}),oh=F(pe,{GetCapabilities:_(Ot),GetMap:_(Ot),GetFeatureInfo:_(Ot),DescribeLayer:_(Ot),GetLegendGraphic:_(Ot)}),ah=F(pe,{Format:te(v),DCPType:te(Lh)}),lh=F(pe,{HTTP:_(vh)}),ch=F(pe,{Get:_(Ye),Post:_(Ye)}),uh=F(pe,{Name:_(v),Title:_(v),Abstract:_(v),LegendURL:te(Xs),StyleSheetURL:_(Ye),StyleURL:_(Ye)}),hh=F(pe,{Format:_(v),OnlineResource:_(Ft)}),dh=F(pe,{Keyword:O(v)});function fh(i,e){return A({},nh,i,e)}function gh(i,e){return{SupportSLD:!!be(i.getAttribute("SupportSLD")),UserLayer:!!be(i.getAttribute("UserLayer")),UserStyle:!!be(i.getAttribute("UserStyle")),RemoteWFS:!!be(i.getAttribute("RemoteWFS")),InlineFeatureData:!!be(i.getAttribute("InlineFeatureData")),RemoteWCS:!!be(i.getAttribute("RemoteWCS"))}}function $s(i,e,t=!0){const r=[Ge(i.getAttribute("minx")),Ge(i.getAttribute("miny")),Ge(i.getAttribute("maxx")),Ge(i.getAttribute("maxy"))],n=[Ge(i.getAttribute("resx")),Ge(i.getAttribute("resy"))],s={extent:r,res:n};return t&&(Qt(e)?s.crs=i.getAttribute("CRS"):s.srs=i.getAttribute("SRS")),s}function ph(i,e){const t=A({},sh,i,e);if(!t)return;const r=t.westBoundLongitude,n=t.southBoundLatitude,s=t.eastBoundLongitude,o=t.northBoundLatitude;if(!(r===void 0||n===void 0||s===void 0||o===void 0))return[r,n,s,o]}function mh(i,e){return A({},qu,i,e)}function _h(i,e){return A({},Qt(e)?Qu:Ju,i,e)}function Eh(i,e){return A({},eh,i,e)}function yh(i,e){return A({},th,i,e)}function xh(i,e){return A({},rh,i,e)}function Th(i,e){return A([],ih,i,e)}function Rh(i,e){const t=A({},Qt(e)?zs:Bs,i,e);return t.Layer===void 0?Object.assign(t,Or(i,e)):t}function Or(i,e){const t=Qt(e),r=e[e.length-1],n=A({},t?zs:Bs,i,e);if(!n)return;let s=be(i.getAttribute("queryable"));s===void 0&&(s=r.queryable),n.queryable=s!==void 0?s:!1;let o=Je(i.getAttribute("cascaded"));o===void 0&&(o=r.cascaded),n.cascaded=o;let a=be(i.getAttribute("opaque"));a===void 0&&(a=r.opaque),n.opaque=a!==void 0?a:!1;let l=be(i.getAttribute("noSubsets"));l===void 0&&(l=r.noSubsets),n.noSubsets=l!==void 0?l:!1;let c=Ge(i.getAttribute("fixedWidth"));c||(c=r.fixedWidth),n.fixedWidth=c;let h=Ge(i.getAttribute("fixedHeight"));h||(h=r.fixedHeight),n.fixedHeight=h;const u=["Style","AuthorityURL"];t?u.push("CRS"):u.push("SRS","Dimension"),u.forEach(function(g){if(g in r){const d=n[g]||[];n[g]=d.concat(r[g])}});const f=["BoundingBox","Attribution"];return t?f.push("Dimension","EX_GeographicBoundingBox","MinScaleDenominator","MaxScaleDenominator"):f.push("LatLonBoundingBox","ScaleHint","Extent"),f.forEach(function(g){if(!(g in n)){const d=r[g];n[g]=d}}),n}function Sh(i,e){const t={name:i.getAttribute("name"),units:i.getAttribute("units"),unitSymbol:i.getAttribute("unitSymbol")};return Qt(e)&&Object.assign(t,{default:i.getAttribute("default"),multipleValues:be(i.getAttribute("multipleValues")),nearestValue:be(i.getAttribute("nearestValue")),current:be(i.getAttribute("current")),values:v(i)}),t}function Ph(i,e){return{name:i.getAttribute("name"),default:i.getAttribute("default"),nearestValue:be(i.getAttribute("nearestValue"))}}function wh(i,e){return{min:Ge(i.getAttribute("min")),max:Ge(i.getAttribute("max"))}}function Ye(i,e){return A({},hh,i,e)}function bh(i,e){return A({},oh,i,e)}function Lh(i,e){return A({},lh,i,e)}function vh(i,e){return A({},ch,i,e)}function Ot(i,e){return A({},ah,i,e)}function Xs(i,e){const t=Ye(i,e);if(t){const r=[Je(i.getAttribute("width")),Je(i.getAttribute("height"))];return t.size=r,t}}function Ah(i,e){const t=Ye(i,e);if(t)return t.name=i.getAttribute("name"),t}function Ch(i,e){const t=Ye(i,e);if(t)return t.type=i.getAttribute("type"),t}function Ih(i,e){return A({},uh,i,e)}function ks(i,e){return A([],dh,i,e)}const Fh="_feature",Nh="_layer";class Mh extends vr{constructor(e){super(),e=e||{},this.featureNS_="http://mapserver.gis.umn.edu/mapserver",this.gmlFormat_=new W,this.layers_=e.layers?e.layers:null}getLayers(){return this.layers_}setLayers(e){this.layers_=e}readFeatures_(e,t){e.setAttribute("namespaceURI",this.featureNS_);const r=e.localName;let n=[];if(e.childNodes.length===0)return n;if(r=="msGMLOutput")for(let s=0,o=e.childNodes.length;s<o;s++){const a=e.childNodes[s];if(a.nodeType!==Node.ELEMENT_NODE)continue;const l=a,c=t[0],h=Nh,u=l.localName.replace(h,"");if(this.layers_&&!this.layers_.includes(u))continue;const f=u+Fh;c.featureType=f,c.featureNS=this.featureNS_;const g={};g[f]=O(this.gmlFormat_.readFeatureElement,this.gmlFormat_);const d=F([c.featureNS,null],g);l.setAttribute("namespaceURI",this.featureNS_);const p=A([],d,l,t,this.gmlFormat_);p&&fr(n,p)}if(r=="FeatureCollection"){const s=A([],this.gmlFormat_.FEATURE_COLLECTION_PARSERS,e,[{}],this.gmlFormat_);s&&(n=s)}return n}readFeaturesFromNode(e,t){const r={};return t&&Object.assign(r,this.getReadOptions(e,t)),this.readFeatures_(e,[r])}}const ze=[null,"http://www.opengis.net/wmts/1.0"],Mt=[null,"http://www.opengis.net/ows/1.1"],Oh=F(ze,{Contents:_(Wh)});let js=class extends Oi{constructor(){super(),this.owsParser_=new bs}readFromNode(e){let t=e.getAttribute("version");t&&(t=t.trim());let r=this.owsParser_.readFromNode(e);return r?(r.version=t,r=A(r,Oh,e,[]),r||null):null}};const Dh=F(ze,{Layer:te(Zh),TileMatrixSet:te(Hh)}),Gh=F(ze,{Style:te(Vh),Format:te(v),TileMatrixSetLink:te(Yh),Dimension:te(qh),ResourceURL:te(Kh)},F(Mt,{Title:_(v),Abstract:_(v),WGS84BoundingBox:_(Zs),BoundingBox:te(Jh),Identifier:_(v)})),Uh=F(ze,{LegendURL:te(Qh)},F(Mt,{Title:_(v),Identifier:_(v)})),Bh=F(ze,{TileMatrixSet:_(v),TileMatrixSetLimits:_(td)}),zh=F(ze,{TileMatrixLimits:O(rd)}),$h=F(ze,{TileMatrix:_(v),MinTileRow:_(fe),MaxTileRow:_(fe),MinTileCol:_(fe),MaxTileCol:_(fe)}),Xh=F(ze,{Default:_(v),Value:te(v)},F(Mt,{Identifier:_(v)})),Ws=F(Mt,{LowerCorner:O(ii),UpperCorner:O(ii)}),kh=F(ze,{WellKnownScaleSet:_(v),TileMatrix:te(ed)},F(Mt,{SupportedCRS:_(v),Identifier:_(v),BoundingBox:_(Zs)})),jh=F(ze,{TopLeftCorner:_(ii),ScaleDenominator:_(ye),TileWidth:_(fe),TileHeight:_(fe),MatrixWidth:_(fe),MatrixHeight:_(fe)},F(Mt,{Identifier:_(v)}));function Wh(i,e){return A({},Dh,i,e)}function Zh(i,e){return A({},Gh,i,e)}function Hh(i,e){return A({},kh,i,e)}function Vh(i,e){const t=A({},Uh,i,e);if(!t)return;const r=i.getAttribute("isDefault")==="true";return t.isDefault=r,t}function Yh(i,e){return A({},Bh,i,e)}function qh(i,e){return A({},Xh,i,e)}function Kh(i,e){const t=i.getAttribute("format"),r=i.getAttribute("template"),n=i.getAttribute("resourceType"),s={};return t&&(s.format=t),r&&(s.template=r),n&&(s.resourceType=n),s}function Zs(i,e){const t=A([],Ws,i,e);if(t.length==2)return fi(t)}function Jh(i,e){const t=i.getAttribute("crs"),r=A([],Ws,i,e);if(r.length==2)return{extent:fi(r),crs:t}}function Qh(i,e){const t={};return t.format=i.getAttribute("format"),t.href=Ft(i),t}function ii(i,e){const t=v(i).split(/\s+/);if(!t||t.length!=2)return;const r=+t[0],n=+t[1];if(!(isNaN(r)||isNaN(n)))return[r,n]}function ed(i,e){return A({},jh,i,e)}function td(i,e){return A([],zh,i,e)}function rd(i,e){return A({},$h,i,e)}window.eoxMapAdvancedOlFormats={EsriJSON:yl,GML:Ai,GPX:Zl,IGC:vc,IIIFInfo:Mc,KML:ko,OWS:bs,Polyline:uu,TopoJSON:Xo,WFS:Lu,WKB:Mu,WKT:Xu,WMSCapabilities:Ku,WMSGetFeatureInfo:Mh,WMTSCapabilities:js};function Hs(i,e,t){const r=[];let n=i(0),s=i(1),o=e(n),a=e(s);const l=[s,n],c=[a,o],h=[1,0],u={};let f=1e5,g,d,p,m,E,x;for(;--f>0&&h.length>0;)p=h.pop(),n=l.pop(),o=c.pop(),x=p.toString(),x in u||(r.push(o[0],o[1]),u[x]=!0),m=h.pop(),s=l.pop(),a=c.pop(),E=(p+m)/2,g=i(E),d=e(g),jo(d[0],d[1],o[0],o[1],a[0],a[1])<t?(r.push(a[0],a[1]),x=m.toString(),u[x]=!0):(h.push(m,E,E,p),c.push(a,d,d,o),l.push(s,g,g,n));return r}function id(i,e,t,r,n){const s=K("EPSG:4326");return Hs(function(o){return[i,e+(t-e)*o]},_r(s,r),n)}function nd(i,e,t,r,n){const s=K("EPSG:4326");return Hs(function(o){return[e+(t-e)*o,i]},_r(s,r),n)}function sd(i){if(!(i.context instanceof CanvasRenderingContext2D))throw new Error("Only works for render events from Canvas 2D layers");const e=i.inversePixelTransform[0],t=i.inversePixelTransform[1],r=Math.sqrt(e*e+t*t),n=i.frameState,s=zt(i.inversePixelTransform.slice(),n.coordinateToPixelTransform),o=Wo(n.viewState.resolution,r);let a;return new Zo(i.context,r,n.extent,s,n.viewState.rotation,o,a)}const od=new Yr({color:"rgba(0,0,0,0.2)"}),ad=[90,45,30,20,10,5,2,1,30/60,20/60,10/60,5/60,2/60,1/60,30/3600,20/3600,10/3600,5/3600,2/3600,1/3600];class ld extends Ho{constructor(e){e=e||{};const t=Object.assign({updateWhileAnimating:!0,updateWhileInteracting:!0,renderBuffer:0},e);delete t.maxLines,delete t.strokeStyle,delete t.targetSize,delete t.showLabels,delete t.lonLabelFormatter,delete t.latLabelFormatter,delete t.lonLabelPosition,delete t.latLabelPosition,delete t.lonLabelStyle,delete t.latLabelStyle,delete t.intervals,super(t),this.projection_=null,this.maxLat_=1/0,this.maxLon_=1/0,this.minLat_=-1/0,this.minLon_=-1/0,this.maxX_=1/0,this.maxY_=1/0,this.minX_=-1/0,this.minY_=-1/0,this.targetSize_=e.targetSize!==void 0?e.targetSize:100,this.maxLines_=e.maxLines!==void 0?e.maxLines:100,this.meridians_=[],this.parallels_=[],this.strokeStyle_=e.strokeStyle!==void 0?e.strokeStyle:od,this.fromLonLatTransform_=void 0,this.toLonLatTransform_=void 0,this.projectionCenterLonLat_=null,this.bottomLeft_=null,this.bottomRight_=null,this.topLeft_=null,this.topRight_=null,this.meridiansLabels_=null,this.parallelsLabels_=null,e.showLabels&&(this.lonLabelFormatter_=e.lonLabelFormatter==null?en.bind(this,"EW"):e.lonLabelFormatter,this.latLabelFormatter_=e.latLabelFormatter==null?en.bind(this,"NS"):e.latLabelFormatter,this.lonLabelPosition_=e.lonLabelPosition==null?0:e.lonLabelPosition,this.latLabelPosition_=e.latLabelPosition==null?1:e.latLabelPosition,this.lonLabelStyleBase_=new Ur({text:e.lonLabelStyle!==void 0?e.lonLabelStyle.clone():new tn({font:"12px Calibri,sans-serif",textBaseline:"bottom",fill:new rn({color:"rgba(0,0,0,1)"}),stroke:new Yr({color:"rgba(255,255,255,1)",width:3})})}),this.lonLabelStyle_=r=>{const n=r.get("graticule_label");return this.lonLabelStyleBase_.getText().setText(n),this.lonLabelStyleBase_},this.latLabelStyleBase_=new Ur({text:e.latLabelStyle!==void 0?e.latLabelStyle.clone():new tn({font:"12px Calibri,sans-serif",textAlign:"right",fill:new rn({color:"rgba(0,0,0,1)"}),stroke:new Yr({color:"rgba(255,255,255,1)",width:3})})}),this.latLabelStyle_=r=>{const n=r.get("graticule_label");return this.latLabelStyleBase_.getText().setText(n),this.latLabelStyleBase_},this.meridiansLabels_=[],this.parallelsLabels_=[],this.addEventListener(lt.POSTRENDER,this.drawLabels_.bind(this))),this.intervals_=e.intervals!==void 0?e.intervals:ad,this.setSource(new gi({loader:this.loaderFunction.bind(this),strategy:this.strategyFunction.bind(this),features:new Vo,overlaps:!1,useSpatialIndex:!1,wrapX:e.wrapX})),this.featurePool_=[],this.lineStyle_=new Ur({stroke:this.strokeStyle_}),this.loadedExtent_=null,this.renderedExtent_=null,this.renderedResolution_=null,this.setRenderOrder(null)}strategyFunction(e,t){let r=e.slice();return this.projection_&&this.getSource().getWrapX()&&Yo(r,this.projection_),this.loadedExtent_&&(qo(this.loadedExtent_,r,t)?r=this.loadedExtent_.slice():this.getSource().removeLoadedExtent(this.loadedExtent_)),[r]}loaderFunction(e,t,r){this.loadedExtent_=e;const n=this.getSource(),s=this.getExtent()||[-1/0,-1/0,1/0,1/0],o=Ue(s,e);if(this.renderedExtent_&&$t(this.renderedExtent_,o)&&this.renderedResolution_===t||(this.renderedExtent_=o,this.renderedResolution_=t,pi(o)))return;const a=Ze(o),l=t*t/4;(!this.projection_||!lr(this.projection_,r))&&this.updateProjectionInfo_(r),this.createGraticule_(o,a,t,l);let h=this.meridians_.length+this.parallels_.length;this.meridiansLabels_&&(h+=this.meridians_.length),this.parallelsLabels_&&(h+=this.parallels_.length);let u;for(;h>this.featurePool_.length;)u=new Re,this.featurePool_.push(u);const f=n.getFeaturesCollection();f.clear();let g=0,d,p;for(d=0,p=this.meridians_.length;d<p;++d)u=this.featurePool_[g++],u.setGeometry(this.meridians_[d]),u.setStyle(this.lineStyle_),f.push(u);for(d=0,p=this.parallels_.length;d<p;++d)u=this.featurePool_[g++],u.setGeometry(this.parallels_[d]),u.setStyle(this.lineStyle_),f.push(u)}addMeridian_(e,t,r,n,s,o){const a=this.getMeridian_(e,t,r,n,o);if(wt(a.getExtent(),s)){if(this.meridiansLabels_){const l=this.lonLabelFormatter_(e);o in this.meridiansLabels_?this.meridiansLabels_[o].text=l:this.meridiansLabels_[o]={geom:new Ie([]),text:l}}this.meridians_[o++]=a}return o}addParallel_(e,t,r,n,s,o){const a=this.getParallel_(e,t,r,n,o);if(wt(a.getExtent(),s)){if(this.parallelsLabels_){const l=this.latLabelFormatter_(e);o in this.parallelsLabels_?this.parallelsLabels_[o].text=l:this.parallelsLabels_[o]={geom:new Ie([]),text:l}}this.parallels_[o++]=a}return o}drawLabels_(e){const t=e.frameState.viewState.rotation,r=e.frameState.viewState.resolution,n=e.frameState.size,s=e.frameState.extent,o=Ze(s);let a=s;if(t){const d=n[0]*r,p=n[1]*r;a=[o[0]-d/2,o[1]-p/2,o[0]+d/2,o[1]+p/2]}let l=0,c=0,h=this.latLabelPosition_<.5;const u=this.projection_.getExtent(),f=Ee(u);if(this.getSource().getWrapX()&&this.projection_.canWrapX()&&!hr(u,s)){l=Math.floor((s[0]-u[0])/f),c=Math.ceil((s[2]-u[2])/f);const d=Math.abs(t)>Math.PI/2;h=h!==d}const g=sd(e);for(let d=l;d<=c;++d){let p=this.meridians_.length+this.parallels_.length,m,E,x,T;if(this.meridiansLabels_)for(E=0,x=this.meridiansLabels_.length;E<x;++E){const S=this.meridians_[E];if(!t&&d===0)T=this.getMeridianPoint_(S,s,E);else{const P=S.clone();P.translate(d*f,0),P.rotate(-t,o),T=this.getMeridianPoint_(P,a,E),T.rotate(t,o)}m=this.featurePool_[p++],m.setGeometry(T),m.set("graticule_label",this.meridiansLabels_[E].text),g.drawFeature(m,this.lonLabelStyle_(m))}if(this.parallelsLabels_&&(d===l&&h||d===c&&!h))for(E=0,x=this.parallels_.length;E<x;++E){const S=this.parallels_[E];if(!t&&d===0)T=this.getParallelPoint_(S,s,E);else{const P=S.clone();P.translate(d*f,0),P.rotate(-t,o),T=this.getParallelPoint_(P,a,E),T.rotate(t,o)}m=this.featurePool_[p++],m.setGeometry(T),m.set("graticule_label",this.parallelsLabels_[E].text),g.drawFeature(m,this.latLabelStyle_(m))}}}createGraticule_(e,t,r,n){const s=this.getInterval_(r);if(s==-1){this.meridians_.length=0,this.parallels_.length=0,this.meridiansLabels_&&(this.meridiansLabels_.length=0),this.parallelsLabels_&&(this.parallelsLabels_.length=0);return}let o=!1;const a=this.projection_.getExtent(),l=Ee(a);this.getSource().getWrapX()&&this.projection_.canWrapX()&&!hr(a,e)&&(Ee(e)>=l?(e[0]=a[0],e[2]=a[2]):o=!0);const c=[ue(t[0],this.minX_,this.maxX_),ue(t[1],this.minY_,this.maxY_)],h=this.toLonLatTransform_(c);isNaN(h[1])&&(h[1]=Math.abs(this.maxLat_)>=Math.abs(this.minLat_)?this.maxLat_:this.minLat_);let u=ue(h[0],this.minLon_,this.maxLon_),f=ue(h[1],this.minLat_,this.maxLat_);const g=this.maxLines_;let d,p,m,E,x=e;o||(x=[ue(e[0],this.minX_,this.maxX_),ue(e[1],this.minY_,this.maxY_),ue(e[2],this.minX_,this.maxX_),ue(e[3],this.minY_,this.maxY_)]);const T=bt(x,this.toLonLatTransform_,void 0,8);let S=T[3],P=T[2],R=T[1],L=T[0];if(o||(St(x,this.bottomLeft_)&&(L=this.minLon_,R=this.minLat_),St(x,this.bottomRight_)&&(P=this.maxLon_,R=this.minLat_),St(x,this.topLeft_)&&(L=this.minLon_,S=this.maxLat_),St(x,this.topRight_)&&(P=this.maxLon_,S=this.maxLat_),S=ue(S,f,this.maxLat_),P=ue(P,u,this.maxLon_),R=ue(R,this.minLat_,f),L=ue(L,this.minLon_,u)),u=Math.floor(u/s)*s,E=ue(u,this.minLon_,this.maxLon_),p=this.addMeridian_(E,R,S,n,e,0),d=0,o)for(;(E-=s)>=L&&d++<g;)p=this.addMeridian_(E,R,S,n,e,p);else for(;E!=this.minLon_&&d++<g;)E=Math.max(E-s,this.minLon_),p=this.addMeridian_(E,R,S,n,e,p);if(E=ue(u,this.minLon_,this.maxLon_),d=0,o)for(;(E+=s)<=P&&d++<g;)p=this.addMeridian_(E,R,S,n,e,p);else for(;E!=this.maxLon_&&d++<g;)E=Math.min(E+s,this.maxLon_),p=this.addMeridian_(E,R,S,n,e,p);for(this.meridians_.length=p,this.meridiansLabels_&&(this.meridiansLabels_.length=p),f=Math.floor(f/s)*s,m=ue(f,this.minLat_,this.maxLat_),p=this.addParallel_(m,L,P,n,e,0),d=0;m!=this.minLat_&&d++<g;)m=Math.max(m-s,this.minLat_),p=this.addParallel_(m,L,P,n,e,p);for(m=ue(f,this.minLat_,this.maxLat_),d=0;m!=this.maxLat_&&d++<g;)m=Math.min(m+s,this.maxLat_),p=this.addParallel_(m,L,P,n,e,p);this.parallels_.length=p,this.parallelsLabels_&&(this.parallelsLabels_.length=p)}getInterval_(e){const t=this.projectionCenterLonLat_[0],r=this.projectionCenterLonLat_[1];let n=-1;const s=Math.pow(this.targetSize_*e,2),o=[],a=[];for(let l=0,c=this.intervals_.length;l<c;++l){const h=ue(this.intervals_[l]/2,0,90),u=ue(r,-90+h,90-h);if(o[0]=t-h,o[1]=u-h,a[0]=t+h,a[1]=u+h,this.fromLonLatTransform_(o,o),this.fromLonLatTransform_(a,a),Math.pow(a[0]-o[0],2)+Math.pow(a[1]-o[1],2)<=s)break;n=this.intervals_[l]}return n}getMeridian_(e,t,r,n,s){const o=id(e,t,r,this.projection_,n);let a=this.meridians_[s];return a?(a.setFlatCoordinates("XY",o),a.changed()):(a=new Be(o,"XY"),this.meridians_[s]=a),a}getMeridianPoint_(e,t,r){const n=e.getFlatCoordinates();let s=1,o=n.length-1;n[s]>n[o]&&(s=o,o=1);const a=Math.max(t[1],n[s]),l=Math.min(t[3],n[o]),c=ue(t[1]+Math.abs(t[1]-t[3])*this.lonLabelPosition_,a,l),u=[n[s-1]+(n[o-1]-n[s-1])*(c-n[s])/(n[o]-n[s]),c],f=this.meridiansLabels_[r].geom;return f.setCoordinates(u),f}getMeridians(){return this.meridians_}getParallel_(e,t,r,n,s){const o=nd(e,t,r,this.projection_,n);let a=this.parallels_[s];return a?(a.setFlatCoordinates("XY",o),a.changed()):a=new Be(o,"XY"),a}getParallelPoint_(e,t,r){const n=e.getFlatCoordinates();let s=0,o=n.length-2;n[s]>n[o]&&(s=o,o=0);const a=Math.max(t[0],n[s]),l=Math.min(t[2],n[o]),c=ue(t[0]+Math.abs(t[0]-t[2])*this.latLabelPosition_,a,l),h=n[s+1]+(n[o+1]-n[s+1])*(c-n[s])/(n[o]-n[s]),u=[c,h],f=this.parallelsLabels_[r].geom;return f.setCoordinates(u),f}getParallels(){return this.parallels_}updateProjectionInfo_(e){const t=K("EPSG:4326"),r=e.getWorldExtent();this.maxLat_=r[3],this.maxLon_=r[2],this.minLat_=r[1],this.minLon_=r[0];const n=_r(e,t);if(this.minLon_<this.maxLon_)this.toLonLatTransform_=n;else{const o=this.minLon_+this.maxLon_/2;this.maxLon_+=360,this.toLonLatTransform_=function(a,l,c){c=c||2;const h=n(a,l,c);for(let u=0,f=h.length;u<f;u+=c)h[u]<o&&(h[u]+=360);return h}}this.fromLonLatTransform_=_r(t,e);const s=bt([this.minLon_,this.minLat_,this.maxLon_,this.maxLat_],this.fromLonLatTransform_,void 0,8);this.minX_=s[0],this.maxX_=s[2],this.minY_=s[1],this.maxY_=s[3],this.bottomLeft_=this.fromLonLatTransform_([this.minLon_,this.minLat_]),this.bottomRight_=this.fromLonLatTransform_([this.maxLon_,this.minLat_]),this.topLeft_=this.fromLonLatTransform_([this.minLon_,this.maxLat_]),this.topRight_=this.fromLonLatTransform_([this.maxLon_,this.maxLat_]),this.projectionCenterLonLat_=this.toLonLatTransform_(Ze(e.getExtent())),isNaN(this.projectionCenterLonLat_[1])&&(this.projectionCenterLonLat_[1]=Math.abs(this.maxLat_)>=Math.abs(this.minLat_)?this.maxLat_:this.minLat_),this.projection_=e}}function mt(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}function Rr(i,e){return i[0]=e[0],i[1]=e[1],i[4]=e[2],i[5]=e[3],i[12]=e[4],i[13]=e[5],i}function ni(i,e,t,r,n,s,o){o=o??mt();const a=1/(i-e),l=1/(t-r),c=1/(n-s);return o[0]=-2*a,o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[5]=-2*l,o[6]=0,o[7]=0,o[8]=0,o[9]=0,o[10]=2*c,o[11]=0,o[12]=(i+e)*a,o[13]=(r+t)*l,o[14]=(s+n)*c,o[15]=1,o}function Bn(i,e,t,r,n){return n=n??mt(),n[0]=i[0]*e,n[1]=i[1]*e,n[2]=i[2]*e,n[3]=i[3]*e,n[4]=i[4]*t,n[5]=i[5]*t,n[6]=i[6]*t,n[7]=i[7]*t,n[8]=i[8]*r,n[9]=i[9]*r,n[10]=i[10]*r,n[11]=i[11]*r,n[12]=i[12],n[13]=i[13],n[14]=i[14],n[15]=i[15],n}function cd(i,e,t,r,n){n=n??mt();let s,o,a,l,c,h,u,f,g,d,p,m;return i===n?(n[12]=i[0]*e+i[4]*t+i[8]*r+i[12],n[13]=i[1]*e+i[5]*t+i[9]*r+i[13],n[14]=i[2]*e+i[6]*t+i[10]*r+i[14],n[15]=i[3]*e+i[7]*t+i[11]*r+i[15]):(s=i[0],o=i[1],a=i[2],l=i[3],c=i[4],h=i[5],u=i[6],f=i[7],g=i[8],d=i[9],p=i[10],m=i[11],n[0]=s,n[1]=o,n[2]=a,n[3]=l,n[4]=c,n[5]=h,n[6]=u,n[7]=f,n[8]=g,n[9]=d,n[10]=p,n[11]=m,n[12]=s*e+c*t+g*r+i[12],n[13]=o*e+h*t+d*r+i[13],n[14]=a*e+u*t+p*r+i[14],n[15]=l*e+f*t+m*r+i[15]),n}function ud(i,e,t,r){return r=r??mt(),r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=1,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=1,r[11]=0,r[12]=i,r[13]=e,r[14]=t,r[15]=1,r}const ft=34962,er=34963,Xi=35044,Pt=35048,hd=5121,dd=5123,fd=5125,Vs=5126,zn=["experimental-webgl","webgl","webkit-3d","moz-webgl"];function gd(i,e){e=Object.assign({preserveDrawingBuffer:!0,antialias:!Ko},e);const t=zn.length;for(let r=0;r<t;++r)try{const n=i.getContext(zn[r],e);if(n)return n}catch{}return null}const pd={STATIC_DRAW:Xi};class tt{constructor(e,t){this.array_=null,this.type_=e,ve(e===ft||e===er,"A `WebGLArrayBuffer` must either be of type `ELEMENT_ARRAY_BUFFER` or `ARRAY_BUFFER`"),this.usage_=t!==void 0?t:pd.STATIC_DRAW}ofSize(e){return this.array_=new(or(this.type_))(e),this}fromArray(e){return this.array_=or(this.type_).from(e),this}fromArrayBuffer(e){return this.array_=new(or(this.type_))(e),this}getType(){return this.type_}getArray(){return this.array_}setArray(e){const t=or(this.type_);if(!(e instanceof t))throw new Error(`Expected ${t}`);this.array_=e}getUsage(){return this.usage_}getSize(){return this.array_?this.array_.length:0}}function or(i){switch(i){case ft:return Float32Array;case er:return Uint32Array;default:return Float32Array}}const ar={LOST:"webglcontextlost",RESTORED:"webglcontextrestored"},md=`
  precision mediump float;

  attribute vec2 a_position;
  varying vec2 v_texCoord;
  varying vec2 v_screenCoord;

  uniform vec2 u_screenSize;

  void main() {
    v_texCoord = a_position * 0.5 + 0.5;
    v_screenCoord = v_texCoord * u_screenSize;
    gl_Position = vec4(a_position, 0.0, 1.0);
  }
`,_d=`
  precision mediump float;

  uniform sampler2D u_image;
  uniform float u_opacity;

  varying vec2 v_texCoord;

  void main() {
    gl_FragColor = texture2D(u_image, v_texCoord) * u_opacity;
  }
`;class $n{constructor(e){this.gl_=e.webGlContext;const t=this.gl_;this.scaleRatio_=e.scaleRatio||1,this.renderTargetTexture_=t.createTexture(),this.renderTargetTextureSize_=null,this.frameBuffer_=t.createFramebuffer(),this.depthBuffer_=t.createRenderbuffer();const r=t.createShader(t.VERTEX_SHADER);t.shaderSource(r,e.vertexShader||md),t.compileShader(r);const n=t.createShader(t.FRAGMENT_SHADER);t.shaderSource(n,e.fragmentShader||_d),t.compileShader(n),this.renderTargetProgram_=t.createProgram(),t.attachShader(this.renderTargetProgram_,r),t.attachShader(this.renderTargetProgram_,n),t.linkProgram(this.renderTargetProgram_),this.renderTargetVerticesBuffer_=t.createBuffer();const s=[-1,-1,1,-1,-1,1,1,-1,1,1,-1,1];t.bindBuffer(t.ARRAY_BUFFER,this.renderTargetVerticesBuffer_),t.bufferData(t.ARRAY_BUFFER,new Float32Array(s),t.STATIC_DRAW),this.renderTargetAttribLocation_=t.getAttribLocation(this.renderTargetProgram_,"a_position"),this.renderTargetUniformLocation_=t.getUniformLocation(this.renderTargetProgram_,"u_screenSize"),this.renderTargetOpacityLocation_=t.getUniformLocation(this.renderTargetProgram_,"u_opacity"),this.renderTargetTextureLocation_=t.getUniformLocation(this.renderTargetProgram_,"u_image"),this.uniforms_=[],e.uniforms&&Object.keys(e.uniforms).forEach(o=>{this.uniforms_.push({value:e.uniforms[o],location:t.getUniformLocation(this.renderTargetProgram_,o)})})}getRenderTargetTexture(){return this.renderTargetTexture_}getGL(){return this.gl_}init(e){const t=this.getGL(),r=[t.drawingBufferWidth*this.scaleRatio_,t.drawingBufferHeight*this.scaleRatio_];if(t.bindFramebuffer(t.FRAMEBUFFER,this.getFrameBuffer()),t.bindRenderbuffer(t.RENDERBUFFER,this.getDepthBuffer()),t.viewport(0,0,r[0],r[1]),!this.renderTargetTextureSize_||this.renderTargetTextureSize_[0]!==r[0]||this.renderTargetTextureSize_[1]!==r[1]){this.renderTargetTextureSize_=r;const n=0,s=t.RGBA,o=0,a=t.RGBA,l=t.UNSIGNED_BYTE,c=null;t.bindTexture(t.TEXTURE_2D,this.renderTargetTexture_),t.texImage2D(t.TEXTURE_2D,n,s,r[0],r[1],o,a,l,c),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.renderTargetTexture_,0),t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT16,r[0],r[1]),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,this.depthBuffer_)}}apply(e,t,r,n){const s=this.getGL(),o=e.size;if(s.bindFramebuffer(s.FRAMEBUFFER,t?t.getFrameBuffer():null),s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,this.renderTargetTexture_),!t){const l=Q(s.canvas);if(!e.renderTargets[l]){const c=s.getContextAttributes();c&&c.preserveDrawingBuffer&&(s.clearColor(0,0,0,0),s.clearDepth(1),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT)),e.renderTargets[l]=!0}}s.disable(s.DEPTH_TEST),s.enable(s.BLEND),s.blendFunc(s.ONE,s.ONE_MINUS_SRC_ALPHA),s.viewport(0,0,s.drawingBufferWidth,s.drawingBufferHeight),s.bindBuffer(s.ARRAY_BUFFER,this.renderTargetVerticesBuffer_),s.useProgram(this.renderTargetProgram_),s.enableVertexAttribArray(this.renderTargetAttribLocation_),s.vertexAttribPointer(this.renderTargetAttribLocation_,2,s.FLOAT,!1,0,0),s.uniform2f(this.renderTargetUniformLocation_,o[0],o[1]),s.uniform1i(this.renderTargetTextureLocation_,0);const a=e.layerStatesArray[e.layerIndex].opacity;s.uniform1f(this.renderTargetOpacityLocation_,a),this.applyUniforms(e),r&&r(s,e),s.drawArrays(s.TRIANGLES,0,6),n&&n(s,e)}getFrameBuffer(){return this.frameBuffer_}getDepthBuffer(){return this.depthBuffer_}applyUniforms(e){const t=this.getGL();let r,n=1;this.uniforms_.forEach(function(s){if(r=typeof s.value=="function"?s.value(e):s.value,r instanceof HTMLCanvasElement||r instanceof ImageData)s.texture||(s.texture=t.createTexture()),t.activeTexture(t[`TEXTURE${n}`]),t.bindTexture(t.TEXTURE_2D,s.texture),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),r instanceof ImageData?t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,r.width,r.height,0,t.UNSIGNED_BYTE,new Uint8Array(r.data)):t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,r),t.uniform1i(s.location,n++);else if(Array.isArray(r))switch(r.length){case 2:t.uniform2f(s.location,r[0],r[1]);return;case 3:t.uniform3f(s.location,r[0],r[1],r[2]);return;case 4:t.uniform4f(s.location,r[0],r[1],r[2],r[3]);return;default:return}else typeof r=="number"&&t.uniform1f(s.location,r)})}}const De={PROJECTION_MATRIX:"u_projectionMatrix",SCREEN_TO_WORLD_MATRIX:"u_screenToWorldMatrix",TIME:"u_time",ZOOM:"u_zoom",RESOLUTION:"u_resolution",ROTATION:"u_rotation",VIEWPORT_SIZE_PX:"u_viewportSizePx",PIXEL_RATIO:"u_pixelRatio",HIT_DETECTION:"u_hitDetection"},de={UNSIGNED_BYTE:hd,UNSIGNED_SHORT:dd,UNSIGNED_INT:fd,FLOAT:Vs},Sr={};function Xn(i){return"shared/"+i}let kn=0;function Ed(){const i="unique/"+kn;return kn+=1,i}function yd(i){let e=Sr[i];if(!e){const t=document.createElement("canvas");t.width=1,t.height=1,t.style.position="absolute",t.style.left="0",e={users:0,context:gd(t)},Sr[i]=e}return e.users+=1,e.context}function xd(i){const e=Sr[i];if(!e||(e.users-=1,e.users>0))return;const t=e.context,r=t.getExtension("WEBGL_lose_context");r&&r.loseContext();const n=t.canvas;n.width=1,n.height=1,delete Sr[i]}class Td extends us{constructor(e){super(),e=e||{},this.boundHandleWebGLContextLost_=this.handleWebGLContextLost.bind(this),this.boundHandleWebGLContextRestored_=this.handleWebGLContextRestored.bind(this),this.canvasCacheKey_=e.canvasCacheKey?Xn(e.canvasCacheKey):Ed(),this.gl_=yd(this.canvasCacheKey_),this.bufferCache_={},this.extensionCache_={},this.currentProgram_=null,this.needsToBeRecreated_=!1;const t=this.gl_.canvas;t.addEventListener(ar.LOST,this.boundHandleWebGLContextLost_),t.addEventListener(ar.RESTORED,this.boundHandleWebGLContextRestored_),this.offsetRotateMatrix_=_e(),this.offsetScaleMatrix_=_e(),this.tmpMat4_=mt(),this.uniformLocationsByProgram_={},this.attribLocationsByProgram_={},this.uniforms_=[],e.uniforms&&this.setUniforms(e.uniforms),this.postProcessPasses_=e.postProcesses?e.postProcesses.map(r=>new $n({webGlContext:this.gl_,scaleRatio:r.scaleRatio,vertexShader:r.vertexShader,fragmentShader:r.fragmentShader,uniforms:r.uniforms})):[new $n({webGlContext:this.gl_})],this.shaderCompileErrors_=null,this.startTime_=Date.now(),this.maxAttributeCount_=this.gl_.getParameter(this.gl_.MAX_VERTEX_ATTRIBS)}setUniforms(e){this.uniforms_=[],this.addUniforms(e)}addUniforms(e){for(const t in e)this.uniforms_.push({name:t,value:e[t]})}canvasCacheKeyMatches(e){return this.canvasCacheKey_===Xn(e)}getExtension(e){if(e in this.extensionCache_)return this.extensionCache_[e];const t=this.gl_.getExtension(e);return this.extensionCache_[e]=t,t}getInstancedRenderingExtension_(){const e=this.getExtension("ANGLE_instanced_arrays");return ve(!!e,"WebGL extension 'ANGLE_instanced_arrays' is required for vector rendering"),e}bindBuffer(e){const t=this.gl_,r=Q(e);let n=this.bufferCache_[r];if(!n){const s=t.createBuffer();n={buffer:e,webGlBuffer:s},this.bufferCache_[r]=n}t.bindBuffer(e.getType(),n.webGlBuffer)}flushBufferData(e){const t=this.gl_;this.bindBuffer(e),t.bufferData(e.getType(),e.getArray(),e.getUsage())}deleteBuffer(e){const t=Q(e);delete this.bufferCache_[t]}disposeInternal(){const e=this.gl_.canvas;e.removeEventListener(ar.LOST,this.boundHandleWebGLContextLost_),e.removeEventListener(ar.RESTORED,this.boundHandleWebGLContextRestored_),xd(this.canvasCacheKey_),delete this.gl_}prepareDraw(e,t,r){const n=this.gl_,s=this.getCanvas(),o=e.size,a=e.pixelRatio;(s.width!==o[0]*a||s.height!==o[1]*a)&&(s.width=o[0]*a,s.height=o[1]*a,s.style.width=o[0]+"px",s.style.height=o[1]+"px");for(let l=this.postProcessPasses_.length-1;l>=0;l--)this.postProcessPasses_[l].init(e);n.bindTexture(n.TEXTURE_2D,null),n.clearColor(0,0,0,0),n.depthRange(0,1),n.clearDepth(1),n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT),n.enable(n.BLEND),n.blendFunc(n.ONE,t?n.ZERO:n.ONE_MINUS_SRC_ALPHA),r?(n.enable(n.DEPTH_TEST),n.depthFunc(n.LEQUAL)):n.disable(n.DEPTH_TEST)}bindFrameBuffer(e,t){const r=this.getGL();r.bindFramebuffer(r.FRAMEBUFFER,e),t&&r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,t,0)}bindInitialFrameBuffer(){const e=this.getGL(),t=this.postProcessPasses_[0].getFrameBuffer();e.bindFramebuffer(e.FRAMEBUFFER,t);const r=this.postProcessPasses_[0].getRenderTargetTexture();e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,r,0)}bindTexture(e,t,r){const n=this.gl_;n.activeTexture(n.TEXTURE0+t),n.bindTexture(n.TEXTURE_2D,e),n.uniform1i(this.getUniformLocation(r),t)}bindAttribute(e,t,r){const n=this.getGL();this.bindBuffer(e);const s=this.getAttributeLocation(t);n.enableVertexAttribArray(s),n.vertexAttribPointer(s,r,n.FLOAT,!1,0,0)}prepareDrawToRenderTarget(e,t,r,n){const s=this.gl_,o=t.getSize();s.bindFramebuffer(s.FRAMEBUFFER,t.getFramebuffer()),s.bindRenderbuffer(s.RENDERBUFFER,t.getDepthbuffer()),s.viewport(0,0,o[0],o[1]),s.bindTexture(s.TEXTURE_2D,t.getTexture()),s.clearColor(0,0,0,0),s.depthRange(0,1),s.clearDepth(1),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT),s.enable(s.BLEND),s.blendFunc(s.ONE,r?s.ZERO:s.ONE_MINUS_SRC_ALPHA),n?(s.enable(s.DEPTH_TEST),s.depthFunc(s.LEQUAL)):s.disable(s.DEPTH_TEST)}drawElements(e,t){const r=this.gl_;this.getExtension("OES_element_index_uint");const n=r.UNSIGNED_INT,s=4,o=t-e,a=e*s;r.drawElements(r.TRIANGLES,o,n,a)}drawElementsInstanced(e,t,r){const n=this.gl_;this.getExtension("OES_element_index_uint");const s=this.getInstancedRenderingExtension_(),o=n.UNSIGNED_INT,a=4,l=t-e,c=e*a;s.drawElementsInstancedANGLE(n.TRIANGLES,l,o,c,r);for(let h=0;h<this.maxAttributeCount_;h++)s.vertexAttribDivisorANGLE(h,0)}finalizeDraw(e,t,r){for(let n=0,s=this.postProcessPasses_.length;n<s;n++)n===s-1?this.postProcessPasses_[n].apply(e,null,t,r):this.postProcessPasses_[n].apply(e,this.postProcessPasses_[n+1])}getCanvas(){return this.gl_.canvas}getGL(){return this.gl_}applyFrameState(e){const t=e.size,r=e.viewState.rotation,n=e.pixelRatio;this.setUniformFloatValue(De.TIME,(Date.now()-this.startTime_)*.001),this.setUniformFloatValue(De.ZOOM,e.viewState.zoom),this.setUniformFloatValue(De.RESOLUTION,e.viewState.resolution),this.setUniformFloatValue(De.PIXEL_RATIO,n),this.setUniformFloatVec2(De.VIEWPORT_SIZE_PX,[t[0],t[1]]),this.setUniformFloatValue(De.ROTATION,r)}applyHitDetectionUniform(e){const t=this.getUniformLocation(De.HIT_DETECTION);this.getGL().uniform1i(t,e?1:0),e&&this.setUniformFloatValue(De.PIXEL_RATIO,.5)}applyUniforms(e){const t=this.gl_;let r,n=0;this.uniforms_.forEach(s=>{if(r=typeof s.value=="function"?s.value(e):s.value,r instanceof HTMLCanvasElement||r instanceof HTMLImageElement||r instanceof ImageData||r instanceof WebGLTexture){r instanceof WebGLTexture&&!s.texture?(s.prevValue=void 0,s.texture=r):s.texture||(s.prevValue=void 0,s.texture=t.createTexture()),this.bindTexture(s.texture,n,s.name),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE);const o=!(r instanceof HTMLImageElement)||r.complete;!(r instanceof WebGLTexture)&&o&&s.prevValue!==r&&(s.prevValue=r,t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,r)),n++}else if(Array.isArray(r)&&r.length===6)this.setUniformMatrixValue(s.name,Rr(this.tmpMat4_,r));else if(Array.isArray(r)&&r.length<=4)switch(r.length){case 2:t.uniform2f(this.getUniformLocation(s.name),r[0],r[1]);return;case 3:t.uniform3f(this.getUniformLocation(s.name),r[0],r[1],r[2]);return;case 4:t.uniform4f(this.getUniformLocation(s.name),r[0],r[1],r[2],r[3]);return;default:return}else typeof r=="number"&&t.uniform1f(this.getUniformLocation(s.name),r)})}useProgram(e,t){this.disableAllAttributes_(),this.gl_.useProgram(e),this.currentProgram_=e,t&&(this.applyFrameState(t),this.applyUniforms(t))}compileShader(e,t){const r=this.gl_,n=r.createShader(t);return r.shaderSource(n,e),r.compileShader(n),n}getProgram(e,t){const r=this.gl_,n=this.compileShader(e,r.FRAGMENT_SHADER),s=this.compileShader(t,r.VERTEX_SHADER),o=r.createProgram();if(r.attachShader(o,n),r.attachShader(o,s),r.linkProgram(o),!r.getShaderParameter(n,r.COMPILE_STATUS)){const a=`Fragment shader compilation failed: ${r.getShaderInfoLog(n)}`;throw new Error(a)}if(r.deleteShader(n),!r.getShaderParameter(s,r.COMPILE_STATUS)){const a=`Vertex shader compilation failed: ${r.getShaderInfoLog(s)}`;throw new Error(a)}if(r.deleteShader(s),!r.getProgramParameter(o,r.LINK_STATUS)){const a=`GL program linking failed: ${r.getProgramInfoLog(o)}`;throw new Error(a)}return o}getUniformLocation(e){const t=Q(this.currentProgram_);return this.uniformLocationsByProgram_[t]===void 0&&(this.uniformLocationsByProgram_[t]={}),this.uniformLocationsByProgram_[t][e]===void 0&&(this.uniformLocationsByProgram_[t][e]=this.gl_.getUniformLocation(this.currentProgram_,e)),this.uniformLocationsByProgram_[t][e]}getAttributeLocation(e){const t=Q(this.currentProgram_);return this.attribLocationsByProgram_[t]===void 0&&(this.attribLocationsByProgram_[t]={}),this.attribLocationsByProgram_[t][e]===void 0&&(this.attribLocationsByProgram_[t][e]=this.gl_.getAttribLocation(this.currentProgram_,e)),this.attribLocationsByProgram_[t][e]}makeProjectionTransform(e,t){const r=e.size,n=e.viewState.rotation,s=e.viewState.resolution,o=e.viewState.center;return mi(t,0,0,2/(s*r[0]),2/(s*r[1]),-n,-o[0],-o[1]),t}setUniformFloatValue(e,t){this.gl_.uniform1f(this.getUniformLocation(e),t)}setUniformFloatVec2(e,t){this.gl_.uniform2fv(this.getUniformLocation(e),t)}setUniformFloatVec4(e,t){this.gl_.uniform4fv(this.getUniformLocation(e),t)}setUniformMatrixValue(e,t){this.gl_.uniformMatrix4fv(this.getUniformLocation(e),!1,t)}disableAllAttributes_(){for(let e=0;e<this.maxAttributeCount_;e++)this.gl_.disableVertexAttribArray(e)}enableAttributeArray_(e,t,r,n,s,o){const a=this.getAttributeLocation(e);a<0||(this.gl_.enableVertexAttribArray(a),this.gl_.vertexAttribPointer(a,t,r,!1,n,s),o&&this.getInstancedRenderingExtension_().vertexAttribDivisorANGLE(a,1))}enableAttributes_(e,t){const r=Rd(e);let n=0;for(let s=0;s<e.length;s++){const o=e[s];o.name&&this.enableAttributeArray_(o.name,o.size,o.type||Vs,r,n,t),n+=o.size*Ys(o.type)}}enableAttributes(e){this.enableAttributes_(e,!1)}enableAttributesInstanced(e){this.enableAttributes_(e,!0)}handleWebGLContextLost(e){Jo(this.bufferCache_),this.currentProgram_=null,e.preventDefault()}handleWebGLContextRestored(){this.needsToBeRecreated_=!0}needsToBeRecreated(){return this.needsToBeRecreated_}createTexture(e,t,r,n){const s=this.gl_;r=r||s.createTexture();const o=n?s.NEAREST:s.LINEAR;s.bindTexture(s.TEXTURE_2D,r),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,o),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,o),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE);const a=0,l=s.RGBA,c=0,h=s.RGBA,u=s.UNSIGNED_BYTE;return t instanceof Uint8Array?s.texImage2D(s.TEXTURE_2D,a,l,e[0],e[1],c,h,u,t):t?s.texImage2D(s.TEXTURE_2D,a,l,h,u,t):s.texImage2D(s.TEXTURE_2D,a,l,e[0],e[1],c,h,u,null),r}}function Rd(i){let e=0;for(let t=0;t<i.length;t++){const r=i[t];e+=r.size*Ys(r.type)}return e}function Ys(i){switch(i){case de.UNSIGNED_BYTE:return Uint8Array.BYTES_PER_ELEMENT;case de.UNSIGNED_SHORT:return Uint16Array.BYTES_PER_ELEMENT;case de.UNSIGNED_INT:return Uint32Array.BYTES_PER_ELEMENT;case de.FLOAT:default:return Float32Array.BYTES_PER_ELEMENT}}class Sd extends Qo{constructor(e){super(),this.tile,this.handleTileChange_=this.handleTileChange_.bind(this),this.gutter=e.gutter||0,this.helper=e.helper,this.loaded=!1,this.ready=!1}setTile(e){if(e!==this.tile)if(this.tile&&this.tile.removeEventListener(Te.CHANGE,this.handleTileChange_),this.tile=e,this.loaded=e.getState()===V.LOADED,this.loaded)this.uploadTile();else{if(e instanceof _i){const t=e.getImage();t instanceof Image&&!t.crossOrigin&&(t.crossOrigin="anonymous")}e.addEventListener(Te.CHANGE,this.handleTileChange_)}}uploadTile(){ke()}setReady(){this.ready=!0,this.dispatchEvent(Te.CHANGE)}handleTileChange_(){this.tile.getState()===V.LOADED&&(this.loaded=!0,this.uploadTile())}setHelper(e){this.helper=e,this.helper&&this.loaded&&this.uploadTile()}disposeInternal(){this.setHelper(null),this.tile.removeEventListener(Te.CHANGE,this.handleTileChange_)}}function qs(i,e,t){const r=t?i.LINEAR:i.NEAREST;i.bindTexture(i.TEXTURE_2D,e),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,r),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,r)}function Pd(i,e,t,r){qs(i,e,r),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,t)}function jn(i,e,t,r,n,s){const o=i.getGL();let a,l;t instanceof Float32Array?(a=o.FLOAT,i.getExtension("OES_texture_float"),l=i.getExtension("OES_texture_float_linear")!==null):(a=o.UNSIGNED_BYTE,l=!0),qs(o,e,s&&l);const c=t.byteLength/r[1];let h=1;c%8===0?h=8:c%4===0?h=4:c%2===0&&(h=2);let u;switch(n){case 1:{u=o.LUMINANCE;break}case 2:{u=o.LUMINANCE_ALPHA;break}case 3:{u=o.RGB;break}case 4:{u=o.RGBA;break}default:throw new Error(`Unsupported number of bands: ${n}`)}const f=o.getParameter(o.UNPACK_ALIGNMENT);o.pixelStorei(o.UNPACK_ALIGNMENT,h),o.texImage2D(o.TEXTURE_2D,0,u,r[0],r[1],0,u,a,t),o.pixelStorei(o.UNPACK_ALIGNMENT,f)}let Rt=null;function wd(){Rt=nt(1,1,void 0,{willReadFrequently:!0})}class bd extends Sd{constructor(e){super(e),this.textures=[],this.renderSize_=Fe(e.grid.getTileSize(e.tile.tileCoord[0])),this.bandCount=NaN;const t=new tt(ft,Xi);t.fromArray([0,1,1,1,1,0,0,0]),this.helper.flushBufferData(t),this.coords=t,this.setTile(e.tile)}setHelper(e){var r;const t=(r=this.helper)==null?void 0:r.getGL();if(t){this.helper.deleteBuffer(this.coords);for(let n=0;n<this.textures.length;++n)t.deleteTexture(this.textures[n])}super.setHelper(e),e&&e.flushBufferData(this.coords)}uploadTile(){const e=this.helper,t=e.getGL(),r=this.tile;this.textures.length=0;let n;r instanceof _i||r instanceof ea?n=r.getImage():n=r.getData();const s=Kr(n);if(s){const x=t.createTexture();this.textures.push(x),this.bandCount=4,Pd(t,x,s,r.interpolate),this.setReady();return}n=qr(n);const o=r.getSize(),a=[o[0]+2*this.gutter,o[1]+2*this.gutter],l=n instanceof Float32Array,c=a[0]*a[1],h=l?Float32Array:Uint8Array,u=h.BYTES_PER_ELEMENT,f=n.byteLength/a[1];this.bandCount=Math.floor(f/u/a[0]);const g=Math.ceil(this.bandCount/4);if(g===1){const x=t.createTexture();this.textures.push(x),jn(e,x,n,a,this.bandCount,r.interpolate),this.setReady();return}const d=new Array(g);for(let x=0;x<g;++x){const T=t.createTexture();this.textures.push(T);const S=x<g-1?4:(this.bandCount-1)%4+1;d[x]=new h(c*S)}let p=0,m=0;const E=a[0]*this.bandCount;for(let x=0;x<a[1];++x){for(let T=0;T<E;++T){const S=n[m+T],P=Math.floor(p/this.bandCount),R=T%this.bandCount,L=Math.floor(R/4),I=d[L],C=I.length/c,w=R%4;I[P*C+w]=S,++p}m+=f/u}for(let x=0;x<g;++x){const T=this.textures[x],S=d[x],P=S.length/c;jn(e,T,S,a,P,r.interpolate)}this.setReady()}getImagePixelData_(e,t,r){const n=this.gutter,s=this.renderSize_[0],o=this.renderSize_[1];Rt||wd(),Rt.clearRect(0,0,1,1);const a=e.width,l=e.height,c=a-2*n,h=l-2*n,u=n+Math.floor(c*(t/s)),f=n+Math.floor(h*(r/o));let g;try{Rt.drawImage(e,u,f,1,1,0,0,1,1),g=Rt.getImageData(0,0,1,1).data}catch{return Rt=null,null}return g}getArrayPixelData_(e,t,r,n){const s=this.gutter,o=this.renderSize_[0],a=this.renderSize_[1],l=t[0],c=t[1],h=l+2*s,u=c+2*s,f=s+Math.floor(l*(r/o)),g=s+Math.floor(c*(n/a));if(e instanceof DataView){const p=e.byteLength/(h*u),m=p*(g*h+f),E=e.buffer.slice(m,m+p);return new DataView(E)}const d=this.bandCount*(g*h+f);return e.slice(d,d+this.bandCount)}getPixelData(e,t){if(!this.loaded)return null;if(this.tile instanceof Ei){const r=this.tile.getData(),n=qr(r);if(n){const s=this.tile.getSize();return this.getArrayPixelData_(n,s,e,t)}return this.getImagePixelData_(Kr(r),e,t)}return this.getImagePixelData_(this.tile.getImage(),e,t)}}class tr extends ta{constructor(e,t){super(e),t=t||{},this.inversePixelTransform_=_e(),this.postProcesses_=t.postProcesses,this.uniforms_=t.uniforms,this.helper,this.onMapChanged_=()=>{this.clearCache(),this.removeHelper()},e.addChangeListener(Jr.MAP,this.onMapChanged_),this.dispatchPreComposeEvent=this.dispatchPreComposeEvent.bind(this),this.dispatchPostComposeEvent=this.dispatchPostComposeEvent.bind(this)}dispatchPreComposeEvent(e,t){const r=this.getLayer();if(r.hasListener(lt.PRECOMPOSE)){const n=new Br(lt.PRECOMPOSE,void 0,t,e);r.dispatchEvent(n)}}dispatchPostComposeEvent(e,t){const r=this.getLayer();if(r.hasListener(lt.POSTCOMPOSE)){const n=new Br(lt.POSTCOMPOSE,void 0,t,e);r.dispatchEvent(n)}}reset(e){this.uniforms_=e.uniforms,this.helper&&this.helper.setUniforms(this.uniforms_)}removeHelper(){this.helper&&(this.helper.dispose(),delete this.helper)}prepareFrame(e){if(this.getLayer().getRenderSource()){let t=!0,r=-1,n;for(let o=0,a=e.layerStatesArray.length;o<a;o++){const l=e.layerStatesArray[o].layer,c=l.getRenderer();if(!(c instanceof tr)){t=!0;continue}const h=l.getClassName();if((t||h!==n)&&(r+=1,t=!1),n=h,c===this)break}const s="map/"+e.mapId+"/group/"+r;(!this.helper||!this.helper.canvasCacheKeyMatches(s)||this.helper.needsToBeRecreated())&&(this.removeHelper(),this.helper=new Td({postProcesses:this.postProcesses_,uniforms:this.uniforms_,canvasCacheKey:s}),n&&(this.helper.getCanvas().className=n),this.afterHelperCreated())}return this.prepareFrameInternal(e)}afterHelperCreated(){}prepareFrameInternal(e){return!0}clearCache(){}disposeInternal(){var e;this.clearCache(),this.removeHelper(),(e=this.getLayer())==null||e.removeChangeListener(Jr.MAP,this.onMapChanged_),super.disposeInternal()}dispatchRenderEvent_(e,t,r){const n=this.getLayer();if(n.hasListener(e)){mi(this.inversePixelTransform_,0,0,r.pixelRatio,-r.pixelRatio,0,0,-r.size[1]);const s=new Br(e,this.inversePixelTransform_,r,t);n.dispatchEvent(s)}}preRender(e,t){this.dispatchRenderEvent_(lt.PRERENDER,e,t)}postRender(e,t){this.dispatchRenderEvent_(lt.POSTRENDER,e,t)}}const Ld={TILE_TRANSFORM:"u_tileTransform",TRANSITION_ALPHA:"u_transitionAlpha",DEPTH:"u_depth",RENDER_EXTENT:"u_renderExtent",PATTERN_ORIGIN:"u_patternOrigin",RESOLUTION:"u_resolution",ZOOM:"u_zoom",GLOBAL_ALPHA:"u_globalAlpha",PROJECTION_MATRIX:"u_projectionMatrix",SCREEN_TO_WORLD_MATRIX:"u_screenToWorldMatrix"};function Wn(i){return 1/(i+2)}function vd(){return{tileIds:new Set,representationsByZ:{}}}function Zn(i,e){return i.tileIds.has(Q(e))}function Hn(i,e,t){const r=i.representationsByZ;t in r||(r[t]=new Set),r[t].add(e),i.tileIds.add(Q(e.tile))}function Xr(i,e){const t=i.layerStatesArray[i.layerIndex];t.extent&&(e=Ue(e,ds(t.extent,i.viewState.projection)));const r=t.layer.getRenderSource();if(!r.getWrapX()){const n=r.getTileGridForProjection(i.viewState.projection).getExtent();n&&(e=Ue(e,n))}return e}function si(i,e){return`${Q(i)},${i.getKey()},${i.getRevision()},${Tt(e)}`}class Ad extends tr{constructor(e,t){super(e,{uniforms:t.uniforms,postProcesses:t.postProcesses}),this.renderComplete=!1,this.tileTransform_=_e(),this.tempMat4=mt(),this.tempTileRange_=new ra(0,0,0,0),this.tempTileCoord_=Qr(0,0,0),this.tempSize_=[0,0];const r=t.cacheSize!==void 0?t.cacheSize:512;this.tileRepresentationCache=new hs(r),this.frameState=null,this.renderedProjection_=void 0}reset(e){super.reset({uniforms:e.uniforms})}prepareFrameInternal(e){this.renderedProjection_?e.viewState.projection!==this.renderedProjection_&&(this.clearCache(),this.renderedProjection_=e.viewState.projection):this.renderedProjection_=e.viewState.projection;const r=this.getLayer().getRenderSource();return!r||pi(Xr(e,e.extent))?!1:r.getState()==="ready"}createTileRepresentation(e){return ke()}enqueueTiles(e,t,r,n,s){const o=e.viewState,a=this.getLayer(),l=a.getRenderSource(),c=l.getTileGridForProjection(o.projection),h=l.getGutterForProjection(o.projection),u=Q(l);u in e.wantedTiles||(e.wantedTiles[u]={});const f=e.wantedTiles[u],g=this.tileRepresentationCache,d=a.getMapInternal(),p=Math.max(r-s,c.getMinZoom(),c.getZForResolution(Math.min(a.getMaxResolution(),d?d.getView().getResolutionForZoom(Math.max(a.getMinZoom(),0)):c.getResolution(0)),l.zDirection)),m=o.rotation,E=m?ia(o.center,o.resolution,m,e.size):void 0;for(let x=r;x>=p;--x){const T=c.getTileRangeForExtentAndZ(t,x,this.tempTileRange_),S=c.getResolution(x);for(let P=T.minX;P<=T.maxX;++P)for(let R=T.minY;R<=T.maxY;++R){if(m&&!c.tileCoordIntersectsViewport([x,P,R],E))continue;const L=Qr(x,P,R,this.tempTileCoord_),I=si(l,L);let C,w;if(g.containsKey(I)&&(C=g.get(I),w=C.tile),(!C||C.tile.key!==l.getKey())&&(w=l.getTile(x,P,R,e.pixelRatio,o.projection),!w)||Zn(n,w))continue;C?C.setTile(w):(C=this.createTileRepresentation({tile:w,grid:c,helper:this.helper,gutter:h}),g.set(I,C)),Hn(n,C,x);const U=w.getKey();f[U]=!0,w.getState()===V.IDLE&&(e.tileQueue.isKeyQueued(U)||e.tileQueue.enqueue([w,u,c.getTileCoordCenter(L),S]))}}}beforeTilesRender(e,t){this.helper.prepareDraw(this.frameState,!t,!0)}beforeTilesMaskRender(e){return!1}renderTile(e,t,r,n,s,o,a,l,c,h,u){}renderTileMask(e,t,r,n){}drawTile_(e,t,r,n,s,o,a){if(!t.ready)return;const c=t.tile.tileCoord,h=Tt(c),u=h in o?o[h]:1,f=a.getResolution(r),g=Fe(a.getTileSize(r),this.tempSize_),d=a.getOrigin(r),p=a.getTileCoordExtent(c),m=u<1?-1:Wn(r);u<1&&(e.animate=!0);const E=e.viewState,x=E.center[0],T=E.center[1],S=g[0]+2*n,P=g[1]+2*n,R=S/P,L=(x-d[0])/(g[0]*f),I=(d[1]-T)/(g[1]*f),C=E.resolution/f,w=c[1],U=c[2];na(this.tileTransform_),nn(this.tileTransform_,2/(e.size[0]*C/S),-2/(e.size[1]*C/S)),sa(this.tileTransform_,E.rotation),nn(this.tileTransform_,1,1/R),yi(this.tileTransform_,(g[0]*(w-L)-n)/S,(g[1]*(U-I)-n)/P),this.renderTile(t,this.tileTransform_,e,s,f,g,d,p,m,n,u)}renderFrame(e){this.frameState=e,this.renderComplete=!0;const t=this.helper.getGL();this.preRender(t,e);const r=e.viewState,n=this.getLayer(),s=n.getRenderSource(),o=s.getTileGridForProjection(r.projection),a=s.getGutterForProjection(r.projection),l=Xr(e,e.extent),c=o.getZForResolution(r.resolution,s.zDirection),h=vd(),u=n.getPreload();if(e.nextExtent){const T=o.getZForResolution(r.nextResolution,s.zDirection),S=Xr(e,e.nextExtent);this.enqueueTiles(e,S,T,h,u)}this.enqueueTiles(e,l,c,h,0),u>0&&setTimeout(()=>{this.enqueueTiles(e,l,c-1,h,u-1)},0);const f={};let g=!1;const d=h.representationsByZ;if(c in d){const T=Q(this),S=e.time;for(const P of d[c]){const R=P.tile;if(R.getState()===V.EMPTY)continue;const L=R.tileCoord;if(P.ready){const w=R.getAlpha(T,S);if(w===1){R.endTransition(T);continue}g=!0;const U=Tt(L);f[U]=w}if(this.renderComplete=!1,this.findAltTiles_(o,L,c+1,h))continue;const C=o.getMinZoom();for(let w=c-1;w>=C&&!this.findAltTiles_(o,L,w,h);--w);}}const p=Object.keys(d).map(Number).sort(oa);if(this.beforeTilesMaskRender(e))for(let T=0,S=p.length;T<S;++T){const P=p[T];for(const R of d[P]){const L=R.tile.tileCoord;if(Tt(L)in f)continue;const C=o.getTileCoordExtent(L);this.renderTileMask(R,P,C,Wn(P))}}this.beforeTilesRender(e,g);for(let T=0,S=p.length;T<S;++T){const P=p[T];for(const R of d[P]){const L=R.tile.tileCoord;Tt(L)in f||this.drawTile_(e,R,P,a,l,f,o)}}if(c in d)for(const T of d[c]){const S=T.tile.tileCoord;Tt(S)in f&&this.drawTile_(e,T,c,a,l,f,o)}this.beforeFinalize(e),this.helper.finalizeDraw(e,this.dispatchPreComposeEvent,this.dispatchPostComposeEvent);const E=this.helper.getCanvas();return this.tileRepresentationCache.expireCache(),this.postRender(t,e),E}beforeFinalize(e){}findAltTiles_(e,t,r,n){const s=e.getTileRangeForTileCoordAndZ(t,r,this.tempTileRange_);if(!s)return!1;let o=!0;const a=this.tileRepresentationCache,l=this.getLayer().getRenderSource();for(let c=s.minX;c<=s.maxX;++c)for(let h=s.minY;h<=s.maxY;++h){const u=si(l,[r,c,h]);let f=!1;if(a.containsKey(u)){const g=a.get(u);g.ready&&!Zn(n,g.tile)&&(Hn(n,g,r),f=!0)}f||(o=!1)}return o}clearCache(){super.clearCache();const e=this.tileRepresentationCache;e.forEach(t=>t.dispose()),e.clear()}afterHelperCreated(){super.afterHelperCreated(),this.tileRepresentationCache.forEach(e=>e.setHelper(this.helper))}disposeInternal(){super.disposeInternal(),delete this.frameState}}const X={...Ld,TILE_TEXTURE_ARRAY:"u_tileTextures",TEXTURE_PIXEL_WIDTH:"u_texturePixelWidth",TEXTURE_PIXEL_HEIGHT:"u_texturePixelHeight",TEXTURE_RESOLUTION:"u_textureResolution",TEXTURE_ORIGIN_X:"u_textureOriginX",TEXTURE_ORIGIN_Y:"u_textureOriginY"},cr={TEXTURE_COORD:"a_textureCoord"},Cd=[{name:cr.TEXTURE_COORD,size:2,type:de.FLOAT}];class Id extends Ad{constructor(e,t){super(e,t),this.program_,this.vertexShader_=t.vertexShader,this.fragmentShader_=t.fragmentShader,this.indices_=new tt(er,Xi),this.indices_.fromArray([0,1,3,1,2,3]),this.paletteTextures_=t.paletteTextures||[]}reset(e){if(super.reset(e),this.helper){const t=this.helper.getGL();for(const r of this.paletteTextures_)r.delete(t)}if(this.vertexShader_=e.vertexShader,this.fragmentShader_=e.fragmentShader,this.paletteTextures_=e.paletteTextures||[],this.helper){this.program_=this.helper.getProgram(this.fragmentShader_,this.vertexShader_);const t=this.helper.getGL();for(const r of this.paletteTextures_)r.getTexture(t)}}afterHelperCreated(){super.afterHelperCreated();const e=this.helper.getGL();for(const t of this.paletteTextures_)t.getTexture(e);this.program_=this.helper.getProgram(this.fragmentShader_,this.vertexShader_),this.helper.flushBufferData(this.indices_)}removeHelper(){if(this.helper){const e=this.helper.getGL();for(const t of this.paletteTextures_)t.delete(e)}super.removeHelper()}createTileRepresentation(e){return new bd(e)}beforeTilesRender(e,t){super.beforeTilesRender(e,t),this.helper.useProgram(this.program_,e)}renderTile(e,t,r,n,s,o,a,l,c,h,u){const f=this.helper.getGL();this.helper.bindBuffer(e.coords),this.helper.bindBuffer(this.indices_),this.helper.enableAttributes(Cd);let g=0;for(;g<e.textures.length;){const R=`${X.TILE_TEXTURE_ARRAY}[${g}]`;this.helper.bindTexture(e.textures[g],g,R),++g}for(let R=0;R<this.paletteTextures_.length;++R){const L=this.paletteTextures_[R],I=L.getTexture(f);this.helper.bindTexture(I,g,L.name),++g}const d=r.viewState,p=o[0]+2*h,m=o[1]+2*h,x=e.tile.tileCoord,T=x[1],S=x[2];this.helper.setUniformMatrixValue(X.TILE_TRANSFORM,Rr(this.tempMat4,t)),this.helper.setUniformFloatValue(X.TRANSITION_ALPHA,u),this.helper.setUniformFloatValue(X.DEPTH,c);let P=n;h>0&&(P=l,Ue(P,n,P)),this.helper.setUniformFloatVec4(X.RENDER_EXTENT,P),this.helper.setUniformFloatValue(X.RESOLUTION,d.resolution),this.helper.setUniformFloatValue(X.ZOOM,d.zoom),this.helper.setUniformFloatValue(X.TEXTURE_PIXEL_WIDTH,p),this.helper.setUniformFloatValue(X.TEXTURE_PIXEL_HEIGHT,m),this.helper.setUniformFloatValue(X.TEXTURE_RESOLUTION,s),this.helper.setUniformFloatValue(X.TEXTURE_ORIGIN_X,a[0]+T*o[0]*s-h*s),this.helper.setUniformFloatValue(X.TEXTURE_ORIGIN_Y,a[1]-S*o[1]*s+h*s),this.helper.drawElements(0,this.indices_.getSize())}getData(e){if(!this.helper.getGL())return null;const r=this.frameState;if(!r)return null;const n=this.getLayer(),s=Ve(r.pixelToCoordinateTransform,e.slice()),o=r.viewState,a=n.getExtent();if(a&&!St(ds(a,o.projection),s))return null;const l=n.getSources(fi([s]),o.resolution);let c,h,u;for(c=l.length-1;c>=0;--c)if(h=l[c],h.getState()==="ready"){if(u=h.getTileGridForProjection(o.projection),h.getWrapX())break;const g=u.getExtent();if(!g||St(g,s))break}if(c<0)return null;const f=this.tileRepresentationCache;for(let g=u.getZForResolution(o.resolution);g>=u.getMinZoom();--g){const d=u.getTileCoordForCoordAndZ(s,g),p=si(h,d);if(!f.containsKey(p))continue;const m=f.get(p);if(m.tile.getState()===V.EMPTY)return null;if(!m.loaded)continue;const x=u.getOrigin(g),T=Fe(u.getTileSize(g)),S=u.getResolution(g),P=(s[0]-x[0])/S-d[1]*T[0],R=(x[1]-s[1])/S-d[2]*T[1];return m.getPixelData(P,R)}return null}disposeInternal(){const e=this.helper;if(e){const t=e.getGL();for(const r of this.paletteTextures_)r.delete(t);this.paletteTextures_.length=0,t.deleteProgram(this.program_),delete this.program_,e.deleteBuffer(this.indices_)}super.disposeInternal(),delete this.indices_}}class Fd{constructor(e,t){this.name=e,this.data=t,this.texture_=null}getTexture(e){if(!this.texture_){const t=e.createTexture();e.bindTexture(e.TEXTURE_2D,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,this.data.length/4,1,0,e.RGBA,e.UNSIGNED_BYTE,this.data),this.texture_=t}return this.texture_}delete(e){this.texture_&&e.deleteTexture(this.texture_),this.texture_=null}}function Nd(i,e){return`operator_${i}_${Object.keys(e.functions).length}`}function rt(i){const e=i.toString();return e.includes(".")?e:e+".0"}function ki(i){if(i.length<2||i.length>4)throw new Error("`formatArray` can only output `vec2`, `vec3` or `vec4` arrays.");return`vec${i.length}(${i.map(rt).join(", ")})`}function ur(i){const e=Ht(i),t=e.length>3?e[3]:1;return ki([e[0]/255,e[1]/255,e[2]/255,t])}function Md(i){const e=Fe(i);return ki(e)}const kr={};let Od=0;function Lt(i){return i in kr||(kr[i]=Od++),kr[i]}function je(i){return rt(Lt(i))}function Dr(i){return"u_var_"+i}function ji(){return{variables:{},properties:{},functions:{},bandCount:0,featureId:!1,geometryType:!1}}const jr="getBandValue",Ks="u_paletteTextures",Js="featureId",Qs="geometryType",oi=-9999999;function Dd(i,e,t,r){const n=aa(i,e,t);return Wi(n,e,r)}function J(i){return(e,t,r)=>{const n=t.args.length,s=new Array(n);for(let o=0;o<n;++o)s[o]=Wi(t.args[o],r,e);return i(s,e)}}const Gd={[j.Get]:(i,e)=>{const r=e.args[0].value;r in i.properties||(i.properties[r]={name:r,type:e.type});let s="a_prop_"+r;return sn(e.type,Xt)&&(s=`(${s} > 0.0)`),s},[j.Id]:i=>(i.featureId=!0,"a_"+Js),[j.GeometryType]:i=>(i.geometryType=!0,"a_"+Qs),[j.LineMetric]:()=>"currentLineMetric",[j.Var]:(i,e)=>{const r=e.args[0].value;r in i.variables||(i.variables[r]={name:r,type:e.type});let s=Dr(r);return sn(e.type,Xt)&&(s=`(${s} > 0.0)`),s},[j.Has]:(i,e)=>{const r=e.args[0].value;return r in i.properties||(i.properties[r]={name:r,type:e.type}),`(a_prop_${r} != ${rt(oi)})`},[j.Resolution]:()=>"u_resolution",[j.Zoom]:()=>"u_zoom",[j.Time]:()=>"u_time",[j.Any]:J(i=>`(${i.join(" || ")})`),[j.All]:J(i=>`(${i.join(" && ")})`),[j.Not]:J(([i])=>`(!${i})`),[j.Equal]:J(([i,e])=>`(${i} == ${e})`),[j.NotEqual]:J(([i,e])=>`(${i} != ${e})`),[j.GreaterThan]:J(([i,e])=>`(${i} > ${e})`),[j.GreaterThanOrEqualTo]:J(([i,e])=>`(${i} >= ${e})`),[j.LessThan]:J(([i,e])=>`(${i} < ${e})`),[j.LessThanOrEqualTo]:J(([i,e])=>`(${i} <= ${e})`),[j.Multiply]:J(i=>`(${i.join(" * ")})`),[j.Divide]:J(([i,e])=>`(${i} / ${e})`),[j.Add]:J(i=>`(${i.join(" + ")})`),[j.Subtract]:J(([i,e])=>`(${i} - ${e})`),[j.Clamp]:J(([i,e,t])=>`clamp(${i}, ${e}, ${t})`),[j.Mod]:J(([i,e])=>`mod(${i}, ${e})`),[j.Pow]:J(([i,e])=>`pow(${i}, ${e})`),[j.Abs]:J(([i])=>`abs(${i})`),[j.Floor]:J(([i])=>`floor(${i})`),[j.Ceil]:J(([i])=>`ceil(${i})`),[j.Round]:J(([i])=>`floor(${i} + 0.5)`),[j.Sin]:J(([i])=>`sin(${i})`),[j.Cos]:J(([i])=>`cos(${i})`),[j.Atan]:J(([i,e])=>e!==void 0?`atan(${i}, ${e})`:`atan(${i})`),[j.Sqrt]:J(([i])=>`sqrt(${i})`),[j.Match]:J(i=>{const e=i[0],t=i[i.length-1];let r=null;for(let n=i.length-3;n>=1;n-=2){const s=i[n],o=i[n+1];r=`(${e} == ${s} ? ${o} : ${r||t})`}return r}),[j.Between]:J(([i,e,t])=>`(${i} >= ${e} && ${i} <= ${t})`),[j.Interpolate]:J(([i,e,...t])=>{let r="";for(let n=0;n<t.length-2;n+=2){const s=t[n],o=r||t[n+1],a=t[n+2],l=t[n+3];let c;i===rt(1)?c=`(${e} - ${s}) / (${a} - ${s})`:c=`(pow(${i}, (${e} - ${s})) - 1.0) / (pow(${i}, (${a} - ${s})) - 1.0)`,r=`mix(${o}, ${l}, clamp(${c}, 0.0, 1.0))`}return r}),[j.Case]:J(i=>{const e=i[i.length-1];let t=null;for(let r=i.length-3;r>=0;r-=2){const n=i[r],s=i[r+1];t=`(${n} ? ${s} : ${t||e})`}return t}),[j.In]:J(([i,...e],t)=>{const r=Nd("in",t),n=[];for(let s=0;s<e.length;s+=1)n.push(`  if (inputValue == ${e[s]}) { return true; }`);return t.functions[r]=`bool ${r}(float inputValue) {
${n.join(`
`)}
  return false;
}`,`${r}(${i})`}),[j.Array]:J(i=>`vec${i.length}(${i.join(", ")})`),[j.Color]:J(i=>{if(i.length===1)return`vec4(vec3(${i[0]} / 255.0), 1.0)`;if(i.length===2)return`vec4(vec3(${i[0]} / 255.0), ${i[1]})`;const e=i.slice(0,3).map(r=>`${r} / 255.0`);if(i.length===3)return`vec4(${e.join(", ")}, 1.0)`;const t=i[3];return`vec4(${e.join(", ")}, ${t})`}),[j.Band]:J(([i,e,t],r)=>{if(!(jr in r.functions)){let n="";const s=r.bandCount||1;for(let o=0;o<s;o++){const a=Math.floor(o/4);let l=o%4;o===s-1&&l===1&&(l=3);const c=`${X.TILE_TEXTURE_ARRAY}[${a}]`;n+=`  if (band == ${o+1}.0) {
    return texture2D(${c}, v_textureCoord + vec2(dx, dy))[${l}];
  }
`}r.functions[jr]=`float getBandValue(float band, float xOffset, float yOffset) {
  float dx = xOffset / ${X.TEXTURE_PIXEL_WIDTH};
  float dy = yOffset / ${X.TEXTURE_PIXEL_HEIGHT};
${n}
}`}return`${jr}(${i}, ${e??"0.0"}, ${t??"0.0"})`}),[j.Palette]:(i,e)=>{const[t,...r]=e.args,n=r.length,s=new Uint8Array(n*4);for(let c=0;c<r.length;c++){const h=r[c].value,u=Ht(h),f=c*4;s[f]=u[0],s[f+1]=u[1],s[f+2]=u[2],s[f+3]=u[3]*255}i.paletteTextures||(i.paletteTextures=[]);const o=`${Ks}[${i.paletteTextures.length}]`,a=new Fd(o,s);i.paletteTextures.push(a);const l=Wi(t,Y,i);return`texture2D(${o}, vec2((${l} + 0.5) / ${n}.0, 0.5))`}};function Wi(i,e,t){if(i instanceof la){const r=Gd[i.operator];if(r===void 0)throw new Error(`No compiler defined for this operator: ${JSON.stringify(i.operator)}`);return r(t,i,e)}if((i.type&Y)>0)return rt(i.value);if((i.type&Xt)>0)return i.value.toString();if((i.type&kt)>0)return je(i.value.toString());if((i.type&Se)>0)return ur(i.value);if((i.type&ht)>0)return ki(i.value);if((i.type&gt)>0)return Md(i.value);throw new Error(`Unexpected expression ${i.value} (expected type ${ca(e)})`)}function Ud(){return{"fill-color":"rgba(255,255,255,0.4)","stroke-color":"#3399CC","stroke-width":1.25,"circle-radius":5,"circle-fill-color":"rgba(255,255,255,0.4)","circle-stroke-width":1.25,"circle-stroke-color":"#3399CC"}}const Vn=.985;function D(i,e,t){const r=ua();return Dd(e,t,r,i)}function Bd(i){const e=Ht(i),t=e[0]*256,r=e[1],n=e[2]*256,s=Math.round(e[3]*255);return[t+r,n+s]}const zd=`vec4 unpackColor(vec2 packedColor) {
  return vec4(
    min(floor(packedColor[0] / 256.0) / 255.0, 1.0),
    min(mod(packedColor[0], 256.0) / 255.0, 1.0),
    min(floor(packedColor[1] / 256.0) / 255.0, 1.0),
    min(mod(packedColor[1], 256.0) / 255.0, 1.0)
  );
}`;function Zi(i){return i===Se||i===gt?2:i===ht?4:1}function ai(i){const e=Zi(i);return e>1?`vec${e}`:"float"}function eo(i,e){for(const t in e.variables){const r=e.variables[t],n=Dr(r.name);let s=ai(r.type);r.type===Se&&(s="vec4"),i.addUniform(n,s)}for(const t in e.properties){const r=e.properties[t],n=ai(r.type),s=`a_prop_${r.name}`;r.type===Se?i.addAttribute(s,n,`unpackColor(${s})`,"vec4"):i.addAttribute(s,n)}for(const t in e.functions)i.addVertexShaderFunction(e.functions[t]),i.addFragmentShaderFunction(e.functions[t])}function to(i,e){const t={};for(const r in i.variables){const n=i.variables[r],s=Dr(n.name);t[s]=()=>{const o=e[n.name];if(typeof o=="number")return o;if(typeof o=="boolean")return o?1:0;if(n.type===Se){const a=[...Ht(o||"#eee")];return a[0]/=255,a[1]/=255,a[2]/=255,a[3]??(a[3]=1),a}return typeof o=="string"?Lt(o):o}}return t}function ro(i){const e={};for(const t in i.properties){const r=i.properties[t],n=s=>{const o=s.get(r.name);return r.type===Se?Bd([...Ht(o||"#eee")]):typeof o=="string"?Lt(o):typeof o=="boolean"?o?1:0:o};e[`prop_${r.name}`]={size:Zi(r.type),callback:n}}return e}const Et=`#ifdef GL_FRAGMENT_PRECISION_HIGH
precision highp float;
#else
precision mediump float;
#endif
uniform mat4 u_projectionMatrix;
uniform mat4 u_screenToWorldMatrix;
uniform vec2 u_viewportSizePx;
uniform float u_pixelRatio;
uniform float u_globalAlpha;
uniform float u_time;
uniform float u_zoom;
uniform float u_resolution;
uniform float u_rotation;
uniform vec4 u_renderExtent;
uniform vec2 u_patternOrigin;
uniform float u_depth;
uniform mediump int u_hitDetection;

const float PI = 3.141592653589793238;
const float TWO_PI = 2.0 * PI;
float currentLineMetric = 0.; // an actual value will be used in the stroke shaders

${zd}
`,yt=Ud();class io{constructor(){this.uniforms_=[],this.attributes_=[],this.hasSymbol_=!1,this.symbolSizeExpression_=`vec2(${rt(yt["circle-radius"])} + ${rt(yt["circle-stroke-width"]*.5)})`,this.symbolRotationExpression_="0.0",this.symbolOffsetExpression_="vec2(0.0)",this.symbolColorExpression_=ur(yt["circle-fill-color"]),this.texCoordExpression_="vec4(0.0, 0.0, 1.0, 1.0)",this.discardExpression_="false",this.symbolRotateWithView_=!1,this.hasStroke_=!1,this.strokeWidthExpression_=rt(yt["stroke-width"]),this.strokeColorExpression_=ur(yt["stroke-color"]),this.strokeOffsetExpression_="0.",this.strokeCapExpression_=je("round"),this.strokeJoinExpression_=je("round"),this.strokeMiterLimitExpression_="10.",this.strokeDistanceFieldExpression_="-1000.",this.strokePatternLengthExpression_=null,this.hasFill_=!1,this.fillColorExpression_=ur(yt["fill-color"]),this.vertexShaderFunctions_=[],this.fragmentShaderFunctions_=[]}addUniform(e,t){return this.uniforms_.push({name:e,type:t}),this}addAttribute(e,t,r,n){return this.attributes_.push({name:e,type:t,varyingName:e.replace(/^a_/,"v_"),varyingType:n??t,varyingExpression:r??e}),this}setSymbolSizeExpression(e){return this.hasSymbol_=!0,this.symbolSizeExpression_=e,this}getSymbolSizeExpression(){return this.symbolSizeExpression_}setSymbolRotationExpression(e){return this.symbolRotationExpression_=e,this}setSymbolOffsetExpression(e){return this.symbolOffsetExpression_=e,this}getSymbolOffsetExpression(){return this.symbolOffsetExpression_}setSymbolColorExpression(e){return this.hasSymbol_=!0,this.symbolColorExpression_=e,this}getSymbolColorExpression(){return this.symbolColorExpression_}setTextureCoordinateExpression(e){return this.texCoordExpression_=e,this}setFragmentDiscardExpression(e){return this.discardExpression_=e,this}getFragmentDiscardExpression(){return this.discardExpression_}setSymbolRotateWithView(e){return this.symbolRotateWithView_=e,this}setStrokeWidthExpression(e){return this.hasStroke_=!0,this.strokeWidthExpression_=e,this}setStrokeColorExpression(e){return this.hasStroke_=!0,this.strokeColorExpression_=e,this}getStrokeColorExpression(){return this.strokeColorExpression_}setStrokeOffsetExpression(e){return this.strokeOffsetExpression_=e,this}setStrokeCapExpression(e){return this.strokeCapExpression_=e,this}setStrokeJoinExpression(e){return this.strokeJoinExpression_=e,this}setStrokeMiterLimitExpression(e){return this.strokeMiterLimitExpression_=e,this}setStrokeDistanceFieldExpression(e){return this.strokeDistanceFieldExpression_=e,this}setStrokePatternLengthExpression(e){return this.strokePatternLengthExpression_=e,this}getStrokePatternLengthExpression(){return this.strokePatternLengthExpression_}setFillColorExpression(e){return this.hasFill_=!0,this.fillColorExpression_=e,this}getFillColorExpression(){return this.fillColorExpression_}addVertexShaderFunction(e){return this.vertexShaderFunctions_.includes(e)?this:(this.vertexShaderFunctions_.push(e),this)}addFragmentShaderFunction(e){return this.fragmentShaderFunctions_.includes(e)?this:(this.fragmentShaderFunctions_.push(e),this)}getSymbolVertexShader(){return this.hasSymbol_?`${Et}
${this.uniforms_.map(e=>`uniform ${e.type} ${e.name};`).join(`
`)}
attribute vec2 a_position;
attribute vec2 a_localPosition;
attribute vec2 a_hitColor;

varying vec2 v_texCoord;
varying vec2 v_quadCoord;
varying vec4 v_hitColor;
varying vec2 v_centerPx;
varying float v_angle;
varying vec2 v_quadSizePx;

${this.attributes_.map(e=>`attribute ${e.type} ${e.name};
varying ${e.varyingType} ${e.varyingName};`).join(`
`)}
${this.vertexShaderFunctions_.join(`
`)}
vec2 pxToScreen(vec2 coordPx) {
  vec2 scaled = coordPx / u_viewportSizePx / 0.5;
  return scaled;
}

vec2 screenToPx(vec2 coordScreen) {
  return (coordScreen * 0.5 + 0.5) * u_viewportSizePx;
}

void main(void) {
  v_quadSizePx = ${this.symbolSizeExpression_};
  vec2 halfSizePx = v_quadSizePx * 0.5;
  vec2 centerOffsetPx = ${this.symbolOffsetExpression_};
  vec2 offsetPx = centerOffsetPx + a_localPosition * halfSizePx * vec2(1., -1.);
  float angle = ${this.symbolRotationExpression_}${this.symbolRotateWithView_?" + u_rotation":""};
  float c = cos(-angle);
  float s = sin(-angle);
  offsetPx = vec2(c * offsetPx.x - s * offsetPx.y, s * offsetPx.x + c * offsetPx.y);
  vec4 center = u_projectionMatrix * vec4(a_position, 0.0, 1.0);
  gl_Position = center + vec4(pxToScreen(offsetPx), u_depth, 0.);
  vec4 texCoord = ${this.texCoordExpression_};
  float u = mix(texCoord.s, texCoord.p, a_localPosition.x * 0.5 + 0.5);
  float v = mix(texCoord.t, texCoord.q, a_localPosition.y * 0.5 + 0.5);
  v_texCoord = vec2(u, v);
  v_hitColor = unpackColor(a_hitColor);
  v_angle = angle;
  c = cos(-v_angle);
  s = sin(-v_angle);
  centerOffsetPx = vec2(c * centerOffsetPx.x - s * centerOffsetPx.y, s * centerOffsetPx.x + c * centerOffsetPx.y);
  v_centerPx = screenToPx(center.xy) + centerOffsetPx;
${this.attributes_.map(e=>`  ${e.varyingName} = ${e.varyingExpression};`).join(`
`)}
}`:null}getSymbolFragmentShader(){return this.hasSymbol_?`${Et}
${this.uniforms_.map(e=>`uniform ${e.type} ${e.name};`).join(`
`)}
varying vec2 v_texCoord;
varying vec4 v_hitColor;
varying vec2 v_centerPx;
varying float v_angle;
varying vec2 v_quadSizePx;
${this.attributes_.map(e=>`varying ${e.varyingType} ${e.varyingName};`).join(`
`)}
${this.fragmentShaderFunctions_.join(`
`)}

void main(void) {
${this.attributes_.map(e=>`  ${e.varyingType} ${e.name} = ${e.varyingName}; // assign to original attribute name`).join(`
`)}
  if (${this.discardExpression_}) { discard; }
  vec2 coordsPx = gl_FragCoord.xy / u_pixelRatio - v_centerPx; // relative to center
  float c = cos(v_angle);
  float s = sin(v_angle);
  coordsPx = vec2(c * coordsPx.x - s * coordsPx.y, s * coordsPx.x + c * coordsPx.y);
  gl_FragColor = ${this.symbolColorExpression_};
  gl_FragColor.rgb *= gl_FragColor.a;
  if (u_hitDetection > 0) {
    if (gl_FragColor.a < 0.05) { discard; };
    gl_FragColor = v_hitColor;
  }
}`:null}getStrokeVertexShader(){return this.hasStroke_?`${Et}
${this.uniforms_.map(e=>`uniform ${e.type} ${e.name};`).join(`
`)}
attribute vec2 a_segmentStart;
attribute vec2 a_segmentEnd;
attribute vec2 a_localPosition;
attribute float a_measureStart;
attribute float a_measureEnd;
attribute float a_angleTangentSum;
attribute float a_distanceLow;
attribute float a_distanceHigh;
attribute vec2 a_joinAngles;
attribute vec2 a_hitColor;

varying vec2 v_segmentStartPx;
varying vec2 v_segmentEndPx;
varying float v_angleStart;
varying float v_angleEnd;
varying float v_width;
varying vec4 v_hitColor;
varying float v_distancePx;
varying float v_measureStart;
varying float v_measureEnd;

${this.attributes_.map(e=>`attribute ${e.type} ${e.name};
varying ${e.varyingType} ${e.varyingName};`).join(`
`)}
${this.vertexShaderFunctions_.join(`
`)}
vec2 worldToPx(vec2 worldPos) {
  vec4 screenPos = u_projectionMatrix * vec4(worldPos, 0.0, 1.0);
  return (0.5 * screenPos.xy + 0.5) * u_viewportSizePx;
}

vec4 pxToScreen(vec2 pxPos) {
  vec2 screenPos = 2.0 * pxPos / u_viewportSizePx - 1.0;
  return vec4(screenPos, u_depth, 1.0);
}

bool isCap(float joinAngle) {
  return joinAngle < -0.1;
}

vec2 getJoinOffsetDirection(vec2 normalPx, float joinAngle) {
  float halfAngle = joinAngle / 2.0;
  float c = cos(halfAngle);
  float s = sin(halfAngle);
  vec2 angleBisectorNormal = vec2(s * normalPx.x + c * normalPx.y, -c * normalPx.x + s * normalPx.y);
  float length = 1.0 / s;
  return angleBisectorNormal * length;
}

vec2 getOffsetPoint(vec2 point, vec2 normal, float joinAngle, float offsetPx) {
  // if on a cap or the join angle is too high, offset the line along the segment normal
  if (cos(joinAngle) > 0.998 || isCap(joinAngle)) {
    return point - normal * offsetPx;
  }
  // offset is applied along the inverted normal (positive offset goes "right" relative to line direction)
  return point - getJoinOffsetDirection(normal, joinAngle) * offsetPx;
}

void main(void) {
  v_angleStart = a_joinAngles.x;
  v_angleEnd = a_joinAngles.y;
  float startEndRatio = a_localPosition.x * 0.5 + 0.5;
  currentLineMetric = mix(a_measureStart, a_measureEnd, startEndRatio);
  // we're reading the fractional part while keeping the sign (so -4.12 gives -0.12, 3.45 gives 0.45)

  float lineWidth = ${this.strokeWidthExpression_};
  float lineOffsetPx = ${this.strokeOffsetExpression_};

  // compute segment start/end in px with offset
  vec2 segmentStartPx = worldToPx(a_segmentStart);
  vec2 segmentEndPx = worldToPx(a_segmentEnd);
  vec2 tangentPx = normalize(segmentEndPx - segmentStartPx);
  vec2 normalPx = vec2(-tangentPx.y, tangentPx.x);
  segmentStartPx = getOffsetPoint(segmentStartPx, normalPx, v_angleStart, lineOffsetPx),
  segmentEndPx = getOffsetPoint(segmentEndPx, normalPx, v_angleEnd, lineOffsetPx);

  // compute current vertex position
  float normalDir = -1. * a_localPosition.y;
  float tangentDir = -1. * a_localPosition.x;
  float angle = mix(v_angleStart, v_angleEnd, startEndRatio);
  vec2 joinDirection;
  vec2 positionPx = mix(segmentStartPx, segmentEndPx, startEndRatio);
  // if angle is too high, do not make a proper join
  if (cos(angle) > ${Vn} || isCap(angle)) {
    joinDirection = normalPx * normalDir - tangentPx * tangentDir;
  } else {
    joinDirection = getJoinOffsetDirection(normalPx * normalDir, angle);
  }
  positionPx = positionPx + joinDirection * (lineWidth * 0.5 + 1.); // adding 1 pixel for antialiasing
  gl_Position = pxToScreen(positionPx);

  v_segmentStartPx = segmentStartPx;
  v_segmentEndPx = segmentEndPx;
  v_width = lineWidth;
  v_hitColor = unpackColor(a_hitColor);

  v_distancePx = a_distanceLow / u_resolution - (lineOffsetPx * a_angleTangentSum);
  float distanceHighPx = a_distanceHigh / u_resolution;
  ${this.strokePatternLengthExpression_!==null?`v_distancePx = mod(v_distancePx, ${this.strokePatternLengthExpression_});
  distanceHighPx = mod(distanceHighPx, ${this.strokePatternLengthExpression_});
  `:""}v_distancePx += distanceHighPx;

  v_measureStart = a_measureStart;
  v_measureEnd = a_measureEnd;
${this.attributes_.map(e=>`  ${e.varyingName} = ${e.varyingExpression};`).join(`
`)}
}`:null}getStrokeFragmentShader(){return this.hasStroke_?`${Et}
${this.uniforms_.map(e=>`uniform ${e.type} ${e.name};`).join(`
`)}
varying vec2 v_segmentStartPx;
varying vec2 v_segmentEndPx;
varying float v_angleStart;
varying float v_angleEnd;
varying float v_width;
varying vec4 v_hitColor;
varying float v_distancePx;
varying float v_measureStart;
varying float v_measureEnd;
${this.attributes_.map(e=>`varying ${e.varyingType} ${e.varyingName};`).join(`
`)}
${this.fragmentShaderFunctions_.join(`
`)}

vec2 pxToWorld(vec2 pxPos) {
  vec2 screenPos = 2.0 * pxPos / u_viewportSizePx - 1.0;
  return (u_screenToWorldMatrix * vec4(screenPos, 0.0, 1.0)).xy;
}

bool isCap(float joinAngle) {
  return joinAngle < -0.1;
}

float segmentDistanceField(vec2 point, vec2 start, vec2 end, float width) {
  vec2 tangent = normalize(end - start);
  vec2 normal = vec2(-tangent.y, tangent.x);
  vec2 startToPoint = point - start;
  return abs(dot(startToPoint, normal)) - width * 0.5;
}

float buttCapDistanceField(vec2 point, vec2 start, vec2 end) {
  vec2 startToPoint = point - start;
  vec2 tangent = normalize(end - start);
  return dot(startToPoint, -tangent);
}

float squareCapDistanceField(vec2 point, vec2 start, vec2 end, float width) {
  return buttCapDistanceField(point, start, end) - width * 0.5;
}

float roundCapDistanceField(vec2 point, vec2 start, vec2 end, float width) {
  float onSegment = max(0., 1000. * dot(point - start, end - start)); // this is very high when inside the segment
  return length(point - start) - width * 0.5 - onSegment;
}

float roundJoinDistanceField(vec2 point, vec2 start, vec2 end, float width) {
  return roundCapDistanceField(point, start, end, width);
}

float bevelJoinField(vec2 point, vec2 start, vec2 end, float width, float joinAngle) {
  vec2 startToPoint = point - start;
  vec2 tangent = normalize(end - start);
  float c = cos(joinAngle * 0.5);
  float s = sin(joinAngle * 0.5);
  float direction = -sign(sin(joinAngle));
  vec2 bisector = vec2(c * tangent.x - s * tangent.y, s * tangent.x + c * tangent.y);
  float radius = width * 0.5 * s;
  return dot(startToPoint, bisector * direction) - radius;
}

float miterJoinDistanceField(vec2 point, vec2 start, vec2 end, float width, float joinAngle) {
  if (cos(joinAngle) > ${Vn}) { // avoid risking a division by zero
    return bevelJoinField(point, start, end, width, joinAngle);
  }
  float miterLength = 1. / sin(joinAngle * 0.5);
  float miterLimit = ${this.strokeMiterLimitExpression_};
  if (miterLength > miterLimit) {
    return bevelJoinField(point, start, end, width, joinAngle);
  }
  return -1000.;
}

float capDistanceField(vec2 point, vec2 start, vec2 end, float width, float capType) {
   if (capType == ${je("butt")}) {
    return buttCapDistanceField(point, start, end);
  } else if (capType == ${je("square")}) {
    return squareCapDistanceField(point, start, end, width);
  }
  return roundCapDistanceField(point, start, end, width);
}

float joinDistanceField(vec2 point, vec2 start, vec2 end, float width, float joinAngle, float joinType) {
  if (joinType == ${je("bevel")}) {
    return bevelJoinField(point, start, end, width, joinAngle);
  } else if (joinType == ${je("miter")}) {
    return miterJoinDistanceField(point, start, end, width, joinAngle);
  }
  return roundJoinDistanceField(point, start, end, width);
}

float computeSegmentPointDistance(vec2 point, vec2 start, vec2 end, float width, float joinAngle, float capType, float joinType) {
  if (isCap(joinAngle)) {
    return capDistanceField(point, start, end, width, capType);
  }
  return joinDistanceField(point, start, end, width, joinAngle, joinType);
}

float distanceFromSegment(vec2 point, vec2 start, vec2 end) {
  vec2 tangent = end - start;
  vec2 startToPoint = point - start;
  // inspire by capsule fn in https://iquilezles.org/articles/distfunctions/
  float h = clamp(dot(startToPoint, tangent) / dot(tangent, tangent), 0.0, 1.0);
  return length(startToPoint - tangent * h);
}

void main(void) {
${this.attributes_.map(e=>`  ${e.varyingType} ${e.name} = ${e.varyingName}; // assign to original attribute name`).join(`
`)}

  vec2 currentPointPx = gl_FragCoord.xy / u_pixelRatio;
  #ifdef GL_FRAGMENT_PRECISION_HIGH
  vec2 worldPos = pxToWorld(currentPointPx);
  if (
    abs(u_renderExtent[0] - u_renderExtent[2]) > 0.0 && (
      worldPos[0] < u_renderExtent[0] ||
      worldPos[1] < u_renderExtent[1] ||
      worldPos[0] > u_renderExtent[2] ||
      worldPos[1] > u_renderExtent[3]
    )
  ) {
    discard;
  }
  #endif

  float segmentLengthPx = length(v_segmentEndPx - v_segmentStartPx);
  segmentLengthPx = max(segmentLengthPx, 1.17549429e-38); // avoid divide by zero
  vec2 segmentTangent = (v_segmentEndPx - v_segmentStartPx) / segmentLengthPx;
  vec2 segmentNormal = vec2(-segmentTangent.y, segmentTangent.x);
  vec2 startToPointPx = currentPointPx - v_segmentStartPx;
  float lengthToPointPx = max(0., min(dot(segmentTangent, startToPointPx), segmentLengthPx));
  float currentLengthPx = lengthToPointPx + v_distancePx;
  float currentRadiusPx = distanceFromSegment(currentPointPx, v_segmentStartPx, v_segmentEndPx);
  float currentRadiusRatio = dot(segmentNormal, startToPointPx) * 2. / v_width;
  currentLineMetric = mix(v_measureStart, v_measureEnd, lengthToPointPx / segmentLengthPx);

  if (${this.discardExpression_}) { discard; }

  float capType = ${this.strokeCapExpression_};
  float joinType = ${this.strokeJoinExpression_};
  float segmentStartDistance = computeSegmentPointDistance(currentPointPx, v_segmentStartPx, v_segmentEndPx, v_width, v_angleStart, capType, joinType);
  float segmentEndDistance = computeSegmentPointDistance(currentPointPx, v_segmentEndPx, v_segmentStartPx, v_width, v_angleEnd, capType, joinType);
  float distanceField = max(
    segmentDistanceField(currentPointPx, v_segmentStartPx, v_segmentEndPx, v_width),
    max(segmentStartDistance, segmentEndDistance)
  );
  distanceField = max(distanceField, ${this.strokeDistanceFieldExpression_});

  vec4 color = ${this.strokeColorExpression_};
  color.a *= smoothstep(0.5, -0.5, distanceField);
  gl_FragColor = color;
  gl_FragColor.a *= u_globalAlpha;
  gl_FragColor.rgb *= gl_FragColor.a;
  if (u_hitDetection > 0) {
    if (gl_FragColor.a < 0.1) { discard; };
    gl_FragColor = v_hitColor;
  }
}`:null}getFillVertexShader(){return this.hasFill_?`${Et}
${this.uniforms_.map(e=>`uniform ${e.type} ${e.name};`).join(`
`)}
attribute vec2 a_position;
attribute vec2 a_hitColor;

varying vec4 v_hitColor;

${this.attributes_.map(e=>`attribute ${e.type} ${e.name};
varying ${e.varyingType} ${e.varyingName};`).join(`
`)}
${this.vertexShaderFunctions_.join(`
`)}
void main(void) {
  gl_Position = u_projectionMatrix * vec4(a_position, u_depth, 1.0);
  v_hitColor = unpackColor(a_hitColor);
${this.attributes_.map(e=>`  ${e.varyingName} = ${e.varyingExpression};`).join(`
`)}
}`:null}getFillFragmentShader(){return this.hasFill_?`${Et}
${this.uniforms_.map(e=>`uniform ${e.type} ${e.name};`).join(`
`)}
varying vec4 v_hitColor;
${this.attributes_.map(e=>`varying ${e.varyingType} ${e.varyingName};`).join(`
`)}
${this.fragmentShaderFunctions_.join(`
`)}
vec2 pxToWorld(vec2 pxPos) {
  vec2 screenPos = 2.0 * pxPos / u_viewportSizePx - 1.0;
  return (u_screenToWorldMatrix * vec4(screenPos, 0.0, 1.0)).xy;
}

vec2 worldToPx(vec2 worldPos) {
  vec4 screenPos = u_projectionMatrix * vec4(worldPos, 0.0, 1.0);
  return (0.5 * screenPos.xy + 0.5) * u_viewportSizePx;
}

void main(void) {
${this.attributes_.map(e=>`  ${e.varyingType} ${e.name} = ${e.varyingName}; // assign to original attribute name`).join(`
`)}
  vec2 pxPos = gl_FragCoord.xy / u_pixelRatio;
  vec2 pxOrigin = worldToPx(u_patternOrigin);
  #ifdef GL_FRAGMENT_PRECISION_HIGH
  vec2 worldPos = pxToWorld(pxPos);
  if (
    abs(u_renderExtent[0] - u_renderExtent[2]) > 0.0 && (
      worldPos[0] < u_renderExtent[0] ||
      worldPos[1] < u_renderExtent[1] ||
      worldPos[0] > u_renderExtent[2] ||
      worldPos[1] > u_renderExtent[3]
    )
  ) {
    discard;
  }
  #endif
  if (${this.discardExpression_}) { discard; }
  gl_FragColor = ${this.fillColorExpression_};
  gl_FragColor.a *= u_globalAlpha;
  gl_FragColor.rgb *= gl_FragColor.a;
  if (u_hitDetection > 0) {
    if (gl_FragColor.a < 0.1) { discard; };
    gl_FragColor = v_hitColor;
  }
}`:null}}class Pr{constructor(){this.globalCounter_=0,this.refToFeature_=new Map,this.uidToRef_=new Map,this.freeGlobalRef_=[],this.polygonBatch={entries:{},geometriesCount:0,verticesCount:0,ringsCount:0},this.pointBatch={entries:{},geometriesCount:0},this.lineStringBatch={entries:{},geometriesCount:0,verticesCount:0}}addFeatures(e,t){for(let r=0;r<e.length;r++)this.addFeature(e[r],t)}addFeature(e,t){let r=e.getGeometry();r&&(t&&(r=r.clone(),r.applyTransform(t)),this.addGeometry_(r,e))}clearFeatureEntryInPointBatch_(e){const t=Q(e),r=this.pointBatch.entries[t];if(r)return this.pointBatch.geometriesCount-=r.flatCoordss.length,delete this.pointBatch.entries[t],r}clearFeatureEntryInLineStringBatch_(e){const t=Q(e),r=this.lineStringBatch.entries[t];if(r)return this.lineStringBatch.verticesCount-=r.verticesCount,this.lineStringBatch.geometriesCount-=r.flatCoordss.length,delete this.lineStringBatch.entries[t],r}clearFeatureEntryInPolygonBatch_(e){const t=Q(e),r=this.polygonBatch.entries[t];if(r)return this.polygonBatch.verticesCount-=r.verticesCount,this.polygonBatch.ringsCount-=r.ringsCount,this.polygonBatch.geometriesCount-=r.flatCoordss.length,delete this.polygonBatch.entries[t],r}addGeometry_(e,t){var n;const r=e.getType();switch(r){case"GeometryCollection":{const s=e.getGeometriesArray();for(const o of s)this.addGeometry_(o,t);break}case"MultiPolygon":{const s=e;this.addCoordinates_(r,s.getFlatCoordinates(),s.getEndss(),t,Q(t),s.getStride());break}case"MultiLineString":{const s=e;this.addCoordinates_(r,s.getFlatCoordinates(),s.getEnds(),t,Q(t),s.getStride());break}case"MultiPoint":{const s=e;this.addCoordinates_(r,s.getFlatCoordinates(),null,t,Q(t),s.getStride());break}case"Polygon":{const s=e;this.addCoordinates_(r,s.getFlatCoordinates(),s.getEnds(),t,Q(t),s.getStride());break}case"Point":{const s=e;this.addCoordinates_(r,s.getFlatCoordinates(),null,t,Q(t),s.getStride());break}case"LineString":case"LinearRing":{const s=e,o=s.getStride();this.addCoordinates_(r,s.getFlatCoordinates(),null,t,Q(t),o,(n=s.getLayout)==null?void 0:n.call(s));break}}}addCoordinates_(e,t,r,n,s,o,a){let l;switch(e){case"MultiPolygon":{const c=r;for(let h=0,u=c.length;h<u;h++){let f=c[h];const g=h>0?c[h-1]:null,d=g?g[g.length-1]:0,p=f[f.length-1];f=d>0?f.map(m=>m-d):f,this.addCoordinates_("Polygon",t.slice(d,p),f,n,s,o,a)}break}case"MultiLineString":{const c=r;for(let h=0,u=c.length;h<u;h++){const f=h>0?c[h-1]:0;this.addCoordinates_("LineString",t.slice(f,c[h]),null,n,s,o,a)}break}case"MultiPoint":for(let c=0,h=t.length;c<h;c+=o)this.addCoordinates_("Point",t.slice(c,c+2),null,n,s,null,null);break;case"Polygon":{const c=r;if(n instanceof ha){const f=da(t,c);if(f.length>1){this.addCoordinates_("MultiPolygon",t,f,n,s,o,a);return}}this.polygonBatch.entries[s]||(this.polygonBatch.entries[s]=this.addRefToEntry_(s,{feature:n,flatCoordss:[],verticesCount:0,ringsCount:0,ringsVerticesCounts:[]})),l=t.length/o;const h=r.length,u=r.map((f,g,d)=>g>0?(f-d[g-1])/o:f/o);this.polygonBatch.verticesCount+=l,this.polygonBatch.ringsCount+=h,this.polygonBatch.geometriesCount++,this.polygonBatch.entries[s].flatCoordss.push($d(t,o)),this.polygonBatch.entries[s].ringsVerticesCounts.push(u),this.polygonBatch.entries[s].verticesCount+=l,this.polygonBatch.entries[s].ringsCount+=h;for(let f=0,g=c.length;f<g;f++){const d=f>0?c[f-1]:0;this.addCoordinates_("LinearRing",t.slice(d,c[f]),null,n,s,o,a)}break}case"Point":this.pointBatch.entries[s]||(this.pointBatch.entries[s]=this.addRefToEntry_(s,{feature:n,flatCoordss:[]})),this.pointBatch.geometriesCount++,this.pointBatch.entries[s].flatCoordss.push(t);break;case"LineString":case"LinearRing":this.lineStringBatch.entries[s]||(this.lineStringBatch.entries[s]=this.addRefToEntry_(s,{feature:n,flatCoordss:[],verticesCount:0})),l=t.length/o,this.lineStringBatch.verticesCount+=l,this.lineStringBatch.geometriesCount++,this.lineStringBatch.entries[s].flatCoordss.push(Xd(t,o,a)),this.lineStringBatch.entries[s].verticesCount+=l;break}}addRefToEntry_(e,t){const r=this.uidToRef_.get(e),n=r||this.freeGlobalRef_.pop()||++this.globalCounter_;return t.ref=n,r||(this.refToFeature_.set(n,t.feature),this.uidToRef_.set(e,n)),t}removeRef_(e,t){if(!e)throw new Error("This feature has no ref: "+t);this.refToFeature_.delete(e),this.uidToRef_.delete(t),this.freeGlobalRef_.push(e)}changeFeature(e,t){if(!this.uidToRef_.get(Q(e)))return;this.removeFeature(e);let r=e.getGeometry();r&&(t&&(r=r.clone(),r.applyTransform(t)),this.addGeometry_(r,e))}removeFeature(e){let t=this.clearFeatureEntryInPointBatch_(e);t=this.clearFeatureEntryInPolygonBatch_(e)||t,t=this.clearFeatureEntryInLineStringBatch_(e)||t,t&&this.removeRef_(t.ref,Q(t.feature))}clear(){this.polygonBatch.entries={},this.polygonBatch.geometriesCount=0,this.polygonBatch.verticesCount=0,this.polygonBatch.ringsCount=0,this.lineStringBatch.entries={},this.lineStringBatch.geometriesCount=0,this.lineStringBatch.verticesCount=0,this.pointBatch.entries={},this.pointBatch.geometriesCount=0,this.globalCounter_=0,this.freeGlobalRef_=[],this.refToFeature_.clear(),this.uidToRef_.clear()}getFeatureFromRef(e){return this.refToFeature_.get(e)}isEmpty(){return this.globalCounter_===0}filter(e){const t=new Pr;t.globalCounter_=this.globalCounter_,t.uidToRef_=this.uidToRef_,t.refToFeature_=this.refToFeature_;let r=!0;for(const n of this.refToFeature_.values())e(n)&&(t.addFeature(n),r=!1);return r?new Pr:t}}function $d(i,e){return e===2?i:i.filter((t,r)=>r%e<2)}function Xd(i,e,t){return e===3&&t==="XYM"?i:e===4?i.filter((r,n)=>n%e!==2):e===3?i.map((r,n)=>n%e!==2?r:0):new Array(i.length*1.5).fill(0).map((r,n)=>n%3===2?0:i[Math.round(n/1.5)])}function no(){const i='function t(t,n,x=2){const o=n&&n.length,i=o?n[0]*x:t.length;let f=e(t,0,i,x,!0);const l=[];if(!f||f.next===f.prev)return l;let c,y,h;if(o&&(f=function(t,n,r,x){const o=[];for(let r=0,i=n.length;r<i;r++){const f=e(t,n[r]*x,r<i-1?n[r+1]*x:t.length,x,!1);f===f.next&&(f.steiner=!0),o.push(a(f))}o.sort(u);for(let t=0;t<o.length;t++)r=s(o[t],r);return r}(t,n,f,x)),t.length>80*x){c=t[0],y=t[1];let e=c,n=y;for(let r=x;r<i;r+=x){const x=t[r],o=t[r+1];x<c&&(c=x),o<y&&(y=o),x>e&&(e=x),o>n&&(n=o)}h=Math.max(e-c,n-y),h=0!==h?32767/h:0}return r(f,l,x,c,y,h,0),l}function e(t,e,n,r,x){let o;if(x===function(t,e,n,r){let x=0;for(let o=e,i=n-r;o<n;o+=r)x+=(t[i]-t[o])*(t[o+1]+t[i+1]),i=o;return x}(t,e,n,r)>0)for(let x=e;x<n;x+=r)o=d(x/r|0,t[x],t[x+1],o);else for(let x=n-r;x>=e;x-=r)o=d(x/r|0,t[x],t[x+1],o);return o&&b(o,o.next)&&(w(o),o=o.next),o}function n(t,e){if(!t)return t;e||(e=t);let n,r=t;do{if(n=!1,r.steiner||!b(r,r.next)&&0!==v(r.prev,r,r.next))r=r.next;else{if(w(r),r=e=r.prev,r===r.next)break;n=!0}}while(n||r!==e);return e}function r(t,e,u,s,l,a,y){if(!t)return;!y&&a&&function(t,e,n,r){let x=t;do{0===x.z&&(x.z=c(x.x,x.y,e,n,r)),x.prevZ=x.prev,x.nextZ=x.next,x=x.next}while(x!==t);x.prevZ.nextZ=null,x.prevZ=null,function(t){let e,n=1;do{let r,x=t;t=null;let o=null;for(e=0;x;){e++;let i=x,f=0;for(let t=0;t<n&&(f++,i=i.nextZ,i);t++);let u=n;for(;f>0||u>0&&i;)0!==f&&(0===u||!i||x.z<=i.z)?(r=x,x=x.nextZ,f--):(r=i,i=i.nextZ,u--),o?o.nextZ=r:t=r,r.prevZ=o,o=r;x=i}o.nextZ=null,n*=2}while(e>1)}(x)}(t,s,l,a);let h=t;for(;t.prev!==t.next;){const c=t.prev,p=t.next;if(a?o(t,s,l,a):x(t))e.push(c.i,t.i,p.i),w(t),t=p.next,h=p.next;else if((t=p)===h){y?1===y?r(t=i(n(t),e),e,u,s,l,a,2):2===y&&f(t,e,u,s,l,a):r(n(t),e,u,s,l,a,1);break}}}function x(t){const e=t.prev,n=t,r=t.next;if(v(e,n,r)>=0)return!1;const x=e.x,o=n.x,i=r.x,f=e.y,u=n.y,s=r.y,l=Math.min(x,o,i),c=Math.min(f,u,s),a=Math.max(x,o,i),y=Math.max(f,u,s);let p=r.next;for(;p!==e;){if(p.x>=l&&p.x<=a&&p.y>=c&&p.y<=y&&h(x,f,o,u,i,s,p.x,p.y)&&v(p.prev,p,p.next)>=0)return!1;p=p.next}return!0}function o(t,e,n,r){const x=t.prev,o=t,i=t.next;if(v(x,o,i)>=0)return!1;const f=x.x,u=o.x,s=i.x,l=x.y,a=o.y,y=i.y,p=Math.min(f,u,s),b=Math.min(l,a,y),M=Math.max(f,u,s),m=Math.max(l,a,y),A=c(p,b,e,n,r),g=c(M,m,e,n,r);let Z=t.prevZ,d=t.nextZ;for(;Z&&Z.z>=A&&d&&d.z<=g;){if(Z.x>=p&&Z.x<=M&&Z.y>=b&&Z.y<=m&&Z!==x&&Z!==i&&h(f,l,u,a,s,y,Z.x,Z.y)&&v(Z.prev,Z,Z.next)>=0)return!1;if(Z=Z.prevZ,d.x>=p&&d.x<=M&&d.y>=b&&d.y<=m&&d!==x&&d!==i&&h(f,l,u,a,s,y,d.x,d.y)&&v(d.prev,d,d.next)>=0)return!1;d=d.nextZ}for(;Z&&Z.z>=A;){if(Z.x>=p&&Z.x<=M&&Z.y>=b&&Z.y<=m&&Z!==x&&Z!==i&&h(f,l,u,a,s,y,Z.x,Z.y)&&v(Z.prev,Z,Z.next)>=0)return!1;Z=Z.prevZ}for(;d&&d.z<=g;){if(d.x>=p&&d.x<=M&&d.y>=b&&d.y<=m&&d!==x&&d!==i&&h(f,l,u,a,s,y,d.x,d.y)&&v(d.prev,d,d.next)>=0)return!1;d=d.nextZ}return!0}function i(t,e){let r=t;do{const n=r.prev,x=r.next.next;!b(n,x)&&M(n,r,r.next,x)&&g(n,x)&&g(x,n)&&(e.push(n.i,r.i,x.i),w(r),w(r.next),r=t=x),r=r.next}while(r!==t);return n(r)}function f(t,e,x,o,i,f){let u=t;do{let t=u.next.next;for(;t!==u.prev;){if(u.i!==t.i&&p(u,t)){let s=Z(u,t);return u=n(u,u.next),s=n(s,s.next),r(u,e,x,o,i,f,0),void r(s,e,x,o,i,f,0)}t=t.next}u=u.next}while(u!==t)}function u(t,e){let n=t.x-e.x;if(0===n&&(n=t.y-e.y,0===n)){n=(t.next.y-t.y)/(t.next.x-t.x)-(e.next.y-e.y)/(e.next.x-e.x)}return n}function s(t,e){const r=function(t,e){let n=e;const r=t.x,x=t.y;let o,i=-1/0;if(b(t,n))return n;do{if(b(t,n.next))return n.next;if(x<=n.y&&x>=n.next.y&&n.next.y!==n.y){const t=n.x+(x-n.y)*(n.next.x-n.x)/(n.next.y-n.y);if(t<=r&&t>i&&(i=t,o=n.x<n.next.x?n:n.next,t===r))return o}n=n.next}while(n!==e);if(!o)return null;const f=o,u=o.x,s=o.y;let c=1/0;n=o;do{if(r>=n.x&&n.x>=u&&r!==n.x&&y(x<s?r:i,x,u,s,x<s?i:r,x,n.x,n.y)){const e=Math.abs(x-n.y)/(r-n.x);g(n,t)&&(e<c||e===c&&(n.x>o.x||n.x===o.x&&l(o,n)))&&(o=n,c=e)}n=n.next}while(n!==f);return o}(t,e);if(!r)return e;const x=Z(r,t);return n(x,x.next),n(r,r.next)}function l(t,e){return v(t.prev,t,e.prev)<0&&v(e.next,t,t.next)<0}function c(t,e,n,r,x){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-n)*x|0)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-r)*x|0)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function a(t){let e=t,n=t;do{(e.x<n.x||e.x===n.x&&e.y<n.y)&&(n=e),e=e.next}while(e!==t);return n}function y(t,e,n,r,x,o,i,f){return(x-i)*(e-f)>=(t-i)*(o-f)&&(t-i)*(r-f)>=(n-i)*(e-f)&&(n-i)*(o-f)>=(x-i)*(r-f)}function h(t,e,n,r,x,o,i,f){return!(t===i&&e===f)&&y(t,e,n,r,x,o,i,f)}function p(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!function(t,e){let n=t;do{if(n.i!==t.i&&n.next.i!==t.i&&n.i!==e.i&&n.next.i!==e.i&&M(n,n.next,t,e))return!0;n=n.next}while(n!==t);return!1}(t,e)&&(g(t,e)&&g(e,t)&&function(t,e){let n=t,r=!1;const x=(t.x+e.x)/2,o=(t.y+e.y)/2;do{n.y>o!=n.next.y>o&&n.next.y!==n.y&&x<(n.next.x-n.x)*(o-n.y)/(n.next.y-n.y)+n.x&&(r=!r),n=n.next}while(n!==t);return r}(t,e)&&(v(t.prev,t,e.prev)||v(t,e.prev,e))||b(t,e)&&v(t.prev,t,t.next)>0&&v(e.prev,e,e.next)>0)}function v(t,e,n){return(e.y-t.y)*(n.x-e.x)-(e.x-t.x)*(n.y-e.y)}function b(t,e){return t.x===e.x&&t.y===e.y}function M(t,e,n,r){const x=A(v(t,e,n)),o=A(v(t,e,r)),i=A(v(n,r,t)),f=A(v(n,r,e));return x!==o&&i!==f||(!(0!==x||!m(t,n,e))||(!(0!==o||!m(t,r,e))||(!(0!==i||!m(n,t,r))||!(0!==f||!m(n,e,r)))))}function m(t,e,n){return e.x<=Math.max(t.x,n.x)&&e.x>=Math.min(t.x,n.x)&&e.y<=Math.max(t.y,n.y)&&e.y>=Math.min(t.y,n.y)}function A(t){return t>0?1:t<0?-1:0}function g(t,e){return v(t.prev,t,t.next)<0?v(t,e,t.next)>=0&&v(t,t.prev,e)>=0:v(t,e,t.prev)<0||v(t,t.next,e)<0}function Z(t,e){const n=F(t.i,t.x,t.y),r=F(e.i,e.x,e.y),x=t.next,o=e.prev;return t.next=e,e.prev=t,n.next=x,x.prev=n,r.next=n,n.prev=r,o.next=r,r.prev=o,r}function d(t,e,n,r){const x=F(t,e,n);return r?(x.next=r.next,x.prev=r,r.next.prev=x,r.next=x):(x.prev=x,x.next=x),x}function w(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function F(t,e,n){return{i:t,x:e,y:n,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}function E(t,e){const n=e[0],r=e[1];return e[0]=t[0]*n+t[2]*r+t[4],e[1]=t[1]*n+t[3]*r+t[5],e}function I(t,e){const n=(r=e)[0]*r[3]-r[1]*r[2];var r;!function(t,e){if(!t)throw new Error(e)}(0!==n,"Transformation matrix cannot be inverted");const x=e[0],o=e[1],i=e[2],f=e[3],u=e[4],s=e[5];return t[0]=f/n,t[1]=-o/n,t[2]=-i/n,t[3]=x/n,t[4]=(i*s-f*u)/n,t[5]=-(x*s-o*u)/n,t}new Array(6);const z=[],B={vertexAttributesPosition:0,instanceAttributesPosition:0,indicesPosition:0};function P(t,e,n,r,x){const o=t[e++],i=t[e++],f=z;f.length=r;for(let n=0;n<f.length;n++)f[n]=t[e+n];let u=x?x.instanceAttributesPosition:0;return n[u++]=o,n[u++]=i,f.length&&(n.set(f,u),u+=f.length),B.instanceAttributesPosition=u,B}function N(t,e,n,r,x,o,i,f,u,s){const l=[t[e],t[e+1]],c=[t[n],t[n+1]],a=t[e+2],y=t[n+2],h=E(f,[...l]),p=E(f,[...c]);function v(t,e,n){const r=Math.sqrt((e[0]-t[0])*(e[0]-t[0])+(e[1]-t[1])*(e[1]-t[1])),x=[(e[0]-t[0])/r,(e[1]-t[1])/r],o=[-x[1],x[0]],i=Math.sqrt((n[0]-t[0])*(n[0]-t[0])+(n[1]-t[1])*(n[1]-t[1])),f=[(n[0]-t[0])/i,(n[1]-t[1])/i];let u=0===r||0===i?0:Math.acos((s=f[0]*x[0]+f[1]*x[1],l=-1,c=1,Math.min(Math.max(s,l),c)));var s,l,c;u=Math.max(u,1e-5);return f[0]*o[0]+f[1]*o[1]>0?u:2*Math.PI-u}let b=-1,M=-1,m=s;const A=null!==x;if(null!==r){b=v(h,p,E(f,[...[t[r],t[r+1]]])),Math.cos(b)<=.985&&(m+=Math.tan((b-Math.PI)/2))}if(A){M=v(p,h,E(f,[...[t[x],t[x+1]]])),Math.cos(M)<=.985&&(m+=Math.tan((Math.PI-M)/2))}const g=Math.pow(2,24),Z=u%g,d=Math.floor(u/g)*g;return o.push(l[0],l[1],a,c[0],c[1],y,b,M,Z,d,s),o.push(...i),{length:u+Math.sqrt((p[0]-h[0])*(p[0]-h[0])+(p[1]-h[1])*(p[1]-h[1])),angle:m}}function R(e,n,r,x,o){const i=2+o;let f=n;const u=e.slice(f,f+o);f+=o;const s=e[f++];let l=0;const c=new Array(s-1);for(let t=0;t<s;t++)l+=e[f++],t<s-1&&(c[t]=l);const a=e.slice(f,f+2*l),y=t(a,c,2);for(let t=0;t<y.length;t++)x.push(y[t]+r.length/i);for(let t=0;t<a.length;t+=2)r.push(a[t],a[t+1],...u);return f+2*l}const S="GENERATE_POLYGON_BUFFERS",T="GENERATE_POINT_BUFFERS",_="GENERATE_LINE_STRING_BUFFERS",O=self;O.onmessage=t=>{const e=t.data;switch(e.type){case T:{const t=2,n=2,r=e.customAttributesSize,x=n+r,o=new Float32Array(e.renderInstructions),i=o.length/x*(t+r),f=Uint32Array.from([0,1,3,1,2,3]),u=Float32Array.from([-1,-1,1,-1,1,1,-1,1]),s=new Float32Array(i);let l;for(let t=0;t<o.length;t+=x)l=P(o,t,s,r,l);const c=Object.assign({indicesBuffer:f.buffer,vertexAttributesBuffer:u.buffer,instanceAttributesBuffer:s.buffer,renderInstructions:o.buffer},e);O.postMessage(c,[u.buffer,s.buffer,f.buffer,o.buffer]);break}case _:{const t=[],n=e.customAttributesSize,r=3,x=new Float32Array(e.renderInstructions);let o=0;const i=[1,0,0,1,0,0];let f,u;for(I(i,e.renderInstructionsTransform);o<x.length;){u=Array.from(x.slice(o,o+n)),o+=n,f=x[o++];const e=o,s=o+(f-1)*r,l=x[e]===x[s]&&x[e+1]===x[s+1];let c=0,a=0;for(let n=0;n<f-1;n++){let y=null;n>0?y=o+(n-1)*r:l&&(y=s-r);let h=null;n<f-2?h=o+(n+2)*r:l&&(h=e+r);const p=N(x,o+n*r,o+(n+1)*r,y,h,t,u,i,c,a);c=p.length,a=p.angle}o+=f*r}const s=Uint32Array.from([0,1,3,1,2,3]),l=Float32Array.from([-1,-1,1,-1,1,1,-1,1]),c=Float32Array.from(t),a=Object.assign({indicesBuffer:s.buffer,vertexAttributesBuffer:l.buffer,instanceAttributesBuffer:c.buffer,renderInstructions:x.buffer},e);O.postMessage(a,[l.buffer,c.buffer,s.buffer,x.buffer]);break}case S:{const t=[],n=[],r=e.customAttributesSize,x=new Float32Array(e.renderInstructions);let o=0;for(;o<x.length;)o=R(x,o,t,n,r);const i=Uint32Array.from(n),f=Float32Array.from(t),u=Float32Array.from([]),s=Object.assign({indicesBuffer:i.buffer,vertexAttributesBuffer:f.buffer,instanceAttributesBuffer:u.buffer,renderInstructions:x.buffer},e);O.postMessage(s,[f.buffer,u.buffer,i.buffer,x.buffer]);break}}};';return new Worker(typeof Blob>"u"?"data:application/javascript;base64,"+Buffer.from(i,"binary").toString("base64"):URL.createObjectURL(new Blob([i],{type:"application/javascript"})))}const Ut={GENERATE_POLYGON_BUFFERS:"GENERATE_POLYGON_BUFFERS",GENERATE_POINT_BUFFERS:"GENERATE_POINT_BUFFERS",GENERATE_LINE_STRING_BUFFERS:"GENERATE_LINE_STRING_BUFFERS"};function so(i,e){e=e||[];const t=256,r=t-1,n=Math.floor(i/t/t/t)/r,s=Math.floor(i/t/t)%t/r,o=Math.floor(i/t)%t/r,a=i%t/r;return e[0]=n*256*255+s*255,e[1]=o*256*255+a*255,e}function oo(i){let e=0;const t=256,r=t-1;return e+=Math.round(i[0]*t*t*t*r),e+=Math.round(i[1]*t*t*r),e+=Math.round(i[2]*t*r),e+=Math.round(i[3]*r),e}function Hi(i,e,t,r){let n=0;for(const s in e){const o=e[s],a=o.callback.call(t,t.feature);let l=(a==null?void 0:a[0])??a;l===oi&&console.warn('The "has" operator might return false positives.'),l===void 0?l=oi:l===null&&(l=0),i[r+n++]=l,!(!o.size||o.size===1)&&(i[r+n++]=a[1],!(o.size<3)&&(i[r+n++]=a[2],!(o.size<4)&&(i[r+n++]=a[3])))}return n}function Gr(i){return Object.keys(i).reduce((e,t)=>e+(i[t].size||1),0)}function kd(i,e,t,r){const n=(2+Gr(t))*i.geometriesCount;(!e||e.length!==n)&&(e=new Float32Array(n));const s=[];let o=0;for(const a in i.entries){const l=i.entries[a];for(let c=0,h=l.flatCoordss.length;c<h;c++)s[0]=l.flatCoordss[c][0],s[1]=l.flatCoordss[c][1],Ve(r,s),e[o++]=s[0],e[o++]=s[1],o+=Hi(e,t,l,o)}return e}function jd(i,e,t,r){const n=3*i.verticesCount+(1+Gr(t))*i.geometriesCount;(!e||e.length!==n)&&(e=new Float32Array(n));const s=[];let o=0;for(const a in i.entries){const l=i.entries[a];for(let c=0,h=l.flatCoordss.length;c<h;c++){s.length=l.flatCoordss[c].length,fs(l.flatCoordss[c],0,s.length,3,r,s,3),o+=Hi(e,t,l,o),e[o++]=s.length/3;for(let u=0,f=s.length;u<f;u+=3)e[o++]=s[u],e[o++]=s[u+1],e[o++]=s[u+2]}}return e}function Wd(i,e,t,r){const n=2*i.verticesCount+(1+Gr(t))*i.geometriesCount+i.ringsCount;(!e||e.length!==n)&&(e=new Float32Array(n));const s=[];let o=0;for(const a in i.entries){const l=i.entries[a];for(let c=0,h=l.flatCoordss.length;c<h;c++){s.length=l.flatCoordss[c].length,fs(l.flatCoordss[c],0,s.length,2,r,s),o+=Hi(e,t,l,o),e[o++]=l.ringsVerticesCounts[c].length;for(let u=0,f=l.ringsVerticesCounts[c].length;u<f;u++)e[o++]=l.ringsVerticesCounts[c][u];for(let u=0,f=s.length;u<f;u+=2)e[o++]=s[u],e[o++]=s[u+1]}}return e}function wr(i){return(JSON.stringify(i).split("").reduce((t,r)=>(t<<5)-t+r.charCodeAt(0),0)>>>0).toString()}function Vi(i,e,t,r){if(`${r}radius`in i&&r!=="icon-"){let n=D(t,i[`${r}radius`],Y);if(`${r}radius2`in i){const s=D(t,i[`${r}radius2`],Y);n=`max(${n}, ${s})`}`${r}stroke-width`in i&&(n=`(${n} + ${D(t,i[`${r}stroke-width`],Y)} * 0.5)`),e.setSymbolSizeExpression(`vec2(${n} * 2. + 0.5)`)}if(`${r}scale`in i){const n=D(t,i[`${r}scale`],gt);e.setSymbolSizeExpression(`${e.getSymbolSizeExpression()} * ${n}`)}`${r}displacement`in i&&e.setSymbolOffsetExpression(D(t,i[`${r}displacement`],ht)),`${r}rotation`in i&&e.setSymbolRotationExpression(D(t,i[`${r}rotation`],Y)),`${r}rotate-with-view`in i&&e.setSymbolRotateWithView(!!i[`${r}rotate-with-view`])}function ao(i,e,t,r,n){let s="vec4(0.)";if(e!==null&&(s=e),t!==null&&r!==null){const l=`smoothstep(-${r} + 0.63, -${r} - 0.58, ${i})`;s=`mix(${t}, ${s}, ${l})`}const o=`(1.0 - smoothstep(-0.63, 0.58, ${i}))`;let a=`${s} * vec4(1.0, 1.0, 1.0, ${o})`;return n!==null&&(a=`${a} * vec4(1.0, 1.0, 1.0, ${n})`),a}function Yi(i,e,t,r,n){const s=new Image;s.crossOrigin=i[`${r}cross-origin`]===void 0?"anonymous":i[`${r}cross-origin`],ve(typeof i[`${r}src`]=="string",`WebGL layers do not support expressions for the ${r}src style property`),s.src=i[`${r}src`],t[`u_texture${n}_size`]=()=>s.complete?[s.width,s.height]:[0,0],e.addUniform(`u_texture${n}_size`,"vec2");const o=`u_texture${n}_size`;return t[`u_texture${n}`]=s,e.addUniform(`u_texture${n}`,"sampler2D"),o}function qi(i,e,t,r,n){let s=D(t,i[`${e}offset`],gt);if(`${e}offset-origin`in i)switch(i[`${e}offset-origin`]){case"top-right":s=`vec2(${r}.x, 0.) + ${n} * vec2(-1., 0.) + ${s} * vec2(-1., 1.)`;break;case"bottom-left":s=`vec2(0., ${r}.y) + ${n} * vec2(0., -1.) + ${s} * vec2(1., -1.)`;break;case"bottom-right":s=`${r} - ${n} - ${s}`;break}return s}function Zd(i,e,t,r){r.functions.circleDistanceField=`float circleDistanceField(vec2 point, float radius) {
  return length(point) - radius;
}`,Vi(i,e,r,"circle-");let n=null;"circle-opacity"in i&&(n=D(r,i["circle-opacity"],Y));let s="coordsPx";"circle-scale"in i&&(s=`coordsPx / ${D(r,i["circle-scale"],gt)}`);let o=null;"circle-fill-color"in i&&(o=D(r,i["circle-fill-color"],Se));let a=null;"circle-stroke-color"in i&&(a=D(r,i["circle-stroke-color"],Se));let l=D(r,i["circle-radius"],Y),c=null;"circle-stroke-width"in i&&(c=D(r,i["circle-stroke-width"],Y),l=`(${l} + ${c} * 0.5)`);const h=`circleDistanceField(${s}, ${l})`,u=ao(h,o,a,c,n);e.setSymbolColorExpression(u)}function Hd(i,e,t,r){r.functions.round=`float round(float v) {
  return sign(v) * floor(abs(v) + 0.5);
}`,r.functions.starDistanceField=`float starDistanceField(vec2 point, float numPoints, float radius, float radius2, float angle) {
  float startAngle = -PI * 0.5 + angle; // tip starts upwards and rotates clockwise with angle
  float c = cos(startAngle);
  float s = sin(startAngle);
  vec2 pointRotated = vec2(c * point.x - s * point.y, s * point.x + c * point.y);
  float alpha = TWO_PI / numPoints; // the angle of one sector
  float beta = atan(pointRotated.y, pointRotated.x);
  float gamma = round(beta / alpha) * alpha; // angle in sector
  c = cos(-gamma);
  s = sin(-gamma);
  vec2 inSector = vec2(c * pointRotated.x - s * pointRotated.y, abs(s * pointRotated.x + c * pointRotated.y));
  vec2 tipToPoint = inSector + vec2(-radius, 0.);
  vec2 edgeNormal = vec2(radius2 * sin(alpha * 0.5), -radius2 * cos(alpha * 0.5) + radius);
  return dot(normalize(edgeNormal), tipToPoint);
}`,r.functions.regularDistanceField=`float regularDistanceField(vec2 point, float numPoints, float radius, float angle) {
  float startAngle = -PI * 0.5 + angle; // tip starts upwards and rotates clockwise with angle
  float c = cos(startAngle);
  float s = sin(startAngle);
  vec2 pointRotated = vec2(c * point.x - s * point.y, s * point.x + c * point.y);
  float alpha = TWO_PI / numPoints; // the angle of one sector
  float radiusIn = radius * cos(PI / numPoints);
  float beta = atan(pointRotated.y, pointRotated.x);
  float gamma = round((beta - alpha * 0.5) / alpha) * alpha + alpha * 0.5; // angle in sector from mid
  c = cos(-gamma);
  s = sin(-gamma);
  vec2 inSector = vec2(c * pointRotated.x - s * pointRotated.y, abs(s * pointRotated.x + c * pointRotated.y));
  return inSector.x - radiusIn;
}`,Vi(i,e,r,"shape-");let n=null;"shape-opacity"in i&&(n=D(r,i["shape-opacity"],Y));let s="coordsPx";"shape-scale"in i&&(s=`coordsPx / ${D(r,i["shape-scale"],gt)}`);let o=null;"shape-fill-color"in i&&(o=D(r,i["shape-fill-color"],Se));let a=null;"shape-stroke-color"in i&&(a=D(r,i["shape-stroke-color"],Se));let l=null;"shape-stroke-width"in i&&(l=D(r,i["shape-stroke-width"],Y));const c=D(r,i["shape-points"],Y);let h="0.";"shape-angle"in i&&(h=D(r,i["shape-angle"],Y));let u,f=D(r,i["shape-radius"],Y);if(l!==null&&(f=`${f} + ${l} * 0.5`),"shape-radius2"in i){let d=D(r,i["shape-radius2"],Y);l!==null&&(d=`${d} + ${l} * 0.5`),u=`starDistanceField(${s}, ${c}, ${f}, ${d}, ${h})`}else u=`regularDistanceField(${s}, ${c}, ${f}, ${h})`;const g=ao(u,o,a,l,n);e.setSymbolColorExpression(g)}function Vd(i,e,t,r){let n="vec4(1.0)";"icon-color"in i&&(n=D(r,i["icon-color"],Se)),"icon-opacity"in i&&(n=`${n} * vec4(1.0, 1.0, 1.0, ${D(r,i["icon-opacity"],Y)})`);const s=wr(i["icon-src"]),o=Yi(i,e,t,"icon-",s);if(e.setSymbolColorExpression(`${n} * texture2D(u_texture${s}, v_texCoord)`).setSymbolSizeExpression(o),"icon-width"in i&&"icon-height"in i&&e.setSymbolSizeExpression(`vec2(${D(r,i["icon-width"],Y)}, ${D(r,i["icon-height"],Y)})`),"icon-offset"in i&&"icon-size"in i){const a=D(r,i["icon-size"],ht),l=e.getSymbolSizeExpression();e.setSymbolSizeExpression(a);const c=qi(i,"icon-",r,"v_quadSizePx",a);e.setTextureCoordinateExpression(`(vec4((${c}).xyxy) + vec4(0., 0., ${a})) / (${l}).xyxy`)}if(Vi(i,e,r,"icon-"),"icon-anchor"in i){const a=D(r,i["icon-anchor"],ht);let l="1.0";"icon-scale"in i&&(l=D(r,i["icon-scale"],gt));let c;i["icon-anchor-x-units"]==="pixels"&&i["icon-anchor-y-units"]==="pixels"?c=`${a} * ${l}`:i["icon-anchor-x-units"]==="pixels"?c=`${a} * vec2(vec2(${l}).x, v_quadSizePx.y)`:i["icon-anchor-y-units"]==="pixels"?c=`${a} * vec2(v_quadSizePx.x, vec2(${l}).x)`:c=`${a} * v_quadSizePx`;let h=`v_quadSizePx * vec2(0.5, -0.5) + ${c} * vec2(-1., 1.)`;if("icon-anchor-origin"in i)switch(i["icon-anchor-origin"]){case"top-right":h=`v_quadSizePx * -0.5 + ${c}`;break;case"bottom-left":h=`v_quadSizePx * 0.5 - ${c}`;break;case"bottom-right":h=`v_quadSizePx * vec2(-0.5, 0.5) + ${c} * vec2(1., -1.)`;break}e.setSymbolOffsetExpression(`${e.getSymbolOffsetExpression()} + ${h}`)}}function Yd(i,e,t,r){if("stroke-color"in i&&e.setStrokeColorExpression(D(r,i["stroke-color"],Se)),"stroke-pattern-src"in i){const n=wr(i["stroke-pattern-src"]),s=Yi(i,e,t,"stroke-pattern-",n);let o=s,a="vec2(0.)";"stroke-pattern-offset"in i&&"stroke-pattern-size"in i&&(o=D(r,i["stroke-pattern-size"],ht),a=qi(i,"stroke-pattern-",r,s,o));let l="0.";"stroke-pattern-spacing"in i&&(l=D(r,i["stroke-pattern-spacing"],Y));let c="0.";"stroke-pattern-start-offset"in i&&(c=D(r,i["stroke-pattern-start-offset"],Y)),r.functions.sampleStrokePattern=`vec4 sampleStrokePattern(sampler2D texture, vec2 textureSize, vec2 textureOffset, vec2 sampleSize, float spacingPx, float startOffsetPx, float currentLengthPx, float currentRadiusRatio, float lineWidth) {
  float currentLengthScaled = (currentLengthPx - startOffsetPx) * sampleSize.y / lineWidth;
  float spacingScaled = spacingPx * sampleSize.y / lineWidth;
  float uCoordPx = mod(currentLengthScaled, (sampleSize.x + spacingScaled));
  float isInsideOfPattern = step(uCoordPx, sampleSize.x);
  float vCoordPx = (-currentRadiusRatio * 0.5 + 0.5) * sampleSize.y;
  // make sure that we're not sampling too close to the borders to avoid interpolation with outside pixels
  uCoordPx = clamp(uCoordPx, 0.5, sampleSize.x - 0.5);
  vCoordPx = clamp(vCoordPx, 0.5, sampleSize.y - 0.5);
  vec2 texCoord = (vec2(uCoordPx, vCoordPx) + textureOffset) / textureSize;
  return texture2D(texture, texCoord) * vec4(1.0, 1.0, 1.0, isInsideOfPattern);
}`;const h=`u_texture${n}`;let u="1.";"stroke-color"in i&&(u=e.getStrokeColorExpression()),e.setStrokeColorExpression(`${u} * sampleStrokePattern(${h}, ${s}, ${a}, ${o}, ${l}, ${c}, currentLengthPx, currentRadiusRatio, v_width)`),r.functions.computeStrokePatternLength=`float computeStrokePatternLength(vec2 sampleSize, float spacingPx, float lineWidth) {
  float patternLengthPx = sampleSize.x / sampleSize.y * lineWidth;
  return patternLengthPx + spacingPx;
}`,e.setStrokePatternLengthExpression(`computeStrokePatternLength(${o}, ${l}, v_width)`)}if("stroke-width"in i&&e.setStrokeWidthExpression(D(r,i["stroke-width"],Y)),"stroke-offset"in i&&e.setStrokeOffsetExpression(D(r,i["stroke-offset"],Y)),"stroke-line-cap"in i&&e.setStrokeCapExpression(D(r,i["stroke-line-cap"],kt)),"stroke-line-join"in i&&e.setStrokeJoinExpression(D(r,i["stroke-line-join"],kt)),"stroke-miter-limit"in i&&e.setStrokeMiterLimitExpression(D(r,i["stroke-miter-limit"],Y)),"stroke-line-dash"in i){r.functions.getSingleDashDistance=`float getSingleDashDistance(float distance, float radius, float dashOffset, float dashLength, float dashLengthTotal, float capType, float lineWidth) {
  float localDistance = mod(distance, dashLengthTotal);
  float distanceSegment = abs(localDistance - dashOffset - dashLength * 0.5) - dashLength * 0.5;
  distanceSegment = min(distanceSegment, dashLengthTotal - localDistance);
  if (capType == ${je("square")}) {
    distanceSegment -= lineWidth * 0.5;
  } else if (capType == ${je("round")}) {
    distanceSegment = min(distanceSegment, sqrt(distanceSegment * distanceSegment + radius * radius) - lineWidth * 0.5);
  }
  return distanceSegment;
}`;let n=i["stroke-line-dash"].map(d=>D(r,d,Y));n.length%2===1&&(n=[...n,...n]);let s="0.";"stroke-line-dash-offset"in i&&(s=D(r,i["stroke-line-dash-offset"],Y));const a=`dashDistanceField_${wr(i["stroke-line-dash"])}`,l=n.map((d,p)=>`float dashLength${p}`).join(", "),c=n.map((d,p)=>`dashLength${p}`).join(" + ");let h="0.",u=`getSingleDashDistance(distance, radius, ${h}, dashLength0, totalDashLength, capType, lineWidth)`;for(let d=2;d<n.length;d+=2)h=`${h} + dashLength${d-2} + dashLength${d-1}`,u=`min(${u}, getSingleDashDistance(distance, radius, ${h}, dashLength${d}, totalDashLength, capType, lineWidth))`;r.functions[a]=`float ${a}(float distance, float radius, float capType, float lineWidth, ${l}) {
  float totalDashLength = ${c};
  return ${u};
}`;const f=n.map((d,p)=>`${d}`).join(", ");e.setStrokeDistanceFieldExpression(`${a}(currentLengthPx + ${s}, currentRadiusPx, capType, v_width, ${f})`);let g=n.join(" + ");e.getStrokePatternLengthExpression()&&(r.functions.combinePatternLengths=`float combinePatternLengths(float patternLength1, float patternLength2) {
  return patternLength1 * patternLength2;
}`,g=`combinePatternLengths(${e.getStrokePatternLengthExpression()}, ${g})`),e.setStrokePatternLengthExpression(g)}}function qd(i,e,t,r){if("fill-color"in i&&e.setFillColorExpression(D(r,i["fill-color"],Se)),"fill-pattern-src"in i){const n=wr(i["fill-pattern-src"]),s=Yi(i,e,t,"fill-pattern-",n);let o=s,a="vec2(0.)";"fill-pattern-offset"in i&&"fill-pattern-size"in i&&(o=D(r,i["fill-pattern-size"],ht),a=qi(i,"fill-pattern-",r,s,o)),r.functions.sampleFillPattern=`vec4 sampleFillPattern(sampler2D texture, vec2 textureSize, vec2 textureOffset, vec2 sampleSize, vec2 pxOrigin, vec2 pxPosition) {
  float scaleRatio = pow(2., mod(u_zoom + 0.5, 1.) - 0.5);
  vec2 pxRelativePos = pxPosition - pxOrigin;
  // rotate the relative position from origin by the current view rotation
  pxRelativePos = vec2(pxRelativePos.x * cos(u_rotation) - pxRelativePos.y * sin(u_rotation), pxRelativePos.x * sin(u_rotation) + pxRelativePos.y * cos(u_rotation));
  // sample position is computed according to the sample offset & size
  vec2 samplePos = mod(pxRelativePos / scaleRatio, sampleSize);
  // also make sure that we're not sampling too close to the borders to avoid interpolation with outside pixels
  samplePos = clamp(samplePos, vec2(0.5), sampleSize - vec2(0.5));
  samplePos.y = sampleSize.y - samplePos.y; // invert y axis so that images appear upright
  return texture2D(texture, (samplePos + textureOffset) / textureSize);
}`;const l=`u_texture${n}`;let c="1.";"fill-color"in i&&(c=e.getFillColorExpression()),e.setFillColorExpression(`${c} * sampleFillPattern(${l}, ${s}, ${a}, ${o}, pxOrigin, pxPos)`)}}function li(i,e,t){const r=ji(),n=new io,s={};if("icon-src"in i?Vd(i,n,s,r):"shape-points"in i?Hd(i,n,s,r):"circle-radius"in i&&Zd(i,n,s,r),Yd(i,n,s,r),qd(i,n,s,r),t){const l=D(r,t,Xt);n.setFragmentDiscardExpression(`!${l}`)}const o={};function a(l,c,h,u){if(!r[l])return;const f=ai(h),g=Zi(h);n.addAttribute(`a_${c}`,f),o[c]={size:g,callback:u}}return a("geometryType",Qs,kt,l=>Lt(fa(l.getGeometry()))),a("featureId",Js,kt|Y,l=>{const c=l.getId()??null;return typeof c=="string"?Lt(c):c}),eo(n,r),{builder:n,attributes:{...o,...ro(r)},uniforms:{...s,...to(r,e)}}}const Kd=[];let Wr;function Jd(){return Wr||(Wr=no()),Wr}let Qd=0;const Ce={POSITION:"a_position",LOCAL_POSITION:"a_localPosition",SEGMENT_START:"a_segmentStart",SEGMENT_END:"a_segmentEnd",MEASURE_START:"a_measureStart",MEASURE_END:"a_measureEnd",ANGLE_TANGENT_SUM:"a_angleTangentSum",JOIN_ANGLES:"a_joinAngles",DISTANCE_LOW:"a_distanceLow",DISTANCE_HIGH:"a_distanceHigh"};class ef{constructor(e,t,r,n){this.helper_,this.hitDetectionEnabled_=!!n,this.styleShaders=tf(e,t),this.customAttributes_={},this.uniforms_={},this.hitDetectionEnabled_&&(this.customAttributes_.hitColor={callback(){return so(this.ref,Kd)},size:2});for(const s of this.styleShaders){for(const o in s.attributes)o in this.customAttributes_||(this.customAttributes_[o]=s.attributes[o]);for(const o in s.uniforms)o in this.uniforms_||(this.uniforms_[o]=s.uniforms[o])}this.renderPasses_=this.styleShaders.map(s=>{const o={},a=Object.entries(this.customAttributes_).map(([l,c])=>({name:l in s.attributes||l==="hitColor"?`a_${l}`:null,size:c.size||1,type:de.FLOAT}));return s.builder.getFillVertexShader()&&(o.fillRenderPass={vertexShader:s.builder.getFillVertexShader(),fragmentShader:s.builder.getFillFragmentShader(),attributesDesc:[{name:Ce.POSITION,size:2,type:de.FLOAT},...a],instancedAttributesDesc:[],instancePrimitiveVertexCount:3}),s.builder.getStrokeVertexShader()&&(o.strokeRenderPass={vertexShader:s.builder.getStrokeVertexShader(),fragmentShader:s.builder.getStrokeFragmentShader(),attributesDesc:[{name:Ce.LOCAL_POSITION,size:2,type:de.FLOAT}],instancedAttributesDesc:[{name:Ce.SEGMENT_START,size:2,type:de.FLOAT},{name:Ce.MEASURE_START,size:1,type:de.FLOAT},{name:Ce.SEGMENT_END,size:2,type:de.FLOAT},{name:Ce.MEASURE_END,size:1,type:de.FLOAT},{name:Ce.JOIN_ANGLES,size:2,type:de.FLOAT},{name:Ce.DISTANCE_LOW,size:1,type:de.FLOAT},{name:Ce.DISTANCE_HIGH,size:1,type:de.FLOAT},{name:Ce.ANGLE_TANGENT_SUM,size:1,type:de.FLOAT},...a],instancePrimitiveVertexCount:6}),s.builder.getSymbolVertexShader()&&(o.symbolRenderPass={vertexShader:s.builder.getSymbolVertexShader(),fragmentShader:s.builder.getSymbolFragmentShader(),attributesDesc:[{name:Ce.LOCAL_POSITION,size:2,type:de.FLOAT}],instancedAttributesDesc:[{name:Ce.POSITION,size:2,type:de.FLOAT},...a],instancePrimitiveVertexCount:6}),o}),this.hasFill_=this.renderPasses_.some(s=>s.fillRenderPass),this.hasStroke_=this.renderPasses_.some(s=>s.strokeRenderPass),this.hasSymbol_=this.renderPasses_.some(s=>s.symbolRenderPass),this.setHelper(r)}async generateBuffers(e,t){if(e.isEmpty())return null;const r=this.generateRenderInstructions_(e,t),[n,s,o]=await Promise.all([this.generateBuffersForType_(r.polygonInstructions,"Polygon",t),this.generateBuffersForType_(r.lineStringInstructions,"LineString",t),this.generateBuffersForType_(r.pointInstructions,"Point",t)]),a=jt(_e(),t);return{polygonBuffers:n,lineStringBuffers:s,pointBuffers:o,invertVerticesTransform:a}}generateRenderInstructions_(e,t){const r=this.hasFill_?Wd(e.polygonBatch,new Float32Array(0),this.customAttributes_,t):null,n=this.hasStroke_?jd(e.lineStringBatch,new Float32Array(0),this.customAttributes_,t):null,s=this.hasSymbol_?kd(e.pointBatch,new Float32Array(0),this.customAttributes_,t):null;return{polygonInstructions:r,lineStringInstructions:n,pointInstructions:s}}generateBuffersForType_(e,t,r){if(e===null)return null;const n=Qd++;let s;switch(t){case"Polygon":s=Ut.GENERATE_POLYGON_BUFFERS;break;case"LineString":s=Ut.GENERATE_LINE_STRING_BUFFERS;break;case"Point":s=Ut.GENERATE_POINT_BUFFERS;break}const o={id:n,type:s,renderInstructions:e.buffer,renderInstructionsTransform:r,customAttributesSize:Gr(this.customAttributes_)},a=Jd();return a.postMessage(o,[e.buffer]),e=null,new Promise(l=>{const c=h=>{const u=h.data;if(u.id!==n||(a.removeEventListener("message",c),!this.helper_.getGL()))return;const f=new tt(er,Pt).fromArrayBuffer(u.indicesBuffer),g=new tt(ft,Pt).fromArrayBuffer(u.vertexAttributesBuffer),d=new tt(ft,Pt).fromArrayBuffer(u.instanceAttributesBuffer);this.helper_.flushBufferData(f),this.helper_.flushBufferData(g),this.helper_.flushBufferData(d),l([f,g,d])};a.addEventListener("message",c)})}render(e,t,r){for(const n of this.renderPasses_)n.fillRenderPass&&this.renderInternal_(e.polygonBuffers[0],e.polygonBuffers[1],e.polygonBuffers[2],n.fillRenderPass,t,r),n.strokeRenderPass&&this.renderInternal_(e.lineStringBuffers[0],e.lineStringBuffers[1],e.lineStringBuffers[2],n.strokeRenderPass,t,r),n.symbolRenderPass&&this.renderInternal_(e.pointBuffers[0],e.pointBuffers[1],e.pointBuffers[2],n.symbolRenderPass,t,r)}renderInternal_(e,t,r,n,s,o){const a=e.getSize();if(a===0)return;const l=n.instancedAttributesDesc.length;if(this.helper_.useProgram(n.program,s),this.helper_.bindBuffer(t),this.helper_.bindBuffer(e),this.helper_.enableAttributes(n.attributesDesc),this.helper_.bindBuffer(r),this.helper_.enableAttributesInstanced(n.instancedAttributesDesc),o(),l){const c=n.instancedAttributesDesc.reduce((u,f)=>u+(f.size||1),0),h=r.getSize()/c;this.helper_.drawElementsInstanced(0,a,h)}else this.helper_.drawElements(0,a)}setHelper(e,t=null){this.helper_=e;for(const r of this.renderPasses_)r.fillRenderPass&&(r.fillRenderPass.program=this.helper_.getProgram(r.fillRenderPass.fragmentShader,r.fillRenderPass.vertexShader)),r.strokeRenderPass&&(r.strokeRenderPass.program=this.helper_.getProgram(r.strokeRenderPass.fragmentShader,r.strokeRenderPass.vertexShader)),r.symbolRenderPass&&(r.symbolRenderPass.program=this.helper_.getProgram(r.symbolRenderPass.fragmentShader,r.symbolRenderPass.vertexShader));this.helper_.addUniforms(this.uniforms_),t&&(t.polygonBuffers&&(this.helper_.flushBufferData(t.polygonBuffers[0]),this.helper_.flushBufferData(t.polygonBuffers[1]),this.helper_.flushBufferData(t.polygonBuffers[2])),t.lineStringBuffers&&(this.helper_.flushBufferData(t.lineStringBuffers[0]),this.helper_.flushBufferData(t.lineStringBuffers[1]),this.helper_.flushBufferData(t.lineStringBuffers[2])),t.pointBuffers&&(this.helper_.flushBufferData(t.pointBuffers[0]),this.helper_.flushBufferData(t.pointBuffers[1]),this.helper_.flushBufferData(t.pointBuffers[2])))}}function tf(i,e){const t=Array.isArray(i)?i:[i];if("style"in t[0]){const r=[],n=t,s=[];for(const o of n){const a=Array.isArray(o.style)?o.style:[o.style];let l=o.filter;o.else&&s.length&&(l=["all",...s.map(h=>["!",h])],o.filter&&l.push(o.filter),l.length<3&&(l=l[1])),o.filter&&s.push(o.filter);const c=a.map(h=>li(h,e,l));r.push(...c)}return r}return"builder"in t[0]?t:t.map(r=>li(r,e,null))}const Oe=new Uint8Array(4);class lo{constructor(e,t){this.helper_=e;const r=e.getGL();this.texture_=r.createTexture(),this.framebuffer_=r.createFramebuffer(),this.depthbuffer_=r.createRenderbuffer(),this.size_=t||[1,1],this.data_=new Uint8Array(0),this.dataCacheDirty_=!0,this.updateSize_()}setSize(e){ga(e,this.size_)||(this.size_[0]=e[0],this.size_[1]=e[1],this.updateSize_())}getSize(){return this.size_}clearCachedData(){this.dataCacheDirty_=!0}readAll(){if(this.dataCacheDirty_){const e=this.size_,t=this.helper_.getGL();t.bindFramebuffer(t.FRAMEBUFFER,this.framebuffer_),t.readPixels(0,0,e[0],e[1],t.RGBA,t.UNSIGNED_BYTE,this.data_),this.dataCacheDirty_=!1}return this.data_}readPixel(e,t){if(e<0||t<0||e>this.size_[0]||t>=this.size_[1])return Oe[0]=0,Oe[1]=0,Oe[2]=0,Oe[3]=0,Oe;this.readAll();const r=Math.floor(e)+(this.size_[1]-Math.floor(t)-1)*this.size_[0];return Oe[0]=this.data_[r*4],Oe[1]=this.data_[r*4+1],Oe[2]=this.data_[r*4+2],Oe[3]=this.data_[r*4+3],Oe}getTexture(){return this.texture_}getFramebuffer(){return this.framebuffer_}getDepthbuffer(){return this.depthbuffer_}updateSize_(){const e=this.size_,t=this.helper_.getGL();this.texture_=this.helper_.createTexture(e,null,this.texture_),t.bindFramebuffer(t.FRAMEBUFFER,this.framebuffer_),t.viewport(0,0,e[0],e[1]),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.texture_,0),t.bindRenderbuffer(t.RENDERBUFFER,this.depthbuffer_),t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT16,e[0],e[1]),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,this.depthbuffer_),this.data_=new Uint8Array(e[0]*e[1]*4)}}function co(i,e){const t=i.viewState.projection,n=e.getSource().getWrapX()&&t.canWrapX(),s=t.getExtent(),o=i.extent,a=n?Ee(s):null,l=n?Math.ceil((o[2]-s[2])/a)+1:1;return[n?Math.floor((o[0]-s[0])/a):0,l,a]}const xt={...De,RENDER_EXTENT:"u_renderExtent",PATTERN_ORIGIN:"u_patternOrigin",GLOBAL_ALPHA:"u_globalAlpha"};class uo extends tr{constructor(e,t){const r={[xt.RENDER_EXTENT]:[0,0,0,0],[xt.PATTERN_ORIGIN]:[0,0],[xt.GLOBAL_ALPHA]:1};super(e,{uniforms:r,postProcesses:t.postProcesses}),this.hitDetectionEnabled_=!t.disableHitDetection,this.hitRenderTarget_,this.sourceRevision_=-1,this.previousExtent_=Vt(),this.currentTransform_=_e(),this.tmpCoords_=[0,0],this.tmpTransform_=_e(),this.tmpMat4_=mt(),this.currentFrameStateTransform_=_e(),this.styleVariables_={},this.style_=[],this.styleRenderer_=null,this.buffers_=null,this.applyOptions_(t),this.batch_=new Pr,this.initialFeaturesAdded_=!1,this.sourceListenKeys_=null}addInitialFeatures_(e){const t=this.getLayer().getSource();let r;this.batch_.addFeatures(t.getFeatures(),r),this.sourceListenKeys_=[We(t,Qe.ADDFEATURE,this.handleSourceFeatureAdded_.bind(this,r)),We(t,Qe.CHANGEFEATURE,this.handleSourceFeatureChanged_.bind(this,r),this),We(t,Qe.REMOVEFEATURE,this.handleSourceFeatureDelete_,this),We(t,Qe.CLEAR,this.handleSourceFeatureClear_,this)]}applyOptions_(e){this.styleVariables_=e.variables,this.style_=e.style}createRenderers_(){this.buffers_=null,this.styleRenderer_=new ef(this.style_,this.styleVariables_,this.helper,this.hitDetectionEnabled_)}reset(e){this.applyOptions_(e),this.helper&&this.createRenderers_(),super.reset(e)}afterHelperCreated(){this.styleRenderer_?this.styleRenderer_.setHelper(this.helper,this.buffers_):this.createRenderers_(),this.hitDetectionEnabled_&&(this.hitRenderTarget_=new lo(this.helper))}handleSourceFeatureAdded_(e,t){const r=t.feature;this.batch_.addFeature(r,e)}handleSourceFeatureChanged_(e,t){const r=t.feature;this.batch_.changeFeature(r,e)}handleSourceFeatureDelete_(e){const t=e.feature;this.batch_.removeFeature(t)}handleSourceFeatureClear_(){this.batch_.clear()}applyUniforms_(e){pa(this.tmpTransform_,this.currentFrameStateTransform_),zt(this.tmpTransform_,e),this.helper.setUniformMatrixValue(xt.PROJECTION_MATRIX,Rr(this.tmpMat4_,this.tmpTransform_)),jt(this.tmpTransform_,this.tmpTransform_),this.helper.setUniformMatrixValue(xt.SCREEN_TO_WORLD_MATRIX,Rr(this.tmpMat4_,this.tmpTransform_)),this.tmpCoords_[0]=0,this.tmpCoords_[1]=0,jt(this.tmpTransform_,e),Ve(this.tmpTransform_,this.tmpCoords_),this.helper.setUniformFloatVec2(xt.PATTERN_ORIGIN,this.tmpCoords_)}renderFrame(e){const t=this.helper.getGL();this.preRender(t,e);const[r,n,s]=co(e,this.getLayer());this.helper.prepareDraw(e),this.renderWorlds(e,!1,r,n,s),this.helper.finalizeDraw(e,this.dispatchPreComposeEvent,this.dispatchPostComposeEvent);const o=this.helper.getCanvas();return this.hitDetectionEnabled_&&(this.renderWorlds(e,!0,r,n,s),this.hitRenderTarget_.clearCachedData()),this.postRender(t,e),o}prepareFrameInternal(e){this.initialFeaturesAdded_||(this.addInitialFeatures_(e),this.initialFeaturesAdded_=!0);const t=this.getLayer(),r=t.getSource(),n=e.viewState,s=!e.viewHints[st.ANIMATING]&&!e.viewHints[st.INTERACTING],o=!$t(this.previousExtent_,e.extent),a=this.sourceRevision_<r.getRevision();if(a&&(this.sourceRevision_=r.getRevision()),s&&(o||a)){const l=n.projection,c=n.resolution,h=t instanceof Cr?t.getRenderBuffer():0,u=xi(e.extent,h*c);r.loadFeatures(u,c,l),this.ready=!1;const f=this.helper.makeProjectionTransform(e,_e());this.styleRenderer_.generateBuffers(this.batch_,f).then(g=>{this.buffers_&&this.disposeBuffers(this.buffers_),this.buffers_=g,this.ready=!0,this.getLayer().changed()}),this.previousExtent_=e.extent.slice()}return!0}renderWorlds(e,t,r,n,s){let o=r;t&&(this.hitRenderTarget_.setSize([Math.floor(e.size[0]/2),Math.floor(e.size[1]/2)]),this.helper.prepareDrawToRenderTarget(e,this.hitRenderTarget_,!0));do this.helper.makeProjectionTransform(e,this.currentFrameStateTransform_),yi(this.currentFrameStateTransform_,o*s,0),this.buffers_&&this.styleRenderer_.render(this.buffers_,e,()=>{this.applyUniforms_(this.buffers_.invertVerticesTransform),this.helper.applyHitDetectionUniform(t)});while(++o<n)}forEachFeatureAtCoordinate(e,t,r,n,s){if(ve(this.hitDetectionEnabled_,"`forEachFeatureAtCoordinate` cannot be used on a WebGL layer if the hit detection logic has been disabled using the `disableHitDetection: true` option."),!this.styleRenderer_||!this.hitDetectionEnabled_)return;const o=Ve(t.coordinateToPixelTransform,e.slice()),a=this.hitRenderTarget_.readPixel(o[0]/2,o[1]/2),l=[a[0]/255,a[1]/255,a[2]/255,a[3]/255],c=oo(l),h=this.batch_.getFeatureFromRef(c);if(h)return n(h,this.getLayer(),null)}disposeBuffers(e){const t=r=>{for(const n of r)n&&this.helper.deleteBuffer(n)};e.pointBuffers&&t(e.pointBuffers),e.lineStringBuffers&&t(e.lineStringBuffers),e.polygonBuffers&&t(e.polygonBuffers)}disposeInternal(){this.buffers_&&this.disposeBuffers(this.buffers_),this.sourceListenKeys_&&(this.sourceListenKeys_.forEach(function(e){Er(e)}),this.sourceListenKeys_=null),super.disposeInternal()}renderDeclutter(){}}const Xe={BLUR:"blur",GRADIENT:"gradient",RADIUS:"radius"},rf=["#00f","#0ff","#0f0","#ff0","#f00"];class nf extends Cr{constructor(e){e=e||{};const t=Object.assign({},e);delete t.gradient,delete t.radius,delete t.blur,delete t.weight,super(t),this.on,this.once,this.un,this.filter_=e.filter??!0,this.styleVariables_=e.variables||{},this.gradient_=null,this.addChangeListener(Xe.GRADIENT,this.handleGradientChanged_),this.setGradient(e.gradient?e.gradient:rf),this.setBlur(e.blur!==void 0?e.blur:15),this.setRadius(e.radius!==void 0?e.radius:8);const r=e.weight?e.weight:"weight";this.weight_=r,this.setRenderOrder(null)}getBlur(){return this.get(Xe.BLUR)}getGradient(){return this.get(Xe.GRADIENT)}getRadius(){return this.get(Xe.RADIUS)}handleGradientChanged_(){this.gradient_=sf(this.getGradient())}setBlur(e){const t=this.get(Xe.BLUR);if(this.set(Xe.BLUR,e),typeof e=="number"&&typeof t=="number"){this.changed();return}this.clearRenderer()}setGradient(e){this.set(Xe.GRADIENT,e)}setRadius(e){const t=this.get(Xe.RADIUS);if(this.set(Xe.RADIUS,e),typeof e=="number"&&typeof t=="number"){this.changed();return}this.clearRenderer()}setFilter(e){this.filter_=e,this.changed(),this.clearRenderer()}setWeight(e){this.weight_=e,this.changed(),this.clearRenderer()}createRenderer(){const e=new io,t=ji(),r=D(t,this.filter_,Xt);let n=D(t,this.getRadius(),Y),s=D(t,this.getBlur(),Y);const o={};typeof this.getBlur()=="number"&&(s="a_blur",o.a_blur=()=>this.getBlur(),e.addUniform("a_blur","float")),typeof this.getRadius()=="number"&&(n="a_radius",o.a_radius=()=>this.getRadius(),e.addUniform("a_radius","float"));const a={};let l=null;if(typeof this.weight_=="string"||typeof this.weight_=="function"){const u=typeof this.weight_=="string"?f=>f.get(this.weight_):this.weight_;a.prop_weight={size:1,callback:f=>{const g=u(f);return g!==void 0?ue(g,0,1):1}},l="a_prop_weight",e.addAttribute("a_prop_weight","float")}else{const u=["clamp",this.weight_,0,1];l=D(t,u,Y)}e.addFragmentShaderFunction(`float getBlurSlope() {
  float blur = max(1., ${s});
  float radius = ${n};
  return radius / blur;
}`).setSymbolSizeExpression(`vec2(${n} + ${s}) * 2.`).setSymbolColorExpression(`vec4(smoothstep(0., 1., (1. - length(coordsPx * 2. / v_quadSizePx)) * getBlurSlope()) * ${l})`).setStrokeColorExpression(`vec4(smoothstep(0., 1., (1. - length(currentRadiusPx * 2. / v_width)) * getBlurSlope()) * ${l})`).setStrokeWidthExpression(`(${n} + ${s}) * 2.`).setFillColorExpression(`vec4(${l})`).setFragmentDiscardExpression(`!${r}`),eo(e,t);const c=ro(t),h=to(t,this.styleVariables_);return new uo(this,{className:this.getClassName(),variables:this.styleVariables_,style:{builder:e,attributes:{...c,...a},uniforms:{...h,...o}},disableHitDetection:!1,postProcesses:[{fragmentShader:`
            precision mediump float;

            uniform sampler2D u_image;
            uniform sampler2D u_gradientTexture;
            uniform float u_opacity;

            varying vec2 v_texCoord;

            void main() {
              vec4 color = texture2D(u_image, v_texCoord);
              gl_FragColor.a = color.a * u_opacity;
              gl_FragColor.rgb = texture2D(u_gradientTexture, vec2(0.5, color.a)).rgb;
              gl_FragColor.rgb *= gl_FragColor.a;
            }`,uniforms:{u_gradientTexture:()=>this.gradient_,u_opacity:()=>this.getOpacity()}}]})}updateStyleVariables(e){Object.assign(this.styleVariables_,e),this.changed()}renderDeclutter(){}}function sf(i){const r=nt(1,256),n=r.createLinearGradient(0,0,1,256),s=1/(i.length-1);for(let o=0,a=i.length;o<a;++o)n.addColorStop(o*s,i[o]);return r.fillStyle=n,r.fillRect(0,0,1,256),r.canvas}class Ki extends gs{constructor(e,t,r,n,s){const o=s!==void 0?ct.IDLE:ct.LOADED;super(e,t,r,o),this.loader_=s!==void 0?s:null,this.canvas_=n,this.error_=null}getError(){return this.error_}handleLoad_(e){e?(this.error_=e,this.state=ct.ERROR):this.state=ct.LOADED,this.changed()}load(){this.state==ct.IDLE&&(this.state=ct.LOADING,this.changed(),this.loader_(this.handleLoad_.bind(this)))}getImage(){return this.canvas_}}class of extends ma{constructor(e){super(e),this.vectorRenderer_=new _a(e),this.layerImageRatio_=e.getImageRatio(),this.coordinateToVectorPixelTransform_=_e(),this.renderedPixelToCoordinateTransform_=null}disposeInternal(){this.vectorRenderer_.dispose(),super.disposeInternal()}getFeatures(e){if(!this.vectorRenderer_)return Promise.resolve([]);const t=Ve(this.coordinateToVectorPixelTransform_,Ve(this.renderedPixelToCoordinateTransform_,e.slice()));return this.vectorRenderer_.getFeatures(t)}handleFontsChanged(){this.vectorRenderer_.handleFontsChanged()}prepareFrame(e){var h;const t=e.pixelRatio,r=e.viewState,n=r.resolution,s=e.viewHints,o=this.vectorRenderer_;let a=e.extent;this.layerImageRatio_!==1&&(a=a.slice(0),ps(a,this.layerImageRatio_));const l=Ee(a)/n,c=Me(a)/n;if(!s[st.ANIMATING]&&!s[st.INTERACTING]&&!pi(a)){o.useContainer(null,null);const u=o.context,f=e.layerStatesArray[e.layerIndex],g=Object.assign({},f,{opacity:1}),d=Object.assign({},e,{extent:a,size:[l,c],viewState:Object.assign({},e.viewState,{rotation:0}),layerStatesArray:[g],layerIndex:0,declutter:null}),p=this.getLayer().getDeclutter();p&&(d.declutter={[p]:new Ea(9)});const m=new Ki(a,n,t,u.canvas,function(E){o.prepareFrame(d)&&o.replayGroupChanged&&(o.clipping=!1,o.renderFrame(d,null),o.renderDeclutter(d),o.renderDeferred(d),E())});m.addEventListener(Te.CHANGE,()=>{if(m.getState()!==ct.LOADED)return;this.image=m;const E=m.getPixelRatio(),x=ya(m.getResolution())*t/E;this.renderedResolution=x,this.coordinateToVectorPixelTransform_=mi(this.coordinateToVectorPixelTransform_,l/2,c/2,1/x,-1/x,0,-r.center[0],-r.center[1])}),m.load()}return this.image&&(this.renderedPixelToCoordinateTransform_=e.pixelToCoordinateTransform.slice()),!((h=this.getLayer().getSource())!=null&&h.loading)&&!!this.image}preRender(){}postRender(){}renderDeclutter(){}forEachFeatureAtCoordinate(e,t,r,n,s){return this.vectorRenderer_?this.vectorRenderer_.forEachFeatureAtCoordinate(e,t,r,n,s):super.forEachFeatureAtCoordinate(e,t,r,n,s)}}class af extends Cr{constructor(e){e=e||{};const t=Object.assign({},e);delete t.imageRatio,super(t),this.imageRatio_=e.imageRatio!==void 0?e.imageRatio:1}getImageRatio(){return this.imageRatio_}createRenderer(){return new of(this)}}class lf extends tr{constructor(e,t){const r=t.uniforms||{},n=_e();r[De.PROJECTION_MATRIX]=n,super(e,{uniforms:r,postProcesses:t.postProcesses}),this.sourceRevision_=-1,this.verticesBuffer_=new tt(ft,Pt),this.instanceAttributesBuffer_=new tt(ft,Pt),this.indicesBuffer_=new tt(er,Pt),this.vertexShader_=t.vertexShader,this.fragmentShader_=t.fragmentShader,this.program_,this.hitDetectionEnabled_=t.hitDetectionEnabled??!0;const s=t.attributes?t.attributes.map(function(a){return{name:"a_"+a.name,size:1,type:de.FLOAT}}):[];this.attributes=[{name:"a_localPosition",size:2,type:de.FLOAT}],this.instanceAttributes=[{name:"a_position",size:2,type:de.FLOAT}],this.hitDetectionEnabled_&&(this.instanceAttributes.push({name:"a_hitColor",size:2,type:de.FLOAT}),this.instanceAttributes.push({name:"a_featureUid",size:1,type:de.FLOAT})),this.instanceAttributes.push(...s),this.customAttributes=t.attributes?t.attributes:[],this.previousExtent_=Vt(),this.currentTransform_=n,this.renderTransform_=_e(),this.invertRenderTransform_=_e(),this.renderInstructions_=new Float32Array(0),this.hitRenderTarget_,this.lastSentId=0,this.worker_=no(),this.worker_.addEventListener("message",a=>{const l=a.data;if(l.type===Ut.GENERATE_POINT_BUFFERS){const c=l.projectionTransform;this.verticesBuffer_.fromArrayBuffer(l.vertexAttributesBuffer),this.instanceAttributesBuffer_.fromArrayBuffer(l.instanceAttributesBuffer),this.helper.flushBufferData(this.verticesBuffer_),this.helper.flushBufferData(this.instanceAttributesBuffer_),this.indicesBuffer_.fromArrayBuffer(l.indicesBuffer),this.helper.flushBufferData(this.indicesBuffer_),this.renderTransform_=c,jt(this.invertRenderTransform_,this.renderTransform_),this.renderInstructions_=new Float32Array(a.data.renderInstructions),l.id===this.lastSentId&&(this.ready=!0),this.getLayer().changed()}}),this.featureCache_={},this.featureCount_=0;const o=this.getLayer().getSource();this.sourceListenKeys_=[We(o,Qe.ADDFEATURE,this.handleSourceFeatureAdded_,this),We(o,Qe.CHANGEFEATURE,this.handleSourceFeatureChanged_,this),We(o,Qe.REMOVEFEATURE,this.handleSourceFeatureDelete_,this),We(o,Qe.CLEAR,this.handleSourceFeatureClear_,this)],o.forEachFeature(a=>{const l=a.getGeometry();l&&l.getType()==="Point"&&(this.featureCache_[Q(a)]={feature:a,properties:a.getProperties(),flatCoordinates:l.getFlatCoordinates()},this.featureCount_++)})}afterHelperCreated(){this.program_=this.helper.getProgram(this.fragmentShader_,this.vertexShader_),this.hitDetectionEnabled_&&(this.hitRenderTarget_=new lo(this.helper)),this.verticesBuffer_.getArray()&&this.helper.flushBufferData(this.verticesBuffer_),this.indicesBuffer_.getArray()&&this.helper.flushBufferData(this.indicesBuffer_)}handleSourceFeatureAdded_(e){const t=e.feature,r=t.getGeometry();r&&r.getType()==="Point"&&(this.featureCache_[Q(t)]={feature:t,properties:t.getProperties(),flatCoordinates:r.getFlatCoordinates()},this.featureCount_++)}handleSourceFeatureChanged_(e){const t=e.feature,r=Q(t),n=this.featureCache_[r],s=t.getGeometry();n?s&&s.getType()==="Point"?(n.properties=t.getProperties(),n.flatCoordinates=s.getFlatCoordinates()):(delete this.featureCache_[r],this.featureCount_--):s&&s.getType()==="Point"&&(this.featureCache_[r]={feature:t,properties:t.getProperties(),flatCoordinates:s.getFlatCoordinates()},this.featureCount_++)}handleSourceFeatureDelete_(e){const t=e.feature,r=Q(t);r in this.featureCache_&&(delete this.featureCache_[r],this.featureCount_--)}handleSourceFeatureClear_(){this.featureCache_={},this.featureCount_=0}renderFrame(e){const t=this.helper.getGL();this.preRender(t,e);const[r,n,s]=co(e,this.getLayer());return this.renderWorlds(e,!1,r,n,s),this.helper.finalizeDraw(e,this.dispatchPreComposeEvent,this.dispatchPostComposeEvent),this.hitDetectionEnabled_&&(this.renderWorlds(e,!0,r,n,s),this.hitRenderTarget_.clearCachedData()),this.postRender(t,e),this.helper.getCanvas()}prepareFrameInternal(e){const t=this.getLayer(),r=t.getSource(),n=e.viewState,s=!e.viewHints[st.ANIMATING]&&!e.viewHints[st.INTERACTING],o=!$t(this.previousExtent_,e.extent),a=this.sourceRevision_<r.getRevision();if(a&&(this.sourceRevision_=r.getRevision()),s&&(o||a)){const l=n.projection,c=n.resolution,h=t instanceof Cr?t.getRenderBuffer():0,u=xi(e.extent,h*c);r.loadFeatures(u,c,l),this.rebuildBuffers_(e),this.previousExtent_=e.extent.slice()}return this.helper.useProgram(this.program_,e),this.helper.prepareDraw(e),!0}rebuildBuffers_(e){const t=_e();this.helper.makeProjectionTransform(e,t);const n=(this.hitDetectionEnabled_?5:2)+this.customAttributes.length,s=n*this.featureCount_,o=this.renderInstructions_&&this.renderInstructions_.length===s?this.renderInstructions_:new Float32Array(s);this.renderInstructions_=null;let a=[];const l=[];let c=-1;e.viewState.projection;for(const u in this.featureCache_){const f=this.featureCache_[u];if(a[0]=f.flatCoordinates[0],a[1]=f.flatCoordinates[1],Ve(t,a),o[++c]=a[0],o[++c]=a[1],this.hitDetectionEnabled_){const g=so(c+3,l);o[++c]=g[0],o[++c]=g[1],o[++c]=Number(u)}for(let g=0;g<this.customAttributes.length;g++){const d=this.customAttributes[g].callback(f.feature,f.properties);o[++c]=d}}const h={id:++this.lastSentId,type:Ut.GENERATE_POINT_BUFFERS,renderInstructions:o.buffer,customAttributesSize:n-2};h.projectionTransform=t,this.ready=!1,this.worker_.postMessage(h,[o.buffer])}forEachFeatureAtCoordinate(e,t,r,n,s){if(ve(this.hitDetectionEnabled_,"`forEachFeatureAtCoordinate` cannot be used on a WebGL layer if the hit detection logic has been disabled using the `disableHitDetection: true` option."),!this.renderInstructions_||!this.hitDetectionEnabled_)return;const o=Ve(t.coordinateToPixelTransform,e.slice()),a=this.hitRenderTarget_.readPixel(o[0]/2,o[1]/2),l=[a[0]/255,a[1]/255,a[2]/255,a[3]/255],c=oo(l),h=this.renderInstructions_[c],u=Math.floor(h).toString(),g=this.getLayer().getSource().getFeatureByUid(u);if(g)return n(g,this.getLayer(),null)}renderWorlds(e,t,r,n,s){let o=r;this.helper.useProgram(this.program_,e),t&&(this.hitRenderTarget_.setSize([Math.floor(e.size[0]/2),Math.floor(e.size[1]/2)]),this.helper.prepareDrawToRenderTarget(e,this.hitRenderTarget_,!0));const a=this.instanceAttributes.reduce((c,h)=>c+(h.size||1),0),l=this.instanceAttributesBuffer_.getSize()/a;do{this.helper.bindBuffer(this.indicesBuffer_),this.helper.bindBuffer(this.verticesBuffer_),this.helper.enableAttributes(this.attributes),this.helper.bindBuffer(this.instanceAttributesBuffer_),this.helper.enableAttributesInstanced(this.instanceAttributes),this.helper.makeProjectionTransform(e,this.currentTransform_),yi(this.currentTransform_,o*s,0),zt(this.currentTransform_,this.invertRenderTransform_),this.helper.applyUniforms(e),this.helper.applyHitDetectionUniform(t);const c=this.indicesBuffer_.getSize();this.helper.drawElementsInstanced(0,c,l)}while(++o<n)}disposeInternal(){this.worker_.terminate(),this.sourceListenKeys_.forEach(function(e){Er(e)}),this.sourceListenKeys_=null,super.disposeInternal()}renderDeclutter(){}}class cf extends Ti{constructor(e){const t=Object.assign({},e);super(t),this.styleVariables_=e.variables||{},this.parseResult_=li(e.style,this.styleVariables_,e.filter),this.hitDetectionDisabled_=!!e.disableHitDetection}createRenderer(){const e=Object.keys(this.parseResult_.attributes).map(t=>({name:t,...this.parseResult_.attributes[t]}));return new lf(this,{vertexShader:this.parseResult_.builder.getSymbolVertexShader(),fragmentShader:this.parseResult_.builder.getSymbolFragmentShader(),hitDetectionEnabled:!this.hitDetectionDisabled_,uniforms:this.parseResult_.uniforms,attributes:e})}updateStyleVariables(e){Object.assign(this.styleVariables_,e),this.changed()}}function Yn(i,e){const t=`
    attribute vec2 ${cr.TEXTURE_COORD};
    uniform mat4 ${X.TILE_TRANSFORM};
    uniform float ${X.TEXTURE_PIXEL_WIDTH};
    uniform float ${X.TEXTURE_PIXEL_HEIGHT};
    uniform float ${X.TEXTURE_RESOLUTION};
    uniform float ${X.TEXTURE_ORIGIN_X};
    uniform float ${X.TEXTURE_ORIGIN_Y};
    uniform float ${X.DEPTH};

    varying vec2 v_textureCoord;
    varying vec2 v_mapCoord;

    void main() {
      v_textureCoord = ${cr.TEXTURE_COORD};
      v_mapCoord = vec2(
        ${X.TEXTURE_ORIGIN_X} + ${X.TEXTURE_RESOLUTION} * ${X.TEXTURE_PIXEL_WIDTH} * v_textureCoord[0],
        ${X.TEXTURE_ORIGIN_Y} - ${X.TEXTURE_RESOLUTION} * ${X.TEXTURE_PIXEL_HEIGHT} * v_textureCoord[1]
      );
      gl_Position = ${X.TILE_TRANSFORM} * vec4(${cr.TEXTURE_COORD}, ${X.DEPTH}, 1.0);
    }
  `,r={...ji(),bandCount:e},n=[];if(i.color!==void 0){const u=D(r,i.color,Se);n.push(`color = ${u};`)}if(i.contrast!==void 0){const u=D(r,i.contrast,Y);n.push(`color.rgb = clamp((${u} + 1.0) * color.rgb - (${u} / 2.0), vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0));`)}if(i.exposure!==void 0){const u=D(r,i.exposure,Y);n.push(`color.rgb = clamp((${u} + 1.0) * color.rgb, vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0));`)}if(i.saturation!==void 0){const u=D(r,i.saturation,Y);n.push(`
      float saturation = ${u} + 1.0;
      float sr = (1.0 - saturation) * 0.2126;
      float sg = (1.0 - saturation) * 0.7152;
      float sb = (1.0 - saturation) * 0.0722;
      mat3 saturationMatrix = mat3(
        sr + saturation, sr, sr,
        sg, sg + saturation, sg,
        sb, sb, sb + saturation
      );
      color.rgb = clamp(saturationMatrix * color.rgb, vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0));
    `)}if(i.gamma!==void 0){const u=D(r,i.gamma,Y);n.push(`color.rgb = pow(color.rgb, vec3(1.0 / ${u}));`)}if(i.brightness!==void 0){const u=D(r,i.brightness,Y);n.push(`color.rgb = clamp(color.rgb + ${u}, vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0));`)}const s={},o=Object.keys(r.variables).length;if(o>1&&!i.variables)throw new Error(`Missing variables in style (expected ${r.variables})`);for(let u=0;u<o;++u){const f=r.variables[Object.keys(r.variables)[u]];if(!(f.name in i.variables))throw new Error(`Missing '${f.name}' in style variables`);const g=Dr(f.name);s[g]=function(){let d=i.variables[f.name];return typeof d=="string"&&(d=Lt(d)),d!==void 0?d:-9999999}}const a=Object.keys(s).map(function(u){return`uniform float ${u};`}),l=Math.ceil(e/4);a.push(`uniform sampler2D ${X.TILE_TEXTURE_ARRAY}[${l}];`),r.paletteTextures&&a.push(`uniform sampler2D ${Ks}[${r.paletteTextures.length}];`);const c=Object.keys(r.functions).map(function(u){return r.functions[u]}),h=`
    #ifdef GL_FRAGMENT_PRECISION_HIGH
    precision highp float;
    #else
    precision mediump float;
    #endif

    varying vec2 v_textureCoord;
    varying vec2 v_mapCoord;
    uniform vec4 ${X.RENDER_EXTENT};
    uniform float ${X.TRANSITION_ALPHA};
    uniform float ${X.TEXTURE_PIXEL_WIDTH};
    uniform float ${X.TEXTURE_PIXEL_HEIGHT};
    uniform float ${X.RESOLUTION};
    uniform float ${X.ZOOM};

    ${a.join(`
`)}

    ${c.join(`
`)}

    void main() {
      if (
        v_mapCoord[0] < ${X.RENDER_EXTENT}[0] ||
        v_mapCoord[1] < ${X.RENDER_EXTENT}[1] ||
        v_mapCoord[0] > ${X.RENDER_EXTENT}[2] ||
        v_mapCoord[1] > ${X.RENDER_EXTENT}[3]
      ) {
        discard;
      }

      vec4 color = texture2D(${X.TILE_TEXTURE_ARRAY}[0],  v_textureCoord);

      ${n.join(`
`)}

      gl_FragColor = color;
      gl_FragColor.rgb *= gl_FragColor.a;
      gl_FragColor *= ${X.TRANSITION_ALPHA};
    }`;return{vertexShader:t,fragmentShader:h,uniforms:s,paletteTextures:r.paletteTextures}}class ho extends xa{constructor(e){e=e?Object.assign({},e):{};const t=e.style||{};delete e.style,super(e),this.sources_=e.sources,this.renderedSource_=null,this.renderedResolution_=NaN,this.style_=t,this.styleVariables_=this.style_.variables||{},this.handleSourceUpdate_(),this.addChangeListener(Jr.SOURCE,this.handleSourceUpdate_)}getSources(e,t){const r=this.getSource();return this.sources_?typeof this.sources_=="function"?this.sources_(e,t):this.sources_:r?[r]:[]}getRenderSource(){return this.renderedSource_||this.getSource()}getSourceState(){const e=this.getRenderSource();return e?e.getState():"undefined"}handleSourceUpdate_(){this.hasRenderer()&&this.getRenderer().clearCache();const e=this.getSource();if(e)if(e.getState()==="loading"){const t=()=>{e.getState()==="ready"&&(e.removeEventListener("change",t),this.setStyle(this.style_))};e.addEventListener("change",t)}else this.setStyle(this.style_)}getSourceBandCount_(){const e=Number.MAX_SAFE_INTEGER,t=this.getSources([-e,-e,e,e],e);return t&&t.length&&"bandCount"in t[0]?t[0].bandCount:4}createRenderer(){const e=Yn(this.style_,this.getSourceBandCount_());return new Id(this,{vertexShader:e.vertexShader,fragmentShader:e.fragmentShader,uniforms:e.uniforms,cacheSize:this.getCacheSize(),paletteTextures:e.paletteTextures})}renderSources(e,t){const r=this.getRenderer();let n;for(let s=0,o=t.length;s<o;++s)this.renderedSource_=t[s],r.prepareFrame(e)&&(n=r.renderFrame(e));return n}render(e,t){this.rendered=!0;const r=e.viewState,n=this.getSources(e.extent,r.resolution);let s=!0;for(let a=0,l=n.length;a<l;++a){const c=n[a],h=c.getState();if(h=="loading"){const u=()=>{c.getState()=="ready"&&(c.removeEventListener("change",u),this.changed())};c.addEventListener("change",u)}s=s&&h=="ready"}const o=this.renderSources(e,n);if(this.getRenderer().renderComplete&&s)return this.renderedResolution_=r.resolution,o;if(this.renderedResolution_>.5*r.resolution){const a=this.getSources(e.extent,this.renderedResolution_).filter(l=>!n.includes(l));if(a.length>0)return this.renderSources(e,a)}return o}setStyle(e){if(this.styleVariables_=e.variables||{},this.style_=e,this.hasRenderer()){const t=Yn(this.style_,this.getSourceBandCount_());this.getRenderer().reset({vertexShader:t.vertexShader,fragmentShader:t.fragmentShader,uniforms:t.uniforms,paletteTextures:t.paletteTextures}),this.changed()}}updateStyleVariables(e){Object.assign(this.styleVariables_,e),this.changed()}}ho.prototype.dispose;class uf extends Ti{constructor(e){const t=Object.assign({},e);super(t),this.styleVariables_=e.variables||{},this.style_=e.style,this.hitDetectionDisabled_=!!e.disableHitDetection}createRenderer(){return new uo(this,{style:this.style_,variables:this.styleVariables_,disableHitDetection:this.hitDetectionDisabled_})}updateStyleVariables(e){Object.assign(this.styleVariables_,e),this.changed()}setStyle(e){this.style_=e,this.clearRenderer(),this.changed()}}class hf extends Ta{constructor(e={}){const{mapboxStyle:t,applyOptions:r,...n}=e;super(n),t&&this.applyMapboxStyle(t,r)}applyMapboxStyle(e,t){return ol(this,e,t)}}Ra(gl);window.eoxMapAdvancedOlLayers={Graticule:ld,Heatmap:nf,Layer:Ti,VectorImage:af,WebGLPoints:cf,WebGLTile:ho,WebGLVector:uf,STAC:al,MapboxStyle:hf};function df(i){const e=i[0],t=new Array(e);let r=1<<e-1,n,s;for(n=0;n<e;++n)s=48,i[1]&r&&(s+=1),i[2]&r&&(s+=2),t[n]=String.fromCharCode(s),r>>=1;return t.join("")}const ff='<a class="ol-attribution-bing-tos" href="https://www.microsoft.com/maps/product/terms.html" target="_blank">Terms of Use</a>';class gf extends qe{constructor(e){const t=e.hidpi!==void 0?e.hidpi:!1;super({cacheSize:e.cacheSize,crossOrigin:"anonymous",interpolate:e.interpolate,projection:K("EPSG:3857"),reprojectionErrorThreshold:e.reprojectionErrorThreshold,state:"loading",tileLoadFunction:e.tileLoadFunction,tilePixelRatio:t?2:1,wrapX:e.wrapX!==void 0?e.wrapX:!0,transition:e.transition,zDirection:e.zDirection}),this.hidpi_=t,this.culture_=e.culture!==void 0?e.culture:"en-us",this.maxZoom_=e.maxZoom!==void 0?e.maxZoom:-1,this.apiKey_=e.key,this.imagerySet_=e.imagerySet,this.placeholderTiles_=e.placeholderTiles;const r=(e.url||"https://dev.virtualearth.net/REST/v1/Imagery/Metadata/")+this.imagerySet_+"?uriScheme=https&include=ImageryProviders&key="+this.apiKey_+"&c="+this.culture_;fetch(r).then(n=>n.json()).then(n=>this.handleImageryMetadataResponse(n))}getApiKey(){return this.apiKey_}getImagerySet(){return this.imagerySet_}handleImageryMetadataResponse(e){if(e.statusCode!=200||e.statusDescription!="OK"||e.authenticationResultCode!="ValidCredentials"||e.resourceSets.length!=1||e.resourceSets[0].resources.length!=1){this.setState("error");return}const t=e.resourceSets[0].resources[0],r=this.maxZoom_==-1?t.zoomMax:this.maxZoom_,n=this.getProjection(),s=Yt(n),o=this.hidpi_?2:1,a=t.imageWidth==t.imageHeight?t.imageWidth/o:[t.imageWidth/o,t.imageHeight/o],l=qt({extent:s,minZoom:t.zoomMin,maxZoom:r,tileSize:a});this.tileGrid=l;const c=this.culture_,h=this.hidpi_,u=this.placeholderTiles_;if(this.tileUrlFunction=Ri(t.imageUrlSubdomains.map(function(f){const g=[0,0,0],d=t.imageUrl.replace("{subdomain}",f).replace("{culture}",c);return function(p,m,E){if(!p)return;Qr(p[0],p[1],p[2],g);const x=new URL(d.replace("{quadkey}",df(g))),T=x.searchParams;return h&&(T.set("dpi","d1"),T.set("device","mobile")),u===!0?T.delete("n"):u===!1&&T.set("n","z"),x.toString()}})),t.imageryProviders){const f=Si(K("EPSG:4326"),this.getProjection());this.setAttributions(g=>{const d=[],p=g.viewState,m=this.getTileGrid(),E=m.getZForResolution(p.resolution,this.zDirection),T=m.getTileCoordForCoordAndZ(p.center,E)[0];return t.imageryProviders.map(function(S){let P=!1;const R=S.coverageAreas;for(let L=0,I=R.length;L<I;++L){const C=R[L];if(T>=C.zoomMin&&T<=C.zoomMax){const w=C.bbox,U=[w[1],w[0],w[3],w[2]],M=bt(U,f);if(wt(M,g.extent)){P=!0;break}}}P&&d.push(S.attribution)}),d.push(ff),d})}this.setState("ready")}}class pf extends ms{constructor(e){super({attributions:e.attributions,cacheSize:e.cacheSize,crossOrigin:e.crossOrigin,maxZoom:e.maxZoom!==void 0?e.maxZoom:18,minZoom:e.minZoom,projection:e.projection,transition:e.transition,wrapX:e.wrapX,zDirection:e.zDirection}),this.account_=e.account,this.mapId_=e.map||"",this.config_=e.config||{},this.templateCache_={},this.initializeMap_()}getConfig(){return this.config_}updateConfig(e){Object.assign(this.config_,e),this.initializeMap_()}setConfig(e){this.config_=e||{},this.initializeMap_()}initializeMap_(){const e=JSON.stringify(this.config_);if(this.templateCache_[e]){this.applyTemplate_(this.templateCache_[e]);return}let t="https://"+this.account_+".carto.com/api/v1/map";this.mapId_&&(t+="/named/"+this.mapId_);const r=new XMLHttpRequest;r.addEventListener("load",this.handleInitResponse_.bind(this,e)),r.addEventListener("error",this.handleInitError_.bind(this)),r.open("POST",t),r.setRequestHeader("Content-type","application/json"),r.send(JSON.stringify(this.config_))}handleInitResponse_(e,t){const r=t.target;if(!r.status||r.status>=200&&r.status<300){let n;try{n=JSON.parse(r.responseText)}catch{this.setState("error");return}this.applyTemplate_(n),this.templateCache_[e]=n,this.setState("ready")}else this.setState("error")}handleInitError_(e){this.setState("error")}applyTemplate_(e){const t="https://"+e.cdn_url.https+"/"+this.account_+"/api/v1/map/"+e.layergroupid+"/{z}/{x}/{y}.png";this.setUrl(t)}}const mf=`
  attribute vec4 a_position;
  attribute vec4 a_texcoord;

  uniform mat4 u_matrix;
  uniform mat4 u_textureMatrix;

  varying vec2 v_texcoord;

  void main() {
    gl_Position = u_matrix * a_position;
    vec2 texcoord = (u_textureMatrix * a_texcoord).xy;
    v_texcoord = texcoord;
  }
`,_f=`
  precision mediump float;

  varying vec2 v_texcoord;

  uniform sampler2D u_texture;

  void main() {
    if (
      v_texcoord.x < 0.0 ||
      v_texcoord.y < 0.0 ||
      v_texcoord.x > 1.0 ||
      v_texcoord.y > 1.0
    ) {
      discard;
    }
    gl_FragColor = texture2D(u_texture, v_texcoord);
  }
`;class Ef{constructor(e){this.gl_=e,this.program_=ci(e,_f,mf),this.positionLocation=e.getAttribLocation(this.program_,"a_position"),this.texcoordLocation=e.getAttribLocation(this.program_,"a_texcoord"),this.matrixLocation=e.getUniformLocation(this.program_,"u_matrix"),this.textureMatrixLocation=e.getUniformLocation(this.program_,"u_textureMatrix"),this.textureLocation=e.getUniformLocation(this.program_,"u_texture"),this.positionBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.positionBuffer),this.positions=[0,0,0,1,1,0,1,0,0,1,1,1],e.bufferData(e.ARRAY_BUFFER,new Float32Array(this.positions),e.STATIC_DRAW),this.texcoordBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.texcoordBuffer),this.texcoords=[0,0,0,1,1,0,1,0,0,1,1,1],e.bufferData(e.ARRAY_BUFFER,new Float32Array(this.texcoords),e.STATIC_DRAW)}drawImage(e,t,r,n,s,o,a,l,c,h,u,f,g){const d=this.gl_;l===void 0&&(l=n),c===void 0&&(c=s),o===void 0&&(o=t),a===void 0&&(a=r),h===void 0&&(h=o),u===void 0&&(u=a),f===void 0&&(f=d.canvas.width),g===void 0&&(g=d.canvas.height),d.bindTexture(d.TEXTURE_2D,e),d.useProgram(this.program_),d.bindBuffer(d.ARRAY_BUFFER,this.positionBuffer),d.enableVertexAttribArray(this.positionLocation),d.vertexAttribPointer(this.positionLocation,2,d.FLOAT,!1,0,0),d.bindBuffer(d.ARRAY_BUFFER,this.texcoordBuffer),d.enableVertexAttribArray(this.texcoordLocation),d.vertexAttribPointer(this.texcoordLocation,2,d.FLOAT,!1,0,0);let p=ni(0,f,0,g,-1,1);p=cd(p,l,c,0),p=Bn(p,h,u,1),d.uniformMatrix4fv(this.matrixLocation,!1,p);let m=ud(n/t,s/r,0);m=Bn(m,o/t,a/r,1),d.uniformMatrix4fv(this.textureMatrixLocation,!1,m),d.uniform1i(this.textureLocation,0),d.drawArrays(d.TRIANGLES,0,this.positions.length/2)}}function qn(i,e,t){const r=i.createShader(e);if(r===null)throw new Error("Shader compilation failed");if(i.shaderSource(r,t),i.compileShader(r),!i.getShaderParameter(r,i.COMPILE_STATUS)){const n=i.getShaderInfoLog(r);throw n===null?new Error("Shader info log creation failed"):new Error(n)}return r}function ci(i,e,t){const r=i.createProgram(),n=qn(i,i.VERTEX_SHADER,t),s=qn(i,i.FRAGMENT_SHADER,e);if(r===null)throw new Error("Program creation failed");if(i.attachShader(r,n),i.attachShader(r,s),i.linkProgram(r),!i.getProgramParameter(r,i.LINK_STATUS))throw i.getProgramInfoLog(r)===null?new Error("Program info log creation failed"):new Error;return r}const yf=`
  attribute vec4 a_position;

  uniform mat4 u_matrix;

  void main() {
     gl_Position = u_matrix * a_position;
  }
`,xf=`
  precision mediump float;

  uniform vec4 u_val;
  void main() {
     gl_FragColor = u_val;
  }
`,Tf=`
  attribute vec4 a_position;
  attribute vec2 a_texcoord;

  varying vec2 v_texcoord;

  uniform mat4 u_matrix;

  void main() {
     gl_Position = u_matrix * a_position;
     v_texcoord = a_texcoord;
  }
`,Rf=`
  precision mediump float;

  varying vec2 v_texcoord;

  uniform sampler2D u_texture;

  void main() {
    if (v_texcoord.x < 0.0 || v_texcoord.x > 1.0 || v_texcoord.y < 0.0 || v_texcoord.y > 1.0) {
      discard;
    }
    gl_FragColor = texture2D(u_texture, v_texcoord);
  }
`;function Sf(i,e,t,r){let n;return t&&t.length?n=t.shift():Sa?n=new OffscreenCanvas(i||300,e||300):n=document.createElement("canvas"),i&&(n.width=i),e&&(n.height=e),n.getContext("webgl",r)}function Pf(i){const e=i.canvas;e.width=1,e.height=1,i.clear(i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT|i.STENCIL_BUFFER_BIT)}const Kn=[];function wf(i,e,t,r,n,s,o,a,l,c,h,u,f,g){const d=Math.round(r*e),p=Math.round(r*t);i.canvas.width=d,i.canvas.height=p;let m,E;if(E=i.createTexture(),i.bindTexture(i.TEXTURE_2D,E),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),f?(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.LINEAR)):(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.NEAREST)),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,d,p,0,i.RGBA,h,null),m=i.createFramebuffer(),i.bindFramebuffer(i.FRAMEBUFFER,m),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,E,0),m===null)throw new Error("Could not create framebuffer");if(E===null)throw new Error("Could not create texture");if(l.length===0)return{width:d,height:p,framebuffer:m,texture:E};const x=Vt();l.forEach(function(w,U,M){Pa(x,w.extent)});let T,S,P;const R=1/n;{if(T=i.createTexture(),E===null)throw new Error("Could not create texture");S=Math.round(Ee(x)*R),P=Math.round(Me(x)*R);const w=i.getParameter(i.MAX_TEXTURE_SIZE),U=Math.max(S,P),M=U>w?w/U:1,z=Math.round(S*M),Z=Math.round(P*M);i.bindTexture(i.TEXTURE_2D,T),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),f?(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.LINEAR)):(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.NEAREST)),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,z,Z,0,i.RGBA,h,null);const $=i.createFramebuffer();i.bindFramebuffer(i.FRAMEBUFFER,$),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,T,0);const se=new Ef(i);l.forEach(function(B,le,ne){const oe=(B.extent[0]-x[0])*R*M,he=-(B.extent[3]-x[3])*R*M,xe=Ee(B.extent)*R*M,ce=Me(B.extent)*R*M;if(i.bindFramebuffer(i.FRAMEBUFFER,$),i.viewport(0,0,z,Z),B.clipExtent){const we=(B.clipExtent[0]-x[0])*R*M,Ne=-(B.clipExtent[3]-x[3])*R*M,$e=Ee(B.clipExtent)*R*M,_t=Me(B.clipExtent)*R*M;i.enable(i.SCISSOR_TEST),i.scissor(f?we:Math.round(we),f?Ne:Math.round(Ne),f?$e:Math.round(we+$e)-Math.round(we),f?_t:Math.round(Ne+_t)-Math.round(Ne))}se.drawImage(B.texture,B.width,B.height,c,c,B.width-2*c,B.height-2*c,f?oe:Math.round(oe),f?he:Math.round(he),f?xe:Math.round(oe+xe)-Math.round(oe),f?ce:Math.round(he+ce)-Math.round(he),z,Z),i.disable(i.SCISSOR_TEST)}),i.deleteFramebuffer($)}const L=ei(o),I=ei(x),C=w=>{const U=(w[0][0]-L[0])/s*r,M=-(w[0][1]-L[1])/s*r,z=(w[1][0]-L[0])/s*r,Z=-(w[1][1]-L[1])/s*r,$=(w[2][0]-L[0])/s*r,se=-(w[2][1]-L[1])/s*r;return{u1:z,v1:Z,u0:U,v0:M,u2:$,v2:se}};i.bindFramebuffer(i.FRAMEBUFFER,m),i.viewport(0,0,d,p);{const w=[],U=[],M=ci(i,Rf,Tf);i.useProgram(M);const z=i.getUniformLocation(M,"u_texture");i.bindTexture(i.TEXTURE_2D,T),i.uniform1i(z,0),a.getTriangles().forEach(function(oe,he,xe){const ce=oe.source,we=oe.target,{u1:Ne,v1:$e,u0:_t,v0:Po,u2:wo,v2:bo}=C(we),Lo=(ce[0][0]-I[0])/n/S,vo=-(ce[0][1]-I[1])/n/P,Ao=(ce[1][0]-I[0])/n/S,Co=-(ce[1][1]-I[1])/n/P,Io=(ce[2][0]-I[0])/n/S,Fo=-(ce[2][1]-I[1])/n/P;w.push(Ne,$e,_t,Po,wo,bo),U.push(Ao,Co,Lo,vo,Io,Fo)});const Z=ni(0,d,p,0,-1,1),$=i.getUniformLocation(M,"u_matrix");i.uniformMatrix4fv($,!1,Z);const se=i.getAttribLocation(M,"a_position"),B=i.createBuffer();i.bindBuffer(i.ARRAY_BUFFER,B),i.bufferData(i.ARRAY_BUFFER,new Float32Array(w),i.STATIC_DRAW),i.vertexAttribPointer(se,2,i.FLOAT,!1,0,0),i.enableVertexAttribArray(se);const le=i.getAttribLocation(M,"a_texcoord"),ne=i.createBuffer();i.bindBuffer(i.ARRAY_BUFFER,ne),i.bufferData(i.ARRAY_BUFFER,new Float32Array(U),i.STATIC_DRAW),i.vertexAttribPointer(le,2,i.FLOAT,!1,0,0),i.enableVertexAttribArray(le),i.drawArrays(i.TRIANGLES,0,w.length/2)}if(u){const w=ci(i,xf,yf);i.useProgram(w);const U=ni(0,d,p,0,-1,1),M=i.getUniformLocation(w,"u_matrix");i.uniformMatrix4fv(M,!1,U);const z=Array.isArray(u)?u:[0,0,0,255],Z=i.getUniformLocation(w,"u_val");i.uniform4fv(Z,z);const $=i.getAttribLocation(w,"a_position"),se=i.createBuffer();i.bindBuffer(i.ARRAY_BUFFER,se),i.vertexAttribPointer($,2,i.FLOAT,!1,0,0),i.enableVertexAttribArray($);const B=a.getTriangles().reduce(function(le,ne){const oe=ne.target,{u1:he,v1:xe,u0:ce,v0:we,u2:Ne,v2:$e}=C(oe);return le.concat([he,xe,ce,we,ce,we,Ne,$e,Ne,$e,he,xe])},[]);i.bufferData(i.ARRAY_BUFFER,new Float32Array(B),i.STATIC_DRAW),i.drawArrays(i.LINES,0,B.length/2)}return{width:d,height:p,framebuffer:m,texture:E}}class bf extends Ei{constructor(e){super({tileCoord:e.tileCoord,loader:()=>Promise.resolve(new Uint8ClampedArray(4)),interpolate:e.interpolate,transition:e.transition}),this.renderEdges_=e.renderEdges!==void 0?e.renderEdges:!1,this.pixelRatio_=e.pixelRatio,this.gutter_=e.gutter,this.reprojData_=null,this.reprojError_=null,this.reprojSize_=void 0,this.sourceTileGrid_=e.sourceTileGrid,this.targetTileGrid_=e.targetTileGrid,this.wrappedTileCoord_=e.wrappedTileCoord||e.tileCoord,this.sourceTiles_=[],this.sourcesListenerKeys_=null,this.sourceZ_=0;const t=e.sourceProj,r=t.getExtent(),n=e.sourceTileGrid.getExtent();this.clipExtent_=t.canWrapX()?n?Ue(r,n):r:n;const s=this.targetTileGrid_.getTileCoordExtent(this.wrappedTileCoord_),o=this.targetTileGrid_.getExtent();let a=this.sourceTileGrid_.getExtent();const l=o?Ue(s,o):s;if(on(l)===0){this.state=V.EMPTY;return}r&&(a?a=Ue(a,r):a=r);const c=this.targetTileGrid_.getResolution(this.wrappedTileCoord_[0]),h=e.targetProj,u=wa(t,h,l,c);if(!isFinite(u)||u<=0){this.state=V.EMPTY;return}const f=e.errorThreshold!==void 0?e.errorThreshold:ba;if(this.triangulation_=new La(t,h,l,a,u*f,c,e.transformMatrix),this.triangulation_.getTriangles().length===0){this.state=V.EMPTY;return}this.sourceZ_=this.sourceTileGrid_.getZForResolution(u);let g=this.triangulation_.calculateSourceExtent();if(a&&(t.canWrapX()?(g[1]=ue(g[1],a[1],a[3]),g[3]=ue(g[3],a[1],a[3])):g=Ue(g,a)),!on(g))this.state=V.EMPTY;else{let d=0,p=0;t.canWrapX()&&(d=Ee(r),p=Math.floor((g[0]-r[0])/d)),va(g.slice(),t,!0).forEach(E=>{const x=this.sourceTileGrid_.getTileRangeForExtentAndZ(E,this.sourceZ_),T=e.getTileFunction;for(let S=x.minX;S<=x.maxX;S++)for(let P=x.minY;P<=x.maxY;P++){const R=T(this.sourceZ_,S,P,this.pixelRatio_);if(R){const L=p*d;this.sourceTiles_.push({tile:R,offset:L})}}++p}),this.sourceTiles_.length===0&&(this.state=V.EMPTY)}}getSize(){return this.reprojSize_}getData(){return this.reprojData_}getError(){return this.reprojError_}reproject_(){const e=[];let t=!1;if(this.sourceTiles_.forEach(S=>{var he;const P=S.tile;if(!P||P.getState()!==V.LOADED)return;const R=P.getSize(),L=this.gutter_;let I;const C=qr(P.getData());C?I=C:(t=!0,I=Aa(Kr(P.getData())));const w=[R[0]+2*L,R[1]+2*L],U=I instanceof Float32Array,M=w[0]*w[1],z=U?Float32Array:Uint8ClampedArray,Z=new z(I.buffer),$=z.BYTES_PER_ELEMENT,se=$*Z.length/M,B=Z.byteLength/w[1],le=Math.floor(B/$/w[0]),ne=this.sourceTileGrid_.getTileCoordExtent(P.tileCoord);ne[0]+=S.offset,ne[2]+=S.offset;const oe=(he=this.clipExtent_)==null?void 0:he.slice();oe&&(oe[0]+=S.offset,oe[2]+=S.offset),e.push({extent:ne,clipExtent:oe,data:Z,dataType:z,bytesPerPixel:se,pixelSize:w,bandCount:le})}),this.sourceTiles_.length=0,e.length===0){this.state=V.ERROR,this.changed();return}const r=this.wrappedTileCoord_[0],n=this.targetTileGrid_.getTileSize(r),s=typeof n=="number"?n:n[0],o=typeof n=="number"?n:n[1],a=Math.round(s*this.pixelRatio_),l=Math.round(o*this.pixelRatio_),c=this.targetTileGrid_.getResolution(r),h=this.sourceTileGrid_.getResolution(this.sourceZ_),u=this.targetTileGrid_.getTileCoordExtent(this.wrappedTileCoord_),f=e[0].bandCount,g=new e[0].dataType(f*a*l),d=Sf(a,l,Kn,{premultipliedAlpha:!1,antialias:!1});let p;const m=d.RGBA;let E;e[0].dataType==Float32Array?(E=d.FLOAT,d.getExtension("WEBGL_color_buffer_float"),d.getExtension("OES_texture_float"),d.getExtension("EXT_float_blend"),p=d.getExtension("OES_texture_float_linear")!==null&&this.interpolate):(E=d.UNSIGNED_BYTE,p=this.interpolate);const x=4,T=Math.ceil(f/x);for(let S=T-1;S>=0;--S){const P=[];for(let z=0,Z=e.length;z<Z;++z){const $=e[z],se=$.pixelSize,B=se[0],le=se[1],ne=new $.dataType(x*B*le),oe=$.data;let he=S*x;for(let ce=0,we=ne.length;ce<we;ce+=x)ne[ce]=oe[he],ne[ce+1]=oe[he+1],ne[ce+2]=oe[he+2],ne[ce+3]=oe[he+3],he+=f;const xe=d.createTexture();d.bindTexture(d.TEXTURE_2D,xe),p?(d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MIN_FILTER,d.LINEAR),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MAG_FILTER,d.LINEAR)):(d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MIN_FILTER,d.NEAREST),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MAG_FILTER,d.NEAREST)),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_S,d.CLAMP_TO_EDGE),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_T,d.CLAMP_TO_EDGE),d.texImage2D(d.TEXTURE_2D,0,m,B,le,0,m,E,ne),P.push({extent:$.extent,clipExtent:$.clipExtent,texture:xe,width:B,height:le})}const{framebuffer:R,width:L,height:I}=wf(d,s,o,this.pixelRatio_,h,c,u,this.triangulation_,P,this.gutter_,E,this.renderEdges_,p),C=L,w=I*x,U=new e[0].dataType(C*w);d.bindFramebuffer(d.FRAMEBUFFER,R),d.readPixels(0,0,L,I,d.RGBA,E,U);let M=S*x;for(let z=0,Z=U.length;z<Z;z+=x){const $=(C-1-(z/w|0))*w+z%w;g[M]=U[$],g[M+1]=U[$+1],g[M+2]=U[$+2],g[M+3]=U[$+3],M+=f}}if(Pf(d),Kn.push(d.canvas),t){const S=nt(s,o),P=new ImageData(g,s);S.putImageData(P,0,0),this.reprojData_=S.canvas}else this.reprojData_=g;this.reprojSize_=[a,l],this.state=V.LOADED,this.changed()}load(){if(this.state!==V.IDLE&&this.state!==V.ERROR)return;this.state=V.LOADING,this.changed();let e=0;this.sourcesListenerKeys_=[],this.sourceTiles_.forEach(({tile:t})=>{const r=t.getState();if(r!==V.IDLE&&r!==V.LOADING)return;e++;const n=We(t,Te.CHANGE,()=>{const s=t.getState();(s==V.LOADED||s==V.ERROR||s==V.EMPTY)&&(Er(n),e--,e===0&&(this.unlistenSources_(),this.reproject_()))});this.sourcesListenerKeys_.push(n)}),e===0?setTimeout(this.reproject_.bind(this),0):this.sourceTiles_.forEach(function({tile:t}){t.getState()==V.IDLE&&t.load()})}unlistenSources_(){this.sourcesListenerKeys_.forEach(Er),this.sourcesListenerKeys_=null}}class rr extends Pi{constructor(e){const t=e.projection===void 0?"EPSG:3857":e.projection;let r=e.tileGrid;r===void 0&&t&&(r=qt({extent:Yt(t),maxResolution:e.maxResolution,maxZoom:e.maxZoom,minZoom:e.minZoom,tileSize:e.tileSize})),super({cacheSize:.1,attributions:e.attributions,attributionsCollapsible:e.attributionsCollapsible,projection:t,tileGrid:r,state:e.state,wrapX:e.wrapX,transition:e.transition,interpolate:e.interpolate,key:e.key,zDirection:e.zDirection}),this.gutter_=e.gutter!==void 0?e.gutter:0,this.tileSize_=e.tileSize?Fe(e.tileSize):null,this.tileSizes_=null,this.tileLoadingKeys_={},this.loader_=e.loader,this.handleTileChange_=this.handleTileChange_.bind(this),this.bandCount=e.bandCount===void 0?4:e.bandCount,this.tileGridForProjection_={},this.crossOrigin_=e.crossOrigin||"anonymous",this.transformMatrix=null}setTileSizes(e){this.tileSizes_=e}getTileSize(e){if(this.tileSizes_)return this.tileSizes_[e];if(this.tileSize_)return this.tileSize_;const t=this.getTileGrid();return t?Fe(t.getTileSize(e)):[256,256]}getGutterForProjection(e){const t=this.getProjection();return(!t||lr(t,e))&&!this.transformMatrix?this.gutter_:0}setLoader(e){this.loader_=e}getReprojTile_(e,t,r,n,s,o){const a=this.tileGrid||this.getTileGridForProjection(s||n),l=Math.max.apply(null,a.getResolutions().map((d,p)=>{const m=Fe(a.getTileSize(p)),E=this.getTileSize(p);return Math.max(E[0]/m[0],E[1]/m[1])})),c=this.getTileGridForProjection(n),h=[e,t,r],u=this.getTileCoordForTileUrlFunction(h,n),f=Object.assign({sourceProj:s||n,sourceTileGrid:a,targetProj:n,targetTileGrid:c,tileCoord:h,wrappedTileCoord:u,pixelRatio:l,gutter:this.gutter_,getTileFunction:(d,p,m,E)=>this.getTile(d,p,m,E,void 0,o),transformMatrix:this.transformMatrix},this.tileOptions),g=new bf(f);return g.key=this.getKey(),g}getTile(e,t,r,n,s,o){var R;const a=this.getProjection();if(s&&(a&&!lr(a,s)||this.transformMatrix))return this.getReprojTile_(e,t,r,s,a,o);const l=this.getTileSize(e),c=this.loader_,h=new AbortController,u={signal:h.signal,crossOrigin:this.crossOrigin_},f=this.getTileCoordForTileUrlFunction([e,t,r]);if(!f)return null;const g=this.getKey(),d=Ca(this,g,e,t,r);if(o&&o.containsKey(d))return o.get(d);const p=f[0],m=f[1],E=f[2],x=(R=this.getTileGrid())==null?void 0:R.getFullTileRange(p);x&&(u.maxY=x.getHeight()-1);function T(){return Na(function(){return c(p,m,E,u)})}const S=Object.assign({tileCoord:[e,t,r],loader:T,size:l,controller:h},this.tileOptions),P=new Ei(S);return P.key=this.getKey(),P.addEventListener(Te.CHANGE,this.handleTileChange_),o==null||o.set(d,P),P}handleTileChange_(e){const t=e.target,r=Q(t),n=t.getState();let s;n==V.LOADING?(this.tileLoadingKeys_[r]=!0,s=zr.TILELOADSTART):r in this.tileLoadingKeys_&&(delete this.tileLoadingKeys_[r],s=n==V.ERROR?zr.TILELOADERROR:n==V.LOADED?zr.TILELOADEND:void 0),s&&this.dispatchEvent(new Ia(s,t))}getTileGridForProjection(e){const t=this.getProjection();if(this.tileGrid&&(!t||lr(t,e))&&!this.transformMatrix)return this.tileGrid;const r=Q(e);return r in this.tileGridForProjection_||(this.tileGridForProjection_[r]=Fa(e)),this.tileGridForProjection_[r]}setTileGridForProjection(e,t){const r=K(e);if(r){const n=Q(r);n in this.tileGridForProjection_||(this.tileGridForProjection_[n]=t)}}}function Lf(i){return((i.fileDirectory.NewSubfileType||0)&4)===4}function vf(i,e){if(!i)return!1;if(i===!0)return!0;if(e.getSamplesPerPixel()!==3)return!1;const t=e.fileDirectory.PhotometricInterpretation,r=dl;return t===r.CMYK||t===r.YCbCr||t===r.CIELab||t===r.ICCLab}const Jn="STATISTICS_MAXIMUM",Qn="STATISTICS_MINIMUM",Zr=256;let Hr;function Af(){return Hr||(Hr=new hl),Hr}function Cf(i){try{return i.getBoundingBox(!0)}catch{return[0,0,i.getWidth(),i.getHeight()]}}function If(i){try{return i.getOrigin().slice(0,2)}catch{return[0,i.getHeight()]}}function Ff(i,e){try{return i.getResolution(e)}catch{return[e.getWidth()/i.getWidth(),e.getHeight()/i.getHeight()]}}function Nf(i){const e=i.geoKeys;if(!e)return null;if(e.ProjectedCSTypeGeoKey&&e.ProjectedCSTypeGeoKey!==32767){const t="EPSG:"+e.ProjectedCSTypeGeoKey;let r=K(t);if(!r){const n=an(e.ProjLinearUnitsGeoKey);n&&(r=new ln({code:t,units:n}))}return r}if(e.GeographicTypeGeoKey&&e.GeographicTypeGeoKey!==32767){const t="EPSG:"+e.GeographicTypeGeoKey;let r=K(t);if(!r){const n=an(e.GeogAngularUnitsGeoKey);n&&(r=new ln({code:t,units:n}))}return r}return null}function Mf(i){return i.getImageCount().then(function(e){const t=new Array(e);for(let r=0;r<e;++r)t[r]=i.getImage(r);return Promise.all(t)})}function Of(i,e){let t;return i.blob?t=ll(i.blob):i.overviews?t=cl(i.url,i.overviews,e):t=ul(i.url,e),t.then(Mf)}function Gt(i,e,t,r,n){if(Array.isArray(i)){const s=i.length;if(!Array.isArray(e)||s!=e.length){const o=new Error(r);throw n(o),o}for(let o=0;o<s;++o)Gt(i[o],e[o],t,r,n);return}if(e=e,Math.abs(i-e)>t*i)throw new Error(r)}function Df(i){return i instanceof Int8Array?-128:i instanceof Int16Array?-32768:i instanceof Int32Array?-2147483648:i instanceof Float32Array?12e-39:0}function Gf(i){return i instanceof Int8Array?127:i instanceof Uint8Array||i instanceof Uint8ClampedArray?255:i instanceof Int16Array?32767:i instanceof Uint16Array?65535:i instanceof Int32Array?2147483647:i instanceof Uint32Array?4294967295:i instanceof Float32Array?34e37:255}class fo extends rr{constructor(e){super({attributions:e.attributions,state:"loading",tileGrid:null,projection:e.projection||null,transition:e.transition,interpolate:e.interpolate!==!1,wrapX:e.wrapX}),this.sourceInfo_=e.sources;const t=this.sourceInfo_.length;this.sourceOptions_=e.sourceOptions,this.sourceImagery_=new Array(t),this.sourceMasks_=new Array(t),this.resolutionFactors_=new Array(t),this.samplesPerPixel_,this.nodataValues_,this.metadata_,this.normalize_=e.normalize!==!1,this.addAlpha_=!1,this.error_=null,this.convertToRGB_=e.convertToRGB||!1,this.setKey(this.sourceInfo_.map(s=>s.url).join(","));const r=this,n=new Array(t);for(let s=0;s<t;++s)n[s]=Of(this.sourceInfo_[s],this.sourceOptions_);Promise.all(n).then(function(s){r.configure_(s)}).catch(function(s){Wt(s),r.error_=s,r.setState("error")})}getError(){return this.error_}determineProjection(e){const t=e[0];for(let r=t.length-1;r>=0;--r){const n=t[r],s=Nf(n);if(s){this.projection=s;break}}}determineTransformMatrix(e){const t=e[0];for(let r=t.length-1;r>=0;--r){const s=t[r].fileDirectory.ModelTransformation;if(s){const[o,a,l,c,h,u,f,g]=s,d=zt(zt([1/Math.sqrt(o*o+h*h),0,0,-1/Math.sqrt(a*a+u*u),c,g],[o,h,a,u,0,0]),[1,0,0,1,-c,-g]);this.transformMatrix=d,this.addAlpha_=!0;break}}}configure_(e){let t,r,n,s,o;const a=new Array(e.length),l=new Array(e.length),c=new Array(e.length);let h=0;const u=e.length;for(let m=0;m<u;++m){const E=[],x=[];e[m].forEach(C=>{Lf(C)?x.push(C):E.push(C)});const T=E.length;if(x.length>0&&x.length!==T)throw new Error(`Expected one mask per image found ${x.length} masks and ${T} images`);let S,P;const R=new Array(T),L=new Array(T),I=new Array(T);l[m]=new Array(T),c[m]=new Array(T);for(let C=0;C<T;++C){const w=E[C],U=w.getGDALNoData();c[m][C]=w.getGDALMetadata(0),l[m][C]=U;const M=this.sourceInfo_[m].bands;a[m]=M?M.length:w.getSamplesPerPixel();const z=T-(C+1);S||(S=Cf(w)),P||(P=If(w));const Z=Ff(w,E[0]);I[z]=Z[0];const $=[w.getTileWidth(),w.getTileHeight()];$[0]!==$[1]&&$[1]<Zr&&($[0]=Zr,$[1]=Zr),R[z]=$;const se=Z[0]/Math.abs(Z[1]);L[z]=[$[0],$[1]/se]}if(t?Ue(t,S,t):t=S,!r)r=P;else{const C=`Origin mismatch for source ${m}, got [${P}] but expected [${r}]`;Gt(r,P,0,C,this.viewRejector)}if(!o)o=I,this.resolutionFactors_[m]=1;else{o.length-h>I.length&&(h=o.length-I.length);const C=o[o.length-1]/I[I.length-1];this.resolutionFactors_[m]=C;const w=I.map(M=>M*=C),U=`Resolution mismatch for source ${m}, got [${w}] but expected [${o}]`;Gt(o.slice(h,o.length),w,.02,U,this.viewRejector)}n?Gt(n.slice(h,n.length),L,.01,`Tile size mismatch for source ${m}`,this.viewRejector):n=L,s?Gt(s.slice(h,s.length),R,0,`Tile size mismatch for source ${m}`,this.viewRejector):s=R,this.sourceImagery_[m]=E.reverse(),this.sourceMasks_[m]=x.reverse()}for(let m=0,E=this.sourceImagery_.length;m<E;++m){const x=this.sourceImagery_[m];for(;x.length<o.length;)x.unshift(void 0)}this.getProjection()||this.determineProjection(e),this.determineTransformMatrix(e),this.samplesPerPixel_=a,this.nodataValues_=l,this.metadata_=c;e:for(let m=0;m<u;++m){if(this.sourceInfo_[m].nodata!==void 0){this.addAlpha_=!0;break}if(this.sourceMasks_[m].length){this.addAlpha_=!0;break}const E=l[m],x=this.sourceInfo_[m].bands;if(x){for(let T=0;T<x.length;++T)if(E[x[T]-1]!==null){this.addAlpha_=!0;break e}continue}for(let T=0;T<E.length;++T)if(E[T]!==null){this.addAlpha_=!0;break e}}let f=this.addAlpha_?1:0;for(let m=0;m<u;++m)f+=a[m];this.bandCount=f;const g=new wi({extent:t,minZoom:h,origin:r,resolutions:o,tileSizes:n});this.tileGrid=g,this.setTileSizes(s),this.setLoader(this.loadTile_.bind(this)),this.setState("ready");const d=1;o.length===2?o=[o[0],o[1],o[1]/2]:o.length===1&&(o=[o[0]*2,o[0],o[0]/2]);let p=t;if(this.transformMatrix){const m=jt(_e(),this.transformMatrix.slice()),E=Ma(x=>Ve(m,x));p=bt(t,E)}this.viewResolver({showFullExtent:!0,projection:this.projection,resolutions:o,center:Es(Ze(p),this.projection),extent:_s(p,this.projection),zoom:d})}loadTile_(e,t,r,n){const s=this.getTileSize(e),o=this.sourceImagery_.length,a=new Array(o*2),l=this.nodataValues_,c=this.sourceInfo_,h=Af();for(let u=0;u<o;++u){const f=c[u],g=this.resolutionFactors_[u],d=[Math.round(t*(s[0]*g)),Math.round(r*(s[1]*g)),Math.round((t+1)*(s[0]*g)),Math.round((r+1)*(s[1]*g))],p=this.sourceImagery_[u][e];let m;f.bands&&(m=f.bands.map(function(P){return P-1}));let E;"nodata"in f&&f.nodata!==null?E=f.nodata:m?E=m.map(function(P){return l[u][P]}):E=l[u];const x={window:d,width:s[0],height:s[1],samples:m,fillValue:E,pool:h,interleave:!1,signal:n.signal};vf(this.convertToRGB_,p)?a[u]=p.readRGB(x):a[u]=p.readRasters(x);const T=o+u,S=this.sourceMasks_[u][e];if(!S){a[T]=Promise.resolve(null);continue}a[T]=S.readRasters({window:d,width:s[0],height:s[1],samples:[0],pool:h,interleave:!1})}return Promise.all(a).then(this.composeTile_.bind(this,s)).catch(function(u){throw Wt(u),u})}composeTile_(e,t){const r=this.metadata_,n=this.sourceInfo_,s=this.sourceImagery_.length,o=this.bandCount,a=this.samplesPerPixel_,l=this.nodataValues_,c=this.normalize_,h=this.addAlpha_,u=e[0]*e[1],f=u*o;let g;c?g=new Uint8Array(f):g=new Float32Array(f);let d=0;for(let p=0;p<u;++p){let m=h;for(let E=0;E<s;++E){const x=n[E];let T=x.min,S=x.max,P,R;if(c){const L=r[E][0];T===void 0&&(L&&Qn in L?T=parseFloat(L[Qn]):T=Df(t[E][0])),S===void 0&&(L&&Jn in L?S=parseFloat(L[Jn]):S=Gf(t[E][0])),P=255/(S-T),R=-T*P}for(let L=0;L<a[E];++L){const I=t[E][L][p];let C;if(c?C=ue(P*I+R,0,255):C=I,!h)g[d]=C;else{let w=x.nodata;if(w===void 0){let M;x.bands?M=x.bands[L]-1:M=L,w=l[E][M]}const U=isNaN(w);(!U&&I!==w||U&&!isNaN(I))&&(m=!1,g[d]=C)}d++}if(!m){const L=s+E,I=t[L];I&&!I[0][p]&&(m=!0)}}h&&(m||(g[d]=255),d++)}return g}}fo.prototype.getView;function Ji(i,e,t,r){const n=document.createElement("script"),s="olc_"+Q(e);function o(){delete window[s],n.parentNode.removeChild(n)}n.async=!0,n.src=i+(i.includes("?")?"&":"?")+"callback="+s;const a=setTimeout(function(){o(),t&&t()},1e4);window[s]=function(l){clearTimeout(a),o(),e(l)},document.head.appendChild(n)}class Uf extends Error{constructor(e){const t="Unexpected response status: "+e.status;super(t),this.name="ResponseError",this.response=e}}class Bf extends Error{constructor(e){super("Failed to issue request"),this.name="ClientError",this.client=e}}function go(i){return new Promise(function(e,t){function r(o){const a=o.target;if(!a.status||a.status>=200&&a.status<300){let l;try{l=JSON.parse(a.responseText)}catch(c){const h="Error parsing response text as JSON: "+c.message;t(new Error(h));return}e(l);return}t(new Uf(a))}function n(o){t(new Bf(o.target))}const s=new XMLHttpRequest;s.addEventListener("load",r),s.addEventListener("error",n),s.open("GET",i),s.setRequestHeader("Accept","application/json"),s.send()})}function po(i,e){return e.includes("://")?e:new URL(e,i).href}const zf={"image/png":!0,"image/jpeg":!0,"image/gif":!0,"image/webp":!0},$f={"application/vnd.mapbox-vector-tile":!0,"application/geo+json":!0};function mo(i,e){if(!e.length)return i;const t=new URL(i,"file:/");if(t.pathname.split("/").includes("collections"))return Wt('The "collections" query parameter cannot be added to collection endpoints'),i;const r=e.map(o=>encodeURIComponent(o)).join(",");t.searchParams.append("collections",r);const n=i.split("?")[0],s=decodeURIComponent(t.searchParams.toString());return`${n}?${s}`}function Xf(i,e,t){let r,n;for(let s=0;s<i.length;++s){const o=i[s];if(o.rel==="item"){if(o.type===e){r=o.href;break}(zf[o.type]||!n&&o.type.startsWith("image/"))&&(n=o.href)}}if(!r)if(n)r=n;else throw new Error('Could not find "item" link');return t&&(r=mo(r,t)),r}function kf(i,e,t,r){let n,s;const o={};for(let a=0;a<i.length;++a){const l=i[a];if(o[l.type]=l.href,l.rel==="item"){if(l.type===e){n=l.href;break}$f[l.type]&&(s=l.href)}}if(!n&&t)for(let a=0;a<t.length;++a){const l=t[a];if(o[l]){n=o[l];break}}if(!n)if(s)n=s;else throw new Error('Could not find "item" link');return r&&(n=mo(n,r)),n}function ui(i,e,t,r){let n=i.projection;if(!n&&(typeof e.crs=="string"?n=K(e.crs):"uri"in e.crs&&(n=K(e.crs.uri)),!n))throw new Error(`Unsupported CRS: ${JSON.stringify(e.crs)}`);const s=e.orderedAxes,a=!(s?s.slice(0,2).map(R=>R.replace(/E|X|Lon/i,"e").replace(/N|Y|Lat/i,"n")).join(""):n.getAxisOrientation()).startsWith("en"),l=e.tileMatrices.sort(function(R,L){return L.cellSize-R.cellSize}),c={};for(let R=0;R<l.length;++R){const L=l[R];c[L.id]=L}const h={},u=[];if(r)for(let R=0;R<r.length;++R){const L=r[R],I=L.tileMatrix,C=c[I],w=l.indexOf(C);u[w]=I,h[I]=L}else for(let R=0;R<l.length;++R){const L=l[R].id;u.push(L)}const f=u.length,g=new Array(f),d=new Array(f),p=new Array(f),m=new Array(f),E=[-1/0,-1/0,1/0,1/0];for(let R=0;R<f;++R){const L=u[R],I=c[L],C=I.pointOfOrigin;a?g[R]=[C[1],C[0]]:g[R]=C,d[R]=I.cellSize,p[R]=[I.matrixWidth,I.matrixHeight],m[R]=[I.tileWidth,I.tileHeight];const w=h[L];if(w){const U=I.cellSize*I.tileWidth,M=g[R][0]+w.minTileCol*U,z=g[R][0]+(w.maxTileCol+1)*U,Z=I.cellSize*I.tileHeight,$=I.cornerOfOrigin==="bottomLeft";let se,B;$?(se=g[R][1]+w.minTileRow*Z,B=g[R][1]+(w.maxTileRow+1)*Z):(se=g[R][1]-(w.maxTileRow+1)*Z,B=g[R][1]-w.minTileRow*Z),Ue(E,[M,se,z,B],E)}}const x=new bi({origins:g,resolutions:d,sizes:p,tileSizes:m,extent:r?E:void 0,matrixIds:u});if(!t)return{grid:x,projection:n};const T=i.context,S=i.url;function P(R,L,I){if(!R)return;const C=u[R[0]],w=c[C],U=w.cornerOfOrigin==="bottomLeft",M={tileMatrix:C,tileCol:R[1],tileRow:U?-R[2]-1:R[2]};if(r){const Z=h[w.id];if(M.tileCol<Z.minTileCol||M.tileCol>Z.maxTileCol||M.tileRow<Z.minTileRow||M.tileRow>Z.maxTileRow)return}Object.assign(M,{z:M.tileMatrix,x:M.tileCol,y:M.tileRow},T);const z=t.replace(/\{(\w+?)\}/g,function(Z,$){return M[$]});return po(S,z)}return{grid:x,projection:n,urlTemplate:t,urlFunction:P}}function jf(i,e){const t=e.tileMatrixSetLimits;let r;if(e.dataType==="map")r=Xf(e.links,i.mediaType,i.collections);else if(e.dataType==="vector")r=kf(e.links,i.mediaType,i.supportedMediaTypes,i.collections);else throw new Error('Expected tileset data type to be "map" or "vector"');if(e.tileMatrixSet)return ui(i,e.tileMatrixSet,r,t);const n=e.links.find(a=>a.rel==="http://www.opengis.net/def/rel/ogc/1.0/tiling-scheme");if(!n)throw new Error("Expected http://www.opengis.net/def/rel/ogc/1.0/tiling-scheme link or tileMatrixSet");const s=n.href,o=po(i.url,s);return go(o).then(function(a){return ui(i,a,r,t)})}function _o(i){return go(i.url).then(function(e){return jf(i,e)})}const Wf=["d35379db-88df-4056-af3a-620245f8e347","f17cb550-5864-4468-aeb7-f3180cfb622f","689b58e2-cf7b-45e0-9fff-9cfc0883d6b4"];class Zf extends rr{constructor(e){super({state:"loading",tileGrid:null,projection:e.projection||null,transition:e.transition,wrapX:e.wrapX}),this.url_=e.url,this.group_=e.group,this.error_=null,this.root_=null,this.consolidatedMetadata_=null,this.bands_=e.bands,this.bandsByLevel_=null,this.fillValue_,this.resampleMethod_=e.resample||"linear",this.setLoader(this.loadTile_.bind(this)),this.tileGrid,this.configure_().then(()=>{this.setState("ready")}).catch(t=>{this.error_=t,this.setState("error")})}async configure_(){const e=new pl(this.url_);this.root_=await $r(e,{kind:"group"});try{this.consolidatedMetadata_=JSON.parse(new TextDecoder().decode(await e.get(this.root_.resolve("zarr.json").path))).consolidated_metadata.metadata}catch{}const r=(await $r(this.root_.resolve(this.group_),{kind:"group"})).attrs;if("zarr_conventions"in r&&Array.isArray(r.zarr_conventions)&&Wf.every(s=>r.zarr_conventions.find(o=>o.uuid===s))&&"layout"in r.multiscales){const{tileGrid:s,projection:o,bandsByLevel:a,fillValue:l}=Hf(r,this.consolidatedMetadata_,this.group_,this.bands_);this.bandsByLevel_=a,this.tileGrid=s,this.projection=o,this.fillValue_=l}else if("tile_matrix_set"in r.multiscales){const{tileGrid:s,projection:o}=Vf(r);this.tileGrid=s,this.projection=o}const n=this.tileGrid.getExtent();setTimeout(()=>{this.viewResolver({showFullExtent:!0,projection:this.projection,resolutions:this.tileGrid.getResolutions(),center:Es(Ze(n),this.projection),extent:_s(n,this.projection),zoom:1})})}async loadTile_(e,t,r,n){const s=this.tileGrid.getResolutions(),o=this.tileGrid.getResolution(e),a=this.tileGrid.getTileCoordExtent([e,t,r]),l=[],c=[];for(const g of this.bands_){let d,p,m=0;if(!this.bandsByLevel_)d=this.tileGrid.getMatrixId(e),p=o,m=e;else for(let I=0;I<s.length;I+=1){const C=s[I];if(d&&C<o)break;const w=this.tileGrid.getMatrixId(I);this.bandsByLevel_[w].includes(g)&&(d=w,p=this.tileGrid.getResolution(I),m=I)}if(!d||!p)throw new Error(`Could not find available resolution for band ${g}`);const E=this.tileGrid.getOrigin(m),x=Math.round((a[0]-E[0])/p),T=Math.round((a[2]-E[0])/p),S=Math.round((E[1]-a[3])/p),P=Math.round((E[1]-a[1])/p),R=`${this.group_}/${d}/${g}`,L=await $r(this.root_.resolve(R),{kind:"array"});l.push(ml(L,[dn(S,P),dn(x,T)])),c.push(p)}const h=await Promise.all(l),[u,f]=Fe(this.tileGrid.getTileSize(e));return Yf(h,c,u,f,o,this.resampleMethod_,this.fillValue_||0)}}function Hf(i,e,t,r){const n=i.multiscales,s=i["spatial:bbox"],o=K(i["proj:code"]),a=[],l=e?{}:null;let c;for(const u of n.layout){const f=u["spatial:transform"],g=f[0],d=[f[2],f[5]],p=u.asset;if(a.push({matrixId:p,resolution:g,origin:d}),e){const m=[];for(const E of r){const x=e[`${t}/${p}/${E}`];x&&(m.push(E),c===void 0&&(c=x.fill_value))}l[p]=m}}return a.sort((u,f)=>f.resolution-u.resolution),{tileGrid:new bi({extent:s,origins:a.map(u=>u.origin),resolutions:a.map(u=>u.resolution),matrixIds:a.map(u=>u.matrixId)}),projection:o,bandsByLevel:l,fillValue:c}}function Vf(i){const e=i.multiscales,t=e.tile_matrix_set,r=e.tile_matrix_limits,n=t.tileMatrices.length,s=new Array(n);let o=!1;for(let c=0;c<n;c+=1){const h=t.tileMatrices[c],u=h.id;(h.tileWidth>512||h.tileHeight>512)&&(o=!0),s[c]=r[u]}const a=ui({},t,void 0,s);let l=a.grid;return o&&(l=new bi({tileSize:512,extent:l.getExtent(),origins:l.getOrigins(),resolutions:l.getResolutions(),matrixIds:l.getMatrixIds()})),{tileGrid:l,projection:a.projection}}function Yf(i,e,t,r,n,s,o){const a=i.length,l=new Float32Array(t*r*a);for(let c=0;c<r;c++)for(let h=0;h<t;h++)for(let u=0;u<a;++u){const f=i[u],g=f.shape[0],d=f.shape[1],p=n/e[u];let m=o;if(p===1)c<g&&h<d&&(m=f.data[c*d+h]);else{const E=c*p,x=h*p;switch(s){case"nearest":{const T=Math.round(E),S=Math.round(x);T<g&&S<d&&(m=f.data[T*d+S]);break}default:throw new Error(`Unsupported resample method: ${s}`)}}isNaN(m)&&(m=o),l[a*(c*t+h)+u]=m}return l}const qf=22;class Kf extends qe{constructor(e){const t=!!e.highDpi;super({attributionsCollapsible:e.attributionsCollapsible,cacheSize:e.cacheSize,crossOrigin:"anonymous",interpolate:e.interpolate,projection:"EPSG:3857",reprojectionErrorThreshold:e.reprojectionErrorThreshold,state:"loading",tileLoadFunction:e.tileLoadFunction,tilePixelRatio:t?2:1,wrapX:e.wrapX!==void 0?e.wrapX:!0,transition:e.transition,zDirection:e.zDirection}),this.apiKey_=e.key,this.error_=null;const r={mapType:e.mapType||"roadmap",language:e.language||"en-US",region:e.region||"US"};e.imageFormat&&(r.imageFormat=e.imageFormat),e.scale&&(r.scale=e.scale),t&&(r.highDpi=!0),e.layerTypes&&(r.layerTypes=e.layerTypes),e.styles&&(r.styles=e.styles),e.overlay===!0&&(r.overlay=!0),e.apiOptions&&(r.apiOptions=e.apiOptions),this.sessionTokenRequest_=r,this.sessionTokenValue_,this.sessionRefreshId_,this.previousViewportAttribution_,this.previousViewportExtent_;const n=e.url||"https://tile.googleapis.com/";this.createSessionUrl_=n+"v1/createSession",this.tileUrl_=n+"v1/2dtiles",this.attributionUrl_=n+"tile/v1/viewport",this.createSession_()}getError(){return this.error_}fetchSessionToken(e,t){return fetch(e,t)}async createSession_(){const e=this.createSessionUrl_+"?key="+this.apiKey_,t={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(this.sessionTokenRequest_)},r=await this.fetchSessionToken(e,t);if(!r.ok){try{const f=await r.json();this.error_=new Error(f.error.message)}catch{this.error_=new Error("Error fetching session token")}this.setState("error");return}const n=await r.json(),s=this.getTilePixelRatio(1),o=[n.tileWidth/s,n.tileHeight/s];this.tileGrid=qt({extent:Yt(this.getProjection()),maxZoom:qf,tileSize:o});const a=n.session;this.sessionTokenValue_=a;const l=this.apiKey_,c=this.tileUrl_;this.tileUrlFunction=function(f,g,d){const p=f[0],m=f[1],E=f[2];return`${c}/${p}/${m}/${E}?session=${a}&key=${l}`};const h=parseInt(n.expiry,10)*1e3,u=Math.max(h-Date.now()-60*1e3,1);this.sessionRefreshId_=setTimeout(()=>this.createSession_(),u),this.setAttributions(this.fetchAttributions_.bind(this)),this.setState("ready")}async fetchAttributions_(e){if(e.viewHints[st.ANIMATING]||e.viewHints[st.INTERACTING]||e.animate)return this.previousViewportAttribution_;const[t,r]=cn(Oa(e.extent),e.viewState.projection),[n,s]=cn(Da(e.extent),e.viewState.projection),l=`zoom=${this.getTileGrid().getZForResolution(e.viewState.resolution,this.zDirection)}&north=${s}&south=${r}&east=${n}&west=${t}`;if(this.previousViewportExtent_==l)return this.previousViewportAttribution_;this.previousViewportExtent_=l;const c=this.sessionTokenValue_,h=this.apiKey_,f=`${this.attributionUrl_}?session=${c}&key=${h}&${l}`;return this.previousViewportAttribution_=await fetch(f).then(g=>g.json()).then(g=>g.copyright),this.previousViewportAttribution_}disposeInternal(){clearTimeout(this.sessionRefreshId_),super.disposeInternal()}}let Eo=class extends _i{constructor(e,t,r,n,s,o,a){super(t,r,n,s,o,a),this.zoomifyImage_=null,this.tileSize_=e}getImage(){if(this.zoomifyImage_)return this.zoomifyImage_;const e=super.getImage();if(this.state==V.LOADED){const t=this.tileSize_;if(e.width==t[0]&&e.height==t[1])return this.zoomifyImage_=e,e;const r=nt(t[0],t[1]);return r.drawImage(e,0,0),this.zoomifyImage_=r.canvas,r.canvas}return e}};class Jf extends qe{constructor(e){const t=e.size,r=e.tierSizeCalculation!==void 0?e.tierSizeCalculation:"default",n=e.tilePixelRatio||1,s=t[0],o=t[1],a=[],l=e.tileSize||ti;let c=l*n;switch(r){case"default":for(;s>c||o>c;)a.push([Math.ceil(s/c),Math.ceil(o/c)]),c+=c;break;case"truncated":let R=s,L=o;for(;R>c||L>c;)a.push([Math.ceil(R/c),Math.ceil(L/c)]),R>>=1,L>>=1;break;default:throw new Error("Unknown `tierSizeCalculation` configured")}a.push([1,1]),a.reverse();const h=[n],u=[0];for(let R=1,L=a.length;R<L;R++)h.push(n<<R),u.push(a[R-1][0]*a[R-1][1]+u[R-1]);h.reverse();const f=new wi({tileSize:l,extent:e.extent||[0,-o,s,0],resolutions:h});let g=e.url;g&&!g.includes("{TileGroup}")&&!g.includes("{tileIndex}")&&(g+="{TileGroup}/{z}-{x}-{y}.jpg");const d=ys(g);let p=l*n;function m(R){return function(L,I,C){if(!L)return;const w=L[0],U=L[1],M=L[2],z=U+M*a[w][0],Z=(z+u[w])/p|0,$={z:w,x:U,y:M,tileIndex:z,TileGroup:"TileGroup"+Z};return R.replace(/\{(\w+?)\}/g,function(se,B){return $[B]})}}const E=Ri(d.map(m)),x=Eo.bind(null,Fe(l*n));super({attributions:e.attributions,cacheSize:e.cacheSize,crossOrigin:e.crossOrigin,interpolate:e.interpolate,projection:e.projection,tilePixelRatio:n,reprojectionErrorThreshold:e.reprojectionErrorThreshold,tileClass:x,tileGrid:f,tileUrlFunction:E,transition:e.transition}),this.zDirection=e.zDirection;const T=f.getTileCoordForCoordAndResolution(Ze(f.getExtent()),h[h.length-1]),S=E(T,1,null),P=new Image;P.addEventListener("error",()=>{p=l,this.changed()}),P.src=S}}function Dt(i){return i.toLocaleString("en",{maximumFractionDigits:10})}class Qf extends qe{constructor(e){const t=e||{};let r=t.url||"";r=r+(r.lastIndexOf("/")===r.length-1||r===""?"":"/");const n=t.version||ge.VERSION2,s=t.sizes||[],o=t.size;ve(o!=null&&Array.isArray(o)&&o.length==2&&!isNaN(o[0])&&o[0]>0&&!isNaN(o[1])&&o[1]>0,"Missing or invalid `size`");const a=o[0],l=o[1],c=t.tileSize,h=t.tilePixelRatio||1,u=t.format||"jpg",f=t.quality||(t.version==ge.VERSION1?"native":"default");let g=t.resolutions||[];const d=t.supports||[],p=t.extent||[0,-l,a,0],m=s!=null&&Array.isArray(s)&&s.length>0,E=c!==void 0&&(typeof c=="number"&&Number.isInteger(c)&&c>0||Array.isArray(c)&&c.length>0),x=d!=null&&Array.isArray(d)&&(d.includes("regionByPx")||d.includes("regionByPct"))&&(d.includes("sizeByWh")||d.includes("sizeByH")||d.includes("sizeByW")||d.includes("sizeByPct"));let T,S,P;if(g.sort(function(C,w){return w-C}),E||x)if(c!=null&&(typeof c=="number"&&Number.isInteger(c)&&c>0?(T=c,S=c):Array.isArray(c)&&c.length>0&&((c.length==1||c[1]==null&&Number.isInteger(c[0]))&&(T=c[0],S=c[0]),c.length==2&&(Number.isInteger(c[0])&&Number.isInteger(c[1])?(T=c[0],S=c[1]):c[0]==null&&Number.isInteger(c[1])&&(T=c[1],S=c[1])))),(T===void 0||S===void 0)&&(T=ti,S=ti),g.length==0){P=Math.max(Math.ceil(Math.log(a/T)/Math.LN2),Math.ceil(Math.log(l/S)/Math.LN2));for(let C=P;C>=0;C--)g.push(Math.pow(2,C))}else{const C=Math.max(...g);P=Math.round(Math.log(C)/Math.LN2)}else if(T=a,S=l,g=[],m){s.sort(function(w,U){return w[0]-U[0]}),P=-1;const C=[];for(let w=0;w<s.length;w++){const U=a/s[w][0];if(g.length>0&&g[g.length-1]==U){C.push(w);continue}g.push(U),P++}if(C.length>0)for(let w=0;w<C.length;w++)s.splice(C[w]-w,1)}else g.push(1),s.push([a,l]),P=0;const R=new wi({tileSize:[T,S],extent:p,origin:ei(p),resolutions:g}),L=function(C,w,U){let M,z;const Z=C[0];if(Z>P)return;const $=C[1],se=C[2],B=g[Z];if(!($===void 0||se===void 0||B===void 0||$<0||Math.ceil(a/B/T)<=$||se<0||Math.ceil(l/B/S)<=se)){if(x||E){const le=$*T*B,ne=se*S*B;let oe=T*B,he=S*B,xe=T,ce=S;if(le+oe>a&&(oe=a-le),ne+he>l&&(he=l-ne),le+T*B>a&&(xe=Math.floor((a-le+B-1)/B)),ne+S*B>l&&(ce=Math.floor((l-ne+B-1)/B)),le==0&&oe==a&&ne==0&&he==l)M="full";else if(!x||d.includes("regionByPx"))M=le+","+ne+","+oe+","+he;else if(d.includes("regionByPct")){const we=Dt(le/a*100),Ne=Dt(ne/l*100),$e=Dt(oe/a*100),_t=Dt(he/l*100);M="pct:"+we+","+Ne+","+$e+","+_t}n==ge.VERSION3&&(!x||d.includes("sizeByWh"))?z=xe+","+ce:!x||d.includes("sizeByW")?z=xe+",":d.includes("sizeByH")?z=","+ce:d.includes("sizeByWh")?z=xe+","+ce:d.includes("sizeByPct")&&(z="pct:"+Dt(100/B))}else if(M="full",m){const le=s[Z][0],ne=s[Z][1];n==ge.VERSION3?le==a&&ne==l?z="max":z=le+","+ne:le==a?z="full":z=le+","}else z=n==ge.VERSION3?"max":"full";return r+M+"/"+z+"/0/"+f+"."+u}},I=Eo.bind(null,Fe(c||256).map(function(C){return C*h}));super({attributions:t.attributions,attributionsCollapsible:t.attributionsCollapsible,cacheSize:t.cacheSize,crossOrigin:t.crossOrigin,interpolate:t.interpolate,projection:t.projection,reprojectionErrorThreshold:t.reprojectionErrorThreshold,state:t.state,tileClass:I,tileGrid:R,tilePixelRatio:t.tilePixelRatio,tileUrlFunction:L,transition:t.transition}),this.zDirection=t.zDirection}}function yo(i,e,t,r,n,s){const o=n.getCode().split(/:(?=\d+$)/).pop(),a=t/r,l=[un(Ee(e)/a,hn),un(Me(e)/a,hn)];s.SIZE=l[0]+","+l[1],s.BBOX=e.join(","),s.BBOXSR=o,s.IMAGESR=o,s.DPI=Math.round(s.DPI?s.DPI*r:90*r);const c=i.replace(/MapServer\/?$/,"MapServer/export").replace(/ImageServer\/?$/,"ImageServer/exportImage");return yr(c,s)}function eg(i){const e=i.load?i.load:Ct,t=K(i.projection||"EPSG:3857"),r=i.ratio??1.5,n=i.crossOrigin??null;return function(s,o,a){a=i.hidpi?a:1;const l={F:"image",FORMAT:"PNG32",TRANSPARENT:!0};Object.assign(l,i.params),s=xs(s,o,a,r);const c=yo(i.url,s,o,a,t,l),h=new Image;return h.crossOrigin=n,e(h,c).then(u=>{const f=Ee(s)/u.width*a;return{image:u,extent:s,resolution:f,pixelRatio:a}})}}class tg extends pt{constructor(e){e=e||{},super({attributions:e.attributions,interpolate:e.interpolate,projection:e.projection,resolutions:e.resolutions}),this.crossOrigin_=e.crossOrigin!==void 0?e.crossOrigin:null,this.hidpi_=e.hidpi!==void 0?e.hidpi:!0,this.url_=e.url,this.imageLoadFunction_=e.imageLoadFunction!==void 0?e.imageLoadFunction:Li,this.params_=Object.assign({},e.params),this.imageSize_=[0,0],this.renderedRevision_=0,this.ratio_=e.ratio!==void 0?e.ratio:1.5,this.loaderProjection_=null}getParams(){return this.params_}getImageInternal(e,t,r,n){return this.url_===void 0?null:((!this.loader||this.loaderProjection_!==n)&&(this.loaderProjection_=n,this.loader=eg({crossOrigin:this.crossOrigin_,params:this.params_,projection:n,hidpi:this.hidpi_,url:this.url_,ratio:this.ratio_,load:(s,o)=>(this.image.setImage(s),this.imageLoadFunction_(this.image,o),Ct(s))})),super.getImageInternal(e,t,r,n))}getImageLoadFunction(){return this.imageLoadFunction_}getUrl(){return this.url_}setImageLoadFunction(e){this.imageLoadFunction_=e,this.changed()}setUrl(e){e!=this.url_&&(this.url_=e,this.loader=null,this.changed())}setParams(e){this.params_=Object.assign({},e),this.changed()}updateParams(e){Object.assign(this.params_,e),this.changed()}changed(){this.image=null,super.changed()}}class rg extends pt{constructor(e){e=e||{},super({attributions:e.attributions,interpolate:e.interpolate,projection:e.projection,resolutions:e.resolutions,state:e.state}),this.canvasFunction_=e.canvasFunction,this.canvas_=null,this.renderedRevision_=0,this.ratio_=e.ratio!==void 0?e.ratio:1.5}getImageInternal(e,t,r,n){t=this.findNearestResolution(t);let s=this.canvas_;if(s&&this.renderedRevision_==this.getRevision()&&s.getResolution()==t&&s.getPixelRatio()==r&&hr(s.getExtent(),e))return s;e=e.slice(),ps(e,this.ratio_);const o=Ee(e)/t,a=Me(e)/t,l=[o*r,a*r],c=this.canvasFunction_.call(this,e,t,r,l,n);return c&&(s=new Ki(e,t,r,c)),this.canvas_=s,this.renderedRevision_=this.getRevision(),s}}function ig(i,e,t,r){const n=Ee(i),s=Me(i),o=e[0],a=e[1],l=.0254/r;return a*n>o*s?n*t/(o*l):s*t/(a*l)}function ng(i,e,t,r,n,s,o){const a=ig(t,r,s,o),l=Ze(t),c={OPERATION:n?"GETDYNAMICMAPOVERLAYIMAGE":"GETMAPIMAGE",VERSION:"2.0.0",LOCALE:"en",CLIENTAGENT:"ol/source/ImageMapGuide source",CLIP:"1",SETDISPLAYDPI:o,SETDISPLAYWIDTH:Math.round(r[0]),SETDISPLAYHEIGHT:Math.round(r[1]),SETVIEWSCALE:a,SETVIEWCENTERX:l[0],SETVIEWCENTERY:l[1]};return Object.assign(c,e),yr(i,c)}function sg(i){const e=i.load||Ct,t=i.useOverlay??!1,r=i.metersPerUnit||1,n=i.displayDpi||96,s=i.ratio??1,o=i.crossOrigin??null;return function(a,l,c){const h=new Image;h.crossOrigin=o,a=xs(a,l,c,s);const u=Ee(a)/l,f=Me(a)/l,g=[u*c,f*c],d=ng(i.url,i.params,a,g,t,r,n);return e(h,d).then(p=>({image:p,extent:a,pixelRatio:c}))}}class og extends pt{constructor(e){super({interpolate:e.interpolate,projection:e.projection,resolutions:e.resolutions}),this.crossOrigin_=e.crossOrigin!==void 0?e.crossOrigin:null,this.displayDpi_=e.displayDpi!==void 0?e.displayDpi:96,this.params_=Object.assign({},e.params),this.url_=e.url,this.imageLoadFunction_=e.imageLoadFunction!==void 0?e.imageLoadFunction:Li,this.hidpi_=e.hidpi!==void 0?e.hidpi:!0,this.metersPerUnit_=e.metersPerUnit!==void 0?e.metersPerUnit:1,this.ratio_=e.ratio!==void 0?e.ratio:1,this.useOverlay_=e.useOverlay!==void 0?e.useOverlay:!1,this.renderedRevision_=0,this.loaderProjection_=null}getParams(){return this.params_}getImageInternal(e,t,r,n){return this.url_===void 0?null:((!this.loader||this.loaderProjection_!==n)&&(this.loaderProjection_=n,this.loader=sg({crossOrigin:this.crossOrigin_,params:this.params_,hidpi:this.hidpi_,metersPerUnit:this.metersPerUnit_,url:this.url_,useOverlay:this.useOverlay_,ratio:this.ratio_,load:(s,o)=>(this.image.setImage(s),this.imageLoadFunction_(this.image,o),Ct(s))})),super.getImageInternal(e,t,r,n))}getImageLoadFunction(){return this.imageLoadFunction_}setParams(e){this.params_=Object.assign({},e),this.changed()}updateParams(e){Object.assign(this.params_,e),this.changed()}setImageLoadFunction(e){this.imageLoadFunction_=e,this.changed()}changed(){this.image=null,super.changed()}}function ag(i){const e=i.load||Ct,t=i.imageExtent,r=i.crossOrigin??null;return()=>{const n=new Image;return n.crossOrigin=r,e(n,i.url).then(s=>{const o=Ee(t)/s.width,a=Me(t)/s.height;return{image:s,extent:t,resolution:o!==a?[o,a]:a,pixelRatio:1}})}}class lg extends pt{constructor(e){const t=e.crossOrigin!==void 0?e.crossOrigin:null,r=e.imageLoadFunction!==void 0?e.imageLoadFunction:Li;super({attributions:e.attributions,interpolate:e.interpolate,projection:K(e.projection)}),this.url_=e.url,this.imageExtent_=e.imageExtent,this.image=null,this.image=new gs(this.imageExtent_,void 0,1,ag({url:e.url,imageExtent:e.imageExtent,crossOrigin:t,load:(n,s)=>(this.image.setImage(n),r(this.image,s),Ct(n))})),this.image.addEventListener(Te.CHANGE,this.handleImageChange.bind(this))}getImageExtent(){return this.imageExtent_}getImageInternal(e,t,r,n){return wt(e,this.image.getExtent())?this.image:null}getUrl(){return this.url_}}const cg=new Error("Image failed to load");function xo(i,e,t,r,n){return new Promise((s,o)=>{const a=new Image;a.crossOrigin=n.crossOrigin??null,a.addEventListener("load",()=>s(a)),a.addEventListener("error",()=>o(cg)),a.src=Ts(i,e,t,r,n.maxY)})}function es(i){return function(e,t,r,n){const s=Ga(i,e,t,r);return xo(s,e,t,r,n)}}function ug(i){return function(e,t,r,n){const s=i(e,t,r,n);return xo(s,e,t,r,n)}}function ts(i){let e;if(Array.isArray(i))e=es(i);else if(typeof i=="string"){const t=ys(i);e=es(t)}else if(typeof i=="function")e=ug(i);else throw new Error("The url option must be a single template, an array of templates, or a function for getting a URL");return e}let rs=0;function is(i){return Array.isArray(i)?i.join(`
`):typeof i=="string"?i:(++rs,"url-function-key-"+rs)}class To extends rr{constructor(e){e=e||{};let t=e.loader,r;e.url&&(t=ts(e.url),r=is(e.url));const n=t?e.state:"loading",s=e.wrapX===void 0?!0:e.wrapX;super({loader:t,key:r,attributions:e.attributions,attributionsCollapsible:e.attributionsCollapsible,maxZoom:e.maxZoom,minZoom:e.minZoom,tileSize:e.tileSize,gutter:e.gutter,maxResolution:e.maxResolution,projection:e.projection,tileGrid:e.tileGrid,state:n,wrapX:s,transition:e.transition,interpolate:e.interpolate!==!1,crossOrigin:e.crossOrigin,zDirection:e.zDirection})}setUrl(e){const t=ts(e);this.setLoader(t),this.setKey(is(e)),this.getState()!=="ready"&&this.setState("ready")}}class hg extends qe{constructor(e){super({attributions:e.attributions,cacheSize:e.cacheSize,crossOrigin:e.crossOrigin,interpolate:e.interpolate,projection:e.projection,reprojectionErrorThreshold:e.reprojectionErrorThreshold,state:"loading",tileLoadFunction:e.tileLoadFunction,wrapX:e.wrapX!==void 0?e.wrapX:!0,transition:e.transition});const t={url:e.url,projection:this.getProjection(),mediaType:e.mediaType,context:e.context||null,collections:e.collections};_o(t).then(this.handleTileSetInfo_.bind(this)).catch(this.handleError_.bind(this))}handleTileSetInfo_(e){this.tileGrid=e.grid,this.projection=e.projection,this.setTileUrlFunction(e.urlFunction,e.urlTemplate),this.setState("ready")}handleError_(e){Wt(e),this.setState("error")}}class dg extends Ua{constructor(e){super({attributions:e.attributions,attributionsCollapsible:e.attributionsCollapsible,cacheSize:e.cacheSize,format:e.format,overlaps:e.overlaps,projection:e.projection,tileClass:e.tileClass,transition:e.transition,wrapX:e.wrapX,zDirection:e.zDirection,state:"loading"});const t={url:e.url,projection:this.getProjection(),mediaType:e.mediaType,supportedMediaTypes:e.format.supportedMediaTypes,context:e.context||null,collections:e.collections};_o(t).then(this.handleTileSetInfo_.bind(this)).catch(this.handleError_.bind(this))}handleTileSetInfo_(e){this.tileGrid=e.grid,this.projection=e.projection,this.setTileUrlFunction(e.urlFunction,e.urlTemplate),this.setState("ready")}handleError_(e){Wt(e),this.setState("error")}}function Ro(i){return function(e){const t=e.buffers,r=e.meta,n=e.imageOps,s=e.width,o=e.height,a=t.length,l=t[0].byteLength;if(n){const f=new Array(a);for(let d=0;d<a;++d)f[d]=new ImageData(new Uint8ClampedArray(t[d]),s,o);return i(f,r).data.buffer}const c=new Uint8ClampedArray(l),h=new Array(a),u=new Array(a);for(let f=0;f<a;++f)h[f]=new Uint8ClampedArray(t[f]),u[f]=[0,0,0,0];for(let f=0;f<l;f+=4){for(let d=0;d<a;++d){const p=h[d];u[d][0]=p[f],u[d][1]=p[f+1],u[d][2]=p[f+2],u[d][3]=p[f+3]}const g=i(u,r);c[f]=g[0],c[f+1]=g[1],c[f+2]=g[2],c[f+3]=g[3]}return c.buffer}}function fg(i,e){const r=Object.keys(i.lib||{}).map(function(s){return"const "+s+" = "+i.lib[s].toString()+";"}).concat(["const __minion__ = ("+Ro.toString()+")(",i.operation.toString(),");",'self.addEventListener("message", function(event) {',"  const buffer = __minion__(event.data);","  self.postMessage({buffer: buffer, meta: event.data.meta}, [buffer]);","});"]),n=new Worker(typeof Blob>"u"?"data:text/javascript;base64,"+Buffer.from(r.join(`
`),"binary").toString("base64"):URL.createObjectURL(new Blob(r,{type:"text/javascript"})));return n.addEventListener("message",e),n}function gg(i,e){const t=Ro(i.operation);let r=!1;return{postMessage:function(n){setTimeout(function(){r||e({data:{buffer:t(n),meta:n.meta}})},0)},terminate:function(){r=!0}}}class pg extends us{constructor(e){super(),this.imageOps_=!!e.imageOps;let t;e.threads===0?t=0:this.imageOps_?t=1:t=e.threads||1;const r=new Array(t);if(t)for(let n=0;n<t;++n)r[n]=fg(e,this.onWorkerMessage_.bind(this,n));else r[0]=gg(e,this.onWorkerMessage_.bind(this,0));this.workers_=r,this.queue_=[],this.maxQueueLength_=e.queue||1/0,this.running_=0,this.dataLookup_={},this.job_=null}process(e,t,r){this.enqueue_({inputs:e,meta:t,callback:r}),this.dispatch_()}enqueue_(e){for(this.queue_.push(e);this.queue_.length>this.maxQueueLength_;)this.queue_.shift().callback(null,null)}dispatch_(){if(this.running_||this.queue_.length===0)return;const e=this.queue_.shift();this.job_=e;const t=e.inputs[0].width,r=e.inputs[0].height,n=e.inputs.map(function(l){return l.data.buffer}),s=this.workers_.length;if(this.running_=s,s===1){this.workers_[0].postMessage({buffers:n,meta:e.meta,imageOps:this.imageOps_,width:t,height:r},n);return}const o=e.inputs[0].data.length,a=4*Math.ceil(o/4/s);for(let l=0;l<s;++l){const c=l*a,h=[];for(let u=0,f=n.length;u<f;++u)h.push(n[u].slice(c,c+a));this.workers_[l].postMessage({buffers:h,meta:e.meta,imageOps:this.imageOps_,width:t,height:r},h)}}onWorkerMessage_(e,t){this.disposed||(this.dataLookup_[e]=t.data,--this.running_,this.running_===0&&this.resolveJob_())}resolveJob_(){const e=this.job_,t=this.workers_.length;let r,n;if(t===1)r=new Uint8ClampedArray(this.dataLookup_[0].buffer),n=this.dataLookup_[0].meta;else{const s=e.inputs[0].data.length;r=new Uint8ClampedArray(s),n=new Array(t);const o=4*Math.ceil(s/4/t);for(let a=0;a<t;++a){const l=this.dataLookup_[a].buffer,c=a*o;r.set(new Uint8ClampedArray(l),c),n[a]=this.dataLookup_[a].meta}}this.job_=null,this.dataLookup_={},e.callback(null,new ImageData(r,e.inputs[0].width,e.inputs[0].height),n),this.dispatch_()}disposeInternal(){for(let e=0;e<this.workers_.length;++e)this.workers_[e].terminate();this.workers_.length=0}}const ns={BEFOREOPERATIONS:"beforeoperations",AFTEROPERATIONS:"afteroperations"};class ss extends za{constructor(e,t,r){super(e),this.extent=t.extent,this.resolution=t.viewState.resolution/t.pixelRatio,this.data=r}}class So extends pt{constructor(e){super({projection:null}),this.on,this.once,this.un,this.processor_=null,this.operationType_=e.operationType!==void 0?e.operationType:"pixel",this.threads_=e.threads!==void 0?e.threads:1,this.layers_=Eg(e.sources);const t=this.changed.bind(this);for(let r=0,n=this.layers_.length;r<n;++r)this.layers_[r].addEventListener(Te.CHANGE,t);this.useResolutions_=e.resolutions!==null,this.tileQueue_=new Ba(function(){return 1},this.processSources_.bind(this)),this.requestedFrameState_,this.renderedImageCanvas_=null,this.renderedRevision_,this.frameState_={animate:!1,coordinateToPixelTransform:_e(),declutter:null,extent:null,index:0,layerIndex:0,layerStatesArray:_g(this.layers_),pixelRatio:1,pixelToCoordinateTransform:_e(),postRenderFunctions:[],size:[0,0],tileQueue:this.tileQueue_,time:Date.now(),usedTiles:{},viewState:{rotation:0},viewHints:[],wantedTiles:{},mapId:Q(this),renderTargets:{}},this.setAttributions(function(r){var s;const n=[];for(let o=0,a=e.sources.length;o<a;++o){const l=e.sources[o],c=l instanceof vi?l:l.getSource();if(!c)continue;const h=(s=c.getAttributions())==null?void 0:s(r);typeof h=="string"?n.push(h):h!==void 0&&n.push(...h)}return n}),e.operation!==void 0&&this.setOperation(e.operation,e.lib)}setOperation(e,t){this.processor_&&this.processor_.dispose(),this.processor_=new pg({operation:e,imageOps:this.operationType_==="image",queue:1,lib:t,threads:this.threads_}),this.changed()}updateFrameState_(e,t,r){const n=Object.assign({},this.frameState_);n.viewState=Object.assign({},n.viewState);const s=Ze(e);n.size[0]=Math.ceil(Ee(e)/t),n.size[1]=Math.ceil(Me(e)/t),n.extent=[s[0]-n.size[0]*t/2,s[1]-n.size[1]*t/2,s[0]+n.size[0]*t/2,s[1]+n.size[1]*t/2],n.time=Date.now();const o=n.viewState;return o.center=s,o.projection=r,o.resolution=t,n}allSourcesReady_(){let e=!0,t;for(let r=0,n=this.layers_.length;r<n;++r)if(t=this.layers_[r].getSource(),!t||t.getState()!=="ready"){e=!1;break}return e}getImage(e,t,r,n){if(!this.allSourcesReady_())return null;this.tileQueue_.loadMoreTiles(16,16),t=this.findNearestResolution(t);const s=this.updateFrameState_(e,t,n);if(this.requestedFrameState_=s,this.renderedImageCanvas_){const o=this.renderedImageCanvas_.getResolution(),a=this.renderedImageCanvas_.getExtent();(t!==o||!$t(s.extent,a))&&(this.renderedImageCanvas_=null)}return(!this.renderedImageCanvas_||this.getRevision()!==this.renderedRevision_)&&this.processSources_(),s.animate&&requestAnimationFrame(this.changed.bind(this)),this.renderedImageCanvas_}processSources_(){const e=this.requestedFrameState_,t=this.layers_.length,r=new Array(t);for(let s=0;s<t;++s){e.layerIndex=s,e.renderTargets={};const o=mg(this.layers_[s],e);if(o)r[s]=o;else return}const n={};this.dispatchEvent(new ss(ns.BEFOREOPERATIONS,e,n)),this.processor_.process(r,n,this.onWorkerComplete_.bind(this,e))}onWorkerComplete_(e,t,r,n){if(t||!r)return;const s=e.extent,o=e.viewState.resolution;if(o!==this.requestedFrameState_.viewState.resolution||!$t(s,this.requestedFrameState_.extent))return;let a;if(this.renderedImageCanvas_)a=this.renderedImageCanvas_.getImage().getContext("2d");else{const l=Math.round(Ee(s)/o),c=Math.round(Me(s)/o);a=nt(l,c),this.renderedImageCanvas_=new Ki(s,o,1,a.canvas)}a.putImageData(r,0,0),e.animate?requestAnimationFrame(this.changed.bind(this)):this.changed(),this.renderedRevision_=this.getRevision(),this.dispatchEvent(new ss(ns.AFTEROPERATIONS,e,n))}getResolutions(e){if(!this.useResolutions_)return null;let t=super.getResolutions();if(!t)for(let r=0,n=this.layers_.length;r<n&&(t=this.layers_[r].getSource().getResolutions(e),!t);++r);return t}disposeInternal(){this.processor_&&this.processor_.dispose(),super.disposeInternal()}}So.prototype.dispose;let at=null;function mg(i,e){const t=i.getRenderer();if(!t)throw new Error("Unsupported layer type: "+i);if(!t.prepareFrame(e))return null;const r=e.size[0],n=e.size[1];if(r===0||n===0)return null;const s=t.renderFrame(e,null);let o;if(s instanceof HTMLCanvasElement)o=s;else{if(s&&(o=s.firstElementChild),!(o instanceof HTMLCanvasElement))throw new Error("Unsupported rendered element: "+o);if(o.width===r&&o.height===n)return o.getContext("2d").getImageData(0,0,r,n)}if(!at)at=nt(r,n,void 0,{willReadFrequently:!0});else{const a=at.canvas;a.width!==r||a.height!==n?at=nt(r,n,void 0,{willReadFrequently:!0}):at.clearRect(0,0,r,n)}return at.drawImage(o,0,0,r,n),at.getImageData(0,0,r,n)}function _g(i){return i.map(function(e){return e.getLayerState()})}function Eg(i){const e=i.length,t=new Array(e);for(let r=0;r<e;++r)t[r]=yg(i[r]);return t}function yg(i){let e;return i instanceof vi?i instanceof Pi?e=new $a({source:i}):i instanceof pt&&(e=new Xa({source:i})):e=i,e}const xg='&copy; <a href="https://www.stadiamaps.com/" target="_blank">Stadia Maps</a>',Tg='&copy; <a href="https://openmaptiles.org/" target="_blank">OpenMapTiles</a>',Rg='&copy; <a href="https://stamen.com/" target="_blank">Stamen Design</a>',Sg={stamen_terrain:{extension:"png"},stamen_terrain_background:{extension:"png"},stamen_terrain_labels:{extension:"png"},stamen_terrain_lines:{extension:"png"},stamen_toner_background:{extension:"png"},stamen_toner:{extension:"png"},stamen_toner_labels:{extension:"png"},stamen_toner_lines:{extension:"png"},stamen_toner_lite:{extension:"png"},stamen_toner_dark:{extension:"png"},stamen_toner_blacklite:{extension:"png"},stamen_watercolor:{extension:"jpg"},alidade_smooth:{extension:"png"},alidade_smooth_dark:{extension:"png"},alidade_satellite:{extension:"png"},outdoors:{extension:"png"},osm_bright:{extension:"png"}},Pg={stamen_terrain:{minZoom:0,maxZoom:18,retina:!0},stamen_toner:{minZoom:0,maxZoom:20,retina:!0},stamen_toner_dark:{minZoom:0,maxZoom:20,retina:!0},stamen_toner_blacklite:{minZoom:0,maxZoom:20,retina:!0},stamen_watercolor:{minZoom:1,maxZoom:18,retina:!1}};class wg extends ms{constructor(e){const t=e.layer.indexOf("-"),r=t==-1?e.layer:e.layer.slice(0,t),n=Pg[r]||{minZoom:0,maxZoom:20,retina:!0},s=Sg[e.layer],o=e.apiKey?"?api_key="+e.apiKey:"",a=n.retina&&e.retina?"@2x":"",l=e.url!==void 0?e.url:"https://tiles.stadiamaps.com/tiles/"+e.layer+"/{z}/{x}/{y}"+a+"."+s.extension+o,c=[xg,Tg,ka];e.layer.startsWith("stamen_")&&c.splice(1,0,Rg),super({attributions:c,cacheSize:e.cacheSize,crossOrigin:"anonymous",interpolate:e.interpolate,maxZoom:e.maxZoom!==void 0?e.maxZoom:n.maxZoom,minZoom:e.minZoom!==void 0?e.minZoom:n.minZoom,reprojectionErrorThreshold:e.reprojectionErrorThreshold,tileLoadFunction:e.tileLoadFunction,transition:e.transition,url:l,tilePixelRatio:a?2:1,wrapX:e.wrapX,zDirection:e.zDirection})}}class bg extends qe{constructor(e){e=e||{},super({attributions:e.attributions,cacheSize:e.cacheSize,crossOrigin:e.crossOrigin,interpolate:e.interpolate,projection:e.projection,reprojectionErrorThreshold:e.reprojectionErrorThreshold,tileGrid:e.tileGrid,tileLoadFunction:e.tileLoadFunction,url:e.url,urls:e.urls,wrapX:e.wrapX!==void 0?e.wrapX:!0,transition:e.transition,zDirection:e.zDirection}),this.params_=Object.assign({},e.params),this.hidpi_=e.hidpi!==void 0?e.hidpi:!0,this.tmpExtent_=Vt(),this.setKey(this.getKeyForParams_())}getKeyForParams_(){let e=0;const t=[];for(const r in this.params_)t[e++]=r+"-"+this.params_[r];return t.join("/")}getParams(){return this.params_}getRequestUrl_(e,t,r,n,s,o){const a=this.urls;if(!a)return;let l;if(a.length==1)l=a[0];else{const c=ja(Wa(e),a.length);l=a[c]}return yo(l,r,(this.tileGrid||this.getTileGridForProjection(s)).getResolution(e[0]),n,s,o)}getTilePixelRatio(e){return this.hidpi_?e:1}setParams(e){this.params_=Object.assign({},e),this.setKey(this.getKeyForParams_())}updateParams(e){Object.assign(this.params_,e),this.setKey(this.getKeyForParams_())}tileUrlFunction(e,t,r){let n=this.getTileGrid();if(n||(n=this.getTileGridForProjection(r)),n.getResolutions().length<=e[0])return;t!=1&&!this.hidpi_&&(t=1);const s=n.getTileCoordExtent(e,this.tmpExtent_);let o=Fe(n.getTileSize(e[0]),this.tmpSize);t!=1&&(o=Za(o,t,this.tmpSize));const a={F:"image",FORMAT:"PNG32",TRANSPARENT:!0};return Object.assign(a,this.params_),this.getRequestUrl_(e,o,s,t,r,a)}}class Lg extends To{constructor(e){e=e||{};const t=e.template||"z:{z} x:{x} y:{y}",r=e.source,n=e.color||"grey";super({transition:0,wrapX:e.wrapX!==void 0?e.wrapX:r!==void 0?r.getWrapX():void 0});const s=()=>{var a;this.projection=e.projection!==void 0?K(e.projection):r!==void 0?r.getProjection():this.projection,this.tileGrid=e.tileGrid!==void 0?e.tileGrid:r!==void 0?r.getTileGrid():this.tileGrid,this.zDirection=e.zDirection!==void 0?e.zDirection:r!==void 0?r.zDirection:this.zDirection,r instanceof rr&&(this.transformMatrix=((a=r.transformMatrix)==null?void 0:a.slice())||null);const o=this.tileGrid;o&&this.setTileSizes(o.getResolutions().map((l,c)=>Fe(o.getTileSize(c)).map(h=>Math.max(Math.floor(h),1)))),this.setLoader((l,c,h,u)=>{const f=Ts(t,l,c,h,u.maxY),[g,d]=this.getTileSize(l),p=nt(g,d);return p.strokeStyle=n,p.strokeRect(.5,.5,g+.5,d+.5),p.fillStyle=n,p.strokeStyle="white",p.textAlign="center",p.textBaseline="middle",p.font="24px sans-serif",p.lineWidth=4,p.strokeText(f,g/2,d/2,g),p.fillText(f,g/2,d/2,g),Promise.resolve(p.canvas)}),this.setState("ready")};if(r===void 0||r.getState()==="ready")s();else{const o=()=>{r.getState()==="ready"&&(r.removeEventListener(Te.CHANGE,o),s())};r.addEventListener(Te.CHANGE,o)}}}class vg extends qe{constructor(e){if(super({attributions:e.attributions,cacheSize:e.cacheSize,crossOrigin:e.crossOrigin,interpolate:e.interpolate,projection:K("EPSG:3857"),reprojectionErrorThreshold:e.reprojectionErrorThreshold,state:"loading",tileLoadFunction:e.tileLoadFunction,wrapX:e.wrapX!==void 0?e.wrapX:!0,transition:e.transition,zDirection:e.zDirection}),this.tileJSON_=null,this.tileSize_=e.tileSize,e.url)if(e.jsonp)Ji(e.url,this.handleTileJSONResponse.bind(this),this.handleTileJSONError.bind(this));else{const t=new XMLHttpRequest;t.addEventListener("load",this.onXHRLoad_.bind(this)),t.addEventListener("error",this.onXHRError_.bind(this)),t.open("GET",e.url),t.send()}else if(e.tileJSON)this.handleTileJSONResponse(e.tileJSON);else throw new Error("Either `url` or `tileJSON` options must be provided")}onXHRLoad_(e){const t=e.target;if(!t.status||t.status>=200&&t.status<300){let r;try{r=JSON.parse(t.responseText)}catch{this.handleTileJSONError();return}this.handleTileJSONResponse(r)}else this.handleTileJSONError()}onXHRError_(e){this.handleTileJSONError()}getTileJSON(){return this.tileJSON_}handleTileJSONResponse(e){const t=K("EPSG:4326"),r=this.getProjection();let n;if(e.bounds!==void 0){const c=Si(t,r);n=bt(e.bounds,c)}const s=Yt(r),o=e.minzoom||0,a=e.maxzoom||22,l=qt({extent:s,maxZoom:a,minZoom:o,tileSize:this.tileSize_});if(this.tileGrid=l,this.tileUrlFunction=Rs(e.tiles,l),e.attribution&&!this.getAttributions()){const c=n!==void 0?n:s;this.setAttributions(function(h){return wt(c,h.extent)?[e.attribution]:null})}this.tileJSON_=e,this.setState("ready")}handleTileJSONError(){this.setState("error")}}class Ag extends Ya{constructor(e,t,r,n,s,o){super(e,t),this.src_=r,this.extent_=n,this.preemptive_=s,this.grid_=null,this.keys_=null,this.data_=null,this.jsonp_=o}getImage(){return null}getData(e){if(!this.grid_||!this.keys_)return null;const t=(e[0]-this.extent_[0])/(this.extent_[2]-this.extent_[0]),r=(e[1]-this.extent_[1])/(this.extent_[3]-this.extent_[1]),n=this.grid_[Math.floor((1-r)*this.grid_.length)];if(typeof n!="string")return null;let s=n.charCodeAt(Math.floor(t*n.length));s>=93&&s--,s>=35&&s--,s-=32;let o=null;if(s in this.keys_){const a=this.keys_[s];this.data_&&a in this.data_?o=this.data_[a]:o=a}return o}forDataAtCoordinate(e,t,r){this.state==V.EMPTY&&r===!0?(this.state=V.IDLE,qa(this,Te.CHANGE,n=>{t(this.getData(e))}),this.loadInternal_()):r===!0?setTimeout(()=>{t(this.getData(e))},0):t(this.getData(e))}getKey(){return this.src_}handleError_(){this.state=V.ERROR,this.changed()}handleLoad_(e){this.grid_=e.grid,this.keys_=e.keys,this.data_=e.data,this.state=V.LOADED,this.changed()}loadInternal_(){if(this.state==V.IDLE)if(this.state=V.LOADING,this.jsonp_)Ji(this.src_,this.handleLoad_.bind(this),this.handleError_.bind(this));else{const e=new XMLHttpRequest;e.addEventListener("load",this.onXHRLoad_.bind(this)),e.addEventListener("error",this.onXHRError_.bind(this)),e.open("GET",this.src_),e.send()}}onXHRLoad_(e){const t=e.target;if(!t.status||t.status>=200&&t.status<300){let r;try{r=JSON.parse(t.responseText)}catch{this.handleError_();return}this.handleLoad_(r)}else this.handleError_()}onXHRError_(e){this.handleError_()}load(){this.preemptive_?this.loadInternal_():this.setState(V.EMPTY)}}class Cg extends Pi{constructor(e){if(super({projection:K("EPSG:3857"),state:"loading",wrapX:e.wrapX!==void 0?e.wrapX:!0,zDirection:e.zDirection}),this.preemptive_=e.preemptive!==void 0?e.preemptive:!0,this.tileUrlFunction_=Ha,this.template_=void 0,this.jsonp_=e.jsonp||!1,this.tileCache_=new hs(512),e.url)if(this.jsonp_)Ji(e.url,this.handleTileJSONResponse.bind(this),this.handleTileJSONError.bind(this));else{const t=new XMLHttpRequest;t.addEventListener("load",this.onXHRLoad_.bind(this)),t.addEventListener("error",this.onXHRError_.bind(this)),t.open("GET",e.url),t.send()}else if(e.tileJSON)this.handleTileJSONResponse(e.tileJSON);else throw new Error("Either `url` or `tileJSON` options must be provided")}onXHRLoad_(e){const t=e.target;if(!t.status||t.status>=200&&t.status<300){let r;try{r=JSON.parse(t.responseText)}catch{this.handleTileJSONError();return}this.handleTileJSONResponse(r)}else this.handleTileJSONError()}onXHRError_(e){this.handleTileJSONError()}getTemplate(){return this.template_}forDataAtCoordinateAndResolution(e,t,r,n){if(this.tileGrid){const s=this.tileGrid.getZForResolution(t,this.zDirection),o=this.tileGrid.getTileCoordForCoordAndZ(e,s),a=this.getTile(o[0],o[1],o[2],1,this.getProjection());a.getState()==V.IDLE&&a.load(),a.forDataAtCoordinate(e,r,n)}else n===!0?setTimeout(function(){r(null)},0):r(null)}handleTileJSONError(){this.setState("error")}handleTileJSONResponse(e){const t=K("EPSG:4326"),r=this.getProjection();let n;if(e.bounds!==void 0){const h=Si(t,r);n=bt(e.bounds,h)}const s=Yt(r),o=e.minzoom||0,a=e.maxzoom||22,l=qt({extent:s,maxZoom:a,minZoom:o});this.tileGrid=l,this.template_=e.template;const c=e.grids;if(!c){this.setState("error");return}if(this.tileUrlFunction_=Rs(c,l),e.attribution){const h=n!==void 0?n:s;this.setAttributions(function(u){return wt(h,u.extent)?[e.attribution]:null})}this.setState("ready")}getTile(e,t,r,n,s){const o=[e,t,r],a=this.getTileCoordForTileUrlFunction(o,s),l=this.tileUrlFunction_(a,n,s),c=`${this.getKey()},${Va(e,t,r)}`;if(this.tileCache_.containsKey(c))return this.tileCache_.get(c);this.tileCache_.expireCache();const h=new Ag(o,l!==void 0?V.IDLE:V.EMPTY,l!==void 0?l:"",this.tileGrid.getTileCoordExtent(o),this.preemptive_,this.jsonp_);return this.tileCache_.set(c,h),h}}class Ig extends gi{constructor(e){e=e||{},super({attributions:e.attributions,wrapX:e.wrapX}),this.resolution=void 0,this.distance=e.distance!==void 0?e.distance:20,this.minDistance=e.minDistance||0,this.interpolationRatio=0,this.features=[],this.geometryFunction=e.geometryFunction||function(t){const r=t.getGeometry();return ve(!r||r.getType()==="Point","The default `geometryFunction` can only handle `Point` or null geometries"),r},this.createCustomCluster_=e.createCluster,this.source=null,this.boundRefresh_=this.refresh.bind(this),this.updateDistance(this.distance,this.minDistance),this.setSource(e.source||null)}clear(e){this.features.length=0,super.clear(e)}getDistance(){return this.distance}getSource(){return this.source}loadFeatures(e,t,r){var n;(n=this.source)==null||n.loadFeatures(e,t,r),t!==this.resolution&&(this.resolution=t,this.refresh())}setDistance(e){this.updateDistance(e,this.minDistance)}setMinDistance(e){this.updateDistance(this.distance,e)}getMinDistance(){return this.minDistance}setSource(e){this.source&&this.source.removeEventListener(Te.CHANGE,this.boundRefresh_),this.source=e,e&&e.addEventListener(Te.CHANGE,this.boundRefresh_),this.refresh()}refresh(){this.clear(),this.cluster(),this.addFeatures(this.features)}updateDistance(e,t){const r=e===0?0:Math.min(t,e)/e,n=e!==this.distance||this.interpolationRatio!==r;this.distance=e,this.minDistance=t,this.interpolationRatio=r,n&&this.refresh()}cluster(){if(this.resolution===void 0||!this.source)return;const e=Vt(),t=this.distance*this.resolution,r=this.source.getFeatures(),n={};for(let s=0,o=r.length;s<o;s++){const a=r[s];if(!(Q(a)in n)){const l=this.geometryFunction(a);if(l){const c=l.getCoordinates();Ka(c,e),xi(e,t,e);const h=this.source.getFeaturesInExtent(e).filter(function(u){const f=Q(u);return f in n?!1:(n[f]=!0,!0)});this.features.push(this.createCluster(h,e))}}}}createCluster(e,t){const r=[0,0];for(let a=e.length-1;a>=0;--a){const l=this.geometryFunction(e[a]);l?Ja(r,l.getCoordinates()):e.splice(a,1)}Qa(r,1/e.length);const n=Ze(t),s=this.interpolationRatio,o=new Ie([r[0]*(1-s)+n[0]*s,r[1]*(1-s)+n[1]*s]);return this.createCustomCluster_?this.createCustomCluster_(o,e):new Re({geometry:o,features:e})}}class br extends Ig{constructor(e={}){super({...e,createCluster:br.defaultCreateCluster,geometryFunction:br.defaultGeometryFunction})}static defaultCreateCluster(e,t){const r=t.length===1&&t[0].getGeometry()instanceof ut?t[0].getGeometry():e,n=new Re({geometry:r,features:t});if(t.length===1){const s=t[0];for(const o in s.getProperties())o!=="geometry"&&n.set(o,s.get(o))}return n}static defaultGeometryFunction(e){const t=e&&e.getGeometry();return t instanceof Ie?t:t instanceof ut?t.getInteriorPoint():null}}class Fg extends qe{constructor(e){super({attributions:e.attributions,cacheSize:e.cacheSize,tilePixelRatio:e.tilePixelRatio,transition:e.transition,interpolate:e.interpolate!==void 0?e.interpolate:!0,key:e.key,attributionsCollapsible:e.attributionsCollapsible,zDirection:e.zDirection,wrapX:e.wrapX}),this.version_=e.version!==void 0?e.version:"1.0.0",this.dimensions_=e.dimensions!==void 0?e.dimensions:{},this.layer_=e.layer,fetch(e.url).then(t=>t.text()).then(t=>new window.DOMParser().parseFromString(t,"application/xml")).then(t=>{this.handleCapabilitiesResponse(t,e)})}handleCapabilitiesResponse(e,t){const n=new js().read(e),s=el(n,t);this.crossOrigin=s.crossOrigin,this.projection=s.projection,this.tileGrid=s.tileGrid,this.requestEncoding_=s.requestEncoding,this.matrixSet_=s.matrixSet,this.style_=s.style,this.format_=s.format,this.dimensions_=s.dimensions,this.setUrls(s.urls),this.urls&&this.urls.length>0&&(this.tileUrlFunction=Ri(this.urls.map(this.createFromWMTSTemplate.bind(this)))),this.getState()!=="ready"&&this.setState("ready")}createFromWMTSTemplate(e){const t=this.requestEncoding_,r={layer:this.layer_,style:this.style_,tilematrixset:this.matrixSet_};t==="KVP"&&Object.assign(r,{Service:"WMTS",Request:"GetTile",Version:this.version_,Format:this.format_}),e=t==="KVP"?yr(e,r):e.replace(/\{(\w+?)\}/g,(o,a)=>a.toLowerCase()in r?r[a.toLowerCase()]:o);const n=this.tileGrid,s=this.dimensions_;return function(o){if(!o)return;const a={TileMatrix:n.getMatrixId(o[0]),TileCol:o[1],TileRow:o[2]};Object.assign(a,s);let l=e;return t==="KVP"?l=yr(l,a):l=l.replace(/\{(\w+?)\}/g,(c,h)=>a[h]),l}}}class Ng extends gi{constructor(e){super({attributions:e.attributions,wrapX:e.wrapX,strategy:tl}),this.dataProjection=e.projection||rl.dataProjection,this.resourceURL=e.url,super.setLoader(this.loader)}fgbBoundingBox(e,t){const r=il(e,t.getCode(),this.dataProjection);return{minX:r[0],minY:r[1],maxX:r[2],maxY:r[3]}}async loader(e,t,r,n,s){const o=this.fgbBoundingBox(e,r);try{if(o.minX!==-1/0){const a=[],l=fl(this.resourceURL,o),c=new nl({featureProjection:r,dataProjection:this.dataProjection});for await(const h of l){const u=c.readFeature(h);a.push(u)}super.clear(),super.addFeatures(a),n(a)}}catch{s()}}}window.eoxMapAdvancedOlSources={BingMaps:gf,CartoDB:pf,Cluster:br,DataTile:rr,GeoTIFF:fo,GeoZarr:Zf,Google:Kf,IIIF:Qf,Image:pt,ImageArcGISRest:tg,ImageCanvas:rg,ImageMapGuide:og,ImageStatic:lg,ImageTile:To,OGCMapTile:hg,OGCVectorTile:dg,Raster:So,Source:vi,StadiaMaps:wg,TileArcGISRest:bg,TileDebug:Lg,TileImage:qe,TileJSON:vg,UrlTile:sl,UTFGrid:Cg,Zoomify:Jf,WMTSCapabilities:Fg,FlatGeoBuf:Ng};

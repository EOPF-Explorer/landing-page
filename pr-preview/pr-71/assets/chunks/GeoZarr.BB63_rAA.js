const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/chunks/blosc.nNxqTOai.js","assets/chunks/chunk-INHXZS53.D3tQiqtZ.js","assets/chunks/lz4.COuoZ_ur.js","assets/chunks/zstd.CtzXwP91.js"])))=>i.map(i=>d[i]);
var hn=Object.defineProperty;var Yt=t=>{throw TypeError(t)};var dn=(t,e,r)=>e in t?hn(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r;var I=(t,e,r)=>dn(t,typeof e!="symbol"?e+"":e,r),et=(t,e,r)=>e.has(t)||Yt("Cannot "+r);var C=(t,e,r)=>(et(t,e,"read from private field"),r?r.call(t):e.get(t)),X=(t,e,r)=>e.has(t)?Yt("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,r),B=(t,e,r,n)=>(et(t,e,"write to private field"),n?n.call(t,r):e.set(t,r),r),tt=(t,e,r)=>(et(t,e,"access private method"),r);import{P as fn,v as G,Q as Ur,y as ie,V as _n,t as Pr,W as ht,Y as Tn,Z as Vt,_ as de,B as Me,$ as En,a0 as pn,a1 as oe,a2 as dt,a3 as gn,a4 as ce,a5 as Ir,a6 as Dr,a7 as mn,a8 as S,a9 as Kt,n as Rn,aa as xn,ab as yn,E as bn,j as An,N as vn,f as wn,w as Ln,ac as Cn,ad as Sn,x as Un,ae as rt}from"./XYZ.khqhGb_1.js";import{D as Pn,au as In,C as ne,S as Fr,T as Zt,n as Dn,e as Fn,E as ke,F as nt,u as qt,L as Nn,am as Jt,m as Qt,z as Mn,w as it,g as He,av as On,a9 as Gn,ak as Bn,d as Xn}from"./proj.DNHHD1fb.js";import{n as Nr,m as V,ao as $n,a1 as We,_ as Mr,aj as kn,ak as jn,E as _e,a as Or,a7 as zn,a6 as er,ap as Hn,a8 as Wn,ad as Yn,a3 as Vn,l as Kn,u as tr,al as Zn}from"./Polygon.FVLon8Z8.js";import{a8 as vt,a9 as ft,aa as _t,ab as qn,U as ue,ac as st,ad as Jn,ae as Qn,af as ei}from"./Tile.CxQIIfjm.js";import{W as wt}from"./WMTS.DDNw7afE.js";import{a5 as ot}from"./framework.CIem6SRJ.js";function ge(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}function Gr(t,e){return t[0]=e[0],t[1]=e[1],t[4]=e[2],t[5]=e[3],t[12]=e[4],t[13]=e[5],t}function Tt(t,e,r,n,i,s,o){o=o??ge();const a=1/(t-e),c=1/(r-n),l=1/(i-s);return o[0]=-2*a,o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[5]=-2*c,o[6]=0,o[7]=0,o[8]=0,o[9]=0,o[10]=2*l,o[11]=0,o[12]=(t+e)*a,o[13]=(n+r)*c,o[14]=(s+i)*l,o[15]=1,o}function rr(t,e,r,n,i){return i=i??ge(),i[0]=t[0]*e,i[1]=t[1]*e,i[2]=t[2]*e,i[3]=t[3]*e,i[4]=t[4]*r,i[5]=t[5]*r,i[6]=t[6]*r,i[7]=t[7]*r,i[8]=t[8]*n,i[9]=t[9]*n,i[10]=t[10]*n,i[11]=t[11]*n,i[12]=t[12],i[13]=t[13],i[14]=t[14],i[15]=t[15],i}function ti(t,e,r,n,i){i=i??ge();let s,o,a,c,l,d,h,f,_,u,E,y;return t===i?(i[12]=t[0]*e+t[4]*r+t[8]*n+t[12],i[13]=t[1]*e+t[5]*r+t[9]*n+t[13],i[14]=t[2]*e+t[6]*r+t[10]*n+t[14],i[15]=t[3]*e+t[7]*r+t[11]*n+t[15]):(s=t[0],o=t[1],a=t[2],c=t[3],l=t[4],d=t[5],h=t[6],f=t[7],_=t[8],u=t[9],E=t[10],y=t[11],i[0]=s,i[1]=o,i[2]=a,i[3]=c,i[4]=l,i[5]=d,i[6]=h,i[7]=f,i[8]=_,i[9]=u,i[10]=E,i[11]=y,i[12]=s*e+l*r+_*n+t[12],i[13]=o*e+d*r+u*n+t[13],i[14]=a*e+h*r+E*n+t[14],i[15]=c*e+f*r+y*n+t[15]),i}function ri(t,e,r,n){return n=n??ge(),n[0]=1,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=1,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=1,n[11]=0,n[12]=t,n[13]=e,n[14]=r,n[15]=1,n}const Lt=34962,Ct=34963,St=35044,so=35048,ni=5121,ii=5123,si=5125,Br=5126,nr=["experimental-webgl","webgl","webkit-3d","moz-webgl"];function oi(t,e){e=Object.assign({preserveDrawingBuffer:!0,antialias:!fn},e);const r=nr.length;for(let n=0;n<r;++n)try{const i=t.getContext(nr[n],e);if(i)return i}catch{}return null}const ai={STATIC_DRAW:St};class Xr{constructor(e,r){this.array_=null,this.type_=e,Nr(e===Lt||e===Ct,"A `WebGLArrayBuffer` must either be of type `ELEMENT_ARRAY_BUFFER` or `ARRAY_BUFFER`"),this.usage_=r!==void 0?r:ai.STATIC_DRAW}ofSize(e){return this.array_=new(Xe(this.type_))(e),this}fromArray(e){return this.array_=Xe(this.type_).from(e),this}fromArrayBuffer(e){return this.array_=new(Xe(this.type_))(e),this}getType(){return this.type_}getArray(){return this.array_}setArray(e){const r=Xe(this.type_);if(!(e instanceof r))throw new Error(`Expected ${r}`);this.array_=e}getUsage(){return this.usage_}getSize(){return this.array_?this.array_.length:0}}function Xe(t){switch(t){case Lt:return Float32Array;case Ct:return Uint32Array;default:return Float32Array}}const $e={LOST:"webglcontextlost",RESTORED:"webglcontextrestored"},ci=`
  precision mediump float;

  attribute vec2 a_position;
  varying vec2 v_texCoord;
  varying vec2 v_screenCoord;

  uniform vec2 u_screenSize;

  void main() {
    v_texCoord = a_position * 0.5 + 0.5;
    v_screenCoord = v_texCoord * u_screenSize;
    gl_Position = vec4(a_position, 0.0, 1.0);
  }
`,li=`
  precision mediump float;

  uniform sampler2D u_image;
  uniform float u_opacity;

  varying vec2 v_texCoord;

  void main() {
    gl_FragColor = texture2D(u_image, v_texCoord) * u_opacity;
  }
`;class ir{constructor(e){this.gl_=e.webGlContext;const r=this.gl_;this.scaleRatio_=e.scaleRatio||1,this.renderTargetTexture_=r.createTexture(),this.renderTargetTextureSize_=null,this.frameBuffer_=r.createFramebuffer(),this.depthBuffer_=r.createRenderbuffer();const n=r.createShader(r.VERTEX_SHADER);r.shaderSource(n,e.vertexShader||ci),r.compileShader(n);const i=r.createShader(r.FRAGMENT_SHADER);r.shaderSource(i,e.fragmentShader||li),r.compileShader(i),this.renderTargetProgram_=r.createProgram(),r.attachShader(this.renderTargetProgram_,n),r.attachShader(this.renderTargetProgram_,i),r.linkProgram(this.renderTargetProgram_),this.renderTargetVerticesBuffer_=r.createBuffer();const s=[-1,-1,1,-1,-1,1,1,-1,1,1,-1,1];r.bindBuffer(r.ARRAY_BUFFER,this.renderTargetVerticesBuffer_),r.bufferData(r.ARRAY_BUFFER,new Float32Array(s),r.STATIC_DRAW),this.renderTargetAttribLocation_=r.getAttribLocation(this.renderTargetProgram_,"a_position"),this.renderTargetUniformLocation_=r.getUniformLocation(this.renderTargetProgram_,"u_screenSize"),this.renderTargetOpacityLocation_=r.getUniformLocation(this.renderTargetProgram_,"u_opacity"),this.renderTargetTextureLocation_=r.getUniformLocation(this.renderTargetProgram_,"u_image"),this.uniforms_=[],e.uniforms&&Object.keys(e.uniforms).forEach(o=>{this.uniforms_.push({value:e.uniforms[o],location:r.getUniformLocation(this.renderTargetProgram_,o)})})}getRenderTargetTexture(){return this.renderTargetTexture_}getGL(){return this.gl_}init(e){const r=this.getGL(),n=[r.drawingBufferWidth*this.scaleRatio_,r.drawingBufferHeight*this.scaleRatio_];if(r.bindFramebuffer(r.FRAMEBUFFER,this.getFrameBuffer()),r.bindRenderbuffer(r.RENDERBUFFER,this.getDepthBuffer()),r.viewport(0,0,n[0],n[1]),!this.renderTargetTextureSize_||this.renderTargetTextureSize_[0]!==n[0]||this.renderTargetTextureSize_[1]!==n[1]){this.renderTargetTextureSize_=n;const i=0,s=r.RGBA,o=0,a=r.RGBA,c=r.UNSIGNED_BYTE,l=null;r.bindTexture(r.TEXTURE_2D,this.renderTargetTexture_),r.texImage2D(r.TEXTURE_2D,i,s,n[0],n[1],o,a,c,l),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,this.renderTargetTexture_,0),r.renderbufferStorage(r.RENDERBUFFER,r.DEPTH_COMPONENT16,n[0],n[1]),r.framebufferRenderbuffer(r.FRAMEBUFFER,r.DEPTH_ATTACHMENT,r.RENDERBUFFER,this.depthBuffer_)}}apply(e,r,n,i){const s=this.getGL(),o=e.size;if(s.bindFramebuffer(s.FRAMEBUFFER,r?r.getFrameBuffer():null),s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,this.renderTargetTexture_),!r){const c=V(s.canvas);if(!e.renderTargets[c]){const l=s.getContextAttributes();l&&l.preserveDrawingBuffer&&(s.clearColor(0,0,0,0),s.clearDepth(1),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT)),e.renderTargets[c]=!0}}s.disable(s.DEPTH_TEST),s.enable(s.BLEND),s.blendFunc(s.ONE,s.ONE_MINUS_SRC_ALPHA),s.viewport(0,0,s.drawingBufferWidth,s.drawingBufferHeight),s.bindBuffer(s.ARRAY_BUFFER,this.renderTargetVerticesBuffer_),s.useProgram(this.renderTargetProgram_),s.enableVertexAttribArray(this.renderTargetAttribLocation_),s.vertexAttribPointer(this.renderTargetAttribLocation_,2,s.FLOAT,!1,0,0),s.uniform2f(this.renderTargetUniformLocation_,o[0],o[1]),s.uniform1i(this.renderTargetTextureLocation_,0);const a=e.layerStatesArray[e.layerIndex].opacity;s.uniform1f(this.renderTargetOpacityLocation_,a),this.applyUniforms(e),n&&n(s,e),s.drawArrays(s.TRIANGLES,0,6),i&&i(s,e)}getFrameBuffer(){return this.frameBuffer_}getDepthBuffer(){return this.depthBuffer_}applyUniforms(e){const r=this.getGL();let n,i=1;this.uniforms_.forEach(function(s){if(n=typeof s.value=="function"?s.value(e):s.value,n instanceof HTMLCanvasElement||n instanceof ImageData)s.texture||(s.texture=r.createTexture()),r.activeTexture(r[`TEXTURE${i}`]),r.bindTexture(r.TEXTURE_2D,s.texture),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),n instanceof ImageData?r.texImage2D(r.TEXTURE_2D,0,r.RGBA,r.RGBA,n.width,n.height,0,r.UNSIGNED_BYTE,new Uint8Array(n.data)):r.texImage2D(r.TEXTURE_2D,0,r.RGBA,r.RGBA,r.UNSIGNED_BYTE,n),r.uniform1i(s.location,i++);else if(Array.isArray(n))switch(n.length){case 2:r.uniform2f(s.location,n[0],n[1]);return;case 3:r.uniform3f(s.location,n[0],n[1],n[2]);return;case 4:r.uniform4f(s.location,n[0],n[1],n[2],n[3]);return;default:return}else typeof n=="number"&&r.uniform1f(s.location,n)})}}const te={PROJECTION_MATRIX:"u_projectionMatrix",SCREEN_TO_WORLD_MATRIX:"u_screenToWorldMatrix",TIME:"u_time",ZOOM:"u_zoom",RESOLUTION:"u_resolution",ROTATION:"u_rotation",VIEWPORT_SIZE_PX:"u_viewportSizePx",PIXEL_RATIO:"u_pixelRatio",HIT_DETECTION:"u_hitDetection"},Re={UNSIGNED_BYTE:ni,UNSIGNED_SHORT:ii,UNSIGNED_INT:si,FLOAT:Br},Ye={};function sr(t){return"shared/"+t}let or=0;function ui(){const t="unique/"+or;return or+=1,t}function hi(t){let e=Ye[t];if(!e){const r=document.createElement("canvas");r.width=1,r.height=1,r.style.position="absolute",r.style.left="0",e={users:0,context:oi(r)},Ye[t]=e}return e.users+=1,e.context}function di(t){const e=Ye[t];if(!e||(e.users-=1,e.users>0))return;const r=e.context,n=r.getExtension("WEBGL_lose_context");n&&n.loseContext();const i=r.canvas;i.width=1,i.height=1,delete Ye[t]}class fi extends $n{constructor(e){super(),e=e||{},this.boundHandleWebGLContextLost_=this.handleWebGLContextLost.bind(this),this.boundHandleWebGLContextRestored_=this.handleWebGLContextRestored.bind(this),this.canvasCacheKey_=e.canvasCacheKey?sr(e.canvasCacheKey):ui(),this.gl_=hi(this.canvasCacheKey_),this.bufferCache_={},this.extensionCache_={},this.currentProgram_=null,this.needsToBeRecreated_=!1;const r=this.gl_.canvas;r.addEventListener($e.LOST,this.boundHandleWebGLContextLost_),r.addEventListener($e.RESTORED,this.boundHandleWebGLContextRestored_),this.offsetRotateMatrix_=We(),this.offsetScaleMatrix_=We(),this.tmpMat4_=ge(),this.uniformLocationsByProgram_={},this.attribLocationsByProgram_={},this.uniforms_=[],e.uniforms&&this.setUniforms(e.uniforms),this.postProcessPasses_=e.postProcesses?e.postProcesses.map(n=>new ir({webGlContext:this.gl_,scaleRatio:n.scaleRatio,vertexShader:n.vertexShader,fragmentShader:n.fragmentShader,uniforms:n.uniforms})):[new ir({webGlContext:this.gl_})],this.shaderCompileErrors_=null,this.startTime_=Date.now(),this.maxAttributeCount_=this.gl_.getParameter(this.gl_.MAX_VERTEX_ATTRIBS)}setUniforms(e){this.uniforms_=[],this.addUniforms(e)}addUniforms(e){for(const r in e)this.uniforms_.push({name:r,value:e[r]})}canvasCacheKeyMatches(e){return this.canvasCacheKey_===sr(e)}getExtension(e){if(e in this.extensionCache_)return this.extensionCache_[e];const r=this.gl_.getExtension(e);return this.extensionCache_[e]=r,r}getInstancedRenderingExtension_(){const e=this.getExtension("ANGLE_instanced_arrays");return Nr(!!e,"WebGL extension 'ANGLE_instanced_arrays' is required for vector rendering"),e}bindBuffer(e){const r=this.gl_,n=V(e);let i=this.bufferCache_[n];if(!i){const s=r.createBuffer();i={buffer:e,webGlBuffer:s},this.bufferCache_[n]=i}r.bindBuffer(e.getType(),i.webGlBuffer)}flushBufferData(e){const r=this.gl_;this.bindBuffer(e),r.bufferData(e.getType(),e.getArray(),e.getUsage())}deleteBuffer(e){const r=V(e);delete this.bufferCache_[r]}disposeInternal(){const e=this.gl_.canvas;e.removeEventListener($e.LOST,this.boundHandleWebGLContextLost_),e.removeEventListener($e.RESTORED,this.boundHandleWebGLContextRestored_),di(this.canvasCacheKey_),delete this.gl_}prepareDraw(e,r,n){const i=this.gl_,s=this.getCanvas(),o=e.size,a=e.pixelRatio;(s.width!==o[0]*a||s.height!==o[1]*a)&&(s.width=o[0]*a,s.height=o[1]*a,s.style.width=o[0]+"px",s.style.height=o[1]+"px");for(let c=this.postProcessPasses_.length-1;c>=0;c--)this.postProcessPasses_[c].init(e);i.bindTexture(i.TEXTURE_2D,null),i.clearColor(0,0,0,0),i.depthRange(0,1),i.clearDepth(1),i.clear(i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT),i.enable(i.BLEND),i.blendFunc(i.ONE,r?i.ZERO:i.ONE_MINUS_SRC_ALPHA),n?(i.enable(i.DEPTH_TEST),i.depthFunc(i.LEQUAL)):i.disable(i.DEPTH_TEST)}bindFrameBuffer(e,r){const n=this.getGL();n.bindFramebuffer(n.FRAMEBUFFER,e),r&&n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,r,0)}bindInitialFrameBuffer(){const e=this.getGL(),r=this.postProcessPasses_[0].getFrameBuffer();e.bindFramebuffer(e.FRAMEBUFFER,r);const n=this.postProcessPasses_[0].getRenderTargetTexture();e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,n,0)}bindTexture(e,r,n){const i=this.gl_;i.activeTexture(i.TEXTURE0+r),i.bindTexture(i.TEXTURE_2D,e),i.uniform1i(this.getUniformLocation(n),r)}bindAttribute(e,r,n){const i=this.getGL();this.bindBuffer(e);const s=this.getAttributeLocation(r);i.enableVertexAttribArray(s),i.vertexAttribPointer(s,n,i.FLOAT,!1,0,0)}prepareDrawToRenderTarget(e,r,n,i){const s=this.gl_,o=r.getSize();s.bindFramebuffer(s.FRAMEBUFFER,r.getFramebuffer()),s.bindRenderbuffer(s.RENDERBUFFER,r.getDepthbuffer()),s.viewport(0,0,o[0],o[1]),s.bindTexture(s.TEXTURE_2D,r.getTexture()),s.clearColor(0,0,0,0),s.depthRange(0,1),s.clearDepth(1),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT),s.enable(s.BLEND),s.blendFunc(s.ONE,n?s.ZERO:s.ONE_MINUS_SRC_ALPHA),i?(s.enable(s.DEPTH_TEST),s.depthFunc(s.LEQUAL)):s.disable(s.DEPTH_TEST)}drawElements(e,r){const n=this.gl_;this.getExtension("OES_element_index_uint");const i=n.UNSIGNED_INT,s=4,o=r-e,a=e*s;n.drawElements(n.TRIANGLES,o,i,a)}drawElementsInstanced(e,r,n){const i=this.gl_;this.getExtension("OES_element_index_uint");const s=this.getInstancedRenderingExtension_(),o=i.UNSIGNED_INT,a=4,c=r-e,l=e*a;s.drawElementsInstancedANGLE(i.TRIANGLES,c,o,l,n);for(let d=0;d<this.maxAttributeCount_;d++)s.vertexAttribDivisorANGLE(d,0)}finalizeDraw(e,r,n){for(let i=0,s=this.postProcessPasses_.length;i<s;i++)i===s-1?this.postProcessPasses_[i].apply(e,null,r,n):this.postProcessPasses_[i].apply(e,this.postProcessPasses_[i+1])}getCanvas(){return this.gl_.canvas}getGL(){return this.gl_}applyFrameState(e){const r=e.size,n=e.viewState.rotation,i=e.pixelRatio;this.setUniformFloatValue(te.TIME,(Date.now()-this.startTime_)*.001),this.setUniformFloatValue(te.ZOOM,e.viewState.zoom),this.setUniformFloatValue(te.RESOLUTION,e.viewState.resolution),this.setUniformFloatValue(te.PIXEL_RATIO,i),this.setUniformFloatVec2(te.VIEWPORT_SIZE_PX,[r[0],r[1]]),this.setUniformFloatValue(te.ROTATION,n)}applyHitDetectionUniform(e){const r=this.getUniformLocation(te.HIT_DETECTION);this.getGL().uniform1i(r,e?1:0),e&&this.setUniformFloatValue(te.PIXEL_RATIO,.5)}applyUniforms(e){const r=this.gl_;let n,i=0;this.uniforms_.forEach(s=>{if(n=typeof s.value=="function"?s.value(e):s.value,n instanceof HTMLCanvasElement||n instanceof HTMLImageElement||n instanceof ImageData||n instanceof WebGLTexture){n instanceof WebGLTexture&&!s.texture?(s.prevValue=void 0,s.texture=n):s.texture||(s.prevValue=void 0,s.texture=r.createTexture()),this.bindTexture(s.texture,i,s.name),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE);const o=!(n instanceof HTMLImageElement)||n.complete;!(n instanceof WebGLTexture)&&o&&s.prevValue!==n&&(s.prevValue=n,r.texImage2D(r.TEXTURE_2D,0,r.RGBA,r.RGBA,r.UNSIGNED_BYTE,n)),i++}else if(Array.isArray(n)&&n.length===6)this.setUniformMatrixValue(s.name,Gr(this.tmpMat4_,n));else if(Array.isArray(n)&&n.length<=4)switch(n.length){case 2:r.uniform2f(this.getUniformLocation(s.name),n[0],n[1]);return;case 3:r.uniform3f(this.getUniformLocation(s.name),n[0],n[1],n[2]);return;case 4:r.uniform4f(this.getUniformLocation(s.name),n[0],n[1],n[2],n[3]);return;default:return}else typeof n=="number"&&r.uniform1f(this.getUniformLocation(s.name),n)})}useProgram(e,r){this.disableAllAttributes_(),this.gl_.useProgram(e),this.currentProgram_=e,r&&(this.applyFrameState(r),this.applyUniforms(r))}compileShader(e,r){const n=this.gl_,i=n.createShader(r);return n.shaderSource(i,e),n.compileShader(i),i}getProgram(e,r){const n=this.gl_,i=this.compileShader(e,n.FRAGMENT_SHADER),s=this.compileShader(r,n.VERTEX_SHADER),o=n.createProgram();if(n.attachShader(o,i),n.attachShader(o,s),n.linkProgram(o),!n.getShaderParameter(i,n.COMPILE_STATUS)){const a=`Fragment shader compilation failed: ${n.getShaderInfoLog(i)}`;throw new Error(a)}if(n.deleteShader(i),!n.getShaderParameter(s,n.COMPILE_STATUS)){const a=`Vertex shader compilation failed: ${n.getShaderInfoLog(s)}`;throw new Error(a)}if(n.deleteShader(s),!n.getProgramParameter(o,n.LINK_STATUS)){const a=`GL program linking failed: ${n.getProgramInfoLog(o)}`;throw new Error(a)}return o}getUniformLocation(e){const r=V(this.currentProgram_);return this.uniformLocationsByProgram_[r]===void 0&&(this.uniformLocationsByProgram_[r]={}),this.uniformLocationsByProgram_[r][e]===void 0&&(this.uniformLocationsByProgram_[r][e]=this.gl_.getUniformLocation(this.currentProgram_,e)),this.uniformLocationsByProgram_[r][e]}getAttributeLocation(e){const r=V(this.currentProgram_);return this.attribLocationsByProgram_[r]===void 0&&(this.attribLocationsByProgram_[r]={}),this.attribLocationsByProgram_[r][e]===void 0&&(this.attribLocationsByProgram_[r][e]=this.gl_.getAttribLocation(this.currentProgram_,e)),this.attribLocationsByProgram_[r][e]}makeProjectionTransform(e,r){const n=e.size,i=e.viewState.rotation,s=e.viewState.resolution,o=e.viewState.center;return Mr(r,0,0,2/(s*n[0]),2/(s*n[1]),-i,-o[0],-o[1]),r}setUniformFloatValue(e,r){this.gl_.uniform1f(this.getUniformLocation(e),r)}setUniformFloatVec2(e,r){this.gl_.uniform2fv(this.getUniformLocation(e),r)}setUniformFloatVec4(e,r){this.gl_.uniform4fv(this.getUniformLocation(e),r)}setUniformMatrixValue(e,r){this.gl_.uniformMatrix4fv(this.getUniformLocation(e),!1,r)}disableAllAttributes_(){for(let e=0;e<this.maxAttributeCount_;e++)this.gl_.disableVertexAttribArray(e)}enableAttributeArray_(e,r,n,i,s,o){const a=this.getAttributeLocation(e);a<0||(this.gl_.enableVertexAttribArray(a),this.gl_.vertexAttribPointer(a,r,n,!1,i,s),o&&this.getInstancedRenderingExtension_().vertexAttribDivisorANGLE(a,1))}enableAttributes_(e,r){const n=_i(e);let i=0;for(let s=0;s<e.length;s++){const o=e[s];o.name&&this.enableAttributeArray_(o.name,o.size,o.type||Br,n,i,r),i+=o.size*$r(o.type)}}enableAttributes(e){this.enableAttributes_(e,!1)}enableAttributesInstanced(e){this.enableAttributes_(e,!0)}handleWebGLContextLost(e){kn(this.bufferCache_),this.currentProgram_=null,e.preventDefault()}handleWebGLContextRestored(){this.needsToBeRecreated_=!0}needsToBeRecreated(){return this.needsToBeRecreated_}createTexture(e,r,n,i){const s=this.gl_;n=n||s.createTexture();const o=i?s.NEAREST:s.LINEAR;s.bindTexture(s.TEXTURE_2D,n),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,o),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,o),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE);const a=0,c=s.RGBA,l=0,d=s.RGBA,h=s.UNSIGNED_BYTE;return r instanceof Uint8Array?s.texImage2D(s.TEXTURE_2D,a,c,e[0],e[1],l,d,h,r):r?s.texImage2D(s.TEXTURE_2D,a,c,d,h,r):s.texImage2D(s.TEXTURE_2D,a,c,e[0],e[1],l,d,h,null),n}}function _i(t){let e=0;for(let r=0;r<t.length;r++){const n=t[r];e+=n.size*$r(n.type)}return e}function $r(t){switch(t){case Re.UNSIGNED_BYTE:return Uint8Array.BYTES_PER_ELEMENT;case Re.UNSIGNED_SHORT:return Uint16Array.BYTES_PER_ELEMENT;case Re.UNSIGNED_INT:return Uint32Array.BYTES_PER_ELEMENT;case Re.FLOAT:default:return Float32Array.BYTES_PER_ELEMENT}}class Ti extends jn{constructor(e){super(),this.tile,this.handleTileChange_=this.handleTileChange_.bind(this),this.gutter=e.gutter||0,this.helper=e.helper,this.loaded=!1,this.ready=!1}setTile(e){if(e!==this.tile)if(this.tile&&this.tile.removeEventListener(_e.CHANGE,this.handleTileChange_),this.tile=e,this.loaded=e.getState()===G.LOADED,this.loaded)this.uploadTile();else{if(e instanceof Ur){const r=e.getImage();r instanceof Image&&!r.crossOrigin&&(r.crossOrigin="anonymous")}e.addEventListener(_e.CHANGE,this.handleTileChange_)}}uploadTile(){Or()}setReady(){this.ready=!0,this.dispatchEvent(_e.CHANGE)}handleTileChange_(){this.tile.getState()===G.LOADED&&(this.loaded=!0,this.uploadTile())}setHelper(e){this.helper=e,this.helper&&this.loaded&&this.uploadTile()}disposeInternal(){this.setHelper(null),this.tile.removeEventListener(_e.CHANGE,this.handleTileChange_)}}function kr(t,e,r){const n=r?t.LINEAR:t.NEAREST;t.bindTexture(t.TEXTURE_2D,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,n),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,n)}function Ei(t,e,r,n){kr(t,e,n),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,r)}function ar(t,e,r,n,i,s){const o=t.getGL();let a,c;r instanceof Float32Array?(a=o.FLOAT,t.getExtension("OES_texture_float"),c=t.getExtension("OES_texture_float_linear")!==null):(a=o.UNSIGNED_BYTE,c=!0),kr(o,e,s&&c);const l=r.byteLength/n[1];let d=1;l%8===0?d=8:l%4===0?d=4:l%2===0&&(d=2);let h;switch(i){case 1:{h=o.LUMINANCE;break}case 2:{h=o.LUMINANCE_ALPHA;break}case 3:{h=o.RGB;break}case 4:{h=o.RGBA;break}default:throw new Error(`Unsupported number of bands: ${i}`)}const f=o.getParameter(o.UNPACK_ALIGNMENT);o.pixelStorei(o.UNPACK_ALIGNMENT,d),o.texImage2D(o.TEXTURE_2D,0,h,n[0],n[1],0,h,a,r),o.pixelStorei(o.UNPACK_ALIGNMENT,f)}let fe=null;function pi(){fe=Pr(1,1,void 0,{willReadFrequently:!0})}class gi extends Ti{constructor(e){super(e),this.textures=[],this.renderSize_=ie(e.grid.getTileSize(e.tile.tileCoord[0])),this.bandCount=NaN;const r=new Xr(Lt,St);r.fromArray([0,1,1,1,1,0,0,0]),this.helper.flushBufferData(r),this.coords=r,this.setTile(e.tile)}setHelper(e){var n;const r=(n=this.helper)==null?void 0:n.getGL();if(r){this.helper.deleteBuffer(this.coords);for(let i=0;i<this.textures.length;++i)r.deleteTexture(this.textures[i])}super.setHelper(e),e&&e.flushBufferData(this.coords)}uploadTile(){const e=this.helper,r=e.getGL(),n=this.tile;this.textures.length=0;let i;n instanceof Ur||n instanceof _n?i=n.getImage():i=n.getData();const s=ft(i);if(s){const p=r.createTexture();this.textures.push(p),this.bandCount=4,Ei(r,p,s,n.interpolate),this.setReady();return}i=_t(i);const o=n.getSize(),a=[o[0]+2*this.gutter,o[1]+2*this.gutter],c=i instanceof Float32Array,l=a[0]*a[1],d=c?Float32Array:Uint8Array,h=d.BYTES_PER_ELEMENT,f=i.byteLength/a[1];this.bandCount=Math.floor(f/h/a[0]);const _=Math.ceil(this.bandCount/4);if(_===1){const p=r.createTexture();this.textures.push(p),ar(e,p,i,a,this.bandCount,n.interpolate),this.setReady();return}const u=new Array(_);for(let p=0;p<_;++p){const b=r.createTexture();this.textures.push(b);const g=p<_-1?4:(this.bandCount-1)%4+1;u[p]=new d(l*g)}let E=0,y=0;const m=a[0]*this.bandCount;for(let p=0;p<a[1];++p){for(let b=0;b<m;++b){const g=i[y+b],R=Math.floor(E/this.bandCount),T=b%this.bandCount,v=Math.floor(T/4),A=u[v],U=A.length/l,x=T%4;A[R*U+x]=g,++E}y+=f/h}for(let p=0;p<_;++p){const b=this.textures[p],g=u[p],R=g.length/l;ar(e,b,g,a,R,n.interpolate)}this.setReady()}getImagePixelData_(e,r,n){const i=this.gutter,s=this.renderSize_[0],o=this.renderSize_[1];fe||pi(),fe.clearRect(0,0,1,1);const a=e.width,c=e.height,l=a-2*i,d=c-2*i,h=i+Math.floor(l*(r/s)),f=i+Math.floor(d*(n/o));let _;try{fe.drawImage(e,h,f,1,1,0,0,1,1),_=fe.getImageData(0,0,1,1).data}catch{return fe=null,null}return _}getArrayPixelData_(e,r,n,i){const s=this.gutter,o=this.renderSize_[0],a=this.renderSize_[1],c=r[0],l=r[1],d=c+2*s,h=l+2*s,f=s+Math.floor(c*(n/o)),_=s+Math.floor(l*(i/a));if(e instanceof DataView){const E=e.byteLength/(d*h),y=E*(_*d+f),m=e.buffer.slice(y,y+E);return new DataView(m)}const u=this.bandCount*(_*d+f);return e.slice(u,u+this.bandCount)}getPixelData(e,r){if(!this.loaded)return null;if(this.tile instanceof vt){const n=this.tile.getData(),i=_t(n);if(i){const s=this.tile.getSize();return this.getArrayPixelData_(i,s,e,r)}return this.getImagePixelData_(ft(n),e,r)}return this.getImagePixelData_(this.tile.getImage(),e,r)}}class Ut extends qn{constructor(e,r){super(e),r=r||{},this.inversePixelTransform_=We(),this.postProcesses_=r.postProcesses,this.uniforms_=r.uniforms,this.helper,this.onMapChanged_=()=>{this.clearCache(),this.removeHelper()},e.addChangeListener(ht.MAP,this.onMapChanged_),this.dispatchPreComposeEvent=this.dispatchPreComposeEvent.bind(this),this.dispatchPostComposeEvent=this.dispatchPostComposeEvent.bind(this)}dispatchPreComposeEvent(e,r){const n=this.getLayer();if(n.hasListener(ue.PRECOMPOSE)){const i=new st(ue.PRECOMPOSE,void 0,r,e);n.dispatchEvent(i)}}dispatchPostComposeEvent(e,r){const n=this.getLayer();if(n.hasListener(ue.POSTCOMPOSE)){const i=new st(ue.POSTCOMPOSE,void 0,r,e);n.dispatchEvent(i)}}reset(e){this.uniforms_=e.uniforms,this.helper&&this.helper.setUniforms(this.uniforms_)}removeHelper(){this.helper&&(this.helper.dispose(),delete this.helper)}prepareFrame(e){if(this.getLayer().getRenderSource()){let r=!0,n=-1,i;for(let o=0,a=e.layerStatesArray.length;o<a;o++){const c=e.layerStatesArray[o].layer,l=c.getRenderer();if(!(l instanceof Ut)){r=!0;continue}const d=c.getClassName();if((r||d!==i)&&(n+=1,r=!1),i=d,l===this)break}const s="map/"+e.mapId+"/group/"+n;(!this.helper||!this.helper.canvasCacheKeyMatches(s)||this.helper.needsToBeRecreated())&&(this.removeHelper(),this.helper=new fi({postProcesses:this.postProcesses_,uniforms:this.uniforms_,canvasCacheKey:s}),i&&(this.helper.getCanvas().className=i),this.afterHelperCreated())}return this.prepareFrameInternal(e)}afterHelperCreated(){}prepareFrameInternal(e){return!0}clearCache(){}disposeInternal(){var e;this.clearCache(),this.removeHelper(),(e=this.getLayer())==null||e.removeChangeListener(ht.MAP,this.onMapChanged_),super.disposeInternal()}dispatchRenderEvent_(e,r,n){const i=this.getLayer();if(i.hasListener(e)){Mr(this.inversePixelTransform_,0,0,n.pixelRatio,-n.pixelRatio,0,0,-n.size[1]);const s=new st(e,this.inversePixelTransform_,n,r);i.dispatchEvent(s)}}preRender(e,r){this.dispatchRenderEvent_(ue.PRERENDER,e,r)}postRender(e,r){this.dispatchRenderEvent_(ue.POSTRENDER,e,r)}}const mi={TILE_TRANSFORM:"u_tileTransform",TRANSITION_ALPHA:"u_transitionAlpha",DEPTH:"u_depth",RENDER_EXTENT:"u_renderExtent",PATTERN_ORIGIN:"u_patternOrigin",RESOLUTION:"u_resolution",ZOOM:"u_zoom",GLOBAL_ALPHA:"u_globalAlpha",PROJECTION_MATRIX:"u_projectionMatrix",SCREEN_TO_WORLD_MATRIX:"u_screenToWorldMatrix"};function cr(t){return 1/(t+2)}function Ri(){return{tileIds:new Set,representationsByZ:{}}}function lr(t,e){return t.tileIds.has(V(e))}function ur(t,e,r){const n=t.representationsByZ;r in n||(n[r]=new Set),n[r].add(e),t.tileIds.add(V(e.tile))}function at(t,e){const r=t.layerStatesArray[t.layerIndex];r.extent&&(e=ne(e,Fr(r.extent,t.viewState.projection)));const n=r.layer.getRenderSource();if(!n.getWrapX()){const i=n.getTileGridForProjection(t.viewState.projection).getExtent();i&&(e=ne(e,i))}return e}function Et(t,e){return`${V(t)},${t.getKey()},${de(e)}`}class xi extends Ut{constructor(e,r){super(e,{uniforms:r.uniforms,postProcesses:r.postProcesses}),this.renderComplete=!1,this.tileTransform_=We(),this.tempMat4=ge(),this.tempTileRange_=new Tn(0,0,0,0),this.tempTileCoord_=Vt(0,0,0),this.tempSize_=[0,0];const n=r.cacheSize!==void 0?r.cacheSize:512;this.tileRepresentationCache=new Jn(n),this.frameState=null,this.renderedProjection_=void 0}reset(e){super.reset({uniforms:e.uniforms})}prepareFrameInternal(e){this.renderedProjection_?e.viewState.projection!==this.renderedProjection_&&(this.clearCache(),this.renderedProjection_=e.viewState.projection):this.renderedProjection_=e.viewState.projection;const n=this.getLayer().getRenderSource();return!n||Pn(at(e,e.extent))?!1:n.getState()==="ready"}createTileRepresentation(e){return Or()}enqueueTiles(e,r,n,i,s){const o=e.viewState,a=this.getLayer(),c=a.getRenderSource(),l=c.getTileGridForProjection(o.projection),d=c.getGutterForProjection(o.projection),h=V(c);h in e.wantedTiles||(e.wantedTiles[h]={});const f=e.wantedTiles[h],_=this.tileRepresentationCache,u=a.getMapInternal(),E=Math.max(n-s,l.getMinZoom(),l.getZForResolution(Math.min(a.getMaxResolution(),u?u.getView().getResolutionForZoom(Math.max(a.getMinZoom(),0)):l.getResolution(0)),c.zDirection)),y=o.rotation,m=y?In(o.center,o.resolution,y,e.size):void 0;for(let p=n;p>=E;--p){const b=l.getTileRangeForExtentAndZ(r,p,this.tempTileRange_),g=l.getResolution(p);for(let R=b.minX;R<=b.maxX;++R)for(let T=b.minY;T<=b.maxY;++T){if(y&&!l.tileCoordIntersectsViewport([p,R,T],m))continue;const v=Vt(p,R,T,this.tempTileCoord_),A=Et(c,v);let U,x;if(_.containsKey(A)&&(U=_.get(A),x=U.tile),(!U||U.tile.key!==c.getKey())&&(x=c.getTile(p,R,T,e.pixelRatio,o.projection),!x)||lr(i,x))continue;U?U.setTile(x):(U=this.createTileRepresentation({tile:x,grid:l,helper:this.helper,gutter:d}),_.set(A,U)),ur(i,U,p);const P=x.getKey();f[P]=!0,x.getState()===G.IDLE&&(e.tileQueue.isKeyQueued(P)||e.tileQueue.enqueue([x,h,l.getTileCoordCenter(v),g]))}}}beforeTilesRender(e,r){this.helper.prepareDraw(this.frameState,!r,!0)}beforeTilesMaskRender(e){return!1}renderTile(e,r,n,i,s,o,a,c,l,d,h){}renderTileMask(e,r,n,i){}drawTile_(e,r,n,i,s,o,a){if(!r.ready)return;const l=r.tile.tileCoord,d=de(l),h=d in o?o[d]:1,f=a.getResolution(n),_=ie(a.getTileSize(n),this.tempSize_),u=a.getOrigin(n),E=a.getTileCoordExtent(l),y=h<1?-1:cr(n);h<1&&(e.animate=!0);const m=e.viewState,p=m.center[0],b=m.center[1],g=_[0]+2*i,R=_[1]+2*i,T=g/R,v=(p-u[0])/(_[0]*f),A=(u[1]-b)/(_[1]*f),U=m.resolution/f,x=l[1],P=l[2];zn(this.tileTransform_),er(this.tileTransform_,2/(e.size[0]*U/g),-2/(e.size[1]*U/g)),Hn(this.tileTransform_,m.rotation),er(this.tileTransform_,1,1/T),Wn(this.tileTransform_,(_[0]*(x-v)-i)/g,(_[1]*(P-A)-i)/R),this.renderTile(r,this.tileTransform_,e,s,f,_,u,E,y,i,h)}renderFrame(e){this.frameState=e,this.renderComplete=!0;const r=this.helper.getGL();this.preRender(r,e);const n=e.viewState,i=this.getLayer(),s=i.getRenderSource(),o=s.getTileGridForProjection(n.projection),a=s.getGutterForProjection(n.projection),c=at(e,e.extent),l=o.getZForResolution(n.resolution,s.zDirection),d=Ri(),h=i.getPreload();if(e.nextExtent){const b=o.getZForResolution(n.nextResolution,s.zDirection),g=at(e,e.nextExtent);this.enqueueTiles(e,g,b,d,h)}this.enqueueTiles(e,c,l,d,0),h>0&&setTimeout(()=>{this.enqueueTiles(e,c,l-1,d,h-1)},0);const f={};let _=!1;const u=d.representationsByZ;if(l in u){const b=V(this),g=e.time;for(const R of u[l]){const T=R.tile;if(T.getState()===G.EMPTY)continue;const v=T.tileCoord;if(R.ready){const x=T.getAlpha(b,g);if(x===1){T.endTransition(b);continue}_=!0;const P=de(v);f[P]=x}if(this.renderComplete=!1,this.findAltTiles_(o,v,l+1,d))continue;const U=o.getMinZoom();for(let x=l-1;x>=U&&!this.findAltTiles_(o,v,x,d);--x);}}const E=Object.keys(u).map(Number).sort(Yn);if(this.beforeTilesMaskRender(e))for(let b=0,g=E.length;b<g;++b){const R=E[b];for(const T of u[R]){const v=T.tile.tileCoord;if(de(v)in f)continue;const U=o.getTileCoordExtent(v);this.renderTileMask(T,R,U,cr(R))}}this.beforeTilesRender(e,_);for(let b=0,g=E.length;b<g;++b){const R=E[b];for(const T of u[R]){const v=T.tile.tileCoord;de(v)in f||this.drawTile_(e,T,R,a,c,f,o)}}if(l in u)for(const b of u[l]){const g=b.tile.tileCoord;de(g)in f&&this.drawTile_(e,b,l,a,c,f,o)}this.beforeFinalize(e),this.helper.finalizeDraw(e,this.dispatchPreComposeEvent,this.dispatchPostComposeEvent);const m=this.helper.getCanvas();return this.tileRepresentationCache.expireCache(),this.postRender(r,e),m}beforeFinalize(e){}findAltTiles_(e,r,n,i){const s=e.getTileRangeForTileCoordAndZ(r,n,this.tempTileRange_);if(!s)return!1;let o=!0;const a=this.tileRepresentationCache,c=this.getLayer().getRenderSource();for(let l=s.minX;l<=s.maxX;++l)for(let d=s.minY;d<=s.maxY;++d){const h=Et(c,[n,l,d]);let f=!1;if(a.containsKey(h)){const _=a.get(h);_.ready&&!lr(i,_.tile)&&(ur(i,_,n),f=!0)}f||(o=!1)}return o}clearCache(){super.clearCache();const e=this.tileRepresentationCache;e.forEach(r=>r.dispose()),e.clear()}afterHelperCreated(){super.afterHelperCreated(),this.tileRepresentationCache.forEach(e=>e.setHelper(this.helper))}disposeInternal(){super.disposeInternal(),delete this.frameState}}const L={...mi,TILE_TEXTURE_ARRAY:"u_tileTextures",TEXTURE_PIXEL_WIDTH:"u_texturePixelWidth",TEXTURE_PIXEL_HEIGHT:"u_texturePixelHeight",TEXTURE_RESOLUTION:"u_textureResolution",TEXTURE_ORIGIN_X:"u_textureOriginX",TEXTURE_ORIGIN_Y:"u_textureOriginY"},je={TEXTURE_COORD:"a_textureCoord"},yi=[{name:je.TEXTURE_COORD,size:2,type:Re.FLOAT}];class bi extends xi{constructor(e,r){super(e,r),this.program_,this.vertexShader_=r.vertexShader,this.fragmentShader_=r.fragmentShader,this.indices_=new Xr(Ct,St),this.indices_.fromArray([0,1,3,1,2,3]),this.paletteTextures_=r.paletteTextures||[]}reset(e){if(super.reset(e),this.helper){const r=this.helper.getGL();for(const n of this.paletteTextures_)n.delete(r)}if(this.vertexShader_=e.vertexShader,this.fragmentShader_=e.fragmentShader,this.paletteTextures_=e.paletteTextures||[],this.helper){this.program_=this.helper.getProgram(this.fragmentShader_,this.vertexShader_);const r=this.helper.getGL();for(const n of this.paletteTextures_)n.getTexture(r)}}afterHelperCreated(){super.afterHelperCreated();const e=this.helper.getGL();for(const r of this.paletteTextures_)r.getTexture(e);this.program_=this.helper.getProgram(this.fragmentShader_,this.vertexShader_),this.helper.flushBufferData(this.indices_)}removeHelper(){if(this.helper){const e=this.helper.getGL();for(const r of this.paletteTextures_)r.delete(e)}super.removeHelper()}createTileRepresentation(e){return new gi(e)}beforeTilesRender(e,r){super.beforeTilesRender(e,r),this.helper.useProgram(this.program_,e)}renderTile(e,r,n,i,s,o,a,c,l,d,h){const f=this.helper.getGL();this.helper.bindBuffer(e.coords),this.helper.bindBuffer(this.indices_),this.helper.enableAttributes(yi);let _=0;for(;_<e.textures.length;){const T=`${L.TILE_TEXTURE_ARRAY}[${_}]`;this.helper.bindTexture(e.textures[_],_,T),++_}for(let T=0;T<this.paletteTextures_.length;++T){const v=this.paletteTextures_[T],A=v.getTexture(f);this.helper.bindTexture(A,_,v.name),++_}const u=n.viewState,E=o[0]+2*d,y=o[1]+2*d,p=e.tile.tileCoord,b=p[1],g=p[2];this.helper.setUniformMatrixValue(L.TILE_TRANSFORM,Gr(this.tempMat4,r)),this.helper.setUniformFloatValue(L.TRANSITION_ALPHA,h),this.helper.setUniformFloatValue(L.DEPTH,l);let R=i;d>0&&(R=c,ne(R,i,R)),this.helper.setUniformFloatVec4(L.RENDER_EXTENT,R),this.helper.setUniformFloatValue(L.RESOLUTION,u.resolution),this.helper.setUniformFloatValue(L.ZOOM,u.zoom),this.helper.setUniformFloatValue(L.TEXTURE_PIXEL_WIDTH,E),this.helper.setUniformFloatValue(L.TEXTURE_PIXEL_HEIGHT,y),this.helper.setUniformFloatValue(L.TEXTURE_RESOLUTION,s),this.helper.setUniformFloatValue(L.TEXTURE_ORIGIN_X,a[0]+b*o[0]*s-d*s),this.helper.setUniformFloatValue(L.TEXTURE_ORIGIN_Y,a[1]-g*o[1]*s+d*s),this.helper.drawElements(0,this.indices_.getSize())}getData(e){if(!this.helper.getGL())return null;const n=this.frameState;if(!n)return null;const i=this.getLayer(),s=Vn(n.pixelToCoordinateTransform,e.slice()),o=n.viewState,a=i.getExtent();if(a&&!Zt(Fr(a,o.projection),s))return null;const c=i.getSources(Dn([s]),o.resolution);let l,d,h;for(l=c.length-1;l>=0;--l)if(d=c[l],d.getState()==="ready"){if(h=d.getTileGridForProjection(o.projection),d.getWrapX())break;const _=h.getExtent();if(!_||Zt(_,s))break}if(l<0)return null;const f=this.tileRepresentationCache;for(let _=h.getZForResolution(o.resolution);_>=h.getMinZoom();--_){const u=h.getTileCoordForCoordAndZ(s,_),E=Et(d,u);if(!f.containsKey(E))continue;const y=f.get(E);if(y.tile.getState()===G.EMPTY)return null;if(!y.loaded)continue;const p=h.getOrigin(_),b=ie(h.getTileSize(_)),g=h.getResolution(_),R=(s[0]-p[0])/g-u[1]*b[0],T=(p[1]-s[1])/g-u[2]*b[1];return y.getPixelData(R,T)}return null}disposeInternal(){const e=this.helper;if(e){const r=e.getGL();for(const n of this.paletteTextures_)n.delete(r);this.paletteTextures_.length=0,r.deleteProgram(this.program_),delete this.program_,e.deleteBuffer(this.indices_)}super.disposeInternal(),delete this.indices_}}class Ai{constructor(e,r){this.name=e,this.data=r,this.texture_=null}getTexture(e){if(!this.texture_){const r=e.createTexture();e.bindTexture(e.TEXTURE_2D,r),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,this.data.length/4,1,0,e.RGBA,e.UNSIGNED_BYTE,this.data),this.texture_=r}return this.texture_}delete(e){this.texture_&&e.deleteTexture(this.texture_),this.texture_=null}}function vi(t,e){return`operator_${t}_${Object.keys(e.functions).length}`}function ye(t){const e=t.toString();return e.includes(".")?e:e+".0"}function Pt(t){if(t.length<2||t.length>4)throw new Error("`formatArray` can only output `vec2`, `vec3` or `vec4` arrays.");return`vec${t.length}(${t.map(ye).join(", ")})`}function wi(t){const e=Me(t),r=e.length>3?e[3]:1;return Pt([e[0]/255,e[1]/255,e[2]/255,r])}function Li(t){const e=ie(t);return Pt(e)}const ct={};let Ci=0;function qe(t){return t in ct||(ct[t]=Ci++),ct[t]}function Si(t){return ye(qe(t))}function Je(t){return"u_var_"+t}function Ui(){return{variables:{},properties:{},functions:{},bandCount:0,featureId:!1,geometryType:!1}}const lt="getBandValue",jr="u_paletteTextures",Pi="featureId",Ii="geometryType",Di=-9999999;function Fi(t,e,r,n){const i=En(t,e,r);return It(i,e,n)}function D(t){return(e,r,n)=>{const i=r.args.length,s=new Array(i);for(let o=0;o<i;++o)s[o]=It(r.args[o],n,e);return t(s,e)}}const Ni={[S.Get]:(t,e)=>{const n=e.args[0].value;n in t.properties||(t.properties[n]={name:n,type:e.type});let s="a_prop_"+n;return Kt(e.type,dt)&&(s=`(${s} > 0.0)`),s},[S.Id]:t=>(t.featureId=!0,"a_"+Pi),[S.GeometryType]:t=>(t.geometryType=!0,"a_"+Ii),[S.LineMetric]:()=>"currentLineMetric",[S.Var]:(t,e)=>{const n=e.args[0].value;n in t.variables||(t.variables[n]={name:n,type:e.type});let s=Je(n);return Kt(e.type,dt)&&(s=`(${s} > 0.0)`),s},[S.Has]:(t,e)=>{const n=e.args[0].value;return n in t.properties||(t.properties[n]={name:n,type:e.type}),`(a_prop_${n} != ${ye(Di)})`},[S.Resolution]:()=>"u_resolution",[S.Zoom]:()=>"u_zoom",[S.Time]:()=>"u_time",[S.Any]:D(t=>`(${t.join(" || ")})`),[S.All]:D(t=>`(${t.join(" && ")})`),[S.Not]:D(([t])=>`(!${t})`),[S.Equal]:D(([t,e])=>`(${t} == ${e})`),[S.NotEqual]:D(([t,e])=>`(${t} != ${e})`),[S.GreaterThan]:D(([t,e])=>`(${t} > ${e})`),[S.GreaterThanOrEqualTo]:D(([t,e])=>`(${t} >= ${e})`),[S.LessThan]:D(([t,e])=>`(${t} < ${e})`),[S.LessThanOrEqualTo]:D(([t,e])=>`(${t} <= ${e})`),[S.Multiply]:D(t=>`(${t.join(" * ")})`),[S.Divide]:D(([t,e])=>`(${t} / ${e})`),[S.Add]:D(t=>`(${t.join(" + ")})`),[S.Subtract]:D(([t,e])=>`(${t} - ${e})`),[S.Clamp]:D(([t,e,r])=>`clamp(${t}, ${e}, ${r})`),[S.Mod]:D(([t,e])=>`mod(${t}, ${e})`),[S.Pow]:D(([t,e])=>`pow(${t}, ${e})`),[S.Abs]:D(([t])=>`abs(${t})`),[S.Floor]:D(([t])=>`floor(${t})`),[S.Ceil]:D(([t])=>`ceil(${t})`),[S.Round]:D(([t])=>`floor(${t} + 0.5)`),[S.Sin]:D(([t])=>`sin(${t})`),[S.Cos]:D(([t])=>`cos(${t})`),[S.Atan]:D(([t,e])=>e!==void 0?`atan(${t}, ${e})`:`atan(${t})`),[S.Sqrt]:D(([t])=>`sqrt(${t})`),[S.Match]:D(t=>{const e=t[0],r=t[t.length-1];let n=null;for(let i=t.length-3;i>=1;i-=2){const s=t[i],o=t[i+1];n=`(${e} == ${s} ? ${o} : ${n||r})`}return n}),[S.Between]:D(([t,e,r])=>`(${t} >= ${e} && ${t} <= ${r})`),[S.Interpolate]:D(([t,e,...r])=>{let n="";for(let i=0;i<r.length-2;i+=2){const s=r[i],o=n||r[i+1],a=r[i+2],c=r[i+3];let l;t===ye(1)?l=`(${e} - ${s}) / (${a} - ${s})`:l=`(pow(${t}, (${e} - ${s})) - 1.0) / (pow(${t}, (${a} - ${s})) - 1.0)`,n=`mix(${o}, ${c}, clamp(${l}, 0.0, 1.0))`}return n}),[S.Case]:D(t=>{const e=t[t.length-1];let r=null;for(let n=t.length-3;n>=0;n-=2){const i=t[n],s=t[n+1];r=`(${i} ? ${s} : ${r||e})`}return r}),[S.In]:D(([t,...e],r)=>{const n=vi("in",r),i=[];for(let s=0;s<e.length;s+=1)i.push(`  if (inputValue == ${e[s]}) { return true; }`);return r.functions[n]=`bool ${n}(float inputValue) {
${i.join(`
`)}
  return false;
}`,`${n}(${t})`}),[S.Array]:D(t=>`vec${t.length}(${t.join(", ")})`),[S.Color]:D(t=>{if(t.length===1)return`vec4(vec3(${t[0]} / 255.0), 1.0)`;if(t.length===2)return`vec4(vec3(${t[0]} / 255.0), ${t[1]})`;const e=t.slice(0,3).map(n=>`${n} / 255.0`);if(t.length===3)return`vec4(${e.join(", ")}, 1.0)`;const r=t[3];return`vec4(${e.join(", ")}, ${r})`}),[S.Band]:D(([t,e,r],n)=>{if(!(lt in n.functions)){let i="";const s=n.bandCount||1;for(let o=0;o<s;o++){const a=Math.floor(o/4);let c=o%4;o===s-1&&c===1&&(c=3);const l=`${L.TILE_TEXTURE_ARRAY}[${a}]`;i+=`  if (band == ${o+1}.0) {
    return texture2D(${l}, v_textureCoord + vec2(dx, dy))[${c}];
  }
`}n.functions[lt]=`float getBandValue(float band, float xOffset, float yOffset) {
  float dx = xOffset / ${L.TEXTURE_PIXEL_WIDTH};
  float dy = yOffset / ${L.TEXTURE_PIXEL_HEIGHT};
${i}
}`}return`${lt}(${t}, ${e??"0.0"}, ${r??"0.0"})`}),[S.Palette]:(t,e)=>{const[r,...n]=e.args,i=n.length,s=new Uint8Array(i*4);for(let l=0;l<n.length;l++){const d=n[l].value,h=Me(d),f=l*4;s[f]=h[0],s[f+1]=h[1],s[f+2]=h[2],s[f+3]=h[3]*255}t.paletteTextures||(t.paletteTextures=[]);const o=`${jr}[${t.paletteTextures.length}]`,a=new Ai(o,s);t.paletteTextures.push(a);const c=It(r,oe,t);return`texture2D(${o}, vec2((${c} + 0.5) / ${i}.0, 0.5))`}};function It(t,e,r){if(t instanceof pn){const n=Ni[t.operator];if(n===void 0)throw new Error(`No compiler defined for this operator: ${JSON.stringify(t.operator)}`);return n(r,t,e)}if((t.type&oe)>0)return ye(t.value);if((t.type&dt)>0)return t.value.toString();if((t.type&gn)>0)return Si(t.value.toString());if((t.type&ce)>0)return wi(t.value);if((t.type&Ir)>0)return Pt(t.value);if((t.type&Dr)>0)return Li(t.value);throw new Error(`Unexpected expression ${t.value} (expected type ${mn(e)})`)}function he(t,e,r){const n=Rn();return Fi(e,r,n,t)}function Mi(t){const e=Me(t),r=e[0]*256,n=e[1],i=e[2]*256,s=Math.round(e[3]*255);return[r+n,i+s]}const oo=`vec4 unpackColor(vec2 packedColor) {
  return vec4(
    min(floor(packedColor[0] / 256.0) / 255.0, 1.0),
    min(mod(packedColor[0], 256.0) / 255.0, 1.0),
    min(floor(packedColor[1] / 256.0) / 255.0, 1.0),
    min(mod(packedColor[1], 256.0) / 255.0, 1.0)
  );
}`;function zr(t){return t===ce||t===Dr?2:t===Ir?4:1}function hr(t){const e=zr(t);return e>1?`vec${e}`:"float"}function ao(t,e){for(const r in e.variables){const n=e.variables[r],i=Je(n.name);let s=hr(n.type);n.type===ce&&(s="vec4"),t.addUniform(i,s)}for(const r in e.properties){const n=e.properties[r],i=hr(n.type),s=`a_prop_${n.name}`;n.type===ce?t.addAttribute(s,i,`unpackColor(${s})`,"vec4"):t.addAttribute(s,i)}for(const r in e.functions)t.addVertexShaderFunction(e.functions[r]),t.addFragmentShaderFunction(e.functions[r])}function co(t,e){const r={};for(const n in t.variables){const i=t.variables[n],s=Je(i.name);r[s]=()=>{const o=e[i.name];if(typeof o=="number")return o;if(typeof o=="boolean")return o?1:0;if(i.type===ce){const a=[...Me(o||"#eee")];return a[0]/=255,a[1]/=255,a[2]/=255,a[3]??(a[3]=1),a}return typeof o=="string"?qe(o):o}}return r}function lo(t){const e={};for(const r in t.properties){const n=t.properties[r],i=s=>{const o=s.get(n.name);return n.type===ce?Mi([...Me(o||"#eee")]):typeof o=="string"?qe(o):typeof o=="boolean"?o?1:0:o};e[`prop_${n.name}`]={size:zr(n.type),callback:i}}return e}function dr(t,e){const r=`
    attribute vec2 ${je.TEXTURE_COORD};
    uniform mat4 ${L.TILE_TRANSFORM};
    uniform float ${L.TEXTURE_PIXEL_WIDTH};
    uniform float ${L.TEXTURE_PIXEL_HEIGHT};
    uniform float ${L.TEXTURE_RESOLUTION};
    uniform float ${L.TEXTURE_ORIGIN_X};
    uniform float ${L.TEXTURE_ORIGIN_Y};
    uniform float ${L.DEPTH};

    varying vec2 v_textureCoord;
    varying vec2 v_mapCoord;

    void main() {
      v_textureCoord = ${je.TEXTURE_COORD};
      v_mapCoord = vec2(
        ${L.TEXTURE_ORIGIN_X} + ${L.TEXTURE_RESOLUTION} * ${L.TEXTURE_PIXEL_WIDTH} * v_textureCoord[0],
        ${L.TEXTURE_ORIGIN_Y} - ${L.TEXTURE_RESOLUTION} * ${L.TEXTURE_PIXEL_HEIGHT} * v_textureCoord[1]
      );
      gl_Position = ${L.TILE_TRANSFORM} * vec4(${je.TEXTURE_COORD}, ${L.DEPTH}, 1.0);
    }
  `,n={...Ui(),bandCount:e},i=[];if(t.color!==void 0){const h=he(n,t.color,ce);i.push(`color = ${h};`)}if(t.contrast!==void 0){const h=he(n,t.contrast,oe);i.push(`color.rgb = clamp((${h} + 1.0) * color.rgb - (${h} / 2.0), vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0));`)}if(t.exposure!==void 0){const h=he(n,t.exposure,oe);i.push(`color.rgb = clamp((${h} + 1.0) * color.rgb, vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0));`)}if(t.saturation!==void 0){const h=he(n,t.saturation,oe);i.push(`
      float saturation = ${h} + 1.0;
      float sr = (1.0 - saturation) * 0.2126;
      float sg = (1.0 - saturation) * 0.7152;
      float sb = (1.0 - saturation) * 0.0722;
      mat3 saturationMatrix = mat3(
        sr + saturation, sr, sr,
        sg, sg + saturation, sg,
        sb, sb, sb + saturation
      );
      color.rgb = clamp(saturationMatrix * color.rgb, vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0));
    `)}if(t.gamma!==void 0){const h=he(n,t.gamma,oe);i.push(`color.rgb = pow(color.rgb, vec3(1.0 / ${h}));`)}if(t.brightness!==void 0){const h=he(n,t.brightness,oe);i.push(`color.rgb = clamp(color.rgb + ${h}, vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0));`)}const s={},o=Object.keys(n.variables).length;if(o>1&&!t.variables)throw new Error(`Missing variables in style (expected ${n.variables})`);for(let h=0;h<o;++h){const f=n.variables[Object.keys(n.variables)[h]];if(!(f.name in t.variables))throw new Error(`Missing '${f.name}' in style variables`);const _=Je(f.name);s[_]=function(){let u=t.variables[f.name];return typeof u=="string"&&(u=qe(u)),u!==void 0?u:-9999999}}const a=Object.keys(s).map(function(h){return`uniform float ${h};`}),c=Math.ceil(e/4);a.push(`uniform sampler2D ${L.TILE_TEXTURE_ARRAY}[${c}];`),n.paletteTextures&&a.push(`uniform sampler2D ${jr}[${n.paletteTextures.length}];`);const l=Object.keys(n.functions).map(function(h){return n.functions[h]}),d=`
    #ifdef GL_FRAGMENT_PRECISION_HIGH
    precision highp float;
    #else
    precision mediump float;
    #endif

    varying vec2 v_textureCoord;
    varying vec2 v_mapCoord;
    uniform vec4 ${L.RENDER_EXTENT};
    uniform float ${L.TRANSITION_ALPHA};
    uniform float ${L.TEXTURE_PIXEL_WIDTH};
    uniform float ${L.TEXTURE_PIXEL_HEIGHT};
    uniform float ${L.RESOLUTION};
    uniform float ${L.ZOOM};

    ${a.join(`
`)}

    ${l.join(`
`)}

    void main() {
      if (
        v_mapCoord[0] < ${L.RENDER_EXTENT}[0] ||
        v_mapCoord[1] < ${L.RENDER_EXTENT}[1] ||
        v_mapCoord[0] > ${L.RENDER_EXTENT}[2] ||
        v_mapCoord[1] > ${L.RENDER_EXTENT}[3]
      ) {
        discard;
      }

      vec4 color = texture2D(${L.TILE_TEXTURE_ARRAY}[0],  v_textureCoord);

      ${i.join(`
`)}

      gl_FragColor = color;
      gl_FragColor.rgb *= gl_FragColor.a;
      gl_FragColor *= ${L.TRANSITION_ALPHA};
    }`;return{vertexShader:r,fragmentShader:d,uniforms:s,paletteTextures:n.paletteTextures}}class Oi extends Qn{constructor(e){e=e?Object.assign({},e):{};const r=e.style||{};delete e.style,super(e),this.sources_=e.sources,this.renderedSource_=null,this.renderedResolution_=NaN,this.style_=r,this.styleVariables_=this.style_.variables||{},this.handleSourceUpdate_(),this.addChangeListener(ht.SOURCE,this.handleSourceUpdate_)}getSources(e,r){const n=this.getSource();return this.sources_?typeof this.sources_=="function"?this.sources_(e,r):this.sources_:n?[n]:[]}getRenderSource(){return this.renderedSource_||this.getSource()}getSourceState(){const e=this.getRenderSource();return e?e.getState():"undefined"}handleSourceUpdate_(){this.hasRenderer()&&this.getRenderer().clearCache();const e=this.getSource();if(e)if(e.getState()==="loading"){const r=()=>{e.getState()==="ready"&&(e.removeEventListener("change",r),this.setStyle(this.style_))};e.addEventListener("change",r)}else this.setStyle(this.style_)}getSourceBandCount_(){const e=Number.MAX_SAFE_INTEGER,r=this.getSources([-e,-e,e,e],e);return r&&r.length&&"bandCount"in r[0]?r[0].bandCount:4}createRenderer(){const e=dr(this.style_,this.getSourceBandCount_());return new bi(this,{vertexShader:e.vertexShader,fragmentShader:e.fragmentShader,uniforms:e.uniforms,cacheSize:this.getCacheSize(),paletteTextures:e.paletteTextures})}renderSources(e,r){const n=this.getRenderer();let i;for(let s=0,o=r.length;s<o;++s)this.renderedSource_=r[s],n.prepareFrame(e)&&(i=n.renderFrame(e));return i}render(e,r){this.rendered=!0;const n=e.viewState,i=this.getSources(e.extent,n.resolution);let s=!0;for(let a=0,c=i.length;a<c;++a){const l=i[a],d=l.getState();if(d=="loading"){const h=()=>{l.getState()=="ready"&&(l.removeEventListener("change",h),this.changed())};l.addEventListener("change",h)}s=s&&d=="ready"}const o=this.renderSources(e,i);if(this.getRenderer().renderComplete&&s)return this.renderedResolution_=n.resolution,o;if(this.renderedResolution_>.5*n.resolution){const a=this.getSources(e.extent,this.renderedResolution_).filter(c=>!i.includes(c));if(a.length>0)return this.renderSources(e,a)}return o}setStyle(e){if(this.styleVariables_=e.variables||{},this.style_=e,this.hasRenderer()){const r=dr(this.style_,this.getSourceBandCount_());this.getRenderer().reset({vertexShader:r.vertexShader,fragmentShader:r.fragmentShader,uniforms:r.uniforms,paletteTextures:r.paletteTextures}),this.changed()}}updateStyleVariables(e){Object.assign(this.styleVariables_,e),this.changed()}}Oi.prototype.dispose;function Hr(t,e,r,n={}){return e!==void 0&&r!==void 0&&(n={...n,headers:{...n.headers,Range:`bytes=${e}-${e+r-1}`}}),fetch(t,n)}function Gi(t,e){return{...t,...e,headers:{...t.headers,...e.headers}}}function fr(t,e){const r=typeof t=="string"?new URL(t):t;r.pathname.endsWith("/")||(r.pathname+="/");const n=new URL(e.slice(1),r);return n.search=r.search,n}async function _r(t){if(t.status!==404){if(t.status===200||t.status===206)return new Uint8Array(await t.arrayBuffer());throw new Error(`Unexpected response status ${t.status} ${t.statusText}`)}}async function Bi(t,e,r,n){if(n)return fetch(t,{...r,headers:{...r.headers,Range:`bytes=-${e}`}});let i=await fetch(t,{...r,method:"HEAD"});if(!i.ok)return i;let s=i.headers.get("Content-Length"),o=Number(s);return Hr(t,o-e,o,r)}var Ae,ve,we,pt;class Xi{constructor(e,r={}){X(this,we);I(this,"url");X(this,Ae);X(this,ve);this.url=e,B(this,Ae,r.overrides??{}),B(this,ve,r.useSuffixRequest??!1)}async get(e,r={}){let n=fr(this.url,e).href,i=await fetch(n,tt(this,we,pt).call(this,r));return _r(i)}async getRange(e,r,n={}){let i=fr(this.url,e),s=tt(this,we,pt).call(this,n),o;return"suffixLength"in r?o=await Bi(i,r.suffixLength,s,C(this,ve)):o=await Hr(i,r.offset,r.length,s),_r(o)}}Ae=new WeakMap,ve=new WeakMap,we=new WeakSet,pt=function(e){return Gi(C(this,Ae),e)};var K;class Wr{constructor(e,r,n){X(this,K);typeof e=="number"?B(this,K,new Uint8Array(e)):e instanceof ArrayBuffer?B(this,K,new Uint8Array(e,r,n)):B(this,K,new Uint8Array(Array.from(e,i=>i?1:0)))}get BYTES_PER_ELEMENT(){return 1}get byteOffset(){return C(this,K).byteOffset}get byteLength(){return C(this,K).byteLength}get buffer(){return C(this,K).buffer}get length(){return C(this,K).length}get(e){let r=C(this,K)[e];return typeof r=="number"?r!==0:r}set(e,r){C(this,K)[e]=r?1:0}fill(e){C(this,K).fill(e?1:0)}*[Symbol.iterator](){for(let e=0;e<this.length;e++)yield this.get(e)}}K=new WeakMap;var Te;class Dt{constructor(e,r,n,i){I(this,"_data");I(this,"chars");X(this,Te);if(this.chars=e,B(this,Te,new TextEncoder),typeof r=="number")this._data=new Uint8Array(r*e);else if(r instanceof ArrayBuffer)i&&(i=i*e),this._data=new Uint8Array(r,n,i);else{let s=Array.from(r);this._data=new Uint8Array(s.length*e);for(let o=0;o<s.length;o++)this.set(o,s[o])}}get BYTES_PER_ELEMENT(){return this.chars}get byteOffset(){return this._data.byteOffset}get byteLength(){return this._data.byteLength}get buffer(){return this._data.buffer}get length(){return this.byteLength/this.BYTES_PER_ELEMENT}get(e){const r=new Uint8Array(this.buffer,this.byteOffset+this.chars*e,this.chars);return new TextDecoder().decode(r).replace(/\x00/g,"")}set(e,r){const n=new Uint8Array(this.buffer,this.byteOffset+this.chars*e,this.chars);n.fill(0),n.set(C(this,Te).encode(r))}fill(e){const r=C(this,Te).encode(e);for(let n=0;n<this.length;n++)this._data.set(r,n*this.chars)}*[Symbol.iterator](){for(let e=0;e<this.length;e++)yield this.get(e)}}Te=new WeakMap;var W;const kt=class kt{constructor(e,r,n,i){X(this,W);I(this,"chars");if(this.chars=e,typeof r=="number")B(this,W,new Int32Array(r*e));else if(r instanceof ArrayBuffer)i&&(i*=e),B(this,W,new Int32Array(r,n,i));else{const s=r,o=new kt(e,1);B(this,W,new Int32Array(function*(){for(let a of s)o.set(0,a),yield*C(o,W)}()))}}get BYTES_PER_ELEMENT(){return C(this,W).BYTES_PER_ELEMENT*this.chars}get byteLength(){return C(this,W).byteLength}get byteOffset(){return C(this,W).byteOffset}get buffer(){return C(this,W).buffer}get length(){return C(this,W).length/this.chars}get(e){const r=this.chars*e;let n="";for(let i=0;i<this.chars;i++)n+=String.fromCodePoint(C(this,W)[r+i]);return n.replace(/\u0000/g,"")}set(e,r){const n=this.chars*e,i=C(this,W).subarray(n,n+this.chars);i.fill(0);for(let s=0;s<this.chars;s++)i[s]=r.codePointAt(s)??0}fill(e){this.set(0,e);let r=C(this,W).subarray(0,this.chars);for(let n=1;n<this.length;n++)C(this,W).set(r,n*this.chars)}*[Symbol.iterator](){for(let e=0;e<this.length;e++)yield this.get(e)}};W=new WeakMap;let be=kt;function Oe(t){const e=new TextDecoder().decode(t);return JSON.parse(e)}function Tr(t,e){const r=e/2,n=e-1;let i=0;for(let s=0;s<t.length;s+=e)for(let o=0;o<r;o+=1)i=t[s+o],t[s+o]=t[s+n-o],t[s+n-o]=i}function Yr(t){if(t==="v2:object")return globalThis.Array;let e=t.match(/v2:([US])(\d+)/);if(e){let[,n,i]=e;return(n==="U"?be:Dt).bind(null,Number(i))}if(t==="string")return globalThis.Array;let r={int8:Int8Array,int16:Int16Array,int32:Int32Array,int64:globalThis.BigInt64Array,uint8:Uint8Array,uint16:Uint16Array,uint32:Uint32Array,uint64:globalThis.BigUint64Array,float16:globalThis.Float16Array,float32:Float32Array,float64:Float64Array,bool:Wr}[t];return j(r,`Unknown or unsupported data_type: ${t}`),r}function le(t,e){const r=t.length;typeof e=="string"&&(e=e==="C"?Array.from({length:r},(s,o)=>o):Array.from({length:r},(s,o)=>r-1-o)),j(r===e.length,"Order length must match the number of dimensions.");let n=1,i=new Array(r);for(let s=e.length-1;s>=0;s--)i[e[s]]=n,n*=t[e[s]];return i}function $i({name:t,configuration:e}){if(t==="default"){const r=(e==null?void 0:e.separator)??"/";return n=>["c",...n].join(r)}if(t==="v2"){const r=(e==null?void 0:e.separator)??".";return n=>n.join(r)||"0"}throw new Error(`Unknown chunk key encoding: ${t}`)}function ki(t){if(t==="|O")return{data_type:"v2:object"};let e=t.match(/^([<|>])(.*)$/);j(e,`Invalid dtype: ${t}`);let[,r,n]=e,i={b1:"bool",i1:"int8",u1:"uint8",i2:"int16",u2:"uint16",i4:"int32",u4:"uint32",i8:"int64",u8:"uint64",f2:"float16",f4:"float32",f8:"float64"}[n]??(n.startsWith("S")||n.startsWith("U")?`v2:${n}`:void 0);return j(i,`Unsupported or unknown dtype: ${t}`),r==="|"?{data_type:i}:{data_type:i,endian:r==="<"?"little":"big"}}function ji(t,e={}){let r=[],n=ki(t.dtype);t.order==="F"&&r.push({name:"transpose",configuration:{order:"F"}}),"endian"in n&&n.endian==="big"&&r.push({name:"bytes",configuration:{endian:"big"}});for(let{id:i,...s}of t.filters??[])r.push({name:i,configuration:s});if(t.compressor){let{id:i,...s}=t.compressor;r.push({name:i,configuration:s})}return{zarr_format:3,node_type:"array",shape:t.shape,data_type:n.data_type,chunk_grid:{name:"regular",configuration:{chunk_shape:t.chunks}},chunk_key_encoding:{name:"v2",configuration:{separator:t.dimension_separator??"."}},codecs:r,fill_value:t.fill_value,attributes:e}}function zi(t,e={}){return{zarr_format:3,node_type:"group",attributes:e}}function Hi(t,e){if(e!=="number"&&e!=="bigint"&&e!=="boolean"&&e!=="object"&&e!=="string")return t===e;let r=t==="bool";if(e==="boolean")return r;let n=t.startsWith("v2:U")||t.startsWith("v2:S")||t==="string";if(e==="string")return n;let i=t==="int64"||t==="uint64";if(e==="bigint")return i;let s=t==="v2:object";return e==="object"?s:!n&&!i&&!r&&!s}function Wi(t){return(t==null?void 0:t.name)==="sharding_indexed"}function Vr(t){return(t.data_type==="uint64"||t.data_type==="int64")&&t.fill_value!=null?BigInt(t.fill_value):t.fill_value}function Kr(t,...e){if(!e.some(r=>t instanceof r))throw t}function j(t,e=""){if(!t)throw new Error(e)}async function Zr(t,{format:e,signal:r}){const n=t instanceof Response?t:new Response(t);j(n.body,"Response does not contain body.");try{return await new Response(n.body.pipeThrough(new DecompressionStream(e),{signal:r})).arrayBuffer()}catch{throw r==null||r.throwIfAborted(),new Error(`Failed to decode ${e}`)}}class Ft{constructor(e,r){I(this,"kind","array_to_array");j(e.keepbits>=0,"keepbits must be zero or positive")}static fromConfig(e,r){return new Ft(e,r)}encode(e){throw new Error("`BitroundCodec.encode` is not implemented. Please open an issue at https://github.com/manzt/zarrita.js/issues.")}decode(e){return e}}const Er=Yi();function Yi(){const t=new Uint32Array([305419896]);return new Uint8Array(t.buffer,t.byteOffset,t.byteLength)[0]!==18}function pr(t){return"BYTES_PER_ELEMENT"in t?t.BYTES_PER_ELEMENT:4}var Le,re,Ce,Se,Ee;const jt=class jt{constructor(e,r){I(this,"kind","array_to_bytes");X(this,Le);X(this,re);X(this,Ce);X(this,Se);X(this,Ee);B(this,Ee,e==null?void 0:e.endian),B(this,re,Yr(r.data_type)),B(this,Se,r.shape),B(this,Le,le(r.shape,"C"));const n=new(C(this,re))(0);B(this,Ce,n.BYTES_PER_ELEMENT)}static fromConfig(e,r){return new jt(e,r)}encode(e){let r=new Uint8Array(e.data.buffer);return Er&&C(this,Ee)==="big"&&Tr(r,pr(C(this,re))),r}decode(e){return Er&&C(this,Ee)==="big"&&Tr(e,pr(C(this,re))),{data:new(C(this,re))(e.buffer,e.byteOffset,e.byteLength/C(this,Ce)),shape:C(this,Se),stride:C(this,Le)}}};Le=new WeakMap,re=new WeakMap,Ce=new WeakMap,Se=new WeakMap,Ee=new WeakMap;let Ve=jt;class Nt{constructor(){I(this,"kind","bytes_to_bytes")}static fromConfig(){return new Nt}encode(e){throw new Error("Not implemented")}decode(e){return new Uint8Array(e.buffer,e.byteOffset,e.byteLength-4)}}class Mt{constructor(){I(this,"kind","bytes_to_bytes")}static fromConfig(e){return new Mt}encode(e){throw new Error("Gzip encoding is not enabled by default. Please register a custom codec with `numcodecs/gzip`.")}async decode(e){const r=await Zr(e,{format:"gzip"});return new Uint8Array(r)}}function Vi(t,e){return j(!Number.isNaN(e),"JsonCodec allow_nan is false but NaN was encountered during encoding."),j(e!==Number.POSITIVE_INFINITY,"JsonCodec allow_nan is false but Infinity was encountered during encoding."),j(e!==Number.NEGATIVE_INFINITY,"JsonCodec allow_nan is false but -Infinity was encountered during encoding."),e}function Ki(t,e){return e instanceof Object&&!Array.isArray(e)?Object.keys(e).sort().reduce((r,n)=>(r[n]=e[n],r),{}):e}var Ue,Pe;const zt=class zt{constructor(e={}){I(this,"configuration");I(this,"kind","array_to_bytes");X(this,Ue);X(this,Pe);this.configuration=e;const{encoding:r="utf-8",skipkeys:n=!1,ensure_ascii:i=!0,check_circular:s=!0,allow_nan:o=!0,sort_keys:a=!0,indent:c,strict:l=!0}=e;let d=e.separators;d||(c?d=[", ",": "]:d=[",",":"]),B(this,Ue,{encoding:r,skipkeys:n,ensure_ascii:i,check_circular:s,allow_nan:o,indent:c,separators:d,sort_keys:a}),B(this,Pe,{strict:l})}static fromConfig(e){return new zt(e)}encode(e){const{indent:r,encoding:n,ensure_ascii:i,check_circular:s,allow_nan:o,sort_keys:a}=C(this,Ue);j(n==="utf-8","JsonCodec does not yet support non-utf-8 encoding.");const c=[];j(s,"JsonCodec does not yet support skipping the check for circular references during encoding."),o||c.push(Vi),a&&c.push(Ki);const l=Array.from(e.data);l.push("|O"),l.push(e.shape);let d;c.length&&(d=(f,_)=>{let u=_;for(let E of c)u=E(f,u);return u});let h=JSON.stringify(l,d,r);return i&&(h=h.replace(/[\u007F-\uFFFF]/g,f=>{const _=`0000${f.charCodeAt(0).toString(16)}`;return`\\u${_.substring(_.length-4)}`})),new TextEncoder().encode(h)}decode(e){const{strict:r}=C(this,Pe);j(r,"JsonCodec does not yet support non-strict decoding.");const n=Oe(e),i=n.pop();n.pop(),j(i,"0D not implemented for JsonCodec.");const s=le(i,"C");return{data:n,shape:i,stride:s}}};Ue=new WeakMap,Pe=new WeakMap;let gt=zt;function gr(t){return t instanceof Wr||t instanceof Dt||t instanceof be?new Proxy(t,{get(r,n){return r.get(Number(n))},set(r,n,i){return r.set(Number(n),i),!0}}):t}function Zi(t,e){let r;return t.data instanceof Dt||t.data instanceof be?r=new t.constructor(t.data.length,t.data.chars):r=new t.constructor(t.data.length),{data:r,shape:t.shape,stride:le(t.shape,e)}}function qi(t,e){let r=Zi(t,e),n=t.shape.length,i=t.data.length,s=Array(n).fill(0),o=gr(t.data),a=gr(r.data);for(let c=0;c<i;c++){let l=0;for(let d=0;d<n;d++)l+=s[d]*r.stride[d];a[l]=o[c],s[0]+=1;for(let d=0;d<n;d++)if(s[d]===t.shape[d]){if(d+1===n)break;s[d]=0,s[d+1]+=1}}return r}function Ji(t){let e=t.shape.length;return j(e===t.stride.length,"Shape and stride must have the same length."),t.stride.map((r,n)=>({stride:r,index:n})).sort((r,n)=>n.stride-r.stride).map(r=>r.index)}function Qi(t,e){let r=Ji(t);return j(r.length===e.length,"Orders must match"),r.every((n,i)=>n===e[i])}var Ie,pe;const Ht=class Ht{constructor(e,r){I(this,"kind","array_to_array");X(this,Ie);X(this,pe);let n=e.order??"C",i=r.shape.length,s=new Array(i),o=new Array(i);if(n==="C")for(let a=0;a<i;++a)s[a]=a,o[a]=a;else if(n==="F")for(let a=0;a<i;++a)s[a]=i-a-1,o[a]=i-a-1;else s=n,s.forEach((a,c)=>{j(o[a]===void 0,`Invalid permutation: ${JSON.stringify(n)}`),o[a]=c});B(this,Ie,s),B(this,pe,o)}static fromConfig(e,r){return new Ht(e,r)}encode(e){return Qi(e,C(this,pe))?e:qi(e,C(this,pe))}decode(e){return{data:e.data,shape:e.shape,stride:le(e.shape,C(this,Ie))}}};Ie=new WeakMap,pe=new WeakMap;let mt=Ht;var De,Fe;const Wt=class Wt{constructor(e){I(this,"kind","array_to_bytes");X(this,De);X(this,Fe);B(this,De,e),B(this,Fe,le(e,"C"))}static fromConfig(e,r){return new Wt(r.shape)}encode(e){throw new Error("Method not implemented.")}decode(e){let r=new TextDecoder,n=new DataView(e.buffer),i=Array(n.getUint32(0,!0)),s=4;for(let o=0;o<i.length;o++){let a=n.getUint32(s,!0);s+=4,i[o]=r.decode(e.buffer.slice(s,s+a)),s+=a}return{data:i,shape:C(this,De),stride:C(this,Fe)}}};De=new WeakMap,Fe=new WeakMap;let Rt=Wt;class Ot{constructor(){I(this,"kind","bytes_to_bytes")}static fromConfig(e){return new Ot}encode(e){throw new Error("Zlib encoding is not enabled by default. Please register a codec with `numcodecs/zlib`.")}async decode(e){const r=await Zr(e,{format:"deflate"});return new Uint8Array(r)}}function es(){return new Map().set("blosc",()=>ot(()=>import("./blosc.nNxqTOai.js"),__vite__mapDeps([0,1])).then(t=>t.default)).set("lz4",()=>ot(()=>import("./lz4.COuoZ_ur.js"),__vite__mapDeps([2,1])).then(t=>t.default)).set("zstd",()=>ot(()=>import("./zstd.CtzXwP91.js"),__vite__mapDeps([3,1])).then(t=>t.default)).set("gzip",()=>Mt).set("zlib",()=>Ot).set("transpose",()=>mt).set("bytes",()=>Ve).set("crc32c",()=>Nt).set("vlen-utf8",()=>Rt).set("json2",()=>gt).set("bitround",()=>Ft)}const ts=es();function xt(t){let e;return{async encode(r){e||(e=await mr(t));for(const i of e.array_to_array)r=await i.encode(r);let n=await e.array_to_bytes.encode(r);for(const i of e.bytes_to_bytes)n=await i.encode(n);return n},async decode(r){e||(e=await mr(t));for(let i=e.bytes_to_bytes.length-1;i>=0;i--)r=await e.bytes_to_bytes[i].decode(r);let n=await e.array_to_bytes.decode(r);for(let i=e.array_to_array.length-1;i>=0;i--)n=await e.array_to_array[i].decode(n);return n}}}async function mr(t){let e=t.codecs.map(async s=>{var a;let o=await((a=ts.get(s.name))==null?void 0:a());return j(o,`Unknown codec: ${s.name}`),{Codec:o,meta:s}}),r=[],n,i=[];for await(let{Codec:s,meta:o}of e){let a=s.fromConfig(o.configuration,t);switch(a.kind){case"array_to_array":r.push(a);break;case"array_to_bytes":n=a;break;default:i.push(a)}}return n||(j(rs(t),`Cannot encode ${t.data_type} to bytes without a codec`),n=Ve.fromConfig({endian:"little"},t)),{array_to_array:r,array_to_bytes:n,bytes_to_bytes:i}}function rs(t){return t.data_type!=="v2:object"&&t.data_type!=="string"}class Ge extends Error{constructor(e,r={}){super(`Node not found: ${e}`,r),this.name="NodeNotFoundError"}}class Gt extends Error{constructor(e){super(`Missing key: ${e}`),this.name="KeyError"}}const Rr=18446744073709551615n;function ns(t,e,r,n){j(t.store.getRange,"Store does not support range requests");let i=t.store.getRange.bind(t.store),s=e.map((c,l)=>c/n.chunk_shape[l]),o=xt({data_type:"uint64",shape:[...s,2],codecs:n.index_codecs}),a={};return async(c,l)=>{let d=c.map((b,g)=>Math.floor(b/s[g])),h=t.resolve(r(d)).path,f;if(h in a)f=a[h];else{let b=4,g=16*s.reduce((T,v)=>T*v,1),R=await i(h,{suffixLength:g+b},l);f=a[h]=R?await o.decode(R):null}if(f===null)return;let{data:_,shape:u,stride:E}=f,y=c.map((b,g)=>b%u[g]).reduce((b,g,R)=>b+g*E[R],0),m=_[y],p=_[y+1];if(!(m===Rr&&p===Rr))return i(h,{offset:Number(m),length:Number(p)},l)}}class me{constructor(e,r="/"){I(this,"store");I(this,"path");this.store=e,this.path=r}resolve(e){let r=new URL(`file://${this.path.endsWith("/")?this.path:`${this.path}/`}`);return new me(this.store,decodeURIComponent(new URL(e,r).pathname))}}var Ne;class Bt extends me{constructor(r,n,i){super(r,n);I(this,"kind","group");X(this,Ne);B(this,Ne,i)}get attrs(){return C(this,Ne).attributes}}Ne=new WeakMap;function xr(t){var r;const e=t.find(n=>n.name==="transpose");return((r=e==null?void 0:e.configuration)==null?void 0:r.order)??"C"}const xe=Symbol("zarrita.context");function is(t){return t[xe]}function ss(t,e){let{configuration:r}=e.codecs.find(Wi)??{},n={encode_chunk_key:$i(e.chunk_key_encoding),TypedArray:Yr(e.data_type),fill_value:e.fill_value};if(r){let s=xr(r.codecs);return{...n,kind:"sharded",chunk_shape:r.chunk_shape,codec:xt({data_type:e.data_type,shape:r.chunk_shape,codecs:r.codecs}),get_strides(o){return le(o,s)},get_chunk_bytes:ns(t,e.chunk_grid.configuration.chunk_shape,n.encode_chunk_key,r)}}let i=xr(e.codecs);return{...n,kind:"regular",chunk_shape:e.chunk_grid.configuration.chunk_shape,codec:xt({data_type:e.data_type,shape:e.chunk_grid.configuration.chunk_shape,codecs:e.codecs}),get_strides(s){return le(s,i)},async get_chunk_bytes(s,o){let a=n.encode_chunk_key(s),c=t.resolve(a).path;return t.store.get(c,o)}}}var Lr,Cr,ae,Sr;let Ke=(Sr=class extends(Cr=me,Lr=xe,Cr){constructor(r,n,i){super(r,n);I(this,"kind","array");X(this,ae);I(this,Lr);B(this,ae,{...i,fill_value:Vr(i)}),this[xe]=ss(this,i)}get attrs(){return C(this,ae).attributes}get shape(){return C(this,ae).shape}get chunks(){return this[xe].chunk_shape}get dtype(){return C(this,ae).data_type}async getChunk(r,n){let i=this[xe],s=await i.get_chunk_bytes(r,n);if(!s){let o=i.chunk_shape.reduce((c,l)=>c*l,1),a=new i.TypedArray(o);return a.fill(i.fill_value),{data:a,shape:i.chunk_shape,stride:i.get_strides(i.chunk_shape)}}return i.codec.decode(s)}is(r){return Hi(this.dtype,r)}},ae=new WeakMap,Sr);function*os(t,e,r=1){e===void 0&&(e=t,t=0);for(let n=t;n<e;n+=r)yield n}function*as(...t){if(t.length===0)return;const e=t.map(n=>n[Symbol.iterator]()),r=e.map(n=>n.next());if(r.some(n=>n.done))throw new Error("Input contains an empty iterator.");for(let n=0;;){if(r[n].done){if(e[n]=t[n][Symbol.iterator](),r[n]=e[n].next(),++n>=e.length)return}else yield r.map(({value:i})=>i),n=0;r[n]=e[n].next()}}function cs({start:t,stop:e,step:r},n){if(r===0)throw new Error("slice step cannot be zero");r=r??1;const i=r<0,[s,o]=i?[-1,n-1]:[0,n];return t===null?t=i?o:s:t<0?(t+=n,t<s&&(t=s)):t>o&&(t=o),e===null?e=i?s:o:e<0?(e+=n,e<s&&(e=s)):e>o&&(e=o),[t,e,r]}function Ze(t,e,r=null){return e===void 0&&(e=t,t=null),{start:t,stop:e,step:r}}function ls(){const t=[];return{add:e=>t.push(e()),onIdle:()=>Promise.all(t)}}class Xt extends Error{constructor(e){super(e),this.name="IndexError"}}function us(t,e){throw new Xt(`too many indicies for array; expected ${e.length}, got ${t.length}`)}function hs(t){throw new Xt(`index out of bounds for dimension with length ${t}`)}function ds(){throw new Xt("only slices with step >= 1 are supported")}function fs(t,e){t.length>e.length&&us(t,e)}function _s(t,e){return t=Math.trunc(t),t<0&&(t=e+t),(t>=e||t<0)&&hs(e),t}class Ts{constructor({dim_sel:e,dim_len:r,dim_chunk_len:n}){I(this,"dim_sel");I(this,"dim_len");I(this,"dim_chunk_len");I(this,"nitems");e=_s(e,r),this.dim_sel=e,this.dim_len=r,this.dim_chunk_len=n,this.nitems=1}*[Symbol.iterator](){const e=Math.floor(this.dim_sel/this.dim_chunk_len),r=e*this.dim_chunk_len,n=this.dim_sel-r;yield{dim_chunk_ix:e,dim_chunk_sel:n}}}class yr{constructor({dim_sel:e,dim_len:r,dim_chunk_len:n}){I(this,"start");I(this,"stop");I(this,"step");I(this,"dim_len");I(this,"dim_chunk_len");I(this,"nitems");I(this,"nchunks");const[i,s,o]=cs(e,r);this.start=i,this.stop=s,this.step=o,this.step<1&&ds(),this.dim_len=r,this.dim_chunk_len=n,this.nitems=Math.max(0,Math.ceil((this.stop-this.start)/this.step)),this.nchunks=Math.ceil(this.dim_len/this.dim_chunk_len)}*[Symbol.iterator](){const e=Math.floor(this.start/this.dim_chunk_len),r=Math.ceil(this.stop/this.dim_chunk_len);for(const n of os(e,r)){const i=n*this.dim_chunk_len,s=Math.min(this.dim_len,(n+1)*this.dim_chunk_len),o=s-i;let a=0,c=0;if(this.start<i){const _=(i-this.start)%this.step;_&&(c+=this.step-_),a=Math.ceil((i-this.start)/this.step)}else c=this.start-i;const l=this.stop>s?o:this.stop-i,d=[c,l,this.step],h=Math.ceil((l-c)/this.step),f=[a,a+h,1];yield{dim_chunk_ix:n,dim_chunk_sel:d,dim_out_sel:f}}}}function Es(t,e){let r=[];return t===null?r=e.map(n=>Ze(null)):Array.isArray(t)&&(r=t.map(n=>n??Ze(null))),fs(r,e),r}class ps{constructor({selection:e,shape:r,chunk_shape:n}){I(this,"dim_indexers");I(this,"shape");this.dim_indexers=Es(e,r).map((i,s)=>new(typeof i=="number"?Ts:yr)({dim_sel:i,dim_len:r[s],dim_chunk_len:n[s]})),this.shape=this.dim_indexers.filter(i=>i instanceof yr).map(i=>i.nitems)}*[Symbol.iterator](){for(const e of as(...this.dim_indexers)){const r=e.map(i=>i.dim_chunk_ix),n=e.map(i=>"dim_out_sel"in i?{from:i.dim_chunk_sel,to:i.dim_out_sel}:{from:i.dim_chunk_sel,to:null});yield{chunk_coords:r,mapping:n}}}}function gs(t,e){return"get"in t?t.get(e):t[e]}async function ms(t,e,r,n){var c;let i=is(t),s=new ps({selection:e,shape:t.shape,chunk_shape:t.chunks}),o=n.prepare(new i.TypedArray(s.shape.reduce((l,d)=>l*d,1)),s.shape,i.get_strides(s.shape)),a=((c=r.create_queue)==null?void 0:c.call(r))??ls();for(const{chunk_coords:l,mapping:d}of s)a.add(async()=>{let{data:h,shape:f,stride:_}=await t.getChunk(l,r.opts),u=n.prepare(h,f,_);n.set_from_chunk(o,u,d)});return await a.onIdle(),s.shape.length===0?gs(o.data,0):o}function $t(t,e=0,r){let n=r??t.length-e;return{length:n,subarray(i,s=n){return $t(t,e+i,s-i)},set(i,s=0){for(let o=0;o<i.length;o++)t[e+s+o]=i.get(o)},get(i){return t[e+i]}}}function ut(t){return globalThis.Array.isArray(t.data)?{data:$t(t.data),stride:t.stride,bytes_per_element:1}:{data:new Uint8Array(t.data.buffer,t.data.byteOffset,t.data.byteLength),stride:t.stride,bytes_per_element:t.data.BYTES_PER_ELEMENT}}function Rs(t){return"chars"in t?t.constructor.bind(null,t.chars):t.constructor}function xs(t,e){if(globalThis.Array.isArray(t.data))return $t([e]);let r=Rs(t.data),n=new r([e]);return new Uint8Array(n.buffer,n.byteOffset,n.byteLength)}const ys={prepare(t,e,r){return{data:t,shape:e,stride:r}},set_scalar(t,e,r){let n=ut(t);yt(n,e,xs(t,r),n.bytes_per_element)},set_from_chunk(t,e,r){let n=ut(t);ze(n,ut(e),n.bytes_per_element,r)}};async function bs(t,e=null,r={}){return ms(t,e,r,ys)}function qr(t,e,r){return r<0&&e<t?Math.floor((t-e-1)/-r)+1:t<e?Math.floor((e-t-1)/r)+1:0}function yt(t,e,r,n){if(e.length===0){t.data.set(r,0);return}const[i,...s]=e,[o,...a]=t.stride;if(typeof i=="number"){const f=t.data.subarray(o*i*n);yt({data:f,stride:a},s,r,n);return}const[c,l,d]=i,h=qr(c,l,d);if(s.length===0){for(let f=0;f<h;f++)t.data.set(r,o*(c+d*f)*n);return}for(let f=0;f<h;f++){const _=t.data.subarray(o*(c+d*f)*n);yt({data:_,stride:a},s,r,n)}}function ze(t,e,r,n){const[i,...s]=n,[o,...a]=t.stride,[c,...l]=e.stride;if(i.from===null){if(s.length===0){t.data.set(e.data.subarray(0,r),i.to*r);return}ze({data:t.data.subarray(o*i.to*r),stride:a},e,r,s);return}if(i.to===null){if(s.length===0){let m=i.from*r;t.data.set(e.data.subarray(m,m+r),0);return}ze(t,{data:e.data.subarray(c*i.from*r),stride:l},r,s);return}const[d,h,f]=i.to,[_,u,E]=i.from,y=qr(d,h,f);if(s.length===0){if(f===1&&E===1&&o===1&&c===1){let m=_*r,p=y*r;t.data.set(e.data.subarray(m,m+p),d*r);return}for(let m=0;m<y;m++){let p=c*(_+E*m)*r;t.data.set(e.data.subarray(p,p+r),o*(d+f*m)*r)}return}for(let m=0;m<y;m++)ze({data:t.data.subarray(o*(d+m*f)*r),stride:a},{data:e.data.subarray(c*(_+m*E)*r),stride:l},r,s)}let Qe=As();function As(){let t=new WeakMap;function e(r){let n=t.get(r)??{v2:0,v3:0};return t.set(r,n),n}return{increment(r,n){e(r)[n]+=1},version_max(r){let n=e(r);return n.v3>n.v2?"v3":"v2"}}}async function vs(t){let e=await t.store.get(t.resolve(".zattrs").path);return e?Oe(e):{}}async function ws(t,e={}){let r="store"in t?t:new me(t),n={};return(e.attrs??!0)&&(n=await vs(r)),e.kind==="array"?br(r,n):e.kind==="group"?Ar(r,n):br(r,n).catch(i=>(Kr(i,Ge),Ar(r,n)))}async function br(t,e){let{path:r}=t.resolve(".zarray"),n=await t.store.get(r);if(!n)throw new Ge("v2 array",{cause:new Gt(r)});return Qe.increment(t.store,"v2"),new Ke(t.store,t.path,ji(Oe(n),e))}async function Ar(t,e){let{path:r}=t.resolve(".zgroup"),n=await t.store.get(r);if(!n)throw new Ge("v2 group",{cause:new Gt(r)});return Qe.increment(t.store,"v2"),new Bt(t.store,t.path,zi(Oe(n),e))}async function Ls(t){let{store:e,path:r}=t.resolve("zarr.json"),n=await t.store.get(r);if(!n)throw new Ge("v3 array or group",{cause:new Gt(r)});let i=Oe(n);return i.node_type==="array"&&(i.fill_value=Vr(i)),i.node_type==="array"?new Ke(e,t.path,i):new Bt(e,t.path,i)}async function Cs(t,e={}){let r="store"in t?t:new me(t),n=await Ls(r);if(Qe.increment(r.store,"v3"),e.kind===void 0||e.kind==="array"&&n instanceof Ke||e.kind==="group"&&n instanceof Bt)return n;let i=n instanceof Ke?"array":"group";throw new Error(`Expected node of kind ${e.kind}, found ${i}.`)}async function ee(t,e={}){let r="store"in t?t.store:t,n=Qe.version_max(r),i=n==="v2"?ee.v2:ee.v3,s=n==="v2"?ee.v3:ee.v2;return i(t,e).catch(o=>(Kr(o,Ge),s(t,e)))}ee.v2=ws;ee.v3=Cs;const Ss=`
  attribute vec4 a_position;
  attribute vec4 a_texcoord;

  uniform mat4 u_matrix;
  uniform mat4 u_textureMatrix;

  varying vec2 v_texcoord;

  void main() {
    gl_Position = u_matrix * a_position;
    vec2 texcoord = (u_textureMatrix * a_texcoord).xy;
    v_texcoord = texcoord;
  }
`,Us=`
  precision mediump float;

  varying vec2 v_texcoord;

  uniform sampler2D u_texture;

  void main() {
    if (
      v_texcoord.x < 0.0 ||
      v_texcoord.y < 0.0 ||
      v_texcoord.x > 1.0 ||
      v_texcoord.y > 1.0
    ) {
      discard;
    }
    gl_FragColor = texture2D(u_texture, v_texcoord);
  }
`;class Ps{constructor(e){this.gl_=e,this.program_=bt(e,Us,Ss),this.positionLocation=e.getAttribLocation(this.program_,"a_position"),this.texcoordLocation=e.getAttribLocation(this.program_,"a_texcoord"),this.matrixLocation=e.getUniformLocation(this.program_,"u_matrix"),this.textureMatrixLocation=e.getUniformLocation(this.program_,"u_textureMatrix"),this.textureLocation=e.getUniformLocation(this.program_,"u_texture"),this.positionBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.positionBuffer),this.positions=[0,0,0,1,1,0,1,0,0,1,1,1],e.bufferData(e.ARRAY_BUFFER,new Float32Array(this.positions),e.STATIC_DRAW),this.texcoordBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.texcoordBuffer),this.texcoords=[0,0,0,1,1,0,1,0,0,1,1,1],e.bufferData(e.ARRAY_BUFFER,new Float32Array(this.texcoords),e.STATIC_DRAW)}drawImage(e,r,n,i,s,o,a,c,l,d,h,f,_){const u=this.gl_;c===void 0&&(c=i),l===void 0&&(l=s),o===void 0&&(o=r),a===void 0&&(a=n),d===void 0&&(d=o),h===void 0&&(h=a),f===void 0&&(f=u.canvas.width),_===void 0&&(_=u.canvas.height),u.bindTexture(u.TEXTURE_2D,e),u.useProgram(this.program_),u.bindBuffer(u.ARRAY_BUFFER,this.positionBuffer),u.enableVertexAttribArray(this.positionLocation),u.vertexAttribPointer(this.positionLocation,2,u.FLOAT,!1,0,0),u.bindBuffer(u.ARRAY_BUFFER,this.texcoordBuffer),u.enableVertexAttribArray(this.texcoordLocation),u.vertexAttribPointer(this.texcoordLocation,2,u.FLOAT,!1,0,0);let E=Tt(0,f,0,_,-1,1);E=ti(E,c,l,0),E=rr(E,d,h,1),u.uniformMatrix4fv(this.matrixLocation,!1,E);let y=ri(i/r,s/n,0);y=rr(y,o/r,a/n,1),u.uniformMatrix4fv(this.textureMatrixLocation,!1,y),u.uniform1i(this.textureLocation,0),u.drawArrays(u.TRIANGLES,0,this.positions.length/2)}}function vr(t,e,r){const n=t.createShader(e);if(n===null)throw new Error("Shader compilation failed");if(t.shaderSource(n,r),t.compileShader(n),!t.getShaderParameter(n,t.COMPILE_STATUS)){const i=t.getShaderInfoLog(n);throw i===null?new Error("Shader info log creation failed"):new Error(i)}return n}function bt(t,e,r){const n=t.createProgram(),i=vr(t,t.VERTEX_SHADER,r),s=vr(t,t.FRAGMENT_SHADER,e);if(n===null)throw new Error("Program creation failed");if(t.attachShader(n,i),t.attachShader(n,s),t.linkProgram(n),!t.getProgramParameter(n,t.LINK_STATUS))throw t.getProgramInfoLog(n)===null?new Error("Program info log creation failed"):new Error;return n}const Is=`
  attribute vec4 a_position;

  uniform mat4 u_matrix;

  void main() {
     gl_Position = u_matrix * a_position;
  }
`,Ds=`
  precision mediump float;

  uniform vec4 u_val;
  void main() {
     gl_FragColor = u_val;
  }
`,Fs=`
  attribute vec4 a_position;
  attribute vec2 a_texcoord;

  varying vec2 v_texcoord;

  uniform mat4 u_matrix;

  void main() {
     gl_Position = u_matrix * a_position;
     v_texcoord = a_texcoord;
  }
`,Ns=`
  precision mediump float;

  varying vec2 v_texcoord;

  uniform sampler2D u_texture;

  void main() {
    if (v_texcoord.x < 0.0 || v_texcoord.x > 1.0 || v_texcoord.y < 0.0 || v_texcoord.y > 1.0) {
      discard;
    }
    gl_FragColor = texture2D(u_texture, v_texcoord);
  }
`;function Ms(t,e,r,n){let i;return r&&r.length?i=r.shift():xn?i=new OffscreenCanvas(t||300,e||300):i=document.createElement("canvas"),t&&(i.width=t),e&&(i.height=e),i.getContext("webgl",n)}function Os(t){const e=t.canvas;e.width=1,e.height=1,t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT|t.STENCIL_BUFFER_BIT)}const wr=[];function Gs(t,e,r,n,i,s,o,a,c,l,d,h,f,_){const u=Math.round(n*e),E=Math.round(n*r);t.canvas.width=u,t.canvas.height=E;let y,m;if(m=t.createTexture(),t.bindTexture(t.TEXTURE_2D,m),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),f?(t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR)):(t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST)),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,u,E,0,t.RGBA,d,null),y=t.createFramebuffer(),t.bindFramebuffer(t.FRAMEBUFFER,y),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,m,0),y===null)throw new Error("Could not create framebuffer");if(m===null)throw new Error("Could not create texture");if(c.length===0)return{width:u,height:E,framebuffer:y,texture:m};const p=Nn();c.forEach(function(x,P,w){Fn(p,x.extent)});let b,g,R;const T=1/i;{if(b=t.createTexture(),m===null)throw new Error("Could not create texture");g=Math.round(ke(p)*T),R=Math.round(nt(p)*T);const x=t.getParameter(t.MAX_TEXTURE_SIZE),P=Math.max(g,R),w=P>x?x/P:1,O=Math.round(g*w),N=Math.round(R*w);t.bindTexture(t.TEXTURE_2D,b),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),f?(t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR)):(t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST)),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,O,N,0,t.RGBA,d,null);const M=t.createFramebuffer();t.bindFramebuffer(t.FRAMEBUFFER,M),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,b,0);const z=new Ps(t);c.forEach(function(F,Z,Y){const $=(F.extent[0]-p[0])*T*w,H=-(F.extent[3]-p[3])*T*w,J=ke(F.extent)*T*w,k=nt(F.extent)*T*w;if(t.bindFramebuffer(t.FRAMEBUFFER,M),t.viewport(0,0,O,N),F.clipExtent){const q=(F.clipExtent[0]-p[0])*T*w,Q=-(F.clipExtent[3]-p[3])*T*w,se=ke(F.clipExtent)*T*w,Be=nt(F.clipExtent)*T*w;t.enable(t.SCISSOR_TEST),t.scissor(f?q:Math.round(q),f?Q:Math.round(Q),f?se:Math.round(q+se)-Math.round(q),f?Be:Math.round(Q+Be)-Math.round(Q))}z.drawImage(F.texture,F.width,F.height,l,l,F.width-2*l,F.height-2*l,f?$:Math.round($),f?H:Math.round(H),f?J:Math.round($+J)-Math.round($),f?k:Math.round(H+k)-Math.round(H),O,N),t.disable(t.SCISSOR_TEST)}),t.deleteFramebuffer(M)}const v=qt(o),A=qt(p),U=x=>{const P=(x[0][0]-v[0])/s*n,w=-(x[0][1]-v[1])/s*n,O=(x[1][0]-v[0])/s*n,N=-(x[1][1]-v[1])/s*n,M=(x[2][0]-v[0])/s*n,z=-(x[2][1]-v[1])/s*n;return{u1:O,v1:N,u0:P,v0:w,u2:M,v2:z}};t.bindFramebuffer(t.FRAMEBUFFER,y),t.viewport(0,0,u,E);{const x=[],P=[],w=bt(t,Ns,Fs);t.useProgram(w);const O=t.getUniformLocation(w,"u_texture");t.bindTexture(t.TEXTURE_2D,b),t.uniform1i(O,0),a.getTriangles().forEach(function($,H,J){const k=$.source,q=$.target,{u1:Q,v1:se,u0:Be,v0:tn,u2:rn,v2:nn}=U(q),sn=(k[0][0]-A[0])/i/g,on=-(k[0][1]-A[1])/i/R,an=(k[1][0]-A[0])/i/g,cn=-(k[1][1]-A[1])/i/R,ln=(k[2][0]-A[0])/i/g,un=-(k[2][1]-A[1])/i/R;x.push(Q,se,Be,tn,rn,nn),P.push(an,cn,sn,on,ln,un)});const N=Tt(0,u,E,0,-1,1),M=t.getUniformLocation(w,"u_matrix");t.uniformMatrix4fv(M,!1,N);const z=t.getAttribLocation(w,"a_position"),F=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,F),t.bufferData(t.ARRAY_BUFFER,new Float32Array(x),t.STATIC_DRAW),t.vertexAttribPointer(z,2,t.FLOAT,!1,0,0),t.enableVertexAttribArray(z);const Z=t.getAttribLocation(w,"a_texcoord"),Y=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,Y),t.bufferData(t.ARRAY_BUFFER,new Float32Array(P),t.STATIC_DRAW),t.vertexAttribPointer(Z,2,t.FLOAT,!1,0,0),t.enableVertexAttribArray(Z),t.drawArrays(t.TRIANGLES,0,x.length/2)}if(h){const x=bt(t,Ds,Is);t.useProgram(x);const P=Tt(0,u,E,0,-1,1),w=t.getUniformLocation(x,"u_matrix");t.uniformMatrix4fv(w,!1,P);const O=Array.isArray(h)?h:[0,0,0,255],N=t.getUniformLocation(x,"u_val");t.uniform4fv(N,O);const M=t.getAttribLocation(x,"a_position"),z=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,z),t.vertexAttribPointer(M,2,t.FLOAT,!1,0,0),t.enableVertexAttribArray(M);const F=a.getTriangles().reduce(function(Z,Y){const $=Y.target,{u1:H,v1:J,u0:k,v0:q,u2:Q,v2:se}=U($);return Z.concat([H,J,k,q,k,q,Q,se,Q,se,H,J])},[]);t.bufferData(t.ARRAY_BUFFER,new Float32Array(F),t.STATIC_DRAW),t.drawArrays(t.LINES,0,F.length/2)}return{width:u,height:E,framebuffer:y,texture:m}}class Bs extends vt{constructor(e){super({tileCoord:e.tileCoord,loader:()=>Promise.resolve(new Uint8ClampedArray(4)),interpolate:e.interpolate,transition:e.transition}),this.renderEdges_=e.renderEdges!==void 0?e.renderEdges:!1,this.pixelRatio_=e.pixelRatio,this.gutter_=e.gutter,this.reprojData_=null,this.reprojError_=null,this.reprojSize_=void 0,this.sourceTileGrid_=e.sourceTileGrid,this.targetTileGrid_=e.targetTileGrid,this.wrappedTileCoord_=e.wrappedTileCoord||e.tileCoord,this.sourceTiles_=[],this.sourcesListenerKeys_=null,this.sourceZ_=0;const r=e.sourceProj,n=r.getExtent(),i=e.sourceTileGrid.getExtent();this.clipExtent_=r.canWrapX()?i?ne(n,i):n:i;const s=this.targetTileGrid_.getTileCoordExtent(this.wrappedTileCoord_),o=this.targetTileGrid_.getExtent();let a=this.sourceTileGrid_.getExtent();const c=o?ne(s,o):s;if(Jt(c)===0){this.state=G.EMPTY;return}n&&(a?a=ne(a,n):a=n);const l=this.targetTileGrid_.getResolution(this.wrappedTileCoord_[0]),d=e.targetProj,h=yn(r,d,c,l);if(!isFinite(h)||h<=0){this.state=G.EMPTY;return}const f=e.errorThreshold!==void 0?e.errorThreshold:bn;if(this.triangulation_=new An(r,d,c,a,h*f,l,e.transformMatrix),this.triangulation_.getTriangles().length===0){this.state=G.EMPTY;return}this.sourceZ_=this.sourceTileGrid_.getZForResolution(h);let _=this.triangulation_.calculateSourceExtent();if(a&&(r.canWrapX()?(_[1]=Qt(_[1],a[1],a[3]),_[3]=Qt(_[3],a[1],a[3])):_=ne(_,a)),!Jt(_))this.state=G.EMPTY;else{let u=0,E=0;r.canWrapX()&&(u=ke(n),E=Math.floor((_[0]-n[0])/u)),Mn(_.slice(),r,!0).forEach(m=>{const p=this.sourceTileGrid_.getTileRangeForExtentAndZ(m,this.sourceZ_),b=e.getTileFunction;for(let g=p.minX;g<=p.maxX;g++)for(let R=p.minY;R<=p.maxY;R++){const T=b(this.sourceZ_,g,R,this.pixelRatio_);if(T){const v=E*u;this.sourceTiles_.push({tile:T,offset:v})}}++E}),this.sourceTiles_.length===0&&(this.state=G.EMPTY)}}getSize(){return this.reprojSize_}getData(){return this.reprojData_}getError(){return this.reprojError_}reproject_(){const e=[];let r=!1;if(this.sourceTiles_.forEach(g=>{var H;const R=g.tile;if(!R||R.getState()!==G.LOADED)return;const T=R.getSize(),v=this.gutter_;let A;const U=_t(R.getData());U?A=U:(r=!0,A=ei(ft(R.getData())));const x=[T[0]+2*v,T[1]+2*v],P=A instanceof Float32Array,w=x[0]*x[1],O=P?Float32Array:Uint8ClampedArray,N=new O(A.buffer),M=O.BYTES_PER_ELEMENT,z=M*N.length/w,F=N.byteLength/x[1],Z=Math.floor(F/M/x[0]),Y=this.sourceTileGrid_.getTileCoordExtent(R.tileCoord);Y[0]+=g.offset,Y[2]+=g.offset;const $=(H=this.clipExtent_)==null?void 0:H.slice();$&&($[0]+=g.offset,$[2]+=g.offset),e.push({extent:Y,clipExtent:$,data:N,dataType:O,bytesPerPixel:z,pixelSize:x,bandCount:Z})}),this.sourceTiles_.length=0,e.length===0){this.state=G.ERROR,this.changed();return}const n=this.wrappedTileCoord_[0],i=this.targetTileGrid_.getTileSize(n),s=typeof i=="number"?i:i[0],o=typeof i=="number"?i:i[1],a=Math.round(s*this.pixelRatio_),c=Math.round(o*this.pixelRatio_),l=this.targetTileGrid_.getResolution(n),d=this.sourceTileGrid_.getResolution(this.sourceZ_),h=this.targetTileGrid_.getTileCoordExtent(this.wrappedTileCoord_),f=e[0].bandCount,_=new e[0].dataType(f*a*c),u=Ms(a,c,wr,{premultipliedAlpha:!1,antialias:!1});let E;const y=u.RGBA;let m;e[0].dataType==Float32Array?(m=u.FLOAT,u.getExtension("WEBGL_color_buffer_float"),u.getExtension("OES_texture_float"),u.getExtension("EXT_float_blend"),E=u.getExtension("OES_texture_float_linear")!==null&&this.interpolate):(m=u.UNSIGNED_BYTE,E=this.interpolate);const p=4,b=Math.ceil(f/p);for(let g=b-1;g>=0;--g){const R=[];for(let O=0,N=e.length;O<N;++O){const M=e[O],z=M.pixelSize,F=z[0],Z=z[1],Y=new M.dataType(p*F*Z),$=M.data;let H=g*p;for(let k=0,q=Y.length;k<q;k+=p)Y[k]=$[H],Y[k+1]=$[H+1],Y[k+2]=$[H+2],Y[k+3]=$[H+3],H+=f;const J=u.createTexture();u.bindTexture(u.TEXTURE_2D,J),E?(u.texParameteri(u.TEXTURE_2D,u.TEXTURE_MIN_FILTER,u.LINEAR),u.texParameteri(u.TEXTURE_2D,u.TEXTURE_MAG_FILTER,u.LINEAR)):(u.texParameteri(u.TEXTURE_2D,u.TEXTURE_MIN_FILTER,u.NEAREST),u.texParameteri(u.TEXTURE_2D,u.TEXTURE_MAG_FILTER,u.NEAREST)),u.texParameteri(u.TEXTURE_2D,u.TEXTURE_WRAP_S,u.CLAMP_TO_EDGE),u.texParameteri(u.TEXTURE_2D,u.TEXTURE_WRAP_T,u.CLAMP_TO_EDGE),u.texImage2D(u.TEXTURE_2D,0,y,F,Z,0,y,m,Y),R.push({extent:M.extent,clipExtent:M.clipExtent,texture:J,width:F,height:Z})}const{framebuffer:T,width:v,height:A}=Gs(u,s,o,this.pixelRatio_,d,l,h,this.triangulation_,R,this.gutter_,m,this.renderEdges_,E),U=v,x=A*p,P=new e[0].dataType(U*x);u.bindFramebuffer(u.FRAMEBUFFER,T),u.readPixels(0,0,v,A,u.RGBA,m,P);let w=g*p;for(let O=0,N=P.length;O<N;O+=p){const M=(U-1-(O/x|0))*x+O%x;_[w]=P[M],_[w+1]=P[M+1],_[w+2]=P[M+2],_[w+3]=P[M+3],w+=f}}if(Os(u),wr.push(u.canvas),r){const g=Pr(s,o),R=new ImageData(_,s);g.putImageData(R,0,0),this.reprojData_=g.canvas}else this.reprojData_=_;this.reprojSize_=[a,c],this.state=G.LOADED,this.changed()}load(){if(this.state!==G.IDLE&&this.state!==G.ERROR)return;this.state=G.LOADING,this.changed();let e=0;this.sourcesListenerKeys_=[],this.sourceTiles_.forEach(({tile:r})=>{const n=r.getState();if(n!==G.IDLE&&n!==G.LOADING)return;e++;const i=Kn(r,_e.CHANGE,()=>{const s=r.getState();(s==G.LOADED||s==G.ERROR||s==G.EMPTY)&&(tr(i),e--,e===0&&(this.unlistenSources_(),this.reproject_()))});this.sourcesListenerKeys_.push(i)}),e===0?setTimeout(this.reproject_.bind(this),0):this.sourceTiles_.forEach(function({tile:r}){r.getState()==G.IDLE&&r.load()})}unlistenSources_(){this.sourcesListenerKeys_.forEach(tr),this.sourcesListenerKeys_=null}}class Xs extends vn{constructor(e){const r=e.projection===void 0?"EPSG:3857":e.projection;let n=e.tileGrid;n===void 0&&r&&(n=wn({extent:Ln(r),maxResolution:e.maxResolution,maxZoom:e.maxZoom,minZoom:e.minZoom,tileSize:e.tileSize})),super({cacheSize:.1,attributions:e.attributions,attributionsCollapsible:e.attributionsCollapsible,projection:r,tileGrid:n,state:e.state,wrapX:e.wrapX,transition:e.transition,interpolate:e.interpolate,key:e.key,zDirection:e.zDirection}),this.gutter_=e.gutter!==void 0?e.gutter:0,this.tileSize_=e.tileSize?ie(e.tileSize):null,this.tileSizes_=null,this.tileLoadingKeys_={},this.loader_=e.loader,this.handleTileChange_=this.handleTileChange_.bind(this),this.bandCount=e.bandCount===void 0?4:e.bandCount,this.tileGridForProjection_={},this.crossOrigin_=e.crossOrigin||"anonymous",this.referrerPolicy_=e.referrerPolicy,this.transformMatrix=null}setTileSizes(e){this.tileSizes_=e}getTileSize(e){if(this.tileSizes_)return this.tileSizes_[e];if(this.tileSize_)return this.tileSize_;const r=this.getTileGrid();return r?ie(r.getTileSize(e)):[256,256]}getGutterForProjection(e){const r=this.getProjection();return(!r||it(r,e))&&!this.transformMatrix?this.gutter_:0}setLoader(e){this.loader_=e}getReprojTile_(e,r,n,i,s,o){const a=this.tileGrid||this.getTileGridForProjection(s||i),c=Math.max.apply(null,a.getResolutions().map((u,E)=>{const y=ie(a.getTileSize(E)),m=this.getTileSize(E);return Math.max(m[0]/y[0],m[1]/y[1])})),l=this.getTileGridForProjection(i),d=[e,r,n],h=this.getTileCoordForTileUrlFunction(d,i),f=Object.assign({sourceProj:s||i,sourceTileGrid:a,targetProj:i,targetTileGrid:l,tileCoord:d,wrappedTileCoord:h,pixelRatio:c,gutter:this.gutter_,getTileFunction:(u,E,y,m)=>this.getTile(u,E,y,m,void 0,o),transformMatrix:this.transformMatrix},this.tileOptions),_=new Bs(f);return _.key=this.getKey(),_}getTile(e,r,n,i,s,o){var T;const a=this.getProjection();if(s&&(a&&!it(a,s)||this.transformMatrix))return this.getReprojTile_(e,r,n,s,a,o);const c=this.getTileSize(e),l=this.loader_,d=new AbortController,h={signal:d.signal,crossOrigin:this.crossOrigin_,referrerPolicy:this.referrerPolicy_},f=this.getTileCoordForTileUrlFunction([e,r,n]);if(!f)return null;const _=this.getKey(),u=Cn(this,_,e,r,n);if(o&&o.containsKey(u))return o.get(u);const E=f[0],y=f[1],m=f[2],p=(T=this.getTileGrid())==null?void 0:T.getFullTileRange(E);p&&(h.maxY=p.getHeight()-1);function b(){return Zn(function(){return l(E,y,m,h)})}const g=Object.assign({tileCoord:[e,r,n],loader:b,size:c,controller:d},this.tileOptions),R=new vt(g);return R.key=this.getKey(),R.addEventListener(_e.CHANGE,this.handleTileChange_),o==null||o.set(u,R),R}handleTileChange_(e){const r=e.target,n=V(r),i=r.getState();let s;i==G.LOADING?(this.tileLoadingKeys_[n]=!0,s=rt.TILELOADSTART):n in this.tileLoadingKeys_&&(delete this.tileLoadingKeys_[n],s=i==G.ERROR?rt.TILELOADERROR:i==G.LOADED?rt.TILELOADEND:void 0),s&&this.dispatchEvent(new Sn(s,r))}getTileGridForProjection(e){const r=this.getProjection();if(this.tileGrid&&(!r||it(r,e))&&!this.transformMatrix)return this.tileGrid;const n=V(e);return n in this.tileGridForProjection_||(this.tileGridForProjection_[n]=Un(e)),this.tileGridForProjection_[n]}setTileGridForProjection(e,r){const n=He(e);if(n){const i=V(n);i in this.tileGridForProjection_||(this.tileGridForProjection_[i]=r)}}}function ho(t,e,r,n){const i=document.createElement("script"),s="olc_"+V(e);function o(){delete window[s],i.parentNode.removeChild(i)}i.async=!0,i.src=t+(t.includes("?")?"&":"?")+"callback="+s;const a=setTimeout(function(){o(),r&&r()},1e4);window[s]=function(c){clearTimeout(a),o(),e(c)},document.head.appendChild(i)}class $s extends Error{constructor(e){const r="Unexpected response status: "+e.status;super(r),this.name="ResponseError",this.response=e}}class ks extends Error{constructor(e){super("Failed to issue request"),this.name="ClientError",this.client=e}}function Jr(t){return new Promise(function(e,r){function n(o){const a=o.target;if(!a.status||a.status>=200&&a.status<300){let c;try{c=JSON.parse(a.responseText)}catch(l){const d="Error parsing response text as JSON: "+l.message;r(new Error(d));return}e(c);return}r(new $s(a))}function i(o){r(new ks(o.target))}const s=new XMLHttpRequest;s.addEventListener("load",n),s.addEventListener("error",i),s.open("GET",t),s.setRequestHeader("Accept","application/json"),s.send()})}function Qr(t,e){return e.includes("://")?e:new URL(e,t).href}const js={"image/png":!0,"image/jpeg":!0,"image/gif":!0,"image/webp":!0},zs={"application/vnd.mapbox-vector-tile":!0,"application/geo+json":!0};function en(t,e){if(!e.length)return t;const r=new URL(t,"file:/");if(r.pathname.split("/").includes("collections"))return On('The "collections" query parameter cannot be added to collection endpoints'),t;const n=e.map(o=>encodeURIComponent(o)).join(",");r.searchParams.append("collections",n);const i=t.split("?")[0],s=decodeURIComponent(r.searchParams.toString());return`${i}?${s}`}function Hs(t,e,r){let n,i;for(let s=0;s<t.length;++s){const o=t[s];if(o.rel==="item"){if(o.type===e){n=o.href;break}(js[o.type]||!i&&o.type.startsWith("image/"))&&(i=o.href)}}if(!n)if(i)n=i;else throw new Error('Could not find "item" link');return r&&(n=en(n,r)),n}function Ws(t,e,r,n){let i,s;const o={};for(let a=0;a<t.length;++a){const c=t[a];if(o[c.type]=c.href,c.rel==="item"){if(c.type===e){i=c.href;break}zs[c.type]&&(s=c.href)}}if(!i&&r)for(let a=0;a<r.length;++a){const c=r[a];if(o[c]){i=o[c];break}}if(!i)if(s)i=s;else throw new Error('Could not find "item" link');return n&&(i=en(i,n)),i}function At(t,e,r,n){let i=t.projection;if(!i&&(typeof e.crs=="string"?i=He(e.crs):"uri"in e.crs&&(i=He(e.crs.uri)),!i))throw new Error(`Unsupported CRS: ${JSON.stringify(e.crs)}`);const s=e.orderedAxes,a=!(s?s.slice(0,2).map(T=>T.replace(/E|X|Lon/i,"e").replace(/N|Y|Lat/i,"n")).join(""):i.getAxisOrientation()).startsWith("en"),c=e.tileMatrices.sort(function(T,v){return v.cellSize-T.cellSize}),l={};for(let T=0;T<c.length;++T){const v=c[T];l[v.id]=v}const d={},h=[];if(n)for(let T=0;T<n.length;++T){const v=n[T],A=v.tileMatrix,U=l[A],x=c.indexOf(U);h[x]=A,d[A]=v}else for(let T=0;T<c.length;++T){const v=c[T].id;h.push(v)}const f=h.length,_=new Array(f),u=new Array(f),E=new Array(f),y=new Array(f),m=[-1/0,-1/0,1/0,1/0];for(let T=0;T<f;++T){const v=h[T],A=l[v],U=A.pointOfOrigin;a?_[T]=[U[1],U[0]]:_[T]=U,u[T]=A.cellSize,E[T]=[A.matrixWidth,A.matrixHeight],y[T]=[A.tileWidth,A.tileHeight];const x=d[v];if(x){const P=A.cellSize*A.tileWidth,w=_[T][0]+x.minTileCol*P,O=_[T][0]+(x.maxTileCol+1)*P,N=A.cellSize*A.tileHeight,M=A.cornerOfOrigin==="bottomLeft";let z,F;M?(z=_[T][1]+x.minTileRow*N,F=_[T][1]+(x.maxTileRow+1)*N):(z=_[T][1]-(x.maxTileRow+1)*N,F=_[T][1]-x.minTileRow*N),ne(m,[w,z,O,F],m)}}const p=new wt({origins:_,resolutions:u,sizes:E,tileSizes:y,extent:n?m:void 0,matrixIds:h});if(!r)return{grid:p,projection:i};const b=t.context,g=t.url;function R(T,v,A){if(!T)return;const U=h[T[0]],x=l[U],P=x.cornerOfOrigin==="bottomLeft",w={tileMatrix:U,tileCol:T[1],tileRow:P?-T[2]-1:T[2]};if(n){const N=d[x.id];if(w.tileCol<N.minTileCol||w.tileCol>N.maxTileCol||w.tileRow<N.minTileRow||w.tileRow>N.maxTileRow)return}Object.assign(w,{z:w.tileMatrix,x:w.tileCol,y:w.tileRow},b);const O=r.replace(/\{(\w+?)\}/g,function(N,M){return w[M]});return Qr(g,O)}return{grid:p,projection:i,urlTemplate:r,urlFunction:R}}function Ys(t,e){const r=e.tileMatrixSetLimits;let n;if(e.dataType==="map")n=Hs(e.links,t.mediaType,t.collections);else if(e.dataType==="vector")n=Ws(e.links,t.mediaType,t.supportedMediaTypes,t.collections);else throw new Error('Expected tileset data type to be "map" or "vector"');if(e.tileMatrixSet)return At(t,e.tileMatrixSet,n,r);const i=e.links.find(a=>a.rel==="http://www.opengis.net/def/rel/ogc/1.0/tiling-scheme");if(!i)throw new Error("Expected http://www.opengis.net/def/rel/ogc/1.0/tiling-scheme link or tileMatrixSet");const s=i.href,o=Qr(t.url,s);return Jr(o).then(function(a){return At(t,a,n,r)})}function fo(t){return Jr(t.url).then(function(e){return Ys(t,e)})}const Vs=["d35379db-88df-4056-af3a-620245f8e347","f17cb550-5864-4468-aeb7-f3180cfb622f","689b58e2-cf7b-45e0-9fff-9cfc0883d6b4"];class _o extends Xs{constructor(e){super({state:"loading",tileGrid:null,projection:e.projection||null,transition:e.transition,wrapX:e.wrapX}),this.url_=e.url,this.group_=e.group,this.error_=null,this.root_=null,this.consolidatedMetadata_=null,this.bands_=e.bands,this.bandsByLevel_=null,this.fillValue_,this.resampleMethod_=e.resample||"linear",this.bandCount=this.bands_.length,this.setLoader(this.loadTile_.bind(this)),this.tileGrid,this.configure_().then(()=>{this.setState("ready")}).catch(r=>{this.error_=r,this.setState("error")})}async configure_(){const e=new Xi(this.url_);this.root_=await ee(e,{kind:"group"});try{this.consolidatedMetadata_=JSON.parse(new TextDecoder().decode(await e.get(this.root_.resolve("zarr.json").path))).consolidated_metadata.metadata}catch{}const n=(await ee(this.root_.resolve(this.group_),{kind:"group"})).attrs;if("zarr_conventions"in n&&Array.isArray(n.zarr_conventions)&&Vs.every(s=>n.zarr_conventions.find(o=>o.uuid===s))&&"layout"in n.multiscales){const{tileGrid:s,projection:o,bandsByLevel:a,fillValue:c}=Ks(n,this.consolidatedMetadata_,this.group_,this.bands_);this.bandsByLevel_=a,this.tileGrid=s,this.projection=o,this.fillValue_=c}if("tile_matrix_set"in n.multiscales){const{tileGrid:s,projection:o}=Zs(n);this.tileGrid=s,this.projection||(this.projection=o)}if(!this.tileGrid)throw new Error("Could not determine tile grid");const i=this.tileGrid.getExtent();setTimeout(()=>{this.viewResolver({showFullExtent:!0,projection:this.projection,resolutions:this.tileGrid.getResolutions(),center:Bn(Xn(i),this.projection),extent:Gn(i,this.projection),zoom:1})})}async loadTile_(e,r,n,i){const s=this.tileGrid.getResolutions(),o=this.tileGrid.getResolution(e),a=this.tileGrid.getTileCoordExtent([e,r,n]),c=[],l=[];for(const _ of this.bands_){let u,E,y=0;if(!this.bandsByLevel_)u=this.tileGrid.getMatrixId(e),E=o,y=e;else for(let A=0;A<s.length;A+=1){const U=s[A];if(u&&U<o)break;const x=this.tileGrid.getMatrixId(A);this.bandsByLevel_[x].includes(_)&&(u=x,E=this.tileGrid.getResolution(A),y=A)}if(!u||!E)throw new Error(`Could not find available resolution for band ${_}`);const m=this.tileGrid.getOrigin(y),p=Math.round((a[0]-m[0])/E),b=Math.round((a[2]-m[0])/E),g=Math.round((m[1]-a[3])/E),R=Math.round((m[1]-a[1])/E),T=`${this.group_}/${u}/${_}`,v=await ee(this.root_.resolve(T),{kind:"array"});c.push(bs(v,[Ze(g,R),Ze(p,b)])),l.push(E)}const d=await Promise.all(c),[h,f]=ie(this.tileGrid.getTileSize(e));return qs(d,l,h,f,o,this.resampleMethod_,this.fillValue_||0)}}function Ks(t,e,r,n){const i=t.multiscales,s=t["spatial:bbox"],o=He(t["proj:code"]),a=[],c=e?{}:null;let l;for(const h of i.layout){const f=h["spatial:transform"],_=f[0],u=[f[2],f[5]],E=h.asset;if(a.push({matrixId:E,resolution:_,origin:u}),e){const y=[];for(const m of n){const p=e[`${r}/${E}/${m}`];p&&(y.push(m),l===void 0&&(l=p.fill_value))}c[E]=y}}return a.sort((h,f)=>f.resolution-h.resolution),{tileGrid:new wt({extent:s,origins:a.map(h=>h.origin),resolutions:a.map(h=>h.resolution),matrixIds:a.map(h=>h.matrixId)}),projection:o,bandsByLevel:c,fillValue:l}}function Zs(t){const e=t.multiscales,r=e.tile_matrix_set,n=e.tile_matrix_limits,i=r.tileMatrices.length,s=new Array(i);let o=!1;for(let l=0;l<i;l+=1){const d=r.tileMatrices[l],h=d.id;(d.tileWidth>512||d.tileHeight>512)&&(o=!0),s[l]=n[h]}const a=At({},r,void 0,s);let c=a.grid;return o&&(c=new wt({tileSize:512,extent:c.getExtent(),origins:c.getOrigins(),resolutions:c.getResolutions(),matrixIds:c.getMatrixIds()})),{tileGrid:c,projection:a.projection}}function qs(t,e,r,n,i,s,o){const a=t.length,c=new Float32Array(r*n*a);for(let l=0;l<n;l++)for(let d=0;d<r;d++)for(let h=0;h<a;++h){const f=t[h],_=f.shape[0],u=f.shape[1],E=i/e[h];let y=o;if(E===1)l<_&&d<u&&(y=f.data[l*u+d]);else{const m=l*E,p=d*E;switch(s){case"nearest":{const b=Math.round(m),g=Math.round(p);b<_&&g<u&&(y=f.data[b*u+g]);break}case"linear":{const b=Math.floor(m),g=Math.floor(p);if(b<_&&g<u){const R=Math.min(b+1,_-1),T=Math.min(g+1,u-1),v=f.data[b*u+g],A=f.data[b*u+T],U=f.data[R*u+g],x=f.data[R*u+T],P=p-g,w=m-b;y=(1-w)*((1-P)*v+P*A)+w*((1-P)*U+P*x)}break}default:throw new Error(`Unsupported resample method: ${s}`)}}isNaN(y)&&(y=o),c[a*(l*r+d)+h]=y}return c}export{Re as A,Xs as D,Ct as E,Pi as F,_o as G,oo as U,Oi as W,Di as a,ao as b,wi as c,co as d,he as e,lo as f,fo as g,Ui as h,hr as i,ho as j,zr as k,qe as l,Ii as m,ye as n,Xr as o,so as p,Lt as q,Ut as r,Si as s,ge as t,te as u,Gr as v};

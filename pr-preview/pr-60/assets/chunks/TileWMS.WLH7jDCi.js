import{I as N,i as U,j as H,k as h,l as X,E as k,S as K,m as j,o as Z,X as Q,p as B,q as J}from"./XYZ.CBnrgZcO.js";import{a1 as $,d as C,a2 as ee,a3 as P,a4 as b,l as te,E as Y,u as se,a5 as re,H as v,V as ie,$ as w,a6 as I,a7 as V,D as ne,a8 as x,g as T,a9 as D,aa as p,ab as ae,a0 as ce,ac as F,ad as oe}from"./Polygon.DGYqraVP.js";function y(i){return Array.isArray(i)?Math.min(...i):i}class ue extends N{constructor(e,t,s,r,n,a,c){let o=e.getExtent();o&&e.canWrapX()&&(o=o.slice(),o[0]=-1/0,o[2]=1/0);let u=t.getExtent();u&&t.canWrapX()&&(u=u.slice(),u[0]=-1/0,u[2]=1/0);const l=u?$(s,u):s,g=C(l),d=U(e,t,g,r),_=k,R=new H(e,t,l,o,d*_,r),E=R.calculateSourceExtent(),f=ee(E)?null:a(E,d,n),A=f?h.IDLE:h.EMPTY,G=f?f.getPixelRatio():1;super(s,r,G,A),this.targetProj_=t,this.maxSourceExtent_=o,this.triangulation_=R,this.targetResolution_=r,this.targetExtent_=s,this.sourceImage_=f,this.sourcePixelRatio_=G,this.interpolate_=c,this.canvas_=null,this.sourceListenerKey_=null}disposeInternal(){this.state==h.LOADING&&this.unlistenSource_(),super.disposeInternal()}getImage(){return this.canvas_}getProjection(){return this.targetProj_}reproject_(){const e=this.sourceImage_.getState();if(e==h.LOADED){const t=P(this.targetExtent_)/this.targetResolution_,s=b(this.targetExtent_)/this.targetResolution_;this.canvas_=X(t,s,this.sourcePixelRatio_,y(this.sourceImage_.getResolution()),this.maxSourceExtent_,this.targetResolution_,this.targetExtent_,this.triangulation_,[{extent:this.sourceImage_.getExtent(),image:this.sourceImage_.getImage()}],0,void 0,this.interpolate_,!0)}this.state=e,this.changed()}load(){if(this.state==h.IDLE){this.state=h.LOADING,this.changed();const e=this.sourceImage_.getState();e==h.LOADED||e==h.ERROR?this.reproject_():(this.sourceListenerKey_=te(this.sourceImage_,Y.CHANGE,t=>{const s=this.sourceImage_.getState();(s==h.LOADED||s==h.ERROR)&&(this.unlistenSource_(),this.reproject_())}),this.sourceImage_.load())}}unlistenSource_(){se(this.sourceListenerKey_),this.sourceListenerKey_=null}}const m=4,L={IMAGELOADSTART:"imageloadstart",IMAGELOADEND:"imageloadend",IMAGELOADERROR:"imageloaderror"};class he extends ne{constructor(e,t){super(e),this.image=t}}class _e extends K{constructor(e){super({attributions:e.attributions,projection:e.projection,state:e.state,interpolate:e.interpolate!==void 0?e.interpolate:!0}),this.on,this.once,this.un,this.loader=e.loader||null,this.resolutions_=e.resolutions!==void 0?e.resolutions:null,this.reprojectedImage_=null,this.reprojectedRevision_=0,this.image=null,this.wantedExtent_,this.wantedResolution_,this.static_=e.loader?e.loader.length===0:!1,this.wantedProjection_=null}getResolutions(){return this.resolutions_}setResolutions(e){this.resolutions_=e}findNearestResolution(e){const t=this.getResolutions();if(t){const s=re(t,e,0);e=t[s]}return e}getImage(e,t,s,r){const n=this.getProjection();if(!n||!r||v(n,r))return n&&(r=n),this.getImageInternal(e,t,s,r);if(this.reprojectedImage_){if(this.reprojectedRevision_==this.getRevision()&&v(this.reprojectedImage_.getProjection(),r)&&this.reprojectedImage_.getResolution()==t&&ie(this.reprojectedImage_.getExtent(),e))return this.reprojectedImage_;this.reprojectedImage_.dispose(),this.reprojectedImage_=null}return this.reprojectedImage_=new ue(n,r,e,t,s,(a,c,o)=>this.getImageInternal(a,c,o,n),this.getInterpolate()),this.reprojectedRevision_=this.getRevision(),this.reprojectedImage_}getImageInternal(e,t,s,r){if(this.loader){const n=q(e,t,s,1),a=this.findNearestResolution(t);if(this.image&&(this.static_||this.wantedProjection_===r&&(this.wantedExtent_&&w(this.wantedExtent_,n)||w(this.image.getExtent(),n))&&(this.wantedResolution_&&y(this.wantedResolution_)===a||y(this.image.getResolution())===a)))return this.image;this.wantedProjection_=r,this.wantedExtent_=n,this.wantedResolution_=a,this.image=new N(n,a,s,this.loader),this.image.addEventListener(Y.CHANGE,this.handleImageChange.bind(this))}return this.image}handleImageChange(e){const t=e.target;let s;switch(t.getState()){case h.LOADING:this.loading=!0,s=L.IMAGELOADSTART;break;case h.LOADED:this.loading=!1,s=L.IMAGELOADEND;break;case h.ERROR:this.loading=!1,s=L.IMAGELOADERROR;break;default:return}this.hasListener(s)&&this.dispatchEvent(new he(s,t))}}function me(i,e){i.getImage().src=e}function q(i,e,t,s){const r=e/t,n=C(i),a=I(P(i)/r,m),c=I(b(i)/r,m),o=I((s-1)*a/2,m),u=a+2*o,l=I((s-1)*c/2,m),g=c+2*l;return V(n,r,0,[u,g])}const S="1.3.0",M=[101,101];function z(i,e,t,s,r){r.WIDTH=t[0],r.HEIGHT=t[1];const n=s.getAxisOrientation(),a=p(r.VERSION,"1.3")>=0;r[a?"CRS":"SRS"]=s.getCode();const c=a&&n.startsWith("ne")?[e[1],e[0],e[3],e[2]]:e;return r.BBOX=c.join(","),j(i,r)}function W(i,e,t,s,r,n,a){n=Object.assign({REQUEST:"GetMap"},n);const c=e/t,o=[x(P(i)/c,m),x(b(i)/c,m)];if(t!=1)switch(a){case"geoserver":const l=90*t+.5|0;"FORMAT_OPTIONS"in n?n.FORMAT_OPTIONS+=";dpi:"+l:n.FORMAT_OPTIONS="dpi:"+l;break;case"mapserver":n.MAP_RESOLUTION=90*t;break;case"carmentaserver":case"qgis":n.DPI=90*t;break;default:throw new Error("Unknown `serverType` configured")}return z(r,i,o,s,n)}function O(i,e){return Object.assign({REQUEST:e,SERVICE:"WMS",VERSION:S,FORMAT:"image/png",STYLES:"",TRANSPARENT:"TRUE"},i)}function Ee(i){const e=i.hidpi===void 0?!0:i.hidpi,t=T(i.projection||"EPSG:3857"),s=i.ratio||1.5,r=i.load||Z,n=i.crossOrigin??null,a=i.referrerPolicy;return(c,o,u)=>{c=q(c,o,u,s),u!=1&&(!e||i.serverType===void 0)&&(u=1);const l=W(c,o,u,t,i.url,O(i.params,"GetMap"),i.serverType),g=new Image;return g.crossOrigin=n,a!==void 0&&(g.referrerPolicy=a),r(g,l).then(d=>({image:d,extent:c,pixelRatio:u}))}}function fe(i,e,t){if(i.url===void 0)return;const s=T(i.projection||"EPSG:3857"),r=V(e,t,0,M),n={QUERY_LAYERS:i.params.LAYERS,INFO_FORMAT:"application/json"};Object.assign(n,O(i.params,"GetFeatureInfo"),i.params);const a=D((e[0]-r[0])/t,m),c=D((r[3]-e[1])/t,m),o=p(n.VERSION,"1.3")>=0;return n[o?"I":"X"]=a,n[o?"J":"Y"]=c,z(i.url,r,M,s,n)}function Re(i,e){if(i.url===void 0)return;const t={SERVICE:"WMS",VERSION:S,REQUEST:"GetLegendGraphic",FORMAT:"image/png"};if(e!==void 0){const s=T(i.projection||"EPSG:3857").getMetersPerUnit()||1,r=28e-5;t.SCALE=e*s/r}if(Object.assign(t,i.params),i.params!==void 0&&t.LAYER===void 0){const s=t.LAYERS;if(!(!Array.isArray(s)||s.length!==1))return;t.LAYER=s}return j(i.url,t)}const le='&#169; <a href="https://www.openstreetmap.org/copyright" target="_blank">OpenStreetMap</a> contributors.';class Ie extends Q{constructor(e){e=e||{};let t;e.attributions!==void 0?t=e.attributions:t=[le];const s=e.url!==void 0?e.url:"https://tile.openstreetmap.org/{z}/{x}/{y}.png";super({attributions:t,attributionsCollapsible:!1,cacheSize:e.cacheSize,crossOrigin:e.crossOrigin!==void 0?e.crossOrigin:"anonymous",referrerPolicy:e.referrerPolicy||"origin-when-cross-origin",interpolate:e.interpolate,maxZoom:e.maxZoom!==void 0?e.maxZoom:19,reprojectionErrorThreshold:e.reprojectionErrorThreshold,tileLoadFunction:e.tileLoadFunction,transition:e.transition,url:s,wrapX:e.wrapX,zDirection:e.zDirection})}}class Se extends B{constructor(e){e=e||{};const t=Object.assign({},e.params);super({attributions:e.attributions,attributionsCollapsible:e.attributionsCollapsible,cacheSize:e.cacheSize,crossOrigin:e.crossOrigin,interpolate:e.interpolate,projection:e.projection,reprojectionErrorThreshold:e.reprojectionErrorThreshold,tileClass:e.tileClass,tileGrid:e.tileGrid,tileLoadFunction:e.tileLoadFunction,url:e.url,urls:e.urls,wrapX:e.wrapX!==void 0?e.wrapX:!0,transition:e.transition,zDirection:e.zDirection}),this.gutter_=e.gutter!==void 0?e.gutter:0,this.params_=t,this.v13_=!0,this.serverType_=e.serverType,this.hidpi_=e.hidpi!==void 0?e.hidpi:!0,this.tmpExtent_=ae(),this.updateV13_(),this.setKey(this.getKeyForParams_())}getFeatureInfoUrl(e,t,s,r){const n=T(s),a=this.getProjection()||n;let c=this.getTileGrid();c||(c=this.getTileGridForProjection(a));const o=ce(e,n,a),u=U(a,n,e,t),l=c.getZForResolution(u,this.zDirection),g=c.getResolution(l),d=c.getTileCoordForCoordAndZ(o,l);if(c.getResolutions().length<=d[0])return;let _=c.getTileCoordExtent(d,this.tmpExtent_);const R=this.gutter_;R!==0&&(_=F(_,g*R,_));const E={QUERY_LAYERS:this.params_.LAYERS};Object.assign(E,O(this.params_,"GetFeatureInfo"),r);const f=Math.floor((o[0]-_[0])/g),A=Math.floor((_[3]-o[1])/g);return E[this.v13_?"I":"X"]=f,E[this.v13_?"J":"Y"]=A,this.getRequestUrl_(d,_,1,a||n,E)}getLegendUrl(e,t){if(this.urls[0]===void 0)return;const s={SERVICE:"WMS",VERSION:S,REQUEST:"GetLegendGraphic",FORMAT:"image/png"};if(t===void 0||t.LAYER===void 0){const r=this.params_.LAYERS;if(!(!Array.isArray(r)||r.length===1))return;s.LAYER=r}if(e!==void 0){const r=this.getProjection()?this.getProjection().getMetersPerUnit():1,n=28e-5;s.SCALE=e*r/n}return Object.assign(s,t),j(this.urls[0],s)}getGutter(){return this.gutter_}getParams(){return this.params_}getRequestUrl_(e,t,s,r,n){const a=this.urls;if(!a)return;let c;if(a.length==1)c=a[0];else{const o=oe(J(e),a.length);c=a[o]}return W(t,(this.tileGrid||this.getTileGridForProjection(r)).getResolution(e[0]),s,r,c,n,this.serverType_)}getTilePixelRatio(e){return!this.hidpi_||this.serverType_===void 0?1:e}getKeyForParams_(){let e=0;const t=[];for(const s in this.params_)t[e++]=s+"-"+this.params_[s];return t.join("/")}setParams_(e){this.params_=e,this.updateV13_(),this.setKey(this.getKeyForParams_())}setParams(e){this.setParams_(Object.assign({},e))}updateParams(e){this.setParams_(Object.assign(this.params_,e))}updateV13_(){const e=this.params_.VERSION||S;this.v13_=p(e,"1.3")>=0}tileUrlFunction(e,t,s){let r=this.getTileGrid();if(r||(r=this.getTileGridForProjection(s)),r.getResolutions().length<=e[0])return;t!=1&&(!this.hidpi_||this.serverType_===void 0)&&(t=1);const n=r.getResolution(e[0]);let a=r.getTileCoordExtent(e,this.tmpExtent_);const c=this.gutter_;c!==0&&(a=F(a,n*c,a));const o=Object.assign({},O(this.params_,"GetMap"));return this.getRequestUrl_(e,a,t,s,o)}}export{le as A,m as D,_e as I,Ie as O,Se as T,Re as a,q as b,Ee as c,me as d,y as f,fe as g};

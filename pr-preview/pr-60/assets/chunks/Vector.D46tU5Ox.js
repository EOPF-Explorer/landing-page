import{q as lt,r as Bt,t as nt,u as st,v as vt,x as Gt,y as Yt,z as ei,A as j,D as Xt,E as dt,G as Nt,H as kt,J as Fe,K as ii,Z as ni,N as si,O as oi,Q as ye,l as ri,C as li,k as bt,R as Ce,U as Ie,B as ai}from"./Tile.6y57umDW.js";import{aN as oe,b1 as hi,b2 as ci,al as Mt,ar as Te,az as ke,b3 as di,b4 as Vt,b5 as fi,ac as re,b6 as ui,ag as U,k as it,U as Rt,b7 as gi,r as _i,aJ as Zt,aG as le,aM as yt,j as Re,aH as It,b8 as xi,ab as Ht,b9 as pi,aY as Pt,N as Si,ba as mi,p as yi,bb as Ci,bc as Ii,bd as Ti,q as we,be as We,a3 as Ct,a4 as ki,aL as Ri,$ as Ft,a2 as wi,aX as Li,bf as Ei}from"./Polygon.DGYqraVP.js";import{t as wt,k as Tt,u as Oi}from"./XYZ.CBnrgZcO.js";import{l as Di}from"./Feature.DysECzI9.js";class Pe{drawCustom(t,e,i,n,o){}drawGeometry(t){}setStyle(t){}drawCircle(t,e,i){}drawFeature(t,e,i){}drawGeometryCollection(t,e,i){}drawLineString(t,e,i){}drawMultiLineString(t,e,i){}drawMultiPoint(t,e,i){}drawMultiPolygon(t,e,i){}drawPoint(t,e,i){}drawPolygon(t,e,i){}drawText(t,e,i){}setFillStrokeStyle(t,e){}setImageStyle(t,e){}setTextStyle(t,e){}}const T={BEGIN_GEOMETRY:0,BEGIN_PATH:1,CIRCLE:2,CLOSE_PATH:3,CUSTOM:4,DRAW_CHARS:5,DRAW_IMAGE:6,END_GEOMETRY:7,FILL:8,MOVE_TO_LINE_TO:9,SET_FILL_STYLE:10,SET_STROKE_STYLE:11,STROKE:12},Wt=[T.FILL],at=[T.STROKE],ft=[T.BEGIN_PATH],Le=[T.CLOSE_PATH];class Lt extends Pe{constructor(t,e,i,n){super(),this.tolerance=t,this.maxExtent=e,this.pixelRatio=n,this.maxLineWidth=0,this.resolution=i,this.beginGeometryInstruction1_=null,this.beginGeometryInstruction2_=null,this.bufferedMaxExtent_=null,this.instructions=[],this.coordinates=[],this.tmpCoordinate_=[],this.hitDetectionInstructions=[],this.state={}}applyPixelRatio(t){const e=this.pixelRatio;return e==1?t:t.map(function(i){return i*e})}appendFlatPointCoordinates(t,e){const i=this.getBufferedMaxExtent(),n=this.tmpCoordinate_,o=this.coordinates;let s=o.length;for(let l=0,r=t.length;l<r;l+=e)n[0]=t[l],n[1]=t[l+1],oe(i,n)&&(o[s++]=n[0],o[s++]=n[1]);return s}appendFlatLineCoordinates(t,e,i,n,o,s){const l=this.coordinates;let r=l.length;const h=this.getBufferedMaxExtent();s&&(e+=n);let a=t[e],c=t[e+1];const u=this.tmpCoordinate_;let d=!0,g,p,_;for(g=e+n;g<i;g+=n)u[0]=t[g],u[1]=t[g+1],_=hi(h,u),_!==p?(d&&(l[r++]=a,l[r++]=c,d=!1),l[r++]=u[0],l[r++]=u[1]):_===ci.INTERSECTING?(l[r++]=u[0],l[r++]=u[1],d=!1):d=!0,a=u[0],c=u[1],p=_;return(o&&d||g===e+n)&&(l[r++]=a,l[r++]=c),r}drawCustomCoordinates_(t,e,i,n,o){for(let s=0,l=i.length;s<l;++s){const r=i[s],h=this.appendFlatLineCoordinates(t,e,r,n,!1,!1);o.push(h),e=r}return e}drawCustom(t,e,i,n,o){this.beginGeometry(t,e,o);const s=t.getType(),l=t.getStride(),r=this.coordinates.length;let h,a,c,u,d;switch(s){case"MultiPolygon":h=t.getOrientedFlatCoordinates(),u=[];const g=t.getEndss();d=0;for(let p=0,_=g.length;p<_;++p){const x=[];d=this.drawCustomCoordinates_(h,d,g[p],l,x),u.push(x)}this.instructions.push([T.CUSTOM,r,u,t,i,ke,o]),this.hitDetectionInstructions.push([T.CUSTOM,r,u,t,n||i,ke,o]);break;case"Polygon":case"MultiLineString":c=[],h=s=="Polygon"?t.getOrientedFlatCoordinates():t.getFlatCoordinates(),d=this.drawCustomCoordinates_(h,0,t.getEnds(),l,c),this.instructions.push([T.CUSTOM,r,c,t,i,Te,o]),this.hitDetectionInstructions.push([T.CUSTOM,r,c,t,n||i,Te,o]);break;case"LineString":case"Circle":h=t.getFlatCoordinates(),a=this.appendFlatLineCoordinates(h,0,h.length,l,!1,!1),this.instructions.push([T.CUSTOM,r,a,t,i,Mt,o]),this.hitDetectionInstructions.push([T.CUSTOM,r,a,t,n||i,Mt,o]);break;case"MultiPoint":h=t.getFlatCoordinates(),a=this.appendFlatPointCoordinates(h,l),a>r&&(this.instructions.push([T.CUSTOM,r,a,t,i,Mt,o]),this.hitDetectionInstructions.push([T.CUSTOM,r,a,t,n||i,Mt,o]));break;case"Point":h=t.getFlatCoordinates(),this.coordinates.push(h[0],h[1]),a=this.coordinates.length,this.instructions.push([T.CUSTOM,r,a,t,i,void 0,o]),this.hitDetectionInstructions.push([T.CUSTOM,r,a,t,n||i,void 0,o]);break}this.endGeometry(e)}beginGeometry(t,e,i){this.beginGeometryInstruction1_=[T.BEGIN_GEOMETRY,e,0,t,i],this.instructions.push(this.beginGeometryInstruction1_),this.beginGeometryInstruction2_=[T.BEGIN_GEOMETRY,e,0,t,i],this.hitDetectionInstructions.push(this.beginGeometryInstruction2_)}finish(){return{instructions:this.instructions,hitDetectionInstructions:this.hitDetectionInstructions,coordinates:this.coordinates}}reverseHitDetectionInstructions(){const t=this.hitDetectionInstructions;t.reverse();let e;const i=t.length;let n,o,s=-1;for(e=0;e<i;++e)n=t[e],o=n[0],o==T.END_GEOMETRY?s=e:o==T.BEGIN_GEOMETRY&&(n[2]=e,di(this.hitDetectionInstructions,s,e),s=-1)}fillStyleToState(t,e={}){if(t){const i=t.getColor();e.fillPatternScale=i&&typeof i=="object"&&"src"in i?this.pixelRatio:1,e.fillStyle=lt(i||j)}else e.fillStyle=void 0;return e}strokeStyleToState(t,e={}){if(t){const i=t.getColor();e.strokeStyle=lt(i||Xt);const n=t.getLineCap();e.lineCap=n!==void 0?n:Bt;const o=t.getLineDash();e.lineDash=o?o.slice():nt;const s=t.getLineDashOffset();e.lineDashOffset=s||st;const l=t.getLineJoin();e.lineJoin=l!==void 0?l:vt;const r=t.getWidth();e.lineWidth=r!==void 0?r:Gt;const h=t.getMiterLimit();e.miterLimit=h!==void 0?h:Yt;const a=t.getOffset();e.strokeOffset=a??ei,e.lineWidth>this.maxLineWidth&&(this.maxLineWidth=e.lineWidth,this.bufferedMaxExtent_=null)}else e.strokeStyle=void 0,e.lineCap=void 0,e.lineDash=null,e.lineDashOffset=void 0,e.lineJoin=void 0,e.lineWidth=void 0,e.miterLimit=void 0,e.strokeOffset=void 0;return e}setFillStrokeStyle(t,e){const i=this.state;this.fillStyleToState(t,i),this.strokeStyleToState(e,i)}createFill(t){const e=t.fillStyle,i=[T.SET_FILL_STYLE,e];return typeof e!="string"&&i.push(t.fillPatternScale),i}applyStroke(t){this.instructions.push(this.createStroke(t))}createStroke(t){return[T.SET_STROKE_STYLE,t.strokeStyle,t.lineWidth*this.pixelRatio,t.lineCap,t.lineJoin,t.miterLimit,t.lineDash?this.applyPixelRatio(t.lineDash):null,t.lineDashOffset*this.pixelRatio]}updateFillStyle(t,e){const i=t.fillStyle;(typeof i!="string"||t.currentFillStyle!=i)&&(this.instructions.push(e.call(this,t)),t.currentFillStyle=i)}updateStrokeStyle(t,e){const i=t.strokeStyle,n=t.lineCap,o=t.lineDash,s=t.lineDashOffset,l=t.lineJoin,r=t.lineWidth,h=t.miterLimit,a=t.strokeOffset;(t.currentStrokeStyle!=i||t.currentLineCap!=n||o!=t.currentLineDash&&!Vt(t.currentLineDash,o)||t.currentLineDashOffset!=s||t.currentLineJoin!=l||t.currentLineWidth!=r||t.currentMiterLimit!=h||t.currentStrokeOffset!=a)&&(e.call(this,t),t.currentStrokeStyle=i,t.currentLineCap=n,t.currentLineDash=o,t.currentLineDashOffset=s,t.currentLineJoin=l,t.currentLineWidth=r,t.currentMiterLimit=h,t.currentStrokeOffset=a)}endGeometry(t){this.beginGeometryInstruction1_[2]=this.instructions.length,this.beginGeometryInstruction1_=null,this.beginGeometryInstruction2_[2]=this.hitDetectionInstructions.length,this.beginGeometryInstruction2_=null;const e=[T.END_GEOMETRY,t];this.instructions.push(e),this.hitDetectionInstructions.push(e)}getBufferedMaxExtent(){if(!this.bufferedMaxExtent_&&(this.bufferedMaxExtent_=fi(this.maxExtent),this.maxLineWidth>0)){const t=this.resolution*(this.maxLineWidth+1)/2;re(this.bufferedMaxExtent_,t,this.bufferedMaxExtent_)}return this.bufferedMaxExtent_}}class bi extends Lt{constructor(t,e,i,n){super(t,e,i,n),this.hitDetectionImage_=null,this.image_=null,this.imagePixelRatio_=void 0,this.anchorX_=void 0,this.anchorY_=void 0,this.height_=void 0,this.opacity_=void 0,this.originX_=void 0,this.originY_=void 0,this.rotateWithView_=void 0,this.rotation_=void 0,this.scale_=void 0,this.width_=void 0,this.declutterMode_=void 0,this.declutterImageWithText_=void 0}drawPoint(t,e,i){if(!this.image_||this.maxExtent&&!oe(this.maxExtent,t.getFlatCoordinates()))return;this.beginGeometry(t,e,i);const n=t.getFlatCoordinates(),o=t.getStride(),s=this.coordinates.length,l=this.appendFlatPointCoordinates(n,o);this.instructions.push([T.DRAW_IMAGE,s,l,this.image_,this.anchorX_*this.imagePixelRatio_,this.anchorY_*this.imagePixelRatio_,Math.ceil(this.height_*this.imagePixelRatio_),this.opacity_,this.originX_*this.imagePixelRatio_,this.originY_*this.imagePixelRatio_,this.rotateWithView_,this.rotation_,[this.scale_[0]*this.pixelRatio/this.imagePixelRatio_,this.scale_[1]*this.pixelRatio/this.imagePixelRatio_],Math.ceil(this.width_*this.imagePixelRatio_),this.declutterMode_,this.declutterImageWithText_]),this.hitDetectionInstructions.push([T.DRAW_IMAGE,s,l,this.hitDetectionImage_,this.anchorX_,this.anchorY_,this.height_,1,this.originX_,this.originY_,this.rotateWithView_,this.rotation_,this.scale_,this.width_,this.declutterMode_,this.declutterImageWithText_]),this.endGeometry(e)}drawMultiPoint(t,e,i){if(!this.image_)return;this.beginGeometry(t,e,i);const n=t.getFlatCoordinates(),o=[];for(let r=0,h=n.length;r<h;r+=t.getStride())(!this.maxExtent||oe(this.maxExtent,n.slice(r,r+2)))&&o.push(n[r],n[r+1]);const s=this.coordinates.length,l=this.appendFlatPointCoordinates(o,2);this.instructions.push([T.DRAW_IMAGE,s,l,this.image_,this.anchorX_*this.imagePixelRatio_,this.anchorY_*this.imagePixelRatio_,Math.ceil(this.height_*this.imagePixelRatio_),this.opacity_,this.originX_*this.imagePixelRatio_,this.originY_*this.imagePixelRatio_,this.rotateWithView_,this.rotation_,[this.scale_[0]*this.pixelRatio/this.imagePixelRatio_,this.scale_[1]*this.pixelRatio/this.imagePixelRatio_],Math.ceil(this.width_*this.imagePixelRatio_),this.declutterMode_,this.declutterImageWithText_]),this.hitDetectionInstructions.push([T.DRAW_IMAGE,s,l,this.hitDetectionImage_,this.anchorX_,this.anchorY_,this.height_,1,this.originX_,this.originY_,this.rotateWithView_,this.rotation_,this.scale_,this.width_,this.declutterMode_,this.declutterImageWithText_]),this.endGeometry(e)}finish(){return this.reverseHitDetectionInstructions(),this.anchorX_=void 0,this.anchorY_=void 0,this.hitDetectionImage_=null,this.image_=null,this.imagePixelRatio_=void 0,this.height_=void 0,this.scale_=void 0,this.opacity_=void 0,this.originX_=void 0,this.originY_=void 0,this.rotateWithView_=void 0,this.rotation_=void 0,this.width_=void 0,super.finish()}setImageStyle(t,e){const i=t.getAnchor(),n=t.getSize(),o=t.getOrigin();this.imagePixelRatio_=t.getPixelRatio(this.pixelRatio),this.anchorX_=i[0],this.anchorY_=i[1],this.hitDetectionImage_=t.getHitDetectionImage(),this.image_=t.getImage(this.pixelRatio),this.height_=n[1],this.opacity_=t.getOpacity(),this.originX_=o[0],this.originY_=o[1],this.rotateWithView_=t.getRotateWithView(),this.rotation_=t.getRotation(),this.scale_=t.getScaleArray(),this.width_=n[0],this.declutterMode_=t.getDeclutterMode(),this.declutterImageWithText_=e}}class Mi extends Lt{constructor(t,e,i,n){super(t,e,i,n)}drawFlatCoordinates_(t,e,i,n,o){const s=this.coordinates.length,l=this.appendFlatLineCoordinates(t,e,i,n,!1,!1);return this.instructions.push([T.MOVE_TO_LINE_TO,s,l,o*this.pixelRatio]),this.hitDetectionInstructions.push([T.MOVE_TO_LINE_TO,s,l,o]),i}drawLineString(t,e,i){const n=this.state,o=n.strokeStyle,s=n.lineWidth,l=n.strokeOffset;if(o===void 0||s===void 0)return;this.updateStrokeStyle(n,this.applyStroke),this.beginGeometry(t,e,i),this.hitDetectionInstructions.push([T.SET_STROKE_STYLE,n.strokeStyle,n.lineWidth,n.lineCap,n.lineJoin,n.miterLimit,nt,st],ft);const r=t.getFlatCoordinates(),h=t.getStride();this.drawFlatCoordinates_(r,0,r.length,h,l),this.hitDetectionInstructions.push(at),this.endGeometry(e)}drawMultiLineString(t,e,i){const n=this.state,o=n.strokeStyle,s=n.lineWidth,l=n.strokeOffset;if(o===void 0||s===void 0)return;this.updateStrokeStyle(n,this.applyStroke),this.beginGeometry(t,e,i),this.hitDetectionInstructions.push([T.SET_STROKE_STYLE,n.strokeStyle,n.lineWidth,n.lineCap,n.lineJoin,n.miterLimit,nt,st],ft);const r=t.getEnds(),h=t.getFlatCoordinates(),a=t.getStride();let c=0;for(let u=0,d=r.length;u<d;++u)c=this.drawFlatCoordinates_(h,c,r[u],a,l);this.hitDetectionInstructions.push(at),this.endGeometry(e)}finish(){const t=this.state;return t.lastStroke!=null&&t.lastStroke!=this.coordinates.length&&this.instructions.push(at),this.reverseHitDetectionInstructions(),this.state=null,super.finish()}applyStroke(t){t.lastStroke!=null&&t.lastStroke!=this.coordinates.length&&(this.instructions.push(at),t.lastStroke=this.coordinates.length),t.lastStroke=0,super.applyStroke(t),this.instructions.push(ft)}}class Ee extends Lt{constructor(t,e,i,n){super(t,e,i,n)}drawFlatCoordinatess_(t,e,i,n,o){const s=this.state,l=s.fillStyle!==void 0,r=s.strokeStyle!==void 0,h=i.length;this.instructions.push(ft),this.hitDetectionInstructions.push(ft);for(let a=0;a<h;++a){const c=i[a],u=this.coordinates.length,d=this.appendFlatLineCoordinates(t,e,c,n,!0,!r);this.instructions.push([T.MOVE_TO_LINE_TO,u,d,o*this.pixelRatio,!0]),this.hitDetectionInstructions.push([T.MOVE_TO_LINE_TO,u,d,o,!0]),r&&(this.instructions.push(Le),this.hitDetectionInstructions.push(Le)),e=c}return l&&(this.instructions.push(Wt),this.hitDetectionInstructions.push(Wt)),r&&(this.instructions.push(at),this.hitDetectionInstructions.push(at)),e}drawCircle(t,e,i){const n=this.state,o=n.fillStyle,s=n.strokeStyle,l=n.strokeOffset;if(o===void 0&&s===void 0||this.handleStrokeOffset_(()=>this.drawCircle(t,e,i)))return;this.setFillStrokeStyles_(),this.beginGeometry(t,e,i),n.fillStyle!==void 0&&this.hitDetectionInstructions.push([T.SET_FILL_STYLE,j]),n.strokeStyle!==void 0&&this.hitDetectionInstructions.push([T.SET_STROKE_STYLE,n.strokeStyle,n.lineWidth,n.lineCap,n.lineJoin,n.miterLimit,nt,st]);const r=t.getFlatCoordinates(),h=t.getStride(),a=this.coordinates.length;this.appendFlatLineCoordinates(r,0,r.length,h,!1,!1);const c=[T.CIRCLE,a,l];this.instructions.push(ft,c),this.hitDetectionInstructions.push(ft,c),n.fillStyle!==void 0&&(this.instructions.push(Wt),this.hitDetectionInstructions.push(Wt)),n.strokeStyle!==void 0&&(this.instructions.push(at),this.hitDetectionInstructions.push(at)),this.endGeometry(e)}drawPolygon(t,e,i){const n=this.state,o=n.fillStyle,s=n.strokeStyle,l=n.strokeOffset;if(o===void 0&&s===void 0||this.handleStrokeOffset_(()=>this.drawPolygon(t,e,i)))return;this.setFillStrokeStyles_(),this.beginGeometry(t,e,i),n.fillStyle!==void 0&&this.hitDetectionInstructions.push([T.SET_FILL_STYLE,j]),n.strokeStyle!==void 0&&this.hitDetectionInstructions.push([T.SET_STROKE_STYLE,n.strokeStyle,n.lineWidth,n.lineCap,n.lineJoin,n.miterLimit,nt,st]);const r=t.getEnds(),h=t.getOrientedFlatCoordinates(),a=t.getStride();this.drawFlatCoordinatess_(h,0,r,a,l),this.endGeometry(e)}drawMultiPolygon(t,e,i){const n=this.state,o=n.fillStyle,s=n.strokeStyle,l=n.strokeOffset;if(o===void 0&&s===void 0||this.handleStrokeOffset_(()=>this.drawMultiPolygon(t,e,i)))return;this.setFillStrokeStyles_(),this.beginGeometry(t,e,i),n.fillStyle!==void 0&&this.hitDetectionInstructions.push([T.SET_FILL_STYLE,j]),n.strokeStyle!==void 0&&this.hitDetectionInstructions.push([T.SET_STROKE_STYLE,n.strokeStyle,n.lineWidth,n.lineCap,n.lineJoin,n.miterLimit,nt,st]);const r=t.getEndss(),h=t.getOrientedFlatCoordinates(),a=t.getStride();let c=0;for(let u=0,d=r.length;u<d;++u)c=this.drawFlatCoordinatess_(h,c,r[u],a,l);this.endGeometry(e)}finish(){this.reverseHitDetectionInstructions(),this.state=null;const t=this.tolerance;if(t!==0){const e=this.coordinates;for(let i=0,n=e.length;i<n;++i)e[i]=ui(e[i],t)}return super.finish()}setFillStrokeStyles_(){const t=this.state;this.updateFillStyle(t,this.createFill),this.updateStrokeStyle(t,this.applyStroke)}handleStrokeOffset_(t){const e=this.state,i=e.fillStyle,n=e.strokeStyle,o=e.strokeOffset;return Math.abs(o)>0&&i!==void 0&&n!==void 0?(e.strokeStyle=void 0,e.strokeOffset=0,t(),e.fillStyle=void 0,e.strokeStyle=n,e.strokeOffset=o,t(),e.fillStyle=i,!0):!1}}function Fi(f,t,e,i,n){const o=[];let s=e,l=0,r=t.slice(e,2);for(;l<f&&s+n<i;){const[h,a]=r.slice(-2),c=t[s+n],u=t[s+n+1],d=Math.sqrt((c-h)*(c-h)+(u-a)*(u-a));if(l+=d,l>=f){const g=(f-l+d)/d,p=U(h,c,g),_=U(a,u,g);r.push(p,_),o.push(r),r=[p,_],l==f&&(s+=n),l=0}else if(l<f)r.push(t[s+n],t[s+n+1]),s+=n;else{const g=d-l,p=U(h,c,g/d),_=U(a,u,g/d);r.push(p,_),o.push(r),r=[p,_],l=0,s+=n}}return l>0&&o.push(r),o}function Wi(f,t,e,i,n){let o=e,s=e,l=0,r=0,h=e,a,c,u,d,g,p,_,x,m,C;for(c=e;c<i;c+=n){const S=t[c],I=t[c+1];g!==void 0&&(m=S-g,C=I-p,d=Math.sqrt(m*m+C*C),_!==void 0&&(r+=u,a=Math.acos((_*m+x*C)/(u*d)),a>f&&(r>l&&(l=r,o=h,s=c),r=0,h=c-n)),u=d,_=m,x=C),g=S,p=I}return r+=d,r>l?[h,c]:[o,s]}const Jt={left:0,center:.5,right:1,top:0,middle:.5,hanging:.2,alphabetic:.8,ideographic:.8,bottom:1};class Pi extends Lt{constructor(t,e,i,n){super(t,e,i,n),this.labels_=null,this.text_="",this.textOffsetX_=0,this.textOffsetY_=0,this.textRotateWithView_=void 0,this.textKeepUpright_=void 0,this.textRotation_=0,this.textFillState_=null,this.fillStates={},this.fillStates[j]={fillStyle:j},this.textStrokeState_=null,this.strokeStates={},this.textState_={},this.textStates={},this.textKey_="",this.fillKey_="",this.strokeKey_="",this.declutterMode_=void 0,this.declutterImageWithText_=void 0}finish(){const t=super.finish();return t.textStates=this.textStates,t.fillStates=this.fillStates,t.strokeStates=this.strokeStates,t}drawText(t,e,i){const n=this.textFillState_,o=this.textStrokeState_,s=this.textState_;if(this.text_===""||!s||!n&&!o)return;const l=this.coordinates;let r=l.length;const h=t.getType();let a=null,c=t.getStride();if(s.placement==="line"&&(h=="LineString"||h=="MultiLineString"||h=="Polygon"||h=="MultiPolygon")){if(!it(this.maxExtent,t.getExtent()))return;let u;if(a=t.getFlatCoordinates(),h=="LineString")u=[a.length];else if(h=="MultiLineString")u=t.getEnds();else if(h=="Polygon")u=t.getEnds().slice(0,1);else if(h=="MultiPolygon"){const _=t.getEndss();u=[];for(let x=0,m=_.length;x<m;++x)u.push(_[x][0])}this.beginGeometry(t,e,i);const d=s.repeat,g=d?void 0:s.textAlign;let p=0;for(let _=0,x=u.length;_<x;++_){let m;d?m=Fi(d*this.resolution,a,p,u[_],c):m=[a.slice(p,u[_])];for(let C=0,S=m.length;C<S;++C){const I=m[C];let R=0,L=I.length;if(g==null){const k=Wi(s.maxAngle,I,0,I.length,2);R=k[0],L=k[1]}for(let k=R;k<L;k+=c)l.push(I[k],I[k+1]);const O=l.length;p=u[_],this.drawChars_(r,O),r=O}}this.endGeometry(e)}else{let u=s.overflow?null:[];switch(h){case"Point":case"MultiPoint":a=t.getFlatCoordinates();break;case"LineString":a=t.getFlatMidpoint();break;case"Circle":a=t.getCenter();break;case"MultiLineString":a=t.getFlatMidpoints(),c=2;break;case"Polygon":a=t.getFlatInteriorPoint(),s.overflow||u.push(a[2]/this.resolution),c=3;break;case"MultiPolygon":const S=t.getFlatInteriorPoints();a=[];for(let I=0,R=S.length;I<R;I+=3)s.overflow||u.push(S[I+2]/this.resolution),a.push(S[I],S[I+1]);if(a.length===0)return;c=2;break}const d=this.appendFlatPointCoordinates(a,c);if(d===r)return;if(u&&(d-r)/2!==a.length/c){let S=r/2;u=u.filter((I,R)=>{const L=l[(S+R)*2]===a[R*c]&&l[(S+R)*2+1]===a[R*c+1];return L||--S,L})}this.saveTextStates_();const g=s.backgroundFill?this.createFill(this.fillStyleToState(s.backgroundFill)):null,p=s.backgroundStroke?this.createStroke(this.strokeStyleToState(s.backgroundStroke)):null;this.beginGeometry(t,e,i);let _=s.padding;if(_!=dt&&(s.scale[0]<0||s.scale[1]<0)){let S=s.padding[0],I=s.padding[1],R=s.padding[2],L=s.padding[3];s.scale[0]<0&&(I=-I,L=-L),s.scale[1]<0&&(S=-S,R=-R),_=[S,I,R,L]}const x=this.pixelRatio;this.instructions.push([T.DRAW_IMAGE,r,d,null,NaN,NaN,NaN,1,0,0,this.textRotateWithView_,this.textRotation_,[1,1],NaN,this.declutterMode_,this.declutterImageWithText_,_==dt?dt:_.map(function(S){return S*x}),g,p,this.text_,this.textKey_,this.strokeKey_,this.fillKey_,this.textOffsetX_,this.textOffsetY_,u]);const m=1/x,C=g?g.slice(0):null;C&&(C[1]=j),this.hitDetectionInstructions.push([T.DRAW_IMAGE,r,d,null,NaN,NaN,NaN,1,0,0,this.textRotateWithView_,this.textRotation_,[m,m],NaN,this.declutterMode_,this.declutterImageWithText_,_,C,p,this.text_,this.textKey_,this.strokeKey_,this.fillKey_?j:this.fillKey_,this.textOffsetX_,this.textOffsetY_,u]),this.endGeometry(e)}}saveTextStates_(){const t=this.textStrokeState_,e=this.textState_,i=this.textFillState_,n=this.strokeKey_;t&&(n in this.strokeStates||(this.strokeStates[n]={strokeStyle:t.strokeStyle,lineCap:t.lineCap,lineDashOffset:t.lineDashOffset,lineWidth:t.lineWidth,lineJoin:t.lineJoin,miterLimit:t.miterLimit,lineDash:t.lineDash}));const o=this.textKey_;o in this.textStates||(this.textStates[o]={font:e.font,textAlign:e.textAlign||kt,justify:e.justify,textBaseline:e.textBaseline||Nt,scale:e.scale});const s=this.fillKey_;i&&(s in this.fillStates||(this.fillStates[s]={fillStyle:i.fillStyle}))}drawChars_(t,e){const i=this.textStrokeState_,n=this.textState_,o=this.strokeKey_,s=this.textKey_,l=this.fillKey_;this.saveTextStates_();const r=this.pixelRatio,h=Jt[n.textBaseline],a=this.textOffsetY_*r,c=this.text_,u=i?i.lineWidth*Math.abs(n.scale[0])/2:0;this.instructions.push([T.DRAW_CHARS,t,e,h,n.overflow,l,n.maxAngle,r,a,o,u*r,c,s,1,this.declutterMode_,this.textKeepUpright_]),this.hitDetectionInstructions.push([T.DRAW_CHARS,t,e,h,n.overflow,l&&j,n.maxAngle,r,a,o,u*r,c,s,1/r,this.declutterMode_,this.textKeepUpright_])}setTextStyle(t,e){let i,n,o;if(!t)this.text_="";else{const s=t.getFill();s?(n=this.textFillState_,n||(n={},this.textFillState_=n),n.fillStyle=lt(s.getColor()||j)):(n=null,this.textFillState_=n);const l=t.getStroke();if(!l)o=null,this.textStrokeState_=o;else{o=this.textStrokeState_,o||(o={},this.textStrokeState_=o);const p=l.getLineDash(),_=l.getLineDashOffset(),x=l.getWidth(),m=l.getMiterLimit();o.lineCap=l.getLineCap()||Bt,o.lineDash=p?p.slice():nt,o.lineDashOffset=_===void 0?st:_,o.lineJoin=l.getLineJoin()||vt,o.lineWidth=x===void 0?Gt:x,o.miterLimit=m===void 0?Yt:m,o.strokeStyle=lt(l.getColor()||Xt)}i=this.textState_;const r=t.getFont()||Fe;ii(r);const h=t.getScaleArray();i.overflow=t.getOverflow(),i.font=r,i.maxAngle=t.getMaxAngle(),i.placement=t.getPlacement(),i.textAlign=t.getTextAlign(),i.repeat=t.getRepeat(),i.justify=t.getJustify(),i.textBaseline=t.getTextBaseline()||Nt,i.backgroundFill=t.getBackgroundFill(),i.backgroundStroke=t.getBackgroundStroke(),i.padding=t.getPadding()||dt,i.scale=h===void 0?[1,1]:h;const a=t.getOffsetX(),c=t.getOffsetY(),u=t.getRotateWithView(),d=t.getKeepUpright(),g=t.getRotation();this.text_=t.getText()||"",this.textOffsetX_=a===void 0?0:a,this.textOffsetY_=c===void 0?0:c,this.textRotateWithView_=u===void 0?!1:u,this.textKeepUpright_=d===void 0?!0:d,this.textRotation_=g===void 0?0:g,this.strokeKey_=o?(typeof o.strokeStyle=="string"?o.strokeStyle:Rt(o.strokeStyle))+o.lineCap+o.lineDashOffset+"|"+o.lineWidth+o.lineJoin+o.miterLimit+"["+o.lineDash.join()+"]":"",this.textKey_=i.font+i.scale+(i.textAlign||"?")+(i.repeat||"?")+(i.justify||"?")+(i.textBaseline||"?"),this.fillKey_=n&&n.fillStyle?typeof n.fillStyle=="string"?n.fillStyle:"|"+Rt(n.fillStyle):""}this.declutterMode_=t.getDeclutterMode(),this.declutterImageWithText_=e}}const Ai={Circle:Ee,Default:Lt,Image:bi,LineString:Mi,Polygon:Ee,Text:Pi};class Bi{constructor(t,e,i,n){this.tolerance_=t,this.maxExtent_=e,this.pixelRatio_=n,this.resolution_=i,this.buildersByZIndex_={}}finish(){const t={};for(const e in this.buildersByZIndex_){t[e]=t[e]||{};const i=this.buildersByZIndex_[e];for(const n in i){const o=i[n].finish();t[e][n]=o}}return t}getBuilder(t,e){const i=t!==void 0?t.toString():"0";let n=this.buildersByZIndex_[i];n===void 0&&(n={},this.buildersByZIndex_[i]=n);let o=n[e];if(o===void 0){const s=Ai[e];o=new s(this.tolerance_,this.maxExtent_,this.resolution_,this.pixelRatio_),n[e]=o}return o}}function vi(f,t,e,i,n,o){n=n??[],o=o??t;const s=f[0],l=f[1],r=f[f.length-4],h=f[f.length-3];let a,c,u,d,g,p,_,x,m=0;for(let C=0;C<f.length;C+=t){u=a,d=c,g=void 0,p=void 0,C+t<f.length&&(g=f[C+t],p=f[C+t+1]),i&&C===0&&(u=r,d=h),i&&C===f.length-2&&(g=s,p=l),a=f[C],c=f[C+1],[_,x]=At(a,c,u,d,g,p,e),n[m++]=_,n[m++]=x;for(let S=2;S<o;S++)n[m++]=f[C+S]}return n.length!=m&&(n.length=m),n}function At(f,t,e,i,n,o,s){let l,r;e!==void 0&&i!==void 0?(l=f-e,r=t-i):n!==void 0&&o!==void 0?(l=n-f,r=o-t):(l=1,r=0);const h=Math.hypot(l,r),a=l/h,c=r/h;if(l=-c,r=a,e===void 0||i===void 0)return[f+l*s,t+r*s];if(n===void 0||o===void 0)return[f+l*s,t+r*s];const u=gi([f,t],[e,i],[n,o]);if(Math.cos(u)>.998)return[f+a*s,t+c*s];const d=Math.cos(u/2),g=Math.sin(u/2),p=g*l+d*r,_=-d*l+g*r,x=p*(1/g),m=_*(1/g);return[f+x*s,t+m*s]}function Gi(f,t,e,i,n,o,s,l,r,h,a,c,u=!0){let d=f[t],g=f[t+1],p=0,_=0,x=0,m=0;function C(){p=d,_=g,t+=i,d=f[t],g=f[t+1],m+=x,x=Math.sqrt((d-p)*(d-p)+(g-_)*(g-_))}do C();while(t<e-i&&m+x<o);let S=x===0?0:(o-m)/x;const I=U(p,d,S),R=U(_,g,S),L=t-i,O=m,k=o+l*r(h,n,a);for(;t<e-i&&m+x<k;)C();S=x===0?0:(k-m)/x;const P=U(p,d,S),B=U(_,g,S);let D=!1;if(u)if(c){const E=[I,R,P,B];_i(E,0,4,2,c,E,E),D=E[0]>E[2]}else D=I>P;const M=Math.PI,A=[],w=L+i===t;t=L,x=0,m=O,d=f[t],g=f[t+1];let b;if(w){C(),b=Math.atan2(g-_,d-p),D&&(b+=b>0?-M:M);const E=(P+I)/2,W=(B+R)/2;return A[0]=[E,W,(k-o)/2,b,n],A}n=n.replace(/\n/g," ");for(let E=0,W=n.length;E<W;){C();let F=Math.atan2(g-_,d-p);if(D&&(F+=F>0?-M:M),b!==void 0){let y=F-b;if(y+=y>M?-2*M:y<-M?2*M:0,Math.abs(y)>s)return null}b=F;const Y=E;let v=0;for(;E<W;++E){const y=D?W-E-1:E,jt=l*r(h,n[y],a);if(t+i<e&&m+x<o+v+jt/2)break;v+=jt}if(E===Y)continue;const X=D?n.substring(W-Y,W-E):n.substring(Y,E);S=x===0?0:(o+v/2-m)/x;const N=U(p,d,S),gt=U(_,g,S);A.push([N,gt,v/2,F,X]),o+=v}return A}const ut=Ht(),ot=[],tt=[],et=[],rt=[];function Oe(f){return f[3].declutterBox}const De=new RegExp("[֑-ࣿיִ-﷿ﹰ-ﻼࠀ-࿿-]");function ne(f,t){return t==="start"?t=De.test(f)?"right":"left":t==="end"&&(t=De.test(f)?"left":"right"),Jt[t]}function Yi(f,t,e){return e>0&&f.push(`
`,""),f.push(t,""),f}function Xi(f,t,e){return e%2===0&&(f+=t),f}class Ni{constructor(t,e,i,n,o){this.overlaps=i,this.pixelRatio=e,this.resolution=t,this.alignAndScaleFill_,this.instructions=n.instructions,this.coordinates=n.coordinates,this.coordinateCache_={},this.renderedTransform_=Zt(),this.hitDetectionInstructions=n.hitDetectionInstructions,this.pixelCoordinates_=null,this.viewRotation_=0,this.fillStates=n.fillStates||{},this.strokeStates=n.strokeStates||{},this.textStates=n.textStates||{},this.widths_={},this.labels_={},this.zIndexContext_=o?new ni:null}getZIndexContext(){return this.zIndexContext_}createLabel(t,e,i,n){const o=t+e+i+n;if(this.labels_[o])return this.labels_[o];const s=n?this.strokeStates[n]:null,l=i?this.fillStates[i]:null,r=this.textStates[e],h=this.pixelRatio,a=[r.scale[0]*h,r.scale[1]*h],c=r.justify?Jt[r.justify]:ne(Array.isArray(t)?t[0]:t,r.textAlign||kt),u=n&&s.lineWidth?s.lineWidth:0,d=Array.isArray(t)?t:String(t).split(`
`).reduce(Yi,[]),{width:g,height:p,widths:_,heights:x,lineWidths:m}=si(r,d),C=g+u,S=[],I=(C+2)*a[0],R=(p+u)*a[1],L={width:I<0?Math.floor(I):Math.ceil(I),height:R<0?Math.floor(R):Math.ceil(R),contextInstructions:S};(a[0]!=1||a[1]!=1)&&S.push("scale",a),n&&(S.push("strokeStyle",s.strokeStyle),S.push("lineWidth",u),S.push("lineCap",s.lineCap),S.push("lineJoin",s.lineJoin),S.push("miterLimit",s.miterLimit),S.push("setLineDash",[s.lineDash]),S.push("lineDashOffset",s.lineDashOffset)),i&&S.push("fillStyle",l.fillStyle),S.push("textBaseline","middle"),S.push("textAlign","center");const O=.5-c;let k=c*C+O*u;const P=[],B=[];let D=0,M=0,A=0,w=0,b;for(let E=0,W=d.length;E<W;E+=2){const F=d[E];if(F===`
`){M+=D,D=0,k=c*C+O*u,++w;continue}const Y=d[E+1]||r.font;Y!==b&&(n&&P.push("font",Y),i&&B.push("font",Y),b=Y),D=Math.max(D,x[A]);const v=[F,k+O*_[A]+c*(_[A]-m[w]),.5*(u+D)+M];k+=_[A],n&&P.push("strokeText",v),i&&B.push("fillText",v),++A}return Array.prototype.push.apply(S,P),Array.prototype.push.apply(S,B),this.labels_[o]=L,L}replayTextBackground_(t,e,i,n,o,s,l){t.beginPath(),t.moveTo.apply(t,e),t.lineTo.apply(t,i),t.lineTo.apply(t,n),t.lineTo.apply(t,o),t.lineTo.apply(t,e),s&&(this.alignAndScaleFill_=s[2],t.fillStyle=s[1],this.fill_(t)),l&&(this.setStrokeStyle_(t,l),t.stroke())}calculateImageOrLabelDimensions_(t,e,i,n,o,s,l,r,h,a,c,u,d,g,p,_){l*=u[0],r*=u[1];let x=i-l,m=n-r;const C=o+h>t?t-h:o,S=s+a>e?e-a:s,I=g[3]+C*u[0]+g[1],R=g[0]+S*u[1]+g[2],L=x-g[3],O=m-g[0];(p||c!==0)&&(ot[0]=L,rt[0]=L,ot[1]=O,tt[1]=O,tt[0]=L+I,et[0]=tt[0],et[1]=O+R,rt[1]=et[1]);let k;return c!==0?(k=le(Zt(),i,n,1,1,c,-i,-n),yt(k,ot),yt(k,tt),yt(k,et),yt(k,rt),Re(Math.min(ot[0],tt[0],et[0],rt[0]),Math.min(ot[1],tt[1],et[1],rt[1]),Math.max(ot[0],tt[0],et[0],rt[0]),Math.max(ot[1],tt[1],et[1],rt[1]),ut)):Re(Math.min(L,L+I),Math.min(O,O+R),Math.max(L,L+I),Math.max(O,O+R),ut),d&&(x=Math.round(x),m=Math.round(m)),{drawImageX:x,drawImageY:m,drawImageW:C,drawImageH:S,originX:h,originY:a,declutterBox:{minX:ut[0],minY:ut[1],maxX:ut[2],maxY:ut[3],value:_},canvasTransform:k,scale:u}}replayImageOrLabel_(t,e,i,n,o,s,l){const r=!!(s||l),h=n.declutterBox,a=l?l[2]*n.scale[0]/2:0;return h.minX-a<=e[0]&&h.maxX+a>=0&&h.minY-a<=e[1]&&h.maxY+a>=0&&(r&&this.replayTextBackground_(t,ot,tt,et,rt,s,l),oi(t,n.canvasTransform,o,i,n.originX,n.originY,n.drawImageW,n.drawImageH,n.drawImageX,n.drawImageY,n.scale)),!0}fill_(t){const e=this.alignAndScaleFill_;if(e){const i=yt(this.renderedTransform_,[0,0]),n=512*this.pixelRatio;t.save(),t.translate(i[0]%n,i[1]%n),e!==1&&t.scale(e,e)}t.fill(),e&&t.restore()}setStrokeStyle_(t,e){t.strokeStyle=e[1],e[1]&&(t.lineWidth=e[2],t.lineCap=e[3],t.lineJoin=e[4],t.miterLimit=e[5],t.lineDashOffset=e[7],t.setLineDash(e[6]))}drawLabelWithPointPlacement_(t,e,i,n){const o=this.textStates[e],s=this.createLabel(t,e,n,i),l=this.strokeStates[i],r=this.pixelRatio,h=ne(Array.isArray(t)?t[0]:t,o.textAlign||kt),a=Jt[o.textBaseline||Nt],c=l&&l.lineWidth?l.lineWidth:0,u=s.width/r-2*o.scale[0],d=h*u+2*(.5-h)*c,g=a*s.height/r+2*(.5-a)*c;return{label:s,anchorX:d,anchorY:g}}execute_(t,e,i,n,o,s,l,r){const h=this.zIndexContext_;let a;this.pixelCoordinates_&&Vt(i,this.renderedTransform_)?a=this.pixelCoordinates_:(this.pixelCoordinates_||(this.pixelCoordinates_=[]),a=It(this.coordinates,0,this.coordinates.length,2,i,this.pixelCoordinates_),xi(this.renderedTransform_,i));let c=0;const u=n.length;let d=0,g,p,_,x,m,C,S,I,R,L,O,k,P,B,D,M,A=0,w=0;const b=this.coordinateCache_,E=this.viewRotation_,W=Math.round(Math.atan2(-i[1],i[0])*1e12)/1e12,F={context:t,pixelRatio:this.pixelRatio,resolution:this.resolution,rotation:E},Y=this.instructions!=n||this.overlaps?0:200;let v,X,N,gt;for(;c<u;){const y=n[c];switch(y[0]){case T.BEGIN_GEOMETRY:v=y[1],gt=y[3],v.getGeometry()?l!==void 0&&!it(l,gt.getExtent())?c=y[2]+1:++c:c=y[2],h&&(h.zIndex=y[4]);break;case T.BEGIN_PATH:A>Y&&(this.fill_(t),A=0),w>Y&&(t.stroke(),w=0),!A&&!w&&(t.beginPath(),I=NaN,R=NaN),++c;break;case T.CIRCLE:d=y[1],x=y[2]??0;const Kt=a[d],Ut=a[d+1],Ne=a[d+2]-x,Ze=a[d+3]-x,ae=Ne-Kt,he=Ze-Ut,ce=Math.sqrt(ae*ae+he*he);t.moveTo(Kt+ce,Ut),t.arc(Kt,Ut,ce,0,2*Math.PI,!0),++c;break;case T.CLOSE_PATH:t.closePath(),++c;break;case T.CUSTOM:d=y[1],g=y[2];const He=y[3],Je=y[4],de=y[5];F.geometry=He,F.feature=v,c in b||(b[c]=[]);const _t=b[c];de?de(a,d,g,2,_t):(_t[0]=a[d],_t[1]=a[d+1],_t.length=2),h&&(h.zIndex=y[6]),Je(_t,F),++c;break;case T.DRAW_IMAGE:d=y[1],g=y[2],k=y[3],p=y[4],_=y[5];let zt=y[6];const Ve=y[7],je=y[8],Ke=y[9],fe=y[10];let qt=y[11];const Ue=y[12];let Et=y[13];S=y[14]||"declutter";const xt=y[15];if(!k&&y.length>=20){P=y[19],B=y[20],D=y[21],M=y[22];const H=this.drawLabelWithPointPlacement_(P,B,D,M);k=H.label,y[3]=k;const ht=y[23];p=(H.anchorX-ht)*this.pixelRatio,y[4]=p;const J=y[24];_=(H.anchorY-J)*this.pixelRatio,y[5]=_,zt=k.height,y[6]=zt,Et=k.width,y[13]=Et}let $t;y.length>25&&($t=y[25]);let Qt,Ot,Dt;y.length>17?(Qt=y[16],Ot=y[17],Dt=y[18]):(Qt=dt,Ot=null,Dt=null),fe&&W?qt+=E:!fe&&!W&&(qt-=E);let ze=0;for(;d<g;d+=2){if($t&&$t[ze++]<Et/this.pixelRatio)continue;const H=this.calculateImageOrLabelDimensions_(k.width,k.height,a[d],a[d+1],Et,zt,p,_,je,Ke,qt,Ue,o,Qt,!!Ot||!!Dt,v),ht=[t,e,k,H,Ve,Ot,Dt];if(r){let J,K,V;if(xt){const G=g-d;if(!xt[G]){xt[G]={args:ht,declutterMode:S};continue}const Z=xt[G];J=Z.args,K=Z.declutterMode,delete xt[G],V=Oe(J)}let q,$;if(J&&(K!=="declutter"||!r.collides(V))&&(q=!0),(S!=="declutter"||!r.collides(H.declutterBox))&&($=!0),K==="declutter"&&S==="declutter"){const G=q&&$;q=G,$=G}q&&(K!=="none"&&r.insert(V),this.replayImageOrLabel_.apply(this,J)),$&&(S!=="none"&&r.insert(H.declutterBox),this.replayImageOrLabel_.apply(this,ht))}else this.replayImageOrLabel_.apply(this,ht)}++c;break;case T.DRAW_CHARS:const ue=y[1],ge=y[2],te=y[3],qe=y[4];M=y[5];const $e=y[6],_e=y[7],xe=y[8];D=y[9];const ee=y[10];P=y[11],Array.isArray(P)&&(P=P.reduce(Xi,"")),B=y[12];const pe=[y[13],y[13]];S=y[14]||"declutter";const Qe=y[15],ie=this.textStates[B],pt=ie.font,St=[ie.scale[0]*_e,ie.scale[1]*_e];let mt;pt in this.widths_?mt=this.widths_[pt]:(mt={},this.widths_[pt]=mt);const Se=Di(a,ue,ge,2),me=Math.abs(St[0])*ye(pt,P,mt);if(qe||me<=Se){const H=this.textStates[B].textAlign,ht=(Se-me)*ne(P,H),J=Gi(a,ue,ge,2,P,ht,$e,Math.abs(St[0]),ye,pt,mt,W?0:this.viewRotation_,Qe);t:if(J){const K=[];let V,q,$,G,Z;if(D)for(V=0,q=J.length;V<q;++V){Z=J[V],$=Z[4],G=this.createLabel($,B,"",D),p=Z[2]+(St[0]<0?-ee:ee),_=te*G.height+(.5-te)*2*ee*St[1]/St[0]-xe;const Q=this.calculateImageOrLabelDimensions_(G.width,G.height,Z[0],Z[1],G.width,G.height,p,_,0,0,Z[3],pe,!1,dt,!1,v);if(r&&S==="declutter"&&r.collides(Q.declutterBox))break t;K.push([t,e,G,Q,1,null,null])}if(M)for(V=0,q=J.length;V<q;++V){Z=J[V],$=Z[4],G=this.createLabel($,B,M,""),p=Z[2],_=te*G.height-xe;const Q=this.calculateImageOrLabelDimensions_(G.width,G.height,Z[0],Z[1],G.width,G.height,p,_,0,0,Z[3],pe,!1,dt,!1,v);if(r&&S==="declutter"&&r.collides(Q.declutterBox))break t;K.push([t,e,G,Q,1,null,null])}r&&S!=="none"&&r.load(K.map(Oe));for(let Q=0,ti=K.length;Q<ti;++Q)this.replayImageOrLabel_.apply(this,K[Q])}}++c;break;case T.END_GEOMETRY:if(s!==void 0){v=y[1];const H=s(v,gt,S);if(H)return H}++c;break;case T.FILL:Y?A++:this.fill_(t),++c;break;case T.MOVE_TO_LINE_TO:for(d=y[1],g=y[2],x=y[3],m=y[4]??!1,X=a[d],N=a[d+1],x&&(C=d,[X,N]=At(X,N,m?a[g-4]:void 0,m?a[g-3]:void 0,a[d+2],a[d+3],x)),t.moveTo(X,N),I=X+.5|0,R=N+.5|0,d+=2;d<g;d+=2)X=a[d],N=a[d+1],L=X+.5|0,O=N+.5|0,(d==g-2||L!==I||O!==R)&&(x&&(d==g-2?[X,N]=At(X,N,a[d-2],a[d-1],m?a[C+2]:void 0,m?a[C+3]:void 0,x):[X,N]=At(X,N,a[d-2],a[d-1],a[d+2],a[d+3],x)),t.lineTo(X,N),I=L,R=O);++c;break;case T.SET_FILL_STYLE:this.alignAndScaleFill_=y[2],A&&(this.fill_(t),A=0,w&&(t.stroke(),w=0)),t.fillStyle=y[1],++c;break;case T.SET_STROKE_STYLE:w&&(t.stroke(),w=0),this.setStrokeStyle_(t,y),++c;break;case T.STROKE:Y?w++:t.stroke(),++c;break;default:++c;break}}A&&this.fill_(t),w&&t.stroke()}execute(t,e,i,n,o,s){this.viewRotation_=n,this.execute_(t,e,i,this.instructions,o,void 0,void 0,s)}executeHitDetection(t,e,i,n,o){return this.viewRotation_=i,this.execute_(t,[t.canvas.width,t.canvas.height],e,this.hitDetectionInstructions,!0,n,o)}}const ct=["Polygon","Circle","LineString","Image","Text","Default"],Ae=["Image","Text"],Zi=ct.filter(f=>!Ae.includes(f));let Be=!1,ve=!1;function Hi(){let f=0;const t=i=>{const n=wt(1,1,null,{willReadFrequently:i});let o=0;const s=performance.now();for(;performance.now()-s<50;++o)n.fillStyle=`rgba(255,0,${o%256},1)`,n.fillRect(0,0,1,1),n.getImageData(0,0,1,1);return f=o>f?o:f,o};Be={[t(!0)]:!0,[t(!1)]:!1,[t(void 0)]:void 0}[f],ve=!0}class Ji{constructor(t,e,i,n,o,s,l){this.maxExtent_=t,this.overlaps_=n,this.pixelRatio_=i,this.resolution_=e,this.renderBuffer_=s,this.executorsByZIndex_={},this.hitDetectionContext_=null,this.hitDetectionTransform_=Zt(),this.renderedContext_=null,this.deferredZIndexContexts_={},this.createExecutors_(o,l)}clip(t,e){const i=this.getClipCoords(e);t.beginPath(),t.moveTo(i[0],i[1]),t.lineTo(i[2],i[3]),t.lineTo(i[4],i[5]),t.lineTo(i[6],i[7]),t.clip()}createExecutors_(t,e){for(const i in t){let n=this.executorsByZIndex_[i];n===void 0&&(n={},this.executorsByZIndex_[i]=n);const o=t[i];for(const s in o){const l=o[s];n[s]=new Ni(this.resolution_,this.pixelRatio_,this.overlaps_,l,e)}}}hasExecutors(t){for(const e in this.executorsByZIndex_){const i=this.executorsByZIndex_[e];for(let n=0,o=t.length;n<o;++n)if(t[n]in i)return!0}return!1}forEachFeatureAtCoordinate(t,e,i,n,o,s){ve===!1&&Hi(),n=Math.round(n);const l=n*2+1,r=le(this.hitDetectionTransform_,n+.5,n+.5,1/e,-1/e,-i,-t[0],-t[1]),h=!this.hitDetectionContext_;h&&(this.hitDetectionContext_=wt(l,l,null,{willReadFrequently:Be}));const a=this.hitDetectionContext_;a.canvas.width!==l||a.canvas.height!==l?(a.canvas.width=l,a.canvas.height=l):h||a.clearRect(0,0,l,l);let c;this.renderBuffer_!==void 0&&(c=Ht(),pi(c,t),re(c,e*(this.renderBuffer_+n),c));const u=Vi(n);let d;function g(I,R,L){const O=a.getImageData(0,0,l,l).data;for(let k=0,P=u.length;k<P;k++)if(O[u[k]]>0){if(!s||L==="none"||d!=="Image"&&d!=="Text"||s.includes(I)){const B=(u[k]-3)/4,D=n-B%l,M=n-(B/l|0),A=o(I,R,D*D+M*M);if(A)return A}a.clearRect(0,0,l,l);break}}const p=Object.keys(this.executorsByZIndex_).map(Number);p.sort(Pt);let _,x,m,C,S;for(_=p.length-1;_>=0;--_){const I=p[_].toString();for(m=this.executorsByZIndex_[I],x=ct.length-1;x>=0;--x)if(d=ct[x],C=m[d],C!==void 0&&(S=C.executeHitDetection(a,r,i,g,c),S))return S}}getClipCoords(t){const e=this.maxExtent_;if(!e)return null;const i=e[0],n=e[1],o=e[2],s=e[3],l=[i,n,i,s,o,s,o,n];return It(l,0,8,2,t,l),l}isEmpty(){return Si(this.executorsByZIndex_)}execute(t,e,i,n,o,s,l){const r=Object.keys(this.executorsByZIndex_).map(Number);r.sort(l?mi:Pt),s=s||ct;const h=ct.length;for(let a=0,c=r.length;a<c;++a){const u=r[a].toString(),d=this.executorsByZIndex_[u];for(let g=0,p=s.length;g<p;++g){const _=s[g],x=d[_];if(x!==void 0){const m=l===null?void 0:x.getZIndexContext(),C=m?m.getContext():t,S=this.maxExtent_&&_!=="Image"&&_!=="Text";if(S&&(C.save(),this.clip(C,i)),!m||_==="Text"||_==="Image"?x.execute(C,e,i,n,o,l):m.pushFunction(I=>x.execute(I,e,i,n,o,l)),S&&C.restore(),m){m.offset();const I=r[a]*h+ct.indexOf(_);this.deferredZIndexContexts_[I]||(this.deferredZIndexContexts_[I]=[]),this.deferredZIndexContexts_[I].push(m)}}}}this.renderedContext_=t}getDeferredZIndexContexts(){return this.deferredZIndexContexts_}getRenderedContext(){return this.renderedContext_}renderDeferred(){const t=this.deferredZIndexContexts_,e=Object.keys(t).map(Number).sort(Pt);for(let i=0,n=e.length;i<n;++i)t[e[i]].forEach(o=>{o.draw(this.renderedContext_),o.clear()}),t[e[i]].length=0}}const se={};function Vi(f){if(se[f]!==void 0)return se[f];const t=f*2+1,e=f*f,i=new Array(e+1);for(let o=0;o<=f;++o)for(let s=0;s<=f;++s){const l=o*o+s*s;if(l>e)break;let r=i[l];r||(r=[],i[l]=r),r.push(((f+o)*t+(f+s))*4+3),o>0&&r.push(((f-o)*t+(f+s))*4+3),s>0&&(r.push(((f+o)*t+(f-s))*4+3),o>0&&r.push(((f-o)*t+(f-s))*4+3))}const n=[];for(let o=0,s=i.length;o<s;++o)i[o]&&n.push(...i[o]);return se[f]=n,n}class ji extends Pe{constructor(t,e,i,n,o,s,l){super(),this.context_=t,this.pixelRatio_=e,this.extent_=i,this.transform_=n,this.transformRotation_=n?yi(Math.atan2(n[1],n[0]),10):0,this.viewRotation_=o,this.squaredTolerance_=s,this.userTransform_=l,this.contextFillState_=null,this.contextStrokeState_=null,this.contextTextState_=null,this.fillState_=null,this.strokeState_=null,this.image_=null,this.imageAnchorX_=0,this.imageAnchorY_=0,this.imageHeight_=0,this.imageOpacity_=0,this.imageOriginX_=0,this.imageOriginY_=0,this.imageRotateWithView_=!1,this.imageRotation_=0,this.imageScale_=[0,0],this.imageWidth_=0,this.text_="",this.textOffsetX_=0,this.textOffsetY_=0,this.textRotateWithView_=!1,this.textRotation_=0,this.textScale_=[0,0],this.textFillState_=null,this.textStrokeState_=null,this.textState_=null,this.pixelCoordinates_=[],this.tmpLocalTransform_=Zt()}drawImages_(t,e,i,n){if(!this.image_)return;const o=It(t,e,i,n,this.transform_,this.pixelCoordinates_),s=this.context_,l=this.tmpLocalTransform_,r=s.globalAlpha;this.imageOpacity_!=1&&(s.globalAlpha=r*this.imageOpacity_);let h=this.imageRotation_;this.transformRotation_===0&&(h-=this.viewRotation_),this.imageRotateWithView_&&(h+=this.viewRotation_);for(let a=0,c=o.length;a<c;a+=2){const u=o[a]-this.imageAnchorX_,d=o[a+1]-this.imageAnchorY_;if(h!==0||this.imageScale_[0]!=1||this.imageScale_[1]!=1){const g=u+this.imageAnchorX_,p=d+this.imageAnchorY_;le(l,g,p,1,1,h,-g,-p),s.save(),s.transform.apply(s,l),s.translate(g,p),s.scale(this.imageScale_[0],this.imageScale_[1]),s.drawImage(this.image_,this.imageOriginX_,this.imageOriginY_,this.imageWidth_,this.imageHeight_,-this.imageAnchorX_,-this.imageAnchorY_,this.imageWidth_,this.imageHeight_),s.restore()}else s.drawImage(this.image_,this.imageOriginX_,this.imageOriginY_,this.imageWidth_,this.imageHeight_,u,d,this.imageWidth_,this.imageHeight_)}this.imageOpacity_!=1&&(s.globalAlpha=r)}drawText_(t,e,i,n){if(!this.textState_||this.text_==="")return;this.textFillState_&&this.setContextFillState_(this.textFillState_),this.textStrokeState_&&this.setContextStrokeState_(this.textStrokeState_),this.setContextTextState_(this.textState_);const o=It(t,e,i,n,this.transform_,this.pixelCoordinates_),s=this.context_;let l=this.textRotation_;for(this.transformRotation_===0&&(l-=this.viewRotation_),this.textRotateWithView_&&(l+=this.viewRotation_);e<i;e+=n){const r=o[e]+this.textOffsetX_,h=o[e+1]+this.textOffsetY_;l!==0||this.textScale_[0]!=1||this.textScale_[1]!=1?(s.save(),s.translate(r-this.textOffsetX_,h-this.textOffsetY_),s.rotate(l),s.translate(this.textOffsetX_,this.textOffsetY_),s.scale(this.textScale_[0],this.textScale_[1]),this.textStrokeState_&&s.strokeText(this.text_,0,0),this.textFillState_&&s.fillText(this.text_,0,0),s.restore()):(this.textStrokeState_&&s.strokeText(this.text_,r,h),this.textFillState_&&s.fillText(this.text_,r,h))}}moveToLineTo_(t,e,i,n,o,s){const l=this.context_;let r=It(t,e,i,n,this.transform_,this.pixelCoordinates_);Math.abs(s)>0&&(r=vi(r,n,s,o,r)),l.moveTo(r[0],r[1]);let h=r.length;o&&(h-=2);for(let a=2;a<h;a+=2)l.lineTo(r[a],r[a+1]);return o&&l.closePath(),i}drawRings_(t,e,i,n,o){for(let s=0,l=i.length;s<l;++s)e=this.moveToLineTo_(t,e,i[s],n,!0,o);return e}drawCircle(t){if(this.squaredTolerance_&&(t=t.simplifyTransformed(this.squaredTolerance_,this.userTransform_)),!!it(this.extent_,t.getExtent())){if(this.fillState_||this.strokeState_){this.fillState_&&this.setContextFillState_(this.fillState_),this.strokeState_&&this.setContextStrokeState_(this.strokeState_);const e=Ci(t,this.transform_,this.pixelCoordinates_),i=e[2]-e[0],n=e[3]-e[1],o=Math.sqrt(i*i+n*n),s=this.context_;s.beginPath(),s.arc(e[0],e[1],o,0,2*Math.PI),this.fillState_&&s.fill(),this.strokeState_&&s.stroke()}this.text_!==""&&this.drawText_(t.getCenter(),0,2,2)}}setStyle(t){this.setFillStrokeStyle(t.getFill(),t.getStroke()),this.setImageStyle(t.getImage()),this.setTextStyle(t.getText())}setTransform(t){this.transform_=t}drawGeometry(t){switch(t.getType()){case"Point":this.drawPoint(t);break;case"LineString":this.drawLineString(t);break;case"Polygon":this.drawPolygon(t);break;case"MultiPoint":this.drawMultiPoint(t);break;case"MultiLineString":this.drawMultiLineString(t);break;case"MultiPolygon":this.drawMultiPolygon(t);break;case"GeometryCollection":this.drawGeometryCollection(t);break;case"Circle":this.drawCircle(t);break}}drawFeature(t,e){const i=e.getGeometryFunction()(t);i&&(this.setStyle(e),this.drawGeometry(i))}drawGeometryCollection(t){const e=t.getGeometriesArray();for(let i=0,n=e.length;i<n;++i)this.drawGeometry(e[i])}drawPoint(t){this.squaredTolerance_&&(t=t.simplifyTransformed(this.squaredTolerance_,this.userTransform_));const e=t.getFlatCoordinates(),i=t.getStride();this.image_&&this.drawImages_(e,0,e.length,i),this.text_!==""&&this.drawText_(e,0,e.length,i)}drawMultiPoint(t){this.squaredTolerance_&&(t=t.simplifyTransformed(this.squaredTolerance_,this.userTransform_));const e=t.getFlatCoordinates(),i=t.getStride();this.image_&&this.drawImages_(e,0,e.length,i),this.text_!==""&&this.drawText_(e,0,e.length,i)}drawLineString(t){if(this.squaredTolerance_&&(t=t.simplifyTransformed(this.squaredTolerance_,this.userTransform_)),!!it(this.extent_,t.getExtent())){if(this.strokeState_){this.setContextStrokeState_(this.strokeState_);const e=this.context_,i=t.getFlatCoordinates();e.beginPath(),this.moveToLineTo_(i,0,i.length,t.getStride(),!1,this.strokeState_.strokeOffset),e.stroke()}if(this.text_!==""){const e=t.getFlatMidpoint();this.drawText_(e,0,2,2)}}}drawMultiLineString(t){this.squaredTolerance_&&(t=t.simplifyTransformed(this.squaredTolerance_,this.userTransform_));const e=t.getExtent();if(it(this.extent_,e)){if(this.strokeState_){this.setContextStrokeState_(this.strokeState_);const i=this.context_,n=t.getFlatCoordinates();let o=0;const s=t.getEnds(),l=t.getStride();i.beginPath();for(let r=0,h=s.length;r<h;++r)o=this.moveToLineTo_(n,o,s[r],l,!1,this.strokeState_.strokeOffset);i.stroke()}if(this.text_!==""){const i=t.getFlatMidpoints();this.drawText_(i,0,i.length,2)}}}drawPolygon(t){var e;if(this.squaredTolerance_&&(t=t.simplifyTransformed(this.squaredTolerance_,this.userTransform_)),!!it(this.extent_,t.getExtent())){if(this.strokeState_||this.fillState_){this.fillState_&&this.setContextFillState_(this.fillState_),this.strokeState_&&this.setContextStrokeState_(this.strokeState_);const i=this.context_;i.beginPath(),this.drawRings_(t.getOrientedFlatCoordinates(),0,t.getEnds(),t.getStride(),(e=this.strokeState_)==null?void 0:e.strokeOffset),this.fillState_&&i.fill(),this.strokeState_&&i.stroke()}if(this.text_!==""){const i=t.getFlatInteriorPoint();this.drawText_(i,0,2,2)}}}drawMultiPolygon(t){var e;if(this.squaredTolerance_&&(t=t.simplifyTransformed(this.squaredTolerance_,this.userTransform_)),!!it(this.extent_,t.getExtent())){if(this.strokeState_||this.fillState_){this.fillState_&&this.setContextFillState_(this.fillState_),this.strokeState_&&this.setContextStrokeState_(this.strokeState_);const i=this.context_,n=t.getOrientedFlatCoordinates();let o=0;const s=t.getEndss(),l=t.getStride();i.beginPath();for(let r=0,h=s.length;r<h;++r){const a=s[r];o=this.drawRings_(n,o,a,l,(e=this.strokeState_)==null?void 0:e.strokeOffset)}this.fillState_&&i.fill(),this.strokeState_&&i.stroke()}if(this.text_!==""){const i=t.getFlatInteriorPoints();this.drawText_(i,0,i.length,2)}}}setContextFillState_(t){const e=this.context_,i=this.contextFillState_;i?i.fillStyle!=t.fillStyle&&(i.fillStyle=t.fillStyle,e.fillStyle=t.fillStyle):(e.fillStyle=t.fillStyle,this.contextFillState_={fillStyle:t.fillStyle})}setContextStrokeState_(t){const e=this.context_,i=this.contextStrokeState_;i?(i.lineCap!=t.lineCap&&(i.lineCap=t.lineCap,e.lineCap=t.lineCap),Vt(i.lineDash,t.lineDash)||e.setLineDash(i.lineDash=t.lineDash),i.lineDashOffset!=t.lineDashOffset&&(i.lineDashOffset=t.lineDashOffset,e.lineDashOffset=t.lineDashOffset),i.lineJoin!=t.lineJoin&&(i.lineJoin=t.lineJoin,e.lineJoin=t.lineJoin),i.lineWidth!=t.lineWidth&&(i.lineWidth=t.lineWidth,e.lineWidth=t.lineWidth),i.miterLimit!=t.miterLimit&&(i.miterLimit=t.miterLimit,e.miterLimit=t.miterLimit),i.strokeStyle!=t.strokeStyle&&(i.strokeStyle=t.strokeStyle,e.strokeStyle=t.strokeStyle)):(e.lineCap=t.lineCap,e.setLineDash(t.lineDash),e.lineDashOffset=t.lineDashOffset,e.lineJoin=t.lineJoin,e.lineWidth=t.lineWidth,e.miterLimit=t.miterLimit,e.strokeStyle=t.strokeStyle,this.contextStrokeState_={lineCap:t.lineCap,lineDash:t.lineDash,lineDashOffset:t.lineDashOffset,lineJoin:t.lineJoin,lineWidth:t.lineWidth,miterLimit:t.miterLimit,strokeStyle:t.strokeStyle})}setContextTextState_(t){const e=this.context_,i=this.contextTextState_,n=t.textAlign?t.textAlign:kt;i?(i.font!=t.font&&(i.font=t.font,e.font=t.font),i.textAlign!=n&&(i.textAlign=n,e.textAlign=n),i.textBaseline!=t.textBaseline&&(i.textBaseline=t.textBaseline,e.textBaseline=t.textBaseline)):(e.font=t.font,e.textAlign=n,e.textBaseline=t.textBaseline,this.contextTextState_={font:t.font,textAlign:n,textBaseline:t.textBaseline})}setFillStrokeStyle(t,e){if(!t)this.fillState_=null;else{const i=t.getColor();this.fillState_={fillStyle:lt(i||j)}}if(!e)this.strokeState_=null;else{const i=e.getColor(),n=e.getLineCap(),o=e.getLineDash(),s=e.getLineDashOffset(),l=e.getLineJoin(),r=e.getWidth(),h=e.getMiterLimit(),a=o||nt,c=e.getOffset();this.strokeState_={lineCap:n!==void 0?n:Bt,lineDash:this.pixelRatio_===1?a:a.map(u=>u*this.pixelRatio_),lineDashOffset:(s||st)*this.pixelRatio_,lineJoin:l!==void 0?l:vt,lineWidth:(r!==void 0?r:Gt)*this.pixelRatio_,miterLimit:h!==void 0?h:Yt,strokeStyle:lt(i||Xt),strokeOffset:(c??0)*this.pixelRatio_}}}setImageStyle(t){let e;if(!t||!(e=t.getSize())){this.image_=null;return}const i=t.getPixelRatio(this.pixelRatio_),n=t.getAnchor(),o=t.getOrigin();this.image_=t.getImage(this.pixelRatio_),this.imageAnchorX_=n[0]*i,this.imageAnchorY_=n[1]*i,this.imageHeight_=e[1]*i,this.imageOpacity_=t.getOpacity(),this.imageOriginX_=o[0],this.imageOriginY_=o[1],this.imageRotateWithView_=t.getRotateWithView(),this.imageRotation_=t.getRotation();const s=t.getScaleArray();this.imageScale_=[s[0]*this.pixelRatio_/i,s[1]*this.pixelRatio_/i],this.imageWidth_=e[0]*i}setTextStyle(t){if(!t)this.text_="";else{const e=t.getFill();if(!e)this.textFillState_=null;else{const d=e.getColor();this.textFillState_={fillStyle:lt(d||j)}}const i=t.getStroke();if(!i)this.textStrokeState_=null;else{const d=i.getColor(),g=i.getLineCap(),p=i.getLineDash(),_=i.getLineDashOffset(),x=i.getLineJoin(),m=i.getWidth(),C=i.getMiterLimit();this.textStrokeState_={lineCap:g!==void 0?g:Bt,lineDash:p||nt,lineDashOffset:_||st,lineJoin:x!==void 0?x:vt,lineWidth:m!==void 0?m:Gt,miterLimit:C!==void 0?C:Yt,strokeStyle:lt(d||Xt)}}const n=t.getFont(),o=t.getOffsetX(),s=t.getOffsetY(),l=t.getRotateWithView(),r=t.getRotation(),h=t.getScaleArray(),a=t.getText(),c=t.getTextAlign(),u=t.getTextBaseline();this.textState_={font:n!==void 0?n:Fe,textAlign:c!==void 0?c:kt,textBaseline:u!==void 0?u:Nt},this.text_=a!==void 0?Array.isArray(a)?a.reduce((d,g,p)=>d+=p%2?" ":g,""):a:"",this.textOffsetX_=o!==void 0?this.pixelRatio_*o:0,this.textOffsetY_=s!==void 0?this.pixelRatio_*s:0,this.textRotateWithView_=l!==void 0?l:!1,this.textRotation_=r!==void 0?r:0,this.textScale_=[this.pixelRatio_*h[0],this.pixelRatio_*h[1]]}}}const z=.5;function Ki(f,t,e,i,n,o,s,l,r){const h=r?We(n):n,a=f[0]*z,c=f[1]*z,u=wt(a,c);u.imageSmoothingEnabled=!1;const d=u.canvas,g=new ji(u,z,n,null,s,l,r?Ii(Ti(),r):null),p=e.length,_=Math.floor((256*256*256-1)/p),x={};for(let C=1;C<=p;++C){const S=e[C-1],I=S.getStyleFunction()||i;if(!I)continue;let R=I(S,o);if(!R)continue;Array.isArray(R)||(R=[R]);const O=(C*_).toString(16).padStart(7,"#00000");for(let k=0,P=R.length;k<P;++k){const B=R[k],D=B.getGeometryFunction()(S);if(!D||!it(h,D.getExtent()))continue;const M=B.clone(),A=M.getFill();A&&A.setColor(O);const w=M.getStroke();w&&(w.setColor(O),w.setLineDash(null)),M.setText(void 0);const b=B.getImage();if(b){const Y=b.getImageSize();if(!Y)continue;const v=wt(Y[0],Y[1],void 0,{alpha:!1}),X=v.canvas;v.fillStyle=O,v.fillRect(0,0,X.width,X.height),M.setImage(new ri({img:X,anchor:b.getAnchor(),anchorXUnits:"pixels",anchorYUnits:"pixels",offset:b.getOrigin(),opacity:1,size:b.getSize(),scale:b.getScale(),rotation:b.getRotation(),rotateWithView:b.getRotateWithView()}))}const E=M.getZIndex()||0;let W=x[E];W||(W={},x[E]=W,W.Polygon=[],W.Circle=[],W.LineString=[],W.Point=[]);const F=D.getType();if(F==="GeometryCollection"){const Y=D.getGeometriesArrayRecursive();for(let v=0,X=Y.length;v<X;++v){const N=Y[v];W[N.getType().replace("Multi","")].push(N,M)}}else W[F.replace("Multi","")].push(D,M)}}const m=Object.keys(x).map(Number).sort(Pt);for(let C=0,S=m.length;C<S;++C){const I=x[m[C]];for(const R in I){const L=I[R];for(let O=0,k=L.length;O<k;O+=2){g.setStyle(L[O+1]);for(let P=0,B=t.length;P<B;++P)g.setTransform(t[P]),g.drawGeometry(L[O])}}}return u.getImageData(0,0,d.width,d.height)}function Ui(f,t,e){const i=[];if(e){const n=Math.floor(Math.round(f[0])*z),o=Math.floor(Math.round(f[1])*z),s=(we(n,0,e.width-1)+we(o,0,e.height-1)*e.width)*4,l=e.data[s],r=e.data[s+1],a=e.data[s+2]+256*(r+256*l),c=Math.floor((256*256*256-1)/t.length);a&&a%c===0&&i.push(t[a/c-1])}return i}const zi=.5,Ge={Point:on,LineString:en,Polygon:ln,MultiPoint:rn,MultiLineString:nn,MultiPolygon:sn,GeometryCollection:tn,Circle:$i};function qi(f,t){return parseInt(Rt(f),10)-parseInt(Rt(t),10)}function be(f,t){const e=Ye(f,t);return e*e}function Ye(f,t){return zi*f/t}function $i(f,t,e,i,n){const o=e.getFill(),s=e.getStroke();if(o||s){const r=f.getBuilder(e.getZIndex(),"Circle");r.setFillStrokeStyle(o,s),r.drawCircle(t,i,n)}const l=e.getText();if(l&&l.getText()){const r=f.getBuilder(e.getZIndex(),"Text");r.setTextStyle(l),r.drawText(t,i)}}function Me(f,t,e,i,n,o,s,l){const r=[],h=e.getImage();if(h){let u=!0;const d=h.getImageState();d==Tt.LOADED||d==Tt.ERROR?u=!1:d==Tt.IDLE&&h.load(),u&&r.push(h.ready())}const a=e.getFill();a&&a.loading()&&r.push(a.ready());const c=r.length>0;return c&&Promise.all(r).then(()=>n(null)),Qi(f,t,e,i,o,s,l),c}function Qi(f,t,e,i,n,o,s){const l=e.getGeometryFunction()(t);if(!l)return;const r=l.simplifyTransformed(i,n);if(e.getRenderer())Xe(f,r,e,t,s);else{const a=Ge[r.getType()];a(f,r,e,t,s,o)}}function Xe(f,t,e,i,n){if(t.getType()=="GeometryCollection"){const s=t.getGeometries();for(let l=0,r=s.length;l<r;++l)Xe(f,s[l],e,i,n);return}f.getBuilder(e.getZIndex(),"Default").drawCustom(t,i,e.getRenderer(),e.getHitDetectionRenderer(),n)}function tn(f,t,e,i,n,o){const s=t.getGeometriesArray();let l,r;for(l=0,r=s.length;l<r;++l){const h=Ge[s[l].getType()];h(f,s[l],e,i,n,o)}}function en(f,t,e,i,n){const o=e.getStroke();if(o){const l=f.getBuilder(e.getZIndex(),"LineString");l.setFillStrokeStyle(null,o),l.drawLineString(t,i,n)}const s=e.getText();if(s&&s.getText()){const l=f.getBuilder(e.getZIndex(),"Text");l.setTextStyle(s),l.drawText(t,i,n)}}function nn(f,t,e,i,n){const o=e.getStroke();if(o){const l=f.getBuilder(e.getZIndex(),"LineString");l.setFillStrokeStyle(null,o),l.drawMultiLineString(t,i,n)}const s=e.getText();if(s&&s.getText()){const l=f.getBuilder(e.getZIndex(),"Text");l.setTextStyle(s),l.drawText(t,i,n)}}function sn(f,t,e,i,n){const o=e.getFill(),s=e.getStroke();if(s||o){const r=f.getBuilder(e.getZIndex(),"Polygon");r.setFillStrokeStyle(o,s),r.drawMultiPolygon(t,i,n)}const l=e.getText();if(l&&l.getText()){const r=f.getBuilder(e.getZIndex(),"Text");r.setTextStyle(l),r.drawText(t,i,n)}}function on(f,t,e,i,n,o){const s=e.getImage(),l=e.getText(),r=l&&l.getText(),h=o&&s&&r?{}:void 0;if(s){if(s.getImageState()!=Tt.LOADED)return;const a=f.getBuilder(e.getZIndex(),"Image");a.setImageStyle(s,h),a.drawPoint(t,i,n)}if(r){const a=f.getBuilder(e.getZIndex(),"Text");a.setTextStyle(l,h),a.drawText(t,i,n)}}function rn(f,t,e,i,n,o){const s=e.getImage(),l=s&&s.getOpacity()!==0,r=e.getText(),h=r&&r.getText(),a=o&&l&&h?{}:void 0;if(l){if(s.getImageState()!=Tt.LOADED)return;const c=f.getBuilder(e.getZIndex(),"Image");c.setImageStyle(s,a),c.drawMultiPoint(t,i,n)}if(h){const c=f.getBuilder(e.getZIndex(),"Text");c.setTextStyle(r,a),c.drawText(t,i,n)}}function ln(f,t,e,i,n){const o=e.getFill(),s=e.getStroke();if(o||s){const r=f.getBuilder(e.getZIndex(),"Polygon");r.setFillStrokeStyle(o,s),r.drawPolygon(t,i,n)}const l=e.getText();if(l&&l.getText()){const r=f.getBuilder(e.getZIndex(),"Text");r.setTextStyle(l),r.drawText(t,i,n)}}class an extends li{constructor(t){super(t),this.boundHandleStyleImageChange_=this.handleStyleImageChange_.bind(this),this.animatingOrInteracting_,this.hitDetectionImageData_=null,this.clipExtent_=null,this.extendX_=!1,this.renderedFeatures_=null,this.renderedRevision_=-1,this.renderedResolution_=NaN,this.renderedExtent_=Ht(),this.wrappedRenderedExtent_=Ht(),this.renderedRotation_,this.renderedCenter_=null,this.renderedProjection_=null,this.renderedPixelRatio_=1,this.renderedRenderOrder_=null,this.renderedFrameDeclutter_,this.replayGroup_=null,this.replayGroupChanged=!0,this.clipping=!0,this.targetContext_=null,this.opacity_=1}renderWorlds(t,e,i){const n=e.extent,o=e.viewState,s=o.center,l=o.resolution,r=o.projection,h=o.rotation,a=r.getExtent(),c=this.getLayer().getSource(),u=this.getLayer().getDeclutter(),d=e.pixelRatio,g=e.viewHints,p=!(g[bt.ANIMATING]||g[bt.INTERACTING]),_=this.context,x=Math.round(Ct(n)/l*d),m=Math.round(ki(n)/l*d),C=c.getWrapX()&&r.canWrapX(),S=C?Ct(a):null,I=C?Math.ceil((n[2]-a[2])/S)+(this.extendX_?2:1):1;let R=C?Math.floor((n[0]-a[0])/S)-(this.extendX_?1:0):0;do{let L=this.getRenderTransform(s,l,0,d,x,m,R*S);e.declutter&&(L=L.slice(0)),t.execute(_,[_.canvas.width,_.canvas.height],L,h,p,i===void 0?ct:i?Ae:Zi,i?u&&e.declutter[u]:void 0)}while(++R<I)}setDrawContext_(){this.opacity_!==1&&(this.targetContext_=this.context,this.context=wt(this.context.canvas.width,this.context.canvas.height,Ce))}resetDrawContext_(){if(this.opacity_!==1&&this.targetContext_){const t=this.targetContext_.globalAlpha;this.targetContext_.globalAlpha=this.opacity_,this.targetContext_.drawImage(this.context.canvas,0,0),this.targetContext_.globalAlpha=t,Oi(this.context),Ce.push(this.context.canvas),this.context=this.targetContext_,this.targetContext_=null}}renderDeclutter(t){!this.replayGroup_||!this.getLayer().getDeclutter()||this.renderWorlds(this.replayGroup_,t,!0)}renderDeferredInternal(t){this.replayGroup_&&(this.clipExtent_&&this.clipUnrotated(this.context,t,this.clipExtent_),this.replayGroup_.renderDeferred(),this.clipExtent_&&(this.context.restore(),this.clipExtent_=null),this.resetDrawContext_())}renderFrame(t,e){const i=t.layerStatesArray[t.layerIndex];this.opacity_=i.opacity;const n=t.viewState;this.prepareContainer(t,e);const o=this.context,s=this.replayGroup_;let l=s&&!s.isEmpty();if(!l&&!(this.getLayer().hasListener(Ie.PRERENDER)||this.getLayer().hasListener(Ie.POSTRENDER)))return this.container;this.setDrawContext_(),this.preRender(o,t),n.projection,this.clipExtent_=null;let r=!1;if(l&&i.extent&&this.clipping){const h=Ri(i.extent);l=it(h,t.extent),l&&!Ft(h,t.extent)&&(t.declutter?this.clipExtent_=h:(this.clipUnrotated(o,t,h),r=!0))}return l&&this.renderWorlds(s,t,this.getLayer().getDeclutter()?!1:void 0),r&&o.restore(),this.postRender(o,t),this.renderedRotation_!==n.rotation&&(this.renderedRotation_=n.rotation,this.hitDetectionImageData_=null),t.declutter||this.resetDrawContext_(),this.container}getFeatures(t){return new Promise(e=>{if(this.frameState&&!this.hitDetectionImageData_&&!this.animatingOrInteracting_){const i=this.frameState.size.slice(),n=this.renderedCenter_,o=this.renderedResolution_,s=this.renderedRotation_,l=this.renderedProjection_,r=this.wrappedRenderedExtent_,h=this.getLayer(),a=[],c=i[0]*z,u=i[1]*z;a.push(this.getRenderTransform(n,o,s,z,c,u,0).slice());const d=h.getSource(),g=l.getExtent();if(d.getWrapX()&&l.canWrapX()&&!Ft(g,r)){let p=r[0];const _=Ct(g);let x=0,m;for(;p<g[0];)--x,m=_*x,a.push(this.getRenderTransform(n,o,s,z,c,u,m).slice()),p+=_;for(x=0,p=r[2];p>g[2];)++x,m=_*x,a.push(this.getRenderTransform(n,o,s,z,c,u,m).slice()),p-=_}this.hitDetectionImageData_=Ki(i,a,this.renderedFeatures_,h.getStyleFunction(),r,o,s,be(o,this.renderedPixelRatio_),null)}e(Ui(t,this.renderedFeatures_,this.hitDetectionImageData_))})}forEachFeatureAtCoordinate(t,e,i,n,o){var u,d;if(!this.replayGroup_)return;const s=e.viewState.resolution,l=e.viewState.rotation,r=this.getLayer(),h={},a=function(g,p,_){const x=Rt(g),m=h[x];if(m){if(m!==!0&&_<m.distanceSq){if(_===0)return h[x]=!0,o.splice(o.lastIndexOf(m),1),n(g,r,p);m.geometry=p,m.distanceSq=_}}else{if(_===0)return h[x]=!0,n(g,r,p);o.push(h[x]={feature:g,layer:r,geometry:p,distanceSq:_,callback:n})}},c=this.getLayer().getDeclutter();return this.replayGroup_.forEachFeatureAtCoordinate(t,s,l,i,a,c?(d=(u=e.declutter)==null?void 0:u[c])==null?void 0:d.all().map(g=>g.value):null)}handleFontsChanged(){const t=this.getLayer();t.getVisible()&&this.replayGroup_&&t.changed()}handleStyleImageChange_(t){this.renderIfReadyAndVisible()}prepareFrame(t){const e=this.getLayer(),i=e.getSource();if(!i)return!1;const n=t.viewHints[bt.ANIMATING],o=t.viewHints[bt.INTERACTING],s=e.getUpdateWhileAnimating(),l=e.getUpdateWhileInteracting();if(this.ready&&!s&&n||!l&&o)return this.animatingOrInteracting_=!0,!0;this.animatingOrInteracting_=!1;const r=t.extent,h=t.viewState,a=h.projection,c=h.resolution,u=t.pixelRatio,d=e.getRevision(),g=e.getRenderBuffer();let p=e.getRenderOrder();p===void 0&&(p=qi);const _=h.center.slice(),x=re(r,g*c),m=x.slice(),C=[x.slice()],S=a.getExtent(),I=i.getWrapX()&&a.canWrapX();if(this.extendX_=!1,I){const w=i.getExtent();w&&!wi(w)&&(this.extendX_=w[0]<S[0]||w[2]>S[2])}if(I&&(!Ft(S,t.extent)||this.extendX_)){const w=Ct(S),b=Math.max(Ct(x)/2,w);let E=S[0],W=S[2];this.extendX_&&(E-=w,W+=w),x[0]=E-b,x[2]=W+b,Li(_,a);const F=Ei(C[0],a);F[0]<S[0]&&F[2]<S[2]?C.push([F[0]+w,F[1],F[2]+w,F[3]]):F[0]>S[0]&&F[2]>S[2]&&C.push([F[0]-w,F[1],F[2]-w,F[3]])}if(this.ready&&this.renderedResolution_==c&&this.renderedPixelRatio_===u&&this.renderedRevision_==d&&this.renderedRenderOrder_==p&&this.renderedFrameDeclutter_===!!t.declutter&&Ft(this.wrappedRenderedExtent_,x))return Vt(this.renderedExtent_,m)||(this.hitDetectionImageData_=null,this.renderedExtent_=m),this.renderedCenter_=_,this.replayGroupChanged=!1,!0;this.replayGroup_=null;const R=new Bi(Ye(c,u),x,c,u);let L;for(let w=0,b=C.length;w<b;++w)i.loadFeatures(C[w],c,a);const O=be(c,u);let k=!0;const P=(w,b)=>{let E;const W=w.getStyleFunction()||e.getStyleFunction();if(W&&(E=W(w,c)),E){const F=this.renderFeature(w,O,E,R,L,this.getLayer().getDeclutter(),b);k=k&&!F}},B=We(x),D=i.getFeaturesInExtent(B);p&&D.sort(p);for(let w=0,b=D.length;w<b;++w)P(D[w],w);this.renderedFeatures_=D,this.ready=k;const M=R.finish(),A=new Ji(x,c,u,i.getOverlaps(),M,e.getRenderBuffer(),!!t.declutter);return this.renderedResolution_=c,this.renderedRevision_=d,this.renderedRenderOrder_=p,this.renderedFrameDeclutter_=!!t.declutter,this.renderedExtent_=m,this.wrappedRenderedExtent_=x,this.renderedCenter_=_,this.renderedProjection_=a,this.renderedPixelRatio_=u,this.replayGroup_=A,this.hitDetectionImageData_=null,this.replayGroupChanged=!0,!0}renderFeature(t,e,i,n,o,s,l){if(!i)return!1;let r=!1;if(Array.isArray(i))for(let h=0,a=i.length;h<a;++h)r=Me(n,t,i[h],e,this.boundHandleStyleImageChange_,o,s,l)||r;else r=Me(n,t,i,e,this.boundHandleStyleImageChange_,o,s,l);return r}}class un extends ai{constructor(t){super(t)}createRenderer(){return new an(this)}}export{Bi as B,ji as C,Ae as D,Ji as E,z as H,un as V,an as a,Ki as c,be as g,Ui as h,Me as r};

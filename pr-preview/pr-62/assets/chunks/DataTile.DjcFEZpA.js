var Xt=Object.defineProperty;var je=t=>{throw TypeError(t)};var $t=(t,e,r)=>e in t?Xt(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r;var ze=(t,e,r)=>$t(t,typeof e!="symbol"?e+"":e,r),Re=(t,e,r)=>e.has(t)||je("Cannot "+r);var ge=(t,e,r)=>(Re(t,e,"read from private field"),r?r.call(t):e.get(t)),ue=(t,e,r)=>e.has(t)?je("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,r),pe=(t,e,r,i)=>(Re(t,e,"write to private field"),i?i.call(t,r):e.set(t,r),r),xe=(t,e,r)=>(Re(t,e,"access private method"),r);import{aA as Ht,aB as dt,U as H,aC as jt,h as _e,x as Tt,aD as zt,aE as Wt,an as re,I as F,K as _t,aF as Et,J as q,N as Yt,O as Oe,aG as ve,Q as Pe,n as Rt,L as Vt,aH as Ue,E as J,R as me,T as Kt,B as We,C as Zt,aI as kt,Y as qt,aJ as ee,aK as Jt,aL as Ye,aM as Qt,aN as er,aO as tr,_ as k,Z as gt,s as rr,H as Ve,aq as ir,aP as nr,aQ as sr,aR as Z,aS as Ie,aT as or,aU as pt,aV as ar,aW as cr,aX as lr,aY as L,j as xt,aZ as Ke,a_ as ur,a2 as hr,aw as mt,a$ as fr,W as dr,b0 as Tr,u as de,v as Ae,A as _r,o as Ze,b1 as ke,b2 as Er,b3 as Rr,b4 as qe,b5 as gr,b6 as pr,b7 as xr,ad as Je,b8 as mr,b9 as Ar,ba as br,bb as Lr,G as be,D as Sr,bc as yr,bd as Cr,be as vr,bf as Le}from"./XYZ.DUxXAAi-.js";function ie(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}function At(t,e){return t[0]=e[0],t[1]=e[1],t[4]=e[2],t[5]=e[3],t[12]=e[4],t[13]=e[5],t}function De(t,e,r,i,n,s,o){o=o??ie();const a=1/(t-e),h=1/(r-i),l=1/(n-s);return o[0]=-2*a,o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[5]=-2*h,o[6]=0,o[7]=0,o[8]=0,o[9]=0,o[10]=2*l,o[11]=0,o[12]=(t+e)*a,o[13]=(i+r)*h,o[14]=(s+n)*l,o[15]=1,o}function Qe(t,e,r,i,n){return n=n??ie(),n[0]=t[0]*e,n[1]=t[1]*e,n[2]=t[2]*e,n[3]=t[3]*e,n[4]=t[4]*r,n[5]=t[5]*r,n[6]=t[6]*r,n[7]=t[7]*r,n[8]=t[8]*i,n[9]=t[9]*i,n[10]=t[10]*i,n[11]=t[11]*i,n[12]=t[12],n[13]=t[13],n[14]=t[14],n[15]=t[15],n}function Pr(t,e,r,i,n){n=n??ie();let s,o,a,h,l,f,u,T,d,c,p,A;return t===n?(n[12]=t[0]*e+t[4]*r+t[8]*i+t[12],n[13]=t[1]*e+t[5]*r+t[9]*i+t[13],n[14]=t[2]*e+t[6]*r+t[10]*i+t[14],n[15]=t[3]*e+t[7]*r+t[11]*i+t[15]):(s=t[0],o=t[1],a=t[2],h=t[3],l=t[4],f=t[5],u=t[6],T=t[7],d=t[8],c=t[9],p=t[10],A=t[11],n[0]=s,n[1]=o,n[2]=a,n[3]=h,n[4]=l,n[5]=f,n[6]=u,n[7]=T,n[8]=d,n[9]=c,n[10]=p,n[11]=A,n[12]=s*e+l*r+d*i+t[12],n[13]=o*e+f*r+c*i+t[13],n[14]=a*e+u*r+p*i+t[14],n[15]=h*e+T*r+A*i+t[15]),n}function Ur(t,e,r,i){return i=i??ie(),i[0]=1,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=1,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=t,i[13]=e,i[14]=r,i[15]=1,i}const Me=34962,we=34963,Be=35044,Ir=5121,Dr=5123,Fr=5125,bt=5126,et=["experimental-webgl","webgl","webkit-3d","moz-webgl"];function Nr(t,e){e=Object.assign({preserveDrawingBuffer:!0,antialias:!Ht},e);const r=et.length;for(let i=0;i<r;++i)try{const n=t.getContext(et[i],e);if(n)return n}catch{}return null}const Gr={STATIC_DRAW:Be};class Lt{constructor(e,r){this.array_=null,this.type_=e,dt(e===Me||e===we,"A `WebGLArrayBuffer` must either be of type `ELEMENT_ARRAY_BUFFER` or `ARRAY_BUFFER`"),this.usage_=r!==void 0?r:Gr.STATIC_DRAW}ofSize(e){return this.array_=new(he(this.type_))(e),this}fromArray(e){return this.array_=he(this.type_).from(e),this}fromArrayBuffer(e){return this.array_=new(he(this.type_))(e),this}getType(){return this.type_}getArray(){return this.array_}setArray(e){const r=he(this.type_);if(!(e instanceof r))throw new Error(`Expected ${r}`);this.array_=e}getUsage(){return this.usage_}getSize(){return this.array_?this.array_.length:0}}function he(t){switch(t){case Me:return Float32Array;case we:return Uint32Array;default:return Float32Array}}const fe={LOST:"webglcontextlost",RESTORED:"webglcontextrestored"},Or=`
  precision mediump float;

  attribute vec2 a_position;
  varying vec2 v_texCoord;
  varying vec2 v_screenCoord;

  uniform vec2 u_screenSize;

  void main() {
    v_texCoord = a_position * 0.5 + 0.5;
    v_screenCoord = v_texCoord * u_screenSize;
    gl_Position = vec4(a_position, 0.0, 1.0);
  }
`,Mr=`
  precision mediump float;

  uniform sampler2D u_image;
  uniform float u_opacity;

  varying vec2 v_texCoord;

  void main() {
    gl_FragColor = texture2D(u_image, v_texCoord) * u_opacity;
  }
`;class tt{constructor(e){this.gl_=e.webGlContext;const r=this.gl_;this.scaleRatio_=e.scaleRatio||1,this.renderTargetTexture_=r.createTexture(),this.renderTargetTextureSize_=null,this.frameBuffer_=r.createFramebuffer(),this.depthBuffer_=r.createRenderbuffer();const i=r.createShader(r.VERTEX_SHADER);r.shaderSource(i,e.vertexShader||Or),r.compileShader(i);const n=r.createShader(r.FRAGMENT_SHADER);r.shaderSource(n,e.fragmentShader||Mr),r.compileShader(n),this.renderTargetProgram_=r.createProgram(),r.attachShader(this.renderTargetProgram_,i),r.attachShader(this.renderTargetProgram_,n),r.linkProgram(this.renderTargetProgram_),this.renderTargetVerticesBuffer_=r.createBuffer();const s=[-1,-1,1,-1,-1,1,1,-1,1,1,-1,1];r.bindBuffer(r.ARRAY_BUFFER,this.renderTargetVerticesBuffer_),r.bufferData(r.ARRAY_BUFFER,new Float32Array(s),r.STATIC_DRAW),this.renderTargetAttribLocation_=r.getAttribLocation(this.renderTargetProgram_,"a_position"),this.renderTargetUniformLocation_=r.getUniformLocation(this.renderTargetProgram_,"u_screenSize"),this.renderTargetOpacityLocation_=r.getUniformLocation(this.renderTargetProgram_,"u_opacity"),this.renderTargetTextureLocation_=r.getUniformLocation(this.renderTargetProgram_,"u_image"),this.uniforms_=[],e.uniforms&&Object.keys(e.uniforms).forEach(o=>{this.uniforms_.push({value:e.uniforms[o],location:r.getUniformLocation(this.renderTargetProgram_,o)})})}getRenderTargetTexture(){return this.renderTargetTexture_}getGL(){return this.gl_}init(e){const r=this.getGL(),i=[r.drawingBufferWidth*this.scaleRatio_,r.drawingBufferHeight*this.scaleRatio_];if(r.bindFramebuffer(r.FRAMEBUFFER,this.getFrameBuffer()),r.bindRenderbuffer(r.RENDERBUFFER,this.getDepthBuffer()),r.viewport(0,0,i[0],i[1]),!this.renderTargetTextureSize_||this.renderTargetTextureSize_[0]!==i[0]||this.renderTargetTextureSize_[1]!==i[1]){this.renderTargetTextureSize_=i;const n=0,s=r.RGBA,o=0,a=r.RGBA,h=r.UNSIGNED_BYTE,l=null;r.bindTexture(r.TEXTURE_2D,this.renderTargetTexture_),r.texImage2D(r.TEXTURE_2D,n,s,i[0],i[1],o,a,h,l),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,this.renderTargetTexture_,0),r.renderbufferStorage(r.RENDERBUFFER,r.DEPTH_COMPONENT16,i[0],i[1]),r.framebufferRenderbuffer(r.FRAMEBUFFER,r.DEPTH_ATTACHMENT,r.RENDERBUFFER,this.depthBuffer_)}}apply(e,r,i,n){const s=this.getGL(),o=e.size;if(s.bindFramebuffer(s.FRAMEBUFFER,r?r.getFrameBuffer():null),s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,this.renderTargetTexture_),!r){const h=H(s.canvas);if(!e.renderTargets[h]){const l=s.getContextAttributes();l&&l.preserveDrawingBuffer&&(s.clearColor(0,0,0,0),s.clearDepth(1),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT)),e.renderTargets[h]=!0}}s.disable(s.DEPTH_TEST),s.enable(s.BLEND),s.blendFunc(s.ONE,s.ONE_MINUS_SRC_ALPHA),s.viewport(0,0,s.drawingBufferWidth,s.drawingBufferHeight),s.bindBuffer(s.ARRAY_BUFFER,this.renderTargetVerticesBuffer_),s.useProgram(this.renderTargetProgram_),s.enableVertexAttribArray(this.renderTargetAttribLocation_),s.vertexAttribPointer(this.renderTargetAttribLocation_,2,s.FLOAT,!1,0,0),s.uniform2f(this.renderTargetUniformLocation_,o[0],o[1]),s.uniform1i(this.renderTargetTextureLocation_,0);const a=e.layerStatesArray[e.layerIndex].opacity;s.uniform1f(this.renderTargetOpacityLocation_,a),this.applyUniforms(e),i&&i(s,e),s.drawArrays(s.TRIANGLES,0,6),n&&n(s,e)}getFrameBuffer(){return this.frameBuffer_}getDepthBuffer(){return this.depthBuffer_}applyUniforms(e){const r=this.getGL();let i,n=1;this.uniforms_.forEach(function(s){if(i=typeof s.value=="function"?s.value(e):s.value,i instanceof HTMLCanvasElement||i instanceof ImageData)s.texture||(s.texture=r.createTexture()),r.activeTexture(r[`TEXTURE${n}`]),r.bindTexture(r.TEXTURE_2D,s.texture),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),i instanceof ImageData?r.texImage2D(r.TEXTURE_2D,0,r.RGBA,r.RGBA,i.width,i.height,0,r.UNSIGNED_BYTE,new Uint8Array(i.data)):r.texImage2D(r.TEXTURE_2D,0,r.RGBA,r.RGBA,r.UNSIGNED_BYTE,i),r.uniform1i(s.location,n++);else if(Array.isArray(i))switch(i.length){case 2:r.uniform2f(s.location,i[0],i[1]);return;case 3:r.uniform3f(s.location,i[0],i[1],i[2]);return;case 4:r.uniform4f(s.location,i[0],i[1],i[2],i[3]);return;default:return}else typeof i=="number"&&r.uniform1f(s.location,i)})}}const V={TIME:"u_time",ZOOM:"u_zoom",RESOLUTION:"u_resolution",ROTATION:"u_rotation",VIEWPORT_SIZE_PX:"u_viewportSizePx",PIXEL_RATIO:"u_pixelRatio",HIT_DETECTION:"u_hitDetection"},ne={UNSIGNED_BYTE:Ir,UNSIGNED_SHORT:Dr,UNSIGNED_INT:Fr,FLOAT:bt},Ee={};function rt(t){return"shared/"+t}let it=0;function wr(){const t="unique/"+it;return it+=1,t}function Br(t){let e=Ee[t];if(!e){const r=document.createElement("canvas");r.width=1,r.height=1,r.style.position="absolute",r.style.left="0",e={users:0,context:Nr(r)},Ee[t]=e}return e.users+=1,e.context}function Xr(t){const e=Ee[t];if(!e||(e.users-=1,e.users>0))return;const r=e.context,i=r.getExtension("WEBGL_lose_context");i&&i.loseContext();const n=r.canvas;n.width=1,n.height=1,delete Ee[t]}class $r extends jt{constructor(e){super(),e=e||{},this.boundHandleWebGLContextLost_=this.handleWebGLContextLost.bind(this),this.boundHandleWebGLContextRestored_=this.handleWebGLContextRestored.bind(this),this.canvasCacheKey_=e.canvasCacheKey?rt(e.canvasCacheKey):wr(),this.gl_=Br(this.canvasCacheKey_),this.bufferCache_={},this.extensionCache_={},this.currentProgram_=null,this.needsToBeRecreated_=!1;const r=this.gl_.canvas;r.addEventListener(fe.LOST,this.boundHandleWebGLContextLost_),r.addEventListener(fe.RESTORED,this.boundHandleWebGLContextRestored_),this.offsetRotateMatrix_=_e(),this.offsetScaleMatrix_=_e(),this.tmpMat4_=ie(),this.uniformLocationsByProgram_={},this.attribLocationsByProgram_={},this.uniforms_=[],e.uniforms&&this.setUniforms(e.uniforms),this.postProcessPasses_=e.postProcesses?e.postProcesses.map(i=>new tt({webGlContext:this.gl_,scaleRatio:i.scaleRatio,vertexShader:i.vertexShader,fragmentShader:i.fragmentShader,uniforms:i.uniforms})):[new tt({webGlContext:this.gl_})],this.shaderCompileErrors_=null,this.startTime_=Date.now(),this.maxAttributeCount_=this.gl_.getParameter(this.gl_.MAX_VERTEX_ATTRIBS)}setUniforms(e){this.uniforms_=[],this.addUniforms(e)}addUniforms(e){for(const r in e)this.uniforms_.push({name:r,value:e[r]})}canvasCacheKeyMatches(e){return this.canvasCacheKey_===rt(e)}getExtension(e){if(e in this.extensionCache_)return this.extensionCache_[e];const r=this.gl_.getExtension(e);return this.extensionCache_[e]=r,r}getInstancedRenderingExtension_(){const e=this.getExtension("ANGLE_instanced_arrays");return dt(!!e,"WebGL extension 'ANGLE_instanced_arrays' is required for vector rendering"),e}bindBuffer(e){const r=this.gl_,i=H(e);let n=this.bufferCache_[i];if(!n){const s=r.createBuffer();n={buffer:e,webGlBuffer:s},this.bufferCache_[i]=n}r.bindBuffer(e.getType(),n.webGlBuffer)}flushBufferData(e){const r=this.gl_;this.bindBuffer(e),r.bufferData(e.getType(),e.getArray(),e.getUsage())}deleteBuffer(e){const r=H(e);delete this.bufferCache_[r]}disposeInternal(){const e=this.gl_.canvas;e.removeEventListener(fe.LOST,this.boundHandleWebGLContextLost_),e.removeEventListener(fe.RESTORED,this.boundHandleWebGLContextRestored_),Xr(this.canvasCacheKey_),delete this.gl_}prepareDraw(e,r,i){const n=this.gl_,s=this.getCanvas(),o=e.size,a=e.pixelRatio;(s.width!==o[0]*a||s.height!==o[1]*a)&&(s.width=o[0]*a,s.height=o[1]*a,s.style.width=o[0]+"px",s.style.height=o[1]+"px");for(let h=this.postProcessPasses_.length-1;h>=0;h--)this.postProcessPasses_[h].init(e);n.bindTexture(n.TEXTURE_2D,null),n.clearColor(0,0,0,0),n.depthRange(0,1),n.clearDepth(1),n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT),n.enable(n.BLEND),n.blendFunc(n.ONE,r?n.ZERO:n.ONE_MINUS_SRC_ALPHA),i?(n.enable(n.DEPTH_TEST),n.depthFunc(n.LEQUAL)):n.disable(n.DEPTH_TEST)}bindFrameBuffer(e,r){const i=this.getGL();i.bindFramebuffer(i.FRAMEBUFFER,e),r&&i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,r,0)}bindInitialFrameBuffer(){const e=this.getGL(),r=this.postProcessPasses_[0].getFrameBuffer();e.bindFramebuffer(e.FRAMEBUFFER,r);const i=this.postProcessPasses_[0].getRenderTargetTexture();e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,i,0)}bindTexture(e,r,i){const n=this.gl_;n.activeTexture(n.TEXTURE0+r),n.bindTexture(n.TEXTURE_2D,e),n.uniform1i(this.getUniformLocation(i),r)}bindAttribute(e,r,i){const n=this.getGL();this.bindBuffer(e);const s=this.getAttributeLocation(r);n.enableVertexAttribArray(s),n.vertexAttribPointer(s,i,n.FLOAT,!1,0,0)}prepareDrawToRenderTarget(e,r,i,n){const s=this.gl_,o=r.getSize();s.bindFramebuffer(s.FRAMEBUFFER,r.getFramebuffer()),s.bindRenderbuffer(s.RENDERBUFFER,r.getDepthbuffer()),s.viewport(0,0,o[0],o[1]),s.bindTexture(s.TEXTURE_2D,r.getTexture()),s.clearColor(0,0,0,0),s.depthRange(0,1),s.clearDepth(1),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT),s.enable(s.BLEND),s.blendFunc(s.ONE,i?s.ZERO:s.ONE_MINUS_SRC_ALPHA),n?(s.enable(s.DEPTH_TEST),s.depthFunc(s.LEQUAL)):s.disable(s.DEPTH_TEST)}drawElements(e,r){const i=this.gl_;this.getExtension("OES_element_index_uint");const n=i.UNSIGNED_INT,s=4,o=r-e,a=e*s;i.drawElements(i.TRIANGLES,o,n,a)}drawElementsInstanced(e,r,i){const n=this.gl_;this.getExtension("OES_element_index_uint");const s=this.getInstancedRenderingExtension_(),o=n.UNSIGNED_INT,a=4,h=r-e,l=e*a;s.drawElementsInstancedANGLE(n.TRIANGLES,h,o,l,i);for(let f=0;f<this.maxAttributeCount_;f++)s.vertexAttribDivisorANGLE(f,0)}finalizeDraw(e,r,i){for(let n=0,s=this.postProcessPasses_.length;n<s;n++)n===s-1?this.postProcessPasses_[n].apply(e,null,r,i):this.postProcessPasses_[n].apply(e,this.postProcessPasses_[n+1])}getCanvas(){return this.gl_.canvas}getGL(){return this.gl_}applyFrameState(e){const r=e.size,i=e.viewState.rotation,n=e.pixelRatio;this.setUniformFloatValue(V.TIME,(Date.now()-this.startTime_)*.001),this.setUniformFloatValue(V.ZOOM,e.viewState.zoom),this.setUniformFloatValue(V.RESOLUTION,e.viewState.resolution),this.setUniformFloatValue(V.PIXEL_RATIO,n),this.setUniformFloatVec2(V.VIEWPORT_SIZE_PX,[r[0],r[1]]),this.setUniformFloatValue(V.ROTATION,i)}applyHitDetectionUniform(e){const r=this.getUniformLocation(V.HIT_DETECTION);this.getGL().uniform1i(r,e?1:0),e&&this.setUniformFloatValue(V.PIXEL_RATIO,.5)}applyUniforms(e){const r=this.gl_;let i,n=0;this.uniforms_.forEach(s=>{if(i=typeof s.value=="function"?s.value(e):s.value,i instanceof HTMLCanvasElement||i instanceof HTMLImageElement||i instanceof ImageData||i instanceof WebGLTexture){i instanceof WebGLTexture&&!s.texture?(s.prevValue=void 0,s.texture=i):s.texture||(s.prevValue=void 0,s.texture=r.createTexture()),this.bindTexture(s.texture,n,s.name),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE);const o=!(i instanceof HTMLImageElement)||i.complete;!(i instanceof WebGLTexture)&&o&&s.prevValue!==i&&(s.prevValue=i,r.texImage2D(r.TEXTURE_2D,0,r.RGBA,r.RGBA,r.UNSIGNED_BYTE,i)),n++}else if(Array.isArray(i)&&i.length===6)this.setUniformMatrixValue(s.name,At(this.tmpMat4_,i));else if(Array.isArray(i)&&i.length<=4)switch(i.length){case 2:r.uniform2f(this.getUniformLocation(s.name),i[0],i[1]);return;case 3:r.uniform3f(this.getUniformLocation(s.name),i[0],i[1],i[2]);return;case 4:r.uniform4f(this.getUniformLocation(s.name),i[0],i[1],i[2],i[3]);return;default:return}else typeof i=="number"&&r.uniform1f(this.getUniformLocation(s.name),i)})}useProgram(e,r){this.disableAllAttributes_(),this.gl_.useProgram(e),this.currentProgram_=e,r&&(this.applyFrameState(r),this.applyUniforms(r))}compileShader(e,r){const i=this.gl_,n=i.createShader(r);return i.shaderSource(n,e),i.compileShader(n),n}getProgram(e,r){const i=this.gl_,n=this.compileShader(e,i.FRAGMENT_SHADER),s=this.compileShader(r,i.VERTEX_SHADER),o=i.createProgram();if(i.attachShader(o,n),i.attachShader(o,s),i.linkProgram(o),!i.getShaderParameter(n,i.COMPILE_STATUS)){const a=`Fragment shader compilation failed: ${i.getShaderInfoLog(n)}`;throw new Error(a)}if(i.deleteShader(n),!i.getShaderParameter(s,i.COMPILE_STATUS)){const a=`Vertex shader compilation failed: ${i.getShaderInfoLog(s)}`;throw new Error(a)}if(i.deleteShader(s),!i.getProgramParameter(o,i.LINK_STATUS)){const a=`GL program linking failed: ${i.getProgramInfoLog(o)}`;throw new Error(a)}return o}getUniformLocation(e){const r=H(this.currentProgram_);return this.uniformLocationsByProgram_[r]===void 0&&(this.uniformLocationsByProgram_[r]={}),this.uniformLocationsByProgram_[r][e]===void 0&&(this.uniformLocationsByProgram_[r][e]=this.gl_.getUniformLocation(this.currentProgram_,e)),this.uniformLocationsByProgram_[r][e]}getAttributeLocation(e){const r=H(this.currentProgram_);return this.attribLocationsByProgram_[r]===void 0&&(this.attribLocationsByProgram_[r]={}),this.attribLocationsByProgram_[r][e]===void 0&&(this.attribLocationsByProgram_[r][e]=this.gl_.getAttribLocation(this.currentProgram_,e)),this.attribLocationsByProgram_[r][e]}makeProjectionTransform(e,r){const i=e.size,n=e.viewState.rotation,s=e.viewState.resolution,o=e.viewState.center;return Tt(r,0,0,2/(s*i[0]),2/(s*i[1]),-n,-o[0],-o[1]),r}setUniformFloatValue(e,r){this.gl_.uniform1f(this.getUniformLocation(e),r)}setUniformFloatVec2(e,r){this.gl_.uniform2fv(this.getUniformLocation(e),r)}setUniformFloatVec4(e,r){this.gl_.uniform4fv(this.getUniformLocation(e),r)}setUniformMatrixValue(e,r){this.gl_.uniformMatrix4fv(this.getUniformLocation(e),!1,r)}disableAllAttributes_(){for(let e=0;e<this.maxAttributeCount_;e++)this.gl_.disableVertexAttribArray(e)}enableAttributeArray_(e,r,i,n,s,o){const a=this.getAttributeLocation(e);a<0||(this.gl_.enableVertexAttribArray(a),this.gl_.vertexAttribPointer(a,r,i,!1,n,s),o&&this.getInstancedRenderingExtension_().vertexAttribDivisorANGLE(a,1))}enableAttributes_(e,r){const i=Hr(e);let n=0;for(let s=0;s<e.length;s++){const o=e[s];o.name&&this.enableAttributeArray_(o.name,o.size,o.type||bt,i,n,r),n+=o.size*St(o.type)}}enableAttributes(e){this.enableAttributes_(e,!1)}enableAttributesInstanced(e){this.enableAttributes_(e,!0)}handleWebGLContextLost(e){zt(this.bufferCache_),this.currentProgram_=null,e.preventDefault()}handleWebGLContextRestored(){this.needsToBeRecreated_=!0}needsToBeRecreated(){return this.needsToBeRecreated_}createTexture(e,r,i,n){const s=this.gl_;i=i||s.createTexture();const o=n?s.NEAREST:s.LINEAR;s.bindTexture(s.TEXTURE_2D,i),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,o),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,o),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE);const a=0,h=s.RGBA,l=0,f=s.RGBA,u=s.UNSIGNED_BYTE;return r instanceof Uint8Array?s.texImage2D(s.TEXTURE_2D,a,h,e[0],e[1],l,f,u,r):r?s.texImage2D(s.TEXTURE_2D,a,h,f,u,r):s.texImage2D(s.TEXTURE_2D,a,h,e[0],e[1],l,f,u,null),i}}function Hr(t){let e=0;for(let r=0;r<t.length;r++){const i=t[r];e+=i.size*St(i.type)}return e}function St(t){switch(t){case ne.UNSIGNED_BYTE:return Uint8Array.BYTES_PER_ELEMENT;case ne.UNSIGNED_SHORT:return Uint16Array.BYTES_PER_ELEMENT;case ne.UNSIGNED_INT:return Uint32Array.BYTES_PER_ELEMENT;case ne.FLOAT:default:return Float32Array.BYTES_PER_ELEMENT}}class jr extends Wt{constructor(e){super(),this.tile,this.handleTileChange_=this.handleTileChange_.bind(this),this.gutter=e.gutter||0,this.helper=e.helper,this.loaded=!1,this.ready=!1}setTile(e){if(e!==this.tile)if(this.tile&&this.tile.removeEventListener(re.CHANGE,this.handleTileChange_),this.tile=e,this.loaded=e.getState()===F.LOADED,this.loaded)this.uploadTile();else{if(e instanceof _t){const r=e.getImage();r instanceof Image&&!r.crossOrigin&&(r.crossOrigin="anonymous")}e.addEventListener(re.CHANGE,this.handleTileChange_)}}uploadTile(){Et()}setReady(){this.ready=!0,this.dispatchEvent(re.CHANGE)}handleTileChange_(){this.tile.getState()===F.LOADED&&(this.loaded=!0,this.uploadTile())}setHelper(e){this.helper=e,this.helper&&this.loaded&&this.uploadTile()}disposeInternal(){this.setHelper(null),this.tile.removeEventListener(re.CHANGE,this.handleTileChange_)}}function yt(t,e,r){const i=r?t.LINEAR:t.NEAREST;t.bindTexture(t.TEXTURE_2D,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,i),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,i)}function zr(t,e,r,i){yt(t,e,i),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,r)}function nt(t,e,r,i,n,s){const o=t.getGL();let a,h;r instanceof Float32Array?(a=o.FLOAT,t.getExtension("OES_texture_float"),h=t.getExtension("OES_texture_float_linear")!==null):(a=o.UNSIGNED_BYTE,h=!0),yt(o,e,s&&h);const l=r.byteLength/i[1];let f=1;l%8===0?f=8:l%4===0?f=4:l%2===0&&(f=2);let u;switch(n){case 1:{u=o.LUMINANCE;break}case 2:{u=o.LUMINANCE_ALPHA;break}case 3:{u=o.RGB;break}case 4:{u=o.RGBA;break}default:throw new Error(`Unsupported number of bands: ${n}`)}const T=o.getParameter(o.UNPACK_ALIGNMENT);o.pixelStorei(o.UNPACK_ALIGNMENT,f),o.texImage2D(o.TEXTURE_2D,0,u,i[0],i[1],0,u,a,r),o.pixelStorei(o.UNPACK_ALIGNMENT,T)}let te=null;function Wr(){te=Rt(1,1,void 0,{willReadFrequently:!0})}class Yr extends jr{constructor(e){super(e),this.textures=[],this.renderSize_=q(e.grid.getTileSize(e.tile.tileCoord[0])),this.bandCount=NaN;const r=new Lt(Me,Be);r.fromArray([0,1,1,1,1,0,0,0]),this.helper.flushBufferData(r),this.coords=r,this.setTile(e.tile)}setHelper(e){var i;const r=(i=this.helper)==null?void 0:i.getGL();if(r){this.helper.deleteBuffer(this.coords);for(let n=0;n<this.textures.length;++n)r.deleteTexture(this.textures[n])}super.setHelper(e),e&&e.flushBufferData(this.coords)}uploadTile(){const e=this.helper,r=e.getGL(),i=this.tile;this.textures.length=0;let n;i instanceof _t||i instanceof Yt?n=i.getImage():n=i.getData();const s=Pe(n);if(s){const E=r.createTexture();this.textures.push(E),this.bandCount=4,zr(r,E,s,i.interpolate),this.setReady();return}n=ve(n);const o=i.getSize(),a=[o[0]+2*this.gutter,o[1]+2*this.gutter],h=n instanceof Float32Array,l=a[0]*a[1],f=h?Float32Array:Uint8Array,u=f.BYTES_PER_ELEMENT,T=n.byteLength/a[1];this.bandCount=Math.floor(T/u/a[0]);const d=Math.ceil(this.bandCount/4);if(d===1){const E=r.createTexture();this.textures.push(E),nt(e,E,n,a,this.bandCount,i.interpolate),this.setReady();return}const c=new Array(d);for(let E=0;E<d;++E){const R=r.createTexture();this.textures.push(R);const g=E<d-1?4:(this.bandCount-1)%4+1;c[E]=new f(l*g)}let p=0,A=0;const S=a[0]*this.bandCount;for(let E=0;E<a[1];++E){for(let R=0;R<S;++R){const g=n[A+R],_=Math.floor(p/this.bandCount),x=R%this.bandCount,y=Math.floor(x/4),P=c[y],U=P.length/l,m=x%4;P[_*U+m]=g,++p}A+=T/u}for(let E=0;E<d;++E){const R=this.textures[E],g=c[E],_=g.length/l;nt(e,R,g,a,_,i.interpolate)}this.setReady()}getImagePixelData_(e,r,i){const n=this.gutter,s=this.renderSize_[0],o=this.renderSize_[1];te||Wr(),te.clearRect(0,0,1,1);const a=e.width,h=e.height,l=a-2*n,f=h-2*n,u=n+Math.floor(l*(r/s)),T=n+Math.floor(f*(i/o));let d;try{te.drawImage(e,u,T,1,1,0,0,1,1),d=te.getImageData(0,0,1,1).data}catch{return te=null,null}return d}getArrayPixelData_(e,r,i,n){const s=this.gutter,o=this.renderSize_[0],a=this.renderSize_[1],h=r[0],l=r[1],f=h+2*s,u=l+2*s,T=s+Math.floor(h*(i/o)),d=s+Math.floor(l*(n/a));if(e instanceof DataView){const p=e.byteLength/(f*u),A=p*(d*f+T),S=e.buffer.slice(A,A+p);return new DataView(S)}const c=this.bandCount*(d*f+T);return e.slice(c,c+this.bandCount)}getPixelData(e,r){if(!this.loaded)return null;if(this.tile instanceof Oe){const i=this.tile.getData(),n=ve(i);if(n){const s=this.tile.getSize();return this.getArrayPixelData_(n,s,e,r)}return this.getImagePixelData_(Pe(i),e,r)}return this.getImagePixelData_(this.tile.getImage(),e,r)}}class Xe extends Vt{constructor(e,r){super(e),r=r||{},this.inversePixelTransform_=_e(),this.postProcesses_=r.postProcesses,this.uniforms_=r.uniforms,this.helper,this.onMapChanged_=()=>{this.clearCache(),this.removeHelper()},e.addChangeListener(Ue.MAP,this.onMapChanged_),this.dispatchPreComposeEvent=this.dispatchPreComposeEvent.bind(this),this.dispatchPostComposeEvent=this.dispatchPostComposeEvent.bind(this)}dispatchPreComposeEvent(e,r){const i=this.getLayer();if(i.hasListener(J.PRECOMPOSE)){const n=new me(J.PRECOMPOSE,void 0,r,e);i.dispatchEvent(n)}}dispatchPostComposeEvent(e,r){const i=this.getLayer();if(i.hasListener(J.POSTCOMPOSE)){const n=new me(J.POSTCOMPOSE,void 0,r,e);i.dispatchEvent(n)}}reset(e){this.uniforms_=e.uniforms,this.helper&&this.helper.setUniforms(this.uniforms_)}removeHelper(){this.helper&&(this.helper.dispose(),delete this.helper)}prepareFrame(e){if(this.getLayer().getRenderSource()){let r=!0,i=-1,n;for(let o=0,a=e.layerStatesArray.length;o<a;o++){const h=e.layerStatesArray[o].layer,l=h.getRenderer();if(!(l instanceof Xe)){r=!0;continue}const f=h.getClassName();if((r||f!==n)&&(i+=1,r=!1),n=f,l===this)break}const s="map/"+e.mapId+"/group/"+i;(!this.helper||!this.helper.canvasCacheKeyMatches(s)||this.helper.needsToBeRecreated())&&(this.removeHelper(),this.helper=new $r({postProcesses:this.postProcesses_,uniforms:this.uniforms_,canvasCacheKey:s}),n&&(this.helper.getCanvas().className=n),this.afterHelperCreated())}return this.prepareFrameInternal(e)}afterHelperCreated(){}prepareFrameInternal(e){return!0}clearCache(){}disposeInternal(){var e;this.clearCache(),this.removeHelper(),(e=this.getLayer())==null||e.removeChangeListener(Ue.MAP,this.onMapChanged_),super.disposeInternal()}dispatchRenderEvent_(e,r,i){const n=this.getLayer();if(n.hasListener(e)){Tt(this.inversePixelTransform_,0,0,i.pixelRatio,-i.pixelRatio,0,0,-i.size[1]);const s=new me(e,this.inversePixelTransform_,i,r);n.dispatchEvent(s)}}preRender(e,r){this.dispatchRenderEvent_(J.PRERENDER,e,r)}postRender(e,r){this.dispatchRenderEvent_(J.POSTRENDER,e,r)}}const Vr={TILE_TRANSFORM:"u_tileTransform",TRANSITION_ALPHA:"u_transitionAlpha",DEPTH:"u_depth",RENDER_EXTENT:"u_renderExtent",PATTERN_ORIGIN:"u_patternOrigin",RESOLUTION:"u_resolution",ZOOM:"u_zoom",GLOBAL_ALPHA:"u_globalAlpha",PROJECTION_MATRIX:"u_projectionMatrix",SCREEN_TO_WORLD_MATRIX:"u_screenToWorldMatrix"};function st(t){return 1/(t+2)}function Kr(){return{tileIds:new Set,representationsByZ:{}}}function ot(t,e){return t.tileIds.has(H(e))}function at(t,e,r){const i=t.representationsByZ;r in i||(i[r]=new Set),i[r].add(e),t.tileIds.add(H(e.tile))}function Se(t,e){const r=t.layerStatesArray[t.layerIndex];r.extent&&(e=k(e,gt(r.extent,t.viewState.projection)));const i=r.layer.getRenderSource();if(!i.getWrapX()){const n=i.getTileGridForProjection(t.viewState.projection).getExtent();n&&(e=k(e,n))}return e}function Fe(t,e){return`${H(t)},${t.getKey()},${t.getRevision()},${ee(e)}`}class Zr extends Xe{constructor(e,r){super(e,{uniforms:r.uniforms,postProcesses:r.postProcesses}),this.renderComplete=!1,this.tileTransform_=_e(),this.tempMat4=ie(),this.tempTileRange_=new Kt(0,0,0,0),this.tempTileCoord_=We(0,0,0),this.tempSize_=[0,0];const i=r.cacheSize!==void 0?r.cacheSize:512;this.tileRepresentationCache=new Zt(i),this.frameState=null,this.renderedProjection_=void 0}reset(e){super.reset({uniforms:e.uniforms})}prepareFrameInternal(e){this.renderedProjection_?e.viewState.projection!==this.renderedProjection_&&(this.clearCache(),this.renderedProjection_=e.viewState.projection):this.renderedProjection_=e.viewState.projection;const i=this.getLayer().getRenderSource();return!i||kt(Se(e,e.extent))?!1:i.getState()==="ready"}createTileRepresentation(e){return Et()}enqueueTiles(e,r,i,n,s){const o=e.viewState,a=this.getLayer(),h=a.getRenderSource(),l=h.getTileGridForProjection(o.projection),f=h.getGutterForProjection(o.projection),u=H(h);u in e.wantedTiles||(e.wantedTiles[u]={});const T=e.wantedTiles[u],d=this.tileRepresentationCache,c=a.getMapInternal(),p=Math.max(i-s,l.getMinZoom(),l.getZForResolution(Math.min(a.getMaxResolution(),c?c.getView().getResolutionForZoom(Math.max(a.getMinZoom(),0)):l.getResolution(0)),h.zDirection)),A=o.rotation,S=A?qt(o.center,o.resolution,A,e.size):void 0;for(let E=i;E>=p;--E){const R=l.getTileRangeForExtentAndZ(r,E,this.tempTileRange_),g=l.getResolution(E);for(let _=R.minX;_<=R.maxX;++_)for(let x=R.minY;x<=R.maxY;++x){if(A&&!l.tileCoordIntersectsViewport([E,_,x],S))continue;const y=We(E,_,x,this.tempTileCoord_),P=Fe(h,y);let U,m;if(d.containsKey(P)&&(U=d.get(P),m=U.tile),(!U||U.tile.key!==h.getKey())&&(m=h.getTile(E,_,x,e.pixelRatio,o.projection),!m)||ot(n,m))continue;U?U.setTile(m):(U=this.createTileRepresentation({tile:m,grid:l,helper:this.helper,gutter:f}),d.set(P,U)),at(n,U,E);const I=m.getKey();T[I]=!0,m.getState()===F.IDLE&&(e.tileQueue.isKeyQueued(I)||e.tileQueue.enqueue([m,u,l.getTileCoordCenter(y),g]))}}}beforeTilesRender(e,r){this.helper.prepareDraw(this.frameState,!r,!0)}beforeTilesMaskRender(e){return!1}renderTile(e,r,i,n,s,o,a,h,l,f,u){}renderTileMask(e,r,i,n){}drawTile_(e,r,i,n,s,o,a){if(!r.ready)return;const l=r.tile.tileCoord,f=ee(l),u=f in o?o[f]:1,T=a.getResolution(i),d=q(a.getTileSize(i),this.tempSize_),c=a.getOrigin(i),p=a.getTileCoordExtent(l),A=u<1?-1:st(i);u<1&&(e.animate=!0);const S=e.viewState,E=S.center[0],R=S.center[1],g=d[0]+2*n,_=d[1]+2*n,x=g/_,y=(E-c[0])/(d[0]*T),P=(c[1]-R)/(d[1]*T),U=S.resolution/T,m=l[1],I=l[2];Jt(this.tileTransform_),Ye(this.tileTransform_,2/(e.size[0]*U/g),-2/(e.size[1]*U/g)),Qt(this.tileTransform_,S.rotation),Ye(this.tileTransform_,1,1/x),er(this.tileTransform_,(d[0]*(m-y)-n)/g,(d[1]*(I-P)-n)/_),this.renderTile(r,this.tileTransform_,e,s,T,d,c,p,A,n,u)}renderFrame(e){this.frameState=e,this.renderComplete=!0;const r=this.helper.getGL();this.preRender(r,e);const i=e.viewState,n=this.getLayer(),s=n.getRenderSource(),o=s.getTileGridForProjection(i.projection),a=s.getGutterForProjection(i.projection),h=Se(e,e.extent),l=o.getZForResolution(i.resolution,s.zDirection),f=Kr(),u=n.getPreload();if(e.nextExtent){const R=o.getZForResolution(i.nextResolution,s.zDirection),g=Se(e,e.nextExtent);this.enqueueTiles(e,g,R,f,u)}this.enqueueTiles(e,h,l,f,0),u>0&&setTimeout(()=>{this.enqueueTiles(e,h,l-1,f,u-1)},0);const T={};let d=!1;const c=f.representationsByZ;if(l in c){const R=H(this),g=e.time;for(const _ of c[l]){const x=_.tile;if(x.getState()===F.EMPTY)continue;const y=x.tileCoord;if(_.ready){const m=x.getAlpha(R,g);if(m===1){x.endTransition(R);continue}d=!0;const I=ee(y);T[I]=m}if(this.renderComplete=!1,this.findAltTiles_(o,y,l+1,f))continue;const U=o.getMinZoom();for(let m=l-1;m>=U&&!this.findAltTiles_(o,y,m,f);--m);}}const p=Object.keys(c).map(Number).sort(tr);if(this.beforeTilesMaskRender(e))for(let R=0,g=p.length;R<g;++R){const _=p[R];for(const x of c[_]){const y=x.tile.tileCoord;if(ee(y)in T)continue;const U=o.getTileCoordExtent(y);this.renderTileMask(x,_,U,st(_))}}this.beforeTilesRender(e,d);for(let R=0,g=p.length;R<g;++R){const _=p[R];for(const x of c[_]){const y=x.tile.tileCoord;ee(y)in T||this.drawTile_(e,x,_,a,h,T,o)}}if(l in c)for(const R of c[l]){const g=R.tile.tileCoord;ee(g)in T&&this.drawTile_(e,R,l,a,h,T,o)}this.beforeFinalize(e),this.helper.finalizeDraw(e,this.dispatchPreComposeEvent,this.dispatchPostComposeEvent);const S=this.helper.getCanvas();return this.tileRepresentationCache.expireCache(),this.postRender(r,e),S}beforeFinalize(e){}findAltTiles_(e,r,i,n){const s=e.getTileRangeForTileCoordAndZ(r,i,this.tempTileRange_);if(!s)return!1;let o=!0;const a=this.tileRepresentationCache,h=this.getLayer().getRenderSource();for(let l=s.minX;l<=s.maxX;++l)for(let f=s.minY;f<=s.maxY;++f){const u=Fe(h,[i,l,f]);let T=!1;if(a.containsKey(u)){const d=a.get(u);d.ready&&!ot(n,d.tile)&&(at(n,d,i),T=!0)}T||(o=!1)}return o}clearCache(){super.clearCache();const e=this.tileRepresentationCache;e.forEach(r=>r.dispose()),e.clear()}afterHelperCreated(){super.afterHelperCreated(),this.tileRepresentationCache.forEach(e=>e.setHelper(this.helper))}disposeInternal(){super.disposeInternal(),delete this.frameState}}const b={...Vr,TILE_TEXTURE_ARRAY:"u_tileTextures",TEXTURE_PIXEL_WIDTH:"u_texturePixelWidth",TEXTURE_PIXEL_HEIGHT:"u_texturePixelHeight",TEXTURE_RESOLUTION:"u_textureResolution",TEXTURE_ORIGIN_X:"u_textureOriginX",TEXTURE_ORIGIN_Y:"u_textureOriginY"},Te={TEXTURE_COORD:"a_textureCoord"},kr=[{name:Te.TEXTURE_COORD,size:2,type:ne.FLOAT}];class qr extends Zr{constructor(e,r){super(e,r),this.program_,this.vertexShader_=r.vertexShader,this.fragmentShader_=r.fragmentShader,this.indices_=new Lt(we,Be),this.indices_.fromArray([0,1,3,1,2,3]),this.paletteTextures_=r.paletteTextures||[]}reset(e){if(super.reset(e),this.helper){const r=this.helper.getGL();for(const i of this.paletteTextures_)i.delete(r)}if(this.vertexShader_=e.vertexShader,this.fragmentShader_=e.fragmentShader,this.paletteTextures_=e.paletteTextures||[],this.helper){this.program_=this.helper.getProgram(this.fragmentShader_,this.vertexShader_);const r=this.helper.getGL();for(const i of this.paletteTextures_)i.getTexture(r)}}afterHelperCreated(){super.afterHelperCreated();const e=this.helper.getGL();for(const r of this.paletteTextures_)r.getTexture(e);this.program_=this.helper.getProgram(this.fragmentShader_,this.vertexShader_),this.helper.flushBufferData(this.indices_)}removeHelper(){if(this.helper){const e=this.helper.getGL();for(const r of this.paletteTextures_)r.delete(e)}super.removeHelper()}createTileRepresentation(e){return new Yr(e)}beforeTilesRender(e,r){super.beforeTilesRender(e,r),this.helper.useProgram(this.program_,e)}renderTile(e,r,i,n,s,o,a,h,l,f,u){const T=this.helper.getGL();this.helper.bindBuffer(e.coords),this.helper.bindBuffer(this.indices_),this.helper.enableAttributes(kr);let d=0;for(;d<e.textures.length;){const x=`${b.TILE_TEXTURE_ARRAY}[${d}]`;this.helper.bindTexture(e.textures[d],d,x),++d}for(let x=0;x<this.paletteTextures_.length;++x){const y=this.paletteTextures_[x],P=y.getTexture(T);this.helper.bindTexture(P,d,y.name),++d}const c=i.viewState,p=o[0]+2*f,A=o[1]+2*f,E=e.tile.tileCoord,R=E[1],g=E[2];this.helper.setUniformMatrixValue(b.TILE_TRANSFORM,At(this.tempMat4,r)),this.helper.setUniformFloatValue(b.TRANSITION_ALPHA,u),this.helper.setUniformFloatValue(b.DEPTH,l);let _=n;f>0&&(_=h,k(_,n,_)),this.helper.setUniformFloatVec4(b.RENDER_EXTENT,_),this.helper.setUniformFloatValue(b.RESOLUTION,c.resolution),this.helper.setUniformFloatValue(b.ZOOM,c.zoom),this.helper.setUniformFloatValue(b.TEXTURE_PIXEL_WIDTH,p),this.helper.setUniformFloatValue(b.TEXTURE_PIXEL_HEIGHT,A),this.helper.setUniformFloatValue(b.TEXTURE_RESOLUTION,s),this.helper.setUniformFloatValue(b.TEXTURE_ORIGIN_X,a[0]+R*o[0]*s-f*s),this.helper.setUniformFloatValue(b.TEXTURE_ORIGIN_Y,a[1]-g*o[1]*s+f*s),this.helper.drawElements(0,this.indices_.getSize())}getData(e){if(!this.helper.getGL())return null;const i=this.frameState;if(!i)return null;const n=this.getLayer(),s=rr(i.pixelToCoordinateTransform,e.slice()),o=i.viewState,a=n.getExtent();if(a&&!Ve(gt(a,o.projection),s))return null;const h=n.getSources(ir([s]),o.resolution);let l,f,u;for(l=h.length-1;l>=0;--l)if(f=h[l],f.getState()==="ready"){if(u=f.getTileGridForProjection(o.projection),f.getWrapX())break;const d=u.getExtent();if(!d||Ve(d,s))break}if(l<0)return null;const T=this.tileRepresentationCache;for(let d=u.getZForResolution(o.resolution);d>=u.getMinZoom();--d){const c=u.getTileCoordForCoordAndZ(s,d),p=Fe(f,c);if(!T.containsKey(p))continue;const A=T.get(p);if(A.tile.getState()===F.EMPTY)return null;if(!A.loaded)continue;const E=u.getOrigin(d),R=q(u.getTileSize(d)),g=u.getResolution(d),_=(s[0]-E[0])/g-c[1]*R[0],x=(E[1]-s[1])/g-c[2]*R[1];return A.getPixelData(_,x)}return null}disposeInternal(){const e=this.helper;if(e){const r=e.getGL();for(const i of this.paletteTextures_)i.delete(r);this.paletteTextures_.length=0,r.deleteProgram(this.program_),delete this.program_,e.deleteBuffer(this.indices_)}super.disposeInternal(),delete this.indices_}}class Jr{constructor(e,r){this.name=e,this.data=r,this.texture_=null}getTexture(e){if(!this.texture_){const r=e.createTexture();e.bindTexture(e.TEXTURE_2D,r),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,this.data.length/4,1,0,e.RGBA,e.UNSIGNED_BYTE,this.data),this.texture_=r}return this.texture_}delete(e){this.texture_&&e.deleteTexture(this.texture_),this.texture_=null}}function Qr(t,e){return`operator_${t}_${Object.keys(e.functions).length}`}function se(t){const e=t.toString();return e.includes(".")?e:e+".0"}function $e(t){if(t.length<2||t.length>4)throw new Error("`formatArray` can only output `vec2`, `vec3` or `vec4` arrays.");return`vec${t.length}(${t.map(se).join(", ")})`}function ei(t){const e=xt(t),r=e.length>3?e[3]:1;return $e([e[0]/255,e[1]/255,e[2]/255,r])}function ti(t){const e=q(t);return $e(e)}const ye={};let ri=0;function Ct(t){return t in ye||(ye[t]=ri++),ye[t]}function ii(t){return se(Ct(t))}function vt(t){return"u_var_"+t}function ni(){return{variables:{},properties:{},functions:{},bandCount:0,featureId:!1,geometryType:!1}}const Ce="getBandValue",Pt="u_paletteTextures",si="featureId",oi="geometryType",ai=-9999999;function ci(t,e,r,i){const n=nr(t,e,r);return He(n,e,i)}function C(t){return(e,r,i)=>{const n=r.args.length,s=new Array(n);for(let o=0;o<n;++o)s[o]=He(r.args[o],i,e);return t(s,e)}}const li={[L.Get]:(t,e)=>{const i=e.args[0].value;i in t.properties||(t.properties[i]={name:i,type:e.type});let s="a_prop_"+i;return Ke(e.type,Ie)&&(s=`(${s} > 0.0)`),s},[L.Id]:t=>(t.featureId=!0,"a_"+si),[L.GeometryType]:t=>(t.geometryType=!0,"a_"+oi),[L.LineMetric]:()=>"currentLineMetric",[L.Var]:(t,e)=>{const i=e.args[0].value;i in t.variables||(t.variables[i]={name:i,type:e.type});let s=vt(i);return Ke(e.type,Ie)&&(s=`(${s} > 0.0)`),s},[L.Has]:(t,e)=>{const i=e.args[0].value;return i in t.properties||(t.properties[i]={name:i,type:e.type}),`(a_prop_${i} != ${se(ai)})`},[L.Resolution]:()=>"u_resolution",[L.Zoom]:()=>"u_zoom",[L.Time]:()=>"u_time",[L.Any]:C(t=>`(${t.join(" || ")})`),[L.All]:C(t=>`(${t.join(" && ")})`),[L.Not]:C(([t])=>`(!${t})`),[L.Equal]:C(([t,e])=>`(${t} == ${e})`),[L.NotEqual]:C(([t,e])=>`(${t} != ${e})`),[L.GreaterThan]:C(([t,e])=>`(${t} > ${e})`),[L.GreaterThanOrEqualTo]:C(([t,e])=>`(${t} >= ${e})`),[L.LessThan]:C(([t,e])=>`(${t} < ${e})`),[L.LessThanOrEqualTo]:C(([t,e])=>`(${t} <= ${e})`),[L.Multiply]:C(t=>`(${t.join(" * ")})`),[L.Divide]:C(([t,e])=>`(${t} / ${e})`),[L.Add]:C(t=>`(${t.join(" + ")})`),[L.Subtract]:C(([t,e])=>`(${t} - ${e})`),[L.Clamp]:C(([t,e,r])=>`clamp(${t}, ${e}, ${r})`),[L.Mod]:C(([t,e])=>`mod(${t}, ${e})`),[L.Pow]:C(([t,e])=>`pow(${t}, ${e})`),[L.Abs]:C(([t])=>`abs(${t})`),[L.Floor]:C(([t])=>`floor(${t})`),[L.Ceil]:C(([t])=>`ceil(${t})`),[L.Round]:C(([t])=>`floor(${t} + 0.5)`),[L.Sin]:C(([t])=>`sin(${t})`),[L.Cos]:C(([t])=>`cos(${t})`),[L.Atan]:C(([t,e])=>e!==void 0?`atan(${t}, ${e})`:`atan(${t})`),[L.Sqrt]:C(([t])=>`sqrt(${t})`),[L.Match]:C(t=>{const e=t[0],r=t[t.length-1];let i=null;for(let n=t.length-3;n>=1;n-=2){const s=t[n],o=t[n+1];i=`(${e} == ${s} ? ${o} : ${i||r})`}return i}),[L.Between]:C(([t,e,r])=>`(${t} >= ${e} && ${t} <= ${r})`),[L.Interpolate]:C(([t,e,...r])=>{let i="";for(let n=0;n<r.length-2;n+=2){const s=r[n],o=i||r[n+1],a=r[n+2],h=r[n+3];let l;t===se(1)?l=`(${e} - ${s}) / (${a} - ${s})`:l=`(pow(${t}, (${e} - ${s})) - 1.0) / (pow(${t}, (${a} - ${s})) - 1.0)`,i=`mix(${o}, ${h}, clamp(${l}, 0.0, 1.0))`}return i}),[L.Case]:C(t=>{const e=t[t.length-1];let r=null;for(let i=t.length-3;i>=0;i-=2){const n=t[i],s=t[i+1];r=`(${n} ? ${s} : ${r||e})`}return r}),[L.In]:C(([t,...e],r)=>{const i=Qr("in",r),n=[];for(let s=0;s<e.length;s+=1)n.push(`  if (inputValue == ${e[s]}) { return true; }`);return r.functions[i]=`bool ${i}(float inputValue) {
${n.join(`
`)}
  return false;
}`,`${i}(${t})`}),[L.Array]:C(t=>`vec${t.length}(${t.join(", ")})`),[L.Color]:C(t=>{if(t.length===1)return`vec4(vec3(${t[0]} / 255.0), 1.0)`;if(t.length===2)return`vec4(vec3(${t[0]} / 255.0), ${t[1]})`;const e=t.slice(0,3).map(i=>`${i} / 255.0`);if(t.length===3)return`vec4(${e.join(", ")}, 1.0)`;const r=t[3];return`vec4(${e.join(", ")}, ${r})`}),[L.Band]:C(([t,e,r],i)=>{if(!(Ce in i.functions)){let n="";const s=i.bandCount||1;for(let o=0;o<s;o++){const a=Math.floor(o/4);let h=o%4;o===s-1&&h===1&&(h=3);const l=`${b.TILE_TEXTURE_ARRAY}[${a}]`;n+=`  if (band == ${o+1}.0) {
    return texture2D(${l}, v_textureCoord + vec2(dx, dy))[${h}];
  }
`}i.functions[Ce]=`float getBandValue(float band, float xOffset, float yOffset) {
  float dx = xOffset / ${b.TEXTURE_PIXEL_WIDTH};
  float dy = yOffset / ${b.TEXTURE_PIXEL_HEIGHT};
${n}
}`}return`${Ce}(${t}, ${e??"0.0"}, ${r??"0.0"})`}),[L.Palette]:(t,e)=>{const[r,...i]=e.args,n=i.length,s=new Uint8Array(n*4);for(let l=0;l<i.length;l++){const f=i[l].value,u=xt(f),T=l*4;s[T]=u[0],s[T+1]=u[1],s[T+2]=u[2],s[T+3]=u[3]*255}t.paletteTextures||(t.paletteTextures=[]);const o=`${Pt}[${t.paletteTextures.length}]`,a=new Jr(o,s);t.paletteTextures.push(a);const h=He(r,Z,t);return`texture2D(${o}, vec2((${h} + 0.5) / ${n}.0, 0.5))`}};function He(t,e,r){if(t instanceof sr){const i=li[t.operator];if(i===void 0)throw new Error(`No compiler defined for this operator: ${JSON.stringify(t.operator)}`);return i(r,t,e)}if((t.type&Z)>0)return se(t.value);if((t.type&Ie)>0)return t.value.toString();if((t.type&or)>0)return ii(t.value.toString());if((t.type&pt)>0)return ei(t.value);if((t.type&ar)>0)return $e(t.value);if((t.type&cr)>0)return ti(t.value);throw new Error(`Unexpected expression ${t.value} (expected type ${lr(e)})`)}function Q(t,e,r){const i=ur();return ci(e,r,i,t)}function ct(t,e){const r=`
    attribute vec2 ${Te.TEXTURE_COORD};
    uniform mat4 ${b.TILE_TRANSFORM};
    uniform float ${b.TEXTURE_PIXEL_WIDTH};
    uniform float ${b.TEXTURE_PIXEL_HEIGHT};
    uniform float ${b.TEXTURE_RESOLUTION};
    uniform float ${b.TEXTURE_ORIGIN_X};
    uniform float ${b.TEXTURE_ORIGIN_Y};
    uniform float ${b.DEPTH};

    varying vec2 v_textureCoord;
    varying vec2 v_mapCoord;

    void main() {
      v_textureCoord = ${Te.TEXTURE_COORD};
      v_mapCoord = vec2(
        ${b.TEXTURE_ORIGIN_X} + ${b.TEXTURE_RESOLUTION} * ${b.TEXTURE_PIXEL_WIDTH} * v_textureCoord[0],
        ${b.TEXTURE_ORIGIN_Y} - ${b.TEXTURE_RESOLUTION} * ${b.TEXTURE_PIXEL_HEIGHT} * v_textureCoord[1]
      );
      gl_Position = ${b.TILE_TRANSFORM} * vec4(${Te.TEXTURE_COORD}, ${b.DEPTH}, 1.0);
    }
  `,i={...ni(),bandCount:e},n=[];if(t.color!==void 0){const u=Q(i,t.color,pt);n.push(`color = ${u};`)}if(t.contrast!==void 0){const u=Q(i,t.contrast,Z);n.push(`color.rgb = clamp((${u} + 1.0) * color.rgb - (${u} / 2.0), vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0));`)}if(t.exposure!==void 0){const u=Q(i,t.exposure,Z);n.push(`color.rgb = clamp((${u} + 1.0) * color.rgb, vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0));`)}if(t.saturation!==void 0){const u=Q(i,t.saturation,Z);n.push(`
      float saturation = ${u} + 1.0;
      float sr = (1.0 - saturation) * 0.2126;
      float sg = (1.0 - saturation) * 0.7152;
      float sb = (1.0 - saturation) * 0.0722;
      mat3 saturationMatrix = mat3(
        sr + saturation, sr, sr,
        sg, sg + saturation, sg,
        sb, sb, sb + saturation
      );
      color.rgb = clamp(saturationMatrix * color.rgb, vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0));
    `)}if(t.gamma!==void 0){const u=Q(i,t.gamma,Z);n.push(`color.rgb = pow(color.rgb, vec3(1.0 / ${u}));`)}if(t.brightness!==void 0){const u=Q(i,t.brightness,Z);n.push(`color.rgb = clamp(color.rgb + ${u}, vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0));`)}const s={},o=Object.keys(i.variables).length;if(o>1&&!t.variables)throw new Error(`Missing variables in style (expected ${i.variables})`);for(let u=0;u<o;++u){const T=i.variables[Object.keys(i.variables)[u]];if(!(T.name in t.variables))throw new Error(`Missing '${T.name}' in style variables`);const d=vt(T.name);s[d]=function(){let c=t.variables[T.name];return typeof c=="string"&&(c=Ct(c)),c!==void 0?c:-9999999}}const a=Object.keys(s).map(function(u){return`uniform float ${u};`}),h=Math.ceil(e/4);a.push(`uniform sampler2D ${b.TILE_TEXTURE_ARRAY}[${h}];`),i.paletteTextures&&a.push(`uniform sampler2D ${Pt}[${i.paletteTextures.length}];`);const l=Object.keys(i.functions).map(function(u){return i.functions[u]}),f=`
    #ifdef GL_FRAGMENT_PRECISION_HIGH
    precision highp float;
    #else
    precision mediump float;
    #endif

    varying vec2 v_textureCoord;
    varying vec2 v_mapCoord;
    uniform vec4 ${b.RENDER_EXTENT};
    uniform float ${b.TRANSITION_ALPHA};
    uniform float ${b.TEXTURE_PIXEL_WIDTH};
    uniform float ${b.TEXTURE_PIXEL_HEIGHT};
    uniform float ${b.RESOLUTION};
    uniform float ${b.ZOOM};

    ${a.join(`
`)}

    ${l.join(`
`)}

    void main() {
      if (
        v_mapCoord[0] < ${b.RENDER_EXTENT}[0] ||
        v_mapCoord[1] < ${b.RENDER_EXTENT}[1] ||
        v_mapCoord[0] > ${b.RENDER_EXTENT}[2] ||
        v_mapCoord[1] > ${b.RENDER_EXTENT}[3]
      ) {
        discard;
      }

      vec4 color = texture2D(${b.TILE_TEXTURE_ARRAY}[0],  v_textureCoord);

      ${n.join(`
`)}

      gl_FragColor = color;
      gl_FragColor.rgb *= gl_FragColor.a;
      gl_FragColor *= ${b.TRANSITION_ALPHA};
    }`;return{vertexShader:r,fragmentShader:f,uniforms:s,paletteTextures:i.paletteTextures}}class ui extends hr{constructor(e){e=e?Object.assign({},e):{};const r=e.style||{};delete e.style,super(e),this.sources_=e.sources,this.renderedSource_=null,this.renderedResolution_=NaN,this.style_=r,this.styleVariables_=this.style_.variables||{},this.handleSourceUpdate_(),this.addChangeListener(Ue.SOURCE,this.handleSourceUpdate_)}getSources(e,r){const i=this.getSource();return this.sources_?typeof this.sources_=="function"?this.sources_(e,r):this.sources_:i?[i]:[]}getRenderSource(){return this.renderedSource_||this.getSource()}getSourceState(){const e=this.getRenderSource();return e?e.getState():"undefined"}handleSourceUpdate_(){this.hasRenderer()&&this.getRenderer().clearCache();const e=this.getSource();if(e)if(e.getState()==="loading"){const r=()=>{e.getState()==="ready"&&(e.removeEventListener("change",r),this.setStyle(this.style_))};e.addEventListener("change",r)}else this.setStyle(this.style_)}getSourceBandCount_(){const e=Number.MAX_SAFE_INTEGER,r=this.getSources([-e,-e,e,e],e);return r&&r.length&&"bandCount"in r[0]?r[0].bandCount:4}createRenderer(){const e=ct(this.style_,this.getSourceBandCount_());return new qr(this,{vertexShader:e.vertexShader,fragmentShader:e.fragmentShader,uniforms:e.uniforms,cacheSize:this.getCacheSize(),paletteTextures:e.paletteTextures})}renderSources(e,r){const i=this.getRenderer();let n;for(let s=0,o=r.length;s<o;++s)this.renderedSource_=r[s],i.prepareFrame(e)&&(n=i.renderFrame(e));return n}render(e,r){this.rendered=!0;const i=e.viewState,n=this.getSources(e.extent,i.resolution);let s=!0;for(let a=0,h=n.length;a<h;++a){const l=n[a],f=l.getState();if(f=="loading"){const u=()=>{l.getState()=="ready"&&(l.removeEventListener("change",u),this.changed())};l.addEventListener("change",u)}s=s&&f=="ready"}const o=this.renderSources(e,n);if(this.getRenderer().renderComplete&&s)return this.renderedResolution_=i.resolution,o;if(this.renderedResolution_>.5*i.resolution){const a=this.getSources(e.extent,this.renderedResolution_).filter(h=>!n.includes(h));if(a.length>0)return this.renderSources(e,a)}return o}setStyle(e){if(this.styleVariables_=e.variables||{},this.style_=e,this.hasRenderer()){const r=ct(this.style_,this.getSourceBandCount_());this.getRenderer().reset({vertexShader:r.vertexShader,fragmentShader:r.fragmentShader,uniforms:r.uniforms,paletteTextures:r.paletteTextures}),this.changed()}}updateStyleVariables(e){Object.assign(this.styleVariables_,e),this.changed()}}ui.prototype.dispose;function Ut(t,e,r,i={}){return e!==void 0&&r!==void 0&&(i={...i,headers:{...i.headers,Range:`bytes=${e}-${e+r-1}`}}),fetch(t,i)}function hi(t,e){return{...t,...e,headers:{...t.headers,...e.headers}}}function lt(t,e){const r=typeof t=="string"?new URL(t):t;r.pathname.endsWith("/")||(r.pathname+="/");const i=new URL(e.slice(1),r);return i.search=r.search,i}async function ut(t){if(t.status!==404){if(t.status===200||t.status===206)return new Uint8Array(await t.arrayBuffer());throw new Error(`Unexpected response status ${t.status} ${t.statusText}`)}}async function fi(t,e,r,i){if(i)return fetch(t,{...r,headers:{...r.headers,Range:`bytes=-${e}`}});let n=await fetch(t,{...r,method:"HEAD"});if(!n.ok)return n;let s=n.headers.get("Content-Length"),o=Number(s);return Ut(t,o-e,o,r)}var oe,ae,ce,Ne;class Ci{constructor(e,r={}){ue(this,ce);ze(this,"url");ue(this,oe);ue(this,ae);this.url=e,pe(this,oe,r.overrides??{}),pe(this,ae,r.useSuffixRequest??!1)}async get(e,r={}){let i=lt(this.url,e).href,n=await fetch(i,xe(this,ce,Ne).call(this,r));return ut(n)}async getRange(e,r,i={}){let n=lt(this.url,e),s=xe(this,ce,Ne).call(this,i),o;return"suffixLength"in r?o=await fi(n,r.suffixLength,s,ge(this,ae)):o=await Ut(n,r.offset,r.length,s),ut(o)}}oe=new WeakMap,ae=new WeakMap,ce=new WeakSet,Ne=function(e){return hi(ge(this,oe),e)};class di extends fr{constructor(e){super({extent:e.extent,origin:e.origin,origins:e.origins,resolutions:e.resolutions,tileSize:e.tileSize,tileSizes:e.tileSizes,sizes:e.sizes}),this.matrixIds_=e.matrixIds}getMatrixId(e){return this.matrixIds_[e]}getMatrixIds(){return this.matrixIds_}}function vi(t,e,r){const i=[],n=[],s=[],o=[],a=[];r=r!==void 0?r:[];const h="SupportedCRS",l="TileMatrix",f="Identifier",u="ScaleDenominator",T="TopLeftCorner",d="TileWidth",c="TileHeight",p=t[h],A=mt(p),S=A.getMetersPerUnit(),E=A.getAxisOrientation().startsWith("ne");return t[l].sort(function(R,g){return g[u]-R[u]}),t[l].forEach(function(R){let g;if(r.length>0?g=r.find(function(_){return R[f]==_[l]?!0:R[f].includes(":")?!1:t[f]+":"+R[f]===_[l]}):g=!0,g){n.push(R[f]);const _=R[u]*28e-5/S,x=R[d],y=R[c];E?s.push([R[T][1],R[T][0]]):s.push(R[T]),i.push(_),o.push(x==y?x:[x,y]),a.push([R.MatrixWidth,R.MatrixHeight])}}),new di({extent:e,origins:s,resolutions:i,matrixIds:n,tileSizes:o,sizes:a})}const Ti=`
  attribute vec4 a_position;
  attribute vec4 a_texcoord;

  uniform mat4 u_matrix;
  uniform mat4 u_textureMatrix;

  varying vec2 v_texcoord;

  void main() {
    gl_Position = u_matrix * a_position;
    vec2 texcoord = (u_textureMatrix * a_texcoord).xy;
    v_texcoord = texcoord;
  }
`,_i=`
  precision mediump float;

  varying vec2 v_texcoord;

  uniform sampler2D u_texture;

  void main() {
    if (
      v_texcoord.x < 0.0 ||
      v_texcoord.y < 0.0 ||
      v_texcoord.x > 1.0 ||
      v_texcoord.y > 1.0
    ) {
      discard;
    }
    gl_FragColor = texture2D(u_texture, v_texcoord);
  }
`;class Ei{constructor(e){this.gl_=e,this.program_=Ge(e,_i,Ti),this.positionLocation=e.getAttribLocation(this.program_,"a_position"),this.texcoordLocation=e.getAttribLocation(this.program_,"a_texcoord"),this.matrixLocation=e.getUniformLocation(this.program_,"u_matrix"),this.textureMatrixLocation=e.getUniformLocation(this.program_,"u_textureMatrix"),this.textureLocation=e.getUniformLocation(this.program_,"u_texture"),this.positionBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.positionBuffer),this.positions=[0,0,0,1,1,0,1,0,0,1,1,1],e.bufferData(e.ARRAY_BUFFER,new Float32Array(this.positions),e.STATIC_DRAW),this.texcoordBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.texcoordBuffer),this.texcoords=[0,0,0,1,1,0,1,0,0,1,1,1],e.bufferData(e.ARRAY_BUFFER,new Float32Array(this.texcoords),e.STATIC_DRAW)}drawImage(e,r,i,n,s,o,a,h,l,f,u,T,d){const c=this.gl_;h===void 0&&(h=n),l===void 0&&(l=s),o===void 0&&(o=r),a===void 0&&(a=i),f===void 0&&(f=o),u===void 0&&(u=a),T===void 0&&(T=c.canvas.width),d===void 0&&(d=c.canvas.height),c.bindTexture(c.TEXTURE_2D,e),c.useProgram(this.program_),c.bindBuffer(c.ARRAY_BUFFER,this.positionBuffer),c.enableVertexAttribArray(this.positionLocation),c.vertexAttribPointer(this.positionLocation,2,c.FLOAT,!1,0,0),c.bindBuffer(c.ARRAY_BUFFER,this.texcoordBuffer),c.enableVertexAttribArray(this.texcoordLocation),c.vertexAttribPointer(this.texcoordLocation,2,c.FLOAT,!1,0,0);let p=De(0,T,0,d,-1,1);p=Pr(p,h,l,0),p=Qe(p,f,u,1),c.uniformMatrix4fv(this.matrixLocation,!1,p);let A=Ur(n/r,s/i,0);A=Qe(A,o/r,a/i,1),c.uniformMatrix4fv(this.textureMatrixLocation,!1,A),c.uniform1i(this.textureLocation,0),c.drawArrays(c.TRIANGLES,0,this.positions.length/2)}}function ht(t,e,r){const i=t.createShader(e);if(i===null)throw new Error("Shader compilation failed");if(t.shaderSource(i,r),t.compileShader(i),!t.getShaderParameter(i,t.COMPILE_STATUS)){const n=t.getShaderInfoLog(i);throw n===null?new Error("Shader info log creation failed"):new Error(n)}return i}function Ge(t,e,r){const i=t.createProgram(),n=ht(t,t.VERTEX_SHADER,r),s=ht(t,t.FRAGMENT_SHADER,e);if(i===null)throw new Error("Program creation failed");if(t.attachShader(i,n),t.attachShader(i,s),t.linkProgram(i),!t.getProgramParameter(i,t.LINK_STATUS))throw t.getProgramInfoLog(i)===null?new Error("Program info log creation failed"):new Error;return i}const Ri=`
  attribute vec4 a_position;

  uniform mat4 u_matrix;

  void main() {
     gl_Position = u_matrix * a_position;
  }
`,gi=`
  precision mediump float;

  uniform vec4 u_val;
  void main() {
     gl_FragColor = u_val;
  }
`,pi=`
  attribute vec4 a_position;
  attribute vec2 a_texcoord;

  varying vec2 v_texcoord;

  uniform mat4 u_matrix;

  void main() {
     gl_Position = u_matrix * a_position;
     v_texcoord = a_texcoord;
  }
`,xi=`
  precision mediump float;

  varying vec2 v_texcoord;

  uniform sampler2D u_texture;

  void main() {
    if (v_texcoord.x < 0.0 || v_texcoord.x > 1.0 || v_texcoord.y < 0.0 || v_texcoord.y > 1.0) {
      discard;
    }
    gl_FragColor = texture2D(u_texture, v_texcoord);
  }
`;function mi(t,e,r,i){let n;return r&&r.length?n=r.shift():dr?n=new OffscreenCanvas(t||300,e||300):n=document.createElement("canvas"),t&&(n.width=t),e&&(n.height=e),n.getContext("webgl",i)}function Ai(t){const e=t.canvas;e.width=1,e.height=1,t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT|t.STENCIL_BUFFER_BIT)}const ft=[];function bi(t,e,r,i,n,s,o,a,h,l,f,u,T,d){const c=Math.round(i*e),p=Math.round(i*r);t.canvas.width=c,t.canvas.height=p;let A,S;if(S=t.createTexture(),t.bindTexture(t.TEXTURE_2D,S),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),T?(t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR)):(t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST)),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,c,p,0,t.RGBA,f,null),A=t.createFramebuffer(),t.bindFramebuffer(t.FRAMEBUFFER,A),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,S,0),A===null)throw new Error("Could not create framebuffer");if(S===null)throw new Error("Could not create texture");if(h.length===0)return{width:c,height:p,framebuffer:A,texture:S};const E=_r();h.forEach(function(m,I,v){Tr(E,m.extent)});let R,g,_;const x=1/n;{if(R=t.createTexture(),S===null)throw new Error("Could not create texture");g=Math.round(de(E)*x),_=Math.round(Ae(E)*x);const m=t.getParameter(t.MAX_TEXTURE_SIZE),I=Math.max(g,_),v=I>m?m/I:1,G=Math.round(g*v),w=Math.round(_*v);t.bindTexture(t.TEXTURE_2D,R),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),T?(t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR)):(t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST)),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,G,w,0,t.RGBA,f,null);const N=t.createFramebuffer();t.bindFramebuffer(t.FRAMEBUFFER,N),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,R,0);const $=new Ei(t);h.forEach(function(D,j,X){const O=(D.extent[0]-E[0])*x*v,B=-(D.extent[3]-E[3])*x*v,W=de(D.extent)*x*v,M=Ae(D.extent)*x*v;if(t.bindFramebuffer(t.FRAMEBUFFER,N),t.viewport(0,0,G,w),D.clipExtent){const z=(D.clipExtent[0]-E[0])*x*v,Y=-(D.clipExtent[3]-E[3])*x*v,K=de(D.clipExtent)*x*v,le=Ae(D.clipExtent)*x*v;t.enable(t.SCISSOR_TEST),t.scissor(T?z:Math.round(z),T?Y:Math.round(Y),T?K:Math.round(z+K)-Math.round(z),T?le:Math.round(Y+le)-Math.round(Y))}$.drawImage(D.texture,D.width,D.height,l,l,D.width-2*l,D.height-2*l,T?O:Math.round(O),T?B:Math.round(B),T?W:Math.round(O+W)-Math.round(O),T?M:Math.round(B+M)-Math.round(B),G,w),t.disable(t.SCISSOR_TEST)}),t.deleteFramebuffer(N)}const y=Ze(o),P=Ze(E),U=m=>{const I=(m[0][0]-y[0])/s*i,v=-(m[0][1]-y[1])/s*i,G=(m[1][0]-y[0])/s*i,w=-(m[1][1]-y[1])/s*i,N=(m[2][0]-y[0])/s*i,$=-(m[2][1]-y[1])/s*i;return{u1:G,v1:w,u0:I,v0:v,u2:N,v2:$}};t.bindFramebuffer(t.FRAMEBUFFER,A),t.viewport(0,0,c,p);{const m=[],I=[],v=Ge(t,xi,pi);t.useProgram(v);const G=t.getUniformLocation(v,"u_texture");t.bindTexture(t.TEXTURE_2D,R),t.uniform1i(G,0),a.getTriangles().forEach(function(O,B,W){const M=O.source,z=O.target,{u1:Y,v1:K,u0:le,v0:It,u2:Dt,v2:Ft}=U(z),Nt=(M[0][0]-P[0])/n/g,Gt=-(M[0][1]-P[1])/n/_,Ot=(M[1][0]-P[0])/n/g,Mt=-(M[1][1]-P[1])/n/_,wt=(M[2][0]-P[0])/n/g,Bt=-(M[2][1]-P[1])/n/_;m.push(Y,K,le,It,Dt,Ft),I.push(Ot,Mt,Nt,Gt,wt,Bt)});const w=De(0,c,p,0,-1,1),N=t.getUniformLocation(v,"u_matrix");t.uniformMatrix4fv(N,!1,w);const $=t.getAttribLocation(v,"a_position"),D=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,D),t.bufferData(t.ARRAY_BUFFER,new Float32Array(m),t.STATIC_DRAW),t.vertexAttribPointer($,2,t.FLOAT,!1,0,0),t.enableVertexAttribArray($);const j=t.getAttribLocation(v,"a_texcoord"),X=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,X),t.bufferData(t.ARRAY_BUFFER,new Float32Array(I),t.STATIC_DRAW),t.vertexAttribPointer(j,2,t.FLOAT,!1,0,0),t.enableVertexAttribArray(j),t.drawArrays(t.TRIANGLES,0,m.length/2)}if(u){const m=Ge(t,gi,Ri);t.useProgram(m);const I=De(0,c,p,0,-1,1),v=t.getUniformLocation(m,"u_matrix");t.uniformMatrix4fv(v,!1,I);const G=Array.isArray(u)?u:[0,0,0,255],w=t.getUniformLocation(m,"u_val");t.uniform4fv(w,G);const N=t.getAttribLocation(m,"a_position"),$=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,$),t.vertexAttribPointer(N,2,t.FLOAT,!1,0,0),t.enableVertexAttribArray(N);const D=a.getTriangles().reduce(function(j,X){const O=X.target,{u1:B,v1:W,u0:M,v0:z,u2:Y,v2:K}=U(O);return j.concat([B,W,M,z,M,z,Y,K,Y,K,B,W])},[]);t.bufferData(t.ARRAY_BUFFER,new Float32Array(D),t.STATIC_DRAW),t.drawArrays(t.LINES,0,D.length/2)}return{width:c,height:p,framebuffer:A,texture:S}}class Li extends Oe{constructor(e){super({tileCoord:e.tileCoord,loader:()=>Promise.resolve(new Uint8ClampedArray(4)),interpolate:e.interpolate,transition:e.transition}),this.renderEdges_=e.renderEdges!==void 0?e.renderEdges:!1,this.pixelRatio_=e.pixelRatio,this.gutter_=e.gutter,this.reprojData_=null,this.reprojError_=null,this.reprojSize_=void 0,this.sourceTileGrid_=e.sourceTileGrid,this.targetTileGrid_=e.targetTileGrid,this.wrappedTileCoord_=e.wrappedTileCoord||e.tileCoord,this.sourceTiles_=[],this.sourcesListenerKeys_=null,this.sourceZ_=0;const r=e.sourceProj,i=r.getExtent(),n=e.sourceTileGrid.getExtent();this.clipExtent_=r.canWrapX()?n?k(i,n):i:n;const s=this.targetTileGrid_.getTileCoordExtent(this.wrappedTileCoord_),o=this.targetTileGrid_.getExtent();let a=this.sourceTileGrid_.getExtent();const h=o?k(s,o):s;if(ke(h)===0){this.state=F.EMPTY;return}i&&(a?a=k(a,i):a=i);const l=this.targetTileGrid_.getResolution(this.wrappedTileCoord_[0]),f=e.targetProj,u=gr(r,f,h,l);if(!isFinite(u)||u<=0){this.state=F.EMPTY;return}const T=e.errorThreshold!==void 0?e.errorThreshold:pr;if(this.triangulation_=new xr(r,f,h,a,u*T,l,e.transformMatrix),this.triangulation_.getTriangles().length===0){this.state=F.EMPTY;return}this.sourceZ_=this.sourceTileGrid_.getZForResolution(u);let d=this.triangulation_.calculateSourceExtent();if(a&&(r.canWrapX()?(d[1]=Je(d[1],a[1],a[3]),d[3]=Je(d[3],a[1],a[3])):d=k(d,a)),!ke(d))this.state=F.EMPTY;else{let c=0,p=0;r.canWrapX()&&(c=de(i),p=Math.floor((d[0]-i[0])/c)),mr(d.slice(),r,!0).forEach(S=>{const E=this.sourceTileGrid_.getTileRangeForExtentAndZ(S,this.sourceZ_),R=e.getTileFunction;for(let g=E.minX;g<=E.maxX;g++)for(let _=E.minY;_<=E.maxY;_++){const x=R(this.sourceZ_,g,_,this.pixelRatio_);if(x){const y=p*c;this.sourceTiles_.push({tile:x,offset:y})}}++p}),this.sourceTiles_.length===0&&(this.state=F.EMPTY)}}getSize(){return this.reprojSize_}getData(){return this.reprojData_}getError(){return this.reprojError_}reproject_(){const e=[];let r=!1;if(this.sourceTiles_.forEach(g=>{var B;const _=g.tile;if(!_||_.getState()!==F.LOADED)return;const x=_.getSize(),y=this.gutter_;let P;const U=ve(_.getData());U?P=U:(r=!0,P=Er(Pe(_.getData())));const m=[x[0]+2*y,x[1]+2*y],I=P instanceof Float32Array,v=m[0]*m[1],G=I?Float32Array:Uint8ClampedArray,w=new G(P.buffer),N=G.BYTES_PER_ELEMENT,$=N*w.length/v,D=w.byteLength/m[1],j=Math.floor(D/N/m[0]),X=this.sourceTileGrid_.getTileCoordExtent(_.tileCoord);X[0]+=g.offset,X[2]+=g.offset;const O=(B=this.clipExtent_)==null?void 0:B.slice();O&&(O[0]+=g.offset,O[2]+=g.offset),e.push({extent:X,clipExtent:O,data:w,dataType:G,bytesPerPixel:$,pixelSize:m,bandCount:j})}),this.sourceTiles_.length=0,e.length===0){this.state=F.ERROR,this.changed();return}const i=this.wrappedTileCoord_[0],n=this.targetTileGrid_.getTileSize(i),s=typeof n=="number"?n:n[0],o=typeof n=="number"?n:n[1],a=Math.round(s*this.pixelRatio_),h=Math.round(o*this.pixelRatio_),l=this.targetTileGrid_.getResolution(i),f=this.sourceTileGrid_.getResolution(this.sourceZ_),u=this.targetTileGrid_.getTileCoordExtent(this.wrappedTileCoord_),T=e[0].bandCount,d=new e[0].dataType(T*a*h),c=mi(a,h,ft,{premultipliedAlpha:!1,antialias:!1});let p;const A=c.RGBA;let S;e[0].dataType==Float32Array?(S=c.FLOAT,c.getExtension("WEBGL_color_buffer_float"),c.getExtension("OES_texture_float"),c.getExtension("EXT_float_blend"),p=c.getExtension("OES_texture_float_linear")!==null&&this.interpolate):(S=c.UNSIGNED_BYTE,p=this.interpolate);const E=4,R=Math.ceil(T/E);for(let g=R-1;g>=0;--g){const _=[];for(let G=0,w=e.length;G<w;++G){const N=e[G],$=N.pixelSize,D=$[0],j=$[1],X=new N.dataType(E*D*j),O=N.data;let B=g*E;for(let M=0,z=X.length;M<z;M+=E)X[M]=O[B],X[M+1]=O[B+1],X[M+2]=O[B+2],X[M+3]=O[B+3],B+=T;const W=c.createTexture();c.bindTexture(c.TEXTURE_2D,W),p?(c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.LINEAR),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.LINEAR)):(c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.NEAREST),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.NEAREST)),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,c.CLAMP_TO_EDGE),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,c.CLAMP_TO_EDGE),c.texImage2D(c.TEXTURE_2D,0,A,D,j,0,A,S,X),_.push({extent:N.extent,clipExtent:N.clipExtent,texture:W,width:D,height:j})}const{framebuffer:x,width:y,height:P}=bi(c,s,o,this.pixelRatio_,f,l,u,this.triangulation_,_,this.gutter_,S,this.renderEdges_,p),U=y,m=P*E,I=new e[0].dataType(U*m);c.bindFramebuffer(c.FRAMEBUFFER,x),c.readPixels(0,0,y,P,c.RGBA,S,I);let v=g*E;for(let G=0,w=I.length;G<w;G+=E){const N=(U-1-(G/m|0))*m+G%m;d[v]=I[N],d[v+1]=I[N+1],d[v+2]=I[N+2],d[v+3]=I[N+3],v+=T}}if(Ai(c),ft.push(c.canvas),r){const g=Rt(s,o),_=new ImageData(d,s);g.putImageData(_,0,0),this.reprojData_=g.canvas}else this.reprojData_=d;this.reprojSize_=[a,h],this.state=F.LOADED,this.changed()}load(){if(this.state!==F.IDLE&&this.state!==F.ERROR)return;this.state=F.LOADING,this.changed();let e=0;this.sourcesListenerKeys_=[],this.sourceTiles_.forEach(({tile:r})=>{const i=r.getState();if(i!==F.IDLE&&i!==F.LOADING)return;e++;const n=Rr(r,re.CHANGE,()=>{const s=r.getState();(s==F.LOADED||s==F.ERROR||s==F.EMPTY)&&(qe(n),e--,e===0&&(this.unlistenSources_(),this.reproject_()))});this.sourcesListenerKeys_.push(n)}),e===0?setTimeout(this.reproject_.bind(this),0):this.sourceTiles_.forEach(function({tile:r}){r.getState()==F.IDLE&&r.load()})}unlistenSources_(){this.sourcesListenerKeys_.forEach(qe),this.sourcesListenerKeys_=null}}class Pi extends Ar{constructor(e){const r=e.projection===void 0?"EPSG:3857":e.projection;let i=e.tileGrid;i===void 0&&r&&(i=br({extent:Lr(r),maxResolution:e.maxResolution,maxZoom:e.maxZoom,minZoom:e.minZoom,tileSize:e.tileSize})),super({cacheSize:.1,attributions:e.attributions,attributionsCollapsible:e.attributionsCollapsible,projection:r,tileGrid:i,state:e.state,wrapX:e.wrapX,transition:e.transition,interpolate:e.interpolate,key:e.key,zDirection:e.zDirection}),this.gutter_=e.gutter!==void 0?e.gutter:0,this.tileSize_=e.tileSize?q(e.tileSize):null,this.tileSizes_=null,this.tileLoadingKeys_={},this.loader_=e.loader,this.handleTileChange_=this.handleTileChange_.bind(this),this.bandCount=e.bandCount===void 0?4:e.bandCount,this.tileGridForProjection_={},this.crossOrigin_=e.crossOrigin||"anonymous",this.transformMatrix=null}setTileSizes(e){this.tileSizes_=e}getTileSize(e){if(this.tileSizes_)return this.tileSizes_[e];if(this.tileSize_)return this.tileSize_;const r=this.getTileGrid();return r?q(r.getTileSize(e)):[256,256]}getGutterForProjection(e){const r=this.getProjection();return(!r||be(r,e))&&!this.transformMatrix?this.gutter_:0}setLoader(e){this.loader_=e}getReprojTile_(e,r,i,n,s,o){const a=this.tileGrid||this.getTileGridForProjection(s||n),h=Math.max.apply(null,a.getResolutions().map((c,p)=>{const A=q(a.getTileSize(p)),S=this.getTileSize(p);return Math.max(S[0]/A[0],S[1]/A[1])})),l=this.getTileGridForProjection(n),f=[e,r,i],u=this.getTileCoordForTileUrlFunction(f,n),T=Object.assign({sourceProj:s||n,sourceTileGrid:a,targetProj:n,targetTileGrid:l,tileCoord:f,wrappedTileCoord:u,pixelRatio:h,gutter:this.gutter_,getTileFunction:(c,p,A,S)=>this.getTile(c,p,A,S,void 0,o),transformMatrix:this.transformMatrix},this.tileOptions),d=new Li(T);return d.key=this.getKey(),d}getTile(e,r,i,n,s,o){var x;const a=this.getProjection();if(s&&(a&&!be(a,s)||this.transformMatrix))return this.getReprojTile_(e,r,i,s,a,o);const h=this.getTileSize(e),l=this.loader_,f=new AbortController,u={signal:f.signal,crossOrigin:this.crossOrigin_},T=this.getTileCoordForTileUrlFunction([e,r,i]);if(!T)return null;const d=this.getKey(),c=Sr(this,d,e,r,i);if(o&&o.containsKey(c))return o.get(c);const p=T[0],A=T[1],S=T[2],E=(x=this.getTileGrid())==null?void 0:x.getFullTileRange(p);E&&(u.maxY=E.getHeight()-1);function R(){return vr(function(){return l(p,A,S,u)})}const g=Object.assign({tileCoord:[e,r,i],loader:R,size:h,controller:f},this.tileOptions),_=new Oe(g);return _.key=this.getKey(),_.addEventListener(re.CHANGE,this.handleTileChange_),o==null||o.set(c,_),_}handleTileChange_(e){const r=e.target,i=H(r),n=r.getState();let s;n==F.LOADING?(this.tileLoadingKeys_[i]=!0,s=Le.TILELOADSTART):i in this.tileLoadingKeys_&&(delete this.tileLoadingKeys_[i],s=n==F.ERROR?Le.TILELOADERROR:n==F.LOADED?Le.TILELOADEND:void 0),s&&this.dispatchEvent(new yr(s,r))}getTileGridForProjection(e){const r=this.getProjection();if(this.tileGrid&&(!r||be(r,e))&&!this.transformMatrix)return this.tileGrid;const i=H(e);return i in this.tileGridForProjection_||(this.tileGridForProjection_[i]=Cr(e)),this.tileGridForProjection_[i]}setTileGridForProjection(e,r){const i=mt(e);if(i){const n=H(i);n in this.tileGridForProjection_||(this.tileGridForProjection_[n]=r)}}}export{Pi as D,Ci as F,ui as W,di as a,vi as c};

var Kc=Object.defineProperty;var Ec=l=>{throw TypeError(l)};var Qc=(l,e,t)=>e in l?Kc(l,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):l[e]=t;var Cc=(l,e,t)=>Qc(l,typeof e!="symbol"?e+"":e,t),xc=(l,e,t)=>e.has(l)||Ec("Cannot "+t);var Ie=(l,e,t)=>(xc(l,e,"read from private field"),t?t.call(l):e.get(l)),tt=(l,e,t)=>e.has(l)?Ec("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(l):e.set(l,t),pt=(l,e,t,s)=>(xc(l,e,"write to private field"),s?s.call(l,t):e.set(l,t),t),Rt=(l,e,t)=>(xc(l,e,"access private method"),t);import{i,b,A as A$1,e as eoxStyle,a as addCommonStylesheet}from"./addCommonStyleSheet.CwyJxROK.js";import{a0 as SimpleGeometry,r as createOrUpdate,as as intersects,cG as forEachCorner,cH as deflateCoordinate,cI as rotate,cJ as BaseObject,cK as identityTransform,bH as getTransformFromProjections,g as get,cL as toRadians,cM as circular,cl as BaseEvent,aE as EventType$1,aD as Target,bk as listen,bq as unlistenByKey,cN as PASSIVE_EVENT_LISTENERS,cO as VOID,cP as CLASS_UNSELECTABLE,cQ as CLASS_CONTROL,cR as CLASS_COLLAPSED,bW as toPromise,bi as equals,cS as removeChildren,cT as replaceNode,cU as CLASS_HIDDEN,cV as easeOut,ak as Collection,cW as linear,cX as TRUE,cY as WEBKIT,cZ as MAC,c_ as FALSE,cz as scale,c$ as rotate$1,d0 as disable,az as Disposable,P as Polygon,au as clamp,W as abstract,aB as compose,bh as makeInverse,d1 as wrapX,at as getWidth,d2 as inView,d3 as shared,d4 as ObjectEventType,d5 as checkedFonts,d6 as createMockDiv,bJ as WORKER_OFFSCREEN_CANVAS,aP as RenderEvent,ai as RenderEventType,bo as BaseVectorLayer,d7 as replaceChildren,d8 as isCanvas,d9 as fromString,da as DEVICE_PIXEL_RATIO,aA as create,cj as TileQueue,db as View,dc as CollectionEventType,c0 as toUserCoordinate,a$ as apply,dd as fromUserCoordinate,de as getTilePriority,bn as ViewHint,df as GroupEvent,dg as hasArea,ay as getUid,dh as getForViewAndSize,ap as isEmpty,ao as equals$1,di as createOrUpdateEmpty,dj as clone,dk as warn,bB as LayerGroup,Y as assert,bz as Layer,dl as CLASS_SELECTABLE,dm as outerWidth,dn as outerHeight,c as containsExtent,c9 as round,cd as DECIMALS,bw as getHeight,dp as floor,a3 as compareVersions,ca as appendParams,cb as getRequestExtent,cc as decode,ce as ImageSource,cf as defaultImageLoadFunction,dq as calculateSourceResolution,dr as transform$1,bD as TileImage,bj as createEmpty,bp as buffer,cp as modulo,cq as hash,ds as distance,e as LineString,a as MultiLineString,M as MultiPolygon,$ as GeometryCollection,dt as squaredDistance,du as toFixed,a4 as boundingExtent,c5 as getBottomLeft,dv as getBottomRight,c6 as getTopRight,bL as getTopLeft,dw as squaredDistance$1,ac as VectorLayer,aj as VectorSource,F as Feature,f as Point,_ as getStrideForLayout,b as MultiPoint,dx as createEditingStyle,dy as RBush,bl as VectorEventType,cx as createOrUpdateFromCoordinate,dz as equals$2,dA as closestOnSegment,a_ as fromUserExtent,b$ as toUserExtent,dB as squaredDistanceToSegment,dC as getLength,dD as getArea,cE as GeoJSON,cC as READ_FEATURES_OPTIONS,a6 as KML,a5 as TopoJSON,bC as register,dE as fromEPSGCode,cD as transformExtent$1,dF as fromLonLat,V as FeatureFormat,c2 as Projection,bd as RenderFeature,t as transformGeometryWithOptions,be as inflateEnds,dG as CanvasTileLayerRenderer,aF as TileState,ar as equivalent,an as getIntersection,a7 as getTransform,dH as BuilderGroup,dI as ExecutorGroup,aH as toSize,dJ as HIT_DETECT_RESOLUTION,dK as createHitDetectionImageData,dL as hitDetect,dM as DECLUTTER,dN as ascending,a9 as multiply,aW as scale$1,dO as ZIndexContext,dP as renderFeature,aV as reset,aY as translate,aa as getSquaredTolerance,dQ as TileProperty,cm as TileLayer,cn as ImageLayer,bI as XYZ,dR as WMTS,ci as VectorTile,bS as TileSource,dS as OSM,bK as extend,bM as getArea$1,af as Style,ad as Stroke,c3 as WMTSTileGrid,bF as createXYZ,dT as getPointResolution,dU as METERS_PER_UNIT,dV as CLASS_UNSUPPORTED,dW as stopPropagation,dX as ViewProperty,bv as scaleFromCenter,dY as fromExtent,cw as listenOnce,ah as Fill}from"./map.Ch-ahxIj.js";import{r,s as serialize}from"./index.BK49ErFf.js";import{p as proj4}from"./index.Du0sVlOV.js";import{P as Pbf}from"./index.BYzJOi-i.js";import{g as getElement}from"./getElement.CdRlZPdn.js";import"./index.OUYS7i6-.js";import"./commonjsHelpers.BosuxZz1.js";class Circle extends SimpleGeometry{constructor(e,t,s){super(),s!==void 0&&t===void 0?this.setFlatCoordinates(s,e):(t=t||0,this.setCenterAndRadius(e,t,s))}clone(){const e=new Circle(this.flatCoordinates.slice(),void 0,this.layout);return e.applyProperties(this),e}closestPointXY(e,t,s,n){const o=this.flatCoordinates,a=e-o[0],h=t-o[1],c=a*a+h*h;if(c<n){if(c===0)for(let d=0;d<this.stride;++d)s[d]=o[d];else{const d=this.getRadius()/Math.sqrt(c);s[0]=o[0]+d*a,s[1]=o[1]+d*h;for(let u=2;u<this.stride;++u)s[u]=o[u]}return s.length=this.stride,c}return n}containsXY(e,t){const s=this.flatCoordinates,n=e-s[0],o=t-s[1];return n*n+o*o<=this.getRadiusSquared_()}getCenter(){return this.flatCoordinates.slice(0,this.stride)}computeExtent(e){const t=this.flatCoordinates,s=t[this.stride]-t[0];return createOrUpdate(t[0]-s,t[1]-s,t[0]+s,t[1]+s,e)}getRadius(){return Math.sqrt(this.getRadiusSquared_())}getRadiusSquared_(){const e=this.flatCoordinates[this.stride]-this.flatCoordinates[0],t=this.flatCoordinates[this.stride+1]-this.flatCoordinates[1];return e*e+t*t}getType(){return"Circle"}intersectsExtent(e){const t=this.getExtent();if(intersects(e,t)){const s=this.getCenter();return e[0]<=s[0]&&e[2]>=s[0]||e[1]<=s[1]&&e[3]>=s[1]?!0:forEachCorner(e,this.intersectsCoordinate.bind(this))}return!1}setCenter(e){const t=this.stride,s=this.flatCoordinates[t]-this.flatCoordinates[0],n=e.slice();n[t]=n[0]+s;for(let o=1;o<t;++o)n[t+o]=e[o];this.setFlatCoordinates(this.layout,n),this.changed()}setCenterAndRadius(e,t,s){this.setLayout(s,e,0),this.flatCoordinates||(this.flatCoordinates=[]);const n=this.flatCoordinates;let o=deflateCoordinate(n,0,e,this.stride);n[o++]=n[0]+t;for(let a=1,h=this.stride;a<h;++a)n[o++]=n[a];n.length=o,this.changed()}getCoordinates(){return null}setCoordinates(e,t){}setRadius(e){this.flatCoordinates[this.stride]=this.flatCoordinates[0]+e,this.changed()}rotate(e,t){const s=this.getCenter(),n=this.getStride();this.setCenter(rotate(s,0,s.length,n,e,t,s)),this.changed()}}Circle.prototype.transform;const Property$1={ACCURACY:"accuracy",ACCURACY_GEOMETRY:"accuracyGeometry",ALTITUDE:"altitude",ALTITUDE_ACCURACY:"altitudeAccuracy",HEADING:"heading",POSITION:"position",PROJECTION:"projection",SPEED:"speed",TRACKING:"tracking",TRACKING_OPTIONS:"trackingOptions"},GeolocationErrorType={ERROR:"error"};class GeolocationError extends BaseEvent{constructor(e){super(GeolocationErrorType.ERROR),this.code=e.code,this.message=e.message}}class Geolocation extends BaseObject{constructor(e){super(),this.on,this.once,this.un,e=e||{},this.position_=null,this.transform_=identityTransform,this.watchId_=void 0,this.addChangeListener(Property$1.PROJECTION,this.handleProjectionChanged_),this.addChangeListener(Property$1.TRACKING,this.handleTrackingChanged_),e.projection!==void 0&&this.setProjection(e.projection),e.trackingOptions!==void 0&&this.setTrackingOptions(e.trackingOptions),this.setTracking(e.tracking!==void 0?e.tracking:!1)}disposeInternal(){this.setTracking(!1),super.disposeInternal()}handleProjectionChanged_(){const e=this.getProjection();e&&(this.transform_=getTransformFromProjections(get("EPSG:4326"),e),this.position_&&this.set(Property$1.POSITION,this.transform_(this.position_)))}handleTrackingChanged_(){if("geolocation"in navigator){const e=this.getTracking();e&&this.watchId_===void 0?this.watchId_=navigator.geolocation.watchPosition(this.positionChange_.bind(this),this.positionError_.bind(this),this.getTrackingOptions()):!e&&this.watchId_!==void 0&&(navigator.geolocation.clearWatch(this.watchId_),this.watchId_=void 0)}}positionChange_(e){const t=e.coords;this.set(Property$1.ACCURACY,t.accuracy),this.set(Property$1.ALTITUDE,t.altitude===null?void 0:t.altitude),this.set(Property$1.ALTITUDE_ACCURACY,t.altitudeAccuracy===null?void 0:t.altitudeAccuracy),this.set(Property$1.HEADING,t.heading===null?void 0:toRadians(t.heading)),this.position_?(this.position_[0]=t.longitude,this.position_[1]=t.latitude):this.position_=[t.longitude,t.latitude];const s=this.transform_(this.position_);this.set(Property$1.POSITION,s.slice()),this.set(Property$1.SPEED,t.speed===null?void 0:t.speed);const n=circular(this.position_,t.accuracy);n.applyTransform(this.transform_),this.set(Property$1.ACCURACY_GEOMETRY,n),this.changed()}positionError_(e){this.dispatchEvent(new GeolocationError(e))}getAccuracy(){return this.get(Property$1.ACCURACY)}getAccuracyGeometry(){return this.get(Property$1.ACCURACY_GEOMETRY)||null}getAltitude(){return this.get(Property$1.ALTITUDE)}getAltitudeAccuracy(){return this.get(Property$1.ALTITUDE_ACCURACY)}getHeading(){return this.get(Property$1.HEADING)}getPosition(){return this.get(Property$1.POSITION)}getProjection(){return this.get(Property$1.PROJECTION)}getSpeed(){return this.get(Property$1.SPEED)}getTracking(){return this.get(Property$1.TRACKING)}getTrackingOptions(){return this.get(Property$1.TRACKING_OPTIONS)}setProjection(e){this.set(Property$1.PROJECTION,get(e))}setTracking(e){this.set(Property$1.TRACKING,e)}setTrackingOptions(e){this.set(Property$1.TRACKING_OPTIONS,e)}}class Kinetic{constructor(e,t,s){this.decay_=e,this.minVelocity_=t,this.delay_=s,this.points_=[],this.angle_=0,this.initialVelocity_=0}begin(){this.points_.length=0,this.angle_=0,this.initialVelocity_=0}update(e,t){this.points_.push(e,t,Date.now())}end(){if(this.points_.length<6)return!1;const e=Date.now()-this.delay_,t=this.points_.length-3;if(this.points_[t+2]<e)return!1;let s=t-3;for(;s>0&&this.points_[s+2]>e;)s-=3;const n=this.points_[t+2]-this.points_[s+2];if(n<1e3/60)return!1;const o=this.points_[t]-this.points_[s],a=this.points_[t+1]-this.points_[s+1];return this.angle_=Math.atan2(a,o),this.initialVelocity_=Math.sqrt(o*o+a*a)/n,this.initialVelocity_>this.minVelocity_}getDistance(){return(this.minVelocity_-this.initialVelocity_)/this.decay_}getAngle(){return this.angle_}}class MapEvent extends BaseEvent{constructor(e,t,s){super(e),this.map=t,this.frameState=s!==void 0?s:null}}class MapBrowserEvent extends MapEvent{constructor(e,t,s,n,o,a){super(e,t,o),this.originalEvent=s,this.pixel_=null,this.coordinate_=null,this.dragging=n!==void 0?n:!1,this.activePointers=a}get pixel(){return this.pixel_||(this.pixel_=this.map.getEventPixel(this.originalEvent)),this.pixel_}set pixel(e){this.pixel_=e}get coordinate(){return this.coordinate_||(this.coordinate_=this.map.getCoordinateFromPixel(this.pixel)),this.coordinate_}set coordinate(e){this.coordinate_=e}preventDefault(){super.preventDefault(),"preventDefault"in this.originalEvent&&this.originalEvent.preventDefault()}stopPropagation(){super.stopPropagation(),"stopPropagation"in this.originalEvent&&this.originalEvent.stopPropagation()}}const MapBrowserEventType={SINGLECLICK:"singleclick",CLICK:EventType$1.CLICK,DBLCLICK:EventType$1.DBLCLICK,POINTERDRAG:"pointerdrag",POINTERMOVE:"pointermove",POINTERDOWN:"pointerdown",POINTERUP:"pointerup",POINTEROVER:"pointerover",POINTEROUT:"pointerout",POINTERENTER:"pointerenter",POINTERLEAVE:"pointerleave",POINTERCANCEL:"pointercancel"},EventType={POINTERMOVE:"pointermove",POINTERDOWN:"pointerdown",POINTERUP:"pointerup",POINTEROUT:"pointerout"};class MapBrowserEventHandler extends Target{constructor(e,t){super(e),this.map_=e,this.clickTimeoutId_,this.emulateClicks_=!1,this.dragging_=!1,this.dragListenerKeys_=[],this.moveTolerance_=t===void 0?1:t,this.down_=null;const s=this.map_.getViewport();this.activePointers_=[],this.trackedTouches_={},this.element_=s,this.pointerdownListenerKey_=listen(s,EventType.POINTERDOWN,this.handlePointerDown_,this),this.originalPointerMoveEvent_,this.relayedListenerKey_=listen(s,EventType.POINTERMOVE,this.relayMoveEvent_,this),this.boundHandleTouchMove_=this.handleTouchMove_.bind(this),this.element_.addEventListener(EventType$1.TOUCHMOVE,this.boundHandleTouchMove_,PASSIVE_EVENT_LISTENERS?{passive:!1}:!1)}emulateClick_(e){let t=new MapBrowserEvent(MapBrowserEventType.CLICK,this.map_,e);this.dispatchEvent(t),this.clickTimeoutId_!==void 0?(clearTimeout(this.clickTimeoutId_),this.clickTimeoutId_=void 0,t=new MapBrowserEvent(MapBrowserEventType.DBLCLICK,this.map_,e),this.dispatchEvent(t)):this.clickTimeoutId_=setTimeout(()=>{this.clickTimeoutId_=void 0;const s=new MapBrowserEvent(MapBrowserEventType.SINGLECLICK,this.map_,e);this.dispatchEvent(s)},250)}updateActivePointers_(e){const t=e,s=t.pointerId;if(t.type==MapBrowserEventType.POINTERUP||t.type==MapBrowserEventType.POINTERCANCEL){delete this.trackedTouches_[s];for(const n in this.trackedTouches_)if(this.trackedTouches_[n].target!==t.target){delete this.trackedTouches_[n];break}}else(t.type==MapBrowserEventType.POINTERDOWN||t.type==MapBrowserEventType.POINTERMOVE)&&(this.trackedTouches_[s]=t);this.activePointers_=Object.values(this.trackedTouches_)}handlePointerUp_(e){this.updateActivePointers_(e);const t=new MapBrowserEvent(MapBrowserEventType.POINTERUP,this.map_,e,void 0,void 0,this.activePointers_);this.dispatchEvent(t),this.emulateClicks_&&!t.defaultPrevented&&!this.dragging_&&this.isMouseActionButton_(e)&&this.emulateClick_(this.down_),this.activePointers_.length===0&&(this.dragListenerKeys_.forEach(unlistenByKey),this.dragListenerKeys_.length=0,this.dragging_=!1,this.down_=null)}isMouseActionButton_(e){return e.button===0}handlePointerDown_(e){this.emulateClicks_=this.activePointers_.length===0,this.updateActivePointers_(e);const t=new MapBrowserEvent(MapBrowserEventType.POINTERDOWN,this.map_,e,void 0,void 0,this.activePointers_);if(this.dispatchEvent(t),this.down_=new PointerEvent(e.type,e),Object.defineProperty(this.down_,"target",{writable:!1,value:e.target}),this.dragListenerKeys_.length===0){const s=this.map_.getOwnerDocument();this.dragListenerKeys_.push(listen(s,MapBrowserEventType.POINTERMOVE,this.handlePointerMove_,this),listen(s,MapBrowserEventType.POINTERUP,this.handlePointerUp_,this),listen(this.element_,MapBrowserEventType.POINTERCANCEL,this.handlePointerUp_,this)),this.element_.getRootNode&&this.element_.getRootNode()!==s&&this.dragListenerKeys_.push(listen(this.element_.getRootNode(),MapBrowserEventType.POINTERUP,this.handlePointerUp_,this))}}handlePointerMove_(e){if(this.isMoving_(e)){this.updateActivePointers_(e),this.dragging_=!0;const t=new MapBrowserEvent(MapBrowserEventType.POINTERDRAG,this.map_,e,this.dragging_,void 0,this.activePointers_);this.dispatchEvent(t)}}relayMoveEvent_(e){this.originalPointerMoveEvent_=e;const t=!!(this.down_&&this.isMoving_(e));this.dispatchEvent(new MapBrowserEvent(MapBrowserEventType.POINTERMOVE,this.map_,e,t))}handleTouchMove_(e){const t=this.originalPointerMoveEvent_;(!t||t.defaultPrevented)&&(typeof e.cancelable!="boolean"||e.cancelable===!0)&&e.preventDefault()}isMoving_(e){return this.dragging_||Math.abs(e.clientX-this.down_.clientX)>this.moveTolerance_||Math.abs(e.clientY-this.down_.clientY)>this.moveTolerance_}disposeInternal(){this.relayedListenerKey_&&(unlistenByKey(this.relayedListenerKey_),this.relayedListenerKey_=null),this.element_.removeEventListener(EventType$1.TOUCHMOVE,this.boundHandleTouchMove_),this.pointerdownListenerKey_&&(unlistenByKey(this.pointerdownListenerKey_),this.pointerdownListenerKey_=null),this.dragListenerKeys_.forEach(unlistenByKey),this.dragListenerKeys_.length=0,this.element_=null,super.disposeInternal()}}const MapEventType={POSTRENDER:"postrender",MOVESTART:"movestart",MOVEEND:"moveend",LOADSTART:"loadstart",LOADEND:"loadend"},MapProperty={LAYERGROUP:"layergroup",SIZE:"size",TARGET:"target",VIEW:"view"};class Control extends BaseObject{constructor(e){super();const t=e.element;t&&!e.target&&!t.style.pointerEvents&&(t.style.pointerEvents="auto"),this.element=t||null,this.target_=null,this.map_=null,this.listenerKeys=[],e.render&&(this.render=e.render),e.target&&this.setTarget(e.target)}disposeInternal(){var e;(e=this.element)==null||e.remove(),super.disposeInternal()}getMap(){return this.map_}setMap(e){var t;this.map_&&((t=this.element)==null||t.remove());for(let s=0,n=this.listenerKeys.length;s<n;++s)unlistenByKey(this.listenerKeys[s]);if(this.listenerKeys.length=0,this.map_=e,e){const s=this.target_??e.getOverlayContainerStopEvent();this.element&&s.appendChild(this.element),this.render!==VOID&&this.listenerKeys.push(listen(e,MapEventType.POSTRENDER,this.render,this)),e.render()}}render(e){}setTarget(e){this.target_=typeof e=="string"?document.getElementById(e):e}}class Attribution extends Control{constructor(e){e=e||{},super({element:document.createElement("div"),render:e.render,target:e.target}),this.ulElement_=document.createElement("ul"),this.collapsed_=e.collapsed!==void 0?e.collapsed:!0,this.userCollapsed_=this.collapsed_,this.overrideCollapsible_=e.collapsible!==void 0,this.collapsible_=e.collapsible!==void 0?e.collapsible:!0,this.collapsible_||(this.collapsed_=!1),this.attributions_=e.attributions;const t=e.className!==void 0?e.className:"ol-attribution",s=e.tipLabel!==void 0?e.tipLabel:"Attributions",n=e.expandClassName!==void 0?e.expandClassName:t+"-expand",o=e.collapseLabel!==void 0?e.collapseLabel:"›",a=e.collapseClassName!==void 0?e.collapseClassName:t+"-collapse";typeof o=="string"?(this.collapseLabel_=document.createElement("span"),this.collapseLabel_.textContent=o,this.collapseLabel_.className=a):this.collapseLabel_=o;const h=e.label!==void 0?e.label:"i";typeof h=="string"?(this.label_=document.createElement("span"),this.label_.textContent=h,this.label_.className=n):this.label_=h;const c=this.collapsible_&&!this.collapsed_?this.collapseLabel_:this.label_;this.toggleButton_=document.createElement("button"),this.toggleButton_.setAttribute("type","button"),this.toggleButton_.setAttribute("aria-expanded",String(!this.collapsed_)),this.toggleButton_.title=s,this.toggleButton_.appendChild(c),this.toggleButton_.addEventListener(EventType$1.CLICK,this.handleClick_.bind(this),!1);const d=t+" "+CLASS_UNSELECTABLE+" "+CLASS_CONTROL+(this.collapsed_&&this.collapsible_?" "+CLASS_COLLAPSED:"")+(this.collapsible_?"":" ol-uncollapsible"),u=this.element;u.className=d,u.appendChild(this.toggleButton_),u.appendChild(this.ulElement_),this.renderedAttributions_=[],this.renderedVisible_=!0}collectSourceAttributions_(e){const t=this.getMap().getAllLayers(),s=new Set(t.flatMap(n=>n.getAttributions(e)));if(this.attributions_!==void 0&&(Array.isArray(this.attributions_)?this.attributions_.forEach(n=>s.add(n)):s.add(this.attributions_)),!this.overrideCollapsible_){const n=!t.some(o=>{var a;return((a=o.getSource())==null?void 0:a.getAttributionsCollapsible())===!1});this.setCollapsible(n)}return Array.from(s)}async updateElement_(e){if(!e){this.renderedVisible_&&(this.element.style.display="none",this.renderedVisible_=!1);return}const t=await Promise.all(this.collectSourceAttributions_(e).map(n=>toPromise(()=>n))),s=t.length>0;if(this.renderedVisible_!=s&&(this.element.style.display=s?"":"none",this.renderedVisible_=s),!equals(t,this.renderedAttributions_)){removeChildren(this.ulElement_);for(let n=0,o=t.length;n<o;++n){const a=document.createElement("li");a.innerHTML=t[n],this.ulElement_.appendChild(a)}this.renderedAttributions_=t}}handleClick_(e){e.preventDefault(),this.handleToggle_(),this.userCollapsed_=this.collapsed_}handleToggle_(){this.element.classList.toggle(CLASS_COLLAPSED),this.collapsed_?replaceNode(this.collapseLabel_,this.label_):replaceNode(this.label_,this.collapseLabel_),this.collapsed_=!this.collapsed_,this.toggleButton_.setAttribute("aria-expanded",String(!this.collapsed_))}getCollapsible(){return this.collapsible_}setCollapsible(e){this.collapsible_!==e&&(this.collapsible_=e,this.element.classList.toggle("ol-uncollapsible"),this.userCollapsed_&&this.handleToggle_())}setCollapsed(e){this.userCollapsed_=e,!(!this.collapsible_||this.collapsed_===e)&&this.handleToggle_()}getCollapsed(){return this.collapsed_}render(e){this.updateElement_(e.frameState)}}class Rotate extends Control{constructor(e){e=e||{},super({element:document.createElement("div"),render:e.render,target:e.target});const t=e.className!==void 0?e.className:"ol-rotate",s=e.label!==void 0?e.label:"⇧",n=e.compassClassName!==void 0?e.compassClassName:"ol-compass";this.label_=null,typeof s=="string"?(this.label_=document.createElement("span"),this.label_.className=n,this.label_.textContent=s):(this.label_=s,this.label_.classList.add(n));const o=e.tipLabel?e.tipLabel:"Reset rotation",a=document.createElement("button");a.className=t+"-reset",a.setAttribute("type","button"),a.title=o,a.appendChild(this.label_),a.addEventListener(EventType$1.CLICK,this.handleClick_.bind(this),!1);const h=t+" "+CLASS_UNSELECTABLE+" "+CLASS_CONTROL,c=this.element;c.className=h,c.appendChild(a),this.callResetNorth_=e.resetNorth?e.resetNorth:void 0,this.duration_=e.duration!==void 0?e.duration:250,this.autoHide_=e.autoHide!==void 0?e.autoHide:!0,this.rotation_=void 0,this.autoHide_&&this.element.classList.add(CLASS_HIDDEN)}handleClick_(e){e.preventDefault(),this.callResetNorth_!==void 0?this.callResetNorth_():this.resetNorth_()}resetNorth_(){const t=this.getMap().getView();if(!t)return;const s=t.getRotation();s!==void 0&&(this.duration_>0&&s%(2*Math.PI)!==0?t.animate({rotation:0,duration:this.duration_,easing:easeOut}):t.setRotation(0))}render(e){const t=e.frameState;if(!t)return;const s=t.viewState.rotation;if(s!=this.rotation_){const n="rotate("+s+"rad)";if(this.autoHide_){const o=this.element.classList.contains(CLASS_HIDDEN);!o&&s===0?this.element.classList.add(CLASS_HIDDEN):o&&s!==0&&this.element.classList.remove(CLASS_HIDDEN)}this.label_.style.transform=n}this.rotation_=s}}class Zoom extends Control{constructor(e){e=e||{},super({element:document.createElement("div"),target:e.target});const t=e.className!==void 0?e.className:"ol-zoom",s=e.delta!==void 0?e.delta:1,n=e.zoomInClassName!==void 0?e.zoomInClassName:t+"-in",o=e.zoomOutClassName!==void 0?e.zoomOutClassName:t+"-out",a=e.zoomInLabel!==void 0?e.zoomInLabel:"+",h=e.zoomOutLabel!==void 0?e.zoomOutLabel:"–",c=e.zoomInTipLabel!==void 0?e.zoomInTipLabel:"Zoom in",d=e.zoomOutTipLabel!==void 0?e.zoomOutTipLabel:"Zoom out",u=document.createElement("button");u.className=n,u.setAttribute("type","button"),u.title=c,u.appendChild(typeof a=="string"?document.createTextNode(a):a),u.addEventListener(EventType$1.CLICK,this.handleClick_.bind(this,s),!1);const _=document.createElement("button");_.className=o,_.setAttribute("type","button"),_.title=d,_.appendChild(typeof h=="string"?document.createTextNode(h):h),_.addEventListener(EventType$1.CLICK,this.handleClick_.bind(this,-s),!1);const f=t+" "+CLASS_UNSELECTABLE+" "+CLASS_CONTROL,v=this.element;v.className=f,v.appendChild(u),v.appendChild(_),this.duration_=e.duration!==void 0?e.duration:250}handleClick_(e,t){t.preventDefault(),this.zoomByDelta_(e)}zoomByDelta_(e){const s=this.getMap().getView();if(!s)return;const n=s.getZoom();if(n!==void 0){const o=s.getConstrainedZoom(n+e);this.duration_>0?(s.getAnimating()&&s.cancelAnimations(),s.animate({zoom:o,duration:this.duration_,easing:easeOut})):s.setZoom(o)}}}function defaults$1(l){l=l||{};const e=new Collection;return(l.zoom!==void 0?l.zoom:!0)&&e.push(new Zoom(l.zoomOptions)),(l.rotate!==void 0?l.rotate:!0)&&e.push(new Rotate(l.rotateOptions)),(l.attribution!==void 0?l.attribution:!0)&&e.push(new Attribution(l.attributionOptions)),e}const InteractionProperty={ACTIVE:"active"};class Interaction extends BaseObject{constructor(e){super(),this.on,this.once,this.un,e&&e.handleEvent&&(this.handleEvent=e.handleEvent),this.map_=null,this.setActive(!0)}getActive(){return this.get(InteractionProperty.ACTIVE)}getMap(){return this.map_}handleEvent(e){return!0}setActive(e){this.set(InteractionProperty.ACTIVE,e)}setMap(e){this.map_=e}}function pan(l,e,t){const s=l.getCenterInternal();if(s){const n=[s[0]+e[0],s[1]+e[1]];l.animateInternal({duration:t!==void 0?t:250,easing:linear,center:l.getConstrainedCenter(n)})}}function zoomByDelta(l,e,t,s){const n=l.getZoom();if(n===void 0)return;const o=l.getConstrainedZoom(n+e),a=l.getResolutionForZoom(o);l.getAnimating()&&l.cancelAnimations(),l.animate({resolution:a,anchor:t,duration:s!==void 0?s:250,easing:easeOut})}class DoubleClickZoom extends Interaction{constructor(e){super(),e=e||{},this.delta_=e.delta?e.delta:1,this.duration_=e.duration!==void 0?e.duration:250}handleEvent(e){let t=!1;if(e.type==MapBrowserEventType.DBLCLICK){const s=e.originalEvent,n=e.map,o=e.coordinate,a=s.shiftKey?-this.delta_:this.delta_,h=n.getView();zoomByDelta(h,a,o,this.duration_),s.preventDefault(),t=!0}return!t}}function all(l){const e=arguments;return function(t){let s=!0;for(let n=0,o=e.length;n<o&&(s=s&&e[n](t),!!s);++n);return s}}const altKeyOnly=function(l){const e=l.originalEvent;return e.altKey&&!(e.metaKey||e.ctrlKey)&&!e.shiftKey},altShiftKeysOnly=function(l){const e=l.originalEvent;return e.altKey&&!(e.metaKey||e.ctrlKey)&&e.shiftKey},focus=function(l){const e=l.map.getTargetElement(),t=e.getRootNode(),s=l.map.getOwnerDocument().activeElement;return t instanceof ShadowRoot?t.host.contains(s):e.contains(s)},focusWithTabindex=function(l){const e=l.map.getTargetElement(),t=e.getRootNode();return(t instanceof ShadowRoot?t.host:e).hasAttribute("tabindex")?focus(l):!0},always=TRUE,mouseActionButton=function(l){const e=l.originalEvent;return"pointerId"in e&&e.button==0&&!(WEBKIT&&MAC&&e.ctrlKey)},never=FALSE,singleClick=function(l){return l.type==MapBrowserEventType.SINGLECLICK},noModifierKeys=function(l){const e=l.originalEvent;return!e.altKey&&!(e.metaKey||e.ctrlKey)&&!e.shiftKey},platformModifierKeyOnly=function(l){const e=l.originalEvent;return!e.altKey&&(MAC?e.metaKey:e.ctrlKey)&&!e.shiftKey},platformModifierKey=function(l){const e=l.originalEvent;return MAC?e.metaKey:e.ctrlKey},shiftKeyOnly=function(l){const e=l.originalEvent;return!e.altKey&&!(e.metaKey||e.ctrlKey)&&e.shiftKey},targetNotEditable=function(l){const e=l.originalEvent,t=e.target.tagName;return t!=="INPUT"&&t!=="SELECT"&&t!=="TEXTAREA"&&!e.target.isContentEditable},mouseOnly=function(l){const e=l.originalEvent;return"pointerId"in e&&e.pointerType=="mouse"},primaryAction=function(l){const e=l.originalEvent;return"pointerId"in e&&e.isPrimary&&e.button===0};class PointerInteraction extends Interaction{constructor(e){e=e||{},super(e),e.handleDownEvent&&(this.handleDownEvent=e.handleDownEvent),e.handleDragEvent&&(this.handleDragEvent=e.handleDragEvent),e.handleMoveEvent&&(this.handleMoveEvent=e.handleMoveEvent),e.handleUpEvent&&(this.handleUpEvent=e.handleUpEvent),e.stopDown&&(this.stopDown=e.stopDown),this.handlingDownUpSequence=!1,this.targetPointers=[]}getPointerCount(){return this.targetPointers.length}handleDownEvent(e){return!1}handleDragEvent(e){}handleEvent(e){if(!e.originalEvent)return!0;let t=!1;if(this.updateTrackedPointers_(e),this.handlingDownUpSequence){if(e.type==MapBrowserEventType.POINTERDRAG)this.handleDragEvent(e),e.originalEvent.preventDefault();else if(e.type==MapBrowserEventType.POINTERUP){const s=this.handleUpEvent(e);this.handlingDownUpSequence=s&&this.targetPointers.length>0}}else if(e.type==MapBrowserEventType.POINTERDOWN){const s=this.handleDownEvent(e);this.handlingDownUpSequence=s,t=this.stopDown(s)}else e.type==MapBrowserEventType.POINTERMOVE&&this.handleMoveEvent(e);return!t}handleMoveEvent(e){}handleUpEvent(e){return!1}stopDown(e){return e}updateTrackedPointers_(e){e.activePointers&&(this.targetPointers=e.activePointers)}}function centroid(l){const e=l.length;let t=0,s=0;for(let n=0;n<e;n++)t+=l[n].clientX,s+=l[n].clientY;return{clientX:t/e,clientY:s/e}}class DragPan extends PointerInteraction{constructor(e){super({stopDown:FALSE}),e=e||{},this.kinetic_=e.kinetic,this.lastCentroid=null,this.lastPointersCount_,this.panning_=!1;const t=e.condition?e.condition:all(noModifierKeys,primaryAction);this.condition_=e.onFocusOnly?all(focusWithTabindex,t):t,this.noKinetic_=!1}handleDragEvent(e){const t=e.map;this.panning_||(this.panning_=!0,t.getView().beginInteraction());const s=this.targetPointers,n=t.getEventPixel(centroid(s));if(s.length==this.lastPointersCount_){if(this.kinetic_&&this.kinetic_.update(n[0],n[1]),this.lastCentroid){const o=[this.lastCentroid[0]-n[0],n[1]-this.lastCentroid[1]],h=e.map.getView();scale(o,h.getResolution()),rotate$1(o,h.getRotation()),h.adjustCenterInternal(o)}}else this.kinetic_&&this.kinetic_.begin();this.lastCentroid=n,this.lastPointersCount_=s.length,e.originalEvent.preventDefault()}handleUpEvent(e){const t=e.map,s=t.getView();if(this.targetPointers.length===0){if(!this.noKinetic_&&this.kinetic_&&this.kinetic_.end()){const n=this.kinetic_.getDistance(),o=this.kinetic_.getAngle(),a=s.getCenterInternal(),h=t.getPixelFromCoordinateInternal(a),c=t.getCoordinateFromPixelInternal([h[0]-n*Math.cos(o),h[1]-n*Math.sin(o)]);s.animateInternal({center:s.getConstrainedCenter(c),duration:500,easing:easeOut})}return this.panning_&&(this.panning_=!1,s.endInteraction()),!1}return this.kinetic_&&this.kinetic_.begin(),this.lastCentroid=null,!0}handleDownEvent(e){if(this.targetPointers.length>0&&this.condition_(e)){const s=e.map.getView();return this.lastCentroid=null,s.getAnimating()&&s.cancelAnimations(),this.kinetic_&&this.kinetic_.begin(),this.noKinetic_=this.targetPointers.length>1,!0}return!1}}class DragRotate extends PointerInteraction{constructor(e){e=e||{},super({stopDown:FALSE}),this.condition_=e.condition?e.condition:altShiftKeysOnly,this.lastAngle_=void 0,this.duration_=e.duration!==void 0?e.duration:250}handleDragEvent(e){if(!mouseOnly(e))return;const t=e.map,s=t.getView();if(s.getConstraints().rotation===disable)return;const n=t.getSize(),o=e.pixel,a=Math.atan2(n[1]/2-o[1],o[0]-n[0]/2);if(this.lastAngle_!==void 0){const h=a-this.lastAngle_;s.adjustRotationInternal(-h)}this.lastAngle_=a}handleUpEvent(e){return mouseOnly(e)?(e.map.getView().endInteraction(this.duration_),!1):!0}handleDownEvent(e){return mouseOnly(e)&&mouseActionButton(e)&&this.condition_(e)?(e.map.getView().beginInteraction(),this.lastAngle_=void 0,!0):!1}}class RenderBox extends Disposable{constructor(e){super(),this.geometry_=null,this.element_=document.createElement("div"),this.element_.style.position="absolute",this.element_.style.pointerEvents="auto",this.element_.className="ol-box "+e,this.map_=null,this.startPixel_=null,this.endPixel_=null}disposeInternal(){this.setMap(null)}render_(){const e=this.startPixel_,t=this.endPixel_,s="px",n=this.element_.style;n.left=Math.min(e[0],t[0])+s,n.top=Math.min(e[1],t[1])+s,n.width=Math.abs(t[0]-e[0])+s,n.height=Math.abs(t[1]-e[1])+s}setMap(e){if(this.map_){this.map_.getOverlayContainer().removeChild(this.element_);const t=this.element_.style;t.left="inherit",t.top="inherit",t.width="inherit",t.height="inherit"}this.map_=e,this.map_&&this.map_.getOverlayContainer().appendChild(this.element_)}setPixels(e,t){this.startPixel_=e,this.endPixel_=t,this.createOrUpdateGeometry(),this.render_()}createOrUpdateGeometry(){if(!this.map_)return;const e=this.startPixel_,t=this.endPixel_,n=[e,[e[0],t[1]],t,[t[0],e[1]]].map(this.map_.getCoordinateFromPixelInternal,this.map_);n[4]=n[0].slice(),this.geometry_?this.geometry_.setCoordinates([n]):this.geometry_=new Polygon([n])}getGeometry(){return this.geometry_}}const DragBoxEventType={BOXSTART:"boxstart",BOXDRAG:"boxdrag",BOXEND:"boxend",BOXCANCEL:"boxcancel"};class DragBoxEvent extends BaseEvent{constructor(e,t,s){super(e),this.coordinate=t,this.mapBrowserEvent=s}}class DragBox extends PointerInteraction{constructor(e){super(),this.on,this.once,this.un,e=e??{},this.box_=new RenderBox(e.className||"ol-dragbox"),this.minArea_=e.minArea??64,e.onBoxEnd&&(this.onBoxEnd=e.onBoxEnd),this.startPixel_=null,this.condition_=e.condition??mouseActionButton,this.boxEndCondition_=e.boxEndCondition??this.defaultBoxEndCondition}defaultBoxEndCondition(e,t,s){const n=s[0]-t[0],o=s[1]-t[1];return n*n+o*o>=this.minArea_}getGeometry(){return this.box_.getGeometry()}handleDragEvent(e){this.startPixel_&&(this.box_.setPixels(this.startPixel_,e.pixel),this.dispatchEvent(new DragBoxEvent(DragBoxEventType.BOXDRAG,e.coordinate,e)))}handleUpEvent(e){if(!this.startPixel_)return!1;const t=this.boxEndCondition_(e,this.startPixel_,e.pixel);return t&&this.onBoxEnd(e),this.dispatchEvent(new DragBoxEvent(t?DragBoxEventType.BOXEND:DragBoxEventType.BOXCANCEL,e.coordinate,e)),this.box_.setMap(null),this.startPixel_=null,!1}handleDownEvent(e){return this.condition_(e)?(this.startPixel_=e.pixel,this.box_.setMap(e.map),this.box_.setPixels(this.startPixel_,this.startPixel_),this.dispatchEvent(new DragBoxEvent(DragBoxEventType.BOXSTART,e.coordinate,e)),!0):!1}onBoxEnd(e){}setActive(e){e||(this.box_.setMap(null),this.startPixel_&&(this.dispatchEvent(new DragBoxEvent(DragBoxEventType.BOXCANCEL,this.startPixel_,null)),this.startPixel_=null)),super.setActive(e)}setMap(e){this.getMap()&&(this.box_.setMap(null),this.startPixel_&&(this.dispatchEvent(new DragBoxEvent(DragBoxEventType.BOXCANCEL,this.startPixel_,null)),this.startPixel_=null)),super.setMap(e)}}class DragZoom extends DragBox{constructor(e){e=e||{};const t=e.condition?e.condition:shiftKeyOnly;super({condition:t,className:e.className||"ol-dragzoom",minArea:e.minArea}),this.duration_=e.duration!==void 0?e.duration:200,this.out_=e.out!==void 0?e.out:!1}onBoxEnd(e){const s=this.getMap().getView();let n=this.getGeometry();if(this.out_){const o=s.rotatedExtentForGeometry(n),a=s.getResolutionForExtentInternal(o),h=s.getResolution()/a;n=n.clone(),n.scale(h*h)}s.fitInternal(n,{duration:this.duration_,easing:easeOut})}}const Key={LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",DOWN:"ArrowDown"};class KeyboardPan extends Interaction{constructor(e){super(),e=e||{},this.defaultCondition_=function(t){return noModifierKeys(t)&&targetNotEditable(t)},this.condition_=e.condition!==void 0?e.condition:this.defaultCondition_,this.duration_=e.duration!==void 0?e.duration:100,this.pixelDelta_=e.pixelDelta!==void 0?e.pixelDelta:128}handleEvent(e){let t=!1;if(e.type==EventType$1.KEYDOWN){const s=e.originalEvent,n=s.key;if(this.condition_(e)&&(n==Key.DOWN||n==Key.LEFT||n==Key.RIGHT||n==Key.UP)){const a=e.map.getView(),h=a.getResolution()*this.pixelDelta_;let c=0,d=0;n==Key.DOWN?d=-h:n==Key.LEFT?c=-h:n==Key.RIGHT?c=h:d=h;const u=[c,d];rotate$1(u,a.getRotation()),pan(a,u,this.duration_),s.preventDefault(),t=!0}}return!t}}class KeyboardZoom extends Interaction{constructor(e){super(),e=e||{},this.condition_=e.condition?e.condition:function(t){return!platformModifierKey(t)&&targetNotEditable(t)},this.delta_=e.delta?e.delta:1,this.duration_=e.duration!==void 0?e.duration:100}handleEvent(e){let t=!1;if(e.type==EventType$1.KEYDOWN||e.type==EventType$1.KEYPRESS){const s=e.originalEvent,n=s.key;if(this.condition_(e)&&(n==="+"||n==="-")){const o=e.map,a=n==="+"?this.delta_:-this.delta_,h=o.getView();zoomByDelta(h,a,void 0,this.duration_),s.preventDefault(),t=!0}}return!t}}const DELTA_LINE_MULTIPLIER=40,DELTA_PAGE_MULTIPLIER=300;class MouseWheelZoom extends Interaction{constructor(e){e=e||{},super(e),this.totalDelta_=0,this.lastDelta_=0,this.maxDelta_=e.maxDelta!==void 0?e.maxDelta:1,this.duration_=e.duration!==void 0?e.duration:250,this.timeout_=e.timeout!==void 0?e.timeout:80,this.useAnchor_=e.useAnchor!==void 0?e.useAnchor:!0,this.constrainResolution_=e.constrainResolution!==void 0?e.constrainResolution:!1;const t=e.condition?e.condition:always;this.condition_=e.onFocusOnly?all(focusWithTabindex,t):t,this.lastAnchor_=null,this.startTime_=void 0,this.timeoutId_,this.mode_=void 0,this.trackpadEventGap_=400,this.trackpadTimeoutId_,this.deltaPerZoom_=300}endInteraction_(){this.trackpadTimeoutId_=void 0;const e=this.getMap();if(!e)return;e.getView().endInteraction(void 0,this.lastDelta_?this.lastDelta_>0?1:-1:0,this.lastAnchor_?e.getCoordinateFromPixel(this.lastAnchor_):null)}handleEvent(e){if(!this.condition_(e)||e.type!==EventType$1.WHEEL)return!0;const s=e.map,n=e.originalEvent;n.preventDefault(),this.useAnchor_&&(this.lastAnchor_=e.pixel);let o=n.deltaY;switch(n.deltaMode){case WheelEvent.DOM_DELTA_LINE:o*=DELTA_LINE_MULTIPLIER;break;case WheelEvent.DOM_DELTA_PAGE:o*=DELTA_PAGE_MULTIPLIER;break}if(o===0)return!1;this.lastDelta_=o;const a=Date.now();this.startTime_===void 0&&(this.startTime_=a),(!this.mode_||a-this.startTime_>this.trackpadEventGap_)&&(this.mode_=Math.abs(o)<4?"trackpad":"wheel");const h=s.getView();if(this.mode_==="trackpad"&&!(h.getConstrainResolution()||this.constrainResolution_))return this.trackpadTimeoutId_?clearTimeout(this.trackpadTimeoutId_):(h.getAnimating()&&h.cancelAnimations(),h.beginInteraction()),this.trackpadTimeoutId_=setTimeout(this.endInteraction_.bind(this),this.timeout_),h.adjustZoom(-o/this.deltaPerZoom_,this.lastAnchor_?s.getCoordinateFromPixel(this.lastAnchor_):null),this.startTime_=a,!1;this.totalDelta_+=o;const c=Math.max(this.timeout_-(a-this.startTime_),0);return clearTimeout(this.timeoutId_),this.timeoutId_=setTimeout(this.handleWheelZoom_.bind(this,s),c),!1}handleWheelZoom_(e){const t=e.getView();t.getAnimating()&&t.cancelAnimations();let s=-clamp(this.totalDelta_,-this.maxDelta_*this.deltaPerZoom_,this.maxDelta_*this.deltaPerZoom_)/this.deltaPerZoom_;(t.getConstrainResolution()||this.constrainResolution_)&&(s=s?s>0?1:-1:0),zoomByDelta(t,s,this.lastAnchor_?e.getCoordinateFromPixel(this.lastAnchor_):null,this.duration_),this.mode_=void 0,this.totalDelta_=0,this.lastAnchor_=null,this.startTime_=void 0,this.timeoutId_=void 0}setMouseAnchor(e){this.useAnchor_=e,e||(this.lastAnchor_=null)}}class PinchRotate extends PointerInteraction{constructor(e){e=e||{};const t=e;t.stopDown||(t.stopDown=FALSE),super(t),this.anchor_=null,this.lastAngle_=void 0,this.rotating_=!1,this.rotationDelta_=0,this.threshold_=e.threshold!==void 0?e.threshold:.3,this.duration_=e.duration!==void 0?e.duration:250}handleDragEvent(e){let t=0;const s=this.targetPointers[0],n=this.targetPointers[1],o=Math.atan2(n.clientY-s.clientY,n.clientX-s.clientX);if(this.lastAngle_!==void 0){const c=o-this.lastAngle_;this.rotationDelta_+=c,!this.rotating_&&Math.abs(this.rotationDelta_)>this.threshold_&&(this.rotating_=!0),t=c}this.lastAngle_=o;const a=e.map,h=a.getView();h.getConstraints().rotation!==disable&&(this.anchor_=a.getCoordinateFromPixelInternal(a.getEventPixel(centroid(this.targetPointers))),this.rotating_&&(a.render(),h.adjustRotationInternal(t,this.anchor_)))}handleUpEvent(e){return this.targetPointers.length<2?(e.map.getView().endInteraction(this.duration_),!1):!0}handleDownEvent(e){if(this.targetPointers.length>=2){const t=e.map;return this.anchor_=null,this.lastAngle_=void 0,this.rotating_=!1,this.rotationDelta_=0,this.handlingDownUpSequence||t.getView().beginInteraction(),!0}return!1}}class PinchZoom extends PointerInteraction{constructor(e){e=e||{};const t=e;t.stopDown||(t.stopDown=FALSE),super(t),this.anchor_=null,this.duration_=e.duration!==void 0?e.duration:400,this.lastDistance_=void 0,this.lastScaleDelta_=1}handleDragEvent(e){let t=1;const s=this.targetPointers[0],n=this.targetPointers[1],o=s.clientX-n.clientX,a=s.clientY-n.clientY,h=Math.sqrt(o*o+a*a);this.lastDistance_!==void 0&&(t=this.lastDistance_/h),this.lastDistance_=h;const c=e.map,d=c.getView();t!=1&&(this.lastScaleDelta_=t),this.anchor_=c.getCoordinateFromPixelInternal(c.getEventPixel(centroid(this.targetPointers))),c.render(),d.adjustResolutionInternal(t,this.anchor_)}handleUpEvent(e){if(this.targetPointers.length<2){const s=e.map.getView(),n=this.lastScaleDelta_>1?1:-1;return s.endInteraction(this.duration_,n),!1}return!0}handleDownEvent(e){if(this.targetPointers.length>=2){const t=e.map;return this.anchor_=null,this.lastDistance_=void 0,this.lastScaleDelta_=1,this.handlingDownUpSequence||t.getView().beginInteraction(),!0}return!1}}function defaults(l){l=l||{};const e=new Collection,t=new Kinetic(-.005,.05,100);return(l.altShiftDragRotate!==void 0?l.altShiftDragRotate:!0)&&e.push(new DragRotate),(l.doubleClickZoom!==void 0?l.doubleClickZoom:!0)&&e.push(new DoubleClickZoom({delta:l.zoomDelta,duration:l.zoomDuration})),(l.dragPan!==void 0?l.dragPan:!0)&&e.push(new DragPan({onFocusOnly:l.onFocusOnly,kinetic:t})),(l.pinchRotate!==void 0?l.pinchRotate:!0)&&e.push(new PinchRotate),(l.pinchZoom!==void 0?l.pinchZoom:!0)&&e.push(new PinchZoom({duration:l.zoomDuration})),(l.keyboard!==void 0?l.keyboard:!0)&&(e.push(new KeyboardPan),e.push(new KeyboardZoom({delta:l.zoomDelta,duration:l.zoomDuration}))),(l.mouseWheelZoom!==void 0?l.mouseWheelZoom:!0)&&e.push(new MouseWheelZoom({onFocusOnly:l.onFocusOnly,duration:l.zoomDuration})),(l.shiftDragZoom!==void 0?l.shiftDragZoom:!0)&&e.push(new DragZoom({duration:l.zoomDuration})),e}class MapRenderer extends Disposable{constructor(e){super(),this.map_=e}dispatchRenderEvent(e,t){abstract()}calculateMatrices2D(e){const t=e.viewState,s=e.coordinateToPixelTransform,n=e.pixelToCoordinateTransform;compose(s,e.size[0]/2,e.size[1]/2,1/t.resolution,-1/t.resolution,-t.rotation,-t.center[0],-t.center[1]),makeInverse(n,s)}forEachFeatureAtCoordinate(e,t,s,n,o,a,h,c){let d;const u=t.viewState;function _(C,E,L,S){return o.call(a,E,C?L:null,S)}const f=u.projection,v=wrapX(e.slice(),f),g=[[0,0]];if(f.canWrapX()&&n){const C=f.getExtent(),E=getWidth(C);g.push([-E,0],[E,0])}const y=t.layerStatesArray,p=y.length,x=[],T=[];for(let C=0;C<g.length;C++)for(let E=p-1;E>=0;--E){const L=y[E],S=L.layer;if(S.hasRenderer()&&inView(L,u)&&h.call(c,S)){const P=S.getRenderer(),R=S.getSource();if(P&&R){const M=R.getWrapX()?v:e,B=_.bind(null,L.managed);T[0]=M[0]+g[C][0],T[1]=M[1]+g[C][1],d=P.forEachFeatureAtCoordinate(T,t,s,B,x)}if(d)return d}}if(x.length===0)return;const w=1/x.length;return x.forEach((C,E)=>C.distanceSq+=E*w),x.sort((C,E)=>C.distanceSq-E.distanceSq),x.some(C=>d=C.callback(C.feature,C.layer,C.geometry)),d}hasFeatureAtCoordinate(e,t,s,n,o,a){return this.forEachFeatureAtCoordinate(e,t,s,n,TRUE,this,o,a)!==void 0}getMap(){return this.map_}renderFrame(e){abstract()}scheduleExpireIconCache(e){shared.canExpireCache()&&e.postRenderFunctions.push(expireIconCache)}}function expireIconCache(l,e){shared.expire()}class CompositeMapRenderer extends MapRenderer{constructor(e){super(e),this.fontChangeListenerKey_=listen(checkedFonts,ObjectEventType.PROPERTYCHANGE,e.redrawText,e),this.element_=WORKER_OFFSCREEN_CANVAS?createMockDiv():document.createElement("div");const t=this.element_.style;t.position="absolute",t.width="100%",t.height="100%",t.zIndex="0",this.element_.className=CLASS_UNSELECTABLE+" ol-layers";const s=e.getViewport();s&&s.insertBefore(this.element_,s.firstChild||null),this.children_=[],this.renderedVisible_=!0}dispatchRenderEvent(e,t){const s=this.getMap();if(s.hasListener(e)){const n=new RenderEvent(e,void 0,t);s.dispatchEvent(n)}}disposeInternal(){unlistenByKey(this.fontChangeListenerKey_),this.element_.remove(),super.disposeInternal()}renderFrame(e){if(!e){this.renderedVisible_&&(this.element_.style.display="none",this.renderedVisible_=!1);return}this.calculateMatrices2D(e),this.dispatchRenderEvent(RenderEventType.PRECOMPOSE,e);const t=e.layerStatesArray.sort((d,u)=>d.zIndex-u.zIndex);t.some(d=>d.layer instanceof BaseVectorLayer&&d.layer.getDeclutter())&&(e.declutter={});const n=e.viewState;this.children_.length=0;const o=[];let a=null;for(let d=0,u=t.length;d<u;++d){const _=t[d];e.layerIndex=d;const f=_.layer,v=f.getSourceState();if(!inView(_,n)||v!="ready"&&v!="undefined"){f.unrender();continue}const g=f.render(e,a);g&&(g!==a&&(this.children_.push(g),a=g),o.push(_))}this.declutter(e,o),replaceChildren(this.element_,this.children_);const c=this.getMap().getTargetElement();if(isCanvas(c)){const d=c.getContext("2d");for(const u of this.children_){const _=u.firstElementChild||u,f=u.style.backgroundColor;if(f&&(!isCanvas(_)||_.width>0)&&(d.fillStyle=f,d.fillRect(0,0,c.width,c.height)),isCanvas(_)&&_.width>0){d.save();const v=u.style.opacity||_.style.opacity;d.globalAlpha=v===""?1:Number(v);const g=_.style.transform;if(g)d.transform(...fromString(g));else{const y=parseFloat(_.style.width)/_.width,p=parseFloat(_.style.height)/_.height;d.transform(y,0,0,p,0,0)}d.drawImage(_,0,0),d.restore()}}}this.dispatchRenderEvent(RenderEventType.POSTCOMPOSE,e),this.renderedVisible_||(this.element_.style.display="",this.renderedVisible_=!0),this.scheduleExpireIconCache(e)}declutter(e,t){if(e.declutter){for(let s=t.length-1;s>=0;--s){const n=t[s],o=n.layer;o.getDeclutter()&&o.renderDeclutter(e,n)}t.forEach(s=>s.layer.renderDeferred(e))}}}function removeLayerMapProperty(l){if(l instanceof Layer){l.setMapInternal(null);return}l instanceof LayerGroup&&l.getLayers().forEach(removeLayerMapProperty)}function setLayerMapProperty(l,e){if(l instanceof Layer){l.setMapInternal(e);return}if(l instanceof LayerGroup){const t=l.getLayers().getArray();for(let s=0,n=t.length;s<n;++s)setLayerMapProperty(t[s],e)}}let Map$1=class extends BaseObject{constructor(e){super(),e=e||{},this.on,this.once,this.un;const t=createOptionsInternal(e);this.renderComplete_=!1,this.loaded_=!0,this.boundHandleBrowserEvent_=this.handleBrowserEvent.bind(this),this.maxTilesLoading_=e.maxTilesLoading!==void 0?e.maxTilesLoading:16,this.pixelRatio_=e.pixelRatio!==void 0?e.pixelRatio:DEVICE_PIXEL_RATIO,this.postRenderTimeoutHandle_,this.animationDelayKey_,this.animationDelay_=this.animationDelay_.bind(this),this.coordinateToPixelTransform_=create(),this.pixelToCoordinateTransform_=create(),this.frameIndex_=0,this.frameState_=null,this.previousExtent_=null,this.viewPropertyListenerKey_=null,this.viewChangeListenerKey_=null,this.layerGroupPropertyListenerKeys_=null,WORKER_OFFSCREEN_CANVAS||(this.viewport_=document.createElement("div"),this.viewport_.className="ol-viewport"+("ontouchstart"in window?" ol-touch":""),this.viewport_.style.position="relative",this.viewport_.style.overflow="hidden",this.viewport_.style.width="100%",this.viewport_.style.height="100%",this.overlayContainer_=document.createElement("div"),this.overlayContainer_.style.position="absolute",this.overlayContainer_.style.zIndex="0",this.overlayContainer_.style.width="100%",this.overlayContainer_.style.height="100%",this.overlayContainer_.style.pointerEvents="none",this.overlayContainer_.className="ol-overlaycontainer",this.viewport_.appendChild(this.overlayContainer_),this.overlayContainerStopEvent_=document.createElement("div"),this.overlayContainerStopEvent_.style.position="absolute",this.overlayContainerStopEvent_.style.zIndex="0",this.overlayContainerStopEvent_.style.width="100%",this.overlayContainerStopEvent_.style.height="100%",this.overlayContainerStopEvent_.style.pointerEvents="none",this.overlayContainerStopEvent_.className="ol-overlaycontainer-stopevent",this.viewport_.appendChild(this.overlayContainerStopEvent_)),this.mapBrowserEventHandler_=null,this.moveTolerance_=e.moveTolerance,this.keyboardEventTarget_=t.keyboardEventTarget,this.targetChangeHandlerKeys_=null,this.targetElement_=null,WORKER_OFFSCREEN_CANVAS||(this.resizeObserver_=new ResizeObserver(()=>this.updateSize())),this.controls=t.controls||(WORKER_OFFSCREEN_CANVAS?new Collection:defaults$1()),this.interactions=t.interactions||(WORKER_OFFSCREEN_CANVAS?new Collection:defaults({onFocusOnly:!0})),this.overlays_=t.overlays,this.overlayIdIndex_={},this.renderer_=null,this.postRenderFunctions_=[],this.tileQueue_=new TileQueue(this.getTilePriority.bind(this),this.handleTileChange_.bind(this)),this.addChangeListener(MapProperty.LAYERGROUP,this.handleLayerGroupChanged_),this.addChangeListener(MapProperty.VIEW,this.handleViewChanged_),this.addChangeListener(MapProperty.SIZE,this.handleSizeChanged_),this.addChangeListener(MapProperty.TARGET,this.handleTargetChanged_),this.setProperties(t.values);const s=this;e.view&&!(e.view instanceof View)&&e.view.then(function(n){s.setView(new View(n))}),this.controls.addEventListener(CollectionEventType.ADD,n=>{n.element.setMap(this)}),this.controls.addEventListener(CollectionEventType.REMOVE,n=>{n.element.setMap(null)}),this.interactions.addEventListener(CollectionEventType.ADD,n=>{n.element.setMap(this)}),this.interactions.addEventListener(CollectionEventType.REMOVE,n=>{n.element.setMap(null)}),this.overlays_.addEventListener(CollectionEventType.ADD,n=>{this.addOverlayInternal_(n.element)}),this.overlays_.addEventListener(CollectionEventType.REMOVE,n=>{const o=n.element.getId();o!==void 0&&delete this.overlayIdIndex_[o.toString()],n.element.setMap(null)}),this.controls.forEach(n=>{n.setMap(this)}),this.interactions.forEach(n=>{n.setMap(this)}),this.overlays_.forEach(this.addOverlayInternal_.bind(this))}addControl(e){this.getControls().push(e)}addInteraction(e){this.getInteractions().push(e)}addLayer(e){this.getLayerGroup().getLayers().push(e)}handleLayerAdd_(e){setLayerMapProperty(e.layer,this)}addOverlay(e){this.getOverlays().push(e)}addOverlayInternal_(e){const t=e.getId();t!==void 0&&(this.overlayIdIndex_[t.toString()]=e),e.setMap(this)}disposeInternal(){var e;this.controls.clear(),this.interactions.clear(),this.overlays_.clear(),(e=this.resizeObserver_)==null||e.disconnect(),this.setTarget(null),super.disposeInternal()}forEachFeatureAtPixel(e,t,s){if(!this.frameState_||!this.renderer_)return;const n=this.getCoordinateFromPixelInternal(e);s=s!==void 0?s:{};const o=s.hitTolerance!==void 0?s.hitTolerance:0,a=s.layerFilter!==void 0?s.layerFilter:TRUE,h=s.checkWrapped!==!1;return this.renderer_.forEachFeatureAtCoordinate(n,this.frameState_,o,h,t,null,a,null)}getFeaturesAtPixel(e,t){const s=[];return this.forEachFeatureAtPixel(e,function(n){s.push(n)},t),s}getAllLayers(){const e=[];function t(s){s.forEach(function(n){n instanceof LayerGroup?t(n.getLayers()):e.push(n)})}return t(this.getLayers()),e}hasFeatureAtPixel(e,t){if(!this.frameState_||!this.renderer_)return!1;const s=this.getCoordinateFromPixelInternal(e);t=t!==void 0?t:{};const n=t.layerFilter!==void 0?t.layerFilter:TRUE,o=t.hitTolerance!==void 0?t.hitTolerance:0,a=t.checkWrapped!==!1;return this.renderer_.hasFeatureAtCoordinate(s,this.frameState_,o,a,n,null)}getEventCoordinate(e){return this.getCoordinateFromPixel(this.getEventPixel(e))}getEventCoordinateInternal(e){return this.getCoordinateFromPixelInternal(this.getEventPixel(e))}getEventPixel(e){const s=this.viewport_.getBoundingClientRect(),n=this.getSize(),o=s.width/n[0],a=s.height/n[1],h="changedTouches"in e?e.changedTouches[0]:e;return[(h.clientX-s.left)/o,(h.clientY-s.top)/a]}getTarget(){return this.get(MapProperty.TARGET)}getTargetElement(){return this.targetElement_}getCoordinateFromPixel(e){return toUserCoordinate(this.getCoordinateFromPixelInternal(e),this.getView().getProjection())}getCoordinateFromPixelInternal(e){const t=this.frameState_;return t?apply(t.pixelToCoordinateTransform,e.slice()):null}getControls(){return this.controls}getOverlays(){return this.overlays_}getOverlayById(e){const t=this.overlayIdIndex_[e.toString()];return t!==void 0?t:null}getInteractions(){return this.interactions}getLayerGroup(){return this.get(MapProperty.LAYERGROUP)}setLayers(e){const t=this.getLayerGroup();if(e instanceof Collection){t.setLayers(e);return}const s=t.getLayers();s.clear(),s.extend(e)}getLayers(){return this.getLayerGroup().getLayers()}getLoadingOrNotReady(){const e=this.getLayerGroup().getLayerStatesArray();for(let t=0,s=e.length;t<s;++t){const n=e[t];if(!n.visible)continue;const o=n.layer.getRenderer();if(o&&!o.ready)return!0;const a=n.layer.getSource();if(a&&a.loading)return!0}return!1}getPixelFromCoordinate(e){const t=fromUserCoordinate(e,this.getView().getProjection());return this.getPixelFromCoordinateInternal(t)}getPixelFromCoordinateInternal(e){const t=this.frameState_;return t?apply(t.coordinateToPixelTransform,e.slice(0,2)):null}getPixelRatio(){return this.pixelRatio_}setPixelRatio(e){this.pixelRatio_!==e&&(this.pixelRatio_=e,this.render())}getRenderer(){return this.renderer_}getSize(){return this.get(MapProperty.SIZE)}getView(){return this.get(MapProperty.VIEW)}getViewport(){return this.viewport_}getOverlayContainer(){return this.overlayContainer_}getOverlayContainerStopEvent(){return this.overlayContainerStopEvent_}getOwnerDocument(){const e=this.getTargetElement();return e?e.ownerDocument:document}getTilePriority(e,t,s,n){return getTilePriority(this.frameState_,e,t,s,n)}handleBrowserEvent(e,t){t=t||e.type;const s=new MapBrowserEvent(t,this,e);this.handleMapBrowserEvent(s)}handleMapBrowserEvent(e){if(!this.frameState_)return;const t=e.originalEvent,s=t.type;if(s===EventType.POINTERDOWN||s===EventType$1.WHEEL||s===EventType$1.KEYDOWN){const n=this.getOwnerDocument(),o=this.viewport_.getRootNode?this.viewport_.getRootNode():n,a=t.target,h=o instanceof ShadowRoot?o.host===a?o.host.ownerDocument:o:o===n?n.documentElement:o;if(this.overlayContainerStopEvent_.contains(a)||!h.contains(a))return}if(e.frameState=this.frameState_,this.dispatchEvent(e)!==!1){const n=this.getInteractions().getArray().slice();for(let o=n.length-1;o>=0;o--){const a=n[o];if(a.getMap()!==this||!a.getActive()||!this.getTargetElement())continue;if(!a.handleEvent(e)||e.propagationStopped)break}}}handlePostRender(){const e=this.frameState_,t=this.tileQueue_;if(!t.isEmpty()){let n=this.maxTilesLoading_,o=n;if(e){const a=e.viewHints;if(a[ViewHint.ANIMATING]||a[ViewHint.INTERACTING]){const h=Date.now()-e.time>8;n=h?0:8,o=h?0:2}}t.getTilesLoading()<n&&(t.reprioritize(),t.loadMoreTiles(n,o))}e&&this.renderer_&&!e.animate&&(this.renderComplete_?(this.hasListener(RenderEventType.RENDERCOMPLETE)&&this.renderer_.dispatchRenderEvent(RenderEventType.RENDERCOMPLETE,e),this.loaded_===!1&&(this.loaded_=!0,this.dispatchEvent(new MapEvent(MapEventType.LOADEND,this,e)))):this.loaded_===!0&&(this.loaded_=!1,this.dispatchEvent(new MapEvent(MapEventType.LOADSTART,this,e))));const s=this.postRenderFunctions_;if(e)for(let n=0,o=s.length;n<o;++n)s[n](this,e);s.length=0}handleSizeChanged_(){this.getView()&&!this.getView().getAnimating()&&this.getView().resolveConstraints(0),this.render()}handleTargetChanged_(){var s,n;if(this.mapBrowserEventHandler_){for(let o=0,a=this.targetChangeHandlerKeys_.length;o<a;++o)unlistenByKey(this.targetChangeHandlerKeys_[o]);this.targetChangeHandlerKeys_=null,this.viewport_.removeEventListener(EventType$1.CONTEXTMENU,this.boundHandleBrowserEvent_),this.viewport_.removeEventListener(EventType$1.WHEEL,this.boundHandleBrowserEvent_),this.mapBrowserEventHandler_.dispose(),this.mapBrowserEventHandler_=null,this.viewport_.remove()}if(this.targetElement_&&!isCanvas(this.targetElement_)){(s=this.resizeObserver_)==null||s.unobserve(this.targetElement_);const o=this.targetElement_.getRootNode();o instanceof ShadowRoot&&this.resizeObserver_.unobserve(o.host),this.setSize(void 0)}const e=this.getTarget(),t=typeof e=="string"?document.getElementById(e):e;if(this.targetElement_=t,!t)this.renderer_&&(clearTimeout(this.postRenderTimeoutHandle_),this.postRenderTimeoutHandle_=void 0,this.postRenderFunctions_.length=0,this.renderer_.dispose(),this.renderer_=null),this.animationDelayKey_&&(cancelAnimationFrame(this.animationDelayKey_),this.animationDelayKey_=void 0);else{if(isCanvas(t)||t.appendChild(this.viewport_),this.renderer_||(this.renderer_=new CompositeMapRenderer(this)),!isCanvas(t)){this.mapBrowserEventHandler_=new MapBrowserEventHandler(this,this.moveTolerance_);for(const a in MapBrowserEventType)this.mapBrowserEventHandler_.addEventListener(MapBrowserEventType[a],this.handleMapBrowserEvent.bind(this));this.viewport_.addEventListener(EventType$1.CONTEXTMENU,this.boundHandleBrowserEvent_,!1),this.viewport_.addEventListener(EventType$1.WHEEL,this.boundHandleBrowserEvent_,PASSIVE_EVENT_LISTENERS?{passive:!1}:!1);let o;if(this.keyboardEventTarget_)o=this.keyboardEventTarget_;else{const a=t.getRootNode();o=a instanceof ShadowRoot?a.host:t}if(this.targetChangeHandlerKeys_=[listen(o,EventType$1.KEYDOWN,this.handleBrowserEvent,this),listen(o,EventType$1.KEYPRESS,this.handleBrowserEvent,this)],t instanceof HTMLElement){const a=t.getRootNode();a instanceof ShadowRoot&&this.resizeObserver_.observe(a.host),(n=this.resizeObserver_)==null||n.observe(t)}}this.updateSize()}}handleTileChange_(){this.render()}handleViewPropertyChanged_(){this.render()}handleViewChanged_(){this.viewPropertyListenerKey_&&(unlistenByKey(this.viewPropertyListenerKey_),this.viewPropertyListenerKey_=null),this.viewChangeListenerKey_&&(unlistenByKey(this.viewChangeListenerKey_),this.viewChangeListenerKey_=null);const e=this.getView();e&&(this.updateViewportSize_(this.getSize()),this.viewPropertyListenerKey_=listen(e,ObjectEventType.PROPERTYCHANGE,this.handleViewPropertyChanged_,this),this.viewChangeListenerKey_=listen(e,EventType$1.CHANGE,this.handleViewPropertyChanged_,this),e.resolveConstraints(0)),this.render()}handleLayerGroupChanged_(){this.layerGroupPropertyListenerKeys_&&(this.layerGroupPropertyListenerKeys_.forEach(unlistenByKey),this.layerGroupPropertyListenerKeys_=null);const e=this.getLayerGroup();e&&(this.handleLayerAdd_(new GroupEvent("addlayer",e)),this.layerGroupPropertyListenerKeys_=[listen(e,ObjectEventType.PROPERTYCHANGE,this.render,this),listen(e,EventType$1.CHANGE,this.render,this),listen(e,"addlayer",this.handleLayerAdd_,this),listen(e,"removelayer",this.handleLayerRemove_,this)]),this.render()}isRendered(){return!!this.frameState_}animationDelay_(){this.animationDelayKey_=void 0,this.renderFrame_(Date.now())}renderSync(){this.animationDelayKey_&&cancelAnimationFrame(this.animationDelayKey_),this.animationDelay_()}redrawText(){if(!this.frameState_)return;const e=this.frameState_.layerStatesArray;for(let t=0,s=e.length;t<s;++t){const n=e[t].layer;n.hasRenderer()&&n.getRenderer().handleFontsChanged()}}render(){this.renderer_&&this.animationDelayKey_===void 0&&(this.animationDelayKey_=requestAnimationFrame(this.animationDelay_))}removeControl(e){return this.getControls().remove(e)}removeInteraction(e){return this.getInteractions().remove(e)}removeLayer(e){return this.getLayerGroup().getLayers().remove(e)}handleLayerRemove_(e){removeLayerMapProperty(e.layer)}removeOverlay(e){return this.getOverlays().remove(e)}renderFrame_(e){const t=this.getSize(),s=this.getView(),n=this.frameState_;let o=null;if(t!==void 0&&hasArea(t)&&s&&s.isDef()){const a=s.getHints(this.frameState_?this.frameState_.viewHints:void 0),h=s.getState();if(o={animate:!1,coordinateToPixelTransform:this.coordinateToPixelTransform_,declutter:null,extent:getForViewAndSize(h.center,h.resolution,h.rotation,t),index:this.frameIndex_++,layerIndex:0,layerStatesArray:this.getLayerGroup().getLayerStatesArray(),pixelRatio:this.pixelRatio_,pixelToCoordinateTransform:this.pixelToCoordinateTransform_,postRenderFunctions:[],size:t,tileQueue:this.tileQueue_,time:e,usedTiles:{},viewState:h,viewHints:a,wantedTiles:{},mapId:getUid(this),renderTargets:{}},h.nextCenter&&h.nextResolution){const c=isNaN(h.nextRotation)?h.rotation:h.nextRotation;o.nextExtent=getForViewAndSize(h.nextCenter,h.nextResolution,c,t)}}this.frameState_=o,this.renderer_.renderFrame(o),o&&(o.animate&&this.render(),Array.prototype.push.apply(this.postRenderFunctions_,o.postRenderFunctions),n&&(!this.previousExtent_||!isEmpty(this.previousExtent_)&&!equals$1(o.extent,this.previousExtent_))&&(this.dispatchEvent(new MapEvent(MapEventType.MOVESTART,this,n)),this.previousExtent_=createOrUpdateEmpty(this.previousExtent_)),this.previousExtent_&&!o.viewHints[ViewHint.ANIMATING]&&!o.viewHints[ViewHint.INTERACTING]&&!equals$1(o.extent,this.previousExtent_)&&(this.dispatchEvent(new MapEvent(MapEventType.MOVEEND,this,o)),clone(o.extent,this.previousExtent_))),this.dispatchEvent(new MapEvent(MapEventType.POSTRENDER,this,o)),this.renderComplete_=(this.hasListener(MapEventType.LOADSTART)||this.hasListener(MapEventType.LOADEND)||this.hasListener(RenderEventType.RENDERCOMPLETE))&&!this.tileQueue_.getTilesLoading()&&!this.tileQueue_.getCount()&&!this.getLoadingOrNotReady(),this.postRenderTimeoutHandle_||(this.postRenderTimeoutHandle_=setTimeout(()=>{this.postRenderTimeoutHandle_=void 0,this.handlePostRender()},0))}setLayerGroup(e){const t=this.getLayerGroup();t&&this.handleLayerRemove_(new GroupEvent("removelayer",t)),this.set(MapProperty.LAYERGROUP,e)}setSize(e){this.set(MapProperty.SIZE,e)}setTarget(e){this.set(MapProperty.TARGET,e)}setView(e){if(!e||e instanceof View){this.set(MapProperty.VIEW,e);return}this.set(MapProperty.VIEW,new View);const t=this;e.then(function(s){t.setView(new View(s))})}updateSize(){const e=this.getTargetElement();let t;if(e){let n,o;if(isCanvas(e)){const a=e.getContext("2d").getTransform();n=e.width/a.a,o=e.height/a.d}else{const a=getComputedStyle(e);n=e.offsetWidth-parseFloat(a.borderLeftWidth)-parseFloat(a.paddingLeft)-parseFloat(a.paddingRight)-parseFloat(a.borderRightWidth),o=e.offsetHeight-parseFloat(a.borderTopWidth)-parseFloat(a.paddingTop)-parseFloat(a.paddingBottom)-parseFloat(a.borderBottomWidth)}!isNaN(n)&&!isNaN(o)&&(t=[Math.max(0,n),Math.max(0,o)],!hasArea(t)&&(e.offsetWidth||e.offsetHeight||e.getClientRects().length)&&warn("No map visible because the map container's width or height are 0."))}const s=this.getSize();t&&(!s||!equals(t,s))&&(this.setSize(t),this.updateViewportSize_(t))}updateViewportSize_(e){const t=this.getView();t&&t.setViewportSize(e)}};function createOptionsInternal(l){let e=null;l.keyboardEventTarget!==void 0&&(e=typeof l.keyboardEventTarget=="string"?document.getElementById(l.keyboardEventTarget):l.keyboardEventTarget);const t={},s=l.layers&&typeof l.layers.getLayers=="function"?l.layers:new LayerGroup({layers:l.layers});t[MapProperty.LAYERGROUP]=s,t[MapProperty.TARGET]=l.target,t[MapProperty.VIEW]=l.view instanceof View?l.view:new View;let n;l.controls!==void 0&&(Array.isArray(l.controls)?n=new Collection(l.controls.slice()):(assert(typeof l.controls.getArray=="function","Expected `controls` to be an array or an `ol/Collection.js`"),n=l.controls));let o;l.interactions!==void 0&&(Array.isArray(l.interactions)?o=new Collection(l.interactions.slice()):(assert(typeof l.interactions.getArray=="function","Expected `interactions` to be an array or an `ol/Collection.js`"),o=l.interactions));let a;return l.overlays!==void 0?Array.isArray(l.overlays)?a=new Collection(l.overlays.slice()):(assert(typeof l.overlays.getArray=="function","Expected `overlays` to be an array or an `ol/Collection.js`"),a=l.overlays):a=new Collection,{controls:n,interactions:o,keyboardEventTarget:e,overlays:a,values:t}}const Property={ELEMENT:"element",MAP:"map",OFFSET:"offset",POSITION:"position",POSITIONING:"positioning"};class Overlay extends BaseObject{constructor(e){super(),this.on,this.once,this.un,this.options=e,this.id=e.id,this.insertFirst=e.insertFirst!==void 0?e.insertFirst:!0,this.stopEvent=e.stopEvent!==void 0?e.stopEvent:!0,this.element=document.createElement("div"),this.element.className=e.className!==void 0?e.className:"ol-overlay-container "+CLASS_SELECTABLE,this.element.style.position="absolute",this.element.style.pointerEvents="auto",this.autoPan=e.autoPan===!0?{}:e.autoPan||void 0,this.rendered={transform_:"",visible:!0},this.mapPostrenderListenerKey=null,this.addChangeListener(Property.ELEMENT,this.handleElementChanged),this.addChangeListener(Property.MAP,this.handleMapChanged),this.addChangeListener(Property.OFFSET,this.handleOffsetChanged),this.addChangeListener(Property.POSITION,this.handlePositionChanged),this.addChangeListener(Property.POSITIONING,this.handlePositioningChanged),e.element!==void 0&&this.setElement(e.element),this.setOffset(e.offset!==void 0?e.offset:[0,0]),this.setPositioning(e.positioning||"top-left"),e.position!==void 0&&this.setPosition(e.position)}getElement(){return this.get(Property.ELEMENT)}getId(){return this.id}getMap(){return this.get(Property.MAP)||null}getOffset(){return this.get(Property.OFFSET)}getPosition(){return this.get(Property.POSITION)}getPositioning(){return this.get(Property.POSITIONING)}handleElementChanged(){removeChildren(this.element);const e=this.getElement();e&&this.element.appendChild(e)}handleMapChanged(){var t;this.mapPostrenderListenerKey&&((t=this.element)==null||t.remove(),unlistenByKey(this.mapPostrenderListenerKey),this.mapPostrenderListenerKey=null);const e=this.getMap();if(e){this.mapPostrenderListenerKey=listen(e,MapEventType.POSTRENDER,this.render,this),this.updatePixelPosition();const s=this.stopEvent?e.getOverlayContainerStopEvent():e.getOverlayContainer();this.insertFirst?s.insertBefore(this.element,s.childNodes[0]||null):s.appendChild(this.element),this.performAutoPan()}}render(){this.updatePixelPosition()}handleOffsetChanged(){this.updatePixelPosition()}handlePositionChanged(){this.updatePixelPosition(),this.performAutoPan()}handlePositioningChanged(){this.updatePixelPosition()}setElement(e){this.set(Property.ELEMENT,e)}setMap(e){this.set(Property.MAP,e)}setOffset(e){this.set(Property.OFFSET,e)}setPosition(e){this.set(Property.POSITION,e)}performAutoPan(){this.autoPan&&this.panIntoView(this.autoPan)}panIntoView(e){const t=this.getMap();if(!t||!t.getTargetElement()||!this.get(Property.POSITION))return;const s=this.getRect(t.getTargetElement(),t.getSize()),n=this.getElement(),o=this.getRect(n,[outerWidth(n),outerHeight(n)]);e=e||{};const a=e.margin===void 0?20:e.margin;if(!containsExtent(s,o)){const h=o[0]-s[0],c=s[2]-o[2],d=o[1]-s[1],u=s[3]-o[3],_=[0,0];if(h<0?_[0]=h-a:c<0&&(_[0]=Math.abs(c)+a),d<0?_[1]=d-a:u<0&&(_[1]=Math.abs(u)+a),_[0]!==0||_[1]!==0){const f=t.getView().getCenterInternal(),v=t.getPixelFromCoordinateInternal(f);if(!v)return;const g=[v[0]+_[0],v[1]+_[1]],y=e.animation||{};t.getView().animateInternal({center:t.getCoordinateFromPixelInternal(g),duration:y.duration,easing:y.easing})}}}getRect(e,t){const s=e.getBoundingClientRect(),n=s.left+window.pageXOffset,o=s.top+window.pageYOffset;return[n,o,n+t[0],o+t[1]]}setPositioning(e){this.set(Property.POSITIONING,e)}setVisible(e){this.rendered.visible!==e&&(this.element.style.display=e?"":"none",this.rendered.visible=e)}updatePixelPosition(){const e=this.getMap(),t=this.getPosition();if(!e||!e.isRendered()||!t){this.setVisible(!1);return}const s=e.getPixelFromCoordinate(t),n=e.getSize();this.updateRenderedPosition(s,n)}updateRenderedPosition(e,t){const s=this.element.style,n=this.getOffset(),o=this.getPositioning();this.setVisible(!0);const a=`${e[0]+n[0]}px`,h=`${e[1]+n[1]}px`;let c="0%",d="0%";o=="bottom-right"||o=="center-right"||o=="top-right"?c="-100%":(o=="bottom-center"||o=="center-center"||o=="top-center")&&(c="-50%"),o=="bottom-left"||o=="bottom-center"||o=="bottom-right"?d="-100%":(o=="center-left"||o=="center-center"||o=="center-right")&&(d="-50%");const u=`translate(${c}, ${d}) translate(${a}, ${h})`;this.rendered.transform_!=u&&(this.rendered.transform_=u,s.transform=u)}getOptions(){return this.options}}const DEFAULT_VERSION="1.3.0",GETFEATUREINFO_IMAGE_SIZE=[101,101];function getRequestUrl(l,e,t,s,n){n.WIDTH=t[0],n.HEIGHT=t[1];const o=s.getAxisOrientation(),a=compareVersions(n.VERSION,"1.3")>=0;n[a?"CRS":"SRS"]=s.getCode();const h=a&&o.startsWith("ne")?[e[1],e[0],e[3],e[2]]:e;return n.BBOX=h.join(","),appendParams(l,n)}function getImageSrc(l,e,t,s,n,o,a){o=Object.assign({REQUEST:"GetMap"},o);const h=e/t,c=[round(getWidth(l)/h,DECIMALS),round(getHeight(l)/h,DECIMALS)];if(t!=1)switch(a){case"geoserver":const u=90*t+.5|0;"FORMAT_OPTIONS"in o?o.FORMAT_OPTIONS+=";dpi:"+u:o.FORMAT_OPTIONS="dpi:"+u;break;case"mapserver":o.MAP_RESOLUTION=90*t;break;case"carmentaserver":case"qgis":o.DPI=90*t;break;default:throw new Error("Unknown `serverType` configured")}return getRequestUrl(n,l,c,s,o)}function getRequestParams(l,e){return Object.assign({REQUEST:e,SERVICE:"WMS",VERSION:DEFAULT_VERSION,FORMAT:"image/png",STYLES:"",TRANSPARENT:"TRUE"},l)}function createLoader(l){const e=l.hidpi===void 0?!0:l.hidpi,t=get(l.projection||"EPSG:3857"),s=l.ratio||1.5,n=l.load||decode,o=l.crossOrigin??null;return(a,h,c)=>{a=getRequestExtent(a,h,c,s),c!=1&&(!e||l.serverType===void 0)&&(c=1);const d=getImageSrc(a,h,c,t,l.url,getRequestParams(l.params,"GetMap"),l.serverType),u=new Image;return u.crossOrigin=o,n(u,d).then(_=>({image:_,extent:a,pixelRatio:c}))}}function getFeatureInfoUrl(l,e,t){if(l.url===void 0)return;const s=get(l.projection||"EPSG:3857"),n=getForViewAndSize(e,t,0,GETFEATUREINFO_IMAGE_SIZE),o={QUERY_LAYERS:l.params.LAYERS,INFO_FORMAT:"application/json"};Object.assign(o,getRequestParams(l.params,"GetFeatureInfo"),l.params);const a=floor((e[0]-n[0])/t,DECIMALS),h=floor((n[3]-e[1])/t,DECIMALS),c=compareVersions(o.VERSION,"1.3")>=0;return o[c?"I":"X"]=a,o[c?"J":"Y"]=h,getRequestUrl(l.url,n,GETFEATUREINFO_IMAGE_SIZE,s,o)}function getLegendUrl(l,e){if(l.url===void 0)return;const t={SERVICE:"WMS",VERSION:DEFAULT_VERSION,REQUEST:"GetLegendGraphic",FORMAT:"image/png"};if(e!==void 0){const s=get(l.projection||"EPSG:3857").getMetersPerUnit()||1,n=28e-5;t.SCALE=e*s/n}if(Object.assign(t,l.params),l.params!==void 0&&t.LAYER===void 0){const s=t.LAYERS;if(!(!Array.isArray(s)||s.length!==1))return;t.LAYER=s}return appendParams(l.url,t)}class ImageWMS extends ImageSource{constructor(e){e=e||{},super({attributions:e.attributions,interpolate:e.interpolate,projection:e.projection,resolutions:e.resolutions}),this.crossOrigin_=e.crossOrigin!==void 0?e.crossOrigin:null,this.url_=e.url,this.imageLoadFunction_=e.imageLoadFunction!==void 0?e.imageLoadFunction:defaultImageLoadFunction,this.params_=Object.assign({},e.params),this.serverType_=e.serverType,this.hidpi_=e.hidpi!==void 0?e.hidpi:!0,this.renderedRevision_=0,this.ratio_=e.ratio!==void 0?e.ratio:1.5,this.loaderProjection_=null}getFeatureInfoUrl(e,t,s,n){const o=get(s),a=this.getProjection();a&&a!==o&&(t=calculateSourceResolution(a,o,e,t),e=transform$1(e,o,a));const h={url:this.url_,params:{...this.params_,...n},projection:a||o};return getFeatureInfoUrl(h,e,t)}getLegendUrl(e,t){return getLegendUrl({url:this.url_,params:{...this.params_,...t}},e)}getParams(){return this.params_}getImageInternal(e,t,s,n){return this.url_===void 0?null:((!this.loader||this.loaderProjection_!==n)&&(this.loaderProjection_=n,this.loader=createLoader({crossOrigin:this.crossOrigin_,params:this.params_,projection:n,serverType:this.serverType_,hidpi:this.hidpi_,url:this.url_,ratio:this.ratio_,load:(o,a)=>(this.image.setImage(o),this.imageLoadFunction_(this.image,a),decode(o))})),super.getImageInternal(e,t,s,n))}getImageLoadFunction(){return this.imageLoadFunction_}getUrl(){return this.url_}setImageLoadFunction(e){this.imageLoadFunction_=e,this.changed()}setUrl(e){e!=this.url_&&(this.url_=e,this.loader=null,this.changed())}setParams(e){this.params_=Object.assign({},e),this.changed()}updateParams(e){Object.assign(this.params_,e),this.changed()}changed(){this.image=null,super.changed()}}class TileWMS extends TileImage{constructor(e){e=e||{};const t=Object.assign({},e.params);super({attributions:e.attributions,attributionsCollapsible:e.attributionsCollapsible,cacheSize:e.cacheSize,crossOrigin:e.crossOrigin,interpolate:e.interpolate,projection:e.projection,reprojectionErrorThreshold:e.reprojectionErrorThreshold,tileClass:e.tileClass,tileGrid:e.tileGrid,tileLoadFunction:e.tileLoadFunction,url:e.url,urls:e.urls,wrapX:e.wrapX!==void 0?e.wrapX:!0,transition:e.transition,zDirection:e.zDirection}),this.gutter_=e.gutter!==void 0?e.gutter:0,this.params_=t,this.v13_=!0,this.serverType_=e.serverType,this.hidpi_=e.hidpi!==void 0?e.hidpi:!0,this.tmpExtent_=createEmpty(),this.updateV13_(),this.setKey(this.getKeyForParams_())}getFeatureInfoUrl(e,t,s,n){const o=get(s),a=this.getProjection()||o;let h=this.getTileGrid();h||(h=this.getTileGridForProjection(a));const c=transform$1(e,o,a),d=calculateSourceResolution(a,o,e,t),u=h.getZForResolution(d,this.zDirection),_=h.getResolution(u),f=h.getTileCoordForCoordAndZ(c,u);if(h.getResolutions().length<=f[0])return;let v=h.getTileCoordExtent(f,this.tmpExtent_);const g=this.gutter_;g!==0&&(v=buffer(v,_*g,v));const y={QUERY_LAYERS:this.params_.LAYERS};Object.assign(y,getRequestParams(this.params_,"GetFeatureInfo"),n);const p=Math.floor((c[0]-v[0])/_),x=Math.floor((v[3]-c[1])/_);return y[this.v13_?"I":"X"]=p,y[this.v13_?"J":"Y"]=x,this.getRequestUrl_(f,v,1,a||o,y)}getLegendUrl(e,t){if(this.urls[0]===void 0)return;const s={SERVICE:"WMS",VERSION:DEFAULT_VERSION,REQUEST:"GetLegendGraphic",FORMAT:"image/png"};if(t===void 0||t.LAYER===void 0){const n=this.params_.LAYERS;if(!(!Array.isArray(n)||n.length===1))return;s.LAYER=n}if(e!==void 0){const n=this.getProjection()?this.getProjection().getMetersPerUnit():1,o=28e-5;s.SCALE=e*n/o}return Object.assign(s,t),appendParams(this.urls[0],s)}getGutter(){return this.gutter_}getParams(){return this.params_}getRequestUrl_(e,t,s,n,o){const a=this.urls;if(!a)return;let h;if(a.length==1)h=a[0];else{const c=modulo(hash(e),a.length);h=a[c]}return getImageSrc(t,(this.tileGrid||this.getTileGridForProjection(n)).getResolution(e[0]),s,n,h,o,this.serverType_)}getTilePixelRatio(e){return!this.hidpi_||this.serverType_===void 0?1:e}getKeyForParams_(){let e=0;const t=[];for(const s in this.params_)t[e++]=s+"-"+this.params_[s];return t.join("/")}setParams_(e){this.params_=e,this.updateV13_(),this.setKey(this.getKeyForParams_())}setParams(e){this.setParams_(Object.assign({},e))}updateParams(e){this.setParams_(Object.assign(this.params_,e))}updateV13_(){const e=this.params_.VERSION||DEFAULT_VERSION;this.v13_=compareVersions(e,"1.3")>=0}tileUrlFunction(e,t,s){let n=this.getTileGrid();if(n||(n=this.getTileGridForProjection(s)),n.getResolutions().length<=e[0])return;t!=1&&(!this.hidpi_||this.serverType_===void 0)&&(t=1);const o=n.getResolution(e[0]);let a=n.getTileCoordExtent(e,this.tmpExtent_);const h=this.gutter_;h!==0&&(a=buffer(a,o*h,a));const c=Object.assign({},getRequestParams(this.params_,"GetMap"));return this.getRequestUrl_(e,a,t,s,c)}}const olCss=':root,:host{--ol-background-color: white;--ol-accent-background-color: #F5F5F5;--ol-subtle-background-color: rgba(128, 128, 128, .25);--ol-partial-background-color: rgba(255, 255, 255, .75);--ol-foreground-color: #333333;--ol-subtle-foreground-color: #666666;--ol-brand-color: #00AAFF}.ol-box{box-sizing:border-box;border-radius:2px;border:1.5px solid var(--ol-background-color);background-color:var(--ol-partial-background-color)}.ol-mouse-position{top:8px;right:8px;position:absolute}.ol-scale-line{background:var(--ol-partial-background-color);border-radius:4px;bottom:8px;left:8px;padding:2px;position:absolute}.ol-scale-line-inner{border:1px solid var(--ol-subtle-foreground-color);border-top:none;color:var(--ol-foreground-color);font-size:10px;text-align:center;margin:1px;will-change:contents,width;transition:all .25s}.ol-scale-bar{position:absolute;bottom:8px;left:8px}.ol-scale-bar-inner{display:flex}.ol-scale-step-marker{width:1px;height:15px;background-color:var(--ol-foreground-color);float:right;z-index:10}.ol-scale-step-text{position:absolute;bottom:-5px;font-size:10px;z-index:11;color:var(--ol-foreground-color);text-shadow:-1.5px 0 var(--ol-partial-background-color),0 1.5px var(--ol-partial-background-color),1.5px 0 var(--ol-partial-background-color),0 -1.5px var(--ol-partial-background-color)}.ol-scale-text{position:absolute;font-size:12px;text-align:center;bottom:25px;color:var(--ol-foreground-color);text-shadow:-1.5px 0 var(--ol-partial-background-color),0 1.5px var(--ol-partial-background-color),1.5px 0 var(--ol-partial-background-color),0 -1.5px var(--ol-partial-background-color)}.ol-scale-singlebar{position:relative;height:10px;z-index:9;box-sizing:border-box;border:1px solid var(--ol-foreground-color)}.ol-scale-singlebar-even{background-color:var(--ol-subtle-foreground-color)}.ol-scale-singlebar-odd{background-color:var(--ol-background-color)}.ol-unsupported{display:none}.ol-viewport,.ol-unselectable{-webkit-touch-callout:none;-webkit-user-select:none;-moz-user-select:none;user-select:none;-webkit-tap-highlight-color:transparent}.ol-viewport canvas{all:unset;overflow:hidden}.ol-viewport{touch-action:pan-x pan-y}.ol-selectable{-webkit-touch-callout:default;-webkit-user-select:text;-moz-user-select:text;user-select:text}.ol-grabbing{cursor:-webkit-grabbing;cursor:-moz-grabbing;cursor:grabbing}.ol-grab{cursor:move;cursor:-webkit-grab;cursor:-moz-grab;cursor:grab}.ol-control{position:absolute;background-color:var(--ol-subtle-background-color);border-radius:4px}.ol-zoom{top:.5em;left:.5em}.ol-rotate{top:.5em;right:.5em;transition:opacity .25s linear,visibility 0s linear}.ol-rotate.ol-hidden{opacity:0;visibility:hidden;transition:opacity .25s linear,visibility 0s linear .25s}.ol-zoom-extent{top:4.643em;left:.5em}.ol-full-screen{right:.5em;top:.5em}.ol-control button{display:block;margin:1px;padding:0;color:var(--ol-subtle-foreground-color);font-weight:700;text-decoration:none;font-size:inherit;text-align:center;height:1.375em;width:1.375em;line-height:.4em;background-color:var(--ol-background-color);border:none;border-radius:2px}.ol-control button::-moz-focus-inner{border:none;padding:0}.ol-zoom-extent button{line-height:1.4em}.ol-compass{display:block;font-weight:400;will-change:transform}.ol-touch .ol-control button{font-size:1.5em}.ol-touch .ol-zoom-extent{top:5.5em}.ol-control button:hover,.ol-control button:focus{text-decoration:none;outline:1px solid var(--ol-subtle-foreground-color);color:var(--ol-foreground-color)}.ol-zoom .ol-zoom-in{border-radius:2px 2px 0 0}.ol-zoom .ol-zoom-out{border-radius:0 0 2px 2px}.ol-attribution{text-align:right;bottom:.5em;right:.5em;max-width:calc(100% - 1.3em);display:flex;flex-flow:row-reverse;align-items:center}.ol-attribution a{color:var(--ol-subtle-foreground-color);text-decoration:none}.ol-attribution ul{margin:0;padding:1px .5em;color:var(--ol-foreground-color);text-shadow:0 0 2px var(--ol-background-color);font-size:12px}.ol-attribution li{display:inline;list-style:none}.ol-attribution li:not(:last-child):after{content:" "}.ol-attribution img{max-height:2em;max-width:inherit;vertical-align:middle}.ol-attribution button{flex-shrink:0}.ol-attribution.ol-collapsed ul{display:none}.ol-attribution:not(.ol-collapsed){background:var(--ol-partial-background-color)}.ol-attribution.ol-uncollapsible{bottom:0;right:0;border-radius:4px 0 0}.ol-attribution.ol-uncollapsible img{margin-top:-.2em;max-height:1.6em}.ol-attribution.ol-uncollapsible button{display:none}.ol-zoomslider{top:4.5em;left:.5em;height:200px}.ol-zoomslider button{position:relative;height:10px}.ol-touch .ol-zoomslider{top:5.5em}.ol-overviewmap{left:.5em;bottom:.5em}.ol-overviewmap.ol-uncollapsible{bottom:0;left:0;border-radius:0 4px 0 0}.ol-overviewmap .ol-overviewmap-map,.ol-overviewmap button{display:block}.ol-overviewmap .ol-overviewmap-map{border:1px solid var(--ol-subtle-foreground-color);height:150px;width:150px}.ol-overviewmap:not(.ol-collapsed) button{bottom:0;left:0;position:absolute}.ol-overviewmap.ol-collapsed .ol-overviewmap-map,.ol-overviewmap.ol-uncollapsible button{display:none}.ol-overviewmap:not(.ol-collapsed){background:var(--ol-subtle-background-color)}.ol-overviewmap-box{border:1.5px dotted var(--ol-subtle-foreground-color)}.ol-overviewmap .ol-overviewmap-box:hover{cursor:move}.ol-overviewmap .ol-viewport:hover{cursor:pointer}';function getCoordinate(l,e){const t=l.length;return e<0?l[e+t]:e>=t?l[e-t]:l[e]}function interpolateCoordinate(l,e){const t=l.length;let s=Math.floor(e);const n=e-s;s>=t?s-=t:s<0&&(s+=t);let o=s+1;o>=t&&(o-=t);const a=l[s],h=a[0],c=a[1],d=l[o],u=d[0]-h,_=d[1]-c;return[h+u*n,c+_*n]}const sharedUpdateInfo={index:-1,endIndex:NaN,closestTargetDistance:1/0};function getTraceTargetUpdate(l,e,t,s){const n=l[0],o=l[1];let a=1/0,h=-1,c=NaN;for(let _=0;_<e.targets.length;++_){const f=e.targets[_],v=f.coordinates;let g=1/0,y;for(let p=0;p<v.length-1;++p){const x=v[p],T=v[p+1],w=getPointSegmentRelationship(n,o,x,T);w.squaredDistance<g&&(g=w.squaredDistance,y=p+w.along)}g<a&&(a=g,f.ring&&e.targetIndex===_&&(f.endIndex>f.startIndex?y<f.startIndex&&(y+=v.length):f.endIndex<f.startIndex&&y>f.startIndex&&(y-=v.length)),c=y,h=_)}const d=e.targets[h];let u=d.ring;if(e.targetIndex===h&&u){const _=interpolateCoordinate(d.coordinates,c),f=t.getPixelFromCoordinate(_),v=t.getPixelFromCoordinate(e.startCoord);distance(f,v)>s&&(u=!1)}if(u){const _=d.coordinates,f=_.length,v=d.startIndex,g=c;if(v<g){const y=getCumulativeSquaredDistance(_,v,g);getCumulativeSquaredDistance(_,v,g-f)<y&&(c-=f)}else{const y=getCumulativeSquaredDistance(_,v,g);getCumulativeSquaredDistance(_,v,g+f)<y&&(c+=f)}}return sharedUpdateInfo.index=h,sharedUpdateInfo.endIndex=c,sharedUpdateInfo.closestTargetDistance=a,sharedUpdateInfo}function getTraceTargets(l,e){const t=[];for(let s=0;s<e.length;++s){const o=e[s].getGeometry();appendGeometryTraceTargets(l,o,t)}return t}function appendGeometryTraceTargets(l,e,t){if(e instanceof LineString){appendTraceTarget(l,e.getCoordinates(),!1,t);return}if(e instanceof MultiLineString){const s=e.getCoordinates();for(let n=0,o=s.length;n<o;++n)appendTraceTarget(l,s[n],!1,t);return}if(e instanceof Polygon){const s=e.getCoordinates();for(let n=0,o=s.length;n<o;++n)appendTraceTarget(l,s[n],!0,t);return}if(e instanceof MultiPolygon){const s=e.getCoordinates();for(let n=0,o=s.length;n<o;++n){const a=s[n];for(let h=0,c=a.length;h<c;++h)appendTraceTarget(l,a[h],!0,t)}return}if(e instanceof GeometryCollection){const s=e.getGeometries();for(let n=0;n<s.length;++n)appendGeometryTraceTargets(l,s[n],t);return}}function appendTraceTarget(l,e,t,s){const n=l[0],o=l[1];for(let a=0,h=e.length-1;a<h;++a){const c=e[a],d=e[a+1],u=getPointSegmentRelationship(n,o,c,d);if(u.squaredDistance===0){const _=a+u.along;s.push({coordinates:e,ring:t,startIndex:_,endIndex:_});return}}}function getSquaredDistance(l,e){return squaredDistance(l[0],l[1],e[0],e[1])}function getCumulativeSquaredDistance(l,e,t){let s,n;e<t?(s=e,n=t):(s=t,n=e);const o=Math.ceil(s),a=Math.floor(n);if(o>a){const c=interpolateCoordinate(l,s),d=interpolateCoordinate(l,n);return getSquaredDistance(c,d)}let h=0;if(s<o){const c=interpolateCoordinate(l,s),d=getCoordinate(l,o);h+=getSquaredDistance(c,d)}if(a<n){const c=getCoordinate(l,a),d=interpolateCoordinate(l,n);h+=getSquaredDistance(c,d)}for(let c=o;c<a-1;++c){const d=getCoordinate(l,c),u=getCoordinate(l,c+1);h+=getSquaredDistance(d,u)}return h}const sharedRel={along:0,squaredDistance:0};function getPointSegmentRelationship(l,e,t,s){const n=t[0],o=t[1],a=s[0],h=s[1],c=a-n,d=h-o;let u=0,_=n,f=o;return(c!==0||d!==0)&&(u=clamp(((l-n)*c+(e-o)*d)/(c*c+d*d),0,1),_+=c*u,f+=d*u),sharedRel.along=u,sharedRel.squaredDistance=toFixed(squaredDistance(l,e,_,f),10),sharedRel}const DrawEventType={DRAWSTART:"drawstart",DRAWEND:"drawend",DRAWABORT:"drawabort"};class DrawEvent extends BaseEvent{constructor(e,t){super(e),this.feature=t}}class Draw extends PointerInteraction{constructor(e){const t=e;t.stopDown||(t.stopDown=FALSE),super(t),this.on,this.once,this.un,this.options_=e,this.shouldHandle_=!1,this.downPx_=null,this.downTimeout_,this.lastDragTime_,this.pointerType_,this.freehand_=!1,this.source_=e.source?e.source:null,this.features_=e.features?e.features:null,this.snapTolerance_=e.snapTolerance?e.snapTolerance:12,this.type_=e.type,this.mode_=getMode(this.type_),this.stopClick_=!!e.stopClick,this.ignoreNextUpEvent_=!1,this.minPoints_=e.minPoints?e.minPoints:this.mode_==="Polygon"?3:2,this.maxPoints_=this.mode_==="Circle"?2:e.maxPoints?e.maxPoints:1/0,this.finishCondition_=e.finishCondition?e.finishCondition:TRUE,this.geometryLayout_=e.geometryLayout?e.geometryLayout:"XY";let s=e.geometryFunction;if(!s){const n=this.mode_;if(n==="Circle")s=(o,a,h)=>{const c=a||new Circle([NaN,NaN]),d=fromUserCoordinate(o[0]),u=squaredDistance$1(d,fromUserCoordinate(o[o.length-1]));return c.setCenterAndRadius(d,Math.sqrt(u),this.geometryLayout_),c};else{let o;n==="Point"?o=Point:n==="LineString"?o=LineString:n==="Polygon"&&(o=Polygon),s=(a,h,c)=>(h?n==="Polygon"?a[0].length?h.setCoordinates([a[0].concat([a[0][0]])],this.geometryLayout_):h.setCoordinates([],this.geometryLayout_):h.setCoordinates(a,this.geometryLayout_):h=new o(a,this.geometryLayout_),h)}}this.geometryFunction_=s,this.dragVertexDelay_=e.dragVertexDelay!==void 0?e.dragVertexDelay:500,this.finishCoordinate_=null,this.sketchFeature_=null,this.sketchPoint_=null,this.sketchCoords_=null,this.sketchLine_=null,this.sketchLineCoords_=null,this.squaredClickTolerance_=e.clickTolerance?e.clickTolerance*e.clickTolerance:36,this.overlay_=new VectorLayer({source:new VectorSource({useSpatialIndex:!1,wrapX:e.wrapX?e.wrapX:!1}),style:e.style?e.style:getDefaultStyleFunction$1(),updateWhileInteracting:!0}),this.geometryName_=e.geometryName,this.condition_=e.condition?e.condition:noModifierKeys,this.freehandCondition_,e.freehand?this.freehandCondition_=always:this.freehandCondition_=e.freehandCondition?e.freehandCondition:shiftKeyOnly,this.traceCondition_,this.setTrace(e.trace||!1),this.traceState_={active:!1},this.traceSource_=e.traceSource||e.source||null,this.addChangeListener(InteractionProperty.ACTIVE,this.updateState_)}setTrace(e){let t;e?e===!0?t=always:t=e:t=never,this.traceCondition_=t}setMap(e){super.setMap(e),this.updateState_()}setFreehand(e){this.freehand_=e,this.freehand_?this.freehandCondition_=always:this.freehandCondition_=this.options_&&this.options_.freehandCondition?this.options_.freehandCondition:shiftKeyOnly}getOverlay(){return this.overlay_}getFreehand(){return this.freehand_}handleEvent(e){e.originalEvent.type===EventType$1.CONTEXTMENU&&e.originalEvent.preventDefault(),this.freehand_=this.mode_!=="Point"&&this.freehandCondition_(e);let t=e.type===MapBrowserEventType.POINTERMOVE,s=!0;return!this.freehand_&&this.lastDragTime_&&e.type===MapBrowserEventType.POINTERDRAG&&(Date.now()-this.lastDragTime_>=this.dragVertexDelay_?(this.downPx_=e.pixel,this.shouldHandle_=!this.freehand_,t=!0):this.lastDragTime_=void 0,this.shouldHandle_&&this.downTimeout_!==void 0&&(clearTimeout(this.downTimeout_),this.downTimeout_=void 0)),this.freehand_&&e.type===MapBrowserEventType.POINTERDRAG&&this.sketchFeature_!==null?(this.addToDrawing_(e.coordinate),s=!1):this.freehand_&&e.type===MapBrowserEventType.POINTERDOWN?s=!1:t&&this.getPointerCount()<2?(s=e.type===MapBrowserEventType.POINTERMOVE,s&&this.freehand_?(this.handlePointerMove_(e),this.shouldHandle_&&e.originalEvent.preventDefault()):(e.originalEvent.pointerType==="mouse"||e.type===MapBrowserEventType.POINTERDRAG&&this.downTimeout_===void 0)&&this.handlePointerMove_(e)):e.type===MapBrowserEventType.DBLCLICK&&(s=!1),super.handleEvent(e)&&s}handleDownEvent(e){return this.shouldHandle_=!this.freehand_,this.freehand_?(this.downPx_=e.pixel,this.finishCoordinate_||this.startDrawing_(e.coordinate),!0):this.condition_(e)?(this.lastDragTime_=Date.now(),this.downTimeout_=setTimeout(()=>{this.handlePointerMove_(new MapBrowserEvent(MapBrowserEventType.POINTERMOVE,e.map,e.originalEvent,!1,e.frameState))},this.dragVertexDelay_),this.downPx_=e.pixel,!0):(this.lastDragTime_=void 0,!1)}deactivateTrace_(){this.traceState_={active:!1}}toggleTraceState_(e){if(!this.traceSource_||!this.traceCondition_(e))return;if(this.traceState_.active){this.deactivateTrace_();return}const t=this.getMap(),s=t.getCoordinateFromPixel([e.pixel[0]-this.snapTolerance_,e.pixel[1]+this.snapTolerance_]),n=t.getCoordinateFromPixel([e.pixel[0]+this.snapTolerance_,e.pixel[1]-this.snapTolerance_]),o=boundingExtent([s,n]),a=this.traceSource_.getFeaturesInExtent(o);if(a.length===0)return;const h=getTraceTargets(e.coordinate,a);h.length&&(this.traceState_={active:!0,startCoord:e.coordinate.slice(),targets:h,targetIndex:-1})}addOrRemoveTracedCoordinates_(e,t){const s=e.startIndex<=e.endIndex,n=e.startIndex<=t;s===n?s&&t>e.endIndex||!s&&t<e.endIndex?this.addTracedCoordinates_(e,e.endIndex,t):(s&&t<e.endIndex||!s&&t>e.endIndex)&&this.removeTracedCoordinates_(t,e.endIndex):(this.removeTracedCoordinates_(e.startIndex,e.endIndex),this.addTracedCoordinates_(e,e.startIndex,t))}removeTracedCoordinates_(e,t){if(e===t)return;let s=0;if(e<t){const n=Math.ceil(e);let o=Math.floor(t);o===t&&(o-=1),s=o-n+1}else{const n=Math.floor(e);let o=Math.ceil(t);o===t&&(o+=1),s=n-o+1}s>0&&this.removeLastPoints_(s)}addTracedCoordinates_(e,t,s){if(t===s)return;const n=[];if(t<s){const o=Math.ceil(t);let a=Math.floor(s);a===s&&(a-=1);for(let h=o;h<=a;++h)n.push(getCoordinate(e.coordinates,h))}else{const o=Math.floor(t);let a=Math.ceil(s);a===s&&(a+=1);for(let h=o;h>=a;--h)n.push(getCoordinate(e.coordinates,h))}n.length&&this.appendCoordinates(n)}updateTrace_(e){const t=this.traceState_;if(!t.active)return;if(t.targetIndex===-1){const h=e.map.getPixelFromCoordinate(t.startCoord);if(distance(h,e.pixel)<this.snapTolerance_)return}const s=getTraceTargetUpdate(e.coordinate,t,this.getMap(),this.snapTolerance_);if(t.targetIndex!==s.index){if(t.targetIndex!==-1){const c=t.targets[t.targetIndex];this.removeTracedCoordinates_(c.startIndex,c.endIndex)}const h=t.targets[s.index];this.addTracedCoordinates_(h,h.startIndex,s.endIndex)}else{const h=t.targets[t.targetIndex];this.addOrRemoveTracedCoordinates_(h,s.endIndex)}t.targetIndex=s.index;const n=t.targets[t.targetIndex];n.endIndex=s.endIndex;const o=interpolateCoordinate(n.coordinates,n.endIndex),a=this.getMap().getPixelFromCoordinate(o);e.coordinate=o,e.pixel=[Math.round(a[0]),Math.round(a[1])]}handleDragEvent(e){this.ignoreNextUpEvent_=!0,super.handleDragEvent(e)}handleUpEvent(e){let t=!0;if(this.getPointerCount()===0){this.downTimeout_&&(clearTimeout(this.downTimeout_),this.downTimeout_=void 0),this.handlePointerMove_(e);const s=this.traceState_.active;if(this.ignoreNextUpEvent_||this.toggleTraceState_(e),this.shouldHandle_){const n=!this.finishCoordinate_;n&&this.startDrawing_(e.coordinate),!n&&this.freehand_?this.finishDrawing():!this.freehand_&&(!n||this.mode_==="Point")&&(this.atFinish_(e.pixel,s)?this.finishCondition_(e)&&this.finishDrawing():this.addToDrawing_(e.coordinate)),t=!1}else this.freehand_&&this.abortDrawing()}return this.ignoreNextUpEvent_=!1,!t&&this.stopClick_&&e.preventDefault(),t}handlePointerMove_(e){if(this.pointerType_=e.originalEvent.pointerType,this.downPx_&&(!this.freehand_&&this.shouldHandle_||this.freehand_&&!this.shouldHandle_)){const t=this.downPx_,s=e.pixel,n=t[0]-s[0],o=t[1]-s[1],a=n*n+o*o;if(this.shouldHandle_=this.freehand_?a>this.squaredClickTolerance_:a<=this.squaredClickTolerance_,!this.shouldHandle_)return}if(!this.finishCoordinate_){this.createOrUpdateSketchPoint_(e.coordinate.slice());return}this.updateTrace_(e),this.modifyDrawing_(e.coordinate)}atFinish_(e,t){let s=!1;if(this.sketchFeature_){let n=!1,o=[this.finishCoordinate_];const a=this.mode_;if(a==="Point")s=!0;else if(a==="Circle")s=this.sketchCoords_.length===2;else if(a==="LineString")n=!t&&this.sketchCoords_.length>this.minPoints_;else if(a==="Polygon"){const h=this.sketchCoords_;n=h[0].length>this.minPoints_,o=[h[0][0],h[0][h[0].length-2]],t?o=[h[0][0]]:o=[h[0][0],h[0][h[0].length-2]]}if(n){const h=this.getMap();for(let c=0,d=o.length;c<d;c++){const u=o[c],_=h.getPixelFromCoordinate(u),f=e[0]-_[0],v=e[1]-_[1],g=this.freehand_?1:this.snapTolerance_;if(s=Math.sqrt(f*f+v*v)<=g,s){this.finishCoordinate_=u;break}}}}return s}createOrUpdateSketchPoint_(e){this.sketchPoint_?this.sketchPoint_.getGeometry().setCoordinates(e):(this.sketchPoint_=new Feature(new Point(e)),this.updateSketchFeatures_())}createOrUpdateCustomSketchLine_(e){this.sketchLine_||(this.sketchLine_=new Feature);const t=e.getLinearRing(0);let s=this.sketchLine_.getGeometry();s?(s.setFlatCoordinates(t.getLayout(),t.getFlatCoordinates()),s.changed()):(s=new LineString(t.getFlatCoordinates(),t.getLayout()),this.sketchLine_.setGeometry(s))}startDrawing_(e){const t=this.getMap().getView().getProjection(),s=getStrideForLayout(this.geometryLayout_);for(;e.length<s;)e.push(0);this.finishCoordinate_=e,this.mode_==="Point"?this.sketchCoords_=e.slice():this.mode_==="Polygon"?(this.sketchCoords_=[[e.slice(),e.slice()]],this.sketchLineCoords_=this.sketchCoords_[0]):this.sketchCoords_=[e.slice(),e.slice()],this.sketchLineCoords_&&(this.sketchLine_=new Feature(new LineString(this.sketchLineCoords_)));const n=this.geometryFunction_(this.sketchCoords_,void 0,t);this.sketchFeature_=new Feature,this.geometryName_&&this.sketchFeature_.setGeometryName(this.geometryName_),this.sketchFeature_.setGeometry(n),this.updateSketchFeatures_(),this.dispatchEvent(new DrawEvent(DrawEventType.DRAWSTART,this.sketchFeature_))}modifyDrawing_(e){const t=this.getMap(),s=this.sketchFeature_.getGeometry(),n=t.getView().getProjection(),o=getStrideForLayout(this.geometryLayout_);let a,h;for(;e.length<o;)e.push(0);this.mode_==="Point"?h=this.sketchCoords_:this.mode_==="Polygon"?(a=this.sketchCoords_[0],h=a[a.length-1],this.atFinish_(t.getPixelFromCoordinate(e))&&(e=this.finishCoordinate_.slice())):(a=this.sketchCoords_,h=a[a.length-1]),h[0]=e[0],h[1]=e[1],this.geometryFunction_(this.sketchCoords_,s,n),this.sketchPoint_&&this.sketchPoint_.getGeometry().setCoordinates(e),s.getType()==="Polygon"&&this.mode_!=="Polygon"?this.createOrUpdateCustomSketchLine_(s):this.sketchLineCoords_&&this.sketchLine_.getGeometry().setCoordinates(this.sketchLineCoords_),this.updateSketchFeatures_()}addToDrawing_(e){const t=this.sketchFeature_.getGeometry(),s=this.getMap().getView().getProjection();let n,o;const a=this.mode_;return a==="LineString"||a==="Circle"?(this.finishCoordinate_=e.slice(),o=this.sketchCoords_,o.length>=this.maxPoints_&&(this.freehand_?o.pop():n=!0),o.push(e.slice()),this.geometryFunction_(o,t,s)):a==="Polygon"&&(o=this.sketchCoords_[0],o.length>=this.maxPoints_&&(this.freehand_?o.pop():n=!0),o.push(e.slice()),n&&(this.finishCoordinate_=o[0]),this.geometryFunction_(this.sketchCoords_,t,s)),this.createOrUpdateSketchPoint_(e.slice()),this.updateSketchFeatures_(),n?this.finishDrawing():this.sketchFeature_}removeLastPoints_(e){if(!this.sketchFeature_)return;const t=this.sketchFeature_.getGeometry(),s=this.getMap().getView().getProjection(),n=this.mode_;for(let o=0;o<e;++o){let a;if(n==="LineString"||n==="Circle"){if(a=this.sketchCoords_,a.splice(-2,1),a.length>=2){this.finishCoordinate_=a[a.length-2].slice();const h=this.finishCoordinate_.slice();a[a.length-1]=h,this.createOrUpdateSketchPoint_(h)}this.geometryFunction_(a,t,s),t.getType()==="Polygon"&&this.sketchLine_&&this.createOrUpdateCustomSketchLine_(t)}else if(n==="Polygon"){a=this.sketchCoords_[0],a.splice(-2,1);const h=this.sketchLine_.getGeometry();if(a.length>=2){const c=a[a.length-2].slice();a[a.length-1]=c,this.createOrUpdateSketchPoint_(c)}h.setCoordinates(a),this.geometryFunction_(this.sketchCoords_,t,s)}if(a.length===1){this.abortDrawing();break}}this.updateSketchFeatures_()}removeLastPoint(){this.removeLastPoints_(1)}finishDrawing(){const e=this.abortDrawing_();if(!e)return null;let t=this.sketchCoords_;const s=e.getGeometry(),n=this.getMap().getView().getProjection();return this.mode_==="LineString"?(t.pop(),this.geometryFunction_(t,s,n)):this.mode_==="Polygon"&&(t[0].pop(),this.geometryFunction_(t,s,n),t=s.getCoordinates()),this.type_==="MultiPoint"?e.setGeometry(new MultiPoint([t])):this.type_==="MultiLineString"?e.setGeometry(new MultiLineString([t])):this.type_==="MultiPolygon"&&e.setGeometry(new MultiPolygon([t])),this.dispatchEvent(new DrawEvent(DrawEventType.DRAWEND,e)),this.features_&&this.features_.push(e),this.source_&&this.source_.addFeature(e),e}abortDrawing_(){this.finishCoordinate_=null;const e=this.sketchFeature_;return this.sketchFeature_=null,this.sketchPoint_=null,this.sketchLine_=null,this.overlay_.getSource().clear(!0),this.deactivateTrace_(),e}abortDrawing(){const e=this.abortDrawing_();e&&this.dispatchEvent(new DrawEvent(DrawEventType.DRAWABORT,e))}appendCoordinates(e){const t=this.mode_,s=!this.sketchFeature_;s&&this.startDrawing_(e[0]);let n;if(t==="LineString"||t==="Circle")n=this.sketchCoords_;else if(t==="Polygon")n=this.sketchCoords_&&this.sketchCoords_.length?this.sketchCoords_[0]:[];else return;s&&n.shift(),n.pop();for(let a=0;a<e.length;a++)this.addToDrawing_(e[a]);const o=e[e.length-1];this.sketchFeature_=this.addToDrawing_(o),this.modifyDrawing_(o)}extend(e){const s=e.getGeometry();this.sketchFeature_=e,this.sketchCoords_=s.getCoordinates();const n=this.sketchCoords_[this.sketchCoords_.length-1];this.finishCoordinate_=n.slice(),this.sketchCoords_.push(n.slice()),this.sketchPoint_=new Feature(new Point(n)),this.updateSketchFeatures_(),this.dispatchEvent(new DrawEvent(DrawEventType.DRAWSTART,this.sketchFeature_))}updateSketchFeatures_(){const e=[];this.sketchFeature_&&e.push(this.sketchFeature_),this.sketchLine_&&e.push(this.sketchLine_),this.sketchPoint_&&e.push(this.sketchPoint_);const t=this.overlay_.getSource();t.clear(!0),t.addFeatures(e)}updateState_(){const e=this.getMap(),t=this.getActive();(!e||!t)&&this.abortDrawing(),this.overlay_.setMap(t?e:null)}}function getDefaultStyleFunction$1(){const l=createEditingStyle();return function(e,t){return l[e.getGeometry().getType()]}}function createBox(){return function(l,e,t){const s=boundingExtent([l[0],l[l.length-1]].map(function(o){return fromUserCoordinate(o)})),n=[[getBottomLeft(s),getBottomRight(s),getTopRight(s),getTopLeft(s),getBottomLeft(s)]];return e?e.setCoordinates(n):e=new Polygon(n),e}}function getMode(l){switch(l){case"Point":case"MultiPoint":return"Point";case"LineString":case"MultiLineString":return"LineString";case"Polygon":case"MultiPolygon":return"Polygon";case"Circle":return"Circle";default:throw new Error("Invalid type: "+l)}}const CIRCLE_CENTER_INDEX=0,CIRCLE_CIRCUMFERENCE_INDEX=1,tempExtent=[0,0,0,0],tempSegment=[],ModifyEventType={MODIFYSTART:"modifystart",MODIFYEND:"modifyend"};function getCoordinatesArray(l,e,t){let s;switch(e){case"LineString":s=l;break;case"MultiLineString":case"Polygon":s=l[t[0]];break;case"MultiPolygon":s=l[t[1]][t[0]];break}return s}class ModifyEvent extends BaseEvent{constructor(e,t,s){super(e),this.features=t,this.mapBrowserEvent=s}}class Modify extends PointerInteraction{constructor(e){if(super(e),this.handleSourceAdd_=this.handleSourceAdd_.bind(this),this.handleSourceRemove_=this.handleSourceRemove_.bind(this),this.handleExternalCollectionAdd_=this.handleExternalCollectionAdd_.bind(this),this.handleExternalCollectionRemove_=this.handleExternalCollectionRemove_.bind(this),this.handleFeatureChange_=this.handleFeatureChange_.bind(this),this.on,this.once,this.un,this.condition_=e.condition?e.condition:primaryAction,this.defaultDeleteCondition_=function(s){return altKeyOnly(s)&&singleClick(s)},this.deleteCondition_=e.deleteCondition?e.deleteCondition:this.defaultDeleteCondition_,this.insertVertexCondition_=e.insertVertexCondition?e.insertVertexCondition:always,this.vertexFeature_=null,this.vertexSegments_=null,this.lastCoordinate_=[0,0],this.ignoreNextSingleClick_=!1,this.featuresBeingModified_=null,this.rBush_=new RBush,this.pixelTolerance_=e.pixelTolerance!==void 0?e.pixelTolerance:10,this.snappedToVertex_=!1,this.changingFeature_=!1,this.dragSegments_=[],this.overlay_=new VectorLayer({source:new VectorSource({useSpatialIndex:!1,wrapX:!!e.wrapX}),style:e.style?e.style:getDefaultStyleFunction(),updateWhileAnimating:!0,updateWhileInteracting:!0}),this.SEGMENT_WRITERS_={Point:this.writePointGeometry_.bind(this),LineString:this.writeLineStringGeometry_.bind(this),LinearRing:this.writeLineStringGeometry_.bind(this),Polygon:this.writePolygonGeometry_.bind(this),MultiPoint:this.writeMultiPointGeometry_.bind(this),MultiLineString:this.writeMultiLineStringGeometry_.bind(this),MultiPolygon:this.writeMultiPolygonGeometry_.bind(this),Circle:this.writeCircleGeometry_.bind(this),GeometryCollection:this.writeGeometryCollectionGeometry_.bind(this)},this.source_=null,this.traceSource_=e.traceSource||e.source||null,this.traceCondition_,this.setTrace(e.trace||!1),this.traceState_={active:!1},this.traceSegments_=null,this.hitDetection_=null,this.filterFunctionWasSupplied_=e.filter!=null,this.filter_=e.filter?e.filter:()=>!0,!(e.features||e.source))throw new Error("The modify interaction requires features collection or a source");let t;e.features?(t=e.features.getArray(),e.features.addEventListener(CollectionEventType.ADD,this.handleExternalCollectionAdd_),e.features.addEventListener(CollectionEventType.REMOVE,this.handleExternalCollectionRemove_),this.featuresCollection_=e.features):e.source&&(t=e.source.getFeatures(),e.source.addEventListener(VectorEventType.ADDFEATURE,this.handleSourceAdd_),e.source.addEventListener(VectorEventType.REMOVEFEATURE,this.handleSourceRemove_),this.source_=e.source),t.forEach(s=>{s.addEventListener(EventType$1.CHANGE,this.handleFeatureChange_),this.filterFunctionWasSupplied_&&s.addEventListener(ObjectEventType.PROPERTYCHANGE,this.handleFeatureChange_)}),e.hitDetection&&(this.hitDetection_=e.hitDetection),this.features_=[],t.filter(this.filter_).forEach(s=>this.addFeature_(s)),this.lastPointerEvent_=null,this.delta_=[0,0],this.snapToPointer_=e.snapToPointer===void 0?!this.hitDetection_:e.snapToPointer}setTrace(e){let t;e?e===!0?t=always:t=e:t=never,this.traceCondition_=t}addFeature_(e){this.features_.push(e);const t=e.getGeometry();if(t){const n=this.SEGMENT_WRITERS_[t.getType()];n&&n(e,t)}const s=this.getMap();s&&s.isRendered()&&this.getActive()&&this.handlePointerAtPixel_(this.lastCoordinate_)}willModifyFeatures_(e,t){if(!this.featuresBeingModified_){this.featuresBeingModified_=new Collection;const s=this.featuresBeingModified_.getArray();for(let n=0,o=t.length;n<o;++n){const a=t[n].feature;a&&!s.includes(a)&&this.featuresBeingModified_.push(a)}this.featuresBeingModified_.getLength()===0?this.featuresBeingModified_=null:this.dispatchEvent(new ModifyEvent(ModifyEventType.MODIFYSTART,this.featuresBeingModified_,e))}}removeFeature_(e){const t=this.features_.indexOf(e);this.features_.splice(t,1),this.removeFeatureSegmentData_(e),this.vertexFeature_&&this.features_.length===0&&(this.overlay_.getSource().removeFeature(this.vertexFeature_),this.vertexFeature_=null)}removeFeatureSegmentData_(e){const t=this.rBush_,s=[];t.forEach(function(n){e===n.feature&&s.push(n)});for(let n=s.length-1;n>=0;--n){const o=s[n];for(let a=this.dragSegments_.length-1;a>=0;--a)this.dragSegments_[a][0]===o&&this.dragSegments_.splice(a,1);t.remove(o)}}setActive(e){this.vertexFeature_&&!e&&(this.overlay_.getSource().removeFeature(this.vertexFeature_),this.vertexFeature_=null),super.setActive(e)}setMap(e){this.overlay_.setMap(e),super.setMap(e)}getOverlay(){return this.overlay_}handleSourceAdd_(e){const t=e.feature;t&&this.externalAddFeatureHandler_(t)}handleSourceRemove_(e){const t=e.feature;t&&this.externalRemoveFeatureHandler_(t)}handleExternalCollectionAdd_(e){const t=e.element;t&&this.externalAddFeatureHandler_(t)}handleExternalCollectionRemove_(e){const t=e.element;t&&this.externalRemoveFeatureHandler_(t)}externalAddFeatureHandler_(e){e.addEventListener(EventType$1.CHANGE,this.handleFeatureChange_),this.filterFunctionWasSupplied_&&e.addEventListener(ObjectEventType.PROPERTYCHANGE,this.handleFeatureChange_),this.filter_(e)&&this.addFeature_(e)}externalRemoveFeatureHandler_(e){e.removeEventListener(EventType$1.CHANGE,this.handleFeatureChange_),this.filterFunctionWasSupplied_&&e.removeEventListener(ObjectEventType.PROPERTYCHANGE,this.handleFeatureChange_),this.removeFeature_(e)}handleFeatureChange_(e){if(!this.changingFeature_){const t=e.target;this.removeFeature_(t),this.filter_(t)&&this.addFeature_(t)}}writePointGeometry_(e,t){const s=t.getCoordinates(),n={feature:e,geometry:t,segment:[s,s]};this.rBush_.insert(t.getExtent(),n)}writeMultiPointGeometry_(e,t){const s=t.getCoordinates();for(let n=0,o=s.length;n<o;++n){const a=s[n],h={feature:e,geometry:t,depth:[n],index:n,segment:[a,a]};this.rBush_.insert(t.getExtent(),h)}}writeLineStringGeometry_(e,t){const s=t.getCoordinates();for(let n=0,o=s.length-1;n<o;++n){const a=s.slice(n,n+2),h={feature:e,geometry:t,index:n,segment:a};this.rBush_.insert(boundingExtent(a),h)}}writeMultiLineStringGeometry_(e,t){const s=t.getCoordinates();for(let n=0,o=s.length;n<o;++n){const a=s[n];for(let h=0,c=a.length-1;h<c;++h){const d=a.slice(h,h+2),u={feature:e,geometry:t,depth:[n],index:h,segment:d};this.rBush_.insert(boundingExtent(d),u)}}}writePolygonGeometry_(e,t){const s=t.getCoordinates();for(let n=0,o=s.length;n<o;++n){const a=s[n];for(let h=0,c=a.length-1;h<c;++h){const d=a.slice(h,h+2),u={feature:e,geometry:t,depth:[n],index:h,segment:d};this.rBush_.insert(boundingExtent(d),u)}}}writeMultiPolygonGeometry_(e,t){const s=t.getCoordinates();for(let n=0,o=s.length;n<o;++n){const a=s[n];for(let h=0,c=a.length;h<c;++h){const d=a[h];for(let u=0,_=d.length-1;u<_;++u){const f=d.slice(u,u+2),v={feature:e,geometry:t,depth:[h,n],index:u,segment:f};this.rBush_.insert(boundingExtent(f),v)}}}}writeCircleGeometry_(e,t){const s=t.getCenter(),n={feature:e,geometry:t,index:CIRCLE_CENTER_INDEX,segment:[s,s]},o={feature:e,geometry:t,index:CIRCLE_CIRCUMFERENCE_INDEX,segment:[s,s]},a=[n,o];n.featureSegments=a,o.featureSegments=a,this.rBush_.insert(createOrUpdateFromCoordinate(s),n);let h=t;this.rBush_.insert(h.getExtent(),o)}writeGeometryCollectionGeometry_(e,t){const s=t.getGeometriesArray();for(let n=0;n<s.length;++n){const o=s[n],a=this.SEGMENT_WRITERS_[o.getType()];a(e,o)}}createOrUpdateVertexFeature_(e,t,s,n){let o=this.vertexFeature_;return o?o.getGeometry().setCoordinates(e):(o=new Feature(new Point(e)),this.vertexFeature_=o,this.overlay_.getSource().addFeature(o)),o.set("features",t),o.set("geometries",s),o.set("existing",n),o}handleEvent(e){if(!e.originalEvent)return!0;this.lastPointerEvent_=e;let t;return!e.map.getView().getInteracting()&&e.type==MapBrowserEventType.POINTERMOVE&&!this.handlingDownUpSequence&&this.handlePointerMove_(e),this.vertexFeature_&&this.deleteCondition_(e)&&(e.type!=MapBrowserEventType.SINGLECLICK||!this.ignoreNextSingleClick_?t=this.removePoint():t=!0),e.type==MapBrowserEventType.SINGLECLICK&&(this.ignoreNextSingleClick_=!1),super.handleEvent(e)&&!t}findInsertVerticesAndUpdateDragSegments_(e){if(this.handlePointerAtPixel_(e),this.dragSegments_.length=0,this.featuresBeingModified_=null,!this.vertexFeature_)return;this.getMap().getView().getProjection();const s=[],n=this.vertexFeature_.getGeometry().getCoordinates(),o=boundingExtent([n]),a=this.rBush_.getInExtent(o),h={};a.sort(compareIndexes);for(let c=0,d=a.length;c<d;++c){const u=a[c],_=u.segment;let f=getUid(u.geometry);const v=u.depth;if(v&&(f+="-"+v.join("-")),h[f]||(h[f]=new Array(2)),u.geometry.getType()==="Circle"&&u.index===CIRCLE_CIRCUMFERENCE_INDEX){const g=closestOnSegmentData(e,u);equals$2(g,n)&&!h[f][0]&&(this.dragSegments_.push([u,0]),h[f][0]=u);continue}if(equals$2(_[0],n)&&!h[f][0]){this.dragSegments_.push([u,0]),h[f][0]=u;continue}if(equals$2(_[1],n)&&!h[f][1]){if(h[f][0]&&h[f][0].index===0){let g=u.geometry.getCoordinates();switch(u.geometry.getType()){case"LineString":case"MultiLineString":continue;case"MultiPolygon":g=g[v[1]];case"Polygon":if(u.index!==g[v[0]].length-2)continue;break}}this.dragSegments_.push([u,1]),h[f][1]=u;continue}getUid(_)in this.vertexSegments_&&!h[f][0]&&!h[f][1]&&s.push(u)}return s}deactivateTrace_(){this.traceState_={active:!1}}updateTrace_(e){const t=this.traceState_;if(!t.active)return;if(t.targetIndex===-1){const o=e.map.getPixelFromCoordinate(t.startCoord);if(distance(o,e.pixel)<this.pixelTolerance_)return}const s=getTraceTargetUpdate(e.coordinate,t,e.map,this.pixelTolerance_);if(t.targetIndex===-1&&Math.sqrt(s.closestTargetDistance)/e.map.getView().getResolution()>this.pixelTolerance_)return;if(t.targetIndex!==s.index){if(t.targetIndex!==-1){const a=t.targets[t.targetIndex];this.removeTracedCoordinates_(a.startIndex,a.endIndex)}else for(const a of this.traceSegments_){const h=a[0],c=h.geometry,d=a[1],u=c.getCoordinates();getCoordinatesArray(u,c.getType(),h.depth).splice(h.index+d,1),c.setCoordinates(u),d===0&&(h.index-=1)}const o=t.targets[s.index];this.addTracedCoordinates_(o,o.startIndex,s.endIndex)}else{const o=t.targets[t.targetIndex];this.addOrRemoveTracedCoordinates_(o,s.endIndex)}t.targetIndex=s.index;const n=t.targets[t.targetIndex];n.endIndex=s.endIndex}getTraceCandidates_(e){const t=this.getMap(),s=this.pixelTolerance_,n=t.getCoordinateFromPixel([e.pixel[0]-s,e.pixel[1]+s]),o=t.getCoordinateFromPixel([e.pixel[0]+s,e.pixel[1]-s]),a=boundingExtent([n,o]);return this.traceSource_.getFeaturesInExtent(a)}toggleTraceState_(e){if(!this.traceSource_||!this.traceCondition_(e))return;if(this.traceState_.active){this.deactivateTrace_(),this.traceSegments_=null;return}const t=this.getTraceCandidates_(e);if(t.length===0)return;const s=getTraceTargets(e.coordinate,t);s.length&&(this.traceState_={active:!0,startCoord:e.coordinate.slice(),targets:s,targetIndex:-1})}addOrRemoveTracedCoordinates_(e,t){const s=e.startIndex<=e.endIndex,n=e.startIndex<=t;s===n?s&&t>e.endIndex||!s&&t<e.endIndex?this.addTracedCoordinates_(e,e.endIndex,t):(s&&t<e.endIndex||!s&&t>e.endIndex)&&this.removeTracedCoordinates_(t,e.endIndex):(this.removeTracedCoordinates_(e.startIndex,e.endIndex),this.addTracedCoordinates_(e,e.startIndex,t))}removeTracedCoordinates_(e,t){if(e===t)return;let s=0;if(e<t){const n=Math.ceil(e);let o=Math.floor(t);o===t&&(o-=1),s=o-n+1}else{const n=Math.floor(e);let o=Math.ceil(t);o===t&&(o+=1),s=n-o+1}if(s>0)for(const n of this.traceSegments_){const o=n[0],a=o.geometry,h=n[1];let c=n[0].index+1;h===1&&(c-=s);const d=a.getCoordinates();getCoordinatesArray(d,a.getType(),o.depth).splice(c,s),a.setCoordinates(d),h===1&&(o.index-=s)}}addTracedCoordinates_(e,t,s){if(t===s)return;const n=[];if(t<s){const o=Math.ceil(t);let a=Math.floor(s);a===s&&(a-=1);for(let h=o;h<=a;++h)n.push(getCoordinate(e.coordinates,h))}else{const o=Math.floor(t);let a=Math.ceil(s);a===s&&(a+=1);for(let h=o;h>=a;--h)n.push(getCoordinate(e.coordinates,h))}if(n.length)for(const o of this.traceSegments_){const a=o[0],h=a.geometry,c=o[1],d=a.index+1;c===0&&n.reverse();const u=h.getCoordinates();getCoordinatesArray(u,h.getType(),a.depth).splice(d,0,...n),h.setCoordinates(u),c===1&&(a.index+=n.length)}}updateGeometry_(e,t){const s=t[0],n=s.depth;let o;const a=s.segment,h=s.geometry,c=t[1];for(;e.length<h.getStride();)e.push(a[c][e.length]);switch(h.getType()){case"Point":o=e,a[0]=e,a[1]=e;break;case"MultiPoint":o=h.getCoordinates(),o[s.index]=e,a[0]=e,a[1]=e;break;case"LineString":o=h.getCoordinates(),o[s.index+c]=e,a[c]=e;break;case"MultiLineString":o=h.getCoordinates(),o[n[0]][s.index+c]=e,a[c]=e;break;case"Polygon":o=h.getCoordinates(),o[n[0]][s.index+c]=e,a[c]=e;break;case"MultiPolygon":o=h.getCoordinates(),o[n[1]][n[0]][s.index+c]=e,a[c]=e;break;case"Circle":const d=h;if(a[0]=e,a[1]=e,s.index===CIRCLE_CENTER_INDEX)this.changingFeature_=!0,d.setCenter(e),this.changingFeature_=!1;else{this.changingFeature_=!0,this.getMap().getView().getProjection();let u=distance(fromUserCoordinate(d.getCenter()),fromUserCoordinate(e));d.setRadius(u),this.changingFeature_=!1}break}o&&this.setGeometryCoordinates_(h,o)}handleDragEvent(e){this.ignoreNextSingleClick_=!1,this.willModifyFeatures_(e,this.dragSegments_.map(([a])=>a));const t=[e.coordinate[0]+this.delta_[0],e.coordinate[1]+this.delta_[1]],s=[],n=[],o=this.traceState_.active&&!this.traceSegments_?this.traceState_.startCoord:null;if(o){this.traceSegments_=[];for(const a of this.dragSegments_){const h=a[0];distance(closestOnSegment(o,h.segment),o)/e.map.getView().getResolution()<1&&this.traceSegments_.push(a)}}for(let a=0,h=this.dragSegments_.length;a<h;++a){const c=this.dragSegments_[a],d=c[0],u=d.feature;s.includes(u)||s.push(u);const _=d.geometry;n.includes(_)||n.push(_),this.updateGeometry_(t,c)}this.updateTrace_(e),this.createOrUpdateVertexFeature_(t,s,n,!0)}handleDownEvent(e){if(!this.condition_(e))return!1;const t=e.coordinate,s=this.findInsertVerticesAndUpdateDragSegments_(t);if(s!=null&&s.length&&this.insertVertexCondition_(e)&&(this.willModifyFeatures_(e,s),this.vertexFeature_)){const n=this.vertexFeature_.getGeometry().getCoordinates();for(let o=s.length-1;o>=0;--o)this.insertVertex_(s[o],n);this.ignoreNextSingleClick_=!0}return!!this.vertexFeature_}handleUpEvent(e){for(let t=this.dragSegments_.length-1;t>=0;--t){const s=this.dragSegments_[t][0],n=s.geometry;if(n.getType()==="Circle"){const o=n,a=o.getCenter(),h=s.featureSegments[0],c=s.featureSegments[1];h.segment[0]=a,h.segment[1]=a,c.segment[0]=a,c.segment[1]=a,this.rBush_.update(createOrUpdateFromCoordinate(a),h);let d=o;this.rBush_.update(d.getExtent(),c)}else this.rBush_.update(boundingExtent(s.segment),s)}return this.featuresBeingModified_&&(this.toggleTraceState_(e),this.dispatchEvent(new ModifyEvent(ModifyEventType.MODIFYEND,this.featuresBeingModified_,e)),this.featuresBeingModified_=null),!1}handlePointerMove_(e){this.lastCoordinate_=e.coordinate,this.handlePointerAtPixel_(this.lastCoordinate_)}handlePointerAtPixel_(e){const t=this.getMap(),s=t.getPixelFromCoordinate(e);t.getView().getProjection();const n=function(h,c){return projectedDistanceToSegmentDataSquared(e,h)-projectedDistanceToSegmentDataSquared(e,c)};let o,a;if(this.hitDetection_){const h=typeof this.hitDetection_=="object"?c=>c===this.hitDetection_:void 0;t.forEachFeatureAtPixel(s,(c,d,u)=>{u&&u.getType()==="Point"&&(u=new Point(toUserCoordinate(u.getCoordinates())));const _=u||c.getGeometry();if(_&&_.getType()==="Point"&&c instanceof Feature&&this.features_.includes(c)){a=_;const f=c.getGeometry().getFlatCoordinates().slice(0,2);o=[{feature:c,geometry:a,segment:[f,f]}]}return!0},{layerFilter:h})}if(!o){const h=fromUserExtent(createOrUpdateFromCoordinate(e,tempExtent)),c=t.getView().getResolution()*this.pixelTolerance_,d=toUserExtent(buffer(h,c,tempExtent));o=this.rBush_.getInExtent(d)}if(o&&o.length>0){const h=o.sort(n)[0],c=h.segment;let d=closestOnSegmentData(e,h);const u=t.getPixelFromCoordinate(d);let _=distance(s,u);if(a||_<=this.pixelTolerance_){const f={};if(f[getUid(c)]=!0,this.snapToPointer_||(this.delta_[0]=d[0]-e[0],this.delta_[1]=d[1]-e[1]),h.geometry.getType()==="Circle"&&h.index===CIRCLE_CIRCUMFERENCE_INDEX)this.snappedToVertex_=!0,this.createOrUpdateVertexFeature_(d,[h.feature],[h.geometry],this.snappedToVertex_);else{const v=t.getPixelFromCoordinate(c[0]),g=t.getPixelFromCoordinate(c[1]),y=squaredDistance$1(u,v),p=squaredDistance$1(u,g);if(_=Math.sqrt(Math.min(y,p)),this.snappedToVertex_=_<=this.pixelTolerance_,!this.snappedToVertex_&&!this.insertVertexCondition_(this.lastPointerEvent_)){this.vertexFeature_&&(this.overlay_.getSource().removeFeature(this.vertexFeature_),this.vertexFeature_=null);return}this.snappedToVertex_&&(d=y>p?c[1]:c[0]),this.createOrUpdateVertexFeature_(d,[h.feature],[h.geometry],this.snappedToVertex_);const x={};x[getUid(h.geometry)]=!0;for(let T=1,w=o.length;T<w;++T){const C=o[T].segment;if(equals$2(c[0],C[0])&&equals$2(c[1],C[1])||equals$2(c[0],C[1])&&equals$2(c[1],C[0])){const E=getUid(o[T].geometry);E in x||(x[E]=!0,f[getUid(C)]=!0)}else break}}this.vertexSegments_=f;return}}this.vertexFeature_&&(this.overlay_.getSource().removeFeature(this.vertexFeature_),this.vertexFeature_=null)}insertVertex_(e,t){const s=e.segment,n=e.feature,o=e.geometry,a=e.depth,h=e.index;let c;for(;t.length<o.getStride();)t.push(0);switch(o.getType()){case"MultiLineString":c=o.getCoordinates(),c[a[0]].splice(h+1,0,t);break;case"Polygon":c=o.getCoordinates(),c[a[0]].splice(h+1,0,t);break;case"MultiPolygon":c=o.getCoordinates(),c[a[1]][a[0]].splice(h+1,0,t);break;case"LineString":c=o.getCoordinates(),c.splice(h+1,0,t);break;default:return!1}this.setGeometryCoordinates_(o,c);const d=this.rBush_;d.remove(e),this.updateSegmentIndices_(o,h,a,1);const u={segment:[s[0],t],feature:n,geometry:o,depth:a,index:h};d.insert(boundingExtent(u.segment),u),this.dragSegments_.push([u,1]);const _={segment:[t,s[1]],feature:n,geometry:o,depth:a,index:h+1};return d.insert(boundingExtent(_.segment),_),this.dragSegments_.push([_,0]),!0}updatePointer_(e){var t;return e&&this.findInsertVerticesAndUpdateDragSegments_(e),(t=this.vertexFeature_)==null?void 0:t.getGeometry().getCoordinates()}getPoint(){var t;const e=(t=this.vertexFeature_)==null?void 0:t.getGeometry().getCoordinates();return e?toUserCoordinate(e,this.getMap().getView().getProjection()):null}canRemovePoint(){if(!this.vertexFeature_||this.vertexFeature_.get("geometries").every(s=>s.getType()==="Circle"||s.getType().endsWith("Point")))return!1;const e=this.vertexFeature_.getGeometry().getCoordinates();return this.rBush_.getInExtent(boundingExtent([e])).some(({segment:s})=>equals$2(s[0],e)||equals$2(s[1],e))}removePoint(e){if(e&&(e=fromUserCoordinate(e,this.getMap().getView().getProjection()),this.updatePointer_(e)),!this.lastPointerEvent_||this.lastPointerEvent_&&this.lastPointerEvent_.type!=MapBrowserEventType.POINTERDRAG){const t=this.lastPointerEvent_;this.willModifyFeatures_(t,this.dragSegments_.map(([n])=>n));const s=this.removeVertex_();return this.featuresBeingModified_&&this.dispatchEvent(new ModifyEvent(ModifyEventType.MODIFYEND,this.featuresBeingModified_,t)),this.featuresBeingModified_=null,s}return!1}removeVertex_(){const e=this.dragSegments_,t={};let s=!1,n,o,a,h,c,d,u,_,f,v,g;for(c=e.length-1;c>=0;--c)a=e[c],v=a[0],g=getUid(v.feature),v.depth&&(g+="-"+v.depth.join("-")),g in t||(t[g]={}),a[1]===0?(t[g].right=v,t[g].index=v.index):a[1]==1&&(t[g].left=v,t[g].index=v.index+1);for(g in t){switch(f=t[g].right,u=t[g].left,d=t[g].index,_=d-1,u!==void 0?v=u:v=f,_<0&&(_=0),h=v.geometry,o=h.getCoordinates(),n=o,s=!1,h.getType()){case"MultiLineString":o[v.depth[0]].length>2&&(o[v.depth[0]].splice(d,1),s=!0);break;case"LineString":o.length>2&&(o.splice(d,1),s=!0);break;case"MultiPolygon":n=n[v.depth[1]];case"Polygon":n=n[v.depth[0]],n.length>4&&(d==n.length-1&&(d=0),n.splice(d,1),s=!0,d===0&&(n.pop(),n.push(n[0]),_=n.length-1));break}if(s){this.setGeometryCoordinates_(h,o);const y=[];if(u!==void 0&&(this.rBush_.remove(u),y.push(u.segment[0])),f!==void 0&&(this.rBush_.remove(f),y.push(f.segment[1])),u!==void 0&&f!==void 0){const p={depth:v.depth,feature:v.feature,geometry:v.geometry,index:_,segment:y};this.rBush_.insert(boundingExtent(p.segment),p)}this.updateSegmentIndices_(h,d,v.depth,-1),this.vertexFeature_&&(this.overlay_.getSource().removeFeature(this.vertexFeature_),this.vertexFeature_=null),e.length=0}}return s}canInsertPoint(){if(!this.vertexFeature_||this.vertexFeature_.get("geometries").every(s=>s.getType()==="Circle"||s.getType().endsWith("Point")))return!1;const e=this.vertexFeature_.getGeometry().getCoordinates();return this.rBush_.getInExtent(boundingExtent([e])).some(({segment:s})=>!(equals$2(s[0],e)||equals$2(s[1],e)))}insertPoint(e){var n;const t=e?fromUserCoordinate(e,this.getMap().getView().getProjection()):(n=this.vertexFeature_)==null?void 0:n.getGeometry().getCoordinates();return t?this.findInsertVerticesAndUpdateDragSegments_(t).reduce((o,a)=>o||this.insertVertex_(a,t),!1):!1}setGeometryCoordinates_(e,t){this.changingFeature_=!0,e.setCoordinates(t),this.changingFeature_=!1}updateSegmentIndices_(e,t,s,n){this.rBush_.forEachInExtent(e.getExtent(),function(o){o.geometry===e&&(s===void 0||o.depth===void 0||equals(o.depth,s))&&o.index>t&&(o.index+=n)})}disposeInternal(){if(super.disposeInternal(),this.featuresCollection_){this.featuresCollection_.removeEventListener(CollectionEventType.ADD,this.handleExternalCollectionAdd_),this.featuresCollection_.removeEventListener(CollectionEventType.REMOVE,this.handleExternalCollectionRemove_);for(const e of this.featuresCollection_.getArray())e.removeEventListener(EventType$1.CHANGE,this.handleFeatureChange_),this.filterFunctionWasSupplied_&&e.removeEventListener(ObjectEventType.PROPERTYCHANGE,this.handleFeatureChange_)}else if(this.source_){this.source_.removeEventListener(VectorEventType.ADDFEATURE,this.handleSourceAdd_),this.source_.removeEventListener(VectorEventType.REMOVEFEATURE,this.handleSourceRemove_);for(const e of this.source_.getFeatures())e.removeEventListener(EventType$1.CHANGE,this.handleFeatureChange_),this.filterFunctionWasSupplied_&&e.removeEventListener(ObjectEventType.PROPERTYCHANGE,this.handleFeatureChange_)}}}function compareIndexes(l,e){return l.index-e.index}function projectedDistanceToSegmentDataSquared(l,e,t){const s=e.geometry;if(s.getType()==="Circle"){let o=s;if(e.index===CIRCLE_CIRCUMFERENCE_INDEX){const a=squaredDistance$1(o.getCenter(),fromUserCoordinate(l)),h=Math.sqrt(a)-o.getRadius();return h*h}}const n=fromUserCoordinate(l);return tempSegment[0]=fromUserCoordinate(e.segment[0]),tempSegment[1]=fromUserCoordinate(e.segment[1]),squaredDistanceToSegment(n,tempSegment)}function closestOnSegmentData(l,e,t){const s=e.geometry;if(s.getType()==="Circle"&&e.index===CIRCLE_CIRCUMFERENCE_INDEX)return toUserCoordinate(s.getClosestPoint(fromUserCoordinate(l)));const n=fromUserCoordinate(l);return tempSegment[0]=fromUserCoordinate(e.segment[0]),tempSegment[1]=fromUserCoordinate(e.segment[1]),toUserCoordinate(closestOnSegment(n,tempSegment))}function getDefaultStyleFunction(){const l=createEditingStyle();return function(e,t){return l.Point}}const controlCss='.geolocation{top:85px;left:.5em}.geolocation button{background:var(--primary);color:var(--on-primary)}.geolocation button>svg{fill:var(--on-primary);min-inline-size:1.25rem!important;max-inline-size:1.25rem!important;min-block-size:1.25rem!important;max-block-size:1.25rem!important}.ol-touch.geolocation{top:100px}.loading-indicator{position:absolute;pointer-events:none!important;display:flex;align-items:center;justify-content:center;background-color:#0000}.loading-indicator.small{bottom:.5em;left:.5em;width:30px;height:30px}.loading-indicator.fullscreen{width:100%;height:100%}.disabled{filter:brightness(1.7);pointer-events:none}.ol-unselectable{pointer-events:none}.ol-control{background:none}.ol-control button,.ol-control button:hover,.ol-control button:focus{--_round: 32px;border-radius:var(--_round);background:var(--primary);color:var(--on-primary);width:32px;height:32px;cursor:pointer;border:none;outline:none;pointer-events:all;position:relative;font-size:1rem}.ol-control button:hover:after{background-size:15000%;opacity:.1;transition:background-size var(--speed2) linear;content:"";position:absolute;top:0;right:0;bottom:0;left:0;z-index:1;border-radius:inherit;inline-size:100%;block-size:100%;background-position:center;background-image:radial-gradient(circle,currentColor 1%,transparent 1%)}.ol-control button.ol-zoom-in,.ol-control button.ol-zoom-in:hover{border-top-left-radius:var(--_round);border-top-right-radius:var(--_round);border-bottom-left-radius:.5rem;border-bottom-right-radius:.5rem;margin-bottom:.125rem}.ol-control button.ol-zoom-out,.ol-control button.ol-zoom-out:hover{border-top-left-radius:.5rem;border-top-right-radius:.5rem;border-bottom-left-radius:var(--_round);border-bottom-right-radius:var(--_round)}';var gc,Lc;class EOxMapCompare extends i{constructor(){super();tt(this,gc);this.value=50,this.enabled="true"}static get properties(){return{value:{attribute:"value",type:Number},enabled:{attribute:"enabled",type:String}}}render(){return b`
      <style>
        :host {
          display: block;
          --thumb-size: 3rem;
        }
        .eox-map-compare {
          --thumb-bgc: #fff;
          --thumb-w: var(--thumb-size);

          position: relative;
          height: 100%;
        }
        .eox-map-compare::after {
          content: "";
          display: block;
        }
        .eox-map-compare__first,
        .eox-map-compare__second {
          height: 100%;
          object-fit: cover;
          position: absolute;
          top: 0;
          width: 100%;
        }
        .eox-map-compare__first {
          clip-path: polygon(
            0% 0%,
            ${this.value}% 0%,
            ${this.value}% 100%,
            0% 100%
          );
        }
        .eox-map-compare__second {
          clip-path: polygon(
            100% 0%,
            ${this.value}% 0%,
            ${this.value}% 100%,
            100% 100%
          );
        }
        .eox-map-compare__range {
          background-color: transparent;
          box-sizing: border-box;
          font-family: inherit;
          height: 100%;
          margin: 0;
          outline: none;
          position: absolute;
          top: 0;
          width: 100%;
          pointer-events: none;
        }
        .eox-map-compare__range::-moz-range-thumb {
          cursor: ew-resize;
          height: 100%;
          width: var(--thumb-w);
          pointer-events: all;
          background: transparent;
          border: none;
        }
        .eox-map-compare__range::-webkit-slider-thumb {
          cursor: ew-resize;
          height: 100%;
          width: var(--thumb-w);
          pointer-events: all;
          position: relative;
          background: transparent;
          border: none;
        }
        .eox-map-compare__range::-moz-range-track {
          background: transparent;
          background-size: 100%;
          box-sizing: border-box;
        }
        .eox-map-compare__range::-webkit-slider-runnable-track {
          background: transparent;
          background-size: 100%;
          box-sizing: border-box;
          height: 100%;
        }
        .eox-map-compare__range,
        .eox-map-compare__range::-webkit-slider-runnable-track,
        .eox-map-compare__range::-webkit-slider-thumb {
          -webkit-appearance: none;
          appearance: none;
        }
        .slider-bar,
        .slider-thumb {
          position: absolute;
          box-shadow: 0 0.125rem 0.125rem 0 rgb(0 0 0 / 0.32);
        }
        .slider-bar {
          pointer-events: none;
          top: 0;
          width: 0.3rem;
          height: 100%;
          background-color: var(--thumb-bgc);
          z-index: 2;
          left: calc(${this.value}% - 0.15rem);
          -webkit-clip-path: inset(0 -5px 0 -5px);
          clip-path: inset(0 -5px 0 -5px);
        }
        .slider-thumb {
          pointer-events: none;
          top: calc(50% - var(--thumb-size) / 2);
          background: var(--primary);
          z-index: 3;
          width: var(--thumb-size);
          aspect-ratio: 1;
          left: calc(${this.value}% - var(--thumb-size) / 2);
          border-radius: 50%;
          padding: 0.7rem;
          color: var(--on-primary);
          display: flex;
          align-items: center;
          justify-content: center;
          box-sizing: border-box;
        }
        .slider-thumb svg {
          fill: currentColor;
        }
      </style>
      ${r(this.enabled,[["first",()=>b`<slot name="first"></slot>`],["second",()=>b`<slot name="second"></slot>`]],()=>b`
          <div class="eox-map-compare">
            <div class="eox-map-compare__first">
              <slot name="first"></slot>
            </div>
            <div class="eox-map-compare__second">
              <slot name="second"></slot>
            </div>
            <input
              type="range"
              class="eox-map-compare__range"
              min="0"
              max="100"
              value=${this.value}
              @input=${Rt(this,gc,Lc)}
            />
            <div class="slider-bar"></div>
            <div class="slider-thumb">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <title>arrow-left-right</title>
                <path
                  d="M6.45,17.45L1,12L6.45,6.55L7.86,7.96L4.83,11H19.17L16.14,7.96L17.55,6.55L23,12L17.55,17.45L16.14,16.04L19.17,13H4.83L7.86,16.04L6.45,17.45Z"
                />
              </svg>
            </div>
          </div>
        `)}
    `}}gc=new WeakSet,Lc=function(t){this.value=parseInt(t.target.value)};customElements.define("eox-map-compare",EOxMapCompare);function addNewFeature(l,e,t,s=!1,n=!1,o=!0){const a=s?[l.feature]:l.features;n&&e.getSource().clear();const h=e.getSource().getFeatures();if(!e.get("multipleFeatures")&&(h.length||a.length>1))return console.error("Multiple features detected!");a.forEach(u=>{const _=u.getGeometry();if(_ instanceof LineString){const v=getLength(_,{radius:6378137,projection:t.projection});u.set("measure",v)}else if(_ instanceof Polygon){const v=getArea(_,{radius:6378137,projection:t.projection});u.set("measure",v)}const f=getUid(u);u.set("id",f),u.setId(f)}),!s&&a.length&&(e.getSource().addFeatures(a),t.map.getView().fit(e.getSource().getExtent(),{duration:o?750:0}));const c=new GeoJSON,d=JSON.parse(c.writeFeatures(a,READ_FEATURES_OPTIONS));(s||n)&&dispatchEvt(t,"drawend",l,d),dispatchEvt(t,"addfeatures",l,d)}function dispatchEvt(l,e,t,s){const n=new CustomEvent(e,{detail:{originalEvent:t,geoJSON:s}});l.dispatchEvent(n)}function cancelAnimation(l){l.setRotation(l.getRotation())}function getProj(l,e){const o=l.readFeatures(e)[0].getGeometry().getCoordinates();if(o&&o.length>0){const a=findFirstCoordinateValue(o);if(typeof a=="number")return a>=-180&&a<=180?"EPSG:4326":"EPSG:3857"}}function findFirstCoordinateValue(l){if(typeof l=="number")return l;if(Array.isArray(l)&&l.length>0)return findFirstCoordinateValue(l[0])}function parseTextToFeature(l,e,t,s=!1,n=!0){try{const o=getFormatReader(l);if(!o){console.error("Unsupported format or invalid data");return}const a=getProj(o,l),h=o.readFeatures(l,{dataProjection:a||READ_FEATURES_OPTIONS.dataProjection,featureProjection:t.projection});addNewFeature({features:h},e,t,!1,s,n)}catch(o){console.error("Error parsing data:",o)}}function getFormatReader(l){return isGeoJSON(l)?new GeoJSON:isKML(l)?new KML({extractStyles:!1}):isTopoJSON(l)?new TopoJSON:null}function isGeoJSON(l){try{const e=JSON.parse(l);return e.type==="FeatureCollection"||e.type==="Feature"}catch{return!1}}function isKML(l){return l.includes("<kml")&&l.includes("</kml>")}function isTopoJSON(l){try{const e=JSON.parse(l);return e.type==="Topology"&&e.objects}catch{return!1}}function registerProjection(l,e,t=void 0){proj4.defs(l,e),register(proj4),typeof t<"u"&&get(l).setExtent(t)}async function registerProjectionFromCode(l){return register(proj4),await fromEPSGCode(l)}function parseFeature(l){return new GeoJSON().writeFeaturesObject(l)}function transform(l,e,t=void 0){return t||(t="EPSG:4326"),transform$1(l,e,t)}function transformExtent(l,e,t=void 0){return t||(t="EPSG:4326"),transformExtent$1(l,e,t)}function addScrollInteractions(l,e=!1){e?(l.addInteraction(new MouseWheelZoom({condition:platformModifierKeyOnly})),"ontouchstart"in window||navigator.maxTouchPoints>0?l.addInteraction(new DragPan({condition:function(s){return this.getPointerCount()===2||platformModifierKeyOnly(s)}})):l.addInteraction(new DragPan)):(l.addInteraction(new MouseWheelZoom),l.addInteraction(new DragPan))}function removeDefaultScrollInteractions(l){l.getInteractions().getArray().forEach(e=>{(e instanceof MouseWheelZoom||e instanceof DragPan)&&l.removeInteraction(e)})}function coordinatesRoughlyEquals(l,e,t=.001){let s=!0;for(let n=l.length-1;n>=0;--n)if(!numbersRoughlyEquals(l[n],e[n],t)){s=!1;break}return s}function numbersRoughlyEquals(l,e,t=.001){return Math.abs(l-e)<t}function getCenterFromProperty(l){if(l){const e=l;return!equals$2(e,[0,0])&&e[0]>=-180&&e[0]<=180&&e[1]>=-90&&e[1]<=90?fromLonLat(e):e}return[0,0]}function addDraw(l,e,t){const s=Object.assign({},t);if(l.interactions[s.id])throw Error(`Interaction with id: ${s.id} already exists.`);s.modify=typeof s.modify=="boolean"?s.modify:!0;const n=e.getSource();s.type==="Box"&&(s.geometryFunction=createBox(),s.type="Circle");const o=new Draw({...s,source:n});s.active===!1&&o.setActive(!1),o.on("drawend",c=>{e.get("isDrawingEnabled")&&addNewFeature(c,e,l,!0)}),l.map.addInteraction(o),l.interactions[s.id]=o;const a=new Modify({source:n});a.setActive(s.modify),l.map.addInteraction(a),l.interactions[`${s.id}_modify`]=a;const h=()=>{l.getLayerById(e.get("id"))||(l.removeInteraction(s.id),l.removeInteraction(`${s.id}_modify`),l.map.getLayerGroup().un("change",h))};l.map.getLayerGroup().on("change",h)}class EOxMapTooltip extends i{static get properties(){return{feature:{attribute:!1,property:!0,type:Object},propertyTransform:{attribute:!1,property:!0,type:Function}}}constructor(){super(),this.feature=null,this.propertyTransform=(e,t)=>e}render(){return this.feature?b` <style>
            ul {
              margin: 0;
              padding: 1rem 1rem 1rem 2rem;
              border-radius: 0.5rem;
              max-width: 250px;
              font-size: small;
              background-color: var(--inverse-surface);
              color: var(--inverse-on-surface);
              box-shadow: 0 0.25rem 0.5rem 0 rgb(0 0 0 / 0.4);
              line-height: normal;
              white-space: normal;
            }
            span {
              font-weight: bold;
            }
          </style>
          <ul>
            ${Object.entries(this.feature.getProperties()).map(([e,t])=>this.propertyTransform({key:e,value:t},this.feature)).filter(e=>e).map(({key:e,value:t})=>b`<li><span>${e}</span>: ${t}</li>`)}
          </ul>`:A$1}}customElements.get("eox-map-tooltip")||customElements.define("eox-map-tooltip",EOxMapTooltip);class MVT extends FeatureFormat{constructor(e){super(),e=e||{},this.dataProjection=new Projection({code:"",units:"tile-pixels"}),this.featureClass=e.featureClass?e.featureClass:RenderFeature,this.geometryName_=e.geometryName,this.layerName_=e.layerName?e.layerName:"layer",this.layers_=e.layers?e.layers:null,this.idProperty_=e.idProperty,this.supportedMediaTypes=["application/vnd.mapbox-vector-tile","application/x-protobuf"]}readRawGeometry_(e,t,s,n){e.pos=t.geometry;const o=e.readVarint()+e.pos;let a=1,h=0,c=0,d=0,u=0,_=0;for(;e.pos<o;){if(!h){const f=e.readVarint();a=f&7,h=f>>3}if(h--,a===1||a===2)c+=e.readSVarint(),d+=e.readSVarint(),a===1&&u>_&&(n.push(u),_=u),s.push(c,d),u+=2;else if(a===7)u>_&&(s.push(s[_],s[_+1]),u+=2);else throw new Error("Invalid command found in the PBF")}u>_&&(n.push(u),_=u)}createFeature_(e,t,s){const n=t.type;if(n===0)return null;let o;const a=t.properties;let h;this.idProperty_?(h=a[this.idProperty_],delete a[this.idProperty_]):h=t.id,a[this.layerName_]=t.layer.name;const c=[],d=[];this.readRawGeometry_(e,t,c,d);const u=getGeometryType(n,d.length);if(this.featureClass===RenderFeature)o=new this.featureClass(u,c,d,2,a,h),o.transform(s.dataProjection);else{let _;if(u=="Polygon"){const g=inflateEnds(c,d);_=g.length>1?new MultiPolygon(c,"XY",g):new Polygon(c,"XY",d)}else _=u==="Point"?new Point(c,"XY"):u==="LineString"?new LineString(c,"XY"):u==="MultiPoint"?new MultiPoint(c,"XY"):u==="MultiLineString"?new MultiLineString(c,"XY",d):null;const f=this.featureClass;o=new f,this.geometryName_&&o.setGeometryName(this.geometryName_);const v=transformGeometryWithOptions(_,!1,s);o.setGeometry(v),h!==void 0&&o.setId(h),o.setProperties(a,!0)}return o}getType(){return"arraybuffer"}readFeatures(e,t){const s=this.layers_;t=this.adaptOptions(t);const n=get(t.dataProjection);n.setWorldExtent(t.extent),t.dataProjection=n;const o=new Pbf(e),a=o.readFields(layersPBFReader,{}),h=[];for(const c in a){if(s&&!s.includes(c))continue;const d=a[c],u=d?[0,0,d.extent,d.extent]:null;n.setExtent(u);for(let _=0,f=d.length;_<f;++_){const v=readRawFeature(o,d,_),g=this.createFeature_(o,v,t);g!==null&&h.push(g)}}return h}readProjection(e){return this.dataProjection}setLayers(e){this.layers_=e}}function layersPBFReader(l,e,t){if(l===3){const s={keys:[],values:[],features:[]},n=t.readVarint()+t.pos;t.readFields(layerPBFReader,s,n),s.length=s.features.length,s.length&&(e[s.name]=s)}}function layerPBFReader(l,e,t){if(l===15)e.version=t.readVarint();else if(l===1)e.name=t.readString();else if(l===5)e.extent=t.readVarint();else if(l===2)e.features.push(t.pos);else if(l===3)e.keys.push(t.readString());else if(l===4){let s=null;const n=t.readVarint()+t.pos;for(;t.pos<n;)l=t.readVarint()>>3,s=l===1?t.readString():l===2?t.readFloat():l===3?t.readDouble():l===4?t.readVarint64():l===5?t.readVarint():l===6?t.readSVarint():l===7?t.readBoolean():null;e.values.push(s)}}function featurePBFReader(l,e,t){if(l==1)e.id=t.readVarint();else if(l==2){const s=t.readVarint()+t.pos;for(;t.pos<s;){const n=e.layer.keys[t.readVarint()],o=e.layer.values[t.readVarint()];e.properties[n]=o}}else l==3?e.type=t.readVarint():l==4&&(e.geometry=t.pos)}function readRawFeature(l,e,t){l.pos=e.features[t];const s=l.readVarint()+l.pos,n={layer:e,type:0,properties:{}};return l.readFields(featurePBFReader,n,s),n}function getGeometryType(l,e){let t;return l===1?t=e===1?"Point":"MultiPoint":l===2?t=e===1?"LineString":"MultiLineString":l===3&&(t="Polygon"),t}const IMAGE_REPLAYS={image:["Polygon","Circle","LineString","Image","Text"],hybrid:["Polygon","LineString"],vector:[]},VECTOR_REPLAYS={hybrid:["Image","Text","Default"],vector:["Polygon","Circle","LineString","Image","Text","Default"]};class CanvasVectorTileLayerRenderer extends CanvasTileLayerRenderer{constructor(e,t){super(e,t),this.boundHandleStyleImageChange_=this.handleStyleImageChange_.bind(this),this.renderedLayerRevision_,this.renderedPixelToCoordinateTransform_=null,this.renderedRotation_,this.renderedOpacity_=1,this.tmpTransform_=create(),this.tileClipContexts_=null}enqueueTilesForNextExtent(){return this.getLayer().getRenderMode()!=="vector"}drawTile(e,t,s,n,o,a,h,c){this.updateExecutorGroup_(e,t.pixelRatio,t.viewState.projection),this.tileImageNeedsRender_(e)&&this.renderTileImage_(e,t),super.drawTile(e,t,s,n,o,a,h,c)}getTile(e,t,s,n){const o=this.getOrCreateTile(e,t,s,n);if(!o)return null;const a=n.viewState,h=a.resolution,c=n.viewHints,d=this.getLayer().getSource(),u=d.getTileGridForProjection(a.projection),_=!(c[ViewHint.ANIMATING]||c[ViewHint.INTERACTING]),f=u.getZForResolution(h,d.zDirection)===e;return _&&f?o.wantedResolution=h:o.wantedResolution||(o.wantedResolution=u.getResolution(e)),o}prepareFrame(e){const t=this.getLayer().getRevision();return this.renderedLayerRevision_!==t&&(this.renderedLayerRevision_=t,this.renderedTiles.length=0),super.prepareFrame(e)}updateExecutorGroup_(e,t,s){const n=this.getLayer(),o=n.getRevision(),a=n.getRenderOrder()||null,h=e.wantedResolution,c=e.getReplayState(n);if(!c.dirty&&c.renderedResolution===h&&c.renderedRevision==o&&c.renderedPixelRatio===t&&c.renderedRenderOrder==a)return;const d=n.getSource(),u=!!n.getDeclutter(),_=d.getTileGrid(),v=d.getTileGridForProjection(s).getTileCoordExtent(e.wrappedTileCoord),g=d.getSourceTiles(t,s,e),y=getUid(n);delete e.hitDetectionImageData[y],e.executorGroups[y]=[],c.dirty=!1;for(let p=0,x=g.length;p<x;++p){const T=g[p];if(T.getState()!=TileState.LOADED)continue;const w=d.getProjection(),C=T.tileCoord;let E=_.getTileCoordExtent(C);s&&w&&!equivalent(s,w)&&(E=transformExtent$1(E,w,s,32));const L=getIntersection(v,E),S=buffer(L,n.getRenderBuffer()*h,this.tempExtent),P=equals$1(E,L)?null:S,R=new BuilderGroup(0,L,h,t),M=getSquaredTolerance(h,t),B=function(G,k){let F;const Ce=G.getStyleFunction()||n.getStyleFunction();if(Ce&&(F=Ce(G,h)),F){const Mt=this.renderFeature(G,M,F,R,u,k);c.dirty=c.dirty||Mt}},z=T.getFeatures();a&&a!==c.renderedRenderOrder&&z.sort(a);for(let G=0,k=z.length;G<k;++G){let F=z[G];s&&T.projection&&!equivalent(s,T.projection)&&(F=F.clone(),F.getGeometry().applyTransform(getTransform(T.projection,s))),(!P||intersects(P,F.getGeometry().getExtent()))&&B.call(this,F,G)}const ue=R.finish(),I=n.getRenderMode()!=="vector"&&u&&g.length===1?null:L,se=new ExecutorGroup(I,h,t,d.getOverlaps(),ue,n.getRenderBuffer(),!0);e.executorGroups[y].push(se)}c.renderedRevision=o,c.renderedPixelRatio=t,c.renderedRenderOrder=a,c.renderedResolution=h}forEachFeatureAtCoordinate(e,t,s,n,o){var w,C;const a=t.viewState.resolution,h=t.viewState.rotation;s=s??0;const c=this.getLayer(),u=c.getSource().getTileGridForProjection(t.viewState.projection),_=boundingExtent([e]);buffer(_,a*s,_);const f={},v=function(E,L,S){let P=E.getId();P===void 0&&(P=getUid(E));const R=f[P];if(R){if(R!==!0&&S<R.distanceSq){if(S===0)return f[P]=!0,o.splice(o.lastIndexOf(R),1),n(E,c,L);R.geometry=L,R.distanceSq=S}}else{if(S===0)return f[P]=!0,n(E,c,L);o.push(f[P]={feature:E,layer:c,geometry:L,distanceSq:S,callback:n})}},g=this.renderedTiles,y=getUid(c),p=c.getDeclutter(),x=p?(C=(w=t.declutter)==null?void 0:w[p])==null?void 0:C.all().map(E=>E.value):null;let T;e:for(let E=0,L=g.length;E<L;++E){const S=g[E],P=u.getTileCoordExtent(S.wrappedTileCoord);if(!intersects(P,_))continue;const R=S.executorGroups[y];for(let M=0,B=R.length;M<B;++M)if(T=R[M].forEachFeatureAtCoordinate(e,a,h,s,v,x),T)break e}return T}getFeatures(e){return this.renderedTiles.length===0?Promise.resolve([]):new Promise((t,s)=>{const n=this.getLayer(),o=n.getSource(),a=this.renderedProjection,h=a.getExtent(),c=this.renderedResolution,d=o.getTileGridForProjection(a),u=apply(this.renderedPixelToCoordinateTransform_,e.slice()),_=d.getTileCoordForCoordAndResolution(u,c).toString(),f=this.renderedTiles.find(w=>w.tileCoord.toString()===_&&w.getState()===TileState.LOADED);if(!f||f.loadingSourceTiles>0){t([]);return}o.getWrapX()&&a.canWrapX()&&!containsExtent(h,d.getTileCoordExtent(f.tileCoord))&&wrapX(u,a);const v=getUid(n),g=d.getTileCoordExtent(f.wrappedTileCoord),y=getTopLeft(g),p=[(u[0]-y[0])/c,(y[1]-u[1])/c],x=f.getSourceTiles().reduce((w,C)=>w.concat(C.getFeatures()),[]);let T=f.hitDetectionImageData[v];if(!T){const w=toSize(d.getTileSize(d.getZForResolution(c,o.zDirection))),C=this.renderedRotation_,E=[this.getRenderTransform(d.getTileCoordCenter(f.wrappedTileCoord),c,0,HIT_DETECT_RESOLUTION,w[0]*HIT_DETECT_RESOLUTION,w[1]*HIT_DETECT_RESOLUTION,0)];T=createHitDetectionImageData(w,E,x,n.getStyleFunction(),d.getTileCoordExtent(f.wrappedTileCoord),f.getReplayState(n).renderedResolution,C),f.hitDetectionImageData[v]=T}t(hitDetect(p,x,T))})}getFeaturesInExtent(e){const t=[],s=this.getTileCache();if(s.getCount()===0)return t;const o=this.getLayer().getSource().getTileGridForProjection(this.frameState.viewState.projection),a=o.getZForResolution(this.renderedResolution),h={};return s.forEach(c=>{if(c.tileCoord[0]!==a||c.getState()!==TileState.LOADED)return;const d=c.getSourceTiles();for(let u=0,_=d.length;u<_;++u){const f=d[u],v=f.getKey();if(v in h)continue;h[v]=!0;const g=f.tileCoord;if(intersects(e,o.getTileCoordExtent(g))){const y=f.getFeatures();if(y)for(let p=0,x=y.length;p<x;++p){const T=y[p],w=T.getGeometry();intersects(e,w.getExtent())&&t.push(T)}}}}),t}handleFontsChanged(){const e=this.getLayer();e.getVisible()&&this.renderedLayerRevision_!==void 0&&e.changed()}handleStyleImageChange_(e){this.renderIfReadyAndVisible()}renderDeclutter(e,t){var f;const s=this.context,n=s.globalAlpha;s.globalAlpha=t.opacity;const o=e.viewHints,a=!(o[ViewHint.ANIMATING]||o[ViewHint.INTERACTING]),h=[this.context.canvas.width,this.context.canvas.height],c=this.getLayer().getDeclutter(),d=c?(f=e.declutter)==null?void 0:f[c]:void 0,u=getUid(this.getLayer()),_=this.renderedTiles;for(let v=0,g=_.length;v<g;++v){const y=_[v],p=y.executorGroups[u];if(p)for(let x=p.length-1;x>=0;--x)p[x].execute(this.context,h,this.getTileRenderTransform(y,e),e.viewState.rotation,a,DECLUTTER,d)}s.globalAlpha=n}renderDeferredInternal(e){const t=this.renderedTiles,s=getUid(this.getLayer()),n=t.reduce((c,d,u)=>(d.executorGroups[s].forEach(_=>c.push({executorGroup:_,index:u})),c),[]),o=n.map(({executorGroup:c})=>c.getDeferredZIndexContexts()),a={};for(let c=0,d=n.length;c<d;++c){const u=n[c].executorGroup.getDeferredZIndexContexts();for(const _ in u)a[_]=!0}Object.keys(a).map(Number).sort(ascending).forEach(c=>{o.forEach((d,u)=>{d[c]&&(d[c].forEach(_=>{const{executorGroup:f,index:v}=n[u],g=f.getRenderedContext(),y=g.globalAlpha;g.globalAlpha=this.renderedOpacity_;const p=this.tileClipContexts_[v];p&&p.draw(g),_.draw(g),p&&g.restore(),g.globalAlpha=y,_.clear()}),d[c].length=0)})})}getTileRenderTransform(e,t){const s=t.pixelRatio,n=t.viewState,o=n.center,a=n.resolution,h=n.rotation,c=t.size,d=Math.round(c[0]*s),u=Math.round(c[1]*s),f=this.getLayer().getSource().getTileGridForProjection(t.viewState.projection),v=e.tileCoord,g=f.getTileCoordExtent(e.wrappedTileCoord),y=f.getTileCoordExtent(v,this.tempExtent)[0]-g[0];return multiply(scale$1(this.inversePixelTransform.slice(),1/s,1/s),this.getRenderTransform(o,a,h,s,d,u,y))}postRender(e,t){var E;const s=t.viewHints,n=!(s[ViewHint.ANIMATING]||s[ViewHint.INTERACTING]);this.renderedPixelToCoordinateTransform_=t.pixelToCoordinateTransform.slice(),this.renderedRotation_=t.viewState.rotation,this.renderedOpacity_=t.layerStatesArray[t.layerIndex].opacity;const o=this.getLayer(),a=o.getRenderMode(),h=e.globalAlpha;e.globalAlpha=this.renderedOpacity_;const c=o.getDeclutter(),d=c?VECTOR_REPLAYS[a].filter(L=>!DECLUTTER.includes(L)):VECTOR_REPLAYS[a],u=t.viewState,_=u.rotation,f=o.getSource(),g=f.getTileGridForProjection(u.projection).getZForResolution(u.resolution,f.zDirection),y=this.renderedTiles,p=[],x=[],T=[],w=getUid(o);let C=!0;for(let L=y.length-1;L>=0;--L){const S=y[L];C=C&&!S.getReplayState(o).dirty;const P=S.executorGroups[w].filter(se=>se.hasExecutors(d));if(P.length===0)continue;const R=this.getTileRenderTransform(S,t),M=S.tileCoord[0];let B=!1;const z=P[0].getClipCoords(R);let ue=e,I;if(z){I=new ZIndexContext,ue=I.getContext();for(let se=0,G=p.length;se<G;++se)if(g!==M&&M<x[se]){const k=p[se];intersects([z[0],z[3],z[4],z[7]],[k[0],k[3],k[4],k[7]])&&(B||(ue.save(),B=!0),ue.beginPath(),ue.moveTo(z[0],z[1]),ue.lineTo(z[2],z[3]),ue.lineTo(z[4],z[5]),ue.lineTo(z[6],z[7]),ue.moveTo(k[6],k[7]),ue.lineTo(k[4],k[5]),ue.lineTo(k[2],k[3]),ue.lineTo(k[0],k[1]),ue.clip())}p.push(z),x.push(M)}for(let se=0,G=P.length;se<G;++se)P[se].execute(e,[e.canvas.width,e.canvas.height],R,_,n,d,(E=t.declutter)==null?void 0:E[c]);B&&(ue===e?ue.restore():T[L]=I)}e.globalAlpha=h,this.ready=C,this.tileClipContexts_=T,t.declutter||this.renderDeferredInternal(t),super.postRender(e,t)}renderFeature(e,t,s,n,o,a){if(!s)return!1;let h=!1;if(Array.isArray(s))for(let c=0,d=s.length;c<d;++c)h=renderFeature(n,e,s[c],t,this.boundHandleStyleImageChange_,void 0,o,a)||h;else h=renderFeature(n,e,s,t,this.boundHandleStyleImageChange_,void 0,o,a);return h}tileImageNeedsRender_(e){const t=this.getLayer();if(t.getRenderMode()==="vector")return!1;const s=e.getReplayState(t),n=t.getRevision(),o=e.wantedResolution;return s.renderedTileResolution!==o||s.renderedTileRevision!==n}renderTileImage_(e,t){const s=this.getLayer(),n=e.getReplayState(s),o=s.getRevision(),a=e.executorGroups[getUid(s)];n.renderedTileRevision=o;const h=e.wrappedTileCoord,c=h[0],d=s.getSource();let u=t.pixelRatio;const f=t.viewState.projection,v=d.getTileGridForProjection(f),g=v.getResolution(e.tileCoord[0]),y=t.pixelRatio/e.wantedResolution*g,p=v.getResolution(c),x=e.getContext();u=Math.round(Math.max(u,y/u));const T=d.getTilePixelSize(c,u,f);x.canvas.width=T[0],x.canvas.height=T[1];const w=u/y;if(w!==1){const S=reset(this.tmpTransform_);scale$1(S,w,w),x.setTransform.apply(x,S)}const C=v.getTileCoordExtent(h,this.tempExtent),E=y/p,L=reset(this.tmpTransform_);scale$1(L,E,-E),translate(L,-C[0],-C[3]);for(let S=0,P=a.length;S<P;++S)a[S].execute(x,[x.canvas.width*w,x.canvas.height*w],L,0,!0,IMAGE_REPLAYS[s.getRenderMode()],null);n.renderedTileResolution=e.wantedResolution}}class VectorTileLayer extends BaseVectorLayer{constructor(e){e=e||{};const t=Object.assign({},e);delete t.preload;const s=e.cacheSize===void 0?0:e.cacheSize;delete e.cacheSize,delete t.useInterimTilesOnError,super(t),this.on,this.once,this.un,this.cacheSize_=s;const n=e.renderMode||"hybrid";assert(n=="hybrid"||n=="vector","`renderMode` must be `'hybrid'` or `'vector'`"),this.renderMode_=n,this.setPreload(e.preload?e.preload:0),this.setUseInterimTilesOnError(e.useInterimTilesOnError!==void 0?e.useInterimTilesOnError:!0),this.getBackground,this.setBackground}createRenderer(){return new CanvasVectorTileLayerRenderer(this,{cacheSize:this.cacheSize_})}getFeatures(e){return super.getFeatures(e)}getFeaturesInExtent(e){return this.getRenderer().getFeaturesInExtent(e)}getRenderMode(){return this.renderMode_}getPreload(){return this.get(TileProperty.PRELOAD)}getUseInterimTilesOnError(){return this.get(TileProperty.USE_INTERIM_TILES_ON_ERROR)}setPreload(e){this.set(TileProperty.PRELOAD,e)}setUseInterimTilesOnError(e){this.set(TileProperty.USE_INTERIM_TILES_ON_ERROR,e)}}const basicOlFormats={GeoJSON,MVT},basicOlLayers={Group:LayerGroup,Image:ImageLayer,Tile:TileLayer,Vector:VectorLayer,VectorTile:VectorTileLayer},basicOlSources={ImageWMS,OSM,Tile:TileSource,TileWMS,Vector:VectorSource,VectorTile,WMTS,XYZ};function createLayer(l,e,t=!0){var a;const n={...window.eoxMapAdvancedOlLayers,...basicOlLayers}[e.type];if(!n)throw new Error(`Layer type ${e.type} not supported!`);const o=new n({...e,...e.type!=="MapboxStyle"&&e.source&&{source:createOlSourceFromDefinition(e.source)},...e.type==="Group"&&{layers:[]},...e.properties,style:void 0});if(o.set("_jsonDefinition",e,!0),e.type==="Group"){const h=e.layers.map(c=>createLayer(l,c));h.forEach(c=>c.set("_group",o,!0)),o.setLayers(new Collection(h))}if("style"in e&&o.setStyle(e.style),t&&((a=e.interactions)!=null&&a.length))for(let h=0;h<e.interactions.length;h++){const c=e.interactions[h];addInteraction(l,o,c)}return setSyncListeners(o,e),o}function createOlSourceFromDefinition(l){const t={...window.eoxMapAdvancedOlSources,...basicOlSources}[l.type];if(l&&!t)throw new Error(`Source type ${l.type} not supported!`);const s={...window.eoxMapAdvancedOlFormats,...basicOlFormats},n=generateTileGrid(l);return new t({...l,..."format"in l&&l.type!=="WMTS"&&{format:new s[typeof l.format=="object"?l.format.type:l.format]({...typeof l.format=="object"&&{...l.format}})},..."source"in l&&{source:createOlSourceFromDefinition(l.source)},..."tileGrid"in l&&{tileGrid:n},..."projection"in l&&{projection:get(l.projection)}})}function addInteraction(l,e,t){t.type==="draw"?addDraw(l,e,t.options):t.type==="select"?addSelect(l,e,t.options):t.type==="clusterExplode"&&addClusterExplode(l,e,t.options)}function updateLayer(l,e,t){var o,a,h,c;const s=t.get("_jsonDefinition");if(e.type!==s.type||e.type!=="MapboxStyle"&&((o=e.source)==null?void 0:o.type)!==((a=s.source)==null?void 0:a.type))throw new Error("Layers are not compatible to be updated");const n=createLayer(l,e,!1);if(e.type!=="MapboxStyle"&&serialize(e.source)!==serialize(s.source)&&t.setSource(n.getSource()),e.type==="MapboxStyle"&&serialize(e.properties.mapboxStyle)!==serialize(s.properties.mapboxStyle)&&(t.getLayers().clear(),t.applyMapboxStyle(e.properties.mapboxStyle,e.properties.applyOptions)),["Vector","VectorTile"].includes(e.type)&&serialize(e.style)!==serialize(s.style)&&t.setStyle(n.getStyle()),serialize(e.properties)!==serialize(s.properties)&&t.setProperties(e.properties),e.visible!==s.visible&&t.setVisible(e.visible),e.opacity&&e.opacity!==s.opacity&&t.setOpacity(e.opacity),serialize(e.interactions)!==serialize(s.interactions)&&((h=s.interactions)==null||h.forEach(d=>{const u=e.interactions.find(_=>{var f,v;return _.type===d.type&&((f=_.options)==null?void 0:f.id)===((v=d.options)==null?void 0:v.id)});u?u.type==="draw"?(l.interactions[u.options.id].setActive(u.options.active),l.interactions[`${u.options.id}_modify`].setActive(u.options.modify)):(l.selectInteractions[u.options.id]||l.interactions[u.options.id]).setActive(u.options.active):d.type==="select"?l.removeSelect(d.options.id):l.removeInteraction(d.options.id)}),(c=e.interactions)==null||c.forEach(d=>{s.interactions.find(_=>{var f,v;return _.type===d.type&&((f=_.options)==null?void 0:f.id)===((v=d.options)==null?void 0:v.id)})||addInteraction(l,t,d)})),e.type==="Group"){const d=e.layers.map(v=>{var g;return(g=v.properties)==null?void 0:g.id}),u=t.getLayers();u.getArray().slice().forEach(v=>{d.includes(v.get("id"))||u.remove(v)}),e.layers.forEach(v=>{const g=v.properties.id;if(u.getArray().map(y=>y.get("id")).includes(g))updateLayer(l,v,l.getLayerById(g));else{const y=createLayer(l,v);u.push(y)}});const f=d;u.getArray().sort((v,g)=>f.indexOf(v.get("id"))-f.indexOf(g.get("id"))),u.changed()}return setSyncListeners(t,e),t.set("_jsonDefinition",e,!0),t}const generateLayers=(l,e)=>e?[...e].map(t=>createLayer(l,t)):[];function setSyncListeners(l,e){l.on("change:opacity",()=>{e.opacity=l.getOpacity()}),l.on("change:visible",()=>{e.visible=l.getVisible()}),l.on("change:zIndex",()=>{e.zIndex=l.getZIndex()}),l.on("propertychange",t=>{t.key==="map"||t.key==="source"||e.properties&&(e.properties[t.key]=t.target.get(t.key))})}class EOxSelectInteraction{constructor(e,t,s){Cc(this,"panIntoFeature",(e,t)=>{const s=e instanceof Feature||e instanceof RenderFeature?e.getGeometry().getExtent():e;this.eoxMap.map.getView().fit(s,t||{duration:750})});var d,u,_;this.eoxMap=e,this.selectLayer=t,this.options=s,this.active=s.active||t.getVisible(),this.panIn=s.panIn||!1,this.tooltip=s.tooltip!==!1;const n=this.eoxMap.map.getOverlayById("eox-map-tooltip");let o;this.tooltip&&(n?(this.tooltipElement=n.getElement(),o=n):(this.tooltipElement=this.eoxMap.querySelector("eox-map-tooltip")||this.eoxMap.querySelector("[is=eox-map-tooltip]")||((d=s.overlay)==null?void 0:d.element),this.tooltipElement&&(o=new Overlay({element:this.tooltipElement,position:void 0,offset:[0,0],positioning:"top-left",className:"eox-map-tooltip",id:"eox-map-tooltip",...s.overlay}),this.eoxMap.map.addOverlay(o))));const a=()=>{o&&s.condition==="pointermove"&&o.setPosition(void 0)};e.map.on("change:target",f=>{var v,g;(v=f.oldValue)==null||v.removeEventListener("pointerleave",a),(g=f.target.getTargetElement())==null||g.addEventListener("pointerleave",a)}),(u=e.map.getTargetElement())==null||u.addEventListener("pointerleave",a);const h=f=>{var p,x,T,w;s!=null&&s.projection&&(proj4.defs((p=s.projection)==null?void 0:p.name)||(proj4.defs((x=s.projection)==null?void 0:x.name,(T=s==null?void 0:s.projection)==null?void 0:T.proj4_string),register(proj4)));const v=get(((w=s==null?void 0:s.projection)==null?void 0:w.name)||"EPSG:4326"),g=e.map.getView().getProjection().getCode(),y=transform$1(f.coordinate,g,v);return{lon:y[0].toFixed((s==null?void 0:s.precision)||2),lat:y[1].toFixed((s==null?void 0:s.precision)||2)}},c=f=>Object.values(f).every(v=>v===0);if(this.selectLayer instanceof VectorLayer||this.selectLayer instanceof VectorTileLayer){this.selectedFids=[];let f;if(this.options.layer)f=this.options.layer;else{const y=this.selectLayer.get("_jsonDefinition");f={...y,style:s.style,properties:{id:this.selectLayer.get("id")+"_select"},source:{type:y.type}}}f.renderMode="vector",delete f.interactions,this.selectStyleLayer=createLayer(e,f),this.selectStyleLayer.setSource(this.selectLayer.getSource()),this.selectStyleLayer.setMap(this.eoxMap.map);const v=this.selectStyleLayer.getStyleFunction();this.selectStyleLayer.setStyle((y,p)=>this.selectedFids.length&&this.selectedFids.includes(this.getId(y))?v(y,p):null),this.listener=y=>{if(!this.active||y.dragging)return;const p=this.eoxMap.map.getView().getZoom();if(p<this.selectLayer.getMinZoom()||p>this.selectLayer.getMaxZoom())return;const x=this.eoxMap.map.forEachFeatureAtPixel(y.pixel,E=>E,{layerFilter:E=>E===this.selectLayer}),T=x?[this.getId(x)]:[],w=this.selectedFids[0]!==T[0];if(this.selectedFids=T,w&&(this.selectStyleLayer.changed(),x&&this.panIn&&this.panIntoFeature(x)),o){const E=y.pixel[0]>this.eoxMap.offsetWidth/2?"right":"left",L=y.pixel[1]>this.eoxMap.offsetHeight/2?"bottom":"top";o.setPositioning(`${L}-${E}`),o.setPosition(x?y.coordinate:null),x&&this.tooltipElement&&(this.tooltipElement.feature=x)}const C=new CustomEvent("select",{detail:{id:s.id,originalEvent:y,feature:x}});this.eoxMap.dispatchEvent(C)},this.eoxMap.map.on(s.condition||"click",this.listener),this.selectLayer.on("change:opacity",()=>{this.selectStyleLayer.setOpacity(this.selectLayer.getOpacity())}),this.selectLayer.on("change:visible",()=>{const y=this.selectLayer.getVisible();this.selectStyleLayer.setVisible(y),this.setActive(y)}),this.changeSourceListener=()=>{this.selectStyleLayer.setSource(this.selectLayer.getSource())},this.selectLayer.on("change:source",this.changeSourceListener);const g=()=>{var y,p;e.getLayerById(t.get("id"))?((y=this.selectStyleLayer)==null||y.setMap(this.eoxMap.map),o==null||o.setMap(this.eoxMap.map)):((p=this.selectStyleLayer)==null||p.setMap(null),o==null||o.setMap(null))};e.map.getLayerGroup().on("change",g),this.pointerMoveListener=y=>{var p;y.dragging||(e.map.getTargetElement().style.cursor=e.map.hasFeatureAtPixel(y.pixel,{layerFilter:x=>{var T,w;return(w=(T=x.get("_jsonDefinition"))==null?void 0:T.interactions)==null?void 0:w.find(C=>{var E;return C.type=="select"&&((E=C.options)==null?void 0:E.condition)==="click"})},...s.atPixelOptions})?s.cursor||"pointer":(p=this.eoxMap.interactions.drawInteraction)!=null&&p.getActive()?"crosshair":"auto")},e.map.on("pointermove",this.pointerMoveListener)}(this.selectLayer.getSource()instanceof ImageWMS||this.selectLayer.getSource()instanceof TileWMS)&&(this.listener=f=>{if(!this.active||f.dragging)return;const v=e.map.getView().getResolution(),g=this.selectLayer.getSource().getFeatureInfoUrl(f.coordinate,v,e.map.getView().getProjection(),{INFO_FORMAT:"application/json"});g&&fetch(g).then(y=>y.text()).then(y=>{if(o){const p=f.pixel[0]>this.eoxMap.offsetWidth/2?"right":"left",x=f.pixel[1]>this.eoxMap.offsetHeight/2?"bottom":"top";o.setPositioning(`${x}-${p}`)}if(y&&this.tooltipElement){const p=JSON.parse(y);let x;p.type==="FeatureCollection"&&p.features.length>0?x=p.features[0]:p.type==="Feature"?(x=p,this.tooltipElement.innerHTML=`<pre>${JSON.stringify(x.properties,null,2)}</pre>`):o==null||o.setPosition(null),s!=null&&s.coordinates&&x&&Object.assign(x==null?void 0:x.properties,h(f));const T=new Feature({...x==null?void 0:x.properties});this.tooltipElement.feature=T,o.setPosition(x?f.coordinate:null)}})},s.condition=="click"&&this.eoxMap.map.on(s.condition,this.listener)),((_=this.selectLayer.getProperties())==null?void 0:_.type)==="WebGLTile"&&(this.listener=f=>{if(!this.active||f.dragging)return;const v=this.selectLayer.getData(f.pixel);if(v){if(o){const g=f.pixel[0]>this.eoxMap.offsetWidth/2?"right":"left",y=f.pixel[1]>this.eoxMap.offsetHeight/2?"bottom":"top";o.setPositioning(`${y}-${g}`),o.setPosition(f.coordinate);let p={};for(const[x,T]of v.entries()){const w=(x+1).toString();p[`band${w}`]=T}if(c(p))o==null||o.setPosition(null);else if(this.tooltipElement){s!=null&&s.coordinates&&Object.assign(p,h(f));const x=new Feature({...p});this.tooltipElement.feature=x,o.setPosition(Object.keys(p).length>0?f.coordinate:null)}}}else o==null||o.setPosition(null)},this.eoxMap.map.on(s.condition||"click",this.listener))}setActive(e){this.active=e}highlightById(e,t){if(this.selectedFids=e,e.length&&t){const s=createEmpty();if(this.selectLayer instanceof VectorLayer)for(let n=0;n<this.selectedFids.length;n++){const o=this.selectedFids[n],a=this.selectLayer.getSource().getFeatureById(o);a&&a.getGeometry()&&extend(s,a.getGeometry().getExtent())}else if(this.selectLayer instanceof VectorTileLayer){const n=this.eoxMap.map,o=this.selectLayer.getFeaturesInExtent(n.getView().calculateExtent(n.getSize()));for(let a=0;a<o.length;a++){const h=o[a];this.selectedFids.includes(this.getId(h))&&extend(s,h.getGeometry().getExtent())}}isEmpty(s)||this.panIntoFeature(s,t)}this.selectStyleLayer.changed()}remove(){this.eoxMap.map.un(this.options.condition||"click",this.listener),(this.selectLayer instanceof VectorLayer||this.selectLayer instanceof VectorTileLayer)&&(this.selectStyleLayer.setMap(null),delete this.eoxMap.selectInteractions[this.options.id],this.selectLayer.un("change:source",this.changeSourceListener),this.eoxMap.map.un("pointermove",this.pointerMoveListener))}getId(e){if(this.options.idProperty)return e.get(this.options.idProperty);if(e.getId()!==void 0)return e.getId();if(e.get("id")!==void 0)return e.get("id");if(getUid(e)!==void 0)return getUid(e);throw Error("No feature id found. Please provide which feature property should be taken instead using idProperty.")}}function addSelect(l,e,t){if(l.interactions[t.id])throw Error(`Interaction with id: ${t.id} already exists.`);return l.selectInteractions[t.id]=new EOxSelectInteraction(l,e,t),l.selectInteractions[t.id]}const circleDistanceMultiplier=1,circleFootSeparation=28,circleStartAngle=Math.PI/2;var ki,xn,Bi,je,bc,zs,pc,fc,Ac,wc;class EOxClusterExplodeInteraction extends Interaction{constructor(t,s,n){super(n);tt(this,je);tt(this,ki,null);tt(this,xn,null);tt(this,Bi,null);tt(this,pc,t=>new Promise(s=>{const n=this.eoxMap.map.getView().getZoom(),o={...Ie(this,ki).fitOptions};o.callback=a=>{var h,c;s(this.eoxMap.map.getView().getZoom()!==n),(c=(h=Ie(this,ki).fitOptions).callback)==null||c.call(h,a)},this.eoxMap.map.getView().fit(t,o)}));this.clusterLayer=s,this.eoxMap=t;const o={maxZoom:20,atPixelOptions:{},fitOptions:{duration:500,padding:[40,40,40,40]}},a=structuredClone(n);a.fitOptions&&(o.fitOptions={...o.fitOptions,...a.fitOptions},delete a.fitOptions),pt(this,ki,{...o,...a}),this.active=n.active||s.getVisible();const h=new VectorLayer;h.setStyle(n.style),pt(this,xn,h.getStyleFunction())}handleEvent(t){if(!this.getActive())return!0;if(t.type==="pointermove"){const s=this.eoxMap.map.hasFeatureAtPixel(t.pixel,{layerFilter:n=>n===this.clusterLayer,...Ie(this,ki).atPixelOptions});return this.eoxMap.map.getTargetElement().style.cursor=s?"pointer":"default",!s}if(t.type==="click"){const s=this.eoxMap.map.getFeaturesAtPixel(t.pixel,{layerFilter:h=>h===this.clusterLayer,...Ie(this,ki).atPixelOptions});if(s.length===0)return Rt(this,je,zs).call(this),!0;const n=s[0],o=n.get("features");if(o.length===1)return Rt(this,je,bc).call(this,t,o[0]),Rt(this,je,zs).call(this),!0;if(Ie(this,Bi)&&Ie(this,Bi)===n){const h=Rt(this,je,Ac).call(this,n,t.coordinate);Rt(this,je,bc).call(this,t,h.feature)}if(this.eoxMap.map.getView().getZoom()>Ie(this,ki).maxZoom-1)return Rt(this,je,fc).call(this,n),!1;const a=createEmpty();return o.forEach(h=>{extend(a,h.getGeometry().getExtent())}),getArea$1(a)<100?(Rt(this,je,fc).call(this,n),!1):(Ie(this,pc).call(this,a).then(h=>{h||Rt(this,je,fc).call(this,n)}),!1)}return!0}setActive(t){t||(Rt(this,je,zs).call(this),this.eoxMap.map.getTargetElement().style.cursor="default"),super.setActive(t)}setMap(t){t||(Rt(this,je,zs).call(this),this.eoxMap.map.getTargetElement().style.cursor="default"),super.setMap(t)}remove(){this.setMap(null)}}ki=new WeakMap,xn=new WeakMap,Bi=new WeakMap,je=new WeakSet,bc=function(t,s){const n=new CustomEvent("clusterSelect",{detail:{originalEvent:t,feature:s}});this.eoxMap.dispatchEvent(n)},zs=function(){Ie(this,Bi)&&(Ie(this,Bi).setStyle(void 0),pt(this,Bi,null))},pc=new WeakMap,fc=function(t){Ie(this,Bi)&&Rt(this,je,zs).call(this);const s=t.getGeometry().getCoordinates(),n=t.get("features"),o=Rt(this,je,wc).call(this,n.length,s,this.eoxMap.map.getView().getResolution()).reduce((a,h,c)=>{const d=new Point(h),u=new LineString([s,h]);a.unshift(new Style({geometry:u,stroke:new Stroke({color:"rgba(50, 50, 50, 0.5)",width:2.5})}));const _=new Feature({...n[c].getProperties()}),f=Ie(this,xn).call(this,_,this.eoxMap.map.getView().getResolution());return f!=null&&f.length&&f.forEach(v=>{const g=v.clone();g.setGeometry(d),a.unshift(g)}),a},[]);t.setStyle(o),pt(this,Bi,t)},Ac=function(t,s){const n=t.get("features"),o=Rt(this,je,wc).call(this,n.length,t.getGeometry().getCoordinates(),this.eoxMap.map.getView().getResolution());let a=1/0,h;for(let c=0,d=o.length;c<d;++c){const u=(s[0]-o[c][0])**2+(s[1]-o[c][1])**2;u<a&&(h=c,a=u)}return{feature:n[h],coords:o[h]}},wc=function(t,s,n){let a=circleDistanceMultiplier*circleFootSeparation*(2+t)/(Math.PI*2);const h=Math.PI*2/t,c=[];let d;a=Math.max(a,35)*n;for(let u=0;u<t;++u)d=circleStartAngle+u*h,c.push([s[0]+a*Math.cos(d),s[1]+a*Math.sin(d)]);return c};function addClusterExplode(l,e,t){if(l.interactions[t.id])throw Error(`Interaction with id: ${t.id} already exists.`);const s=new EOxClusterExplodeInteraction(l,e,t);l.interactions[t.id]=s,l.map.addInteraction(s)}function generateTileGrid(l){let e;if(!(!l||!("tileGrid"in l))){if(l.type==="WMTS"){const s=get("EPSG:3857").getExtent(),n=getWidth(s)/128,o=new Array(19),a=new Array(19);for(let h=0;h<19;++h)o[h]=n/Math.pow(2,h),a[h]=h;e=new WMTSTileGrid({resolutions:o,origin:getTopLeft(s),projection:l.tileGrid.projection||"EPSG:3857",matrixIds:a,...l.tileGrid})}else e=createXYZ({...l.tileGrid});return e}}function getLayerById(l,e){return getFlatLayersArray(l.map.getLayers().getArray()).find(s=>s.get("id")===e)}function getFlatLayersArray(l){const e=[];e.push(...l);let t=e.filter(s=>s instanceof LayerGroup);for(;t.length;){const s=[];for(let n=0;n<t.length;n++){const o=t[n].getLayers().getArray();e.push(...o),s.push(...o.filter(a=>a instanceof LayerGroup))}t=s}return e}function animateToStateMethod(l){const e=Object.assign({},l.animationOptions),t=l.map.getView();if(cancelAnimation(t),!e||!Object.keys(e).length){t.setCenter(l.center),t.setZoom(l.zoom);return}e.center=getCenterFromProperty(l.center),e.zoom=l.zoom,t.animate(e)}const UNITS_PROP="units",LEADING_DIGITS=[1,2,5],DEFAULT_DPI=25.4/.28;class ScaleLine extends Control{constructor(e){e=e||{};const t=document.createElement("div");t.style.pointerEvents="none",super({element:t,render:e.render,target:e.target}),this.on,this.once,this.un;const s=e.className!==void 0?e.className:e.bar?"ol-scale-bar":"ol-scale-line";this.innerElement_=document.createElement("div"),this.innerElement_.className=s+"-inner",this.element.className=s+" "+CLASS_UNSELECTABLE,this.element.appendChild(this.innerElement_),this.viewState_=null,this.minWidth_=e.minWidth!==void 0?e.minWidth:64,this.maxWidth_=e.maxWidth,this.renderedVisible_=!1,this.renderedWidth_=void 0,this.renderedHTML_="",this.addChangeListener(UNITS_PROP,this.handleUnitsChanged_),this.setUnits(e.units||"metric"),this.scaleBar_=e.bar||!1,this.scaleBarSteps_=e.steps||4,this.scaleBarText_=e.text||!1,this.dpi_=e.dpi||void 0}getUnits(){return this.get(UNITS_PROP)}handleUnitsChanged_(){this.updateElement_()}setUnits(e){this.set(UNITS_PROP,e)}setDpi(e){this.dpi_=e}updateElement_(){const e=this.viewState_;if(!e){this.renderedVisible_&&(this.element.style.display="none",this.renderedVisible_=!1);return}const t=e.center,s=e.projection,n=this.getUnits(),o=n=="degrees"?"degrees":"m";let a=getPointResolution(s,e.resolution,t,o);const h=this.minWidth_*(this.dpi_||DEFAULT_DPI)/DEFAULT_DPI,c=this.maxWidth_!==void 0?this.maxWidth_*(this.dpi_||DEFAULT_DPI)/DEFAULT_DPI:void 0;let d=h*a,u="";if(n=="degrees"){const w=METERS_PER_UNIT.degrees;d*=w,d<w/60?(u="″",a*=3600):d<w?(u="′",a*=60):u="°"}else if(n=="imperial")d<.9144?(u="in",a/=.0254):d<1609.344?(u="ft",a/=.3048):(u="mi",a/=1609.344);else if(n=="nautical")a/=1852,u="NM";else if(n=="metric")d<1e-6?(u="nm",a*=1e9):d<.001?(u="μm",a*=1e6):d<1?(u="mm",a*=1e3):d<1e3?u="m":(u="km",a/=1e3);else if(n=="us")d<.9144?(u="in",a*=39.37):d<1609.344?(u="ft",a/=.30480061):(u="mi",a/=1609.3472);else throw new Error("Invalid units");let _=3*Math.floor(Math.log(h*a)/Math.log(10)),f,v,g,y=0,p,x;for(;;){g=Math.floor(_/3);const w=Math.pow(10,g);if(f=LEADING_DIGITS[(_%3+3)%3]*w,v=Math.round(f/a),isNaN(v)){this.element.style.display="none",this.renderedVisible_=!1;return}if(c!==void 0&&v>=c){f=y,v=p,g=x;break}else if(v>=h)break;y=f,p=v,x=g,++_}const T=this.scaleBar_?this.createScaleBar(v,f,u):f.toFixed(g<0?-g:0)+" "+u;this.renderedHTML_!=T&&(this.innerElement_.innerHTML=T,this.renderedHTML_=T),this.renderedWidth_!=v&&(this.innerElement_.style.width=v+"px",this.renderedWidth_=v),this.renderedVisible_||(this.element.style.display="",this.renderedVisible_=!0)}createScaleBar(e,t,s){const n=this.getScaleForResolution(),o=n<1?Math.round(1/n).toLocaleString()+" : 1":"1 : "+Math.round(n).toLocaleString(),a=this.scaleBarSteps_,h=e/a,c=[this.createMarker("absolute")];for(let u=0;u<a;++u){const _=u%2===0?"ol-scale-singlebar-odd":"ol-scale-singlebar-even";c.push(`<div><div class="ol-scale-singlebar ${_}" style="width: ${h}px;"></div>`+this.createMarker("relative")+(u%2===0||a===2?this.createStepText(u,e,!1,t,s):"")+"</div>")}return c.push(this.createStepText(a,e,!0,t,s)),(this.scaleBarText_?`<div class="ol-scale-text" style="width: ${e}px;">`+o+"</div>":"")+c.join("")}createMarker(e){return`<div class="ol-scale-step-marker" style="position: ${e}; top: ${e==="absolute"?3:-10}px;"></div>`}createStepText(e,t,s,n,o){const h=(e===0?0:Math.round(n/this.scaleBarSteps_*e*100)/100)+(e===0?"":" "+o),c=e===0?-3:t/this.scaleBarSteps_*-1,d=e===0?0:t/this.scaleBarSteps_*2;return`<div class="ol-scale-step-text" style="margin-left: ${c}px;text-align: ${e===0?"left":"center"};min-width: ${d}px;left: ${s?t+"px":"unset"};">`+h+"</div>"}getScaleForResolution(){const e=getPointResolution(this.viewState_.projection,this.viewState_.resolution,this.viewState_.center,"m"),t=this.dpi_||DEFAULT_DPI,s=1e3/25.4;return e*s*t}render(e){const t=e.frameState;t?this.viewState_=t.viewState:this.viewState_=null,this.updateElement_()}}const events=["fullscreenchange","webkitfullscreenchange"],FullScreenEventType={ENTERFULLSCREEN:"enterfullscreen",LEAVEFULLSCREEN:"leavefullscreen"};class FullScreen extends Control{constructor(e){e=e||{},super({element:document.createElement("div"),target:e.target}),this.on,this.once,this.un,this.keys_=e.keys!==void 0?e.keys:!1,this.source_=e.source,this.isInFullscreen_=!1,this.boundHandleMapTargetChange_=this.handleMapTargetChange_.bind(this),this.cssClassName_=e.className!==void 0?e.className:"ol-full-screen",this.documentListeners_=[],this.activeClassName_=e.activeClassName!==void 0?e.activeClassName.split(" "):[this.cssClassName_+"-true"],this.inactiveClassName_=e.inactiveClassName!==void 0?e.inactiveClassName.split(" "):[this.cssClassName_+"-false"];const t=e.label!==void 0?e.label:"⤢";this.labelNode_=typeof t=="string"?document.createTextNode(t):t;const s=e.labelActive!==void 0?e.labelActive:"×";this.labelActiveNode_=typeof s=="string"?document.createTextNode(s):s;const n=e.tipLabel?e.tipLabel:"Toggle full-screen";this.button_=document.createElement("button"),this.button_.title=n,this.button_.setAttribute("type","button"),this.button_.appendChild(this.labelNode_),this.button_.addEventListener(EventType$1.CLICK,this.handleClick_.bind(this),!1),this.setClassName_(this.button_,this.isInFullscreen_),this.element.className=`${this.cssClassName_} ${CLASS_UNSELECTABLE} ${CLASS_CONTROL}`,this.element.appendChild(this.button_)}handleClick_(e){e.preventDefault(),this.handleFullScreen_()}handleFullScreen_(){const e=this.getMap();if(!e)return;const t=e.getOwnerDocument();if(isFullScreenSupported(t))if(isFullScreen(t))exitFullScreen(t);else{let s;this.source_?s=typeof this.source_=="string"?t.getElementById(this.source_):this.source_:s=e.getTargetElement(),this.keys_?requestFullScreenWithKeys(s):requestFullScreen(s)}}handleFullScreenChange_(){const e=this.getMap();if(!e)return;const t=this.isInFullscreen_;this.isInFullscreen_=isFullScreen(e.getOwnerDocument()),t!==this.isInFullscreen_&&(this.setClassName_(this.button_,this.isInFullscreen_),this.isInFullscreen_?(replaceNode(this.labelActiveNode_,this.labelNode_),this.dispatchEvent(FullScreenEventType.ENTERFULLSCREEN)):(replaceNode(this.labelNode_,this.labelActiveNode_),this.dispatchEvent(FullScreenEventType.LEAVEFULLSCREEN)),e.updateSize())}setClassName_(e,t){t?(e.classList.remove(...this.inactiveClassName_),e.classList.add(...this.activeClassName_)):(e.classList.remove(...this.activeClassName_),e.classList.add(...this.inactiveClassName_))}setMap(e){const t=this.getMap();t&&t.removeChangeListener(MapProperty.TARGET,this.boundHandleMapTargetChange_),super.setMap(e),this.handleMapTargetChange_(),e&&e.addChangeListener(MapProperty.TARGET,this.boundHandleMapTargetChange_)}handleMapTargetChange_(){const e=this.documentListeners_;for(let s=0,n=e.length;s<n;++s)unlistenByKey(e[s]);e.length=0;const t=this.getMap();if(t){const s=t.getOwnerDocument();isFullScreenSupported(s)?this.element.classList.remove(CLASS_UNSUPPORTED):this.element.classList.add(CLASS_UNSUPPORTED);for(let n=0,o=events.length;n<o;++n)e.push(listen(s,events[n],this.handleFullScreenChange_,this));this.handleFullScreenChange_()}}}function isFullScreenSupported(l){const e=l.body;return!!(e.webkitRequestFullscreen||e.requestFullscreen&&l.fullscreenEnabled)}function isFullScreen(l){return!!(l.webkitIsFullScreen||l.fullscreenElement)}function requestFullScreen(l){l.requestFullscreen?l.requestFullscreen():l.webkitRequestFullscreen&&l.webkitRequestFullscreen()}function requestFullScreenWithKeys(l){l.webkitRequestFullscreen?l.webkitRequestFullscreen():requestFullScreen(l)}function exitFullScreen(l){l.exitFullscreen?l.exitFullscreen():l.webkitExitFullscreen&&l.webkitExitFullscreen()}const Direction={VERTICAL:0,HORIZONTAL:1};class ZoomSlider extends Control{constructor(e){e=e||{},super({target:e.target,element:document.createElement("div"),render:e.render}),this.dragListenerKeys_=[],this.currentResolution_=void 0,this.direction_=Direction.VERTICAL,this.dragging_,this.heightLimit_=0,this.widthLimit_=0,this.startX_,this.startY_,this.thumbSize_=null,this.sliderInitialized_=!1,this.duration_=e.duration!==void 0?e.duration:200;const t=e.className!==void 0?e.className:"ol-zoomslider",s=document.createElement("button");s.setAttribute("type","button"),s.className=t+"-thumb "+CLASS_UNSELECTABLE;const n=this.element;n.className=t+" "+CLASS_UNSELECTABLE+" "+CLASS_CONTROL,n.appendChild(s),n.addEventListener(EventType.POINTERDOWN,this.handleDraggerStart_.bind(this),!1),n.addEventListener(EventType.POINTERMOVE,this.handleDraggerDrag_.bind(this),!1),n.addEventListener(EventType.POINTERUP,this.handleDraggerEnd_.bind(this),!1),n.addEventListener(EventType$1.CLICK,this.handleContainerClick_.bind(this),!1),s.addEventListener(EventType$1.CLICK,stopPropagation,!1)}setMap(e){super.setMap(e),e&&e.render()}initSlider_(){const e=this.element;let t=e.offsetWidth,s=e.offsetHeight;if(t===0&&s===0)return this.sliderInitialized_=!1;const n=getComputedStyle(e);t-=parseFloat(n.paddingRight)+parseFloat(n.paddingLeft),s-=parseFloat(n.paddingTop)+parseFloat(n.paddingBottom);const o=e.firstElementChild,a=getComputedStyle(o),h=o.offsetWidth+parseFloat(a.marginRight)+parseFloat(a.marginLeft),c=o.offsetHeight+parseFloat(a.marginTop)+parseFloat(a.marginBottom);return this.thumbSize_=[h,c],t>s?(this.direction_=Direction.HORIZONTAL,this.widthLimit_=t-h):(this.direction_=Direction.VERTICAL,this.heightLimit_=s-c),this.sliderInitialized_=!0}handleContainerClick_(e){const t=this.getMap().getView(),s=this.getRelativePosition_(e.offsetX-this.thumbSize_[0]/2,e.offsetY-this.thumbSize_[1]/2),n=this.getResolutionForPosition_(s),o=t.getConstrainedZoom(t.getZoomForResolution(n));t.animateInternal({zoom:o,duration:this.duration_,easing:easeOut})}handleDraggerStart_(e){if(!this.dragging_&&e.target===this.element.firstElementChild){const t=this.element.firstElementChild;if(this.getMap().getView().beginInteraction(),this.startX_=e.clientX-parseFloat(t.style.left),this.startY_=e.clientY-parseFloat(t.style.top),this.dragging_=!0,this.dragListenerKeys_.length===0){const s=this.handleDraggerDrag_,n=this.handleDraggerEnd_,o=this.getMap().getOwnerDocument();this.dragListenerKeys_.push(listen(o,EventType.POINTERMOVE,s,this),listen(o,EventType.POINTERUP,n,this))}}}handleDraggerDrag_(e){if(this.dragging_){const t=e.clientX-this.startX_,s=e.clientY-this.startY_,n=this.getRelativePosition_(t,s);this.currentResolution_=this.getResolutionForPosition_(n),this.getMap().getView().setResolution(this.currentResolution_)}}handleDraggerEnd_(e){this.dragging_&&(this.getMap().getView().endInteraction(),this.dragging_=!1,this.startX_=void 0,this.startY_=void 0,this.dragListenerKeys_.forEach(unlistenByKey),this.dragListenerKeys_.length=0)}setThumbPosition_(e){const t=this.getPositionForResolution_(e),s=this.element.firstElementChild;this.direction_==Direction.HORIZONTAL?s.style.left=this.widthLimit_*t+"px":s.style.top=this.heightLimit_*t+"px"}getRelativePosition_(e,t){let s;return this.direction_===Direction.HORIZONTAL?s=e/this.widthLimit_:s=t/this.heightLimit_,clamp(s,0,1)}getResolutionForPosition_(e){return this.getMap().getView().getResolutionForValueFunction()(1-e)}getPositionForResolution_(e){const t=this.getMap().getView().getValueForResolutionFunction();return clamp(1-t(e),0,1)}render(e){if(!e.frameState||!this.sliderInitialized_&&!this.initSlider_())return;const t=e.frameState.viewState.resolution;this.currentResolution_=t,this.setThumbPosition_(t)}}const MAX_RATIO=.75,MIN_RATIO=.1;class OverviewMap extends Control{constructor(e){e=e||{},super({element:document.createElement("div"),render:e.render,target:e.target}),this.boundHandleRotationChanged_=this.handleRotationChanged_.bind(this),this.collapsed_=e.collapsed!==void 0?e.collapsed:!0,this.collapsible_=e.collapsible!==void 0?e.collapsible:!0,this.collapsible_||(this.collapsed_=!1),this.rotateWithView_=e.rotateWithView!==void 0?e.rotateWithView:!1,this.viewExtent_=void 0;const t=e.className!==void 0?e.className:"ol-overviewmap",s=e.tipLabel!==void 0?e.tipLabel:"Overview map",n=e.collapseLabel!==void 0?e.collapseLabel:"‹";typeof n=="string"?(this.collapseLabel_=document.createElement("span"),this.collapseLabel_.textContent=n):this.collapseLabel_=n;const o=e.label!==void 0?e.label:"›";typeof o=="string"?(this.label_=document.createElement("span"),this.label_.textContent=o):this.label_=o;const a=this.collapsible_&&!this.collapsed_?this.collapseLabel_:this.label_,h=document.createElement("button");h.setAttribute("type","button"),h.title=s,h.appendChild(a),h.addEventListener(EventType$1.CLICK,this.handleClick_.bind(this),!1),this.ovmapDiv_=document.createElement("div"),this.ovmapDiv_.className="ol-overviewmap-map",this.view_=e.view;const c=new Map$1({view:e.view,controls:new Collection,interactions:new Collection});this.ovmap_=c,e.layers&&e.layers.forEach(function(x){c.addLayer(x)});const d=document.createElement("div");d.className="ol-overviewmap-box",d.style.boxSizing="border-box",this.boxOverlay_=new Overlay({position:[0,0],positioning:"center-center",element:d}),this.ovmap_.addOverlay(this.boxOverlay_);const u=t+" "+CLASS_UNSELECTABLE+" "+CLASS_CONTROL+(this.collapsed_&&this.collapsible_?" "+CLASS_COLLAPSED:"")+(this.collapsible_?"":" ol-uncollapsible"),_=this.element;_.className=u,_.appendChild(this.ovmapDiv_),_.appendChild(h);const f=this.boxOverlay_,v=this.boxOverlay_.getElement(),g=x=>({clientX:x.clientX,clientY:x.clientY}),y=function(x){const T=g(x),w=c.getEventCoordinate(T);f.setPosition(w)},p=x=>{const T=c.getEventCoordinateInternal(x),w=this.getMap();w.getView().setCenterInternal(T);const C=w.getOwnerDocument();C.removeEventListener("pointermove",y),C.removeEventListener("pointerup",p)};this.ovmapDiv_.addEventListener("pointerdown",x=>{const T=this.getMap().getOwnerDocument();x.target===v&&T.addEventListener("pointermove",y),T.addEventListener("pointerup",p)})}setMap(e){const t=this.getMap();if(e!==t){if(t){const s=t.getView();s&&this.unbindView_(s),this.ovmap_.setTarget(null)}if(super.setMap(e),e){this.ovmap_.setTarget(this.ovmapDiv_),this.listenerKeys.push(listen(e,ObjectEventType.PROPERTYCHANGE,this.handleMapPropertyChange_,this));const s=e.getView();s&&this.bindView_(s),this.ovmap_.isRendered()||this.updateBoxAfterOvmapIsRendered_()}}}handleMapPropertyChange_(e){if(e.key===MapProperty.VIEW){const t=e.oldValue;t&&this.unbindView_(t);const s=this.getMap().getView();this.bindView_(s)}else!this.ovmap_.isRendered()&&(e.key===MapProperty.TARGET||e.key===MapProperty.SIZE)&&this.ovmap_.updateSize()}bindView_(e){if(!this.view_){const t=new View({projection:e.getProjection()});this.ovmap_.setView(t)}e.addChangeListener(ViewProperty.ROTATION,this.boundHandleRotationChanged_),this.handleRotationChanged_(),e.isDef()&&(this.ovmap_.updateSize(),this.resetExtent_())}unbindView_(e){e.removeChangeListener(ViewProperty.ROTATION,this.boundHandleRotationChanged_)}handleRotationChanged_(){this.rotateWithView_&&this.ovmap_.getView().setRotation(this.getMap().getView().getRotation())}validateExtent_(){const e=this.getMap(),t=this.ovmap_;if(!e.isRendered()||!t.isRendered())return;const s=e.getSize(),o=e.getView().calculateExtentInternal(s);if(this.viewExtent_&&equals$1(o,this.viewExtent_))return;this.viewExtent_=o;const a=t.getSize(),c=t.getView().calculateExtentInternal(a),d=t.getPixelFromCoordinateInternal(getTopLeft(o)),u=t.getPixelFromCoordinateInternal(getBottomRight(o)),_=Math.abs(d[0]-u[0]),f=Math.abs(d[1]-u[1]),v=a[0],g=a[1];_<v*MIN_RATIO||f<g*MIN_RATIO||_>v*MAX_RATIO||f>g*MAX_RATIO?this.resetExtent_():containsExtent(c,o)||this.recenter_()}resetExtent_(){const e=this.getMap(),t=this.ovmap_,s=e.getSize(),o=e.getView().calculateExtentInternal(s),a=t.getView(),h=Math.log(MAX_RATIO/MIN_RATIO)/Math.LN2,c=1/(Math.pow(2,h/2)*MIN_RATIO);scaleFromCenter(o,c),a.fitInternal(fromExtent(o))}recenter_(){const e=this.getMap(),t=this.ovmap_,s=e.getView();t.getView().setCenterInternal(s.getCenterInternal())}updateBox_(){const e=this.getMap(),t=this.ovmap_;if(!e.isRendered()||!t.isRendered())return;const s=e.getSize(),n=e.getView(),o=t.getView(),a=this.rotateWithView_?0:-n.getRotation(),h=this.boxOverlay_,c=this.boxOverlay_.getElement(),d=n.getCenter(),u=n.getResolution(),_=o.getResolution(),f=s[0]*u/_,v=s[1]*u/_;if(h.setPosition(d),c){c.style.width=f+"px",c.style.height=v+"px";const g="rotate("+a+"rad)";c.style.transform=g}}updateBoxAfterOvmapIsRendered_(){this.ovmapPostrenderKey_||(this.ovmapPostrenderKey_=listenOnce(this.ovmap_,MapEventType.POSTRENDER,e=>{delete this.ovmapPostrenderKey_,this.updateBox_()}))}handleClick_(e){e.preventDefault(),this.handleToggle_()}handleToggle_(){this.element.classList.toggle(CLASS_COLLAPSED),this.collapsed_?replaceNode(this.collapseLabel_,this.label_):replaceNode(this.label_,this.collapseLabel_),this.collapsed_=!this.collapsed_;const e=this.ovmap_;if(!this.collapsed_){if(e.isRendered()){this.viewExtent_=void 0,e.render();return}e.updateSize(),this.resetExtent_(),this.updateBoxAfterOvmapIsRendered_()}}getCollapsible(){return this.collapsible_}setCollapsible(e){this.collapsible_!==e&&(this.collapsible_=e,this.element.classList.toggle("ol-uncollapsible"),!e&&this.collapsed_&&this.handleToggle_())}setCollapsed(e){!this.collapsible_||this.collapsed_===e||this.handleToggle_()}getCollapsed(){return this.collapsed_}getRotateWithView(){return this.rotateWithView_}setRotateWithView(e){this.rotateWithView_!==e&&(this.rotateWithView_=e,this.getMap().getView().getRotation()!==0&&(this.rotateWithView_?this.handleRotationChanged_():this.ovmap_.getView().setRotation(0),this.viewExtent_=void 0,this.validateExtent_(),this.updateBox_()))}getOverviewMap(){return this.ovmap_}render(e){this.validateExtent_(),this.updateBox_()}}class ZoomToExtent extends Control{constructor(e){e=e||{},super({element:document.createElement("div"),target:e.target}),this.extent=e.extent?e.extent:null,this.fitOptions=e.fitOptions||{};const t=e.className!==void 0?e.className:"ol-zoom-extent",s=e.label!==void 0?e.label:"E",n=e.tipLabel!==void 0?e.tipLabel:"Fit to extent",o=document.createElement("button");o.setAttribute("type","button"),o.title=n,o.appendChild(typeof s=="string"?document.createTextNode(s):s),o.addEventListener(EventType$1.CLICK,this.handleClick_.bind(this),!1);const a=t+" "+CLASS_UNSELECTABLE+" "+CLASS_CONTROL,h=this.element;h.className=a,h.appendChild(o)}handleClick_(e){e.preventDefault(),this.handleZoomToExtent()}handleZoomToExtent(){const t=this.getMap().getView(),s=this.extent?fromUserExtent(this.extent,t.getProjection()):t.getProjection().getExtent();t.fitInternal(fromExtent(s),this.fitOptions)}}const PROJECTION="projection",COORDINATE_FORMAT="coordinateFormat";class MousePosition extends Control{constructor(e){e=e||{};const t=document.createElement("div");t.className=e.className!==void 0?e.className:"ol-mouse-position",super({element:t,render:e.render,target:e.target}),this.on,this.once,this.un,this.addChangeListener(PROJECTION,this.handleProjectionChanged_),e.coordinateFormat&&this.setCoordinateFormat(e.coordinateFormat),e.projection&&this.setProjection(e.projection),this.renderOnMouseOut_=e.placeholder!==void 0,this.placeholder_=this.renderOnMouseOut_?e.placeholder:"&#160;",this.renderedHTML_=t.innerHTML,this.mapProjection_=null,this.transform_=null,this.wrapX_=e.wrapX!==!1}handleProjectionChanged_(){this.transform_=null}getCoordinateFormat(){return this.get(COORDINATE_FORMAT)}getProjection(){return this.get(PROJECTION)}handleMouseMove(e){const t=this.getMap();this.updateHTML_(t.getEventPixel(e))}handleMouseOut(e){this.updateHTML_(null)}setMap(e){if(super.setMap(e),e){const t=e.getViewport();this.listenerKeys.push(listen(t,EventType.POINTERMOVE,this.handleMouseMove,this)),this.renderOnMouseOut_&&this.listenerKeys.push(listen(t,EventType.POINTEROUT,this.handleMouseOut,this)),this.updateHTML_(null)}}setCoordinateFormat(e){this.set(COORDINATE_FORMAT,e)}setProjection(e){this.set(PROJECTION,get(e))}updateHTML_(e){let t=this.placeholder_;if(e&&this.mapProjection_){if(!this.transform_){const o=this.getProjection();o?this.transform_=getTransformFromProjections(this.mapProjection_,o):this.transform_=identityTransform}const n=this.getMap().getCoordinateFromPixelInternal(e);if(n){if(this.transform_(n,n),this.wrapX_){const a=this.getProjection()||this.mapProjection_;wrapX(n,a)}const o=this.getCoordinateFormat();o?t=o(n):t=n.toString()}}(!this.renderedHTML_||t!==this.renderedHTML_)&&(this.element.innerHTML=t,this.renderedHTML_=t)}render(e){const t=e.frameState;t?this.mapProjection_!=t.viewState.projection&&(this.mapProjection_=t.viewState.projection,this.transform_=null):this.mapProjection_=null}}class GeolocationControl extends Control{constructor(e){const t=e||{},s=document.createElement("div");s.className="geolocation ol-unselectable ol-control";const n=document.createElement("button");n.title="Show your location",n.innerHTML=t.buttonIcon?`
      <img src="${t.buttonIcon}" alt="Geolocation" />
    `:`
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><title>crosshairs-gps</title><path d="M12,8A4,4 0 0,1 16,12A4,4 0 0,1 12,16A4,4 0 0,1 8,12A4,4 0 0,1 12,8M3.05,13H1V11H3.05C3.5,6.83 6.83,3.5 11,3.05V1H13V3.05C17.17,3.5 20.5,6.83 20.95,11H23V13H20.95C20.5,17.17 17.17,20.5 13,20.95V23H11V20.95C6.83,20.5 3.5,17.17 3.05,13M12,5A7,7 0 0,0 5,12A7,7 0 0,0 12,19A7,7 0 0,0 19,12A7,7 0 0,0 12,5Z" /></svg>
    `,s.appendChild(n),super({element:s}),this._centerWhenReady=t.centerWhenReady,this._highAccuracy=t.highAccuracy,this._trackAccuracy=t.trackAccuracy,this._trackHeading=t.trackHeading,this._positionFeature=new Feature({geometry:new Point([NaN,NaN]),heading:0}),this._source=new VectorSource({features:[this._positionFeature]}),this._trackAccuracy&&(this._accuracyFeature=new Feature,this._accuracyFeature.setStyle(new Style({fill:new Fill({color:"rgba(0, 0, 0, 0.2)"}),stroke:new Stroke({width:2,color:"rgba(0, 0, 0, 0.7)"})})),this._source.addFeature(this._accuracyFeature)),this._layer=new VectorLayer({source:this._source}),t.style&&this._layer.setStyle(t.style),n.addEventListener("click",this.centerOnPosition.bind(this),!1)}setMap(e){this._layer.setMap(e),super.setMap(e),e&&this._centerWhenReady&&this.initGeolocation()}initGeolocation(){return new Promise((e,t)=>{const s=this.getMap();s&&(this._geolocation=new Geolocation({tracking:!0,trackingOptions:{enableHighAccuracy:this._highAccuracy},projection:s.getView().getProjection()})),this._centerWhenReady&&this._geolocation.once("change:position",n=>{s.getView().setCenter(n.target.getPosition())}),this._geolocation.on("error",n=>t(n)),this._geolocation.on("change:accuracyGeometry",()=>{this._trackAccuracy&&this._accuracyFeature.setGeometry(this._geolocation.getAccuracyGeometry())}),this._geolocation.on("change:heading",n=>{this._trackHeading&&this._highAccuracy&&this._positionFeature.set("heading",n.target.getHeading())}),this._geolocation.on("change:position",()=>{const n=this._geolocation.getPosition();this._positionFeature.getGeometry().setCoordinates(n||null),e(n)})})}getElement(){return this.element}async centerOnPosition(){var e,t;try{await this.initGeolocation();const s=(e=this._geolocation)==null?void 0:e.getPosition();s&&((t=this.getMap())==null||t.getView().setCenter(s))}catch(s){console.error(s)}}}class LoadingIndicatorControl extends Control{constructor(e){const t=e||{};t.opacity===void 0&&(t.opacity=1),t.type===void 0&&(t.type="small");const s=document.createElement("div");s.className="LoadingIndicator ol-unselectable ol-control",s.classList.add("loading-indicator"),s.style.opacity=String(t.opacity),t.spinnerSvg?s.innerHTML=t.spinnerSvg:s.innerHTML=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid" width="50" height="50" style="shape-rendering: auto; display: block; background: transparent;" xmlns:xlink="http://www.w3.org/1999/xlink"><g><circle stroke-dasharray="164.93361431346415 56.97787143782138" r="35" stroke-width="12" stroke="#1a467c" fill="none" cy="50" cx="50">
      <animateTransform keyTimes="0;1" values="0 50 50;360 50 50" dur="1.2222222222222223s" repeatCount="indefinite" type="rotate" attributeName="transform"></animateTransform>
      </circle></g></svg>`,t.type==="fullscreen"?s.classList.add("fullscreen"):s.classList.add("small"),super({element:s})}setMap(e){super.setMap(e),e&&(e.on("loadstart",()=>{this.getElement().style.visibility="visible"}),e.on("loadend",()=>{this.getElement().style.visibility="hidden"}))}getElement(){return this.element}}const availableControls={Zoom,Rotate,ScaleLine,FullScreen,ZoomSlider,Attribution,OverviewMap,ZoomToExtent,MousePosition,Geolocation:GeolocationControl,LoadingIndicator:LoadingIndicatorControl};function addOrUpdateControl(l,e,t,s){e&&e[t]?serialize(e[t])!==serialize(s)&&(l.removeControl(t),addControl(l,t,s)):addControl(l,t,s)}function addControl(l,e,t){const s=Object.assign({},t);t&&t.layers&&(s.layers=generateLayers(l,t.layers));const n=new availableControls[e](s);l.map.addControl(n),l.mapControls[e]=n}function setCenterMethod(l,e){let t;const s=(l==null?void 0:l.length)&&coordinatesRoughlyEquals(l,e.map.getView().getCenter());return l&&!s&&(!e.projection||e.projection==="EPSG:3857"?t=getCenterFromProperty(l):t=l),t}function setZoomExtentMethod(l,e){if(!l||!l.length)return;const t=e.map.getView();return cancelAnimation(t),setTimeout(()=>t.fit(l,e.animationOptions),0),l}function setControlsMethod(l,e,t){const s=l;if(e){const n=Object.keys(e),o=Object.keys(s);for(let a=0,h=n.length;a<h;a++){const c=n[a];o.includes(c)||t.removeControl(c)}}if(s){const n=Object.keys(l);for(let o=0,a=n.length;o<a;o++){const h=n[o];addOrUpdateControl(t,e,h,l[h])}}return s}function setLayersMethod(layers,oldLayers,EOxMap){const newLayers=eval("("+serialize(layers)+")");oldLayers&&oldLayers.forEach(l=>{var e,t;if(!((e=l.properties)!=null&&e.id)||!newLayers.find(s=>s.properties.id===l.properties.id)){const s=getLayerById(EOxMap,(t=l.properties)==null?void 0:t.id),o=s.get("_jsonDefinition").interactions;o==null||o.forEach(a=>{a.type==="select"?EOxMap.removeSelect(a.options.id):EOxMap.removeInteraction(a.options.id)}),EOxMap.map.removeLayer(s)}}),newLayers.forEach(l=>{EOxMap.addOrUpdateLayer(l)});const sortedIds=newLayers.map(l=>{var e;return(e=l.properties)==null?void 0:e.id});EOxMap.map.getLayers().getArray().sort((l,e)=>sortedIds.indexOf(l.get("id"))-sortedIds.indexOf(e.get("id")));let minMax=EOxMap.map.getLayers().getArray().reduce((l,e)=>{var t,s,n,o,a,h,c,d;return l.maxZoom=(s=(t=EOxMap.config)==null?void 0:t.view)!=null&&s.maxZoom?(o=(n=EOxMap.config)==null?void 0:n.view)==null?void 0:o.maxZoom:l.maxZoom===void 0||e.get("maxZoom")<l.maxZoom?e.get("maxZoom"):l.maxZoom,l.minZoom=(h=(a=EOxMap.config)==null?void 0:a.view)!=null&&h.minZoom?(d=(c=EOxMap.config)==null?void 0:c.view)==null?void 0:d.minZoom:l.minZoom===void 0||e.get("minZoom")>l.minZoom?e.get("minZoom"):l.minZoom,l},{minZoom:0,maxZoom:1/0});EOxMap.map.getLayers().getArray().map(l=>l.setMinZoom(l.get("minZoom")-1e-12));const currentMinZoom=EOxMap.map.getView().getMinZoom(),currentMaxZoom=EOxMap.map.getView().getMaxZoom();return currentMinZoom!==minMax.minZoom&&EOxMap.map.getView().setMinZoom(minMax.minZoom>=0?minMax.minZoom:0),currentMaxZoom!==minMax.maxZoom&&EOxMap.map.getView().setMaxZoom(minMax.maxZoom),EOxMap.map.on("moveend",()=>{var t;if(!((t=EOxMap==null?void 0:EOxMap.controls)!=null&&t.Zoom))return;const l=EOxMap.renderRoot.querySelector("button.ol-zoom-out"),e=EOxMap.renderRoot.querySelector("button.ol-zoom-in");EOxMap.map.getView().getZoom()>=minMax.maxZoom?e==null||e.classList.add("disabled"):e==null||e.classList.remove("disabled"),EOxMap.map.getView().getZoom()-1e-12<=minMax.minZoom?l==null||l.classList.add("disabled"):l==null||l.classList.remove("disabled")}),newLayers}function setPreventScrollMethod(l,e){return l?(removeDefaultScrollInteractions(e.map),addScrollInteractions(e.map,!0)):addScrollInteractions(e.map),l}function setConfigMethod(l,e){var t,s,n,o,a,h,c,d;return Object.assign(e,{...(l==null?void 0:l.animationOptions)!==void 0?{animationOptions:l.animationOptions}:{},projection:((t=l==null?void 0:l.view)==null?void 0:t.projection)||"EPSG:3857",layers:(l==null?void 0:l.layers)||[],controls:(l==null?void 0:l.controls)||{},...(l==null?void 0:l.preventScroll)!==void 0&&e.preventScroll===void 0?{preventScroll:l==null?void 0:l.preventScroll}:{},zoom:((s=l==null?void 0:l.view)==null?void 0:s.zoom)||0,center:((n=l==null?void 0:l.view)==null?void 0:n.center)||[0,0],zoomExtent:(o=l==null?void 0:l.view)==null?void 0:o.zoomExtent}),(a=l==null?void 0:l.view)!=null&&a.minZoom&&e.map.getView().setMinZoom((h=l==null?void 0:l.view)==null?void 0:h.minZoom),(c=l==null?void 0:l.view)!=null&&c.maxZoom&&e.map.getView().setMaxZoom((d=l==null?void 0:l.view)==null?void 0:d.maxZoom),l}function setProjectionMethod(l,e,t){let s=e;const n=t.map.getView();if(l&&get(l)&&l!==n.getProjection().getCode()){const o=transform$1(n.getCenter(),n.getProjection().getCode(),l),a=get(l),h=n.getResolution(),c=n.getProjection().getMetersPerUnit(),d=a.getMetersPerUnit(),u=getPointResolution(n.getProjection(),1/c,n.getCenter(),"m")*c,_=getPointResolution(a,1/d,o,"m")*d,f=h*u/_,v=new View({zoom:n.getZoom(),center:o,resolution:f,rotation:n.getRotation(),projection:l});["change:center","change:resolution","change:rotation","propertychange"].forEach(y=>{const p=n.getListeners(y);if(p!=null&&p.length)for(let x=p.length-1;x>=0;x--){const T=p[x];n.un(y,T),v.on(y,T)}}),t.map.setView(v),t.getFlatLayersArray(t.map.getLayers().getArray()).filter(y=>y instanceof VectorLayer).forEach(y=>y.getSource().refresh()),s=l,t.center=o}return s}function setSyncMethod(l,e){return l&&setTimeout(()=>{const t=getElement(l);t&&(e.clientHeight<1&&!t.zoom?t.map.setView(e.map.getView()):e.map.setView(t.map.getView()))}),l}function getLonLatCenterMethod(l){var e;if(l.projection==="globe"){const t=(e=l.globe)==null?void 0:e.planet.camera.getLonLat();return[(t==null?void 0:t.lon)??0,(t==null?void 0:t.lat)??0]}return l.projection==="EPSG:4326"?l.map.getView().getCenter():transform(l.map.getView().getCenter(),l.projection)}function getLonLatExtentMethod(l){var t;if(l.projection==="globe"){const s=(t=l.globe)==null?void 0:t.planet.camera.getLonLat();if(!s||typeof s.height>"u")return[-180,-90,180,90];const n=Math.log2(2705e4/s.height)+1,o=[s.lon,s.lat],a=new View({zoom:n,center:transform(o,"EPSG:4326",l.projection),projection:l.projection});return a.setCenter(transform(o,"EPSG:4326",l.projection)),transformExtent(a.calculateExtent(l.map.getSize()),l.projection)}const e=l.map.getView().calculateExtent(l.map.getSize());return l.projection==="EPSG:4326"?e:transformExtent(e,l.projection)}function getZoomExtentMethod(l){return l.map.getView().calculateExtent(l.map.getSize())}function addOrUpdateLayerMethod(l,e){var o;l.interactions||(l.interactions=[]);const t=(o=l.properties)==null?void 0:o.id,s=t?getLayerById(e,t):!1;let n;return s?(updateLayer(e,l,s),n=s):(n=createLayer(e,l),e.map.addLayer(n)),n}function removeInteractionMethod(l,e){e.map.removeInteraction(e.interactions[l]),delete e.interactions[l],e.interactions[`${l}_modify`]&&(e.map.removeInteraction(e.interactions[`${l}_modify`]),delete e.interactions[`${l}_modify`])}function removeSelectMethod(l,e){e.selectInteractions[l].remove(),delete e.selectInteractions[l]}function removeControlMethod(l,e){e.map.removeControl(e.mapControls[l]),delete e.mapControls[l]}function firstUpdatedMethod(l,e){e.map.once("change:target",s=>{s.target.getView().setCenter(e.center)});const t=e.renderRoot.querySelector("div#map");e.map.setTarget(t),l?e.map.getView().fit(l,e.animationOptions):animateToStateMethod(e),e.map.on("loadend",()=>{e.dispatchEvent(new CustomEvent("loadend",{detail:e.map}))}),e.dispatchEvent(new CustomEvent("mapmounted",{detail:e.map}))}const Wi=2*Math.PI,go=Math.PI/2,sr=Number.MAX_VALUE||17976931348623157e292,_n=Math.log(2),Ee=2147483647,yt=549755748352,Tt=-549755748352,U=Math.PI/180,Q=180/Math.PI,Hr=2*Q,ie=.5*U,po=Math.sqrt(.5),mo=1e-5,re=1e-10,rr=1e-12,nr=1e-14;function $i(l,e,t){return Math.max(e,Math.min(l,t))}function Xi(l){return!(l&l-1)}function Ye(l,e=4096){--l;for(let t=1;t<32;t<<=1)l|=l>>t;return l+1>e?e:l+1}function Oi(l=0,e=1){return Math.floor(Math.random()*(e-l))+l}function vo(l,e){return(l%e+e)%e}function Ve(l){const e=vo(l,Wi);return Math.abs(e)<nr&&Math.abs(l)>nr?Wi:e}function ei(l){const e=Math.abs(l);return e-Math.floor(e)}function yo(l,e,t){return t+l*(e-t)}function Os(l){return l*l*l}function Ns(l){return l*l}function or(l){return l-360*Math.floor(l/360)}Object.freeze(Object.defineProperty({__proto__:null,ARCSECONDS_TO_RADIANS:484813681109536e-20,DEG2RAD:function(l){return l*U},DEGREES:Q,DEGREES_DOUBLE:Hr,DEGREES_TO_HOURS:1/15,EPS1:.1,EPS10:re,EPS11:1e-11,EPS12:rr,EPS13:1e-13,EPS14:nr,EPS15:1e-15,EPS16:1e-16,EPS17:1e-17,EPS18:1e-18,EPS19:1e-19,EPS2:.01,EPS20:1e-20,EPS3:.001,EPS4:1e-4,EPS5:mo,EPS6:1e-6,EPS7:1e-7,EPS8:1e-8,EPS9:1e-9,HOURS_TO_DEGREES:15,HOURS_TO_RADIANS:.26179938779914946,LOG2:_n,MAX:yt,MAX32:Ee,MAX_FLOAT:sr,MIN:Tt,PI_TWO:go,RAD2DEG:function(l){return l*Q},RADIANS:U,RADIANS_HALF:ie,RADIANS_TO_HOURS:3.819718634205488,SQRT_HALF:po,TWO_PI:Wi,W:3,X:0,Y:1,Z:2,bezier1v:function(l,e,t,s,n){return Os(1-l)*e+3*Ns(1-l)*l*t+3*(1-l)*Ns(l)*s+Os(l)*n},bezier3v:function(l,e,t,s,n){let o=1-l,a=l*l,h=o*o,c=h*o,d=a*l;return e.scaleTo(c).addA(t.scaleTo(3*h*l)).addA(s.scaleTo(3*o*a)).addA(n.scaleTo(d))},clamp:$i,cube:Os,degToDec:function(l,e,t,s){return s?l+e/60+t/3600:-l-e/60-t/3600},exp2:function(l){return Math.pow(2,l)},frac:ei,getAngleBetweenAzimuths:function(l,e){return(((l=Ve(l))-(e=Ve(e)))%360+360+180)%360-180},isPowerOfTwo:Xi,lerp:yo,log:function(l,e){return Math.log(l)/Math.log(e)},log2:function(l){return Math.log(l)/_n},mod:vo,negativePItoPI:function(l){return Ve(l+Math.PI)-Math.PI},nextHighestPowerOfTwo:Ye,norm_lon:function(l){return l>180?(l+180)%360-180:l<-180?(l-180)%360+180:l},pow2i:function(l){return 2<<l-1},random:function(l=0,e=1){return Math.random()*(e-l)+l},randomi:Oi,rev:or,slice:function(l,e,t){return l*(e-t)},solve_iteration:function(l,e,t,s=50){let n=0,o=e;for(let a=0;a<s;a++)if(n=o,o=l(n),Math.abs(o-n)<t)return o;return o},solve_iteration_fixed:function(l,e,t){let s=0,n=e;for(let o=0;o<t;o++)s=n,n=l(s);return n},square:Ns,step:function(l,e){return e<l?0:1},zeroTwoPI:Ve},Symbol.toStringTag,{value:"Module"}));const Ra=.5*Math.PI,xo=180/Math.PI,Ma=2*xo,Hs=Math.PI/360,Ba=xo*Ra;class A{constructor(e=0,t=0,s=0){this.lon=0,this.lat=0,this.height=0,this.lon=e,this.lat=t,this.height=s}isZero(){return this.lon===0&&this.lat===0&&this.height===0}static join(e){let t=[];for(let s=0;s<e.length;s++){let n=e[s];t[s]=new A(n[0],n[1],n[2])}return t}static createFromArray(e){return new A(e[0],e[1],e[2])}static toArray(e){return[e.lon,e.lat,e.height]}toArray(){return A.toArray(this)}static forwardMercator(e,t,s){return new A(e*Ni,Math.log(Math.tan((90+t)*Hs))*qe,s)}static forwardMercatorRes(e,t){return t.lon=e.lon*Ni,t.lat=Math.log(Math.tan((90+e.lat)*Hs))*qe,t.height=e.height,t}static inverseMercator(e,t,s=0){return new A(e*bo,Ma*Math.atan(Math.exp(t*Vr))-Ba,s)}set(e=0,t=0,s=0){return this.lon=e,this.lat=t,this.height=s,this}copy(e){return this.lon=e.lon,this.lat=e.lat,this.height=e.height,this}clone(){return new A(this.lon,this.lat,this.height)}forwardMercator(){return A.forwardMercator(this.lon,this.lat,this.height)}forwardMercatorEPS01(){let e=this.lat;return e>89.9?e=89.9:e<-89.9&&(e=-89.9),new A(this.lon*Ni,Math.log(Math.tan((90+e)*Hs))*qe)}inverseMercator(){return A.inverseMercator(this.lon,this.lat,this.height)}equal(e){return e.height?this.lon===e.lon&&this.lat===e.lat&&this.height===e.height:this.lon===e.lon&&this.lat===e.lat}}const At=2003750834e-2,Zi=2*At,Vr=Math.PI/At,qe=At/Math.PI,ka=.5*Math.PI,Ni=At/180,bo=180/At,wo=Math.PI/360,fn=Math.PI/180,Ia=180/Math.PI,To=2*At,ii=1/To;function Ki(l){return new A(l.lon*At/180,Math.log(Math.tan((90+l.lat)*wo))*qe,l.height)}function si(l){return l*At/180}function ri(l){return Math.log(Math.tan((90+l)*wo))*qe}function Co(l){return Ia*(2*Math.atan(Math.exp(l*Vr))-ka)}function $e(l,e,t){let s=Zi/(1<<t),n=new A(l*s-2003750834e-2,At-e*s-s);return new H(n,new A(n.lon+s,n.lat+s))}const ht=Co(At),Ft=-ht;Object.freeze(Object.defineProperty({__proto__:null,INV_POLE_BY_180:bo,MAX_LAT:ht,MIN_LAT:Ft,ONE_BY_POLE_DOUBLE:ii,PI_BY_POLE:Vr,POLE:At,POLE2:Zi,POLE_BY_180:Ni,POLE_BY_PI:qe,POLE_DOUBLE:To,forward:Ki,forwardArray:function(l){let e=[];for(let t=0;t<l.length;t++)e.push(l[t].forwardMercator());return e},forward_lat:ri,forward_lon:si,getTileExtent:$e,getTileX:function(l,e){return Math.floor((l+180)/360*Math.pow(2,e))},getTileY:function(l,e){return Math.floor(.5*(1-Math.log(Math.tan(l*fn)+1/Math.cos(l*fn))/Math.PI)*Math.pow(2,e))},inverse_lat:Co,inverse_lon:function(l){return 180*l/At}},Symbol.toStringTag,{value:"Module"}));class H{constructor(e=new A,t=new A){this.southWest=e,this.northEast=t}static createFromArray(e){return new H(new A(e[0],e[1]),new A(e[2],e[3]))}static createByCoordinates(e){let t=yt,s=Tt,n=yt,o=Tt;for(let a=0;a<e.length;a++){const h=e[a];h.lon<t&&(t=h.lon),h.lon>s&&(s=h.lon),h.lat<n&&(n=h.lat),h.lat>o&&(o=h.lat)}return new H(new A(t,n),new A(s,o))}static createByCoordinatesArr(e){let t=yt,s=Tt,n=yt,o=Tt;for(let a=0;a<e.length;a++){const h=e[a];h[0]<t&&(t=h[0]),h[0]>s&&(s=h[0]),h[1]<n&&(n=h[1]),h[1]>o&&(o=h[1])}return new H(new A(t,n),new A(s,o))}static fromTile(e,t,s,n=4007501668e-2,o=4007501668e-2){const a=1<<s,h=n/a,c=o/a,d=.5*-n+e*h,u=.5*o-t*c,_=d+h;return new H(new A(d,u-c),new A(_,u))}setByCoordinates(e){let t=yt,s=Tt,n=yt,o=Tt;for(let a=0;a<e.length;a++){const h=e[a];h.lon<t&&(t=h.lon),h.lon>s&&(s=h.lon),h.lat<n&&(n=h.lat),h.lat>o&&(o=h.lat)}return this.southWest.lon=t,this.southWest.lat=n,this.northEast.lon=s,this.northEast.lat=o,this}isInside(e){const t=this.southWest,s=this.northEast;return e.lon>=t.lon&&e.lon<=s.lon&&e.lat>=t.lat&&e.lat<=s.lat}overlaps(e){const t=this.southWest,s=this.northEast;return t.lon<=e.northEast.lon&&s.lon>=e.southWest.lon&&t.lat<=e.northEast.lat&&s.lat>=e.southWest.lat}getWidth(){return this.northEast.lon-this.southWest.lon}getHeight(){return this.northEast.lat-this.southWest.lat}clone(){return new H(this.southWest.clone(),this.northEast.clone())}getCenter(){const e=this.southWest,t=this.northEast;return new A(e.lon+.5*(t.lon-e.lon),e.lat+.5*(t.lat-e.lat))}getNorthWest(){return new A(this.southWest.lon,this.northEast.lat)}getNorthEast(){return new A(this.northEast.lon,this.northEast.lat)}getSouthWest(){return new A(this.southWest.lon,this.southWest.lat)}getSouthEast(){return new A(this.northEast.lon,this.southWest.lat)}getNorth(){return this.northEast.lat}getEast(){return this.northEast.lon}getWest(){return this.southWest.lon}getSouth(){return this.southWest.lat}equals(e){return this.southWest.lon===e.southWest.lon&&this.southWest.lat===e.southWest.lat&&this.northEast.lon===e.northEast.lon&&this.northEast.lat===e.northEast.lat}forwardMercator(){return new H(this.southWest.forwardMercator(),this.northEast.forwardMercator())}inverseMercator(){return new H(this.southWest.inverseMercator(),this.northEast.inverseMercator())}getCartesianBounds(e){let t=yt,s=Tt,n=yt,o=Tt,a=yt,h=Tt;const c=[new A(this.southWest.lon,this.southWest.lat),new A(this.southWest.lon,this.northEast.lat),new A(this.northEast.lon,this.northEast.lat),new A(this.northEast.lon,this.southWest.lat)];for(let d=0;d<c.length;d++){const u=e.lonLatToCartesian(c[d]),_=u.x,f=u.y,v=u.z;_<t&&(t=_),_>s&&(s=_),f<n&&(n=f),f>o&&(o=f),v<a&&(a=v),v>h&&(h=v)}return[t,n,a,s,o,h]}toString(){return`[${this.southWest.lon.toFixed(5)}, ${this.southWest.lat.toFixed(5)}, ${this.northEast.lon.toFixed(5)}, ${this.northEast.lat.toFixed(5)}]`}}class Pe{constructor(){this._m=[0,0,0,0,0,0,0,0,0]}set(e){return this._m[0]=e[0],this._m[1]=e[1],this._m[2]=e[2],this._m[3]=e[3],this._m[4]=e[4],this._m[5]=e[5],this._m[6]=e[6],this._m[7]=e[7],this._m[8]=e[8],this}clone(){let e=new Pe;return e.set(this._m),e}copy(e){return this.set(e._m)}transposeTo(){let e=new Pe,t=this._m;return e._m[0]=t[0],e._m[1]=t[3],e._m[2]=t[6],e._m[3]=t[1],e._m[4]=t[4],e._m[5]=t[7],e._m[6]=t[2],e._m[7]=t[5],e._m[8]=t[8],e}setIdentity(){return this._m[0]=1,this._m[1]=0,this._m[2]=0,this._m[3]=0,this._m[4]=1,this._m[5]=0,this._m[6]=0,this._m[7]=0,this._m[8]=1,this}mulVec(e){let t=e.x,s=e.y,n=e.z,o=this._m;return new m(o[0]*t+o[3]*s+o[6]*n,o[1]*t+o[4]*s+o[7]*n,o[2]*t+o[5]*s+o[8]*n)}getMat4(){let e=new st,t=e._m,s=this._m;return t[0]=s[0],t[1]=s[1],t[2]=s[2],t[3]=0,t[4]=s[3],t[5]=s[4],t[6]=s[5],t[7]=0,t[8]=s[6],t[9]=s[7],t[10]=s[8],t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,e}}class J{constructor(e=0,t=0,s=0,n=0){this.x=e,this.y=t,this.z=s,this.w=n}static get identity(){return new J(0,0,0,1)}static fromVec(e){return new J(e[0],e[1],e[2],e[3])}toVec3(){return new m(this.x,this.y,this.z)}clone(){return new J(this.x,this.y,this.z,this.w)}equal(e){return this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this}toArray(){return[this.x,this.y,this.z,this.w]}toArray3(){return[this.x,this.y,this.z]}set(e,t,s,n){return this.x=e,this.y=t,this.z=s,this.w=n,this}addA(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this}subA(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this}scale(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this}affinity(){let e=1/this.w;return this.x*=e,this.y*=e,this.z*=e,this.w=1,this}scaleTo(e){return new J(this.x*e,this.y*e,this.z*e,this.w*e)}getStep(e){return new J(this.x<e?0:1,this.y<e?0:1,this.z<e?0:1,this.w<e?0:1)}getFrac(e){return new J(ei(e.x),ei(e.y),ei(e.z),ei(e.w))}dot(e){return e.x*this.x+e.y*this.y+e.z*this.z+e.w*this.w}isZero(){return!(this.x||this.y||this.z||this.w)}}class st{constructor(){this._m=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]}static identity(){let e=new st;return e._m[0]=1,e._m[1]=0,e._m[2]=0,e._m[3]=0,e._m[4]=0,e._m[5]=1,e._m[6]=0,e._m[7]=0,e._m[8]=0,e._m[9]=0,e._m[10]=1,e._m[11]=0,e._m[12]=0,e._m[13]=0,e._m[14]=0,e._m[15]=1,e}static getRotationAroundPoint(e,t=m.ZERO,s=m.UP){let n=st.getRotation(e,s),o=new st().setIdentity().translate(t),a=new st().setIdentity().translate(t.negateTo());return o.mul(n).mul(a)}static getRotation(e,t=m.UP){return new st().setRotation(t,e)}getPosition(){return new m(this._m[12],this._m[13],this._m[14])}getScaling(){let e=this._m[0],t=this._m[1],s=this._m[2],n=this._m[4],o=this._m[5],a=this._m[6],h=this._m[8],c=this._m[9],d=this._m[10];return new m(Math.sqrt(e*e+t*t+s*s),Math.sqrt(n*n+o*o+a*a),Math.sqrt(h*h+c*c+d*d))}getQuat(){let e=this.getScaling();const t=[0,0,0,1];let s=1/e.x,n=1/e.y,o=1/e.z,a=this._m[0]*s,h=this._m[1]*n,c=this._m[2]*o,d=this._m[4]*s,u=this._m[5]*n,_=this._m[6]*o,f=this._m[8]*s,v=this._m[9]*n,g=this._m[10]*o,y=a+u+g,p=0;return y>0?(p=2*Math.sqrt(y+1),t[3]=.25*p,t[0]=(_-v)/p,t[1]=(f-c)/p,t[2]=(h-d)/p):a>u&&a>g?(p=2*Math.sqrt(1+a-u-g),t[3]=(_-v)/p,t[0]=.25*p,t[1]=(h+d)/p,t[2]=(f+c)/p):u>g?(p=2*Math.sqrt(1+u-a-g),t[3]=(f-c)/p,t[0]=(h+d)/p,t[1]=.25*p,t[2]=(_+v)/p):(p=2*Math.sqrt(1+g-a-u),t[3]=(h-d)/p,t[0]=(f+c)/p,t[1]=(_+v)/p,t[2]=.25*p),new D(...t)}set(e){return this._m[0]=e[0],this._m[1]=e[1],this._m[2]=e[2],this._m[3]=e[3],this._m[4]=e[4],this._m[5]=e[5],this._m[6]=e[6],this._m[7]=e[7],this._m[8]=e[8],this._m[9]=e[9],this._m[10]=e[10],this._m[11]=e[11],this._m[12]=e[12],this._m[13]=e[13],this._m[14]=e[14],this._m[15]=e[15],this}clone(){let e=new st;return e.set(this._m),e}copy(e){return this.set(e._m)}getMat3(){let e=new Pe,t=this._m,s=e._m;return s[0]=t[0],s[1]=t[1],s[2]=t[2],s[3]=t[4],s[4]=t[5],s[5]=t[6],s[6]=t[8],s[7]=t[9],s[8]=t[10],e}mulVec3(e){let t=e.x,s=e.y,n=e.z;return new m(this._m[0]*t+this._m[4]*s+this._m[8]*n+this._m[12],this._m[1]*t+this._m[5]*s+this._m[9]*n+this._m[13],this._m[2]*t+this._m[6]*s+this._m[10]*n+this._m[14])}mulVec4(e){let t=e.x,s=e.y,n=e.z,o=e.w;return new J(this._m[0]*t+this._m[4]*s+this._m[8]*n+this._m[12]*o,this._m[1]*t+this._m[5]*s+this._m[9]*n+this._m[13]*o,this._m[2]*t+this._m[6]*s+this._m[10]*n+this._m[14]*o,this._m[3]*t+this._m[7]*s+this._m[11]*n+this._m[15]*o)}toInverseMatrix3(){let e=this._m,t=e[0],s=e[1],n=e[2],o=e[4],a=e[5],h=e[6],c=e[8],d=e[9],u=e[10],_=u*a-h*d,f=-u*o+h*c,v=d*o-a*c,g=t*_+s*f+n*v;if(!g)return;g=1/g;let y=new Pe;return y._m[0]=_*g,y._m[1]=(-u*s+n*d)*g,y._m[2]=(h*s-n*a)*g,y._m[3]=f*g,y._m[4]=(u*t-n*c)*g,y._m[5]=(-h*t+n*o)*g,y._m[6]=v*g,y._m[7]=(-d*t+s*c)*g,y._m[8]=(a*t-s*o)*g,y}inverseTo(e=new st){let t=this._m[0],s=this._m[1],n=this._m[2],o=this._m[3],a=this._m[4],h=this._m[5],c=this._m[6],d=this._m[7],u=this._m[8],_=this._m[9],f=this._m[10],v=this._m[11],g=this._m[12],y=this._m[13],p=this._m[14],x=this._m[15],T=t*h-s*a,w=t*c-n*a,C=t*d-o*a,E=s*c-n*h,L=s*d-o*h,S=n*d-o*c,P=u*y-_*g,R=u*p-f*g,M=u*x-v*g,B=_*p-f*y,z=_*x-v*y,ue=f*x-v*p,I=1/(T*ue-w*z+C*B+E*M-L*R+S*P);return e._m[0]=(h*ue-c*z+d*B)*I,e._m[1]=(-s*ue+n*z-o*B)*I,e._m[2]=(y*S-p*L+x*E)*I,e._m[3]=(-_*S+f*L-v*E)*I,e._m[4]=(-a*ue+c*M-d*R)*I,e._m[5]=(t*ue-n*M+o*R)*I,e._m[6]=(-g*S+p*C-x*w)*I,e._m[7]=(u*S-f*C+v*w)*I,e._m[8]=(a*z-h*M+d*P)*I,e._m[9]=(-t*z+s*M-o*P)*I,e._m[10]=(g*L-y*C+x*T)*I,e._m[11]=(-u*L+_*C-v*T)*I,e._m[12]=(-a*B+h*R-c*P)*I,e._m[13]=(t*B-s*R+n*P)*I,e._m[14]=(-g*E+y*w-p*T)*I,e._m[15]=(u*E-_*w+f*T)*I,e}transposeTo(){let e=new st;return e._m[0]=this._m[0],e._m[1]=this._m[4],e._m[2]=this._m[8],e._m[3]=this._m[12],e._m[4]=this._m[1],e._m[5]=this._m[5],e._m[6]=this._m[9],e._m[7]=this._m[13],e._m[8]=this._m[2],e._m[9]=this._m[6],e._m[10]=this._m[10],e._m[11]=this._m[14],e._m[12]=this._m[3],e._m[13]=this._m[7],e._m[14]=this._m[11],e._m[15]=this._m[15],e}setIdentity(){return this._m[0]=1,this._m[1]=0,this._m[2]=0,this._m[3]=0,this._m[4]=0,this._m[5]=1,this._m[6]=0,this._m[7]=0,this._m[8]=0,this._m[9]=0,this._m[10]=1,this._m[11]=0,this._m[12]=0,this._m[13]=0,this._m[14]=0,this._m[15]=1,this}mul(e){let t=this._m[0],s=this._m[1],n=this._m[2],o=this._m[3],a=this._m[4],h=this._m[5],c=this._m[6],d=this._m[7],u=this._m[8],_=this._m[9],f=this._m[10],v=this._m[11],g=this._m[12],y=this._m[13],p=this._m[14],x=this._m[15],T=e._m[0],w=e._m[1],C=e._m[2],E=e._m[3],L=e._m[4],S=e._m[5],P=e._m[6],R=e._m[7],M=e._m[8],B=e._m[9],z=e._m[10],ue=e._m[11],I=e._m[12],se=e._m[13],G=e._m[14],k=e._m[15],F=new st;return F._m[0]=T*t+w*a+C*u+E*g,F._m[1]=T*s+w*h+C*_+E*y,F._m[2]=T*n+w*c+C*f+E*p,F._m[3]=T*o+w*d+C*v+E*x,F._m[4]=L*t+S*a+P*u+R*g,F._m[5]=L*s+S*h+P*_+R*y,F._m[6]=L*n+S*c+P*f+R*p,F._m[7]=L*o+S*d+P*v+R*x,F._m[8]=M*t+B*a+z*u+ue*g,F._m[9]=M*s+B*h+z*_+ue*y,F._m[10]=M*n+B*c+z*f+ue*p,F._m[11]=M*o+B*d+z*v+ue*x,F._m[12]=I*t+se*a+G*u+k*g,F._m[13]=I*s+se*h+G*_+k*y,F._m[14]=I*n+se*c+G*f+k*p,F._m[15]=I*o+se*d+G*v+k*x,F}translate(e){let t=e.x,s=e.y,n=e.z,o=this._m;return o[12]=o[0]*t+o[4]*s+o[8]*n+o[12],o[13]=o[1]*t+o[5]*s+o[9]*n+o[13],o[14]=o[2]*t+o[6]*s+o[10]*n+o[14],o[15]=o[3]*t+o[7]*s+o[11]*n+o[15],this}translateToPosition(e){let t=this._m;return t[12]=e.x,t[13]=e.y,t[14]=e.z,this}rotate(e,t){let s=Math.cos(t),n=Math.sin(t),o=new st,a=o._m;return a[0]=s+(1-s)*e.x*e.x,a[1]=(1-s)*e.y*e.x-n*e.z,a[2]=(1-s)*e.z*e.x+n*e.y,a[3]=0,a[4]=(1-s)*e.x*e.y+n*e.z,a[5]=s+(1-s)*e.y*e.y,a[6]=(1-s)*e.z*e.y-n*e.x,a[7]=0,a[8]=(1-s)*e.x*e.z-n*e.y,a[9]=(1-s)*e.y*e.z+n*e.x,a[10]=s+(1-s)*e.z*e.z,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,this.mul(o)}setRotation(e,t){let s=Math.cos(t),n=Math.sin(t),o=this._m;return o[0]=s+(1-s)*e.x*e.x,o[1]=(1-s)*e.y*e.x-n*e.z,o[2]=(1-s)*e.z*e.x+n*e.y,o[3]=0,o[4]=(1-s)*e.x*e.y+n*e.z,o[5]=s+(1-s)*e.y*e.y,o[6]=(1-s)*e.z*e.y-n*e.x,o[7]=0,o[8]=(1-s)*e.x*e.z-n*e.y,o[9]=(1-s)*e.y*e.z+n*e.x,o[10]=s+(1-s)*e.z*e.z,o[11]=0,o[12]=0,o[13]=0,o[14]=0,o[15]=1,this}rotateBetweenVectors(e,t){return D.getRotationBetweenVectors(e,t).getMat4()}scale(e){let t=this._m;return t[0]=t[0]*e.x,t[1]=t[1]*e.x,t[2]=t[2]*e.x,t[3]=t[3]*e.x,t[4]=t[4]*e.y,t[5]=t[5]*e.y,t[6]=t[6]*e.y,t[7]=t[7]*e.y,t[8]=t[8]*e.z,t[9]=t[9]*e.z,t[10]=t[10]*e.z,t[11]=t[11]*e.z,this}setPerspective(e,t,s,n,o,a){let h=t-e,c=n-s,d=o-a,u=2*o,_=this._m;return _[0]=u/h,_[1]=0,_[2]=0,_[3]=0,_[4]=0,_[5]=u/c,_[6]=0,_[7]=0,_[8]=(t+e)/h,_[9]=(n+s)/c,_[10]=(a+o)/d,_[11]=-1,_[12]=0,_[13]=0,_[14]=u*a/d,_[15]=0,this}setOrthographic(e,t,s,n,o,a){let h=1/(e-t),c=1/(s-n),d=1/(o-a),u=this._m;return u[0]=-2*h,u[1]=0,u[2]=0,u[3]=0,u[4]=0,u[5]=-2*c,u[6]=0,u[7]=0,u[8]=0,u[9]=0,u[10]=2*d,u[11]=0,u[12]=(e+t)*h,u[13]=(n+s)*c,u[14]=(a+o)*d,u[15]=1,this}eulerToMatrix(e,t,s){let n=Math.cos(e),o=Math.sin(e),a=Math.cos(t),h=Math.sin(t),c=Math.cos(s),d=Math.sin(s),u=n*h,_=o*h,f=this._m;return f[0]=a*c,f[1]=-a*d,f[2]=-h,f[4]=-_*c+n*d,f[5]=_*d+n*c,f[6]=-o*a,f[8]=u*c+o*d,f[9]=-u*d+o*c,f[10]=n*a,f[3]=f[7]=f[11]=f[12]=f[13]=f[14]=0,f[15]=1,this}}class D{constructor(e=0,t=0,s=0,n=0){this.x=e,this.y=t,this.z=s,this.w=n}static get IDENTITY(){return new D(0,0,0,1)}static xRotation(e){return e*=.5,new D(Math.sin(e),0,0,Math.cos(e))}static yRotation(e){return e*=.5,new D(0,Math.sin(e),0,Math.cos(e))}static zRotation(e){return e*=.5,new D(0,0,Math.sin(e),Math.cos(e))}static axisAngleToQuat(e,t=0){let s=e.getNormal(),n=.5*t,o=Math.sin(n);return new D(s.x*o,s.y*o,s.z*o,Math.cos(n))}static getLookRotation(e,t){let s=e.getNormal().negate(),n=t.cross(s).normalize(),o=s.cross(n),a=1+n.x+o.y+s.z;if(a>1e-6){let c=1/(2*Math.sqrt(a));return new D((s.y-o.z)*c,(n.z-s.x)*c,(o.x-n.y)*c,.25/c)}if(n.x>o.y&&n.x>s.z){let c=1/(2*Math.sqrt(1+n.x-o.y-s.z));return new D(.25/c,(o.x+n.y)*c,(n.z+s.x)*c,(s.y-o.z)*c)}if(o.y>s.z){let c=1/(2*Math.sqrt(1+o.y-n.x-s.z));return new D((o.x+n.y)*c,.25/c,(s.y+o.z)*c,(n.z-s.x)*c)}let h=1/(2*Math.sqrt(1+s.z-n.x-o.y));return new D((n.z+s.x)*h,(s.y+o.z)*h,.25/h,(o.x-n.y)*h)}static getLookAtSourceDest(e,t){let s=t.subA(e).normalize(),n=m.FORWARD.dot(s);if(Math.abs(n- -1)<1e-6)return D.axisAngleToQuat(m.UP,Math.PI);if(Math.abs(n-1)<1e-6)return new D(0,0,0,1);let o=Math.acos(n),a=m.FORWARD.cross(s).normalize();return D.axisAngleToQuat(a,o)}static getRotationBetweenVectors(e,t){let s=e.cross(t);return new D(s.x,s.y,s.z,1+e.dot(t)).normalize()}static getRotationBetweenVectorsRes(e,t,s){let n=e.cross(t);return s.set(n.x,n.y,n.z,1+e.dot(t)),s.normalize()}static getRotationBetweenVectorsUp(e,t,s){let n=e.dot(t);if(Math.abs(n+1)<1e-6)return D.axisAngleToQuat(s,Math.PI);if(Math.abs(n-1)<1e-6)return new D(0,0,0,1);let o=Math.acos(n),a=e.cross(t).normalize();return D.axisAngleToQuat(a,o)}isZero(){return this.x===0&&this.y===0&&this.z===0&&this.w===0}isNaN(){return isNaN(this.x)||isNaN(this.y)||isNaN(this.z)||isNaN(this.w)}clear(){return this.x=this.y=this.z=this.w=0,this}set(e,t,s,n){return this.x=e,this.y=t,this.z=s,this.w=n,this}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this}setIdentity(){return this.x=0,this.y=0,this.z=0,this.w=1,this}clone(){return new D(this.x,this.y,this.z,this.w)}add(e){return new D(this.x+e.x,this.y+e.y,this.z+e.z,this.w+e.w)}addRes(e,t){return t.set(this.x+e.x,this.y+e.y,this.z+e.z,this.w+e.w)}sub(e){return new D(this.x-e.x,this.y-e.y,this.z-e.z,this.w-e.w)}scaleTo(e){return new D(this.x*e,this.y*e,this.z*e,this.w*e)}scale(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this}toVec(){return[this.x,this.y,this.z,this.w]}get xyz(){return new m(this.x,this.y,this.z)}setLookRotation(e,t){let s=e.getNormal().negate(),n=t.cross(s).normalize(),o=s.cross(n),a=1+n.x+o.y+s.z;if(a>1e-6){let h=1/(2*Math.sqrt(a));this.x=(s.y-o.z)*h,this.y=(n.z-s.x)*h,this.z=(o.x-n.y)*h,this.w=.25/h}else if(n.x>o.y&&n.x>s.z){let h=1/(2*Math.sqrt(1+n.x-o.y-s.z));this.x=.25/h,this.y=(o.x+n.y)*h,this.z=(n.z+s.x)*h,this.w=(s.y-o.z)*h}else if(o.y>s.z){let h=1/(2*Math.sqrt(1+o.y-n.x-s.z));this.x=(o.x+n.y)*h,this.y=.25/h,this.z=(s.y+o.z)*h,this.w=(n.z-s.x)*h}else{let h=1/(2*Math.sqrt(1+s.z-n.x-o.y));this.x=(n.z+s.x)*h,this.y=(s.y+o.z)*h,this.z=.25/h,this.w=(o.x-n.y)*h}return this}setFromSphericalCoords(e,t,s){let n=Math.sin(s/2),o=Math.cos(s/2),a=Math.sin(e),h=Math.cos(e),c=Math.sin(t),d=Math.cos(t);return this.x=n*h*c,this.y=n*a,this.z=n*a*d,this.w=o,this}getSphericalCoords(){let e=this.w,t=Math.sqrt(1-e*e);Math.abs(t)<5e-4&&(t=1);let s,n=this.x/t,o=this.y/t,a=this.z/t,h=-Math.asin(o);return s=n*n+a*a<5e-4?0:Math.atan2(n,a),s<0&&(s+=360),{lat:h,lon:s,alpha:Math.acos(e)}}setFromAxisAngle(e,t){let s=e.getNormal(),n=.5*t,o=Math.sin(n);return this.set(s.x*o,s.y*o,s.z*o,Math.cos(n)),this}getAxisAngle(){let e,t,s=this.x,n=this.y,o=this.z,a=this.w,h=Math.sqrt(s*s+n*n+o*o);if(h>1e-7){let c=1/h;e=new m(s*c,n*c,o*c),t=a<0?2*Math.atan2(-h,-a):2*Math.atan2(h,a)}else e=new m(0,0,0),t=0;return{axis:e,angle:t}}getPitch(){let e=-2*(this.y*this.z-this.w*this.x);return Math.abs(e)>=1?Math.sign(e)*go:Math.asin(e)}getYaw(){return-Math.atan2(2*(this.x*this.z+this.w*this.y),1-2*(this.y*this.y+this.x*this.x))}getRoll(){return Math.atan2(2*(this.x*this.y+this.w*this.z),1-2*(this.z*this.z+this.x*this.x))}setPitchYawRoll(e,t,s,n=D.IDENTITY){let o=D.xRotation(-e),a=D.yRotation(t),h=D.zRotation(-s);return this.copy(h.mul(o).mul(a).mul(n).conjugate())}setFromEulerAngles(e,t,s){let n=e*ie,o=t*ie,a=s*ie,h=Math.cos(n),c=Math.cos(o),d=Math.cos(a),u=Math.sin(n),_=Math.sin(o),f=Math.sin(a),v=c*d,g=_*f;return this.w=h*v+u*g,this.x=u*v-h*g,this.y=h*_*d+u*c*f,this.z=h*c*f-u*_*d,this.normalize()}getEulerAngles(){let e=this.x,t=this.y,s=this.z,n=this.w,o=t*t,a=n*t-s*e;return a<-1?a=-1:a>1&&(a=1),{roll:Math.atan2(2*(n*e+t*s),1-2*(e*e+o)),pitch:Math.asin(2*a),yaw:Math.atan2(2*(n*s+e*t),1-2*(o+s*s))}}setFromMatrix4(e){let t,s,n,o,a,h=[],c=e._m,d=[1,2,0];return t=c[0]+c[5]+c[10],t>0?(s=Math.sqrt(t+1),this.w=s/2,s=.5/s,this.x=(c[6]-c[9])*s,this.y=(c[8]-c[2])*s,this.z=(c[1]-c[4])*s):(n=0,c[5]>c[0]&&(n=1),c[10]>c[5*n]&&(n=2),o=d[n],a=d[o],s=Math.sqrt(c[5*n]-(c[5*o]+c[5*a])+1),h[n]=.5*s,s!==0&&(s=.5/s),h[3]=(c[4*o+a]-c[4*a+o])*s,h[o]=(c[4*n+o]+c[4*o+n])*s,h[a]=(c[4*n+a]+c[4*a+n])*s,this.x=h[0],this.y=h[1],this.z=h[2],this.w=h[3]),this}getMat4(e=new st){let t=this.x+this.x,s=this.y+this.y,n=this.z+this.z,o=this.w*t,a=this.w*s,h=this.w*n,c=this.x*t,d=this.x*s,u=this.x*n,_=this.y*s,f=this.y*n,v=this.z*n;return e.set([1-(_+v),d-h,u+a,0,d+h,1-(c+v),f-o,0,u-a,f+o,1-(c+_),0,0,0,0,1])}getMat3(){let e=new Pe,t=e._m,s=this.x,n=this.y,o=this.z,a=this.w,h=s+s,c=n+n,d=o+o,u=s*h,_=s*c;s*=d;let f=n*c;return n*=d,o*=d,h*=a,c*=a,a*=d,t[0]=1-(f+o),t[1]=_-a,t[2]=s+c,t[3]=_+a,t[4]=1-(u+o),t[5]=n-h,t[6]=s-c,t[7]=n+h,t[8]=1-(u+f),e}mulVec3(e){let t=e.x,s=e.y,n=e.z,o=this.x,a=this.y,h=this.z,c=this.w,d=c*t+a*n-h*s,u=c*s+h*t-o*n,_=c*n+o*s-a*t;return t=-o*t-a*s-h*n,new m(d*c+t*-o+u*-h-_*-a,u*c+t*-a+_*-o-d*-h,_*c+t*-h+d*-a-u*-o)}mulVec3Res(e,t){let s=e.x,n=e.y,o=e.z,a=this.x,h=this.y,c=this.z,d=this.w,u=d*s+h*o-c*n,_=d*n+c*s-a*o,f=d*o+a*n-h*s;return s=-a*s-h*n-c*o,t.set(u*d+s*-a+_*-c-f*-h,_*d+s*-h+f*-a-u*-c,f*d+s*-c+u*-h-_*-a)}mul(e){let t=this.x,s=this.y,n=this.z,o=this.w,a=e.x,h=e.y,c=e.z,d=e.w;return new D(t*d+o*a+s*c-n*h,s*d+o*h+n*a-t*c,n*d+o*c+t*h-s*a,o*d-t*a-s*h-n*c)}mulRes(e,t){let s=this.x,n=this.y,o=this.z,a=this.w,h=e.x,c=e.y,d=e.z,u=e.w;return t.set(s*u+a*h+n*d-o*c,n*u+a*c+o*h-s*d,o*u+a*d+s*c-n*h,a*u-s*h-n*c-o*d)}mulA(e){let t=this.x,s=this.y,n=this.z,o=this.w,a=e.x,h=e.y,c=e.z,d=e.w;return this.x=t*d+o*a+s*c-n*h,this.y=s*d+o*h+n*a-t*c,this.z=n*d+o*c+t*h-s*a,this.w=o*d-t*a-s*h-n*c,this}conjugate(){return new D(-this.x,-this.y,-this.z,this.w)}inverse(){let e=1/this.magnitude2();return new D(-this.x*e,-this.y*e,-this.z*e,this.w*e)}magnitude(){let e=this.x,t=this.y,s=this.z,n=this.w;return Math.sqrt(e*e+t*t+s*s+n*n)}magnitude2(){let e=this.x,t=this.y,s=this.z,n=this.w;return e*e+t*t+s*s+n*n}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z}normalize(){let e=this.x,t=this.y,s=this.z,n=this.w,o=Math.sqrt(e*e+t*t+s*s+n*n);return o===0?(this.x=0,this.y=0,this.z=0,this.w=0,this):(o=1/o,this.x=e*o,this.y=t*o,this.z=s*o,this.w=n*o,this)}isEqual(e){let t=this.dot(e);return Math.abs(t-1)<.001}slerp(e,t){let s,n,o,a,h,c=this.x,d=this.y,u=this.z,_=this.w,f=e.x,v=e.y,g=e.z,y=e.w;return n=c*f+d*v+u*g+_*y,n<0&&(n=-n,f=-f,v=-v,g=-g,y=-y),1-n>1e-6?(s=Math.acos(n),o=Math.sin(s),a=Math.sin((1-t)*s)/o,h=Math.sin(t*s)/o):(a=1-t,h=t),new D(a*c+h*f,a*d+h*v,a*u+h*g,a*_+h*y)}}class m{constructor(e=0,t=0,s=0){this.x=e,this.y=t,this.z=s}static get UP(){return new m(0,1,0)}static get DOWN(){return new m(0,-1,0)}static get RIGHT(){return new m(1,0,0)}static get LEFT(){return new m(-1,0,0)}static get FORWARD(){return new m(0,0,-1)}static get BACKWARD(){return new m(0,0,1)}static get ZERO(){return new m}static get UNIT_X(){return new m(1,0,0)}static get UNIT_Y(){return new m(0,1,0)}static get UNIT_Z(){return new m(0,0,1)}static get NORTH(){return m.UNIT_Z}static doubleToTwoFloats(e,t,s){let n=e.x,o=e.y,a=e.z;if(n>=0){let h=65536*Math.floor(n/65536);t.x=Math.fround(h),s.x=Math.fround(n-h)}else{let h=65536*Math.floor(-n/65536);t.x=Math.fround(-h),s.x=Math.fround(n+h)}if(o>=0){let h=65536*Math.floor(o/65536);t.y=Math.fround(h),s.y=Math.fround(o-h)}else{let h=65536*Math.floor(-o/65536);t.y=Math.fround(-h),s.y=Math.fround(o+h)}if(a>=0){let h=65536*Math.floor(a/65536);t.z=Math.fround(h),s.z=Math.fround(a-h)}else{let h=65536*Math.floor(-a/65536);t.z=Math.fround(-h),s.z=Math.fround(a+h)}}static doubleToTwoFloat32Array(e,t,s){let n=e.x,o=e.y,a=e.z;if(n>=0){let h=65536*Math.floor(n/65536);t[0]=Math.fround(h),s[0]=Math.fround(n-h)}else{let h=65536*Math.floor(-n/65536);t[0]=Math.fround(-h),s[0]=Math.fround(n+h)}if(o>=0){let h=65536*Math.floor(o/65536);t[1]=Math.fround(h),s[1]=Math.fround(o-h)}else{let h=65536*Math.floor(-o/65536);t[1]=Math.fround(-h),s[1]=Math.fround(o+h)}if(a>=0){let h=65536*Math.floor(a/65536);t[2]=Math.fround(h),s[2]=Math.fround(a-h)}else{let h=65536*Math.floor(-a/65536);t[2]=Math.fround(-h),s[2]=Math.fround(a+h)}}static fromVec(e){return new m(e[0],e[1],e[2])}static angle(e,t){let s=e.dot(t),n=e.cross(t).length();return Math.atan2(n,s)}static lerp(e,t,s){return new m(e.x+(t.x-e.x)*s,e.y+(t.y-e.y)*s,e.z+(t.z-e.z)*s)}static add(e,t){let s=new m(e.x,e.y,e.z);return s.addA(t),s}static sub(e,t){let s=new m(e.x,e.y,e.z);return s.subA(t),s}static scale(e,t){return e.scaleTo(t)}static mul(e,t){let s=new m(e.x,e.y,e.z);return s.mulA(t),s}static noncollinear(e,t){return!!(e.y*t.z-e.z*t.y||e.z*t.x-e.x*t.z||e.x*t.y-e.y*t.z)}static proj_b_to_plane(e,t,s){let n=e.sub(t.scaleTo(t.dot(e)/t.dot(t)));return s&&n.isZero()?new m(s.x,s.y,s.z):n}static proj_b_to_a(e,t){return t.scaleTo(t.dot(e)/t.dot(t))}static orthoNormalize(e,t){return(e=e.getNormal()).scale(t.dot(e)),t.subA(e).normalize()}static isOrthogonal(e,t,s=1e-6){const n=e.x*t.x+e.y*t.y+e.z*t.z;return Math.abs(n)<s}isOrthogonal(e,t=1e-6){const s=this.x*e.x+this.y*e.y+this.z*e.z;return Math.abs(s)<t}static div(e,t){let s=new m(e.x,e.y,e.z);return s.divA(t),s}static length2(e){return e.length2()}static dot(e,t){return e.dot(t)}toVec4(){return new J(this.x,this.y,this.z,1)}clone(){return new m(this.x,this.y,this.z)}toString(){return`(${this.x},${this.y},${this.z})`}isZero(){return!(this.x||this.y||this.z)}projToVec(e){return e.scaleTo(e.dot(this)/e.dot(e))}equal(e){return this.x===e.x&&this.y===e.y&&this.z===e.z}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}length2(){return this.x*this.x+this.y*this.y+this.z*this.z}getQuat(){return new D(this.x,this.y,this.z)}addA(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this}add(e){return new m(this.x+e.x,this.y+e.y,this.z+e.z)}addRes(e,t){return t.set(this.x+e.x,this.y+e.y,this.z+e.z)}subA(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this}sub(e){return new m(this.x-e.x,this.y-e.y,this.z-e.z)}scale(e){return this.x*=e,this.y*=e,this.z*=e,this}scaleTo(e){return new m(this.x*e,this.y*e,this.z*e)}mulA(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this}mul(e){return new m(this.x*e.x,this.y*e.y,this.z*e.z)}mulRes(e,t){return t.set(this.x*e.x,this.y*e.y,this.z*e.z)}divA(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this}div(e){return new m(this.x/e.x,this.y/e.y,this.z/e.z)}dot(e){return e.x*this.x+e.y*this.y+e.z*this.z}dotArr(e){return e[0]*this.x+e[1]*this.y+e[2]*this.z}cross(e){return new m(this.y*e.z-this.z*e.y,this.z*e.x-this.x*e.z,this.x*e.y-this.y*e.x)}clear(){return this.x=this.y=this.z=0,this}getNormal(){let e=new m;e.copy(this);let t=1/e.length();return e.x*=t,e.y*=t,e.z*=t,e}normal(){let e=new m;e.copy(this);let t=1/e.length();return e.x*=t,e.y*=t,e.z*=t,e}normalNegate(){let e=new m;e.copy(this);let t=-1/e.length();return e.x*=t,e.y*=t,e.z*=t,e}normalNegateScale(e){let t=new m;t.copy(this);let s=-e/t.length();return t.x*=s,t.y*=s,t.z*=s,t}normalScale(e){let t=new m;t.copy(this);let s=e/t.length();return t.x*=s,t.y*=s,t.z*=s,t}normalize(){let e=1/this.length();return this.x*=e,this.y*=e,this.z*=e,this}toVec(){return[this.x,this.y,this.z]}toArray(){return[this.x,this.y,this.z]}distance(e){let t=this.x-e.x,s=this.y-e.y,n=this.z-e.z;return Math.sqrt(t*t+s*s+n*n)}distance2(e){let t=this.x-e.x,s=this.y-e.y,n=this.z-e.z;return t*t+s*s+n*n}set(e,t,s){return this.x=e,this.y=t,this.z=s,this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}negateTo(){return new m(-this.x,-this.y,-this.z)}projToRay(e,t){let s=m.proj_b_to_a(m.sub(this,e),t);return s.addA(e),s}angle(e){return m.angle(this,e)}lerp(e,t){return new m(this.x+(e.x-this.x)*t,this.y+(e.y-this.y)*t,this.z+(e.z-this.z)*t)}smerp(e,t){let s=1-t;return new m(this.x*t+e.x*s,this.y*t+e.y*s,this.z*t+e.z*s)}static get LERP_DELTA(){return 1e-6}slerp(e,t){let s,n,o,a,h=new m;if(t<=0)return h.copy(this),h;if(t>=1)return h.copy(e),h;let c=this.dot(e);return 1-c>m.LERP_DELTA?(s=Math.acos(c),n=Math.sin(s),o=Math.sin((1-t)*s)/n,a=Math.sin(t*s)/n):(o=1-t,a=t),m.add(this.scaleTo(o),e.scale(a))}mulVecA(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this}getRotationTo(e,t){let s=this.clone(),n=e.clone();s.normalize(),n.normalize();let o=s.dot(n);if(o>=1)return D.IDENTITY.clone();if(o<-.999999){if(t.equal(m.ZERO)){let a=m.UNIT_X.cross(s);return a.isZero()&&(a=m.UNIT_Y.cross(s)),a.normalize(),D.axisAngleToQuat(a,Math.PI)}return D.axisAngleToQuat(t,Math.PI)}{let a=Math.sqrt(2*(1+o)),h=1/a,c=s.cross(n),d=new D(c.x*h,c.y*h,c.z*h,.5*a);return d.normalize(),d}}}class O{constructor(e=0,t=0){this.x=e,this.y=t}static get UP(){return new O(0,1)}static get DOWN(){return new O(0,-1)}static get RIGHT(){return new O(1,0)}static get LEFT(){return new O(-1,0)}static get ZERO(){return new O}static add(e,t){const s=new O(e.x,e.y);return s.addA(t),s}static sub(e,t){var s=new O(e.x,e.y);return s.subA(t),s}static scale(e,t){let s=new O(e.x,e.y);return s.scale(t),s}static mul(e,t){let s=new O(e.x,e.y);return s.mulA(t),s}static div(e,t){let s=new O(e.x,e.y);return s.divA(t),s}static proj_b_to_a(e,t){return t.scaleTo(t.dot(e)/t.dot(t))}static angle(e,t){return Math.acos(e.dot(t)/Math.sqrt(e.length2()*t.length2()))}static orthoNormalize(e,t){return(e=e.normal()).scale(t.dot(e)),t.sub(e).normalize()}static proj_b_to_plane(e,t,s){let n=e.sub(t.scaleTo(t.dot(e)/t.dot(t)));return s&&n.isZero()?new O(s.x,s.y):n}toVector3(){return new m(this.x,this.y,0)}clone(){return new O(this.x,this.y)}equal(e){return this.x===e.x&&this.y===e.y}copy(e){return this.x=e.x,this.y=e.y,this}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}length2(){return this.x*this.x+this.y*this.y}addA(e){return this.x+=e.x,this.y+=e.y,this}add(e){return new O(this.x+e.x,this.y+e.y)}subA(e){return this.x-=e.x,this.y-=e.y,this}sub(e){return new O(this.x-e.x,this.y-e.y)}scale(e){return this.x*=e,this.y*=e,this}scaleTo(e){return new O(this.x*e,this.y*e)}mulA(e){return this.x*=e.x,this.y*=e.y,this}mul(e){return new O(this.x*e.x,this.y*e.y)}divA(e){return this.x/=e.x,this.y/=e.y,this}dot(e){return e.x*this.x+e.y*this.y}dotArr(e){return e[0]*this.x+e[1]*this.y}cross(e){return this.x*e.y-this.y*e.x}clear(){return this.x=this.y=0,this}normal(){return this.getNormal()}getNormal(){let e=new O;e.copy(this);let t=1/e.length();return e.x*=t,e.y*=t,e}normalize(){let e=1/this.length();return this.x*=e,this.y*=e,this}toVec(){return[this.x,this.y]}distance(e){return O.sub(this,e).length()}set(e,t){return this.x=e,this.y=t,this}negate(){return this.x=-this.x,this.y=-this.y,this}negateTo(){return new O(-this.x,-this.y)}projToRay(e,t){let s=O.proj_b_to_a(O.sub(this,e),t);return s.add(e),s}angle(e){return O.angle(this,e)}lerp(e,t,s){let n=this.clone();return s<=0?n.copy(e):s>=1?n.copy(t):n=O.add(e,O.sub(t,e).scale(s)),n}static get LERP_DELTA(){return 1e-6}slerp(e,t){let s,n,o,a,h=new O;if(t<=0)return h.copy(this),h;if(t>=1)return h.copy(e),h;let c=this.dot(e);return 1-c>O.LERP_DELTA?(s=Math.acos(c),n=Math.sin(s),o=Math.sin((1-t)*s)/n,a=Math.sin(t*s)/n):(o=1-t,a=t),O.add(this.scale(o),e.scale(a))}isZero(){return!(this.x||this.y)}}const Eo={aliceblue:"#f0f8ff",antiquewhite:"#faebd7",aqua:"#00ffff",aquamarine:"#7fffd4",azure:"#f0ffff",beige:"#f5f5dc",bisque:"#ffe4c4",black:"#000000",blanchedalmond:"#ffebcd",blue:"#0000ff",blueviolet:"#8a2be2",brown:"#a52a2a",burlywood:"#deb887",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",cornflowerblue:"#6495ed",cornsilk:"#fff8dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkgray:"#a9a9a9",darkgreen:"#006400",darkkhaki:"#bdb76b",darkmagenta:"#8b008b",darkolivegreen:"#556b2f",darkorange:"#ff8c00",darkorchid:"#9932cc",darkred:"#8b0000",darksalmon:"#e9967a",darkseagreen:"#8fbc8f",darkslateblue:"#483d8b",darkslategray:"#2f4f4f",darkturquoise:"#00ced1",darkviolet:"#9400d3",deeppink:"#ff1493",deepskyblue:"#00bfff",dimgray:"#696969",dodgerblue:"#1e90ff",firebrick:"#b22222",floralwhite:"#fffaf0",forestgreen:"#228b22",fuchsia:"#ff00ff",gainsboro:"#dcdcdc",ghostwhite:"#f8f8ff",gold:"#ffd700",goldenrod:"#daa520",gray:"#808080",green:"#008000",greenyellow:"#adff2f",honeydew:"#f0fff0",hotpink:"#ff69b4","indianred ":"#cd5c5c",indigo:"#4b0082",ivory:"#fffff0",khaki:"#f0e68c",lavender:"#e6e6fa",lavenderblush:"#fff0f5",lawngreen:"#7cfc00",lemonchiffon:"#fffacd",lightblue:"#add8e6",lightcoral:"#f08080",lightcyan:"#e0ffff",lightgoldenrodyellow:"#fafad2",lightgrey:"#d3d3d3",lightgreen:"#90ee90",lightpink:"#ffb6c1",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",lightskyblue:"#87cefa",lightslategray:"#778899",lightsteelblue:"#b0c4de",lightyellow:"#ffffe0",lime:"#00ff00",limegreen:"#32cd32",linen:"#faf0e6",magenta:"#ff00ff",maroon:"#800000",mediumaquamarine:"#66cdaa",mediumblue:"#0000cd",mediumorchid:"#ba55d3",mediumpurple:"#9370d8",mediumseagreen:"#3cb371",mediumslateblue:"#7b68ee",mediumspringgreen:"#00fa9a",mediumturquoise:"#48d1cc",mediumvioletred:"#c71585",midnightblue:"#191970",mintcream:"#f5fffa",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",navajowhite:"#ffdead",navy:"#000080",oldlace:"#fdf5e6",olive:"#808000",olivedrab:"#6b8e23",orange:"#ffa500",orangered:"#ff4500",orchid:"#da70d6",palegoldenrod:"#eee8aa",palegreen:"#98fb98",paleturquoise:"#afeeee",palevioletred:"#d87093",papayawhip:"#ffefd5",peachpuff:"#ffdab9",peru:"#cd853f",pink:"#ffc0cb",plum:"#dda0dd",powderblue:"#b0e0e6",purple:"#800080",rebeccapurple:"#663399",red:"#ff0000",rosybrown:"#bc8f8f",royalblue:"#4169e1",saddlebrown:"#8b4513",salmon:"#fa8072",sandybrown:"#f4a460",seagreen:"#2e8b57",seashell:"#fff5ee",sienna:"#a0522d",silver:"#c0c0c0",skyblue:"#87ceeb",slateblue:"#6a5acd",slategray:"#708090",snow:"#fffafa",springgreen:"#00ff7f",steelblue:"#4682b4",tan:"#d2b48c",teal:"#008080",thistle:"#d8bfd8",tomato:"#ff6347",turquoise:"#40e0d0",violet:"#ee82ee",wheat:"#f5deb3",white:"#ffffff",whitesmoke:"#f5f5f5",yellow:"#ffff00",yellowgreen:"#9acd32"};class Ur{constructor(e=1,t=1){this._a=e,this._b=t,this._flattening=(e-t)/e,this._f=1/this._flattening,this._a2=e*e,this._b2=t*t;const s=Math.sqrt(this._a2-this._b2);this._e=s/e,this._e2=this._e*this._e,this._e22=this._e2*this._e2,this._k=s/t,this._k2=this._k*this._k,this._radii=new m(e,e,t),this._radii2=new m(this._a2,this._a2,this._b2),this._invRadii=new m(1/e,1/e,1/t),this._invRadii2=new m(1/this._a2,1/this._a2,1/this._b2)}rhumbDistanceTo(e,t){const s=e.lat*U,n=t.lat*U,o=n-s;let a=Math.abs(t.lon-e.lon)*U;Math.abs(a)>Math.PI&&(a=a>0?-(2*Math.PI-a):2*Math.PI+a);const h=Math.log(Math.tan(n/2+Math.PI/4)/Math.tan(s/2+Math.PI/4)),c=Math.abs(h)>1e-11?o/h:Math.cos(s);return Math.sqrt(o*o+c*c*a*a)*this._a}getIntermediatePointOnGreatCircle(e,t,s){if(s==0)return e.clone();if(s==1)return t.clone();const n=this.inverse(e,t),o=n.distance,a=n.initialAzimuth;return isNaN(a)?e:this.getGreatCircleDestination(e,a,o*s)}static getBearing(e,t){let s=e.lat*U,n=e.lon*U,o=t.lat*U,a=t.lon*U,h=Math.sin(a-n)*Math.cos(o),c=Math.cos(s)*Math.sin(o)-Math.sin(s)*Math.cos(o)*Math.cos(a-n);return Math.atan2(h,c)*Q}getFlattening(){return this._flattening}getEquatorialSize(){return this._a}get equatorialSize(){return this._a}get equatorialSizeSqr(){return this._a2}getPolarSize(){return this._b}get polarSize(){return this._b}get polarSizeSqr(){return this._b2}lonLatToCartesian(e){return this.geodeticToCartesian(e.lon,e.lat,e.height)}lonLatToCartesianRes(e,t){return this.geodeticToCartesian(e.lon,e.lat,e.height,t)}geodeticToCartesian(e,t,s=0,n=new m){let o=U*t,a=U*e,h=Math.sin(o),c=this._a/Math.sqrt(1-this._e2*h*h),d=(c+s)*Math.cos(o);return n.x=d*Math.cos(a),n.y=d*Math.sin(a),n.z=(c*(1-this._e2)+s)*h,n}projToSurface(e){let t=e.x||0,s=e.y||0,n=e.z||0,o=Math.sqrt(t*t+s*s+n*n);if(o===0)return this.lonLatToCartesian(new A);let a=this._invRadii2.x,h=this._invRadii2.y,c=this._invRadii2.z,d=t*t*a,u=s*s*h,_=n*n*c,f=d+u+_,v=Math.sqrt(1/f),g=e.scaleTo(v);if(f<.1)return Number.isFinite(v)?g:new m;let y=(1-v)*o/g.mulA(this._invRadii2).length(),p=0,x=0,T=0;for(;;){p=1/(1+y*a),x=1/(1+y*h),T=1/(1+y*c);let w=p*p,C=x*x,E=T*T,L=d*w+u*C+_*E-1;if(Math.abs(L)<rr)break;y+=.5*L/(d*(w*p)*a+u*(C*x)*h+_*(E*T)*c)}return new m(t*p,s*x,n*T)}cartesianToLonLat(e){return this.cartesianToLonLatRes(e)}cartesianToLonLatRes(e,t=new A){let s=this.projToSurface(e),n=this.getSurfaceNormal3v(s),o=e.sub(s);return t.lon=Math.atan2(n.y,n.x)*Q,t.lat=Math.asin(n.z)*Q,t.height=Math.sign(o.dot(e))*o.length(),t}getSurfaceNormal3v(e){let t=this._invRadii2,s=e.x*t.x,n=e.y*t.y,o=e.z*t.z,a=1/Math.sqrt(s*s+n*n+o*o);return new m(s*a,n*a,o*a)}getGreatCircleDistance(e,t){return this.inverse(e,t).distance}getGreatCircleDestination(e,t,s){return this.direct(e,t,s).destination}inverse(e,t){let s=this._a,n=this._b,o=this._flattening;const a=e.lat*U,h=e.lon*U,c=t.lat*U,d=t.lon*U-h,u=(1-o)*Math.tan(a),_=1/Math.sqrt(1+u*u),f=u*_,v=(1-o)*Math.tan(c),g=1/Math.sqrt(1+v*v),y=v*g,p=Math.abs(d)>Math.PI/2||Math.abs(c-a)>Math.PI/2;let x=d,T=null,w=null,C=p?Math.PI:0,E=0,L=p?-1:1,S=null,P=1,R=1,M=null,B=0;do{if(T=Math.sin(x),w=Math.cos(x),S=(g*T)**2+(_*y-f*g*w)**2,Math.abs(S)<1e-24)break;E=Math.sqrt(S),L=f*y+_*g*w,C=Math.atan2(E,L);const k=_*g*T/E;R=1-k*k,P=R!=0?L-2*f*y/R:0;const F=o/16*R*(4+o*(4-3*R));M=x,x=d+(1-F)*o*k*(C+F*E*(P+F*L*(2*P*P-1)))}while(Math.abs(x-M)>rr&&++B<1e3);const z=R*(s*s-n*n)/(n*n),ue=z/1024*(256+z*(z*(74-47*z)-128)),I=n*(1+z/16384*(4096+z*(z*(320-175*z)-768)))*(C-ue*E*(P+ue/4*(L*(2*P*P-1)-ue/6*P*(4*E*E-3)*(4*P*P-3)))),se=Math.abs(S)<Number.EPSILON?0:Math.atan2(g*T,_*y-f*g*w),G=Math.abs(S)<Number.EPSILON?Math.PI:Math.atan2(_*T,-f*g+_*y*w);return{distance:I,initialAzimuth:Math.abs(I)<Number.EPSILON?NaN:Ve(se)*Q,finalAzimuth:Math.abs(I)<Number.EPSILON?NaN:Ve(G)*Q}}direct(e,t,s){let n=e.lon,o=e.lat,a=this._a,h=this._b,c=this._flattening,d=s,u=t*U,_=Math.sin(u),f=Math.cos(u),v=(1-c)*Math.tan(o*U),g=1/Math.sqrt(1+v*v),y=v*g,p=Math.atan2(v,f),x=g*_,T=1-x*x,w=T*(a*a-h*h)/(h*h),C=1+w/16384*(4096+w*(w*(320-175*w)-768)),E=w/1024*(256+w*(w*(74-47*w)-128)),L=d/(h*C),S=2*Math.PI,P=0,R=0,M=0,B=0;for(;Math.abs(L-S)>1e-12;)P=Math.cos(2*p+L),R=Math.sin(L),M=Math.cos(L),B=E*R*(P+E/4*(M*(2*P*P-1)-E/6*P*(4*R*R-3)*(4*P*P-3))),S=L,L=d/(h*C)+B;let z=y*R-g*M*f,ue=Math.atan2(y*M+g*R*f,(1-c)*Math.sqrt(x*x+z*z)),I=c/16*T*(4+c*(4-3*T)),se=Math.atan2(R*_,g*M-y*R*f)-(1-I)*c*x*(L+I*R*(P+I*M*(2*P*P-1))),G=Math.atan2(x,-z);return{destination:new A(n+se*Q,ue*Q),finalAzimuth:G*Q}}hitRay(e,t){let s,n,o,a,h,c=this._invRadii.mul(e),d=this._invRadii.mul(t),u=c.dot(c),_=c.dot(d);if(u>1){if(_>=0)return;var f=_*_;if(s=u-1,n=d.dot(d),o=n*s,Math.abs(f-o)>1e-15&&f<o)return;if(f>o){a=_*_-o,h=-_+Math.sqrt(a);var v=h/n,g=s/h;return v<g?e.add(t.scaleTo(v)):e.add(t.scaleTo(g))}var y=Math.sqrt(s/n);return e.add(t.scaleTo(y))}return u<1?(s=u-1,n=d.dot(d),o=n*s,a=_*_-o,h=-_+Math.sqrt(a),e.add(t.scaleTo(h/n))):_<0?(n=d.dot(d),e.add(t.scaleTo(-_/n))):void 0}getNorthFrameRotation(e){let t=this.getSurfaceNormal3v(e),s=m.proj_b_to_plane(m.NORTH,t);return D.getLookRotation(s,t)}getBearingDestination(e,t=0,s=0){t*=U;var n=(e.lon+540)%360-180,o=e.lat*U,a=n*U,h=s/this._a,c=Math.asin(Math.sin(o)*Math.cos(h)+Math.cos(o)*Math.sin(h)*Math.cos(t));return new A((a+Math.atan2(Math.sin(t)*Math.sin(h)*Math.cos(o),Math.cos(h)-Math.sin(o)*Math.sin(c)))*Q,c*Q)}static getIntermediatePointOnGreatCircle(e,t,s){var n=e.lat*U,o=e.lon*U,a=t.lat*U,h=t.lon*U,c=Math.sin(n),d=Math.cos(n),u=Math.sin(o),_=Math.cos(o),f=Math.sin(a),v=Math.cos(a),g=Math.sin(h),y=Math.cos(h),p=a-n,x=h-o,T=Math.sin(p/2)*Math.sin(p/2)+Math.cos(n)*Math.cos(a)*Math.sin(x/2)*Math.sin(x/2),w=2*Math.atan2(Math.sqrt(T),Math.sqrt(1-T)),C=Math.sin((1-s)*w)/Math.sin(w),E=Math.sin(s*w)/Math.sin(w),L=C*d*_+E*v*y,S=C*d*u+E*v*g,P=C*c+E*f,R=Math.atan2(P,Math.sqrt(L*L+S*S)),M=Math.atan2(S,L);return new A((M*Q+540)%360-180,R*Q)}static getRhumbBearing(e,t){var s=(t.lon-e.lon)*U,n=Math.log(Math.tan(t.lat*U/2+Math.PI/4)/Math.tan(e.lat*U/2+Math.PI/4));return Math.abs(s)>Math.PI&&(s=s>0?-1*(2*Math.PI-s):2*Math.PI+s),(Math.atan2(s,n)*Q+360)%360}getLonLatVisibilitySimple(e,t,s){const n=this.lonLatToCartesian(t),o=t.height,a=this.polarSize+o,h=Math.max(e.length()-this.polarSize,0),c=n.sub(e);let d;return d=h>0?Math.sqrt((a+h)**2-a**2):a,d>c.length()&&(!s||s.dot(c.normalize())>0)}}const Ao=new Ur(6378137,6356752314245179e-9);function Hi(l,e){return l??e}function Ut(l){return l==null}function gn(l){return l===void 0}let za=0;function Gr(l){let e=l._openglobus_id;return e||(e=l._openglobus_id=++za),e}function Ms(l){return typeof l=="string"||l instanceof String}function Be(l){return l.toString(16).padStart(2,"0")}function ar(l){let e,t,s;return l instanceof Array?(e=Be(l[0]),t=Be(l[1]),s=Be(l[2])):(e=Be(l.x),t=Be(l.y),s=Be(l.z)),`#${e}${t}${s}`}function le(l,e){let t=Eo[l];if(t&&(l=t),l[0]==="#"){let s=/^#?([a-f\d])([a-f\d])([a-f\d])$/i,n=l.replace(s,function(a,h,c,d){return h+h+c+c+d+d}),o=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(n);return o?new J(parseInt(o[1],16)/255,parseInt(o[2],16)/255,parseInt(o[3],16)/255,Ut(e)?1:e):new J}{Ut(e)&&(e=1);let s=l.split(",");return new J(parseInt(s[0].split("(")[1])/255,parseInt(s[1])/255,parseInt(s[2])/255,Ut(s[3])?e:parseFloat(s[3]))}}function me(l,e){let t=le(l,e);return new Float32Array([t.x,t.y,t.z,t.w])}function Qi(l){let e=Eo[l];if(e&&(l=e),l[0]==="#"){let t=/^#?([a-f\d])([a-f\d])([a-f\d])$/i,s=l.replace(t,function(o,a,h,c){return a+a+h+h+c+c}),n=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(s);return n?new m(parseInt(n[1],16)/255,parseInt(n[2],16)/255,parseInt(n[3],16)/255):new m}{let t=l.split(",");return new m(parseInt(t[0].split("(")[1])/255,parseInt(t[1])/255,parseInt(t[2])/255)}}function zt(l,e){return l.replace(/{[^{}]+}/g,function(t){return e[t.replace(/[{}]+/g,"")]||""})}function hi(l,e){return l.replace(/\$\{([^}]+)\}/g,(t,s)=>(e==null?void 0:e[s.trim()])??"")}function jr(l){let e=document.createElement("div");e.innerHTML=l;let t=[];for(let s=0;s<e.childNodes.length;s++)t.push(e.childNodes[s]),e.removeChild(e.childNodes[s]);return t}function Lo(l,e,t,s){let n=document.getElementById(l);n||(n=document.createElement("div"),n.id=l,n.classList.add("defaultText"),document.body.appendChild(n)),n.innerHTML=e,n.style.left=`${t}px`,n.style.top=`${s}px`}function Po(l){return typeof l=="number"}function So(l,e=""){return l?l.trim():e}function qt(l,e){if(l){if(Po(l))return new m(l,l,l);if(l instanceof m)return l.clone();if(l instanceof Array)return m.fromVec(l);if(l instanceof O)return new m(l.x,l.y,0)}else if(e)return e;return new m}function ae(l,e){if(l){if(Ms(l))return le(l);if(l instanceof Array)return J.fromVec(l);if(l instanceof J)return l.clone()}else if(e)return e;return new J(1,1,1,1)}function Gt(l,e){if(l){if(Ms(l))return Qi(l);if(l instanceof Array)return m.fromVec(l);if(l instanceof m)return l.clone()}else if(e)return e;return new m(1,1,1)}function qr(l,e){if(l){if(l instanceof Array)return new H(mi(l[0]),mi(l[1]));if(l instanceof H)return l.clone()}else if(e)return e;return new H}function mi(l,e){if(l){if(l instanceof Array)return new A(l[0],l[1],l[2]);if(l instanceof A)return l.clone()}else if(e)return e;return new A}function Yr(l,e){let t=0,s=l.length-1;for(;t<=s;){let n=Math.floor(.5*(t+s));if(Math.abs(l[n]-e)<.001)return n;l[n]<e?t=n+1:s=n-1}return-1}function Se(l,e,t){let s=0,n=l.length-1;for(;s<=n;){let o=n+s>>1,a=t(e,l[o],o);if(a>0)s=o+1;else{if(!(a<0))return o;n=o-1}}return-s-1}function Wr(l,e,t){let s=Se(l,e,t);return s<0&&(s=~s),l.splice(s,0,e),s}function Ro(l,e,t,s,n=!1){let o=new A(e.lon-l.lon,e.lat-l.lat),a=new A(s.lon-t.lon,s.lat-t.lat),h=-o.lat,c=+o.lon,d=-(h*l.lon+c*l.lat),u=-a.lat,_=+a.lon,f=-(u*t.lon+_*t.lat),v=u*l.lon+_*l.lat+f,g=u*e.lon+_*e.lat+f,y=h*t.lon+c*t.lat+d,p=h*s.lon+c*s.lat+d;if(n&&(v*g>0||y*p>0))return;let x=v/(v-g);return new A(l.lon+x*o.lon,l.lat+x*o.lat)}const Da={string:function(l){return Ut(l)?l:l.toString()},date:function(l){return Ut(l)?l:new Date(1e3*l)},datetime:function(l){return Ut(l)?l:new Date(1e3*l)},time:function(l){return Ut(l)?l:parseInt(l)},integer:function(l){return Ut(l)?l:parseInt(l)},float:function(l){return Ut(l)?l:parseFloat(l)},boolean:function(l){if(l===null)return l;if(typeof l=="boolean")return l===!0;if(typeof l=="string"){if(l==="")return!1;if((l=l.replace(/^\s+|\s+$/g,"")).toLowerCase()==="true"||l.toLowerCase()==="yes")return!0;l=(l=l.replace(/,/g,".")).replace(/^\s*\-\s*/g,"-")}return!isNaN(l)&&parseFloat(l)!==0}};function pn(l,e=""){let t=1024,s=atob(l),n=s.length,o=Math.ceil(n/t),a=new Array(o);for(let h=0;h<o;++h){let c=h*t,d=Math.min(c+t,n),u=new Array(d-c);for(let _=c,f=0;_<d;++f,++_)u[f]=s[_].charCodeAt(0);a[h]=new Uint8Array(u)}return new Blob(a,{type:e})}function vi(l,e,t=!1){let s,n=0;return function(){const o=arguments;n?(t&&clearTimeout(s),s=setTimeout(()=>{Date.now()-n>=e&&(l.apply(null,o),n=Date.now())},e-(Date.now()-n))):(l.apply(null,o),n=Date.now())}}function nt(l,e){let t=new l.constructor(l.length+e.length);return t.set(l,0),t.set(e,l.length),t}function xt(l=[],e=[]){if(ArrayBuffer.isView(l))return nt(l,e);for(let t=0;t<e.length;t++)l.push(e[t]);return l}function it(l,e=Float32Array){if(ArrayBuffer.isView(l))return l;{const t=new e(l.length);return t.set(l,0),t}}function He(l){return ArrayBuffer.isView(l)?Array.from(l):l}function Ct(l,e,t,s){if(ArrayBuffer.isView(l))return e<0&&(t=Math.abs(e),e+=l.length),at(l,e,t,s);{let n;return n=e<0?l.splice(e):l.splice(e,t),s&&(s.result=n),l}}function at(l,e,t,s){if(l.length===0)return l;const n=l.length-t,o=new l.constructor(n);return o.set(l.subarray(0,e)),o.set(l.subarray(e+t),e),s&&(s.result=l.subarray(e,e+t)),o}function $r(l,e,t,s,n){const o=n+1,a=t+o,h=s+o;let c=new Float64Array(o*o*3),d=0;for(let u=t;u<a;u++)for(let _=s;_<h;_++){let f=3*(u*(e+1)+_);c[d++]=l[f],c[d++]=l[f+1],c[d++]=l[f+2]}return c}function Mo(l,e,t,s,n){const o=n+1,a=t+o,h=s+o;let c=new Float32Array(o*o*3),d=0;for(let u=t;u<a;u++)for(let _=s;_<h;_++){let f=3*(u*(e+1)+_);c[d++]=l[f],c[d++]=l[f+1],c[d++]=l[f+2]}return c}function lr(l,e,t,s,n,o,a,h,c,d,u,_,f){const v=o+h+1,g=a+h+1;n+=1;let y=0,p=0;for(let x=o;x<v;x++)for(let T=a;T<g;T++){let w=x*n+T,C=3*w,E=l[C],L=l[C+1],S=l[C+2];s&&s[w]!==0?f[p]=1:(E<_.xmin&&(_.xmin=E),E>_.xmax&&(_.xmax=E),L<_.ymin&&(_.ymin=L),L>_.ymax&&(_.ymax=L),S<_.zmin&&(_.zmin=S),S>_.zmax&&(_.zmax=S)),p++,c[y]=E,u[y]=t[C],d[y++]=e[C],c[y]=L,u[y]=t[C+1],d[y++]=e[C+1],c[y]=S,u[y]=t[C+2],d[y++]=e[C+2]}}function Xr(l){return l.map(e=>Array.isArray(e)?Xr(e):e)}async function Vi(l){return new Promise(e=>{const t=new Image;return t.addEventListener("load",()=>{e(t)}),t.src=l,t.crossOrigin="",t})}function hr(l){return l.complete&&l.naturalHeight!==0}function Ue(l){return l>1e3?l-Math.floor(l)!=0?[(l/1e3).toFixed(2),"km"]:[(l/1e3).toFixed(0),"km"]:l>9?[Math.round(l).toString(),"m"]:l<=.01?["0","m"]:[l.toFixed(1),"m"]}function Bo(l){let e=new URLSearchParams(location.search).get(l);if(e)return Number(e)}function cr(l,e=-1){if(e<0)return l.toString();const t=Math.pow(10,e);return(Math.round(l*t)/t).toString()}Object.freeze(Object.defineProperty({__proto__:null,base64StringToBlog:function(l){let e=l.split(";"),t=e[0].split(":")[1];return pn(e[1].split(",")[1],t)},base64toBlob:pn,binaryInsert:Wr,binarySearch:Se,binarySearchFast:Yr,blerp:function(l,e,t,s,n,o,a=0,h=1,c=0,d=1){return(t*(h-l)*(d-e)+s*(l-a)*(d-e)+n*(h-l)*(e-c)+o*(l-a)*(e-c))/((h-a)*(d-c))},blerp2:function(l,e,t,s,n,o){return t*(1-l)*(1-e)+s*l*(1-e)+n*(1-l)*e+o*l*e},castType:Da,cloneArray:Xr,concatArrays:xt,concatTypedArrays:nt,createColorRGB:Gt,createColorRGBA:ae,createExtent:qr,createLonLat:mi,createVector3:qt,createVector4:function(l,e){if(l){if(l instanceof J)return l.clone();if(l instanceof Array)return J.fromVec(l)}else if(e)return e;return new J},defaultString:So,distanceFormat:function(l){return l>1e3?`${(l/1e3).toFixed(2)} km`:l>9?`${Math.round(l)} m`:`${l.toFixed(1)} m`},distanceFormatExt:Ue,extractElevationTiles:function(l,e,t){let s=Math.sqrt(e.length)-1,n=s+1,o=Math.sqrt(l.length/4),a=o/s,h=0,c=0;for(let d=0,u=0,_=l.length/4;d<_;d++){let f=l[4*d],v=Math.floor(d/o),g=d%o,y=Math.floor(g/s),p=Math.floor(v/s),x=t[p][y],T=v%s,w=g%s,C=(T+p)*n+w+y;if(x[C]=f,(v+p)%a==0&&(g+y)%a==0&&(e[u++]=f),(g+1)%s==0&&g!==o-1){h=l[4*(d+1)];let E=.5*(f+h);C=(T+p)*n+w+1,x[C]=E,(v+p)%a==0&&(e[u++]=E);let L=(T+p)*n+(w+1)%s;t[p][y+1][L]=E}if((v+1)%s==0&&v!==o-1){c=l[4*(d+o)];let E=.5*(f+c);C=(T+1)*n+w+y,x[C]=E,(g+y)%a==0&&(e[u++]=E);let L=(T+1)%s*n+w+y;t[p+1][y][L]=E}if((g+1)%s==0&&g!==o-1&&(v+1)%s==0&&v!==o-1){let E=.25*(f+h+c+l[4*(d+o+1)]);C=(T+1)*n+(w+1),x[C]=E,e[u++]=E;let L=(T+1)*n;t[p][y+1][L]=E;let S=s;t[p+1][y][S]=E;let P=0;t[p+1][y+1][P]=E}}},getDefault:Hi,getHTML:function(l,e){return zt(l,e)},getLinesIntersection2v:function(l,e,t,s,n){let o=e.sub(l),a=s.sub(t),h=-o.y,c=+o.x,d=-(h*l.x+c*l.y),u=-a.y,_=+a.x,f=-(u*t.x+_*t.y),v=u*l.x+_*l.y+f,g=u*e.x+_*e.y+f,y=h*t.x+c*t.y+d,p=h*s.x+c*s.y+d;if(n&&(v*g>0||y*p>0))return;let x=v/(v-g);return new O(l.x+x*o.x,l.y+x*o.y)},getLinesIntersectionLonLat:Ro,getMatrixSubArray32:Mo,getMatrixSubArray64:$r,getMatrixSubArrayBoundsExt:lr,getTileImageResolution:function(l,e,t,s=256,n=Ao){let o=$e(l,e,t),a=o.getSouthWest().inverseMercator(),h=o.getNorthEast().inverseMercator();return[n.getGreatCircleDistance(a,new A(h.lon,a.lat))/s,n.getGreatCircleDistance(a,new A(a.lon,h.lat))/s]},getUrlParam:Bo,htmlColorToFloat32Array:me,htmlColorToRgb:Qi,htmlColorToRgba:le,isEmpty:Ut,isImageLoaded:hr,isNumber:Po,isString:Ms,isUndef:gn,isUndefExt:function(l,e){return gn(l)?e:l},loadImage:Vi,makeArray:He,makeArrayTyped:it,parseHTML:jr,print2d:Lo,rgbToStringHTML:ar,spliceArray:Ct,spliceTypedArray:at,stamp:Gr,stringTemplate:zt,stringTemplate2:hi,throttle:vi,toFixedMax:cr,xmlToJson:function l(e){let t={};if(e.nodeType===1){if(e.attributes.length>0){t["@attributes"]={};for(let s=0;s<e.attributes.length;s++){let n=e.attributes.item(s);t["@attributes"][n.nodeName]=n.nodeValue}}}else e.nodeType===3&&(t=e.nodeValue);if(e.hasChildNodes())for(let s=0;s<e.childNodes.length;s++){let n=e.childNodes.item(s),o=n.nodeName;if(t[o]===void 0)t[o]=l(n);else{if(t[o].push===void 0){let a=t[o];t[o]=[],t[o].push(a)}t[o].push(l(n))}}return t}},Symbol.toStringTag,{value:"Module"}));const Ui=1e3,dr=1/60,mn=1/24,yi=3600,ur=1/yi,Zr=43200,Gi=1440,Fa=1/Gi,Jt=86400,Oa=864e5,Kr=11574074074074074e-24,ne=1/Jt,Ji=2451545;function ko(l,e,t){let s=(e-14)/12|0,n=l+4800+s;return(1461*n/4|0)+(367*(e-2-12*s)/12|0)-(3*((n+100)/100|0)/4|0)+t-32075}function ts(l){let e=ko(l.getUTCFullYear(),l.getUTCMonth()+1,l.getUTCDate()),t=l.getUTCHours()-12;t<0&&(t+=24);let s=l.getUTCSeconds()+t*yi+60*l.getUTCMinutes()+.001*l.getUTCMilliseconds();s>=Zr&&e--;let n=s*ne|0;return e+=n,s-=Jt*n,s<0&&(e--,s+=Jt),e+s*ne}function _r(l){let e=zo,t=Se(e,l,function(n,o){return n-o.jd});t<0&&(t=~t),t>=e.length&&(t=e.length-1);let s=e[t].leapSeconds;return t!==0&&(e[t].jd-l)*Jt>s&&(s=e[t-1].leapSeconds),l+s*ne}function Vs(l){let e=zo,t=Se(e,l,function(n,o){return n-o.jd});if(t<0&&(t=~t),t>=e.length)return l-e[t-1].leapSeconds*ne;if(t===0)return l-e[0].leapSeconds*ne;let s=(e[t].jd-l)*Jt;return s===0?l-e[t].leapSeconds*ne:s<=1?void 0:l-e[t-1].leapSeconds*ne}function fr(l){let e=0|l,t=(l-e)*Jt;t>=Zr&&e++;let s=e+68569|0,n=4*s/146097|0;s=s-((146097*n+3)/4|0)|0;let o=4e3*(s+1)/1461001|0;s=s-(1461*o/4|0)+31|0;let a=80*s/2447|0,h=s-(2447*a/80|0)|0;s=a/11|0;let c=a+2-12*s|0,d=100*(n-49)+o+s|0,u=t*ur|0,_=t-u*yi,f=_*dr|0;_-=60*f;let v=0|_,g=(_-v)*Ui|0;return u+=12,u>23&&(u-=24),new Date(Date.UTC(d,c-1,h,u,f,v,g))}function Io(l,e){return l+e*Kr}function vn(l,e){return l+e*ne}function et(l,e){return{jd:l,leapSeconds:e}}const zo=[et(24413175e-1,10),et(24414995e-1,11),et(24416835e-1,12),et(24420485e-1,13),et(24424135e-1,14),et(24427785e-1,15),et(24431445e-1,16),et(24435095e-1,17),et(24438745e-1,18),et(24442395e-1,19),et(24447865e-1,20),et(24451515e-1,21),et(24455165e-1,22),et(24462475e-1,23),et(24471615e-1,24),et(24478925e-1,25),et(24482575e-1,26),et(24488045e-1,27),et(24491695e-1,28),et(24495345e-1,29),et(24500835e-1,30),et(24506305e-1,31),et(24511795e-1,32),et(24537365e-1,33),et(24548325e-1,34),et(24561095e-1,35),et(24572045e-1,36)],Na=_r(Ji);Object.freeze(Object.defineProperty({__proto__:null,DAYS_PER_JULIAN_CENTURY:36525,DAYS_PER_JULIAN_YEAR:365.25,DateToTAI:function(l){return _r(ts(l))},DateToUTC:ts,HOURS_PER_DAY:24,J2000:Ji,J2000TAI:Na,MILLISECONDS_PER_DAY:Oa,MILLISECONDS_PER_SECOND:Ui,MINUTES_PER_DAY:Gi,MINUTES_PER_HOUR:60,MODIFIED_JULIAN_DATE_DIFFERENCE:24000005e-1,ONE_BY_HOURS_PER_DAY:mn,ONE_BY_MILLISECONDS_PER_DAY:Kr,ONE_BY_MINUTES_PER_DAY:Fa,ONE_BY_SECONDS_PER_DAY:ne,ONE_BY_SECONDS_PER_HOUR:ur,ONE_BY_SECONDS_PER_MINUTE:dr,PICOSECOND:1e-9,SECONDS_PER_12_HOURS:Zr,SECONDS_PER_DAY:Jt,SECONDS_PER_HOUR:yi,SECONDS_PER_MILLISECOND:.001,SECONDS_PER_MINUTE:60,T:function(l){return(l-Ji)/36525},TAItoDate:function(l){let e=Vs(l);return e||(e=Vs(vn(l,-1)),console.trace(`TAItoDate - can't convert ${l.toString()} to utc.`)),fr(e)},TAItoUTC:Vs,UTCtoDate:fr,UTCtoTAI:_r,addDays:function(l,e){return l+e},addHours:function(l,e){return l+e*mn},addMilliseconds:Io,addMinutes:function(l,e){return l+e*Gi},addSeconds:vn,daysToSeconds:function(l){return l*Jt},getDayNumber:ko,getDays:function(l){return 0|l},getHours:function(l){let e=(l-(0|l))*Jt,t=e*ur|0,s=e-t*yi,n=s*dr|0;s-=60*n;let o=0|s;return t+=12+n/60+o/3600+((s-o)*Ui|0)/1e3,t>23&&(t-=24),t},getMilliseconds:function(l){let e=l-(0|l);return e*=Jt,(e-(0|e))*Ui|0},getMinutes:function(l){return(l-(0|l))*Gi|0},getSeconds:function(l){return(l-(0|l))*Jt},secondsToDays:function(l){return l*ne}},Symbol.toStringTag,{value:"Module"}));class Do{constructor(e){this.vertices=[new m,new m,new m,new m,new m,new m,new m,new m],e&&this.setFromBoundsArr(e)}copy(e){for(let t=0,s=this.vertices.length;t<s;t++)this.vertices[t].copy(e.vertices[t])}setFromBoundsArr(e){let t=e[0],s=e[3],n=e[1],o=e[4],a=e[2],h=e[5],c=this.vertices;c[0].set(t,n,a),c[1].set(s,n,a),c[2].set(s,n,h),c[3].set(t,n,h),c[4].set(t,o,a),c[5].set(s,o,a),c[6].set(s,o,h),c[7].set(t,o,h)}setFromExtent(e,t){this.setFromBoundsArr(t.getCartesianBounds(e))}}class Dt{constructor(e=0,t){this.radius=e,this.center=t?t.clone():new m}setFromBounds(e){let t=new m(e[0],e[1],e[2]);this.center.set(t.x+.5*(e[3]-t.x),t.y+.5*(e[3]-t.y),t.z+.5*(e[5]-t.z)),this.radius=this.center.distance(t)}setFromExtent(e,t){this.setFromBounds(t.getCartesianBounds(e))}}Object.freeze(Object.defineProperty({__proto__:null,Box:Do,Sphere:Dt},Symbol.toStringTag,{value:"Module"}));function ot(l,e){return new xi(l,e)}const ls=class Pc{constructor(e,t){this.__id=Pc.__counter__++,this._eventNames=[],e&&this.registerNames(e),this._sender=t||this,this._stopPropagation=!1,this._stampCache={}}bindSender(e){this._sender=e||this}registerNames(e){for(let t=0;t<e.length;t++)this[e[t]]={active:!0,handlers:[]},this._eventNames.push(e[t]);return this}_getStamp(e,t,s){return`${e}_${t}_${s}`}_stamp(e,t){let s=Gr(t),n=this._getStamp(e,this.__id,s);return!this._stampCache[n]&&(this._stampCache[n]=s,!0)}on(e,t,s,n=0){if(this._stamp(e,t)&&this[e]){let o=t.bind(s||this._sender);o._openglobus_id=t._openglobus_id,o._openglobus_priority=n,Wr(this[e].handlers,o,(a,h)=>(h._openglobus_priority||0)-(a._openglobus_priority||0))}}off(e,t){if(t){let s=this._getStamp(e,this.__id,t._openglobus_id);if(t._openglobus_id&&this._stampCache[s]){let n=this[e].handlers,o=n.length,a=-1;for(;o--;)if(n[o]._openglobus_id===t._openglobus_id){a=o;break}a!==-1&&(n.splice(a,1),this._stampCache[s]=void 0,delete this._stampCache[s])}}}dispatch(e,...t){let s=!0;if(e&&e.active&&!this._stopPropagation){let n=e.handlers.slice(0),o=n.length;for(;o--;)n[o](...t)===!1&&(s=!1)}return this._stopPropagation=!1,s}stopPropagation(){this._stopPropagation=!0}clear(){for(let e=0;e<this._eventNames.length;e++){let t=this[this._eventNames[e]];t.handlers.length=0,t.handlers=[]}this._eventNames.length=0,this._eventNames=[]}};ls.__counter__=0;let xi=ls;const Ha=["render"],Ht=class Yt{constructor(e={}){this.__id=Yt.__counter__++,this.events=ot(Ha),this.model=e.model||null,this.template=e.template||"",this.parent=e.parent||null,this._classList=e.classList||[],this.el=null,e.initRender&&this.render()}on(e,t,s,n){this.events.on(e,t,s,n)}off(e,t){this.events.off(e,t)}static getHTML(e,t){return zt(e,t)}static parseHTML(e){return jr(e)}static insertAfter(e,t){Array.isArray(e)||(e=[e]);for(let s=0;s<e.length;s++)t.parentNode&&t.parentNode.insertBefore(e[s],t.nextSibling);return e}static insertBefore(e,t){Array.isArray(e)||(e=[e]);for(let s=0;s<e.length;s++)t.parentNode&&t.parentNode.insertBefore(e[s],t);return e}insertBefore(e){this.el||this.render(),this.el&&(e instanceof HTMLElement&&e.parentNode&&Yt.insertBefore(this.el,e),e instanceof Yt&&e.el&&e.el.parentNode&&Yt.insertBefore(this.el,e.el))}insertAfter(e){this.el||this.render(),this.el&&(e instanceof HTMLElement&&e.parentNode&&Yt.insertAfter(this.el,e),e instanceof Yt&&e.el&&e.el.parentNode&&Yt.insertAfter(this.el,e.el))}isEqual(e){return e.__id===this.__id}appendTo(e,t=!1,s=!1){return e&&(this.el||(this.beforeRender(e),this.render()),this.el&&this.el.parentNode&&this.el.parentNode.removeChild(this.el),t&&(e.innerHTML=""),this.el&&(s&&e.childNodes[0]?Yt.insertBefore(this.el,e.childNodes[0]):e.appendChild(this.el)),this.afterRender(e)),this}afterRender(e){}beforeRender(e){}stopPropagation(){this.events.stopPropagation()}renderTemplate(e){return Yt.parseHTML(Yt.getHTML(this.template,e||{}))[0]}render(e){this.el=this.renderTemplate(e);for(let t=0,s=this._classList.length;t<s;t++)this.el.classList.add(this._classList[t]);return this.events.dispatch(this.events.render,this),this}select(e){return this.el?this.el.querySelector(e):null}selectRemove(e){if(this.el){let t=this.select(e);if(t&&t.parentNode)return t.parentNode.removeChild(t),t}}selectAll(e,t){if(this.el){const s=this.el.querySelectorAll(e);if(t)for(let n=0,o=s.length;n<o;n++)t(s[n],n);return s}}remove(){this.el&&this.el.parentNode&&this.el.parentNode.removeChild(this.el)}};Ht.__counter__=0;let dt=Ht;const Va=["click","mousedown","mouseup","touchstart","touchend","touchcancel"];class he extends dt{constructor(e={}){super({template:zt(`<div class="og-button" title="{title}">
       <div class="og-button-icon">{icon}</div>
       <div class="og-button-text">{text}</div>
    </div>`,{icon:e.icon||"",text:e.text||"",title:e.title||""}),...e}),this._onMouseDown=t=>{t.preventDefault(),this.events.dispatch(this.events.mousedown,this,t)},this._onMouseUp=t=>{t.preventDefault(),this.events.dispatch(this.events.mouseup,this,t)},this._onTouchStart=t=>{t.preventDefault(),this.events.dispatch(this.events.touchstart,this,t)},this._onTouchEnd=t=>{t.preventDefault(),this.events.dispatch(this.events.touchend,this,t)},this._onTouchCancel=t=>{t.preventDefault(),this.events.dispatch(this.events.touchcancel,this,t)},this._onMouseClick=t=>{this._mouseClickHandler(t)},this.events=this.events.registerNames(Va),this.el=null,this.name=e.name||"",this.$icon=null,this.$text=null}render(e){return super.render(e),this.$icon=this.select(".og-button-icon"),this.$text=this.select(".og-button-text"),this.el.__og_button__=this,this._initEvents(),this}_initEvents(){this.el&&(this.el.addEventListener("click",this._onMouseClick),this.el.addEventListener("mousedown",this._onMouseDown),this.el.addEventListener("mouseup",this._onMouseUp),this.el.addEventListener("touchstart",this._onTouchStart),this.el.addEventListener("touchend",this._onTouchEnd),this.el.addEventListener("touchcancel",this._onTouchCancel))}_mouseClickHandler(e){e.preventDefault(),this.events.dispatch(this.events.click,this,e)}remove(){this._clearEvents(),super.remove()}_clearEvents(){this.el&&this.el.removeEventListener("click",this._onMouseClick)}}const hs=class Sc{constructor(e={}){this.__id=Sc.__counter__++,this._name=e.name||`_control_${this.__id.toString()}`,this.planet=null,this._initialized=!1,this.renderer=null,this.autoActivate=e.autoActivate||!1,this._active=!1,this._deferredActive=!0}get name(){return this._name}oninit(){}onadd(){}onremove(){}onactivate(){}ondeactivate(){}addTo(e){e&&(this.renderer=e,e.controls[this.name]=this,this.onadd&&this.onadd(),e.isInitialized()&&!this._initialized&&(this._initialized=!0,this.oninit&&this.oninit(),this.autoActivate&&this.activate()))}remove(){this.deactivate(),this.onremove&&this.onremove();let e=this.renderer,t=this.name;if(!e)return;let s=e.controls[t];s&&this.isEqual(s)&&delete e.controls[t],this.renderer=null,this._active=!1,this._initialized=!1}activate(){this._active||(this._initialized||(this._initialized=!0,this.oninit&&this.oninit()),this._deferredActive?(this._active=!0,this.onactivate&&this.onactivate()):this._deferredActive=!0)}deactivate(){this._active?(this._active=!1,this.ondeactivate&&this.ondeactivate()):this._initialized||(this._deferredActive=!1)}isActive(){return this._active}isEqual(e){return e.__id===this.__id}};hs.__counter__=0;let Z=hs;class Fo extends Z{constructor(e={}){super(e),this._heading=0,this._svg=null}oninit(){let e=new he({classList:["og-map-button","og-compass-button"],icon:`<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<svg
   xmlns:dc="http://purl.org/dc/elements/1.1/"
   xmlns:cc="http://creativecommons.org/ns#"
   xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
   xmlns:svg="http://www.w3.org/2000/svg"
   xmlns="http://www.w3.org/2000/svg"
   xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd"
   xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"
   viewBox="0 0 110.6 110.3"
   version="1.1"
   id="svg21"
   sodipodi:docname="aaa.svg"
   inkscape:version="0.92.3 (2405546, 2018-03-11)">
  <metadata
     id="metadata11">
    <rdf:RDF>
      <cc:Work
         rdf:about="">
        <dc:format>image/svg+xml</dc:format>
        <dc:type
           rdf:resource="http://purl.org/dc/dcmitype/StillImage" />
      </cc:Work>
    </rdf:RDF>
  </metadata>
  <defs
     id="defs25" />
  <sodipodi:namedview
     pagecolor="#ffffff"
     bordercolor="#666666"
     borderopacity="1"
     objecttolerance="10"
     gridtolerance="10"
     guidetolerance="10"
     inkscape:pageopacity="0"
     inkscape:pageshadow="2"
     inkscape:window-width="1920"
     inkscape:window-height="1001"
     id="namedview23"
     showgrid="false"
     inkscape:zoom="9.4900968"
     inkscape:cx="28.376998"
     inkscape:cy="60.17054"
     inkscape:window-x="-9"
     inkscape:window-y="-9"
     inkscape:window-maximized="1"
     inkscape:current-layer="svg21" />
  <g
     id="Layer_2"
     data-name="Layer 2"
     transform="matrix(1,0,0,-1,0,110.3)">
    <g
       id="Слой_1"
       data-name="Слой 1">
      <g
         id="_Group_"
         data-name="&lt;Group&gt;">
        <g
           id="_Group_7"
           data-name="&lt;Group&gt;">
          <polygon
             id="_Path_7"
             data-name="&lt;Path&gt;"
             points="55.2,97.6 55.3,97.4 55.3,97.6 55.3,97.2 65.3,55.1 55.3,55.1 55.2,55.1 45.3,55.1 55.2,97.2 "
             style="fill:#ff2b45" />
          <polygon
             id="_Path_8"
             data-name="&lt;Path&gt;"
             points="55.3,12.7 55.3,12.9 55.2,12.7 55.2,13.1 45.3,55.1 55.2,55.1 55.3,55.1 65.3,55.1 55.3,13.1 "
             style="fill:#cecece;" />
        </g>
      </g>
    </g>
  </g>
</svg>`});e.appendTo(this.renderer.div),e.events.on("click",this._onClick,this),e.events.on("touchstart",this._onClick,this),this._svg=e.select("svg"),this.renderer.events.on("draw",this._draw,this)}_onClick(){const e=this.planet;let t=e.getCartesianFromPixelTerrain(this.renderer.handler.getCenter());t?e.flyCartesian(t.normal().scaleTo(t.length()+t.distance(e.camera.eye)),{amplitude:0,completeCallback:()=>{e.camera.look(t)}}):e.flyCartesian(e.camera.eye)}_draw(){this.setHeading(this.planet.camera.getHeading())}setHeading(e){this._heading!==e&&(this._heading=e,this._svg.style.transform=`rotateZ(${-e}deg)`)}}const Oo=`<svg className="svg-icon" style="width: 1em; height: 1em;vertical-align: middle;fill: currentColor; overflow: hidden;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
    <path d="M777.856 280.192l-33.92-33.952-231.872 231.872-231.84-231.872-33.984 33.888 231.872 231.904-231.84 231.84 33.888 33.984 231.904-231.904 231.84 231.872 33.952-33.888-231.872-231.904z"/>
</svg>`,Ua=["resize","focus","visibility","dragstart","dragend"],cs=class Rc extends dt{constructor(e={}){super({template:zt(`<div class="og-ddialog" 
        style="display:{display}; resize:{resize}; width: {width}px; {height}; top: {top}px; left: {left}px; min-height: {minHeight}; max-height: {maxHeight}; min-width: {minWidth}; max-width: {maxWidth};">
       <div class="og-ddialog-header">
         <div class="og-ddialog-header__title">{title}</div>      
         <div class="og-ddialog-header__buttons"></div>      
        </div>
       <div class="og-ddialog-container"></div>
    </div>>`,{title:e.title||"",display:Hi(e.visible,!0)?"flex":"none",resize:Hi(e.resizable,!0)?"both":"none",width:e.width||300,height:e.height?`height: ${e.height||200}px`:"",left:e.left||0,top:e.top||0,minHeight:e.minHeight?`${e.minHeight}px`:"unset",maxHeight:e.maxHeight?`${e.maxHeight}px`:"unset",minWidth:e.minWidth?`${e.minWidth}px`:"unset",maxWidth:e.maxWidth?`${e.maxWidth}px`:"unset"}),...e}),this._onCloseBtnClick=()=>{this.close()},this._onMouseDownAll=()=>{this.bringToFront()},this._onMouseDown=t=>{t.preventDefault(),this._startDragging(),this._startPosX=t.clientX,this._startPosY=t.clientY,document.addEventListener("mousemove",this._onMouseMove),document.addEventListener("mouseup",this._onMouseUp)},this._onMouseMove=t=>{t.preventDefault();let s=this._startPosX-t.clientX,n=this._startPosY-t.clientY;this._startPosX=t.clientX,this._startPosY=t.clientY,this.setPosition(this.el.offsetLeft-s,this.el.offsetTop-n)},this._onMouseUp=()=>{this._clearDragging(),document.removeEventListener("mouseup",this._onMouseUp),document.removeEventListener("mousemove",this._onMouseMove)},this.events=this.events.registerNames(Ua),this._width=e.width||300,this._height=e.height||200,this._startPosX=0,this._startPosY=0,this.$header=null,this.$title=null,this.$container=null,this.$buttons=null,this._closeBtn=new he({icon:Oo,classList:["og-button-size__20"]}),this.useHide=e.useHide||!1,this._visibility=Hi(e.visible,!0),this._right=e.right!=null?e.right:null}setContainer(e){this.$container.innerHTML=e}get container(){return this.$container}get width(){return this.el?parseFloat(this.el.style.width):this._width}get height(){return this.el?parseFloat(this.el.style.height):this._height}bringToFront(){this.el.style.zIndex=String(Rc.__zIndex__++)}render(e){return super.render(e),this.bringToFront(),this.$header=this.select(".og-ddialog-header"),this.$title=this.select(".og-ddialog-header__title"),this.$container=this.select(".og-ddialog-container"),this.$buttons=this.select(".og-ddialog-header__buttons"),this._initEvents(),this._initButtons(),this._right!=null&&(this.el.style.visibility="hidden",new IntersectionObserver((t,s)=>{t.forEach(n=>{n.isIntersecting&&(this.el.style.visibility="visible",this.el.parentNode&&(this.setPosition(this.el.parentNode.clientWidth-this.el.clientWidth-this._right),s.disconnect()))})}).observe(this.el)),this}show(){this._visibility||(this._visibility=!0,this.el.style.display="flex",this.bringToFront(),this.events.dispatch(this.events.visibility,!0,this))}hide(){this._visibility&&(this._visibility=!1,this.el.style.display="none",this.events.dispatch(this.events.visibility,!1,this))}close(){this.useHide?this.hide():this.remove()}setVisibility(e){e?this.show():this.hide()}getVisibility(){return this._visibility}_initButtons(){this._closeBtn.events.on("click",this._onCloseBtnClick),this._closeBtn.appendTo(this.$buttons)}_initEvents(){this.$header.addEventListener("mousedown",this._onMouseDown),this.el.addEventListener("mousedown",this._onMouseDownAll)}setPosition(e,t){e!=null&&(this.el.style.left=`${e}px`),t!=null&&(this.el.style.top=`${t}px`)}_startDragging(){this.el.classList.contains("dragging")||(this.el.classList.add("dragging"),this.events.dispatch(this.events.dragstart,this))}_clearDragging(){this.el.classList.contains("dragging")&&(this.events.dispatch(this.events.dragend,this),this.el.classList.remove("dragging"))}remove(){this._clearDragging(),this._clearEvents(),super.remove()}_clearEvents(){this._closeBtn.events.off("click",this._onCloseBtnClick),document.removeEventListener("mouseup",this._onMouseUp),document.removeEventListener("mousemove",this._onMouseMove),this.$header.removeEventListener("mousedown",this._onMouseDown),this.el.removeEventListener("mousedown",this._onMouseDownAll)}};cs.__zIndex__=0;let Zt=cs;const Ga=["change"];class ct extends he{constructor(e){super({...e}),this._onMouseClick=t=>{this.preventClick||(this._mouseClickHandler(t),this.setActive(!this.isActive))},this.events=this.events.registerNames(Ga),this._isActive=e.isActive||!1,this.preventClick=e.preventClick||!1}setActive(e,t=!1){e!==this._isActive&&(this._isActive=e,this._toggle(),t||this.events.dispatch(this.events.change,e,this))}_toggle(){this.el&&this.el.classList.toggle("og-button__active")}get isActive(){return this._isActive}render(e){return super.render(e),this._isActive&&this._toggle(),this}}const ci=[2,3,0,1],yn=[[-1,-1,0,1],[1,-1,3,-1],[2,3,-1,-1],[-1,0,-1,2]],ja=[[2,3,0,1],[1,0,3,2],[2,3,0,1],[1,0,3,2]],qa=[[0,1,0,0],[1,0,0,0],[0,1,0,1],[1,1,1,1]];class No{constructor(e,t){this.segment=e,this.layer=t,this.isReady=!1,this.isLoading=!1,this.texture=null,this.pickingMask=null,this.textureExists=!1,this.appliedNodeId=0,this.appliedNode=null,this.texOffset=[0,0,1,1],this.loadingAttempts=0,this._updateTexture=null,this._updatePickingMask=null,this.pickingReady=!1}abortLoading(){this.layer.abortMaterialLoading(this)}_createTexture(e){return this.layer._planet&&this.layer.createTexture(e,this.layer._internalFormat,this.isReady?this.texture:null)}applyImage(e){this.segment.initialized&&(this._updateTexture=null,this.texture=this._createTexture(e),this.isReady=!0,this.pickingReady=!0,this.textureExists=!0,this.isLoading=!1,this.appliedNodeId=this.segment.node.nodeId,this.texOffset=[0,0,1,1])}applyTexture(e,t){this.segment.initialized&&(this.texture=e,this._updateTexture=null,this.pickingMask=t||null,this._updatePickingMask=null,this.isReady=!0,this.pickingReady=!0,this.textureExists=!0,this.isLoading=!1,this.appliedNodeId=this.segment.node.nodeId,this.texOffset=[0,0,1,1])}textureNotExists(){this.segment.initialized&&(this.pickingReady=!0,this.isLoading=!1,this.isReady=!0,this.textureExists=!1)}clear(){this.loadingAttempts=0,this.layer.clearMaterial(this)}}const ds=class Mc{constructor(e,t={}){if(this.isVector=!1,this.__id=Mc.__counter__++,this._iconSrc=t.iconSrc||null,this.events=ot(Ho,this),this.name=e||"noname",this.properties=t.properties||{},this.hideInLayerSwitcher=t.hideInLayerSwitcher||!1,this._hasImageryTiles=!0,this._opacity=t.opacity!=null?t.opacity:1,this.minZoom=t.minZoom||0,this.maxZoom=t.maxZoom!=null?t.maxZoom:50,this._planet=null,this.isVector=!1,this._attribution=t.attribution||"",this._zIndex=t.zIndex||0,this._isBaseLayer=t.isBaseLayer||!1,this._defaultTextures=t.defaultTextures||[null,null],this._visibility=t.visibility===void 0||t.visibility,this._fading=t.fading||!1,this._fadingFactor=this._opacity/30,this._fading?this._fadingOpacity=0:this._fadingOpacity=this._opacity,this._height=t.height||0,this._extent=new H,this.createTexture=null,this._textureFilter=t.textureFilter?t.textureFilter.trim().toUpperCase():"MIPMAP",this._isSRGB=t.isSRGB!=null&&t.isSRGB,this._internalFormat=null,this._extentMerc=new H,this.setExtent(qr(t.extent,new H(new A(-180,-90),new A(180,90)))),this._pickingColor=new m,this._pickingEnabled=t.pickingEnabled===void 0||t.pickingEnabled,this._isPreloadDone=!1,this._preLoadZoomLevels=t.preLoadZoomLevels||[0,1],this._ambient=null,this._diffuse=null,this._specular=null,t.ambient){let s=Gt(t.ambient,new m(.2,.2,.2));this._ambient=new Float32Array([s.x,s.y,s.z])}if(t.diffuse){let s=Gt(t.diffuse,new m(.8,.8,.8));this._diffuse=new Float32Array([s.x,s.y,s.z])}if(t.specular){let s=Gt(t.specular,new m(3e-4,3e-4,3e-4)),n=t.shininess||20;this._specular=new Float32Array([s.x,s.y,s.z,n])}this.nightTextureCoefficient=t.nightTextureCoefficient||1}get iconSrc(){return this._iconSrc}set iconSrc(e){this._iconSrc=e}set diffuse(e){if(e){let t=Gt(e);this._diffuse=new Float32Array(t.toArray())}else this._diffuse=null}set ambient(e){if(e){let t=Gt(e);this._ambient=new Float32Array(t.toArray())}else this._ambient=null}set specular(e){if(e){let t=Gt(e);this._specular=new Float32Array([t.x,t.y,t.y,this._specular?this._specular[3]:0])}else this._specular=null}set shininess(e){this._specular&&(this._specular[3]=e)}static getTMS(e,t,s){return{x:e,y:(1<<s)-t-1,z:s}}static getTileIndex(e,t,s,n){return`${n}::${e}_${t}_${s}`}get instanceName(){return"Layer"}get rendererEvents(){return this.events}set opacity(e){e!==this._opacity&&(this._fading?e>this._opacity?this._fadingFactor=(e-this._opacity)/30:e<this._opacity&&(this._fadingFactor=(this._opacity-e)/30):this._fadingOpacity=e,this._opacity=e)}set pickingEnabled(e){this._pickingEnabled=e}get pickingEnabled(){return this._pickingEnabled}hasImageryTiles(){return this._hasImageryTiles}getID(){return this.__id}get id(){return this.__id}get _id(){return this.__id}isEqual(e){return e.__id===this.__id}_assignPlanet(e){this._planet=e,e._layers.push(this),e.renderer&&e.renderer.isInitialized()&&(this._isSRGB?this._internalFormat=e.renderer.handler.gl.SRGB8_ALPHA8:this._internalFormat=e.renderer.handler.gl.RGBA8,this.createTexture=e.renderer.handler.createTexture[this._textureFilter],this.events.on("visibilitychange",e._onLayerVisibilityChanged,e),this._isBaseLayer&&this._visibility&&e.setBaseLayer(this),e.events.dispatch(e.events.layeradd,this),this.events.dispatch(this.events.add,e),e.updateVisibleLayers(),this._bindPicking(),this._visibility&&this.hasImageryTiles()&&this._preLoad())}get isIdle(){return this._planet&&this._planet.quadTreeStrategy._terrainCompletedActivated||!1}_bindPicking(){this._planet&&this._planet.renderer&&this._planet.renderer.assignPickingColor(this)}addTo(e){this._planet||this._assignPlanet(e)}remove(){let e=this._planet;if(e){for(let t=0;t<e._layers.length;t++)if(this.isEqual(e._layers[t]))return e.renderer&&e.renderer.clearPickingColor(this),e._layers.splice(t,1),e.updateVisibleLayers(),this.clear(),e.events.dispatch(e.events.layerremove,this),this.events.dispatch(this.events.remove,e),this._planet=null,this._internalFormat=null,this.createTexture=null,this}return this}clear(){this._planet&&this._planet._clearLayerMaterial(this)}get planet(){return this._planet}setAttribution(e){this._attribution!==e&&(this._attribution=e,this._planet&&this._planet.updateAttributionsList())}getAttribution(){return this._attribution}setHeight(e){this._height=e,this._planet&&this._planet.updateVisibleLayers()}getHeight(){return this._height}setZIndex(e){this._zIndex=e,this._planet&&this._planet.updateVisibleLayers()}getZIndex(){return this._zIndex}bringToFront(){if(this._planet){let e=this._planet.visibleTileLayers,t=e[e.length-1];t.isEqual(this)||this.setZIndex(t.getZIndex()+1)}}isBaseLayer(){return this._isBaseLayer}setBaseLayer(e){this._isBaseLayer=e,this._planet&&(!e&&this._planet.baseLayer&&this.isEqual(this._planet.baseLayer)&&(this._planet.baseLayer=null),this._planet.updateVisibleLayers())}setVisibility(e){e!==this._visibility&&(this._visibility=e,this._planet&&(this._isBaseLayer&&e&&this._planet.setBaseLayer(this),this._planet.updateVisibleLayers(),!e||this._isPreloadDone||this.isVector||(this._isPreloadDone=!0,this._preLoad())),this.events.dispatch(this.events.visibilitychange,this))}_forceMaterialApply(e){let t=e.materials,s=t[this.__id];s||(s=t[this.__id]=this.createMaterial(e)),s.isReady||(e.quadTreeStrategy._renderCompleted=!1),this.applyMaterial(s,!0)}clearMaterial(e){}loadMaterial(e,t=!1){}applyMaterial(e,t=!1){return[0,0,1,1]}_preLoadRecursive(e,t){if(!(e.segment.tileZoom>t)){this._preLoadZoomLevels.includes(e.segment.tileZoom)&&this._forceMaterialApply(e.segment);for(let s=0,n=e.nodes.length;s<n;s++)e.nodes[s]&&this._preLoadRecursive(e.nodes[s],t)}}_preLoad(){if(this._planet&&this._preLoadZoomLevels.length){let e=this._planet,t=Math.max(...this._preLoadZoomLevels);for(let s=0,n=e.quadTreeStrategy.quadTreeList.length;s<n;s++)this._preLoadRecursive(e.quadTreeStrategy.quadTreeList[s],t)}}getVisibility(){return this._visibility}setExtent(e){let t=e.southWest.clone(),s=e.northEast.clone();t.lat<Ft&&(t.lat=Ft),s.lat>ht&&(s.lat=ht),this._extent=e.clone(),this._extentMerc=new H(t.forwardMercator(),s.forwardMercator()),this._correctFullExtent()}getExtent(){return this._extent}getExtentMerc(){return this._extentMerc}flyExtent(){var e;(e=this._planet)==null||e.flyExtent(this.getExtent())}viewExtent(){var e;(e=this._planet)==null||e.viewExtent(this.getExtent())}_correctFullExtent(){}get opacity(){return this._opacity}get screenOpacity(){return this._fading?this._fadingOpacity:this._opacity}_refreshFadingOpacity(e,t){let s=this._planet;return this._visibility&&s.getViewExtent().overlaps(this._extent)&&t>=this.minZoom&&e<=this.maxZoom?(this._fadingOpacity+=this._fadingFactor,(this._fadingFactor>0&&this._fadingOpacity>this._opacity||this._fadingFactor<0&&this._fadingOpacity<this._opacity)&&(this._fadingOpacity=this._opacity),!1):(this._fadingOpacity-=this._fadingFactor,this._fadingOpacity<=0&&(this._fadingOpacity=0),!1)}createMaterial(e){return new No(e,this)}redraw(){var e;(e=this._planet)==null||e.quadTreeStrategy.clearLayerMaterial(this)}abortMaterialLoading(e){}abortLoading(){}};ds.__counter__=0;let It=ds;const Ho=["visibilitychange","add","remove","mousemove","mouseenter","mouseleave","lclick","rclick","mclick","ldblclick","rdblclick","mdblclick","lup","rup","mup","ldown","rdown","mdown","lhold","rhold","mhold","mousewheel","touchmove","touchstart","touchend","doubletouch","touchleave","touchenter"],Ya=["load","loadend"],Vt=class ti extends It{constructor(e,t){super(e,t),this.events=this.events.registerNames(Ya),this.animated=t.animated||!1,this.minNativeZoom=t.minNativeZoom||0,this.maxNativeZoom=t.maxNativeZoom||100,this._counter=0,this._pendingsQueue=[],this.drawTile=t.drawTile,this._onLoadend_=null}addTo(e){return this._onLoadend_=this._onLoadend.bind(this),this.events.on("loadend",this._onLoadend_,this),super.addTo(e)}remove(){return this.events.off("loadend",this._onLoadend_),this._onLoadend_=null,super.remove()}_onLoadend(){this._planet&&this._planet.quadTreeStrategy._terrainCompletedActivated&&this._planet.events.dispatch(this._planet.events.layerloadend,this)}get instanceName(){return"CanvasTiles"}get isIdle(){return super.isIdle&&this._counter===0}abortLoading(){this._pendingsQueue.forEach(e=>{this.abortMaterialLoading(e)}),this._pendingsQueue=[]}setVisibility(e){e!==this._visibility&&(super.setVisibility(e),e||this.abortLoading())}loadMaterial(e){let t=e.segment;this._isBaseLayer?e.texture=t.getDefaultTexture():e.texture=t.planet.transparentTexture,(this._planet.layerLock.isFree()||e.segment.tileZoom<2)&&(e.isReady=!1,e.isLoading=!0,ti.__requestsCounter>=ti.MAX_REQUESTS&&this._counter?this._pendingsQueue.push(e):this._exec(e))}_exec(e){ti.__requestsCounter++,this._counter++;const t=this.events.load;t.handlers.length&&this.events.dispatch(t,e),requestAnimationFrame(()=>{this.drawTile(e,s=>{this._counter--,ti.__requestsCounter--,this._correctCounter(),e.isLoading&&e.applyImage(s),this._dequeueRequest()})})}_correctCounter(){this._counter<0&&(this._counter=0),ti.__requestsCounter<0&&(ti.__requestsCounter=0)}abortMaterialLoading(e){e.isLoading&&(this._counter--,ti.__requestsCounter--,this._correctCounter(),this._dequeueRequest()),e.isLoading=!1,e.isReady=!1}_dequeueRequest(){if(this._pendingsQueue.length){if(ti.__requestsCounter<ti.MAX_REQUESTS){const e=this._whilePendings();e&&this._exec(e)}}else this._counter===0&&this._planet&&this._planet.quadTreeStrategy._terrainCompletedActivated&&this.events.dispatch(this.events.loadend)}_whilePendings(){for(;this._pendingsQueue.length;){const e=this._pendingsQueue.pop();if(e&&e.segment&&e.segment.node){if(e.segment.initialized&&e.segment.node.getState()===1)return e;e.isLoading=!1}}return null}applyMaterial(e){if(e.isReady)return e.layer.animated&&requestAnimationFrame(()=>{this.drawTile(e,function(t){e.applyImage(t)})}),e.texOffset;if(e.segment.tileZoom<this.minNativeZoom)e.textureNotExists();else{let t=e.segment,s=t.node,n=!1,o=e.layer.maxNativeZoom;t.passReady&&!e.isLoading&&t.tileZoom<=o&&this.loadMaterial(e);let a=this._id,h=e;for(;s.parentNode;)if(s=s.parentNode,h=s.segment.materials[a],h&&h.textureExists){n=!0;break}if(t.passReady){if(s.segment.tileZoom===o)t.tileZoom>o&&e.textureNotExists();else if(s.segment.tileZoom<o){let c=t.node;for(;c.segment.tileZoom>o;)c=c.parentNode;let d=c.segment.materials[a];d?!d.isLoading&&!d.isReady&&this.loadMaterial(d):(d=c.segment.materials[e.layer._id]=e.layer.createMaterial(c.segment),this.loadMaterial(d))}}if(n){e.layer.animated&&requestAnimationFrame(()=>{e.segment&&this.drawTile(e,function(d){e.applyImage(d)})}),e.appliedNodeId=s.nodeId,e.texture=h.texture;let c=1/(2<<t.tileZoom-s.segment.tileZoom-1);e.texOffset[0]=t.tileX*c-s.segment.tileX,e.texOffset[1]=t.tileY*c-s.segment.tileY,e.texOffset[2]=c,e.texOffset[3]=c}else e.texture=t.planet.transparentTexture,e.texOffset[0]=0,e.texOffset[1]=0,e.texOffset[2]=1,e.texOffset[3]=1}return e.texOffset}clearMaterial(e){e.isReady&&(e.isReady=!1,e.textureExists&&e.texture&&!e.texture.default&&(e.segment.handler.gl.deleteTexture(e.texture),e.texture=null)),this.abortMaterialLoading(e),e.isLoading=!1,e.textureExists=!1,e.layer=null,e.segment=null}};Vt.MAX_REQUESTS=20,Vt.__requestsCounter=0;let es=Vt;const Wa=["change"];class Vo{constructor(e={}){this._onChange=(t,s)=>{if(t){s.preventClick=!0;for(let n=0;n<this._buttons.length;n++){let o=this._buttons[n];o.isEqual(s)||(o.setActive(!1),o.preventClick=!1)}this.events.dispatch(this.events.change,s)}},this.events=ot(Wa),this._buttons=e.buttons||[];for(let t=0;t<this._buttons.length;t++)this._bindButton(this._buttons[t])}_bindButton(e){e.events.on("change",this._onChange)}add(e){this._buttons.push(e),this._bindButton(e)}remove(e){for(let t=0;t<this._buttons.length;t++)if(this._buttons[t].isEqual(e))return this._buttons.splice(t),void e.events.off("change",this._onChange)}}class Qr{constructor(e=2,t){this._sourceId=0,this._source=new Map,this._pendingQueue=[],this._numWorkers=e,this._workerQueue=[],t&&this.setProgram(t)}check(){this._pendingQueue.length&&this.make(this._pendingQueue.pop())}setProgram(e){if(Ms(e)){let t=new Blob([e],{type:"application/javascript"});for(let s=0;s<this._numWorkers;s++){let n=new Worker(URL.createObjectURL(t));n.onmessage=o=>{this._onMessage(o),this._workerQueue&&this._workerQueue.unshift(o.target),this.check()},this._workerQueue.push(n)}}else for(let t=0;t<this._numWorkers;t++){let s=new e;s.onmessage=n=>{this._onMessage(n),this._workerQueue&&this._workerQueue.unshift(n.target),this.check()},this._workerQueue.push(s)}}make(e){}_onMessage(e){}destroy(){for(let e=0;e<this._workerQueue.length;e++){const t=this._workerQueue[e];t.onmessage=null,t.terminate()}this._pendingQueue=[],this._workerQueue=[]}get pendingQueue(){return this._pendingQueue}}const Uo=`(function(){"use strict";function n(i,f,u){let o=u.length,b=f*o;for(let A=0;A<o;A++)i[b+A]=u[A]}self.onmessage=function(i){var f=i.data.labelData,u=f[0],o=f[1],b=f[2],A=f[3],z=f[4],D=f[5],H=f[6],I=f[7],L=f[8],M=f[9],P=f[10],j=f[11],q=f[12],B=f[13],E=f[14],G=f[15],J=f[16],K=f[17],N=f[18],O=f[19],Q=f[20],R=f[21],S=f[22],T=f[23],U=f[24],Z=f[25],_=f[26],$=f[27],V=f[28],X=f[29];let w=new Float32Array(12*o),s=new Float32Array(24*o),y=new Float32Array(24*o),F=new Float32Array(18*o),g=new Float32Array(18*o),c=new Float32Array(6*o),d=new Float32Array(18*o),p=new Float32Array(24*o),x=new Float32Array(6*o),h=new Float32Array(18*o),v=new Float32Array(6*o),C=new Float32Array(6*o),m=new Float32Array(24*o),k=new Float32Array(18*o);for(let t=0;t<o;t++){n(w,t,b!==0?[0,0,0,-1,1,-1,1,-1,1,0,0,0]:[0,0,0,0,0,0,0,0,0,0,0,0]),n(s,t,[0,0,-1,0,0,0,-1,0,0,0,-1,0,0,0,-1,0,0,0,-1,0,0,0,-1,0]),n(y,t,[1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0]);var l,r=A,e=z,a=D;n(F,t,[r,e,a,r,e,a,r,e,a,r,e,a,r,e,a,r,e,a]),n(g,t,[r=H,e=I,a=L,r,e,a,r,e,a,r,e,a,r,e,a,r,e,a]),n(c,t,[r=M,r,r,r,r,r]),n(d,t,[r=P,e=j,a=q,r,e,a,r,e,a,r,e,a,r,e,a,r,e,a]),n(p,t,[r=B,e=E,a=G,l=J,r,e,a,l,r,e,a,l,r,e,a,l,r,e,a,l,r,e,a,l]),n(x,t,[r=K,r,r,r,r,r]),n(h,t,[r=N,e=O,a=Q,r,e,a,r,e,a,r,e,a,r,e,a,r,e,a]),n(v,t,[r=R,r,r,r,r,r]),n(C,t,[r=S,r,r,r,r,r]),n(m,t,[r=T,e=U,a=Z,l=_,r,e,a,l,r,e,a,l,r,e,a,l,r,e,a,l,r,e,a,l]),n(k,t,[r=$/255,e=V/255,a=X/255,r,e,a,r,e,a,r,e,a,r,e,a,r,e,a])}self.postMessage({id:u,vertexArr:w,texCoordArr:s,gliphParamArr:y,positionHighArr:F,positionLowArr:g,sizeArr:c,offsetArr:d,rgbaArr:p,rotationArr:x,alignedAxisArr:h,fontIndexArr:v,outlineArr:C,outlineColorArr:m,pickingColorArr:k},[w.buffer,s.buffer,y.buffer,F.buffer,g.buffer,c.buffer,d.buffer,p.buffer,x.buffer,h.buffer,v.buffer,C.buffer,m.buffer,k.buffer])}})();
//# sourceMappingURL=LabelWorker.worker-BT1uJgYn.js.map
`;typeof self<"u"&&self.Blob&&new Blob([Uo],{type:"text/javascript;charset=utf-8"});const us=class Ic{constructor(e={}){this.__id=Ic.__counter__++,this._position=qt(e.position),this._positionHigh=new m,this._positionLow=new m,m.doubleToTwoFloats(this._position,this._positionHigh,this._positionLow),this._rotation=e.rotation||0,this._color=ae(e.color),this._alignedAxis=qt(e.alignedAxis),this._offset=qt(e.offset),this._visibility=e.visibility==null||e.visibility,this._entity=null,this._handler=null,this._handlerIndex=-1,this._isReady=!1,this._lockId=-1}setPosition(e,t,s){this._position.x=e,this._position.y=t,this._position.z=s,m.doubleToTwoFloats(this._position,this._positionHigh,this._positionLow),this._isReady&&this._handler?this._handler.setPositionArr(this._handlerIndex,this._positionHigh,this._positionLow):this._lockId!==-1&&(this._lockId=-2)}setPosition3v(e){this._position.x=e.x,this._position.y=e.y,this._position.z=e.z,m.doubleToTwoFloats(e,this._positionHigh,this._positionLow),this._isReady&&this._handler?this._handler.setPositionArr(this._handlerIndex,this._positionHigh,this._positionLow):this._lockId!==-1&&(this._lockId=-2)}getPosition(){return this._position}setOffset(e,t,s){this._offset.x=e,this._offset.y=t,s!=null&&(this._offset.z=s),this._isReady&&this._handler?this._handler.setOffsetArr(this._handlerIndex,this._offset):this._lockId!==-1&&(this._lockId=-2)}setOffset3v(e){this.setOffset(e.x,e.y,e.z)}getOffset(){return this._offset}setRotation(e){e!==this._rotation&&(this._rotation=e,this._isReady&&this._handler?this._handler.setRotationArr(this._handlerIndex,e):this._lockId!==-1&&(this._lockId=-2))}getRotation(){return this._rotation}setOpacity(e){e!==this._color.w&&(e!=null&&(this._color.w=e),this._isReady&&this._handler?this._handler.setRgbaArr(this._handlerIndex,this._color):this._lockId!==-1&&(this._lockId=-2))}setColor(e,t,s,n){n===this._color.w&&e===this._color.x&&t===this._color.y&&this._color.z===s||(this._color.x=e,this._color.y=t,this._color.z=s,n!=null&&(this._color.w=n),this._isReady&&this._handler?this._handler.setRgbaArr(this._handlerIndex,this._color):this._lockId!==-1&&(this._lockId=-2))}setColor4v(e){this.setColor(e.x,e.y,e.z,e.w)}setColorHTML(e){this.setColor4v(le(e))}getColor(){return this._color}setVisibility(e){e!==this._visibility&&(this._visibility=e,this._isReady&&this._handler?this._handler.setVisibility(this._handlerIndex,e):this._lockId!==-1&&(this._lockId=-2))}getVisibility(){return this._visibility}setAlignedAxis(e,t,s){this._alignedAxis.x=e,this._alignedAxis.y=t,this._alignedAxis.z=s,this._isReady&&this._handler?this._handler.setAlignedAxisArr(this._handlerIndex,this._alignedAxis):this._lockId!==-1&&(this._lockId=-2)}setAlignedAxis3v(e){this.setAlignedAxis(e.x,e.y,e.z)}getAlignedAxis(){return this._alignedAxis}remove(){this._entity=null,this._handler&&this._handler.remove(this)}setPickingColor3v(e){this._isReady&&this._handler?this._handler.setPickingColorArr(this._handlerIndex,e):this._lockId!==-1&&(this._lockId=-2)}serializeWorkerData(e){return this._handler?new Float32Array([]):null}};us.__counter__=0;let is=us;class Za extends is{constructor(e={}){super(e),this._handler=null,this._src=e.src||null,this._image=e.image||null,this._scale=1,this._width=e.width||(e.size?e.size[0]:30),this._height=e.height||(e.size?e.size[1]:30)}setSrc(e){this._src=e;let t=this._handler;if(t&&e&&e.length){let s=t._entityCollection.renderNode;if(s&&s.renderer){let n=s.renderer.billboardsTextureAtlas,o=this;n.loadImage(e,function(a){a.__nodeIndex!=null&&n.get(a.__nodeIndex)?(o._image=a,t.setTexCoordArr(o._handlerIndex,n.get(o._image.__nodeIndex).texCoords)):(n.addImage(a),n.createTexture(),o._image=a,s.updateBillboardsTexCoords())})}}}getSrc(){return this._src}setImage(e){this.setSrc(e.src)}getImage(){return this._image}setSize(e,t){this._width=e,this._height=t,this._handler&&this._handler.setSizeArr(this._handlerIndex,e*this._scale,t*this._scale)}getSize(){return{width:this._width,height:this._height}}setWidth(e){this.setSize(e,this._height)}getWidth(){return this._width}setHeight(e){this.setSize(this._width,e)}getHeight(){return this._height}}var ni=(l=>(l[l.POINT=1]="POINT",l[l.LINESTRING=2]="LINESTRING",l[l.POLYGON=3]="POLYGON",l[l.MULTIPOLYGON=4]="MULTIPOLYGON",l[l.MULTILINESTRING=5]="MULTILINESTRING",l))(ni||{});const Ka={POINT:1,LINESTRING:2,POLYGON:3,MULTIPOLYGON:4,MULTILINESTRING:5},de=class ji{constructor(e={}){this.__id=ji.__counter__++,this._entity=null,this._handler=null,this._handlerIndex=-1,this._polyVerticesHighMerc=[],this._polyVerticesLowMerc=[],this._polyVerticesLength=-1,this._polyIndexesLength=-1,this._polyVerticesHandlerIndex=-1,this._polyIndexesHandlerIndex=-1,this._lineVerticesHighMerc=[],this._lineVerticesLowMerc=[],this._lineVerticesLength=-1,this._lineOrdersLength=-1,this._lineIndexesLength=-1,this._lineColorsLength=-1,this._lineThicknessLength=-1,this._lineVerticesHandlerIndex=-1,this._lineOrdersHandlerIndex=-1,this._lineIndexesHandlerIndex=-1,this._lineThicknessHandlerIndex=-1,this._lineColorsHandlerIndex=-1,this._type=e.type&&ji.getType(e.type)||1,this._coordinates=e.coordinates||[],this._extent=ji.getExtent({type:e.type||"POINT",coordinates:e.coordinates||[]},this._coordinates),e.style=e.style||{},this._style={fillColor:ae(e.style.fillColor,new J(.19,.62,.85,.4)),lineColor:ae(e.style.lineColor,new J(.19,.62,.85,1)),strokeColor:ae(e.style.strokeColor,new J(1,1,1,.95)),lineWidth:e.style.lineWidth||3,strokeWidth:e.style.strokeWidth||0},this._visibility=e.visibility||!0,this._pickingReady=!1}get id(){return this.__id}get type(){return this._type}static getType(e){return Ka[e.toUpperCase()]}static getExtent(e,t){let s=new H(new A(180,90),new A(-180,-90)),n=ji.getType(e.type);if(n===1){let o=e.coordinates[0],a=e.coordinates[1];s.southWest.lon=o,s.southWest.lat=a,s.northEast.lon=o,s.northEast.lat=a,t&&(t[0]=o)&&(t[1]=a)}else if(n===2){let o=e.coordinates;for(let a=0;a<o.length;a++){let h=o[a][0],c=o[a][1];h<s.southWest.lon&&(s.southWest.lon=h),c<s.southWest.lat&&(s.southWest.lat=c),h>s.northEast.lon&&(s.northEast.lon=h),c>s.northEast.lat&&(s.northEast.lat=c),t&&(t[a]=[h,c])}}else if(n===3){let o=e.coordinates;for(let a=0;a<o.length;a++){let h=o[a];t&&(t[a]=[]);for(let c=0;c<h.length;c++){let d=h[c],u=d[0],_=d[1];u<s.southWest.lon&&(s.southWest.lon=u),_<s.southWest.lat&&(s.southWest.lat=_),u>s.northEast.lon&&(s.northEast.lon=u),_>s.northEast.lat&&(s.northEast.lat=_),t&&(t[a][c]=[u,_])}}}else if(n===4){let o=e.coordinates;for(let a=0;a<o.length;a++){let h=o[a];t&&(t[a]=[]);for(let c=0;c<h.length;c++){let d=h[c];t&&(t[a][c]=[]);for(let u=0;u<d.length;u++){let _=d[u],f=_[0],v=_[1];f<s.southWest.lon&&(s.southWest.lon=f),v<s.southWest.lat&&(s.southWest.lat=v),f>s.northEast.lon&&(s.northEast.lon=f),v>s.northEast.lat&&(s.northEast.lat=v),t&&(t[a][c][u]=[f,v])}}}}else if(n===5){let o=e.coordinates;for(let a=0;a<o.length;a++){let h=o[a];t&&(t[a]=[]);for(let c=0;c<h.length;c++){let d=h[c],u=d[0],_=d[1];u<s.southWest.lon&&(s.southWest.lon=u),_<s.southWest.lat&&(s.southWest.lat=_),u>s.northEast.lon&&(s.northEast.lon=u),_>s.northEast.lat&&(s.northEast.lat=_),t&&(t[a][c]=[u,_])}}}else s.southWest.lon=s.southWest.lat=s.northEast.lon=s.northEast.lat=0,t&&(t[0]=0)&&(t[1]=0);return s}setGeometry(e){let t=this._handler;return t&&(this.remove(),this._type=ji.getType(e.type||"Point"),this._extent=ji.getExtent(e,this._coordinates),t.add(this)),this}setFillColor(e,t,s,n=1){let o=this._style.fillColor;return(o.w===0&&n!==0||o.w!==0&&n===0)&&(this._pickingReady=!1),o.x=e,o.y=t,o.z=s,o.w=n,this._handler&&this._handler.setPolyColorArr(this,o),this}overlaps(e){return this._extent.overlaps(e)}setFillColor4v(e){return this.setFillColor(e.x,e.y,e.z,e.w)}setStrokeColor(e,t,s,n=1){let o=this._style.strokeColor;return(o.w===0&&n!==0||o.w!==0&&n===0)&&(this._pickingReady=!1),o.x=e,o.y=t,o.z=s,o.w=n,this._handler&&this._handler.setLineStrokeColorArr(this,o),this}setLineColor(e,t,s,n=1){let o=this._style.lineColor;return(o.w===0&&n!==0||o.w!==0&&n===0)&&(this._pickingReady=!1),o.x=e,o.y=t,o.z=s,o.w=n,this._handler&&this._handler.setLineColorArr(this,o),this}setStrokeColor4v(e){return this.setStrokeColor(e.x,e.y,e.z,e.w)}setLineColor4v(e){return this.setLineColor(e.x,e.y,e.z,e.w)}setStrokeOpacity(e){let t=this._style.strokeColor;return t.w=e,this.setStrokeColor(t.x,t.y,t.z,e)}setLineOpacity(e){let t=this._style.lineColor;return t.w=e,this.setLineColor(t.x,t.y,t.z,e)}setStrokeWidth(e){return this._style.strokeWidth=e,this._pickingReady=!1,this._handler&&this._handler.setLineStrokeArr(this,e),this}bringToFront(){return this._handler&&this._handler.bringToFront(this),this}setLineWidth(e){return this._style.lineWidth=e,this._pickingReady=!1,this._handler&&this._handler.setLineThicknessArr(this,e),this}setFillOpacity(e){let t=this._style.fillColor;return(t.w===0&&e!==0||t.w!==0&&e===0)&&(this._pickingReady=!1),t.w=e,this._handler&&this._handler.setPolyColorArr(this,t),this}setVisibility(e){return this._visibility=e,this._handler&&this._handler.setGeometryVisibility(this),this}getVisibility(){return this._visibility}remove(){this._handler&&this._handler.remove(this)}getExtent(){return this._extent.clone()}getType(){return this._type}};de.__counter__=0;let gr=de;class Kt{constructor(e,t){this.p0=e||new m,this.p1=t||new m}getMagnitude(){return this.p0.distance(this.p1)}getSphereIntersection(e){let t=this.p0,s=this.p1,n=e.center.x,o=e.center.y,a=e.center.z,h=t.x,c=t.y,d=t.z,u=s.x-h,_=s.y-c,f=s.z-d,v=u*u+_*_+f*f,g=2*(h*u+c*_+d*f-u*n-_*o-f*a),y=g*g-4*v*(h*h-2*h*n+n*n+c*c-2*c*o+o*o+d*d-2*d*a+a*a-e.radius*e.radius);if(y<0)return[];let p=(-g-Math.sqrt(y))/(2*v),x=new m(t.x*(1-p)+p*s.x,t.y*(1-p)+p*s.y,t.z*(1-p)+p*s.z);if(y==0)return[x];let T=(-g+Math.sqrt(y))/(2*v),w=new m(t.x*(1-T)+T*s.x,t.y*(1-T)+T*s.y,t.z*(1-T)+T*s.z);return Math.abs(p-.5)<Math.abs(T-.5)?[x,w]:[w,x]}intersects(e,t,s){let n=this.p0.sub(e.p0),o=e.p1.sub(e.p0);if(Math.abs(o.x)<re&&Math.abs(o.y)<re&&Math.abs(o.z)<re)return!1;let a=this.p1.sub(this.p0);if(Math.abs(a.x)<re&&Math.abs(a.y)<re&&Math.abs(a.z)<re)return!1;let h=n.x*o.x+n.y*o.y+n.z*o.z,c=o.x*a.x+o.y*a.y+o.z*a.z,d=n.x*a.x+n.y*a.y+n.z*a.z,u=o.x*o.x+o.y*o.y+o.z*o.z,_=(a.x*a.x+a.y*a.y+a.z*a.z)*u-c*c;if(Math.abs(_)<re)return!1;let f=(h*c-d*u)/_;if(t.x=this.p0.x+f*a.x,t.y=this.p0.y+f*a.y,t.z=this.p0.z+f*a.z,s){let v=(h+c*f)/u;s.x=e.p0.x+v*o.x,s.y=e.p0.y+v*o.y,s.z=e.p0.z+v*o.z}return!0}getNearestDistancePoint(e,t){let s=this.p0,n=this.p1,o=this.getMagnitude(),a=((e.x-s.x)*(n.x-s.x)+(e.y-s.y)*(n.y-s.y)+(e.z-s.z)*(n.z-s.z))/(o*o);return t.x=s.x+a*(n.x-s.x),t.y=s.y+a*(n.y-s.y),t.z=s.z+a*(n.z-s.z),!(a<0||a>1)}}class mt{constructor(e,t){this.p=e?e.clone():new m,this.n=t?t.clone():this.p.isZero()?m.UP:this.p.getNormal()}setByPoints(e,t,s){let n=m.sub(t,e),o=m.sub(s,e);return this.n=n.cross(o),this.p.copy(e),this}static fromPoints(e,t,s){return new mt().setByPoints(e,t,s)}set(e,t){this.p.copy(e),this.n.copy(t)}getNormal(){return this.n.clone()}distance(e){let t=this.getProjection(e);return e.distance(t)}getProjection(e,t){return m.proj_b_to_plane(e,this.n,t)}getProjectionPoint(e,t){let s=e.sub(this.p),n=this.n,o=s.dot(n);return t?t.copy(n.scale(o)):t=n.scale(o),e.sub(t)}getIntersection(e,t,s){let n,o=e.n.cross(t.n),a=o.x>=0?o.x:-o.x,h=o.y>=0?o.y:-o.y,c=o.z>=0?o.z:-o.z;if(a+h+c<mo){let f=t.p.sub(e.p);return e.n.dot(f)==0?1:0}n=a>h?a>c?1:3:h>c?2:3;let d,u,_=new m;return d=-e.n.dot(e.p),u=-t.n.dot(t.p),n===1?(_.x=0,_.y=(u*e.n.z-d*t.n.z)/o.x,_.z=(d*t.n.y-u*e.n.y)/o.x):n===2?(_.x=(d*t.n.z-u*e.n.z)/o.y,_.y=0,_.z=(u*e.n.x-d*t.n.x)/o.y):n===3&&(_.x=(u*e.n.y-d*t.n.y)/o.z,_.y=(d*t.n.x-u*e.n.x)/o.z,_.z=0),s.p0.copy(_),s.p1.copy(_.add(o)),2}}let N=class Mi{constructor(e=m.ZERO,t=m.ZERO){this.origin=e,this.direction=t}static get OUTSIDE(){return 0}static get INSIDE(){return 1}static get INPLANE(){return 2}static get AWAY(){return 3}set(e,t){return this.origin=e,this.direction=t,this}getPoint(e){return m.add(this.origin,this.direction.scaleTo(e))}hitTriangleRes(e,t,s,n){let o=t.sub(e),a=s.sub(e),h=o.cross(a),c=this.origin.sub(e),d=-h.dot(c),u=h.dot(this.direction);if(Math.abs(u)<re)return d===0?(n.copy(this.origin),Mi.INPLANE):Mi.OUTSIDE;let _=d/u;if(n.copy(this.origin.add(this.direction.scaleTo(_))),_<0)return Mi.AWAY;let f=o.dot(o),v=o.dot(a),g=a.dot(a),y=n.sub(e),p=y.dot(o),x=y.dot(a),T=v*v-f*g,w=(v*x-g*p)/T;if(w<0||w>1)return Mi.OUTSIDE;let C=(v*p-f*x)/T;return C<0||w+C>1?Mi.OUTSIDE:Mi.INSIDE}hitPlaneRes(e,t){const s=this.direction.dot(e.n);if(Math.abs(s)<re)return Mi.OUTSIDE;const n=e.p.sub(this.origin).dot(e.n)/s;return n<0?Mi.AWAY:(t.copy(this.getPoint(n)),Mi.INSIDE)}hitSphere(e){const t=m.sub(this.origin,e.center),s=this.direction.dot(this.direction),n=2*t.dot(this.direction),o=n*n-4*s*(t.dot(t)-e.radius*e.radius);if(o<0)return null;const a=Math.sqrt(o);let h=(-n-a)/(2*s);return h<0&&(h=(-n+a)/(2*s)),h<0?null:m.add(this.origin,this.direction.scaleTo(h))}hitBox(e){}};function Us(l){let e=l.split("/"),t=e[e.length-1],s=e[e.length-2];return`${s?s+"/":""}${t}`}class bn{constructor(){this.objPositions=[],this.objTexcoords=[],this.objNormals=[],this.objVertexData=[this.objPositions,this.objTexcoords,this.objNormals],this.vertexData=[[],[],[]],this._materialLibs=[],this.geometries=[],this.geometry=null,this.materials={},this.material={},this.object="default",this.groups=["default"],this._path="",this.keywords={v:e=>{this.objPositions.push(e.map(parseFloat))},vn:e=>{this.objNormals.push(e.map(parseFloat))},vt:e=>{this.objTexcoords.push([parseFloat(e[0]),1-parseFloat(e[1])])},f:e=>{this.setGeometry();const t=e.length-2;for(let s=0;s<t;++s)this.addVertex(e[0]),this.addVertex(e[s+1]),this.addVertex(e[s+2])},s:()=>{},mtllib:(e,t)=>{this._materialLibs.push(t)},usemtl:(e,t)=>{this.newGeometry(),this.setGeometry(),this.geometry&&(this.geometry.material=t)},g:e=>{this.groups=e,this.newGeometry()},o:(e,t)=>{this.object=t,this.newGeometry()},newmtl:(e,t)=>{const s={};this.material=s,this.materials[t]=s},Ns:(e,t)=>{this.material.shininess=parseFloat(t)},Ni:(e,t)=>{},Ka:(e,t)=>{this.material.ambient=e.map(s=>parseFloat(s))},Kd:(e,t)=>{this.material.diffuse=e.map(s=>parseFloat(s))},Ks:(e,t)=>{this.material.specular=e.map(s=>parseFloat(s))},Ke:(e,t)=>{this.material.color=e.map(s=>parseFloat(s))},illum:(e,t)=>{this.material.illum=parseFloat(t)},d:(e,t)=>{this.material.opacity=parseFloat(t)},Tr:(e,t)=>{this.material.opacity=parseFloat(t)},Tf:(e,t)=>{},map_Ka:(e,t)=>{},map_Kd:(e,t)=>{this.material.colorTexture=`${this._path}/${Us(t)}`},map_Bump:(e,t)=>{this.material.normalTexture=`${this._path}/${Us(t)}`},map_Ns:(e,t)=>{this.material.metallicRoughnessTexture=`${this._path}/${Us(t)}`}}}newGeometry(){this.geometry&&this.geometry.data.vertices.length&&(this.geometry=null)}setGeometry(){if(!this.geometry){const e=[],t=[],s=[];this.vertexData=[e,t,s],this.geometry={object:this.object,groups:this.groups,material:"",data:{vertices:e,texCoords:t,normals:s}},this.geometries.push(this.geometry)}}addVertex(e){let t=e.split("/");for(let s=0;s<t.length;s++){let n=t[s];if(!n)continue;let o=parseInt(n)-1,a=this.vertexData[s],h=a.length,c=this.objVertexData[s][o],d=c.length;this.vertexData[s].length=h+d;for(let u=0;u<d;u++)a[h+u]=c[u]}}_innerParser(e,t){const s=/(\w*)(?: )*(.*)/,n=e.split(`
`);for(let o=0;o<n.length;++o){const a=n[o].trim();if(a===""||a.startsWith("#"))continue;const h=s.exec(a);if(!h)continue;const[,c,d]=h,u=a.split(/\s+/).slice(1),_=this.keywords[c];_?_(u,d):console.warn(`Unknown keyword '${c}' in '${t}:${o}'`)}}get data(){return{geometries:this.geometries,materials:this.materials}}async load(e){this._path=e.substring(0,e.lastIndexOf("/"));const t=await fetch(e);if(!t.ok)throw new Error(`Unable to load '${e}'`);const s=t.body.getReader(),n=new TextDecoder;let{value:o,done:a}=await s.read(),h="";for(;!a;){const d=(h+n.decode(o,{stream:!0})).split(`
`);h=d.pop();for(const u of d)this._innerParser(u,e);({value:o,done:a}=await s.read())}h&&this._innerParser(h,e),this._cleanupGeometryArrays();let c=this._materialLibs.map(d=>(d=`${this._path}/${d}`,fetch(d).then(u=>u.text()).then(u=>({text:u,filename:d}))));return await Promise.all(c).then(d=>{d.forEach(u=>this._innerParser(u.text,u.filename))}),this.data}async _readAndParse(e){const t=e.stream().getReader(),s=new TextDecoder;let{value:n,done:o}=await t.read(),a="";for(;!o;){const h=(a+s.decode(n,{stream:!0})).split(`
`);a=h.pop();for(const c of h)this._innerParser(c,e.name);({value:n,done:o}=await t.read())}a&&this._innerParser(a,e.name)}async readFile(e,t){return this._path="",await this._readAndParse(e),this._cleanupGeometryArrays(),t&&await this._readAndParse(t),this.data}_cleanupGeometryArrays(){for(const e of this.geometries)e.data=Object.fromEntries(Object.entries(e.data).filter(([t,s])=>s.length>0))}}function ke(l){let e=new Float32Array([1,1,1]);if(l instanceof Array)e[0]=l[0],e[1]=l[1],e[2]=l[2];else if(typeof l=="string"){let t=me(l);e[0]=t[0],e[1]=t[1],e[2]=t[2]}return e}class W{constructor(e={}){var t;if(this._name=e.name||"noname",this._vertices=e.vertices||[],this._numVertices=this._vertices.length/3,this._texCoords=e.texCoords||new Array(2*this._numVertices),this.color=(t=e.color)instanceof Array?new Float32Array(t):typeof t=="string"?me(t):new Float32Array([.5,.5,.5,1]),this.ambient=ke(e.ambient),this.diffuse=ke(e.diffuse),this.specular=ke(e.specular),this.shininess=e.shininess||100,this.colorTextureSrc=e.colorTextureSrc||null,this.colorTextureImage=e.colorTextureImage||null,this.normalTextureSrc=e.normalTextureSrc||null,this.normalTextureImage=e.normalTextureImage||null,this.metallicRoughnessTextureSrc=e.metallicRoughnessTextureSrc||null,this.metallicRoughnessTextureImage=e.metallicRoughnessTextureImage||null,e.scale){let s,n=e.scale;s=typeof n=="number"?new m(n,n,n):n,W.scale(this._vertices,s)}if(e.center&&W.centering(this._vertices),this.center=W.getCenter(this._vertices),e.indices)this._indices=e.indices,this._normals=e.normals||[];else{this._normals=e.normals||W.getNormals(this._vertices),this._indices=new Array(this._vertices.length/3);for(let s=0,n=this._indices.length;s<n;s++)this._indices[s]=s}}static getCenter(e){let t=yt,s=yt,n=yt,o=Tt,a=Tt,h=Tt;for(let c=0,d=e.length;c<d;c+=3){let u=e[c],_=e[c+1],f=e[c+2];u<t&&(t=u),_<s&&(s=_),f<n&&(n=f),u>o&&(o=u),_>a&&(a=_),f>h&&(h=f)}return new m(t+.5*(o-t),s+.5*(a-s),n+.5*(h-n))}static centering(e){let t=W.getCenter(e);for(let s=0,n=e.length;s<n;s+=3)e[s]-=t.x,e[s+1]-=t.y,e[s+2]-=t.z}setMaterial(e){return e.ambient&&(this.ambient=ke(e.ambient)),e.diffuse&&(this.diffuse=ke(e.diffuse)),e.specular&&(this.specular=ke(e.specular)),e.shininess!==void 0&&(this.shininess=e.shininess),this}centering(){return W.centering(this._vertices),this}applyMat4(e){for(let t=0,s=this._vertices.length;t<s;t+=3){let n=new m(this._vertices[t],this._vertices[t+1],this._vertices[t+2]),o=new m(this._normals[t],this._normals[t+1],this._normals[t+2]);n=e.mulVec3(n),o=e.mulVec3(o),this._vertices[t]=n.x,this._vertices[t+1]=n.y,this._vertices[t+2]=n.z,this._normals[t]=o.x,this._normals[t+1]=o.y,this._normals[t+2]=o.z}return this}scale(e){return W.scale(this._vertices,e),this}translate(e){for(let t=0,s=this._vertices.length;t<s;t+=3)this._vertices[t]+=e.x,this._vertices[t+1]+=e.y,this._vertices[t+2]+=e.z;return this}get name(){return this._name}get vertices(){return this._vertices}get normals(){return this._normals}get indices(){return this._indices}get texCoords(){return this._texCoords}get numVertices(){return this._numVertices}static scale(e,t){for(let s=0;s<e.length;s+=3)e[s]*=t.x,e[s+1]*=t.y,e[s+2]*=t.z}static centroid(e){let t=1e3,s=1e3,n=1e3,o=-1e3,a=-1e3,h=-1e3;for(let c=0;c<e.length;c+=3){let d=e[c],u=e[c+1],_=e[c+2];d<t&&(t=d),u<s&&(s=u),_<n&&(n=_),d>o&&(o=d),u>a&&(a=u),_>h&&(h=_)}return[t+.5*(o-t),s+.5*(a-s),n+.5*(h-n)]}static translate(e,t){for(let s=0;s<e.length;s+=3)e[s]+=t[0],e[s+1]+=t[1],e[s+2]+=t[2]}static getNormals(e){let t=new Array(e.length);for(let s=0;s<e.length;s+=9){let n=s,o=s+3,a=s+6,h=e[n],c=e[n+1],d=e[n+2],u=e[o]-h,_=e[o+1]-c,f=e[o+2]-d,v=e[a]-h,g=e[a+1]-c,y=e[a+2]-d,p=_*y-f*g,x=f*v-u*y,T=u*g-_*v,w=Math.sqrt(p*p+x*x+T*T);p/=w,x/=w,T/=w,t[n]=p,t[n+1]=x,t[n+2]=T,t[o]=p,t[o+1]=x,t[o+2]=T,t[a]=p,t[a+1]=x,t[a+2]=T}return t}static createSphere(e=16,t=16,s=1,n=0,o=0,a=0){let h=[],c=[],d=[];for(let u=0;u<=t;u++){let _=u*Math.PI/t,f=Math.sin(_),v=Math.cos(_);for(let g=0;g<=e;g++){let y=2*g*Math.PI/e,p=Math.sin(y),x=Math.cos(y)*f+n,T=v+o,w=p*f+a;d.push(x),d.push(T),d.push(w),h.push(s*x),h.push(s*T),h.push(s*w)}}for(let u=0;u<t;u++)for(let _=0;_<e;_++){let f=u*(e+1)+_,v=f+e+1;c.push(f),c.push(f+1),c.push(v),c.push(v),c.push(f+1),c.push(v+1)}return new W({vertices:h,normals:d,indices:c})}static createDisc(e=1,t=0,s=8,n=!0,o=0,a=0,h=0,c=0){let d=[],u=[],_=[],f=2*Math.PI,v=n?1:-1,g=o;for(let p=1;p<=s;p++)d.push(a,t*v+h,c),_.push(0,v,0),o++;let y=o;for(let p=0;p<=s;p++){let x=p/s*f+0,T=Math.cos(x),w=Math.sin(x);d.push(e*w+a,t*v+h,e*T+c),_.push(0,v,0),o++}for(let p=0;p<s;p++){let x=g+p,T=y+p;n?u.push(T,T+1,x):u.push(T+1,T,x)}return new W({vertices:d,normals:_,indices:u})}static getFrustumScaleByCameraAngles(e,t,s){return new m(2*e*Math.tan(ie*t),2*e*Math.tan(ie*s),e)}static getFrustumScaleByCameraAspectRatio(e,t,s){let n=Hr*Math.atan(Math.tan(ie*t)/s);return W.getFrustumScaleByCameraAngles(e,t,n)}static createFrustum(e=1,t=1,s=1,n=0,o=0,a=0){return new W({vertices:[0+n,0+o,0+a,-1*(t*=.5)+n,1*(s*=.5)+o,-1*e+a,1*t+n,1*s+o,-1*e+a,0+n,0+o,0+a,1*t+n,-1*s+o,-1*e+a,-1*t+n,-1*s+o,-1*e+a,0+n,0+o,0+a,1*t+n,1*s+o,-1*e+a,1*t+n,-1*s+o,-1*e+a,0+n,0+o,0+a,-1*t+n,-1*s+o,-1*e+a,-1*t+n,1*s+o,-1*e+a,0+n,0+o,0+a,1*t+n,1*s+o,-1*e+a,-1*t+n,1*s+o,-1*e+a,0+n,0+o,0+a,-1*t+n,-1*s+o,-1*e+a,1*t+n,-1*s+o,-1*e+a,0+n,0+o,0+a,1*t+n,-1*s+o,-1*e+a,1*t+n,1*s+o,-1*e+a,0+n,0+o,0+a,-1*t+n,1*s+o,-1*e+a,-1*t+n,-1*s+o,-1*e+a]})}static createCylinder(e=1,t=1,s=1,n=32,o=1,a=!0,h=!0,c=0,d=0,u=0){let _=[],f=[],v=[],g=2*Math.PI,y=0,p=[],x=new m,T=(t-e)/s;for(let w=0;w<=o;w++){let C=[],E=w/o,L=E*(t-e)+e;for(let S=0;S<=n;S++){let P=S/n*g+0,R=Math.sin(P),M=Math.cos(P);_.push(L*R+c,-E*s+s+d,L*M+u),x.set(R,T,M).normalize(),v.push(x.x,x.y,x.z),C.push(y++)}p.push(C)}for(let w=0;w<n;w++)for(let C=0;C<o;C++){let E=p[C][w],L=p[C+1][w],S=p[C+1][w+1],P=p[C][w+1];f.push(E,L,P),f.push(L,S,P)}if(e!==0&&a){let w=W.createDisc(e,s,n,!0,y,c,d,u);_.push(...w.vertices),v.push(...w.normals),f.push(...w.indices)}if(t!==0&&h){let w=W.createDisc(t,0,n,!1,y+(a?1+2*n:0),c,d,u);_.push(...w.vertices),v.push(...w.normals),f.push(...w.indices)}return new W({vertices:_,normals:v,indices:f})}static createCube(e=1,t=1,s=1,n=0,o=0,a=0){let h=.5*e+n,c=.5*t+o,d=.5*s+a;return new W({vertices:[-h,-c,d,h,-c,-d,h,-c,d,-h,-c,d,-h,-c,-d,h,-c,-d,-h,c,d,h,c,d,h,c,-d,-h,c,d,h,c,-d,-h,c,-d,-h,-c,d,h,-c,d,-h,c,d,-h,c,d,h,-c,d,h,c,d,-h,-c,-d,-h,c,-d,h,-c,-d,-h,c,-d,h,c,-d,h,-c,-d,h,-c,d,h,-c,-d,h,c,d,h,c,d,h,-c,-d,h,c,-d,-h,-c,d,-h,c,d,-h,-c,-d,-h,c,d,-h,c,-d,-h,-c,-d]})}static createPlane(e=1,t=1,s=0,n=0,o=0){let a=.5*e,h=.5*t;return new W({vertices:[-a+s,n,h+o,a+s,n,-h+o,a+s,n,h+o,-a+s,n,h+o,-a+s,n,-h+o,a+s,n,-h+o,-a+s,n,h+o,a+s,n,h+o,a+s,n,-h+o,-a+s,n,h+o,a+s,n,-h+o,-a+s,n,-h+o]})}static createArrow(e=0,t=2.1,s=-15){return new W({vertices:[0,t,0,7,0,6,0,0,s,0,0,e,7,0,6,0,t,0,-7,0,6,0,0,e,0,t,0,-7,0,6,0,t,0,0,0,s,-7,0,6,0,0,s,0,0,e,0,0,e,0,0,s,7,0,6]})}static async readFileObj(e,t,s){const n=await new bn().readFile(e,t);let o=n.materials;return n.geometries.map(a=>{let h=o[a.material]||{};return new W({name:a.object,vertices:a.data.vertices,normals:a.data.normals,texCoords:a.data.texCoords,ambient:h.ambient,diffuse:h.diffuse,specular:h.specular,shininess:h.shininess,color:h.color,colorTextureSrc:s?`${s}/${h.colorTexture}`:h.colorTexture,normalTextureSrc:s?`${s}/${h.normalTexture}`:h.normalTexture,metallicRoughnessTextureSrc:s?`${s}/${h.metallicRoughnessTexture}`:h.metallicRoughnessTexture})})}static async loadObj(e){const t=await new bn().load(e);let s=t.materials;return t.geometries.map(n=>{let o=s[n.material]||{};return new W({name:n.object,vertices:n.data.vertices,normals:n.data.normals,texCoords:n.data.texCoords,ambient:o.ambient,diffuse:o.diffuse,specular:o.specular,shininess:o.shininess,color:o.color,colorTextureSrc:o.colorTexture,normalTextureSrc:o.normalTexture,metallicRoughnessTextureSrc:o.metallicRoughnessTexture})})}merge(e){const t=this._vertices.length/3;let s=this._vertices.length;this._vertices.length=s+e._vertices.length;for(let n=0;n<e._vertices.length;n++)this._vertices[s+n]=e._vertices[n];s=this._normals.length,this._normals.length=s+e._normals.length;for(let n=0;n<e._normals.length;n++)this._normals[s+n]=e._normals[n];s=this._texCoords.length,this._texCoords.length=s+e._texCoords.length;for(let n=0;n<e._texCoords.length;n++)this._texCoords[s+n]=e._texCoords[n];s=this._indices.length,this._indices.length=s+e._indices.length;for(let n=0;n<e._indices.length;n++)this._indices[s+n]=e._indices[n]+t;return this._numVertices=this._vertices.length/3,this}static merge(e,t){let s=new W,n=t||e.length;for(let o=0;o<n;o++)s.merge(e[o]);return s}}const Qa=new m(0,0,-1),_s=class Bc{constructor(e){var t,s;this._handlerIndex=-1,this._tag=e.tag||"tag_"+Bc.__counter__++,this._entity=null,this._position=qt(e.position),this._rtcPositionHigh=new m,this._rtcPositionLow=new m,this._scale=qt(e.scale,new m(1,1,1)),this._translate=qt(e.translate,new m),this._localPosition=new m;const[n=.15,o=.15,a=.15,h=1]=(t=e.object3d)!=null&&t.color?Array.from(e.object3d.color):[];this._color=ae(e.color,new J(n,o,a,h)),this._handler=null,this._handlerIndex=-1,this._tagData=null,this._tagDataIndex=-1;let c=e.object3d;e.object3d&&((s=e.object3d)==null?void 0:s.vertices.length)!==0||(c=new W),e.objSrc&&(this.setObjectSrc(e.objSrc),this._objectSrc=e.objSrc),this._object3d=c,this._visibility=e.visibility==null||e.visibility,this._children=[],this._direction=new m,this._qFrame=new D,this._qRot=D.IDENTITY}get tag(){return this._tag}getPosition(){return this._position}get object3d(){return this._object3d}get vertices(){return this._object3d.vertices}get normals(){return this._object3d.normals}get texCoords(){return this._object3d.texCoords}get indices(){return this._object3d.indices}setOpacity(e){this._color.w=e,this.setColor(this._color.x,this._color.y,this._color.z,e)}getOpacity(){return this._color.w}setColor(e,t,s,n){this._color.x=e,this._color.y=t,this._color.z=s,n!=null&&(this._color.w=n),this._handler&&this._handler.setRgbaArr(this._tagData,this._tagDataIndex,this._color)}setColor4v(e){this._color.x=e.x,this._color.y=e.y,this._color.z=e.z,e.w!=null&&(this._color.w=e.w),this._handler&&this._handler.setRgbaArr(this._tagData,this._tagDataIndex,this._color)}setVisibility(e){this._visibility=e,this._handler&&this._handler.setVisibility(this._tagData,this._tagDataIndex,e)}getVisibility(){return this._visibility}setPosition(e,t,s){this._position.x=e,this._position.y=t,this._position.z=s,this.updateRTCPosition(),this.updateRotation()}updateRTCPosition(){this._handler&&(this._handler.getRTCPosition(this._position,this._rtcPositionHigh,this._rtcPositionLow),this._handler.setRTCPositionArr(this._tagData,this._tagDataIndex,this._rtcPositionHigh,this._rtcPositionLow))}setPosition3v(e){this.setPosition(e.x,e.y,e.z)}setObject(e){this._object3d=e}setObjectSrc(e){this._objectSrc=e,this._handler&&this._handler.setObjectSrc(e,this.tag)}setColorHTML(e){this.setColor4v(le(e))}setScale(e){this._scale.x=this._scale.y=this._scale.z=e,this._handler&&this._handler.setScaleArr(this._tagData,this._tagDataIndex,this._scale)}setScale3v(e){this._scale.copy(e),this._handler&&this._handler.setScaleArr(this._tagData,this._tagDataIndex,e)}getScale(){return this._scale}setTranslate3v(e){this._translate.copy(e),this._handler&&this._handler.setTranslateArr(this._tagData,this._tagDataIndex,e)}getTranslate(){return this._translate.clone()}setLocalPosition3v(e){this._localPosition.copy(e),this._handler&&this._handler.setLocalPositionArr(this._tagData,this._tagDataIndex,e)}getLocalPosition(){return this._localPosition.clone()}remove(){this._entity=null,this._handler&&this._handler.remove(this)}setPickingColor3v(e){this._handler&&this._handler.setPickingColorArr(this._tagData,this._tagDataIndex,e)}setRotation(e){this._qRot.copy(e),this._qRot.mulVec3Res(Qa,this._direction).normalize(),this.updateRotation()}getRotation(){return this._qRot}updateRotation(){this._handler&&this._handler.setQRotArr(this._tagData,this._tagDataIndex,this._qRot)}getDirection(){return this._direction.clone()}};_s.__counter__=0;let pr=_s;const di={RIGHT:0,LEFT:1,CENTER:2},wn={left:di.LEFT,right:di.RIGHT,center:di.CENTER};class Ja extends is{constructor(e={}){super(e),this._handler=null,this._text=e.text||"",this._face=So(e.face,"arial"),this._size=e.size||24,this._outline=e.outline!=null?e.outline:0,this._outlineColor=ae(e.outlineColor,new J(0,0,0,1)),this._align=e.align&&wn[e.align.trim().toLowerCase()]||di.RIGHT,this._fontIndex=0,this._fontAtlas=null,this._isRTL=e.isRTL||!1,this._letterSpacing=e.letterSpacing||0}setText(e){this._text=e.toString(),this._isReady&&this._handler&&this._handler.setText(this._handlerIndex,e,this._fontIndex,this._align,this._letterSpacing,this._isRTL)}setLetterSpacing(e){this._letterSpacing=e,this._isReady&&this._handler&&this._handler.setText(this._handlerIndex,this._text,this._fontIndex,this._align,e,this._isRTL)}getLetterSpacing(){return this._letterSpacing}setRtl(e){this._isRTL=e,this._isReady&&this._handler&&this._handler.setText(this._handlerIndex,this._text,this._fontIndex,this._align,this._letterSpacing,this._isRTL)}getText(){return this._text}setAlign(e){this._align=wn[e.trim().toLowerCase()],this._isReady&&this._handler?this._handler.setText(this._handlerIndex,this._text,this._fontIndex,this._align,this._letterSpacing,this._isRTL):this._lockId!==-1&&(this._lockId=-2)}getAlign(){return this._align}setFace(e){this._face=e.trim(),this.update()}getFace(){return this._face}setSize(e){e!==this._size&&(this._size=e,this._isReady&&this._handler?this._handler.setSizeArr(this._handlerIndex,e):this._lockId!==-1&&(this._lockId=-2))}getSize(){return this._size}setOutline(e){this._outline=e,this._isReady&&this._handler?this._handler.setOutlineArr(this._handlerIndex,e):this._lockId!==-1&&(this._lockId=-2)}getOutline(){return this._outline}setOpacity(e){super.setOpacity(e),this.setOutlineOpacity(e)}setOutlineColor(e,t,s,n){n===this._outlineColor.w&&e===this._outlineColor.x&&t===this._outlineColor.y&&s===this._outlineColor.z||(this._outlineColor.x=e,this._outlineColor.y=t,this._outlineColor.z=s,this._outlineColor.w=n,this._isReady&&this._handler?this._handler.setOutlineColorArr(this._handlerIndex,this._outlineColor):this._lockId!==-1&&(this._lockId=-2))}setOutlineColor4v(e){this.setOutlineColor(e.x,e.y,e.z,e.w)}setOutlineColorHTML(e){this.setOutlineColor4v(le(e))}getOutlineColor(){return this._outlineColor}setOutlineOpacity(e){e!==this._outlineColor.w&&(this._outlineColor.w=e,this._isReady&&this._handler?this._handler.setOutlineColorArr(this._handlerIndex,this._outlineColor):this._lockId!==-1&&(this._lockId=-2))}getOutlineOpacity(){return this._outlineColor.w}async update(){if(this._fontAtlas){const e=await this._fontAtlas.getFontIndex(this._face);this._applyFontIndex(e)}}_applyFontIndex(e){this._fontIndex=e,this._isReady&&this._handler?(this._handler.setFontIndexArr(this._handlerIndex,this._fontIndex),this._handler.setText(this._handlerIndex,this._text,this._fontIndex,this._align,this._letterSpacing,this._isRTL)):this._lockId!==-1&&(this._lockId=-2)}assignFontAtlas(e){this._fontAtlas||(this._fontAtlas=e),this.update()}serializeWorkerData(e){return this._handler?new Float32Array([e,this._handler._maxLetters,this.getVisibility()?1:0,this._positionHigh.x,this._positionHigh.y,this._positionHigh.z,this._positionLow.x,this._positionLow.y,this._positionLow.z,this._size,this._offset.x,this._offset.y,this._offset.z,this._color.x,this._color.y,this._color.z,this._color.w,this._rotation,this._alignedAxis.x,this._alignedAxis.y,this._alignedAxis.z,this._fontIndex,this._outline,this._outlineColor.x,this._outlineColor.y,this._outlineColor.z,this._outlineColor.w,this._entity._pickingColor.x,this._entity._pickingColor.y,this._entity._pickingColor.z]):null}}const fs=class Dc{constructor(e={}){this.__id=Dc.__counter__++,this.visibility=e.visibility==null||e.visibility,this.pointSize=e.pointSize||3,this.pickingScale=e.pickingScale||0,this._renderNode=null,this._entity=null,this._points=[],this._coordinatesData=[],this._colorData=[],this._pickingColorData=[],this._coordinatesBuffer=null,this._colorBuffer=null,this._pickingColorBuffer=null,this._handler=null,this._handlerIndex=-1,this._buffersUpdateCallbacks=[],this._buffersUpdateCallbacks[0]=this._createCoordinatesBuffer,this._buffersUpdateCallbacks[1]=this._createColorBuffer,this._buffersUpdateCallbacks[2]=this._createPickingColorBuffer,this._changedBuffers=new Array(this._buffersUpdateCallbacks.length),e.points&&this.setPoints(e.points)}clear(){this._points.length=0,this._points=[],this._coordinatesData.length=0,this._coordinatesData=[],this._colorData.length=0,this._colorData=[],this._pickingColorData.length=0,this._pickingColorData=[],this._deleteBuffers()}setVisibility(e){this.visibility=e}getVisibility(){return this.visibility}setRenderNode(e){this._renderNode=e,this._setPickingColors()}remove(){this._entity=null,this._handler&&this._handler.remove(this)}setPoints(e){this.clear();for(let t=0;t<e.length;t++){let s=e[t],n=new m(s[0],s[1],s[2]),o=new J(s[3],s[4],s[5],s[6]==null?255:s[6]);this._coordinatesData.push(n.x,n.y,n.z),this._colorData.push(o.x/255,o.y/255,o.z/255,o.w/255);let a={_entity:this._entity,_pickingColor:new m,_entityCollection:this._entity?this._entity._entityCollection:null,index:t,position:n,color:o,pointCloud:this,properties:s[7]||{}};this._points.push(a),this._renderNode&&this._renderNode.renderer&&(this._renderNode.renderer.assignPickingColor(a),this._pickingColorData.push(a._pickingColor.x/255,a._pickingColor.y/255,a._pickingColor.z/255,1))}this._changedBuffers[0]=!0,this._changedBuffers[1]=!0,this._changedBuffers[2]=!0}setPointPosition(e,t,s,n){this._changedBuffers[0]=!0}setPointColor(e,t,s,n,o){this._changedBuffers[1]=!0}addPoints(e){this._changedBuffers[0]=!0,this._changedBuffers[1]=!0,this._changedBuffers[2]=!0}addPoint(e,t){this._changedBuffers[0]=!0,this._changedBuffers[1]=!0,this._changedBuffers[2]=!0}getPoint(e){return this._points[e]}removePoint(e){this._changedBuffers[0]=!0,this._changedBuffers[1]=!0,this._changedBuffers[2]=!0}insertPoint(e,t){this._changedBuffers[0]=!0,this._changedBuffers[1]=!0,this._changedBuffers[2]=!0}draw(){if(this.visibility&&this._coordinatesData.length){this._update();let e=this._renderNode.renderer,t=e.handler.programs.pointCloud,s=t._program,n=e.handler.gl,o=s.attributes,a=s.uniforms;t.activate(),n.uniformMatrix4fv(a.projectionViewMatrix,!1,e.activeCamera.getProjectionViewMatrix()),n.uniform1f(a.opacity,this._handler._entityCollection._fadingOpacity),n.uniform1f(a.pointSize,this.pointSize),n.bindBuffer(n.ARRAY_BUFFER,this._coordinatesBuffer),n.vertexAttribPointer(o.coordinates,this._coordinatesBuffer.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,this._colorBuffer),n.vertexAttribPointer(o.colors,this._colorBuffer.itemSize,n.FLOAT,!1,0,0),n.drawArrays(n.POINTS,0,this._coordinatesBuffer.numItems)}}drawPicking(){if(this.visibility&&this._coordinatesData.length){let e=this._renderNode.renderer,t=e.handler.programs.pointCloud,s=t._program,n=e.handler.gl,o=s.attributes,a=s.uniforms;t.activate(),n.uniformMatrix4fv(a.projectionViewMatrix,!1,e.activeCamera.getProjectionViewMatrix()),n.uniform1f(a.opacity,this._handler._entityCollection._fadingOpacity),n.uniform1f(a.pointSize,this.pointSize+this.pickingScale),n.bindBuffer(n.ARRAY_BUFFER,this._coordinatesBuffer),n.vertexAttribPointer(o.coordinates,this._coordinatesBuffer.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,this._pickingColorBuffer),n.vertexAttribPointer(o.colors,this._pickingColorBuffer.itemSize,n.FLOAT,!1,0,0),n.drawArrays(n.POINTS,0,this._coordinatesBuffer.numItems)}}_update(){if(this._renderNode){let e=this._changedBuffers.length;for(;e--;)this._changedBuffers[e]&&(this._buffersUpdateCallbacks[e].call(this),this._changedBuffers[e]=!1)}}_deleteBuffers(){if(this._renderNode){let e=this._renderNode.renderer.handler.gl;e.deleteBuffer(this._coordinatesBuffer),e.deleteBuffer(this._colorBuffer),e.deleteBuffer(this._pickingColorBuffer)}this._coordinatesBuffer=null,this._colorBuffer=null,this._pickingColorBuffer=null}_createCoordinatesBuffer(){let e=this._renderNode.renderer.handler;e.gl.deleteBuffer(this._coordinatesBuffer),this._coordinatesBuffer=e.createArrayBuffer(new Float32Array(this._coordinatesData),3,this._coordinatesData.length/3)}_createColorBuffer(){let e=this._renderNode.renderer.handler;e.gl.deleteBuffer(this._colorBuffer),this._colorBuffer=e.createArrayBuffer(new Float32Array(this._colorData),4,this._colorData.length/4)}_createPickingColorBuffer(){let e=this._renderNode.renderer.handler;e.gl.deleteBuffer(this._pickingColorBuffer),this._pickingColorBuffer=e.createArrayBuffer(new Float32Array(this._pickingColorData),4,this._pickingColorData.length/4)}_setPickingColors(){if(this._renderNode&&this._renderNode.renderer){for(let e=0;e<this._points.length;e++){let t=this._points[e];t._entity=this._entity,t._entityCollection=this._entity._entityCollection,this._renderNode.renderer.assignPickingColor(t),this._pickingColorData.push(t._pickingColor.x/255,t._pickingColor.y/255,t._pickingColor.z/255,1)}this._changedBuffers[2]=!0}}};fs.__counter__=0;let mr=fs;const pi=class Tc{constructor(e={}){this.__id=Tc.__counter__++,this.__doubleToTwoFloats=m.doubleToTwoFloats,this.altitude=e.altitude||0,this.thickness=e.thickness||1.5,this._opacity=e.opacity!=null?e.opacity:1,this._defaultColor=me(e.color||"#0000FF",e.opacity),this.visibility=e.visibility==null||e.visibility,this._closedLine=e.isClosed||!1,this._path3v=[],this._pathLengths=[],this._pathLonLat=[],this._pathLonLatMerc=[],this._pathColors=e.pathColors?Xr(e.pathColors):[],this._extent=new H,this._verticesHigh=[],this._verticesLow=[],this._orders=[],this._indexes=[],this._colors=[],this._verticesHighBuffer=null,this._verticesLowBuffer=null,this._ordersBuffer=null,this._indexesBuffer=null,this._colorsBuffer=null,this._pickingColor=[0,0,0],this._renderNode=null,this._entity=null,this._handler=null,this._handlerIndex=-1,this._buffersUpdateCallbacks=[],this._buffersUpdateCallbacks[0]=this._createVerticesBuffer,this._buffersUpdateCallbacks[1]=this._createIndexBuffer,this._buffersUpdateCallbacks[2]=this._createColorsBuffer,this._changedBuffers=new Array(this._buffersUpdateCallbacks.length);let t=qt(e.visibleSpherePosition).toArray(),s=e.visibleSphereRadius||0;this._visibleSphere=new Float32Array([...t,s]),e.pathLonLat?this.setPathLonLat(e.pathLonLat):e.path3v&&this.setPath3v(e.path3v),this._refresh()}__appendLineData3v(e,t,s,n,o,a,h,c,d,u,_,f,v,g){var y=0,p=new m,x=new m;v&&(v.southWest.set(180,90),v.northEast.set(-180,-90)),c.length>0?(y=c[c.length-5]+9,c.push(y,y)):c.push(0,0);for(let B=0,z=e.length;B<z;B++){var T=e[B],w=t[B];if(u[B]=[],f[B]=[],_[B]=[],T.length===0)continue;var C,E=y;if(n)(C=T[T.length-1])instanceof Array&&(C=new m(C[0],C[1],C[2]));else{var L=T[0],S=T[1]||L;L instanceof Array&&(L=new m(L[0],L[1],L[2])),S instanceof Array&&(S=new m(S[0],S[1],S[2])),C=new m(L.x+L.x-S.x,L.y+L.y-S.y,L.z+L.z-S.z)}let ue=s;w&&w[0]&&(ue=w[0]),this.__doubleToTwoFloats(C,p,x),o.push(p.x,p.y,p.z,p.x,p.y,p.z,p.x,p.y,p.z,p.x,p.y,p.z),a.push(x.x,x.y,x.z,x.x,x.y,x.z,x.x,x.y,x.z,x.x,x.y,x.z);let I=ue[0],se=ue[1],G=ue[2],k=ue[3]!=null?ue[3]:1;B>0&&g.push(I,se,G,k,I,se,G,k,I,se,G,k,I,se,G,k),h.push(1,-1,2,-2);for(let F=0,Ce=T.length;F<Ce;F++){var P=T[F];if(P instanceof Array&&(P=new m(P[0],P[1],P[2])),_[B].push(P),d){var R=d.cartesianToLonLat(P);u[B].push(R),f[B].push(R.forwardMercator()),R.lon<v.southWest.lon&&(v.southWest.lon=R.lon),R.lat<v.southWest.lat&&(v.southWest.lat=R.lat),R.lon>v.northEast.lon&&(v.northEast.lon=R.lon),R.lat>v.northEast.lat&&(v.northEast.lat=R.lat)}w&&w[F]&&(ue=w[F]),I=ue[0],se=ue[1],G=ue[2],k=ue[3]!=null?ue[3]:1,this.__doubleToTwoFloats(P,p,x),o.push(p.x,p.y,p.z,p.x,p.y,p.z,p.x,p.y,p.z,p.x,p.y,p.z),a.push(x.x,x.y,x.z,x.x,x.y,x.z,x.x,x.y,x.z,x.x,x.y,x.z),g.push(I,se,G,k,I,se,G,k,I,se,G,k,I,se,G,k),h.push(1,-1,2,-2),c.push(y++,y++,y++,y++)}var M;if(n)(M=T[0])instanceof Array&&(M=new m(M[0],M[1],M[2])),c.push(E,E+1,E+1,E+1);else{let F=T[T.length-1],Ce=T[T.length-2]||F;F instanceof Array&&(F=new m(F[0],F[1],F[2])),Ce instanceof Array&&(Ce=new m(Ce[0],Ce[1],Ce[2])),M=new m(F.x+F.x-Ce.x,F.y+F.y-Ce.y,F.z+F.z-Ce.z),c.push(y-1,y-1,y-1,y-1)}w&&w[T.length-1]&&(ue=w[T.length-1]),I=ue[0],se=ue[1],G=ue[2],k=ue[3]!=null?ue[3]:1,this.__doubleToTwoFloats(M,p,x),o.push(p.x,p.y,p.z,p.x,p.y,p.z,p.x,p.y,p.z,p.x,p.y,p.z),a.push(x.x,x.y,x.z,x.x,x.y,x.z,x.x,x.y,x.z,x.x,x.y,x.z),g.push(I,se,G,k,I,se,G,k,I,se,G,k,I,se,G,k),h.push(1,-1,2,-2),B<e.length-1&&e[B+1].length!==0&&(y+=8,c.push(y,y))}}__appendPoint3v(e,t,s,n,o,a,h,c,d,u,_,f,v,g){var y=new m,p=new m,x=u.length-4,T=u[x-1]+1;e.length===0?(e.push([]),s[0]||(s[0]=[])):s[e.length-1]||(s[e.length-1]=[]);var w=e[e.length-1],C=w.length;w.push(t);let E=n[0],L=n[1],S=n[2],P=n[3]!=null?n[3]:1,R=s[e.length-1];if(R[C]?(R[C][0]=E,R[C][1]=L,R[C][2]=S,R[C][3]=P):R.push(n),C===1){var M;if(o)(M=w[C-1])instanceof Array&&(M=new m(M[0],M[1],M[2]));else{let F=w[0],Ce=w[1]||F;F instanceof Array&&(F=new m(F[0],F[1],F[2])),Ce instanceof Array&&(Ce=new m(Ce[0],Ce[1],Ce[2])),M=new m(F.x+F.x-Ce.x,F.y+F.y-Ce.y,F.z+F.z-Ce.z)}this.__doubleToTwoFloats(M,y,p);let k=a.length-36;a[k]=y.x,a[k+1]=y.y,a[k+2]=y.z,a[k+3]=y.x,a[k+4]=y.y,a[k+5]=y.z,a[k+6]=y.x,a[k+7]=y.y,a[k+8]=y.z,a[k+9]=y.x,a[k+10]=y.y,a[k+11]=y.z,h[k]=p.x,h[k+1]=p.y,h[k+2]=p.z,h[k+3]=p.x,h[k+4]=p.y,h[k+5]=p.z,h[k+6]=p.x,h[k+7]=p.y,h[k+8]=p.z,h[k+9]=p.x,h[k+10]=p.y,h[k+11]=p.z}var B=T;if(_){f.length===0&&f.push([]),v.length===0&&v.push([]);var z=f[f.length-1],ue=v[v.length-1];let k=_.cartesianToLonLat(t);z.push(k),ue.push(k.forwardMercator()),k.lon<g.southWest.lon&&(g.southWest.lon=k.lon),k.lat<g.southWest.lat&&(g.southWest.lat=k.lat),k.lon>g.northEast.lon&&(g.northEast.lon=k.lon),k.lat>g.northEast.lat&&(g.northEast.lat=k.lat)}this.__doubleToTwoFloats(t,y,p);let I=a.length-12;a[I]=y.x,a[I+1]=y.y,a[I+2]=y.z,a[I+3]=y.x,a[I+4]=y.y,a[I+5]=y.z,a[I+6]=y.x,a[I+7]=y.y,a[I+8]=y.z,a[I+9]=y.x,a[I+10]=y.y,a[I+11]=y.z,h[I]=p.x,h[I+1]=p.y,h[I+2]=p.z,h[I+3]=p.x,h[I+4]=p.y,h[I+5]=p.z,h[I+6]=p.x,h[I+7]=p.y,h[I+8]=p.z,h[I+9]=p.x,h[I+10]=p.y,h[I+11]=p.z;let se=c.length-16;var G;if(c[se]=E,c[se+1]=L,c[se+2]=S,c[se+3]=P,c[se+4]=E,c[se+5]=L,c[se+6]=S,c[se+7]=P,c[se+8]=E,c[se+9]=L,c[se+10]=S,c[se+11]=P,c[se+12]=E,c[se+13]=L,c[se+14]=S,c[se+15]=P,u[x]=T++,u[x+1]=T++,u[x+2]=T++,u[x+3]=T++,o)G=w[0],u.push(B,B+1,B+1,B+1);else{let k=w[w.length-1],F=w[w.length-2]||k;G=new m(k.x+k.x-F.x,k.y+k.y-F.y,k.z+k.z-F.z),u.push(T-1,T-1,T-1,T-1)}this.__doubleToTwoFloats(G,y,p),a.push(y.x,y.y,y.z,y.x,y.y,y.z,y.x,y.y,y.z,y.x,y.y,y.z),h.push(p.x,p.y,p.z,p.x,p.y,p.z,p.x,p.y,p.z,p.x,p.y,p.z),c.push(E,L,S,P,E,L,S,P,E,L,S,P,E,L,S,P),d.push(1,-1,2,-2)}static setPathColors(e,t,s,n){for(let c=0,d=e.length;c<d;c++){var o=e[c],a=t[c];if(o.length===0)continue;let u=s;a&&a[0]&&(u=a[0]);let _=u[0],f=u[1],v=u[2],g=u[3]!=null?u[3]:1;c>0&&n.push(_,f,v,g,_,f,v,g,_,f,v,g,_,f,v,g);for(let y=0,p=o.length;y<p;y++){var h=o[y];h instanceof Array&&(h=new A(h[0],h[1],h[2])),a&&a[y]&&(u=a[y]),_=u[0],f=u[1],v=u[2],g=u[3]!=null?u[3]:1,n.push(_,f,v,g,_,f,v,g,_,f,v,g,_,f,v,g)}a&&a[o.length-1]&&(u=a[o.length-1]),_=u[0],f=u[1],v=u[2],g=u[3]!=null?u[3]:1,n.push(_,f,v,g,_,f,v,g,_,f,v,g,_,f,v,g)}}__appendLineDataLonLat(e,t,s,n,o,a,h,c,d,u,_,f,v,g){var y=0,p=new m,x=new m;v&&(v.southWest.set(180,90),v.northEast.set(-180,-90)),c.length>0?(y=c[c.length-5]+9,c.push(y)):c.push(0);for(let R=0,M=e.length;R<M;R++){var T=e[R],w=t[R];if(u[R]=[],f[R]=[],_[R]=[],T.length===0)continue;var C,E=y;if(n){let G=T[T.length-1];C=G instanceof Array?d.lonLatToCartesian(new A(G[0],G[1],G[2])):d.lonLatToCartesian(G)}else{let G,k,F=T[0];G=F instanceof Array?d.lonLatToCartesian(new A(F[0],F[1],F[2])):d.lonLatToCartesian(F),F=T[1],F||(F=T[0]),k=F instanceof Array?d.lonLatToCartesian(new A(F[0],F[1],F[2])):d.lonLatToCartesian(F),C=new m(G.x+G.x-k.x,G.y+G.y-k.y,G.z+G.z-k.z)}let B=s;w&&w[0]&&(B=w[0]),this.__doubleToTwoFloats(C,p,x),o.push(p.x,p.y,p.z,p.x,p.y,p.z,p.x,p.y,p.z,p.x,p.y,p.z),a.push(x.x,x.y,x.z,x.x,x.y,x.z,x.x,x.y,x.z,x.x,x.y,x.z);let z=B[0],ue=B[1],I=B[2],se=B[3]!=null?B[3]:1;R>0&&g.push(z,ue,I,se,z,ue,I,se,z,ue,I,se,z,ue,I,se),h.push(1,-1,2,-2);for(let G=0,k=T.length;G<k;G++){var L=T[G];L instanceof Array&&(L=new A(L[0],L[1],L[2])),w&&w[G]&&(B=w[G]),z=B[0],ue=B[1],I=B[2],se=B[3]!=null?B[3]:1;var S=d.lonLatToCartesian(L);u[R].push(S),_[R].push(L),f[R].push(L.forwardMercator()),this.__doubleToTwoFloats(S,p,x),o.push(p.x,p.y,p.z,p.x,p.y,p.z,p.x,p.y,p.z,p.x,p.y,p.z),a.push(x.x,x.y,x.z,x.x,x.y,x.z,x.x,x.y,x.z,x.x,x.y,x.z),g.push(z,ue,I,se,z,ue,I,se,z,ue,I,se,z,ue,I,se),h.push(1,-1,2,-2),c.push(y++,y++,y++,y++),L.lon<v.southWest.lon&&(v.southWest.lon=L.lon),L.lat<v.southWest.lat&&(v.southWest.lat=L.lat),L.lon>v.northEast.lon&&(v.northEast.lon=L.lon),L.lat>v.northEast.lat&&(v.northEast.lat=L.lat)}var P;if(n){let G=T[0];P=G instanceof Array?d.lonLatToCartesian(new A(G[0],G[1],G[2])):d.lonLatToCartesian(G),c.push(E,E+1,E+1,E+1)}else{let G,k,F=T[T.length-1];G=F instanceof Array?d.lonLatToCartesian(new A(F[0],F[1],F[2])):d.lonLatToCartesian(F),F=T[T.length-2],F||(F=T[0]),k=F instanceof Array?d.lonLatToCartesian(new A(F[0],F[1],F[2])):d.lonLatToCartesian(F),P=new m(G.x+G.x-k.x,G.y+G.y-k.y,G.z+G.z-k.z),c.push(y-1,y-1,y-1,y-1)}w&&w[T.length-1]&&(B=w[T.length-1]),z=B[0],ue=B[1],I=B[2],se=B[3]!=null?B[3]:1,this.__doubleToTwoFloats(P,p,x),o.push(p.x,p.y,p.z,p.x,p.y,p.z,p.x,p.y,p.z,p.x,p.y,p.z),a.push(x.x,x.y,x.z,x.x,x.y,x.z,x.x,x.y,x.z,x.x,x.y,x.z),g.push(z,ue,I,se,z,ue,I,se,z,ue,I,se,z,ue,I,se),h.push(1,-1,2,-2),R<e.length-1&&e[R+1].length!==0&&(y+=8,c.push(y,y))}}_setEqualPath3v(e){var t=this._extent;t.southWest.set(180,90),t.northEast.set(-180,-90);var s=new m,n=new m,o=this._verticesHigh,a=this._verticesLow,h=this._pathLonLat,c=this._pathLonLatMerc,d=0,u=this._renderNode.ellipsoid;for(let T=0;T<e.length;T++){var _,f,v=e[T];_=this._closedLine?v[v.length-1]:new m(v[0].x+v[0].x-v[1].x,v[0].y+v[0].y-v[1].y,v[0].z+v[0].z-v[1].z),this.__doubleToTwoFloats(_,s,n),o[d]=s.x,a[d++]=n.x,o[d]=s.y,a[d++]=n.y,o[d]=s.z,a[d++]=n.z,o[d]=s.x,a[d++]=n.x,o[d]=s.y,a[d++]=n.y,o[d]=s.z,a[d++]=n.z,o[d]=s.x,a[d++]=n.x,o[d]=s.y,a[d++]=n.y,o[d]=s.z,a[d++]=n.z,o[d]=s.x,a[d++]=n.x,o[d]=s.y,a[d++]=n.y,o[d]=s.z,a[d++]=n.z;for(let w=0;w<v.length;w++){var g=v[w],y=this._path3v[T][w];if(y.x=g.x,y.y=g.y,y.z=g.z,u){var p=u.cartesianToLonLat(g);this._pathLonLat[T][w]=p,h[T][w]=p,c[T][w]=p.forwardMercator(),p.lon<t.southWest.lon&&(t.southWest.lon=p.lon),p.lat<t.southWest.lat&&(t.southWest.lat=p.lat),p.lon>t.northEast.lon&&(t.northEast.lon=p.lon),p.lat>t.northEast.lat&&(t.northEast.lat=p.lat)}this.__doubleToTwoFloats(g,s,n),o[d]=s.x,a[d++]=n.x,o[d]=s.y,a[d++]=n.y,o[d]=s.z,a[d++]=n.z,o[d]=s.x,a[d++]=n.x,o[d]=s.y,a[d++]=n.y,o[d]=s.z,a[d++]=n.z,o[d]=s.x,a[d++]=n.x,o[d]=s.y,a[d++]=n.y,o[d]=s.z,a[d++]=n.z,o[d]=s.x,a[d++]=n.x,o[d]=s.y,a[d++]=n.y,o[d]=s.z,a[d++]=n.z}if(this._closedLine)f=v[0];else{var x=v.length-1;f=new m(v[x].x+v[x].x-v[x-1].x,v[x].y+v[x].y-v[x-1].y,v[x].z+v[x].z-v[x-1].z)}this.__doubleToTwoFloats(f,s,n),o[d]=s.x,a[d++]=n.x,o[d]=s.y,a[d++]=n.y,o[d]=s.z,a[d++]=n.z,o[d]=s.x,a[d++]=n.x,o[d]=s.y,a[d++]=n.y,o[d]=s.z,a[d++]=n.z,o[d]=s.x,a[d++]=n.x,o[d]=s.y,a[d++]=n.y,o[d]=s.z,a[d++]=n.z,o[d]=s.x,a[d++]=n.x,o[d]=s.y,a[d++]=n.y,o[d]=s.z,a[d++]=n.z}}_setEqualPathLonLat(e){var t=this._extent;t.southWest.set(180,90),t.northEast.set(-180,-90);var s=new m,n=new m,o=this._verticesHigh,a=this._verticesLow,h=this._pathLonLat,c=this._pathLonLatMerc,d=this._path3v,u=0,_=this._renderNode.ellipsoid;for(let x=0;x<e.length;x++){var f,v,g=e[x];if(this._closedLine)f=_.lonLatToCartesian(g[g.length-1]);else{let T=_.lonLatToCartesian(g[0]),w=_.lonLatToCartesian(g[1]);f=new m(T.x+T.x-w.x,T.y+T.y-w.y,T.z+T.z-w.z)}this.__doubleToTwoFloats(f,s,n),o[u]=s.x,a[u++]=n.x,o[u]=s.y,a[u++]=n.y,o[u]=s.z,a[u++]=n.z,o[u]=s.x,a[u++]=n.x,o[u]=s.y,a[u++]=n.y,o[u]=s.z,a[u++]=n.z,o[u]=s.x,a[u++]=n.x,o[u]=s.y,a[u++]=n.y,o[u]=s.z,a[u++]=n.z,o[u]=s.x,a[u++]=n.x,o[u]=s.y,a[u++]=n.y,o[u]=s.z,a[u++]=n.z;for(let T=0;T<g.length;T++){var y=g[T],p=_.lonLatToCartesian(y);d[x][T]=p,c[x][T]=y.forwardMercator(),h[x][T]=y,this.__doubleToTwoFloats(p,s,n),o[u]=s.x,a[u++]=n.x,o[u]=s.y,a[u++]=n.y,o[u]=s.z,a[u++]=n.z,o[u]=s.x,a[u++]=n.x,o[u]=s.y,a[u++]=n.y,o[u]=s.z,a[u++]=n.z,o[u]=s.x,a[u++]=n.x,o[u]=s.y,a[u++]=n.y,o[u]=s.z,a[u++]=n.z,o[u]=s.x,a[u++]=n.x,o[u]=s.y,a[u++]=n.y,o[u]=s.z,a[u++]=n.z,y.lon<t.southWest.lon&&(t.southWest.lon=y.lon),y.lat<t.southWest.lat&&(t.southWest.lat=y.lat),y.lon>t.northEast.lon&&(t.northEast.lon=y.lon),y.lat>t.northEast.lat&&(t.northEast.lat=y.lat)}if(this._closedLine)v=_.lonLatToCartesian(g[0]);else{let T=_.lonLatToCartesian(g[g.length-1]),w=_.lonLatToCartesian(g[g.length-2]);v=new m(T.x+T.x-w.x,T.y+T.y-w.y,T.z+T.z-w.z)}this.__doubleToTwoFloats(v,s,n),o[u]=s.x,a[u++]=n.x,o[u]=s.y,a[u++]=n.y,o[u]=s.z,a[u++]=n.z,o[u]=s.x,a[u++]=n.x,o[u]=s.y,a[u++]=n.y,o[u]=s.z,a[u++]=n.z,o[u]=s.x,a[u++]=n.x,o[u]=s.y,a[u++]=n.y,o[u]=s.z,a[u++]=n.z,o[u]=s.x,a[u++]=n.x,o[u]=s.y,a[u++]=n.y,o[u]=s.z,a[u++]=n.z}}setPointLonLat(e,t,s){if(this._renderNode&&this._renderNode.ellipsoid){let c=this._pathLonLat,d=this._pathLonLatMerc;c[s][t]=e,d[s][t]=e.forwardMercator();var n=this._extent;n.southWest.set(180,90),n.northEast.set(-180,-90);for(let u=0;u<c.length;u++){var o=c[u];for(let _=0;_<o.length;_++){var a=o[_].lon,h=o[_].lat;a>n.northEast.lon&&(n.northEast.lon=a),h>n.northEast.lat&&(n.northEast.lat=h),a<n.southWest.lon&&(n.southWest.lon=a),h<n.southWest.lat&&(n.southWest.lat=h)}}this.setPoint3v(this._renderNode.ellipsoid.lonLatToCartesian(e),t,s,!0)}else{let c=this._pathLonLat[s];c[t].lon=e.lon,c[t].lat=e.lat,c[t].height=e.height}}setPoint3v(e,t=0,s=0,n=!1){if(this._renderNode){var o,a=new m,h=new m,c=this._verticesHigh,d=this._verticesLow,u=this._pathLonLat,_=this._pathLonLatMerc,f=0;o=12*this._pathLengths[s]+24*s;let E=this._path3v[s];E[t].x=e.x,E[t].y=e.y,E[t].z=e.z;let L=this._closedLine||E.length===1;var v;if((t===0||t===1)&&(v=L?E[E.length-1]:new m(E[0].x+E[0].x-E[1].x,E[0].y+E[0].y-E[1].y,E[0].z+E[0].z-E[1].z),f=o,this.__doubleToTwoFloats(v,a,h),c[f]=a.x,c[f+1]=a.y,c[f+2]=a.z,c[f+3]=a.x,c[f+4]=a.y,c[f+5]=a.z,c[f+6]=a.x,c[f+7]=a.y,c[f+8]=a.z,c[f+9]=a.x,c[f+10]=a.y,c[f+11]=a.z,d[f]=h.x,d[f+1]=h.y,d[f+2]=h.z,d[f+3]=h.x,d[f+4]=h.y,d[f+5]=h.z,d[f+6]=h.x,d[f+7]=h.y,d[f+8]=h.z,d[f+9]=h.x,d[f+10]=h.y,d[f+11]=h.z),!n&&this._renderNode.ellipsoid){var g=this._renderNode.ellipsoid.cartesianToLonLat(e);u[s][t]=g,_[s][t]=g.forwardMercator();var y=this._extent;y.southWest.set(180,90),y.northEast.set(-180,-90);for(let S=0;S<u.length;S++){var p=u[S];for(let P=0;P<p.length;P++){var x=p[P].lon,T=p[P].lat;x>y.northEast.lon&&(y.northEast.lon=x),T>y.northEast.lat&&(y.northEast.lat=T),x<y.southWest.lon&&(y.southWest.lon=x),T<y.southWest.lat&&(y.southWest.lat=T)}}}if(f=o+12*t+12,this.__doubleToTwoFloats(e,a,h),c[f]=a.x,c[f+1]=a.y,c[f+2]=a.z,c[f+3]=a.x,c[f+4]=a.y,c[f+5]=a.z,c[f+6]=a.x,c[f+7]=a.y,c[f+8]=a.z,c[f+9]=a.x,c[f+10]=a.y,c[f+11]=a.z,d[f]=h.x,d[f+1]=h.y,d[f+2]=h.z,d[f+3]=h.x,d[f+4]=h.y,d[f+5]=h.z,d[f+6]=h.x,d[f+7]=h.y,d[f+8]=h.z,d[f+9]=h.x,d[f+10]=h.y,d[f+11]=h.z,t===E.length-1||t===E.length-2){var w;if(L)w=E[0];else{var C=E.length-1;w=new m(E[C].x+E[C].x-E[C-1].x,E[C].y+E[C].y-E[C-1].y,E[C].z+E[C].z-E[C-1].z)}f=o+12*E.length+12,this.__doubleToTwoFloats(w,a,h),c[f]=a.x,c[f+1]=a.y,c[f+2]=a.z,c[f+3]=a.x,c[f+4]=a.y,c[f+5]=a.z,c[f+6]=a.x,c[f+7]=a.y,c[f+8]=a.z,c[f+9]=a.x,c[f+10]=a.y,c[f+11]=a.z,d[f]=h.x,d[f+1]=h.y,d[f+2]=h.z,d[f+3]=h.x,d[f+4]=h.y,d[f+5]=h.z,d[f+6]=h.x,d[f+7]=h.y,d[f+8]=h.z,d[f+9]=h.x,d[f+10]=h.y,d[f+11]=h.z}this._changedBuffers[0]=!0}else{let E=this._path3v[s];E[t].x=e.x,E[t].y=e.y,E[t].z=e.z}}_resizePathLengths(e=0){this._pathLengths[0]=0;for(let t=e+1,s=this._path3v.length;t<=s;t++)this._pathLengths[t]=this._pathLengths[t-1]+this._path3v[t-1].length}removeSegment(e){this._path3v.splice(e,1),this.setPath3v([].concat(this._path3v))}removePoint(e,t=0){this._path3v[t].splice(e,1),this._path3v[t].length===0&&this._path3v.splice(t,1),this.setPath3v([].concat(this._path3v))}insertPoint3v(e,t=0,s,n=0){let o=[].concat(this._path3v),a=o[n];if(a){let h=[].concat(this._pathColors);if(a.splice(t,0,e),s){let c=h[n];c||(c=new Array(a.length)),c.splice(t,0,s)}this.setPath3v(o,h)}else this.addPoint3v(e,n)}appendPoint3v(e,t,s){this._path3v.length!==0&&this._renderNode?(this._verticesHigh=He(this._verticesHigh),this._verticesLow=He(this._verticesLow),this._colors=He(this._colors),this._orders=He(this._orders),this._indexes=He(this._indexes),this.__appendPoint3v(this._path3v,e,this._pathColors,t||this._defaultColor,this._closedLine,this._verticesHigh,this._verticesLow,this._colors,this._orders,this._indexes,s?null:this._renderNode.ellipsoid,this._pathLonLat,this._pathLonLatMerc,this._extent),this._pathLengths[this._path3v.length]+=1,this._changedBuffers[0]=!0,this._changedBuffers[2]=!0,this._changedBuffers[1]=!0):(this._pathColors.push([t||this._defaultColor]),this.addPoint3v(e))}addPoint3v(e,t=0){t>=this._path3v.length&&this._path3v.push([]),this._path3v[t].push(e),this.setPath3v([].concat(this._path3v))}addPointLonLat(e,t=0){t>=this._pathLonLat.length&&this._pathLonLat.push([]),this._pathLonLat[t].push(e),this.setPathLonLat([].concat(this._pathLonLat))}clear(){this._clearData()}setPointColor(e,t=0,s=0){if(this._renderNode&&t<this._path3v[s].length){let n=this._pathColors[s];if(!n){if(!(this._path3v[s]&&t<this._path3v[s].length))return;this._pathColors[s]=new Array(this._path3v[s].length)}n[t]?(n[t][0]=e[0],n[t][1]=e[1],n[t][2]=e[2],n[t][3]=e[3]||1):n[t]=[e[0],e[1],e[2],e[3]||1];let o=this._colors,a=16*t+16*this._pathLengths[s]+32*s;o[a]=o[a+4]=o[a+8]=o[a+12]=e[0],o[a+1]=o[a+5]=o[a+9]=o[a+13]=e[1],o[a+2]=o[a+6]=o[a+10]=o[a+14]=e[2],o[a+3]=o[a+7]=o[a+11]=o[a+15]=e[3]||1,this._changedBuffers[2]=!0}else this._pathColors[s][t]=e}setOpacity(e){this._opacity=e}getOpacity(){return this._opacity}setAltitude(e){this.altitude=e}setThickness(e){this.thickness=e}getThickness(){return this.thickness}setVisibility(e){this.visibility=e}getVisibility(){return this.visibility}setRenderNode(e){e&&(this._renderNode=e,this._pathLonLat.length?this._createDataLonLat([].concat(this._pathLonLat)):this._createData3v([].concat(this._path3v)),this._refresh(),e.renderer&&e.renderer.isInitialized()&&this._update())}_clearData(){this._verticesHigh=null,this._verticesLow=null,this._orders=null,this._indexes=null,this._colors=null,this._verticesHigh=[],this._verticesLow=[],this._orders=[],this._indexes=[],this._colors=[],this._path3v.length=0,this._pathLonLat.length=0,this._pathLonLatMerc.length=0,this._path3v=[],this._pathLonLat=[],this._pathLonLatMerc=[]}_createData3v(e){this._clearData(),this.__appendLineData3v(e,this._pathColors,this._defaultColor,this._closedLine,this._verticesHigh,this._verticesLow,this._orders,this._indexes,this._renderNode.ellipsoid,this._pathLonLat,this._path3v,this._pathLonLatMerc,this._extent,this._colors),this._resizePathLengths(0)}_createDataLonLat(e){this._clearData(),this.__appendLineDataLonLat(e,this._pathColors,this._defaultColor,this._closedLine,this._verticesHigh,this._verticesLow,this._orders,this._indexes,this._renderNode.ellipsoid,this._path3v,this._pathLonLat,this._pathLonLatMerc,this._extent,this._colors),this._resizePathLengths(0)}remove(){this._entity=null,this._pathColors.length=0,this._pathColors=[],this._verticesHigh=null,this._verticesLow=null,this._orders=null,this._indexes=null,this._colors=null,this._verticesHigh=[],this._verticesLow=[],this._orders=[],this._indexes=[],this._colors=[],this._deleteBuffers(),this._handler&&this._handler.remove(this)}setPickingColor3v(e){this._pickingColor[0]=e.x/255,this._pickingColor[1]=e.y/255,this._pickingColor[2]=e.z/255}getExtent(){return this._extent.clone()}getPath3v(){return this._path3v}getPathLonLat(){return this._pathLonLat}getPathColors(){return this._pathColors}setPathColors(e){e&&(this._colors=[],this._pathColors=[].concat(e),Tc.setPathColors(this._pathLonLat,e,this._defaultColor,this._colors),this._changedBuffers[2]=!0)}setColorHTML(e){this._defaultColor=me(e);let t=le(e),s=this._pathColors;for(let o=0,a=s.length;o<a;o++){let h=s[o];for(let c=0,d=h.length;c<d;c++)h[c][0]=t.x,h[c][1]=t.y,h[c][2]=t.z,h[c][3]=t.w}let n=this._colors;for(let o=0,a=n.length;o<a;o+=4)n[o]=t.x,n[o+1]=t.y,n[o+2]=t.z,n[o+3]=t.w;this._changedBuffers[2]=!0}setPathLonLatFast(e,t){this.setPathLonLat(e,t,!0)}setPath3vFast(e,t){this.setPath3v(e,t,!0)}setPathLonLat(e,t,s=!1){t&&(this._pathColors=[].concat(t)),this._renderNode&&this._renderNode.ellipsoid?s?(this._setEqualPathLonLat(e),this._changedBuffers[0]=!0,this._changedBuffers[2]=!0):(this._createDataLonLat(e),this._changedBuffers[0]=!0,this._changedBuffers[1]=!0,this._changedBuffers[2]=!0):this._pathLonLat=[].concat(e)}getSize(e=0){return this._path3v[e].length}setPath3v(e,t,s=!1){t&&(this._pathColors=[].concat(t)),this._renderNode?s?(this._setEqualPath3v(e),this._changedBuffers[0]=!0,this._changedBuffers[2]=!0):(this._createData3v(e),this._changedBuffers[0]=!0,this._changedBuffers[1]=!0,this._changedBuffers[2]=!0):this._path3v=[].concat(e)}draw(){if(this.visibility&&this._path3v.length){this._update();let e=this._renderNode.renderer,t=e.handler.programs.polyline_screen,s=t._program,n=e.handler.gl,o=s.attributes,a=s.uniforms,h=this._handler._entityCollection;t.activate(),n.disable(n.CULL_FACE),n.uniform1f(a.depthOffset,h.polygonOffsetUnits),n.uniformMatrix4fv(a.proj,!1,e.activeCamera.getProjectionMatrix()),n.uniformMatrix4fv(a.view,!1,e.activeCamera.getViewMatrix()),n.uniform3fv(a.rtcEyePositionHigh,this._handler._rtcEyePositionHigh),n.uniform3fv(a.rtcEyePositionLow,this._handler._rtcEyePositionLow),n.uniform4fv(a.visibleSphere,this._visibleSphere),n.uniform2fv(a.viewport,[e.handler.canvas.width,e.handler.canvas.height]),n.uniform1f(a.thickness,.5*this.thickness),n.uniform1f(a.opacity,this._opacity*h._fadingOpacity),n.bindBuffer(n.ARRAY_BUFFER,this._colorsBuffer),n.vertexAttribPointer(o.color,this._colorsBuffer.itemSize,n.FLOAT,!1,0,0);let c=this._verticesHighBuffer;n.bindBuffer(n.ARRAY_BUFFER,c),n.vertexAttribPointer(o.prevHigh,c.itemSize,n.FLOAT,!1,12,0),n.vertexAttribPointer(o.currentHigh,c.itemSize,n.FLOAT,!1,12,48),n.vertexAttribPointer(o.nextHigh,c.itemSize,n.FLOAT,!1,12,96),c=this._verticesLowBuffer,n.bindBuffer(n.ARRAY_BUFFER,c),n.vertexAttribPointer(o.prevLow,c.itemSize,n.FLOAT,!1,12,0),n.vertexAttribPointer(o.currentLow,c.itemSize,n.FLOAT,!1,12,48),n.vertexAttribPointer(o.nextLow,c.itemSize,n.FLOAT,!1,12,96),n.bindBuffer(n.ARRAY_BUFFER,this._ordersBuffer),n.vertexAttribPointer(o.order,this._ordersBuffer.itemSize,n.FLOAT,!1,4,0),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,this._indexesBuffer),n.drawElements(n.TRIANGLE_STRIP,this._indexesBuffer.numItems,n.UNSIGNED_INT,0),n.enable(n.CULL_FACE)}}drawPicking(){if(this.visibility&&this._path3v.length){let e=this._renderNode.renderer,t=e.handler.programs.polyline_picking,s=t._program,n=e.handler.gl,o=s.attributes,a=s.uniforms,h=this._handler._entityCollection;t.activate(),n.disable(n.CULL_FACE),n.uniform1f(a.depthOffset,h.polygonOffsetUnits),n.uniformMatrix4fv(a.proj,!1,e.activeCamera.getProjectionMatrix()),n.uniformMatrix4fv(a.view,!1,e.activeCamera.getViewMatrix()),n.uniform4fv(a.color,[this._pickingColor[0],this._pickingColor[1],this._pickingColor[2],1]),n.uniform3fv(a.rtcEyePositionHigh,this._handler._rtcEyePositionHigh),n.uniform3fv(a.rtcEyePositionLow,this._handler._rtcEyePositionLow),n.uniform4fv(a.visibleSphere,this._visibleSphere),n.uniform2fv(a.viewport,[e.handler.canvas.width,e.handler.canvas.height]),n.uniform1f(a.thickness,.5*this.thickness*h.pickingScale[0]);let c=this._verticesHighBuffer;n.bindBuffer(n.ARRAY_BUFFER,c),n.vertexAttribPointer(o.prevHigh,c.itemSize,n.FLOAT,!1,12,0),n.vertexAttribPointer(o.currentHigh,c.itemSize,n.FLOAT,!1,12,48),n.vertexAttribPointer(o.nextHigh,c.itemSize,n.FLOAT,!1,12,96),c=this._verticesLowBuffer,n.bindBuffer(n.ARRAY_BUFFER,c),n.vertexAttribPointer(o.prevLow,c.itemSize,n.FLOAT,!1,12,0),n.vertexAttribPointer(o.currentLow,c.itemSize,n.FLOAT,!1,12,48),n.vertexAttribPointer(o.nextLow,c.itemSize,n.FLOAT,!1,12,96),n.bindBuffer(n.ARRAY_BUFFER,this._ordersBuffer),n.vertexAttribPointer(o.order,this._ordersBuffer.itemSize,n.FLOAT,!1,4,0),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,this._indexesBuffer),n.drawElements(n.TRIANGLE_STRIP,this._indexesBuffer.numItems,n.UNSIGNED_INT,0),n.enable(n.CULL_FACE)}}_refresh(){let e=this._changedBuffers.length;for(;e--;)this._changedBuffers[e]=!0}_update(){if(this._renderNode){let e=this._changedBuffers.length;for(;e--;)this._changedBuffers[e]&&(this._buffersUpdateCallbacks[e].call(this),this._changedBuffers[e]=!1)}}_deleteBuffers(){if(this._renderNode){let e=this._renderNode.renderer.handler.gl;e.deleteBuffer(this._verticesHighBuffer),e.deleteBuffer(this._verticesLowBuffer),e.deleteBuffer(this._ordersBuffer),e.deleteBuffer(this._indexesBuffer),e.deleteBuffer(this._colorsBuffer),this._verticesHighBuffer=null,this._verticesLowBuffer=null,this._ordersBuffer=null,this._indexesBuffer=null,this._colorsBuffer=null}}_createVerticesBuffer(){let e=this._renderNode.renderer.handler,t=this._verticesHigh.length/3;this._verticesHighBuffer&&this._verticesHighBuffer.numItems===t||(e.gl.deleteBuffer(this._verticesHighBuffer),e.gl.deleteBuffer(this._verticesLowBuffer),this._verticesHighBuffer=e.createStreamArrayBuffer(3,t),this._verticesLowBuffer=e.createStreamArrayBuffer(3,t)),this._verticesHigh=it(this._verticesHigh),this._verticesLow=it(this._verticesLow),e.setStreamArrayBuffer(this._verticesHighBuffer,this._verticesHigh),e.setStreamArrayBuffer(this._verticesLowBuffer,this._verticesLow)}_createIndexBuffer(){let e=this._renderNode.renderer.handler;e.gl.deleteBuffer(this._ordersBuffer),e.gl.deleteBuffer(this._indexesBuffer),this._orders=it(this._orders),this._ordersBuffer=e.createArrayBuffer(this._orders,1,this._orders.length/2),this._indexes=it(this._indexes,Uint32Array),this._indexesBuffer=e.createElementArrayBuffer(this._indexes,1,this._indexes.length)}_createColorsBuffer(){let e=this._renderNode.renderer.handler;e.gl.deleteBuffer(this._colorsBuffer),this._colors=it(this._colors),this._colorsBuffer=e.createArrayBuffer(new Float32Array(this._colors),4,this._colors.length/4)}setVisibleSphere(e,t){this._handler&&(this._visibleSphere[0]=e.x-this._handler._relativeCenter.x,this._visibleSphere[1]=e.y-this._handler._relativeCenter.y,this._visibleSphere[2]=e.z-this._handler._relativeCenter.z),this._visibleSphere[3]=t}updateRTCPosition(){this._handler&&this._renderNode&&(this._visibleSphere[0]=this._visibleSphere[0]-this._handler._relativeCenter.x,this._visibleSphere[1]=this._visibleSphere[1]-this._handler._relativeCenter.y,this._visibleSphere[2]=this._visibleSphere[2]-this._handler._relativeCenter.z,this._setEqualPath3v(this._path3v)),this._changedBuffers[0]=!0}};pi.__counter__=0;let vr=pi;const gs=class kc{constructor(e={}){this.__id=kc.__counter__++,this._thickness=e.thickness||2,this._startPosition=qt(e.startPosition),this._startPositionHigh=new m,this._startPositionLow=new m,m.doubleToTwoFloats(this._startPosition,this._startPositionHigh,this._startPositionLow),this._endPosition=qt(e.endPosition),this._endPositionHigh=new m,this._endPositionLow=new m,m.doubleToTwoFloats(this._endPosition,this._endPositionHigh,this._endPositionLow),this._startColor=ae(e.startColor),this._endColor=ae(e.endColor),this._visibility=e.visibility==null||e.visibility,this._entity=null,this._handler=null,this._handlerIndex=-1}setStartPosition(e,t,s){this._startPosition.x=e,this._startPosition.y=t,this._startPosition.z=s,m.doubleToTwoFloats(this._startPosition,this._startPositionHigh,this._startPositionLow),this._handler&&this._handler.setStartPositionArr(this._handlerIndex,this._startPositionHigh,this._startPositionLow)}getLength(){return this._startPosition.distance(this._endPosition)}setStartPosition3v(e){this._startPosition.x=e.x,this._startPosition.y=e.y,this._startPosition.z=e.z,m.doubleToTwoFloats(this._startPosition,this._startPositionHigh,this._startPositionLow),this._handler&&this._handler.setStartPositionArr(this._handlerIndex,this._startPositionHigh,this._startPositionLow)}setEndPosition(e,t,s){this._endPosition.x=e,this._endPosition.y=t,this._endPosition.z=s,m.doubleToTwoFloats(this._endPosition,this._endPositionHigh,this._endPositionLow),this._handler&&this._handler.setEndPositionArr(this._handlerIndex,this._endPositionHigh,this._endPositionLow)}setEndPosition3v(e){this._endPosition.x=e.x,this._endPosition.y=e.y,this._endPosition.z=e.z,m.doubleToTwoFloats(this._endPosition,this._endPositionHigh,this._endPositionLow),this._handler&&this._handler.setEndPositionArr(this._handlerIndex,this._endPositionHigh,this._endPositionLow)}setThickness(e){this._thickness=e,this._handler&&this._handler.setThicknessArr(this._handlerIndex,e)}setColors4v(e,t){e&&(this._startColor.x=e.x,this._startColor.y=e.y,this._startColor.z=e.z,this._startColor.w=e.w),t&&(this._endColor.x=t.x,this._endColor.y=t.y,this._endColor.z=t.z,this._endColor.w=t.w),this._handler&&this._handler.setRgbaArr(this._handlerIndex,this._startColor,this._endColor)}setColorsHTML(e,t){e&&(this._startColor=le(e)),t&&(this._endColor=le(t)),this._handler&&this._handler.setRgbaArr(this._handlerIndex,this._startColor,this._endColor)}getStartPosition(){return this._startPosition}getEndPosition(){return this._endPosition}setVisibility(e){this._visibility=e,this._handler&&this._handler.setVisibility(this._handlerIndex,e)}getVisibility(){return this._visibility}remove(){this._entity=null,this._handler&&this._handler.remove(this)}setPickingColor3v(e){this._handler&&this._handler.setPickingColorArr(this._handlerIndex,e)}};gs.__counter__=0;let yr=gs,_t=new m,ft=new m;const ps=class Fc{constructor(e={}){if(this.__id=Fc.__counter__++,this.visibility=e.visibility==null||e.visibility,this.color=new Float32Array([1,1,1,.5]),e.color){let t=ae(e.color);this.setColor(t.x,t.y,t.z,t.w)}e.opacity&&this.setOpacity(e.opacity),this._renderNode=null,this._entity=null,this._verticesHighBuffer=null,this._verticesLowBuffer=null,this._indexBuffer=null,this._verticesHigh=[],this._verticesLow=[],this._indexes=[],this._path=[],this._pickingColor=new Float32Array(4),this._gridSize=1,this._handler=null,this._handlerIndex=-1,e.path&&this.setPath(e.path)}setPickingColor3v(e){this._pickingColor[0]=e.x/255,this._pickingColor[1]=e.y/255,this._pickingColor[2]=e.z/255,this._pickingColor[3]=1}clear(){this._path.length=0,this._path=[],this._verticesHigh.length=0,this._verticesHigh=[],this._verticesLow.length=0,this._verticesLow=[],this._indexes.length=0,this._indexes=[],this._deleteBuffers()}setColor4v(e){this.setColor(e.x,e.y,e.z,e.w)}setColorHTML(e){this.setColor4v(le(e))}setColor(e,t,s,n){n=n||this.color[3],this.color[0]=e,this.color[1]=t,this.color[2]=s,this.color[3]=n}setOpacity(e){this.color[3]=e||0}setVisibility(e){this.visibility=e}getVisibility(){return this.visibility}setRenderNode(e){this._renderNode=e,this._createBuffers()}remove(){this._entity=null,this._handler&&this._handler.remove(this)}draw(){if(this.visibility&&this._verticesHigh.length){let e=this._renderNode.renderer,t=e.handler.gl,s=e.handler.programs.strip,n=s._program,o=n.attributes,a=n.uniforms;s.activate(),t.disable(t.CULL_FACE),t.uniformMatrix4fv(a.viewMatrix,!1,e.activeCamera.getViewMatrix()),t.uniformMatrix4fv(a.projectionMatrix,!1,e.activeCamera.getProjectionMatrix()),t.uniform3fv(a.eyePositionHigh,e.activeCamera.eyeHigh),t.uniform3fv(a.eyePositionLow,e.activeCamera.eyeLow),t.uniform4fv(a.uColor,this.color),t.uniform1f(a.uOpacity,this._entity._entityCollection._fadingOpacity),t.bindBuffer(t.ARRAY_BUFFER,this._verticesHighBuffer),t.vertexAttribPointer(o.aVertexPositionHigh,this._verticesHighBuffer.itemSize,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,this._verticesLowBuffer),t.vertexAttribPointer(o.aVertexPositionLow,this._verticesLowBuffer.itemSize,t.FLOAT,!1,0,0),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this._indexBuffer),t.drawElements(e.handler.gl.TRIANGLE_STRIP,this._indexBuffer.numItems,t.UNSIGNED_INT,0),t.enable(t.CULL_FACE)}}drawPicking(){if(this.visibility&&this._verticesHigh.length){let e=this._renderNode.renderer,t=e.handler.gl,s=e.handler.programs.strip,n=s._program,o=n.attributes,a=n.uniforms;s.activate(),t.disable(t.CULL_FACE),t.uniformMatrix4fv(a.viewMatrix,!1,e.activeCamera.getViewMatrix()),t.uniformMatrix4fv(a.projectionMatrix,!1,e.activeCamera.getProjectionMatrix()),t.uniform3fv(a.eyePositionHigh,e.activeCamera.eyeHigh),t.uniform3fv(a.eyePositionLow,e.activeCamera.eyeLow),t.uniform1f(a.uOpacity,this._entity._entityCollection._fadingOpacity!=0?1:0),t.uniform4fv(a.uColor,this._pickingColor),t.bindBuffer(t.ARRAY_BUFFER,this._verticesHighBuffer),t.vertexAttribPointer(o.aVertexPositionHigh,this._verticesHighBuffer.itemSize,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,this._verticesLowBuffer),t.vertexAttribPointer(o.aVertexPositionLow,this._verticesLowBuffer.itemSize,t.FLOAT,!1,0,0),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this._indexBuffer),t.drawElements(e.handler.gl.TRIANGLE_STRIP,this._indexBuffer.numItems,t.UNSIGNED_INT,0),t.enable(t.CULL_FACE)}}_deleteBuffers(){if(this._renderNode&&this._renderNode.renderer){let e=this._renderNode.renderer.handler.gl;e.deleteBuffer(this._indexBuffer),e.deleteBuffer(this._verticesHighBuffer),e.deleteBuffer(this._verticesLowBuffer)}this._verticesHighBuffer=null,this._verticesLowBuffer=null,this._indexBuffer=null}_createBuffers(){if(this._renderNode&&this._renderNode.renderer&&this._renderNode.renderer.isInitialized()){let e=this._renderNode.renderer.handler.gl;e.deleteBuffer(this._indexBuffer),e.deleteBuffer(this._verticesHighBuffer),e.deleteBuffer(this._verticesLowBuffer),this._verticesHighBuffer=this._renderNode.renderer.handler.createArrayBuffer(new Float32Array(this._verticesHigh),3,this._verticesHigh.length/3),this._verticesLowBuffer=this._renderNode.renderer.handler.createArrayBuffer(new Float32Array(this._verticesLow),3,this._verticesLow.length/3),this._indexBuffer=this._renderNode.renderer.handler.createElementArrayBuffer(new Uint32Array(this._indexes),1,this._indexes.length)}}addEdge3v(e,t){let s=this._path.length;if(s===0)this._path.push([e.clone(),t.clone()]);else{let n=this._path[s-1][0],o=this._path[s-1][1];this._path.push([e.clone(),t.clone()]);let a=this._verticesHigh,h=this._verticesLow,c=this._gridSize,d=c+1,u=new m,_=this._verticesHigh.length/3,f=_,v=Math.abs(n.sub(o).normal().dot(e.sub(n).normal()));for(let g=0;g<d;g++){let y=g/c,p=n.lerp(e,y),x=o.lerp(t,y);for(let T=0;T<d;T++){let w=T/c,C=n.lerp(o,w),E=e.lerp(t,w);v!==1?new Kt(p,x).intersects(new Kt(C,E),u):u=E,f=_+g*d+T,m.doubleToTwoFloats(u,_t,ft);let L=3*f;a[L]=_t.x,a[L+1]=_t.y,a[L+2]=_t.z,h[L]=ft.x,h[L+1]=ft.y,h[L+2]=ft.z,g<c&&this._indexes.push(f,f+d)}g<c&&this._indexes.push(f+d,f+1)}this._createBuffers()}}setEdge3v(e,t,s){if(s!==this._path.length)if(this._path[s]){if(this._path[s][0]=e,this._path[s][1]=t,this._path.length>1){let n=this._gridSize,o=n+1,a=o*o,h=new m,c=this._verticesHigh,d=this._verticesLow;if(s===this._path.length-1){let u=this._path[s-1][0],_=this._path[s-1][1],f=this._verticesHigh.length/3-a,v=f,g=Math.abs(u.sub(_).normal().dot(e.sub(u).normal()));for(let y=0;y<o;y++){let p=y/n,x=u.lerp(e,p),T=_.lerp(t,p);for(let w=0;w<o;w++){let C=w/n,E=u.lerp(_,C),L=e.lerp(t,C);g!==1?new Kt(x,T).intersects(new Kt(E,L),h):h=L,v=f+y*o+w,m.doubleToTwoFloats(h,_t,ft);let S=3*v;c[S]=_t.x,c[S+1]=_t.y,c[S+2]=_t.z,d[S]=ft.x,d[S+1]=ft.y,d[S+2]=ft.z}}}else if(s===0){let u=0,_=e,f=t;e=this._path[1][0],t=this._path[1][1];for(let v=0;v<o;v++){let g=v/n,y=_.lerp(e,g),p=f.lerp(t,g);for(let x=0;x<o;x++){let T=x/n,w=_.lerp(f,T),C=e.lerp(t,T);new Kt(y,p).intersects(new Kt(w,C),h),u=v*o+x,m.doubleToTwoFloats(h,_t,ft);let E=3*u;c[E]=_t.x,c[E+1]=_t.y,c[E+2]=_t.z,d[E]=ft.x,d[E+1]=ft.y,d[E+2]=ft.z}}}else if(s>0&&s<this._path.length){let u=this._path[s-1][0],_=this._path[s-1][1],f=this._path[s+1][0],v=this._path[s+1][1],g=s*a,y=(s-1)*a,p=y;for(let x=0;x<o;x++){let T=x/n,w=u.lerp(e,T),C=t.lerp(v,T),E=e.lerp(f,T),L=_.lerp(t,T);for(let S=0;S<o;S++){let P=S/n,R=u.lerp(_,P),M=e.lerp(t,P);new Kt(w,L).intersects(new Kt(R,M),h);let B=x*o+S;p=y+B,m.doubleToTwoFloats(h,_t,ft);let z=3*p;c[z]=_t.x,c[z+1]=_t.y,c[z+2]=_t.z,d[z]=ft.x,d[z+1]=ft.y,d[z+2]=ft.z;let ue=f.lerp(v,P);M=e.lerp(t,P),new Kt(E,C).intersects(new Kt(M,ue),h),p=g+B,m.doubleToTwoFloats(h,_t,ft),z=3*p,c[z]=_t.x,c[z+1]=_t.y,c[z+2]=_t.z,d[z]=ft.x,d[z+1]=ft.y,d[z+2]=ft.z}}}this._createBuffers()}}else console.warn(`strip index ${s} is out of range`);else this.addEdge3v(e,t)}removeEdge(e){this._path.splice(e,1),this.setPath([].concat(this._path))}setGridSize(e){this._gridSize=e,this.setPath([].concat(this._path))}getPath(){return this._path}setPath(e){this._verticesHigh=[],this._verticesLow=[],this._indexes=[],this._path=[];for(let t=0;t<e.length;t++){let s=e[t][0],n=e[t][1];s instanceof Array&&(s=new m(s[0],s[1],s[2])),n instanceof Array&&(n=new m(n[0],n[1],n[2])),this.addEdge3v(s,n)}}insertEdge3v(e,t,s){if(s<this._path.length){let n=[].concat(this._path);n.splice(s,0,[e,t]),this.setPath(n)}else s===this._path.length&&this.addEdge3v(e,t)}};ps.__counter__=0;let xr=ps;const ms=class zc{constructor(e={}){e.properties=e.properties||{},this.__id=zc.__counter__++,this._name=e.name||`entity:${this.__id}`,this.properties=e.properties||{},this.childEntities=[],this.parent=null,this.forceGlobalPosition=e.forceGlobalPosition||!1,this.forceGlobalRotation=e.forceGlobalRotation||!1,this.forceGlobalScale=e.forceGlobalScale||!1,this._cartesian=qt(e.cartesian),this._rootCartesian=new m,this._localPosition=qt(e.localPosition),this._absoluteLocalPosition=new m,this._lonLat=mi(e.lonlat),this._lonLatMerc=new A,this._altitude=e.altitude||0,this._visibility=e.visibility==null||e.visibility,this._entityCollection=null,this._entityCollectionIndex=-1,this._layer=null,this._layerIndex=-1,this._pickingColor=new m(0,0,0),this._independentPicking=e.independentPicking||!1,this._relativePosition=e.relativePosition||!1,this._pitchRad=e.pitch||0,this._yawRad=e.yaw||0,this._rollRad=e.roll||0,this._scale=qt(e.scale,new m(1,1,1)),this._absoluteScale=new m,this._qFrame=D.IDENTITY,this._qRot=D.IDENTITY,this._absoluteQRot=D.IDENTITY,this._useDirectQuaternion=!1,this._featureConstructorArray={billboard:[Za,this.setBillboard],label:[Ja,this.setLabel],polyline:[vr,this.setPolyline],pointCloud:[mr,this.setPointCloud],geometry:[gr,this.setGeometry],geoObject:[pr,this.setGeoObject],strip:[xr,this.setStrip],ray:[yr,this.setRay]},this.billboard=this._createOptionFeature("billboard",e.billboard),this.label=this._createOptionFeature("label",e.label),this.polyline=this._createOptionFeature("polyline",e.polyline),this.ray=this._createOptionFeature("ray",e.ray),this.pointCloud=this._createOptionFeature("pointCloud",e.pointCloud),this.geometry=this._createOptionFeature("geometry",e.geometry),this.geoObject=this._createOptionFeature("geoObject",e.geoObject),this.strip=this._createOptionFeature("strip",e.strip)}get name(){return this._name}set name(e){e!==this._name&&(this._name=e)}get isEmpty(){return!(this.strip||this.polyline||this.ray||this.geoObject||this.geometry||this.billboard||this.label||this.pointCloud)}get rootEntity(){let e=this;for(;e;){if(!e.parent)return e;e=e.parent}return this}set relativePosition(e){if(e!==this._relativePosition){let t=this.getAbsoluteCartesian(),s=this.getAbsolutePitch(),n=this.getAbsoluteYaw(),o=this.getAbsoluteRoll();this._relativePosition=e,this.parent&&this._rootCartesian.copy(this.parent._rootCartesian),e?this.parent&&(this.setAbsoluteCartesian3v(t),this.setAbsolutePitch(s),this.setAbsoluteYaw(n),this.setAbsoluteRoll(o)):(this.setCartesian3v(t),this.setPitch(s),this.setYaw(n),this.setRoll(o))}}get relativePosition(){return this._relativePosition}get entityCollection(){return this._entityCollection}get id(){return this.__id}isEqual(e){return this.__id===e.__id}get layerIndex(){return this._layerIndex}get instanceName(){return"Entity"}_createOptionFeature(e,t){if(t){let s=this._featureConstructorArray[e];return s[1].call(this,new s[0](t))}return null}getCollectionIndex(){return this._entityCollectionIndex}addTo(e){return e.add(this),this}remove(){return this._layer&&this._layer.removeEntity(this),this._entityCollection&&this._entityCollection.removeEntity(this),this}setVisibility(e){this._visibility=e,this.billboard&&this.billboard.setVisibility(e),this.geoObject&&this.geoObject.setVisibility(e),this.label&&this.label.setVisibility(e),this.polyline&&this.polyline.setVisibility(e),this.ray&&this.ray.setVisibility(e),this.geometry&&this.geometry.setVisibility(e);for(let t=0;t<this.childEntities.length;t++)this.childEntities[t].setVisibility(e)}getVisibility(){return this._visibility}setCartesian3v(e){this.setCartesian(e.x,e.y,e.z)}getScale(){return this._scale}setScale3v(e){this._scale.copy(e),this._updateAbsolutePosition();for(let t=0;t<this.childEntities.length;t++){let s=this.childEntities[t];s.forceGlobalScale?s.setScale3v(this._scale):s.setScale3v(this.childEntities[t].getScale())}}setScale(e){this.setScale3v(new m(e,e,e))}getAbsoluteRotation(){return this._absoluteQRot.clone()}getRotation(){return this._qRot}setLook3v(e){let t,s=new D,n=this.getAbsoluteCartesian();if(this._entityCollection){let o=this._entityCollection.renderNode.ellipsoid.getSurfaceNormal3v(n);t=s.setLookRotation(e.sub(n),o).conjugate()}else t=s.setLookRotation(e.sub(n),m.UP).conjugate();this.setAbsoluteRotation(t)}setLookLonLat(e){if(this._entityCollection){let t=this._entityCollection.renderNode.ellipsoid.lonLatToCartesian(e);this.setLook3v(t)}}setAbsoluteRotation(e){this._absoluteQRot.copy(e),this._updatePitchYawRoll()}setRotation(e){this._useDirectQuaternion=!1,this._pitchRad=e.getPitch(),this._yawRad=e.getYaw(),this._rollRad=e.getRoll(),this._updateAbsolutePosition()}setDirectQuaternionRotation(e){this._qRot.copy(e),this._useDirectQuaternion=!0,this._pitchRad=this._qRot.getPitch(),this._yawRad=this._qRot.getYaw(),this._rollRad=this._qRot.getRoll(),this._updateAbsolutePosition()}setPitch(e){this._useDirectQuaternion=!1,this._pitchRad=e,this._updateAbsolutePosition()}setYaw(e){this._useDirectQuaternion=!1,this._yawRad=e,this._updateAbsolutePosition()}setRoll(e){this._useDirectQuaternion=!1,this._rollRad=e,this._updateAbsolutePosition()}getPitch(){return this._pitchRad}getYaw(){return this._yawRad}getRoll(){return this._rollRad}setAbsolutePitch(e){this._relativePosition?(this._absoluteQRot.setPitchYawRoll(e,this.getAbsoluteYaw(),this.getAbsoluteRoll(),this._qFrame),this._updatePitchYawRoll()):this.setPitch(e)}setAbsoluteYaw(e){this._relativePosition?(this._absoluteQRot.setPitchYawRoll(this.getAbsolutePitch(),e,this.getAbsoluteRoll(),this._qFrame),this._updatePitchYawRoll()):this.setYaw(e)}setAbsoluteRoll(e){this._relativePosition?(this._absoluteQRot.setPitchYawRoll(this.getAbsolutePitch(),this.getAbsoluteYaw(),e,this._qFrame),this._updatePitchYawRoll()):this.setRoll(e)}getAbsolutePitch(){return this.parent&&this._relativePosition?this._qFrame.conjugate().inverse().mul(this._absoluteQRot).getPitch():this._pitchRad}getAbsoluteYaw(){return this.parent&&this._relativePosition?this._qFrame.conjugate().inverse().mul(this._absoluteQRot).getYaw():this._yawRad}getAbsoluteRoll(){return this.parent&&this._relativePosition?this._qFrame.conjugate().inverse().mul(this._absoluteQRot).getRoll():this._rollRad}_getScaleByDistance(){let e=1;if(this._entityCollection){let t=this._entityCollection.scaleByDistance,s=1;this._entityCollection.renderNode&&this._entityCollection.renderNode.renderer&&(s=this._entityCollection.renderNode.renderer.activeCamera.eye.distance(this._rootCartesian)),e=t[2]*$i(s,t[0],t[1])/t[0]}return e}setAbsoluteCartesian(e,t,s){this.setAbsoluteCartesian3v(new m(e,t,s))}setAbsoluteCartesian3v(e){let t=e;if(this.parent&&this._relativePosition){let s=this._getScaleByDistance();t=e.sub(this.parent.getAbsoluteCartesian()).scale(1/s).divA(this.parent._absoluteScale),t=this.parent._absoluteQRot.conjugate().mulVec3(t)}this.setCartesian3v(t)}getAbsoluteCartesian(){if(this.parent&&this._relativePosition){let e=this._getScaleByDistance();return this._rootCartesian.add(this._absoluteLocalPosition.scaleTo(e))}return this._cartesian.clone()}setCartesian(e,t,s){this._cartesian.set(e,t,s),this._updateAbsolutePosition();for(let n=0;n<this.childEntities.length;n++){let o=this.childEntities[n];o._relativePosition?o.setCartesian3v(o.getCartesian()):o.forceGlobalPosition&&o.setCartesian(e,t,s)}this._updateLonLat()}_updatePitchYawRoll(){if(this.parent){this._qRot=this.parent._absoluteQRot.conjugate().mul(this._absoluteQRot),this._pitchRad=this._qRot.getPitch(),this._yawRad=this._qRot.getYaw(),this._rollRad=this._qRot.getRoll(),this.geoObject&&this.geoObject.setRotation(this._absoluteQRot);for(let e=0;e<this.childEntities.length;e++)this.childEntities[e]._updateAbsolutePosition()}}_updateAbsolutePosition(){let e=this.parent;if(e&&this._relativePosition){this._scale.mulRes(e._absoluteScale,this._absoluteScale),this._qFrame.copy(e._qFrame),this._rootCartesian.copy(e._rootCartesian),this._useDirectQuaternion||(e&&this.forceGlobalRotation?this._qRot.setPitchYawRoll(e._pitchRad,e._yawRad,e._rollRad):this._qRot.setPitchYawRoll(this._pitchRad,this._yawRad,this._rollRad)),e._absoluteQRot.mulRes(this._qRot,this._absoluteQRot);let t=e._absoluteQRot.mulVec3(this._cartesian.add(this._localPosition)).mulA(e._absoluteScale);e._absoluteLocalPosition.addRes(t,this._absoluteLocalPosition)}else this._qFrame=D.IDENTITY,this._entityCollection&&this._entityCollection.renderNode&&(this._qFrame=this._entityCollection.renderNode.getFrameRotation(this._cartesian)),this._useDirectQuaternion?this._qFrame.isEqual(D.IDENTITY)||(this._qRot=this._qRot.mul(this._qFrame)):e&&this.forceGlobalRotation?this._qRot.setPitchYawRoll(e._pitchRad,e._yawRad,e._rollRad,this._qFrame):this._qRot.setPitchYawRoll(this._pitchRad,this._yawRad,this._rollRad,this._qFrame),this._absoluteScale.copy(this._scale),this._absoluteQRot.copy(this._qRot),this._rootCartesian.copy(this._cartesian),this._absoluteLocalPosition.copy(this._localPosition);this.geoObject&&(this.geoObject.setScale3v(this._absoluteScale),this.geoObject.setRotation(this._absoluteQRot),this.geoObject.setPosition3v(this._rootCartesian),this.geoObject.setLocalPosition3v(this._absoluteLocalPosition)),this.billboard&&this.billboard.setPosition3v(this._rootCartesian),this.label&&this.label.setPosition3v(this._rootCartesian);for(let t=0,s=this.childEntities.length;t<s;t++)this.childEntities[t]._updateAbsolutePosition();this._updateLonLat()}_setCartesian3vSilent(e,t=!1){this._cartesian.copy(e),this._updateAbsolutePosition();for(let s=0;s<this.childEntities.length;s++)this.childEntities[s].setCartesian(this._cartesian.x,this._cartesian.y,this._cartesian.z);t||this._updateLonLat()}_updateLonLat(){let e=this._entityCollection;e&&e.renderNode&&e.renderNode.ellipsoid&&(this._lonLat=e.renderNode.ellipsoid.cartesianToLonLat(this.getAbsoluteCartesian()),Math.abs(this._lonLat.lat)<ht?this._lonLatMerc=this._lonLat.forwardMercator():this._lonLatMerc.lon=this._lonLatMerc.lat=0)}getLonLat(){return this._lonLat.clone()}setLonLat(e){let t=this._lonLat;t.lon=e.lon,t.lat=e.lat,t.height=e.height;let s=this._entityCollection;if(s&&s.renderNode&&s.renderNode.ellipsoid){Math.abs(t.lat)<ht&&(this._lonLatMerc=t.forwardMercator());let n=new m;s.renderNode.ellipsoid.lonLatToCartesianRes(t,n),this.setAbsoluteCartesian3v(n)}}setLonLat2(e,t,s){let n=this._lonLat;n.lon=e,n.lat=t,n.height=s??n.height;let o=this._entityCollection;if(o&&o.renderNode&&o.renderNode.ellipsoid){Math.abs(n.lat)<ht?this._lonLatMerc=n.forwardMercator():this._lonLatMerc.lon=this._lonLatMerc.lat=this._lonLatMerc.height=0;let a=new m;o.renderNode.ellipsoid.lonLatToCartesianRes(n,a),this.setAbsoluteCartesian3v(a)}}setAltitude(e){this._altitude=e}getAltitude(){return this._altitude}getCartesian(){return this._cartesian.clone()}setBillboard(e){return this.billboard&&this.billboard.remove(),this.billboard=e,this.billboard._entity=this,this.billboard.setPosition3v(this._cartesian),this.billboard.setVisibility(this._visibility),this._entityCollection&&this._entityCollection.billboardHandler.add(e),e}setLabel(e){return this.label&&this.label.remove(),this.label=e,this.label._entity=this,this.label.setPosition3v(this._cartesian),this.label.setVisibility(this._visibility),this._entityCollection&&this._entityCollection.labelHandler.add(e),e}setRay(e){return this.ray&&this.ray.remove(),this.ray=e,this.ray._entity=this,this.ray.setVisibility(this._visibility),this._entityCollection&&this._entityCollection.rayHandler.add(e),e}setPolyline(e){return this.polyline&&this.polyline.remove(),this.polyline=e,this.polyline._entity=this,this.polyline.setVisibility(this._visibility),this._entityCollection&&this._entityCollection.polylineHandler.add(e),e}setPointCloud(e){return this.pointCloud&&this.pointCloud.remove(),this.pointCloud=e,this.pointCloud._entity=this,this.pointCloud.setVisibility(this._visibility),this._entityCollection&&this._entityCollection.pointCloudHandler.add(e),e}setGeometry(e){this.geometry&&this.geometry.remove(),this.geometry=e,this.geometry._entity=this,this.geometry.setVisibility(this._visibility);let t=this._layer;return this._layer&&this._layer.removeEntity(this),t&&t.add(this),e}setGeoObject(e){return this.geoObject&&this.geoObject.remove(),this.geoObject=e,this.geoObject._entity=this,this.geoObject.setPosition3v(this._cartesian),this.geoObject.setVisibility(this._visibility),this._entityCollection&&this._entityCollection.geoObjectHandler.add(e),e}setStrip(e){return this.strip&&this.strip.remove(),this.strip=e,this.strip._entity=this,this.strip.setVisibility(this._visibility),this._entityCollection&&this._entityCollection.stripHandler.add(e),e}get layer(){return this._layer}get rendererEvents(){return this._layer?this._layer.events:this._entityCollection?this._entityCollection.events:null}appendChildren(e,t){for(let s=0;s<e.length;s++)t!==void 0&&(e[s].relativePosition=t),this.appendChild(e[s])}appendChild(e){e._entityCollection=this._entityCollection,e._independentPicking||(e._pickingColor=this._pickingColor),e.parent=this,this.childEntities.push(e),this._entityCollection&&this._entityCollection.appendChildEntity(e)}setPickingColor(){let e=this._pickingColor;this.billboard&&this.billboard.setPickingColor3v(e),this.label&&this.label.setPickingColor3v(e),this.polyline&&this.polyline.setPickingColor3v(e),this.ray&&this.ray.setPickingColor3v(e),this.strip&&this.strip.setPickingColor3v(e),this.geoObject&&this.geoObject.setPickingColor3v(e);for(let t=0;t<this.childEntities.length;t++)this.childEntities[t].setPickingColor()}getExtent(){let e,t=this._lonLat;e=this.billboard||this.label?new H(new A(t.lon,t.lat),new A(t.lon,t.lat)):new H(new A(180,90),new A(-180,-90));let s=e.southWest,n=e.northEast;if(this.polyline){let o=this.polyline.getExtent();o.southWest.lon<s.lon&&(s.lon=o.southWest.lon),o.southWest.lat<s.lat&&(s.lat=o.southWest.lat),o.northEast.lon>n.lon&&(n.lon=o.northEast.lon),o.northEast.lat>n.lat&&(n.lat=o.northEast.lat)}if(this.geometry){let o=this.geometry.getExtent();o.southWest.lon<s.lon&&(s.lon=o.southWest.lon),o.southWest.lat<s.lat&&(s.lat=o.southWest.lat),o.northEast.lon>n.lon&&(n.lon=o.northEast.lon),o.northEast.lat>n.lat&&(n.lat=o.northEast.lat)}for(let o=0;o<this.childEntities.length;o++){let a=this.childEntities[o].getExtent();a.southWest.lon<s.lon&&(s.lon=a.southWest.lon),a.southWest.lat<s.lat&&(s.lat=a.southWest.lat),a.northEast.lon>n.lon&&(n.lon=a.northEast.lon),a.northEast.lat>n.lat&&(n.lat=a.northEast.lat)}return e}};ms.__counter__=0;let V=ms;const vs=class Oc{constructor(e){this.__id=Oc.__counter__++,this._name=e||`nonameNode:${this.__id}`,this.topNode=this,this._dictionary={},this._dictionary[this._name]=this,this.childNodes=[],this.parentNode=null}get name(){return this._name}addNode(e){this.parentNode==null?e.topNode=this:e.topNode=this.topNode,e.parentNode=this,e._dictionary=this.topNode._dictionary,this.childNodes.push(e),this.topNode._dictionary[e.name]=e}destroy(){for(let e=0;e<this.childNodes.length;e++)this.childNodes[e].destroy();this._clear()}getNodeByName(e){return this._dictionary[e]}_clear(){this.parentNode=null,this.topNode=this,this.childNodes.length=0}isEqual(e){return e.__id===this.__id}};vs.__counter__=0;let br=vs;class ce extends br{constructor(e){super(e),this.childNodes=[],this.renderer=null,this.drawMode=0,this.show=!0,this._isActive=!0,this.lightEnabled=!1,this._lightPosition=new Float32Array([100,100,100]),this._lightParams=new Float32Array(9),this._lightShininess=100,this.entityCollections=[],this._entityCollectionsByDepthOrder=[],this._pickingId=-1}getFrameRotation(e){return D.IDENTITY}addNode(e){super.addNode(e),this.renderer&&e.assign(this.renderer)}assign(e){this.renderer=e,this._pickingId=e.addPickingCallback(this,this._entityCollectionPickingCallback),this.initialize()}initialize(){if(this.renderer&&this.renderer.isInitialized()){for(let e=0;e<this.entityCollections.length;e++)this.entityCollections[e].bindRenderNode(this);this.init()}}init(){}onremove(){}remove(){let e=this.renderer,t=this.name;if(e){e.renderNodes[t]&&e.renderNodes[t].isEqual(this)&&(e.renderNodes[t]=null,delete e.renderNodes[t]);for(let s=0;s<e._renderNodesArr.length;s++)if(e._renderNodesArr[s].isEqual(this)){e._renderNodesArr.splice(s,1);break}e.removePickingCallback(this._pickingId),this._pickingId=-1,this.onremove&&this.onremove()}}addEntityCollection(e,t){e.renderNode||(e.renderNode=this,t||(this.entityCollections.push(e),this.updateEntityCollectionsDepthOrder()),this.ellipsoid&&e._updateGeodeticCoordinates(this.ellipsoid),e.bindRenderNode(this),e.events.dispatch(e.events.add,this))}removeEntityCollection(e){for(let t=0;t<this.entityCollections.length;t++)if(this.entityCollections[t].isEqual(e))return this.entityCollections.splice(t,1),void this.updateEntityCollectionsDepthOrder()}updateEntityCollectionsDepthOrder(){let e={0:[]};for(const t of this.entityCollections)t.getVisibility()&&(e[t.depthOrder]||(e[t.depthOrder]=[]),e[t.depthOrder].push(t));this._entityCollectionsByDepthOrder.length=0,this._entityCollectionsByDepthOrder=[],this._entityCollectionsByDepthOrder=Object.keys(e).sort((t,s)=>Number(t)-Number(s)).map(t=>e[Number(t)])}addLight(e){return e.addTo(this),this}preDrawNode(){this._isActive&&this._preDrawNodes()}drawNode(){this._isActive&&this._drawNodes()}isActive(){return this._isActive}setActive(e){this._isActive=e,this.renderer&&(this._isActive&&this._pickingId===-1?this._pickingId=this.renderer.addPickingCallback(this,this._entityCollectionPickingCallback):this._isActive||this._pickingId===-1||(this.renderer.removePickingCallback(this._pickingId),this._pickingId=-1));for(let t=0;t<this.childNodes.length;t++)this.childNodes[t].setActive(e)}setDrawMode(e){this.drawMode=e;for(let t=0;t<this.childNodes.length;t++)this.childNodes[t].setDrawMode(e)}updateBillboardsTexCoords(){for(let e=0;e<this.entityCollections.length;e++)this.entityCollections[e].billboardHandler.refreshTexCoordsArr()}frame(){}preFrame(){}_preDrawNodes(){for(let e=0;e<this.childNodes.length;e++)this.childNodes[e]._isActive&&this.childNodes[e]._preDrawNodes();if(this.show){this.preFrame();for(let e=0;e<this._entityCollectionsByDepthOrder.length;e++)this.drawEntityCollections(this._entityCollectionsByDepthOrder[e],e)}}_drawNodes(){for(let e=0;e<this.childNodes.length;e++)this.childNodes[e]._isActive&&this.childNodes[e]._drawNodes();this.show&&this.frame()}drawEntityCollections(e,t=0){this.renderer.enqueueEntityCollectionsToDraw(e,t)}drawPickingEntityCollections(e){if(e.length){let t=e.length;for(;t--;)e[t]._fadingOpacity&&e[t].billboardHandler.drawPicking();for(t=e.length;t--;)e[t]._fadingOpacity&&e[t].geoObjectHandler.drawPicking();for(t=e.length;t--;)e[t]._fadingOpacity&&e[t].labelHandler.drawPicking();for(t=e.length;t--;)e[t]._fadingOpacity&&e[t].rayHandler.drawPicking();for(t=e.length;t--;)e[t]._visibility&&e[t].polylineHandler.drawPicking();for(t=e.length;t--;)e[t]._visibility&&e[t].stripHandler.drawPicking()}}_entityCollectionPickingCallback(){}}const te=new class{constructor(){this._container=document.createElement("div"),this._container.classList.add("ogConsole"),this._container.style.display="none",document.body&&document.body.appendChild(this._container),this._visibility=!1}getVisibility(){return this._visibility}setVisibility(l){this._visibility!=l&&(this._visibility=l,this._visibility?this.show():this.hide())}show(){this._container.parentNode||document.body&&document.body.appendChild(this._container),this._container.style.display="block",this._visibility=!0}hide(){this._container.style.display="none",this._visibility=!1}logErr(l){let e=document.createElement("div");e.classList.add("ogConsole-text"),e.classList.add("ogConsole-error"),e.innerHTML="error: "+l,console.trace(e.innerHTML),this._container.appendChild(e),this.show()}logWrn(l){let e=document.createElement("div");e.classList.add("ogConsole-text"),e.classList.add("ogConsole-warning"),e.innerHTML="warning: "+l,console.trace(e.innerHTML),this._container.appendChild(e),this.show()}log(l){let e=document.createElement("div");e.classList.add("ogConsole-text"),e.innerHTML=l,console.trace(l),this._container.appendChild(e),this.show()}};let ui=["FLOAT","DOUBLE","BOOL","INT","UINT","VEC2","VEC3","VEC4","DVEC2","DVEC3","DVEC4","BVEC2","BVEC3","BVEC4","IVEC2","IVEC3","IVEC4","UVEC2","UVEC3","UVEC4","MAT2","DMAT2","MAT3","DMAT3","MAT4","DMAT4","MAT2X3","MAT2X4","MAT3X2","MAT3X4","MAT4X2","MAT4X3","DMAT2X3","DMAT2X4","DMAT3X2","DMAT3X4","DMAT4X2","DMAT4X3","SAMPLER1D","SAMPLER2D","SAMPLER3D","SAMPLERCUBE","SAMPLER2DSHADOW","SAMPLER2DARRAY","INTXX","FLOATXX"];const lt={};for(let l=0;l<ui.length;l++)lt[ui[l]]=l;const wr={};for(let l=0;l<ui.length;l++)wr[ui[l].toLowerCase()]=lt[ui[l]];const Lt={u:[],a:[]};Lt.u[lt.MAT4]=function(l,e){l.gl.uniformMatrix4fv(e._pName,!1,e.value)},Lt.u[lt.MAT3]=function(l,e){l.gl.uniformMatrix3fv(e._pName,!1,e.value)},Lt.u[lt.FLOAT]=function(l,e){l.gl.uniform1f(e._pName,e.value)},Lt.u[lt.INT]=function(l,e){l.gl.uniform1i(e._pName,e.value)},Lt.u[lt.VEC2]=function(l,e){l.gl.uniform2fv(e._pName,e.value)},Lt.u[lt.VEC3]=function(l,e){l.gl.uniform3fv(e._pName,e.value)},Lt.u[lt.VEC4]=function(l,e){l.gl.uniform4fv(e._pName,e.value)},Lt.u[lt.SAMPLER2D]=function(l,e){let t=l.gl;t.activeTexture(t.TEXTURE0+l._textureID),t.bindTexture(t.TEXTURE_2D,e.value),t.uniform1i(e._pName,l._textureID),l._textureID++},Lt.u[lt.SAMPLERCUBE]=function(l,e){let t=l.gl;t.activeTexture(t.TEXTURE0+l._textureID),t.bindTexture(t.TEXTURE_CUBE_MAP,e.value),t.uniform1i(e._pName,l._textureID),l._textureID++},Lt.u[lt.SAMPLER2DARRAY]=function(l,e){let t=e.value,s=l.gl,n=t.length,o=new Int32Array(n);for(let a=0;a<n;a++)s.activeTexture(s.TEXTURE0+l._textureID+a),s.bindTexture(s.TEXTURE_2D,t[a]),o[a]=a;s.uniform1iv(e._pName,o)},Lt.u[lt.INTXX]=function(l,e){l.gl.uniform1iv(e._pName,e.value)},Lt.u[lt.FLOATXX]=function(l,e){l.gl.uniform1fv(e._pName,e.value)},Lt.a[lt.FLOAT]=function(l,e){l.gl.vertexAttrib1f(e._pName,e.value)},Lt.a[lt.VEC2]=function(l,e){l.gl.vertexAttrib2fv(e._pName,e.value)},Lt.a[lt.VEC3]=function(l,e){l.gl.vertexAttrib3fv(e._pName,e.value)};const tl=["BYTE","SHORT","UNSIGNED_BYTE","UNSIGNED_SHORT","FLOAT","HALF_FLOAT"];class ${constructor(e,t){this.name=e,this._programController=null,this._attributes={};for(let s in t.attributes)typeof t.attributes[s]=="string"||typeof t.attributes[s]=="number"?this._attributes[s]={type:t.attributes[s]}:this._attributes[s]=t.attributes[s];this._uniforms={};for(let s in t.uniforms)typeof t.uniforms[s]=="string"||typeof t.uniforms[s]=="number"?this._uniforms[s]={type:t.uniforms[s]}:this._uniforms[s]=t.uniforms[s];this.vertexShader=t.vertexShader,this.fragmentShader=t.fragmentShader,this.gl=null,this._variables={},this._p=null,this._textureID=0,this._attribArrays=[],this._attribDivisor=[],this.attributes={},this.uniforms={},this.vertexAttribDivisor=null,this.drawElementsInstanced=null}static bindBuffer(e,t){let s=e.gl;s&&(s.bindBuffer(s.ARRAY_BUFFER,t.value),s.vertexAttribPointer(t._pName,t.value.itemSize,t.itemType,t.normalized,0,0))}use(){this.gl&&this.gl.useProgram(this._p)}set(e){this._textureID=0;for(let t in e)this._variables[t].value=e[t],this._variables[t].func(this,this._variables[t])}apply(){this._textureID=0;let e=this._variables;for(let t in e)e[t].func(this,e[t])}drawIndexBuffer(e,t){let s=this.gl;s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,t),s.drawElements(e,t.numItems,s.UNSIGNED_SHORT,0)}drawArrays(e,t){this.gl.drawArrays(e,0,t)}_getShaderCompileStatus(e,t){if(!this.gl)return!1;const s=this.gl instanceof WebGL2RenderingContext;return this.gl.shaderSource(e,function(n,o){if(!o)return n;const a=n.split(`
`),h=a.findIndex(c=>c.startsWith("#version"));return h!==-1?(a.splice(h+1,0,"#define WEBGL2"),a.join(`
`)):n}(t,s)),this.gl.compileShader(e),!!this.gl.getShaderParameter(e,this.gl.COMPILE_STATUS)||(te.logErr(`Shader program "${this.name}":${this.gl.getShaderInfoLog(e)}.`),!1)}_createVertexShader(e){if(!this.gl)return;let t=this.gl.createShader(this.gl.VERTEX_SHADER);return t&&this._getShaderCompileStatus(t,e)?t:void 0}_createFragmentShader(e){if(!this.gl)return;let t=this.gl.createShader(this.gl.FRAGMENT_SHADER);return t&&this._getShaderCompileStatus(t,e)?t:void 0}disableAttribArrays(){let e=this.gl,t=this._attribArrays;for(let s=0,n=t.length;s<n;s++)e.disableVertexAttribArray(t[s]),this.vertexAttribDivisor(t[s],0)}enableAttribArrays(){let e=this.gl,t=this._attribArrays,s=this._attribDivisor;for(let n=0,o=t.length;n<o;n++)e.enableVertexAttribArray(t[n]),this.vertexAttribDivisor(t[n],s[n])}delete(){this.gl&&this.gl.deleteProgram(this._p)}createProgram(e){if(this.gl=e,this._p=this.gl.createProgram(),!this._p)return;let t=this._createFragmentShader(this.fragmentShader),s=this._createVertexShader(this.vertexShader);if(t&&s){if(e.attachShader(this._p,t),e.attachShader(this._p,s),e.linkProgram(this._p),!this.drawElementsInstanced)if(e.drawElementsInstanced)this.drawElementsInstanced=e.drawElementsInstanced.bind(e);else{let n=e.getExtension("ANGLE_instanced_arrays");n&&(this.drawElementsInstanced=n.drawElementsInstancedANGLE.bind(n))}if(!this.vertexAttribDivisor)if(e.vertexAttribDivisor)this.vertexAttribDivisor=e.vertexAttribDivisor.bind(e);else{let n=e.getExtension("ANGLE_instanced_arrays");n&&(this.vertexAttribDivisor=n.vertexAttribDivisorANGLE.bind(n))}if(!e.getProgramParameter(this._p,e.LINK_STATUS))return te.logErr(`Shader program "${this.name}": initialization failed. ${e.getProgramInfoLog(this._p)}.`),void e.deleteProgram(this._p);this.use();for(let n in this._attributes){this._variables[n]=this._attributes[n],this._attributes[n].func=$.bindBuffer;let o=this._attributes[n].itemType,a=o?o.trim().toUpperCase():"FLOAT";if(tl.indexOf(a)==-1?(te.logErr(`Shader program "${this.name}": attribute '${n}', item type '${this._attributes[n].itemType}' not exists.`),this._attributes[n].itemType=e.FLOAT):this._attributes[n].itemType=e[a],this._attributes[n].normalized=this._attributes[n].normalized||!1,this._attributes[n].divisor=this._attributes[n].divisor||0,this._p[n]=e.getAttribLocation(this._p,n),this._p[n]==null)return te.logErr(`Shader program "${this.name}":  attribute '${n}' not exists.`),void e.deleteProgram(this._p);let h=this._attributes[n].type;typeof h=="string"&&(h=wr[h.trim().toLowerCase()]);let c=this._attributes[n].divisor;if(h===lt.MAT4){let d=this._p[n];this._attribArrays.push(d,d+1,d+2,d+3),this._attribDivisor.push(c,c,c,c)}else this._attribArrays.push(this._p[n]),this._attribDivisor.push(c);e.enableVertexAttribArray(this._p[n]),this._attributes[n]._pName=this._p[n],this.attributes[n]=this._p[n]}for(let n in this._uniforms){if(typeof this._uniforms[n].type=="string"){let o=this._uniforms[n].type;this._uniforms[n].func=Lt.u[wr[o.trim().toLowerCase()]]}else this._uniforms[n].func=Lt.u[this._uniforms[n].type];if(this._variables[n]=this._uniforms[n],this._p[n]=e.getUniformLocation(this._p,n),this._p[n]==null)return te.logErr(`Shader program "${this.name}": uniform '${n}' not exists.`),void e.deleteProgram(this._p);this._uniforms[n]._pName=this._p[n],this.uniforms[n]=this._p[n]}e.detachShader(this._p,t),e.detachShader(this._p,s),e.deleteShader(t),e.deleteShader(s)}}}const ys=class Nc{constructor(e){this.__id=Nc.__counter__++,this.pickingEnabled=!0,this._entityCollection=e,this._renderer=null,this._billboards=[],this._positionHighBuffer=null,this._positionLowBuffer=null,this._sizeBuffer=null,this._offsetBuffer=null,this._rgbaBuffer=null,this._rotationBuffer=null,this._texCoordBuffer=null,this._vertexBuffer=null,this._pickingColorBuffer=null,this._texCoordArr=new Float32Array([]),this._vertexArr=new Float32Array([]),this._positionHighArr=new Float32Array([]),this._positionLowArr=new Float32Array([]),this._sizeArr=new Float32Array([]),this._offsetArr=new Float32Array([]),this._rgbaArr=new Float32Array([]),this._rotationArr=new Float32Array([]),this._pickingColorArr=new Float32Array([]),this._buffersUpdateCallbacks=[],this._buffersUpdateCallbacks[0]=this.createPickingColorBuffer,this._buffersUpdateCallbacks[1]=this.createPositionBuffer,this._buffersUpdateCallbacks[2]=this.createSizeBuffer,this._buffersUpdateCallbacks[3]=this.createOffsetBuffer,this._buffersUpdateCallbacks[4]=this.createRgbaBuffer,this._buffersUpdateCallbacks[5]=this.createRotationBuffer,this._buffersUpdateCallbacks[6]=this.createTexCoordBuffer,this._buffersUpdateCallbacks[7]=this.createVertexBuffer,this._changedBuffers=new Array(this._buffersUpdateCallbacks.length)}isEqual(e){return e&&e.__id===this.__id}static concArr(e,t){for(let s=0;s<t.length;s++)e.push(t[s])}initProgram(){this._renderer&&this._renderer.handler&&(this._renderer.handler.programs.billboard||this._renderer.handler.addProgram(new $("billboard",{uniforms:{viewport:"vec2",u_texture:"sampler2d",projectionMatrix:"mat4",viewMatrix:"mat4",eyePositionHigh:"vec3",eyePositionLow:"vec3",planetRadius:"float",uScaleByDistance:"vec3",opacity:"float",depthOffset:"float"},attributes:{a_vertices:"vec2",a_texCoord:"vec2",a_positionsHigh:"vec3",a_positionsLow:"vec3",a_offset:"vec3",a_size:"vec2",a_rotation:"float",a_rgba:"vec4"},vertexShader:`precision highp float;
#define EMPTY - 1.0
#define RTL 1.0
vec2 project(vec4 p,vec2 viewport){return(0.5*p.xyz/p.w+0.5).xy*viewport;}mat2 rotate2d(float angle){return mat2(cos(angle),-sin(angle),sin(angle),cos(angle));}attribute vec2 a_vertices;attribute vec2 a_texCoord;attribute vec3 a_positionsHigh;attribute vec3 a_positionsLow;attribute vec3 a_offset;attribute vec2 a_size;attribute float a_rotation;attribute vec4 a_rgba;varying vec2 v_texCoords;varying vec4 v_rgba;uniform mat4 viewMatrix;uniform mat4 projectionMatrix;uniform vec3 eyePositionHigh;uniform vec3 eyePositionLow;uniform vec3 uScaleByDistance;uniform float opacity;uniform float planetRadius;uniform vec2 viewport;uniform float depthOffset;const vec3 ZERO3=vec3(0.0);void main(){vec3 a_positions=a_positionsHigh+a_positionsLow;vec3 cameraPos=eyePositionHigh+eyePositionLow;v_texCoords=a_texCoord;vec3 look=a_positions-cameraPos;float lookDist=length(look);v_rgba=a_rgba;if(opacity*step(lookDist,sqrt(dot(cameraPos,cameraPos)-planetRadius)+sqrt(dot(a_positions,a_positions)-planetRadius))==0.0){return;}float scd=(1.0-smoothstep(uScaleByDistance[0],uScaleByDistance[1],lookDist))*(1.0-step(uScaleByDistance[2],lookDist));mat4 viewMatrixRTE=viewMatrix;viewMatrixRTE[3]=vec4(0.0,0.0,0.0,1.0);vec3 highDiff=a_positionsHigh-eyePositionHigh;vec3 lowDiff=a_positionsLow-eyePositionLow;vec4 posRTE=viewMatrixRTE*vec4(highDiff+lowDiff,1.0);vec4 projPos=projectionMatrix*posRTE;float camSlope=dot(vec3(viewMatrix[0][2],viewMatrix[1][2],viewMatrix[2][2]),normalize(cameraPos));if(camSlope>0.5){float dist=dot(look,normalize(cameraPos));projPos.z+=dist*0.02;}else{projPos.z+=-(abs(projPos.z))*0.002;}projPos.z+=depthOffset+a_offset.z;vec2 screenPos=project(projPos,viewport);vec2 v=screenPos+rotate2d(a_rotation)*(a_vertices*a_size*scd+a_offset.xy);gl_Position=vec4((2.0*v/viewport-1.0)*projPos.w,projPos.z,projPos.w);}`,fragmentShader:"precision highp float;uniform sampler2D u_texture;varying vec2 v_texCoords;varying vec4 v_rgba;void main(){vec4 color=texture2D(u_texture,v_texCoords);if(color.a<0.1)discard;gl_FragColor=color*v_rgba;}"})),this._renderer.handler.programs.billboardPicking||this._renderer.handler.addProgram(new $("billboardPicking",{uniforms:{viewport:"vec2",projectionMatrix:"mat4",viewMatrix:"mat4",eyePositionHigh:"vec3",eyePositionLow:"vec3",planetRadius:"float",uScaleByDistance:"vec3",opacity:"float",depthOffset:"float"},attributes:{a_vertices:"vec2",a_positionsHigh:"vec3",a_positionsLow:"vec3",a_offset:"vec3",a_size:"vec2",a_rotation:"float",a_rgba:"vec4"},vertexShader:`precision highp float;
#define EMPTY - 1.0
#define RTL 1.0
vec2 project(vec4 p,vec2 viewport){return(0.5*p.xyz/p.w+0.5).xy*viewport;}mat2 rotate2d(float angle){return mat2(cos(angle),-sin(angle),sin(angle),cos(angle));}attribute vec2 a_vertices;attribute vec3 a_positionsHigh;attribute vec3 a_positionsLow;attribute vec3 a_offset;attribute vec2 a_size;attribute float a_rotation;attribute vec4 a_rgba;varying vec3 v_rgb;uniform mat4 viewMatrix;uniform mat4 projectionMatrix;uniform vec3 eyePositionHigh;uniform vec3 eyePositionLow;uniform vec3 uScaleByDistance;uniform float opacity;uniform float planetRadius;uniform vec2 viewport;uniform float depthOffset;const vec3 ZERO3=vec3(0.0);void main(){vec3 a_positions=a_positionsHigh+a_positionsLow;vec3 cameraPos=eyePositionHigh+eyePositionLow;vec3 look=a_positions-cameraPos;float lookDist=length(look);v_rgb=a_rgba.rgb;if(opacity*step(lookDist,sqrt(dot(cameraPos,cameraPos)-planetRadius)+sqrt(dot(a_positions,a_positions)-planetRadius))==0.0){return;}float scd=(1.0-smoothstep(uScaleByDistance[0],uScaleByDistance[1],lookDist))*(1.0-step(uScaleByDistance[2],lookDist));mat4 viewMatrixRTE=viewMatrix;viewMatrixRTE[3]=vec4(0.0,0.0,0.0,1.0);vec3 highDiff=a_positionsHigh-eyePositionHigh;vec3 lowDiff=a_positionsLow-eyePositionLow;vec4 posRTE=viewMatrixRTE*vec4(highDiff+lowDiff,1.0);vec4 projPos=projectionMatrix*posRTE;float camSlope=dot(vec3(viewMatrix[0][2],viewMatrix[1][2],viewMatrix[2][2]),normalize(cameraPos));if(camSlope>0.5){float dist=dot(look,normalize(cameraPos));projPos.z+=dist*0.02;}else{projPos.z+=-(abs(projPos.z))*0.002;}projPos.z+=depthOffset+a_offset.z;vec2 screenPos=project(projPos,viewport);vec2 v=screenPos+rotate2d(a_rotation)*(a_vertices*a_size*scd+a_offset.xy);gl_Position=vec4((2.0*v/viewport-1.0)*projPos.w,projPos.z,projPos.w);}`,fragmentShader:"precision highp float;varying vec3 v_rgb;void main(){gl_FragColor=vec4(v_rgb,1.0);}"})))}setRenderer(e){this._renderer=e,this.initProgram()}refresh(){let e=this._changedBuffers.length;for(;e--;)this._changedBuffers[e]=!0}_removeBillboards(){let e=this._billboards.length;for(;e--;){let t=this._billboards[e];t._handlerIndex=-1,t._handler=null,t._isReady=!1,t._lockId=-1}this._billboards.length=0,this._billboards=[]}clear(){this._texCoordArr=null,this._vertexArr=null,this._positionHighArr=null,this._positionLowArr=null,this._sizeArr=null,this._offsetArr=null,this._rgbaArr=null,this._rotationArr=null,this._pickingColorArr=null,this._texCoordArr=new Float32Array([]),this._vertexArr=new Float32Array([]),this._positionHighArr=new Float32Array([]),this._positionLowArr=new Float32Array([]),this._sizeArr=new Float32Array([]),this._offsetArr=new Float32Array([]),this._rgbaArr=new Float32Array([]),this._rotationArr=new Float32Array([]),this._pickingColorArr=new Float32Array([]),this._removeBillboards(),this._deleteBuffers(),this.refresh()}_deleteBuffers(){if(this._renderer){let e=this._renderer.handler.gl;e.deleteBuffer(this._positionHighBuffer),e.deleteBuffer(this._positionLowBuffer),e.deleteBuffer(this._sizeBuffer),e.deleteBuffer(this._offsetBuffer),e.deleteBuffer(this._rgbaBuffer),e.deleteBuffer(this._rotationBuffer),e.deleteBuffer(this._vertexBuffer),e.deleteBuffer(this._texCoordBuffer),e.deleteBuffer(this._pickingColorBuffer)}this._positionHighBuffer=null,this._positionLowBuffer=null,this._sizeBuffer=null,this._offsetBuffer=null,this._rgbaBuffer=null,this._rotationBuffer=null,this._vertexBuffer=null,this._texCoordBuffer=null,this._pickingColorBuffer=null}update(){if(this._renderer){let e=this._changedBuffers.length;for(;e--;)this._changedBuffers[e]&&(this._buffersUpdateCallbacks[e].call(this),this._changedBuffers[e]=!1)}}add(e){e._handlerIndex==-1&&(e._isReady=!0,e._handler=this,e._handlerIndex=this._billboards.length,this._billboards.push(e))}_displayPASS(){let e=this._renderer,t=e.handler;t.programs.billboard.activate();let s=t.programs.billboard._program,n=s.attributes,o=s.uniforms,a=t.gl,h=this._entityCollection;a.disable(a.CULL_FACE),a.uniform1f(o.depthOffset,h.polygonOffsetUnits),a.uniform1i(o.u_texture,0),a.uniformMatrix4fv(o.viewMatrix,!1,e.activeCamera.getViewMatrix()),a.uniformMatrix4fv(o.projectionMatrix,!1,e.activeCamera.getProjectionMatrix()),a.uniform3fv(o.eyePositionHigh,e.activeCamera.eyeHigh),a.uniform3fv(o.eyePositionLow,e.activeCamera.eyeLow),a.uniform3fv(o.uScaleByDistance,h.scaleByDistance),a.uniform1f(o.opacity,h._fadingOpacity),a.bindBuffer(a.ARRAY_BUFFER,this._texCoordBuffer),a.vertexAttribPointer(n.a_texCoord,this._texCoordBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this._vertexBuffer),a.vertexAttribPointer(n.a_vertices,this._vertexBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this._positionHighBuffer),a.vertexAttribPointer(n.a_positionsHigh,this._positionHighBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this._positionLowBuffer),a.vertexAttribPointer(n.a_positionsLow,this._positionLowBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this._rgbaBuffer),a.vertexAttribPointer(n.a_rgba,this._rgbaBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this._sizeBuffer),a.vertexAttribPointer(n.a_size,this._sizeBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this._offsetBuffer),a.vertexAttribPointer(n.a_offset,this._offsetBuffer.itemSize,a.FLOAT,!1,0,0),a.uniform1f(o.planetRadius,h.renderNode._planetRadius2||0),a.uniform2fv(o.viewport,[t.canvas.clientWidth,t.canvas.clientHeight]),a.bindBuffer(a.ARRAY_BUFFER,this._rotationBuffer),a.vertexAttribPointer(n.a_rotation,this._rotationBuffer.itemSize,a.FLOAT,!1,0,0),a.drawArrays(a.TRIANGLES,0,this._vertexBuffer.numItems),a.enable(a.CULL_FACE)}_pickingPASS(){let e=this._renderer,t=e.handler;t.programs.billboardPicking.activate();let s=t.programs.billboardPicking._program,n=s.attributes,o=s.uniforms,a=t.gl,h=this._entityCollection;a.disable(a.CULL_FACE),a.uniform1f(o.depthOffset,h.polygonOffsetUnits),a.uniformMatrix4fv(o.viewMatrix,!1,e.activeCamera.getViewMatrix()),a.uniformMatrix4fv(o.projectionMatrix,!1,e.activeCamera.getProjectionMatrix()),a.uniform3fv(o.eyePositionHigh,e.activeCamera.eyeHigh),a.uniform3fv(o.eyePositionLow,e.activeCamera.eyeLow),a.uniform3fv(o.uScaleByDistance,h.scaleByDistance),a.uniform1f(o.opacity,h._fadingOpacity),a.bindBuffer(a.ARRAY_BUFFER,this._vertexBuffer),a.vertexAttribPointer(n.a_vertices,this._vertexBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this._positionHighBuffer),a.vertexAttribPointer(n.a_positionsHigh,this._positionHighBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this._positionLowBuffer),a.vertexAttribPointer(n.a_positionsLow,this._positionLowBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this._pickingColorBuffer),a.vertexAttribPointer(n.a_rgba,this._pickingColorBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this._sizeBuffer),a.vertexAttribPointer(n.a_size,this._sizeBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this._offsetBuffer),a.vertexAttribPointer(n.a_offset,this._offsetBuffer.itemSize,a.FLOAT,!1,0,0),a.uniform1f(o.planetRadius,h.renderNode._planetRadius2||0),a.uniform2fv(o.viewport,[t.canvas.clientWidth,t.canvas.clientHeight]),a.bindBuffer(a.ARRAY_BUFFER,this._rotationBuffer),a.vertexAttribPointer(n.a_rotation,this._rotationBuffer.itemSize,a.FLOAT,!1,0,0),a.drawArrays(a.TRIANGLES,0,this._vertexBuffer.numItems),a.enable(a.CULL_FACE)}draw(){this._billboards.length&&(this.update(),this._displayPASS())}drawPicking(){this._billboards.length&&this.pickingEnabled&&this._pickingPASS()}reindexBillboardsArray(e){let t=this._billboards;for(let s=e;s<t.length;s++)t[s]._handlerIndex=s}_removeBillboard(e){let t=e._handlerIndex;this._billboards.splice(t,1);let s=24*t;this._rgbaArr=at(this._rgbaArr,s,24),s=18*t,this._positionHighArr=at(this._positionHighArr,s,18),this._positionLowArr=at(this._positionLowArr,s,18),this._offsetArr=at(this._offsetArr,s,18),this._pickingColorArr=at(this._pickingColorArr,s,18),s=12*t,this._vertexArr=at(this._vertexArr,s,12),this._sizeArr=at(this._sizeArr,s,12),this._texCoordArr=at(this._texCoordArr,s,12),s=6*t,this._rotationArr=at(this._rotationArr,s,6),this.reindexBillboardsArray(t),this.refresh(),e._handlerIndex=-1,e._handler=null,e._isReady=!1,e._lockId=-1}setAlignedAxisArr(e,t){}remove(e){e._handler&&(e._isReady&&this.__id===e._handler.__id?this._removeBillboard(e):e._handler=null)}setPositionArr(e,t,s){let n=18*e,o=this._positionHighArr,a=t.x,h=t.y,c=t.z;o[n]=a,o[n+1]=h,o[n+2]=c,o[n+3]=a,o[n+4]=h,o[n+5]=c,o[n+6]=a,o[n+7]=h,o[n+8]=c,o[n+9]=a,o[n+10]=h,o[n+11]=c,o[n+12]=a,o[n+13]=h,o[n+14]=c,o[n+15]=a,o[n+16]=h,o[n+17]=c,o=this._positionLowArr,a=s.x,h=s.y,c=s.z,o[n]=a,o[n+1]=h,o[n+2]=c,o[n+3]=a,o[n+4]=h,o[n+5]=c,o[n+6]=a,o[n+7]=h,o[n+8]=c,o[n+9]=a,o[n+10]=h,o[n+11]=c,o[n+12]=a,o[n+13]=h,o[n+14]=c,o[n+15]=a,o[n+16]=h,o[n+17]=c,this._changedBuffers[1]=!0}setPickingColorArr(e,t){let s=18*e,n=this._pickingColorArr,o=t.x/255,a=t.y/255,h=t.z/255;n[s]=o,n[s+1]=a,n[s+2]=h,n[s+3]=o,n[s+4]=a,n[s+5]=h,n[s+6]=o,n[s+7]=a,n[s+8]=h,n[s+9]=o,n[s+10]=a,n[s+11]=h,n[s+12]=o,n[s+13]=a,n[s+14]=h,n[s+15]=o,n[s+16]=a,n[s+17]=h,this._changedBuffers[0]=!0}setSizeArr(e,t,s){let n=12*e,o=this._sizeArr,a=t,h=s;o[n]=a,o[n+1]=h,o[n+2]=a,o[n+3]=h,o[n+4]=a,o[n+5]=h,o[n+6]=a,o[n+7]=h,o[n+8]=a,o[n+9]=h,o[n+10]=a,o[n+11]=h,this._changedBuffers[2]=!0}setOffsetArr(e,t){let s=18*e,n=this._offsetArr,o=t.x,a=t.y,h=t.z;n[s]=o,n[s+1]=a,n[s+2]=h,n[s+3]=o,n[s+4]=a,n[s+5]=h,n[s+6]=o,n[s+7]=a,n[s+8]=h,n[s+9]=o,n[s+10]=a,n[s+11]=h,n[s+12]=o,n[s+13]=a,n[s+14]=h,n[s+15]=o,n[s+16]=a,n[s+17]=h,this._changedBuffers[3]=!0}setRgbaArr(e,t){let s=24*e,n=this._rgbaArr,o=t.x,a=t.y,h=t.z,c=t.w;n[s]=o,n[s+1]=a,n[s+2]=h,n[s+3]=c,n[s+4]=o,n[s+5]=a,n[s+6]=h,n[s+7]=c,n[s+8]=o,n[s+9]=a,n[s+10]=h,n[s+11]=c,n[s+12]=o,n[s+13]=a,n[s+14]=h,n[s+15]=c,n[s+16]=o,n[s+17]=a,n[s+18]=h,n[s+19]=c,n[s+20]=o,n[s+21]=a,n[s+22]=h,n[s+23]=c,this._changedBuffers[4]=!0}setRotationArr(e,t){let s=6*e,n=this._rotationArr;n[s]=t,n[s+1]=t,n[s+2]=t,n[s+3]=t,n[s+4]=t,n[s+5]=t,this._changedBuffers[5]=!0}setTexCoordArr(e,t){let s=12*e,n=this._texCoordArr;n[s]=t[0],n[s+1]=t[1],n[s+2]=t[2],n[s+3]=t[3],n[s+4]=t[4],n[s+5]=t[5],n[s+6]=t[6],n[s+7]=t[7],n[s+8]=t[8],n[s+9]=t[9],n[s+10]=t[10],n[s+11]=t[11],this._changedBuffers[6]=!0}setVisibility(e,t){let s;s=t?[-.5,.5,-.5,-.5,.5,-.5,.5,-.5,.5,.5,-.5,.5]:[0,0,0,0,0,0,0,0,0,0,0,0],this.setVertexArr(e,s)}setVertexArr(e,t){let s=12*e,n=this._vertexArr;n[s]=t[0],n[s+1]=t[1],n[s+2]=t[2],n[s+3]=t[3],n[s+4]=t[4],n[s+5]=t[5],n[s+6]=t[6],n[s+7]=t[7],n[s+8]=t[8],n[s+9]=t[9],n[s+10]=t[10],n[s+11]=t[11],this._changedBuffers[7]=!0}createPositionBuffer(){let e=this._renderer.handler,t=this._positionHighArr.length/3;this._positionHighBuffer&&this._positionHighBuffer.numItems===t||(e.gl.deleteBuffer(this._positionHighBuffer),e.gl.deleteBuffer(this._positionLowBuffer),this._positionHighBuffer=e.createStreamArrayBuffer(3,t),this._positionLowBuffer=e.createStreamArrayBuffer(3,t)),e.setStreamArrayBuffer(this._positionHighBuffer,this._positionHighArr),e.setStreamArrayBuffer(this._positionLowBuffer,this._positionLowArr)}createSizeBuffer(){let e=this._renderer.handler;e.gl.deleteBuffer(this._sizeBuffer),this._sizeBuffer=e.createArrayBuffer(this._sizeArr,2,this._sizeArr.length/2)}createOffsetBuffer(){let e=this._renderer.handler;e.gl.deleteBuffer(this._offsetBuffer),this._offsetBuffer=e.createArrayBuffer(this._offsetArr,3,this._offsetArr.length/3)}createRgbaBuffer(){let e=this._renderer.handler;e.gl.deleteBuffer(this._rgbaBuffer),this._rgbaBuffer=e.createArrayBuffer(this._rgbaArr,4,this._rgbaArr.length/4)}createRotationBuffer(){let e=this._renderer.handler;this._rotationBuffer&&this._rotationBuffer.numItems===this._rotationArr.length||(e.gl.deleteBuffer(this._rotationBuffer),this._rotationBuffer=e.createStreamArrayBuffer(1,this._rotationArr.length)),e.setStreamArrayBuffer(this._rotationBuffer,this._rotationArr)}createVertexBuffer(){let e=this._renderer.handler;e.gl.deleteBuffer(this._vertexBuffer),this._vertexBuffer=e.createArrayBuffer(this._vertexArr,2,this._vertexArr.length/2)}createTexCoordBuffer(){let e=this._renderer.handler;e.gl.deleteBuffer(this._texCoordBuffer),this._texCoordBuffer=e.createArrayBuffer(this._texCoordArr,2,this._texCoordArr.length/2)}createPickingColorBuffer(){let e=this._renderer.handler;e.gl.deleteBuffer(this._pickingColorBuffer),this._pickingColorBuffer=e.createArrayBuffer(this._pickingColorArr,3,this._pickingColorArr.length/3)}refreshTexCoordsArr(){}};ys.__counter__=0;let ss=ys;class el extends ss{constructor(e){super(e),this._billboards=[]}add(e){if(e._handlerIndex==-1){super.add(e),this._addBillboardToArrays(e),this.refresh();let t=e.getSrc()||e.getImage()&&e.getImage().src;t&&e.setSrc(t)}}_addBillboardToArrays(e){e.getVisibility()?this._vertexArr=nt(this._vertexArr,[-.5,.5,-.5,-.5,.5,-.5,.5,-.5,.5,.5,-.5,.5]):this._vertexArr=nt(this._vertexArr,[0,0,0,0,0,0,0,0,0,0,0,0]),this._texCoordArr=nt(this._texCoordArr,[0,0,0,0,0,0,0,0,0,0,0,0]);let t,s=e._positionHigh.x,n=e._positionHigh.y,o=e._positionHigh.z;this._positionHighArr=nt(this._positionHighArr,[s,n,o,s,n,o,s,n,o,s,n,o,s,n,o,s,n,o]),s=e._positionLow.x,n=e._positionLow.y,o=e._positionLow.z,this._positionLowArr=nt(this._positionLowArr,[s,n,o,s,n,o,s,n,o,s,n,o,s,n,o,s,n,o]),s=e._width,n=e._height,this._sizeArr=nt(this._sizeArr,[s,n,s,n,s,n,s,n,s,n,s,n]),s=e._offset.x,n=e._offset.y,o=e._offset.z,this._offsetArr=nt(this._offsetArr,[s,n,o,s,n,o,s,n,o,s,n,o,s,n,o,s,n,o]),s=e._color.x,n=e._color.y,o=e._color.z,t=e._color.w,this._rgbaArr=nt(this._rgbaArr,[s,n,o,t,s,n,o,t,s,n,o,t,s,n,o,t,s,n,o,t,s,n,o,t]),s=e._rotation,this._rotationArr=nt(this._rotationArr,[s,s,s,s,s,s]),s=e._entity._pickingColor.x/255,n=e._entity._pickingColor.y/255,o=e._entity._pickingColor.z/255,this._pickingColorArr=nt(this._pickingColorArr,[s,n,o,s,n,o,s,n,o,s,n,o,s,n,o,s,n,o])}get billboards(){return this._billboards}refreshTexCoordsArr(){if(this._entityCollection&&this._renderer){let e=this._renderer.billboardsTextureAtlas;for(let t=0;t<this._billboards.length;t++){let s=this._billboards[t],n=s.getImage();if(n){let o=e.get(n.__nodeIndex);o&&this.setTexCoordArr(s._handlerIndex,o.texCoords)}}}}}class il{constructor(e){this.isFree=!0,this._geoObjectHandler=e,this.geoObjects=[],this.numInstances=0,this._colorTexture=null,this._colorTextureSrc=null,this._colorTextureImage=null,this._normalTexture=null,this._normalTextureSrc=null,this._normalTextureImage=null,this._metallicRoughnessTexture=null,this._metallicRoughnessTextureSrc=null,this._metallicRoughnessTextureImage=null,this._sizeArr=[],this._translateArr=[],this._vertexArr=[],this._rtcPositionHighArr=[],this._rtcPositionLowArr=[],this._qRotArr=[],this._rgbaArr=[],this._normalsArr=[],this._indicesArr=[],this._pickingColorArr=[],this._visibleArr=[],this._texCoordArr=[],this._localPositionArr=[],this._sizeBuffer=null,this._translateBuffer=null,this._vertexBuffer=null,this._rtcPositionHighBuffer=null,this._rtcPositionLowBuffer=null,this._qRotBuffer=null,this._rgbaBuffer=null,this._normalsBuffer=null,this._indicesBuffer=null,this._pickingColorBuffer=null,this._visibleBuffer=null,this._texCoordBuffer=null,this._localPositionBuffer=null,this._materialParams=new Float32Array(9),this._materialShininess=0,this._buffersUpdateCallbacks=[],this._buffersUpdateCallbacks[Zo]=this.createPickingColorBuffer,this._buffersUpdateCallbacks[Yo]=this.createNormalsBuffer,this._buffersUpdateCallbacks[qo]=this.createRgbaBuffer,this._buffersUpdateCallbacks[Wo]=this.createIndicesBuffer,this._buffersUpdateCallbacks[Go]=this.createVertexBuffer,this._buffersUpdateCallbacks[Xo]=this.createSizeBuffer,this._buffersUpdateCallbacks[Ko]=this.createVisibleBuffer,this._buffersUpdateCallbacks[Qo]=this.createTexCoordBuffer,this._buffersUpdateCallbacks[$o]=this.createQRotBuffer,this._buffersUpdateCallbacks[Jo]=this.createTranslateBuffer,this._buffersUpdateCallbacks[jo]=this.createRTCPositionBuffer,this._buffersUpdateCallbacks[ta]=this.createLocalPositionBuffer,this._changedBuffers=new Array(this._buffersUpdateCallbacks.length)}setMaterialAmbient(e,t,s){this._materialParams[0]=e,this._materialParams[1]=t,this._materialParams[2]=s}setMaterialDiffuse(e,t,s){this._materialParams[3]=e,this._materialParams[4]=t,this._materialParams[5]=s}setMaterialSpecular(e,t,s){this._materialParams[6]=e,this._materialParams[7]=t,this._materialParams[8]=s}setMaterialShininess(e){this._materialShininess=e}setMaterialParams(e,t,s,n){this.setMaterialAmbient(e[0],e[1],e[2]),this.setMaterialDiffuse(t[0],t[1],t[2]),this.setMaterialSpecular(s[0],s[1],s[2]),this.setMaterialShininess(n)}drawOpaque(e){let t=e.gl,s=e.uniforms,n=e.attributes;t.bindBuffer(t.ARRAY_BUFFER,this._qRotBuffer),t.vertexAttribPointer(n.qRot,this._qRotBuffer.itemSize,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,this._sizeBuffer),t.vertexAttribPointer(n.aScale,this._sizeBuffer.itemSize,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,this._translateBuffer),t.vertexAttribPointer(n.aTranslate,this._translateBuffer.itemSize,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,this._localPositionBuffer),t.vertexAttribPointer(n.aLocalPosition,this._localPositionBuffer.itemSize,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,this._visibleBuffer),t.vertexAttribPointer(n.aDispose,this._visibleBuffer.itemSize,t.FLOAT,!1,0,0),t.uniform1f(s.uUseTexture,this._colorTexture?1:0),t.bindBuffer(t.ARRAY_BUFFER,this._rgbaBuffer),t.vertexAttribPointer(n.aColor,this._rgbaBuffer.itemSize,t.FLOAT,!1,0,0),t.uniform3fv(s.materialParams,this._materialParams),t.uniform1f(s.materialShininess,this._materialShininess),this._drawElementsInstanced(e)}drawTransparent(e){let t=e.gl,s=e.uniforms,n=e.attributes;t.bindBuffer(t.ARRAY_BUFFER,this._qRotBuffer),t.vertexAttribPointer(n.qRot,this._qRotBuffer.itemSize,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,this._sizeBuffer),t.vertexAttribPointer(n.aScale,this._sizeBuffer.itemSize,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,this._translateBuffer),t.vertexAttribPointer(n.aTranslate,this._translateBuffer.itemSize,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,this._localPositionBuffer),t.vertexAttribPointer(n.aLocalPosition,this._localPositionBuffer.itemSize,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,this._visibleBuffer),t.vertexAttribPointer(n.aDispose,this._visibleBuffer.itemSize,t.FLOAT,!1,0,0),t.uniform1f(s.uUseTexture,this._colorTexture?1:0),t.uniform3fv(s.materialParams,this._materialParams),t.uniform1f(s.materialShininess,this._materialShininess),t.bindBuffer(t.ARRAY_BUFFER,this._rgbaBuffer),t.vertexAttribPointer(n.aColor,this._rgbaBuffer.itemSize,t.FLOAT,!1,0,0),this._drawElementsInstanced(e)}_drawElementsInstanced(e){let t=e.gl,s=e.uniforms,n=e.attributes,o=this._geoObjectHandler._renderer;t.bindBuffer(t.ARRAY_BUFFER,this._rtcPositionHighBuffer),t.vertexAttribPointer(n.aRTCPositionHigh,this._rtcPositionHighBuffer.itemSize,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,this._rtcPositionLowBuffer),t.vertexAttribPointer(n.aRTCPositionLow,this._rtcPositionLowBuffer.itemSize,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,this._normalsBuffer),t.vertexAttribPointer(n.aVertexNormal,this._normalsBuffer.itemSize,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,this._vertexBuffer),t.vertexAttribPointer(n.aVertexPosition,this._vertexBuffer.itemSize,t.FLOAT,!1,0,0),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,this._colorTexture||o.handler.defaultTexture),t.uniform1i(s.uTexture,0),t.bindBuffer(t.ARRAY_BUFFER,this._texCoordBuffer),t.vertexAttribPointer(n.aTexCoord,this._texCoordBuffer.itemSize,t.FLOAT,!1,0,0),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this._indicesBuffer),e.drawElementsInstanced(t.TRIANGLES,this._indicesBuffer.numItems,t.UNSIGNED_INT,0,this.numInstances)}async loadColorTexture(){if(this._geoObjectHandler._renderer){if(!this._colorTextureSrc)return this._colorTextureImage?(await this._colorTextureImage.decode(),void this._createColorTexture(this._colorTextureImage)):void 0;{const e=await Vi(this._colorTextureSrc);this._createColorTexture(e)}}}async loadNormalTexture(){if(this._geoObjectHandler._renderer){if(!this._normalTextureSrc)return this._normalTextureImage?(await this._normalTextureImage.decode(),void this._createNormalTexture(this._normalTextureImage)):void 0;{const e=await Vi(this._normalTextureSrc);this._createNormalTexture(e)}}}async loadMetallicRoughnessTexture(){if(this._geoObjectHandler._renderer){if(!this._metallicRoughnessTextureSrc)return this._metallicRoughnessTextureImage?(await this._metallicRoughnessTextureImage.decode(),void this._createMetallicRoughnessTexture(this._metallicRoughnessTextureImage)):void 0;{const e=await Vi(this._metallicRoughnessTextureSrc);this._createMetallicRoughnessTexture(e)}}}clear(){this.numInstances=0,this.geoObjects=[],this._sizeArr=[],this._translateArr=[],this._vertexArr=[],this._rtcPositionHighArr=[],this._rtcPositionLowArr=[],this._qRotArr=[],this._rgbaArr=[],this._normalsArr=[],this._indicesArr=[],this._pickingColorArr=[],this._visibleArr=[],this._texCoordArr=[],this._localPositionArr=[],this._deleteBuffers(),this.isFree=!1}_deleteBuffers(){if(this._geoObjectHandler&&this._geoObjectHandler._renderer){let e=this._geoObjectHandler._renderer.handler;if(e){e.deleteTexture(this._colorTexture),e.deleteTexture(this._normalTexture),e.deleteTexture(this._metallicRoughnessTexture);let t=e.gl;t&&(t.deleteBuffer(this._sizeBuffer),t.deleteBuffer(this._translateBuffer),t.deleteBuffer(this._vertexBuffer),t.deleteBuffer(this._rtcPositionHighBuffer),t.deleteBuffer(this._rtcPositionLowBuffer),t.deleteBuffer(this._qRotBuffer),t.deleteBuffer(this._rgbaBuffer),t.deleteBuffer(this._normalsBuffer),t.deleteBuffer(this._indicesBuffer),t.deleteBuffer(this._pickingColorBuffer),t.deleteBuffer(this._visibleBuffer),t.deleteBuffer(this._texCoordBuffer),t.deleteBuffer(this._localPositionBuffer))}this._colorTexture=null,this._normalTexture=null,this._metallicRoughnessTexture=null}this._sizeBuffer=null,this._translateBuffer=null,this._vertexBuffer=null,this._rtcPositionHighBuffer=null,this._rtcPositionLowBuffer=null,this._qRotBuffer=null,this._rgbaBuffer=null,this._normalsBuffer=null,this._indicesBuffer=null,this._pickingColorBuffer=null,this._visibleBuffer=null,this._texCoordBuffer=null,this._localPositionBuffer=null}createVertexBuffer(){const e=this._geoObjectHandler._renderer.handler;e.gl.deleteBuffer(this._vertexBuffer),this._vertexArr=it(this._vertexArr),this._vertexBuffer=e.createArrayBuffer(this._vertexArr,3,this._vertexArr.length/3)}createVisibleBuffer(){const e=this._geoObjectHandler._renderer.handler,t=this._visibleArr.length;this._visibleBuffer&&this._visibleBuffer.numItems===t||(e.gl.deleteBuffer(this._visibleBuffer),this._visibleBuffer=e.createStreamArrayBuffer(1,t)),this._visibleArr=it(this._visibleArr),e.setStreamArrayBuffer(this._visibleBuffer,this._visibleArr)}createSizeBuffer(){let e=this._geoObjectHandler._renderer.handler,t=this._sizeArr.length/3;this._sizeBuffer&&this._sizeBuffer.numItems===t||(e.gl.deleteBuffer(this._sizeBuffer),this._sizeBuffer=e.createStreamArrayBuffer(3,t)),this._sizeArr=it(this._sizeArr),e.setStreamArrayBuffer(this._sizeBuffer,this._sizeArr)}createTranslateBuffer(){let e=this._geoObjectHandler._renderer.handler,t=this._translateArr.length/3;this._translateBuffer&&this._translateBuffer.numItems===t||(e.gl.deleteBuffer(this._translateBuffer),this._translateBuffer=e.createStreamArrayBuffer(3,t)),this._translateArr=it(this._translateArr),e.setStreamArrayBuffer(this._translateBuffer,this._translateArr)}createLocalPositionBuffer(){let e=this._geoObjectHandler._renderer.handler,t=this._localPositionArr.length/3;this._localPositionBuffer&&this._localPositionBuffer.numItems===t||(e.gl.deleteBuffer(this._localPositionBuffer),this._localPositionBuffer=e.createStreamArrayBuffer(3,t)),this._localPositionArr=it(this._localPositionArr),e.setStreamArrayBuffer(this._localPositionBuffer,this._localPositionArr)}createTexCoordBuffer(){const e=this._geoObjectHandler._renderer.handler;e.gl.deleteBuffer(this._texCoordBuffer),this._texCoordArr=it(this._texCoordArr),this._texCoordBuffer=e.createArrayBuffer(this._texCoordArr,2,this._texCoordArr.length/2)}createRTCPositionBuffer(){let e=this._geoObjectHandler._renderer.handler,t=this._rtcPositionHighArr.length/3;this._rtcPositionHighBuffer&&this._rtcPositionHighBuffer.numItems===t||(e.gl.deleteBuffer(this._rtcPositionHighBuffer),e.gl.deleteBuffer(this._rtcPositionLowBuffer),this._rtcPositionHighBuffer=e.createStreamArrayBuffer(3,t),this._rtcPositionLowBuffer=e.createStreamArrayBuffer(3,t)),this._rtcPositionHighArr=it(this._rtcPositionHighArr),this._rtcPositionLowArr=it(this._rtcPositionLowArr),e.setStreamArrayBuffer(this._rtcPositionHighBuffer,this._rtcPositionHighArr),e.setStreamArrayBuffer(this._rtcPositionLowBuffer,this._rtcPositionLowArr)}createRgbaBuffer(){let e=this._geoObjectHandler._renderer.handler,t=this._rgbaArr.length/4;this._rgbaBuffer&&this._rgbaBuffer.numItems===t||(e.gl.deleteBuffer(this._rgbaBuffer),this._rgbaBuffer=e.createStreamArrayBuffer(4,t)),this._rgbaArr=it(this._rgbaArr),e.setStreamArrayBuffer(this._rgbaBuffer,this._rgbaArr)}createQRotBuffer(){let e=this._geoObjectHandler._renderer.handler,t=this._qRotArr.length/4;this._qRotBuffer&&this._qRotBuffer.numItems===t||(e.gl.deleteBuffer(this._qRotBuffer),this._qRotBuffer=e.createStreamArrayBuffer(4,t)),this._qRotArr=it(this._qRotArr),e.setStreamArrayBuffer(this._qRotBuffer,this._qRotArr)}createNormalsBuffer(){const e=this._geoObjectHandler._renderer.handler;e.gl.deleteBuffer(this._normalsBuffer),this._normalsArr=it(this._normalsArr),this._normalsBuffer=e.createArrayBuffer(this._normalsArr,3,this._normalsArr.length/3)}createIndicesBuffer(){const e=this._geoObjectHandler._renderer.handler;e.gl.deleteBuffer(this._indicesBuffer),this._indicesArr=it(this._indicesArr,Uint32Array),this._indicesBuffer=e.createElementArrayBuffer(this._indicesArr,1,this._indicesArr.length)}createPickingColorBuffer(){const e=this._geoObjectHandler._renderer.handler;e.gl.deleteBuffer(this._pickingColorBuffer),this._pickingColorArr=it(this._pickingColorArr),this._pickingColorBuffer=e.createArrayBuffer(this._pickingColorArr,3,this._pickingColorArr.length/3)}refresh(){let e=this._changedBuffers.length;for(;e--;)this._changedBuffers[e]=!0}update(){if(this._geoObjectHandler._renderer){let e=this._changedBuffers.length;for(;e--;)this._changedBuffers[e]&&(this._buffersUpdateCallbacks[e].call(this),this._changedBuffers[e]=!1);this.isFree=!0}}_createColorTexture(e){if(this._geoObjectHandler&&this._geoObjectHandler._renderer){let t=this._geoObjectHandler._renderer.handler;this._colorTexture=t.createTextureDefault(e,null,t.gl.REPEAT)}}_createNormalTexture(e){if(this._geoObjectHandler&&this._geoObjectHandler._renderer){let t=this._geoObjectHandler._renderer.handler;this._normalTexture=t.createTextureDefault(e,null,t.gl.REPEAT)}}_createMetallicRoughnessTexture(e){if(this._geoObjectHandler&&this._geoObjectHandler._renderer){let t=this._geoObjectHandler._renderer.handler;this._metallicRoughnessTexture=t.createTextureDefault(e,null,t.gl.REPEAT)}}}const Go=0,jo=1,qo=2,Yo=3,Wo=4,$o=5,Xo=6,Zo=7,Ko=8,Qo=9,Jo=10,ta=11;function wt(l,e=0,t=0,s=1,...n){const o=e*t;for(let a=o,h=o+t;a<h;a++)l[a]=n[a%s];return l}const xs=class Vc{constructor(e){this.__id=Vc.__counter__++,this.pickingEnabled=!0,this._entityCollection=e,this._renderNode=null,this._renderer=null,this._geoObjects=[],this._instanceDataMap=new Map,this._instanceDataMapValues=[],this._dataTagUpdateQueue=[],this._relativeCenter=new m,this._rtcEyePositionHigh=new Float32Array([0,0,0]),this._rtcEyePositionLow=new Float32Array([0,0,0])}initProgram(){this._renderer&&(this._renderer.handler.programs.geo_object||this._renderer.handler.addProgram(new $("geo_object",{uniforms:{viewMatrix:"mat4",projectionMatrix:"mat4",uScaleByDistance:"vec3",eyePositionHigh:"vec3",eyePositionLow:"vec3",rtcEyePositionHigh:"vec3",rtcEyePositionLow:"vec3",sunPosition:"vec3",materialParams:"vec3",materialShininess:"float",uTexture:"sampler2d",uUseTexture:"float",useLighting:"float"},attributes:{aVertexPosition:"vec3",aVertexNormal:"vec3",aTexCoord:"vec2",aLocalPosition:{type:"vec3",divisor:1},aRTCPositionHigh:{type:"vec3",divisor:1},aRTCPositionLow:{type:"vec3",divisor:1},aColor:{type:"vec4",divisor:1},aScale:{type:"vec3",divisor:1},aTranslate:{type:"vec3",divisor:1},aDispose:{type:"float",divisor:1},qRot:{type:"vec4",divisor:1}},vertexShader:"precision highp float;vec3 qRotate(vec4 q,vec3 v){return v+2.0*cross(q.xyz,cross(q.xyz,v)+q.w*v);}attribute vec3 aVertexPosition;attribute vec3 aVertexNormal;attribute vec3 aRTCPositionHigh;attribute vec3 aRTCPositionLow;attribute vec4 aColor;attribute vec3 aScale;attribute vec3 aTranslate;attribute float aDispose;attribute float aUseTexture;attribute vec2 aTexCoord;attribute vec4 qRot;attribute vec3 aLocalPosition;uniform vec3 uScaleByDistance;uniform mat4 projectionMatrix;uniform mat4 viewMatrix;uniform vec3 eyePositionHigh;uniform vec3 eyePositionLow;uniform vec3 rtcEyePositionHigh;uniform vec3 rtcEyePositionLow;varying vec3 cameraPosition;varying vec3 vNormal;varying vec3 v_vertex;varying vec4 vColor;varying float vDispose;varying vec2 vTexCoords;void main(void){if(aDispose==0.0){return;}vColor=aColor;vTexCoords=aTexCoord;mat4 viewMatrixRTE=viewMatrix;viewMatrixRTE[3]=vec4(0.0,0.0,0.0,1.0);vec3 highDiff=aRTCPositionHigh-rtcEyePositionHigh;vec3 lowDiff=aRTCPositionLow-rtcEyePositionLow;cameraPosition=eyePositionHigh+eyePositionLow;highDiff=highDiff*step(1.0,length(highDiff));vec4 positionInViewSpace=viewMatrixRTE*vec4(highDiff+lowDiff,1.0);float lookLength=length(positionInViewSpace.xyz);vNormal=normalize(qRotate(qRot,aVertexNormal));float scd=uScaleByDistance[2]*clamp(lookLength,uScaleByDistance[0],uScaleByDistance[1])/uScaleByDistance[0];vec3 vert=qRotate(qRot,scd*(aVertexPosition*aScale+aTranslate))+scd*aLocalPosition;gl_Position=projectionMatrix*viewMatrixRTE*vec4(highDiff+lowDiff+vert,1.0);v_vertex=positionInViewSpace.xyz+vert;}",fragmentShader:"precision highp float;uniform vec3 sunPosition;uniform vec3 materialParams[3];uniform float materialShininess;uniform sampler2D uTexture;uniform float uUseTexture;uniform float useLighting;varying vec3 cameraPosition;varying vec3 v_vertex;varying vec4 vColor;varying vec3 vNormal;varying vec2 vTexCoords;void main(void){vec3 lightWeighting=vec3(1.0);if(useLighting!=0.0){vec3 normal=normalize(vNormal);vec3 light_dir=normalize(sunPosition);vec3 look_dir=normalize(cameraPosition-v_vertex);float diffuse=max(dot(normal,light_dir),0.0);vec3 refl_dir=reflect(-light_dir,normal);float refl=max(dot(refl_dir,look_dir),0.0);float specular=pow(refl,materialShininess)*step(1e-4,diffuse);lightWeighting=vColor.rgb*materialParams[0]+materialParams[1]*diffuse+materialParams[2]*specular;}else{lightWeighting=vColor.rgb;}if(uUseTexture>0.0){vec4 texColor=texture2D(uTexture,vTexCoords);gl_FragColor=vec4(texColor.rgb*lightWeighting,texColor.a);}else{gl_FragColor=vec4(lightWeighting,vColor.a);}}"})),this._renderer.handler.programs.geo_object_picking||this._renderer.handler.addProgram(new $("geo_object_picking",{uniforms:{viewMatrix:"mat4",projectionMatrix:"mat4",uScaleByDistance:"vec3",pickingScale:"vec3",rtcEyePositionHigh:"vec3",rtcEyePositionLow:"vec3"},attributes:{aVertexPosition:"vec3",aRTCPositionHigh:{type:"vec3",divisor:1},aRTCPositionLow:{type:"vec3",divisor:1},aPickingColor:{type:"vec3",divisor:1},aScale:{type:"vec3",divisor:1},aTranslate:{type:"vec3",divisor:1},aLocalPosition:{type:"vec3",divisor:1},aDispose:{type:"float",divisor:1},qRot:{type:"vec4",divisor:1}},vertexShader:"precision highp float;vec3 qRotate(vec4 q,vec3 v){return v+2.0*cross(q.xyz,cross(q.xyz,v)+q.w*v);}attribute vec3 aVertexPosition;attribute vec3 aRTCPositionHigh;attribute vec3 aRTCPositionLow;attribute vec3 aPickingColor;attribute vec3 aScale;attribute vec3 aTranslate;attribute float aDispose;attribute vec4 qRot;attribute vec3 aLocalPosition;uniform vec3 rtcEyePositionHigh;uniform vec3 rtcEyePositionLow;uniform vec3 uScaleByDistance;uniform mat4 projectionMatrix;uniform mat4 viewMatrix;uniform vec3 pickingScale;varying vec3 vColor;void main(void){if(aDispose==0.0){return;}vColor=aPickingColor;mat4 viewMatrixRTE=viewMatrix;viewMatrixRTE[3]=vec4(0.0,0.0,0.0,1.0);vec3 highDiff=aRTCPositionHigh-rtcEyePositionHigh;vec3 lowDiff=aRTCPositionLow-rtcEyePositionLow;highDiff=highDiff*step(1.0,length(highDiff));vec4 positionInViewSpace=viewMatrixRTE*vec4(highDiff+lowDiff,1.0);float lookLength=length(positionInViewSpace.xyz);float scd=uScaleByDistance[2]*clamp(lookLength,uScaleByDistance[0],uScaleByDistance[1])/uScaleByDistance[0];vec3 vert=qRotate(qRot,scd*pickingScale*(aVertexPosition*aScale+aTranslate))+scd*aLocalPosition;gl_Position=projectionMatrix*viewMatrixRTE*vec4(highDiff+lowDiff+vert,1.0);}",fragmentShader:"precision highp float;varying vec3 vColor;void main(){gl_FragColor=vec4(vColor,1.0);}"})),this._renderer.handler.programs.geo_object_depth||this._renderer.handler.addProgram(new $("geo_object_depth",{uniforms:{viewMatrix:"mat4",projectionMatrix:"mat4",uScaleByDistance:"vec3",rtcEyePositionHigh:"vec3",rtcEyePositionLow:"vec3",frustumPickingColor:"float"},attributes:{aVertexPosition:"vec3",aRTCPositionHigh:{type:"vec3",divisor:1},aRTCPositionLow:{type:"vec3",divisor:1},aScale:{type:"vec3",divisor:1},aTranslate:{type:"vec3",divisor:1},aDispose:{type:"float",divisor:1},qRot:{type:"vec4",divisor:1},aLocalPosition:{type:"vec3",divisor:1}},vertexShader:`#version 300 es
precision highp float;vec3 qRotate(vec4 q,vec3 v){return v+2.0*cross(q.xyz,cross(q.xyz,v)+q.w*v);}in vec3 aVertexPosition;in vec3 aRTCPositionHigh;in vec3 aRTCPositionLow;in vec3 aScale;in vec3 aTranslate;in float aDispose;in vec4 qRot;in vec3 aLocalPosition;uniform vec3 rtcEyePositionHigh;uniform vec3 rtcEyePositionLow;uniform vec3 uScaleByDistance;uniform mat4 projectionMatrix;uniform mat4 viewMatrix;void main(void){if(aDispose==0.0){return;}mat4 viewMatrixRTE=viewMatrix;viewMatrixRTE[3]=vec4(0.0,0.0,0.0,1.0);vec3 highDiff=aRTCPositionHigh-rtcEyePositionHigh;vec3 lowDiff=aRTCPositionLow-rtcEyePositionLow;highDiff=highDiff*step(1.0,length(highDiff));vec4 positionInViewSpace=viewMatrixRTE*vec4(highDiff+lowDiff,1.0);float lookLength=length(positionInViewSpace.xyz);float scd=uScaleByDistance[2]*clamp(lookLength,uScaleByDistance[0],uScaleByDistance[1])/uScaleByDistance[0];vec3 vert=qRotate(qRot,scd*(aVertexPosition*aScale+aTranslate))+scd*aLocalPosition;gl_Position=projectionMatrix*viewMatrixRTE*vec4(highDiff+lowDiff+vert,1.0);}`,fragmentShader:`#version 300 es
precision highp float;uniform float frustumPickingColor;layout(location=0)out vec4 frustumColor;layout(location=1)out vec4 depthColor;void main(){frustumColor=vec4(frustumPickingColor,frustumPickingColor,frustumPickingColor,1.0);depthColor=vec4(gl_FragCoord.z,gl_FragCoord.z,gl_FragCoord.z,1.0);}`})))}setRenderNode(e){this._renderNode=e,this._renderer=e.renderer,this.initProgram();for(let t=0;t<this._instanceDataMapValues.length;t++)this._instanceDataMapValues[t].loadColorTexture(),this._instanceDataMapValues[t].loadNormalTexture(),this._instanceDataMapValues[t].loadMetallicRoughnessTexture();for(let t=0;t<this._geoObjects.length;t++)this._geoObjects[t].updateRotation();this.update()}setColorTextureTag(e,t){const s=this._instanceDataMap.get(t);s&&(typeof e=="string"&&(s._colorTextureSrc=e,s._colorTextureImage=null),e instanceof HTMLImageElement&&(s._colorTextureSrc=null,s._colorTextureImage=e),this._instanceDataMap.set(t,s),s.loadColorTexture())}setNormalTextureTag(e,t){const s=this._instanceDataMap.get(t);s&&(typeof e=="string"&&(s._normalTextureSrc=e,s._normalTextureImage=null),e instanceof HTMLImageElement&&(s._normalTextureSrc=null,s._normalTextureImage=e),this._instanceDataMap.set(t,s),s.loadNormalTexture())}setMetallicRoughnessTextureTag(e,t){const s=this._instanceDataMap.get(t);s&&(typeof e=="string"&&(s._metallicRoughnessTextureSrc=e,s._metallicRoughnessTextureImage=null),e instanceof HTMLImageElement&&(s._metallicRoughnessTextureSrc=null,s._metallicRoughnessTextureImage=e),this._instanceDataMap.set(t,s),s.loadMetallicRoughnessTexture())}setObjectSrc(e,t){const s=this._instanceDataMap.get(t);e&&s&&s._objectSrc!==e&&(s._objectSrc=e,W.loadObj(e).then(n=>{this._updateInstanceData(n[0],t)}))}_updateInstanceData(e,t){const s=this._instanceDataMap.get(t);s&&(e.vertices.length!==s._vertexArr.length&&(s._vertexArr=e.vertices,s._changedBuffers[Go]=!0),e.normals.length!==s._normalsArr.length&&(s._normalsArr=e.normals,s._changedBuffers[Yo]=!0),e.indices.length!==s._indicesArr.length&&(s._indicesArr=e.indices,s._changedBuffers[Wo]=!0),e.texCoords.length!==s._texCoordArr.length&&(s._texCoordArr=e.texCoords,s._changedBuffers[Qo]=!0),s._colorTextureSrc=e.colorTextureSrc,s._normalTextureSrc=e.normalTextureSrc,s._metallicRoughnessTexture=e.metallicRoughnessTextureSrc,s._colorTextureImage=e.colorTextureImage,s._normalTextureImage=e.normalTextureImage,s._metallicRoughnessTextureImage=e.metallicRoughnessTextureImage,s.loadColorTexture(),s.loadNormalTexture(),s.loadMetallicRoughnessTexture(),this._updateTag(s),this._instanceDataMapValues=Array.from(this._instanceDataMap.values()))}_addGeoObjectToArray(e){const t=e.tag;let s=this._instanceDataMap.get(t);s||(s=new il(this),this._instanceDataMap.set(t,s),this._instanceDataMapValues=Array.from(this._instanceDataMap.values()),s._vertexArr=e.vertices,s._normalsArr=e.normals,s._indicesArr=e.indices,s._texCoordArr=e.texCoords,s._colorTextureSrc=e.object3d.colorTextureSrc,s._normalTextureSrc=e.object3d.normalTextureSrc,s._metallicRoughnessTextureSrc=e.object3d.metallicRoughnessTextureSrc,s._colorTextureImage=e.object3d.colorTextureImage,s._normalTextureImage=e.object3d.normalTextureImage,s._metallicRoughnessTextureImage=e.object3d.metallicRoughnessTextureImage,s.setMaterialParams(e.object3d.ambient,e.object3d.diffuse,e.object3d.specular,e.object3d.shininess),s.loadColorTexture(),s.loadNormalTexture(),s.loadMetallicRoughnessTexture()),e._tagDataIndex=s.numInstances++,e._tagData=s,s.geoObjects.push(e);let n=3;s._visibleArr=xt(s._visibleArr,wt([],0,1,1,e.getVisibility()?1:0)),this.getRTCPosition(e.getPosition(),e._rtcPositionHigh,e._rtcPositionLow);let o,a=e._rtcPositionHigh.x,h=e._rtcPositionHigh.y,c=e._rtcPositionHigh.z;s._rtcPositionHighArr=xt(s._rtcPositionHighArr,wt([],0,n,n,a,h,c)),a=e._rtcPositionLow.x,h=e._rtcPositionLow.y,c=e._rtcPositionLow.z,s._rtcPositionLowArr=xt(s._rtcPositionLowArr,wt([],0,n,n,a,h,c)),a=e._entity._pickingColor.x/255,h=e._entity._pickingColor.y/255,c=e._entity._pickingColor.z/255,s._pickingColorArr=xt(s._pickingColorArr,wt([],0,n,n,a,h,c)),n=4,a=e._qRot.x,h=e._qRot.y,c=e._qRot.z,o=e._qRot.w,s._qRotArr=xt(s._qRotArr,wt([],0,n,n,a,h,c,o)),a=e._color.x,h=e._color.y,c=e._color.z,o=e._color.w,s._rgbaArr=xt(s._rgbaArr,wt([],0,n,n,a,h,c,o)),n=3;let d=e.getScale();a=d.x,h=d.y,c=d.z,s._sizeArr=xt(s._sizeArr,wt([],0,n,n,a,h,c));let u=e.getTranslate();a=u.x,h=u.y,c=u.z,s._translateArr=xt(s._translateArr,wt([],0,n,n,a,h,c));let _=e.getLocalPosition();a=_.x,h=_.y,c=_.z,s._localPositionArr=xt(s._localPositionArr,wt([],0,n,n,a,h,c))}_bindCommon(){let e=this._renderer,t=e.handler.programs.geo_object._program.uniforms,s=e.handler.gl,n=this._entityCollection;s.uniform3fv(t.uScaleByDistance,n.scaleByDistance),s.uniform1f(t.useLighting,n._useLighting),s.uniform3fv(t.eyePositionHigh,e.activeCamera.eyeHigh),s.uniform3fv(t.eyePositionLow,e.activeCamera.eyeLow),s.uniform3fv(t.rtcEyePositionHigh,this._rtcEyePositionHigh),s.uniform3fv(t.rtcEyePositionLow,this._rtcEyePositionLow),s.uniformMatrix4fv(t.projectionMatrix,!1,e.activeCamera.getProjectionMatrix()),s.uniformMatrix4fv(t.viewMatrix,!1,e.activeCamera.getViewMatrix()),s.uniform3fv(t.sunPosition,this._renderNode._lightPosition)}_displayOpaquePASS(){let e=this._renderer.handler.programs.geo_object,t=e._program;e.activate(),this._bindCommon();for(let s=0;s<this._instanceDataMapValues.length;s++)this._instanceDataMapValues[s].drawOpaque(t)}_displayTransparentPASS(){let e=this._renderer.handler.programs.geo_object,t=e._program;e.activate(),this._bindCommon();for(let s=0;s<this._instanceDataMapValues.length;s++)this._instanceDataMapValues[s].drawTransparent(t)}_depthPASS(){let e=this._renderer,t=e.handler.programs.geo_object_depth,s=t._program,n=s.uniforms,o=s.attributes,a=e.handler.gl,h=this._entityCollection,c=e.activeCamera;t.activate(),a.uniform3fv(n.uScaleByDistance,h.scaleByDistance),a.uniform3fv(n.rtcEyePositionHigh,this._rtcEyePositionHigh),a.uniform3fv(n.rtcEyePositionLow,this._rtcEyePositionLow),a.uniformMatrix4fv(n.projectionMatrix,!1,e.activeCamera.getProjectionMatrix()),a.uniformMatrix4fv(n.viewMatrix,!1,e.activeCamera.getViewMatrix()),a.uniform1f(n.frustumPickingColor,c.frustumColorIndex);for(let d=0;d<this._instanceDataMapValues.length;d++){let u=this._instanceDataMapValues[d];a.bindBuffer(a.ARRAY_BUFFER,u._qRotBuffer),a.vertexAttribPointer(o.qRot,u._qRotBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,u._sizeBuffer),a.vertexAttribPointer(o.aScale,u._sizeBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,u._translateBuffer),a.vertexAttribPointer(o.aTranslate,u._translateBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,u._localPositionBuffer),a.vertexAttribPointer(o.aLocalPosition,u._localPositionBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,u._rtcPositionHighBuffer),a.vertexAttribPointer(o.aRTCPositionHigh,u._rtcPositionHighBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,u._rtcPositionLowBuffer),a.vertexAttribPointer(o.aRTCPositionLow,u._rtcPositionLowBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,u._visibleBuffer),a.vertexAttribPointer(o.aDispose,u._visibleBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,u._vertexBuffer),a.vertexAttribPointer(o.aVertexPosition,u._vertexBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,u._indicesBuffer),s.drawElementsInstanced(a.TRIANGLES,u._indicesBuffer.numItems,a.UNSIGNED_INT,0,u.numInstances)}}drawDepth(){this._geoObjects.length&&this._depthPASS()}drawPicking(){this._geoObjects.length&&this.pickingEnabled&&this._pickingPASS()}_pickingPASS(){let e=this._renderer,t=e.handler.programs.geo_object_picking,s=t._program,n=s.uniforms,o=s.attributes,a=e.handler.gl,h=this._entityCollection;t.activate(),a.uniform3fv(n.uScaleByDistance,h.scaleByDistance),a.uniform3fv(n.pickingScale,h.pickingScale),a.uniform3fv(n.rtcEyePositionHigh,this._rtcEyePositionHigh),a.uniform3fv(n.rtcEyePositionLow,this._rtcEyePositionLow),a.uniformMatrix4fv(n.projectionMatrix,!1,e.activeCamera.getProjectionMatrix()),a.uniformMatrix4fv(n.viewMatrix,!1,e.activeCamera.getViewMatrix());for(let c=0;c<this._instanceDataMapValues.length;c++){let d=this._instanceDataMapValues[c];a.bindBuffer(a.ARRAY_BUFFER,d._qRotBuffer),a.vertexAttribPointer(o.qRot,d._qRotBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,d._sizeBuffer),a.vertexAttribPointer(o.aScale,d._sizeBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,d._translateBuffer),a.vertexAttribPointer(o.aTranslate,d._translateBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,d._localPositionBuffer),a.vertexAttribPointer(o.aLocalPosition,d._localPositionBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,d._pickingColorBuffer),a.vertexAttribPointer(o.aPickingColor,d._pickingColorBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,d._rtcPositionHighBuffer),a.vertexAttribPointer(o.aRTCPositionHigh,d._rtcPositionHighBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,d._rtcPositionLowBuffer),a.vertexAttribPointer(o.aRTCPositionLow,d._rtcPositionLowBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,d._visibleBuffer),a.vertexAttribPointer(o.aDispose,d._visibleBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,d._vertexBuffer),a.vertexAttribPointer(o.aVertexPosition,d._vertexBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,d._indicesBuffer),s.drawElementsInstanced(a.TRIANGLES,d._indicesBuffer.numItems,a.UNSIGNED_INT,0,d.numInstances)}}setQRotArr(e,t,s){wt(e._qRotArr,t,4,4,s.x,s.y,s.z,s.w),e._changedBuffers[$o]=!0,this._updateTag(e)}setVisibility(e,t,s){wt(e._visibleArr,t,1,1,s?1:0),e._changedBuffers[Ko]=!0,this._updateTag(e)}setRTCPositionArr(e,t,s,n){wt(e._rtcPositionHighArr,t,3,3,s.x,s.y,s.z),wt(e._rtcPositionLowArr,t,3,3,n.x,n.y,n.z),e._changedBuffers[jo]=!0,this._updateTag(e)}setRgbaArr(e,t,s){wt(e._rgbaArr,t,4,4,s.x,s.y,s.z,s.w),e._changedBuffers[qo]=!0,this._updateTag(e)}setPickingColorArr(e,t,s){wt(e._pickingColorArr,t,3,3,s.x/255,s.y/255,s.z/255),e._changedBuffers[Zo]=!0,this._updateTag(e)}setScaleArr(e,t,s){wt(e._sizeArr,t,3,3,s.x,s.y,s.z),e._changedBuffers[Xo]=!0,this._updateTag(e)}setTranslateArr(e,t,s){wt(e._translateArr,t,3,3,s.x,s.y,s.z),e._changedBuffers[Jo]=!0,this._updateTag(e)}setLocalPositionArr(e,t,s){wt(e._localPositionArr,t,3,3,s.x,s.y,s.z),e._changedBuffers[ta]=!0,this._updateTag(e)}_updateTag(e){e.isFree&&(e.isFree=!1,this._dataTagUpdateQueue.push(e))}update(){for(let e=0,t=this._dataTagUpdateQueue.length;e<t;e++)this._dataTagUpdateQueue[e].update();this._dataTagUpdateQueue=[]}_removeAll(){let e=this._geoObjects.length;for(;e--;){const t=this._geoObjects[e];t._tagDataIndex=-1,t._tagData=null,t._handlerIndex=-1,t._handler=null}this._geoObjects.length=0,this._geoObjects=[];for(let t=0;t<this._instanceDataMapValues.length;t++)this._instanceDataMapValues[t].clear();this._instanceDataMap.clear(),this._instanceDataMapValues=[]}clear(){this._removeAll()}getRTCPosition(e,t,s){let n=e.sub(this._relativeCenter);m.doubleToTwoFloats(n,t,s)}setRelativeCenter(e){this._relativeCenter.copy(e);for(let t=0;t<this._instanceDataMapValues.length;t++){let s=this._instanceDataMapValues[t].geoObjects;for(let n=0;n<s.length;n++)s[n].updateRTCPosition()}}_updateRTCEyePosition(){let e=this._renderer;if(e.activeCamera.isFirstPass){let t=e.activeCamera.eye.sub(this._relativeCenter);m.doubleToTwoFloat32Array(t,this._rtcEyePositionHigh,this._rtcEyePositionLow)}}draw(){this._geoObjects.length&&(this._updateRTCEyePosition(),this.update(),this._displayOpaquePASS())}drawTransparent(){this._geoObjects.length&&this._displayTransparentPASS()}add(e){e._handlerIndex===-1&&(e._handler=this,e._handlerIndex=this._geoObjects.length,this._geoObjects.push(e),this._addGeoObjectToArray(e),e.updateRotation(),e._tagData.refresh(),this._updateTag(e._tagData),e.setObjectSrc(e._objectSrc))}remove(e){e._handler&&this.__id==e._handler.__id&&this._removeGeoObject(e)}_clearDataTagQueue(){this._dataTagUpdateQueue=[]}_removeGeoObject(e){let t=e._tagData,s=e.tag;t.numInstances--;let n=!1;if(t.numInstances===0){t.clear(),this._instanceDataMap.delete(s);for(let a=0;this._instanceDataMapValues.length;a++)if(this._instanceDataMapValues[a].numInstances===0){this._instanceDataMapValues.splice(a,1);break}this._clearDataTagQueue(),n=!0}this._geoObjects.splice(e._handlerIndex,1);for(let a=e._handlerIndex,h=this._geoObjects.length;a<h;a++){let c=this._geoObjects[a];c._handlerIndex=c._handlerIndex-1}let o=e._tagDataIndex;t.geoObjects.splice(o,1);for(let a=e._tagDataIndex,h=t.geoObjects.length;a<h;a++){let c=t.geoObjects[a];c._tagDataIndex=c._tagDataIndex-1}t._rgbaArr=Ct(t._rgbaArr,4*o,4),t._rtcPositionHighArr=Ct(t._rtcPositionHighArr,3*o,3),t._rtcPositionLowArr=Ct(t._rtcPositionLowArr,3*o,3),t._qRotArr=Ct(t._qRotArr,4*o,4),t._pickingColorArr=Ct(t._pickingColorArr,3*o,3),t._sizeArr=Ct(t._sizeArr,3*o,3),t._translateArr=Ct(t._translateArr,3*o,3),t._localPositionArr=Ct(t._localPositionArr,3*o,3),t._visibleArr=Ct(t._visibleArr,o,1),e._handlerIndex=-1,e._handler=null,e._tagDataIndex=-1,e._tagData=null,n||(t.refresh(),this._updateTag(t))}};xs.__counter__=0;let Tr=xs;class sl extends ss{constructor(e,t=21){super(e),this._billboards=[],this._gliphParamBuffer=null,this._fontIndexBuffer=null,this._outlineBuffer=null,this._outlineColorBuffer=null,this._gliphParamArr=new Float32Array([]),this._fontIndexArr=new Float32Array([]),this._outlineArr=new Float32Array([]),this._outlineColorArr=new Float32Array([]),this._buffersUpdateCallbacks[8]=this.createFontIndexBuffer,this._buffersUpdateCallbacks[9]=this.createOutlineBuffer,this._buffersUpdateCallbacks[10]=this.createOutlineColorBuffer,this._changedBuffers=new Array(this._buffersUpdateCallbacks.length),this._maxLetters=t}initProgram(){this._renderer&&this._renderer.handler&&this._renderer.handler.gl&&(this._renderer.handler.programs.label||(this._renderer.handler.gl.type==="webgl2"?this._renderer.handler.addProgram(new $("label",{uniforms:{viewport:"vec2",fontTextureArr:"sampler2darray",sdfParamsArr:"vec4",projectionMatrix:"mat4",viewMatrix:"mat4",eyePositionHigh:"vec3",eyePositionLow:"vec3",planetRadius:"float",scaleByDistance:"vec3",opacity:"float",isOutlinePass:"int",depthOffset:"float"},attributes:{a_outline:"float",a_gliphParam:"vec4",a_vertices:"vec2",a_texCoord:"vec4",a_positionsHigh:"vec3",a_positionsLow:"vec3",a_size:"float",a_rotation:"float",a_rgba:"vec4",a_offset:"vec3",a_fontIndex:"float"},vertexShader:`#version 300 es
#define EMPTY - 1.0
#define RTL 1.0
vec2 project(vec4 p,vec2 viewport){return(0.5*p.xyz/p.w+0.5).xy*viewport;}mat2 rotate2d(float angle){return mat2(cos(angle),-sin(angle),sin(angle),cos(angle));}in float a_outline;in vec4 a_gliphParam;in vec2 a_vertices;in vec4 a_texCoord;in vec3 a_positionsHigh;in vec3 a_positionsLow;in vec3 a_offset;in float a_size;in float a_rotation;in vec4 a_rgba;in float a_fontIndex;out vec2 v_uv;out vec4 v_rgba;flat out int v_fontIndex;out vec4 v_outlineColor;flat out float v_outline;uniform vec2 viewport;uniform mat4 viewMatrix;uniform mat4 projectionMatrix;uniform vec3 eyePositionHigh;uniform vec3 eyePositionLow;uniform float planetRadius;uniform vec3 scaleByDistance;uniform float opacity;uniform float depthOffset;const vec3 ZERO3=vec3(0.0);void main(){if(a_texCoord.w==EMPTY){gl_Position=vec4(0.0);v_fontIndex=-1;return;}vec3 a_positions=a_positionsHigh+a_positionsLow;vec3 cameraPos=eyePositionHigh+eyePositionLow;v_outline=a_outline;v_fontIndex=int(a_fontIndex);v_uv=a_texCoord.xy;vec3 look=a_positions-cameraPos;float lookDist=length(look);v_rgba=a_rgba;if(opacity*step(lookDist,sqrt(dot(cameraPos,cameraPos)-planetRadius)+sqrt(dot(a_positions,a_positions)-planetRadius))==0.0){return;}float scd=(1.0-smoothstep(scaleByDistance[0],scaleByDistance[1],lookDist))*(1.0-step(scaleByDistance[2],lookDist));v_rgba.a*=opacity;mat4 viewMatrixRTE=viewMatrix;viewMatrixRTE[3]=vec4(0.0,0.0,0.0,1.0);vec3 highDiff=a_positionsHigh-eyePositionHigh;vec3 lowDiff=a_positionsLow-eyePositionLow;vec4 posRTE=viewMatrixRTE*vec4(highDiff+lowDiff,1.0);vec4 projPos=projectionMatrix*posRTE;float camSlope=dot(vec3(viewMatrix[0][2],viewMatrix[1][2],viewMatrix[2][2]),normalize(cameraPos));if(camSlope>0.5){float dist=dot(look,normalize(cameraPos));projPos.z+=dist*0.02;}else{projPos.z+=-(abs(projPos.z))*0.002;}projPos.z+=depthOffset+a_offset.z;vec2 screenPos=project(projPos,viewport);vec2 vert=a_vertices;vec4 gp=a_gliphParam;if(a_texCoord.w==RTL){vert.x=step(vert.x*0.5+1.0,1.0);gp.x=-a_gliphParam.x;gp.z=-(a_gliphParam.z+a_texCoord.z);}else{gp.z=a_gliphParam.z+a_texCoord.z;}vec2 v=screenPos+rotate2d(a_rotation)*((vert*gp.xy+gp.zw)*a_size*scd+a_offset.xy);gl_Position=vec4((2.0*v/viewport-1.0)*projPos.w,projPos.z,projPos.w);}`,fragmentShader:`#version 300 es
uniform int isOutlinePass;precision highp float;const int MAX_SIZE=11;uniform sampler2D fontTextureArr[MAX_SIZE];uniform vec4 sdfParamsArr[MAX_SIZE];flat in int v_fontIndex;in vec2 v_uv;in vec4 v_rgba;flat in float v_outline;in vec3 v_pickingColor;layout(location=0)out vec4 outScreen;float median(float r,float g,float b){return max(min(r,g),min(max(r,g),b));}float getDistance(){vec3 msdf;if(v_fontIndex==0){msdf=texture(fontTextureArr[0],v_uv).rgb;}else if(v_fontIndex==1){msdf=texture(fontTextureArr[1],v_uv).rgb;}else if(v_fontIndex==2){msdf=texture(fontTextureArr[2],v_uv).rgb;}else if(v_fontIndex==3){msdf=texture(fontTextureArr[3],v_uv).rgb;}else if(v_fontIndex==4){msdf=texture(fontTextureArr[4],v_uv).rgb;}else if(v_fontIndex==5){msdf=texture(fontTextureArr[5],v_uv).rgb;}else if(v_fontIndex==6){msdf=texture(fontTextureArr[6],v_uv).rgb;}else if(v_fontIndex==7){msdf=texture(fontTextureArr[7],v_uv).rgb;}else if(v_fontIndex==8){msdf=texture(fontTextureArr[8],v_uv).rgb;}else if(v_fontIndex==9){msdf=texture(fontTextureArr[9],v_uv).rgb;}else if(v_fontIndex==10){msdf=texture(fontTextureArr[10],v_uv).rgb;}return median(msdf.r,msdf.g,msdf.b);}void main(){if(v_fontIndex==-1){return;}vec4 sdfParams=sdfParamsArr[v_fontIndex];float sd=getDistance();vec2 dxdy=fwidth(v_uv)*sdfParams.xy;if(isOutlinePass==0){float dist=sd+min(0.001,0.5-1.0/sdfParams.w)-0.5;float opacity=clamp(dist*sdfParams.w/length(dxdy)+0.5,0.0,1.0);if(opacity<=0.1){discard;}outScreen=vec4(v_rgba.rgb,opacity*v_rgba.a);}else{float dist=sd+min(v_outline,0.5-1.0/sdfParams.w)-0.5;float opacity=clamp(dist*sdfParams.w/length(dxdy)+0.5,0.0,1.0);if(opacity<=0.1){discard;}outScreen=vec4(v_rgba.rgb,opacity*v_rgba.a);}}`})):this._renderer.handler.addProgram(new $("label",{uniforms:{viewport:"vec2",fontTextureArr:"sampler2darray",sdfParamsArr:"vec4",projectionMatrix:"mat4",viewMatrix:"mat4",eyePositionHigh:"vec3",eyePositionLow:"vec3",planetRadius:"float",scaleByDistance:"vec3",opacity:"float",isOutlinePass:"int",depthOffset:"float"},attributes:{a_outline:"float",a_gliphParam:"vec4",a_vertices:"vec2",a_texCoord:"vec4",a_positionsHigh:"vec3",a_positionsLow:"vec3",a_size:"float",a_rotation:"float",a_rgba:"vec4",a_offset:"vec3",a_fontIndex:"float"},vertexShader:`#define EMPTY - 1.0
#define RTL 1.0
vec2 project(vec4 p,vec2 viewport){return(0.5*p.xyz/p.w+0.5).xy*viewport;}mat2 rotate2d(float angle){return mat2(cos(angle),-sin(angle),sin(angle),cos(angle));}attribute float a_outline;attribute vec4 a_gliphParam;attribute vec2 a_vertices;attribute vec4 a_texCoord;attribute vec3 a_positionsHigh;attribute vec3 a_positionsLow;attribute vec3 a_offset;attribute float a_size;attribute float a_rotation;attribute vec4 a_rgba;attribute float a_fontIndex;varying float v_outline;varying vec2 v_uv;varying vec4 v_rgba;varying float v_fontIndex;uniform vec2 viewport;uniform mat4 viewMatrix;uniform mat4 projectionMatrix;uniform vec3 eyePositionHigh;uniform vec3 eyePositionLow;uniform float planetRadius;uniform vec3 scaleByDistance;uniform float opacity;uniform float depthOffset;const vec3 ZERO3=vec3(0.0);void main(){if(a_texCoord.w==EMPTY){gl_Position=vec4(0.0);v_fontIndex=-1.0;return;}vec3 a_positions=a_positionsHigh+a_positionsLow;vec3 cameraPos=eyePositionHigh+eyePositionLow;v_outline=a_outline;v_uv=vec2(a_texCoord.xy);v_rgba=a_rgba;v_fontIndex=a_fontIndex;vec3 look=a_positions-cameraPos;float lookDist=length(look);if(opacity*step(lookDist,sqrt(dot(cameraPos,cameraPos)-planetRadius)+sqrt(dot(a_positions,a_positions)-planetRadius))==0.0){return;}float scd=(1.0-smoothstep(scaleByDistance[0],scaleByDistance[1],lookDist))*(1.0-step(scaleByDistance[2],lookDist));v_rgba.a*=opacity;mat4 viewMatrixRTE=viewMatrix;viewMatrixRTE[3]=vec4(0.0,0.0,0.0,1.0);vec3 highDiff=a_positionsHigh-eyePositionHigh;vec3 lowDiff=a_positionsLow-eyePositionLow;vec4 posRTE=viewMatrixRTE*vec4(highDiff+lowDiff,1.0);vec4 projPos=projectionMatrix*posRTE;float camSlope=dot(vec3(viewMatrix[0][2],viewMatrix[1][2],viewMatrix[2][2]),normalize(cameraPos));if(camSlope>0.5){float dist=dot(look,normalize(cameraPos));projPos.z+=dist*0.02;}else{projPos.z+=-(abs(projPos.z))*0.002;}projPos.z+=depthOffset+a_offset.z;vec2 screenPos=project(projPos,viewport);vec2 vert=a_vertices;vec4 gp=a_gliphParam;if(a_texCoord.w==RTL){vert.x=step(vert.x*0.5+1.0,1.0);gp.x=-a_gliphParam.x;gp.z=-(a_gliphParam.z+a_texCoord.z);}else{gp.z=a_gliphParam.z+a_texCoord.z;}vec2 v=screenPos+rotate2d(a_rotation)*((vert*gp.xy+gp.zw)*a_size*scd+a_offset.xy);gl_Position=vec4((2.0*v/viewport-1.0)*projPos.w,projPos.z,projPos.w);}`,fragmentShader:`#extension GL_OES_standard_derivatives: enable
precision highp float;precision highp int;const int MAX_SIZE=11;uniform sampler2D fontTextureArr[MAX_SIZE];uniform vec4 sdfParamsArr[MAX_SIZE];uniform int isOutlinePass;varying float v_outline;varying vec2 v_uv;varying vec4 v_rgba;varying float v_fontIndex;float fontIndex;float median(float r,float g,float b){return max(min(r,g),min(max(r,g),b));}float getDistance(){vec3 msdf;if(fontIndex>=0.0&&fontIndex<1.0){msdf=texture2D(fontTextureArr[0],v_uv).rgb;}else if(fontIndex>=1.0&&fontIndex<2.0){msdf=texture2D(fontTextureArr[1],v_uv).rgb;}else if(fontIndex>=2.0&&fontIndex<3.0){msdf=texture2D(fontTextureArr[2],v_uv).rgb;}else if(fontIndex>=3.0&&fontIndex<4.0){msdf=texture2D(fontTextureArr[3],v_uv).rgb;}else if(fontIndex>=4.0&&fontIndex<5.0){msdf=texture2D(fontTextureArr[4],v_uv).rgb;}else if(fontIndex>=5.0&&fontIndex<6.0){msdf=texture2D(fontTextureArr[5],v_uv).rgb;}else if(fontIndex>=6.0&&fontIndex<7.0){msdf=texture2D(fontTextureArr[6],v_uv).rgb;}else if(fontIndex>=7.0&&fontIndex<8.0){msdf=texture2D(fontTextureArr[7],v_uv).rgb;}else if(fontIndex>=8.0&&fontIndex<9.0){msdf=texture2D(fontTextureArr[8],v_uv).rgb;}else if(fontIndex>=9.0&&fontIndex<10.0){msdf=texture2D(fontTextureArr[9],v_uv).rgb;}else if(fontIndex>=10.0&&fontIndex<11.0){msdf=texture2D(fontTextureArr[10],v_uv).rgb;}return median(msdf.r,msdf.g,msdf.b);}vec4 getSDFParams(){if(fontIndex>=0.0&&fontIndex<1.0){return sdfParamsArr[0];}else if(fontIndex>=1.0&&fontIndex<2.0){return sdfParamsArr[1];}else if(fontIndex>=2.0&&fontIndex<3.0){return sdfParamsArr[2];}else if(fontIndex>=3.0&&fontIndex<4.0){return sdfParamsArr[3];}else if(fontIndex>=4.0&&fontIndex<5.0){return sdfParamsArr[4];}else if(fontIndex>=5.0&&fontIndex<6.0){return sdfParamsArr[5];}else if(fontIndex>=6.0&&fontIndex<7.0){return sdfParamsArr[6];}else if(fontIndex>=7.0&&fontIndex<8.0){return sdfParamsArr[7];}else if(fontIndex>=8.0&&fontIndex<9.0){return sdfParamsArr[8];}else if(fontIndex>=9.0&&fontIndex<10.0){return sdfParamsArr[9];}else if(fontIndex>=10.0&&fontIndex<11.0){return sdfParamsArr[10];}}void main(){fontIndex=v_fontIndex+0.1;if(v_fontIndex<0.0){return;}vec4 sdfParams=getSDFParams();float sd=getDistance();vec2 dxdy=fwidth(v_uv)*sdfParams.xy;float dist=sd+min(0.001,0.5-1.0/sdfParams.w)-0.5;float opacity=clamp(dist*sdfParams.w/length(dxdy)+0.5,0.0,1.0);if(isOutlinePass==0){}else{float strokeDist=sd+min(v_outline,0.5-1.0/sdfParams.w)-0.5;float strokeAlpha=v_rgba.a*clamp(strokeDist*sdfParams.w/length(dxdy)+0.5,0.0,1.0);if(strokeAlpha<0.1){discard;}}}`}))),this._renderer.handler.programs.labelPicking||this._renderer.handler.addProgram(new $("labelPicking",{uniforms:{viewport:"vec2",projectionMatrix:"mat4",viewMatrix:"mat4",eyePositionHigh:"vec3",eyePositionLow:"vec3",planetRadius:"float",scaleByDistance:"vec3",opacity:"float",depthOffset:"float"},attributes:{a_gliphParam:"vec4",a_vertices:"vec2",a_texCoord:"vec4",a_positionsHigh:"vec3",a_positionsLow:"vec3",a_offset:"vec3",a_size:"float",a_rotation:"float",a_rgba:"vec4"},vertexShader:`#define EMPTY - 1.0
#define RTL 1.0
vec2 project(vec4 p,vec2 viewport){return(0.5*p.xyz/p.w+0.5).xy*viewport;}mat2 rotate2d(float angle){return mat2(cos(angle),-sin(angle),sin(angle),cos(angle));}attribute vec4 a_gliphParam;attribute vec2 a_vertices;attribute vec4 a_texCoord;attribute vec3 a_positionsHigh;attribute vec3 a_positionsLow;attribute vec3 a_offset;attribute float a_size;attribute float a_rotation;attribute vec4 a_rgba;varying vec4 v_rgba;uniform vec2 viewport;uniform mat4 viewMatrix;uniform mat4 projectionMatrix;uniform vec3 eyePositionHigh;uniform vec3 eyePositionLow;uniform float planetRadius;uniform vec3 scaleByDistance;uniform float opacity;uniform float depthOffset;const vec3 ZERO3=vec3(0.0);void main(){vec3 a_positions=a_positionsHigh+a_positionsLow;vec3 cameraPos=eyePositionHigh+eyePositionLow;v_rgba=a_rgba;if(a_texCoord.w==EMPTY){v_rgba.a=0.0;gl_Position=vec4(0.0);return;}vec3 look=a_positions-cameraPos;float lookDist=length(look);if(opacity*step(lookDist,sqrt(dot(cameraPos,cameraPos)-planetRadius)+sqrt(dot(a_positions,a_positions)-planetRadius))==0.0){return;}float scd=(1.0-smoothstep(scaleByDistance[0],scaleByDistance[1],lookDist))*(1.0-step(scaleByDistance[2],lookDist));v_rgba.a*=opacity;mat4 viewMatrixRTE=viewMatrix;viewMatrixRTE[3]=vec4(0.0,0.0,0.0,1.0);vec3 highDiff=a_positionsHigh-eyePositionHigh;vec3 lowDiff=a_positionsLow-eyePositionLow;vec4 posRTE=viewMatrixRTE*vec4(highDiff+lowDiff,1.0);vec4 projPos=projectionMatrix*posRTE;float camSlope=dot(vec3(viewMatrix[0][2],viewMatrix[1][2],viewMatrix[2][2]),normalize(cameraPos));if(camSlope>0.5){float dist=dot(look,normalize(cameraPos));projPos.z+=dist*0.02;}else{projPos.z+=-(abs(projPos.z))*0.002;}projPos.z+=depthOffset+a_offset.z;vec2 screenPos=project(projPos,viewport);vec2 vert=a_vertices;vec4 gp=a_gliphParam;if(a_texCoord.w==RTL){vert.x=step(vert.x*0.5+1.0,1.0);gp.x=-a_gliphParam.x;gp.z=-(a_gliphParam.z+a_texCoord.z);}else{gp.z=a_gliphParam.z+a_texCoord.z;}vec2 v=screenPos+rotate2d(a_rotation)*((vert*gp.xy+gp.zw)*a_size*scd+a_offset.xy);gl_Position=vec4((2.0*v/viewport-1.0)*projPos.w,projPos.z,projPos.w);}`,fragmentShader:"precision highp float;varying vec4 v_rgba;varying vec3 v_pickingColor;void main(){vec4 color=v_rgba;if(color.a<0.05){return;}gl_FragColor=vec4(v_rgba.rgb,v_rgba.a);}"})))}get labels(){return this._billboards}add(e){e._handler||(e._handler=this,this.assignFontAtlas(e),this.refresh())}updateFonts(){let e=[...this._billboards];this._billboards=[];for(let t=0;t<e.length;t++)this.assignFontAtlas(e[t])}_addLabelToArrays(e){this._renderer&&this._renderer.labelWorker.make({handler:this,label:e})}assignFontAtlas(e){this._entityCollection&&this._renderer?(e.assignFontAtlas(this._renderer.fontAtlas),this._addLabelToArrays(e)):this._billboards.push(e)}workerCallback(e,t){t._lockId!==-1&&t._handler&&this.isEqual(t._handler)&&(t._isReady=!0,t._lockId=-1,t._handlerIndex=this._billboards.length,this._billboards.push(t),this._vertexArr=nt(this._vertexArr,e.vertexArr),this._texCoordArr=nt(this._texCoordArr,e.texCoordArr),this._gliphParamArr=nt(this._gliphParamArr,e.gliphParamArr),this._positionHighArr=nt(this._positionHighArr,e.positionHighArr),this._positionLowArr=nt(this._positionLowArr,e.positionLowArr),this._sizeArr=nt(this._sizeArr,e.sizeArr),this._offsetArr=nt(this._offsetArr,e.offsetArr),this._rgbaArr=nt(this._rgbaArr,e.rgbaArr),this._rotationArr=nt(this._rotationArr,e.rotationArr),this._fontIndexArr=nt(this._fontIndexArr,e.fontIndexArr),this._outlineArr=nt(this._outlineArr,e.outlineArr),this._outlineColorArr=nt(this._outlineColorArr,e.outlineColorArr),this._pickingColorArr=nt(this._pickingColorArr,e.pickingColorArr),t.update(),this.refresh())}clear(){this._texCoordArr=null,this._gliphParamArr=null,this._vertexArr=null,this._positionHighArr=null,this._positionLowArr=null,this._sizeArr=null,this._offsetArr=null,this._rgbaArr=null,this._rotationArr=null,this._fontIndexArr=null,this._outlineArr=null,this._outlineColorArr=null,this._texCoordArr=new Float32Array([]),this._gliphParamArr=new Float32Array([]),this._vertexArr=new Float32Array([]),this._positionHighArr=new Float32Array([]),this._positionLowArr=new Float32Array([]),this._sizeArr=new Float32Array([]),this._offsetArr=new Float32Array([]),this._rgbaArr=new Float32Array([]),this._rotationArr=new Float32Array([]),this._fontIndexArr=new Float32Array([]),this._outlineArr=new Float32Array([]),this._outlineColorArr=new Float32Array([]),this._removeBillboards(),this._deleteBuffers(),this.refresh()}_deleteBuffers(){if(this._renderer){let e=this._renderer.handler.gl;e.deleteBuffer(this._gliphParamBuffer),e.deleteBuffer(this._sizeBuffer),e.deleteBuffer(this._fontIndexBuffer),e.deleteBuffer(this._texCoordBuffer),e.deleteBuffer(this._outlineBuffer),e.deleteBuffer(this._outlineColorBuffer),e.deleteBuffer(this._positionHighBuffer),e.deleteBuffer(this._positionLowBuffer),e.deleteBuffer(this._sizeBuffer),e.deleteBuffer(this._offsetBuffer),e.deleteBuffer(this._rgbaBuffer),e.deleteBuffer(this._rotationBuffer),e.deleteBuffer(this._vertexBuffer),e.deleteBuffer(this._texCoordBuffer),e.deleteBuffer(this._pickingColorBuffer),this._gliphParamBuffer=null,this._sizeBuffer=null,this._fontIndexBuffer=null,this._texCoordBuffer=null,this._outlineBuffer=null,this._outlineColorBuffer=null,this._positionHighBuffer=null,this._positionLowBuffer=null,this._sizeBuffer=null,this._offsetBuffer=null,this._rgbaBuffer=null,this._rotationBuffer=null,this._vertexBuffer=null,this._texCoordBuffer=null,this._pickingColorBuffer=null}}_displayPASS(){let e=this._renderer,t=e.handler;t.programs.label.activate();let s=t.programs.label._program,n=s.attributes,o=s.uniforms,a=t.gl,h=this._entityCollection;a.disable(a.CULL_FACE),a.uniform1iv(o.fontTextureArr,e.fontAtlas.samplerArr),a.uniform4fv(o.sdfParamsArr,e.fontAtlas.sdfParamsArr),a.uniformMatrix4fv(o.viewMatrix,!1,e.activeCamera.getViewMatrix()),a.uniformMatrix4fv(o.projectionMatrix,!1,e.activeCamera.getProjectionMatrix()),a.uniform3fv(o.eyePositionHigh,e.activeCamera.eyeHigh),a.uniform3fv(o.eyePositionLow,e.activeCamera.eyeLow),a.uniform3fv(o.scaleByDistance,h.scaleByDistance),a.uniform1f(o.opacity,h._fadingOpacity),a.uniform1f(o.planetRadius,h.renderNode._planetRadius2||0),a.uniform2fv(o.viewport,[t.canvas.clientWidth,t.canvas.clientHeight]),a.bindBuffer(a.ARRAY_BUFFER,this._texCoordBuffer),a.vertexAttribPointer(n.a_texCoord,this._texCoordBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this._gliphParamBuffer),a.vertexAttribPointer(n.a_gliphParam,this._gliphParamBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this._vertexBuffer),a.vertexAttribPointer(n.a_vertices,this._vertexBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this._positionHighBuffer),a.vertexAttribPointer(n.a_positionsHigh,this._positionHighBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this._positionLowBuffer),a.vertexAttribPointer(n.a_positionsLow,this._positionLowBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this._sizeBuffer),a.vertexAttribPointer(n.a_size,this._sizeBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this._rotationBuffer),a.vertexAttribPointer(n.a_rotation,this._rotationBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this._offsetBuffer),a.vertexAttribPointer(n.a_offset,this._offsetBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this._fontIndexBuffer),a.vertexAttribPointer(n.a_fontIndex,this._fontIndexBuffer.itemSize,a.FLOAT,!1,0,0),a.uniform1i(o.isOutlinePass,1),a.uniform1f(o.depthOffset,h.polygonOffsetUnits),a.bindBuffer(a.ARRAY_BUFFER,this._outlineColorBuffer),a.vertexAttribPointer(n.a_rgba,this._outlineColorBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this._outlineBuffer),a.vertexAttribPointer(n.a_outline,this._outlineBuffer.itemSize,a.FLOAT,!1,0,0),a.drawArrays(a.TRIANGLES,0,this._vertexBuffer.numItems),a.depthFunc(a.EQUAL),a.uniform1i(o.isOutlinePass,0),a.uniform1f(o.depthOffset,h.polygonOffsetUnits),a.bindBuffer(a.ARRAY_BUFFER,this._rgbaBuffer),a.vertexAttribPointer(n.a_rgba,this._rgbaBuffer.itemSize,a.FLOAT,!1,0,0),a.drawArrays(a.TRIANGLES,0,this._vertexBuffer.numItems),a.depthFunc(a.LESS),a.enable(a.CULL_FACE)}_pickingPASS(){let e=this._renderer,t=e.handler;t.programs.labelPicking.activate();let s=t.programs.labelPicking._program,n=s.attributes,o=s.uniforms,a=t.gl,h=this._entityCollection,c=h.renderNode;a.disable(a.CULL_FACE),a.uniformMatrix4fv(o.viewMatrix,!1,e.activeCamera.getViewMatrix()),a.uniformMatrix4fv(o.projectionMatrix,!1,e.activeCamera.getProjectionMatrix()),a.uniform3fv(o.eyePositionHigh,e.activeCamera.eyeHigh),a.uniform3fv(o.eyePositionLow,e.activeCamera.eyeLow),a.uniform3fv(o.scaleByDistance,h.scaleByDistance),a.uniform1f(o.opacity,h._fadingOpacity),a.uniform1f(o.planetRadius,c._planetRadius2||0),a.uniform2fv(o.viewport,[t.canvas.clientWidth,t.canvas.clientHeight]),a.bindBuffer(a.ARRAY_BUFFER,this._texCoordBuffer),a.vertexAttribPointer(n.a_texCoord,this._texCoordBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this._gliphParamBuffer),a.vertexAttribPointer(n.a_gliphParam,this._gliphParamBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this._vertexBuffer),a.vertexAttribPointer(n.a_vertices,this._vertexBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this._positionHighBuffer),a.vertexAttribPointer(n.a_positionsHigh,this._positionHighBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this._positionLowBuffer),a.vertexAttribPointer(n.a_positionsLow,this._positionLowBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this._sizeBuffer),a.vertexAttribPointer(n.a_size,this._sizeBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this._rotationBuffer),a.vertexAttribPointer(n.a_rotation,this._rotationBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this._offsetBuffer),a.vertexAttribPointer(n.a_offset,this._offsetBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this._pickingColorBuffer),a.vertexAttribPointer(n.a_rgba,this._pickingColorBuffer.itemSize,a.FLOAT,!1,0,0),a.uniform1f(o.depthOffset,h.polygonOffsetUnits),a.drawArrays(a.TRIANGLES,0,this._vertexBuffer.numItems),a.enable(a.CULL_FACE)}_removeBillboard(e){let t=e._handlerIndex;this._billboards.splice(t,1);let s=24*this._maxLetters,n=t*s;this._rgbaArr=at(this._rgbaArr,n,s),this._outlineColorArr=at(this._outlineColorArr,n,s),this._texCoordArr=at(this._texCoordArr,n,s),this._gliphParamArr=at(this._gliphParamArr,n,s),s=18*this._maxLetters,n=t*s,this._positionHighArr=at(this._positionHighArr,n,s),this._positionLowArr=at(this._positionLowArr,n,s),this._offsetArr=at(this._offsetArr,n,s),this._pickingColorArr=at(this._pickingColorArr,n,s),s=12*this._maxLetters,n=t*s,this._vertexArr=at(this._vertexArr,n,s),s=6*this._maxLetters,n=t*s,this._sizeArr=at(this._sizeArr,n,s),this._rotationArr=at(this._rotationArr,n,s),this._fontIndexArr=at(this._fontIndexArr,n,s),this._outlineArr=at(this._outlineArr,n,s),this.reindexBillboardsArray(t),this.refresh(),e._handlerIndex=-1,e._handler=null,e._isReady=!1}setText(e,t,s,n,o=0,a=!1){t=t.normalize("NFKC");let h=this._renderer.fontAtlas.atlasesArr[s];if(!h)return;let c=24*e*this._maxLetters,d=this._texCoordArr,u=this._gliphParamArr,_=0,f=Math.min(this._maxLetters,t.length),v=0;a&&(v=1);let g=0,y=h.kernings;for(_=0;_<f;_++){let p=c+24*_,x=t[_],T=h.get(x.charCodeAt(0))||h.get(32);if(!T)continue;let w=T.texCoords,C=T.metrics;d[p]=w[0],d[p+1]=w[1],d[p+2]=g,d[p+3]=v,d[p+4]=w[2],d[p+5]=w[3],d[p+6]=g,d[p+7]=v,d[p+8]=w[4],d[p+9]=w[5],d[p+10]=g,d[p+11]=v,d[p+12]=w[6],d[p+13]=w[7],d[p+14]=g,d[p+15]=v,d[p+16]=w[8],d[p+17]=w[9],d[p+18]=g,d[p+19]=v,d[p+20]=w[10],d[p+21]=w[11],d[p+22]=g,d[p+23]=v,u[p]=C.nWidth,u[p+1]=C.nHeight,u[p+2]=C.nXOffset,u[p+3]=C.nYOffset,u[p+4]=C.nWidth,u[p+5]=C.nHeight,u[p+6]=C.nXOffset,u[p+7]=C.nYOffset,u[p+8]=C.nWidth,u[p+9]=C.nHeight,u[p+10]=C.nXOffset,u[p+11]=C.nYOffset,u[p+12]=C.nWidth,u[p+13]=C.nHeight,u[p+14]=C.nXOffset,u[p+15]=C.nYOffset,u[p+16]=C.nWidth,u[p+17]=C.nHeight,u[p+18]=C.nXOffset,u[p+19]=C.nYOffset,u[p+20]=C.nWidth,u[p+21]=C.nHeight,u[p+22]=C.nXOffset,u[p+23]=C.nYOffset;let E=y[x.charCodeAt(0)];if(E&&t[_+1]){let L=E[t[_+1].charCodeAt(0)];g+=L?C.nAdvance+L+o:C.nAdvance+o}else g+=C.nAdvance+o}if(n===di.CENTER)for(g*=-.5,_=0;_<f;_++){let p=c+24*_;d[p+2]+=g,d[p+6]+=g,d[p+10]+=g,d[p+14]+=g,d[p+18]+=g,d[p+22]+=g}for(;_<this._maxLetters;_++){let p=c+24*_;d[p+3]=-1,d[p+7]=-1,d[p+11]=-1,d[p+15]=-1,d[p+19]=-1,d[p+23]=-1}this._changedBuffers[6]=!0}setPositionArr(e,t,s){let n=18*e*this._maxLetters,o=this._positionHighArr,a=t.x,h=t.y,c=t.z,d=this._positionLowArr,u=s.x,_=s.y,f=s.z;for(let v=0;v<this._maxLetters;v++){let g=n+18*v;o[g]=a,o[g+1]=h,o[g+2]=c,o[g+3]=a,o[g+4]=h,o[g+5]=c,o[g+6]=a,o[g+7]=h,o[g+8]=c,o[g+9]=a,o[g+10]=h,o[g+11]=c,o[g+12]=a,o[g+13]=h,o[g+14]=c,o[g+15]=a,o[g+16]=h,o[g+17]=c,d[g]=u,d[g+1]=_,d[g+2]=f,d[g+3]=u,d[g+4]=_,d[g+5]=f,d[g+6]=u,d[g+7]=_,d[g+8]=f,d[g+9]=u,d[g+10]=_,d[g+11]=f,d[g+12]=u,d[g+13]=_,d[g+14]=f,d[g+15]=u,d[g+16]=_,d[g+17]=f}this._changedBuffers[1]=!0}setPickingColorArr(e,t){let s=18*e*this._maxLetters,n=this._pickingColorArr,o=t.x/255,a=t.y/255,h=t.z/255;for(let c=0;c<this._maxLetters;c++){let d=s+18*c;n[d]=o,n[d+1]=a,n[d+2]=h,n[d+3]=o,n[d+4]=a,n[d+5]=h,n[d+6]=o,n[d+7]=a,n[d+8]=h,n[d+9]=o,n[d+10]=a,n[d+11]=h,n[d+12]=o,n[d+13]=a,n[d+14]=h,n[d+15]=o,n[d+16]=a,n[d+17]=h}this._changedBuffers[0]=!0}setSizeArr(e,t){let s=6*e*this._maxLetters,n=this._sizeArr;for(let o=0;o<this._maxLetters;o++){let a=s+6*o;n[a]=t,n[a+1]=t,n[a+2]=t,n[a+3]=t,n[a+4]=t,n[a+5]=t}this._changedBuffers[2]=!0}setOffsetArr(e,t){let s=18*e*this._maxLetters,n=this._offsetArr,o=t.x,a=t.y,h=t.z;for(let c=0;c<this._maxLetters;c++){let d=s+18*c;n[d]=o,n[d+1]=a,n[d+2]=h,n[d+3]=o,n[d+4]=a,n[d+5]=h,n[d+6]=o,n[d+7]=a,n[d+8]=h,n[d+9]=o,n[d+10]=a,n[d+11]=h,n[d+12]=o,n[d+13]=a,n[d+14]=h,n[d+15]=o,n[d+16]=a,n[d+17]=h}this._changedBuffers[3]=!0}setRgbaArr(e,t){let s=24*e*this._maxLetters,n=this._rgbaArr,o=t.x,a=t.y,h=t.z,c=t.w;for(let d=0;d<this._maxLetters;d++){let u=s+24*d;n[u]=o,n[u+1]=a,n[u+2]=h,n[u+3]=c,n[u+4]=o,n[u+5]=a,n[u+6]=h,n[u+7]=c,n[u+8]=o,n[u+9]=a,n[u+10]=h,n[u+11]=c,n[u+12]=o,n[u+13]=a,n[u+14]=h,n[u+15]=c,n[u+16]=o,n[u+17]=a,n[u+18]=h,n[u+19]=c,n[u+20]=o,n[u+21]=a,n[u+22]=h,n[u+23]=c}this._changedBuffers[4]=!0}setOutlineColorArr(e,t){let s=24*e*this._maxLetters,n=this._outlineColorArr,o=t.x,a=t.y,h=t.z,c=t.w;for(let d=0;d<this._maxLetters;d++){let u=s+24*d;n[u]=o,n[u+1]=a,n[u+2]=h,n[u+3]=c,n[u+4]=o,n[u+5]=a,n[u+6]=h,n[u+7]=c,n[u+8]=o,n[u+9]=a,n[u+10]=h,n[u+11]=c,n[u+12]=o,n[u+13]=a,n[u+14]=h,n[u+15]=c,n[u+16]=o,n[u+17]=a,n[u+18]=h,n[u+19]=c,n[u+20]=o,n[u+21]=a,n[u+22]=h,n[u+23]=c}this._changedBuffers[10]=!0}setOutlineArr(e,t){let s=6*e*this._maxLetters,n=this._outlineArr;for(let o=0;o<this._maxLetters;o++){let a=s+6*o;n[a]=t,n[a+1]=t,n[a+2]=t,n[a+3]=t,n[a+4]=t,n[a+5]=t}this._changedBuffers[9]=!0}setRotationArr(e,t){let s=6*e*this._maxLetters,n=this._rotationArr;for(let o=0;o<this._maxLetters;o++){let a=s+6*o;n[a]=t,n[a+1]=t,n[a+2]=t,n[a+3]=t,n[a+4]=t,n[a+5]=t}this._changedBuffers[5]=!0}setVisibility(e,t){let s;s=t?[0,0,0,-1,1,-1,1,-1,1,0,0,0]:[0,0,0,0,0,0,0,0,0,0,0,0],this.setVertexArr(e,s)}setVertexArr(e,t){let s=12*e*this._maxLetters,n=this._vertexArr;for(let o=0;o<this._maxLetters;o++){let a=s+12*o;n[a]=t[0],n[a+1]=t[1],n[a+2]=t[2],n[a+3]=t[3],n[a+4]=t[4],n[a+5]=t[5],n[a+6]=t[6],n[a+7]=t[7],n[a+8]=t[8],n[a+9]=t[9],n[a+10]=t[10],n[a+11]=t[11]}this._changedBuffers[7]=!0}setFontIndexArr(e,t){let s=6*e*this._maxLetters,n=this._fontIndexArr;for(let o=0;o<this._maxLetters;o++){let a=s+6*o;n[a]=t,n[a+1]=t,n[a+2]=t,n[a+3]=t,n[a+4]=t,n[a+5]=t}this._changedBuffers[8]=!0}createSizeBuffer(){let e=this._renderer.handler;e.gl.deleteBuffer(this._sizeBuffer),this._sizeBuffer=e.createArrayBuffer(this._sizeArr,1,this._sizeArr.length)}createFontIndexBuffer(){let e=this._renderer.handler;e.gl.deleteBuffer(this._fontIndexBuffer),this._fontIndexBuffer=e.createArrayBuffer(this._fontIndexArr,1,this._fontIndexArr.length)}createTexCoordBuffer(){let e=this._renderer.handler;e.gl.deleteBuffer(this._texCoordBuffer),this._texCoordBuffer=e.createArrayBuffer(this._texCoordArr,4,this._texCoordArr.length/4),e.gl.deleteBuffer(this._gliphParamBuffer),this._gliphParamBuffer=e.createArrayBuffer(this._gliphParamArr,4,this._gliphParamArr.length/4)}createOutlineBuffer(){let e=this._renderer.handler;e.gl.deleteBuffer(this._outlineBuffer),this._outlineBuffer=e.createArrayBuffer(this._outlineArr,1,this._outlineArr.length)}createOutlineColorBuffer(){let e=this._renderer.handler;e.gl.deleteBuffer(this._outlineColorBuffer),this._outlineColorBuffer=e.createArrayBuffer(this._outlineColorArr,4,this._outlineColorArr.length/4)}setMaxLetters(e){this._maxLetters=e}}const bs=class Hc{constructor(e){this.pickingEnabled=!0,this.__id=Hc.__counter__++,this.pickingEnabled=!0,this._entityCollection=e,this._renderer=null,this._pointClouds=[]}_initProgram(){this._renderer&&this._renderer.handler&&(this._renderer.handler.programs.pointCloud||this._renderer.handler.addProgram(new $("pointCloud",{uniforms:{projectionViewMatrix:"mat4",opacity:"float",pointSize:"float"},attributes:{coordinates:"vec3",colors:"vec3"},vertexShader:`attribute vec3 coordinates;
            attribute vec4 colors;
            uniform mat4 projectionViewMatrix;
            uniform float opacity;
            uniform float pointSize;
            varying vec4 color;
            void main() {
                color = colors;
                color.a *= opacity;
                gl_Position = projectionViewMatrix * vec4(coordinates, 1.0);
                gl_PointSize = pointSize;
            }`,fragmentShader:`precision highp float;
            varying vec4 color;
            void main(void) {
                gl_FragColor = color;
            }`})))}setRenderNode(e){this._renderer=e.renderer,this._initProgram();for(let t=0;t<this._pointClouds.length;t++)this._pointClouds[t].setRenderNode(e)}add(e){e._handlerIndex===-1&&(e._handler=this,e._handlerIndex=this._pointClouds.length,this._pointClouds.push(e),this._entityCollection&&this._entityCollection.renderNode&&e.setRenderNode(this._entityCollection.renderNode))}remove(e){let t=e._handlerIndex;t!==-1&&(e._deleteBuffers(),e._handlerIndex=-1,e._handler=null,this._pointClouds.splice(t,1),this._reindexPointCloudArray(t))}_reindexPointCloudArray(e){let t=this._pointClouds;for(let s=e;s<t.length;s++)t[s]._handlerIndex=s}draw(){let e=this._pointClouds.length;for(;e--;)this._pointClouds[e].draw()}drawPicking(){if(this.pickingEnabled){let e=this._pointClouds.length;for(;e--;)this._pointClouds[e].drawPicking()}}clear(){let e=this._pointClouds.length;for(;e--;)this._pointClouds[e]._deleteBuffers(),this._pointClouds[e]._handler=null,this._pointClouds[e]._handlerIndex=-1;this._pointClouds.length=0,this._pointClouds=[]}};bs.__counter__=0;let Cr=bs;const ws=class Uc{constructor(e){this.__id=Uc.__counter__++,this._entityCollection=e,this._renderer=null,this._polylines=[],this.pickingEnabled=!0,this._relativeCenter=new m,this._rtcEyePositionHigh=new Float32Array([0,0,0]),this._rtcEyePositionLow=new Float32Array([0,0,0])}_initProgram(){this._renderer&&this._renderer.handler&&(this._renderer.handler.programs.polyline_screen||this._renderer.handler.addProgram(new $("polyline_screen",{uniforms:{viewport:"vec2",proj:"mat4",view:"mat4",rtcEyePositionHigh:"vec3",rtcEyePositionLow:"vec3",thickness:"float",opacity:"float",depthOffset:"float",visibleSphere:"vec4"},attributes:{prevHigh:"vec3",currentHigh:"vec3",nextHigh:"vec3",prevLow:"vec3",currentLow:"vec3",nextLow:"vec3",order:"float",color:"vec4"},vertexShader:"precision highp float;attribute vec3 prevHigh;attribute vec3 currentHigh;attribute vec3 nextHigh;attribute vec3 prevLow;attribute vec3 currentLow;attribute vec3 nextLow;attribute float order;attribute vec4 color;uniform float thickness;uniform mat4 proj;uniform mat4 view;uniform vec2 viewport;uniform vec3 rtcEyePositionHigh;uniform vec3 rtcEyePositionLow;uniform float opacity;uniform float depthOffset;varying vec4 vColor;varying vec3 vPos;varying vec3 uCamPos;const float NEAR=-1.0;vec2 getIntersection(vec2 start1,vec2 end1,vec2 start2,vec2 end2){vec2 dir=end2-start2;vec2 perp=vec2(-dir.y,dir.x);float d2=dot(perp,start2);float seg=dot(perp,start1)-d2;float prl=seg-dot(perp,end1)+d2;if(prl>-1.0&&prl<1.0){return start1;}float u=seg/prl;return start1+u*(end1-start1);}vec2 project(vec4 p){return(0.5*p.xyz/p.w+0.5).xy*viewport;}void main(){uCamPos=rtcEyePositionHigh+rtcEyePositionLow;vPos=currentHigh+currentLow;vColor=vec4(color.rgb,color.a*opacity);mat4 viewMatrixRTE=view;viewMatrixRTE[3]=vec4(0.0,0.0,0.0,1.0);vec3 highDiff,lowDiff;highDiff=currentHigh-rtcEyePositionHigh;highDiff=highDiff*step(1.0,length(highDiff));lowDiff=currentLow-rtcEyePositionLow;vec4 vCurrent=viewMatrixRTE*vec4(highDiff+lowDiff,1.0);highDiff=prevHigh-rtcEyePositionHigh;highDiff=highDiff*step(1.0,length(highDiff));lowDiff=prevLow-rtcEyePositionLow;vec4 vPrev=viewMatrixRTE*vec4(highDiff+lowDiff,1.0);highDiff=nextHigh-rtcEyePositionHigh;highDiff=highDiff*step(1.0,length(highDiff));lowDiff=nextLow-rtcEyePositionLow;vec4 vNext=viewMatrixRTE*vec4(highDiff+lowDiff,1.0);if(vCurrent.z>NEAR){if(vPrev.z<NEAR&&abs(order)==1.0){vCurrent=vPrev+(vCurrent-vPrev)*(NEAR-vPrev.z)/(vCurrent.z-vPrev.z);}else if(vNext.z<NEAR&&abs(order)==2.0){vCurrent=vNext+(vCurrent-vNext)*(NEAR-vNext.z)/(vCurrent.z-vNext.z);}}vec4 dCurrent=proj*vCurrent;vec2 _next=project(proj*vNext);vec2 _prev=project(proj*vPrev);vec2 _current=project(dCurrent);if(_prev==_current){if(_next==_current){_next=_current+vec2(1.0,0.0);_prev=_current-_next;}else{_prev=_current+normalize(_current-_next);}}if(_next==_current){_next=_current+normalize(_current-_prev);}vec2 sNext=_next,sCurrent=_current,sPrev=_prev;vec2 dirNext=normalize(sNext-sCurrent);vec2 dirPrev=normalize(sPrev-sCurrent);float dotNP=dot(dirNext,dirPrev);vec2 normalNext=normalize(vec2(-dirNext.y,dirNext.x));vec2 normalPrev=normalize(vec2(dirPrev.y,-dirPrev.x));float d=thickness*sign(order);vec2 m;if(dotNP>=0.99991){m=sCurrent-normalPrev*d;}else{m=getIntersection(sCurrent+normalPrev*d,sPrev+normalPrev*d,sCurrent+normalNext*d,sNext+normalNext*d);if(dotNP>0.5&&dot(dirNext+dirPrev,m-sCurrent)<0.0){float occw=order*sign(dirNext.x*dirPrev.y-dirNext.y*dirPrev.x);if(occw==-1.0){m=sCurrent+normalPrev*d;}else if(occw==1.0){m=sCurrent+normalNext*d;}else if(occw==-2.0){m=sCurrent+normalNext*d;}else if(occw==2.0){m=sCurrent+normalPrev*d;}}else if(distance(sCurrent,m)>min(distance(sCurrent,sNext),distance(sCurrent,sPrev))){m=sCurrent+normalNext*d;}}gl_Position=vec4((2.0*m/viewport-1.0)*dCurrent.w,dCurrent.z+depthOffset,dCurrent.w);}",fragmentShader:"precision highp float;uniform vec4 visibleSphere;varying vec3 uCamPos;varying vec4 vColor;varying vec3 vPos;void main(){if(visibleSphere.w!=0.0){vec3 cam_dir=normalize(vPos-uCamPos);vec3 sph_dir=normalize(vPos-visibleSphere.xyz);if(dot(cam_dir,sph_dir)>0.11){discard;}}gl_FragColor=vec4(vColor.rgb,vColor.a);}"})),this._renderer.handler.programs.polyline_picking||this._renderer.handler.addProgram(new $("polyline_picking",{uniforms:{viewport:"vec2",proj:"mat4",view:"mat4",rtcEyePositionHigh:"vec3",rtcEyePositionLow:"vec3",color:"vec4",thickness:"float",depthOffset:"float",visibleSphere:"vec4"},attributes:{prevHigh:"vec3",currentHigh:"vec3",nextHigh:"vec3",prevLow:"vec3",currentLow:"vec3",nextLow:"vec3",order:"float"},vertexShader:"precision highp float;attribute vec3 prevHigh;attribute vec3 currentHigh;attribute vec3 nextHigh;attribute vec3 prevLow;attribute vec3 currentLow;attribute vec3 nextLow;attribute float order;uniform float thickness;uniform vec4 color;uniform mat4 proj;uniform mat4 view;uniform vec2 viewport;uniform vec3 rtcEyePositionHigh;uniform vec3 rtcEyePositionLow;uniform float depthOffset;varying vec4 vColor;varying vec3 vPos;varying vec3 uCamPos;const float NEAR=-1.0;vec2 getIntersection(vec2 start1,vec2 end1,vec2 start2,vec2 end2){vec2 dir=end2-start2;vec2 perp=vec2(-dir.y,dir.x);float d2=dot(perp,start2);float seg=dot(perp,start1)-d2;float prl=seg-dot(perp,end1)+d2;if(prl>-1.0&&prl<1.0){return start1;}float u=seg/prl;return start1+u*(end1-start1);}vec2 project(vec4 p){return(0.5*p.xyz/p.w+0.5).xy*viewport;}void main(){uCamPos=rtcEyePositionHigh+rtcEyePositionLow;vPos=currentHigh+currentLow;vColor=color;vec3 highDiff,lowDiff;mat4 viewMatrixRTE=view;viewMatrixRTE[3]=vec4(0.0,0.0,0.0,1.0);highDiff=currentHigh-rtcEyePositionHigh;highDiff=highDiff*step(1.0,length(highDiff));lowDiff=currentLow-rtcEyePositionLow;vec4 vCurrent=viewMatrixRTE*vec4(highDiff+lowDiff,1.0);highDiff=prevHigh-rtcEyePositionHigh;highDiff=highDiff*step(1.0,length(highDiff));lowDiff=prevLow-rtcEyePositionLow;vec4 vPrev=viewMatrixRTE*vec4(highDiff+lowDiff,1.0);highDiff=nextHigh-rtcEyePositionHigh;highDiff=highDiff*step(1.0,length(highDiff));lowDiff=nextLow-rtcEyePositionLow;vec4 vNext=viewMatrixRTE*vec4(highDiff+lowDiff,1.0);if(vCurrent.z>NEAR){if(vPrev.z<NEAR&&abs(order)==1.0){vCurrent=vPrev+(vCurrent-vPrev)*(NEAR-vPrev.z)/(vCurrent.z-vPrev.z);}else if(vNext.z<NEAR&&abs(order)==2.0){vCurrent=vNext+(vCurrent-vNext)*(NEAR-vNext.z)/(vCurrent.z-vNext.z);}}vec4 dCurrent=proj*vCurrent;vec2 _next=project(proj*vNext);vec2 _prev=project(proj*vPrev);vec2 _current=project(dCurrent);if(_prev==_current){if(_next==_current){_next=_current+vec2(1.0,0.0);_prev=_current-_next;}else{_prev=_current+normalize(_current-_next);}}if(_next==_current){_next=_current+normalize(_current-_prev);}vec2 sNext=_next,sCurrent=_current,sPrev=_prev;vec2 dirNext=normalize(sNext-sCurrent);vec2 dirPrev=normalize(sPrev-sCurrent);float dotNP=dot(dirNext,dirPrev);vec2 normalNext=normalize(vec2(-dirNext.y,dirNext.x));vec2 normalPrev=normalize(vec2(dirPrev.y,-dirPrev.x));float d=thickness*sign(order);vec2 m;if(dotNP>=0.99991){m=sCurrent-normalPrev*d;}else{m=getIntersection(sCurrent+normalPrev*d,sPrev+normalPrev*d,sCurrent+normalNext*d,sNext+normalNext*d);if(dotNP>0.5&&dot(dirNext+dirPrev,m-sCurrent)<0.0){float occw=order*sign(dirNext.x*dirPrev.y-dirNext.y*dirPrev.x);if(occw==-1.0){m=sCurrent+normalPrev*d;}else if(occw==1.0){m=sCurrent+normalNext*d;}else if(occw==-2.0){m=sCurrent+normalNext*d;}else if(occw==2.0){m=sCurrent+normalPrev*d;}}else if(distance(sCurrent,m)>min(distance(sCurrent,sNext),distance(sCurrent,sPrev))){m=sCurrent+normalNext*d;}}gl_Position=vec4((2.0*m/viewport-1.0)*dCurrent.w,dCurrent.z+depthOffset,dCurrent.w);}",fragmentShader:"precision highp float;uniform vec4 visibleSphere;varying vec3 uCamPos;varying vec4 vColor;varying vec3 vPos;void main(){if(visibleSphere.w!=0.0){vec3 cam_dir=normalize(vPos-uCamPos);vec3 sph_dir=normalize(vPos-visibleSphere.xyz);if(dot(cam_dir,sph_dir)>0.11){discard;}}gl_FragColor=vec4(vColor.rgb,vColor.a);}"})))}setRenderNode(e){this._renderer=e.renderer,this._initProgram();for(let t=0;t<this._polylines.length;t++)this._polylines[t].setRenderNode(e)}add(e){e._handlerIndex===-1&&(e._handler=this,e._handlerIndex=this._polylines.length,e.__doubleToTwoFloats=this.getRTCPosition.bind(this),this._polylines.push(e),this._entityCollection&&this._entityCollection.renderNode&&(e.setRenderNode(this._entityCollection.renderNode),e.updateRTCPosition()))}remove(e){let t=e._handlerIndex;t!==-1&&(e._deleteBuffers(),e._handlerIndex=-1,e._handler=null,this._polylines.splice(t,1),this.reindexPolylineArray(t))}reindexPolylineArray(e){let t=this._polylines;for(let s=e;s<t.length;s++)t[s]._handlerIndex=s}draw(){this._updateRTCEyePosition();let e=this._polylines.length;for(;e--;)this._polylines[e].draw()}drawPicking(){if(this.pickingEnabled){let e=this._polylines.length;for(;e--;)this._polylines[e].drawPicking()}}clear(){let e=this._polylines.length;for(;e--;)this._polylines[e]._deleteBuffers(),this._polylines[e]._handler=null,this._polylines[e]._handlerIndex=-1;this._polylines.length=0,this._polylines=[]}getRTCPosition(e,t,s){let n=e.sub(this._relativeCenter);m.doubleToTwoFloats(n,t,s)}setRelativeCenter(e){this._relativeCenter.copy(e);for(let t=0;t<this._polylines.length;t++)this._polylines[t].updateRTCPosition()}_updateRTCEyePosition(){let e=this._renderer;if(e.activeCamera.isFirstPass){let t=e.activeCamera.eye.sub(this._relativeCenter);m.doubleToTwoFloat32Array(t,this._rtcEyePositionHigh,this._rtcEyePositionLow)}}};ws.__counter__=0;let Er=ws;const Ts=class Gc{constructor(e){this.__id=Gc.__counter__++,this.pickingEnabled=!0,this._entityCollection=e,this._renderer=null,this._rays=[],this._vertexBuffer=null,this._startPositionHighBuffer=null,this._startPositionLowBuffer=null,this._endPositionHighBuffer=null,this._endPositionLowBuffer=null,this._thicknessBuffer=null,this._rgbaBuffer=null,this._pickingColorBuffer=null,this._vertexArr=[],this._startPositionHighArr=[],this._startPositionLowArr=[],this._endPositionHighArr=[],this._endPositionLowArr=[],this._thicknessArr=[],this._rgbaArr=[],this._pickingColorArr=[],this._buffersUpdateCallbacks=[],this._buffersUpdateCallbacks[5]=this.createVertexBuffer,this._buffersUpdateCallbacks[1]=this.createStartPositionBuffer,this._buffersUpdateCallbacks[2]=this.createEndPositionBuffer,this._buffersUpdateCallbacks[4]=this.createThicknessBuffer,this._buffersUpdateCallbacks[3]=this.createRgbaBuffer,this._buffersUpdateCallbacks[0]=this.createPickingColorBuffer,this._changedBuffers=new Array(this._buffersUpdateCallbacks.length)}static concArr(e,t){for(let s=0;s<t.length;s++)e.push(t[s])}initProgram(){this._renderer&&this._renderer.handler&&(this._renderer.handler.programs.rayScreen||this._renderer.handler.addProgram(new $("rayScreen",{uniforms:{projectionMatrix:"mat4",viewMatrix:"mat4",eyePositionHigh:"vec3",eyePositionLow:"vec3",resolution:"float",uOpacity:"float"},attributes:{a_vertices:"vec2",a_startPosHigh:"vec3",a_startPosLow:"vec3",a_endPosHigh:"vec3",a_endPosLow:"vec3",a_thickness:"float",a_rgba:"vec4"},vertexShader:"precision highp float;attribute vec4 a_rgba;attribute vec3 a_startPosHigh;attribute vec3 a_startPosLow;attribute vec3 a_endPosHigh;attribute vec3 a_endPosLow;attribute vec2 a_vertices;attribute float a_thickness;varying vec4 v_rgba;uniform mat4 viewMatrix;uniform mat4 projectionMatrix;uniform vec3 eyePositionHigh;uniform vec3 eyePositionLow;uniform float resolution;uniform float uOpacity;void main(){v_rgba=vec4(a_rgba.rgb,a_rgba.a*uOpacity);vec3 v=(a_endPosHigh-a_startPosHigh)+(a_endPosLow-a_startPosLow);vec3 look=(a_startPosHigh-eyePositionHigh)+(a_startPosLow-eyePositionLow)+v*a_vertices.y;vec3 up=normalize(normalize(v));vec3 right=normalize(cross(look,up));float dist=dot(look,vec3(viewMatrix[0][2],viewMatrix[1][2],viewMatrix[2][2]));float focalSize=2.0*dist*resolution;vec3 vert=right*a_thickness*focalSize*a_vertices.x;vec3 highDiff;if(a_vertices.y==0.0){highDiff=a_startPosHigh-eyePositionHigh;vert+=a_startPosLow-eyePositionLow;}else{highDiff=a_endPosHigh-eyePositionHigh;vert+=a_endPosLow-eyePositionLow;}mat4 viewMatrixRTE=viewMatrix;viewMatrixRTE[3]=vec4(0.0,0.0,0.0,1.0);gl_Position=projectionMatrix*viewMatrixRTE*vec4(highDiff*step(1.0,length(highDiff))+vert,1.0);}",fragmentShader:"precision highp float;varying vec4 v_rgba;void main(){gl_FragColor=v_rgba;}"})))}setRenderer(e){this._renderer=e,this.initProgram()}refresh(){let e=this._changedBuffers.length;for(;e--;)this._changedBuffers[e]=!0}_removeRays(){let e=this._rays.length;for(;e--;){let t=this._rays[e];t._handlerIndex=-1,t._handler=null}this._rays.length=0,this._rays=[]}clear(){this._vertexArr=null,this._startPositionHighArr=null,this._startPositionLowArr=null,this._endPositionHighArr=null,this._endPositionLowArr=null,this._thicknessArr=null,this._rgbaArr=null,this._vertexArr=new Float32Array([]),this._startPositionHighArr=new Float32Array([]),this._startPositionLowArr=new Float32Array([]),this._endPositionHighArr=new Float32Array([]),this._endPositionLowArr=new Float32Array([]),this._thicknessArr=new Float32Array([]),this._rgbaArr=new Float32Array([]),this._removeRays(),this._deleteBuffers(),this.refresh()}_deleteBuffers(){if(this._renderer){let e=this._renderer.handler.gl;e&&(e.deleteBuffer(this._startPositionHighBuffer),e.deleteBuffer(this._startPositionLowBuffer),e.deleteBuffer(this._endPositionHighBuffer),e.deleteBuffer(this._endPositionLowBuffer),e.deleteBuffer(this._thicknessBuffer),e.deleteBuffer(this._rgbaBuffer),e.deleteBuffer(this._vertexBuffer)),this._startPositionHighBuffer=null,this._startPositionLowBuffer=null,this._endPositionHighBuffer=null,this._endPositionLowBuffer=null,this._thicknessBuffer=null,this._rgbaBuffer=null,this._vertexBuffer=null}}update(){if(this._renderer){let e=this._changedBuffers.length;for(;e--;)this._changedBuffers[e]&&(this._buffersUpdateCallbacks[e].call(this),this._changedBuffers[e]=!1)}}add(e){e._handlerIndex==-1&&(e._handler=this,e._handlerIndex=this._rays.length,this._rays.push(e),this._addRayToArrays(e),this.refresh())}_addRayToArrays(e){e.getVisibility()?this._vertexArr=xt(this._vertexArr,[-.5,1,-.5,0,.5,0,.5,0,.5,1,-.5,1]):this._vertexArr=xt(this._vertexArr,[0,0,0,0,0,0,0,0,0,0,0,0]);let t=e._startPositionHigh.x,s=e._startPositionHigh.y,n=e._startPositionHigh.z;this._startPositionHighArr=xt(this._startPositionHighArr,[t,s,n,t,s,n,t,s,n,t,s,n,t,s,n,t,s,n]),t=e._startPositionLow.x,s=e._startPositionLow.y,n=e._startPositionLow.z,this._startPositionLowArr=xt(this._startPositionLowArr,[t,s,n,t,s,n,t,s,n,t,s,n,t,s,n,t,s,n]),t=e._endPositionHigh.x,s=e._endPositionHigh.y,n=e._endPositionHigh.z,this._endPositionHighArr=xt(this._endPositionHighArr,[t,s,n,t,s,n,t,s,n,t,s,n,t,s,n,t,s,n]),t=e._endPositionLow.x,s=e._endPositionLow.y,n=e._endPositionLow.z,this._endPositionLowArr=xt(this._endPositionLowArr,[t,s,n,t,s,n,t,s,n,t,s,n,t,s,n,t,s,n]),t=e._thickness,this._thicknessArr=xt(this._thicknessArr,[t,t,t,t,t,t]);let o=e._startColor.x,a=e._startColor.y,h=e._startColor.z,c=e._startColor.w,d=e._endColor.x,u=e._endColor.y,_=e._endColor.z,f=e._endColor.w;this._rgbaArr=xt(this._rgbaArr,[d,u,_,f,o,a,h,c,o,a,h,c,o,a,h,c,d,u,_,f,d,u,_,f]),t=e._entity._pickingColor.x/255,s=e._entity._pickingColor.y/255,n=e._entity._pickingColor.z/255,this._pickingColorArr=xt(this._pickingColorArr,[t,s,n,t,s,n,t,s,n,t,s,n,t,s,n,t,s,n])}_displayPASS(){let e=this._renderer,t=e.handler;t.programs.rayScreen.activate();let s=t.programs.rayScreen._program,n=s.attributes,o=s.uniforms,a=t.gl,h=this._entityCollection;a.disable(a.CULL_FACE),a.uniform1f(o.uOpacity,h._fadingOpacity),a.uniformMatrix4fv(o.viewMatrix,!1,e.activeCamera.getViewMatrix()),a.uniformMatrix4fv(o.projectionMatrix,!1,e.activeCamera.getProjectionMatrix()),a.uniform3fv(o.eyePositionHigh,e.activeCamera.eyeHigh),a.uniform3fv(o.eyePositionLow,e.activeCamera.eyeLow),a.uniform1f(o.resolution,e.activeCamera._tanViewAngle_hradOneByHeight),a.bindBuffer(a.ARRAY_BUFFER,this._startPositionHighBuffer),a.vertexAttribPointer(n.a_startPosHigh,this._startPositionHighBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this._startPositionLowBuffer),a.vertexAttribPointer(n.a_startPosLow,this._startPositionLowBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this._endPositionHighBuffer),a.vertexAttribPointer(n.a_endPosHigh,this._endPositionHighBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this._endPositionLowBuffer),a.vertexAttribPointer(n.a_endPosLow,this._endPositionLowBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this._rgbaBuffer),a.vertexAttribPointer(n.a_rgba,this._rgbaBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this._thicknessBuffer),a.vertexAttribPointer(n.a_thickness,this._thicknessBuffer.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this._vertexBuffer),a.vertexAttribPointer(n.a_vertices,this._vertexBuffer.itemSize,a.FLOAT,!1,0,0),a.drawArrays(a.TRIANGLES,0,this._vertexBuffer.numItems),a.enable(a.CULL_FACE)}_pickingPASS(){}draw(){this._rays.length&&(this.update(),this._displayPASS())}drawPicking(){this._rays.length&&this.pickingEnabled&&this._pickingPASS()}reindexRaysArray(e){let t=this._rays;for(let s=e;s<t.length;s++)t[s]._handlerIndex=s}_removeRay(e){let t=e._handlerIndex;this._rays.splice(t,1);let s=24*t;this._rgbaArr=Ct(this._rgbaArr,s,24),s=18*t,this._startPositionHighArr=Ct(this._startPositionHighArr,s,18),this._startPositionLowArr=Ct(this._startPositionLowArr,s,18),this._endPositionHighArr=Ct(this._endPositionHighArr,s,18),this._endPositionLowArr=Ct(this._endPositionLowArr,s,18),this._pickingColorArr=Ct(this._pickingColorArr,s,18),s=12*t,this._vertexArr=Ct(this._vertexArr,s,12),s=6*t,this._thicknessArr=Ct(this._thicknessArr,s,6),this.reindexRaysArray(t),this.refresh(),e._handlerIndex=-1,e._handler=null}remove(e){e._handler&&this.__id===e._handler.__id&&this._removeRay(e)}setStartPositionArr(e,t,s){let n=18*e,o=this._startPositionHighArr,a=t.x,h=t.y,c=t.z;o[n]=a,o[n+1]=h,o[n+2]=c,o[n+3]=a,o[n+4]=h,o[n+5]=c,o[n+6]=a,o[n+7]=h,o[n+8]=c,o[n+9]=a,o[n+10]=h,o[n+11]=c,o[n+12]=a,o[n+13]=h,o[n+14]=c,o[n+15]=a,o[n+16]=h,o[n+17]=c,o=this._startPositionLowArr,a=s.x,h=s.y,c=s.z,o[n]=a,o[n+1]=h,o[n+2]=c,o[n+3]=a,o[n+4]=h,o[n+5]=c,o[n+6]=a,o[n+7]=h,o[n+8]=c,o[n+9]=a,o[n+10]=h,o[n+11]=c,o[n+12]=a,o[n+13]=h,o[n+14]=c,o[n+15]=a,o[n+16]=h,o[n+17]=c,this._changedBuffers[1]=!0}setEndPositionArr(e,t,s){let n=18*e,o=this._endPositionHighArr,a=t.x,h=t.y,c=t.z;o[n]=a,o[n+1]=h,o[n+2]=c,o[n+3]=a,o[n+4]=h,o[n+5]=c,o[n+6]=a,o[n+7]=h,o[n+8]=c,o[n+9]=a,o[n+10]=h,o[n+11]=c,o[n+12]=a,o[n+13]=h,o[n+14]=c,o[n+15]=a,o[n+16]=h,o[n+17]=c,o=this._endPositionLowArr,a=s.x,h=s.y,c=s.z,o[n]=a,o[n+1]=h,o[n+2]=c,o[n+3]=a,o[n+4]=h,o[n+5]=c,o[n+6]=a,o[n+7]=h,o[n+8]=c,o[n+9]=a,o[n+10]=h,o[n+11]=c,o[n+12]=a,o[n+13]=h,o[n+14]=c,o[n+15]=a,o[n+16]=h,o[n+17]=c,this._changedBuffers[2]=!0}setPickingColorArr(e,t){let s=18*e,n=this._pickingColorArr,o=t.x/255,a=t.y/255,h=t.z/255;n[s]=o,n[s+1]=a,n[s+2]=h,n[s+3]=o,n[s+4]=a,n[s+5]=h,n[s+6]=o,n[s+7]=a,n[s+8]=h,n[s+9]=o,n[s+10]=a,n[s+11]=h,n[s+12]=o,n[s+13]=a,n[s+14]=h,n[s+15]=o,n[s+16]=a,n[s+17]=h,this._changedBuffers[0]=!0}setRgbaArr(e,t,s){let n=24*e,o=this._rgbaArr,a=t.x,h=t.y,c=t.z,d=t.w,u=s.x,_=s.y,f=s.z,v=s.w;o[n]=u,o[n+1]=_,o[n+2]=f,o[n+3]=v,o[n+4]=a,o[n+5]=h,o[n+6]=c,o[n+7]=d,o[n+8]=a,o[n+9]=h,o[n+10]=c,o[n+11]=d,o[n+12]=a,o[n+13]=h,o[n+14]=c,o[n+15]=d,o[n+16]=u,o[n+17]=_,o[n+18]=f,o[n+19]=v,o[n+20]=u,o[n+21]=_,o[n+22]=f,o[n+23]=v,this._changedBuffers[3]=!0}setThicknessArr(e,t){let s=6*e,n=this._thicknessArr;n[s]=t,n[s+1]=t,n[s+2]=t,n[s+3]=t,n[s+4]=t,n[s+5]=t,this._changedBuffers[4]=!0}setVisibility(e,t){let s;s=t?[-.5,1,-.5,0,.5,0,.5,0,.5,1,-.5,1]:[0,0,0,0,0,0,0,0,0,0,0,0],this.setVertexArr(e,s)}setVertexArr(e,t){let s=12*e,n=this._vertexArr;n[s]=t[0],n[s+1]=t[1],n[s+2]=t[2],n[s+3]=t[3],n[s+4]=t[4],n[s+5]=t[5],n[s+6]=t[6],n[s+7]=t[7],n[s+8]=t[8],n[s+9]=t[9],n[s+10]=t[10],n[s+11]=t[11],this._changedBuffers[5]=!0}createStartPositionBuffer(){let e=this._renderer.handler;e.gl.deleteBuffer(this._startPositionHighBuffer),this._startPositionHighArr=it(this._startPositionHighArr),this._startPositionHighBuffer=e.createArrayBuffer(this._startPositionHighArr,3,this._startPositionHighArr.length/3,e.gl.DYNAMIC_DRAW),e.gl.deleteBuffer(this._startPositionLowBuffer),this._startPositionLowArr=it(this._startPositionLowArr),this._startPositionLowBuffer=e.createArrayBuffer(this._startPositionLowArr,3,this._startPositionLowArr.length/3,e.gl.DYNAMIC_DRAW)}createEndPositionBuffer(){let e=this._renderer.handler;e.gl.deleteBuffer(this._endPositionHighBuffer),this._endPositionHighArr=it(this._endPositionHighArr),this._endPositionHighBuffer=e.createArrayBuffer(this._endPositionHighArr,3,this._endPositionHighArr.length/3,e.gl.DYNAMIC_DRAW),e.gl.deleteBuffer(this._endPositionLowBuffer),this._endPositionLowArr=it(this._endPositionLowArr),this._endPositionLowBuffer=e.createArrayBuffer(this._endPositionLowArr,3,this._endPositionLowArr.length/3,e.gl.DYNAMIC_DRAW)}createRgbaBuffer(){let e=this._renderer.handler;e.gl.deleteBuffer(this._rgbaBuffer),this._rgbaArr=it(this._rgbaArr),this._rgbaBuffer=e.createArrayBuffer(this._rgbaArr,4,this._rgbaArr.length/4)}createThicknessBuffer(){let e=this._renderer.handler;e.gl.deleteBuffer(this._thicknessBuffer),this._thicknessArr=it(this._thicknessArr),this._thicknessBuffer=e.createArrayBuffer(this._thicknessArr,1,this._thicknessArr.length,e.gl.DYNAMIC_DRAW)}createVertexBuffer(){let e=this._renderer.handler;e.gl.deleteBuffer(this._vertexBuffer),this._vertexArr=it(this._vertexArr),this._vertexBuffer=e.createArrayBuffer(this._vertexArr,2,this._vertexArr.length/2,e.gl.DYNAMIC_DRAW)}createPickingColorBuffer(){let e=this._renderer.handler;e.gl.deleteBuffer(this._pickingColorBuffer),this._pickingColorArr=it(this._pickingColorArr),this._pickingColorBuffer=e.createArrayBuffer(this._pickingColorArr,3,this._pickingColorArr.length/3)}};Ts.__counter__=0;let Ar=Ts;const Cs=class jc{constructor(e){this.__id=jc.__counter__++,this.pickingEnabled=!0,this._entityCollection=e,this._renderer=null,this._strips=[]}_initProgram(){this._renderer&&this._renderer.handler&&!this._renderer.handler.programs.strip&&this._renderer.handler.addProgram(new $("strip",{uniforms:{projectionMatrix:{type:"mat4"},viewMatrix:{type:"mat4"},eyePositionHigh:"vec3",eyePositionLow:"vec3",uColor:{type:"vec4"},uOpacity:{type:"float"}},attributes:{aVertexPositionHigh:{type:"vec3"},aVertexPositionLow:{type:"vec3"}},vertexShader:`attribute vec3 aVertexPositionHigh;
                        attribute vec3 aVertexPositionLow;
                        uniform mat4 projectionMatrix;
                        uniform mat4 viewMatrix;
                        uniform vec3 eyePositionHigh;
                        uniform vec3 eyePositionLow;
                        void main(void) {

                            vec3 highDiff = aVertexPositionHigh - eyePositionHigh;
                            vec3 lowDiff = aVertexPositionLow - eyePositionLow;

                            mat4 viewMatrixRTE = viewMatrix;
                            viewMatrixRTE[3] = vec4(0.0, 0.0, 0.0, 1.0);

                            gl_Position = projectionMatrix * viewMatrixRTE * vec4(highDiff * step(1.0, length(highDiff)) + lowDiff, 1.0);
                        }`,fragmentShader:`precision highp float;
                        uniform vec4 uColor;
                        uniform float uOpacity;
                        void main(void) {
                            gl_FragColor = vec4(uColor.rgb, uColor.a * uOpacity);
                        }`}))}setRenderNode(e){this._renderer=e.renderer,this._initProgram();for(let t=0;t<this._strips.length;t++)this._strips[t].setRenderNode(e)}add(e){e._handlerIndex===-1&&(e._handler=this,e._handlerIndex=this._strips.length,this._strips.push(e),this._entityCollection&&this._entityCollection.renderNode&&e.setRenderNode(this._entityCollection.renderNode))}remove(e){let t=e._handlerIndex;t!==-1&&(e._deleteBuffers(),e._handlerIndex=-1,e._handler=null,this._strips.splice(t,1),this.reindexStripArray(t))}reindexStripArray(e){let t=this._strips;for(let s=e;s<t.length;s++)t[s]._handlerIndex=s}draw(){let e=this._strips.length;for(;e--;)this._strips[e].draw()}drawPicking(){if(this.pickingEnabled){let e=this._strips.length;for(;e--;)this._strips[e].drawPicking()}}clear(){let e=this._strips.length;for(;e--;)this._strips[e]._deleteBuffers(),this._strips[e]._handler=null,this._strips[e]._handlerIndex=-1;this._strips.length=0,this._strips=[]}};Cs.__counter__=0;let Lr=Cs;const Es=class qc{constructor(e={}){this._onChangeRelativeCenter=s=>{this.geoObjectHandler.setRelativeCenter(s),this.polylineHandler.setRelativeCenter(s)},this.__id=qc.__counter__++,this.renderNode=null,this._visibility=e.visibility==null||e.visibility,this.polygonOffsetUnits=e.polygonOffsetUnits!=null?e.polygonOffsetUnits:0,this.billboardHandler=new el(this),this.labelHandler=new sl(this,e.labelMaxLetters),this.polylineHandler=new Er(this),this.rayHandler=new Ar(this),this.pointCloudHandler=new Cr(this),this.stripHandler=new Lr(this),this.geoObjectHandler=new Tr(this),e.pickingEnabled!=null&&this.setPickingEnabled(e.pickingEnabled),this._entities=[],this.scaleByDistance=e.scaleByDistance||[1,1,1];let t=new Float32Array([1,1,1]);e.pickingScale!==void 0&&(e.pickingScale instanceof Array?(t[0]=e.pickingScale[0]||t[0],t[1]=e.pickingScale[1]||t[1],t[2]=e.pickingScale[2]||t[2]):typeof e.pickingScale=="number"&&(t[0]=e.pickingScale,t[1]=e.pickingScale,t[2]=e.pickingScale)),this._depthOrder=e.depthOrder||0,this.pickingScale=t,this._opacity=e.opacity==null?1:e.opacity,this._fadingOpacity=this._opacity,this.events=this.rendererEvents=ot(rl,this),this._useLighting=e.useLighting!=null?e.useLighting?1:0:1,e.entities&&this.addEntities(e.entities)}get depthOrder(){return this._depthOrder}set depthOrder(e){this._depthOrder=e,this.renderNode&&this.renderNode.updateEntityCollectionsDepthOrder()}isEmpty(){return this._entities.length==0}get id(){return this.__id}get useLighting(){return!!this._useLighting}set useLighting(e){this._useLighting=Number(e)}isEqual(e){return e!==null&&this.__id===e.__id}setVisibility(e){var t;this._visibility=e,this._fadingOpacity=this._opacity*(e?1:0),(t=this.renderNode)==null||t.updateEntityCollectionsDepthOrder(),this.events.dispatch(this.events.visibilitychange,this)}getVisibility(){return this._visibility}setOpacity(e){this._opacity=e}setPickingEnabled(e){this.billboardHandler.pickingEnabled=e,this.labelHandler.pickingEnabled=e,this.polylineHandler.pickingEnabled=e,this.rayHandler.pickingEnabled=e,this.pointCloudHandler.pickingEnabled=e,this.stripHandler.pickingEnabled=e,this.geoObjectHandler.pickingEnabled=e}getOpacity(){return this._opacity}setScaleByDistance(e,t,s){this.scaleByDistance[0]=e,this.scaleByDistance[1]=t,this.scaleByDistance[2]=s||Ee}appendChildEntity(e){this._addRecursively(e)}_addRecursively(e){let t=this.renderNode;t&&t.ellipsoid&&e._cartesian.isZero()&&!e.relativePosition&&e.setCartesian3v(t.ellipsoid.lonLatToCartesian(e._lonLat)),this._setPickingColor(e),e._updateAbsolutePosition(),e.setScale3v(e.getScale()),e.billboard&&this.billboardHandler.add(e.billboard),e.label&&this.labelHandler.add(e.label),e.polyline&&this.polylineHandler.add(e.polyline),e.ray&&this.rayHandler.add(e.ray),e.pointCloud&&this.pointCloudHandler.add(e.pointCloud),e.strip&&this.stripHandler.add(e.strip),e.geoObject&&this.geoObjectHandler.add(e.geoObject),this.events.dispatch(this.events.entityadd,e);for(let s=0;s<e.childEntities.length;s++)e.childEntities[s]._entityCollection=this,this._addRecursively(e.childEntities[s])}add(e){return e._entityCollection||(e._entityCollection=this,e._entityCollectionIndex=this._entities.length,this._entities.push(e),this._addRecursively(e)),this}addEntities(e){for(let t=0,s=e.length;t<s;t++)this.add(e[t]);return this}belongs(e){return this.isEqual(e._entityCollection)}_removeRecursively(e){e._entityCollection=null,e._entityCollectionIndex=-1,e.billboard&&this.billboardHandler.remove(e.billboard),e.label&&this.labelHandler.remove(e.label),e.polyline&&this.polylineHandler.remove(e.polyline),e.ray&&this.rayHandler.remove(e.ray),e.pointCloud&&this.pointCloudHandler.remove(e.pointCloud),e.strip&&this.stripHandler.remove(e.strip),e.geoObject&&this.geoObjectHandler.remove(e.geoObject);for(let t=0;t<e.childEntities.length;t++)this._removeRecursively(e.childEntities[t])}_removeEntity(e){if(e.parent){let t=e.parent.childEntities;for(let s=0,n=t.length;s<n;s++)if(t[s].isEqual(e)){t.splice(s,1);break}e.parent=null}else this._entities.splice(e._entityCollectionIndex,1),this.reindexEntitiesArray(e._entityCollectionIndex);this.renderNode&&this.renderNode.renderer&&(this.renderNode.renderer.clearPickingColor(e),e._pickingColor.clear()),this._removeRecursively(e)}removeEntity(e){this.belongs(e)&&(this._removeEntity(e),this.events.dispatch(this.events.entityremove,e))}_removeEntitySilent(e){this.belongs(e)&&this._removeEntity(e)}createPickingColors(e=this._entities){if(this.renderNode&&this.renderNode.renderer)for(let t=0;t<e.length;t++){let s=e[t];this._setPickingColor(s),this.createPickingColors(s.childEntities)}}_setPickingColor(e){this.renderNode&&this.renderNode.renderer&&(e._independentPicking||!e.parent?this.renderNode.renderer.assignPickingColor(e):e._pickingColor=e.parent._pickingColor,this.renderNode.renderer.assignPickingColor(e),e.setPickingColor())}reindexEntitiesArray(e){let t=this._entities;for(let s=e;s<t.length;s++)t[s]._entityCollectionIndex=s}addTo(e,t=!1){return this.renderNode||e.addEntityCollection(this,t),this}bindRenderNode(e){e.renderer&&e.renderer.isInitialized()&&(this.billboardHandler.setRenderer(e.renderer),this.labelHandler.setRenderer(e.renderer),this.rayHandler.setRenderer(e.renderer),this.geoObjectHandler.setRenderNode(e),this.polylineHandler.setRenderNode(e),this.pointCloudHandler.setRenderNode(e),this.stripHandler.setRenderNode(e),e.renderer.events.on("changerelativecenter",this._onChangeRelativeCenter),this.updateBillboardsTextureAtlas(),this.updateLabelsFontAtlas(),this.createPickingColors())}_updateGeodeticCoordinates(e){let t=this._entities,s=t.length;for(;s--;){let n=t[s];n._lonLat&&n.setCartesian3v(e.lonLatToCartesian(n._lonLat))}}updateBillboardsTextureAtlas(){let e=this.billboardHandler.billboards;for(let t=0;t<e.length;t++)e[t].setSrc(e[t].getSrc())}updateLabelsFontAtlas(){this.renderNode&&this.labelHandler.updateFonts()}remove(){var e;this.renderNode&&(this.renderNode.removeEntityCollection(this),(e=this.renderNode.renderer)==null||e.events.off("changerelativecenter",this._onChangeRelativeCenter),this.renderNode=null,this.events.dispatch(this.events.remove,this))}getEntities(){return[].concat(this._entities)}each(e){let t=this._entities.length;for(;t--;){let s=this._entities[t];s&&e(s)}}clear(){this.billboardHandler.clear(),this.labelHandler.clear(),this.polylineHandler.clear(),this.rayHandler.clear(),this.pointCloudHandler.clear(),this.stripHandler.clear(),this.geoObjectHandler.clear();let e=this._entities.length;for(;e--;){let t=this._entities[e];this.renderNode&&this.renderNode.renderer&&(this.renderNode.renderer.clearPickingColor(t),t._pickingColor.clear()),this._clearEntity(t)}this._entities.length=0,this._entities=[]}_clearEntity(e){e._entityCollection=null,e._entityCollectionIndex=-1;for(let t=0;t<e.childEntities.length;t++)this._clearEntity(e.childEntities[t])}};Es.__counter__=0;let ee=Es;const rl=["draw","drawend","add","remove","entityadd","entityremove","visibilitychange","mousemove","mouseenter","mouseleave","lclick","rclick","mclick","ldblclick","rdblclick","mdblclick","lup","rup","mup","ldown","rdown","mdown","lhold","rhold","mhold","mousewheel","touchmove","touchstart","touchend","doubletouch","touchleave","touchenter"];function oe(l,e){if(l>=0){let t=65536*Math.floor(l/65536);e[0]=Math.fround(t),e[1]=Math.fround(l-t)}else{let t=65536*Math.floor(-l/65536);e[0]=Math.fround(-t),e[1]=Math.fround(l+t)}return e}function Tn(l,e){if(l>=0){let t=65536*Math.floor(l/65536);e.x=Math.fround(t),e.y=Math.fround(l-t)}else{let t=65536*Math.floor(-l/65536);e.x=Math.fround(-t),e.y=Math.fround(l+t)}return e}function Cn(l,e,t){t=t||2;var s,n,o,a,h,c,d,u=e&&e.length,_=u?e[0]*t:l.length,f=En(l,0,_,t,!0),v=[];if(!f)return v;if(u&&(f=function(g,y,p,x){var T,w,C,E=[];for(T=0,w=y.length;T<w;T++)(C=En(g,y[T]*x,T<w-1?y[T+1]*x:g.length,x,!1))===C.next&&(C.steiner=!0),E.push(dl(C));for(E.sort(hl),T=0;T<E.length;T++)cl(E[T],p),p=bi(p,p.next);return p}(l,e,f,t)),l.length>80*t){s=o=l[0],n=a=l[1];for(let g=t;g<_;g+=t)(h=l[g])<s&&(s=h),(c=l[g+1])<n&&(n=c),h>o&&(o=h),c>a&&(a=c);d=Math.max(o-s,a-n)}return wi(f,v,t,s,n,d),v}function En(l,e,t,s,n){var o,a;if(n===function(h,c,d,u){var _=0;for(let f=c,v=d-u;f<d;f+=u)_+=(h[v]-h[f])*(h[f+1]+h[v+1]),v=f;return _}(l,e,t,s)>0)for(o=e;o<t;o+=s)a=An(o,l[o],l[o+1],a);else for(o=t-s;o>=e;o-=s)a=An(o,l[o],l[o+1],a);return a&&we(a,a.next)&&(Ci(a),a=a.next),a}function bi(l,e){if(!l)return l;e||(e=l);var t,s=l;do if(t=!1,s.steiner||!we(s,s.next)&&kt(s.prev,s,s.next)!==0)s=s.next;else{if(Ci(s),(s=e=s.prev)===s.next)return null;t=!0}while(t||s!==e);return e}function wi(l,e,t,s,n,o,a){if(l){!a&&o&&function(u,_,f,v){var g=u;do g.z===null&&(g.z=Pr(g.x,g.y,_,f,v)),g.prevZ=g.prev,g.nextZ=g.next,g=g.next;while(g!==u);g.prevZ.nextZ=null,g.prevZ=null,function(y){var p,x,T,w,C,E,L,S,P=1;do{for(x=y,y=null,C=null,E=0;x;){for(E++,T=x,L=0,p=0;p<P&&(L++,T=T.nextZ);p++);for(S=P;L>0||S>0&&T;)L!==0&&(S===0||!T||x.z<=T.z)?(w=x,x=x.nextZ,L--):(w=T,T=T.nextZ,S--),C?C.nextZ=w:y=w,w.prevZ=C,C=w;x=T}C.nextZ=null,P*=2}while(E>1)}(g)}(l,s,n,o);for(var h,c,d=l;l.prev!==l.next;)if(h=l.prev,c=l.next,o?ol(l,s,n,o):nl(l))e.push(h.i/t),e.push(l.i/t),e.push(c.i/t),Ci(l),l=c.next,d=c.next;else if((l=c)===d){a?a===1?wi(l=al(l,e,t),e,t,s,n,o,2):a===2&&ll(l,e,t,s,n,o):wi(bi(l),e,t,s,n,o,1);break}}}function nl(l){var e=l.prev,t=l,s=l.next;if(kt(e,t,s)>=0)return!1;for(var n=l.next.next;n!==l.prev;){if(rs(e.x,e.y,t.x,t.y,s.x,s.y,n.x,n.y)&&kt(n.prev,n,n.next)>=0)return!1;n=n.next}return!0}function ol(l,e,t,s){var n=l.prev,o=l,a=l.next;if(kt(n,o,a)>=0)return!1;for(var h=n.x<o.x?n.x<a.x?n.x:a.x:o.x<a.x?o.x:a.x,c=n.y<o.y?n.y<a.y?n.y:a.y:o.y<a.y?o.y:a.y,d=n.x>o.x?n.x>a.x?n.x:a.x:o.x>a.x?o.x:a.x,u=n.y>o.y?n.y>a.y?n.y:a.y:o.y>a.y?o.y:a.y,_=Pr(h,c,e,t,s),f=Pr(d,u,e,t,s),v=l.nextZ;v&&v.z<=f;){if(v!==l.prev&&v!==l.next&&rs(n.x,n.y,o.x,o.y,a.x,a.y,v.x,v.y)&&kt(v.prev,v,v.next)>=0)return!1;v=v.nextZ}for(v=l.prevZ;v&&v.z>=_;){if(v!==l.prev&&v!==l.next&&rs(n.x,n.y,o.x,o.y,a.x,a.y,v.x,v.y)&&kt(v.prev,v,v.next)>=0)return!1;v=v.prevZ}return!0}function al(l,e,t){var s=l;do{var n=s.prev,o=s.next.next;!we(n,o)&&ea(n,s,s.next,o)&&Ti(n,o)&&Ti(o,n)&&(e.push(n.i/t),e.push(s.i/t),e.push(o.i/t),Ci(s),Ci(s.next),s=l=o),s=s.next}while(s!==l);return s}function ll(l,e,t,s,n,o){var a=l;do{for(var h=a.next.next;h!==a.prev;){if(a.i!==h.i&&ul(a,h)){var c=ia(a,h);return a=bi(a,a.next),c=bi(c,c.next),wi(a,e,t,s,n,o),void wi(c,e,t,s,n,o)}h=h.next}a=a.next}while(a!==l)}function hl(l,e){return l.x-e.x}function cl(l,e){if(e=function(s,n){var o,a=n,h=s.x,c=s.y,d=-1/0;do{if(c<=a.y&&c>=a.next.y&&a.next.y!==a.y){var u=a.x+(c-a.y)*(a.next.x-a.x)/(a.next.y-a.y);if(u<=h&&u>d){if(d=u,u===h){if(c===a.y)return a;if(c===a.next.y)return a.next}o=a.x<a.next.x?a:a.next}}a=a.next}while(a!==n);if(!o)return null;if(h===d)return o.prev;var _,f=o,v=o.x,g=o.y,y=1/0;for(a=o.next;a!==f;)h>=a.x&&a.x>=v&&h!==a.x&&rs(c<g?h:d,c,v,g,c<g?d:h,c,a.x,a.y)&&((_=Math.abs(c-a.y)/(h-a.x))<y||_===y&&a.x>o.x)&&Ti(a,s)&&(o=a,y=_),a=a.next;return o}(l,e)){var t=ia(e,l);bi(t,t.next)}}function Pr(l,e,t,s,n){return(l=1431655765&((l=858993459&((l=252645135&((l=16711935&((l=32767*(l-t)/n)|l<<8))|l<<4))|l<<2))|l<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-s)/n)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function dl(l){var e=l,t=l;do e.x<t.x&&(t=e),e=e.next;while(e!==l);return t}function rs(l,e,t,s,n,o,a,h){return(n-a)*(e-h)-(l-a)*(o-h)>=0&&(l-a)*(s-h)-(t-a)*(e-h)>=0&&(t-a)*(o-h)-(n-a)*(s-h)>=0}function ul(l,e){return l.next.i!==e.i&&l.prev.i!==e.i&&!function(t,s){var n=t;do{if(n.i!==t.i&&n.next.i!==t.i&&n.i!==s.i&&n.next.i!==s.i&&ea(n,n.next,t,s))return!0;n=n.next}while(n!==t);return!1}(l,e)&&Ti(l,e)&&Ti(e,l)&&function(t,s){var n=t,o=!1,a=(t.x+s.x)/2,h=(t.y+s.y)/2;do n.y>h!=n.next.y>h&&n.next.y!==n.y&&a<(n.next.x-n.x)*(h-n.y)/(n.next.y-n.y)+n.x&&(o=!o),n=n.next;while(n!==t);return o}(l,e)}function kt(l,e,t){return(e.y-l.y)*(t.x-e.x)-(e.x-l.x)*(t.y-e.y)}function we(l,e){return l.x===e.x&&l.y===e.y}function ea(l,e,t,s){return!!(we(l,e)&&we(t,s)||we(l,s)&&we(t,e))||kt(l,e,t)>0!=kt(l,e,s)>0&&kt(t,s,l)>0!=kt(t,s,e)>0}function Ti(l,e){return kt(l.prev,l,l.next)<0?kt(l,e,l.next)>=0&&kt(l,l.prev,e)>=0:kt(l,e,l.prev)<0||kt(l,l.next,e)<0}function ia(l,e){var t=new Sr(l.i,l.x,l.y),s=new Sr(e.i,e.x,e.y),n=l.next,o=e.prev;return l.next=e,e.prev=l,t.next=n,n.prev=t,s.next=t,t.prev=s,o.next=s,s.prev=o,s}function An(l,e,t,s){var n=new Sr(l,e,t);return s?(n.next=s.next,n.prev=s,s.next.prev=n,s.next=n):(n.prev=n,n.next=n),n}function Ci(l){l.next.prev=l.prev,l.prev.next=l.next,l.prevZ&&(l.prevZ.nextZ=l.nextZ),l.nextZ&&(l.nextZ.prevZ=l.prevZ)}function Sr(l,e,t){this.i=l,this.x=e,this.y=t,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}function Ln(l){var e=l[0][0].length,t={vertices:[],holes:[],dimensions:e},s=0;for(let n=0;n<l.length;n++){for(let o=0;o<l[n].length;o++)for(let a=0;a<e;a++)t.vertices.push(l[n][o][a]);n>0&&(s+=l[n-1].length,t.holes.push(s))}return t}function Gs(l,e,t){let s=l[0],n=l[1];if(s>=0){let o=65536*Math.floor(s/65536);e.x=Math.fround(o),t.x=Math.fround(s-o)}else{let o=65536*Math.floor(-s/65536);e.x=Math.fround(-o),t.x=Math.fround(s+o)}if(n>=0){let o=65536*Math.floor(n/65536);e.y=Math.fround(o),t.y=Math.fround(n-o)}else{let o=65536*Math.floor(-n/65536);e.y=Math.fround(-o),t.y=Math.fround(n+o)}}let j=new O,q=new O,ze=new O;const fe=class ir{constructor(e){this.__id=ir.__counter__++,this._layer=e,this._handler=null,this._geometries=[],this._updatedGeometryArr=[],this._updatedGeometry={},this._removeGeometryExtentArr=[],this._removeGeometryExtents={},this._polyVerticesHighMerc=[],this._polyVerticesLowMerc=[],this._polyColors=[],this._polyPickingColors=[],this._polyIndexes=[],this._lineVerticesHighMerc=[],this._lineVerticesLowMerc=[],this._lineOrders=[],this._lineIndexes=[],this._lineColors=[],this._linePickingColors=[],this._lineThickness=[],this._lineStrokes=[],this._lineStrokeColors=[],this._polyVerticesHighBufferMerc=null,this._polyVerticesLowBufferMerc=null,this._polyColorsBuffer=null,this._polyPickingColorsBuffer=null,this._polyIndexesBuffer=null,this._lineVerticesHighBufferMerc=null,this._lineVerticesLowBufferMerc=null,this._lineColorsBuffer=null,this._linePickingColorsBuffer=null,this._lineThicknessBuffer=null,this._lineStrokesBuffer=null,this._lineStrokeColorsBuffer=null,this._lineOrdersBuffer=null,this._lineIndexesBuffer=null,this._buffersUpdateCallbacks=[],this._buffersUpdateCallbacks[0]=this.createPolyVerticesBuffer,this._buffersUpdateCallbacks[1]=this.createPolyIndexesBuffer,this._buffersUpdateCallbacks[2]=this.createPolyColorsBuffer,this._buffersUpdateCallbacks[3]=this.createLineVerticesBuffer,this._buffersUpdateCallbacks[4]=this.createLineIndexesBuffer,this._buffersUpdateCallbacks[5]=this.createLineOrdersBuffer,this._buffersUpdateCallbacks[6]=this.createLineColorsBuffer,this._buffersUpdateCallbacks[7]=this.createLineThicknessBuffer,this._buffersUpdateCallbacks[8]=this.createLineStrokesBuffer,this._buffersUpdateCallbacks[9]=this.createLineStrokeColorsBuffer,this._buffersUpdateCallbacks[10]=this.createPolyPickingColorsBuffer,this._buffersUpdateCallbacks[11]=this.createLinePickingColorsBuffer,this._changedBuffers=new Array(this._buffersUpdateCallbacks.length)}static appendLineData(e,t,s,n,o,a,h,c,d,u,_,f,v,g,y,p,x,T){var w=0;_.length>0?(w=_[_.length-5]+9,_.push(w,w)):_.push(0,0);var C=o,E=[s.x,s.y,s.z,s.w],L=h,S=[a.x,a.y,a.z,a.w],P=[n.x,n.y,n.z,1];for(let M=0;M<e.length;M++){var R=e[M];if(R.length===0)continue;let B,z,ue=w;if(t)B=R[R.length-1];else{let I=R[0],se=R[1];se||(se=I),B=[I[0]+I[0]-se[0],I[1]+I[1]-se[1]]}Gs(B,j,q),c.push(j.x,j.y,j.x,j.y,j.x,j.y,j.x,j.y),d.push(q.x,q.y,q.x,q.y,q.x,q.y,q.x,q.y),x.push(j.x,j.y,j.x,j.y,j.x,j.y,j.x,j.y),T.push(q.x,q.y,q.x,q.y,q.x,q.y,q.x,q.y),u.push(1,-1,2,-2),g.push(C,C,C,C),p.push(L,L,L,L),f.push(E[0],E[1],E[2],E[3],E[0],E[1],E[2],E[3],E[0],E[1],E[2],E[3],E[0],E[1],E[2],E[3]),y.push(S[0],S[1],S[2],S[3],S[0],S[1],S[2],S[3],S[0],S[1],S[2],S[3],S[0],S[1],S[2],S[3]),v.push(P[0],P[1],P[2],P[3],P[0],P[1],P[2],P[3],P[0],P[1],P[2],P[3],P[0],P[1],P[2],P[3]);for(let I=0;I<R.length;I++)Gs(R[I],j,q),c.push(j.x,j.y,j.x,j.y,j.x,j.y,j.x,j.y),d.push(q.x,q.y,q.x,q.y,q.x,q.y,q.x,q.y),x.push(j.x,j.y,j.x,j.y,j.x,j.y,j.x,j.y),T.push(q.x,q.y,q.x,q.y,q.x,q.y,q.x,q.y),u.push(1,-1,2,-2),g.push(C,C,C,C),p.push(L,L,L,L),f.push(E[0],E[1],E[2],E[3],E[0],E[1],E[2],E[3],E[0],E[1],E[2],E[3],E[0],E[1],E[2],E[3]),y.push(S[0],S[1],S[2],S[3],S[0],S[1],S[2],S[3],S[0],S[1],S[2],S[3],S[0],S[1],S[2],S[3]),v.push(P[0],P[1],P[2],P[3],P[0],P[1],P[2],P[3],P[0],P[1],P[2],P[3],P[0],P[1],P[2],P[3]),_.push(w++,w++,w++,w++);if(t)z=R[0],_.push(ue,ue+1,ue+1,ue+1);else{let I=R[R.length-1],se=R[R.length-2];se||(se=I),z=[I[0]+I[0]-se[0],I[1]+I[1]-se[1]],_.push(w-1,w-1,w-1,w-1)}Gs(z,j,q),c.push(j.x,j.y,j.x,j.y,j.x,j.y,j.x,j.y),d.push(q.x,q.y,q.x,q.y,q.x,q.y,q.x,q.y),x.push(j.x,j.y,j.x,j.y,j.x,j.y,j.x,j.y),T.push(q.x,q.y,q.x,q.y,q.x,q.y,q.x,q.y),u.push(1,-1,2,-2),g.push(C,C,C,C),p.push(L,L,L,L),f.push(E[0],E[1],E[2],E[3],E[0],E[1],E[2],E[3],E[0],E[1],E[2],E[3],E[0],E[1],E[2],E[3]),y.push(S[0],S[1],S[2],S[3],S[0],S[1],S[2],S[3],S[0],S[1],S[2],S[3],S[0],S[1],S[2],S[3]),v.push(P[0],P[1],P[2],P[3],P[0],P[1],P[2],P[3],P[0],P[1],P[2],P[3],P[0],P[1],P[2],P[3]),M<e.length-1&&(w+=8,_.push(w,w))}}assignHandler(e){this._handler=e,this.refresh(),e.isInitialized()&&this.update()}add(e){if(e._handlerIndex===-1){e._handler=this,e._handlerIndex=this._geometries.length,this._geometries.push(e);let t=e._entity._pickingColor.scaleTo(1/255);if(e._polyVerticesHighMerc=[],e._polyVerticesLowMerc=[],e._lineVerticesHighMerc=[],e._lineVerticesLowMerc=[],e._coordinates[0].length){if(e.type===ni.POLYGON){let s=e._coordinates,n=[];for(let u=0;u<s.length;u++){n[u]=[];for(let _=0;_<s[u].length;_++)n[u][_]=[si(s[u][_][0]),ri(s[u][_][1])]}let o=Ln(n),a=Cn(o.vertices,o.holes,2);e._polyVerticesHandlerIndex=this._polyVerticesHighMerc.length,e._polyIndexesHandlerIndex=this._polyIndexes.length;for(let u=0;u<a.length;u++)this._polyIndexes.push(a[u]+.5*e._polyVerticesHandlerIndex);let h=e._style.fillColor,c=[],d=[];for(let u=0;u<.5*o.vertices.length;u++)this._polyColors.push(h.x,h.y,h.z,h.w),this._polyPickingColors.push(t.x,t.y,t.z,1);for(let u=0;u<o.vertices.length;u++)Tn(o.vertices[u],ze),c[u]=ze.x,d[u]=ze.y;e._polyVerticesHighMerc=c,e._polyVerticesLowMerc=d,this._polyVerticesHighMerc.push.apply(this._polyVerticesHighMerc,c),this._polyVerticesLowMerc.push.apply(this._polyVerticesLowMerc,d),e._polyVerticesLength=o.vertices.length,e._polyIndexesLength=a.length,e._lineVerticesHandlerIndex=this._lineVerticesHighMerc.length,e._lineOrdersHandlerIndex=this._lineOrders.length,e._lineIndexesHandlerIndex=this._lineIndexes.length,e._lineColorsHandlerIndex=this._lineColors.length,e._lineThicknessHandlerIndex=this._lineThickness.length,ir.appendLineData(n,!0,e._style.lineColor,t,e._style.lineWidth,e._style.strokeColor,e._style.strokeWidth,this._lineVerticesHighMerc,this._lineVerticesLowMerc,this._lineOrders,this._lineIndexes,this._lineColors,this._linePickingColors,this._lineThickness,this._lineStrokeColors,this._lineStrokes,e._lineVerticesHighMerc,e._lineVerticesLowMerc),e._lineVerticesLength=this._lineVerticesHighMerc.length-e._lineVerticesHandlerIndex,e._lineOrdersLength=this._lineOrders.length-e._lineOrdersHandlerIndex,e._lineIndexesLength=this._lineIndexes.length-e._lineIndexesHandlerIndex,e._lineColorsLength=this._lineColors.length-e._lineColorsHandlerIndex,e._lineThicknessLength=this._lineThickness.length-e._lineThicknessHandlerIndex}else if(e.type===ni.MULTIPOLYGON){let s=e._coordinates,n=[],o=[];e._lineVerticesHandlerIndex=this._lineVerticesHighMerc.length,e._lineOrdersHandlerIndex=this._lineOrders.length,e._lineIndexesHandlerIndex=this._lineIndexes.length,e._lineColorsHandlerIndex=this._lineColors.length,e._lineThicknessHandlerIndex=this._lineThickness.length;for(let d=0;d<s.length;d++){let u=s[d],_=[];for(let g=0;g<u.length;g++){_[g]=[];for(let y=0;y<s[d][g].length;y++)_[g][y]=[si(u[g][y][0]),ri(u[g][y][1])]}let f=Ln(_),v=Cn(f.vertices,f.holes,2);for(let g=0;g<v.length;g++)o.push(v[g]+.5*n.length);n.push.apply(n,f.vertices),ir.appendLineData(_,!0,e._style.lineColor,t,e._style.lineWidth,e._style.strokeColor,e._style.strokeWidth,this._lineVerticesHighMerc,this._lineVerticesLowMerc,this._lineOrders,this._lineIndexes,this._lineColors,this._linePickingColors,this._lineThickness,this._lineStrokeColors,this._lineStrokes,e._lineVerticesHighMerc,e._lineVerticesLowMerc)}e._polyVerticesHandlerIndex=this._polyVerticesHighMerc.length,e._polyIndexesHandlerIndex=this._polyIndexes.length;for(let d=0;d<o.length;d++)this._polyIndexes.push(o[d]+.5*e._polyVerticesHandlerIndex);let a=e._style.fillColor,h=[],c=[];for(let d=0;d<.5*n.length;d++)this._polyColors.push(a.x,a.y,a.z,a.w),this._polyPickingColors.push(t.x,t.y,t.z,1);for(let d=0;d<n.length;d++)Tn(n[d],ze),h[d]=ze.x,c[d]=ze.y;e._polyVerticesHighMerc=h,e._polyVerticesLowMerc=c,this._polyVerticesHighMerc.push.apply(this._polyVerticesHighMerc,h),this._polyVerticesLowMerc.push.apply(this._polyVerticesLowMerc,c),e._polyVerticesLength=n.length,e._polyIndexesLength=o.length,e._lineVerticesLength=this._lineVerticesHighMerc.length-e._lineVerticesHandlerIndex,e._lineOrdersLength=this._lineOrders.length-e._lineOrdersHandlerIndex,e._lineIndexesLength=this._lineIndexes.length-e._lineIndexesHandlerIndex,e._lineColorsLength=this._lineColors.length-e._lineColorsHandlerIndex,e._lineThicknessLength=this._lineThickness.length-e._lineThicknessHandlerIndex}else if(e.type===ni.LINESTRING){let s=e._coordinates,n=new Array(s.length);for(let o=0;o<s.length;o++)n[o]=[si(s[o][0]),ri(s[o][1])];e._lineVerticesHandlerIndex=this._lineVerticesHighMerc.length,e._lineOrdersHandlerIndex=this._lineOrders.length,e._lineIndexesHandlerIndex=this._lineIndexes.length,e._lineColorsHandlerIndex=this._lineColors.length,e._lineThicknessHandlerIndex=this._lineThickness.length,ir.appendLineData([n],!1,e._style.lineColor,t,e._style.lineWidth,e._style.strokeColor,e._style.strokeWidth,this._lineVerticesHighMerc,this._lineVerticesLowMerc,this._lineOrders,this._lineIndexes,this._lineColors,this._linePickingColors,this._lineThickness,this._lineStrokeColors,this._lineStrokes,e._lineVerticesHighMerc,e._lineVerticesLowMerc),e._lineVerticesLength=this._lineVerticesHighMerc.length-e._lineVerticesHandlerIndex,e._lineOrdersLength=this._lineOrders.length-e._lineOrdersHandlerIndex,e._lineIndexesLength=this._lineIndexes.length-e._lineIndexesHandlerIndex,e._lineColorsLength=this._lineColors.length-e._lineColorsHandlerIndex,e._lineThicknessLength=this._lineThickness.length-e._lineThicknessHandlerIndex}else if(e.type===ni.MULTILINESTRING){let s=e._coordinates,n=[];for(let o=0;o<s.length;o++){n[o]=[];for(let a=0;a<s[o].length;a++)n[o][a]=[si(s[o][a][0]),ri(s[o][a][1])]}e._lineVerticesHandlerIndex=this._lineVerticesHighMerc.length,e._lineOrdersHandlerIndex=this._lineOrders.length,e._lineIndexesHandlerIndex=this._lineIndexes.length,e._lineColorsHandlerIndex=this._lineColors.length,e._lineThicknessHandlerIndex=this._lineThickness.length,ir.appendLineData(n,!1,e._style.lineColor,t,e._style.lineWidth,e._style.strokeColor,e._style.strokeWidth,this._lineVerticesHighMerc,this._lineVerticesLowMerc,this._lineOrders,this._lineIndexes,this._lineColors,this._linePickingColors,this._lineThickness,this._lineStrokeColors,this._lineStrokes,e._lineVerticesHighMerc,e._lineVerticesLowMerc),e._lineVerticesLength=this._lineVerticesHighMerc.length-e._lineVerticesHandlerIndex,e._lineOrdersLength=this._lineOrders.length-e._lineOrdersHandlerIndex,e._lineIndexesLength=this._lineIndexes.length-e._lineIndexesHandlerIndex,e._lineColorsLength=this._lineColors.length-e._lineColorsHandlerIndex,e._lineThicknessLength=this._lineThickness.length-e._lineThicknessHandlerIndex}}this.setGeometryVisibility(e),!this._updatedGeometry[e.__id]&&this._updatedGeometryArr.push(e),this._updatedGeometry[e.__id]=!0,this.refresh()}}remove(e){const t=e._handlerIndex;if(t!==-1){this._geometries.splice(t,1),this._polyVerticesHighMerc.splice(e._polyVerticesHandlerIndex,e._polyVerticesLength),this._polyVerticesLowMerc.splice(e._polyVerticesHandlerIndex,e._polyVerticesLength),this._polyColors.splice(2*e._polyVerticesHandlerIndex,2*e._polyVerticesLength),this._polyPickingColors.splice(2*e._polyVerticesHandlerIndex,2*e._polyVerticesLength),this._polyIndexes.splice(e._polyIndexesHandlerIndex,e._polyIndexesLength);let s=.5*e._polyVerticesLength;for(let o=e._polyIndexesHandlerIndex;o<this._polyIndexes.length;o++)this._polyIndexes[o]-=s;this._lineVerticesHighMerc.splice(e._lineVerticesHandlerIndex,e._lineVerticesLength),this._lineVerticesLowMerc.splice(e._lineVerticesHandlerIndex,e._lineVerticesLength),this._lineOrders.splice(e._lineOrdersHandlerIndex,e._lineOrdersLength),this._lineColors.splice(e._lineColorsHandlerIndex,e._lineColorsLength),this._linePickingColors.splice(e._lineColorsHandlerIndex,e._lineColorsLength),this._lineStrokeColors.splice(e._lineColorsHandlerIndex,e._lineColorsLength),this._lineThickness.splice(e._lineThicknessHandlerIndex,e._lineThicknessLength),this._lineStrokes.splice(e._lineThicknessHandlerIndex,e._lineThicknessLength),this._lineIndexes.splice(e._lineIndexesHandlerIndex,e._lineIndexesLength),s=.5*e._lineVerticesLength;for(let o=e._lineIndexesHandlerIndex;o<this._lineIndexes.length;o++)this._lineIndexes[o]-=s;let n=this._geometries;for(let o=t;o<n.length;o++){let a=n[o];a._handlerIndex=o,a._polyVerticesHandlerIndex-=e._polyVerticesLength,a._polyIndexesHandlerIndex-=e._polyIndexesLength,a._lineVerticesHandlerIndex-=e._lineVerticesLength,a._lineOrdersHandlerIndex-=e._lineOrdersLength,a._lineColorsHandlerIndex-=e._lineColorsLength,a._lineThicknessHandlerIndex-=e._lineThicknessLength,a._lineIndexesHandlerIndex-=e._lineIndexesLength}e._pickingReady=!1,e._handler=null,e._handlerIndex=-1,e._polyVerticesHighMerc=[],e._polyVerticesLowMerc=[],e._polyVerticesLength=-1,e._polyIndexesLength=-1,e._polyVerticesHandlerIndex=-1,e._polyIndexesHandlerIndex=-1,e._lineVerticesHighMerc=[],e._lineVerticesLowMerc=[],e._lineVerticesLength=-1,e._lineOrdersLength=-1,e._lineIndexesLength=-1,e._lineColorsLength=-1,e._lineThicknessLength=-1,e._lineVerticesHandlerIndex=-1,e._lineOrdersHandlerIndex=-1,e._lineIndexesHandlerIndex=-1,e._lineThicknessHandlerIndex=-1,e._lineColorsHandlerIndex=-1,!this._removeGeometryExtents[e.__id]&&this._removeGeometryExtentArr.push(e.getExtent()),this._removeGeometryExtents[e.__id]=!0,this.refresh()}}_refreshRecursevely(e,t){if(t.ready){let s=this._layer._id;for(let n=0;n<t.nodes.length;n++){let o=t.nodes[n];if(e.overlaps(o.segment.getExtentLonLat())){this._refreshRecursevely(e,o);let a=o.segment.materials[s];a&&a.isReady&&(a.segment.node.getState()!==1?a.layer.clearMaterial(a):(a.pickingReady=a.pickingReady&&e._pickingReady,a.isReady=!1,a._updateTexture=a.texture,a._updatePickingMask=a.pickingMask),e._pickingReady=!0)}}}}_refreshRecursevelyExt(e,t){if(t.ready){let s=this._layer.__id;for(let n=0;n<t.nodes.length;n++){let o=t.nodes[n];if(e.overlaps(o.segment.getExtentLonLat())){this._refreshRecursevelyExt(e,o);let a=o.segment.materials[s];a&&a.isReady&&a.layer.clearMaterial(a)}}}}_refreshPlanetNode(e){let t,s=this._removeGeometryExtentArr;for(t=0;t<s.length;t++)this._refreshRecursevelyExt(s[t],e);let n=this._updatedGeometryArr;for(t=0;t<n.length;t++)this._refreshRecursevely(n[t],e)}_updatePlanet(){let e=this._layer._planet;if(e){let t=e.quadTreeStrategy.quadTreeList;for(let s=0;s<t.length;s++)this._refreshPlanetNode(t[s])}this._updatedGeometryArr.length=0,this._updatedGeometryArr=[],this._updatedGeometry={},this._removeGeometryExtentArr.length=0,this._removeGeometryExtentArr=[],this._removeGeometryExtents={}}refresh(){let e=this._changedBuffers.length;for(;e--;)this._changedBuffers[e]=!0}update(){if(this._handler){let e=!1,t=this._changedBuffers.length;for(;t--;)this._changedBuffers[t]&&(e=!0,this._buffersUpdateCallbacks[t].call(this),this._changedBuffers[t]=!1);e&&this._updatePlanet()}}setGeometryVisibility(e){let t=e.getVisibility()?1:0,s=this._polyVerticesHighMerc,n=this._polyVerticesLowMerc,o=e._polyVerticesLength,a=e._polyVerticesHandlerIndex;for(let h=0;h<o;h++)s[a+h]=e._polyVerticesHighMerc[h]*t,n[a+h]=e._polyVerticesLowMerc[h]*t;s=this._lineVerticesHighMerc,n=this._lineVerticesLowMerc,o=e._lineVerticesLength,a=e._lineVerticesHandlerIndex;for(let h=0;h<o;h++)s[a+h]=e._lineVerticesHighMerc[h]*t,n[a+h]=e._lineVerticesLowMerc[h]*t;this._changedBuffers[0]=!0,this._changedBuffers[3]=!0,!this._updatedGeometry[e.__id]&&this._updatedGeometryArr.push(e),this._updatedGeometry[e.__id]=!0}setPolyColorArr(e,t){let s=2*e._polyVerticesHandlerIndex,n=s+2*e._polyVerticesLength,o=this._polyColors;for(let a=s;a<n;a+=4)o[a]=t.x,o[a+1]=t.y,o[a+2]=t.z,o[a+3]=t.w;this._changedBuffers[2]=!0,!this._updatedGeometry[e.__id]&&this._updatedGeometryArr.push(e),this._updatedGeometry[e.__id]=!0}setLineStrokeColorArr(e,t){let s=e._lineColorsHandlerIndex,n=s+e._lineColorsLength,o=this._lineStrokeColors;for(let a=s;a<n;a+=4)o[a]=t.x,o[a+1]=t.y,o[a+2]=t.z,o[a+3]=t.w;this._changedBuffers[9]=!0,!this._updatedGeometry[e.__id]&&this._updatedGeometryArr.push(e),this._updatedGeometry[e.__id]=!0}setLineColorArr(e,t){let s=e._lineColorsHandlerIndex,n=s+e._lineColorsLength,o=this._lineColors;for(let a=s;a<n;a+=4)o[a]=t.x,o[a+1]=t.y,o[a+2]=t.z,o[a+3]=t.w;this._changedBuffers[6]=!0,!this._updatedGeometry[e.__id]&&this._updatedGeometryArr.push(e),this._updatedGeometry[e.__id]=!0}setLineStrokeArr(e,t){}setLineThicknessArr(e,t){let s=e._lineThicknessHandlerIndex,n=s+e._lineThicknessLength,o=this._lineThickness;for(let a=s;a<n;a++)o[a]=t;this._changedBuffers[7]=!0,!this._updatedGeometry[e.__id]&&this._updatedGeometryArr.push(e),this._updatedGeometry[e.__id]=!0}bringToFront(e){let t=this._polyIndexes.splice(e._polyIndexesHandlerIndex,e._polyIndexesLength),s=this._lineIndexes.splice(e._lineIndexesHandlerIndex,e._lineIndexesLength);this._geometries.splice(e._handlerIndex,1);let n=this._geometries;for(let o=e._handlerIndex;o<n.length;o++){let a=n[o];a._handlerIndex=o,a._polyIndexesHandlerIndex-=e._polyIndexesLength,a._lineIndexesHandlerIndex-=e._lineIndexesLength}e._polyIndexesHandlerIndex=this._polyIndexes.length,e._lineIndexesHandlerIndex=this._lineIndexes.length,e._handlerIndex=this._geometries.length,this._geometries.push(e),this._polyIndexes.push.apply(this._polyIndexes,t),this._lineIndexes.push.apply(this._lineIndexes,s),this._changedBuffers[1]=!0,this._changedBuffers[4]=!0,!this._updatedGeometry[e.__id]&&this._updatedGeometryArr.push(e),this._updatedGeometry[e.__id]=!0}createPolyVerticesBuffer(){let e=this._handler;e.gl.deleteBuffer(this._polyVerticesHighBufferMerc),this._polyVerticesHighBufferMerc=e.createArrayBuffer(new Float32Array(this._polyVerticesHighMerc),2,this._polyVerticesHighMerc.length/2),e.gl.deleteBuffer(this._polyVerticesLowBufferMerc),this._polyVerticesLowBufferMerc=e.createArrayBuffer(new Float32Array(this._polyVerticesLowMerc),2,this._polyVerticesLowMerc.length/2)}createPolyIndexesBuffer(){let e=this._handler;e.gl.deleteBuffer(this._polyIndexesBuffer),this._polyIndexesBuffer=e.createElementArrayBuffer(new Uint32Array(this._polyIndexes),1,this._polyIndexes.length)}createPolyColorsBuffer(){let e=this._handler;e.gl.deleteBuffer(this._polyColorsBuffer),this._polyColorsBuffer=e.createArrayBuffer(new Float32Array(this._polyColors),4,this._polyColors.length/4)}createPolyPickingColorsBuffer(){let e=this._handler;e.gl.deleteBuffer(this._polyPickingColorsBuffer),this._polyPickingColorsBuffer=e.createArrayBuffer(new Float32Array(this._polyPickingColors),4,this._polyPickingColors.length/4)}createLineVerticesBuffer(){let e=this._handler;e.gl.deleteBuffer(this._lineVerticesHighBufferMerc),this._lineVerticesHighBufferMerc=e.createArrayBuffer(new Float32Array(this._lineVerticesHighMerc),2,this._lineVerticesHighMerc.length/2),e.gl.deleteBuffer(this._lineVerticesLowBufferMerc),this._lineVerticesLowBufferMerc=e.createArrayBuffer(new Float32Array(this._lineVerticesLowMerc),2,this._lineVerticesLowMerc.length/2)}createLineIndexesBuffer(){let e=this._handler;e.gl.deleteBuffer(this._lineIndexesBuffer),this._lineIndexesBuffer=e.createElementArrayBuffer(new Uint32Array(this._lineIndexes),1,this._lineIndexes.length)}createLineOrdersBuffer(){let e=this._handler;e.gl.deleteBuffer(this._lineOrdersBuffer),this._lineOrdersBuffer=e.createArrayBuffer(new Float32Array(this._lineOrders),1,this._lineOrders.length/2)}createLineColorsBuffer(){let e=this._handler;e.gl.deleteBuffer(this._lineColorsBuffer),this._lineColorsBuffer=e.createArrayBuffer(new Float32Array(this._lineColors),4,this._lineColors.length/4)}createLinePickingColorsBuffer(){let e=this._handler;e.gl.deleteBuffer(this._linePickingColorsBuffer),this._linePickingColorsBuffer=e.createArrayBuffer(new Float32Array(this._linePickingColors),4,this._linePickingColors.length/4)}createLineThicknessBuffer(){let e=this._handler;e.gl.deleteBuffer(this._lineThicknessBuffer),this._lineThicknessBuffer=e.createArrayBuffer(new Float32Array(this._lineThickness),1,this._lineThickness.length)}createLineStrokesBuffer(){let e=this._handler;e.gl.deleteBuffer(this._lineStrokesBuffer),this._lineStrokesBuffer=e.createArrayBuffer(new Float32Array(this._lineStrokes),1,this._lineStrokes.length)}createLineStrokeColorsBuffer(){let e=this._handler;e.gl.deleteBuffer(this._lineStrokeColorsBuffer),this._lineStrokeColorsBuffer=e.createArrayBuffer(new Float32Array(this._lineStrokeColors),4,this._lineStrokeColors.length/4)}clear(){this._geometries=[],this._polyVerticesHighMerc=[],this._polyVerticesLowMerc=[],this._polyIndexes=[],this._polyColors=[],this._polyPickingColors=[],this._lineVerticesHighMerc=[],this._lineVerticesLowMerc=[],this._lineOrders=[],this._lineIndexes=[],this._lineColors=[],this._linePickingColors=[],this._lineThickness=[],this._lineStrokeColors=[],this._lineStrokes=[],this._deleteBuffers(),this._polyVerticesHighBufferMerc=null,this._polyVerticesLowBufferMerc=null,this._polyIndexesBuffer=null,this._polyColorsBuffer=null,this._polyPickingColorsBuffer=null,this._lineVerticesHighBufferMerc=null,this._lineVerticesLowBufferMerc=null,this._lineIndexesBuffer=null,this._lineOrdersBuffer=null,this._lineColorsBuffer=null,this._linePickingColorsBuffer=null,this._lineThicknessBuffer=null,this._lineStrokeColorsBuffer=null,this._lineStrokesBuffer=null,this._updatedGeometryArr=[],this._updatedGeometry={},this._removeGeometryExtentArr=[],this._removeGeometryExtents={},this.refresh()}_deleteBuffers(){if(this._layer._planet&&this._layer._planet.renderer){let e=this._layer._planet.renderer.handler.gl;e&&(e.deleteBuffer(this._polyVerticesHighBufferMerc),e.deleteBuffer(this._polyVerticesLowBufferMerc),e.deleteBuffer(this._polyIndexesBuffer),e.deleteBuffer(this._polyColorsBuffer),e.deleteBuffer(this._polyPickingColorsBuffer),e.deleteBuffer(this._lineVerticesHighBufferMerc),e.deleteBuffer(this._lineVerticesLowBufferMerc),e.deleteBuffer(this._lineIndexesBuffer),e.deleteBuffer(this._lineOrdersBuffer),e.deleteBuffer(this._lineColorsBuffer),e.deleteBuffer(this._linePickingColorsBuffer),e.deleteBuffer(this._lineThicknessBuffer),e.deleteBuffer(this._lineStrokeColorsBuffer),e.deleteBuffer(this._lineStrokesBuffer))}}};fe.__counter__=0;let Rr=fe;class ut extends It{constructor(e,t={}){super(e,t),this.events=this.events.registerNames(_l),this.isVector=!0,this._hasImageryTiles=!1,this.scaleByDistance=t.scaleByDistance||[Ee,Ee,Ee],this._useLighting=t.useLighting===void 0||t.useLighting;let s=new Float32Array([1,1,1]);t.pickingScale!==void 0&&(t.pickingScale instanceof Array?(s[0]=t.pickingScale[0]||s[0],s[1]=t.pickingScale[1]||s[1],s[2]=t.pickingScale[2]||s[2]):typeof t.pickingScale=="number"&&(s[0]=t.pickingScale,s[1]=t.pickingScale,s[2]=t.pickingScale)),this.pickingScale=s,this.async=t.async===void 0||t.async,this.clampToGround=t.clampToGround||!1,this.relativeToGround=t.relativeToGround||!1,this._entities=function(n){let o=[];for(let a=0;a<n.length;a++){let h=n[a];h.instanceName==="Entity"?o.push(h):o.push(new V(h))}return o}(t.entities||[]),this._labelMaxLetters=t.labelMaxLetters||24,this._stripEntityCollection=new ee({pickingEnabled:this.pickingEnabled}),this._bindEventsDefault(this._stripEntityCollection),this._polylineEntityCollection=new ee({pickingEnabled:this.pickingEnabled}),this._bindEventsDefault(this._polylineEntityCollection),this._geoObjectEntityCollection=new ee({pickingEnabled:this.pickingEnabled,useLighting:this._useLighting}),this._bindEventsDefault(this._geoObjectEntityCollection),this._geometryHandler=new Rr(this),this._nodeCapacity=t.nodeCapacity||60,this._entityCollectionsTreeStrategy=null,this.setEntities(this._entities),this.polygonOffsetUnits=t.polygonOffsetUnits!=null?t.polygonOffsetUnits:0,this.pickingEnabled=this._pickingEnabled,this._depthOrder=t.depthOrder||0}get depthOrder(){return this._depthOrder}set depthOrder(e){e!==this._depthOrder&&(this._depthOrder=e,this._planet&&this._planet.updateVisibleLayers())}get useLighting(){return this._useLighting}set useLighting(e){e!==this._useLighting&&(this._geoObjectEntityCollection.useLighting=e,this._useLighting=e)}get labelMaxLetters(){return this._labelMaxLetters}get instanceName(){return"Vector"}_bindPicking(){this._pickingColor.clear()}addTo(e){this._planet||(this._assignPlanet(e),this._geometryHandler.assignHandler(e.renderer.handler),this._polylineEntityCollection.addTo(e,!0),this._stripEntityCollection.addTo(e,!0),this._geoObjectEntityCollection.addTo(e,!0),this._polylineEntityCollection._layer=this,this._stripEntityCollection._layer=this,this._geoObjectEntityCollection._layer=this,this.setEntities(this._entities))}remove(){return super.remove(),this._polylineEntityCollection.remove(),this._stripEntityCollection.remove(),this._geoObjectEntityCollection.remove(),this._polylineEntityCollection._layer=void 0,this._stripEntityCollection._layer=void 0,this._geoObjectEntityCollection._layer=void 0,this}getEntities(){return[].concat(this._entities)}add(e){return e._layer||e._entityCollection||(e._layer=this,e._layerIndex=this._entities.length,this._entities.push(e),this._proceedEntity(e)),this}insert(e,t){if(!e._layer&&!e._entityCollection){e._layer=this,e._layerIndex=t,this._entities.splice(t,0,e);for(let s=t+1,n=this._entities.length;s<n;s++)this._entities[s]._layerIndex=s;this._proceedEntity(e)}return this}_proceedEntity(e){var t;let s=this._hasImageryTiles;e.strip&&this._stripEntityCollection.add(e),(e.polyline||e.ray)&&this._polylineEntityCollection.add(e),(e.geoObject||e.isEmpty)&&this._geoObjectEntityCollection.add(e),e.geometry&&(this._hasImageryTiles=!0,this._planet&&(this._planet.renderer.assignPickingColor(e),this._geometryHandler.add(e.geometry))),this._planet&&((e.billboard||e.label||e.geoObject||e.isEmpty)&&(e._cartesian.isZero()&&!e._lonLat.isZero()?e._setCartesian3vSilent(this._planet.ellipsoid.lonLatToCartesian(e._lonLat)):(e._lonLat=this._planet.ellipsoid.cartesianToLonLat(e._cartesian),Math.abs(e._lonLat.lat)<ht?e._lonLatMerc=e._lonLat.forwardMercator():e._lonLatMerc.lon=e._lonLatMerc.lat=e._lonLatMerc.height=0)),(e.billboard||e.label)&&((t=this._entityCollectionsTreeStrategy)==null||t.insertEntity(e))),this._planet&&this._hasImageryTiles!==s&&this._planet.updateVisibleLayers(),this.events.dispatch(this.events.entityadd,e)}addEntities(e){let t=e.length;for(;t--;)this.add(e[t]);return this}removeEntity(e){if(e._layer&&this.isEqual(e._layer)){if(e.parent||(this._entities.splice(e._layerIndex,1),this._reindexEntitiesArray(e._layerIndex)),e._layer=null,e._layerIndex=-1,e._entityCollection){e._entityCollection._removeEntitySilent(e);let t=e._nodePtr;for(;t;)t.count--,t=t.parentNode;e._nodePtr&&e._nodePtr.count===0&&e._nodePtr.deferredEntities.length===0&&(e._nodePtr.entityCollection=null)}else if(e._nodePtr&&e._nodePtr.deferredEntities.length){let t=e._nodePtr.deferredEntities,s=t.length;for(;s--;)if(t[s].id===e.id){t.splice(s,1);let n=e._nodePtr;for(;n;)n.count--,n=n.parentNode;break}}this._planet&&e.geometry&&(this._geometryHandler.remove(e.geometry),this._planet.renderer.clearPickingColor(e)),e._nodePtr=void 0,this.events.dispatch(this.events.entityremove,e)}return this}set pickingEnabled(e){var t;this._pickingEnabled=e,this._stripEntityCollection.setPickingEnabled(e),this._polylineEntityCollection.setPickingEnabled(e),this._geoObjectEntityCollection.setPickingEnabled(e),(t=this._entityCollectionsTreeStrategy)==null||t.setPickingEnabled(e)}_reindexEntitiesArray(e){const t=this._entities;for(let s=e;s<t.length;s++)t[s]._layerIndex=s}removeEntities(e){let t=e.length;for(;t--;)this.removeEntity(e[t]);return this}clear(){var e;super.clear();let t=new Array(this._entities.length);for(let n=0;n<t.length;n++)t[n]=this._entities[n];let s=this._entities.length;for(;s--;)this._entities[s].remove();this._entities.length=0,this._entities=[];for(let n=0;n<t.length;n++)this._entities[n]=t[n];(e=this._entityCollectionsTreeStrategy)==null||e.dispose(),this._entityCollectionsTreeStrategy=null,this._geometryHandler.clear()}each(e){let t=this._entities,s=t.length;for(;s--;)e(t[s],s)}setEntities(e){let t=new Array(e.length);for(let n=0,o=e.length;n<o;n++)t[n]=e[n];this.clear(),this._entities=new Array(t.length);let s=[];for(let n=0;n<t.length;n++){let o=t[n];o._layer=this,o._layerIndex=n;let a=!(o.strip||o.polyline||o.ray||o.geoObject||o.billboard||o.label);o.strip?this._stripEntityCollection.add(o):o.polyline||o.ray?this._polylineEntityCollection.add(o):o.geoObject||a?this._geoObjectEntityCollection.add(o):(o.billboard||o.label)&&s.push(o),o.geometry&&(this._hasImageryTiles=!0,this._planet&&(this._planet.renderer.assignPickingColor(o),this._geometryHandler.add(o.geometry))),this._entities[n]=o}return this._createEntityCollectionsTree(s),this}_createEntityCollectionsTree(e){this._planet&&(this._entityCollectionsTreeStrategy=this._planet.quadTreeStrategy.createEntityCollectionsTreeStrategy(this,this._nodeCapacity),this._entityCollectionsTreeStrategy.insertEntities(e))}_bindEventsDefault(e){let t=this.events;e.events.on("mousemove",s=>{t.dispatch(t.mousemove,s)}),e.events.on("mouseenter",s=>{t.dispatch(t.mouseenter,s)}),e.events.on("mouseleave",s=>{t.dispatch(t.mouseleave,s)}),e.events.on("lclick",s=>{t.dispatch(t.lclick,s)}),e.events.on("rclick",s=>{t.dispatch(t.rclick,s)}),e.events.on("mclick",s=>{t.dispatch(t.mclick,s)}),e.events.on("ldblclick",s=>{t.dispatch(t.ldblclick,s)}),e.events.on("rdblclick",s=>{t.dispatch(t.rdblclick,s)}),e.events.on("mdblclick",s=>{t.dispatch(t.mdblclick,s)}),e.events.on("lup",s=>{t.dispatch(t.lup,s)}),e.events.on("rup",s=>{t.dispatch(t.rup,s)}),e.events.on("mup",s=>{t.dispatch(t.mup,s)}),e.events.on("ldown",s=>{t.dispatch(t.ldown,s)}),e.events.on("rdown",s=>{t.dispatch(t.rdown,s)}),e.events.on("mdown",s=>{t.dispatch(t.mdown,s)}),e.events.on("lhold",s=>{t.dispatch(t.lhold,s)}),e.events.on("rhold",s=>{t.dispatch(t.rhold,s)}),e.events.on("mhold",s=>{t.dispatch(t.mhold,s)}),e.events.on("mousewheel",s=>{t.dispatch(t.mousewheel,s)}),e.events.on("touchmove",s=>{t.dispatch(t.touchmove,s)}),e.events.on("touchstart",s=>{t.dispatch(t.touchstart,s)}),e.events.on("touchend",s=>{t.dispatch(t.touchend,s)}),e.events.on("doubletouch",s=>{t.dispatch(t.doubletouch,s)}),e.events.on("touchleave",s=>{t.dispatch(t.touchleave,s)}),e.events.on("touchenter",s=>{t.dispatch(t.touchenter,s)})}_collectStripCollectionPASS(e){let t=this._stripEntityCollection;t._fadingOpacity=this._fadingOpacity,t.scaleByDistance=this.scaleByDistance,t.pickingScale=this.pickingScale,t.polygonOffsetUnits=this.polygonOffsetUnits,e.push(t)}_collectPolylineCollectionPASS(e){let t=this._polylineEntityCollection;if(t._fadingOpacity=this._fadingOpacity,t.scaleByDistance=this.scaleByDistance,t.pickingScale=this.pickingScale,t.polygonOffsetUnits=this.polygonOffsetUnits,e.push(t),this.clampToGround||this.relativeToGround){let s=Number(this.relativeToGround);const n=this._planet.quadTreeStrategy._renderedNodes,o=this._planet.getViewExtent();let a=t._entities,h=a.length,c=new m;for(;h--;){let d=a[h]._altitude||0,u=a[h].polyline;if(u&&o.overlaps(u._extent)){let _=u._pathLonLatMerc,f=_.length;for(;f--;){let v=_[f].length;for(;v--;){let g=_[f][v],y=n.length;for(;y--;){let p=n[y].segment;if(p._extent.isInside(g)){let x=u._path3v[f][v];p.getTerrainPoint(x,g,c);let T=s&&u.altitude||d;if(T){let w=this._planet.ellipsoid.getSurfaceNormal3v(c);u.setPoint3v(c.addA(w.scale(T)),v,f,!0)}else u.setPoint3v(c,v,f,!0);break}}}}}}}}_collectGeoObjectCollectionPASS(e){let t=this._geoObjectEntityCollection;t._fadingOpacity=this._fadingOpacity,t.scaleByDistance=this.scaleByDistance,t.pickingScale=this.pickingScale,t.polygonOffsetUnits=this.polygonOffsetUnits,e.push(t)}collectVisibleCollections(e){let t=this._planet;(this._fading&&this._fadingOpacity>0||this.minZoom<=t.quadTreeStrategy.maxCurrZoom&&this.maxZoom>=t.quadTreeStrategy.maxCurrZoom)&&(this._collectStripCollectionPASS(e),this._collectPolylineCollectionPASS(e),this._collectGeoObjectCollectionPASS(e),this._entityCollectionsTreeStrategy&&this._entityCollectionsTreeStrategy.collectVisibleEntityCollections(e))}loadMaterial(e){const t=e.segment;this._isBaseLayer?e.texture=t._isNorth?t.planet.solidTextureOne:t.planet.solidTextureTwo:e.texture=t.planet.transparentTexture,this._planet.layerLock.isFree()&&(e.isReady=!1,e.isLoading=!0,this._planet._vectorTileCreator.add(e))}abortMaterialLoading(e){e.isLoading=!1,e.isReady=!1}applyMaterial(e){if(e.isReady)return[0,0,1,1];{!e.isLoading&&this.loadMaterial(e);const t=e.segment;let s=t.node,n=!1,o=this.__id,a=e;for(;s.parentNode;){if(a&&a.isReady){n=!0;break}s=s.parentNode,a=s.segment.materials[o]}if(n){e.appliedNodeId=s.nodeId,e.texture=a.texture,e.pickingMask=a.pickingMask;const h=1/(2<<t.tileZoom-s.segment.tileZoom-1);return[t.tileX*h-s.segment.tileX,t.tileY*h-s.segment.tileY,h,h]}return e.textureExists&&e._updateTexture?(e.texture=e._updateTexture,e.pickingMask=e._updatePickingMask):(e.texture=t.planet.transparentTexture,e.pickingMask=t.planet.transparentTexture),e.pickingReady=!0,[0,0,1,1]}}clearMaterial(e){if(e.isReady){const t=e.segment.handler.gl;e.isReady=!1,e.pickingReady=!1;let s=e.texture;e.texture=null,s&&!s.default&&t.deleteTexture(s),s=e.pickingMask,e.pickingMask=null,s&&!s.default&&t.deleteTexture(s),s=e._updateTexture,e._updateTexture=null,s&&!s.default&&t.deleteTexture(s),s=e._updatePickingMask,e._updatePickingMask=null,s&&!s.default&&t.deleteTexture(s)}this.abortMaterialLoading(e),e.isLoading=!1,e.textureExists=!1}update(){this._geometryHandler.update(),this.events.dispatch(this.events.draw,this)}}const _l=["draw","entityadd","entityremove"],fl=["change","startpoint"],Pn=W.createCylinder(1,1,2,20,1,!0,!1,0,-.5,0),Bt=200,_i=.3;class sa extends ce{constructor(e){super(e.name),this._cornerDblClick=!1,this._onChange=t=>{if(t.geometryType==="POLYGON"){let s=this.getCoordinates(),n=new V({geometry:{type:t.geometryType,coordinates:[s],style:this._fillStyle}});this._geometryLayer.clear(),this._geometryLayer.add(n)}},this._onCornerMouseEnter=t=>{t.renderer.handler.canvas.style.cursor="pointer",this.hideGhostPointer()},this._onCornerMouseLeave=t=>{t.renderer.handler.canvas.style.cursor="default",this.showGhostPointer()},this._onCenterMouseEnter=t=>{t.renderer.handler.canvas.style.cursor="pointer",this.hideGhostPointer()},this._onCenterMouseLeave=t=>{t.renderer.handler.canvas.style.cursor="default",this._pickedCenter||this._pickedCorner||this.showGhostPointer()},this._onLup=t=>{this._planet.renderer.controls.mouseNavigation.activate(),(this._pickedCorner||this._pickedCenter)&&(this.events.dispatch(this.events.change,this),this.setGhostPointerPosition(this._planet.getCartesianFromPixelTerrain(t)),this.showGhostPointer(),this._pickedCorner=null,this._pickedCenter=null)},this._onCornerLdown=t=>{this._pickedCorner=this._getLdown(t)},this._onCenterLdown=t=>{this._pickedCenter=this._getLdown(t)},this._onMouseMove=t=>{this._pickedCenter?this._moveCenterPoint():this._pickedCorner?this._moveCornerPoint(t.pos):this.setGhostPointerPosition(this._planet.getCartesianFromPixelTerrain(t.pos))},this._onCornerLdblclick=t=>{this._cornerDblClick=!0;let s=this.getCoordinates();s.splice(t.pickingObject.layerIndex,1),this.setCoordinates(s)},this._onMouseDblClick=t=>{if(this._cornerDblClick)return void(this._cornerDblClick=!1);if(!this._showGhostPointer)return;let s=this._planet.getCartesianFromPixelTerrain(t);s&&(this._addNew(s),!this._isStartPoint&&this._cornerLayer.getEntities().length>2&&(this._isStartPoint=!0,this.events.dispatch(this.events.startpoint,this)),this.events.dispatch(this.events.change,this))},this.events=ot(fl),this._planet=null,this._initCoordinates=e.coordinates||[],this._pickedCorner=null,this._pickedCenter=null,this._startPos=null,this._startClick=new O,this._geometryLayer=new ut,this._cornerStyle={scale:.5,tag:"corners",color:"rgb(350, 350, 0)",object3d:Pn,...e.cornerStyle||{}},this._centerStyle={scale:.4,tag:"centers",color:"rgb(0, 350, 50)",object3d:Pn,...e.centerStyle||{}},this._outlineStyle={thickness:3.5,color:"rgb(0, 350, 50)",...e.outlineStyle||{}},this._fillStyle={fillColor:"rgba(0,146,247,0.2)",...e.fillStyle||{}},this._cornerLayer=new ut("corners",{pickingScale:3,pickingEnabled:!0,polygonOffsetUnits:-5,relativeToGround:!0,scaleByDistance:[100,4e6,1]}),this._centerLayer=new ut("centers",{pickingScale:3,pickingEnabled:!0,polygonOffsetUnits:-5,relativeToGround:!0,scaleByDistance:[100,4e6,1]}),this._outlineLayer=new ut("outline",{entities:[new V({polyline:{path3v:[],isClosed:!1,...this._outlineStyle}})],pickingEnabled:!1,polygonOffsetUnits:-5,relativeToGround:!0}),this._outlineLayer.getEntities()[0].polyline.altitude=_i,this._ghostCorner=new V({geoObject:this._cornerStyle}),this._ghostOutlineLayer=new ut("ghost-pointer",{pickingEnabled:!1,polygonOffsetUnits:-5,relativeToGround:!0,scaleByDistance:[100,4e6,1],opacity:.5}),this._showGhostPointer=!1,this._isStartPoint=!1,this._insertCornerIndex=-1}get geometryType(){return"POLYGON"}getCoordinates(){let e=this._cornerLayer.getEntities();return e.length>0?e.map(t=>{let s=t.getLonLat();return[s.lon,s.lat,s.height]}):this._initCoordinates}bindPlanet(e){this._planet=e}init(){this._initEvents(),this._initGhostLayerPointer(),this._initCoordinates.length&&this.setCoordinates(this._initCoordinates),this._planet.addLayer(this._outlineLayer),this._planet.addLayer(this._cornerLayer),this._planet.addLayer(this._centerLayer),this.showGhostPointer(),this.startNewPoint(),this._geometryLayer.addTo(this._planet),this.events.on("change",this._onChange,this)}onremove(){this._clearEvents(),this.hideGhostPointer(),this.stopNewPoint(),this.clear(),this._geometryLayer.remove()}clear(){this._geometryLayer.clear();let e=this._cornerLayer.getEntities(),t=e.length;for(;t--;)e[t].remove();let s=this._centerLayer.getEntities();for(t=s.length;t--;)s[t].remove();let n=this._outlineLayer.getEntities();for(t=n.length;t--;)n[t].polyline.clear(),t>0&&n[t].remove();this._clearGhostPointer()}setCoordinates(e){this.clear();for(let t=0;t<e.length;t++){let s=e[t],n=this._planet.ellipsoid.lonLatToCartesian(new A(s[0],s[1],s[2]));this._appendCart(n)}this.events.dispatch(this.events.change,this)}stopNewPoint(){this.renderer&&this.renderer.events.off("ldblclick",this._onMouseDblClick)}startNewPoint(){this.renderer.events.on("ldblclick",this._onMouseDblClick,this)}showGhostPointer(){this._showGhostPointer=!0,this._planet.addLayer(this._ghostOutlineLayer),this._insertCornerIndex=this._cornerLayer.getEntities().length}hideGhostPointer(){this._showGhostPointer=!1,this._ghostOutlineLayer.remove(),this._insertCornerIndex=-1}setGhostPointerPosition(e){e&&(this._ghostCorner.setCartesian3v(e),this._updateGhostOutlinePointer(e))}_getLdown(e){this._planet.renderer.controls.mouseNavigation.deactivate(),this._startClick.set(e.x,e.y);let t=e.pickingObject.getCartesian();return this._startPos=this._planet.getPixelFromCartesian(t),e.pickingObject}_initEvents(){this._cornerLayer.events.on("ldblclick",this._onCornerLdblclick,this),this._cornerLayer.events.on("ldown",this._onCornerLdown,this),this._centerLayer.events.on("ldown",this._onCenterLdown,this),this.renderer.events.on("lup",this._onLup,this),this.renderer.events.on("mousemove",this._onMouseMove,this),this._cornerLayer.events.on("mouseenter",this._onCornerMouseEnter,this),this._cornerLayer.events.on("mouseleave",this._onCornerMouseLeave,this),this._centerLayer.events.on("mouseenter",this._onCenterMouseEnter,this),this._centerLayer.events.on("mouseleave",this._onCenterMouseLeave,this)}_clearEvents(){this._cornerLayer.events.off("ldblclick",this._onCornerLdblclick),this._cornerLayer.events.off("ldown",this._onCornerLdown),this._centerLayer.events.off("ldown",this._onCenterLdown),this.renderer.events.off("lup",this._onLup),this.renderer.events.off("mousemove",this._onMouseMove),this._cornerLayer.events.off("mouseenter",this._onCornerMouseEnter),this._cornerLayer.events.off("mouseleave",this._onCornerMouseLeave),this._centerLayer.events.off("mouseenter",this._onCenterMouseEnter),this._centerLayer.events.off("mouseleave",this._onCenterMouseLeave)}_drawCorners(){let e=this._cornerLayer.getEntities();for(let t=0;t<e.length;t++){let s=e[t];this._checkTerrainCollision(s)}}_drawCenters(){let e=this._centerLayer.getEntities();for(let t=0;t<e.length;t++){let s=e[t];this._checkTerrainCollision(s)}}_drawGhostCorner(){this._showGhostPointer&&this._checkTerrainCollision(this._ghostCorner)}frame(){this._drawCorners(),this._drawCenters(),this._drawGhostCorner()}_checkTerrainCollision(e){let t=new m,s=this._planet.quadTreeStrategy._renderedNodes;for(let n=0;n<s.length;n++){let o=s[n].segment;if(o&&o._extentLonLat.isInside(e.getLonLat())){o.getEntityTerrainPoint(e,t),e.setCartesian3v(t);break}}}_moveCenterPoint(){let e=this.getCoordinates(),t=this._pickedCenter.layerIndex+1,s=this._pickedCenter.getLonLat(),n=[s.lon,s.lat,s.height];e.splice(t,0,n),this.setCoordinates(e),this._pickedCenter=null,this._pickedCorner=this._cornerLayer.getEntities()[t]}_addNew(e){if(this._insertCornerIndex===-1||this._cornerLayer.getEntities().length<2)this._appendCart(e);else{let t=this.getCoordinates(),s=this._insertCornerIndex,n=this._planet.ellipsoid.cartesianToLonLat(e),o=[n.lon,n.lat,n.height];t.splice(s,0,o),this.clear(),this.setCoordinates(t)}}_appendCart(e){let t=this._cornerLayer.getEntities(),s=t[t.length-1],n=new V({geoObject:this._cornerStyle});if(n.setCartesian3v(e),n.addTo(this._cornerLayer),this._checkTerrainCollision(n),s){let o=t[0].getCartesian(),a=s.getCartesian(),h=n.getCartesian().sub(a),c=n.getCartesian().sub(o),d=h.length(),u=c.length();h.normalize(),c.normalize();let _=[],f=[];for(let w=0;w<=Bt;w++){let C=h.scaleTo(w*d/Bt).addA(a);_.push(C);let E=c.scaleTo(w*u/Bt).addA(o);f.push(E)}this._outlineLayer.getEntities()[0].polyline.setPath3v([f]);let v=new V({polyline:{path3v:[_],isClosed:!1,...this._outlineStyle}});v.polyline.altitude=_i,this._outlineLayer.add(v);let g=this._centerLayer.getEntities(),y=g[g.length-1],p=h.scaleTo(.5*d).addA(a),x=c.scaleTo(.5*u).addA(o),T=new V({geoObject:this._centerStyle});T.setCartesian3v(p),T.addTo(this._centerLayer),this._checkTerrainCollision(T),y.remove(),y.addTo(this._centerLayer),y.setCartesian3v(x)}else new V({geoObject:this._centerStyle}).addTo(this._centerLayer)}_clearGhostPointer(){const e=this._ghostOutlineLayer;e.getEntities()[0].polyline.clear(),e.getEntities()[1].polyline.clear()}_moveCornerPoint(e){let t=new O(e.x,e.y).sub(this._startClick),s=this._startPos.add(t),n=this._planet.getCartesianFromPixelTerrain(s);if(n){this._pickedCorner.setCartesian3v(n);let o=this._cornerLayer.getEntities();if(o.length){let a=this._pickedCorner.layerIndex,h=o.length,c=o[a===0?h-1:a-1].getCartesian(),d=o[(a+1)%h].getCartesian(),u=this._pickedCorner.getCartesian().sub(c),_=this._pickedCorner.getCartesian().sub(d),f=u.length(),v=_.length();u.normalize(),_.normalize();let g=[],y=[];for(let P=0;P<=Bt;P++){let R=u.scaleTo(P*f/Bt).addA(c);g.push(R);let M=_.scaleTo(P*v/Bt).addA(d);y.push(M)}let p=this._outlineLayer.getEntities(),x=p[a].polyline,T=p[(a+1)%h].polyline;x==null||x.setPath3v([g]),T==null||T.setPath3v([y]);let w=this._centerLayer.getEntities(),C=w[a===0?h-1:a-1],E=w[a],L=u.scaleTo(.5*f).addA(c),S=_.scaleTo(.5*v).addA(d);C.setCartesian3v(L),this._checkTerrainCollision(C),E.setCartesian3v(S),this._checkTerrainCollision(E)}}}_updateGhostOutlinePointer(e){let t=this._cornerLayer.getEntities(),s=t.length;if(s>0){let n=0,o=yt;for(let M=0;M<s;M++){let B=t[M].getCartesian().distance(e);B<o&&(o=B,n=M)}let a=t[n].getCartesian(),h=t[(n+1)%s].getCartesian(),c=t[n===0?s-1:n-1].getCartesian().sub(a).normalize(),d=h.sub(a).normalize(),u=e.sub(a).normalize(),_=c.add(d).normalize(),f=u.cross(_),v=c.cross(d);f.dot(v)>0&&(n--,n<0&&(n=s-1));let g=new m;for(let M=0;M<s;M++)if(new Kt(t[M].getCartesian(),t[(M+1)%s].getCartesian()).getNearestDistancePoint(e,g)){let B=g.distance(e);B<o&&(o=B,n=M)}this._insertCornerIndex=(n+1)%s;let y=t[n%s].getCartesian(),p=t[(n+1)%s].getCartesian(),x=this._ghostCorner.getCartesian().sub(y),T=this._ghostCorner.getCartesian().sub(p),w=x.length(),C=T.length();x.normalize(),T.normalize();let E=[],L=[];for(let M=0;M<=Bt;M++){let B=x.scaleTo(M*w/Bt).addA(y);E.push(B);let z=T.scaleTo(M*C/Bt).addA(p);L.push(z)}let S=this._ghostOutlineLayer.getEntities(),P=S[0].polyline,R=S[1].polyline;P==null||P.setPath3v([E]),R==null||R.setPath3v([L])}}_initGhostLayerPointer(){this._ghostOutlineLayer.setEntities([new V({polyline:{path3v:[],isClosed:!1,...this._outlineStyle}}),new V({polyline:{path3v:[],isClosed:!1,...this._outlineStyle}}),this._ghostCorner]);const e=this._ghostOutlineLayer;e.getEntities()[0].polyline.altitude=e.getEntities()[1].polyline.altitude=_i}}class Sn extends sa{constructor(e){super(e)}get geometryType(){return"LineString"}_addNew(e){this._appendCart(e)}_appendCart(e){let t=this._cornerLayer.getEntities(),s=t[t.length-1],n=new V({geoObject:this._cornerStyle});if(n.setCartesian3v(e),n.addTo(this._cornerLayer),this._checkTerrainCollision(n),s){let o=s.getCartesian(),a=n.getCartesian().sub(o),h=a.length();a.normalize();let c=[];for(let f=0;f<=Bt;f++){let v=a.scaleTo(f*h/Bt).addA(o);c.push(v)}let d=new V({polyline:{path3v:[c],isClosed:!1,...this._outlineStyle}});d.polyline.altitude=_i,this._outlineLayer.add(d);let u=a.scaleTo(.5*h).addA(o),_=new V({geoObject:this._centerStyle});_.setCartesian3v(u),_.addTo(this._centerLayer),this._checkTerrainCollision(_)}}_clearGhostPointer(){this._ghostOutlineLayer.getEntities()[0].polyline.clear()}_moveCorner(e,t,s){let n=this._cornerLayer.getEntities();if(n.length==0)return;n.length==1&&(e=t=s=0);let o=n[e].getCartesian(),a=this._pickedCorner.getCartesian().sub(o),h=a.length();a.normalize();let c=[];for(let _=0;_<=Bt;_++){let f=a.scaleTo(_*h/Bt).addA(o);c.push(f)}let d=this._outlineLayer.getEntities()[t].polyline;d==null||d.setPath3v([c]);let u=this._centerLayer.getEntities()[s];if(u){let _=a.scaleTo(.5*h).addA(o);u.setCartesian3v(_),this._checkTerrainCollision(u)}}_moveCornerPoint(e){let t=new O(e.x,e.y).sub(this._startClick),s=this._startPos.add(t),n=this._planet.getCartesianFromPixelTerrain(s);if(n){this._pickedCorner.setCartesian3v(n);let o=this._cornerLayer.getEntities();if(o.length){let a=this._pickedCorner.layerIndex;a===0?this._moveCorner(a+1,a+1,a):(a===o.length-1||this._moveCorner(a+1,a+1,a),this._moveCorner(a-1,a,a-1))}}}_updateGhostOutlinePointer(e){let t=this._cornerLayer.getEntities(),s=t.length;if(s>0){let n=s-1;this._insertCornerIndex=n;let o=t[n].getCartesian(),a=this._ghostCorner.getCartesian().sub(o),h=a.length();a.normalize();let c=[];for(let d=0;d<=Bt;d++){let u=a.scaleTo(d*h/Bt).addA(o);c.push(u)}this._ghostOutlineLayer.getEntities()[0].polyline.setPath3v([c])}}_initGhostLayerPointer(){this._ghostOutlineLayer.setEntities([new V({polyline:{path3v:[],isClosed:!1,...this._outlineStyle}}),this._ghostCorner]),this._ghostOutlineLayer.getEntities()[0].polyline.altitude=_i}}class Rn extends Z{constructor(e={}){super(e),this._drawingScene=new Sn({name:`drawingScene:${this.__id}`,cornerStyle:e.cornerStyle||{},centerStyle:e.centerStyle||{},outlineStyle:e.outlineStyle||{},fillStyle:e.fillStyle||{}})}activatePolygonDrawing(){this.deactivate(),this._drawingScene=new sa({name:`polygonDrawingScene:${this.__id}`,cornerStyle:this._drawingScene._cornerStyle,centerStyle:this._drawingScene._centerStyle,outlineStyle:this._drawingScene._outlineStyle,fillStyle:this._drawingScene._fillStyle}),this.activate()}activateLineStringDrawing(){this.deactivate(),this._drawingScene=new Sn({name:`linestringDrawingScene:${this.__id}`,cornerStyle:this._drawingScene._cornerStyle,centerStyle:this._drawingScene._centerStyle,outlineStyle:this._drawingScene._outlineStyle,fillStyle:this._drawingScene._fillStyle}),this.activate()}oninit(){}onactivate(){this.planet&&this._drawingScene.bindPlanet(this.planet),this.renderer&&this.renderer.addNode(this._drawingScene)}ondeactivate(){this.renderer&&this.renderer.removeNode(this._drawingScene)}}const oi={ell:0,msl:1,gnd:2},Jr=.3048,gl=1/Jr,pl=1/3.6,ra=.001*Jr,ml=1/ra,vl=["m","km","ft","s","h","m/s","km/h","ft/s"],na=[0,2,0,0,0,0,0,0];let gt=[];function oa(l,e,t){return gt[l][e](t)}function Mr(l,e,t,s,n){return l?oa(e,t,s).toFixed(n||na[t]):"--"}function aa(l){return vl[l]}gt[0]=[],gt[0][0]=l=>l,gt[0][1]=l=>.001*l,gt[0][2]=l=>l*gl,gt[2]=[],gt[2][0]=l=>l*Jr,gt[2][1]=l=>l*ra,gt[2][2]=l=>l,gt[1]=[],gt[1][0]=l=>1e3*l,gt[1][1]=l=>l,gt[1][2]=l=>l*ml,gt[5]=[],gt[5][5]=l=>l,gt[5][6]=l=>3.6*l,gt[5][7]=l=>3.28084*l,gt[6]=[],gt[6][5]=l=>l*pl,gt[6][6]=l=>l;const Mn=Object.freeze(Object.defineProperty({__proto__:null,ELL:0,GND:2,MSL:1,_tenth:na,convert:oa,convertExt:Mr,ft:2,fts:7,h:4,heightMode:oi,km:1,kmh:6,m:0,ms:5,s:3,toString:aa},Symbol.toStringTag,{value:"Module"})),yl=[`<div class="og-lat-side"></div><div class="og-lat-val"></div>
    <div class="og-lon-side"></div><div class="og-lon-val"></div>
    <div class="og-height"></div>
    <div class="og-units-height"></div>`,`<div class="og-lat-side"></div><div class="og-lat-val"></div>
    <div class="og-lon-side"></div><div class="og-lon-val"></div>
    <div class="og-height"></div>
    <div class="og-units-height"></div>`];class la extends Z{constructor(e={}){super(e),this._type=e.type||0,this._TYPE_FUNC=[this._SHOW_DECIMAL,this._SHOW_DEGREE],this._showFn=null,this._el=null,this._latSideEl=null,this._lonSideEl=null,this._latValEl=null,this._lonValEl=null,this._heightEl=null,this._altUnitVal=e.altitudeUnit||"m",this._heightModeVal=e.heightMode||"ell",this._altUnit=Mn[this._altUnitVal],this._heightMode=oi[this._heightModeVal],this._lonLat=null,this._centerMode=!1}_SHOW_DECIMAL(e){if(e){let t=e.lat,s=e.lon;this._latSideEl.innerHTML=t>=0?"N":"S",this._lonSideEl.innerHTML=s>=0?"E":"W",this._latValEl.innerHTML=Math.abs(t).toFixed(7)+"°",this._lonValEl.innerHTML=Math.abs(s).toFixed(7)+"°"}}_SHOW_DEGREE(e){if(e){let t=e.lat,s=e.lon;this._latSideEl.innerHTML=t>=0?"N":"S",this._lonSideEl.innerHTML=s>=0?"E":"W";let n=0,o=t<0?Math.ceil(t):Math.floor(t),a=Math.floor(n=60*Math.abs(t-o)),h=Math.floor(6e3*(n-a))/100;this._latValEl.innerHTML=Math.abs(o)+"°"+a+"'"+h.toFixed(0)+'"',o=s<0?Math.ceil(s):Math.floor(s),a=Math.floor(n=60*Math.abs(s-o)),h=Math.floor(6e3*(n-a))/100,this._lonValEl.innerHTML=Math.abs(o)+"°"+a+"'"+h.toFixed(0)+'"'}}_createCenterEl(){let e=document.createElement("div");return e.className="og-center-icon",e.innerHTML='<svg width="12" height="12"><g><path stroke-width="1" stroke-opacity="1" d="M6 0L6 12M0 6L12 6" stroke="#337ab7"></path></g></svg>',e}_updateUnits(){this._heightMode=oi[this._heightModeVal],this._altUnit=Mn[this._altUnitVal],this._el.querySelector(".og-units-height").innerHTML=aa(this._altUnit),this._showHeight()}_refreshCoordinates(){this._type>=this._TYPE_FUNC.length&&(this._type=0);let e=this._el;e.innerHTML=yl[this._type],this._latSideEl=e.querySelector(".og-lat-side"),this._lonSideEl=e.querySelector(".og-lon-side"),this._latValEl=e.querySelector(".og-lat-val"),this._lonValEl=e.querySelector(".og-lon-val"),this._heightEl=e.querySelector(".og-height"),this._showFn=this._TYPE_FUNC[this._type],this._showFn(this._lonLat)}oninit(){this._el=document.createElement("div"),this._el.classList.add("og-coordinates"),this.renderer.div.appendChild(this._el),this._el.addEventListener("click",()=>{this._type++,this._refreshCoordinates(),this._updateUnits(),this._showHeight()}),this._centerMode?(this.renderer.div.appendChild(this._createCenterEl()),this.planet.camera.events.on("moveend",this._grabCoordinates,this),this.planet.camera.events.on("moveend",vi(()=>this._showHeight(),400,!0),this)):(this.renderer.events.on("mousemove",this._grabCoordinates,this),this.renderer.events.on("mousestop",vi(()=>this._showHeight(),400,!0),this)),this._refreshCoordinates(),this._updateUnits()}_grabCoordinates(e){let t,s=e.pos,n=this.renderer;t=this._centerMode?n.handler.getCenter():s,this._lonLat=this.planet.getLonLatFromPixelTerrain(t)||null,this._showFn(this._lonLat)}async _showHeight(){if(this._lonLat&&this.planet){let e=0;this._heightEl.style.opacity="0.7",this._heightMode===oi.ell?(e=await this.planet.getHeightAboveELL(this._lonLat),e=Number(Mr(!0,0,this._altUnit,e))):this._heightMode===oi.msl&&(e=await this.planet.getHeightDefault(this._lonLat),e=Number(Mr(!0,0,this._altUnit,e))),this._heightEl.style.opacity="1.0",this._heightEl.innerHTML=e.toString()}}}const xl=["loadend"];class Ei extends It{constructor(e,t={}){super(e,t),this.events=this.events.registerNames(xl),this._projType=0,this._frameWidth=256,this._frameHeight=256,this._sourceReady=!1,this._sourceTexture=null,this._materialTexture=null,this._gridBufferLow=null,this._gridBufferHigh=null,this._extentWgs84ParamsHigh=new Float32Array(4),this._extentWgs84ParamsLow=new Float32Array(4),this._extentMercParamsHigh=new Float32Array(4),this._extentMercParamsLow=new Float32Array(4),this._refreshFrame=!0,this._frameCreated=!1,this._sourceCreated=!1,this._animate=!1,this._ready=!1,this._creationProceeding=!1,this._isRendering=!1,this._extentWgs84=new H,this._cornersWgs84=[],this._cornersMerc=[],this._isFullExtent=t.fullExtent?1:0,this.rendering=this._renderingProjType0.bind(this),this._onLoadend_=null,t.corners&&this.setCorners(t.corners)}get isIdle(){return super.isIdle&&this._ready}addTo(e){return this._onLoadend_=this._onLoadend.bind(this),this.events.on("loadend",this._onLoadend_,this),super.addTo(e)}_onLoadend(){this._planet&&this._planet.events.dispatch(this._planet.events.layerloadend,this)}remove(){return this.events.off("loadend",this._onLoadend_),this._onLoadend_=null,super.remove()}get instanceName(){return"BaseGeoImage"}getCornersLonLat(){let e=this._cornersWgs84;return[new A(e[0].lon,e[0].lat),new A(e[1].lon,e[1].lat),new A(e[2].lon,e[2].lat),new A(e[3].lon,e[3].lat)]}getCorners(){let e=this._cornersWgs84;return[[e[0].lon,e[0].lat],[e[1].lon,e[1].lat],[e[2].lon,e[2].lat],[e[3].lon,e[3].lat]]}setCorners(e){this.setCornersLonLat(A.join(e))}setCornersLonLat(e){this._refreshFrame=!0,this._cornersWgs84=[e[0].clone(),e[1].clone(),e[2].clone(),e[3].clone()];for(let s=0;s<this._cornersWgs84.length;s++)this._cornersWgs84[s].lat>=89.9&&(this._cornersWgs84[s].lat=89.9),this._cornersWgs84[s].lat<=-89.9&&(this._cornersWgs84[s].lat=-89.9);this._extent.setByCoordinates(this._cornersWgs84);let t=this._extent;t.southWest.lat>ht||t.northEast.lat<Ft?(this._projType=0,this.rendering=this._renderingProjType0):(this._projType=1,this.rendering=this._renderingProjType1),this._ready&&!this._creationProceeding&&this._planet._geoImageCreator.add(this)}_createFrame(){this._extentWgs84=this._extent.clone(),this._cornersMerc=[this._cornersWgs84[0].forwardMercatorEPS01(),this._cornersWgs84[1].forwardMercatorEPS01(),this._cornersWgs84[2].forwardMercatorEPS01(),this._cornersWgs84[3].forwardMercatorEPS01()],this._extentMerc=new H(this._extentWgs84.southWest.forwardMercatorEPS01(),this._extentWgs84.northEast.forwardMercatorEPS01());let e=new Float32Array(2);if(this._projType===0?(oe(this._extentWgs84.southWest.lon,e),this._extentWgs84ParamsHigh[0]=e[0],this._extentWgs84ParamsLow[0]=e[1],oe(this._extentWgs84.southWest.lat,e),this._extentWgs84ParamsHigh[1]=e[0],this._extentWgs84ParamsLow[1]=e[1],this._extentWgs84ParamsHigh[2]=2/this._extentWgs84.getWidth(),this._extentWgs84ParamsHigh[3]=2/this._extentWgs84.getHeight()):(oe(this._extentMerc.southWest.lon,e),this._extentMercParamsHigh[0]=e[0],this._extentMercParamsLow[0]=e[1],oe(this._extentMerc.southWest.lat,e),this._extentMercParamsHigh[1]=e[0],this._extentMercParamsLow[1]=e[1],this._extentMercParamsHigh[2]=2/this._extentMerc.getWidth(),this._extentMercParamsHigh[3]=2/this._extentMerc.getHeight()),this._planet){let t=this._planet.renderer.handler;t.gl.deleteTexture(this._materialTexture),this._materialTexture=t.createEmptyTexture_l(this._frameWidth,this._frameHeight);let s=this._planet._geoImageCreator.createGridBuffer(this._cornersWgs84,this._projType===1);this._gridBufferHigh=s[0],this._gridBufferLow=s[1],this._refreshFrame=!1}}abortMaterialLoading(e){this._creationProceeding=!1,e.isLoading=!1,e.isReady=!1}clear(){let e=this._planet;if(e){let t=e.renderer.handler.gl;this._creationProceeding&&e._geoImageCreator.remove(this),e._clearLayerMaterial(this),t&&(t.deleteBuffer(this._gridBufferHigh),t.deleteBuffer(this._gridBufferLow),t.deleteTexture(this._sourceTexture),this._materialTexture&&!this._materialTexture.default&&t.deleteTexture(this._materialTexture))}this._sourceTexture=null,this._materialTexture=null,this._gridBufferHigh=null,this._gridBufferLow=null,this._refreshFrame=!0,this._sourceCreated=!1,this._ready=!1,this._creationProceeding=!1}setVisibility(e){e!==this._visibility&&(super.setVisibility(e),this._planet&&this._sourceReady&&(e?this._planet._geoImageCreator.add(this):this._planet._geoImageCreator.remove(this)))}clearMaterial(e){e.texture=null,e.isLoading=!1,e.isReady=!1}applyMaterial(e){let t,s,n=e.segment;this._ready?e.applyTexture(this._materialTexture):(e.texture=this._planet.transparentTexture,!this._creationProceeding&&this.loadMaterial(e)),this._projType===0?(t=this._extentWgs84,s=n._extent):(t=this._extentMerc,s=n.getExtentMerc());let o=t.northEast.lon-t.southWest.lon,a=t.northEast.lat-t.southWest.lat;return[(s.southWest.lon-t.southWest.lon)/o,(t.northEast.lat-s.northEast.lat)/a,(s.northEast.lon-s.southWest.lon)/o,(s.northEast.lat-s.southWest.lat)/a]}get getFrameWidth(){return this._frameWidth}get getFrameHeight(){return this._frameHeight}_createSourceTexture(){}_renderingProjType1(){let e=this._planet,t=e.renderer.handler,s=t.gl,n=e._geoImageCreator;this._refreshFrame&&this._createFrame(),this._createSourceTexture();let o=n._framebuffer;o.setSize(this._frameWidth,this._frameHeight),o.activate(),t.programs.geoImageTransform.activate();let a=t.programs.geoImageTransform._program,h=a.attributes,c=a.uniforms;s.disable(s.CULL_FACE),o.bindOutputTexture(this._materialTexture),s.clearColor(0,0,0,0),s.clear(s.COLOR_BUFFER_BIT),s.uniform1i(c.isFullExtent,this._isFullExtent),s.bindBuffer(s.ARRAY_BUFFER,n._texCoordsBuffer),s.vertexAttribPointer(h.texCoords,2,s.UNSIGNED_SHORT,!0,0,0),s.bindBuffer(s.ARRAY_BUFFER,this._gridBufferHigh),s.vertexAttribPointer(h.cornersHigh,this._gridBufferHigh.itemSize,s.FLOAT,!1,0,0),s.bindBuffer(s.ARRAY_BUFFER,this._gridBufferLow),s.vertexAttribPointer(h.cornersLow,this._gridBufferLow.itemSize,s.FLOAT,!1,0,0),s.uniform4fv(c.extentParamsHigh,this._extentMercParamsHigh),s.uniform4fv(c.extentParamsLow,this._extentMercParamsLow),s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,this._sourceTexture),s.uniform1i(c.sourceTexture,0),s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,n._indexBuffer),s.drawElements(s.TRIANGLE_STRIP,n._indexBuffer.numItems,s.UNSIGNED_INT,0),o.deactivate(),s.enable(s.CULL_FACE),this._ready=!0,this._creationProceeding=!1}_renderingProjType0(){let e=this._planet,t=e.renderer.handler,s=t.gl,n=e._geoImageCreator;this._refreshFrame&&this._createFrame(),this._createSourceTexture();let o=n._framebuffer;o.setSize(this._frameWidth,this._frameHeight),o.activate(),t.programs.geoImageTransform.activate();let a=t.programs.geoImageTransform._program,h=a.attributes,c=a.uniforms;s.disable(s.CULL_FACE),o.bindOutputTexture(this._materialTexture),s.clearColor(0,0,0,0),s.clear(s.COLOR_BUFFER_BIT),s.bindBuffer(s.ARRAY_BUFFER,n._texCoordsBuffer),s.vertexAttribPointer(h.texCoords,2,s.UNSIGNED_SHORT,!0,0,0),s.bindBuffer(s.ARRAY_BUFFER,this._gridBufferHigh),s.vertexAttribPointer(h.cornersHigh,this._gridBufferHigh.itemSize,s.FLOAT,!1,0,0),s.bindBuffer(s.ARRAY_BUFFER,this._gridBufferLow),s.vertexAttribPointer(h.cornersLow,this._gridBufferLow.itemSize,s.FLOAT,!1,0,0),s.uniform4fv(c.extentParamsHigh,this._extentWgs84ParamsHigh),s.uniform4fv(c.extentParamsLow,this._extentWgs84ParamsLow),s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,this._sourceTexture),s.uniform1i(c.sourceTexture,0),s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,n._indexBuffer),s.drawElements(s.TRIANGLE_STRIP,n._indexBuffer.numItems,s.UNSIGNED_INT,0),o.deactivate(),s.enable(s.CULL_FACE),this._ready=!0,this._creationProceeding=!1}}const Y={KEY_CTRL:17,KEY_ALT:18,KEY_LEFT:37,KEY_UP:38,KEY_RIGHT:39,KEY_DOWN:40,KEY_PRINTSCREEN:44,KEY_A:65,KEY_D:68,KEY_E:69,KEY_Q:81,KEY_S:83,KEY_W:87,KEY_X:88},bl=["change","idle","play","pause","stop"];class wl extends dt{constructor(e){super({template:zt('<button title={title} class="og-layerSwitcher__layerButton">{icon}<div class="og-layerSwitcher__name">{name}</div></button>',{title:e.model.name,name:e.model.name,icon:e.model.iconSrc?`<img src="${e.model.iconSrc}" />`:""}),...e}),this._onVisibilityChange=t=>{this.el&&(this.model.getVisibility()?this.el.classList.add("og-layerSwitcher__visible"):this.el.classList.remove("og-layerSwitcher__visible"))},this._onClick=()=>{this.model.isBaseLayer()?this.model.setVisibility(!0):this.model.setVisibility(!this.model.getVisibility())},this._onDblClick=()=>{this.model.flyExtent()}}render(e){return super.render(e),this.model.events.on("visibilitychange",this._onVisibilityChange),this._onVisibilityChange(this.model),this.el.addEventListener("click",this._onClick),this.el.addEventListener("dblclick",this._onDblClick),this}remove(){super.remove(),this.model.events.off("visibilitychange",this._onVisibilityChange)}}const Tl=["change"];class K extends dt{constructor(e={}){super({template:zt(`<div class="og-slider">
      <div class="og-slider-label">{label}</div>
      <div class="og-slider-panel">
        <div class="og-slider-progress"></div>      
        <div class="og-slider-pointer"></div>
      </div>
      <input type="number"/>
    </div>`,{label:e.label||""})}),this._onResize=()=>{this._setOffset((this._value-this._min)*this.$panel.clientWidth/(this._max-this._min))},this._onMouseWheel=t=>{(t=t||window.event).preventDefault(),t.stopPropagation(),this.value=this._value+Math.sign(t.wheelDelta)*(this._max-this._min)/100},this._onMouseWheelFF=t=>{this._onMouseWheel(t)},this._onInput=t=>{(t=t||window.event).preventDefault(),t.stopPropagation(),this.value=parseFloat(t.target.value)},this._onMouseDown=t=>{(t=t||window.event).preventDefault(),this._startPosX=t.clientX,this.value=this._min+(this._max-this._min)*(t.offsetX/this.$panel.clientWidth),document.addEventListener("mousemove",this._onMouseMove),document.addEventListener("mouseup",this._onMouseUp)},this._onMouseMove=t=>{(t=t||window.event).preventDefault(),t.stopPropagation();let s=this.$panel.getBoundingClientRect(),n=$i(t.clientX,s.left,s.right),o=this._startPosX-n;this._startPosX=n,this.value=this._value-o*(this._max-this._min)/this.$panel.clientWidth},this._onMouseUp=()=>{document.removeEventListener("mouseup",this._onMouseUp),document.removeEventListener("mousemove",this._onMouseMove)},this.events=this.events.registerNames(Tl),this._value=e.value||0,this._min=e.min||0,this._max=e.max||1,this._resizeObserver=new ResizeObserver(this._onResize),this._startPosX=0,this.$label=null,this.$pointer=null,this.$progress=null,this.$input=null,this.$panel=null}render(e){return super.render(e),this.$label=this.select(".og-slider-label"),this.$label.innerHTML===""&&(this.$label.style.display="none"),this.$pointer=this.select(".og-slider-pointer"),this.$progress=this.select(".og-slider-progress"),this.$panel=this.select(".og-slider-panel"),this.$input=this.select("input"),this._resizeObserver.observe(this.el),this._initEvents(),this}set value(e){e!==this._value&&(this._value=$i(e,this._min,this._max),this.$input.value=this._value.toString(),this._setOffset((this._value-this._min)*this.$panel.clientWidth/(this._max-this._min)),this.events.dispatch(this.events.change,this._value,this))}get value(){return this._value}_initEvents(){this.$panel.addEventListener("mousedown",this._onMouseDown),this.$panel.addEventListener("mousewheel",this._onMouseWheel),this.$panel.addEventListener("wheel",this._onMouseWheelFF),this.$input.addEventListener("input",this._onInput)}_clearEvents(){this.$panel.removeEventListener("mousedown",this._onMouseDown),this.$panel.removeEventListener("mousewheel",this._onMouseWheel),this.$panel.removeEventListener("wheel",this._onMouseWheelFF),this.$input.removeEventListener("input",this._onInput)}_setOffset(e){e>=0&&e<=this.$panel.clientWidth&&(this.$pointer.style.left=this.$progress.style.width=100*e/this.$panel.clientWidth+"%")}remove(){this._clearEvents(),super.remove()}}const Cl=["input"];let El=0;class Bn extends dt{constructor(e={}){super({template:zt(`<div class="og-color">
      <label for="{id}" class="og-color-label">{label}</label>
      <input type="color" name="{id}" value="{value}"/>
    </div>`,{id:"color-"+El++,label:e.label||"",value:e.value||"#000000"})}),this._onInput=t=>{this.value=t.target.value},this.events=this.events.registerNames(Cl),this._value=e.value||"blue",this.$label=null,this.$input=null}render(e){return super.render(e),this.$label=this.select(".og-color-label"),this.$label.innerHTML===""&&(this.$label.style.display="none"),this.$input=this.select("input"),this._initEvents(),this}set value(e){e!==this._value&&(this._value=e,this.$input.value=this._value,this.events.dispatch(this.events.input,this._value,this))}get value(){return this._value}_initEvents(){this.$input.addEventListener("input",this._onInput)}_clearEvents(){this.$input.removeEventListener("input",this._onInput)}remove(){this._clearEvents(),super.remove()}}class Br{constructor(){this._lock=0}lock(e){this._lock|=1<<e.id}free(e){this._lock&=~(1<<e.id)}isFree(){return this._lock===0}isLocked(){return this._lock!==0}}const As=class Wc{constructor(){this.__id=Wc.__counter__++}get id(){return this.__id}};As.__counter__=0;let Re=As;class tn extends Z{constructor(e={}){super(e),this._deactivate=!1,this._shiftBusy=!1,this._name="mouseNavigation",this.grabbedPoint=new m,this._eye0=new m,this.pointOnEarth=new m,this.earthUp=new m,this.inertia=.007,this.grabbedSpheroid=new Dt,this.qRot=new D,this.scaleRot=0,this.distDiff=.3,this.stepsCount=8,this.stepsForward=null,this.stepIndex=0,this._lmbDoubleClickActive=!0,this.minSlope=e.minSlope||.1,this._wheelDirection=1,this._keyLock=new Re}static getMovePointsFromPixelTerrain(e,t,s,n,o,a,h){const c=[];let d=e.eye.clone(),u=e.getBackward(),_=e.getRight(),f=e.getUp(),v=t.getCartesianFromPixelTerrain(o);if(v||(v=t.getCartesianFromPixelTerrain(t.renderer.handler.getCenter())),v){h||(h=m.sub(v,e.eye).normalize());let g=n*e.eye.distance(v)/s;g*=a?-1.25:2;const y=u.scaleTo(g);if(h.dot(e.eye.normal().negate())>=.1){const p=new Dt;p.radius=v.length();let x=[],T=[],w=!1;for(let C=0;C<s;C++){d.addA(y);const E=new N(d,h).hitSphere(p);if(T[C]=d.clone(),!E){w=!0;break}x[C]=new st().rotateBetweenVectors(v.normal(),E.normal())}if(w){d=e.eye.clone();for(let C=0;C<s;C++)c[C]={eye:d.addA(y).clone(),v:f,u:_,n:u}}else for(let C=0;C<s;C++){let E=x[C];c[C]={eye:E.mulVec3(T[C]),v:E.mulVec3(f),u:E.mulVec3(_),n:E.mulVec3(u)}}}else for(let p=0;p<s;p++)c[p]={eye:d.addA(h.scaleTo(-g)).clone(),v:f,u:_,n:u};return c}}onactivate(){this.renderer&&(this.renderer.events.on("mousewheel",this.onMouseWheel,this),this.renderer.events.on("lhold",this.onMouseLeftButtonDown,this),this.renderer.events.on("rhold",this.onMouseRightButtonDown,this),this.renderer.events.on("ldown",this.onMouseLeftButtonClick,this),this.renderer.events.on("lup",this.onMouseLeftButtonUp,this),this.renderer.events.on("rdown",this.onMouseRightButtonClick,this),this.renderer.events.on("draw",this.onDraw,this,-1e3),this.renderer.events.on("mousemove",this.onMouseMove,this),this.renderer.events.on("mouseleave",this.onMouseLeave,this),this.renderer.events.on("mouseenter",this.onMouseEnter,this),this._lmbDoubleClickActive&&this.renderer.events.on("ldblclick",this.onMouseLeftButtonDoubleClick,this))}ondeactivate(){this.renderer&&(this.renderer.events.off("mousewheel",this.onMouseWheel),this.renderer.events.off("lhold",this.onMouseLeftButtonDown),this.renderer.events.off("rhold",this.onMouseRightButtonDown),this.renderer.events.off("ldown",this.onMouseLeftButtonClick),this.renderer.events.off("lup",this.onMouseLeftButtonUp),this.renderer.events.off("rdown",this.onMouseRightButtonClick),this.renderer.events.off("draw",this.onDraw),this.renderer.events.off("ldblclick",this.onMouseLeftButtonDoubleClick),this.renderer.events.off("mouseleave",this.onMouseLeave),this.renderer.events.off("mouseenter",this.onMouseEnter))}activateDoubleClickZoom(){this._lmbDoubleClickActive||(this._lmbDoubleClickActive=!0,this.renderer&&this.renderer.events.on("ldblclick",this.onMouseLeftButtonDoubleClick,this))}deactivateDoubleClickZoom(){this._lmbDoubleClickActive&&(this._lmbDoubleClickActive=!1,this.renderer&&this.renderer.events.off("ldblclick",this.onMouseLeftButtonDoubleClick))}onMouseEnter(e){const t=this.renderer.events;t.isKeyPressed(Y.KEY_ALT)&&t.releaseKeys(),t.updateButtonsStates(e.sys.buttons),t.mouseState.leftButtonDown?this.renderer.handler.canvas.classList.add("ogGrabbingPoiner"):this.renderer.handler.canvas.classList.remove("ogGrabbingPoiner")}onMouseLeave(){this.renderer.events.mouseState.leftButtonDown&&(this.scaleRot=0),this.renderer.handler.canvas.classList.remove("ogGrabbingPoiner")}onMouseWheel(e){this.stepIndex||(this.planet.stopFlying(),this.stopRotation(),this._deactivate=!0,this.lockPlanet(!0),this.stepsForward=tn.getMovePointsFromPixelTerrain(this.planet.camera,this.planet,this.stepsCount,this.distDiff,e.pos,e.wheelDelta>0,e.direction)||null,this._wheelDirection=e.wheelDelta,this.stepsForward&&(this.stepIndex=this.stepsCount))}oninit(){this.activate(),this.renderer&&(this.renderer.events.on("keyfree",Y.KEY_ALT,this.onShiftFree,this),this.renderer.events.on("keyfree",Y.KEY_PRINTSCREEN,this.onShiftFree,this))}onMouseLeftButtonDoubleClick(e){this.planet.stopFlying(),this.stopRotation();const t=this.planet.getCartesianFromPixelTerrain(e.pos);if(t){const s=this.planet.camera;let n=s.maxAltitude+this.planet.ellipsoid.polarSize,o=s.minAltitude+this.planet.ellipsoid.polarSize;const a=s.eye.length(),h=this.planet.ellipsoid.cartesianToLonLat(t);if(a>n||a<o)return void this.planet.flyLonLat(new A(h.lon,h.lat));this.renderer.events.isKeyPressed(Y.KEY_ALT)?this.planet.flyLonLat(new A(h.lon,h.lat,2*s.eye.distance(t))):this.planet.flyLonLat(new A(h.lon,h.lat,.57*s.eye.distance(t)))}}onMouseLeftButtonClick(){this._active&&(this.renderer.handler.canvas.classList.add("ogGrabbingPoiner"),this.grabbedPoint=this.planet.getCartesianFromMouseTerrain(),this.grabbedPoint&&(this._eye0.copy(this.planet.camera.eye),this.grabbedSpheroid.radius=this.grabbedPoint.length(),this.stopRotation()))}stopRotation(){this.qRot.clear(),this.freePlanet()}onMouseLeftButtonUp(e){this.renderer.handler.canvas.classList.remove("ogGrabbingPoiner"),e.x===e.prev_x&&e.y===e.prev_y&&(this.scaleRot=0)}onMouseLeftButtonDown(e){if(this._active){if(!this.grabbedPoint)return;if(this.planet.stopFlying(),e.moving){let t=this.planet.camera;if(t.slope>.2){const s=new N(t.eye,e.direction).hitSphere(this.grabbedSpheroid);if(s){this.scaleRot=1,this.qRot=D.getRotationBetweenVectors(s.normal(),this.grabbedPoint.normal());let n=this.qRot;t.eye=n.mulVec3(t.eye),t.rotate(n)}}else{let s=this.grabbedPoint,n=m.add(s,t.getRight()),o=m.add(s,s.normal()),a=new m;new N(t.eye,e.direction).hitPlaneRes(mt.fromPoints(s,n,o),a)===N.INSIDE&&(t.eye=this._eye0.addA(a.subA(s).negate()))}}}}onMouseRightButtonClick(e){this.stopRotation(),this.planet.stopFlying(),this.pointOnEarth=this.planet.getCartesianFromPixelTerrain(e.pos),this.pointOnEarth&&(this.earthUp=this.pointOnEarth.normal())}onMouseRightButtonDown(e){const t=this.planet.camera;if(this.pointOnEarth&&e.moving){this.renderer.controlsBag.scaleRot=1;let s=.5/t.eye.distance(this.pointOnEarth)*t._lonLat.height*U;s>.007?s=.007:s<.003&&(s=.003),t.rotateHorizontal(s*(e.x-e.prev_x),!1,this.pointOnEarth,this.earthUp),t.rotateVertical(s*(e.y-e.prev_y),this.pointOnEarth,this.minSlope)}}onShiftFree(){this._shiftBusy=!1}onMouseMove(e){this._active&&this.renderer.events.isKeyPressed(Y.KEY_ALT)&&(this._shiftBusy||(this._shiftBusy=!0,this.onMouseRightButtonClick(e)),this.onMouseRightButtonDown(e))}onDraw(){if(this._active){const e=this.renderer,t=this.planet.camera;let s=t.eye.clone();if(this.stepIndex){e.controlsBag.scaleRot=1;const n=this.stepsForward[this.stepsCount-this.stepIndex--];t.eye=n.eye,t._u=n.v,t._r=n.u,t._b=n.n,t._f.set(-t._b.x,-t._b.y,-t._b.z)}else this._deactivate&&(this._deactivate=!1,this.freePlanet());if(e.events.mouseState.leftButtonDown||!this.scaleRot)return;if(this.scaleRot-=this.inertia,this.scaleRot<=0)this.scaleRot=0;else{e.controlsBag.scaleRot=this.scaleRot;let n=this.qRot.slerp(D.IDENTITY,1-this.scaleRot*this.scaleRot*this.scaleRot).normalize();n.x||n.y||n.z||(this.scaleRot=0),t.eye=n.mulVec3(t.eye),t.rotate(n)}t.eye.distance(s)/t.getAltitude()>.01?this.lockPlanet():this.freePlanet()}}lockPlanet(e){this.planet.layerLock.lock(this._keyLock),!e&&this.planet.terrainLock.lock(this._keyLock),this.planet._normalMapCreator.lock(this._keyLock)}freePlanet(){this.planet.layerLock.free(this._keyLock),this.planet.terrainLock.free(this._keyLock),this.planet._normalMapCreator.free(this._keyLock)}}const Al=["drag","zoom","rotate"],Ii=.96;class ha extends Z{constructor(e={}){super({name:"mouseNavigation",autoActivate:!0,...e}),this._shiftBusy=!1,this._hold=!1,this._prevVel=new m,this._screenPosIsChanged=!0,this._onShiftFree=()=>{this._shiftBusy=!1},this._onCameraFly=()=>{this.stop()},this._onMouseMove=t=>{this._active&&this.renderer.events.isKeyPressed(Y.KEY_ALT)&&(this._shiftBusy||(this._shiftBusy=!0,this._onRHold(t)),this._onRDown(t))},this._onMouseEnter=t=>{const s=this.renderer.events;s.isKeyPressed(Y.KEY_ALT)&&s.releaseKeys(),s.updateButtonsStates(t.sys.buttons),s.mouseState.leftButtonDown?this.renderer.handler.canvas.classList.add("ogGrabbingPoiner"):this.renderer.handler.canvas.classList.remove("ogGrabbingPoiner")},this._onMouseLeave=()=>{this.renderer.events.mouseState.leftButtonDown&&this.vel.scale(0),this.renderer.handler.canvas.classList.remove("ogGrabbingPoiner")},this._onRHold=t=>{this._targetRotationPoint&&(this._velInertia=.6,this.force_h=.5*(t.x-t.prev_x),this.force_v=.5*(t.y-t.prev_y))},this._onRDown=t=>{if(this.planet){this.planet.stopFlying();const s=this._getTargetPoint(t.pos);this._targetRotationPoint=s||null,s&&(this._targetZoomPoint=null,this._targetDragPoint=null,this.vel.set(0,0,0),this._tUp=s.getNormal(),this._tRad=this.planet.camera.eye.distance(s))}},this._onMouseWheel=t=>{if(this.planet){this._targetRotationPoint=null,this._targetDragPoint=null;let s=t.x,n=t.y,o=this.planet.camera;if(o.isOrthographic){s=.5*this.renderer.handler.getWidth(),n=.5*this.renderer.handler.getHeight();let d=this._getTargetPoint(new O(s,n));if(!d)return;this._targetZoomPoint=d,this._grabbedSphere.radius=this._targetZoomPoint.length();let u=o.eye.distance(d),_=new m,f=o.unproject(s,n,u,_);const v=_.sub(f.scaleTo(u));if(d=new N(v,f).hitSphere(this._grabbedSphere),!d)return;this._targetZoomPoint=d}else{let d=this._getTargetPoint(new O(s,n));if(!d)return;this._targetZoomPoint=d,this._grabbedSphere.radius=this._targetZoomPoint.length()}if(this._curPitch=o.getPitch(),this._curYaw=o.getYaw(),this._curRoll=o.getRoll(),Math.sign(t.wheelDelta)!==this._wheelDirection)return this.vel.scale(.3),this._currScreenPos.set(s,n),void(this._wheelDirection=Math.sign(t.wheelDelta));this._currScreenPos.set(s,n),this._wheelDirection=Math.sign(t.wheelDelta);let a=20;this._velInertia=.83,this._isTouchPad=t.isTouchPad,t.isTouchPad&&(this._velInertia=.63,a=17);let h=this._targetZoomPoint.sub(o.eye);h.length()>6e3&&this._wheelDirection>0&&o.eye.getNormal().negate().dot(h.normalize())<.3&&(this.fixedUp=!1,a=4.3);let c=this.planet.camera.eye.distance(this._targetZoomPoint)*a;this.force=t.direction.scale(this._wheelDirection).normalize().scale(this._wheelDirection<0?1.3*c:c).scale(this.zoomSpeed),this.vel.set(0,0,0),this.force_roll=this._curRoll}},this._onLDown=t=>{this.stop(),this._targetRotationPoint=null,this._targetZoomPoint=null,this.planet&&(this.planet.stopFlying(),this._grabbedPoint=this._getTargetPoint(t.pos),this._grabbedPoint&&(this._targetDragPoint=this._grabbedPoint,this.planet.camera.isOrthographic?this._grabbedDist=this.renderer.getDistanceFromPixel(t.pos):this._grabbedDist=this.renderer.activeCamera.eye.distance(this._grabbedPoint),this.renderer.handler.canvas.classList.add("ogGrabbingPoiner"),this._grabbedSphere.radius=this._grabbedPoint.length(),this._eye0=this.planet.camera.eye.clone(),this._grabbedCameraHeight=this._eye0.length(),this._curPitch=this.planet.camera.getPitch(),this._curYaw=this.planet.camera.getYaw(),this._curRoll=this.planet.camera.getRoll(),this._currScreenPos.copy(t.pos),this.planet.camera.getUp().dot(new m(0,0,1))>.3&&(this.fixedUp=!0)))},this._onLHold=t=>{if(this._grabbedPoint&&this.planet){let s=this.planet.camera;if(s.isOrthographic){const n=this._grabbedDist,o=new m,a=s.unproject(t.x,t.y,n,o),h=o.sub(a.scaleTo(n)),c=new N(h,a).hitSphere(this._grabbedSphere);if(!c)return;this._targetDragPoint=c;let d=D.getRotationBetweenVectors(this._targetDragPoint.getNormal(),this._grabbedPoint.getNormal()).mulVec3(s.eye);this.force=d.sub(s.eye).scale(this.dragInertia)}else if(s.slope>.35){this._grabbedDist=s.eye.distance(this._grabbedPoint);let n=s.unproject(t.x,t.y,this._grabbedDist),o=new N(s.eye,n).hitSphere(this._grabbedSphere);if(!o)return;this._targetDragPoint=o;let a=D.getRotationBetweenVectors(this._targetDragPoint.getNormal(),this._grabbedPoint.getNormal()).mulVec3(s.eye);this.force=a.sub(s.eye).scale(this.dragInertia)}else{let n=this._grabbedPoint,o=m.add(n,s.getRight()),a=m.add(n,n.getNormal()),h=new m;new N(s.eye,t.direction).hitPlaneRes(mt.fromPoints(n,o,a),h);let c=s.eye.add(h.subA(n).negate());this.force=c.sub(s.eye).scale(this.dragInertia),this._targetDragPoint=h}this.vel.set(0,0,0),this._currScreenPos.equal(t.pos)||(this._screenPosIsChanged=!0,this._currScreenPos.copy(t.pos)),this._hold=!0}},this._onLUp=t=>{this._hold=!1,this.renderer.handler.canvas.classList.remove("ogGrabbingPoiner")},this.events=ot(Al,this),this.force=new m,this.force_h=0,this.force_v=0,this.vel=new m,this.vel_h=0,this.vel_v=0,this.vel_roll=0,this.force_roll=0,this.mass=e.mass!=null?e.mass:1,this.inertia=e.inertia!=null?e.inertia:1,this._velInertia=Ii,this.minSlope=e.minSlope!=null?e.minSlope:.35,this.dragInertia=e.dragInertia!=null?e.dragInertia:170,this.zoomSpeed=e.zoomSpeed!=null?e.zoomSpeed:1,this._lookPos=void 0,this._grabbedPoint=null,this._grabbedDist=0,this._targetZoomPoint=null,this._targetDragPoint=null,this._targetRotationPoint=null,this._tUp=new m,this._tRad=0,this._rotHDir=0,this._rotVDir=0,this._wheelDirection=1,this._currScreenPos=new O,this._grabbedSphere=new Dt,this.fixedUp=e.fixedUp==null||e.fixedUp,this._rot=new D,this._curPitch=0,this._curYaw=0,this._curRoll=0,this._eye0=new m,this._newEye=new m,this._grabbedCameraHeight=0,this._isTouchPad=!1}oninit(){this.renderer&&(this.renderer.events.on("keyfree",Y.KEY_ALT,this._onShiftFree),this.renderer.events.on("keyfree",Y.KEY_PRINTSCREEN,this._onShiftFree))}onadd(){var e;(e=this.planet)!=null&&e.camera&&this.planet.camera.events.on("flystart",this._onCameraFly)}onremove(){var e;(e=this.planet)!=null&&e.camera&&this.planet.camera.events.off("flystart",this._onCameraFly)}onactivate(){super.onactivate();let e=this.renderer;e.events.on("mousewheel",this._onMouseWheel),e.events.on("rhold",this._onRHold),e.events.on("rdown",this._onRDown),e.events.on("lhold",this._onLHold),e.events.on("ldown",this._onLDown),e.events.on("lup",this._onLUp),e.events.on("draw",this.onDraw,this,-1e3),e.events.on("mousemove",this._onMouseMove),e.events.on("mouseleave",this._onMouseLeave),e.events.on("mouseenter",this._onMouseEnter)}ondeactivate(){super.ondeactivate();let e=this.renderer;e.events.off("mousewheel",this._onMouseWheel),e.events.off("rhold",this._onRHold),e.events.off("rdown",this._onRDown),e.events.off("lhold",this._onLHold),e.events.off("ldown",this._onLDown),e.events.off("lup",this._onLUp),e.events.off("draw",this.onDraw),e.events.off("mousemove",this._onMouseMove),e.events.off("mouseleave",this._onMouseLeave),e.events.off("mouseenter",this._onMouseEnter)}onDraw(){this._updateVel(),this._handleZoom(),this._handleDrag(),this._handleRotation()}_handleRotation(){if(this.planet&&this._targetRotationPoint){let e=this.planet.camera;if(this.vel_h===0&&this.vel_v===0)return;let t=this.vel_h*this.dt,s=this.vel_v*this.dt;e.rotateHorizontal(t,!1,this._targetRotationPoint,this._tUp),e.rotateVertical(s,this._targetRotationPoint,.1),this.events.dispatch(this.events.rotate,this),this._curPitch=e.getPitch(),this._curYaw=e.getYaw(),this._curRoll=e.getRoll(),this._velInertia=Ii}}_getTargetPoint(e){return this.planet?this.planet.camera.isOrthographic?this.renderer.getCartesianFromPixel(e)||null:this.planet.camera.getAltitude()>8e4?this.planet.getCartesianFromPixelEllipsoid(e)||null:this.planet.getCartesianFromPixelTerrain(e)||null:null}_handleDrag(){if(this.planet&&this._targetDragPoint&&this._grabbedPoint&&this.vel.length()>.1){this._velInertia=Ii;let e=this.planet.camera;if(Math.abs(e.eyeNorm.dot(m.NORTH))>.9&&(this.fixedUp=!1),this._screenPosIsChanged||this.vel.length()>this._prevVel.length()&&(this.fixedUp=!1),this._screenPosIsChanged=!1,this._prevVel.copy(this.vel),e.slope>this.minSlope){let t=this.vel.scaleTo(this.dt),s=m.proj_b_to_plane(t,e.eyeNorm),n=e.eye.add(s).normalize().scale(this._grabbedCameraHeight);if(this.fixedUp)e.eye.copy(n),this._corrRoll(),e.setPitchYawRoll(this._curPitch,this._curYaw,this._curRoll);else{let o=D.getRotationBetweenVectors(e.eye.getNormal(),n.getNormal());e.rotate(o),e.eye.copy(n)}}else{let t=this.vel.scaleTo(this.dt),s=e.eye.add(t);e.eye.copy(s),e.checkTerrainCollision()}this.events.dispatch(this.events.drag,this)}}_corrRoll(){this.planet.camera.slope<.5&&(this._curRoll-=this.vel_roll*this.dt,this._curRoll<.01*Math.PI/180&&(this._curRoll=.01*Math.PI/180))}_handleZoom(){if(this._targetZoomPoint&&this.vel.length()>.1){let e=this.planet.camera,t=this._targetZoomPoint,s=e.eye.clone(),n=t.sub(e.eye).normalize(),o=this.vel.getNormal(),a=Math.sign(o.dot(e.getForward())),h=this.vel.scaleTo(this.dt);this._grabbedSphere.radius>s.length()&&(a*=-1);let c=e.getForward().scaleTo(a*h.length());s.addA(c),this.events.dispatch(this.events.zoom,this);let d=e.maxAltitude+this.planet.ellipsoid.getEquatorialSize();if(s.length()>d)return void s.copy(s.getNormal().scale(d));let u=new N(s,n).hitSphere(this._grabbedSphere);if(!u)return void this.vel.set(0,0,0);let _=D.getRotationBetweenVectors(u.getNormal(),t.getNormal());if(e.eye=_.mulVec3(s),e.rotate(_),this.fixedUp){this._corrRoll(),e.setPitchYawRoll(this._curPitch,this._curYaw,this._curRoll),e.update();let f=e.unproject2v(this._currScreenPos,e.eye.distance(this._targetZoomPoint)),v=t.sub(e.eye).normalize(),g=new m,y=new m,p=mt.fromPoints(t,t.add(e.getUp()),t.add(e.getRight()));new N(e.eye,f).hitPlaneRes(p,g),new N(e.eye,v).hitPlaneRes(p,y);let x=y.sub(g);e.eye=e.eye.add(x)}if(e.checkTerrainCollision(),e.isOrthographic){let f=e.getAltitude();f&&(e.focusDistance=Math.abs(f))}}}_updateVel(){let e=this.force.scale(1/this.mass);this.vel.addA(e),this.vel.scale(this.velocityInertia),this.vel.length()<.001&&this.vel.set(0,0,0),this.force.set(0,0,0),this._updateVel_h(),this._updateVel_v(),this._updateVel_roll()}_updateVel_h(){let e=this.force_h/this.mass;this.vel_h+=e,this.vel_h*=this.velocityInertia,Math.abs(this.vel_h)<.001&&(this.vel_h=0),this.force_h=0}_updateVel_v(){let e=this.force_v/this.mass;this.vel_v+=e,this.vel_v*=this.velocityInertia,Math.abs(this.vel_v)<.001&&(this.vel_v=0),this.force_v=0}_updateVel_roll(){let e=this.force_roll/this.mass;this.vel_roll+=e,this.vel_roll*=this.velocityInertia,this.force_roll=0}get dt(){return .001*this.renderer.handler.deltaTime}get velocityInertia(){return this._velInertia*this.inertia}stop(){this.vel.set(0,0,0),this.vel_h=0,this.vel_v=0,this._velInertia=Ii,this._targetZoomPoint=null,this._grabbedPoint=null,this._targetRotationPoint=null,this._targetDragPoint=null}}const kn=l=>l>1e3?`${(l/1e3).toFixed(1)} km`:l>9?`${Math.round(l)} m`:`${l.toFixed(1)} m`;let Ll=W.createCylinder(1.1,0,2.7,20,1,!0,!1,0,0,0);const Pl={text:"",size:11,color:"rgba(455,455,455,1.0)",outlineColor:"rgba(0,0,0,0.34)",outline:.23,align:"center",offset:[0,20,0]},In={scale:1,instanced:!0,tag:"ruler",color:"rgb(0,305,0)",object3d:Ll};class ca extends ce{constructor(e={}){super(e.name),this._onCornerLdown=t=>{var s,n;if(!this._startLonLat){(n=(s=this.renderer)==null?void 0:s.controls.mouseNavigation)==null||n.deactivate(),this._startClick.set(t.x,t.y);let o=t.pickingObject.getCartesian();this._startPos=this._planet.getPixelFromCartesian(o),this._pickedCorner=t.pickingObject,t.pickingObject.properties.name=="start"?this._anchorLonLat=this._cornerEntity[1].getLonLat().clone():this._anchorLonLat=this._cornerEntity[0].getLonLat().clone()}},this._onLUp=()=>{var t;this._pickedCorner&&((t=this.renderer.controls.mouseNavigation)==null||t.activate(),this._pickedCorner=null,this._anchorLonLat=null)},this._onCornerLup=()=>{this._onLUp()},this._onCornerEnter=t=>{t.renderer.handler.canvas.style.cursor="pointer"},this._onCornerLeave=t=>{t.renderer.handler.canvas.style.cursor="default"},this._onLdblclick=()=>{this._preventClick=!0},this._onLclick=t=>{let s=this._planet.getLonLatFromPixelTerrain(t.pos);s&&(this._timeout=setTimeout(()=>{this._preventClick||(this._startLonLat?this._startLonLat=null:(this.setVisibility(!0),this._stopDrawing=!1,this._startLonLat=s)),this._preventClick=!1,this._stopDrawing=!1,clearTimeout(this._timeout)},200),this._startLonLat&&(this._stopDrawing=!0))},this._onMouseMove=t=>{if(this._startLonLat&&!this._stopDrawing){this._propsLabel.label.setVisibility(!0);let s=this._planet.getLonLatFromPixelTerrain(t.pos);if(!s)return;this._drawLine(this._startLonLat,s)}else if(this._pickedCorner){let s=this._planet.getLonLatFromPixelTerrain(t.pos);s&&(this._pickedCorner.properties.name==="start"?this._drawLine(s,this._anchorLonLat):this._drawLine(this._anchorLonLat,s))}},this.events=ot(Sl),this._ignoreTerrain=e.ignoreTerrain==null||e.ignoreTerrain,this._planet=e.planet||null,this._startLonLat=null,this._preventClick=!1,this._stopDrawing=!1,this._pickedCorner=null,this._startPos=null,this._startClick=new O,this._anchorLonLat=null,this._heading=0,this._trackLayer=new ut("track",{entities:[],pickingEnabled:!1,polygonOffsetUnits:-1,relativeToGround:!0,hideInLayerSwitcher:!0}),this._labelLayer=new ut("ruler-label",{entities:[],pickingEnabled:!1,polygonOffsetUnits:-100,relativeToGround:!0,hideInLayerSwitcher:!0}),this._cornersLayer=new ut("corners",{entities:[],pickingEnabled:!0,hideInLayerSwitcher:!0,scaleByDistance:[100,4e6,1],pickingScale:2}),this._propsLabel=new V({name:"propsLabel",label:Pl}),this._trackEntity=new V({polyline:{path3v:[],thickness:4.8,color:"rgb(255,131,0)",isClosed:!1}}),this._trackEntity.polyline.altitude=.01,this._cornerEntity=[new V({geoObject:In,properties:{name:"start"}}),new V({geoObject:In,properties:{name:"end"}})]}set ignoreTerrain(e){this._ignoreTerrain=e}bindPlanet(e){this._planet=e}_createCorners(){this._cornersLayer.addEntities(this._cornerEntity)}init(){this._createCorners(),this._trackLayer.addEntities([this._trackEntity]),this._labelLayer.addEntities([this._propsLabel]),this._planet.addLayer(this._labelLayer),this._planet.addLayer(this._trackLayer),this._planet.addLayer(this._cornersLayer),this._activate()}onremove(){this._deactivate()}_activate(){this._propsLabel.label.setVisibility(!1),this.setVisibility(!1),this.renderer.events.on("lclick",this._onLclick,this),this.renderer.events.on("mousemove",this._onMouseMove,this),this.renderer.events.on("ldblclick",this._onLdblclick,this),this.renderer.events.on("lup",this._onLUp,this),this._cornersLayer.events.on("mouseenter",this._onCornerEnter,this),this._cornersLayer.events.on("mouseleave",this._onCornerLeave,this),this._cornersLayer.events.on("ldown",this._onCornerLdown,this),this._cornersLayer.events.on("lup",this._onCornerLup,this)}_deactivate(){this._startLonLat=null,this._preventClick=!1,this._stopDrawing=!1,this._pickedCorner=null,this.renderer.events.off("lclick",this._onLclick),this.renderer.events.off("mousemove",this._onMouseMove),this.renderer.events.off("lup",this._onLUp),this._cornersLayer.events.off("mouseenter",this._onCornerEnter),this._cornersLayer.events.off("mouseleave",this._onCornerLeave),this._cornersLayer.events.off("ldown",this._onCornerLdown),this._cornersLayer.events.off("lup",this._onCornerLup),this.clear()}setVisibility(e){this._cornersLayer.setVisibility(e),this._trackLayer.setVisibility(e),this._labelLayer.setVisibility(e)}_drawLine(e,t,s){s||(s=this._planet.ellipsoid.lonLatToCartesian(e));let n=this._planet.ellipsoid.lonLatToCartesian(t),o=this._planet.ellipsoid.inverse(e,t),a=o.distance;this._heading=o.initialAzimuth;let h=[],c=n.sub(s),d=c.length();c.normalize();for(let u=0;u<120;u++){let _=c.scaleTo(u*d/120).addA(s);h.push(_)}h.push(n),this._trackEntity.polyline.setPath3v([h]),this._ignoreTerrain&&(this._propsLabel.setCartesian3v(h[Math.floor(h.length/2)]),this._propsLabel.label.setText(`${kn(a)}, ${Math.round(this._heading)} deg`))}clear(){this._trackEntity.remove(),this._cornerEntity[0].remove(),this._cornerEntity[1].remove(),this._propsLabel.remove(),this._planet.removeLayer(this._trackLayer),this._planet.removeLayer(this._cornersLayer)}isCornersPositionChanged(){let e=this._trackEntity.polyline.getPath3v()[0];if(e){const t=e[0].clone(),s=e[e.length-1].clone();return this._cornerEntity[0].getCartesian().equal(t)&&this._cornerEntity[1].getCartesian().equal(s)}return!1}frame(){let e=this._trackEntity.polyline.getPath3v()[0];if(e){const t=e[0].clone(),s=e[e.length-1].clone();if(!this.isCornersPositionChanged()&&(this._cornerEntity[0].setCartesian3v(t),this._cornerEntity[1].setCartesian3v(s),!this._ignoreTerrain)){let n=0;for(let o=0,a=e.length-1;o<a;o++)n+=e[o+1].distance(e[o]);this._propsLabel.setCartesian3v(e[Math.floor(e.length/2)]),this._propsLabel.label.setText(`${kn(n)}, ${Math.round(this._heading)} deg`)}}}get ellipsoid(){return this._planet?this._planet.ellipsoid:null}}const Sl=["add","remove","mousemove","mouseenter","mouseleave","lclick","rclick","mclick","ldblclick","rdblclick","mdblclick","lup","rup","mup","ldown","rdown","mdown","lhold","rhold","mhold","mousewheel","touchmove","touchstart","touchend","doubletouch","touchleave","touchenter"];class da extends Z{constructor(e={}){super(e),this._rulerScene=new ca({name:`rulerScene:${this.__id}`,ignoreTerrain:e.ignoreTerrain})}set ignoreTerrain(e){this._rulerScene.ignoreTerrain=e}oninit(){this._rulerScene.bindPlanet(this.planet)}onactivate(){this.renderer&&this.renderer.addNode(this._rulerScene)}ondeactivate(){this.renderer&&this.renderer.removeNode(this._rulerScene)}}let Rl=W.createCylinder(1.1,0,2,6,1,!0,!0,0,0,0);const zn={startColor:"rgb(255,131,0)",endColor:"rgb(255,131,0)",thickness:5},js={text:"",size:11,color:"rgba(455,455,455,1.0)",outlineColor:"rgba(0,0,0,0.34)",outline:.23,align:"center",offset:[0,18,0]},Dn={scale:1,instanced:!0,tag:"height-ruler",color:"rgb(255,131,0)",object3d:Rl};class Ml extends ca{constructor(e={}){super(e),this._geoRulerLayer=new ut("rayHeightRuler",{entities:[],pickingEnabled:!1,polygonOffsetUnits:-2,relativeToGround:!1,hideInLayerSwitcher:!0}),this._rayV=new V({name:"verticalRay",ray:zn}),this._rayH=new V({name:"heightRay",ray:zn}),this._heightLabels=[new V({name:"startCornerLabel",label:{...js}}),new V({name:"endCornerLabel",label:{...js}}),new V({name:"deltaLabel",label:{...js}})]}setVisibility(e){super.setVisibility(e),this._geoRulerLayer.setVisibility(e)}get deltaLabel(){return this._heightLabels[2]}get startLabel(){return this._heightLabels[0]}get endLabel(){return this._heightLabels[1]}get corners(){return this._cornerEntity}get startCorner(){return this.corners[0]}get endCorner(){return this.corners[1]}get startCornerLonLat(){return this.startCorner.getLonLat()}get startCornerHeight(){return this.startCornerLonLat.height}get endCornerLonLat(){return this.endCorner.getLonLat()}get endCornerHeight(){return this.endCornerLonLat.height}get maxHeightCornerLonLat(){return this.startCornerHeight<=this.endCornerHeight?this.endCornerLonLat:this.startCornerLonLat}get minHeightCornerLonLat(){return this.startCornerHeight>this.endCornerHeight?this.endCornerLonLat:this.startCornerLonLat}get deltaHeight(){return Math.abs(this.startCornerHeight-this.endCornerHeight)}_drawLine(e,t,s){super._drawLine(e,t,s),this._updateHeightRaysAndLabels()}async _updateHeightRaysAndLabels(){const e=this.minHeightCornerLonLat.clone();e.height=this.maxHeightCornerLonLat.height,this._rayH.ray.setStartPosition3v(this._planet.ellipsoid.lonLatToCartesian(this.maxHeightCornerLonLat)),this._rayH.ray.setEndPosition3v(this._planet.ellipsoid.lonLatToCartesian(e)),this._rayV.ray.setStartPosition3v(this._planet.ellipsoid.lonLatToCartesian(this.minHeightCornerLonLat)),this._rayV.ray.setEndPosition3v(this._planet.ellipsoid.lonLatToCartesian(e)),e.height=this.minHeightCornerLonLat.height+this.deltaHeight/2,this.deltaLabel.setLonLat(e),this.startLabel.setLonLat(this.startCornerLonLat),this.endLabel.setLonLat(this.endCornerLonLat);const t=await this._planet.getHeightDefault(this.startCornerLonLat),s=await this._planet.getHeightDefault(this.endCornerLonLat);this.deltaLabel.label.setText(`Δ ${Math.abs(t-s).toFixed(1)} m`),this.startLabel.label.setText(`P1 ${t.toFixed(1)} m`),this.endLabel.label.setText(`P2 ${s.toFixed(1)} m`)}clear(){this._rayH.remove(),this._rayV.remove(),this.startCorner.remove(),this.endCorner.remove(),this.startLabel.remove(),this.endLabel.remove(),this.deltaLabel.remove(),super.clear(),this._planet.removeLayer(this._geoRulerLayer)}_createCorners(){this._cornerEntity=[new V({geoObject:Dn,properties:{name:"start"}}),new V({geoObject:Dn,properties:{name:"end"}})],this._cornersLayer.setEntities(this._cornerEntity)}init(){super.init(),this._createCorners(),this._labelLayer.addEntities(this._heightLabels),this._geoRulerLayer.addEntities([this._rayH,this._rayV]),this._planet.addLayer(this._geoRulerLayer)}frame(){super.frame(),this._updateHeightRaysAndLabels()}}class Fn extends da{constructor(e={}){super(e),this._rulerScene=new Ml({name:`heightRulerScene:${this.__id}`,ignoreTerrain:!1})}}const qs=[.001,.005,.01,.05,.1,.2,.5,1,2,3,5,10,20,30,50,100,200,300,500,1e3,2e3,3e3,5e3,1e4,2e4,3e4,5e4,1e5,2e5,3e5,5e5,1e6,2e6,3e6,5e6,1e7];class ua extends Z{constructor(e={}){e.name&&e.name!==""||(e.name="scaleControl"),super(e),this._template=`<div class="og-scale-container">
      <div class="og-scale-label"></div>
      <div class="og-scale-ruler"></div>
    </div>`,this._minWidth=100,this._maxWidth=150,this._isCenter=e.isCenter==null||e.isCenter,this._mPx=0,this.currWidth=0,this._metersInMinSize=0,this.el=null,this._scaleLabelEl=null}_renderTemplate(){return jr(this._template)[0]}oninit(){this.el=this._renderTemplate(),this._scaleLabelEl=this.el.querySelector(".og-scale-label"),this.renderer.div.appendChild(this.el),this._isCenter?(this.planet.camera.events.on("moveend",()=>{this._drawScreen(this.planet.renderer.handler.getCenter())}),!this.planet.terrain.isEmpty&&this.planet.terrain.events.on("loadend",()=>{this._drawScreen(this.planet.renderer.handler.getCenter())})):(this.renderer.events.on("mousemove",e=>{e.leftButtonHold||e.rightButtonHold||this._drawScreen(e.pos)}),this.planet.camera.events.on("moveend",()=>{let e=this.renderer.events.mouseState;e.leftButtonHold||e.rightButtonHold||this._drawScreen(e.pos)}))}_drawScreen(e){let t=this.planet.camera,s=e,n=this.planet.getDistanceFromPixel(s)||0;n===0&&(s=t.project3v(m.ZERO),n=this.planet.getDistanceFromPixel(s)||0);let o=t.getForward().scaleTo(n).addA(t.eye),a=n*Math.tan(t.viewAngle*U),h=o.add(t.getRight().scaleTo(a)),c=t.project3v(h);this._mPx=a/c.distance(s);let d=this._mPx*this._minWidth,u=Se(qs,d,(v,g)=>v-g);u<0&&(u=~u);let _=qs[u],f=(_-d)/(qs[u+1]-_);this.currWidth=this._minWidth+f*(this._maxWidth-this._minWidth),this._scaleLabelEl.innerText=_>=1e3?_/1e3+" km":_>=1?`${_} m`:_>=.01?100*_+" cm":1e3*_+" mm",this._metersInMinSize=d,this.el.style.width=this.currWidth+"px"}}class _a extends Z{constructor(e={}){super({name:"SimpleSkyBackground",...e}),this._colorOne=new Float32Array([128/255,223/255,1]),this._colorTwo=new Float32Array([10/255,15/255,56/255])}get colorOne(){let e=this._colorOne;return ar([Math.round(255*e[0]),Math.round(255*e[1]),Math.round(255*e[2])])}get colorTwo(){let e=this._colorTwo;return ar([Math.round(255*e[0]),Math.round(255*e[1]),Math.round(255*e[2])])}set colorOne(e){let t=Qi(e);this._colorOne[0]=t.x,this._colorOne[1]=t.y,this._colorOne[2]=t.z}set colorTwo(e){let t=Qi(e);this._colorTwo[0]=t.x,this._colorTwo[1]=t.y,this._colorTwo[2]=t.z}oninit(){this.renderer.handler.addProgram(new $("simpleSkyBackground",{uniforms:{iResolution:"vec2",fov:"float",camPos:"vec3",earthRadius:"float",viewMatrix:"mat4",colorOne:"vec3",colorTwo:"vec3"},attributes:{corners:"vec3"},vertexShader:`attribute vec2 corners;
                        
            varying vec2 tc;
            
            void main(void) {
                gl_Position = vec4(corners, 0.0, 1.0);
                tc = corners * 0.5 + 0.5;
            }`,fragmentShader:`precision highp float;
            
            #define MAX 10e10
            #define PI 3.14159265359
            #define rad(x) x * PI / 180.
            #define ZERO vec3(0.0)          
           
            #define RED vec4(1.0, 0.0, 0.0, 1.0)
            #define GREEN vec4(0.0, 1.0, 0.0, 1.0)         
            
            uniform vec3 camPos;            
            uniform vec2 iResolution;
            uniform float fov;
            uniform float earthRadius;
            uniform mat4 viewMatrix;
            
            uniform vec3 colorOne;
            uniform vec3 colorTwo;
                         
            varying vec2 tc;
                        
            // compute the view ray in the camera coordinate
            vec3 computeView(vec2 uv){
                float w_h_ratio = iResolution.x / iResolution.y;   
                float h = tan(rad(fov/2.));
                return normalize(vec3(-w_h_ratio * h, -h, -1.) + vec3(uv.x * 2. * h * w_h_ratio, uv.y*2.*h, 0.));
            }

            // sphere of size ra centered at point ce
            vec2 sphIntersect( in vec3 ro, in vec3 rd, in vec3 ce, float ra )
            {
                vec3 oc = ro - ce;
                float b = dot( oc, rd );
                float c = dot( oc, oc ) - ra * ra;
                float h = b * b - c;
                if( h < 0.0 ) return vec2(MAX); // no intersection
                h = sqrt( h );
                return vec2( -b-h, -b+h );
            }
            
            mat3 transpose(mat3 matrix) {
                vec3 row0 = matrix[0];
                vec3 row1 = matrix[1];
                vec3 row2 = matrix[2];
                mat3 result = mat3(
                    vec3(row0.x, row1.x, row2.x),
                    vec3(row0.y, row1.y, row2.y),
                    vec3(row0.z, row1.z, row2.z)
                );
                return result;
            }
            
            float det(mat2 matrix) {
                return matrix[0].x * matrix[1].y - matrix[0].y * matrix[1].x;
            }
            
            mat3 inverse(mat3 matrix) {
                vec3 row0 = matrix[0];
                vec3 row1 = matrix[1];
                vec3 row2 = matrix[2];
            
                vec3 minors0 = vec3(
                    det(mat2(row1.y, row1.z, row2.y, row2.z)),
                    det(mat2(row1.z, row1.x, row2.z, row2.x)),
                    det(mat2(row1.x, row1.y, row2.x, row2.y))
                );
                vec3 minors1 = vec3(
                    det(mat2(row2.y, row2.z, row0.y, row0.z)),
                    det(mat2(row2.z, row2.x, row0.z, row0.x)),
                    det(mat2(row2.x, row2.y, row0.x, row0.y))
                );
                vec3 minors2 = vec3(
                    det(mat2(row0.y, row0.z, row1.y, row1.z)),
                    det(mat2(row0.z, row0.x, row1.z, row1.x)),
                    det(mat2(row0.x, row0.y, row1.x, row1.y))
                );
            
                mat3 adj = transpose(mat3(minors0, minors1, minors2));
            
                return (1.0 / dot(row0, minors0)) * adj;
            }
            
            void main(void) {
            
                vec3 dir = computeView(tc);
                dir = inverse(mat3(viewMatrix)) * dir;
                
                vec2 ER = sphIntersect(camPos, dir, vec3(0.0), earthRadius);
                
                float bigRadius = earthRadius * 2.5;
                vec3 bigCenter = normalize(camPos) * bigRadius * 1.3;                
                               
                vec2 BIG = sphIntersect(camPos, dir, bigCenter, bigRadius);
                
                float Ix = distance(camPos + dir * BIG.y, ZERO);               
                
                float maxI = sqrt(bigRadius * bigRadius + bigRadius * bigRadius);
                                   
                gl_FragColor = vec4(mix(colorOne, colorTwo, Ix / maxI), 1.0);
            }`})),this.activate()}onactivate(){super.onactivate(),this.planet.events.on("draw",this._drawBackground,this)}ondeactivate(){super.ondeactivate(),this.planet.events.off("draw",this._drawBackground)}_drawBackground(){let e=this.renderer.handler,t=e.programs.simpleSkyBackground,s=t._program,n=s.uniforms,o=e.gl,a=this.planet.camera;o.disable(o.DEPTH_TEST),t.activate(),o.bindBuffer(o.ARRAY_BUFFER,this.renderer.screenFramePositionBuffer),o.vertexAttribPointer(s.attributes.corners,2,o.FLOAT,!1,0,0),o.uniform3fv(n.camPos,[a.eye.x,a.eye.y,a.eye.z]),o.uniform2fv(n.iResolution,[e.getWidth(),e.getHeight()]),o.uniform1f(n.fov,a.getViewAngle()),o.uniform1f(n.earthRadius,this.planet.ellipsoid.getPolarSize()+1),o.uniform3fv(n.colorOne,this._colorOne),o.uniform3fv(n.colorTwo,this._colorTwo),o.uniformMatrix4fv(n.viewMatrix,!1,a.getViewMatrix()),o.drawArrays(o.TRIANGLE_STRIP,0,4),o.enable(o.DEPTH_TEST)}}const Ys=14959787e4;function Ws(l){var e=l-Ji,t=282.9404+470935e-10*e,s=.016709-1151e-12*e,n=or(356.047+.9856002585*e),o=23.4392911-3563e-10*e,a=n+Q*s*Math.sin(n*U)*(1+s*Math.cos(n*U)),h=Math.cos(a*U)-s,c=Math.sin(a*U)*Math.sqrt(1-s*s),d=Math.sqrt(h*h+c*c),u=or(Math.atan2(c,h)*Q+t),_=h=d*Math.cos(u*U),f=(c=d*Math.sin(u*U))*Math.cos(o*U),v=c*Math.sin(o*U),g=Wi*(24*e/23.9344694-259.853/360);return D.zRotation(-g).mulVec3(new m(-_*Ys,-f*Ys,v*Ys))}class Bl{constructor(e){this._renderNode=null,this._position=e.position||new m,this._ambient=e.ambient||new m,this._diffuse=e.diffuse||new m(.8,.8,.8),this._specular=e.specular||new m(.18,.18,.18),this._shininess=e.shininess!=null?e.shininess:3.3,this._active=!0,this._tempAmbient=this._ambient.clone(),this._tempDiffuse=this._diffuse.clone(),this._tempSpecular=this._specular.clone(),this._tempShininess=this._shininess}isActive(){return this._active}setPosition3v(e){this.setPosition(e.x,e.y,e.z)}setPosition(e,t,s){this._position.x=e,this._position.y=t,this._position.z=s,this._renderNode&&(this._renderNode._lightPosition[0]=e,this._renderNode._lightPosition[1]=t,this._renderNode._lightPosition[2]=s)}getPosition(){return this._position.clone()}setAmbient3v(e){this.setAmbient(e.x,e.y,e.z)}setDiffuse3v(e){this.setDiffuse(e.x,e.y,e.z)}setSpecular3v(e){this.setSpecular(e.x,e.y,e.z)}setAmbient(e,t,s){this._ambient.set(e,t,s);const n=this._renderNode;n&&(n._lightParams[0]=e,n._lightParams[1]=t,n._lightParams[2]=s)}setDiffuse(e,t,s){this._diffuse.set(e,t,s);const n=this._renderNode;n&&(n._lightParams[3]=e,n._lightParams[4]=t,n._lightParams[5]=s)}setSpecular(e,t,s){this._specular.set(e,t,s);const n=this._renderNode;n&&(n._lightParams[6]=e,n._lightParams[7]=t,n._lightParams[8]=s)}setShininess(e){this._shininess=e;const t=this._renderNode;t&&(t._lightShininess=e)}addTo(e){this._renderNode=e,this.setShininess(this._shininess),this.setAmbient3v(this._ambient),this.setDiffuse3v(this._diffuse),this.setSpecular3v(this._specular)}}class kr extends Z{constructor(e={}){super({autoActivate:!0,...e}),this._name="sun",this.activationHeight=e.activationHeight||12079e3,this.offsetVertical=e.offsetVertical||-5e6,this.offsetHorizontal=e.offsetHorizontal||5e6,this.sunlight=new Bl({ambient:new m(.15,.15,.25),diffuse:new m(.9,.9,.8),specular:new m(.1,.1,.06),shininess:110}),this._currDate=0,this._prevDate=0,this._clockPtr=null,this._lightOn=!1,this._f=0,this._k=0,this._stopped=e.stopped||!1}oninit(){this.planet.lightEnabled=!0,this.sunlight.addTo(this.planet),this.renderer.events.on("draw",this._draw,this),this._clockPtr||(this._clockPtr=this.renderer.handler.defaultClock)}stop(){this._stopped=!0,this.deactivate()}start(){this._stopped=!1,this.activate()}onactivate(){super.onactivate(),this._stopped=!1}bindClock(e){this._clockPtr=e}_draw(){if(this._clockPtr)if(this._currDate=this._clockPtr.currentDate,this._stopped)this.sunlight.setPosition3v(Ws(this._currDate));else{let e=this.planet.camera;if(e.getHeight()<this.activationHeight||!this._active){this._lightOn=!0,this._f=1;let t=e.eye.normal(),s=e.getForward();s.scale(Math.sign(e.getUp().dot(t))),e.slope>.99&&(s=e.getUp());let n=m.proj_b_to_plane(s,t,s).normalize().scale(this.offsetVertical),o=m.proj_b_to_plane(e.getRight(),t,e.getRight()).normalize().scale(this.offsetHorizontal),a=n.add(o),h=e.eye.add(a);if(this._k>0){this._k-=.001;let c=D.getRotationBetweenVectors(this.sunlight._position.normal(),h.normal()).slerp(D.IDENTITY,this._k).normalize();this.sunlight.setPosition3v(c.mulVec3(this.sunlight._position))}else this.sunlight.setPosition3v(h)}else if(this._k=1,this._f>0){this._f-=.001;let t=D.getRotationBetweenVectors(this.sunlight._position.normal(),Ws(this._currDate).normal()).slerp(D.IDENTITY,this._f).normalize();this.sunlight.setPosition3v(t.mulVec3(this.sunlight._position))}else(Math.abs(this._currDate-this._prevDate)>34e-5&&this._active||this._lightOn)&&(this._lightOn=!1,this._prevDate=this._currDate,this.sunlight.setPosition3v(Ws(this._currDate)),this._f=0)}}}const kl=["inertiamove","drag","doubletapzoom"];class On{constructor(){this.x=0,this.y=0,this.prev_x=0,this.prev_y=0,this.grabbedPoint=null,this.grabbedSpheroid=new Dt,this._vec=new O,this._vecPrev=new O}get dY(){return this.y-this.prev_y}get dX(){return this.x-this.prev_x}get vec(){return this._vec.set(this.x,this.y)}get vecPrev(){return this._vecPrev.set(this.prev_x,this.prev_y)}}class fa extends Z{constructor(e={}){super(e),this._onCameraFly=()=>{this.stopRotation()},this._name="touchNavigation",this.events=ot(kl,this),this.grabbedPoint=new m,this.inertia=e.inertia!=null?e.inertia:.007,this.minSlope=e.minSlope!=null?e.minSlope:.1,this.jerkLimit=e.jerkLimit!=null?e.jerkLimit:.3,this.grabbedSpheroid=new Dt,this.planet=null,this.qRot=new D,this.scaleRot=0,this.rot=1,this._eye0=new m,this.pointOnEarth=null,this.earthUp=null,this.touches=[new On,new On],this._keyLock=new Re,this._touching=!1}oninit(){this.renderer&&(this.renderer.events.on("touchstart",this.onTouchStart,this),this.renderer.events.on("touchend",this.onTouchEnd,this),this.renderer.events.on("doubletouch",this.onDoubleTouch,this),this.renderer.events.on("touchcancel",this.onTouchCancel,this),this.renderer.events.on("touchmove",this.onTouchMove,this),this.renderer.events.on("draw",this.onDraw,this))}onadd(){var e;(e=this.planet)!=null&&e.camera&&this.planet.camera.events.on("flystart",this._onCameraFly)}onremove(){var e;(e=this.planet)!=null&&e.camera&&this.planet.camera.events.off("flystart",this._onCameraFly)}onTouchStart(e){const t=this.renderer.handler;if(this._touching=!0,e.sys.touches.length===2){const s=this.touches[0],n=this.touches[1];s.x=(e.sys.touches.item(0).clientX-e.sys.offsetLeft)*t.pixelRatio,s.y=(e.sys.touches.item(0).clientY-e.sys.offsetTop)*t.pixelRatio,s.prev_x=s.x,s.prev_y=s.y,s.grabbedPoint=this.planet.getCartesianFromPixelTerrain(new O(s.x,s.y))||null,n.x=(e.sys.touches.item(1).clientX-e.sys.offsetLeft)*t.pixelRatio,n.y=(e.sys.touches.item(1).clientY-e.sys.offsetTop)*t.pixelRatio,n.prev_x=n.x,n.prev_y=n.y,n.grabbedPoint=this.planet.getCartesianFromPixelTerrain(new O(n.x,n.y))||null,this.pointOnEarth=this.planet.getCartesianFromPixelTerrain(this.renderer.handler.getCenter())||null,this.pointOnEarth&&(this.earthUp=this.pointOnEarth.normal()),s.grabbedPoint&&n.grabbedPoint&&(s.grabbedSpheroid.radius=s.grabbedPoint.length(),n.grabbedSpheroid.radius=n.grabbedPoint.length(),this.stopRotation())}else e.sys.touches.length===1&&this._startTouchOne(e)}_startTouchOne(e){const t=this.touches[0],s=this.renderer.handler;t.x=(e.sys.touches.item(0).clientX-e.sys.offsetLeft)*s.pixelRatio,t.y=(e.sys.touches.item(0).clientY-e.sys.offsetTop)*s.pixelRatio,t.prev_x=t.x,t.prev_y=t.y,t.grabbedPoint=this.planet.getCartesianFromPixelTerrain(e)||null,this._eye0.copy(this.planet.camera.eye),t.grabbedPoint&&(t.grabbedSpheroid.radius=t.grabbedPoint.length(),this.stopRotation())}stopRotation(){this.qRot.clear(),this.planet.layerLock.free(this._keyLock),this.planet.terrainLock.free(this._keyLock),this.planet._normalMapCreator.free(this._keyLock)}onDoubleTouch(e){this.planet.stopFlying(),this.stopRotation();const t=this.planet.getCartesianFromPixelTerrain(e);if(t){const s=this.planet.ellipsoid.cartesianToLonLat(t);this.planet.flyLonLat(new A(s.lon,s.lat,.57*this.planet.camera.eye.distance(t))),this.events.dispatch(this.events.doubletapzoom,this)}}onTouchEnd(e){e.sys.touches.length===0&&(this._touching=!1),e.sys.touches.length===1&&this._startTouchOne(e),Math.abs(this.touches[0].x-this.touches[0].prev_x)<3&&Math.abs(this.touches[0].y-this.touches[0].prev_y)<3&&(this.scaleRot=0)}onTouchCancel(e){}onTouchMove(e){let t=this.planet.camera;const s=this.renderer.handler;if(e.sys.touches.length===2){this.renderer.controlsBag.scaleRot=1;let o=this.touches[0],a=this.touches[1];if(!o.grabbedPoint||!a.grabbedPoint)return;this.planet.stopFlying(),o.prev_x=o.x,o.prev_y=o.y,o.x=(e.sys.touches.item(0).clientX-e.sys.offsetLeft)*s.pixelRatio,o.y=(e.sys.touches.item(0).clientY-e.sys.offsetTop)*s.pixelRatio,a.prev_x=a.x,a.prev_y=a.y,a.x=(e.sys.touches.item(1).clientX-e.sys.offsetLeft)*s.pixelRatio,a.y=(e.sys.touches.item(1).clientY-e.sys.offsetTop)*s.pixelRatio;const h=o.vec.add(a.vec).scale(.5),c=this.planet.getCartesianFromPixelEllipsoid(h);if(c){this.pointOnEarth=c;const d=Math.atan2(o.prev_y-a.prev_y,o.prev_x-a.prev_x),u=Math.atan2(o.y-a.y,o.x-a.x)-d,_=t.eye.distance(this.pointOnEarth),f=o.vec.sub(a.vec),v=o.vecPrev.sub(a.vecPrev);let g=f.length()/v.length();const y=1+this.jerkLimit,p=1-this.jerkLimit;g=g>y?y:g<p?p:g;let x=_*-(1-g);t.eye.addA(t.getForward().scale(x)),t.rotateAround(-u,!1,this.pointOnEarth,this.earthUp);const T=o.vec.add(a.vec).scale(.5),w=o.vecPrev.add(a.vecPrev).scale(.5),C=T.sub(w).scale(-1);var n=.5/_*t._lonLat.height*U;n>.003&&(n=.003),t.rotateHorizontal(n*-C.x,!1,this.pointOnEarth,this.earthUp),t.rotateVertical(n*-C.y,this.pointOnEarth,this.minSlope),t.checkTerrainCollision(),t.update(),this.events.dispatch(this.events.drag,this)}this.scaleRot=0}else if(e.sys.touches.length===1){let o=this.touches[0];if(o.prev_x=o.x,o.prev_y=o.y,o.x=(e.sys.touches.item(0).clientX-e.sys.offsetLeft)*s.pixelRatio,o.y=(e.sys.touches.item(0).clientY-e.sys.offsetTop)*s.pixelRatio,!o.grabbedPoint)return;this.planet.stopFlying();let a=e.direction,h=new N(t.eye,a).hitSphere(o.grabbedSpheroid);if(h)if(t.slope>.2){this.qRot=D.getRotationBetweenVectors(h.normal(),o.grabbedPoint.normal());let c=this.qRot;t.eye=c.mulVec3(t.eye),t.rotate(c),t.checkTerrainCollision(),t.update(),this.events.dispatch(this.events.drag,this),this.scaleRot=1}else{let c=o.grabbedPoint,d=m.add(c,t.getUp()),u=m.add(c,c.getNormal()),_=t.unproject(o.x,o.y),f=new m;new N(t.eye,_).hitPlaneRes(mt.fromPoints(c,d,u),f)===N.INSIDE&&(t.eye=this._eye0.addA(f.subA(c).negate()),t.checkTerrainCollision(),t.update(),this.events.dispatch(this.events.drag,this),this.scaleRot=0)}}}onDraw(){const e=this.renderer;if(e.controlsBag.scaleRot=this.scaleRot,this._touching)return;let t=this.planet.camera,s=t.eye.clone();if(!e.events.mouseState.leftButtonDown&&this.scaleRot){if(this.scaleRot-=this.inertia,this.scaleRot<=0)this.scaleRot=0;else{e.controlsBag.scaleRot=this.scaleRot;let n=this.qRot.slerp(D.IDENTITY,1-this.scaleRot*this.scaleRot*this.scaleRot).normalize();n.x||n.y||n.z||(this.scaleRot=0),t.eye=n.mulVec3(t.eye),t.rotate(n),t.checkTerrainCollision(),t.update(),this.events.dispatch(this.events.inertiamove,this)}this.setLock(t.eye.distance(s)/t.getAltitude()>.01)}}setLock(e){e?(this.planet.layerLock.lock(this._keyLock),this.planet.terrainLock.lock(this._keyLock),this.planet._normalMapCreator.lock(this._keyLock)):(this.planet.layerLock.free(this._keyLock),this.planet.terrainLock.free(this._keyLock),this.planet._normalMapCreator.free(this._keyLock))}}class ga extends Z{constructor(e={}){super(e),this._keyLock=new Re,this._move=0,this._targetPoint=null}oninit(){let e=new he({classList:["og-map-button","og-zoomin-button"],icon:'<?xml version="1.0"?><svg width=24 height=24 xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">    <path d="M 11 5 L 11 11 L 5 11 L 5 13 L 11 13 L 11 19 L 13 19 L 13 13 L 19 13 L 19 11 L 13 11 L 13 5 L 11 5 z"/></svg>'});e.appendTo(this.renderer.div);let t=new he({classList:["og-map-button","og-zoomout-button"],icon:'<?xml version="1.0"?><svg width=24 height=24 xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">    <path d="M 5 11 L 5 13 L 19 13 L 19 11 L 5 11 z"/></svg>'});t.appendTo(this.renderer.div),e.events.on("mousedown",()=>this.zoomIn()),e.events.on("mouseup",()=>this.stopZoom()),t.events.on("mousedown",()=>this.zoomOut()),t.events.on("mouseup",()=>this.stopZoom()),e.events.on("touchstart",()=>this.zoomIn()),e.events.on("touchend",()=>this.stopZoom()),e.events.on("touchcancel",()=>this.stopZoom()),t.events.on("touchstart",()=>this.zoomOut()),t.events.on("touchend",()=>this.stopZoom()),t.events.on("touchcancel",()=>this.stopZoom()),this.renderer.events.on("draw",this._draw,this)}zoomIn(){this.planet.layerLock.lock(this._keyLock),this.planet.terrainLock.lock(this._keyLock),this.planet._normalMapCreator.lock(this._keyLock),this._targetPoint=this.renderer.getCenter(),this._move=1}zoomOut(){this.planet.layerLock.lock(this._keyLock),this.planet.terrainLock.lock(this._keyLock),this.planet._normalMapCreator.lock(this._keyLock),this._targetPoint=this.renderer.getCenter(),this._move=-1}stopZoom(){this._move=0,this.planet.layerLock.free(this._keyLock),this.planet.terrainLock.free(this._keyLock),this.planet._normalMapCreator.free(this._keyLock)}_draw(e){const t=this.planet.camera;if(this._move!==0){const s=this.planet.getCartesianFromPixelTerrain(e.getCenter());if(s){let n=.035*t.eye.distance(s);t.eye.addA(t.getForward().scale(this._move*n)),t.checkTerrainCollision(),t.update()}}}}class Il extends ce{constructor(e={}){var t,s;super(e.name),this._ignoreTerrain=!1,this.events=new xi(zl),this._ignoreTerrain=e.ignoreTerrain==null||e.ignoreTerrain,this._onSelect=e.onSelect||null,this._autoSelectionHide=e.autoSelectionHide||!1,this._planet=e.planet||null,this._startLonLat=null,this._heading=0,this._propsLabel=new V({name:"propsLabel",label:{text:"",size:11,color:"rgba(455,455,455,1.0)",outlineColor:"rgba(0,0,0,0.34)",outline:.23,align:"center",offset:[0,18]}}),(s=(t=this._propsLabel)==null?void 0:t.label)==null||s.setVisibility(!1),this._trackEntity=new V({polyline:{path3v:[],thickness:3.8,color:"rgb(455,455,455)",isClosed:!1}}),this._trackEntity.polyline.altitude=.01;let n=W.createCylinder(1.1,0,2.7,20,1,!0,!1,0,0,0);this._cornerEntity=[new V({geoObject:{scale:1,instanced:!0,tag:"selection",color:"rgb(0,305,0)",object3d:n},properties:{name:"start"}}),new V({geoObject:{scale:1,instanced:!0,tag:"selection",color:"rgb(455,0,0)",object3d:n},properties:{name:"end"}})],this._trackLayer=new ut("track",{entities:[this._trackEntity,this._propsLabel],pickingEnabled:!1,polygonOffsetUnits:-1,relativeToGround:!0,hideInLayerSwitcher:!1}),this._cornersLayer=new ut("corners",{entities:[this._cornerEntity[0],this._cornerEntity[1]],pickingEnabled:!0,hideInLayerSwitcher:!0,scaleByDistance:[1,4e6,.01],pickingScale:2})}set ignoreTerrain(e){this._ignoreTerrain=e}bindPlanet(e){this._planet=e}init(){this._activate()}onremove(){this._deactivate()}_activate(){var e,t,s,n,o;(t=(e=this._propsLabel)==null?void 0:e.label)==null||t.setVisibility(!1),this._onMouseMove_=this._onMouseMove.bind(this),(s=this.renderer)==null||s.events.on("mousemove",this._onMouseMove_,this),this._onMouseLdown_=this._onMouseLdown.bind(this),(n=this.renderer)==null||n.events.on("ldown",this._onMouseLdown_,this),this._onMouseLup_=this._onMouseLup.bind(this),(o=this.renderer)==null||o.events.on("lup",this._onMouseLup_,this),this._planet.addLayer(this._trackLayer),this._planet.addLayer(this._cornersLayer)}_deactivate(){var e,t,s;this._startLonLat=null,this._trackLayer.remove(),this._cornersLayer.remove(),(e=this.renderer)==null||e.events.off("mousemove",this._onMouseMove_),(t=this.renderer)==null||t.events.off("ldown",this._onMouseLdown_),(s=this.renderer)==null||s.events.off("lup",this._onMouseLup_),this.clear(),this._onMouseMove_=null,this._onMouseLdown_=null,this._onMouseLup_=null}_onMouseLdown(e){var t,s,n,o,a,h;if(e.renderer.handler.canvas.classList.remove("ogGrabbingPoiner"),e.renderer.handler.canvas.style.cursor="pointer",!this._startLonLat){(t=this._propsLabel.label)==null||t.setVisibility(!1),(s=this._trackEntity.polyline)==null||s.setPath3v([]),(n=this._cornerEntity[0].geoObject)==null||n.setVisibility(!0),(o=this._cornerEntity[1].geoObject)==null||o.setVisibility(!0),(h=(a=this.renderer)==null?void 0:a.controls.mouseNavigation)==null||h.deactivate(),this._startLonLat=this._planet.getLonLatFromPixelTerrain(e);let c=this._planet.ellipsoid.lonLatToCartesian(this._startLonLat);this._cornerEntity[0].setCartesian3v(c),this._cornerEntity[1].setCartesian3v(c)}}_onMouseLup(e){var t,s,n;if(this._startLonLat){if(this._pickedCorner=null,this._anchorLonLat=null,(t=this._propsLabel.label)==null||t.setVisibility(!0),this._onSelect&&typeof this._onSelect=="function"){let o=this._cornerEntity[0].getLonLat(),a=this._cornerEntity[1].getLonLat(),h=[Math.min(o.lon,a.lon),Math.min(o.lat,a.lat),Math.max(o.lon,a.lon),Math.max(o.lat,a.lat)];this._onSelect(h)}this._autoSelectionHide&&this.clear(),this._startLonLat=null}e.renderer.handler.canvas.style.cursor="default",(n=(s=this.renderer)==null?void 0:s.controls.mouseNavigation)==null||n.activate()}_drawLine(e,t,s){var n;s||(s=this._planet.ellipsoid.lonLatToCartesian(e));let o=this._planet.ellipsoid.lonLatToCartesian(t),a=this._planet.ellipsoid.direct(e,t);this._heading=a.initialAzimuth;let h=[];this._cornerEntity[0].setCartesian3v(s),this._cornerEntity[1].setCartesian3v(o);let c=[s,this._planet.ellipsoid.lonLatToCartesian(new A(t.lon,e.lat,e.height)),o,this._planet.ellipsoid.lonLatToCartesian(new A(e.lon,t.lat,e.height)),s];h.push(s);let d=(u,_)=>{let f=_.sub(u),v=f.length();f.normalize();for(let g=0;g<120;g++){let y=f.scaleTo(g*v/120).addA(u);h.push(y)}};for(let u=0;u<c.length-1;u++)d(c[u],c[u+1]);(n=this._trackEntity.polyline)==null||n.setPath3v([h]),this._ignoreTerrain}_onMouseMove(e){var t;if(this._startLonLat){(t=this._propsLabel.label)==null||t.setVisibility(!0);let s=this._planet.getLonLatFromPixelTerrain(e);if(!s)return;this._drawLine(this._startLonLat,s)}}clear(){var e,t,s;(e=this._trackEntity.polyline)==null||e.clear(),(t=this._cornerEntity[0].geoObject)==null||t.setVisibility(!1),(s=this._cornerEntity[1].geoObject)==null||s.setVisibility(!1)}frame(){var e,t;let s=(e=this._trackEntity.polyline)==null?void 0:e.getPath3v()[0];if(s&&!this._ignoreTerrain){let o=0;for(let a=0,h=s.length-1;a<h;a++)o+=s[a+1].distance(s[a]);this._propsLabel.setCartesian3v(s[Math.floor(s.length/2)]),(t=this._propsLabel.label)==null||t.setText(`${n=o,n>1e3?`${(n/1e3).toFixed(1)} km`:n>9?`${Math.round(n)} m`:`${n.toFixed(1)} m`}, ${Math.round(this._heading)} deg`)}var n}get ellipsoid(){return this._planet?this._planet.ellipsoid:null}}const zl=["add","remove","mousemove","mouseenter","mouseleave","lclick","rclick","mclick","ldblclick","rdblclick","mdblclick","lup","rup","mup","ldown","rdown","mdown","lhold","rhold","mhold","mousewheel","touchmove","touchstart","touchend","doubletouch","touchleave","touchenter"];function Qt(l,e){return new Date(+l+1e3*e)}function Dl(l,e=!0,t=!1){let s=Ol[l.getMonth()],n=l.getUTCDate(),o=l.getUTCFullYear();if(e){let a=l.getUTCHours().toString().padStart(2,"0"),h=l.getUTCMinutes().toString().padStart(2,"0"),c=l.getUTCSeconds().toString().padStart(2,"0");return t?`${s} ${n} ${o} ${a}:${h}:${c}.${l.getUTCMilliseconds().toString().padStart(3,"0")}`:`${s} ${n} ${o} ${a}:${h}:${c}`}return`${s} ${n} ${o}`}function Nn(l,e=0,t=10,s=2,n="white"){l.lineWidth=s,l.strokeStyle=n,l.beginPath(),l.moveTo(e,0),l.lineTo(e,t),l.stroke()}function Fl(l,e,t,s,n="12px Arial",o="black",a="left",h="bottom",c=0){l.save(),l.translate(t,s),l.rotate(c*U),l.fillStyle=o,l.textBaseline=h,l.font=n,l.textAlign=a,l.fillText(e,0,0),l.restore()}const $s=[[.001,10],[.002,10],[.005,10],[.01,10],[.02,10],[.05,10],[.1,10],[.25,10],[.5,5],[1,10],[2,10],[5,5],[10,10],[15,15],[30,6],[60,12],[120,12],[300,5],[600,10],[900,15],[1800,6],[3600,12],[7200,10],[14400,4],[21600,6],[43200,12],[86400,24],[172800,2],[345600,4],[604800,7],[1296e3,15],[2592e3,5],[5184e3,6],[7776e3,9],[15552e3,18],[31536e3,12],[63072e3,2],[126144e3,4],[15768e4,5],[31536e4,10],[63072e4,2],[126144e4,4],[15768e5,5],[31536e5,10],[63072e5,2],[126144e5,4],[15768e6,5],[31536e6,10]],Ol=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],Nl=["change","current"];class Hl{constructor(e={}){this.events=ot(Nl),this._current=e.current||new Date,this._rangeStart=e.rangeStart||new Date,this._rangeEnd=e.rangeEnd||Qt(this._rangeStart,3600),this._range=this._rangeEnd.getTime()-this._rangeStart.getTime(),this._minDate=e.minDate||null,this._maxDate=e.maxDate||null,this.multiplier=e.multiplier!=null?e.multiplier:1,this._requestAnimationFrameId=0,this._prevNow=0,this.dt=0}play(){this._requestAnimationFrameId||(this._prevNow=window.performance.now(),this._animationFrameCallback())}stop(){this._requestAnimationFrameId&&(window.cancelAnimationFrame(this._requestAnimationFrameId),this._requestAnimationFrameId=0)}stopped(){return this._requestAnimationFrameId==0}_animationFrameCallback(){this._requestAnimationFrameId=window.requestAnimationFrame(()=>{this._frame(),this._animationFrameCallback()})}_frame(){let e=window.performance.now();this.dt=e-this._prevNow,this._prevNow=e,this.current=new Date(this.currentTime+this.dt*this.multiplier)}get range(){return this._range}set(e,t){e===this._rangeStart&&t===this._rangeEnd||(this._rangeStart=e,this._rangeEnd=t,this._range=this._rangeEnd.getTime()-this._rangeStart.getTime(),this.events.dispatch(this.events.change,e,t))}get current(){return this._current}get rangeStart(){return this._rangeStart}get rangeEnd(){return this._rangeEnd}get rangeStartTime(){return this._rangeStart.getTime()}get rangeEndTime(){return this._rangeEnd.getTime()}get currentTime(){return this._current.getTime()}set current(e){e!==this._current&&(this._maxDate&&e>this._maxDate?this._current=this._maxDate:this._minDate&&e<this._minDate?this._current=this._minDate:this._current=e,this.events.dispatch(this.events.current,this._current))}set rangeStart(e){e!==this._rangeStart&&(this._rangeStart=e,this._range=this._rangeEnd.getTime()-this._rangeStart.getTime(),this.events.dispatch(this.events.change,e))}set rangeEnd(e){e!==this._rangeEnd&&(this._rangeEnd=e,this._range=this._rangeEnd.getTime()-this._rangeStart.getTime(),this.events.dispatch(this.events.change,e))}}const De=.001,Vl=["startdrag","stopdrag","startdragcurrent","stopdragcurrent","setcurrent","reset","play","playback","pause","visibility"],Hn="#bfbfbf";class Ul extends dt{constructor(e={}){super({template:`<div class="og-timeline">

  <div class="og-timeline-top">
  </div>

  <div class="og-timeline-frame">
    <div class="og-timeline-current">
      <div class="og-timeline-current-spin">
        <div class="og-timeline-current-arrow"></div>
      </div>
    </div>
    <div class="og-timeline-scale"></div>
  </div>

  <div class="og-timeline-bottom">
    <div class="og-timeline-controls">
    </div>
  </div>

</div>`,model:new Hl({rangeStart:e.rangeStart,rangeEnd:e.rangeEnd,current:e.currentDate,minDate:e.minDate,maxDate:e.maxDate})}),this._onMouseWheel=t=>{if(this._isMouseOver){let s=this._canvasEl.getBoundingClientRect(),n=t.clientX-s.left,o=-(n-.5*this.clientWidth),a=this.model.rangeStartTime+this._millisecondsInPixel*n;this._zoom(a,o,Math.sign(t.wheelDelta))}else if(this._isCurrentMouseOver){let s=-((this.model.currentTime-this.model.rangeStartTime)/this._millisecondsInPixel-.5*this.clientWidth);this._zoom(this.model.currentTime,s,Math.sign(t.wheelDelta))}},this._onMouseWheelFF=t=>{this._onMouseWheel(t)},this._onMouseDown=t=>{this._isMouseOver?(this._isDragging=!0,document.body.classList.add("og-timeline-unselectable"),this._clickPosX=t.clientX,this._clickTime=Date.now(),this._clickRangeStart=this.model.rangeStart,this._clickRangeEnd=this.model.rangeEnd,this.events.dispatch(this.events.startdrag,t)):this._isCurrentMouseOver&&(this._isCurrentDragging=!0,document.body.classList.add("og-timeline-unselectable"),this._clickPosX=t.clientX,this._clickCurrentDate=this.model.current,this.events.dispatch(this.events.startdragcurrent,t))},this._onMouseUp=t=>{if(this._isDragging)if(this._isDragging=!1,document.body.classList.remove("og-timeline-unselectable"),this._clickPosX===t.clientX&&Date.now()-this._clickTime<this._clickDelay){let s=this._canvasEl.getBoundingClientRect(),n=new Date(this.model.rangeStartTime+(t.clientX-s.left)*this._millisecondsInPixel);this.model.current=n,this.events.dispatch(this.events.stopdrag,n),this.events.dispatch(this.events.setcurrent,n)}else this.events.dispatch(this.events.stopdrag,this.model.current);else this._isCurrentDragging&&(this._isCurrentDragging=!1,document.body.classList.remove("og-timeline-unselectable"),this.events.dispatch(this.events.stopdragcurrent,this.model.current))},this._onMouseEnter=()=>{this._isMouseOver=!0},this._onMouseOut=()=>{this._isMouseOver=!1},this._onCurrentMouseEnter=()=>{this._isCurrentMouseOver=!0},this._onCurrentMouseOut=()=>{this._isCurrentMouseOver=!1},this._onMouseMove=t=>{if(this._isDragging){let s=(this._clickPosX-t.clientX)*this._millisecondsInPixel*De;this.model.set(Qt(this._clickRangeStart,s),Qt(this._clickRangeEnd,s))}else if(this._isCurrentDragging){let s=(this._clickPosX-t.clientX)*this._millisecondsInPixel*De,n=Qt(this._clickCurrentDate,-s);n>=this.model.rangeStart&&n<=this.model.rangeEnd&&(this.model.current=Qt(this._clickCurrentDate,-s))}},this.events=this.events.registerNames(Vl),this.fillStyle=e.fillStyle||"rgba(64, 59, 59, 1.0)",this.$controls=null,this._frameEl=null,this._currentEl=null,this._canvasEl=document.createElement("canvas"),this._ctx=this._canvasEl.getContext("2d"),this._isMouseOver=!1,this._isDragging=!1,this._isCurrentDragging=!1,this._isCurrentMouseOver=!1,this._minWidth=330,this._canvasScale=2,this._millisecondsInPixel=0,this._clickPosX=0,this._clickRangeStart=new Date,this._clickRangeEnd=new Date,this._clickCurrentDate=new Date,this._clickTime=0,this._clickDelay=450,this._onResizeObserver_=this._onResizeObserver.bind(this),this._resizeObserver=new ResizeObserver(this._onResizeObserver_),this._pauseBtn=new ct({classList:["og-timeline-control_button"],icon:`<?xml version="1.0" ?><!DOCTYPE svg  PUBLIC '-//W3C//DTD SVG 1.1//EN'  'http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd'><svg enable-background="new 0 0 512 512" height="512px" version="1.1" viewBox="0 0 512 512" width="512px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><g id="Layer_6"><rect fill="#252525" height="320" width="60" x="153" y="96"/><rect fill="#252525" height="320" width="60" x="299" y="96"/></g></svg>`,name:"pause"}),this._playBtn=new ct({classList:["og-timeline-control_button"],icon:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M8 5v14l11-7z" style="fill: black;"/></svg>',name:"play"}),this._buttons=new Vo({buttons:[this._pauseBtn,this._playBtn]}),this._visibility=!1}_onResizeObserver(){this.resize()}get canvasScale(){return this._canvasScale}set canvasScale(e){e!==this._canvasScale&&(this._canvasScale=e,this.resize())}resize(){this._resize(),this.draw()}afterRender(e){this.resize()}render(){return super.render(),this.$controls=this.select(".og-timeline-controls"),this._frameEl=this.select(".og-timeline-frame"),this._currentEl=this.select(".og-timeline-current"),this.select(".og-timeline-frame .og-timeline-scale").appendChild(this._canvasEl),this._resizeObserver.observe(this.el),this.model.events.on("change",()=>{this.draw()}),this.model.events.on("current",e=>{this._drawCurrent(),this.events.dispatch(this.events.setcurrent,e)}),this._canvasEl.addEventListener("mouseenter",this._onMouseEnter),this._canvasEl.addEventListener("mouseout",this._onMouseOut),this._currentEl.addEventListener("mouseenter",this._onCurrentMouseEnter),this._currentEl.addEventListener("mouseout",this._onCurrentMouseOut),document.body.addEventListener("mousemove",this._onMouseMove),document.body.addEventListener("mousedown",this._onMouseDown),document.body.addEventListener("mouseup",this._onMouseUp),document.body.addEventListener("wheel",this._onMouseWheelFF),this._playBtn.appendTo(this.$controls),this._pauseBtn.appendTo(this.$controls),this.model.stopped()?(this._pauseBtn.setActive(!0,!0),this._pauseBtn.preventClick=!0):(this._playBtn.setActive(!0,!0),this._playBtn.preventClick=!0),this._buttons.events.on("change",e=>{switch(e.name){case"play":this.play();break;case"pause":this.pause()}}),this.setVisibility(!0),this}setVisibility(e){e!==this._visibility&&(this._visibility=e,this.el&&(this.el.style.display=e?"block":"none"),this.events.dispatch(this.events.visibility,e))}reset(){this.model.stop(),this.events.dispatch(this.events.reset,this.model)}play(){this.model.multiplier=Math.abs(this.model.multiplier),this.model.play(),this.events.dispatch(this.events.play,this.model)}pause(){this.model.stop(),this.events.dispatch(this.events.pause,this.model)}playBack(){this.model.multiplier=-1*Math.abs(this.model.multiplier),this.model.play(),this.events.dispatch(this.events.playback,this.model)}_zoom(e,t,s){let n=(e-(this.model.rangeStartTime+.5*this.model.range))*De,o=Qt(this.model.rangeStart,n),a=Qt(this.model.rangeEnd,n),h=(a.getTime()-o.getTime())/20*De,c=Qt(o,h*s),d=Qt(a,-h*s),u=(d.getTime()-c.getTime())/this.clientWidth;if(u<31536e6&&u>.1){let _=u*t*De;this.model.set(Qt(c,_),Qt(d,_))}}get clientWidth(){return this._canvasEl?this._canvasEl.width/this._canvasScale:0}get clientHeight(){return this._canvasEl?this._canvasEl.height/this._canvasScale:0}_resize(){this._frameEl&&(this._canvasEl.width=this._frameEl.clientWidth*this._canvasScale,this._canvasEl.height=this._frameEl.clientHeight*this._canvasScale,this._canvasEl.style.width=`${this._frameEl.clientWidth}px`,this._canvasEl.style.height=`${this._frameEl.clientHeight}px`)}getOffsetByTime(e){return(e-this.model.rangeStartTime)/this._millisecondsInPixel}remove(){super.remove(),this.model.stop()}_clearCanvas(){this._ctx.fillStyle=this.fillStyle,this._ctx.fillRect(0,0,this.clientWidth*this._canvasScale,this.clientHeight*this._canvasScale)}_drawCurrent(){let e=(this.model.currentTime-this.model.rangeStartTime)/this._millisecondsInPixel;this.model.current<this.model.rangeStart||this.model.current>this.model.rangeEnd?this._currentEl.style.display="none":(this._currentEl.style.display="block",this._currentEl.style.transform=`translateX(${e}px)`)}draw(){this._millisecondsInPixel=this.model.range/this.clientWidth;let e=function(s){for(let n=0,o=$s.length;n<o;n++)if($s[n][0]>s)return $s[n-1]}(this._minWidth*this._millisecondsInPixel*De);if(e){this._clearCanvas();let s=1e3*e[0],n=s/this._millisecondsInPixel,o=e[1],a=(t=this.model.rangeStartTime)-t%s,h=e[0]<1,c=e[0]<86400;for(let d=a,u=this.model.rangeEndTime+s;d<u;d+=s){let _=this.getOffsetByTime(d);_>=0&&_<=this.clientWidth*this._canvasScale&&Nn(this._ctx,_*this._canvasScale,10*this._canvasScale,2*this._canvasScale,Hn);for(let f=1;f<o;f++){let v=_+f*(n/o);v>=0&&v<=this.clientWidth*this._canvasScale&&Nn(this._ctx,v*this._canvasScale,5*this._canvasScale,1*this._canvasScale,Hn)}Fl(this._ctx,Dl(new Date(d),c,h),_*this._canvasScale,26*this._canvasScale,"24px monospace","#bfbfbf","center")}this._drawCurrent()}var t}}function Vn(l,e){const t=new Date(l);return t.setHours(t.getHours()+e),t}class fi{constructor(){this.resolve=()=>{},this.reject=()=>{},this.promise=new Promise((e,t)=>{this.resolve=e,this.reject=t}),Object.freeze(this)}}const Gl=["startcollecting","profilecollected","clear"];class jl{constructor(e={}){this.events=ot(Gl),this.planet=e.planet||null,this._warningHeightLevel=5,this._pointsReady=!1,this._isWarning=!1,this._minX=0,this._planeDistance=this._maxX=1e3,this._minY=0,this._maxY=200,this._drawData=[[],[]],this._promiseArr=[],this._promiseCounter=0,this._pMaxY=0,this._pMinY=0,this._pDist=0,this._pTrackCoords=[],this._pGroundCoords=[],this._pIndex=0}bindPlanet(e){this.planet=e}setWarningHeightLevel(e=0){this._warningHeightLevel=e}setRange(e,t,s,n){this._minX=e,this._maxX=t,s&&(this._minY=s),n&&(this._maxY=n)}_getHeightAsync(e,t,s){let n=new fi;if(this.planet){let o=this.planet.terrain.geoid.getHeightLonLat(e);this.planet.terrain.getHeightAsync(e,a=>{this.planet&&s===this._promiseCounter?(a+=o,this._pGroundCoords[t][1]=a,this._pGroundCoords[t][2]=0,this._pGroundCoords[t][3]=e.height,a>this._pMaxY&&(this._pMaxY=a),a<this._pMinY&&(this._pMinY=a),this._updatePointType(t),n.resolve(a)):n.reject()})}else n.reject();return n.promise}_collectCoordsBetweenTwoTrackPoints(e,t,s,n,o,a){if(this.planet)for(let h=1;h<=t;h++){this._pDist+=1,this._pIndex++;let c=h*s,d=n.add(o.scaleTo(c)),u=this.planet.ellipsoid.cartesianToLonLat(d);this._pGroundCoords[this._pIndex]=[this._pDist,0,0,0,e],((_,f)=>{this._promiseArr.push(this._getHeightAsync(_,f,a))})(u,this._pIndex)}}_collectAllPoints(e,t){if(!this.planet||t!==this._promiseCounter)return;let s=new m,n=new m;for(let o=1,a=e.length;o<a;o++){let h=e[o-1],c=e[o];this.planet.ellipsoid.lonLatToCartesianRes(h,s),this.planet.ellipsoid.lonLatToCartesianRes(c,n);let d=n.sub(s),u=d.length(),_=this.planet.ellipsoid.getSurfaceNormal3v(s),f=m.proj_b_to_plane(d,_),v=f.length(),g=Math.floor(v/1),y=1*u/v;this._getGroundElevation(h,o-1,t),f.normalize(),d.normalize(),this._collectCoordsBetweenTwoTrackPoints(o-1,g,y,s,d,t),this._pDist+=v-1*g,this._pIndex++;let p=c.height;p>this._pMaxY&&(this._pMaxY=p),p<this._pMinY&&(this._pMinY=p),this._pTrackCoords[o]=[this._pDist,p,this._pIndex]}}_getGroundElevation(e,t,s){this._pGroundCoords[this._pIndex]=[this._pDist,0,0,0,t],this._promiseArr.push(this._getHeightAsync(e,this._pIndex,s))}_calcPointsAsync(e,t){return new Promise((s,n)=>{this._pTrackCoords=[[0,e[0].height,0]],this._pMaxY=e[0].height,this._pMinY=this._pMaxY,this._pDist=0,this._pGroundCoords=[],this._pIndex=0,this._promiseArr=[],this._collectAllPoints(e,t),this._getGroundElevation(e[e.length-1],e.length-1,t),Promise.all(this._promiseArr).then(()=>{s({dist:this._pDist,minY:this._pMinY,maxY:this._pMaxY,trackCoords:this._pTrackCoords,groundCoords:this._pGroundCoords})})})}get minX(){return this._minX}get planeDistance(){return this._planeDistance}get maxX(){return this._maxX}get minY(){return this._minY}get maxY(){return this._maxY}get pointsReady(){return this._pointsReady}get isWarningOrCollision(){return this._isWarning}get drawData(){return this._drawData}collectProfile(e){let t=new fi;return this.planet||t.reject(),this._pointsReady=!1,this._isWarning=!1,e&&e.length?(this.events.dispatch(this.events.startcollecting,this),this._promiseCounter++,(s=>{this._calcPointsAsync(e,s).then(n=>{s===this._promiseCounter&&(this._planeDistance=n.dist,this.setRange(0,n.dist,n.minY-.1*Math.abs(n.minY),n.maxY+.2*Math.abs(n.maxY)),this._pointsReady=!0,this._drawData=[n.trackCoords,n.groundCoords],this.events.dispatch(this.events.profilecollected,this._drawData,this),t.resolve(this._drawData))})})(this._promiseCounter),t.promise):(t.reject(),t.promise)}_updatePointType(e){this._pGroundCoords[e][3]>=this._pGroundCoords[e][1]&&this._pGroundCoords[e][3]<this._pGroundCoords[e][1]+this._warningHeightLevel-.1&&(this._pGroundCoords[e][2]=1),this._pGroundCoords[e][3]<=this._pGroundCoords[e][1]+1&&(this._pGroundCoords[e][2]=2),this._pGroundCoords[e][2]!==1&&this._pGroundCoords[e][2]!==2||(this._isWarning=!0)}_setPointsType(){this._isWarning=!1,this._pTrackCoords=this._drawData[0],this._pGroundCoords=this._drawData[1];for(let e=0;e<this._pGroundCoords.length;e++)this._updatePointType(e);this._drawData[1]=this._pGroundCoords,this.events.dispatch(this.events.profilecollected,this._drawData,this)}clear(){this._promiseCounter=0,this._pointsReady=!1,this._isWarning=!1,this._drawData=[[],[]],this._pMaxY=0,this._pMinY=0,this._pDist=0,this._pTrackCoords=[],this._pGroundCoords=[],this._pIndex=0,this.events.dispatch(this.events.clear,this._drawData,this)}}const pa="rgb(198, 198, 198)",Un=[pa,"rgb(255, 255, 0)","rgb(255, 0, 0)"],ql=["startdrag","stopdrag","pointer","mouseenter","mouseleave","dblclick","tracklength","groundlength","warninglength","collisionlength"];class Yl extends dt{constructor(e={}){super({template:`<div class="og-elevationprofile">
      <div class="og-elevationprofile-loading" style="display: none;">
        <div class="loadingio-spinner-bars-r354qqyl5v">
          <div class="ldio-p0v5a1f6oz">
            <div></div>
            <div></div>
            <div></div>
            <div></div>
          </div>
        </div> 
      </div>     
    </div>`,model:new jl}),this._onMouseDblClick=t=>{let s,n=this.$canvas.getBoundingClientRect(),o=t.clientX-n.left,a=this._leftDistance+(this._rightDistance-this._leftDistance)*o/this.clientWidth,h=this.model.drawData[1],c=this.model.drawData[0];a<0?(s=1,a=0,o=(0-this._leftDistance)*this.clientWidth/(this._rightDistance-this._leftDistance)):a>this.model.planeDistance?(s=h.length-1,a=this.model.planeDistance,o=(a-this._leftDistance)*this.clientWidth/(this._rightDistance-this._leftDistance)):s=-1-Se(h,a,(x,T)=>x-T[0]);let d=h[s-1],u=h[s],_=(a-d[0])/(u[0]-d[0]),f=d[1]+_*(u[1]-d[1]),v=d[4],g=c[v],y=c[v+1];_=(a-g[0])/(y[0]-g[0]);let p=g[1]+_*(y[1]-g[1]);this.events.dispatch(this.events.dblclick,a,g,y,d,u,v,s-1,p-f)},this._onMouseEnter=t=>{this._isMouseOver=!0,this.events.dispatch(this.events.mouseenter,t)},this._onMouseOut=t=>{this._isMouseOver=!1,this.events.dispatch(this.events.mouseleave,t)},this._onMouseDown=t=>{this._isMouseOver&&(this._isDragging=!0,document.body.classList.add("og-timeline-unselectable"),this._clickPosX=t.clientX,this._customFrame||(this._leftDistance=this.model.minX,this._rightDistance=this.model.maxX),this._clickLeftDistance=this._leftDistance,this._clickRightDistance=this._rightDistance,this.events.dispatch(this.events.startdrag,t))},this._onMouseUp=t=>{this._isDragging&&(this._isDragging=!1,document.body.classList.remove("og-timeline-unselectable"),this.events.dispatch(this.events.stopdrag,t))},this._onCanvasMouseMove=t=>{if(this.model.pointsReady)if(this._isDragging)this.clearPointerCanvas();else{this._customFrame||(this._leftDistance=this.model.minX,this._rightDistance=this.model.maxX);let s=this.$pointerCanvas.getBoundingClientRect(),n=t.clientX-s.left;this.redrawPointerCanvas(n)}},this._onMouseMove=t=>{if(this._isDragging&&this.model.pointsReady){let s=(this._clickPosX-t.clientX)*this._canvasScale/this._pixelsInMeter_x;this.setFrame(this._clickLeftDistance+s,this._clickRightDistance+s)}},this._onMouseWheelFF=t=>{this._onMouseWheel(t)},this._onMouseWheel=t=>{if(this._isMouseOver&&this.model.pointsReady){this._customFrame||(this._leftDistance=this.model.minX,this._rightDistance=this.model.maxX),this._customFrame=!0;let s=Math.sign(t.wheelDelta)*(this._rightDistance-this._leftDistance)/20,n=this.$canvas.getBoundingClientRect(),o=t.clientX-n.left,a=o-.5*this.$canvas.clientWidth,h=a*this._canvasScale/this._pixelsInMeter_x,c=h+this._leftDistance+s,d=h+this._rightDistance-s;h=-a*(d-c)/this.clientWidth,this.setFrame(c+h,d+h),this.redrawPointerCanvas(o)}},this.events=this.events.registerNames(ql),this.fillStyle=e.fillStyle||"rgb(63, 63, 63)",this._customFrame=!1,this._leftDistance=0,this._rightDistance=0,this._pixelsInMeter_x=0,this._pixelsInMeter_y=0,this._canvasScale=2,this.$canvas=document.createElement("canvas"),this.$canvas.style.position="absolute",this._ctx=this.$canvas.getContext("2d"),this.$pointerCanvas=document.createElement("canvas"),this.$pointerCanvas.style.pointerEvents="none",this.$pointerCanvas.style.position="absolute",this._pointerCtx=this.$pointerCanvas.getContext("2d"),this.$loading=null,this._isMouseOver=!1,this._isDragging=!1,this._clickPosX=0,this._clickLeftDistance=0,this._clickRightDistance=0,this._timeStartHandler=0,this._onResizeObserver_=this._onResizeObserver.bind(this),this._resizeObserver=new ResizeObserver(this._onResizeObserver_)}_onResizeObserver(){this.resize()}get canvasScale(){return this._canvasScale}set canvasScale(e){e!==this._canvasScale&&(this._canvasScale=e,this.resize())}resize(){this._resize(),this.draw()}render(){return super.render(),this._resizeObserver.observe(this.el),this.el.appendChild(this.$canvas),this.el.appendChild(this.$pointerCanvas),this.model.events.on("profilecollected",e=>{this._hideLoading(),this.clearPointerCanvas(),this.draw()}),this.model.events.on("startcollecting",()=>{clearTimeout(this._timeStartHandler),this._timeStartHandler=setTimeout(()=>{this._showLoading()},450)}),this.model.events.on("clear",()=>{this._customFrame=!1,this._leftDistance=0,this.clearCanvas(),this.clearPointerCanvas()}),this.$loading=this.select(".og-elevationprofile-loading"),this.$canvas.addEventListener("mouseenter",this._onMouseEnter),this.$canvas.addEventListener("mouseout",this._onMouseOut),this.$canvas.addEventListener("dblclick",this._onMouseDblClick),this.$canvas.addEventListener("mousemove",this._onCanvasMouseMove),document.body.addEventListener("mousemove",this._onMouseMove),document.body.addEventListener("mousedown",this._onMouseDown),document.body.addEventListener("mouseup",this._onMouseUp),document.body.addEventListener("wheel",this._onMouseWheelFF),this}_hideLoading(){clearTimeout(this._timeStartHandler),this.$loading.style.display="none"}_showLoading(){this.$loading.style.display="flex"}redrawPointerCanvas(e){this.clearPointerCanvas();let t,s=this._leftDistance+(this._rightDistance-this._leftDistance)*e/this.clientWidth,n=this.model.drawData[1],o=this.model.drawData[0];s<0?(t=1,s=0,e=(0-this._leftDistance)*this.clientWidth/(this._rightDistance-this._leftDistance)):s>this.model.planeDistance?(t=n.length-1,s=this.model.planeDistance,e=(s-this._leftDistance)*this.clientWidth/(this._rightDistance-this._leftDistance)):t=-1-Se(n,s,(T,w)=>T-w[0]);let a=n[t-1],h=n[t],c=(s-a[0])/(h[0]-a[0]),d=a[1]+c*(h[1]-a[1]),u=a[4],_=o[u],f=o[u+1];c=(s-_[0])/(f[0]-_[0]);let v=_[1]+c*(f[1]-_[1]),g=(this.model.maxY-v)*this._pixelsInMeter_y,y=(this.model.maxY-d)*this._pixelsInMeter_y;this.events.dispatch(this.events.pointer,s,_,f,a,h,u,t-1,v-d);let p=this._pointerCtx;p.lineWidth=3,p.strokeStyle="rgba(64,64,64,0.6)",p.beginPath(),p.moveTo(e*this._canvasScale,0),p.lineTo(e*this._canvasScale,this.clientHeight*this._canvasScale),p.stroke(),p.beginPath(),p.arc(e*this._canvasScale,y,4,0,2*Math.PI,!1),p.fillStyle="#FFB277",p.fill(),p.lineWidth=4,p.strokeStyle="#FFB277",p.stroke(),p.beginPath(),p.arc(e*this._canvasScale,g,4,0,2*Math.PI,!1),p.fillStyle="#FFB277",p.fill(),p.lineWidth=4,p.strokeStyle="#FFB277",p.stroke(),p.lineWidth=3,p.strokeStyle="#FFB277",p.beginPath(),p.moveTo(e*this._canvasScale,y),p.lineTo(e*this._canvasScale,g),p.stroke(),p.fillStyle="white",p.font=28/devicePixelRatio+"px Arial",p.textBaseline="middle",p.textAlign="left",p.fillText(`${Math.round(v-d).toString()} m`,(e+5)*this._canvasScale,y+.5*(g-y)),p.fillStyle="white",p.font=28/devicePixelRatio+"px Arial",p.textAlign="right";let x=Ue(s);p.fillText(`${x[0]} ${x[1]}`,(e-5)*this._canvasScale,(this.clientHeight-7)*this._canvasScale)}get clientWidth(){return this.$canvas?this.$canvas.width/this._canvasScale:0}get clientHeight(){return this.$canvas?this.$canvas.height/this._canvasScale:0}_resize(){this.el&&(this.$canvas.width=this.el.clientWidth*this._canvasScale,this.$canvas.height=this.el.clientHeight*this._canvasScale,this.$canvas.style.width=`${this.el.clientWidth}px`,this.$canvas.style.height=`${this.el.clientHeight}px`,this.$pointerCanvas.width=this.el.clientWidth*this._canvasScale,this.$pointerCanvas.height=this.el.clientHeight*this._canvasScale,this.$pointerCanvas.style.width=`${this.el.clientWidth}px`,this.$pointerCanvas.style.height=`${this.el.clientHeight}px`,this._customFrame&&(this._pixelsInMeter_x=this._canvasScale*this.clientWidth/(this._rightDistance-this._leftDistance)))}clearPointerCanvas(){this._pointerCtx.fillStyle="rgba(0,0,0,0)",this._pointerCtx.clearRect(0,0,this.clientWidth*this._canvasScale,this.clientHeight*this._canvasScale)}clearCanvas(){const e=this._ctx.createLinearGradient(0,0,0,this.clientHeight*this._canvasScale);e.addColorStop(0,"black"),e.addColorStop(1,this.fillStyle),this._ctx.fillStyle=e,this._ctx.fillRect(0,0,this.clientWidth*this._canvasScale,this.clientHeight*this._canvasScale)}setFrame(e,t){this._leftDistance=e,this._rightDistance=t,this._customFrame=!0,this._pixelsInMeter_x=this._canvasScale*this.clientWidth/(this._rightDistance-this._leftDistance),this.model.setRange(e,t),this.draw()}_updateUnits(){this._customFrame||(this._pixelsInMeter_x=this._canvasScale*this.clientWidth/(this.model.maxX-this.model.minX)),this._pixelsInMeter_y=this._canvasScale*this.clientHeight/(this.model.maxY-this.model.minY)}clear(){this.model.clear(),this.clearCanvas()}draw(){let e=this.model.drawData[0];if(e.length>1){this._updateUnits(),this.clearCanvas();let t=this.model.drawData[1];this._drawTrack(e,t),this._drawTerrain(t),this._drawWarningAndCollision(t),this._drawLabels(e,t)}else this.clearCanvas()}_drawLabels(e,t){let s=this._ctx;if(s){let n=e[0];const o=this.model.maxY;let a=(-this._leftDistance+n[0])*this._pixelsInMeter_x,h=(o-n[1])*this._pixelsInMeter_y;t[n[2]][1],this._pixelsInMeter_y,s.beginPath(),s.fillStyle="#F7F718",s.fillRect(a-4,h-4,8,8),s.stroke(),s.fillStyle="white",s.font=26/devicePixelRatio+"px Arial",s.textBaseline="bottom",s.textAlign="left",s.fillText(`${Math.round(n[1]-t[n[2]][1]).toString()} m`,a+1,h-10),s.stroke();for(let c=1,d=e.length;c<d;c++){let u=e[c];a=(-this._leftDistance+u[0])*this._pixelsInMeter_x,h=(o-u[1])*this._pixelsInMeter_y,t[u[2]][1],this._pixelsInMeter_y,s.beginPath(),s.fillStyle="#F7F718",s.fillRect(a-4,h-4,8,8),s.stroke(),s.fillStyle="white",s.fillText(`${Math.round(u[1]-t[u[2]][1]).toString()} m`,a+1,h-10),s.stroke()}}}_drawTrack(e,t){let s=e[0],n=this._ctx;if(n){const o=this.model.maxY;n.lineWidth=5,n.strokeStyle="rgb(0, 255, 50)",n.beginPath(),n.moveTo((-this._leftDistance+s[0])*this._pixelsInMeter_x,(o-s[1])*this._pixelsInMeter_y);let a=0;for(let u=1,_=e.length;u<_;u++){let f=e[u];n.lineTo((-this._leftDistance+f[0])*this._pixelsInMeter_x,(o-f[1])*this._pixelsInMeter_y);let v=e[u-1],g=f[0]-v[0],y=f[1]-v[1],p=g*g,x=y*y;a+=Math.sqrt(p+x)}n.stroke(),n.lineWidth=2,n.strokeStyle="rgba(255,255,255,0.7)",n.beginPath();let h=(-this._leftDistance+s[0])*this._pixelsInMeter_x,c=(o-s[1])*this._pixelsInMeter_y,d=(o-t[s[2]][1])*this._pixelsInMeter_y;n.moveTo(h,c),n.lineTo(h,d);for(let u=1,_=e.length;u<_;u++){let f=e[u];h=(-this._leftDistance+f[0])*this._pixelsInMeter_x,c=(o-f[1])*this._pixelsInMeter_y,d=(o-t[f[2]][1])*this._pixelsInMeter_y,n.strokeStyle="rgba(255,255,255,0.7)",n.moveTo(h,c),n.lineTo(h,d)}n.stroke(),this.events.dispatch(this.events.tracklength,a)}}_drawTerrain(e){let t=e[0],s=this._ctx;if(s){const n=this.model.maxY;s.lineWidth=5,s.strokeStyle=pa,s.beginPath(),s.moveTo((-this._leftDistance+t[0])*this._pixelsInMeter_x,this.$canvas.height),s.lineTo((-this._leftDistance+t[0])*this._pixelsInMeter_x,(n-t[1])*this._pixelsInMeter_y);let o=0;for(let a=1,h=e.length;a<h;a++){let c=e[a];s.lineTo((-this._leftDistance+c[0])*this._pixelsInMeter_x,(n-c[1])*this._pixelsInMeter_y);let d=e[a-1],u=c[0]-d[0],_=c[1]-d[1],f=u*u,v=_*_;o+=Math.sqrt(f+v)}s.lineTo((-this._leftDistance+e[e.length-1][0])*this._pixelsInMeter_x,this.$canvas.height),s.closePath(),s.stroke(),s.save(),s.fillStyle="rgb(64, 68, 82)",s.globalAlpha=.5,s.fill(),s.restore(),s.globalAlpha=1,this.events.dispatch(this.events.groundlength,o)}}_drawWarningAndCollision(e){let t=this._ctx;if(t&&e.length>1){let s=this.model.maxY;t.lineWidth=5,t.beginPath();let n=0,o=0;for(let a=0,h=e.length-1;a<h;a++){let c=e[a],d=e[a+1];if(c[2]!==0&&d[2]!==0){let u=d[0]-c[0],_=d[1]-c[1],f=u*u,v=_*_;c[2]===2?(t.stroke(),t.beginPath(),t.strokeStyle=Un[2],o+=Math.sqrt(f+v)):c[2]===1&&(t.stroke(),t.beginPath(),t.strokeStyle=Un[1],n+=Math.sqrt(f+v)),t.moveTo((-this._leftDistance+c[0])*this._pixelsInMeter_x,(s-c[1])*this._pixelsInMeter_y),t.lineTo((-this._leftDistance+d[0])*this._pixelsInMeter_x,(s-d[1])*this._pixelsInMeter_y)}}t.stroke(),this.events.dispatch(this.events.warninglength,n),this.events.dispatch(this.events.collisionlength,o)}}}let Wl=W.createCylinder(.33,0,1,20,1,!0,!1,0,0,0),$l=W.createCylinder(.33,.33,1.1,20,1,!0,!0,0,-.55,0);const Xl={startPosition:new m,endPosition:new m,startColor:"rgba(255,131,0,0.2)",endColor:"rgba(255,131,0,1.0)",thickness:2.7},Zl={src:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACACAYAAADDPmHLAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAAYdEVYdFNvZnR3YXJlAHBhaW50Lm5ldCA0LjEuNBNAaMQAAAiLSURBVHhe7Z0r0BxFEMcjIhAIRERERAQCgUAgEBEIBAIRiUAgIiIQiAgEIlUREQgEIgIREYFAIBCIiAgEIiIiAoGIoHimqPAKz5CP/t23/8vcbe89d/dmZ/pf9avLdZK72e6+ee3M7Imjo6Opc8o4b7xn3DIeGEOJz+Y7+C6+k+/2yjQZXOMEOGdcNe4anv4wvjV+m73bT3wGn8VneqIMlIUyeWXNGteYKTj4feNrI9W/xi/HfxxVfCffnYqyUcbJJINrzIjTxjvGV0aqn43fj/+YhSgLZUpFmd81uAbv2rLANWbAC8ZHxp+GxC8ufZ+rKGNaI1FLcC1ck3etB8U1HhCqzk8N6T/jENV7X6LsXIN008iqeXCNB+B54zND+tt4ePzHIsS1cE0SicA1e74YFdc4IgyjrhvqTP3TvJas9Bq59oP2EVzjCJw03jI0TCMBcurUDS1qBCU9PnjbwCeerwbFNQ4MVd9tQ5pyG7+v0mvHJ6N3FF3jgFwy1JPvmlipUfIFvmHY6/luEFzjANDO0fGRfm1eQ0+UzlriqzOG58tecY0985LxnYH+al5D3ZKP8Bm+83zaG66xRy4a6uzU3NZvK/nqkUEH0fNtL7jGHqBH+4EhTWEGL2ddMwYZJbjGPaGgHxuIDA7tJ/mQGdLek8A17sHTxucGiva+P6kGxbf42PP9TrjGHUmDH1V+/xokCVzjDkTwx1HvSeAat4R2SWP8CP7wko9ZmrZ3n8A1bok6fBH88SRf4/u9ksA1bgFr4ZDG+qHxpLuKLFD1YrMRrnFDLhjocfMaGl8aIjLh5sVoLa5xA140+lhxG+pHNAk7TRu7xjXQ+9TK3Jru4ecqxYB7B88YXsw6cY1rUKcv7ujlI907YLbQi1knrnEFavej05ef1ClkpZUXOxfX2AH3p6Pdz1/E6FnDi2EL19iBVu3Gbd18pdgwU+jFsIVrdHjDQHGDJ39pkojm2ovlAq5xCXqWWtETmo7uG2t3L7vGJTTbF73+6UhNARtVvZjOcY0JZ42Y45+uGK2t7BC6xoQbBoqO3/SkGpt5Gy+2M1xjw3MGGZRubgxNS5qv6dxw4hob9OuPsf90pWnizlrANRpM+sSvvwypFqBGb8W6ZWjgHjOKtn/6Ug3OMv1WrFsG4ykjqv3yxGiudbdw4U2DbvjEuL8cqSZv7TJaeNOg1b2h8nTHWIj3whuDSQOUHmcSKkPagr5wNE0afLhioOj8lSc16QvTw2nwYfk8vlB5YjnfPOZp8FX9x8kd5Uqju3kzkCYAPUQU1X+5UjPACaatBEiPcAmVrfmKIQU/Jn/qEpNCs82lSgCOL0U/Na+hcvVD8/qKMU8AjiZDsdGjfCnGl415AnyCJVSVZptIlAD3sISqEgt9ZwnAHSIU07/1SMv7T5EA7CpFPzavofKljuA5EkCbPmICqB4p1m+SAPQGQ3XqMgnAQwtCdeo6CRBTwPXqJgnAKpFQnbpDAsQcQL26RwLEzt96dZ8ECFWsSIDKFQlQuSIBKlckQOUiAThLJlSnZqOAmAeoV7N5gJgJrFd3SQCePBGqU7dIgLgbWK9mdwO1ITRUn66QADoQIlYE1SPF+gIJEGsC69PCmkDOk0WxKrgeaQf4aRIA9AiYUD2a7wuA2BlUn1gKOE8A9ouj2BtYvh42r4z+5gnATlEUHcHy9X3z+poxT4A4H6Aecfxv63wAiOXh9ah1QgioHxAnhJYr1fKz9h/SBOA0aRSnhJUrJQCP/m0lAMQ5geWr85xA0I2haAbKk4b4K08KVTMQ08LlSU37vPqHNPgiVgiVK5r4hXgvvGm4aKC4PVyOFMuNnhfABEFMCpWnjZ8YAjxfBkUiTF/q/LH0rxXrlqFBJ4friVOh6Uod+oUHRYiWIYFnzaG4QzhdqefPo/+9GK9MAJ42SQ0QtcB0pV//wtAvxTUmqBaIiaHpSff9Z0fCduEaE+gLxBNEpyliRuzctl+4xiU0Ioh5gelIsfrQ8GI6xzUuwdjxgRGalojZacOL6RzX6KDNI0wmhPKWev6tWT8P19jBFwaKDmG+0pD9tnHS8OK4gGvsgDuFUQPkr7UdvxTXuAI9Wk7nzYfykX6clwwvdi6ucQ3MKqEYFeQjxYKFvRtV/cI1roG9hDpdNNYPHl6KAWc9re31L+MaN4DHzMUUcT4iFi8bXqxW4ho3RP2Bx81raHw9al557J8Xo7W4xi24ZqAYHYwv+XztbN8qXOMW0OFQpzBuG48n+XrrTt8yrnFLWELGViMUSTC85GN8Ptvftw+ucQcYGTD7hCIJhpN8y8rtrXv8Hq5xR7hpdNdAkQT9Sz7Fx70EH1zjHlAl6Z5BdAz7k3xJLdta2bsPrnFP0j5BzBXsL/mwlzZ/GdfYA/RMbxgo5gl2l3yHL/fq7XfhGnskfSpp3DvYXKmvZs/5HwrX2DOcP6QVRVqoGOqWfMSmnFcNz6e94RoH4IyhziGLFeMmUlv4RItv8RU+83zZK65xIGjDOH9AnZoYKj6RfIFvrhqDtPcernFg2KTwpSHVvMQsvXa2bnNus+ezwXCNI6DaQOPbGoeLumZ8gC9G+9WnuMYRYeOJdh+hGiaP0mvkiF584PlmFFzjAWAxgzqJqMRESK+Ja91pAUffuMYDwvGlaSJQTU65j0DZ0+aNaztveNd+EFxjBjB3QPWYOm9Kh1WkZeUa2KDJNXnXelBcY0bQPnKs2fIj7nOsFZbLRJkp+0Hb+HW4xgzhMGuqTubEl2sC9igcYpqZ71zeH0HZKCNlpczetWSFa8wcJQO7lrtONiUQ3xh9TDbxGXxWVxNEGSjLZIKe4honxlnjdYMFqnSyhhxB8Nl8B9/Fd/LdXpkmg2ssANpdfpEsXacdZq6BJ6Tya+VZyWnnUsLG3/Fv+Lf8H/4vn8FnZd2W78bRif8BxMOwtJg5Ph4AAAAASUVORK5CYII=",color:"rgb(255,131,0)",size:[8,8]},Kl={text:"",face:"arial",size:10.5,color:"rgba(455,455,455,1.0)",outlineColor:"rgba(0,0,0,0.34)",outline:.23,align:"left",offset:[5,15,-5]},Gn={face:"arial",text:"",size:10.5,color:"rgba(455,455,455,1.0)",outlineColor:"rgba(0,0,0,0.34)",outline:.23,align:"right",offset:[-47,25,0]},Ql={instanced:!0,tag:"ground-pointer",color:"rgb(0,305,0)",object3d:Wl},Jl={instanced:!0,tag:"head-pointer",color:"rgb(305,305,0)",object3d:$l};class th extends ce{constructor(e={}){super("ElevationProfileScene"),this._onLClick=t=>{let s=this._planet.getCartesianFromPixelTerrain(t.pos);s&&this.addGroundPoint3vAsync(s)},this._onMouseMove=t=>{if(this._planet.getCartesianFromMouseTerrain(),this._pickedGroundEntity){let s=new O(t.x,t.y).sub(this._startClickPos),n=this._startEntityPos.add(s),o=this._planet.getCartesianFromPixelTerrain(n);o&&this.setGroundPointCartesian3v(this._pickedGroundEntity.properties.index,o)}else if(this._pickedHeadEntity){let s=this._planet.camera,n=this._pickedHeadEntity.properties.groundEntity.getCartesian(),o=this._planet.ellipsoid.getSurfaceNormal3v(n),a=n.add(o),h=n.add(s.getRight()),c=new m;if(new N(s.eye,t.direction).hitPlaneRes(mt.fromPoints(n,a,h),c)===N.INSIDE){let d=m.proj_b_to_a(c,n),u=d.sub(n).dot(n),_=n.add(o.scale(Math.sign(u)*d.distance(n)));this.setHeadPointCartesian3v(this._pickedHeadEntity.properties.index,_)}}},this._onLUp=t=>{},this._onGroundPointerEnter=t=>{t.renderer.handler.canvas.style.cursor="pointer"},this._onGroundPointerLeave=t=>{t.renderer.handler.canvas.style.cursor="default"},this._onGroundPointerLDown=t=>{this._clampToGround=!1,this.renderer.controls.mouseNavigation.deactivate(),this._pickedGroundEntity=t.pickingObject;const s=this._pickedGroundEntity.getCartesian();this._startClickPos.set(t.x,t.y),this._startEntityPos=this._planet.getPixelFromCartesian(s)},this._onGroundPointerLUp=t=>{this._clampToGround=!0,this.renderer.controls.mouseNavigation.activate(),this._pickedGroundEntity=null},this._onHeadPointerEnter=t=>{t.renderer.handler.canvas.style.cursor="pointer"},this._onHeadPointerLeave=t=>{t.renderer.handler.canvas.style.cursor="default"},this._onHeadPointerLDown=t=>{this.renderer.controls.mouseNavigation.deactivate(),this._pickedHeadEntity=t.pickingObject},this._onHeadPointerLUp=t=>{this.renderer.controls.mouseNavigation.activate(),this._pickedHeadEntity=null},this.events=ot(eh),this._planet=e.planet||null,this._pickedGroundEntity=null,this._pickedHeadEntity=null,this._startClickPos=new O,this._startEntityPos=new O,this._clampToGround=!0,this._trackLayer=new ut("track",{entities:[],pickingEnabled:!1,polygonOffsetUnits:-1,relativeToGround:!0,hideInLayerSwitcher:!0}),this._groundPointersLayer=new ut("ground-pointers",{entities:[],pickingEnabled:!0,hideInLayerSwitcher:!0,scaleByDistance:[1,5e3,.02],pickingScale:1.5}),this._headPointersLayer=new ut("head-pointers",{entities:[],pickingEnabled:!0,hideInLayerSwitcher:!0,scaleByDistance:[1,1e4,.02],pickingScale:1}),this._columnPointersLayer=new ut("column-pointers",{entities:[],pickingEnabled:!1,hideInLayerSwitcher:!0}),this._trackEntity=new V({polyline:{path3v:[],thickness:3.8,color:"rgba(0,305,0,0.8)",isClosed:!1}}),this._trackLayer=new ut("column-pointers",{entities:[this._trackEntity],pickingEnabled:!1,hideInLayerSwitcher:!0}),this._heightsLayer=new ut("heights-labels",{entities:[],pickingEnabled:!1,hideInLayerSwitcher:!0}),this._pointerHeadEntity=new V({cartesian:new m,billboard:Zl}),this._pointerLabelEntity=new V({cartesian:new m,label:Kl}),this._pointerRayEntity=new V({cartesian:new m,ray:Xl}),this._pointerLayer=new ut("pointer",{entities:[this._pointerHeadEntity,this._pointerLabelEntity,this._pointerRayEntity],pickingEnabled:!1,hideInLayerSwitcher:!0})}flyExtent(){let e=this._headPointersLayer.getEntities(),t=180,s=180,n=-180,o=-180,a=-1e6;if(e.length>1){for(let h=0;h<e.length;h++){let c=e[h].getLonLat();c.lon<t&&(t=c.lon),c.lat<s&&(s=c.lat),c.lon>n&&(n=c.lon),c.lat>o&&(o=c.lat),c.height>a&&(a=c.height)}this._planet.camera.flyExtent(new H(new A(t,s),new A(n,o)),a,{amplitude:0})}}get planet(){return this._planet}_createGroundPointer(e,t=10){let s=this.ellipsoid.getSurfaceNormal3v(e),n=e.add(s.scale(t)),o=new V({ray:{startPosition:e,endPosition:n,startColor:"rgba(255,255,255,0.2)",endColor:"rgba(355,355,355,1.0)",thickness:3.2}}),a=new V({cartesian:e,geoObject:Ql}),h=new V({cartesian:n,geoObject:Jl,properties:{}}),c=new V({cartesian:n,label:Gn});c.appendChild(new V({cartesian:n,label:{...Gn,offset:[-47,45,0]}}));const d=this._groundPointersLayer.getEntities().length;return o.properties=a.properties=h.properties={index:d,altitude:t,lonLatEll:new A,headEntity:h,groundEntity:a,columnEntity:o,heightLabelEntity:c},{headEntity:h,groundEntity:a,columnEntity:o,heightLabelEntity:c}}setPointerCartesian3v(e,t){this._pointerLabelEntity.setCartesian3v(e),this._pointerLabelEntity.label.setText(`${Math.round(t).toString()} m`),this._pointerRayEntity.ray.setEndPosition3v(e);let s=this._planet.ellipsoid.getSurfaceNormal3v(e);this._pointerRayEntity.ray.setStartPosition3v(e.add(s.scale(-t))),this._pointerHeadEntity.setCartesian3v(e)}bindPlanet(e){this._planet=e}init(){this._activate()}onremove(){this._deactivate()}_activate(){this._planet.addLayer(this._trackLayer),this._planet.addLayer(this._groundPointersLayer),this._planet.addLayer(this._columnPointersLayer),this._planet.addLayer(this._headPointersLayer),this._planet.addLayer(this._heightsLayer),this._planet.addLayer(this._pointerLayer),this.renderer.events.on("ldblclick",this._onLClick),this.renderer.events.on("mousemove",this._onMouseMove),this.renderer.events.on("lup",this._onLUp),this._groundPointersLayer.events.on("mouseenter",this._onGroundPointerEnter),this._groundPointersLayer.events.on("mouseleave",this._onGroundPointerLeave),this._groundPointersLayer.events.on("ldown",this._onGroundPointerLDown),this._groundPointersLayer.events.on("lup",this._onGroundPointerLUp),this._headPointersLayer.events.on("mouseenter",this._onHeadPointerEnter),this._headPointersLayer.events.on("mouseleave",this._onHeadPointerLeave),this._headPointersLayer.events.on("ldown",this._onHeadPointerLDown),this._headPointersLayer.events.on("lup",this._onHeadPointerLUp),this.setPointerVisibility(!1)}getPointLonLat(e){let t=this._headPointersLayer.getEntities()[e];if(t)return t.getLonLat()}getPointsLonLat(){let e=this._headPointersLayer.getEntities(),t=new Array(e.length);for(let s=0,n=t.length;s<n;s++){let o=e[s];t[s]=o.getLonLat()}return t}getHeightMSL(e){return this._planet&&this._planet.terrain.geoid?this._planet.terrain.geoid.getHeightLonLat(e):0}getHeightELLAsync(e){return new Promise((t,s)=>{this._planet.terrain.getHeightAsync(e,n=>{if(this._planet){let o=this.getHeightMSL(e);t(n+o)}else s()})})}addPointLonLatArrayAsync(e,t=!1){if(!this._planet)throw new Error("Planet is not defined");let s=this._planet.ellipsoid;for(let o=0,a=e.length-1;o<a;o++){let h=s.lonLatToCartesian(e[o]),c=s.lonLatToCartesian(e[o+1]);if(h.distance(c)>1e5)throw new Error("Track is too long! 100 km is maximum.")}let n=new Array(e.length);for(let o=0,a=e.length;o<a;o++)n[o]=this.addPointLonLatAsync(e[o],!0);return Promise.all(n).then(()=>{t||this.events.dispatch(this.events.change,this)}),n}addPointLonLatAsync(e,t=!1){let s=this._planet.ellipsoid.lonLatToCartesian(e),n=this._planet.ellipsoid.getSurfaceNormal3v(s),o=new A(e.lon,e.lat),a=this._planet.ellipsoid.lonLatToCartesian(o),{headEntity:h,groundEntity:c,columnEntity:d,heightLabelEntity:u}=this._createGroundPointer(a);return this._groundPointersLayer.add(c),this._columnPointersLayer.add(d),this._headPointersLayer.add(h),this._heightsLayer.add(u),this._trackEntity.polyline.appendPoint3v(h.getCartesian()),c.properties.lonLatEll.lon=o.lon,c.properties.lonLatEll.lat=o.lat,c.properties.lonLatEll.height=o.height,new Promise(_=>{this.getHeightELLAsync(e).then(f=>{var v;c.properties.lonLatEll.height=f;let g,y=10;e.height===0?(g=s.add(n.scaleTo(f)),s=g.add(n.scaleTo(y))):(y=e.height-f,g=s.sub(n.scaleTo(y))),c.setCartesian3v(g),u.setCartesian3v(s),u.label.setText(`${f.toFixed(1)} m`),u.childEntities[0].label.setText(`${y.toFixed(1)} m`),h.properties.altitude=y,h.setCartesian3v(s),h.properties.columnEntity.ray.setStartPosition3v(g),h.properties.columnEntity.ray.setEndPosition3v(s),(v=this._trackEntity.polyline)==null||v.setPoint3v(s,h.properties.index),t||(this.events.dispatch(this.events.addpoint,h,this),this.events.dispatch(this.events.change,this)),_(h)})})}addGroundPointLonLatAsync(e,t=10,s=!1){let n=this._planet.ellipsoid.lonLatToCartesian(e);return this._addPoint(n,e,t,s)}addGroundPoint3vAsync(e,t=10,s=!1){let n=this._planet.ellipsoid.cartesianToLonLat(e);return this._addPoint(e,n,t,s)}_addPoint(e,t,s,n=!1){return new Promise((o,a)=>{let{headEntity:h,groundEntity:c,columnEntity:d,heightLabelEntity:u}=this._createGroundPointer(e,s);this._groundPointersLayer.add(c),this._columnPointersLayer.add(d),this._headPointersLayer.add(h),this._heightsLayer.add(u),this._trackEntity.polyline.appendPoint3v(h.getCartesian()),c.properties.lonLatEll.lon=t.lon,c.properties.lonLatEll.lat=t.lat,c.properties.lonLatEll.height=t.height,this.getHeightELLAsync(t).then(_=>{var f;c.properties.lonLatEll.height=t.height=_;let v=this._planet.ellipsoid.lonLatToCartesian(t),g=this._planet.ellipsoid.getSurfaceNormal3v(v),y=v.add(g.scale(s));u.setCartesian3v(y),u.label.setText(`${_.toFixed(1)} m`),u.childEntities[0].label.setText(`${s.toFixed(1)} m`),h.setCartesian3v(y),h.properties.columnEntity.ray.setEndPosition3v(y),(f=this._trackEntity.polyline)==null||f.setPoint3v(y,h.properties.index),n||(this.events.dispatch(this.events.addpoint,h,this),this.events.dispatch(this.events.change,this)),o(h)})})}setHeadPointCartesian3v(e,t){const s=this._headPointersLayer.getEntities()[e];if(s){let n=this._planet.ellipsoid.lonLatToCartesian(s.properties.lonLatEll),o=t.length()-n.length();o<=0&&(t=n,o=0),s.properties.altitude=o,s.setCartesian3v(t),s.properties.columnEntity.ray.setEndPosition3v(t),s.properties.heightLabelEntity.setCartesian3v(t),s.properties.heightLabelEntity.childEntities[0].label.setText(`${o.toFixed(1)} m`),this._trackEntity.polyline.setPoint3v(t,e),this.events.dispatch(this.events.change,this._pickedHeadEntity)}}setGroundPointCartesian3v(e,t){var s;let n=this._groundPointersLayer.getEntities()[e];if(n){let o=this._planet.ellipsoid.cartesianToLonLat(t);n.properties.lonLatEll.lon=o.lon,n.properties.lonLatEll.lat=o.lat,n.properties.lonLatEll.height=o.height;let a=this._planet.ellipsoid.getSurfaceNormal3v(t),h=n.properties.headEntity,c=n.properties.heightLabelEntity,d=n.properties.altitude;n.setCartesian3v(t);let u=t.add(a.scale(d));h.setCartesian3v(u),h.properties.columnEntity.ray.setStartPosition3v(t),h.properties.columnEntity.ray.setEndPosition3v(u),(s=this._trackEntity.polyline)==null||s.setPoint3v(u,h.properties.index),c.setCartesian3v(u),c.label.setText(`${o.height.toFixed(1)} m`),c.childEntities[0].label.setText(`${d.toFixed(1)} m`),this.events.dispatch(this.events.change,n.properties.headEntity)}}_deactivate(){this.renderer.events.off("ldblclick",this._onLClick),this.renderer.events.off("mousemove",this._onMouseMove),this.renderer.events.off("lup",this._onLUp),this._groundPointersLayer.events.off("mouseenter",this._onGroundPointerEnter),this._groundPointersLayer.events.off("mouseleave",this._onGroundPointerLeave),this._groundPointersLayer.events.off("ldown",this._onGroundPointerLDown),this._groundPointersLayer.events.off("lup",this._onGroundPointerLUp),this._headPointersLayer.events.off("mouseenter",this._onHeadPointerEnter),this._headPointersLayer.events.off("mouseleave",this._onHeadPointerLeave),this._headPointersLayer.events.off("ldown",this._onHeadPointerLDown),this._headPointersLayer.events.off("lup",this._onHeadPointerLUp),this._trackLayer.remove(),this._groundPointersLayer.remove(),this._headPointersLayer.remove(),this._columnPointersLayer.remove(),this._trackLayer.remove(),this._heightsLayer.remove(),this._pointerLayer.remove(),this.clear()}setPointerVisibility(e){this._pointerLayer.setVisibility(e)}setVisibility(e){this._groundPointersLayer.setVisibility(e),this._trackLayer.setVisibility(e),this._columnPointersLayer.setVisibility(e),this._headPointersLayer.setVisibility(e),this._trackLayer.setVisibility(e),this._heightsLayer.setVisibility(e),this._pointerLayer.setVisibility(e)}clear(){this._headPointersLayer.setEntities([]),this._groundPointersLayer.setEntities([]),this._columnPointersLayer.setEntities([]),this._heightsLayer.setEntities([]),this._trackEntity.polyline.setPath3v([])}frame(){if(this._clampToGround){let e=new m;const t=this._planet.quadTreeStrategy._renderedNodes,s=this._groundPointersLayer.getEntities();for(let n=0;n<s.length;n++){let o=s[n];for(let a=0;a<t.length;a++){let h=t[a];if(h.segment.isEntityInside(o)){h.segment.getEntityTerrainPoint(o,e),o.setCartesian3v(e),o.properties.columnEntity.ray.setStartPosition3v(e);break}}}}}get ellipsoid(){return this._planet?this._planet.ellipsoid:null}}const eh=["change","addpoint"],ih=["reset","list","location"];class sh extends dt{constructor(e={}){super({...e,template:'<div class="og-elevationprofile-buttons"></div>'}),this.events=this.events.registerNames(ih),this.pointListBtn=new ct({classList:["og-elevationprofile-button"],icon:'<?xml version="1.0" encoding="utf-8"?><svg width="800px" height="800px" viewBox="0 0 32 32" id="icon" xmlns="http://www.w3.org/2000/svg"><defs><style>.cls-1{fill:none;}</style></defs><title>list</title><rect x="10" y="6" width="18" height="2"/><rect x="10" y="24" width="18" height="2"/><rect x="10" y="15" width="18" height="2"/><rect x="4" y="15" width="2" height="2"/><rect x="4" y="6" width="2" height="2"/><rect x="4" y="24" width="2" height="2"/></svg>',title:"Point List"}),this.pointListBtn.events.on("change",t=>{this.events.dispatch(this.events.list,t)})}render(e){super.render(e);let t=new he({classList:["og-elevationprofile-button"],icon:`<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<svg width="30" height="30" viewBox="0 0 30 30" version="1.1">
  <g transform="translate(0,-289.0625)">
    <path d="M 15 6 C 10.041282 6 6 10.04128 6 15 C 6 19.95872 10.041282 24 15 24 C 16.586491 24 18.07668 23.58246 19.373047 22.857422 L 17.888672 21.375 C 17.00816 21.772814 16.032235 22 15 22 C 11.122162 22 8 18.87784 8 15 C 8 11.12216 11.122162 8 15 8 C 18.877838 8 22 11.12216 22 15 L 19 15 L 23 20 L 27 15 L 24 15 C 24 10.04128 19.958718 6 15 6 z " transform="translate(0,289.0625)" />
  </g>
</svg>`,title:"Reset"});t.appendTo(this.el),t.events.on("click",()=>{this.model.clear(),this.events.dispatch(this.events.reset,this)}),this.pointListBtn.appendTo(this.el);let s=new he({classList:["og-elevationprofile-button","og-elevationprofile-button__location"],icon:`<?xml version="1.0" encoding="utf-8"?>
<!-- Svg Vector Icons : http://www.onlinewebfonts.com/icon -->
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 256 256" enable-background="new 0 0 256 256" xml:space="preserve">
<metadata> Svg Vector Icons : http://www.onlinewebfonts.com/icon </metadata>
<g><g><path fill="#000000" d="M127,169.4c23.7,0,42.8-18.3,42.8-41s-19.2-41-42.8-41c-23.7,0-42.8,18.4-42.8,41S103.4,169.4,127,169.4z"/><path fill="#000000" d="M221.7,120.2c-3.8-44-40.9-78.9-87-82V15h-16.3v23.6c-44.8,4-80.3,38.5-84.1,81.7H10v15.6h24.3c3.8,43.1,39.3,77.4,84.1,81.7V241h16.3v-23.2c46-3.1,83.2-37.9,87-82H246v-15.6H221.7L221.7,120.2L221.7,120.2z M128,201.6c-42.5,0-76.7-33-76.7-73.4c0-40.4,34.5-73.4,76.7-73.4c42.5,0,76.7,33,76.7,73.4C204.7,168.5,170.5,201.6,128,201.6L128,201.6z"/></g></g>
</svg>`,title:"View bounds"});return s.appendTo(this.el),s.events.on("click",()=>{this.events.dispatch(this.events.location,this)}),this}}class rh extends Zt{constructor(e){super({title:"Points List",visible:!1,resizable:!0,useHide:!0,top:150,left:200,width:400,height:300,minHeight:100,minWidth:100,...e}),this._onApplyClick=()=>{try{this.model.clear();let t=JSON.parse(this.$textarea.value),s=new Array(t.length);for(let n=0;n<t.length;n++){let o=t[n];s[n]=new A(o[0],o[1],o[2])}this.model.addPointLonLatArrayAsync(s)}catch(t){console.error(t)}},this.$textarea=null}render(e){super.render(e);let t=new dt({template:`<div class="og-elevationprofile-list">
        <textarea placeholder="[[lon, lat, height], [lon, lat, height], ..., [lon, lat, height]]"></textarea>
        <div class="og-elevationprofile-list-buttons"></div>
    </div>`});t.appendTo(this.container);let s=new he({classList:["og-elevationprofile-list-apply"],icon:"Apply"});return s.appendTo(t.select(".og-elevationprofile-list-buttons")),s.events.on("click",this._onApplyClick),this.$textarea=t.select("textarea"),this}}class nh extends dt{constructor(e={}){super({...e,template:`<div class="og-elevationprofile-legend">
        <div class="og-elevationprofile-legend__row og-elevationprofile-legend__track">
          <div class="og-elevationprofile-square"></div>
          <div class="og-elevationprofile-value">0</div>
          <div class="og-elevationprofile-units">m</div>
        </div>
        <div class="og-elevationprofile-legend__row og-elevationprofile-legend__ground">
          <div class="og-elevationprofile-square"></div>
          <div class="og-elevationprofile-value">0</div>
          <div class="og-elevationprofile-units">m</div>
        </div>
        <div class="og-elevationprofile-legend__row og-elevationprofile-legend__warning">        
          <div class="og-elevationprofile-square"></div>
          <div class="og-elevationprofile-value">0</div>
          <div class="og-elevationprofile-units">m</div>
        </div>
        <div class="og-elevationprofile-legend__row og-elevationprofile-legend__collision">
          <div class="og-elevationprofile-square"></div>
          <div class="og-elevationprofile-value">0</div>
          <div class="og-elevationprofile-units">m</div>
        </div>
      </div>`}),this.$groundValue=null,this.$trackValue=null,this.$warningValue=null,this.$collisionValue=null,this.$trackUnits=null,this.$groundUnits=null,this.$warningUnits=null,this.$collisionUnits=null}render(e){return super.render(e),this.$trackValue=this.select(".og-elevationprofile-legend__track .og-elevationprofile-value"),this.$groundValue=this.select(".og-elevationprofile-legend__ground .og-elevationprofile-value"),this.$warningValue=this.select(".og-elevationprofile-legend__warning .og-elevationprofile-value"),this.$collisionValue=this.select(".og-elevationprofile-legend__collision .og-elevationprofile-value"),this.$trackUnits=this.select(".og-elevationprofile-legend__track .og-elevationprofile-units"),this.$groundUnits=this.select(".og-elevationprofile-legend__ground .og-elevationprofile-units"),this.$warningUnits=this.select(".og-elevationprofile-legend__warning .og-elevationprofile-units"),this.$collisionUnits=this.select(".og-elevationprofile-legend__collision .og-elevationprofile-units"),this}clear(){this.$trackValue&&(this.$trackValue.innerText="0"),this.$trackUnits&&(this.$trackUnits.innerText="m"),this.$groundValue&&(this.$groundValue.innerText="0"),this.$groundUnits&&(this.$groundUnits.innerText="m"),this.$warningValue&&(this.$warningValue.innerText="0"),this.$warningUnits&&(this.$warningUnits.innerText="m"),this.$collisionValue&&(this.$collisionValue.innerText="0"),this.$collisionUnits&&(this.$collisionUnits.innerText="m")}setTrackLength(e){let t=Ue(e);this.$trackValue.innerText=t[0],this.$trackUnits.innerText=t[1]}setGroundLength(e){let t=Ue(e);this.$groundValue.innerText=t[0],this.$groundUnits.innerText=t[1]}setWarningLength(e){let t=Ue(e);this.$warningValue.innerText=t[0],this.$warningUnits.innerText=t[1]}setCollisionLength(e){let t=Ue(e);this.$collisionValue.innerText=t[0],this.$collisionUnits.innerText=t[1]}}const We="rgb(253,77,77)",en="rgb(248,115,115)",ns="rgb(73,73,239)",sn="rgb(90,90,253)",os="rgb(26,122,26)",rn="rgb(55,191,55)",jn="rgba(255,255,255,0.8)",qi=.1,ma=new m(qi,qi,qi),va=.17,qn=.0095,oh=W.createCylinder(qn,qn,.83).scale(ma),ah=W.createCylinder(0,.04,va,16,16,!1,!0,0,-.17).scale(ma);class Xs extends V{constructor(e={}){super({independentPicking:!0,yaw:e.yaw||0,pitch:e.pitch||0,roll:e.roll||0,forceGlobalPosition:!0,geoObject:{color:e.color||We,scale:1,tag:"line",object3d:oh},properties:e.properties}),this._size=e.size!=null?e.size:1,this.appendChild(new V({yaw:e.yaw||0,pitch:e.pitch||0,roll:e.roll||0,forceGlobalPosition:!0,geoObject:{color:e.color||We,scale:1,tag:"tip",object3d:ah},properties:e.properties}))}setSize(e){this._size=e;const t=new m(1,(this._size-va)/.83,1),s=new m(0,this._size*qi,0);let n=this.childEntities[0];this.setScale3v(t),n.geoObject.setTranslate3v(s)}setColorHTML(e){let t=this.childEntities[0];this.geoObject.setColorHTML(e),t.geoObject.setColorHTML(e)}}class lh extends V{constructor(e={}){super(e),this._size=e.size!=null?e.size:1,this.childEntities=[],this._init()}_init(){let e=new Xs({color:We,yaw:0,pitch:0,roll:90*U,properties:{opName:"move_x",noEdit:!0,style:{color:We,selectColor:en}}}),t=new Xs({color:ns,yaw:0,pitch:0,roll:0,properties:{opName:"move_y",noEdit:!0,style:{color:ns,selectColor:sn}}}),s=new Xs({color:os,yaw:0,pitch:90*U,roll:0,properties:{opName:"move_z",noEdit:!0,style:{color:os,selectColor:rn}}});this.appendChild(e),this.appendChild(t),this.appendChild(s),this.setSize(this._size)}setSize(e){this.childEntities[0].setSize(e),this.childEntities[1].setSize(e),this.childEntities[2].setSize(e)}setPitch(e){let t=this.childEntities[0],s=t.childEntities[0];t.setPitch(e),s.setPitch(e),t=this.childEntities[1],s=t.childEntities[0],t.setPitch(e),s.setPitch(e),t=this.childEntities[2],s=t.childEntities[0],t.setPitch(e+90),s.setPitch(e+90)}setYaw(e){let t=this.childEntities[0],s=t.childEntities[0];t.setYaw(e),s.setYaw(e),t=this.childEntities[1],s=t.childEntities[0],t.setYaw(e),s.setYaw(e),t=this.childEntities[2],s=t.childEntities[0],t.setYaw(e),s.setYaw(e)}setRoll(e){let t=this.childEntities[0],s=t.childEntities[0];t.setRoll(e+90),s.setRoll(e+90),t=this.childEntities[1],s=t.childEntities[0],t.setRoll(e),s.setRoll(e)}getY(){return this.childEntities[1].getAbsoluteRotation().mulVec3(m.UP).normalize()}}const hh=W.createPlane(1,1,-.5,0,.5);class ch extends V{constructor(e={}){super(e),this._init()}_init(){let e=new V({independentPicking:!0,scale:.025,forceGlobalPosition:!0,geoObject:{color:jn,tag:"plane",object3d:hh},properties:{opName:"move_xz",noEdit:!0,style:{color:jn,selectColor:"rgba(255,255,255,1.0)"}}});this.appendChild(e)}}const Ai=360,Zs=.95,Yn=new Array(Ai),Wn=new Array(Ai),$n=new Array(Ai);class dh extends V{constructor(e={}){super(e),this._init()}_init(){const e=Ai;let t=new V({independentPicking:!0,polyline:{path3v:[Array.from({length:e},(o,a)=>new m)],thickness:3.1,color:We,isClosed:!0},properties:{opName:"rotate_pitch",noEdit:!0,style:{color:We,selectColor:en}}}),s=new V({independentPicking:!0,polyline:{path3v:[Array.from({length:e},(o,a)=>new m)],thickness:2.5,color:ns,isClosed:!0},properties:{opName:"rotate_yaw",noEdit:!0,style:{color:ns,selectColor:sn}}}),n=new V({independentPicking:!0,polyline:{path3v:[Array.from({length:e},(o,a)=>new m)],thickness:2.5,color:os,isClosed:!0},properties:{opName:"rotate_roll",noEdit:!0,style:{color:os,selectColor:rn}}});this.appendChild(t),this.appendChild(s),this.appendChild(n)}setCartesian3v(e,t=0){if(super.setCartesian3v(e),this._entityCollection&&this._entityCollection.renderNode){let s=this._entityCollection.renderNode,n=s.renderer.activeCamera,o=s.getFrameRotation(e).conjugate(),a=.15*n.eye.distance(e),h=D.xRotation(0),c=D.yRotation(t),d=D.zRotation(0).mul(h).mul(c).mul(s.getFrameRotation(e)).conjugate();for(let v=0,g=0,y=1;v<Ai;v+=y,g++){let p=v*U,x=Math.cos(p),T=Math.sin(p),w=d.mulVec3(new m(0,T,x)).normalize().scale(a).add(e),C=o.mulVec3(new m(x,0,T)).normalize().scale(a).add(e),E=d.mulVec3(new m(x,T,0)).normalize().scale(a).add(e);Yn[g]=w,Wn[g]=C,$n[g]=E}this.childEntities[0].polyline.setPath3v([Yn],void 0,!0),this.childEntities[1].polyline.setPath3v([Wn],void 0,!0),this.childEntities[2].polyline.setPath3v([$n],void 0,!0);let u=d.mulVec3(new m(1,0,0)).normalize(),_=o.mulVec3(new m(0,1,0)).normalize(),f=d.mulVec3(new m(0,0,1)).normalize();this.childEntities[0].polyline.setVisibleSphere(e,Math.abs(u.dot(n.getForward()))>Zs?0:a),this.childEntities[1].polyline.setVisibleSphere(e,Math.abs(_.dot(n.getForward()))>Zs?0:a),this.childEntities[2].polyline.setVisibleSphere(e,Math.abs(f.dot(n.getForward()))>Zs?0:a)}}}class uh extends V{constructor(e={}){super({...e,forceGlobalPosition:!0}),this._init()}_init(){let e=[],t=[],s=[],n=me(en),o=me(sn),a=me(rn);for(let u=0;u<20;u++){let _=1;if(u<5){let f=u/5;_=.5*(1-Math.cos(Math.PI*f))}else if(u>15){let f=(u-15)/5;_=1-.5*(1-Math.cos(Math.PI*f))}t.push([a[0],a[1],a[2],_]),e.push([n[0],n[1],n[2],_]),s.push([o[0],o[1],o[2],_])}let h=new V({polyline:{path3v:[Array.from({length:20},(u,_)=>new m)],thickness:2.5,pathColors:[e],isClosed:!1}}),c=new V({polyline:{path3v:[Array.from({length:20},(u,_)=>new m)],thickness:2.5,pathColors:[s],isClosed:!1}}),d=new V({polyline:{path3v:[Array.from({length:20},(u,_)=>new m)],thickness:2.5,pathColors:[t],isClosed:!1}});this.appendChild(h),this.appendChild(c),this.appendChild(d)}setCartesian3v(e){if(super.setCartesian3v(e),this._entityCollection&&this._entityCollection.renderNode){let t=this._entityCollection.renderNode,s=.05*t.renderer.activeCamera.eye.distance(e);if(t.planet){let n=[],o=[],a=[],h=t.planet.ellipsoid.getSurfaceNormal3v(e),c=this._lonLat,d=10;for(let u=-10;u<d;u++)a.push(new A(c.lon,c.lat+u,c.height)),o.push(new A(c.lon+u,c.lat,c.height)),n.push(e.add(h.scaleTo(u*s)));this.childEntities[0].polyline.setPathLonLatFast([o]),this.childEntities[1].polyline.setPath3vFast([n]),this.childEntities[2].polyline.setPathLonLatFast([a])}else{let n=[],o=[],a=[],h=m.UNIT_Y,c=m.UNIT_X,d=m.UNIT_Z,u=10;for(let _=-10;_<u;_++)o.push(e.add(c.scaleTo(_*s))),a.push(e.add(h.scaleTo(_*s))),n.push(e.add(d.scaleTo(_*s)));this.childEntities[0].polyline.setPath3vFast([o]),this.childEntities[1].polyline.setPath3vFast([a]),this.childEntities[2].polyline.setPath3vFast([n])}}}}function Xn(l,e,t,s,n,o){let a=n.add(m.UP),h=n.add(l),c=new m;if(new N(e,t).hitPlaneRes(mt.fromPoints(n,a,h),c)===N.INSIDE){let d=m.proj_b_to_a(c,l);if(new N(e,s).hitPlaneRes(mt.fromPoints(n,a,h),c)===N.INSIDE){let u=m.proj_b_to_a(c,l).sub(d);o.copy(n.add(u))}}}class _h extends ce{constructor(e={}){super(e.name||"GeoObjectEditorScene"),this._onAxisLayerMouseEnter=t=>{this.renderer.handler.canvas.style.cursor="pointer",t.pickingObject.setColorHTML(t.pickingObject.properties.style.selectColor)},this._onAxisLayerMouseLeave=t=>{this.renderer.handler.canvas.style.cursor="default",t.pickingObject.setColorHTML(t.pickingObject.properties.style.color)},this._onAxisLayerLUp=t=>{this._selectedMove=null,this._navActivate(),this._setAxisTrackVisibility(!1)},this._onAxisLayerLDown=t=>{this._clickPos=t.pos.clone(),this._selectedEntity&&(this._selectedEntityCart=this._selectedEntity.getAbsoluteCartesian(),this._setAxisTrackVisibility(!0)),this._selectedMove=t.pickingObject.properties.opName,this._navDeactivate()},this._onPlaneLayerMouseEnter=t=>{this.renderer.handler.canvas.style.cursor="pointer",t.pickingObject.geoObject.setColorHTML(t.pickingObject.properties.style.selectColor)},this._onPlaneLayerMouseLeave=t=>{this.renderer.handler.canvas.style.cursor="default",t.pickingObject.geoObject.setColorHTML(t.pickingObject.properties.style.color)},this._onPlaneLayerLUp=t=>{this._selectedMove=null,this._navActivate(),this._setAxisTrackVisibility(!1)},this._onPlaneLayerLDown=t=>{this._clickPos=t.pos.clone(),this._selectedEntity&&(this._selectedEntityCart=this._selectedEntity.getAbsoluteCartesian(),this._setAxisTrackVisibility(!0)),this._selectedMove=t.pickingObject.properties.opName,this._navDeactivate()},this._onRotateLayerMouseEnter=t=>{this.renderer.handler.canvas.style.cursor="pointer",t.pickingObject.polyline.setColorHTML(t.pickingObject.properties.style.selectColor)},this._onRotateLayerMouseLeave=t=>{this.renderer.handler.canvas.style.cursor="default",t.pickingObject.polyline.setColorHTML(t.pickingObject.properties.style.color)},this._onRotateLayerLUp=t=>{this._selectedMove=null,this._navActivate()},this._onRotateLayerLDown=t=>{this._clickPos=t.pos.clone(),this._selectedEntity&&(this._selectedEntityCart=this._selectedEntity.getAbsoluteCartesian(),this._selectedEntity&&(this._selectedEntityPitch=this._selectedEntity.getAbsolutePitch(),this._selectedEntityYaw=this._selectedEntity.getAbsoluteYaw(),this._selectedEntityRoll=this._selectedEntity.getAbsoluteRoll())),this._selectedMove=t.pickingObject.properties.opName,this._navDeactivate()},this._onMouseMove=t=>{this._selectedEntity&&this._selectedMove&&this._ops[this._selectedMove]&&this._ops[this._selectedMove](t)},this._onLclick=t=>{t.pickingObject&&t.pickingObject instanceof V&&this.select(t.pickingObject)},this._moveX=t=>{if(!this._selectedEntity)return;let s=this.renderer.activeCamera,n=this._selectedEntityCart,o=s.unproject(this._clickPos.x,this._clickPos.y),a=new m;if(this.planet){let h=new N(s.eye,o).hitSphere(new Dt(n.length(),new m)),c=new N(s.eye,t.direction).hitSphere(new Dt(n.length(),new m));if(!c)return;if(a=D.getRotationBetweenVectors(h.normal(),c.normal()).mulVec3(n),this.ellipsoid){let d=this.ellipsoid.cartesianToLonLat(n),u=this.ellipsoid.cartesianToLonLat(a);this.ellipsoid.lonLatToCartesianRes(new A(u.lon,d.lat,d.height),a)}}else Xn(m.UNIT_X,s.eye,o,t.direction,n,a);this._selectedEntity.setAbsoluteCartesian3v(a),this.events.dispatch(this.events.position,a,this._selectedEntity),this.events.dispatch(this.events.change,this._selectedEntity)},this._moveY=t=>{if(!this._selectedEntity)return;let s=this.renderer.activeCamera,n=this._selectedEntityCart,o=m.UP;this.planet&&(o=this._axisEntity.getY());let a=n.add(o),h=n.add(s.getRight()),c=new m,d=s.unproject(this._clickPos.x,this._clickPos.y);if(new N(s.eye,d).hitPlaneRes(mt.fromPoints(n,a,h),c)===N.INSIDE){let u=m.proj_b_to_a(c,o);if(new N(s.eye,t.direction).hitPlaneRes(mt.fromPoints(n,a,h),c)===N.INSIDE){let _=m.proj_b_to_a(c,o).sub(u),f=this._selectedEntityCart.add(_);this._selectedEntity.setAbsoluteCartesian3v(f),this.events.dispatch(this.events.position,c,this._selectedEntity),this.events.dispatch(this.events.change,this._selectedEntity)}}},this._moveZ=t=>{if(!this._selectedEntity)return;let s=this.renderer.activeCamera,n=this._selectedEntityCart,o=s.unproject(this._clickPos.x,this._clickPos.y),a=new m;if(this.planet){let h=new N(s.eye,o).hitSphere(new Dt(n.length(),new m)),c=new N(s.eye,t.direction).hitSphere(new Dt(n.length(),new m));if(!c)return;if(a=D.getRotationBetweenVectors(h.normal(),c.normal()).mulVec3(n),this.ellipsoid){let d=this.ellipsoid.cartesianToLonLat(n),u=this.ellipsoid.cartesianToLonLat(a);this.ellipsoid.lonLatToCartesianRes(new A(d.lon,u.lat,d.height),a)}}else Xn(m.UNIT_Z,s.eye,o,t.direction,n,a);this._selectedEntity.setAbsoluteCartesian3v(a),this.events.dispatch(this.events.position,a,this._selectedEntity),this.events.dispatch(this.events.change,this._selectedEntity)},this._moveXZ=t=>{if(!this._selectedEntity)return;let s=this.renderer.activeCamera,n=this._selectedEntityCart,o=s.unproject(this._clickPos.x,this._clickPos.y),a=new m;if(this.planet){let h=new N(s.eye,o).hitSphere(new Dt(n.length(),new m)),c=new N(s.eye,t.direction).hitSphere(new Dt(n.length(),new m));if(!c)return;if(a=D.getRotationBetweenVectors(h.normal(),c.normal()).mulVec3(n),this.ellipsoid){let d=this.ellipsoid.cartesianToLonLat(a),u=this._selectedEntity.getLonLat().height;this.ellipsoid.lonLatToCartesianRes(new A(d.lon,d.lat,u),a)}}else{let h=n.add(m.UNIT_X),c=n.add(m.UNIT_Z),d=new m,u=new m;if(new N(s.eye,o).hitPlaneRes(mt.fromPoints(n,h,c),d)===N.INSIDE&&new N(s.eye,t.direction).hitPlaneRes(mt.fromPoints(n,h,c),u)===N.INSIDE){let _=u.sub(d);a=n.add(_)}}this._selectedEntity.setAbsoluteCartesian3v(a),this.events.dispatch(this.events.position,a,this._selectedEntity),this.events.dispatch(this.events.change,this._selectedEntity)},this._moveXY=t=>{console.log("moveXY")},this._moveZY=t=>{console.log("moveZY")},this._rotatePitch=t=>{if(!this._selectedEntity)return;let s=this.renderer.activeCamera,n=this._selectedEntityCart,o=D.xRotation(0),a=D.yRotation(this._selectedEntity.getYaw()),h=D.zRotation(0).mul(o).mul(a).mul(this.getFrameRotation(n)).conjugate().mulVec3(new m(1,0,0)).normalize(),c=s.unproject(this._clickPos.x,this._clickPos.y),d=new mt(n,h),u=new m,_=new m;if(new N(s.eye,c).hitPlaneRes(d,u)===N.INSIDE&&new N(s.eye,t.direction).hitPlaneRes(d,_)===N.INSIDE){let f=u.sub(n).normalize(),v=_.sub(n).normalize(),g=Math.sign(f.cross(v).dot(h)),y=Math.acos(f.dot(v)),p=this._selectedEntityPitch+g*y;this._selectedEntity.setAbsolutePitch(p),this.events.dispatch(this.events.pitch,p,this._selectedEntity),this.events.dispatch(this.events.change,this._selectedEntity)}},this._rotateYaw=t=>{if(!this._selectedEntity)return;let s=this.renderer.activeCamera,n=this._selectedEntityCart,o=this.getFrameRotation(n).conjugate().mulVec3(new m(0,1,0)).normalize(),a=s.unproject(this._clickPos.x,this._clickPos.y),h=new mt(n,o),c=new m,d=new m;if(new N(s.eye,a).hitPlaneRes(h,c)===N.INSIDE&&new N(s.eye,t.direction).hitPlaneRes(h,d)===N.INSIDE){let u=c.sub(n).normalize(),_=d.sub(n).normalize(),f=Math.sign(_.cross(u).dot(o)),v=Math.acos(u.dot(_)),g=this._selectedEntityYaw+f*v;this._selectedEntity.setAbsoluteYaw(g),this.events.dispatch(this.events.yaw,g,this._selectedEntity),this.events.dispatch(this.events.change,this._selectedEntity)}},this._rotateRoll=t=>{if(!this._selectedEntity)return;let s=this.renderer.activeCamera,n=this._selectedEntityCart;this.getFrameRotation(n).conjugate();let o=D.xRotation(0),a=D.yRotation(this._selectedEntity.getYaw()),h=D.zRotation(0).mul(o).mul(a).mul(this.getFrameRotation(n)).conjugate().mulVec3(new m(0,0,1)).normalize(),c=s.unproject(this._clickPos.x,this._clickPos.y),d=new mt(n,h),u=new m,_=new m;if(new N(s.eye,c).hitPlaneRes(d,u)===N.INSIDE&&new N(s.eye,t.direction).hitPlaneRes(d,_)===N.INSIDE){let f=u.sub(n).normalize(),v=_.sub(n).normalize(),g=Math.sign(f.cross(v).dot(h)),y=Math.acos(f.dot(v)),p=this._selectedEntityRoll+g*y;this._selectedEntity.setAbsoluteRoll(p),this.events.dispatch(this.events.roll,p,this._selectedEntity),this.events.dispatch(this.events.change,this._selectedEntity)}},this._scale=t=>{this.events.dispatch(this.events.scale,1,this._selectedEntity),this.events.dispatch(this.events.change,this._selectedEntity)},this._scaleX=t=>{},this._scaleY=t=>{},this._scaleZ=t=>{},this.events=ot(fh),this._planet=e.planet||null,this._startPos=null,this._startClick=new O,this._axisEntity=new lh,this._planeEntity=new ch,this._rotateEntity=new dh,this._axisTrackEntity=new uh,this._moveLayer=new ee({scaleByDistance:[.1,Ee,.1],useLighting:!1,pickingScale:[5,1.1,5],visibility:!1,depthOrder:1e3}),this._planeLayer=new ee({scaleByDistance:[.1,Ee,.1],useLighting:!1,visibility:!1,depthOrder:1e3}),this._rotateLayer=new ee({useLighting:!1,visibility:!1,depthOrder:1e3,pickingScale:5}),this._selectedEntity=null,this._clickPos=new O,this._selectedEntityCart=new m,this._selectedEntityPitch=0,this._selectedEntityYaw=0,this._selectedEntityRoll=0,this._selectedMove=null,this._axisTrackVisibility=!1,this._axisTrackLayer=new ee({useLighting:!1,visibility:!1,pickingScale:5,pickingEnabled:!1,opacity:.6}),this._ops={move_x:this._moveX,move_y:this._moveY,move_z:this._moveZ,move_xz:this._moveXZ,move_xy:this._moveXY,move_zy:this._moveZY,rotate_pitch:this._rotatePitch,rotate_yaw:this._rotateYaw,rotate_roll:this._rotateRoll,scale:this._scale,scale_x:this._scaleX,scale_y:this._scaleY,scale_z:this._scaleZ}}get ellipsoid(){if(this._planet)return this._planet.ellipsoid}get planet(){return this._planet}bindPlanet(e){this._planet=e}init(){this.activate()}onremove(){this.deactivate()}_addAxisLayers(){this._moveLayer.addTo(this),this._planeLayer.addTo(this),this._rotateLayer.addTo(this),this._axisTrackLayer.addTo(this),this._moveLayer.add(this._axisEntity),this._moveLayer.events.on("mouseenter",this._onAxisLayerMouseEnter),this._moveLayer.events.on("mouseleave",this._onAxisLayerMouseLeave),this._moveLayer.events.on("lup",this._onAxisLayerLUp),this._moveLayer.events.on("ldown",this._onAxisLayerLDown),this._planeLayer.add(this._planeEntity),this._planeLayer.events.on("mouseenter",this._onPlaneLayerMouseEnter),this._planeLayer.events.on("mouseleave",this._onPlaneLayerMouseLeave),this._planeLayer.events.on("lup",this._onPlaneLayerLUp),this._planeLayer.events.on("ldown",this._onPlaneLayerLDown),this._rotateLayer.add(this._rotateEntity),this._rotateLayer.events.on("mouseenter",this._onRotateLayerMouseEnter),this._rotateLayer.events.on("mouseleave",this._onRotateLayerMouseLeave),this._rotateLayer.events.on("lup",this._onRotateLayerLUp),this._rotateLayer.events.on("ldown",this._onRotateLayerLDown),this._axisTrackLayer.add(this._axisTrackEntity)}_navActivate(){this.renderer&&(this.renderer.controls.mouseNavigation&&this.renderer.controls.mouseNavigation.activate(),this.renderer.controls.SimpleNavigation&&this.renderer.controls.SimpleNavigation.activate())}_navDeactivate(){this.renderer&&(this.renderer.controls.mouseNavigation&&this.renderer.controls.mouseNavigation.deactivate(),this.renderer.controls.SimpleNavigation&&this.renderer.controls.SimpleNavigation.deactivate())}_removeAxisLayers(){this._moveLayer.remove(),this._planeLayer.remove(),this._rotateLayer.remove()}activate(){this.renderer.events.on("lclick",this._onLclick),this.renderer.events.on("mousemove",this._onMouseMove),this._addAxisLayers()}deactivate(){this.renderer.events.off("lclick",this._onLclick),this.renderer.events.off("mousemove",this._onMouseMove),this._removeAxisLayers(),this.clear()}_setAxisTrackVisibility(e){e!==this._axisTrackVisibility&&(this._axisTrackVisibility=e,this._axisTrackLayer.setVisibility(e))}setVisibility(e){this._moveLayer.setVisibility(e),this._planeLayer.setVisibility(e),this._rotateLayer.setVisibility(e),this.unlockView()}readyToEdit(e){return!e.properties||!e.properties.noEdit}select(e){(!this._selectedEntity||this._selectedEntity&&!e.isEqual(this._selectedEntity))&&this.readyToEdit(e)&&(this._selectedEntity&&this.unselect(),this._selectedEntity=e,this.renderer&&this.renderer.setRelativeCenter(),this.setVisibility(!0),this.events.dispatch(this.events.select,this._selectedEntity))}unselect(){this.setVisibility(!1);let e=this._selectedEntity;this._selectedEntity=null,this.events.dispatch(this.events.unselect,e)}clear(){this.removeEntityCollection(this._moveLayer),this.removeEntityCollection(this._planeLayer),this.removeEntityCollection(this._rotateLayer)}frame(){if(this._selectedEntity){let e=this._selectedEntity.getAbsoluteCartesian();this._axisEntity.setCartesian3v(e),this._planeEntity.setCartesian3v(e),this._rotateEntity.setCartesian3v(e,this._selectedEntity.getAbsoluteYaw()),this._axisTrackEntity.setCartesian3v(e)}}getFrameRotation(e){return this._planet?this._planet.getFrameRotation(e):super.getFrameRotation(e)}getSelectedEntity(){return this._selectedEntity}lockView(){this.renderer&&this._selectedEntity&&this.renderer.controls.CameraLock.lockView(this._selectedEntity)}unlockView(){if(this.renderer&&this._selectedEntity){let e=this.renderer.controls.CameraLock;e&&e.unlockView()}}}const fh=["mousemove","mouseenter","mouseleave","lclick","rclick","mclick","ldblclick","rdblclick","mdblclick","lup","rup","mup","ldown","rdown","mdown","lhold","rhold","mhold","mousewheel","touchmove","touchstart","touchend","doubletouch","touchleave","touchenter","select","unselect","change","position","pitch","yaw","roll","scale"],gh=["change"];class vt extends dt{constructor(e={}){super({template:zt(`<div class="og-input">
      <div class="og-input-label">{label}</div>
      <input type="{type}"/>
    </div>`,{label:e.label||"",type:e.type||"text"})}),this._onResize=()=>{},this._onMouseWheel=t=>{(t=t||window.event).preventDefault(),t.stopPropagation()},this._onMouseWheelFF=t=>{this._onMouseWheel(t)},this._onInput=t=>{(t=t||window.event).preventDefault(),t.stopPropagation(),this._setValue(t.target.value)},this.events=this.events.registerNames(gh),this._value=e.value||"",this._maxFixed=e.maxFixed!=null?e.maxFixed:-1,this.$label=null,this.$input=null}render(e){return super.render(e),this.$label=this.select(".og-input-label"),this.$label.innerHTML===""&&(this.$label.style.display="none"),this.$input=this.select("input"),this._initEvents(),this}set value(e){e!==this._value&&(this._value=typeof e=="number"?cr(e,this._maxFixed):e,this.$input&&(this.$input.value=this._value),this.events.dispatch(this.events.change,this._value,this))}_setValue(e){e!==this._value&&(this._value=typeof e=="number"?cr(e,this._maxFixed):e,this.events.dispatch(this.events.change,this._value,this))}get value(){return this._value}_initEvents(){this.el.addEventListener("mousewheel",this._onMouseWheel),this.el.addEventListener("wheel",this._onMouseWheelFF),this.$input.addEventListener("input",this._onInput)}_clearEvents(){this.el.removeEventListener("mousewheel",this._onMouseWheel),this.el.removeEventListener("wheel",this._onMouseWheelFF),this.$input.removeEventListener("input",this._onInput)}remove(){this._clearEvents(),super.remove()}set visibility(e){this.el&&(this.el.style.display=e?"":"none")}}const ph=["change"];class mh extends dt{constructor(e={}){super({template:zt(`<div class="og-checkbox">
      <div class="og-input-label">{label}</div>
      <div class="og-checkbox-input">
        <input type="checkbox" {checked}/>
      </div>
    </div>`,{label:e.label||"",checked:e.checked?"checked":""})}),this._onResize=()=>{},this._onMouseWheel=t=>{(t=t||window.event).preventDefault(),t.stopPropagation()},this._onMouseWheelFF=t=>{this._onMouseWheel(t)},this._onClick=t=>{(t=t||window.event).stopPropagation(),this.checked=!this._checked},this._checked=e.checked||!1,this._disabled=e.disabled||!1,this.events=this.events.registerNames(ph),this.$label=null,this.$input=null}set disabled(e){this._disabled=e,this._updateDisabled()}_updateDisabled(){this.el&&(this._disabled?this.el.classList.add("og-input-disabled"):this.el.classList.remove("og-input-disabled"))}get disabled(){return this._disabled}render(e){return super.render(e),this.$label=this.select(".og-input-label"),this.$label.innerHTML===""&&(this.$label.style.display="none"),this.$input=this.select("input"),this.$input.checked=this._checked,this._updateDisabled(),this._initEvents(),this}set checked(e){e!==this._checked&&(this._checked=e,this.$input&&(this.$input.checked=this._checked),this.events.dispatch(this.events.change,this._checked,this))}get checked(){return this._checked}_initEvents(){this.el.addEventListener("mousewheel",this._onMouseWheel),this.el.addEventListener("wheel",this._onMouseWheelFF),this.$input.addEventListener("click",this._onClick)}_clearEvents(){this.el.removeEventListener("mousewheel",this._onMouseWheel),this.el.removeEventListener("wheel",this._onMouseWheelFF),this.$input.removeEventListener("click",this._onClick)}remove(){this._clearEvents(),super.remove()}set visibility(e){this.el&&(this.el.style.display=e?"":"none")}}class vh extends Zt{constructor(e){super({title:"GeoObject Properties",visible:!1,resizable:!0,useHide:!0,top:25,right:85,width:252,height:480,minHeight:100,minWidth:100,model:e.model}),this._onVisibility=t=>{this.model.setVisibility(t)},this._onSelect=t=>{this.show(),this._refresh(t)},this._onUnselect=t=>{this.hide()},this._onChangeRelativePosition=t=>{let s=this.model.getSelectedEntity();s&&(s.relativePosition=t,this._refresh(s))},this._onPosition=(t,s)=>{this._refresh(s)},this._onPitch=(t,s)=>{this._pitchView.stopPropagation(),this._pitchView.value=s.getPitch()*Q,this._absolutePitchView.stopPropagation(),this._absolutePitchView.value=s.getAbsolutePitch()*Q},this._onYaw=(t,s)=>{this._yawView.stopPropagation(),this._yawView.value=s.getYaw()*Q,this._absoluteYawView.stopPropagation(),this._absoluteYawView.value=s.getAbsoluteYaw()*Q},this._onRoll=(t,s)=>{this._rollView.stopPropagation(),this._rollView.value=s.getRoll()*Q,this._absoluteRollView.stopPropagation(),this._absoluteRollView.value=s.getAbsoluteRoll()*Q},this._onChangeLon=t=>{let s=this.model.getSelectedEntity();if(s){let n=s.getLonLat();s.setLonLat2(parseFloat(t),n.lat,n.height),this._refresh(s)}},this._onChangeLat=t=>{let s=this.model.getSelectedEntity();if(s){let n=s.getLonLat();s.setLonLat2(n.lon,parseFloat(t),n.height),this._refresh(s)}},this._onChangeHeight=t=>{let s=this.model.getSelectedEntity();if(s){let n=s.getLonLat();s.setLonLat2(n.lon,n.lat,parseFloat(t)),this._refresh(s)}},this._onChangeX=t=>{let s=this.model.getSelectedEntity();if(s){let n=s.getCartesian();s.setCartesian(parseFloat(t),n.y,n.z),this._refresh(s)}},this._onChangeY=t=>{let s=this.model.getSelectedEntity();if(s){let n=s.getCartesian();s.setCartesian(n.x,parseFloat(t),n.z),this._refresh(s)}},this._onChangeZ=t=>{let s=this.model.getSelectedEntity();if(s){let n=s.getCartesian();s.setCartesian(n.x,n.y,parseFloat(t)),this._refresh(s)}},this._onChangeAbsoluteX=t=>{let s=this.model.getSelectedEntity();if(s){let n=s.getAbsoluteCartesian();s.setAbsoluteCartesian(parseFloat(t),n.y,n.z),this._refresh(s)}},this._onChangeAbsoluteY=t=>{let s=this.model.getSelectedEntity();if(s){let n=s.getAbsoluteCartesian();s.setAbsoluteCartesian(n.x,parseFloat(t),n.z),this._refresh(s)}},this._onChangeAbsoluteZ=t=>{let s=this.model.getSelectedEntity();if(s){let n=s.getAbsoluteCartesian();s.setAbsoluteCartesian(n.x,n.y,parseFloat(t)),this._refresh(s)}},this._onChangePitch=t=>{let s=this.model.getSelectedEntity();s&&(s.setPitch(parseFloat(t)*U),this._refresh(s))},this._onChangeYaw=t=>{let s=this.model.getSelectedEntity();s&&(s.setYaw(parseFloat(t)*U),this._refresh(s))},this._onChangeRoll=t=>{let s=this.model.getSelectedEntity();s&&(s.setRoll(parseFloat(t)*U),this._refresh(s))},this._onChangeAbsolutePitch=t=>{let s=this.model.getSelectedEntity();s&&(s.setAbsolutePitch(parseFloat(t)*U),this._refresh(s))},this._onChangeAbsoluteYaw=t=>{let s=this.model.getSelectedEntity();s&&(s.setAbsoluteYaw(parseFloat(t)*U),this._refresh(s))},this._onChangeAbsoluteRoll=t=>{let s=this.model.getSelectedEntity();s&&(s.setAbsoluteRoll(parseFloat(t)*U),this._refresh(s))},this._onChangeScale=t=>{let s=this.model.getSelectedEntity();if(s){let n=parseFloat(t);s.setScale(n),this._scaleXView.stopPropagation(),this._scaleYView.stopPropagation(),this._scaleZView.stopPropagation(),this._scaleXView.value=n,this._scaleYView.value=n,this._scaleZView.value=n}},this._onChangeScaleX=t=>{let s=this.model.getSelectedEntity();if(s){let n=s.getScale();s.setScale3v(new m(parseFloat(t),n.y,n.z))}},this._onChangeScaleY=t=>{let s=this.model.getSelectedEntity();if(s){let n=s.getScale();s.setScale3v(new m(n.x,parseFloat(t),n.z))}},this._onChangeScaleZ=t=>{let s=this.model.getSelectedEntity();if(s){let n=s.getScale();s.setScale3v(new m(n.x,n.y,parseFloat(t)))}},this._onGround=()=>{let t=this.model.getSelectedEntity();t&&this.model.planet&&(this.model.planet.terrain?this.model.planet.terrain.getHeightAsync(t.getLonLat(),s=>{this._heightView.value=s}):this._heightView.value=0)},this._relativePositionView=new mh({label:"Relative position"}),this._lonView=new vt({label:"Lon",type:"number",min:-180,max:180,maxFixed:10}),this._latView=new vt({label:"Lat",type:"number",min:-90,max:90,maxFixed:10}),this._heightView=new vt({label:"Height",type:"number",maxFixed:4}),this._xView=new vt({label:"X",type:"number",maxFixed:10}),this._yView=new vt({label:"Y",type:"number"}),this._zView=new vt({label:"Z",type:"number"}),this._absXView=new vt({label:"Absolute X",type:"number",maxFixed:10}),this._absYView=new vt({label:"Absolute Y",type:"number"}),this._absZView=new vt({label:"Absolute Z",type:"number"}),this._pitchView=new vt({label:"Pitch",type:"number",maxFixed:2}),this._yawView=new vt({label:"Yaw",type:"number",maxFixed:2}),this._rollView=new vt({label:"Roll",type:"number",maxFixed:2}),this._absolutePitchView=new vt({label:"Absolute pitch",type:"number",maxFixed:2}),this._absoluteYawView=new vt({label:"Absolute yaw",type:"number",maxFixed:2}),this._absoluteRollView=new vt({label:"Absolute roll",type:"number",maxFixed:2}),this._scaleView=new vt({label:"Scale",type:"number",maxFixed:2}),this._scaleXView=new vt({label:"Scale X",type:"number",maxFixed:2}),this._scaleYView=new vt({label:"Scale Y",type:"number",maxFixed:2}),this._scaleZView=new vt({label:"Scale Z",type:"number",maxFixed:2}),this._groundBtn=new he({text:"Ground",title:"Put on the ground",name:"ground",classList:["og-editor-ground_button"]})}render(e){var t;super.render(e),this._initSceneEvents();let s=document.createElement("div");s.classList.add("og-editor_toolbar"),(t=this.container)==null||t.appendChild(s);let n=new ct({classList:["og-editor_toolbar-button"],icon:`<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" id="filter-center-focus">
  <path d="M5 15H3v4c0 1.1.9 2 2 2h4v-2H5v-4zM5 5h4V3H5c-1.1 0-2 .9-2 2v4h2V5zm14-2h-4v2h4v4h2V5c0-1.1-.9-2-2-2zm0 16h-4v2h4c1.1 0 2-.9 2-2v-4h-2v4zM12 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
</svg>`,title:"Lock/Unlock camera view"});return n.appendTo(s),n.events.on("change",o=>{o?this.model.lockView():this.model.unlockView()}),this.events.on("visibility",o=>{o||(n.events.stopPropagation(),n.setActive(!1))}),this.events.on("visibility",this._onVisibility),this._relativePositionView.appendTo(this.container),this.model.planet&&(this._lonView.appendTo(this.container),this._latView.appendTo(this.container),this._heightView.appendTo(this.container)),this._xView.appendTo(this.container),this._yView.appendTo(this.container),this._zView.appendTo(this.container),this._absXView.appendTo(this.container),this._absYView.appendTo(this.container),this._absZView.appendTo(this.container),this._pitchView.appendTo(this.container),this._yawView.appendTo(this.container),this._rollView.appendTo(this.container),this._absolutePitchView.appendTo(this.container),this._absoluteYawView.appendTo(this.container),this._absoluteRollView.appendTo(this.container),this._scaleView.appendTo(this.container),this._scaleXView.appendTo(this.container),this._scaleYView.appendTo(this.container),this._scaleZView.appendTo(this.container),this.model.planet&&this._groundBtn.appendTo(this.container),this._relativePositionView.events.on("change",this._onChangeRelativePosition),this._lonView.events.on("change",this._onChangeLon),this._latView.events.on("change",this._onChangeLat),this._heightView.events.on("change",this._onChangeHeight),this._xView.events.on("change",this._onChangeX),this._yView.events.on("change",this._onChangeY),this._zView.events.on("change",this._onChangeZ),this._absXView.events.on("change",this._onChangeAbsoluteX),this._absYView.events.on("change",this._onChangeAbsoluteY),this._absZView.events.on("change",this._onChangeAbsoluteZ),this._pitchView.events.on("change",this._onChangePitch),this._yawView.events.on("change",this._onChangeYaw),this._rollView.events.on("change",this._onChangeRoll),this._absolutePitchView.events.on("change",this._onChangeAbsolutePitch),this._absoluteYawView.events.on("change",this._onChangeAbsoluteYaw),this._absoluteRollView.events.on("change",this._onChangeAbsoluteRoll),this._scaleView.events.on("change",this._onChangeScale),this._scaleXView.events.on("change",this._onChangeScaleX),this._scaleYView.events.on("change",this._onChangeScaleY),this._scaleZView.events.on("change",this._onChangeScaleZ),this._groundBtn.appendTo(this.container),this._groundBtn.events.on("click",this._onGround),this}remove(){super.remove(),this._clearSceneEvents()}_initSceneEvents(){this.model.events.on("select",this._onSelect),this.model.events.on("unselect",this._onUnselect),this.model.events.on("position",this._onPosition),this.model.events.on("pitch",this._onPitch),this.model.events.on("yaw",this._onYaw),this.model.events.on("roll",this._onRoll)}_clearSceneEvents(){this.model.events.off("select",this._onSelect),this.model.events.off("unselect",this._onUnselect),this.model.events.off("position",this._onPosition),this.model.events.off("pitch",this._onPitch),this.model.events.off("yaw",this._onYaw),this.model.events.off("roll",this._onRoll)}_refresh(e){e.parent?this._relativePositionView.disabled=!1:this._relativePositionView.disabled=!0,this._relativePositionView.checked=e.relativePosition;let t=e.getLonLat();this._lonView.stopPropagation(),this._latView.stopPropagation(),this._heightView.stopPropagation(),this._lonView.value=t.lon,this._latView.value=t.lat,this._heightView.value=t.height;let s=e.getCartesian();this._xView.stopPropagation(),this._yView.stopPropagation(),this._zView.stopPropagation(),this._xView.value=s.x,this._yView.value=s.y,this._zView.value=s.z,s=e.getAbsoluteCartesian(),this._absXView.stopPropagation(),this._absYView.stopPropagation(),this._absZView.stopPropagation(),this._absXView.value=s.x,this._absYView.value=s.y,this._absZView.value=s.z,this._pitchView.stopPropagation(),this._yawView.stopPropagation(),this._rollView.stopPropagation(),this._pitchView.value=e.getPitch()*Q,this._yawView.value=e.getYaw()*Q,this._rollView.value=e.getRoll()*Q,this._absolutePitchView.stopPropagation(),this._absoluteYawView.stopPropagation(),this._absoluteRollView.stopPropagation(),this._absolutePitchView.value=e.getAbsolutePitch()*Q,this._absoluteYawView.value=e.getAbsoluteYaw()*Q,this._absoluteRollView.value=e.getAbsoluteRoll()*Q,this._scaleView.stopPropagation();let n=e.getScale();n.x===n.y&&n.y===n.z?this._scaleView.value=n.x:this._scaleView.value=1,this._scaleXView.stopPropagation(),this._scaleYView.stopPropagation(),this._scaleZView.stopPropagation(),this._scaleXView.value=n.x,this._scaleYView.value=n.y,this._scaleZView.value=n.z}hide(){super.hide(),this.model.events.stopPropagation(),this.model.unselect()}}const yh=["lockview","unlockview"];class Zn extends Z{constructor(e={}){super(e),this._onLockViewDraw=()=>{this.renderer&&this._lockEntity&&(this._isFromTheBack||this.renderer.activeCamera.viewDistance(this._lockEntity.getAbsoluteCartesian(),this._lockDistance))},this._onMouseWheel=t=>{if(this.renderer&&this._lockEntity&&!this._isFromTheBack){let s=this.renderer.activeCamera.eye.distance(this._lockEntity.getAbsoluteCartesian());this._lockDistance-=.33*s*Math.sign(t.wheelDelta),this._lockDistance<.001&&(this._lockDistance=.001),this.renderer.activeCamera.viewDistance(this._lockEntity.getAbsoluteCartesian(),this._lockDistance)}},this._onMouseMove=t=>{if(this._lockEntity&&this.renderer&&(t.rightButtonDown||this.renderer.events.isKeyPressed(Y.KEY_ALT))){let s=this._lockEntity.getAbsoluteCartesian(),n=this.renderer.activeCamera,o=.5/U;o>.007&&(o=.007),this.planet?n.rotateHorizontal(o*(t.x-t.prev_x),!1,s,s.isZero()?m.UP:s.normal()):n.rotateHorizontal(o*(t.x-t.prev_x),!1,s,m.UP),n.rotateVertical(o*(t.y-t.prev_y),s),this._viewDir=s.sub(n.eye).normalize()}},this.events=ot(yh),this._name="CameraLock",this.planet=e.planet||null,this._lockDistance=0,this._isFromTheBack=!1,this._lockEntity=null,this._viewDir=new m(0,0,0)}onactivate(){this.renderer}ondeactivate(){this.renderer&&this.unlockView()}oninit(){this.activate(),this.renderer}flyCartesian(e,t=120){if(!e.isZero()&&this.renderer)if(this.unlockView(),this.planet){let s=this.planet.camera;this.isVisibleDistance(e)&&s.flyDistance(e,t),s.eye.distance(e)<1e6?s.flyDistance(e,t):s.viewDistance(e,t)}else this.renderer.activeCamera.viewDistance(e,t)}lockView(e,t=!1){if(!this.renderer)return;this._lockDistance=this._getDistance(e,this._lockEntity),this._isFromTheBack=t,this._deactivateLockViewEvents(),this._lockEntity=e;let s=this.renderer.activeCamera;this.planet&&this.planet.camera.stopFlying(),s.viewDistance(e.getAbsoluteCartesian(),this._lockDistance),this._deactivateNav(),this._activateLockViewEvents(),this._viewDir=e.getAbsoluteCartesian().sub(s.eye).normalize(),this.events.dispatch(this.events.lockview,this._lockEntity,t)}_activateNav(){this.renderer&&this.renderer.controls.mouseNavigation&&this.renderer.controls.mouseNavigation.activate(),this.renderer&&this.renderer.controls.simpleNavigation&&this.renderer.controls.simpleNavigation.activate()}_deactivateNav(){this.renderer&&this.renderer.controls.mouseNavigation&&(this.renderer.controls.mouseNavigation.deactivate(),this.renderer.controls.mouseNavigation.stop()),this.renderer&&this.renderer.controls.simpleNavigation&&this.renderer.controls.simpleNavigation.deactivate()}unlockView(){this._lockEntity&&(this._deactivateLockViewEvents(),this._activateNav(),this.events.dispatch(this.events.unlockview,this._lockEntity),this._lockEntity=null)}_getCenterDist(){return this.renderer&&this.renderer.getDistanceFromPixel(this.renderer.handler.getCenter())||0}_getDistance(e,t){if(this.renderer){let s=e.getAbsoluteCartesian(),n=this.renderer.activeCamera,o=n.eye.distance(s);return t&&(o=n.eye.distance(t.getAbsoluteCartesian())),this.isVisibleDistance(s)?o:n.eye.distance(s)<1e6?this._getCenterDist():120}return 0}isVisibleDistance(e,t=0){if(this.planet){let s=this.planet.ellipsoid.equatorialSize,n=this.planet.camera.eye;return n.distance(e)<Math.sqrt(n.length2()-s*s)+t}return!0}get lockEntity(){return this._lockEntity}flyLonLat(e,t=120){if(this.planet){let s=this.planet.ellipsoid.lonLatToCartesian(e);this.flyCartesian(s,t)}}_activateLockViewEvents(){this.renderer&&(this.renderer.events.on("mousewheel",this._onMouseWheel),this.renderer.events.on("mousemove",this._onMouseMove),this.renderer.events.on("draw",this._onLockViewDraw))}_deactivateLockViewEvents(){this.renderer&&(this.renderer.events.off("mousewheel",this._onMouseWheel),this.renderer.events.off("mousemove",this._onMouseMove),this._lockEntity&&this.renderer.events.off("draw",this._onLockViewDraw))}}const xh=["click"];class bh extends dt{constructor(e){super({template:zt(`<button class="og-object3d-collection__item">
        <div class="og-object3d-collection__item_name">{name}</div>
    </button>`,{name:e.model.name}),...e}),this.events=ot(xh)}render(e){var t;return super.render(e),(t=this.el)==null||t.addEventListener("click",s=>{this.events.dispatch(this.events.click,this.model,this,s)}),this}}const wh=["select"];class Th extends dt{constructor(e){super({template:'<div class="og-object3d-collection"></div>',model:e.model,...e}),this._onAdd=t=>{this._addItem(t)},this.events=ot(wh),this._activeView=null}_addItem(e){let t=new bh({model:e});t.appendTo(this.el),t.events.on("click",s=>{var n,o;this._activeView&&((n=this._activeView.el)==null||n.classList.remove("active")),this._activeView=t,(o=this._activeView.el)==null||o.classList.add("active"),this.events.dispatch(this.events.select,s,t)})}render(e){super.render(e);let t=this.model.getItems();for(let s of t)this._addItem(s);return this._initEvents(),this}_initEvents(){this.model.events.on("add",this._onAdd)}}const Ch=["select"];class Eh extends Zt{constructor(e){super({classList:["og-object3d-manager"],title:"Object3D Collection",visible:!1,resizable:!0,useHide:!0,top:25,right:85,width:252,height:480,minHeight:100,minWidth:100}),this._onLoadClick=()=>{let t=new dt({initRender:!0,template:'<input type="file" accept=".obj,.mtl" multiple />'});t.el&&(t.el.addEventListener("change",s=>{const n=s.target;if(n.files){const o=Array.from(n.files),a=o.find(c=>c.name.toLowerCase().endsWith(".obj")),h=o.find(c=>c.name.toLowerCase().endsWith(".mtl"));a&&async function(c,d){return await W.readFileObj(c,d).then(u=>({name:c.name,objects:d?u:[W.merge(u)]}))}(a,h).then(this._addObject)}}),t.el.click())},this._addObject=t=>{this._object3dCollectionView.model.addItem(t)},this.events=ot(Ch),this._object3dCollectionView=new Th({model:e.model})}render(e){var t;super.render(e);let s=document.createElement("div");s.classList.add("og-editor_toolbar"),(t=this.container)==null||t.appendChild(s);let n=new he({classList:["og-editor_toolbar-button"],icon:'<svg class="svg-icon" style="vertical-align: middle;fill: currentColor;overflow: hidden;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"><path d="M426.666667 170.666667H170.666667c-47.146667 0-84.906667 38.186667-84.906667 85.333333L85.333333 768c0 47.146667 38.186667 85.333333 85.333334 85.333333h682.666666c47.146667 0 85.333333-38.186667 85.333334-85.333333V341.333333c0-47.146667-38.186667-85.333333-85.333334-85.333333H512l-85.333333-85.333333z"  /></svg>',title:"Load 3D object"});return n.appendTo(s),n.events.on("click",this._onLoadClick),this._object3dCollectionView.appendTo(this.container),this._object3dCollectionView.events.on("select",o=>{this.events.dispatch(this.events.select,o)}),this}}const Ah=["add","remove"];class nn{constructor(e={}){this.events=ot(Ah,this),this._items=nn.createItemsMap(e.collection||[])}static createItemsMap(e){let t=new Map;for(let s=0;s<e.length;s++)t.set(e[s].name,e[s]);return t}getItem(e){return this._items.get(e)}addItem(e,t=!1){this._items.has(e.name)&&!t||(this._items.set(e.name,e),this.events.dispatch(this.events.add,e))}getItems(){return Array.from(this._items,([e,t])=>t)}}class Ir extends Z{constructor(e={}){super({name:"CameraFrameComposer",autoActivate:!0,...e}),this._onPostdraw=()=>{for(let t=0,s=this._frameHandlers.length;t<s;t++)this._frameHandlers[t].frame()},this._cameraLayer=new ee({scaleByDistance:[100,1e6,1],pickingEnabled:!1}),this._cameraScene=new ce("CameraScene"),this._frameHandlers=e.frameHandlers||[]}get frameHandlers(){return[...this._frameHandlers]}add(e){e.addTo(this),this._cameraLayer.add(e.cameraEntity)}oninit(){super.oninit(),this._cameraLayer.addTo(this._cameraScene)}activate(){super.activate(),this.renderer&&(this.renderer.events.on("postdraw",this._onPostdraw),this.renderer.addNode(this._cameraScene))}deactivate(){super.deactivate(),this.renderer&&(this.renderer.events.off("postdraw",this._onPostdraw),this.renderer.removeNode(this._cameraScene))}}let Lh=W.createFrustum();class Kn{constructor(e){this.camera=e.camera,this.frameBuffer=e.frameBuffer,this.frameHandler=e.frameHandler||null,this._composer=null,this._composerIndex=-1,this.showFrustum=e.showFrustum==null||e.showFrustum,this.cameraEntity=new V({visibility:!0,scale:this.frustumScale,geoObject:{tag:"frustum",color:"rgba(0,255,0,0.20)",object3d:Lh}}),this.frameBuffer.init()}get frustumScale(){return W.getFrustumScaleByCameraAspectRatio(1e3,this.camera.getViewAngle(),this.camera.getAspectRatio())}addTo(e){this._composer||(this._composer=e,this._composerIndex=e.frameHandlers.length,this._composer._frameHandlers.push(this))}remove(){this._composer&&(this._composer._frameHandlers.splice(this._composerIndex,1),this._composer=null,this._composerIndex=-1)}frame(){if(this.frameHandler&&this.frameBuffer.handler.gl&&(this.frameHandler(this),this.showFrustum)){let e=this.camera,t=W.getFrustumScaleByCameraAngles(100,e.horizontalViewAngle,e.verticalViewAngle);this.cameraEntity.setScale3v(t),this.cameraEntity.setCartesian3v(e.eye),this.cameraEntity.setAbsolutePitch(e.getAbsolutePitch()),this.cameraEntity.setAbsoluteYaw(e.getAbsoluteYaw()),this.cameraEntity.setAbsoluteRoll(e.getAbsoluteRoll())}}}function Fe(l){let e=1/Math.sqrt(l[0]*l[0]+l[1]*l[1]+l[2]*l[2]);l[0]*=e,l[1]*=e,l[2]*=e,l[3]*=e}class Qn{constructor(e={}){this._pickingColorU=new Float32Array([0,0,0]),this._f=[[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0]],this.projectionMatrix=new st,this.inverseProjectionMatrix=new st,this.projectionViewMatrix=new st,this.projectionViewRTEMatrix=new st,this.inverseProjectionViewMatrix=new st,this.left=0,this.right=0,this.bottom=0,this.top=0,this.near=0,this.far=0,this.cameraFrustumIndex=e.cameraFrustumIndex!=null?e.cameraFrustumIndex:-1,this.setProjectionMatrix(e.fov||30,e.aspect||1,e.near||1,e.far||1e3)}getRightPlane(){return this._f[0]}getLeftPlane(){return this._f[1]}getBottomPlane(){return this._f[2]}getTopPlane(){return this._f[3]}getBackwardPlane(){return this._f[4]}getForwardPlane(){return this._f[5]}getProjectionViewMatrix(){return this.projectionViewMatrix._m}getProjectionViewRTEMatrix(){return this.projectionViewRTEMatrix._m}getProjectionMatrix(){return this.projectionMatrix._m}getInverseProjectionMatrix(){return this.inverseProjectionMatrix._m}setProjectionMatrix(e,t,s,n,o,a=10){if(o){let h=a*Math.tan(e*ie),c=h*t;this._setFrustumParams(h,c,s,n),this.projectionMatrix.setOrthographic(this.left,this.right,this.bottom,this.top,this.near,this.far)}else{let h=s*Math.tan(e*ie),c=h*t;this._setFrustumParams(h,c,s,n),this.projectionMatrix.setPerspective(this.left,this.right,this.bottom,this.top,this.near,this.far)}this.projectionMatrix.inverseTo(this.inverseProjectionMatrix)}_setFrustumParams(e,t,s,n){this.top=e,this.right=t,this.bottom=-this.top,this.left=-this.right,this.near=s,this.far=n}setProjectionViewRTEMatrix(e){this.projectionViewRTEMatrix=this.projectionMatrix.mul(e)}setViewMatrix(e){this.projectionViewMatrix=this.projectionMatrix.mul(e),this.projectionViewMatrix.inverseTo(this.inverseProjectionViewMatrix);let t=this.projectionViewMatrix._m;this._f[0][0]=t[3]-t[0],this._f[0][1]=t[7]-t[4],this._f[0][2]=t[11]-t[8],this._f[0][3]=t[15]-t[12],Fe(this._f[0]),this._f[1][0]=t[3]+t[0],this._f[1][1]=t[7]+t[4],this._f[1][2]=t[11]+t[8],this._f[1][3]=t[15]+t[12],Fe(this._f[1]),this._f[2][0]=t[3]+t[1],this._f[2][1]=t[7]+t[5],this._f[2][2]=t[11]+t[9],this._f[2][3]=t[15]+t[13],Fe(this._f[2]),this._f[3][0]=t[3]-t[1],this._f[3][1]=t[7]-t[5],this._f[3][2]=t[11]-t[9],this._f[3][3]=t[15]-t[13],Fe(this._f[3]),this._f[4][0]=t[3]-t[2],this._f[4][1]=t[7]-t[6],this._f[4][2]=t[11]-t[10],this._f[4][3]=t[15]-t[14],Fe(this._f[4]),this._f[5][0]=t[3]+t[2],this._f[5][1]=t[7]+t[6],this._f[5][2]=t[11]+t[10],this._f[5][3]=t[15]+t[14],Fe(this._f[5])}containsPoint(e){for(let t=0;t<6;t++)if(e.dotArr(this._f[t])+this._f[t][3]<=0)return!1;return!0}containsSphereBottomExc(e){let t=-e.radius,s=this._f;return!(e.center.dotArr(s[0])+s[0][3]<=t||e.center.dotArr(s[1])+s[1][3]<=t||e.center.dotArr(s[3])+s[3][3]<=t||e.center.dotArr(s[4])+s[4][3]<=t||e.center.dotArr(s[5])+s[5][3]<=t)}containsSphereButtom(e){let t=-e.radius,s=this._f;return!(e.center.dotArr(s[2])+s[2][3]<=t)}containsSphere(e){let t=-e.radius,s=this._f;return!(e.center.dotArr(s[0])+s[0][3]<=t||e.center.dotArr(s[1])+s[1][3]<=t||e.center.dotArr(s[2])+s[2][3]<=t||e.center.dotArr(s[3])+s[3][3]<=t||e.center.dotArr(s[4])+s[4][3]<=t||e.center.dotArr(s[5])+s[5][3]<=t)}containsSphere2(e,t){let s=-t;return!(e.dotArr(this._f[0])+this._f[0][3]<=s||e.dotArr(this._f[1])+this._f[1][3]<=s||e.dotArr(this._f[2])+this._f[2][3]<=s||e.dotArr(this._f[3])+this._f[3][3]<=s||e.dotArr(this._f[4])+this._f[4][3]<=s||e.dotArr(this._f[5])+this._f[5][3]<=s)}containsBox(e){let t,s,n=!0;for(let o=0;o<6;o++){t=0,s=0;for(let a=0;a<8&&(s===0||t===0);a++)e.vertices[a].dotArr(this._f[o])+this._f[o][3]<0?t++:s++;if(s===0)return!1;t>0&&(n=!0)}return n}}const X=class{};X.Linear=l=>l,X.QuadIn=l=>l*l,X.QuadOut=l=>1-(1-l)*(1-l),X.QuadInOut=l=>l<.5?2*l*l:1-Math.pow(-2*l+2,2)/2,X.CubicIn=l=>l*l*l,X.CubicOut=l=>1-Math.pow(1-l,3),X.CubicInOut=l=>l<.5?4*l*l*l:1-Math.pow(-2*l+2,3)/2,X.QuartIn=l=>l*l*l*l,X.QuartOut=l=>1-Math.pow(1-l,4),X.QuartInOut=l=>l<.5?8*l*l*l*l:1-Math.pow(-2*l+2,4)/2,X.QuintIn=l=>l*l*l*l*l,X.QuintOut=l=>1-Math.pow(1-l,5),X.QuintInOut=l=>l<.5?16*l*l*l*l*l:1-Math.pow(-2*l+2,5)/2,X.SineIn=l=>1-Math.cos(l*Math.PI/2),X.SineOut=l=>Math.sin(l*Math.PI/2),X.SineInOut=l=>-(Math.cos(Math.PI*l)-1)/2,X.ExpoIn=l=>l===0?0:Math.pow(2,10*l-10),X.ExpoOut=l=>l===1?1:1-Math.pow(2,-10*l),X.ExpoInOut=l=>l===0?0:l===1?1:l<.5?Math.pow(2,20*l-10)/2:(2-Math.pow(2,-20*l+10))/2,X.CircIn=l=>1-Math.sqrt(1-Math.pow(l,2)),X.CircOut=l=>Math.sqrt(1-Math.pow(l-1,2)),X.CircInOut=l=>l<.5?(1-Math.sqrt(1-Math.pow(2*l,2)))/2:(Math.sqrt(1-Math.pow(-2*l+2,2))+1)/2,X.BackIn=l=>2.70158*l*l*l-1.70158*l*l,X.BackOut=l=>1+2.70158*Math.pow(l-1,3)+1.70158*Math.pow(l-1,2),X.BackInOut=l=>{const e=2.5949095;return l<.5?Math.pow(2*l,2)*(7.189819*l-e)/2:(Math.pow(2*l-2,2)*((e+1)*(2*l-2)+e)+2)/2},X.ElasticIn=l=>{const e=2*Math.PI/3;return l===0?0:l===1?1:-Math.pow(2,10*l-10)*Math.sin((10*l-10.75)*e)},X.ElasticOut=l=>{const e=2*Math.PI/3;return l===0?0:l===1?1:Math.pow(2,-10*l)*Math.sin((10*l-.75)*e)+1},X.ElasticInOut=l=>{const e=2*Math.PI/4.5;return l===0?0:l===1?1:l<.5?-Math.pow(2,20*l-10)*Math.sin((20*l-11.125)*e)/2:Math.pow(2,-20*l+10)*Math.sin((20*l-11.125)*e)/2+1},X.BounceOut=l=>l<1/2.75?7.5625*l*l:l<2/2.75?7.5625*(l-=1.5/2.75)*l+.75:l<2.5/2.75?7.5625*(l-=2.25/2.75)*l+.9375:7.5625*(l-=2.625/2.75)*l+.984375,X.BounceIn=l=>1-X.BounceOut(1-l),X.BounceInOut=l=>l<.5?.5*(1-X.BounceOut(1-2*l)):.5*(X.BounceOut(2*l-1)+1);let zr=X;const Ph=["viewchange","moveend","flystart","flyend","flystop"],ya=zr.CubicInOut,Ls=class Yc{constructor(e={}){if(this.__id=Yc.__counter__++,this.events=ot(Ph,this),this._isOrthographic=e.isOrthographic??!1,this._focusDistance=e.focusDistance!=null?e.focusDistance:10,this._width=e.width||1,this._height=e.height||1,this.eye=e.eye||new m,this.eyeHigh=new Float32Array(3),this.eyeLow=new Float32Array(3),this._viewAngle=e.viewAngle||47,this._horizontalViewAngle=0,this._viewMatrix=new st,this._viewMatrixRTE=new st,this._normalMatrix=new Pe,this._r=new m(1,0,0),this._u=new m(0,1,0),this._b=new m(0,0,1),this._f=this._b.negateTo(),this._pr=this._r.clone(),this._pu=this._u.clone(),this._pb=this._b.clone(),this._peye=this.eye.clone(),this.isMoving=!1,this._flight=null,this._completeCallback=null,this._frameCallback=null,this._flying=!1,this._tanViewAngle_hrad=0,this._tanViewAngle_hradOneByHeight=0,this.frustums=[],this.frustumColors=[],e.frustums)for(let t=0,s=e.frustums.length;t<s;t++){let n=e.frustums[t],o=new Qn({fov:this._viewAngle,aspect:this.getAspectRatio(),near:n[0],far:n[1]});o.cameraFrustumIndex=this.frustums.length,this.frustums.push(o),this.frustumColors.push(o._pickingColorU[0],o._pickingColorU[1],o._pickingColorU[2])}else{let t=1,s=500,n=new Qn({fov:this._viewAngle,aspect:this.getAspectRatio(),near:t,far:s});n.cameraFrustumIndex=this.frustums.length,this.frustums.push(n),this.frustumColors.push(n._pickingColorU[0],n._pickingColorU[1],n._pickingColorU[2])}this.FARTHEST_FRUSTUM_INDEX=this.frustums.length-1,this.currentFrustumIndex=0,this.frustumColorIndex=0,this.isFirstPass=!1,this._projSizeConst=0,this.set(e.eye||new m(0,0,1),e.look||new m,e.up||new m(0,1,0))}get isOrthographic(){return this._isOrthographic}set isOrthographic(e){this._isOrthographic!==e&&(this._isOrthographic=e,this.refresh())}get focusDistance(){return this._focusDistance}set focusDistance(e){e!==this._focusDistance&&(this._focusDistance=e,this._isOrthographic&&this.refresh())}get id(){return this.__id}flyCartesian(e,t={}){this.stopFlying(),t.look=t.look||m.ZERO,t.up=t.up||m.UP,t.duration=t.duration||800;const s=t.ease||ya;this._completeCallback=t.completeCallback||(()=>{}),this._frameCallback=t.frameCallback||(()=>{}),t.startCallback&&t.startCallback.call(this);let n=this.eye.clone(),o=this._u,a=this._b,h=t.up,c=e.clone(),d=m.sub(e,t.look),u=h.cross(d);d.normalize(),u.normalize();let _=d.cross(u);this._flight={fly:f=>{let v=1-s(f),g=n.smerp(c,v),y=o.smerp(_,v),p=m.add(g,a.smerp(d,v).negateTo()),x=new m(g.x-p.x,g.y-p.y,g.z-p.z),T=y.cross(x);x.normalize(),T.normalize();let w=x.cross(T);return{eye:g,n:x,u:T,v:w}},duration:t.duration,startedAt:Date.now()},this._flying=!0,this.events.dispatch(this.events.flystart,this)}stopFlying(){this._flying&&(this._flying=!1,this._flight=null,this._frameCallback=null,this.events.dispatch(this.events.flystop,this))}checkFly(){if(this._flying&&this._flight!==null){let e=Math.min((Date.now()-this._flight.startedAt)/this._flight.duration,1);const t=this._flight.fly(e);this.eye=t.eye,this._r=t.u,this._u=t.v,this._b=t.n,this._f.set(-this._b.x,-this._b.y,-this._b.z),this._frameCallback&&this._frameCallback(),this.update(),e>=1&&(this.stopFlying(),this._completeCallback&&(this.events.dispatch(this.events.flyend,this),this._completeCallback(),this._completeCallback=null))}}isFlying(){return this._flying}checkMoveEnd(){let e=this._r,t=this._u,s=this._b,n=this.eye;this._peye.equal(n)&&this._pr.equal(e)&&this._pu.equal(t)&&this._pb.equal(s)?(this.isMoving&&this.events.dispatch(this.events.moveend,this),this.isMoving=!1):this.isMoving=!0,this._pr.copy(e),this._pu.copy(t),this._pb.copy(s),this._peye.copy(n)}bindFrustumsPickingColors(e){for(let t=0;t<this.frustums.length;t++)e.assignPickingColor(this.frustums[t])}_init(e){this._setProj(this._viewAngle,this.getAspectRatio()),this.set(e.eye||new m(0,0,1),e.look||new m,e.up||new m(0,1,0))}getUp(){return this._u.clone()}getDown(){return this._u.negateTo()}getRight(){return this._r.clone()}getLeft(){return this._r.negateTo()}getForward(){return this._f.clone()}getBackward(){return this._b.clone()}update(){let e=this._r,t=this._u,s=this._b,n=this.eye;m.doubleToTwoFloat32Array(n,this.eyeHigh,this.eyeLow),this._viewMatrix.set([e.x,t.x,s.x,0,e.y,t.y,s.y,0,e.z,t.z,s.z,0,-n.dot(e),-n.dot(t),-n.dot(s),1]),this._viewMatrixRTE.set([e.x,t.x,s.x,0,e.y,t.y,s.y,0,e.z,t.z,s.z,0,0,0,0,1]);for(let o=0,a=this.frustums.length;o<a;o++)this.frustums[o].setViewMatrix(this._viewMatrix),this.frustums[o].setProjectionViewRTEMatrix(this._viewMatrixRTE);this.events.dispatch(this.events.viewchange,this)}refresh(){this._setProj(this._viewAngle,this.getAspectRatio()),this.update()}get width(){return this._width}get height(){return this._height}setViewportSize(e,t){this._width=e,this._height=t,this.refresh()}getAspectRatio(){return this._width/this._height}_setProj(e,t){this._viewAngle=e;for(let o=0,a=this.frustums.length;o<a;o++){let h=this.frustums[o];h.setProjectionMatrix(e,t,h.near,h.far,this._isOrthographic,this._focusDistance)}var s,n;this._horizontalViewAngle=(s=e,n=t,Hr*Math.atan(Math.tan(ie*s)*n)),this._updateViewportParameters()}_updateViewportParameters(){this._tanViewAngle_hrad=Math.tan(this._viewAngle*ie),this._tanViewAngle_hradOneByHeight=this._tanViewAngle_hrad*(1/this._height),this._projSizeConst=Math.min(this._width<512?512:this._width,this._height<512?512:this._height)/(this._viewAngle*U)}setViewAngle(e){this._viewAngle=e,this.refresh()}getViewAngle(){return this._viewAngle}get viewAngle(){return this._viewAngle}get verticalViewAngle(){return this._viewAngle}get horizontalViewAngle(){return this._horizontalViewAngle}set(e,t,s){return this.eye.x=e.x,this.eye.y=e.y,this.eye.z=e.z,t=t||this._b,s=s||this._u,this._b.x=e.x-t.x,this._b.y=e.y-t.y,this._b.z=e.z-t.z,this._r.copy(s.cross(this._b)),this._b.normalize(),this._r.normalize(),this._u.copy(this._b.cross(this._r)),this._f.set(-this._b.x,-this._b.y,-this._b.z),this}look(e,t){this._b.set(this.eye.x-e.x,this.eye.y-e.y,this.eye.z-e.z),this._r.copy((t||this._u).cross(this._b)),this._b.normalize(),this._f.set(-this._b.x,-this._b.y,-this._b.z),this._r.normalize(),this._u.copy(this._b.cross(this._r))}slide(e,t,s){this.eye.x+=e*this._r.x+t*this._u.x+s*this._b.x,this.eye.y+=e*this._r.y+t*this._u.y+s*this._b.y,this.eye.z+=e*this._r.z+t*this._u.z+s*this._b.z}setRoll(e){let t=Math.cos(e),s=Math.sin(e),n=this._r.clone();this._r.set(t*n.x-s*this._u.x,t*n.y-s*this._u.y,t*n.z-s*this._u.z),this._u.set(s*n.x+t*this._u.x,s*n.y+t*this._u.y,s*n.z+t*this._u.z)}setPitch(e){let t=Math.cos(e),s=Math.sin(e),n=this._b;this._b.set(t*n.x-s*this._u.x,t*n.y-s*this._u.y,t*n.z-s*this._u.z),this._u.set(s*n.x+t*this._u.x,s*n.y+t*this._u.y,s*n.z+t*this._u.z)}setYaw(e){let t=Math.cos(e),s=Math.sin(e),n=this._r;this._r.set(t*n.x-s*this._b.x,t*n.y-s*this._b.y,t*n.z-s*this._b.z),this._b.set(s*n.x+t*this._b.x,s*n.y+t*this._b.y,s*n.z+t*this._b.z)}setPitchYawRoll(e,t,s){let n=new D;n.setPitchYawRoll(e,t,s),this.setRotation(n)}getPitch(){return this.getRotation().getPitch()}getYaw(){return this.getRotation().getYaw()}getRoll(){return this.getRotation().getRoll()}getAbsolutePitch(){return this.getRotation().getPitch()}getAbsoluteYaw(){return this.getRotation().getYaw()}getAbsoluteRoll(){return this.getRotation().getRoll()}getRotation(){return D.getLookRotation(this._f,this._u).conjugate()}setRotation(e,t,s,n){e.mulVec3Res(t||new m(0,1,0),this._u),e.mulVec3Res(s||new m(1,0,0),this._r),e.mulVec3Res(n||new m(0,0,1),this._b),this._f.set(-this._b.x,-this._b.y,-this._b.z)}rotate(e){e.mulVec3Res(this._u,this._u),e.mulVec3Res(this._r,this._r),e.mulVec3Res(this._b,this._b),this._f.set(-this._b.x,-this._b.y,-this._b.z)}unproject2v(e,t,s){return this.unproject(e.x,e.y,t,s)}unproject(e,t,s,n){let o=.5*this._width,a=.5*this._height,h=(e-o)/o,c=-(t-a)/a,d=this.frustums[0];if(this.isOrthographic){if(s){let u=.5*(d.right-d.left)*h,_=.5*(d.top-d.bottom)*c,f=this.getUp().scale(_),v=this.getRight().scale(u),g=f.addA(v),y=this.eye.add(g),p=this.getForward(),x=y.addA(p.scaleTo(s));return n&&n.copy(x),x.sub(this.eye).normalize()}return this.getForward()}{let u=d.inverseProjectionViewMatrix,_=u.mulVec4(new J(h,c,-1,1)).affinity();return u.mulVec4(new J(h,c,0,1)).affinity().subA(_).toVec3().normalize()}}project3v(e){return this.project(e.x,e.y,e.z)}project(e,t,s){let n=this.frustums[0].projectionViewMatrix.mulVec4(new J(e,t,s,1));return new O((1+n.x/n.w)*this._width*.5,(1-n.y/n.w)*this._height*.5)}rotateAround(e,t=!1,s=m.ZERO,n=m.UP){n=t?this._u:n;let o=st.getRotation(e,n),a=st.getRotationAroundPoint(e,s,n);this.eye=a.mulVec3(this.eye),this._u=o.mulVec3(this._u).normalize(),this._r=o.mulVec3(this._r).normalize(),this._b=o.mulVec3(this._b).normalize(),this._f.set(-this._b.x,-this._b.y,-this._b.z)}rotateHorizontal(e,t,s,n){this.rotateAround(e,t,s,n)}rotateVertical(e,t){this.rotateAround(e,!1,t,this._r)}projectedSize(e,t){if(this.isOrthographic){const s=this.frustums[0].projectionMatrix._m;return t*(this._height*s[5]*.5)}return Math.atan(t/this.eye.distance(e))*this._projSizeConst}getViewMatrix(){return this._viewMatrix._m}getNormalMatrix(){return this._normalMatrix._m}setCurrentFrustum(e){this.currentFrustumIndex=e,this.frustumColorIndex=10*(e+1)/255,this.isFirstPass=e===this.FARTHEST_FRUSTUM_INDEX}getCurrentFrustum(){return this.currentFrustumIndex}containsSphere(e){for(let t=0;t<this.frustums.length;t++)if(this.frustums[t].containsSphere(e))return!0;return!1}get frustum(){return this.frustums[this.currentFrustumIndex]}getProjectionMatrix(){return this.frustum.projectionMatrix._m}getProjectionViewMatrix(){return this.frustum.projectionViewMatrix._m}getProjectionViewRTEMatrix(){return this.frustum.projectionViewRTEMatrix._m}getInverseProjectionViewMatrix(){return this.frustum.inverseProjectionViewMatrix._m}getInverseProjectionMatrix(){return this.frustum.inverseProjectionMatrix._m}viewDistance(e,t=1e4){let s=e.add(this.getBackward().scaleTo(t));this.set(s,e),this.update()}copy(e){this.eye.copy(e.eye),this._r.copy(e._r),this._u.copy(e._u),this._b.copy(e._b),this._f.copy(e._f),this._width=e.width,this._height=e.height,this.setViewAngle(e.viewAngle),this.update()}getAltitude(){return this.eye.y}};Ls.__counter__=0;let Li=Ls;class xa extends Li{constructor(e,t={}){super({...t,frustums:t.frustums||[[1,100.075],[100,1000.075],[1e3,101e4],[1e6,1e9]]}),this.planet=e,this.minAltitude=t.minAltitude||1,this.maxAltitude=t.maxAltitude||2e7,this._lonLat=this.planet.ellipsoid.cartesianToLonLat(this.eye),this._lonLatMerc=this._lonLat.forwardMercator(),this._terrainAltitude=this._lonLat.height,this._terrainPoint=new m,this._insideSegment=null,this.slope=0,this._keyLock=new Re,this._flight=null,this._completeCallback=null,this._frameCallback=null,this._flying=!1,this._checkTerrainCollision=!0,this.eyeNorm=this.eye.getNormal()}setTerrainCollisionActivity(e){this._checkTerrainCollision=e}update(){this.events.stopPropagation();let e=this.maxAltitude+this.planet.ellipsoid.getEquatorialSize();this.eye.length()>e&&this.eye.copy(this.eye.getNormal().scale(e)),super.update(),this.updateGeodeticPosition(),this.eyeNorm=this.eye.getNormal(),this.slope=this._b.dot(this.eyeNorm),this.events.dispatch(this.events.viewchange,this)}updateGeodeticPosition(){this.planet.ellipsoid.cartesianToLonLatRes(this.eye,this._lonLat),Math.abs(this._lonLat.lat)<=ht&&A.forwardMercatorRes(this._lonLat,this._lonLatMerc)}setAltitude(e){let t=this._terrainPoint,s=this.planet.ellipsoid.getSurfaceNormal3v(this.eye);this.eye.x=s.x*e+t.x,this.eye.y=s.y*e+t.y,this.eye.z=s.z*e+t.z,this._terrainAltitude=e}getAltitude(){return this._terrainAltitude}setLonLat(e,t,s){this.stopFlying(),this._lonLat.set(e.lon,e.lat,e.height||this._lonLat.height);let n=this.planet.ellipsoid,o=n.lonLatToCartesian(this._lonLat),a=t?n.lonLatToCartesian(t):m.ZERO;this.set(o,a,s||o.getNormal()),this.update()}getLonLat(){return this._lonLat}getHeight(){return this._lonLat.height}getExtentPosition(e,t){t=t||0;let s=e.getNorth(),n=e.getSouth(),o=e.getEast(),a=e.getWest();a>o&&(o+=360);let h=this.planet.ellipsoid,c=new A(o,s),d=h.lonLatToCartesian(c);c.lat=n;let u=h.lonLatToCartesian(c);c.lon=a;let _=h.lonLatToCartesian(c);c.lat=s;let f=h.lonLatToCartesian(c),v=m.sub(d,_).scale(.5).addA(_),g=v.length();g<1e-6&&(c.lon=.5*(o+a),c.lat=.5*(s+n),v=h.lonLatToCartesian(c)),f.subA(v),u.subA(v),d.subA(v),_.subA(v);let y=v.getNormal(),p=y.cross(m.NORTH).normalize(),x=p.cross(y).normalize(),T=Math.max(Math.abs(x.dot(f)),Math.abs(x.dot(u)),Math.abs(x.dot(d)),Math.abs(x.dot(_))),w=Math.max(Math.abs(p.dot(f)),Math.abs(p.dot(u)),Math.abs(p.dot(d)),Math.abs(p.dot(_))),C=Math.tan(this._viewAngle*U*.5),E=this.getAspectRatio()*C,L=Math.max(w/E,T/C);return v.normalize(),v.scale(g+L+t),v}viewExtent(e,t){this.stopFlying(),this.set(this.getExtentPosition(e,t),m.ZERO,m.NORTH),this.update()}flyExtent(e,t,s={}){s.look=m.ZERO,this.flyCartesian(this.getExtentPosition(e,t),s)}viewDistance(e,t=1e4){let s=this.eye.add(this.getForward().scaleTo(t)),n=D.getRotationBetweenVectors(s.getNormal(),e.getNormal());if(n.isZero()){let o=e.add(this.getBackward().scaleTo(t));this.set(o,e)}else{let o=e.add(n.mulVec3(this.getBackward()).scale(t)),a=n.mulVec3(this.getUp());this.set(o,e,a)}this.update()}flyLonLat(e,t={}){let s=new A(e.lon,e.lat,e.height||this._lonLat.height);this.flyCartesian(this.planet.ellipsoid.lonLatToCartesian(s),t)}flyDistance(e,t=1e4,s={}){let n=this.eye.add(this.getForward().scaleTo(t)),o=D.getRotationBetweenVectors(n.getNormal(),e.getNormal());if(o.isZero()){let a=e.add(this.getBackward().scaleTo(t));this.set(a,e)}else{let a=e.add(o.mulVec3(this.getBackward()).scale(t)),h=o.mulVec3(this.getUp());s.look=e,s.up=h,this.flyCartesian(a,s)}}flyCartesian(e,t={}){this.stopFlying(),t.preventLock||(this.planet.layerLock.lock(this._keyLock),this.planet.terrainLock.lock(this._keyLock),this.planet.normalMapCreator.lock(this._keyLock)),t.amplitude=t.amplitude!=null?t.amplitude:1,t.look=t.look||m.ZERO,t.up=t.up||m.NORTH,t.duration=t.duration||800;const s=t.ease||ya;this._completeCallback=t.completeCallback||(()=>{}),this._frameCallback=t.frameCallback||(()=>{}),t.startCallback&&t.startCallback.call(this),t.look instanceof A&&(t.look=this.planet.ellipsoid.lonLatToCartesian(t.look));let n=this.eye.clone(),o=this._u,a=this._b,h=this.planet.ellipsoid.cartesianToLonLat(e),c=t.up,d=this.planet.ellipsoid.lonLatToCartesian(new A(h.lon,h.lat,0)),u=m.sub(e,t.look),_=c.cross(u);u.normalize(),_.normalize();let f=u.cross(_),v=n.getNormal(),g=d.getNormal(),y=1-v.dot(g),p=t.amplitude*po*Math.sqrt(y>0?y:0),x=6639613,T=Math.max(this._lonLat.height,h.height);T>x&&(x=T);let w=T+2.5*p*(x-T),C=m.ZERO;this._flight={fly:E=>{let L,S=s(E),P=1-S;if(S>=1)L=e.clone();else{let I=n.smerp(e,P).normalize(),se=this.planet.getRayIntersectionEllipsoid(new N(C,I)),G=this._lonLat.height*P*P*P+3*w*P*P*S+3*w*P*S*S+h.height*S*S*S;L=se.addA(I.scale(G))}let R=o.smerp(f,P),M=m.add(L,a.smerp(u,P).negateTo()),B=new m(L.x-M.x,L.y-M.y,L.z-M.z),z=R.cross(B);B.normalize(),z.normalize();let ue=B.cross(z);return{eye:L,n:B,u:z,v:ue}},duration:t.duration,startedAt:Date.now()},this._flying=!0,this.events.dispatch(this.events.flystart,this)}stopFlying(){this._flying&&(this.planet.layerLock.free(this._keyLock),this.planet.terrainLock.free(this._keyLock),this.planet.normalMapCreator.free(this._keyLock),super.stopFlying())}rotateLeft(e,t){this.rotateHorizontal(e,t!==!0,m.ZERO),this.update()}rotateRight(e,t){this.rotateHorizontal(-e,t!==!0,m.ZERO),this.update()}rotateUp(e){this.rotateVertical(e,m.ZERO),this.update()}rotateDown(e){this.rotateVertical(-e,m.ZERO),this.update()}rotateVertical(e,t,s=0){let n=new st().setRotation(this._r,e),o=new st().setIdentity().translate(t),a=new st().setIdentity().translate(t.negateTo()),h=o.mul(n).mul(a).mulVec3(this.eye),c=n.mulVec3(this._u).normalize(),d=n.mulVec3(this._r).normalize(),u=n.mulVec3(this._b).normalize(),_=h.getNormal(),f=u.dot(_);if(!(c.dot(_)<=0))if(s){let v=f-this.slope;if(f<s&&v<0)return;(f>.1&&c.dot(_)>0||this.slope<=.1||this._u.dot(this.eye.getNormal())<=0)&&(this.eye=h,this._u=c,this._r=d,this._b=u,this._f.set(-u.x,-u.y,-u.z))}else this.eye=h,this._u=c,this._r=d,this._b=u,this._f.set(-u.x,-u.y,-u.z)}checkTerrainCollision(){if(this._terrainAltitude=this._lonLat.height,this._insideSegment&&this._insideSegment.planet)return this._terrainAltitude=this._insideSegment.getTerrainPoint(this.eye,this._insideSegment.getInsideLonLat(this),this._terrainPoint),this._terrainAltitude<this.minAltitude&&this._checkTerrainCollision&&this.setAltitude(this.minAltitude),this._terrainPoint}getSurfaceVisibleDistance(e){let t=this.planet.ellipsoid.equatorialSize;return t*Math.acos(t/(t+this._lonLat.height+e))}getHeading(){let e=this.eye.getNormal(),t=m.proj_b_to_plane(this.slope>=.97?this.getUp():this.getForward(),e).normalize(),s=m.proj_b_to_plane(m.NORTH,e).normalize(),n=Math.sign(e.dot(t.cross(s)))*Math.acos(t.dot(s))*Q;return n<0?360+n:n}isVisible(e){let t=this.eye.length();return this.eye.distance(e)<Math.sqrt(t*t-this.planet.ellipsoid.equatorialSizeSqr)}getPitch(){return this.planet.getFrameRotation(this.eye).conjugate().inverse().mul(this.getRotation()).getPitch()}getYaw(){return this.planet.getFrameRotation(this.eye).conjugate().inverse().mul(this.getRotation()).getYaw()}getRoll(){return this.planet.getFrameRotation(this.eye).conjugate().inverse().mul(this.getRotation()).getRoll()}setPitch(e){let t=this.planet.getFrameRotation(this.eye),s=new D;s.setPitchYawRoll(e,this.getYaw(),this.getRoll(),t),this.setRotation(s)}setYaw(e){let t=this.planet.getFrameRotation(this.eye),s=new D;s.setPitchYawRoll(this.getPitch(),e,this.getRoll(),t),this.setRotation(s)}setRoll(e){let t=this.planet.getFrameRotation(this.eye),s=new D;s.setPitchYawRoll(this.getPitch(),this.getYaw(),e,t),this.setRotation(s)}setPitchYawRoll(e,t,s){let n=this.planet.getFrameRotation(this.eye),o=new D;o.setPitchYawRoll(e,t,s,n).conjugate(),this.setRotation(o)}}const Ps=class $c{constructor(e,t={}){this.handler=e,this.__id=$c.__counter__++,this._fbo=null,this._width=t.width||e.canvas.width,this._height=t.height||e.canvas.height,this._depthComponent=t.depthComponent!=null?t.depthComponent:"DEPTH_COMPONENT16",this._useDepth=t.useDepth==null||t.useDepth,this._active=!1,this._size=t.size||1,this._depthRenderbuffer=null,this._filter=t.filter||"NEAREST"}get width(){return this._width}get height(){return this._height}setSize(e,t,s=!1){this._width=e,this._height=t,this._active&&this.handler.gl.viewport(0,0,this._width,this._height),(this._useDepth||s)&&(this.destroy(),this.init())}init(){}destroy(){}isComplete(){let e=this.handler.gl;return e.checkFramebufferStatus(e.FRAMEBUFFER)===e.FRAMEBUFFER_COMPLETE}checkStatus(){let e=this.handler.gl;return e.checkFramebufferStatus(e.FRAMEBUFFER)}activate(){let e=this.handler.gl;e.bindFramebuffer(e.FRAMEBUFFER,null),e.bindFramebuffer(e.FRAMEBUFFER,this._fbo),e.viewport(0,0,this._width,this._height),this._active=!0;let t=this.handler.framebufferStack.current().data;return t&&(t._active=!1),this.handler.framebufferStack.push(this),this}deactivate(){let e=this.handler,t=e.gl;t.bindFramebuffer(t.FRAMEBUFFER,null),this._active=!1;let s=this.handler.framebufferStack.popPrev();s?(t.bindFramebuffer(t.FRAMEBUFFER,s._fbo),t.viewport(0,0,s._width,s._height)):t.viewport(0,0,e.canvas.width,e.canvas.height)}isEqual(e){return!!e&&this.__id===e.__id}};Ps.__counter__=0;let as=Ps;class gi{constructor(e=256,t=256){this._canvas=document.createElement("canvas"),this._canvas.width=e,this._canvas.height=t,this._context=this._canvas.getContext("2d",{willReadFrequently:!0})}getCanvas(){return this._canvas}getContext(){return this._context}fillEmpty(){let e=this._context.getImageData(0,0,this._canvas.width,this._canvas.height),t=e.data;for(let s=0,n=t.length;s<n;s+=4)t[s]=t[s+1]=t[s+2]=t[s+3]=0;this._context.putImageData(e,0,0)}fill(e){this._context.fillStyle=e,this._context.fill()}getData(){return this._context.getImageData(0,0,this._canvas.width,this._canvas.height).data}fillColor(e){this._context.fillStyle=e,this._context.fillRect(0,0,this._canvas.width,this._canvas.height)}setData(e){let t=this._context.createImageData(this._canvas.width,this._canvas.height);t.data.set(e),this._context.putImageData(t,0,0)}resize(e,t){this._canvas.width=e,this._canvas.height=t,this._context=this._canvas.getContext("2d")}drawImage(e,t,s,n,o){this._context.drawImage(e,t||0,s||0,n||e.width,o||e.height)}getImage(){let e=new Image;return e.width=this.getWidth(),e.height=this.getHeight(),e.src=this._canvas.toDataURL("image/png"),e}getTextWidth(e){let t=this._context.measureText(e);return Math.round(t.width)}drawText(e,t=0,s=14,n="normal 14px Verdana",o="black"){this._context.fillStyle=o,this._context.font=n,this._context.fillText(e,t,s)}getWidth(){return this._canvas.width}getHeight(){return this._canvas.height}load(e,t){let s=new Image,n=this;s.onload=function(){n.resize(s.width,s.height),n._context.drawImage(s,0,0,s.width,s.height),t&&t(s)},s.src=e}openImage(){let e=this.getImage(),t="<!DOCTYPE html>";t+="<html>",t+="<head><title>Print</title></head>",t+="<body>",t+='<img src="'+e.src+'">',t+="</body>",t+="</html>";let s=window.open("","","width="+e.width+"px ,height="+e.height+"px");s&&(s.document.open(),s.document.write(t),s.document.close(),s.focus())}destroy(){this._canvas.width=1,this._canvas.height=1,this._canvas=null,this._context=null}}const Jn={UNSIGNED_BYTE:Uint8Array,FLOAT:Float32Array};class St extends as{constructor(e,t={}){super(e,t),this.readPixelBuffersAsync=s=>{const n=this.handler.gl;if(this._skipFrame)return;this._skipFrame=!0;let o=this.width,a=this.height,h=this.pixelBuffers;this.activate();for(let _=0;_<h.length;_++){let f=h[_];n.bindBuffer(n.PIXEL_PACK_BUFFER,f.buffer),n.bufferData(n.PIXEL_PACK_BUFFER,f.data.byteLength,n.STREAM_READ),n.readBuffer(f.glAttachment),n.readPixels(0,0,o,a,n.RGBA,f.glType,0),n.bindBuffer(n.PIXEL_PACK_BUFFER,null)}this.deactivate();const c=n.fenceSync(n.SYNC_GPU_COMMANDS_COMPLETE,0);var d,u;n.flush(),(d=n,u=c,new Promise((_,f)=>{(function v(){const g=d.clientWaitSync(u,0,0);g==d.WAIT_FAILED?f():g==d.TIMEOUT_EXPIRED?requestAnimationFrame(v):_()})()})).then(()=>{this._skipFrame=!1,n.deleteSync(c);for(let _=0;_<h.length;_++){let f=h[_];f.data&&(n.bindBuffer(n.PIXEL_PACK_BUFFER,f.buffer),n.getBufferSubData(n.PIXEL_PACK_BUFFER,0,f.data))}n.bindBuffer(n.PIXEL_PACK_BUFFER,null),s&&s(this)})},this._targets=St.createTargets(t.targets),this._size=this._targets.length,this._renderbufferTarget=t.renderbufferTarget!=null?t.renderbufferTarget:"DEPTH_ATTACHMENT",this.textures=t.textures||new Array(this._size),this.pixelBuffers=[],this._skipFrame=!1}static createTargets(e){let t=0,s=0;return e?e.map(n=>{let o=n.attachment||"COLOR_ATTACHMENT";o==="COLOR_ATTACHMENT"&&(o="COLOR_ATTACHMENT"+t++);let a=n.type||"UNSIGNED_BYTE";return{internalFormat:n.internalFormat||"RGBA",format:n.format||"RGBA",type:a,attachment:o,filter:n.filter||"NEAREST",pixelBufferIndex:n.readAsync?s++:-1,TypeArrayConstructor:Jn[a]}}):[{internalFormat:"RGBA",format:"RGBA",type:"UNSIGNED_BYTE",attachment:"COLOR_ATTACHMENT0",filter:"NEAREST",pixelBufferIndex:-1,TypeArrayConstructor:Jn.UNSIGNED_BYTE}]}destroy(){let e=this.handler.gl;if(e){for(let t=0;t<this.textures.length;t++)e.deleteTexture(this.textures[t]);this.textures=new Array(this._size);for(let t=0;t<this.pixelBuffers.length;t++)this.pixelBuffers[t].data=null,e.deleteBuffer(this.pixelBuffers[t].buffer);this.pixelBuffers=[],e.deleteFramebuffer(this._fbo),e.deleteRenderbuffer(this._depthRenderbuffer),this._depthRenderbuffer=null,this._fbo=null,this._active=!1}}init(){let e=this.handler.gl;if(!e)return;this._fbo=e.createFramebuffer(),e.bindFramebuffer(e.FRAMEBUFFER,this._fbo);let t=[];for(let s=0;s<this._targets.length;s++){let n=this._targets[s],o=this.textures[s]||this.handler.createEmptyTexture2DExt(this._width,this._height,n.filter,n.internalFormat,n.format,n.type),a=e[n.attachment];o&&(this.bindOutputTexture(o,a),this.textures[s]=o),n.attachment!=="DEPTH_ATTACHMENT"&&t.push(a),n.pixelBufferIndex!==-1&&this._createPixelBuffer(n)}e.drawBuffers&&e.drawBuffers(t),this._useDepth&&(this._depthRenderbuffer=e.createRenderbuffer(),e.bindRenderbuffer(e.RENDERBUFFER,this._depthRenderbuffer),e.renderbufferStorage(e.RENDERBUFFER,e[this._depthComponent],this._width,this._height),e.framebufferRenderbuffer(e.FRAMEBUFFER,e[this._renderbufferTarget],e.RENDERBUFFER,this._depthRenderbuffer),e.bindRenderbuffer(e.RENDERBUFFER,null)),e.bindFramebuffer(e.FRAMEBUFFER,null)}getPixelBufferData(e=0){let t=this._targets[e].pixelBufferIndex;return t!==-1?this.pixelBuffers[t].data:null}_createPixelBuffer(e){let t=this.handler.gl,s=e.pixelBufferIndex,n=this.pixelBuffers[s];n||(n=this.pixelBuffers[s]={buffer:null,data:null,glType:-1,glAttachment:-1});let o=this.width*this.height*4;n.data=null,n.data=new e.TypeArrayConstructor(o),n.buffer=t.createBuffer(),t.bindBuffer(t.PIXEL_PACK_BUFFER,n.buffer),t.bufferData(t.PIXEL_PACK_BUFFER,o,t.STREAM_READ),t.bindBuffer(t.PIXEL_PACK_BUFFER,null),n.glType=t[e.type],n.glAttachment=t[e.attachment]}bindOutputTexture(e,t){let s=this.handler.gl;s.bindTexture(s.TEXTURE_2D,e),s.framebufferTexture2D(s.FRAMEBUFFER,t||s.COLOR_ATTACHMENT0,s.TEXTURE_2D,e,0),s.bindTexture(s.TEXTURE_2D,null)}readPixels(e,t,s,n=0,o=1,a=1){let h=this.handler.gl;h.bindFramebuffer(h.FRAMEBUFFER,this._fbo),h.readBuffer&&h.readBuffer(h.COLOR_ATTACHMENT0+n||0),h.readPixels(t*this._width,s*this._height,o,a,h.RGBA,h[this._targets[n].type],e),h.bindFramebuffer(h.FRAMEBUFFER,null)}readAllPixels(e,t=0){let s=this.handler.gl;s.bindFramebuffer(s.FRAMEBUFFER,this._fbo),s.readBuffer&&s.readBuffer(s.COLOR_ATTACHMENT0+t),s.readPixels(0,0,this._width,this._height,s.RGBA,s[this._targets[t].type],e),s.bindFramebuffer(s.FRAMEBUFFER,null)}getImage(){let e=new Uint8Array(4*this._width*this._height);this.readAllPixels(e);let t=new gi(this._width,this._height);return t.setData(e),t.getImage()}readData(e,t,s,n=0){const o=this.width,a=this.height,h=Math.floor(e*(o-1)),c=4*(Math.floor(t*(a-1))*o+h),d=this.pixelBuffers[n].data;d&&(s[0]=d[c],s[1]=d[c+1],s[2]=d[c+2],s[3]=d[c+3])}}const Sh=["tick","end","start","stop"],Ss=class Zc{constructor(e={}){this.__handler=null,this.active=!0,this.__id=Zc.__counter__++,this.events=ot(Sh,this),this.name=e.name||"",this.startDate=e.startDate||0,this.endDate=e.endDate||0;let t=e.currentDate||ts(new Date);e.startDate&&t<e.startDate&&(t=e.startDate),e.endDate&&t>e.endDate&&(t=e.endDate),this.currentDate=t,this._multiplier=e.multiplier!==void 0?e.multiplier:1,this._running=1,this.deltaTicks=0,this.active=!0,this._intervalDelay=0,this._intervalStart=0,this._intervalCallback=null}clearInterval(){this._intervalDelay=0,this._intervalStart=0,this._intervalCallback=null}setInterval(e,t){this._intervalStart=this.currentDate,this._intervalDelay=e*Kr,this._intervalCallback=t}setDate(e){let t=ts(e);this.startDate&&t<this.startDate&&(t=this.startDate),this.endDate&&t>this.endDate&&(t=this.endDate),this.currentDate=t}getDate(){return fr(this.currentDate)}reset(){this.startDate&&(this.currentDate=this.startDate)}tick(e){let t=this._multiplier*this._running;if(this.deltaTicks=e*t,this.active){let s=Io(this.currentDate,this.deltaTicks);t>0?this.endDate&&s>this.endDate?(this.currentDate=this.startDate,this.events.dispatch(this.events.end,this)):this.currentDate=s:this.startDate&&s<this.startDate?(this.currentDate=this.endDate,this.events.dispatch(this.events.end,this)):this.currentDate=s,this._intervalCallback&&this.currentDate-this._intervalStart>=this._intervalDelay&&(this._intervalStart=this.currentDate,this._intervalCallback(this)),this.events.dispatch(this.events.tick,this)}}isEqual(e){return this.__id===e.__id}start(){this._running===0&&(this._running=1,this.events.dispatch(this.events.start,this))}get multiplier(){return this._multiplier}set multiplier(e){this._multiplier=e}stop(){this._running===1&&(this._running=0,this.events.dispatch(this.events.stop,this))}};Ss.__counter__=0;let Dr=Ss;class Rh{constructor(e,t){t._programController=this,this._program=t,this._handler=e,this._activated=!1}initialize(){this._handler.gl&&this._program.createProgram(this._handler.gl)}getProgram(){return this._program}activate(){if(!this._activated){this._handler.activeProgram.deactivate(),this._handler.activeProgram=this;let e=this._program;this._activated=!0,e.enableAttribArrays(),e.use()}return this}remove(){let e=this._handler.programs;e[this._program.name]&&(this._activated&&this.deactivate(),this._program.delete(),delete e[this._program.name])}deactivate(){this._program.disableAttribArrays(),this._activated=!1}isActive(){return this._activated}set(e){return this.activate(),this._program.set(e),this}drawIndexBuffer(e,t){return this._program.drawIndexBuffer(e,t),this}drawArrays(e,t){return this._program.drawArrays(e,t),this}}let to=class{constructor(){this.next=null,this.prev=null,this.data=null}};class Ks{constructor(e=256){this._current=new to,this._head=this._current;for(let t=0;t<e;t++){let s=new to;s.prev=this._current,this._current.next=s,this._current=s}this._current=this._head}current(){return this._current}push(e){this._current=this._current.next,this._current.data=e}pop(){let e=this._current.data;return this._current=this._current.prev,e}popPrev(){return this._current=this._current.prev,this._current.data}}const eo=["","WEBKIT_","MOZ_"],Qs=["webgl2","webgl"];class Me{constructor(e,t={}){this.framebufferStack=new Ks,this._requestAnimationFrameId=0,this.drawFrame=()=>{let s=window.performance.now(),n=this.deltaTime;this.deltaTime=.5*(s-this._lastAnimationFrameTime+this.prevDeltaTime),this.deltaTime>3?this.deltaTime=3:this.deltaTime<1&&(this.deltaTime=1),this.prevDeltaTime=n,this._lastAnimationFrameTime=s,this.defaultClock.tick(this.deltaTime);for(let a=0;a<this._clocks.length;a++)this._clocks[a].tick(this.deltaTime);let o=this.canvas;Math.floor(o.clientWidth*this._params.pixelRatio)===o.width&&Math.floor(o.clientHeight*this._params.pixelRatio)===o.height||(o.clientWidth===0||o.clientHeight===0?this.stop():document.hidden||(this.start(),this.setSize(o.clientWidth,o.clientHeight))),this._frameCallback()},this.events=ot(["visibilitychange","resize"]),this._throttledDrawFrame=this.drawFrame,this.defaultClock=new Dr,this._clocks=[],this.prevDeltaTime=0,this.deltaTime=0,this.canvas=null,this.gl=null,this.programs={},this.activeProgram=null,this._canvasSize=[0,0],this._params={anisotropy:t.anisotropy||4,width:t.width||256,height:t.height||256,pixelRatio:Bo("og_dpi")||t.pixelRatio||1,extensions:t.extensions||[],context:t.context||{}},this.extensions={},this._canvasTarget=e,this._lastAnimationFrameTime=0,this._initialized=!1,this._frameCallback=function(){},this.transparentTexture=null,this.defaultTexture=null,this.framebufferStack=new Ks,this.createTexture_n=this.createTexture_n_webgl2.bind(this),this.createTexture_l=this.createTexture_l_webgl2.bind(this),this.createTexture_mm=this.createTexture_mm_webgl2.bind(this),this.createTexture_a=this.createTexture_a_webgl2.bind(this),this.createTexture={NEAREST:this.createTexture_n,LINEAR:this.createTexture_l,MIPMAP:this.createTexture_mm,ANISOTROPIC:this.createTexture_a},this.createTextureDefault=this.createTexture_n,this.ONCANVASRESIZE=null,this._createCanvas(),(t.autoActivate||Ut(t.autoActivate))&&this.initialize()}set frameDelay(e){this._throttledDrawFrame=e===0?this.drawFrame:vi(this.drawFrame,e)}isInitialized(){return this._initialized}_createCanvas(){this._canvasTarget?this._canvasTarget instanceof HTMLElement?this.canvas=this._canvasTarget:this.canvas=document.getElementById(this._canvasTarget)||document.querySelector(this._canvasTarget):(this.canvas=document.createElement("canvas"),this.canvas.width=this._params.width,this.canvas.height=this._params.height)}static getExtension(e,t){if(!e)return;let s,n;for(s in eo)if(n=e.getExtension(eo[s]+t),n)return n}static getContext(e,t){let s=null;try{let n=new URLSearchParams(location.search).get("og_ver");if(n)s=e.getContext(n,t),s&&(s.type=n);else for(let o=0;o<Qs.length;o++)if(s=e.getContext(Qs[o],t),s){s.type=Qs[o];break}}catch{te.logErr("exception during the GL context initialization")}return s||te.logErr("could not initialise WebGL"),s}setFrameCallback(e){e&&(this._frameCallback=e)}createEmptyTexture2DExt(e=1,t=1,s="NEAREST",n="RGBA",o="RGBA",a="UNSIGNED_BYTE",h="CLAMP_TO_EDGE",c=0){let d=this.gl,u=d.createTexture();return d.bindTexture(d.TEXTURE_2D,u),d.texImage2D(d.TEXTURE_2D,c,d[n.toUpperCase()],e,t,0,d[o.toUpperCase()],d[a.toUpperCase()],null),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MIN_FILTER,d[s.toUpperCase()]),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MAG_FILTER,d[s.toUpperCase()]),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_S,d[h.toUpperCase()]),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_T,d[h.toUpperCase()]),d.bindTexture(d.TEXTURE_2D,null),u}createEmptyTexture_n(e,t,s,n){let o=this.gl,a=o.createTexture();return o.bindTexture(o.TEXTURE_2D,a),o.texImage2D(o.TEXTURE_2D,0,s||o.RGBA,e,t,0,o.RGBA,o.UNSIGNED_BYTE,null),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MIN_FILTER,o.NEAREST),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MAG_FILTER,o.NEAREST),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_S,n||o.CLAMP_TO_EDGE),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_T,n||o.CLAMP_TO_EDGE),o.bindTexture(o.TEXTURE_2D,null),a}createEmptyTexture_l(e,t,s,n){let o=this.gl,a=o.createTexture();return o.bindTexture(o.TEXTURE_2D,a),o.texImage2D(o.TEXTURE_2D,0,s||o.RGBA,e,t,0,o.RGBA,o.UNSIGNED_BYTE,null),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MAG_FILTER,o.LINEAR),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MIN_FILTER,o.LINEAR),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_S,n||o.CLAMP_TO_EDGE),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_T,n||o.CLAMP_TO_EDGE),o.bindTexture(o.TEXTURE_2D,null),a}createTexture_n_webgl1(e,t,s,n=null){let o=this.gl;return n=n||o.createTexture(),o.bindTexture(o.TEXTURE_2D,n),o.texImage2D(o.TEXTURE_2D,0,t||o.RGBA,o.RGBA,o.UNSIGNED_BYTE,e),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MIN_FILTER,o.NEAREST),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MAG_FILTER,o.NEAREST),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_S,s||o.CLAMP_TO_EDGE),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_T,s||o.CLAMP_TO_EDGE),o.bindTexture(o.TEXTURE_2D,null),n}createTexture_l_webgl1(e,t,s,n=null){let o=this.gl;return n=n||o.createTexture(),o.bindTexture(o.TEXTURE_2D,n),o.texImage2D(o.TEXTURE_2D,0,t||o.RGBA,o.RGBA,o.UNSIGNED_BYTE,e),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MAG_FILTER,o.LINEAR),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MIN_FILTER,o.LINEAR),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_S,s||o.CLAMP_TO_EDGE),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_T,s||o.CLAMP_TO_EDGE),o.bindTexture(o.TEXTURE_2D,null),n}createTexture_mm_webgl1(e,t,s,n=null){let o=this.gl;return n=n||o.createTexture(),o.bindTexture(o.TEXTURE_2D,n),o.texImage2D(o.TEXTURE_2D,0,t||o.RGBA,o.RGBA,o.UNSIGNED_BYTE,e),o.generateMipmap(o.TEXTURE_2D),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MIN_FILTER,o.LINEAR_MIPMAP_LINEAR),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_S,s||o.CLAMP_TO_EDGE),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_T,s||o.CLAMP_TO_EDGE),o.bindTexture(o.TEXTURE_2D,null),n}createTexture_a_webgl1(e,t,s,n=null){let o=this.gl;return n=n||o.createTexture(),o.bindTexture(o.TEXTURE_2D,n),o.texImage2D(o.TEXTURE_2D,0,t||o.RGBA,o.RGBA,o.UNSIGNED_BYTE,e),o.generateMipmap(o.TEXTURE_2D),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MIN_FILTER,o.LINEAR_MIPMAP_LINEAR),o.texParameterf(o.TEXTURE_2D,this.extensions.EXT_texture_filter_anisotropic.TEXTURE_MAX_ANISOTROPY_EXT,this._params.anisotropy),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_S,s||o.CLAMP_TO_EDGE),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_T,s||o.CLAMP_TO_EDGE),o.bindTexture(o.TEXTURE_2D,null),n}createTexture_n_webgl2(e,t,s,n=null){let o=this.gl;return n=n||o.createTexture(),o.bindTexture(o.TEXTURE_2D,n),o.texStorage2D(o.TEXTURE_2D,1,t||o.RGBA8,e.width,e.height),o.texSubImage2D(o.TEXTURE_2D,0,0,0,e.width,e.height,o.RGBA,o.UNSIGNED_BYTE,e),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MIN_FILTER,o.NEAREST),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MAG_FILTER,o.NEAREST),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_S,s||o.CLAMP_TO_EDGE),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_T,s||o.CLAMP_TO_EDGE),o.bindTexture(o.TEXTURE_2D,null),n}createTexture_l_webgl2(e,t,s,n=null){let o=this.gl;return n=n||o.createTexture(),o.bindTexture(o.TEXTURE_2D,n),o.texStorage2D(o.TEXTURE_2D,1,t||o.RGBA8,e.width,e.height),o.texSubImage2D(o.TEXTURE_2D,0,0,0,e.width,e.height,o.RGBA,o.UNSIGNED_BYTE,e),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MAG_FILTER,o.LINEAR),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MIN_FILTER,o.LINEAR),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_S,s||o.CLAMP_TO_EDGE),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_T,s||o.CLAMP_TO_EDGE),o.bindTexture(o.TEXTURE_2D,null),n}createTexture_mm_webgl2(e,t,s,n=null){let o=this.gl;return n=n||o.createTexture(),o.bindTexture(o.TEXTURE_2D,n),o.texStorage2D(o.TEXTURE_2D,2,t||o.RGBA8,e.width,e.height),o.texSubImage2D(o.TEXTURE_2D,0,0,0,e.width,e.height,o.RGBA,o.UNSIGNED_BYTE,e),o.generateMipmap(o.TEXTURE_2D),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MIN_FILTER,o.LINEAR_MIPMAP_LINEAR),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_S,s||o.CLAMP_TO_EDGE),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_T,s||o.CLAMP_TO_EDGE),o.bindTexture(o.TEXTURE_2D,null),n}createTexture_a_webgl2(e,t,s,n=null){let o=this.gl;return n=n||o.createTexture(),o.bindTexture(o.TEXTURE_2D,n),o.texStorage2D(o.TEXTURE_2D,2,t||o.RGBA8,e.width,e.height),o.texSubImage2D(o.TEXTURE_2D,0,0,0,e.width,e.height,o.RGBA,o.UNSIGNED_BYTE,e),o.generateMipmap(o.TEXTURE_2D),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MIN_FILTER,o.LINEAR_MIPMAP_LINEAR),o.texParameterf(o.TEXTURE_2D,this.extensions.EXT_texture_filter_anisotropic.TEXTURE_MAX_ANISOTROPY_EXT,this._params.anisotropy),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_S,s||o.CLAMP_TO_EDGE),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_T,s||o.CLAMP_TO_EDGE),o.bindTexture(o.TEXTURE_2D,null),n}loadCubeMapTexture(e){let t=this.gl,s=t.createTexture();t.bindTexture(t.TEXTURE_CUBE_MAP,s),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_MAG_FILTER,t.LINEAR);let n=[[e.px,t.TEXTURE_CUBE_MAP_POSITIVE_X],[e.nx,t.TEXTURE_CUBE_MAP_NEGATIVE_X],[e.py,t.TEXTURE_CUBE_MAP_POSITIVE_Y],[e.ny,t.TEXTURE_CUBE_MAP_NEGATIVE_Y],[e.pz,t.TEXTURE_CUBE_MAP_POSITIVE_Z],[e.nz,t.TEXTURE_CUBE_MAP_NEGATIVE_Z]],o=new gi;o.fillEmpty();let a=o.getImage();for(let h=0;h<n.length;h++){let c=n[h][1];t.bindTexture(t.TEXTURE_CUBE_MAP,s),t.texImage2D(c,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,a)}for(let h=0;h<n.length;h++){let c=n[h][1],d=new Image;d.crossOrigin="",d.onload=function(u,_,f){return function(){t&&u&&(t.bindTexture(t.TEXTURE_CUBE_MAP,u),t.texImage2D(_,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,f))}}(s,c,d),d.src=n[h][0]}return s}addProgram(e,t=!1){if(this.programs[e.name])console.warn(`Shader program: "${e.name}" already exists.`);else{let s=new Rh(this,e);this.programs[e.name]=s,this._initProgramController(s),t||(s._activated=!1)}return e}removeProgram(e){this.programs[e]&&this.programs[e].remove()}addPrograms(e){for(let t=0;t<e.length;t++)this.addProgram(e[t])}_initProgramController(e){this._initialized&&(e.initialize(),this.activeProgram?(e.deactivate(),this.activeProgram._program.enableAttribArrays(),this.activeProgram._program.use()):(this.activeProgram=e,e.activate()))}_initPrograms(){for(let e in this.programs)this._initProgramController(this.programs[e])}initializeExtension(e,t=!1){if(!this.extensions||!this.extensions[e]){let s=Me.getExtension(this.gl,e);s?this.extensions[e]=s:t&&console.warn("og.webgl.Handler: extension '"+e+"' doesn't initialize.")}return this.extensions&&this.extensions[e]}initialize(){if(this._initialized||!this.canvas||(this.gl=Me.getContext(this.canvas,this._params.context),!this.gl))return;this._initialized=!0,this._params.extensions.push("EXT_texture_filter_anisotropic"),this.gl.type==="webgl"?(this._params.extensions.push("OES_standard_derivatives"),this._params.extensions.push("OES_element_index_uint"),this._params.extensions.push("WEBGL_depth_texture"),this._params.extensions.push("ANGLE_instanced_arrays")):(this._params.extensions.push("EXT_color_buffer_float"),this._params.extensions.push("OES_texture_float_linear"));let e=this._params.extensions.length;for(;e--;)this.initializeExtension(this._params.extensions[e],!0);this.gl.type==="webgl"?(this.createTexture_n=this.createTexture_n_webgl1.bind(this),this.createTexture_l=this.createTexture_l_webgl1.bind(this),this.createTexture_mm=this.createTexture_mm_webgl1.bind(this),this.createTexture_a=this.createTexture_a_webgl1.bind(this)):(this.createTexture_n=this.createTexture_n_webgl2.bind(this),this.createTexture_l=this.createTexture_l_webgl2.bind(this),this.createTexture_mm=this.createTexture_mm_webgl2.bind(this),this.createTexture_a=this.createTexture_a_webgl2.bind(this)),this.createTexture.NEAREST=this.createTexture_n,this.createTexture.LINEAR=this.createTexture_l,this.createTexture.MIPMAP=this.createTexture_mm,this.createTexture.ANISOTROPIC=this.createTexture_a,this.extensions.EXT_texture_filter_anisotropic?this.createTextureDefault=this.createTexture_a:this.createTextureDefault=this.createTexture_mm,this._initPrograms(),this._setDefaults(),this.intersectionObserver=new IntersectionObserver(t=>{this._toggleVisibilityChange(t[t.length-1].isIntersecting)},{threshold:0}),this.intersectionObserver.observe(this.canvas),this.resizeObserver=new ResizeObserver(t=>{this._toggleVisibilityChange(t[0].contentRect.width!==0&&t[0].contentRect.height!==0)}),this.resizeObserver.observe(this.canvas),document.addEventListener("visibilitychange",()=>{this._toggleVisibilityChange(document.visibilityState==="visible")})}_toggleVisibilityChange(e){e?(this.start(),this.ONCANVASRESIZE&&this.ONCANVASRESIZE(),this.events.dispatch(this.events.visibilitychange,!0)):(this.events.dispatch(this.events.visibilitychange,!1),this.stop())}_setDefaults(){let e=this.gl;e&&this.canvas&&(e.depthFunc(e.LESS),e.enable(e.DEPTH_TEST),this.setSize(this.canvas.clientWidth||this._params.width,this.canvas.clientHeight||this._params.height),e.frontFace(e.CCW),e.cullFace(e.BACK),e.enable(e.CULL_FACE),e.disable(e.BLEND),this.createDefaultTexture({color:"rgba(0,0,0,0.0)"},t=>{this.transparentTexture=t}),this.createDefaultTexture({color:"rgba(255, 255, 255, 1.0)"},t=>{this.defaultTexture=t}))}getCanvasSize(){return this._canvasSize}createStreamArrayBuffer(e,t,s,n=4){let o=this.gl,a=o.createBuffer();return o.bindBuffer(o.ARRAY_BUFFER,a),o.bufferData(o.ARRAY_BUFFER,t*e*n,s||o.STREAM_DRAW),o.bindBuffer(o.ARRAY_BUFFER,null),a.itemSize=e,a.numItems=t,a}setStreamArrayBuffer(e,t,s=0){let n=this.gl;return n.bindBuffer(n.ARRAY_BUFFER,e),n.bufferSubData(n.ARRAY_BUFFER,s,t),n.bindBuffer(n.ARRAY_BUFFER,null),e}createArrayBuffer(e,t,s,n){let o=this.gl,a=o.createBuffer();return o.bindBuffer(o.ARRAY_BUFFER,a),o.bufferData(o.ARRAY_BUFFER,e,n||o.STATIC_DRAW),o.bindBuffer(o.ARRAY_BUFFER,null),a.itemSize=t,a.numItems=s||e.length/t,a}createArrayBufferLength(e,t){let s=this.gl,n=s.createBuffer();return s.bindBuffer(s.ARRAY_BUFFER,n),s.bufferData(s.ARRAY_BUFFER,e,t||s.STATIC_DRAW),s.bindBuffer(s.ARRAY_BUFFER,null),n.itemSize=1,n.numItems=e,n}createElementArrayBuffer(e,t,s,n){let o=this.gl,a=o.createBuffer();return o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,a),o.bufferData(o.ELEMENT_ARRAY_BUFFER,e,n||o.STATIC_DRAW),o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,null),a.itemSize=t,a.numItems=s||e.length,a}setSize(e,t){this._params.width=e,this._params.height=t,this.canvas&&(this.canvas.width=e*this._params.pixelRatio,this.canvas.height=t*this._params.pixelRatio,this._canvasSize[0]=this.canvas.width,this._canvasSize[1]=this.canvas.height,this.gl&&this.gl.viewport(0,0,e,t),this.ONCANVASRESIZE&&this.ONCANVASRESIZE(this.canvas),this.events.dispatch(this.events.resize,this))}get pixelRatio(){return this._params.pixelRatio}set pixelRatio(e){this._params.pixelRatio=e,this.setSize(this._params.width,this._params.height)}getWidth(){return this.canvas?this.canvas.width:0}getHeight(){return this.canvas?this.canvas.height:0}getClientAspect(){return this.canvas?this.canvas.clientWidth/this.canvas.clientHeight:0}getCenter(){let e=this.canvas;return e?new O(Math.round(.5*e.width),Math.round(.5*e.height)):new O}clearFrame(){let e=this.gl;e.clearColor(0,0,0,1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT)}start(){!this._requestAnimationFrameId&&this._initialized&&this._animationFrameCallback()}stop(){this._requestAnimationFrameId&&(window.cancelAnimationFrame(this._requestAnimationFrameId),this._requestAnimationFrameId=0)}isStopped(){return!this._requestAnimationFrameId}isWebGl2(){return!!this.gl&&this.gl.type==="webgl2"}_animationFrameCallback(){this._requestAnimationFrameId=window.requestAnimationFrame(()=>{this._throttledDrawFrame(),this._requestAnimationFrameId&&this._animationFrameCallback()})}createDefaultTexture(e,t){let s,n;if(e&&e.color)s=new gi(2,2),s.fillColor(e.color),n=this.createTexture_n(s.getCanvas()),n.default=!0,t(n);else if(e&&e.url){let o=new Image,a=this;o.onload=function(){n=a.createTextureDefault(o),n.default=!0,t(n)},o.src=e.url}else s=new gi(2,2),s.fillColor("#C5C5C5"),n=this.createTexture_n(s.getCanvas()),n.default=!0,t(n)}deleteTexture(e){e&&!e.default&&this.gl&&this.gl.deleteTexture(e)}destroy(){var e,t;(e=this.resizeObserver)==null||e.disconnect(),(t=this.intersectionObserver)==null||t.disconnect(),this.stop();for(let n in this.programs)this.removeProgram(n);let s=this.gl;if(s){s.deleteTexture(this.transparentTexture),this.transparentTexture=null,s.deleteTexture(this.defaultTexture),this.defaultTexture=null,this.framebufferStack=new Ks;let n=s.getParameter(s.MAX_VERTEX_ATTRIBS),o=s.createBuffer();s.bindBuffer(s.ARRAY_BUFFER,o);for(let h=0;h<n;++h)s.disableVertexAttribArray(h),s.vertexAttribPointer(h,4,s.FLOAT,!1,0,0),s.vertexAttrib1f(h,0);s.deleteBuffer(o);let a=s.getParameter(s.MAX_TEXTURE_IMAGE_UNITS);for(let h=0;h<a;++h)s.activeTexture(s.TEXTURE0+h),s.bindTexture(s.TEXTURE_CUBE_MAP,null),s.bindTexture(s.TEXTURE_2D,null);s.activeTexture(s.TEXTURE0),s.useProgram(null),s.bindBuffer(s.ARRAY_BUFFER,null),s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,null),s.bindFramebuffer(s.FRAMEBUFFER,null),s.bindRenderbuffer(s.RENDERBUFFER,null),s.disable(s.BLEND),s.disable(s.CULL_FACE),s.disable(s.DEPTH_TEST),s.disable(s.DITHER),s.disable(s.SCISSOR_TEST),s.blendColor(0,0,0,0),s.blendEquation(s.FUNC_ADD),s.blendFunc(s.ONE,s.ZERO),s.clearColor(0,0,0,0),s.clearDepth(1),s.clearStencil(-1)}this.canvas&&(this.canvas.parentNode&&this.canvas.parentNode.removeChild(this.canvas),this.canvas.width=1,this.canvas.height=1,this.canvas=null),this.gl=null,this._initialized=!1}addClock(e){e.__handler||(e.__handler=this,this._clocks.push(e))}addClocks(e){for(let t=0;t<e.length;t++)this.addClock(e[t])}removeClock(e){if(e.__handler){let t=this._clocks,s=t.length;for(;s--;)if(t[s].isEqual(e)){e.__handler=null,t.splice(s,1);break}}}}class ba extends as{constructor(e,t={}){super(e,t),this._internalFormat=t.internalFormat?t.internalFormat.toUpperCase():"RGBA8",this._msaa=t.msaa!=null?t.msaa:4,this._glFilter=0,this.renderbuffers=new Array(this._size)}destroy(){let e=this.handler.gl;if(e){for(let t=0;t<this.renderbuffers.length;t++)e.deleteRenderbuffer(this.renderbuffers[t]);this.renderbuffers=new Array(this._size),e.deleteFramebuffer(this._fbo),e.deleteRenderbuffer(this._depthRenderbuffer),this._depthRenderbuffer=null,this._fbo=null,this._active=!1}}init(){let e=this.handler.gl;if(!e)return;this._glFilter=e[this._filter],this._fbo=e.createFramebuffer(),e.bindFramebuffer(e.FRAMEBUFFER,this._fbo);let t=[];for(let s=0;s<this.renderbuffers.length;s++){let n=e.createRenderbuffer();e.bindRenderbuffer(e.RENDERBUFFER,n),this._msaa>0?e.renderbufferStorageMultisample(e.RENDERBUFFER,this._msaa,e[this._internalFormat],this._width,this._height):e.renderbufferStorage(e.RENDERBUFFER,e[this._internalFormat],this._width,this._height),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0+s,e.RENDERBUFFER,n),t.push(e.COLOR_ATTACHMENT0+s),this.renderbuffers[s]=n,e.bindRenderbuffer(e.RENDERBUFFER,null)}e.drawBuffers(t),this._useDepth&&(this._depthRenderbuffer=e.createRenderbuffer(),e.bindRenderbuffer(e.RENDERBUFFER,this._depthRenderbuffer),e.renderbufferStorageMultisample(e.RENDERBUFFER,this._msaa,e[this._depthComponent],this._width,this._height),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,this._depthRenderbuffer),e.bindRenderbuffer(e.RENDERBUFFER,null)),e.bindFramebuffer(e.FRAMEBUFFER,null)}blitTo(e,t=0){let s=this.handler.gl;s.bindFramebuffer(s.READ_FRAMEBUFFER,this._fbo),s.bindFramebuffer(s.DRAW_FRAMEBUFFER,e._fbo),s.readBuffer(s.COLOR_ATTACHMENT0+t),s.clearBufferfv(s.COLOR,0,[0,0,0,1]),s.blitFramebuffer(0,0,this._width,this._height,0,0,e._width,e._height,s.COLOR_BUFFER_BIT,this._glFilter),s.bindFramebuffer(s.FRAMEBUFFER,null),s.bindFramebuffer(s.READ_FRAMEBUFFER,null),s.bindFramebuffer(s.DRAW_FRAMEBUFFER,null)}}Object.freeze(Object.defineProperty({__proto__:null,Framebuffer:St,Handler:Me,Multisample:ba,Program:$,types:lt},Symbol.toStringTag,{value:"Module"}));class wa extends Ei{constructor(e,t={}){super(e,t),this._image=t.image||null,this._src=t.src||null,this._onLoad_=null}get instanceName(){return"GeoImage"}abortLoading(){this._image instanceof HTMLImageElement&&(this._image.src="")}setSrc(e){this._planet&&this._planet._geoImageCreator.remove(this),this._src=e,this._sourceReady=!1,this._sourceCreated=!1,this._image=new Image,this._image.crossOrigin="Anonymous",this._onLoad_=this._onLoad.bind(this),this._image.addEventListener("load",this._onLoad_),this._image.src=e}setImage(e){this._planet&&this._planet._geoImageCreator.remove(this),this._sourceCreated=!1,this._sourceReady=!1,this._image=e,this._image.crossOrigin="Anonymous",this._src=e.src,hr(this._image)?this._applyImage(this._image):(this._onLoad_=this._onLoad.bind(this),this._image.addEventListener("load",this._onLoad_))}_createSourceTexture(){!this._sourceCreated&&this._image&&(this._sourceTexture=this._planet.renderer.handler.createTexture_l(this._image),this._sourceCreated=!0)}_onLoad(e){this._applyImage(this._image),this._image instanceof HTMLImageElement&&this._image.removeEventListener("load",this._onLoad_),this._onLoad_=null}_applyImage(e){e&&(this._frameWidth=Ye(2*e.width,4096),this._frameHeight=Ye(3*e.height,4096),this._sourceReady=!0,this._planet&&this._planet._geoImageCreator.add(this))}loadMaterial(e){e.isLoading=!0,this._creationProceeding=!0,!this._sourceReady&&this._src?this._image?this._image instanceof HTMLImageElement&&(hr(this._image)?this._applyImage(this._image):(this._onLoad_=this._onLoad.bind(this),this._image.addEventListener("load",this._onLoad_))):(this._image=new Image,this._image.crossOrigin="Anonymous",this._onLoad_=this._onLoad.bind(this),this._image.addEventListener("load",this._onLoad_),this._image.src=this._src):this._planet&&this._planet._geoImageCreator.add(this)}abortMaterialLoading(e){this._image&&this._image instanceof HTMLImageElement&&(this._image.src=""),this._creationProceeding=!1,e.isLoading=!1,e.isReady=!1}}Object.freeze(Object.defineProperty({__proto__:null,AtmosphereConfig:class extends Z{constructor(l={}){super(l),this.$maxOpacity=null,this.$minOpacity=null,this.$rayleight=null,this.$mie=null,this.$height=null,this.$bottomRadius=null,this.$mieScatteringCoefficient=null,this.$mieExtinctionCoefficient=null,this.$rayleighScatteringCoefficientA=null,this.$rayleighScatteringCoefficientB=null,this.$rayleighScatteringCoefficientC=null,this.$ozoneAbsorptionCoefficientA=null,this.$ozoneAbsorptionCoefficientB=null,this.$ozoneAbsorptionCoefficientC=null,this.$sunAngularRadius=null,this.$sunIntensity=null,this.$groundAlbedo=null,this.$ozoneDensityHeight=null,this.$ozoneDensityWide=null,this._toggleBtn=new ct({classList:["og-map-button","og-atmosphere_button"],icon:`<?xml version="1.0" encoding="utf-8"?><!-- Uploaded to: SVG Repo, www.svgrepo.com, Generator: SVG Repo Mixer Tools -->
<svg width="800px" height="800px" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><path fill="#000000" d="M135.688 18.5c-6.798 74.842-23.842 85.39-107.907 59.656 84.85 52.022 73.57 64.954-6.843 96.938 87.743-10.27 103.29 4.89 70.75 87.594 17.805-27.56 32.5-44.498 46.282-54.47-11.813 28.26-18.345 59.274-18.345 91.813 0 84.184 43.71 157.96 109.656 200.376-41.624-43.834-67.686-102.7-67.686-167.875 0-134.923 109.45-244.405 244.375-244.405 30.92 0 60.76 5.762 88 16.25-38.584-26.87-85.517-42.625-136.064-42.625-55.257 0-106.14 18.802-146.562 50.375 4.627-18.783 17.39-38.073 41.03-60.906C190.18 90.942 153.53 95.634 135.69 18.5zm10.03 77.188c5.67.002 11.428 1.247 16.876 3.874 14.506 6.998 22.72 21.81 22 36.938-10.26 10.87-19.507 22.696-27.594 35.344-9.035 2.753-19.075 2.27-28.25-2.156-19.37-9.343-27.5-32.6-18.156-51.97 6.715-13.92 20.638-22.036 35.125-22.03z"/></svg>`}),this._dialog=new Zt({title:"Atmosphere Parameters",visible:!1,useHide:!0,top:60,left:60,width:720}),this._dialog.events.on("visibility",e=>{this._toggleBtn.setActive(e)}),this._panel=new dt({template:`<div class="og-atmosphere og-options-container">
         
         <div class="og-option og-atmosphere-maxOpacity"></div> 
         <div class="og-option og-atmosphere-minOpacity"></div>
         
       <div class="og-emptyline-2"></div>
         
         <div class="og-option og-atmosphere-rayleight"></div>
         <div class="og-option og-atmosphere-mie"></div>
         
       <div class="og-emptyline-2"></div>
                  
         <div class="og-option og-atmosphere-height"></div> 
         <div class="og-option og-atmosphere-bottomRadius"></div>
         
       <div class="og-emptyline-2"></div>
         
         <div class="og-option og-atmosphere-mieScatteringCoefficient"></div>  
         <div class="og-option og-atmosphere-mieExtinctionCoefficient"></div>
         
       <div class="og-emptyline-2"></div>
         
         <div class="og-option og-atmosphere-rayleighScatteringCoefficientA"></div>    
         <div class="og-option og-atmosphere-rayleighScatteringCoefficientB"></div>    
         <div class="og-option og-atmosphere-rayleighScatteringCoefficientC"></div>
         
       <div class="og-emptyline-2"></div>
         
         <div class="og-option og-atmosphere-ozoneAbsorptionCoefficientA"></div>    
         <div class="og-option og-atmosphere-ozoneAbsorptionCoefficientB"></div>    
         <div class="og-option og-atmosphere-ozoneAbsorptionCoefficientC"></div>
         
       <div class="og-emptyline-2"></div>
         
         <div class="og-option og-atmosphere-ozoneDensityHeight"></div>    
         <div class="og-option og-atmosphere-ozoneDensityWide"></div>    
         
       <div class="og-emptyline-2"></div>
         
         <div class="og-option og-atmosphere-sunAngularRadius"></div> 
         <div class="og-option og-atmosphere-sunIntensity"></div> 
         <div class="og-option og-atmosphere-earthAlbedo"></div>
       
    </div>`}),this._maxOpacity=new K({label:"Max.opacity",max:5}),this._minOpacity=new K({label:"Min.opacity",max:5}),this._rayleight=new K({label:"Rayleight Scale",min:-10,max:10}),this._mie=new K({label:"Mie Scale",min:-10,max:10}),this._height=new K({label:"Height",max:1e6}),this._bottomRadius=new K({label:"Planet Radius",max:31783761571225896e-9}),this._mieScatteringCoefficient=new K({label:"Mie Scattering Coefficient e-6",min:-39.96,max:39.96}),this._mieExtinctionCoefficient=new K({label:"Mie Extinction Coef.e-6",min:4.44*-10,max:10*4.44}),this._rayleighScatteringCoefficientA=new K({label:"Rayleight Scattering Coef A.e-6",min:5.802*-10,max:10*5.802}),this._rayleighScatteringCoefficientB=new K({label:"Rayleight Scattering Coef B.e-6",min:13.558*-10,max:10*13.558}),this._rayleighScatteringCoefficientC=new K({label:"Rayleight Scattering Coef C.e-6",min:-331,max:331}),this._ozoneAbsorptionCoefficientA=new K({label:"Ozone absorbtion Coef A.e-6",min:-6.5,max:6.5}),this._ozoneAbsorptionCoefficientB=new K({label:"Ozone absorbtion Coef B.e-6",min:-6.5,max:18.81}),this._ozoneAbsorptionCoefficientC=new K({label:"Ozone absorbtion Coef C.e-6",min:.085*-10,max:10*.085}),this._ozoneDensityHeight=new K({label:"Ozone Density Height",max:25e5}),this._ozoneDensityWide=new K({label:"Ozone Density Wide",max:25e5}),this._sunAngularRadius=new K({label:"Sun Angular Radius",max:4.685}),this._sunIntensity=new K({label:"Sun Intensity",max:10}),this._groundAlbedo=new K({label:"Earth Albedo",max:.5}),this._parameters={ATMOS_HEIGHT:0,RAYLEIGH_SCALE:0,MIE_SCALE:0,GROUND_ALBEDO:0,BOTTOM_RADIUS:0,rayleighScatteringCoefficient_0:0,rayleighScatteringCoefficient_1:0,rayleighScatteringCoefficient_2:0,mieScatteringCoefficient:0,mieExtinctionCoefficient:0,ozoneAbsorptionCoefficient_0:0,ozoneAbsorptionCoefficient_1:0,ozoneAbsorptionCoefficient_2:0,SUN_ANGULAR_RADIUS:0,SUN_INTENSITY:0,ozoneDensityHeight:0,ozoneDensityWide:0,disableSunDisk:!1}}oninit(){this._toggleBtn.appendTo(this.renderer.div),this._dialog.appendTo(this.renderer.div),this._panel.appendTo(this._dialog.container),this._panel.el&&(this.$height=this._panel.el.querySelector(".og-option.og-atmosphere-height"),this.$maxOpacity=this._panel.el.querySelector(".og-option.og-atmosphere-maxOpacity"),this.$minOpacity=this._panel.el.querySelector(".og-option.og-atmosphere-minOpacity"),this.$rayleight=this._panel.el.querySelector(".og-option.og-atmosphere-rayleight"),this.$mie=this._panel.el.querySelector(".og-option.og-atmosphere-mie"),this.$bottomRadius=this._panel.el.querySelector(".og-option.og-atmosphere-bottomRadius"),this.$mieScatteringCoefficient=this._panel.el.querySelector(".og-option.og-atmosphere-mieScatteringCoefficient"),this.$mieExtinctionCoefficient=this._panel.el.querySelector(".og-option.og-atmosphere-mieExtinctionCoefficient"),this.$rayleighScatteringCoefficientA=this._panel.el.querySelector(".og-option.og-atmosphere-rayleighScatteringCoefficientA"),this.$rayleighScatteringCoefficientB=this._panel.el.querySelector(".og-option.og-atmosphere-rayleighScatteringCoefficientB"),this.$rayleighScatteringCoefficientC=this._panel.el.querySelector(".og-option.og-atmosphere-rayleighScatteringCoefficientC"),this.$ozoneAbsorptionCoefficientA=this._panel.el.querySelector(".og-option.og-atmosphere-ozoneAbsorptionCoefficientA"),this.$ozoneAbsorptionCoefficientB=this._panel.el.querySelector(".og-option.og-atmosphere-ozoneAbsorptionCoefficientB"),this.$ozoneAbsorptionCoefficientC=this._panel.el.querySelector(".og-option.og-atmosphere-ozoneAbsorptionCoefficientC"),this.$sunAngularRadius=this._panel.el.querySelector(".og-option.og-atmosphere-sunAngularRadius"),this.$sunIntensity=this._panel.el.querySelector(".og-option.og-atmosphere-sunIntensity"),this.$groundAlbedo=this._panel.el.querySelector(".og-option.og-atmosphere-earthAlbedo"),this.$ozoneDensityHeight=this._panel.el.querySelector(".og-option.og-atmosphere-ozoneDensityHeight"),this.$ozoneDensityWide=this._panel.el.querySelector(".og-option.og-atmosphere-ozoneDensityWide")),this._toggleBtn.events.on("change",l=>{this._dialog.setVisibility(l)}),this._maxOpacity.appendTo(this.$maxOpacity),this._minOpacity.appendTo(this.$minOpacity),this._height.appendTo(this.$height),this._rayleight.appendTo(this.$rayleight),this._mie.appendTo(this.$mie),this._bottomRadius.appendTo(this.$bottomRadius),this._mieScatteringCoefficient.appendTo(this.$mieScatteringCoefficient),this._mieExtinctionCoefficient.appendTo(this.$mieExtinctionCoefficient),this._rayleighScatteringCoefficientA.appendTo(this.$rayleighScatteringCoefficientA),this._rayleighScatteringCoefficientB.appendTo(this.$rayleighScatteringCoefficientB),this._rayleighScatteringCoefficientC.appendTo(this.$rayleighScatteringCoefficientC),this._ozoneAbsorptionCoefficientA.appendTo(this.$ozoneAbsorptionCoefficientA),this._ozoneAbsorptionCoefficientB.appendTo(this.$ozoneAbsorptionCoefficientB),this._ozoneAbsorptionCoefficientC.appendTo(this.$ozoneAbsorptionCoefficientC),this._sunAngularRadius.appendTo(this.$sunAngularRadius),this._sunIntensity.appendTo(this.$sunIntensity),this._groundAlbedo.appendTo(this.$groundAlbedo),this._ozoneDensityHeight.appendTo(this.$ozoneDensityHeight),this._ozoneDensityWide.appendTo(this.$ozoneDensityWide),this.planet&&(this._parameters=this.planet.atmosphereControl.parameters,this._height.value=this._parameters.ATMOS_HEIGHT,this._rayleight.value=this._parameters.RAYLEIGH_SCALE,this._mie.value=this._parameters.MIE_SCALE,this._bottomRadius.value=this._parameters.BOTTOM_RADIUS,this._mieScatteringCoefficient.value=this._parameters.mieScatteringCoefficient,this._mieExtinctionCoefficient.value=this._parameters.mieExtinctionCoefficient,this._rayleighScatteringCoefficientA.value=this._parameters.rayleighScatteringCoefficient_0,this._rayleighScatteringCoefficientB.value=this._parameters.rayleighScatteringCoefficient_1,this._rayleighScatteringCoefficientC.value=this._parameters.rayleighScatteringCoefficient_2,this._ozoneAbsorptionCoefficientA.value=this._parameters.ozoneAbsorptionCoefficient_0,this._ozoneAbsorptionCoefficientB.value=this._parameters.ozoneAbsorptionCoefficient_1,this._ozoneAbsorptionCoefficientC.value=this._parameters.ozoneAbsorptionCoefficient_2,this._sunAngularRadius.value=this._parameters.SUN_ANGULAR_RADIUS,this._sunIntensity.value=this._parameters.SUN_INTENSITY,this._groundAlbedo.value=this._parameters.GROUND_ALBEDO,this._ozoneDensityHeight.value=this._parameters.ozoneDensityHeight,this._ozoneDensityWide.value=this._parameters.ozoneDensityWide),this._minOpacity.value=this.planet.atmosphereMinOpacity,this._minOpacity.events.on("change",l=>{this.planet.atmosphereMinOpacity=l}),this._maxOpacity.value=this.planet.atmosphereMaxOpacity,this._maxOpacity.events.on("change",l=>{this.planet.atmosphereMaxOpacity=l}),this._rayleight.events.on("change",l=>{this._parameters.RAYLEIGH_SCALE=l,this._update()}),this._mie.events.on("change",l=>{this._parameters.MIE_SCALE=l,this._update()}),this._height.events.on("change",l=>{this._parameters.ATMOS_HEIGHT=l,this._update()}),this._bottomRadius.events.on("change",l=>{this._parameters.BOTTOM_RADIUS=l,this._update()}),this._mieScatteringCoefficient.events.on("change",l=>{this._parameters.mieScatteringCoefficient=l,this._update()}),this._mieExtinctionCoefficient.events.on("change",l=>{this._parameters.mieExtinctionCoefficient=l,this._update()}),this._rayleighScatteringCoefficientA.events.on("change",l=>{this._parameters.rayleighScatteringCoefficient_0=l,this._update()}),this._rayleighScatteringCoefficientB.events.on("change",l=>{this._parameters.rayleighScatteringCoefficient_1=l,this._update()}),this._rayleighScatteringCoefficientC.events.on("change",l=>{this._parameters.rayleighScatteringCoefficient_2=l,this._update()}),this._ozoneAbsorptionCoefficientA.events.on("change",l=>{this._parameters.ozoneAbsorptionCoefficient_0=l,this._update()}),this._ozoneAbsorptionCoefficientB.events.on("change",l=>{this._parameters.ozoneAbsorptionCoefficient_1=l,this._update()}),this._ozoneAbsorptionCoefficientC.events.on("change",l=>{this._parameters.ozoneAbsorptionCoefficient_2=l,this._update()}),this._sunAngularRadius.events.on("change",l=>{this._parameters.SUN_ANGULAR_RADIUS=l,this._update()}),this._sunIntensity.events.on("change",l=>{this._parameters.SUN_INTENSITY=l,this._update()}),this._groundAlbedo.events.on("change",l=>{this._parameters.GROUND_ALBEDO=l,this._update()}),this._ozoneDensityHeight.events.on("change",l=>{this._parameters.ozoneDensityHeight=l,this._update()}),this._ozoneDensityWide.events.on("change",l=>{this._parameters.ozoneDensityWide=l,this._update()})}_update(){this.planet&&this.planet.atmosphereControl.setParameters(this._parameters)}},CameraDepthHandler:class extends Z{constructor(l){super(l),this._skipPreRender=!1,this._depthHandlerCallback=e=>{if(!this.planet)return;let t=e.frameBuffer;if(t.handler.gl,t.activate(),this._quadTreeStrategy){let h=e.camera;this._skipPreRender&&this._quadTreeStrategy.collectRenderNodes(h),this._skipPreRender=!0,console.log(this._quadTreeStrategy._renderedNodes)}t.deactivate(),t.readPixelBuffersAsync();let s=this.getLonLatFromPixelTerrain(1,1),n=this.getLonLatFromPixelTerrain(t.width-1,1),o=this.getLonLatFromPixelTerrain(t.width-1,t.height-1),a=this.getLonLatFromPixelTerrain(1,t.height-1);s&&n&&o&&a&&this.cameraGeoImage.setCorners([[s.lon,s.lat],[n.lon,n.lat],[o.lon,o.lat],[a.lon,a.lat]])},this._frameComposer=new Ir,this._frameHandler=null,this.cameraGeoImage=new wa(`cameraGeoImage:${this.__id}`,{src:"test4.jpg",corners:[[0,1],[1,1],[1,0],[0,0]],visibility:!0,isBaseLayer:!1,opacity:.7}),this._quadTreeStrategy=null}_createCamera(){return this.planet?new xa(this.planet,{frustums:[[100,1e9]],width:640,height:480,viewAngle:45}):new Li({frustums:[[100,1e9]],width:640,height:480,viewAngle:45})}get camera(){if(this._frameHandler)return this._frameHandler.camera}oninit(){if(super.oninit(),!this.renderer)return;this.renderer.handler.addProgram(new $("camera_depth",{uniforms:{projectionMatrix:"mat4",viewMatrix:"mat4",height:"float",eyePositionHigh:"vec3",eyePositionLow:"vec3"},attributes:{aVertexPositionHigh:"vec3",aVertexPositionLow:"vec3"},vertexShader:`#version 300 es
            
            precision highp float;

            in vec3 aVertexPositionHigh;
            in vec3 aVertexPositionLow;

            uniform mat4 projectionMatrix;
            uniform mat4 viewMatrix;
            uniform vec3 eyePositionHigh;
            uniform vec3 eyePositionLow;
            uniform float height;

            void main(void) {

                mat4 viewMatrixRTE = viewMatrix;
                viewMatrixRTE[3] = vec4(0.0, 0.0, 0.0, 1.0);

                mat4 m = projectionMatrix * viewMatrixRTE;

                vec3 nh = height * normalize(aVertexPositionHigh + aVertexPositionLow);

                vec3 eyePosition = eyePositionHigh + eyePositionLow;
                vec3 vertexPosition = aVertexPositionHigh + aVertexPositionLow;

                vec3 highDiff = aVertexPositionHigh - eyePositionHigh;
                vec3 lowDiff = aVertexPositionLow - eyePositionLow + nh;
                
                gl_Position =  m * vec4(highDiff * step(1.0, length(highDiff)) + lowDiff, 1.0);    
            }`,fragmentShader:`#version 300 es
            
            precision highp float;        

            layout(location = 0) out vec4 depthColor;

            void main(void) {
                depthColor = vec4(gl_FragCoord.z, gl_FragCoord.z, gl_FragCoord.z, 1.0);
            }`})),this.planet&&this.planet.addLayer(this.cameraGeoImage);let l=new St(this.renderer.handler,{width:640,height:480,targets:[{internalFormat:"RGBA16F",type:"FLOAT",attachment:"COLOR_ATTACHMENT",readAsync:!0}],useDepth:!0});if(this._frameHandler=new Kn({camera:this._createCamera(),frameBuffer:l,frameHandler:this._depthHandlerCallback}),this.renderer.controls.CameraFrameComposer?this._frameComposer=this.renderer.controls.CameraFrameComposer:this.renderer.addControl(this._frameComposer),this._frameComposer.add(this._frameHandler),this.planet){const e={planet:this.planet,maxEqualZoomAltitude:this.planet.quadTreeStrategy.maxEqualZoomAltitude,minEqualZoomAltitude:this.planet.quadTreeStrategy.minEqualZoomAltitude,minEqualZoomCameraSlope:this.planet.quadTreeStrategy.minEqualZoomCameraSlope,transitionOpacityEnabled:!1};this._quadTreeStrategy=new this.planet.quadTreeStrategyPrototype(e),this._quadTreeStrategy.init(this.camera),this._quadTreeStrategy.preRender(),this._quadTreeStrategy.clearRenderedNodes(),this._skipPreRender=!1,this._quadTreeStrategy.preLoad()}}get framebuffer(){if(this._frameHandler)return this._frameHandler.frameBuffer}getCartesianFromPixelTerrain(l,e){if(this._frameHandler){let t=this._frameHandler.frameBuffer,s=this._frameHandler.camera,n=function(h,c,d,u){let _=new O(h,c),f=_.x/u.width,v=(u.height-_.y)/u.height,g=new Float32Array(4),y=0;if(u.readData(f,v,g,0),g[0]===0)return 0;let p=g[0],x=d.frustums[0].inverseProjectionMatrix,T=new J(2*f-1,2*v-1,2*p-1,1),w=x.mulVec4(T),C=d.unproject(f*d.width,(1-v)*d.height);return y=-w.z/w.w/C.dot(d.getForward()),y}(l,e,s,t);if(n===0)return;let o=l/t.width,a=(t.height-e)/t.height;return s.unproject(o*s.width,(1-a)*s.height).scaleTo(n).addA(s.eye)}}getLonLatFromPixelTerrain(l,e){if(this.planet){let t=this.getCartesianFromPixelTerrain(l,e);if(t)return this.planet.ellipsoid.cartesianToLonLat(t)}}activate(){super.activate()}deactivate(){super.deactivate()}},CameraFrameComposer:Ir,CameraFrameHandler:Kn,CameraLock:Zn,CompassButton:Fo,Control:Z,DebugInfo:class extends Z{constructor(l={}){l.name&&l.name!==""||(l.name="DebugInfo"),super(l),this.el=null,this._watch=l.watch||[],this._toggleBtn=new ct({classList:["og-map-button","og-debuginfo_button"],icon:`<?xml version="1.0" encoding="iso-8859-1"?>
<!-- Uploaded to: SVG Repo, www.svgrepo.com, Generator: SVG Repo Mixer Tools -->
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg fill="#000000" version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" 
	 width="800px" height="800px" viewBox="0 0 932.179 932.179"
	 xml:space="preserve">
<g>
	<path d="M61.2,341.538c4.9,16.8,11.7,33,20.3,48.2l-24.5,30.9c-8,10.1-7.1,24.5,1.9,33.6l42.2,42.2c9.1,9.1,23.5,9.899,33.6,1.899
		l30.7-24.3c15.8,9.101,32.6,16.2,50.1,21.2l4.6,39.5c1.5,12.8,12.3,22.4,25.1,22.4h59.7c12.8,0,23.6-9.601,25.1-22.4l4.4-38.1
		c18.8-4.9,36.8-12.2,53.7-21.7l29.7,23.5c10.1,8,24.5,7.1,33.6-1.9l42.2-42.2c9.1-9.1,9.9-23.5,1.9-33.6l-23.1-29.3
		c9.6-16.601,17.1-34.3,22.1-52.8l35.6-4.1c12.801-1.5,22.4-12.3,22.4-25.1v-59.7c0-12.8-9.6-23.6-22.4-25.1l-35.1-4.1
		c-4.801-18.3-12-35.8-21.199-52.2l21.6-27.3c8-10.1,7.1-24.5-1.9-33.6l-42.1-42.1c-9.1-9.1-23.5-9.9-33.6-1.9l-26.5,21
		c-17.2-10.1-35.601-17.8-54.9-23l-4-34.3c-1.5-12.8-12.3-22.4-25.1-22.4h-59.7c-12.8,0-23.6,9.6-25.1,22.4l-4,34.3
		c-19.8,5.3-38.7,13.3-56.3,23.8l-27.5-21.8c-10.1-8-24.5-7.1-33.6,1.9l-42.2,42.2c-9.1,9.1-9.9,23.5-1.9,33.6l23,29.1
		c-9.2,16.6-16.2,34.3-20.8,52.7l-36.8,4.2c-12.8,1.5-22.4,12.3-22.4,25.1v59.7c0,12.8,9.6,23.6,22.4,25.1L61.2,341.538z
		 M277.5,180.038c54.4,0,98.7,44.3,98.7,98.7s-44.3,98.7-98.7,98.7c-54.399,0-98.7-44.3-98.7-98.7S223.1,180.038,277.5,180.038z"/>
	<path d="M867.699,356.238l-31.5-26.6c-9.699-8.2-24-7.8-33.199,0.9l-17.4,16.3c-14.699-7.1-30.299-12.1-46.4-15l-4.898-24
		c-2.5-12.4-14-21-26.602-20l-41.1,3.5c-12.6,1.1-22.5,11.4-22.9,24.1l-0.799,24.4c-15.801,5.7-30.701,13.5-44.301,23.3
		l-20.799-13.8c-10.602-7-24.701-5-32.9,4.7l-26.6,31.7c-8.201,9.7-7.801,24,0.898,33.2l18.201,19.399
		c-6.301,14.2-10.801,29.101-13.4,44.4l-26,5.3c-12.4,2.5-21,14-20,26.601l3.5,41.1c1.1,12.6,11.4,22.5,24.1,22.9l28.1,0.899
		c5.102,13.4,11.801,26.101,19.9,38l-15.699,23.7c-7,10.6-5,24.7,4.699,32.9l31.5,26.6c9.701,8.2,24,7.8,33.201-0.9l20.6-19.3
		c13.5,6.3,27.699,11,42.299,13.8l5.701,28.2c2.5,12.4,14,21,26.6,20l41.1-3.5c12.6-1.1,22.5-11.399,22.9-24.1l0.9-27.601
		c15-5.3,29.199-12.5,42.299-21.399l22.701,15c10.6,7,24.699,5,32.9-4.7l26.6-31.5c8.199-9.7,7.799-24-0.9-33.2l-18.301-19.399
		c6.701-14.2,11.602-29.2,14.4-44.601l25-5.1c12.4-2.5,21-14,20-26.601l-3.5-41.1c-1.1-12.6-11.4-22.5-24.1-22.9l-25.1-0.8
		c-5.201-14.6-12.201-28.399-20.9-41.2l13.699-20.6C879.4,378.638,877.4,364.438,867.699,356.238z M712.801,593.837
		c-44.4,3.801-83.602-29.3-87.301-73.699c-3.801-44.4,29.301-83.601,73.699-87.301c44.4-3.8,83.602,29.301,87.301,73.7
		C790.301,550.938,757.199,590.138,712.801,593.837z"/>
	<path d="M205,704.438c-12.6,1.3-22.3,11.899-22.4,24.6l-0.3,25.3c-0.2,12.7,9.2,23.5,21.8,25.101l18.6,2.399
		c3.1,11.301,7.5,22.101,13.2,32.301l-12,14.8c-8,9.899-7.4,24.1,1.5,33.2l17.7,18.1c8.9,9.1,23.1,10.1,33.2,2.3l14.899-11.5
		c10.5,6.2,21.601,11.101,33.2,14.5l2,19.2c1.3,12.6,11.9,22.3,24.6,22.4l25.301,0.3c12.699,0.2,23.5-9.2,25.1-21.8l2.3-18.2
		c12.601-3.101,24.601-7.8,36-14l14,11.3c9.9,8,24.101,7.4,33.201-1.5l18.1-17.7c9.1-8.899,10.1-23.1,2.301-33.2L496.6,818.438
		c6.6-11,11.701-22.7,15.201-35l16.6-1.7c12.6-1.3,22.299-11.9,22.4-24.6l0.299-25.301c0.201-12.699-9.199-23.5-21.799-25.1
		l-16.201-2.1c-3.1-12.2-7.699-24-13.699-35l10.1-12.4c8-9.9,7.4-24.1-1.5-33.2l-17.699-18.1c-8.9-9.101-23.102-10.101-33.201-2.3
		l-12.101,9.3c-11.399-6.9-23.6-12.2-36.399-15.8l-1.601-15.7c-1.3-12.601-11.899-22.3-24.6-22.4l-25.3-0.3
		c-12.7-0.2-23.5,9.2-25.101,21.8l-2,15.601c-13.199,3.399-25.899,8.6-37.699,15.399l-12.5-10.2c-9.9-8-24.101-7.399-33.201,1.5
		l-18.2,17.801c-9.1,8.899-10.1,23.1-2.3,33.199l10.7,13.801c-6.2,11-11.1,22.699-14.3,35L205,704.438z M368.3,675.837
		c36.3,0.4,65.399,30.301,65,66.601c-0.4,36.3-30.301,65.399-66.601,65c-36.3-0.4-65.399-30.3-65-66.601
		C302.1,704.538,332,675.438,368.3,675.837z"/>
</g>
</svg>`}),this._dialog=new Zt({title:"Debug Info",visible:!1,useHide:!0,top:120,left:60,width:480}),this._dialog.events.on("visibility",e=>{this._toggleBtn.setActive(e)}),this._canvasTiles=new es("Tile grid",{visibility:!0,isBaseLayer:!1,hideInLayerSwitcher:!0,drawTile:function(e,t){let s,n=document.createElement("canvas"),o=n.getContext("2d");n.width=256,n.height=256,o.clearRect(0,0,n.width,n.height),o.beginPath(),o.rect(0,0,n.width,n.height),o.lineWidth=2,o.strokeStyle="black",o.stroke(),s=e.segment.tileZoom>14?"26":"32",o.fillStyle="black",o.font="normal "+s+"px Verdana",o.textAlign="center",o.fillText(e.segment.tileX+","+e.segment.tileY+","+e.segment.tileZoom,n.width/2,n.height/2),t(n)}})}addWatches(l){for(let e=0;e<l.length;e++)this.addWatch(l[e])}addWatch(l){this._watch.push(l);let e=document.createElement("div");e.classList.add("og-watch-line"),e.innerHTML=`<div class="og-watch-label">${l.label}</div><div class="og-watch-value"></div>`,l.valEl=e.querySelector(".og-watch-value"),this.el.appendChild(e)}oninit(){var l;this._toggleBtn.appendTo(this.renderer.div),this._dialog.appendTo(this.renderer.div),this._toggleBtn.events.on("change",a=>{this._dialog.setVisibility(a)}),this.el=document.createElement("div"),this.el.className="og-debug-info";let e=document.createElement("div");e.classList.add("og-debuginfo_controls"),this.el.appendChild(e);let t=this._watch;this._watch=[];for(let a=0;a<t.length;a++)this.addWatch(t[a]);(l=this._dialog.container)==null||l.appendChild(this.el),this.renderer.events.on("draw",this._frame,this);let s=this.planet;s&&this.addWatches([{label:"Nodes count",frame:()=>s.quadTreeStrategy._renderedNodes.length},{label:"Planet._fadingNodes",frame:()=>s.quadTreeStrategy._fadingNodes.size},{label:"createdNodes",frame:()=>s._createdNodesCount},{label:"indexesCache",frame:()=>s._indexesCacheToRemoveCounter},{label:"distBeforeMemClear",frame:()=>Math.round(s._distBeforeMemClear)},{label:"maxZoom/minZoom",frame:()=>s.quadTreeStrategy.maxCurrZoom+" / "+(s==null?void 0:s.quadTreeStrategy.minCurrZoom)},{label:"viewExtent",frame:()=>s.getViewExtent().toString()},{label:"Mouse distance, m",frame:()=>{let a=s.getCartesianFromMouseTerrain();return a?s.camera.eye.distance(a).toFixed(3):""}},{label:"lodSize",frame:()=>Math.round(s.quadTreeStrategy.lodSize)},{label:"deltaTime/FPS",frame:()=>`<div style="width:70px"><div style="width:20px; float: left;">
                        ${Math.round(s.renderer.handler.deltaTime)}
                        </div> <div style="float: left">
                        ${Math.round(1e3/s.renderer.handler.deltaTime)}
                        </div></div>`},{label:"-------------------------"},{label:"Pitch, deg",frame:()=>(s.camera.getPitch()*Q).toFixed(2)},{label:"Yaw, deg",frame:()=>(s.camera.getYaw()*Q).toFixed(2)},{label:"Roll, deg",frame:()=>(s.camera.getRoll()*Q).toFixed(2)},{label:"Lon, Lat",frame:()=>`<div style="width:190px">${s.camera._lonLat.lon.toFixed(7)}, ${s.camera._lonLat.lon.toFixed(7)}</div>`},{label:"height/alt, m",frame:()=>`<div style="width:190px">${s.camera._lonLat.height.toFixed(2)+" / "+s.camera.getAltitude().toFixed(2)}</div>`},{label:"cam.slope",frame:()=>s.camera.slope.toFixed(3)},{label:"-------------------------"},{label:"_renderCompleted / renderCompletedActivated",frame:()=>`${s.quadTreeStrategy._renderCompleted} / ${s.quadTreeStrategy._renderCompletedActivated}`},{label:"_terrainCompleted / terrainCompletedActivated",frame:()=>`${s.quadTreeStrategy._terrainCompleted} / ${s.quadTreeStrategy._terrainCompletedActivated}`},{label:"PlainWorker",frame:()=>s._plainSegmentWorker.pendingQueue.length},{label:"TileLoader",frame:()=>`${s._tileLoader.loading} ${s._tileLoader.queue.length}`},{label:"TerrainLoader",frame:()=>s.terrain&&!s.terrain.isEmpty?`${s.terrain.loader.loading}  ${s.terrain.loader.queue.length}`:""},{label:"TerrainWorker",frame:()=>s._terrainWorker.pendingQueue.length},{label:"NormalMapCreator",frame:()=>s._normalMapCreator.queueSize},{label:"VectorTileCreator",frame:()=>s._vectorTileCreator.queueSize}]);let n=new ct({classList:["og-debuginfo_controls-button"],icon:`<?xml version="1.0" encoding="utf-8"?>
<!-- Uploaded to: SVG Repo, www.svgrepo.com, Generator: SVG Repo Mixer Tools -->
<svg fill="#000000" width="800px" height="800px" viewBox="-7.5 0 32 32" version="1.1" xmlns="http://www.w3.org/2000/svg">
<title>lock</title>
<path d="M14.625 15.156h2.094c0.281 0 0.5 0.25 0.5 0.531v11c0 0.281-0.219 0.5-0.5 0.5h-16.219c-0.281 0-0.5-0.219-0.5-0.5v-11c0-0.281 0.219-0.531 0.5-0.531h2.031v-5.125c0-2.875 1.844-5.25 4.688-5.25h2.688c2.875 0 4.719 2.375 4.719 5.25v5.125zM5.188 15.156h6.813v-4.875c0-1.594-1.313-2.938-2.938-2.938h-0.969c-1.594 0-2.906 1.344-2.906 2.938v4.875zM7.156 24h2.906l-0.719-3.156c0.5-0.25 0.844-0.781 0.844-1.375 0-0.906-0.719-1.594-1.594-1.594s-1.563 0.688-1.563 1.594c0 0.594 0.344 1.125 0.844 1.375z"></path>
</svg>`,title:"Lock/Unlock quad tree"});n.appendTo(e),n.events.on("change",a=>{a?s.lockQuadTree():s.unlockQuadTree()});let o=new ct({classList:["og-debuginfo_controls-button"],icon:`<?xml version="1.0"?>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
    <path d="M 4 4 L 4 8 L 8 8 L 8 4 L 4 4 z M 10 4 L 10 8 L 14 8 L 14 4 L 10 4 z M 16 4 L 16 8 L 20 8 L 20 4 L 16 4 z M 4 10 L 4 14 L 8 14 L 8 10 L 4 10 z M 10 10 L 10 14 L 14 14 L 14 10 L 10 10 z M 16 10 L 16 14 L 20 14 L 20 10 L 16 10 z M 4 16 L 4 20 L 8 20 L 8 16 L 4 16 z M 10 16 L 10 20 L 14 20 L 14 16 L 10 16 z M 16 16 L 16 20 L 20 20 L 20 16 L 16 16 z"/>
</svg>`,title:"Show/Hide grid"});o.appendTo(e),o.events.on("change",a=>{a?this.planet.addLayer(this._canvasTiles):this._canvasTiles.remove()})}_frame(){this._watch.forEach(l=>{l.valEl&&(l.valEl.innerHTML=l.frame?String(l.frame()):"")})}},DrawingControl:Rn,DrawingSwitcher:class extends Z{constructor(l={}){super({name:"DrawingSwitcher",...l}),this.drawingControl=new Rn(l)}oninit(){this.planet.addControl(this.drawingControl),this._createMenu()}onactivate(){this.drawingControl.activate()}ondeactivate(){this.drawingControl.deactivate()}_createMenu(){let l=new ct({classList:["og-map-button","og-drawing-default_button"],icon:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M4 0l16 12.279-6.951 1.17 4.325 8.817-3.596 1.734-4.35-8.879-5.428 4.702z"/></svg>',name:"default",isActive:!0}),e=new ct({classList:["og-map-button","og-drawing-polygon_button"],icon:`<?xml version="1.0" encoding="utf-8"?>
<!-- Generator: Adobe Illustrator 24.1.3, SVG Export Plug-In . SVG Version: 6.00 Build 0)  -->
<svg version="1.1" id="Layer_2" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 viewBox="0 0 1024 1024" style="enable-background:new 0 0 1024 1024;" xml:space="preserve">
<g>
	<path d="M926.03,321.16c-16.02,0-31.11,3.94-44.48,10.79l-263.43-191.4c2.69-8.94,4.18-18.4,4.18-28.2
		c0-54.02-43.95-97.97-97.97-97.97c-54.03,0-97.98,43.95-97.98,97.97c0,9.81,1.49,19.27,4.18,28.21L155.75,340.18
		c-16.22-11.91-36.16-19.03-57.78-19.03C43.95,321.16,0,365.11,0,419.13c0,52.58,41.67,95.5,93.71,97.75l102.63,315.86
		c-24.28,17.85-40.13,46.52-40.13,78.9c0,54.02,43.95,97.98,97.98,97.98c37.54,0,70.18-21.25,86.62-52.34h367.26
		c16.44,31.08,49.08,52.34,86.63,52.34c54.03,0,97.98-43.95,97.98-97.98c0-32.46-15.94-61.21-40.33-79.05l104.11-320.4
		c39.15-12.84,67.54-49.68,67.54-93.07C1024,365.11,980.05,321.16,926.03,321.16z M828.05,911.65c0,8.5-3.3,16.19-8.55,22.09
		c-6.11,6.85-14.9,11.26-24.79,11.26c-13.65,0-25.37-8.26-30.52-20.02c-1.79-4.09-2.82-8.58-2.82-13.33
		c0-18.39,14.95-33.35,33.34-33.35c2.93,0,5.72,0.5,8.43,1.21c13.27,3.49,23.21,14.91,24.59,28.9
		C827.83,909.5,828.05,910.54,828.05,911.65z M790.48,813.89c-45.63,1.96-83.27,35.16-91.87,78.77H350.28
		c-8.62-43.69-46.38-76.93-92.11-78.79L155.59,498.19c24.41-17.84,40.36-46.59,40.36-79.06c0-8.9-1.3-17.49-3.53-25.7L468.57,192.8
		c15.84,11.01,35.05,17.52,55.76,17.52c20.71,0,39.92-6.5,55.76-17.52l256.56,186.4c-5.48,12.21-8.59,25.7-8.59,39.93
		c0,41.02,25.36,76.17,61.21,90.75L790.48,813.89z M254.19,945c-10.11,0-19.07-4.62-25.19-11.75c-5.01-5.84-8.15-13.32-8.15-21.6
		c0-0.91,0.2-1.76,0.27-2.66c1.14-14.18,11.08-25.8,24.43-29.41c2.78-0.75,5.64-1.28,8.65-1.28c18.38,0,33.33,14.96,33.33,33.35
		c0,4.74-1.03,9.24-2.82,13.33C279.55,936.74,267.83,945,254.19,945z M64.88,421.49c-0.06-0.79-0.24-1.55-0.24-2.35
		c0-16.41,11.93-30.01,27.55-32.76c1.89-0.33,3.8-0.58,5.78-0.58c11.94,0,22.35,6.36,28.24,15.81c3.18,5.11,5.11,11.09,5.11,17.53
		c0,15.47-10.63,28.39-24.94,32.14c-2.7,0.71-5.48,1.2-8.4,1.2C80.4,452.47,66.11,438.76,64.88,421.49z M549.41,90.62
		c5.07,5.85,8.25,13.39,8.25,21.72c0,7.32-2.44,14.03-6.45,19.54c-6.07,8.33-15.82,13.81-26.88,13.81
		c-11.07,0-20.83-5.48-26.89-13.81c-4.01-5.51-6.45-12.22-6.45-19.54c0-8.33,3.17-15.86,8.24-21.71
		c6.12-7.07,15.04-11.64,25.1-11.64C534.38,79,543.29,83.57,549.41,90.62z M959.36,419.13c0,11.94-6.36,22.35-15.82,28.24
		c-5.1,3.18-11.07,5.1-17.52,5.1c-6.08,0-11.71-1.76-16.62-4.61c-9.71-5.64-16.33-15.94-16.64-27.89c-0.01-0.29-0.09-0.56-0.09-0.85
		c0-11.75,6.14-22.05,15.36-28c5.2-3.35,11.35-5.35,17.99-5.35C944.41,385.78,959.36,400.75,959.36,419.13z"/>
</g>
</svg>`,name:"polygon"}),t=new ct({classList:["og-map-button","og-drawing-linestring_button"],icon:`<?xml version="1.0" encoding="utf-8"?><!-- License: MIT. Made by Esri: https://github.com/Esri/calcite-ui-icons -->
    <svg width="800px" height="800px" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M21 6h.046l-5.25 9h-.944L10 9.455V7H7v2.926L1.862 18H0v3h3v-2.926L8.138 10h1.01L14 15.545V18h3v-3h-.046l5.25-9H24V3h-3zM8 8h1v1H8zM2 20H1v-1h1zm14-3h-1v-1h1zm7-13v1h-1V4z"/></svg>`,name:"linestring"});new Vo({buttons:[l,e,t]}).events.on("change",s=>{switch(this.drawingControl.deactivate(),s.name){case"polygon":this.drawingControl.activatePolygonDrawing();break;case"linestring":this.drawingControl.activateLineStringDrawing()}}),l.appendTo(this.renderer.div),e.appendTo(this.renderer.div),t.appendTo(this.renderer.div)}},EarthCoordinates:la,ElevationProfileControl:class extends Z{constructor(l={}){super({name:"ElevationProfileControl",...l}),this._onSceneChange=()=>{this._collectProfileThrottled()},this._onElevationProfilePointer=(e,t,s,n,o,a,h,c)=>{let d=this._elevationProfileScene.getPointLonLat(a),u=this._elevationProfileScene.getPointLonLat(a+1),_=this.planet.ellipsoid.lonLatToCartesian(d),f=this.planet.ellipsoid.lonLatToCartesian(u),v=(e-t[0])/(s[0]-t[0]),g=f.sub(_);this._elevationProfileScene.setPointerCartesian3v(_.add(g.scale(v)),c)},this._onElevationProfileDblClick=(e,t,s,n,o,a,h,c)=>{let d=this._elevationProfileScene.getPointLonLat(a),u=this._elevationProfileScene.getPointLonLat(a+1),_=this.planet.ellipsoid.lonLatToCartesian(d),f=this.planet.ellipsoid.lonLatToCartesian(u),v=(e-t[0])/(s[0]-t[0]),g=f.sub(_),y=_.add(g.scale(v));this.planet.camera.flyDistance(y,this.planet.camera.eye.distance(y))},this._onElevationProfileMouseEnter=()=>{this._elevationProfileView.model.pointsReady&&this._elevationProfileScene.setPointerVisibility(!0)},this._onElevationProfileMouseLeave=()=>{},this._elevationProfileScene=new th,this._elevationProfileView=new Yl,this._elevationProfileLegend=new nh,this._elevationProfileButtonsView=new sh({model:this._elevationProfileView.model}),this._elevationProfileView.events.on("pointer",this._onElevationProfilePointer),this._elevationProfileView.events.on("dblclick",this._onElevationProfileDblClick),this._elevationProfileView.events.on("mouseenter",this._onElevationProfileMouseEnter),this._elevationProfileView.events.on("mouseleave",this._onElevationProfileMouseLeave),this._dialog=new Zt({title:"Elevation Profile",visible:!1,resizable:!0,useHide:!0,top:175,left:65,width:400,height:200,minHeight:100,minWidth:100}),this._graphView=new dt({template:`<div class="og-elevationprofile__container">
      <div class="og-elevationprofile__menu"></div>
      <div class="og-elevationprofile__graph"></div>
    </div>`}),this._poiListDialog=new rh({model:this._elevationProfileScene}),this._toggleBtn=new ct({classList:["og-map-button","og-elevationprofile_button"],icon:'<svg style="width: 2em; height: 2em;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"><path d="M128 896v-158.293333l331.946667-191.573334 160.853333 93.866667L896 480V896H128M896 381.44l-275.2 159.146667-160.853333-92.586667L128 640v-94.293333l331.946667-191.573334 160.853333 93.866667L896 288v93.44z" fill="" /></svg>'}),this._collectProfileThrottled=vi(()=>{let e=this._elevationProfileScene.getPointsLonLat();this._elevationProfileView.model.collectProfile(e)},250)}oninit(){this._dialog.appendTo(this.planet.renderer.div),this._graphView.appendTo(this._dialog.container),this._toggleBtn.appendTo(this.renderer.div),this._dialog.events.on("visibility",l=>{this._toggleBtn.setActive(l),l?(this.activate(),this._elevationProfileView.resize()):this.deactivate()}),this._toggleBtn.events.on("change",l=>{this._dialog.setVisibility(l)}),this._elevationProfileView.appendTo(this._graphView.select(".og-elevationprofile__graph")),this._elevationProfileView.model.bindPlanet(this.planet),this._elevationProfileView.model.events.on("clear",()=>{this._elevationProfileScene.clear(),this._elevationProfileLegend.clear()}),this._elevationProfileView.model.events.on("startcollecting",()=>{this._elevationProfileScene.setPointerVisibility(!1)}),this._elevationProfileView.events.on("tracklength",l=>{this._elevationProfileLegend.setTrackLength(l)}),this._elevationProfileView.events.on("groundlength",l=>{this._elevationProfileLegend.setGroundLength(l)}),this._elevationProfileView.events.on("warninglength",l=>{this._elevationProfileLegend.setWarningLength(l)}),this._elevationProfileView.events.on("collisionlength",l=>{this._elevationProfileLegend.setCollisionLength(l)}),this._poiListDialog.appendTo(this.planet.renderer.div),this._poiListDialog.events.on("visibility",l=>{this._elevationProfileButtonsView.pointListBtn.setActive(l,!0)}),this._elevationProfileLegend.appendTo(this._graphView.select(".og-elevationprofile__menu")),this._elevationProfileButtonsView.appendTo(this._graphView.select(".og-elevationprofile__menu")),this._elevationProfileButtonsView.events.on("list",l=>{this._poiListDialog.setVisibility(l)}),this._elevationProfileButtonsView.events.on("location",l=>{this._elevationProfileScene.flyExtent()}),this._elevationProfileButtonsView.events.on("reset",l=>{this._elevationProfileScene.setPointerVisibility(!1)}),this._elevationProfileScene.events.on("change",this._onSceneChange)}onactivate(){this.planet&&this._elevationProfileScene.bindPlanet(this.planet),this.renderer&&this.renderer.addNode(this._elevationProfileScene)}ondeactivate(){this._poiListDialog.setVisibility(!1),this._elevationProfileView.model.clear(),this.renderer&&this.renderer.removeNode(this._elevationProfileScene),this._dialog.hide()}},FramebufferPreview:class extends Z{constructor(l){super({autoActivate:!0,...l}),this._onDraw=()=>{if(this._framebuffer&&this._screenFramebuffer){let e=this.renderer,t=e.handler.gl;t.disable(t.BLEND),this._screenFramebuffer.activate();let s=this._program._programController,n=s._program;t.bindBuffer(t.ARRAY_BUFFER,e.screenFramePositionBuffer),t.vertexAttribPointer(n.attributes.corners,2,t.FLOAT,!1,0,0),s.activate(),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,this._framebuffer.textures[this.framebufferCurrentTexture]),t.uniform1i(n.uniforms.inputTexture,0),t.drawArrays(t.TRIANGLE_STRIP,0,4),this._screenFramebuffer.deactivate(),t.enable(t.BLEND),this._screenFramebuffer.readPixelBuffersAsync(o=>{let a=o.getPixelBufferData();if(a){let h=o.width,c=o.height,d=this.$canvas.getContext("2d"),u=new Uint8ClampedArray(a.buffer,a.byteOffset,a.byteLength),_=new ImageData(u,h,c);createImageBitmap(_).then(f=>{d.clearRect(0,0,this.$canvas.width,this.$canvas.height),d.drawImage(f,0,0,this.$canvas.width,this.$canvas.height)})}})}},this._dialog=new Zt({title:l.title||"",width:580,height:340,left:100,top:100}),this.$canvas=function(e,t){let s=document.createElement("canvas");return s.width=e,s.height=t,s.style.position="absolute",s.style.width="100%",s.style.height="100%",s}(this._dialog.width,this._dialog.height),this._framebuffer=l.framebuffer||null,this._screenFramebuffer=null,this.framebufferCurrentTexture=0,this._program=function(e=0,t,s,n){return new $(`framebuffer_dialog_screen:${e.toString()}`,{uniforms:{inputTexture:"sampler2D"},attributes:{corners:"vec2"},vertexShader:`#version 300 es
            
            in vec2 corners;
            
            out vec2 tc;

            void main(void) {
                gl_Position = vec4(corners, 0.0, 1.0);
                tc = corners * 0.5 + 0.5;
                ${n?"tc.y = 1.0 - tc.y;":""}               
            }`,fragmentShader:`#version 300 es

            precision highp float;

            uniform sampler2D inputTexture;
           
            in vec2 tc;

            layout(location = 0) out vec4 fragColor;

            ${t||""}
            
            ${s||`void mainImage(out vec4 fragColor, in vec2 fragCoord) { 
                fragColor = texture(inputTexture, fragCoord);
            }`}
            
            void main(void) {                              
               mainImage(fragColor, tc);
            }`})}(this.__id,l.common,l.image,l.flippedUV)}bindFramebuffer(l){l.isEqual(this._framebuffer)||(this._framebuffer=l)}oninit(){var l,e;super.oninit(),this.renderer&&(this.renderer.handler.addProgram(this._program),this._screenFramebuffer=new St(this.renderer.handler,{width:(l=this._framebuffer)==null?void 0:l.width,height:(e=this._framebuffer)==null?void 0:e.height,useDepth:!1,targets:[{internalFormat:"RGBA",type:"UNSIGNED_BYTE",attachment:"COLOR_ATTACHMENT",readAsync:!0}]}),this._screenFramebuffer.init())}activate(){var l,e;super.activate(),this._dialog.appendTo(document.body),(l=this._dialog.container)==null||l.appendChild(this.$canvas),(e=this.renderer)==null||e.events.on("draw",this._onDraw)}deactivate(){var l;super.deactivate(),this._dialog.remove(),(l=this.renderer)==null||l.events.off("draw",this._onDraw)}},GeoImageDragControl:class extends Z{constructor(l={}){super(l),this._cornerIndex=-1,this._catchCorner=!1,this._toggleBtn=new ct({classList:["og-map-button","og-geoimagegrag_button"],icon:'<?xml version="1.0" encoding="UTF-8" standalone="no"?> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path d="M16 13l6.964 4.062-2.973.85 2.125 3.681-1.732 1-2.125-3.68-2.223 2.15L16 13zm-2-7h2v2h5a1 1 0 0 1 1 1v4h-2v-3H10v10h4v2H9a1 1 0 0 1-1-1v-5H6v-2h2V9a1 1 0 0 1 1-1h5V6zM4 14v2H2v-2h2zm0-4v2H2v-2h2zm0-4v2H2V6h2zm0-4v2H2V2h2zm4 0v2H6V2h2zm4 0v2h-2V2h2zm4 0v2h-2V2h2z" fill="#000"/></svg>'})}oninit(){this._toggleBtn.appendTo(this.renderer.div),this.planet.events.on("layeradd",l=>{this.isActive()&&this._bindLayer(l)},this),this._toggleBtn.events.on("change",l=>{l?this.activate():this.deactivate()})}onactivate(){super.onactivate();const l=this.planet;for(let e=0;e<l.layers.length;e++)this._bindLayer(l.layers[e])}ondeactivate(){super.ondeactivate();const l=this.planet;for(let e=0;e<l.layers.length;e++)this._unbindLayer(l.layers[e])}_bindLayer(l){l instanceof Ei&&(l.events.on("mousemove",this._onMouseMove,this),l.events.on("mouseleave",this._onMouseLeave,this),l.events.on("ldown",this._onLDown,this),l.events.on("lup",this._onLUp,this))}_unbindLayer(l){l instanceof Ei&&(l.events.off("mousemove",this._onMouseMove),l.events.off("mouseleave",this._onMouseLeave),l.events.off("ldown",this._onLDown),l.events.off("lup",this._onLUp))}_onLUp(l){this._catchCorner=!1,l.renderer.controls.mouseNavigation.activate()}_onLDown(l){this._cornerIndex!==-1&&(this._catchCorner=!0,l.renderer.controls.mouseNavigation.deactivate())}_onMouseLeave(){document.body.style.cursor="auto"}_onMouseMove(l){let e=l.pickingObject;const t=this.planet;if(this._catchCorner){let s=e.getCornersLonLat();s[this._cornerIndex]=t.getLonLatFromPixelTerrain(l),e.setCornersLonLat(s)}else{this._cornerIndex=-1;for(let s=0;s<e._cornersWgs84.length;s++){let n=t.getLonLatFromPixelTerrain(l);if(n&&t.ellipsoid.getGreatCircleDistance(e._cornersWgs84[s],n)/t.getDistanceFromPixel(l)<=.05){this._cornerIndex=s,document.body.style.cursor="move";break}document.body.style.cursor="auto"}}}},GeoObjectEditor:class extends Z{constructor(l={}){super(l),this._geoObjectEditopScene=new _h({name:`geoObjectEditorScene:${this.__id}`}),this._dialog=new vh({model:this._geoObjectEditopScene})}oninit(){this.renderer&&(this.renderer.addControl(new Zn({planet:this.planet})),this._geoObjectEditopScene.bindPlanet(this.planet),this._dialog.appendTo(this.renderer.div||document.body),this.activate())}onactivate(){this.renderer&&this.renderer.addNode(this._geoObjectEditopScene)}ondeactivate(){this.renderer&&this.renderer.removeNode(this._geoObjectEditopScene),this._dialog.hide()}},HeightRuler:Fn,KeyboardNavigation:class extends Z{constructor(l={}){l=l||{},super({name:"KeyboardNavigation",...l}),this.onCameraPitchUp=()=>{this._camera&&this._camera.setPitch(this._camera.getPitch()+.1*U)},this.onCameraPitchDown=()=>{this._camera&&this._camera.setPitch(this._camera.getPitch()-.1*U)},this.onCameraYawLeft=()=>{this._camera&&this._camera.setYaw(this._camera.getYaw()-.1*U)},this.onCameraYawRight=()=>{this._camera&&this._camera.setYaw(this._camera.getYaw()+.1*U)},this.onCameraMoveForward=()=>{this._camera&&this.force.addA(this._camera.getForward()).normalize()},this.onCameraMoveBackward=()=>{this._camera&&this.force.addA(this._camera.getBackward()).normalize()},this._camera=l.camera||null,this.speed=l.speed||10,this.force=new m,this.vel=new m,this.mass=1}bindCamera(l){this._camera=l}onactivate(){let l=this.renderer;l.events.on("keypress",Y.KEY_S,this.onCameraMoveBackward,this),l.events.on("keypress",Y.KEY_W,this.onCameraMoveForward,this),l.events.on("keypress",Y.KEY_UP,this.onCameraPitchUp,this),l.events.on("keypress",Y.KEY_DOWN,this.onCameraPitchDown,this),l.events.on("keypress",Y.KEY_LEFT,this.onCameraYawLeft,this),l.events.on("keypress",Y.KEY_RIGHT,this.onCameraYawRight,this),l.events.on("draw",this.onDraw,this,-1e3)}ondeactivate(){this.renderer}oninit(){this.activate()}get dt(){return .001*this.renderer.handler.deltaTime}onDraw(){if(this.renderer&&this._camera){let l=this.force.scale(1/this.mass);this.vel.addA(l),this.vel.scale(.96),this.force.set(0,0,0);let e=this._camera;e.eye=e.eye.add(this.vel.scaleTo(this.dt)),e.update()}}},LayerAnimation:class extends Z{constructor(l={}){super(l),this._currVisibleIndex=0,this._onViewchange=()=>{this._timeoutStart=performance.now()},this._onVisibilityChange=e=>{e||this.pause()},this._onLayerLoadend=e=>{let t=this._layersArr[this._currentIndex];if(t&&t.isEqual(e)){let s=this._getFrameIndex(this._currentIndex)*this._frameSize,n=this._currentIndex;for(let a=s;a<n;a++){let h=this._layersArr[a];h.opacity=0,h.setVisibility(!1)}t.opacity=1;let o=this._layersArr[this._currVisibleIndex];if(o){o.opacity=0,o.setVisibility(!1);let a=this._getFrameIndex(this._currVisibleIndex);this._getFrameIndex(this._currentIndex)!==a&&this._removeFrameFromPlanet(a)}this.events.dispatch(this.events.idle,t)}},this.events=ot(bl),this._name=l.name||`layerAnimation-${this.__id}`,this._layersArr=l.layers?[].concat(l.layers):[],this._currentIndex=-1,this._playInterval=l.playInterval||120,this._playIntervalHandler=-1,this._playIndex=0,this._frameSize=l.frameSize||50,this.repeat=l.repeat==null||l.repeat,this.skipTimeout=l.skipTimeout||5e3,this._timeoutStart=0}_getFramesNum(){return Math.ceil(this._layersArr.length/this._frameSize)}_setFrame(l){for(let e=0,t=this._getFramesNum();e<t;e++)e!==l?this._removeFrameFromPlanet(e):this._appendFrameToPlanet(e)}_getFrameIndex(l){return Math.floor(l/this._frameSize)}_appendFrameToPlanet(l){if(this.planet){let e=l*this._frameSize,t=e+this._frameSize;for(let s=e,n=t>this._layersArr.length?this._layersArr.length:t;s<n;s++)this.planet.addLayer(this._layersArr[s])}}_removeFrameFromPlanet(l){if(this.planet){let e=l*this._frameSize,t=e+this._frameSize;for(let s=e,n=t>this._layersArr.length?this._layersArr.length:t;s<n;s++)this._layersArr[s].abortLoading(),this._layersArr[s].remove(),this._layersArr[s].setVisibility(!1)}}oninit(){super.oninit(),this.onactivate(),this._initLayers(),this.planet.events.on("layerloadend",this._onLayerLoadend),this._setCurrentIndexAsync(0,!1,!0)}onactivate(){super.onactivate(),this.planet.camera.events.on("viewchange",this._onViewchange),this.planet.renderer.handler.events.on("visibilitychange",this._onVisibilityChange)}ondeactivate(){super.ondeactivate(),this.planet.camera.events.off("viewchange",this._onViewchange);for(let l=0;l<this._layersArr.length;l++)this._layersArr[l].setVisibility(!1);this.planet.events.off("layerloadend",this._onLayerLoadend),this.planet.renderer.handler.events.off("visibilitychange",this._onVisibilityChange)}clear(){this.stop(),this._currentIndex=-1,this._currVisibleIndex=-1;let l=this._layersArr;this._layersArr=[];for(let e=0;e<l.length;e++)l[e].remove()}_initLayers(){if(this.planet){for(let l=0,e=this._layersArr.length;l<e;l++){let t=this._layersArr[l];t.setVisibility(!1),t.setBaseLayer(!1),t.opacity=0}this._appendFrameToPlanet(0)}}setLayers(l){this.clear(),this._layersArr=[].concat(l),this._initLayers()}appendLayer(l){var e;this._layersArr.push(l),l.setVisibility(!1),l.setBaseLayer(!1),l.opacity=0,(e=this.planet)==null||e.addLayer(l)}get isIdle(){let l=this._layersArr[this._currentIndex];return l&&l.isIdle||!l}get playInterval(){return this._playInterval}set playInterval(l){l!==this._playInterval&&(this._playInterval=l,this.isPlaying&&(this.pause(),this.play()))}get isPlaying(){return this._playIntervalHandler!==-1}get layers(){return this._layersArr}_checkEnd(){this._playIndex>this._layersArr.length&&(this.repeat?this._playIndex=0:this.pause())}play(){this.isPlaying||(this._currentIndex>=this._layersArr.length-1&&this.stop(),this._timeoutStart=performance.now(),this._playIntervalHandler=setInterval(()=>{this._checkEnd(),this._setCurrentIndexAsync(this._playIndex,!1,!1),requestAnimationFrame(()=>{(this.isIdle||performance.now()-this._timeoutStart>this.skipTimeout)&&(this._playIndex++,this._timeoutStart=performance.now())})},this._playInterval),this.events.dispatch(this.events.play))}stop(){this._playIndex>0&&(this._clearInterval(),this._playIndex=0,this.setCurrentIndex(0),this.events.dispatch(this.events.stop))}pause(){this.isPlaying&&(this._clearInterval(),this.events.dispatch(this.events.pause))}_clearInterval(){clearInterval(this._playIntervalHandler),this._playIntervalHandler=-1}setCurrentIndex(l,e=!1){this._setCurrentIndexAsync(l,!0,e)}_setCurrentIndexAsync(l,e=!1,t=!1){if(l!=this._currentIndex&&l>=0&&l<this._layersArr.length){let s=this._currentIndex;this._currentIndex=l,this._playIndex=l;let n=this._getFrameIndex(s),o=this._getFrameIndex(this._currentIndex),a=this._layersArr[s],h=this._layersArr[l],c=o!=n;c&&this._appendFrameToPlanet(o),a&&(a.isIdle?this._currVisibleIndex=s:(a.opacity=0,a.setVisibility(!1))),h&&(h.opacity=0,h.setVisibility(!0),requestAnimationFrame(()=>{if(h.isIdle||e){h.opacity=1,c&&this._removeFrameFromPlanet(n),a&&(a.opacity=0,a.setVisibility(!1));let d=this._layersArr[this._currVisibleIndex];d&&(d.opacity=0,d.setVisibility(!1))}}),t||this.events.dispatch(this.events.change,this._currentIndex,s))}}},LayerSwitcher:class extends Z{constructor(l={}){super({name:"LayerSwitcher",...l}),this.addLayer=e=>{if(!e.hideInLayerSwitcher){let t=this._createLayerButton(e);this._layerViews.push(t),e.isBaseLayer()?t.appendTo(this.$baseLayers):t.appendTo(this.$overlays)}},this.removeLayer=e=>{for(let t=0;t<this._layerViews.length;t++){let s=this._layerViews[t];if(s.model.isEqual(e)){s.remove(),this._layerViews.splice(t,1);break}}},this._dialog=new Zt({title:"Layer Switcher",top:15,useHide:!0,visible:!1,width:300,maxHeight:500}),this._panel=new dt({template:`<div class="og-layerSwitcher">
      <div class="og-layerSwitcher__title">Base Layers</div>
      <div class="og-layerSwitcher__list og-layerSwitcher__baseLayers"></div>        
        
      <div class="og-layerSwitcher__title">Overlays</div>
      <div class="og-layerSwitcher__list og-layerSwitcher__overlays"></div>
         
    </div>`}),this._toggleBtn=new ct({classList:["og-map-button","og-layerSwitcher_button"],icon:`<?xml version="1.0" encoding="utf-8"?>
<!-- Svg Vector Icons : http://www.onlinewebfonts.com/icon -->
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 1000 1000" enable-background="new 0 0 1000 1000" xml:space="preserve">
<metadata> Svg Vector Icons : http://www.onlinewebfonts.com/icon </metadata>
<g><path d="M500,573.5c-3.2,0-6.5-0.6-9.5-1.9L25,375.6c-9.1-3.8-15-12.7-15-22.6s5.9-18.8,15-22.6l465.5-196c6.1-2.5,12.9-2.5,19,0l465.5,196c9.1,3.8,15,12.7,15,22.6s-5.9,18.8-15,22.6l-465.5,196C506.5,572.9,503.2,573.5,500,573.5L500,573.5z M97.6,353L500,522.4L902.4,353L500,183.6L97.6,353L97.6,353z"/><path d="M500,720.5c-3.2,0-6.5-0.6-9.5-1.9L25,522.6c-12.4-5.2-18.3-19.6-13.1-32.1c5.2-12.5,19.6-18.3,32.1-13.1l456,192l456-192c12.4-5.2,26.9,0.6,32.1,13.1s-0.6,26.9-13.1,32.1l-465.5,196C506.5,719.9,503.2,720.5,500,720.5L500,720.5z"/><path d="M500,867.5c-3.2,0-6.5-0.6-9.5-1.9L25,669.6c-12.4-5.2-18.3-19.6-13.1-32.1c5.2-12.5,19.6-18.3,32.1-13.1l456,192l456-192c12.4-5.2,26.9,0.6,32.1,13.1c5.2,12.5-0.6,26.8-13.1,32.1l-465.5,196C506.5,866.9,503.2,867.5,500,867.5L500,867.5z"/></g>
</svg>`}),this.$baseLayers=null,this.$overlays=null,this._layerViews=[]}oninit(){this._toggleBtn.appendTo(this.renderer.div),this._dialog.appendTo(this.planet.renderer.div),this._panel.appendTo(this._dialog.container),this.$baseLayers=this._panel.el.querySelector(".og-layerSwitcher__baseLayers"),this.$overlays=this._panel.el.querySelector(".og-layerSwitcher__overlays"),this._dialog.setPosition(this.planet.renderer.div.clientWidth-this._dialog.width-67),this._dialog.events.on("visibility",l=>{this._toggleBtn.setActive(l)}),this._toggleBtn.events.on("change",l=>{this._dialog.setVisibility(l)}),this.planet.events.on("layeradd",this.addLayer,this),this.planet.events.on("layerremove",this.removeLayer,this),this._initLayers()}_initLayers(){let l=this.planet.layers;for(let e=0;e<l.length;e++)this.addLayer(l[e])}_createLayerButton(l){return new wl({model:l})}onactivate(){}ondeactivate(){this._dialog.hide()}},Lighting:class extends Z{constructor(l={}){super(l),this._selectedLayer=null,this._toggleBtn=new ct({classList:["og-map-button","og-lighting_button"],icon:`<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="256" height="256" viewBox="0 0 256 256" xml:space="preserve">

<defs>
</defs>
<g style="stroke: none; stroke-width: 0; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; opacity: 1;" transform="translate(1.4065934065934016 1.4065934065934016) scale(2.81 2.81)" >
	<path d="M 45 68 c -12.682 0 -23 -10.317 -23 -23 c 0 -12.682 10.318 -23 23 -23 c 12.683 0 23 10.318 23 23 C 68 57.683 57.683 68 45 68 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round" />
	<path d="M 45 17.556 c -1.657 0 -3 -1.343 -3 -3 V 3 c 0 -1.657 1.343 -3 3 -3 c 1.657 0 3 1.343 3 3 v 11.556 C 48 16.212 46.657 17.556 45 17.556 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round" />
	<path d="M 45 90 c -1.657 0 -3 -1.343 -3 -3 V 75.444 c 0 -1.657 1.343 -3 3 -3 c 1.657 0 3 1.343 3 3 V 87 C 48 88.657 46.657 90 45 90 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round" />
	<path d="M 14.556 48 H 3 c -1.657 0 -3 -1.343 -3 -3 c 0 -1.657 1.343 -3 3 -3 h 11.556 c 1.657 0 3 1.343 3 3 C 17.556 46.657 16.212 48 14.556 48 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round" />
	<path d="M 87 48 H 75.444 c -1.657 0 -3 -1.343 -3 -3 c 0 -1.657 1.343 -3 3 -3 H 87 c 1.657 0 3 1.343 3 3 C 90 46.657 88.657 48 87 48 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round" />
	<path d="M 66.527 26.473 c -0.768 0 -1.535 -0.293 -2.121 -0.878 c -1.172 -1.172 -1.172 -3.071 0 -4.243 l 8.171 -8.171 c 1.172 -1.172 3.07 -1.171 4.242 0 c 1.172 1.172 1.172 3.071 0 4.243 l -8.171 8.171 C 68.063 26.18 67.295 26.473 66.527 26.473 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round" />
	<path d="M 15.302 77.698 c -0.768 0 -1.536 -0.293 -2.121 -0.879 c -1.172 -1.171 -1.172 -3.071 0 -4.242 l 8.171 -8.171 c 1.171 -1.172 3.071 -1.172 4.242 0 c 1.172 1.171 1.172 3.071 0 4.242 l -8.171 8.171 C 16.837 77.405 16.069 77.698 15.302 77.698 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round" />
	<path d="M 23.473 26.473 c -0.768 0 -1.536 -0.293 -2.121 -0.878 l -8.171 -8.171 c -1.172 -1.172 -1.172 -3.071 0 -4.243 c 1.172 -1.172 3.072 -1.171 4.243 0 l 8.171 8.171 c 1.172 1.172 1.172 3.071 0 4.243 C 25.008 26.18 24.24 26.473 23.473 26.473 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round" />
	<path d="M 74.698 77.698 c -0.768 0 -1.535 -0.293 -2.121 -0.879 l -8.171 -8.171 c -1.172 -1.171 -1.172 -3.071 0 -4.242 c 1.172 -1.172 3.07 -1.172 4.242 0 l 8.171 8.171 c 1.172 1.171 1.172 3.071 0 4.242 C 76.233 77.405 75.466 77.698 74.698 77.698 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round" />
</g>
</svg>`}),this._dialog=new Zt({title:"Lighting Parameters",visible:!1,useHide:!0,top:60,left:60,width:600}),this._dialog.events.on("visibility",e=>{this._toggleBtn.setActive(e)}),this._panel=new dt({template:`<div class="og-lighing og-options-container">

         <div class="og-option">
           <div class="og-suncontrol"></div>
         </div>        
         
         <div class="og-option og-atmosphere-opacity">
         </div>
         
         <div class="og-option og-simpleskybackground">
         </div>
         
        <div class="og-lighting-emptyline"></div>

         <div class="og-option og-gamma"></div>         
         <div class="og-option og-exposure"></div>
       
        <div class="og-lighting-emptyline"></div>

         <div class="og-option">
         <div class="og-layers">
           <div class="og-caption">Select layer:</div>
           <select id="layers"></select>
         </div>
         </div>

         <div class="og-option og-opacity">
         </div>
         
         <div class="og-option og-night">
         </div>
         
         <div class="og-lighting-emptyline"></div>

         <div class="og-option og-diffuse">
         </div>
      
         <div class="og-option og-ambient">
         </div>

         <div class="og-option og-specular">
         </div>        

    </div>`}),this.$gamma=null,this.$exposure=null,this.$night=null,this.$opacity=null,this.$diffuse=null,this.$ambient=null,this.$specular=null,this.$atmosphereOpacity=null,this.$simpleSkyBackground=null,this._atmosphereMaxOpacity=new K({label:"Max.opacity",max:5}),this._atmosphereMinOpacity=new K({label:"Min.opacity",max:5}),this._simpleSkyBackgroundColorOne=new Bn({label:"Color One"}),this._simpleSkyBackgroundColorTwo=new Bn({label:"Color Two"}),this._gamma=new K({label:"Gamma",max:5}),this._exposure=new K({label:"Exposure",max:5}),this._night=new K({label:"Nightlight",max:5}),this._opacity=new K({label:"Opacity",max:1}),this._diffuse_r=new K({label:"Diffuse R",max:5}),this._diffuse_g=new K({label:"Diffuse G",max:5}),this._diffuse_b=new K({label:"Diffuse B",max:5}),this._ambient_r=new K({label:"Ambient R",max:5}),this._ambient_g=new K({label:"Ambient G",max:5}),this._ambient_b=new K({label:"Ambient B",max:5}),this._specular_r=new K({label:"Specular R",max:.2}),this._specular_g=new K({label:"Specular G",max:.2}),this._specular_b=new K({label:"Specular B",max:.2}),this._shininess=new K({label:"Shininess",max:100})}bindLayer(l){this._selectedLayer=l,this._opacity.value=l.opacity,this._update()}oninit(){this._toggleBtn.appendTo(this.renderer.div),this._dialog.appendTo(this.renderer.div),this._panel.appendTo(this._dialog.container),this._panel.el&&(this.$atmosphereOpacity=this._panel.el.querySelector(".og-atmosphere-opacity"),this.$simpleSkyBackground=this._panel.el.querySelector(".og-simpleskybackground"),this.$gamma=this._panel.el.querySelector(".og-option.og-gamma"),this.$exposure=this._panel.el.querySelector(".og-option.og-exposure"),this.$opacity=this._panel.el.querySelector(".og-option.og-opacity"),this.$diffuse=this._panel.el.querySelector(".og-option.og-diffuse"),this.$ambient=this._panel.el.querySelector(".og-option.og-ambient"),this.$specular=this._panel.el.querySelector(".og-option.og-specular"),this.$night=this._panel.el.querySelector(".og-option.og-night")),this._toggleBtn.events.on("change",a=>{this._dialog.setVisibility(a)});let l=this._dialog.select(".og-suncontrol"),e=new ct({classList:["og-suncontrol-button"],isActive:!0,icon:'<?xml version="1.0" encoding="utf-8"?><svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 122.88 70.41" style="enable-background:new 0 0 122.88 70.41" xml:space="preserve"><g><path d="M60.91,19.12c6.95,0,13.24,2.95,17.8,7.72c4.55,4.77,7.37,11.37,7.37,18.64c0,1.94-0.2,3.83-0.58,5.65h31.61 c2.1,0,2.62,1.16,2.62,2.59c0,1.43-0.52,2.59-2.62,2.59H7.09c-2.1,0-2.62-1.16-2.62-2.59c0-1.43,0.52-2.59,2.62-2.59h29.23 c-0.38-1.82-0.58-3.71-0.58-5.65c0-7.28,2.82-13.87,7.37-18.64C47.67,22.08,53.96,19.12,60.91,19.12L60.91,19.12L60.91,19.12z M63.4,70.41c-2.1,0-2.62-1.16-2.62-2.59s0.52-2.59,2.62-2.59h56.86c2.1,0,2.62,1.16,2.62,2.59s-0.52,2.59-2.62,2.59H63.4 L63.4,70.41z M2.62,70.41c-2.1,0-2.62-1.16-2.62-2.59s0.52-2.59,2.62-2.59h29.51c2.1,0,2.62,1.16,2.62,2.59s-0.52,2.59-2.62,2.59 H2.62L2.62,70.41z M38.39,9.46c-0.78-1.35-0.32-3.07,1.03-3.85c1.35-0.78,3.07-0.32,3.85,1.03l3.62,6.27 c0.78,1.35,0.32,3.07-1.03,3.85c-1.35,0.78-3.07,0.32-3.85-1.03L38.39,9.46L38.39,9.46L38.39,9.46z M58.67,2.83 c0-1.56,1.27-2.83,2.83-2.83c1.56,0,2.83,1.27,2.83,2.83v7.24c0,1.56-1.27,2.83-2.83,2.83c-1.56,0-2.83-1.26-2.83-2.83V2.83 L58.67,2.83L58.67,2.83z M79.56,7.23c0.77-1.35,2.49-1.81,3.84-1.04c1.35,0.77,1.81,2.49,1.04,3.84l-3.62,6.27 c-0.77,1.35-2.49,1.81-3.84,1.04c-1.35-0.77-1.81-2.49-1.04-3.84L79.56,7.23L79.56,7.23L79.56,7.23z M95.45,21.48 c1.35-0.78,3.07-0.32,3.85,1.03c0.78,1.35,0.32,3.07-1.03,3.85L92,29.98c-1.35,0.78-3.07,0.32-3.85-1.03 c-0.78-1.35-0.32-3.07,1.03-3.85L95.45,21.48L95.45,21.48L95.45,21.48z M102.08,41.76c1.56,0,2.83,1.27,2.83,2.83 c0,1.56-1.27,2.83-2.83,2.83h-7.24c-1.56,0-2.83-1.26-2.83-2.83s1.26-2.83,2.83-2.83H102.08L102.08,41.76L102.08,41.76z M19.74,46.25c-1.56,0-2.83-1.27-2.83-2.83c0-1.56,1.27-2.83,2.83-2.83h7.24c1.56,0,2.83,1.26,2.83,2.83s-1.27,2.83-2.83,2.83 H19.74L19.74,46.25L19.74,46.25z M24.14,25.35c-1.35-0.77-1.81-2.49-1.04-3.84c0.77-1.35,2.49-1.81,3.84-1.04l6.27,3.62 c1.35,0.77,1.81,2.49,1.04,3.84c-0.77,1.35-2.49,1.81-3.84,1.04L24.14,25.35L24.14,25.35L24.14,25.35z"/></g></svg>',title:"Star/stop the Sun from following the camera"});e.appendTo(l);let t=new ct({classList:["og-suncontrol-button"],isActive:!0,icon:`<?xml version="1.0"?>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32">
    <path style="text-indent:0;text-align:start;line-height:normal;text-transform:none;block-progression:tb;-inkscape-font-specification:Sans" d="M 16 4 C 9.3844277 4 4 9.3844277 4 16 C 4 22.615572 9.3844277 28 16 28 C 22.615572 28 28 22.615572 28 16 C 28 9.3844277 22.615572 4 16 4 z M 16 6 C 16.389823 6 16.778223 6.0506339 17.15625 6.09375 C 18.631659 7.6568432 21 10.9245 21 16 C 21 21.0755 18.631659 24.343157 17.15625 25.90625 C 16.778223 25.949366 16.389823 26 16 26 C 10.465308 26 6 21.534692 6 16 C 6 10.465308 10.465308 6 16 6 z" overflow="visible" font-family="Sans"/>
</svg>
`,title:"Activate/deactivate the Sun current time positioning"});t.appendTo(l),e.events.on("change",a=>{const h=this.planet.renderer.controls.sun;a?h.start():h.stop()}),t.events.on("change",a=>{const h=this.planet.renderer.controls.sun;a?h.activate():h.deactivate()});let s=new ct({classList:["og-suncontrol-button"],isActive:this.planet.lightEnabled,icon:`<?xml version="1.0" encoding="utf-8"?>
<!-- Generated by IcoMoon.io -->
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="512" height="512" viewBox="0 0 512 512">
<g>
</g>
	<path d="M257.894 156.948c-53.258 0-96.42 43.561-96.42 97.26 0 53.719 43.161 97.249 96.42 97.249 53.197 0 96.379-43.53 96.379-97.25 0-53.698-43.182-97.26-96.379-97.26zM257.894 309.873c-30.464 0-55.163-24.945-55.163-55.665s24.699-55.624 55.163-55.624c30.423 0 55.101 24.904 55.101 55.624s-24.688 55.665-55.101 55.665z" fill="#000000" />
	<path d="M241.808 43.499h32.144v79.575h-32.144v-79.575z" fill="#000000" />
	<path d="M417.209 115.897l-22.723-22.917-55.757 56.279 22.723 22.907z" fill="#000000" />
	<path d="M389.468 238.407h78.899v32.389h-78.899v-32.389z" fill="#000000" />
	<path d="M396.012 416.86l22.723-22.917-55.767-56.259-22.712 22.897z" fill="#000000" />
	<path d="M242.473 388.915h32.144v79.575h-32.144v-79.575z" fill="#000000" />
	<path d="M96.266 396.073l22.722 22.938 55.778-56.289-22.692-22.928z" fill="#000000" />
	<path d="M43.633 240.537h78.879v32.43h-78.879v-32.43z" fill="#000000" />
	<path d="M115.394 93.051l-22.681 22.907 55.757 56.258 22.702-22.917z" fill="#000000" />
</svg>`,title:"Enable/disable planet lighting"});s.appendTo(l),s.events.on("change",a=>{this.planet.lightEnabled=a});let n=new ct({classList:["og-suncontrol-button"],isActive:this.planet.atmosphereEnabled,icon:`<?xml version="1.0" encoding="utf-8"?><!-- Uploaded to: SVG Repo, www.svgrepo.com, Generator: SVG Repo Mixer Tools -->
<svg width="800px" height="800px" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><path fill="#000000" d="M135.688 18.5c-6.798 74.842-23.842 85.39-107.907 59.656 84.85 52.022 73.57 64.954-6.843 96.938 87.743-10.27 103.29 4.89 70.75 87.594 17.805-27.56 32.5-44.498 46.282-54.47-11.813 28.26-18.345 59.274-18.345 91.813 0 84.184 43.71 157.96 109.656 200.376-41.624-43.834-67.686-102.7-67.686-167.875 0-134.923 109.45-244.405 244.375-244.405 30.92 0 60.76 5.762 88 16.25-38.584-26.87-85.517-42.625-136.064-42.625-55.257 0-106.14 18.802-146.562 50.375 4.627-18.783 17.39-38.073 41.03-60.906C190.18 90.942 153.53 95.634 135.69 18.5zm10.03 77.188c5.67.002 11.428 1.247 16.876 3.874 14.506 6.998 22.72 21.81 22 36.938-10.26 10.87-19.507 22.696-27.594 35.344-9.035 2.753-19.075 2.27-28.25-2.156-19.37-9.343-27.5-32.6-18.156-51.97 6.715-13.92 20.638-22.036 35.125-22.03z"/></svg>`,title:"Enable/disable atmosphere scattering"});n.appendTo(l),this.planet.atmosphereEnabled?(this.$atmosphereOpacity.style.display="block",this.$simpleSkyBackground.style.display="none"):(this.$atmosphereOpacity.style.display="none",this.$simpleSkyBackground.style.display="flex"),n.events.on("change",a=>{this.planet.atmosphereEnabled=a,this.planet.atmosphereEnabled?(this.$atmosphereOpacity.style.display="block",this.$simpleSkyBackground.style.display="none"):(this.$atmosphereOpacity.style.display="none",this.$simpleSkyBackground.style.display="flex")}),this._atmosphereMaxOpacity.appendTo(this.$atmosphereOpacity),this._atmosphereMinOpacity.appendTo(this.$atmosphereOpacity),this._simpleSkyBackgroundColorOne.appendTo(this.$simpleSkyBackground),this._simpleSkyBackgroundColorTwo.appendTo(this.$simpleSkyBackground),this._gamma.appendTo(this.$gamma),this._exposure.appendTo(this.$exposure),this._night.appendTo(this.$night),this._opacity.appendTo(this.$opacity),this._diffuse_r.appendTo(this.$diffuse),this._diffuse_g.appendTo(this.$diffuse),this._diffuse_b.appendTo(this.$diffuse),this._ambient_r.appendTo(this.$ambient),this._ambient_g.appendTo(this.$ambient),this._ambient_b.appendTo(this.$ambient),this._specular_r.appendTo(this.$specular),this._specular_g.appendTo(this.$specular),this._specular_b.appendTo(this.$specular),this._shininess.appendTo(this.$specular),this._gamma.value=this.planet.renderer.gamma,this._gamma.events.on("change",a=>{this.planet.renderer.gamma=a}),this._exposure.value=this.planet.renderer.exposure,this._exposure.events.on("change",a=>{this.planet.renderer.exposure=a}),this._atmosphereMinOpacity.value=this.planet.atmosphereMinOpacity,this._atmosphereMinOpacity.events.on("change",a=>{this.planet.atmosphereMinOpacity=a}),this._atmosphereMaxOpacity.value=this.planet.atmosphereMaxOpacity,this._atmosphereMaxOpacity.events.on("change",a=>{this.planet.atmosphereMaxOpacity=a,this.planet.renderer.controls.Atmosphere.opacity=a});let o=this.planet.renderer.controls.SimpleSkyBackground;o&&(this._simpleSkyBackgroundColorOne.value=o.colorOne,this._simpleSkyBackgroundColorTwo.value=o.colorTwo),this._simpleSkyBackgroundColorOne.events.on("input",a=>{let h=this.planet.renderer.controls.SimpleSkyBackground;h&&(h.colorOne=a)}),this._simpleSkyBackgroundColorTwo.events.on("input",a=>{let h=this.planet.renderer.controls.SimpleSkyBackground;h&&(h.colorTwo=a)}),this._panel.el.querySelector("#layers").addEventListener("change",a=>{const h=this.planet.getLayerByName(a.target.value);h&&this.bindLayer(h)}),this._night.events.on("change",a=>{this._selectedLayer&&(this._selectedLayer.nightTextureCoefficient=a)}),this._opacity.events.on("change",a=>{this._selectedLayer&&(this._selectedLayer.opacity=a)}),this._ambient_r.events.on("change",a=>{this._selectedLayer&&this._selectedLayer._ambient&&(this._selectedLayer._ambient[0]=a)}),this._ambient_g.events.on("change",a=>{this._selectedLayer&&this._selectedLayer._ambient&&(this._selectedLayer._ambient[1]=a)}),this._ambient_b.events.on("change",a=>{this._selectedLayer&&this._selectedLayer._ambient&&(this._selectedLayer._ambient[2]=a)}),this._diffuse_r.events.on("change",a=>{this._selectedLayer&&this._selectedLayer._diffuse&&(this._selectedLayer._diffuse[0]=a)}),this._diffuse_g.events.on("change",a=>{this._selectedLayer&&this._selectedLayer._diffuse&&(this._selectedLayer._diffuse[1]=a)}),this._diffuse_b.events.on("change",a=>{this._selectedLayer&&this._selectedLayer._diffuse&&(this._selectedLayer._diffuse[2]=a)}),this._specular_r.events.on("change",a=>{this._selectedLayer&&this._selectedLayer._specular&&(this._selectedLayer._specular[0]=a)}),this._specular_g.events.on("change",a=>{this._selectedLayer&&this._selectedLayer._specular&&(this._selectedLayer._specular[1]=a)}),this._specular_b.events.on("change",a=>{this._selectedLayer&&this._selectedLayer._specular&&(this._selectedLayer._specular[2]=a)}),this._shininess.events.on("change",a=>{this._selectedLayer&&this._selectedLayer._specular&&(this._selectedLayer._specular[3]=a)}),this.planet&&(this.planet.events.on("layeradd",this._onLayerAdd,this),this.planet.events.on("layerremove",this._onLayerRemove,this)),this._fetchLayers()}_update(){let l=this._selectedLayer;this._opacity.value=l&&l.opacity?l.opacity:0,this._night.value=l&&l.nightTextureCoefficient?l.nightTextureCoefficient:this.planet.nightTextureCoefficient;let e=l&&l._ambient?l._ambient:this.planet._ambient;this._ambient_r.value=e[0],this._ambient_g.value=e[1],this._ambient_b.value=e[2];let t=l&&l._diffuse?l._diffuse:this.planet._diffuse;this._diffuse_r.value=t[0],this._diffuse_g.value=t[1],this._diffuse_b.value=t[2];let s=l&&l._specular?l._specular:this.planet._specular;this._specular_r.value=s[0],this._specular_g.value=s[1],this._specular_b.value=s[2],this._shininess.value=s[3]}_fetchLayers(){if(this.planet)for(let l=0;l<this.planet.layers.length;l++)this._onLayerAdd(this.planet.layers[l])}_onLayerAdd(l){this.bindLayer(l);let e=document.createElement("option");e.value=l.name,e.innerText=l.name,this._panel.el.querySelector("#layers").appendChild(e),this._panel.el.querySelector("#layers").value=l.name}_onLayerRemove(l){}},MouseNavigation:ha,Object3dManager:class extends Z{constructor(l={}){super(l),this._onSelect=e=>{this._currentItem=e},this._onClick=e=>{if(!this.planet||!this._layer||!this._currentItem)return;let t=this.planet.getLonLatFromPixelTerrain(e.pos);if(t&&(this.renderer.setRelativeCenter(this.planet.camera.eye),this.renderer.events.isKeyPressed(Y.KEY_CTRL))){let s=this._createEntity(this._currentItem,t);this._layer.add(s)}},this._layer=l.layer||null,this._currentItem=null,this._collection=new nn({collection:l.collection}),this._dialog=new Eh({model:this._collection})}oninit(){this.renderer&&(this._dialog.appendTo(this.renderer.div||document.body),this._dialog.events.on("select",this._onSelect),this.activate())}onactivate(){this._dialog.show(),this._initEvents()}ondeactivate(){this._dialog.hide(),this._clearEvents()}bindLayer(l){this._layer=l}_initEvents(){this.planet&&this.planet.renderer&&this.planet.renderer.events.on("lclick",this._onClick)}_clearEvents(){this.planet&&this.planet.renderer&&this.planet.renderer.events.off("lclick",this._onClick)}_createEntity(l,e){let t=l.name,s=l.scale,n=new V({lonlat:e,pitch:0,yaw:0,roll:0,scale:s});for(let o=0;o<l.objects.length;o++){let a=l.objects[o],h=new V({forceGlobalPosition:!0,forceGlobalRotation:!0,forceGlobalScale:!0,geoObject:{tag:`${t}:${o.toString()}`,object3d:a}});n.appendChild(h)}return n}},OldMouseNavigation:tn,Ruler:da,RulerSwitcher:class extends Z{constructor(l={}){super({name:"RulerSwitcher",...l}),this.ruler=new Fn({ignoreTerrain:l.ignoreTerrain})}oninit(){this.planet.addControl(this.ruler),this._createMenuBtn()}onactivate(){this.ruler.activate()}ondeactivate(){this.ruler.deactivate()}_createMenuBtn(){let l=new ct({classList:["og-map-button","og-ruler_button"],icon:`<?xml version="1.0" encoding="iso-8859-1"?>
<!-- Uploaded to: SVG Repo, www.svgrepo.com, Generator: SVG Repo Mixer Tools -->
<svg fill="#000000" height="800px" width="800px" version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" 
	 viewBox="0 0 512 512" xml:space="preserve">
<g>
	<g>
		<path d="M369.151,0L0.001,369.15L142.85,512l369.149-369.15L369.151,0z M47.286,369.15l10.908-10.908l47.782,47.782l23.642-23.642
			L81.837,334.6l10.909-10.909l23.711,23.711L140.1,323.76l-23.711-23.711l10.909-10.909l23.711,23.711l23.642-23.642
			l-23.711-23.711l10.909-10.909l47.782,47.782l23.642-23.642l-47.782-47.782l10.908-10.908l23.71,23.71l23.642-23.642l-23.71-23.71
			l10.908-10.908l23.711,23.711l23.642-23.642l-23.711-23.711l10.909-10.909l47.782,47.782l23.642-23.642l-47.782-47.782
			l10.908-10.908l23.71,23.711l23.642-23.642l-23.711-23.71L334.6,81.837l23.711,23.71l23.642-23.642l-23.711-23.712l10.908-10.908
			l95.564,95.564L142.85,464.714L47.286,369.15z"/>
	</g>
</g>
</svg>`});l.appendTo(this.renderer.div),l.events.on("change",e=>{e?this.onactivate():this.ondeactivate()})}},ScaleControl:ua,Selection:class extends Z{constructor(l={}){super(l),this._selectorScene=new Il({name:`selectionScene:${this.__id}`,ignoreTerrain:l.ignoreTerrain,onSelect:l.onSelect,autoSelectionHide:l.autoSelectionHide}),this._toggleBtn=new ct({classList:["og-map-button","og-selection_button"],icon:`<?xml version="1.0" encoding="utf-8"?><!-- Uploaded to: SVG Repo, www.svgrepo.com, Generator: SVG Repo Mixer Tools -->
<svg width="800px" height="800px" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="iconify iconify--gis" preserveAspectRatio="xMidYMid meet"><path d="M2.1 0v1.914H0v6h3V3h5.1V0h-6zm9 0v3h6V0h-6zm9 0v3h6V0h-6zm9 0v3h6V0h-6zm9 0v3h6V0h-6zm9 0v3h6V0h-6zm9 0v3h6V0h-6zm9 0v3h1.8v1.2h3V0h-4.8zm1.8 7.2v6h3v-6h-3zM0 10.913v6h3v-6H0zM66.9 16.2v6h3v-6h-3zM0 19.914v6h3v-6H0zM66.9 25.2v6h3v-6h-3zM0 28.914v6h3v-6H0zM66.9 34.2v6h3v-6h-3zM0 37.914v6h3v-6H0zM66.9 43.2v6h3v-6h-3zM0 46.914v6h3v-6H0zM66.9 52.2v6h3v-6h-3zM0 55.914v5.191h3.809v-3H3v-2.19H0zm6.809 2.191v3h6v-3h-6zm9 0v3h6v-3h-6zm9 0v3h6v-3h-6zm9 0v3h6v-3h-6zm9 0v3h6v-3h-6zm9 0v3h6v-3h-6zm9 0v3h6v-3h-6zm9.648 1.899a2.076 2.076 0 0 0-2.19 2.324l3.137 33.676c.2 1.635 2.135 2.399 3.397 1.34l6.623-5.371l2.969 5.142c1.707 2.958 4.417 3.684 7.375 1.977c2.957-1.708 3.684-4.417 1.976-7.375l-2.959-5.125l7.848-3.008c1.548-.564 1.855-2.62.539-3.611L71.576 60.416a2.073 2.073 0 0 0-1.119-.412z" fill="#000000"></path></svg>`})}set ignoreTerrain(l){this._selectorScene.ignoreTerrain=l}oninit(){this._toggleBtn.appendTo(this.renderer.div),this._toggleBtn.events.on("change",l=>{l?this.activate():this.deactivate()}),this._selectorScene.bindPlanet(this.planet)}onactivate(){this.renderer.addNode(this._selectorScene)}ondeactivate(){this.renderer.removeNode(this._selectorScene)}},ShowFps:class extends Z{constructor(l){super(l)}oninit(){let l=document.createElement("div");l.className="defaultText ",l.id="ogShowFpsControl",document.body.appendChild(l),this.renderer.events.on("draw",this._draw,this)}_draw(){Lo("ogShowFpsControl",(1e3/this.renderer.handler.deltaTime).toFixed(1),this.renderer.handler.canvas.clientWidth-60,0)}},SimpleNavigation:class extends Z{constructor(l={}){super({name:"SimpleNavigation",autoActivate:!0,...l}),this.focusVel=0,this.focusForce=0,this._nx=0,this._ny=0,this._onMouseLeftButtonDown=e=>{if(this._active&&this.renderer){if(this.stop(),this.renderer.handler.canvas.classList.add("ogGrabbingPoiner"),this._grabbedPoint=this.renderer.getCartesianFromPixel(e),this._grabbedScreenPoint.set(e.nx,e.ny),!this._grabbedPoint){let t=this.renderer.activeCamera,s=new m,n=new m(1,0,0),o=new m(0,0,1),a=new m;new N(t.eye,e.direction).hitPlaneRes(mt.fromPoints(s,n,o),a)===N.INSIDE&&(this._grabbedPoint=a)}this._grabbedPoint&&this._eye0.copy(this.renderer.activeCamera.eye)}},this._onMouseLeftButtonUp=e=>{this.renderer.handler.canvas.classList.remove("ogGrabbingPoiner"),e.x===e.prev_x&&(e.y,e.prev_y)},this._onMouseLeftButtonHold=e=>{if(this.renderer&&this._grabbedPoint&&e.moving){let t=this.renderer.activeCamera;if(t.isOrthographic){let s=e.nx-this._grabbedScreenPoint.x,n=e.ny-this._grabbedScreenPoint.y,o=t.frustum,a=-(o.right-o.left)*s,h=(o.top-o.bottom)*n,c=t.getUp().scale(h),d=t.getRight().scale(a);t.eye=this._eye0.add(d.add(c))}else{let s,n,o=Math.abs(t.getForward().dot(m.UP)),a=this._grabbedPoint;o>.7?(s=m.add(a,m.LEFT),n=m.add(a,t.getRight())):(s=m.add(a,t.getRight()),n=m.add(a,m.UP));let h=new m;new N(t.eye,e.direction).hitPlaneRes(mt.fromPoints(a,s,n),h)===N.INSIDE&&(t.eye=t.eye.add(a.sub(h)))}t.update()}},this._onRHold=e=>{if(this._lookPos&&e.moving&&this.renderer){const t=this.renderer.activeCamera;this.renderer.controlsBag.scaleRot=1;let s=.5/t.eye.distance(this._lookPos)*U;s>.007?s=.007:s<.003&&(s=.003),t.rotateHorizontal(s*(e.x-e.prev_x),!1,this._lookPos,this._up),t.rotateVertical(s*(e.y-e.prev_y),this._lookPos),t.update()}},this._onRDown=e=>{if(this.renderer)if(this.stop(),this._lookPos=this.renderer.getCartesianFromPixel(e.pos),this._lookPos)this._up=m.UP;else{const t=this.renderer.activeCamera;let s=new mt(m.ZERO,m.UP),n=new N(t.eye,e.direction);this._lookPos=new m,n.hitPlaneRes(s,this._lookPos),this._up=m.UP}},this._onMouseWheel=e=>{if(this.renderer){let t=this.renderer.activeCamera;if(t.isOrthographic){let s=t.frustums[0],n=-(s.right-s.left)*(.5-e.nx),o=(s.top-s.bottom)*(.5-e.ny),a=t.getUp().scale(o),h=t.getRight().scale(n),c=t.eye.add(h.add(a));this._wheelPos=c.add(t.getForward()),this._wheelDist=1,this._nx=e.nx,this._ny=e.ny,this.focusForce=.05*e.wheelDelta}else{let s=this.renderer.getCartesianFromPixel(e);if(!s){s=new m;let a=new mt(m.ZERO,m.UP);new N(t.eye,e.direction).hitPlaneRes(a,s)}let n=s.sub(t.eye).normalize(),o=8*t.eye.distance(s);this.force.addA(n.scale(e.wheelDelta)).normalize().scale(o)}}},this.onCameraMoveForward=()=>{this.force.addA(this.renderer.activeCamera.getForward()).normalize()},this.onCameraMoveBackward=()=>{this.force.addA(this.renderer.activeCamera.getBackward()).normalize()},this.onCameraStrifeLeft=()=>{this.force.addA(this.renderer.activeCamera.getLeft()).normalize()},this.onCameraStrifeRight=()=>{this.force.addA(this.renderer.activeCamera.getRight()).normalize()},this.onCameraLookUp=()=>{this.renderer.activeCamera.update()},this.onCameraLookDown=()=>{this.renderer.activeCamera.update()},this.onCameraTurnLeft=()=>{this.renderer.activeCamera.update()},this.onCameraTurnRight=()=>{this.renderer.activeCamera.update()},this.onCameraRollLeft=()=>{this.renderer.activeCamera.update()},this.onCameraRollRight=()=>{this.renderer.activeCamera.update()},this.speed=l.speed||1,this.force=new m,this.vel=new m,this.mass=1,this._lookPos=void 0,this._grabbedPoint=void 0,this._grabbedScreenPoint=new O,this._up=null,this._eye0=new m,this._wheelDist=0,this._wheelPos=new m}oninit(){}onactivate(){super.onactivate();let l=this.renderer;l.activeCamera.isOrthographic&&l.getDepthMinDistanceAsync().then(e=>{l.activeCamera.focusDistance=e}),l.events.on("mousewheel",this._onMouseWheel),l.events.on("keypress",Y.KEY_W,this.onCameraMoveForward,this),l.events.on("keypress",Y.KEY_S,this.onCameraMoveBackward,this),l.events.on("keypress",Y.KEY_A,this.onCameraStrifeLeft,this),l.events.on("keypress",Y.KEY_D,this.onCameraStrifeRight,this),l.events.on("keypress",Y.KEY_UP,this.onCameraLookUp,this),l.events.on("keypress",Y.KEY_DOWN,this.onCameraLookDown,this),l.events.on("keypress",Y.KEY_LEFT,this.onCameraTurnLeft,this),l.events.on("keypress",Y.KEY_RIGHT,this.onCameraTurnRight,this),l.events.on("keypress",Y.KEY_Q,this.onCameraRollLeft,this),l.events.on("keypress",Y.KEY_E,this.onCameraRollRight,this),l.events.on("rhold",this._onRHold,this),l.events.on("rdown",this._onRDown,this),l.events.on("lhold",this._onMouseLeftButtonHold),l.events.on("ldown",this._onMouseLeftButtonDown),l.events.on("lup",this._onMouseLeftButtonUp),l.events.on("draw",this.onDraw,this,-1e3)}ondeactivate(){super.ondeactivate();let l=this.renderer;l.events.off("mousewheel",this._onMouseWheel),l.events.off("keypress",Y.KEY_W,this.onCameraMoveForward),l.events.off("keypress",Y.KEY_S,this.onCameraMoveBackward),l.events.off("keypress",Y.KEY_A,this.onCameraStrifeLeft),l.events.off("keypress",Y.KEY_D,this.onCameraStrifeRight),l.events.off("keypress",Y.KEY_UP,this.onCameraLookUp),l.events.off("keypress",Y.KEY_DOWN,this.onCameraLookDown),l.events.off("keypress",Y.KEY_LEFT,this.onCameraTurnLeft),l.events.off("keypress",Y.KEY_RIGHT,this.onCameraTurnRight),l.events.off("keypress",Y.KEY_Q,this.onCameraRollLeft),l.events.off("keypress",Y.KEY_E,this.onCameraRollRight),l.events.off("rhold",this._onRHold),l.events.off("rdown",this._onRDown),l.events.off("lhold",this._onMouseLeftButtonHold),l.events.off("ldown",this._onMouseLeftButtonDown),l.events.off("lup",this._onMouseLeftButtonUp),l.events.off("draw",this.onDraw)}_handleMouseWheel(){let l=this.renderer.activeCamera;if(l.isOrthographic&&Math.abs(this.focusVel)>.01){l.eye=this._wheelPos.add(l.getBackward().scale(this._wheelDist)),l.focusDistance-=l.focusDistance*this.focusVel*this.dt;let e=l.frustums[0],t=(e.right-e.left)*(.5-this._nx),s=-(e.top-e.bottom)*(.5-this._ny),n=l.getUp().scale(s),o=l.getRight().scale(t);l.eye.addA(o.add(n)),l.update()}else this.vel.length()>.01&&(l.eye=l.eye.add(this.vel.scaleTo(this.dt)),l.update())}onDraw(){this._updateVel(),this._handleMouseWheel()}get dt(){return .001*this.renderer.handler.deltaTime}_updateVel(){let l=this.force.scale(1/this.mass);this.vel.addA(l),this.vel.scale(.77),this.force.set(0,0,0),this.focusVel+=this.focusForce,this.focusVel*=.77,this.focusForce=0}stop(){this.focusVel=0,this.vel.clear()}},SimpleSkyBackground:_a,Sun:kr,TimelineControl:class extends Z{constructor(l={}){super({name:"timeline",...l});let e=l.current||new Date,t=l.rangeStart||Vn(e,-12),s=l.rangeEnd||Vn(e,12);this._timelineView=new Ul({rangeStart:t,rangeEnd:s,currentDate:e}),this._toggleBtn=new ct({classList:["og-map-button","og-timeline_button"],icon:`<?xml version="1.0" encoding="utf-8"?>
<!-- Svg Vector Icons : http://www.onlinewebfonts.com/icon -->
    <!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 1000 1000" enable-background="new 0 0 1000 1000" xml:space="preserve">
    <metadata> Svg Vector Icons : http://www.onlinewebfonts.com/icon </metadata>
    <g><path d="M500,10C229.4,10,10,229.4,10,500s219.4,490,490,490s490-219.4,490-490S770.6,10,500,10z M800.3,800.3c-39,39-84.5,69.7-135,91C613,913.5,557.4,924.7,500,924.7s-112.9-11.2-165.3-33.3c-50.5-21.3-95.9-52-135-91c-39-39-69.7-84.5-91-135C86.5,612.9,75.3,557.4,75.3,500s11.2-112.9,33.3-165.3c21.3-50.5,52-95.9,91-135c39-39,84.5-69.7,135-91C387.1,86.5,442.6,75.3,500,75.3s112.9,11.2,165.3,33.3c50.5,21.3,95.9,52,135,91c39,39,69.7,84.5,91,135c22.1,52.3,33.3,107.9,33.3,165.3s-11.2,112.9-33.3,165.3C869.9,715.8,839.3,761.2,800.3,800.3z"/><path d="M761.3,532.7H532.7V304c0-18.1-14.6-32.7-32.7-32.7s-32.7,14.6-32.7,32.7v261.3l0,0c0,18.1,14.6,32.7,32.7,32.7h261.3c18.1,0,32.7-14.6,32.7-32.7l0,0C794,547.3,779.4,532.7,761.3,532.7z"/></g>
</svg>`}),this._dialog=new Zt({title:"Timeline",visible:!1,resizable:!0,useHide:!0,top:10,left:60,width:600,height:115,minHeight:115,maxHeight:110}),this._dialog.events.on("visibility",n=>{this._toggleBtn.setActive(n)})}oninit(){let l=this.renderer.div;this._toggleBtn.appendTo(l),this._dialog.appendTo(l),this._toggleBtn.events.on("change",e=>{this._dialog.setVisibility(e),e&&this._timelineView.resize()}),this._timelineView.appendTo(this._dialog.container),this._timelineView.events.on("setcurrent",e=>{this.renderer&&this.renderer.handler.defaultClock.setDate(e)}),this._timelineView.events.on("startdrag",()=>{var e;(e=this.planet)==null||e.sun.stop(),this.renderer&&this.renderer.controls.mouseNavigation.deactivate()}),this._timelineView.events.on("stopdrag",()=>{this.renderer&&this.renderer.controls.mouseNavigation.activate()}),this._timelineView.events.on("startdragcurrent",()=>{var e;(e=this.planet)==null||e.sun.stop(),this.renderer&&this.renderer.controls.mouseNavigation.deactivate()}),this._timelineView.events.on("stopdragcurrent",()=>{this.renderer&&this.renderer.controls.mouseNavigation.activate()})}},ToggleWireframe:class extends Z{constructor(l={}){super(l),this._isActive=!1,this.toogleWireframe=()=>{this.renderer&&this.renderer.handler.gl&&(this.planet.drawMode===this.renderer.handler.gl.LINE_STRIP?this.planet.setDrawMode(this.renderer.handler.gl.TRIANGLE_STRIP):this.planet.setDrawMode(this.renderer.handler.gl.LINE_STRIP))},this._isActive=l.isActive||!1}oninit(){this.renderer.events.on("charkeypress",Y.KEY_X,this.toogleWireframe,this),this._isActive&&this.planet.setDrawMode(this.renderer.handler.gl.LINE_STRIP)}},TouchNavigation:fa,ZoomControl:ga},Symbol.toStringTag,{value:"Module"}));function Xe(l){return new Uint32Array(l)}function Mh(l){let e=[],t=0,s=0,n=0;for(let o=1;o<l-1-1;o++){for(let a=1;a<l-1;a++)t=o*l+a,n=(o+1)*l,s=n+a,e.push(t,s);e.push(s,n+1)}return e.push(e[e.length-1],l*l-l),Xe(e)}function Bh(l,e){let t=[];const s=(l-1)/e,n=l*l-l;let o=0;for(let a=0;a<l-2;a++){a%s==0&&(o=a);let h=n-l*a-l+1,c=n-l*o;t.push(c,h)}return e===l-1&&(t.push(l),t.push(0)),Xe(t)}function kh(l,e){let t=[];const s=(l-1)/e;let n=0;for(let o=0;o<l-2;o++){o%s==0&&(n=o);let a=l+o+1,h=n;t.push(h,a)}return e===l-1&&(t.push(l-2),t.push(l-1)),Xe(t)}function Ih(l,e){let t=[];const s=(l-1)/e;let n=0;for(let o=0;o<l-2;o++){o%s==0&&(n=o);let a=l*(o+1)+l-2,h=l+l*n-1;t.push(h,a)}return e===l-1&&(t.push(l*(l-1)-1),t.push(l*l-1)),Xe(t)}function zh(l,e){let t=[];const s=(l-1)/e;let n=0;const o=l*(l-1)-2,a=l*l-1;for(let h=0;h<l-2;h++){h%s==0&&(n=h);let c=o-h,d=a-n;t.push(d,c)}return e===l-1&&t.push(l*l-l+1),t.push(l*l-l),Xe(t)}function io(l){let e=[[],[],[],[]];for(let t=0;t<=l;t++){let s=Math.pow(2,t)+1;e[0][t]=[],e[3][t]=[],e[2][t]=[],e[1][t]=[];for(let n=0;n<=l;n++){let o=Math.pow(2,n);e[3][t][n]=Bh(s,o),e[0][t][n]=kh(s,o),e[1][t][n]=Ih(s,o),e[2][t][n]=zh(s,o)}}return e}function so(l){let e=[];for(let t=0;t<=l;t++){const s=Math.pow(2,t);e[t]=Mh(s+1)}return e}function Dh(l){let e=new Uint16Array((l+1)*(l+1)*2),t=0;for(let s=0;s<=l;s++)for(let n=0;n<=l;n++)e[t++]=n/l*65535,e[t++]=s/l*65535;return e}let Fh=new class{constructor(l=0){this._maxGridSize=l,this.centerIndexesTable=so(this._maxGridSize),this.skirtsIndexesTable=io(this._maxGridSize)}get maxGridSize(){return this._maxGridSize}init(){this.centerIndexesTable=so(this._maxGridSize),this.skirtsIndexesTable=io(this._maxGridSize)}setMaxGridSize(l){this._maxGridSize=l,this.init()}createSegmentIndexes(l,e){if(l){let s=this.centerIndexesTable[l],n=this.skirtsIndexesTable[3][l][e[3]],o=this.skirtsIndexesTable[0][l][e[0]],a=this.skirtsIndexesTable[1][l][e[1]],h=this.skirtsIndexesTable[2][l][e[2]],c=(t=s.length+n.length+o.length+a.length+h.length,new Uint32Array(t));return c.set(s,0),c.set(n,s.length),c.set(o,s.length+n.length),c.set(a,s.length+n.length+o.length),c.set(h,s.length+n.length+o.length+a.length),c}var t;return Xe([0,2,1,3])}initTextureCoordsTable(l){let e=[];for(let t=0;t<=l;t++){const s=Math.pow(2,t);e[t]=Dh(s)}return e}};function Yi(){return Fh}function ro(){return new $("drawnode_screen_wl",{uniforms:{projectionMatrix:"mat4",viewMatrix:"mat4",eyePositionHigh:"vec3",eyePositionLow:"vec3",height:"float",uGlobalTextureCoord:"vec4",uNormalMapBias:"vec3",samplerCount:"int",tileOffsetArr:"vec4",layerOpacityArr:"float",samplerArr:"sampler2darray",defaultTexture:"sampler2d",uNormalMap:"sampler2d",nightTexture:"sampler2d",specularTexture:"sampler2d",lightPosition:"vec3",diffuse:"vec3",ambient:"vec3",specular:"vec4",camHeight:"float",nightTextureCoefficient:"float"},attributes:{aVertexPositionHigh:"vec3",aVertexPositionLow:"vec3",aTextureCoord:"vec2"},vertexShader:"attribute vec3 aVertexPositionHigh;attribute vec3 aVertexPositionLow;attribute vec2 aTextureCoord;uniform mat4 projectionMatrix;uniform mat4 viewMatrix;uniform vec4 uGlobalTextureCoord;uniform vec3 uNormalMapBias;uniform vec3 eyePositionHigh;uniform vec3 eyePositionLow;uniform float height;varying vec4 vTextureCoord;varying vec3 v_vertex;varying vec3 cameraPosition;varying vec2 vGlobalTextureCoord;varying float v_height;void main(void){vec3 aVertexPosition=aVertexPositionHigh+aVertexPositionLow;vec3 nh=height*normalize(aVertexPosition);vTextureCoord.xy=aTextureCoord;vGlobalTextureCoord=uGlobalTextureCoord.xy+(uGlobalTextureCoord.zw-uGlobalTextureCoord.xy)*aTextureCoord;vTextureCoord.zw=uNormalMapBias.z*(aTextureCoord+uNormalMapBias.xy);cameraPosition=eyePositionHigh+eyePositionLow;vec3 highDiff=aVertexPositionHigh-eyePositionHigh;vec3 lowDiff=aVertexPositionLow-eyePositionLow+nh;mat4 viewMatrixRTE=viewMatrix;viewMatrixRTE[3]=vec4(0.0,0.0,0.0,1.0);v_height=height;v_vertex=aVertexPosition+nh;gl_Position=projectionMatrix*viewMatrixRTE*vec4(highDiff*step(1.0,length(highDiff))+lowDiff,1.0);}",fragmentShader:`precision highp float;float getLerpValue(in float min,in float max,in float between){return(clamp(between,min,max)-min)/(max-min);}vec3 aces(vec3 color){float a=2.51;float b=0.03;float c=2.43;float d=0.59;float e=0.14;return clamp((color*(a*color+b))/(color*(c*color+d)+e),0.0,1.0);}bool intersectSphere(vec3 rayOrigin,vec3 rayDirection,float radius,inout float t1,inout float t2){float b=dot(rayDirection,rayOrigin);float c=dot(rayOrigin,rayOrigin)-radius*radius;float d=b*b-c;if(d<0.0){return false;}t1=-b-sqrt(d);t2=-b+sqrt(d);return true;}bool intersectSphere(vec3 rayOrigin,vec3 rayDirection,float radius,inout float t){float b=dot(rayDirection,rayOrigin);float c=dot(rayOrigin,rayOrigin)-radius*radius;float d=b*b-c;if(d<0.0){return false;}t=-b-sqrt(d);return true;}float intersectSphere(vec3 ro,vec3 rd,vec4 sph){vec3 oc=ro-sph.xyz;float b=dot(oc,rd);float c=dot(oc,oc)-sph.w*sph.w;float h=b*b-c;if(h<0.0)return-1.0;h=sqrt(h);return-b-h;}bool intersectEllipsoid(in vec3 ro,in vec3 rd,in vec3 ra,inout float t){vec3 ocn=ro/ra;vec3 rdn=rd/ra;float a=dot(rdn,rdn);float b=dot(ocn,rdn);float c=dot(ocn,ocn);float h=b*b-a*(c-1.0);if(h<0.0){return false;}t=(-b-sqrt(h))/a;return true;}bool intersectEllipsoid(in vec3 ro,in vec3 rd,in vec3 ra,inout float t1,inout float t2){vec3 ocn=ro/ra;vec3 rdn=rd/ra;float a=dot(rdn,rdn);float b=dot(ocn,rdn);float c=dot(ocn,ocn);float h=b*b-a*(c-1.0);if(h<0.0){return false;}h=sqrt(h);t1=(-b-h)/a;t2=(-b+h)/a;return true;}vec3 normalEllipsoid(in vec3 pos,in vec3 ra){return normalize(pos/(ra*ra));}
#ifdef WEBGL2
#define TEXTURE_FUNC texture
#else
#define TEXTURE_FUNC texture2D
#endif
#define SLICE_SIZE 5
#define blend(DEST, SAMPLER, OFFSET, OPACITY) src = TEXTURE_FUNC(SAMPLER, OFFSET.xy + vTextureCoord.xy * OFFSET.zw); DEST = DEST * (1.0 - src.a * OPACITY) + src * OPACITY;
#define blendPicking(DEST, OFFSET, SAMPLER, MASK, COLOR, OPACITY) tc = OFFSET.xy + vTextureCoord.xy * OFFSET.zw; t = TEXTURE_FUNC(SAMPLER, tc); p = TEXTURE_FUNC(MASK, tc); DEST = mix(DEST, vec4(max(COLOR.rgb, p.rgb), OPACITY), (t.a == 0.0 ? 0.0: 1.0) * COLOR.a);
const vec3 nightStep=10.0*vec3(0.58,0.48,0.25);uniform vec4 specular;uniform vec3 diffuse;uniform vec3 ambient;uniform sampler2D uNormalMap;uniform sampler2D nightTexture;uniform sampler2D specularTexture;uniform sampler2D defaultTexture;uniform sampler2D samplerArr[SLICE_SIZE];uniform vec4 tileOffsetArr[SLICE_SIZE];uniform vec3 lightPosition;uniform float layerOpacityArr[SLICE_SIZE];uniform int samplerCount;uniform float nightTextureCoefficient;uniform float camHeight;varying vec4 vTextureCoord;varying vec3 v_vertex;varying vec3 cameraPosition;varying vec2 vGlobalTextureCoord;varying float v_height;vec3 sunPos;void main(void){sunPos=lightPosition;vec3 texNormal=texture2D(uNormalMap,vTextureCoord.zw).rgb;vec3 normal=normalize((texNormal-0.5)*2.0);float minH=1200000.0;float maxH=minH*3.0;float nightCoef=getLerpValue(minH,maxH,camHeight)*nightTextureCoefficient;vec3 lightDir=normalize(sunPos);vec3 viewDir=normalize(cameraPosition-v_vertex);float overGround=1.0-step(0.1,v_height);float shininess=texture2D(specularTexture,vGlobalTextureCoord.st).r*255.0*overGround;vec3 reflectionDirection=reflect(-lightDir,normal);float reflection=max(dot(reflectionDirection,viewDir),0.0);vec3 spec=specular.rgb*pow(reflection,specular.w)*shininess;float diffuseLightWeighting=max(dot(normal,lightDir),0.0);vec4 nightImageColor=texture2D(nightTexture,vGlobalTextureCoord.st);vec3 night=nightStep*(.18-diffuseLightWeighting*3.0)*nightImageColor.rgb*nightCoef;night*=overGround*step(0.0,night);vec4 lightWeighting=vec4(ambient+diffuse*diffuseLightWeighting+night,1.0);gl_FragColor=texture2D(defaultTexture,vTextureCoord.xy);if(samplerCount==0){gl_FragColor=gl_FragColor*lightWeighting+vec4(spec,0.0);return;}vec4 src;blend(gl_FragColor,samplerArr[0],tileOffsetArr[0],layerOpacityArr[0]);if(samplerCount==1){gl_FragColor=gl_FragColor*lightWeighting+vec4(spec,0.0);return;}blend(gl_FragColor,samplerArr[1],tileOffsetArr[1],layerOpacityArr[1]);if(samplerCount==2){gl_FragColor=gl_FragColor*lightWeighting+vec4(spec,0.0);return;}blend(gl_FragColor,samplerArr[2],tileOffsetArr[2],layerOpacityArr[2]);if(samplerCount==3){gl_FragColor=gl_FragColor*lightWeighting+vec4(spec,0.0);return;}blend(gl_FragColor,samplerArr[3],tileOffsetArr[3],layerOpacityArr[3]);if(samplerCount==4){gl_FragColor=gl_FragColor*lightWeighting+vec4(spec,0.0);return;}blend(gl_FragColor,samplerArr[4],tileOffsetArr[4],layerOpacityArr[4]);gl_FragColor=gl_FragColor*lightWeighting+vec4(spec,0.0);}`})}function no(l){return new $("drawnode_screen_wl",{uniforms:{projectionMatrix:"mat4",viewMatrix:"mat4",eyePositionHigh:"vec3",eyePositionLow:"vec3",height:"float",uGlobalTextureCoord:"vec4",uNormalMapBias:"vec3",samplerCount:"int",tileOffsetArr:"vec4",layerOpacityArr:"float",samplerArr:"sampler2darray",defaultTexture:"sampler2d",uNormalMap:"sampler2d",nightTexture:"sampler2d",specularTexture:"sampler2d",lightPosition:"vec3",diffuse:"vec3",ambient:"vec3",specular:"vec4",transmittanceTexture:"sampler2D",scatteringTexture:"sampler2D",camHeight:"float",nightTextureCoefficient:"float",maxMinOpacity:"vec2",transitionOpacity:"float"},attributes:{aVertexPositionHigh:"vec3",aVertexPositionLow:"vec3",aTextureCoord:"vec2"},vertexShader:`#version 300 es
precision highp float;in vec3 aVertexPositionHigh;in vec3 aVertexPositionLow;in vec2 aTextureCoord;uniform mat4 projectionMatrix;uniform mat4 viewMatrix;uniform vec4 uGlobalTextureCoord;uniform vec3 uNormalMapBias;uniform vec3 eyePositionHigh;uniform vec3 eyePositionLow;uniform float height;out vec4 vTextureCoord;out vec3 v_vertex;out vec3 cameraPosition;out vec2 vGlobalTextureCoord;out float v_height;void main(void){vec3 aVertexPosition=aVertexPositionHigh+aVertexPositionLow;vec3 nh=height*normalize(aVertexPosition);vTextureCoord.xy=aTextureCoord;vGlobalTextureCoord=uGlobalTextureCoord.xy+(uGlobalTextureCoord.zw-uGlobalTextureCoord.xy)*aTextureCoord;vTextureCoord.zw=uNormalMapBias.z*(aTextureCoord+uNormalMapBias.xy);cameraPosition=eyePositionHigh+eyePositionLow;vec3 highDiff=aVertexPositionHigh-eyePositionHigh;vec3 lowDiff=aVertexPositionLow-eyePositionLow+nh;mat4 viewMatrixRTE=viewMatrix;viewMatrixRTE[3]=vec4(0.0,0.0,0.0,1.0);v_height=height;v_vertex=aVertexPosition+nh;gl_Position=projectionMatrix*viewMatrixRTE*vec4(highDiff*step(1.0,length(highDiff))+lowDiff,1.0);}`,fragmentShader:hi("#version 300 es\nprecision highp float;\n#ifdef WEBGL2\n#define TEXTURE_FUNC texture\n#else\n#define TEXTURE_FUNC texture2D\n#endif\n#define SLICE_SIZE 5\n#define blend(DEST, SAMPLER, OFFSET, OPACITY) src = TEXTURE_FUNC(SAMPLER, OFFSET.xy + vTextureCoord.xy * OFFSET.zw); DEST = DEST * (1.0 - src.a * OPACITY) + src * OPACITY;\n#define blendPicking(DEST, OFFSET, SAMPLER, MASK, COLOR, OPACITY) tc = OFFSET.xy + vTextureCoord.xy * OFFSET.zw; t = TEXTURE_FUNC(SAMPLER, tc); p = TEXTURE_FUNC(MASK, tc); DEST = mix(DEST, vec4(max(COLOR.rgb, p.rgb), OPACITY), (t.a == 0.0 ? 0.0: 1.0) * COLOR.a);\nconst vec3 nightStep=10.0*vec3(0.58,0.48,0.25);float getLerpValue(in float min,in float max,in float between){return(clamp(between,min,max)-min)/(max-min);}vec3 aces(vec3 color){float a=2.51;float b=0.03;float c=2.43;float d=0.59;float e=0.14;return clamp((color*(a*color+b))/(color*(c*color+d)+e),0.0,1.0);}bool intersectSphere(vec3 rayOrigin,vec3 rayDirection,float radius,inout float t1,inout float t2){float b=dot(rayDirection,rayOrigin);float c=dot(rayOrigin,rayOrigin)-radius*radius;float d=b*b-c;if(d<0.0){return false;}t1=-b-sqrt(d);t2=-b+sqrt(d);return true;}bool intersectSphere(vec3 rayOrigin,vec3 rayDirection,float radius,inout float t){float b=dot(rayDirection,rayOrigin);float c=dot(rayOrigin,rayOrigin)-radius*radius;float d=b*b-c;if(d<0.0){return false;}t=-b-sqrt(d);return true;}float intersectSphere(vec3 ro,vec3 rd,vec4 sph){vec3 oc=ro-sph.xyz;float b=dot(oc,rd);float c=dot(oc,oc)-sph.w*sph.w;float h=b*b-c;if(h<0.0)return-1.0;h=sqrt(h);return-b-h;}bool intersectEllipsoid(in vec3 ro,in vec3 rd,in vec3 ra,inout float t){vec3 ocn=ro/ra;vec3 rdn=rd/ra;float a=dot(rdn,rdn);float b=dot(ocn,rdn);float c=dot(ocn,ocn);float h=b*b-a*(c-1.0);if(h<0.0){return false;}t=(-b-sqrt(h))/a;return true;}bool intersectEllipsoid(in vec3 ro,in vec3 rd,in vec3 ra,inout float t1,inout float t2){vec3 ocn=ro/ra;vec3 rdn=rd/ra;float a=dot(rdn,rdn);float b=dot(ocn,rdn);float c=dot(ocn,ocn);float h=b*b-a*(c-1.0);if(h<0.0){return false;}h=sqrt(h);t1=(-b-h)/a;t2=(-b+h)/a;return true;}vec3 normalEllipsoid(in vec3 pos,in vec3 ra){return normalize(pos/(ra*ra));}\n#define PI 3.1415926538\n#define ATMOS_HEIGHT float(${ATMOS_HEIGHT})\n#define RAYLEIGH_SCALE float(${RAYLEIGH_SCALE})\n#define MIE_SCALE float(${MIE_SCALE})\n#define SAMPLE_COUNT 16\n#define SQRT_SAMPLE_COUNT 4\nconst float GROUND_ALBEDO=float(${GROUND_ALBEDO})/PI;const float BOTTOM_RADIUS=float(${BOTTOM_RADIUS});const float TOP_RADIUS=BOTTOM_RADIUS+ATMOS_HEIGHT;const float EQUATORIAL_RADIUS=6378137.0;const vec3 bottomRadii=vec3(EQUATORIAL_RADIUS,EQUATORIAL_RADIUS,BOTTOM_RADIUS);const vec3 topRadii=bottomRadii+ATMOS_HEIGHT;const vec3 SPHERE_TO_ELLIPSOID_SCALE=vec3(BOTTOM_RADIUS)/bottomRadii;const vec2 rayleighMieHeights=vec2(RAYLEIGH_SCALE,MIE_SCALE)*ATMOS_HEIGHT;const vec3 rayleighScatteringCoefficient=vec3(float(${rayleighScatteringCoefficient_0}),float(${rayleighScatteringCoefficient_1}),float(${rayleighScatteringCoefficient_2}))*1e-6;const float mieScatteringCoefficient=float(${mieScatteringCoefficient})*1e-6;const float mieExtinctionCoefficient=float(${mieExtinctionCoefficient})*1e-6;const vec3 ozoneAbsorptionCoefficient=vec3(float(${ozoneAbsorptionCoefficient_0}),float(${ozoneAbsorptionCoefficient_1}),float(${ozoneAbsorptionCoefficient_2}))*1e-6;const float SUN_ANGULAR_RADIUS=float(${SUN_ANGULAR_RADIUS});const float SUN_INTENSITY=float(${SUN_INTENSITY});const float ozoneDensityHeight=float(${ozoneDensityHeight});const float ozoneDensityWide=float(${ozoneDensityWide});vec3 sunWithBloom(vec3 rayDir,vec3 sunDir){float minSunCosTheta=cos(SUN_ANGULAR_RADIUS);float cosTheta=dot(rayDir,sunDir);if(cosTheta>=minSunCosTheta)return vec3(1.0);float offset=minSunCosTheta-cosTheta;float gaussianBloom=exp(-offset*15000.0)*0.7;float invBloom=1.0/(0.09+offset*200.0)*0.01;return vec3(gaussianBloom+invBloom);}float rayleighPhase(float angle){return 3.0/(16.0*PI)*(1.0+(angle*angle));}float miePhase(float angle){float g=0.8;return 3.0/(8.0*PI)*((1.0-g*g)*(1.0+angle*angle))/((2.0+g*g)*pow(1.0+g*g-2.0*g*angle,1.5));}vec3 opticalDepth(float height,float angle){vec3 rayOrigin=vec3(0.0,BOTTOM_RADIUS+height,0.0);vec3 rayDirection=vec3(sqrt(1.0-angle*angle),angle,0.0);float t1,t2;intersectSphere(rayOrigin,rayDirection,TOP_RADIUS,t1,t2);float segmentLength=t2/float(SAMPLE_COUNT);float t=segmentLength*0.5;vec3 opticalDepth=vec3(0.0);for(int i=0;i<SAMPLE_COUNT;i++){vec3 position=rayOrigin+t*rayDirection;float height=length(position)-BOTTOM_RADIUS;opticalDepth.xy+=exp(-height/rayleighMieHeights)*segmentLength;opticalDepth.z+=(1.0-min(abs(height-ozoneDensityHeight)/ozoneDensityWide,1.0))*segmentLength;t+=segmentLength;}return opticalDepth;}vec3 transmittance(float height,float angle){vec3 opticalDepth=opticalDepth(height,angle);return exp(-(rayleighScatteringCoefficient*opticalDepth.x+mieExtinctionCoefficient*opticalDepth.y+ozoneAbsorptionCoefficient*opticalDepth.z));}uniform vec4 specular;uniform vec3 diffuse;uniform vec3 ambient;uniform vec3 lightPosition;uniform sampler2D uNormalMap;uniform sampler2D nightTexture;uniform sampler2D specularTexture;uniform sampler2D transmittanceTexture;uniform sampler2D scatteringTexture;uniform sampler2D defaultTexture;uniform sampler2D samplerArr[SLICE_SIZE];uniform vec4 tileOffsetArr[SLICE_SIZE];uniform float layerOpacityArr[SLICE_SIZE];uniform int samplerCount;uniform float nightTextureCoefficient;uniform vec2 maxMinOpacity;uniform float camHeight;uniform float transitionOpacity;in vec4 vTextureCoord;in vec3 v_vertex;in vec3 cameraPosition;in vec2 vGlobalTextureCoord;in float v_height;vec3 sunPos;layout(location=0)out vec4 diffuseColor;vec3 transmittanceFromTexture(float height,float angle){float u=(angle+1.0)*0.5;float v=height/ATMOS_HEIGHT;return texture(transmittanceTexture,vec2(u,v)).xyz;}vec3 multipleScatteringContributionFromTexture(float height,float angle){float u=(angle+1.0)*0.5;float v=height/ATMOS_HEIGHT;return texture(scatteringTexture,vec2(u,v)).xyz;}void getSunIlluminance(in vec3 point,in vec3 lightDir,out vec3 sunIlluminance){float mu_s=dot(normalize(point),lightDir);float height=length(point)-BOTTOM_RADIUS;sunIlluminance=SUN_INTENSITY*transmittanceFromTexture(height,mu_s);}void atmosGroundColor(out vec4 fragColor,in vec3 normal){vec3 cameraPosition=cameraPosition;if(length(cameraPosition*SPHERE_TO_ELLIPSOID_SCALE)<BOTTOM_RADIUS+1.0){cameraPosition=normalize(cameraPosition*SPHERE_TO_ELLIPSOID_SCALE)*(BOTTOM_RADIUS+1.0)/SPHERE_TO_ELLIPSOID_SCALE;}vec3 rayDirection=normalize(v_vertex-cameraPosition);vec3 lightDir=normalize(sunPos);rayDirection=normalize(rayDirection*SPHERE_TO_ELLIPSOID_SCALE);vec3 camPos=cameraPosition*SPHERE_TO_ELLIPSOID_SCALE;lightDir=normalize(lightDir*SPHERE_TO_ELLIPSOID_SCALE);vec3 light=vec3(0.0);vec3 transmittanceFromCameraToSpace=vec3(1.0);float offset=0.0;float distanceToSpace=0.0;intersectSphere(camPos,rayDirection,TOP_RADIUS,offset,distanceToSpace);vec3 rayOrigin=camPos;if(offset>0.0){rayOrigin+=rayDirection*offset;}float height=length(rayOrigin)-BOTTOM_RADIUS;float rayAngle=dot(rayOrigin,rayDirection)/length(rayOrigin);bool cameraBelow=rayAngle<0.0;transmittanceFromCameraToSpace=transmittanceFromTexture(height,cameraBelow ?-rayAngle : rayAngle);float phaseAngle=dot(lightDir,rayDirection);float rayleighPhase=rayleighPhase(phaseAngle);float miePhase=miePhase(phaseAngle);float distanceToGround=0.0;bool hitGround=intersectSphere(camPos,rayDirection,BOTTOM_RADIUS,distanceToGround)&&distanceToGround>0.0;if(length(v_vertex*SPHERE_TO_ELLIPSOID_SCALE)>BOTTOM_RADIUS){distanceToGround=distance(camPos,v_vertex*SPHERE_TO_ELLIPSOID_SCALE);}float segmentLength=(distanceToGround-max(offset,0.0))/float(SAMPLE_COUNT);float t=segmentLength*0.5;vec3 transmittanceCamera;vec3 transmittanceLight;for(int i=0;i<SAMPLE_COUNT;i++){vec3 position=rayOrigin+t*rayDirection;float height=length(position)-BOTTOM_RADIUS;vec3 up=position/length(position);float rayAngle=dot(up,rayDirection);float lightAngle=dot(up,lightDir);vec3 transmittanceToSpace=transmittanceFromTexture(height,cameraBelow ?-rayAngle : rayAngle);transmittanceCamera=cameraBelow ?(transmittanceToSpace/transmittanceFromCameraToSpace):(transmittanceFromCameraToSpace/transmittanceToSpace);transmittanceLight=transmittanceFromTexture(height,lightAngle);vec2 opticalDensity=exp(-height/rayleighMieHeights);vec3 scatteredLight=transmittanceLight*(rayleighScatteringCoefficient*opticalDensity.x*rayleighPhase+mieScatteringCoefficient*opticalDensity.y*miePhase);scatteredLight+=multipleScatteringContributionFromTexture(height,lightAngle)*(rayleighScatteringCoefficient*opticalDensity.x+mieScatteringCoefficient*opticalDensity.y);light+=transmittanceCamera*scatteredLight*segmentLength;t+=segmentLength;}light*=SUN_INTENSITY;vec3 hitPoint=camPos+rayDirection*distanceToGround;vec3 up=normalize(hitPoint);float diffuseAngle=max(dot(up,lightDir),0.0);float lightAngle=dot(normal,lightDir);vec3 tA=transmittanceCamera*GROUND_ALBEDO*SUN_INTENSITY;vec3 scatteringLight=multipleScatteringContributionFromTexture(height,lightAngle);vec3 diffuseTransmittanceLight=transmittanceLight*diffuseAngle;light+=tA*(scatteringLight+diffuseTransmittanceLight);fragColor=vec4(pow(light*8.0,vec3(1.0/2.2)),1.0);}void getAtmosFadingOpacity(out float opacity){float c=length(cameraPosition);float maxDist=sqrt(c*c-BOTTOM_RADIUS*BOTTOM_RADIUS);float minDist=c-BOTTOM_RADIUS;float vertDist=distance(cameraPosition,v_vertex);opacity=clamp(maxMinOpacity.y+(maxMinOpacity.x-maxMinOpacity.y)*getLerpValue(minDist,maxDist,vertDist),0.0,1.0);}void main(void){sunPos=lightPosition;vec3 texNormal=texture(uNormalMap,vTextureCoord.zw).rgb;vec3 normal=normalize((texNormal-0.5)*2.0);float minH=1200000.0;float maxH=minH*3.0;float nightCoef=getLerpValue(minH,maxH,camHeight)*nightTextureCoefficient;vec3 lightDir=normalize(sunPos);vec3 viewDir=normalize(cameraPosition-v_vertex);vec4 atmosColor;atmosGroundColor(atmosColor,normal);vec3 sunIlluminance;getSunIlluminance(v_vertex*SPHERE_TO_ELLIPSOID_SCALE,lightDir*SPHERE_TO_ELLIPSOID_SCALE,sunIlluminance);float overGround=1.0-step(0.1,v_height);float shininess=texture(specularTexture,vGlobalTextureCoord.st).r*255.0*overGround;vec3 reflectionDirection=reflect(-lightDir,normal);float reflection=max(dot(reflectionDirection,viewDir),0.0);vec3 spec=sunIlluminance*specular.rgb*pow(reflection,specular.w)*shininess;float diffuseLightWeighting=max(dot(normal,lightDir),0.0);vec4 nightImageColor=texture(nightTexture,vGlobalTextureCoord.st);vec3 night=nightStep*(.18-diffuseLightWeighting*3.0)*nightImageColor.rgb*nightCoef;night*=overGround*step(0.0,night);vec4 lightWeighting=vec4(ambient+sunIlluminance*diffuse*diffuseLightWeighting+night,1.0);float fadingOpacity;getAtmosFadingOpacity(fadingOpacity);getSunIlluminance(cameraPosition,viewDir*SPHERE_TO_ELLIPSOID_SCALE,sunIlluminance);spec*=sunIlluminance;diffuseColor=texture(defaultTexture,vTextureCoord.xy);if(samplerCount==0){diffuseColor=mix(diffuseColor*lightWeighting,atmosColor,fadingOpacity)+vec4(spec,0.0);diffuseColor*=transitionOpacity;return;}vec4 src;blend(diffuseColor,samplerArr[0],tileOffsetArr[0],layerOpacityArr[0]);if(samplerCount==1){diffuseColor=mix(diffuseColor*lightWeighting,atmosColor*diffuseColor.a,fadingOpacity)+vec4(spec,0.0);diffuseColor*=transitionOpacity;return;}blend(diffuseColor,samplerArr[1],tileOffsetArr[1],layerOpacityArr[1]);if(samplerCount==2){diffuseColor=mix(diffuseColor*lightWeighting,atmosColor*diffuseColor.a,fadingOpacity)+vec4(spec,0.0);diffuseColor*=transitionOpacity;return;}blend(diffuseColor,samplerArr[2],tileOffsetArr[2],layerOpacityArr[2]);if(samplerCount==3){diffuseColor=mix(diffuseColor*lightWeighting,atmosColor*diffuseColor.a,fadingOpacity)+vec4(spec,0.0);diffuseColor*=transitionOpacity;return;}blend(diffuseColor,samplerArr[3],tileOffsetArr[3],layerOpacityArr[3]);if(samplerCount==4){diffuseColor=mix(diffuseColor*lightWeighting,atmosColor*diffuseColor.a,fadingOpacity)+vec4(spec,0.0);diffuseColor*=transitionOpacity;return;}blend(diffuseColor,samplerArr[4],tileOffsetArr[4],layerOpacityArr[4]);diffuseColor=mix(diffuseColor*lightWeighting,atmosColor*diffuseColor.a,fadingOpacity)+vec4(spec,0.0);diffuseColor*=transitionOpacity;}",l)})}var Oh="attribute vec2 corners;void main(void){gl_Position=vec4(corners,0.0,1.0);}",Nh="precision lowp float;float getLerpValue(in float min,in float max,in float between){return(clamp(between,min,max)-min)/(max-min);}vec3 aces(vec3 color){float a=2.51;float b=0.03;float c=2.43;float d=0.59;float e=0.14;return clamp((color*(a*color+b))/(color*(c*color+d)+e),0.0,1.0);}bool intersectSphere(vec3 rayOrigin,vec3 rayDirection,float radius,inout float t1,inout float t2){float b=dot(rayDirection,rayOrigin);float c=dot(rayOrigin,rayOrigin)-radius*radius;float d=b*b-c;if(d<0.0){return false;}t1=-b-sqrt(d);t2=-b+sqrt(d);return true;}bool intersectSphere(vec3 rayOrigin,vec3 rayDirection,float radius,inout float t){float b=dot(rayDirection,rayOrigin);float c=dot(rayOrigin,rayOrigin)-radius*radius;float d=b*b-c;if(d<0.0){return false;}t=-b-sqrt(d);return true;}float intersectSphere(vec3 ro,vec3 rd,vec4 sph){vec3 oc=ro-sph.xyz;float b=dot(oc,rd);float c=dot(oc,oc)-sph.w*sph.w;float h=b*b-c;if(h<0.0)return-1.0;h=sqrt(h);return-b-h;}bool intersectEllipsoid(in vec3 ro,in vec3 rd,in vec3 ra,inout float t){vec3 ocn=ro/ra;vec3 rdn=rd/ra;float a=dot(rdn,rdn);float b=dot(ocn,rdn);float c=dot(ocn,ocn);float h=b*b-a*(c-1.0);if(h<0.0){return false;}t=(-b-sqrt(h))/a;return true;}bool intersectEllipsoid(in vec3 ro,in vec3 rd,in vec3 ra,inout float t1,inout float t2){vec3 ocn=ro/ra;vec3 rdn=rd/ra;float a=dot(rdn,rdn);float b=dot(ocn,rdn);float c=dot(ocn,ocn);float h=b*b-a*(c-1.0);if(h<0.0){return false;}h=sqrt(h);t1=(-b-h)/a;t2=(-b+h)/a;return true;}vec3 normalEllipsoid(in vec3 pos,in vec3 ra){return normalize(pos/(ra*ra));}\n#define PI 3.1415926538\n#define ATMOS_HEIGHT float(${ATMOS_HEIGHT})\n#define RAYLEIGH_SCALE float(${RAYLEIGH_SCALE})\n#define MIE_SCALE float(${MIE_SCALE})\n#define SAMPLE_COUNT 16\n#define SQRT_SAMPLE_COUNT 4\nconst float GROUND_ALBEDO=float(${GROUND_ALBEDO})/PI;const float BOTTOM_RADIUS=float(${BOTTOM_RADIUS});const float TOP_RADIUS=BOTTOM_RADIUS+ATMOS_HEIGHT;const float EQUATORIAL_RADIUS=6378137.0;const vec3 bottomRadii=vec3(EQUATORIAL_RADIUS,EQUATORIAL_RADIUS,BOTTOM_RADIUS);const vec3 topRadii=bottomRadii+ATMOS_HEIGHT;const vec3 SPHERE_TO_ELLIPSOID_SCALE=vec3(BOTTOM_RADIUS)/bottomRadii;const vec2 rayleighMieHeights=vec2(RAYLEIGH_SCALE,MIE_SCALE)*ATMOS_HEIGHT;const vec3 rayleighScatteringCoefficient=vec3(float(${rayleighScatteringCoefficient_0}),float(${rayleighScatteringCoefficient_1}),float(${rayleighScatteringCoefficient_2}))*1e-6;const float mieScatteringCoefficient=float(${mieScatteringCoefficient})*1e-6;const float mieExtinctionCoefficient=float(${mieExtinctionCoefficient})*1e-6;const vec3 ozoneAbsorptionCoefficient=vec3(float(${ozoneAbsorptionCoefficient_0}),float(${ozoneAbsorptionCoefficient_1}),float(${ozoneAbsorptionCoefficient_2}))*1e-6;const float SUN_ANGULAR_RADIUS=float(${SUN_ANGULAR_RADIUS});const float SUN_INTENSITY=float(${SUN_INTENSITY});const float ozoneDensityHeight=float(${ozoneDensityHeight});const float ozoneDensityWide=float(${ozoneDensityWide});vec3 sunWithBloom(vec3 rayDir,vec3 sunDir){float minSunCosTheta=cos(SUN_ANGULAR_RADIUS);float cosTheta=dot(rayDir,sunDir);if(cosTheta>=minSunCosTheta)return vec3(1.0);float offset=minSunCosTheta-cosTheta;float gaussianBloom=exp(-offset*15000.0)*0.7;float invBloom=1.0/(0.09+offset*200.0)*0.01;return vec3(gaussianBloom+invBloom);}float rayleighPhase(float angle){return 3.0/(16.0*PI)*(1.0+(angle*angle));}float miePhase(float angle){float g=0.8;return 3.0/(8.0*PI)*((1.0-g*g)*(1.0+angle*angle))/((2.0+g*g)*pow(1.0+g*g-2.0*g*angle,1.5));}vec3 opticalDepth(float height,float angle){vec3 rayOrigin=vec3(0.0,BOTTOM_RADIUS+height,0.0);vec3 rayDirection=vec3(sqrt(1.0-angle*angle),angle,0.0);float t1,t2;intersectSphere(rayOrigin,rayDirection,TOP_RADIUS,t1,t2);float segmentLength=t2/float(SAMPLE_COUNT);float t=segmentLength*0.5;vec3 opticalDepth=vec3(0.0);for(int i=0;i<SAMPLE_COUNT;i++){vec3 position=rayOrigin+t*rayDirection;float height=length(position)-BOTTOM_RADIUS;opticalDepth.xy+=exp(-height/rayleighMieHeights)*segmentLength;opticalDepth.z+=(1.0-min(abs(height-ozoneDensityHeight)/ozoneDensityWide,1.0))*segmentLength;t+=segmentLength;}return opticalDepth;}vec3 transmittance(float height,float angle){vec3 opticalDepth=opticalDepth(height,angle);return exp(-(rayleighScatteringCoefficient*opticalDepth.x+mieExtinctionCoefficient*opticalDepth.y+ozoneAbsorptionCoefficient*opticalDepth.z));}\n#define DISABLE_SUN_DISK ${disableSunDisk}\nuniform mat4 viewMatrix;uniform vec3 sunPos;uniform vec3 camPos;uniform vec2 iResolution;uniform float fov;uniform float opacity;uniform sampler2D transmittanceTexture;uniform sampler2D scatteringTexture;float valueHSV(vec3 rgb){return max(max(rgb.r,rgb.g),rgb.b);}vec3 transmittanceFromTexture(float height,float angle){float u=(angle+1.0)*0.5;float v=height/ATMOS_HEIGHT;return texture2D(transmittanceTexture,vec2(u,v)).xyz;}vec3 multipleScatteringContributionFromTexture(float height,float angle){float u=(angle+1.0)*0.5;float v=height/ATMOS_HEIGHT;return texture2D(scatteringTexture,vec2(u,v)).xyz;}bool intersectEllipsoidToSphere(in vec3 ro,in vec3 rd,in vec3 ellRadii,in float sphereRadius,out float t1,out float t2){float offset=0.0,distanceToSpace=0.0;if(intersectEllipsoid(ro,rd,ellRadii,offset,distanceToSpace)){vec3 hitEll=ro+rd*offset;vec3 nEll=normalEllipsoid(hitEll,ellRadii);float t=0.0;bool intersectsSphere=intersectSphere(hitEll,nEll,sphereRadius,t);vec3 hitSphere=hitEll+nEll*t;t1=length(hitSphere-ro);hitEll=ro+rd*distanceToSpace;nEll=normalEllipsoid(hitEll,ellRadii);t=0.0;intersectsSphere=intersectSphere(hitEll,nEll,sphereRadius,t);hitSphere=hitEll+nEll*t;t2=length(hitSphere-ro);return true;}return false;}mat4 transpose(in mat4 m){vec4 i0=m[0];vec4 i1=m[1];vec4 i2=m[2];vec4 i3=m[3];mat4 outMatrix=mat4(vec4(i0.x,i1.x,i2.x,i3.x),vec4(i0.y,i1.y,i2.y,i3.y),vec4(i0.z,i1.z,i2.z,i3.z),vec4(i0.w,i1.w,i2.w,i3.w));return outMatrix;}void mainImage(out vec4 fragColor){vec3 cameraPosition=camPos;vec3 lightDirection=normalize(sunPos);vec2 uv=(2.0*gl_FragCoord.xy-iResolution.xy)/iResolution.y;float fieldOfView=fov;float z=1.0/tan(fieldOfView*0.5*PI/180.0);vec3 rayDirection=normalize(vec3(uv,-z));vec4 rd=transpose(viewMatrix)*vec4(rayDirection,1.0);rayDirection=rd.xyz;vec3 light=vec3(0.0);vec3 transmittanceFromCameraToSpace=vec3(1.0);float offset=0.0;float distanceToSpace=0.0;rayDirection=normalize(rayDirection*SPHERE_TO_ELLIPSOID_SCALE);cameraPosition*=SPHERE_TO_ELLIPSOID_SCALE;lightDirection=normalize(lightDirection*SPHERE_TO_ELLIPSOID_SCALE);if(length(cameraPosition)<BOTTOM_RADIUS+100.0){cameraPosition=normalize(cameraPosition)*(BOTTOM_RADIUS+100.0);}if(intersectSphere(cameraPosition,rayDirection,TOP_RADIUS,offset,distanceToSpace)){vec3 rayOrigin=cameraPosition;if(offset>0.0){rayOrigin=cameraPosition+rayDirection*offset;}float height=length(rayOrigin)-BOTTOM_RADIUS;float rayAngle=dot(rayOrigin,rayDirection)/length(rayOrigin);bool cameraBelow=rayAngle<0.0;transmittanceFromCameraToSpace=transmittanceFromTexture(height,cameraBelow ?-rayAngle : rayAngle);float phaseAngle=dot(lightDirection,rayDirection);float rayleighPhase=rayleighPhase(phaseAngle);float miePhase=miePhase(phaseAngle);float distanceToGround=0.0;bool hitGround=intersectSphere(cameraPosition,rayDirection,BOTTOM_RADIUS,distanceToGround)&&distanceToGround>0.0;if(intersectSphere(cameraPosition,rayDirection,BOTTOM_RADIUS-100000.0,distanceToGround)&&hitGround){fragColor=vec4(0.47,0.47,0.5,1.0);return;}float segmentLength=abs(((hitGround ? distanceToGround : distanceToSpace)-max(offset,0.0))/float(SAMPLE_COUNT));float t=segmentLength*0.5;vec3 transmittanceCamera;vec3 transmittanceLight;for(int i=0;i<SAMPLE_COUNT;i++){vec3 position=rayOrigin+t*rayDirection;float height=length(position)-BOTTOM_RADIUS;vec3 up=position/length(position);float rayAngle=dot(up,rayDirection);float lightAngle=dot(up,lightDirection);vec3 transmittanceToSpace=transmittanceFromTexture(height,cameraBelow ?-rayAngle : rayAngle);transmittanceCamera=cameraBelow ?(transmittanceToSpace/transmittanceFromCameraToSpace):(transmittanceFromCameraToSpace/transmittanceToSpace);transmittanceLight=transmittanceFromTexture(height,lightAngle);vec2 opticalDensity=exp(-height/rayleighMieHeights);vec3 scatteredLight=transmittanceLight*(rayleighScatteringCoefficient*opticalDensity.x*rayleighPhase+mieScatteringCoefficient*opticalDensity.y*miePhase);scatteredLight+=multipleScatteringContributionFromTexture(height,lightAngle)*(rayleighScatteringCoefficient*opticalDensity.x+mieScatteringCoefficient*opticalDensity.y);light+=transmittanceCamera*scatteredLight*segmentLength;t+=segmentLength;}light*=SUN_INTENSITY;if(hitGround){vec3 hitPoint=cameraPosition+rayDirection*distanceToGround;vec3 up=hitPoint/length(hitPoint);float diffuseAngle=max(dot(up,lightDirection),0.0);float lightAngle=dot(up,lightDirection);light+=transmittanceCamera*GROUND_ALBEDO*multipleScatteringContributionFromTexture(height,lightAngle)*SUN_INTENSITY;light+=transmittanceCamera*transmittanceLight*GROUND_ALBEDO*diffuseAngle*SUN_INTENSITY;}}\n#if !DISABLE_SUN_DISK\n{float distanceToGround=0.0;bool hitGround=intersectSphere(cameraPosition,rayDirection,BOTTOM_RADIUS,distanceToGround)&&distanceToGround>0.0;if(!hitGround){vec3 sunLum=sunWithBloom(rayDirection,lightDirection)*vec3(1.0,1.0,0.8);sunLum=smoothstep(0.002,1.0,sunLum);light+=sunLum*SUN_INTENSITY*transmittanceFromCameraToSpace;}}\n#endif\nvec4 color=vec4(pow(opacity*light*8.0,vec3(1.0/2.2)),valueHSV(light)*clamp(opacity,0.0,1.0));fragColor=color;}void main(void){mainImage(gl_FragColor);}";class Hh extends Z{constructor(e={}){super({name:"Atmosphere",...e}),this._transmittanceBuffer=null,this._scatteringBuffer=null,this.opacity=1,this._parameters={ATMOS_HEIGHT:e.height||1e5,RAYLEIGH_SCALE:e.rayleighScale||.08,MIE_SCALE:e.mieScale||.012,GROUND_ALBEDO:e.groundAlbedo||.05,BOTTOM_RADIUS:e.bottomRadius||6356752314245179e-9,rayleighScatteringCoefficient_0:e.rayleighScatteringCoefficient_0||5.802,rayleighScatteringCoefficient_1:e.rayleighScatteringCoefficient_1||13.558,rayleighScatteringCoefficient_2:e.rayleighScatteringCoefficient_2||33.1,mieScatteringCoefficient:e.mieScatteringCoefficient||3.996,mieExtinctionCoefficient:e.mieExtinctionCoefficient||4.44,ozoneAbsorptionCoefficient_0:e.ozoneAbsorptionCoefficient_0||.65,ozoneAbsorptionCoefficient_1:e.ozoneAbsorptionCoefficient_1||1.881,ozoneAbsorptionCoefficient_2:e.ozoneAbsorptionCoefficient_2||.085,SUN_ANGULAR_RADIUS:e.sunAngularRadius||.004685,SUN_INTENSITY:e.sunIntensity||1,ozoneDensityHeight:e.ozoneDensityHeight||25e3,ozoneDensityWide:e.ozoneDensityWide||15e3,disableSunDisk:e.disableSunDisk}}setParameters(e){this._parameters=JSON.parse(JSON.stringify(e)),this.initLookupTexturesShaders(),this.drawLookupTextures(),this.removeLookupTexturesShaders(),this.initPlanetAtmosphereShader()}get parameters(){return JSON.parse(JSON.stringify(this._parameters))}initPlanetAtmosphereShader(){var e;(e=this.planet)==null||e.initAtmosphereShader(this._parameters)}oninit(){this.renderer&&(this._initLookupTextures(),this.initLookupTexturesShaders(),this.drawLookupTextures(),this.removeLookupTexturesShaders(),this.initBackgroundShader(),this.activate())}initLookupTexturesShaders(){var e,t;this.renderer&&(this.renderer.handler.addProgram((e=this._parameters,new $("transmittance",{uniforms:{iResolution:"vec2"},attributes:{a_position:"vec2"},vertexShader:"attribute vec2 a_position;void main(void){gl_Position=vec4(a_position,0.0,1.0);}",fragmentShader:hi("precision highp float;float getLerpValue(in float min,in float max,in float between){return(clamp(between,min,max)-min)/(max-min);}vec3 aces(vec3 color){float a=2.51;float b=0.03;float c=2.43;float d=0.59;float e=0.14;return clamp((color*(a*color+b))/(color*(c*color+d)+e),0.0,1.0);}bool intersectSphere(vec3 rayOrigin,vec3 rayDirection,float radius,inout float t1,inout float t2){float b=dot(rayDirection,rayOrigin);float c=dot(rayOrigin,rayOrigin)-radius*radius;float d=b*b-c;if(d<0.0){return false;}t1=-b-sqrt(d);t2=-b+sqrt(d);return true;}bool intersectSphere(vec3 rayOrigin,vec3 rayDirection,float radius,inout float t){float b=dot(rayDirection,rayOrigin);float c=dot(rayOrigin,rayOrigin)-radius*radius;float d=b*b-c;if(d<0.0){return false;}t=-b-sqrt(d);return true;}float intersectSphere(vec3 ro,vec3 rd,vec4 sph){vec3 oc=ro-sph.xyz;float b=dot(oc,rd);float c=dot(oc,oc)-sph.w*sph.w;float h=b*b-c;if(h<0.0)return-1.0;h=sqrt(h);return-b-h;}bool intersectEllipsoid(in vec3 ro,in vec3 rd,in vec3 ra,inout float t){vec3 ocn=ro/ra;vec3 rdn=rd/ra;float a=dot(rdn,rdn);float b=dot(ocn,rdn);float c=dot(ocn,ocn);float h=b*b-a*(c-1.0);if(h<0.0){return false;}t=(-b-sqrt(h))/a;return true;}bool intersectEllipsoid(in vec3 ro,in vec3 rd,in vec3 ra,inout float t1,inout float t2){vec3 ocn=ro/ra;vec3 rdn=rd/ra;float a=dot(rdn,rdn);float b=dot(ocn,rdn);float c=dot(ocn,ocn);float h=b*b-a*(c-1.0);if(h<0.0){return false;}h=sqrt(h);t1=(-b-h)/a;t2=(-b+h)/a;return true;}vec3 normalEllipsoid(in vec3 pos,in vec3 ra){return normalize(pos/(ra*ra));}\n#define PI 3.1415926538\n#define ATMOS_HEIGHT float(${ATMOS_HEIGHT})\n#define RAYLEIGH_SCALE float(${RAYLEIGH_SCALE})\n#define MIE_SCALE float(${MIE_SCALE})\n#define SAMPLE_COUNT 16\n#define SQRT_SAMPLE_COUNT 4\nconst float GROUND_ALBEDO=float(${GROUND_ALBEDO})/PI;const float BOTTOM_RADIUS=float(${BOTTOM_RADIUS});const float TOP_RADIUS=BOTTOM_RADIUS+ATMOS_HEIGHT;const float EQUATORIAL_RADIUS=6378137.0;const vec3 bottomRadii=vec3(EQUATORIAL_RADIUS,EQUATORIAL_RADIUS,BOTTOM_RADIUS);const vec3 topRadii=bottomRadii+ATMOS_HEIGHT;const vec3 SPHERE_TO_ELLIPSOID_SCALE=vec3(BOTTOM_RADIUS)/bottomRadii;const vec2 rayleighMieHeights=vec2(RAYLEIGH_SCALE,MIE_SCALE)*ATMOS_HEIGHT;const vec3 rayleighScatteringCoefficient=vec3(float(${rayleighScatteringCoefficient_0}),float(${rayleighScatteringCoefficient_1}),float(${rayleighScatteringCoefficient_2}))*1e-6;const float mieScatteringCoefficient=float(${mieScatteringCoefficient})*1e-6;const float mieExtinctionCoefficient=float(${mieExtinctionCoefficient})*1e-6;const vec3 ozoneAbsorptionCoefficient=vec3(float(${ozoneAbsorptionCoefficient_0}),float(${ozoneAbsorptionCoefficient_1}),float(${ozoneAbsorptionCoefficient_2}))*1e-6;const float SUN_ANGULAR_RADIUS=float(${SUN_ANGULAR_RADIUS});const float SUN_INTENSITY=float(${SUN_INTENSITY});const float ozoneDensityHeight=float(${ozoneDensityHeight});const float ozoneDensityWide=float(${ozoneDensityWide});vec3 sunWithBloom(vec3 rayDir,vec3 sunDir){float minSunCosTheta=cos(SUN_ANGULAR_RADIUS);float cosTheta=dot(rayDir,sunDir);if(cosTheta>=minSunCosTheta)return vec3(1.0);float offset=minSunCosTheta-cosTheta;float gaussianBloom=exp(-offset*15000.0)*0.7;float invBloom=1.0/(0.09+offset*200.0)*0.01;return vec3(gaussianBloom+invBloom);}float rayleighPhase(float angle){return 3.0/(16.0*PI)*(1.0+(angle*angle));}float miePhase(float angle){float g=0.8;return 3.0/(8.0*PI)*((1.0-g*g)*(1.0+angle*angle))/((2.0+g*g)*pow(1.0+g*g-2.0*g*angle,1.5));}vec3 opticalDepth(float height,float angle){vec3 rayOrigin=vec3(0.0,BOTTOM_RADIUS+height,0.0);vec3 rayDirection=vec3(sqrt(1.0-angle*angle),angle,0.0);float t1,t2;intersectSphere(rayOrigin,rayDirection,TOP_RADIUS,t1,t2);float segmentLength=t2/float(SAMPLE_COUNT);float t=segmentLength*0.5;vec3 opticalDepth=vec3(0.0);for(int i=0;i<SAMPLE_COUNT;i++){vec3 position=rayOrigin+t*rayDirection;float height=length(position)-BOTTOM_RADIUS;opticalDepth.xy+=exp(-height/rayleighMieHeights)*segmentLength;opticalDepth.z+=(1.0-min(abs(height-ozoneDensityHeight)/ozoneDensityWide,1.0))*segmentLength;t+=segmentLength;}return opticalDepth;}vec3 transmittance(float height,float angle){vec3 opticalDepth=opticalDepth(height,angle);return exp(-(rayleighScatteringCoefficient*opticalDepth.x+mieExtinctionCoefficient*opticalDepth.y+ozoneAbsorptionCoefficient*opticalDepth.z));}uniform vec2 iResolution;void main(void){vec2 uv=gl_FragCoord.xy/iResolution.xy;float height=uv.y*ATMOS_HEIGHT;float angle=uv.x*2.0-1.0;gl_FragColor=vec4(transmittance(height,angle),1.0);}",e)}))),this.renderer.handler.addProgram((t=this._parameters,new $("scattering",{uniforms:{iResolution:"vec2",transmittanceTexture:"sampler2d"},attributes:{a_position:"vec2"},vertexShader:"attribute vec2 a_position;void main(void){gl_Position=vec4(a_position,0.0,1.0);}",fragmentShader:hi("precision highp float;float getLerpValue(in float min,in float max,in float between){return(clamp(between,min,max)-min)/(max-min);}vec3 aces(vec3 color){float a=2.51;float b=0.03;float c=2.43;float d=0.59;float e=0.14;return clamp((color*(a*color+b))/(color*(c*color+d)+e),0.0,1.0);}bool intersectSphere(vec3 rayOrigin,vec3 rayDirection,float radius,inout float t1,inout float t2){float b=dot(rayDirection,rayOrigin);float c=dot(rayOrigin,rayOrigin)-radius*radius;float d=b*b-c;if(d<0.0){return false;}t1=-b-sqrt(d);t2=-b+sqrt(d);return true;}bool intersectSphere(vec3 rayOrigin,vec3 rayDirection,float radius,inout float t){float b=dot(rayDirection,rayOrigin);float c=dot(rayOrigin,rayOrigin)-radius*radius;float d=b*b-c;if(d<0.0){return false;}t=-b-sqrt(d);return true;}float intersectSphere(vec3 ro,vec3 rd,vec4 sph){vec3 oc=ro-sph.xyz;float b=dot(oc,rd);float c=dot(oc,oc)-sph.w*sph.w;float h=b*b-c;if(h<0.0)return-1.0;h=sqrt(h);return-b-h;}bool intersectEllipsoid(in vec3 ro,in vec3 rd,in vec3 ra,inout float t){vec3 ocn=ro/ra;vec3 rdn=rd/ra;float a=dot(rdn,rdn);float b=dot(ocn,rdn);float c=dot(ocn,ocn);float h=b*b-a*(c-1.0);if(h<0.0){return false;}t=(-b-sqrt(h))/a;return true;}bool intersectEllipsoid(in vec3 ro,in vec3 rd,in vec3 ra,inout float t1,inout float t2){vec3 ocn=ro/ra;vec3 rdn=rd/ra;float a=dot(rdn,rdn);float b=dot(ocn,rdn);float c=dot(ocn,ocn);float h=b*b-a*(c-1.0);if(h<0.0){return false;}h=sqrt(h);t1=(-b-h)/a;t2=(-b+h)/a;return true;}vec3 normalEllipsoid(in vec3 pos,in vec3 ra){return normalize(pos/(ra*ra));}\n#define PI 3.1415926538\n#define ATMOS_HEIGHT float(${ATMOS_HEIGHT})\n#define RAYLEIGH_SCALE float(${RAYLEIGH_SCALE})\n#define MIE_SCALE float(${MIE_SCALE})\n#define SAMPLE_COUNT 16\n#define SQRT_SAMPLE_COUNT 4\nconst float GROUND_ALBEDO=float(${GROUND_ALBEDO})/PI;const float BOTTOM_RADIUS=float(${BOTTOM_RADIUS});const float TOP_RADIUS=BOTTOM_RADIUS+ATMOS_HEIGHT;const float EQUATORIAL_RADIUS=6378137.0;const vec3 bottomRadii=vec3(EQUATORIAL_RADIUS,EQUATORIAL_RADIUS,BOTTOM_RADIUS);const vec3 topRadii=bottomRadii+ATMOS_HEIGHT;const vec3 SPHERE_TO_ELLIPSOID_SCALE=vec3(BOTTOM_RADIUS)/bottomRadii;const vec2 rayleighMieHeights=vec2(RAYLEIGH_SCALE,MIE_SCALE)*ATMOS_HEIGHT;const vec3 rayleighScatteringCoefficient=vec3(float(${rayleighScatteringCoefficient_0}),float(${rayleighScatteringCoefficient_1}),float(${rayleighScatteringCoefficient_2}))*1e-6;const float mieScatteringCoefficient=float(${mieScatteringCoefficient})*1e-6;const float mieExtinctionCoefficient=float(${mieExtinctionCoefficient})*1e-6;const vec3 ozoneAbsorptionCoefficient=vec3(float(${ozoneAbsorptionCoefficient_0}),float(${ozoneAbsorptionCoefficient_1}),float(${ozoneAbsorptionCoefficient_2}))*1e-6;const float SUN_ANGULAR_RADIUS=float(${SUN_ANGULAR_RADIUS});const float SUN_INTENSITY=float(${SUN_INTENSITY});const float ozoneDensityHeight=float(${ozoneDensityHeight});const float ozoneDensityWide=float(${ozoneDensityWide});vec3 sunWithBloom(vec3 rayDir,vec3 sunDir){float minSunCosTheta=cos(SUN_ANGULAR_RADIUS);float cosTheta=dot(rayDir,sunDir);if(cosTheta>=minSunCosTheta)return vec3(1.0);float offset=minSunCosTheta-cosTheta;float gaussianBloom=exp(-offset*15000.0)*0.7;float invBloom=1.0/(0.09+offset*200.0)*0.01;return vec3(gaussianBloom+invBloom);}float rayleighPhase(float angle){return 3.0/(16.0*PI)*(1.0+(angle*angle));}float miePhase(float angle){float g=0.8;return 3.0/(8.0*PI)*((1.0-g*g)*(1.0+angle*angle))/((2.0+g*g)*pow(1.0+g*g-2.0*g*angle,1.5));}vec3 opticalDepth(float height,float angle){vec3 rayOrigin=vec3(0.0,BOTTOM_RADIUS+height,0.0);vec3 rayDirection=vec3(sqrt(1.0-angle*angle),angle,0.0);float t1,t2;intersectSphere(rayOrigin,rayDirection,TOP_RADIUS,t1,t2);float segmentLength=t2/float(SAMPLE_COUNT);float t=segmentLength*0.5;vec3 opticalDepth=vec3(0.0);for(int i=0;i<SAMPLE_COUNT;i++){vec3 position=rayOrigin+t*rayDirection;float height=length(position)-BOTTOM_RADIUS;opticalDepth.xy+=exp(-height/rayleighMieHeights)*segmentLength;opticalDepth.z+=(1.0-min(abs(height-ozoneDensityHeight)/ozoneDensityWide,1.0))*segmentLength;t+=segmentLength;}return opticalDepth;}vec3 transmittance(float height,float angle){vec3 opticalDepth=opticalDepth(height,angle);return exp(-(rayleighScatteringCoefficient*opticalDepth.x+mieExtinctionCoefficient*opticalDepth.y+ozoneAbsorptionCoefficient*opticalDepth.z));}uniform sampler2D transmittanceTexture;uniform vec2 iResolution;vec3 transmittanceFromTexture(float height,float angle){float u=(angle+1.0)*0.5;float v=height/ATMOS_HEIGHT;return texture2D(transmittanceTexture,vec2(u,v)).xyz;}void main(void){vec2 uv=gl_FragCoord.xy/iResolution.xy;float height=uv.y*ATMOS_HEIGHT;float angle=uv.x*2.0-1.0;vec3 rayOrigin=vec3(0.0,BOTTOM_RADIUS+height,0.0);vec3 up=rayOrigin/length(rayOrigin);vec3 lightDirection=vec3(sqrt(1.0-angle*angle),angle,0.0);const float isotropicPhase=1.0/(4.0*PI);vec3 light=vec3(0.0);vec3 lightTransferFactor=vec3(0.0);for(int i=0;i<SQRT_SAMPLE_COUNT;i++){for(int j=0;j<SQRT_SAMPLE_COUNT;j++){float u=((0.5+float(i))/float(SQRT_SAMPLE_COUNT))*2.0-1.0;float v=(0.5+float(j))/float(SQRT_SAMPLE_COUNT);float r=sqrt(1.0-u*u);float theta=2.0*PI*v;vec3 rayDirection=vec3(cos(theta)*r,sin(theta)*r,u);float rayAngle=dot(up,rayDirection);bool cameraBelow=rayAngle<0.0;vec3 transmittanceFromCameraToSpace=transmittanceFromTexture(height,cameraBelow ?-rayAngle : rayAngle);float offset=0.0;float distanceToSpace=0.0;intersectSphere(rayOrigin,rayDirection,TOP_RADIUS,offset,distanceToSpace);float distanceToGround=0.0;bool hitGround=intersectSphere(rayOrigin,rayDirection,BOTTOM_RADIUS,distanceToGround)&&distanceToGround>0.0;float segmentLength=(hitGround ? distanceToGround : distanceToSpace)/float(SAMPLE_COUNT);float t=segmentLength*0.5;vec3 transmittanceCamera;vec3 transmittanceLight;for(int k=0;k<SAMPLE_COUNT;k++){vec3 position=rayOrigin+t*rayDirection;float height=length(position)-BOTTOM_RADIUS;vec3 up=position/length(position);float rayAngle=dot(up,rayDirection);float lightAngle=dot(up,lightDirection);float distanceToGround;float shadow=intersectSphere(position,lightDirection,BOTTOM_RADIUS,distanceToGround)&&distanceToGround>=0.0 ? 0.0 : 1.0;vec3 transmittanceToSpace=transmittanceFromTexture(height,cameraBelow ?-rayAngle : rayAngle);transmittanceCamera=cameraBelow ?(transmittanceToSpace/transmittanceFromCameraToSpace):(transmittanceFromCameraToSpace/transmittanceToSpace);transmittanceLight=transmittanceFromTexture(height,lightAngle);vec2 opticalDensity=exp(-height/rayleighMieHeights);vec3 scatteredLight=transmittanceLight*(rayleighScatteringCoefficient*opticalDensity.x+mieScatteringCoefficient*opticalDensity.y)*isotropicPhase;light+=shadow*transmittanceCamera*scatteredLight*segmentLength;lightTransferFactor+=transmittanceCamera*(rayleighScatteringCoefficient*opticalDensity.x+mieScatteringCoefficient*opticalDensity.y)*segmentLength;t+=segmentLength;}if(hitGround){vec3 hitPoint=rayOrigin+rayDirection*distanceToGround;vec3 normal=normalize(hitPoint);float diffuseAngle=max(dot(normal,lightDirection),0.0);light+=transmittanceCamera*transmittanceLight*GROUND_ALBEDO*diffuseAngle;}}}light/=float(SAMPLE_COUNT);lightTransferFactor/=float(SAMPLE_COUNT);vec3 color=light/(1.0-lightTransferFactor);gl_FragColor=vec4(color,1.0);}",t)}))))}initBackgroundShader(){var e;this.renderer&&this.renderer.handler.addProgram((e=this._parameters,new $("atmosphereBackground",{uniforms:{iResolution:"vec2",fov:"float",camPos:"vec3",viewMatrix:"mat4",transmittanceTexture:"sampler2D",scatteringTexture:"sampler2D",sunPos:"vec3",opacity:"float"},attributes:{corners:"vec3"},vertexShader:Oh,fragmentShader:hi(Nh,{...e,disableSunDisk:e!=null&&e.disableSunDisk?1:0})})))}removeBackgroundShader(){this.renderer&&this.renderer.handler.removeProgram("atmosphereBackground")}removeLookupTexturesShaders(){var e,t;if(this.renderer){let s=this.renderer.handler;(e=this._scatteringBuffer)!=null&&e.isComplete()&&s.removeProgram("scattering"),(t=this._transmittanceBuffer)!=null&&t.isComplete()&&s.removeProgram("transmittance")}}onactivate(){super.onactivate(),this.planet&&this.planet.events.on("draw",this._drawBackground,this)}ondeactivate(){super.ondeactivate(),this.planet&&this.planet.events.off("draw",this._drawBackground)}_initLookupTextures(){this._transmittanceBuffer=new St(this.renderer.handler,{width:1024,height:1024,useDepth:!1,targets:[{filter:"LINEAR",type:"FLOAT",internalFormat:"RGBA16F"}]}),this._transmittanceBuffer.init(),this._scatteringBuffer=new St(this.renderer.handler,{width:1024,height:1024,useDepth:!1,targets:[{filter:"LINEAR",type:"FLOAT",internalFormat:"RGBA16F"}]}),this._scatteringBuffer.init()}_renderLookupTextures(){if(!this.renderer)return;let e=this.renderer.screenFramePositionBuffer,t=this.renderer.handler,s=t.gl;if(this._transmittanceBuffer){this._transmittanceBuffer.activate();let n=t.programs.transmittance,o=n._program.attributes,a=n._program.uniforms;n.activate(),s.clearColor(0,0,0,1),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT),s.uniform2fv(a.iResolution,[this._transmittanceBuffer.width,this._transmittanceBuffer.height]),s.bindBuffer(s.ARRAY_BUFFER,e),s.vertexAttribPointer(o.a_position,e.itemSize,s.FLOAT,!1,0,0),s.drawArrays(s.TRIANGLE_STRIP,0,e.numItems),this._transmittanceBuffer.deactivate()}if(this._scatteringBuffer&&this._transmittanceBuffer){this._scatteringBuffer.activate();let n=t.programs.scattering,o=n._program.attributes,a=n._program.uniforms;n.activate(),s.clearColor(0,0,0,1),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT),s.uniform2fv(a.iResolution,[this._scatteringBuffer.width,this._scatteringBuffer.height]),s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,this._transmittanceBuffer.textures[0]),s.uniform1i(a.transmittanceTexture,0),s.bindBuffer(s.ARRAY_BUFFER,e),s.vertexAttribPointer(o.a_position,e.itemSize,s.FLOAT,!1,0,0),s.drawArrays(s.TRIANGLE_STRIP,0,e.numItems),this._scatteringBuffer.deactivate()}}drawLookupTextures(){this._renderLookupTextures()}_drawBackground(){let e=this.renderer.handler,t=e.programs.atmosphereBackground,s=t._program,n=s.uniforms,o=e.gl,a=this.renderer,h=this.planet.camera;o.disable(o.DEPTH_TEST),a.enableBlendOneSrcAlpha(),t.activate(),o.bindBuffer(o.ARRAY_BUFFER,a.screenFramePositionBuffer),o.vertexAttribPointer(s.attributes.corners,2,o.FLOAT,!1,0,0),o.activeTexture(o.TEXTURE0),o.bindTexture(o.TEXTURE_2D,this._transmittanceBuffer.textures[0]),o.uniform1i(n.transmittanceTexture,0),o.activeTexture(o.TEXTURE1),o.bindTexture(o.TEXTURE_2D,this._scatteringBuffer.textures[0]),o.uniform1i(n.scatteringTexture,1),o.uniformMatrix4fv(n.viewMatrix,!1,h.getViewMatrix());let c=this.planet.sunPos;o.uniform3fv(n.sunPos,[c.x,c.y,c.z]),o.uniform3fv(n.camPos,[h.eye.x,h.eye.y,h.eye.z]),o.uniform2fv(n.iResolution,[a.sceneFramebuffer.width,a.sceneFramebuffer.height]),o.uniform1f(n.fov,h.getViewAngle()),o.uniform1f(n.opacity,this.opacity),o.drawArrays(o.TRIANGLE_STRIP,0,4),o.enable(o.DEPTH_TEST),a.enableBlendDefault()}}const Ta="degrees",Vh="m";let Uh=0;class on{constructor(e){this.id=Uh++,this.code=e.code,this.units=e.units}equal(e){return e.id===this.id}}const an=new on({code:"epsg:3857",units:Vh});class Gh{constructor(e){this.segment=e,this.layers=[],this.tileOffsetArr=new Float32Array(e.planet.SLICE_SIZE_4),this.layerOpacityArr=new Float32Array(e.planet.SLICE_SIZE)}clear(){this.layers=null,this.tileOffsetArr=null,this.layerOpacityArr=null}append(e,t){let s=this.layers.length;this.layers.push(e),this.layerOpacityArr[s]=e.screenOpacity;let n=4*s,o=e.applyMaterial(t);this.tileOffsetArr[n]=o[0],this.tileOffsetArr[n+1]=o[1],this.tileOffsetArr[n+2]=o[2],this.tileOffsetArr[n+3]=o[3]}}function Et(l,e,t){return Math.floor(Math.abs(t-l)/e)}function Pi(l,e,t,s){let n=1/(1<<t),o=s.getWidth()*n,a=s.getHeight()*n,h=s.southWest.lon+l*o,c=s.northEast.lat-e*a;return new H(new A(h,c-a),new A(h+o,c))}const Ae=20,Le=300;let ve=new m,ye=new m,Js=new m,Ze=new m,Ke=new m,tr=new m,Qe=new N,zi=new N;const ai=new Array(4);ai[0]=0,ai[1]=1,ai[2]=1,ai[3]=0;const li=new Array(4);li[0]=!1,li[1]=!0,li[2]=!1,li[3]=!0;class Ca{constructor(e,t,s,n){this.isPole=!1,this._tileGroup=0,this._projection=an,this.node=e,this.quadTreeStrategy=t,this.planet=t.planet,this.handler=t.planet.renderer.handler,this.bsphere=new Dt,this._plainRadius=0,this.bbox=new Do,this._sw=new m,this._nw=new m,this._se=new m,this._ne=new m,this.centerNormal=new m,this._extent=this._extentMerc=n,this._extentLonLat=new H,this.gridSize=this.planet.terrain.gridSizeByZoom[s],this.fileGridSize=0,this.tileZoom=s,this.powTileZoom=1<<s,this.tileX=0,this.tileXE=0,this.tileXW=0,this.tileYN=0,this.tileYS=0,this.tileY=0,this.tileIndex="",this.elevationData=null,this._assignTileIndexes(),this.materials=[],this.plainReady=!1,this.initialized=!1,this.normalMapReady=!1,this.terrainReady=!1,this.terrainIsLoading=!1,this.terrainExists=!1,this.passReady=!1,this.plainVertices=null,this.plainVerticesHigh=null,this.plainVerticesLow=null,this.plainNormals=null,this.terrainVertices=null,this.terrainVerticesHigh=null,this.terrainVerticesLow=null,this.noDataVertices=null,this.tempVertices=null,this.tempVerticesHigh=null,this.tempVerticesLow=null,this.normalMapTexture=null,this.normalMapTextureBias=new Float32Array(3),this.normalMapVertices=null,this.normalMapVerticesHigh=null,this.normalMapVerticesLow=null,this.normalMapNormals=null,this.vertexNormalBuffer=null,this.vertexPositionBuffer=null,this.vertexPositionBufferHigh=null,this.vertexPositionBufferLow=null,this.vertexTextureCoordBuffer=null,this._globalTextureCoordinates=new Float32Array(4),this._inTheQueue=!1,this._appliedNeighborsZoom=[0,0,0,0],this._slices=[],this._indexBuffer=null,this.readyToEngage=!1,this.plainProcessing=!1,this.normalMapTexturePtr=null,this._transitionOpacity=1,this._transitionTimestamp=0}checkZoom(){return this.tileZoom<this.planet.terrain._maxNodeZoom}getEntityTerrainPoint(e,t){return this.getTerrainPoint(e._cartesian,this.getInsideLonLat(e),t)}getInsideLonLat(e){return e._lonLatMerc}isEntityInside(e){return this._extentLonLat.isInside(e._lonLat)}getTerrainPoint(e,t,s){let n=this.tempVertices;if(n&&n.length){let o=this.planet.ellipsoid.getSurfaceNormal3v(e);Qe.set(e,o.negateTo());let a=this._extent.northEast,h=this._extent.southWest,c=Math.sqrt(n.length/3)-1,d=a.lon,u=a.lat,_=h.lon,f=h.lat,v=(d-_)/c,g=(u-f)/c,y=t.lon-_,p=t.lat-f,x=Math.floor(y/v),T=Math.floor(c-p/g),w=3*((c+1)*T+x),C=3*((c+1)*(T+1)+x);Js.set(n[w],n[w+1],n[w+2]),Ze.set(n[w+3],n[w+4],n[w+5]),Ke.set(n[C],n[C+1],n[C+2]);let E=Qe.hitTriangleRes(Js,Ze,Ke,s);return E===N.INSIDE?e.distance(s):E===N.AWAY&&(zi.set(e,o),zi.hitTriangleRes(Js,Ze,Ke,s)===N.INSIDE)?-e.distance(s):(tr.set(n[C+3],n[C+4],n[C+5]),E=Qe.hitTriangleRes(Ze,tr,Ke,s),E===N.INSIDE?e.distance(s):E===N.AWAY&&(zi.set(e,o),zi.hitTriangleRes(Ze,tr,Ke,s)===N.INSIDE)||E===N.AWAY?-e.distance(s):e.distance(s))}return e.distance(this.planet.ellipsoid.hitRay(Qe.origin,Qe.direction))}projectNative(e){return e.forwardMercator()}loadTerrain(e=!1){this.tileZoom<this.planet.terrain.minZoom||this.planet.terrain.isEmpty?(this.terrainIsLoading=!0,this.elevationsNotExists(),this._inTheQueue||this.planet._normalMapCreator.queue(this)):this.tileZoom>this.planet.terrain.maxZoom?this.elevationsNotExists():this.terrainIsLoading||this.terrainReady||this.planet.terrain.loadTerrain(this,e)}elevationsExists(e){if(this.plainReady&&this.terrainIsLoading){let t=new Float32Array(e.length);t.set(e),this.elevationData=new Float32Array(e.length),this.elevationData.set(e),this.planet._terrainWorker.make({segment:this,elevations:t}),this.plainVerticesHigh=null,this.plainVerticesLow=null,this.normalMapVerticesHigh=null,this.normalMapVerticesLow=null,this.planet.terrain.equalizeVertices||(this.tempVerticesHigh=null,this.tempVerticesLow=null)}}elevationsNotExists(){if(this.planet&&this.tileZoom<=this.planet.terrain.maxNativeZoom){if(this.plainReady&&this.terrainIsLoading){this.terrainIsLoading=!1;let e=this.node;e.appliedTerrainNodeId=this.node.nodeId,e.equalizedSideWithNodeId[0]=e.equalizedSideWithNodeId[1]=e.equalizedSideWithNodeId[2]=e.equalizedSideWithNodeId[3]=e.appliedTerrainNodeId,this.planet.lightEnabled&&!this._inTheQueue&&this.planet._normalMapCreator.queue(this),this.readyToEngage=!0}this.terrainVertices=this.plainVertices,this.terrainVerticesHigh=this.plainVerticesHigh,this.terrainVerticesLow=this.plainVerticesLow,this.tempVertices=this.terrainVertices,this.tempVerticesHigh=this.terrainVerticesHigh,this.tempVerticesLow=this.terrainVerticesLow,this.noDataVertices=null,this.fileGridSize=Math.sqrt(this.terrainVertices.length/3)-1,this.gridSize=this.fileGridSize,this.terrainReady=!0,this.terrainExists=!1}else if(this.plainReady&&this.terrainIsLoading){this.terrainIsLoading=!1;let e=this.node;e.appliedTerrainNodeId=this.node.nodeId,e.equalizedSideWithNodeId[0]=e.equalizedSideWithNodeId[1]=e.equalizedSideWithNodeId[2]=e.equalizedSideWithNodeId[3]=e.appliedTerrainNodeId,this.readyToEngage=!0,this.terrainReady=!0,this.passReady=!0,this.terrainExists=!1}}_checkEqualization(e,t){return t&&t.segment&&this.tileZoom>=t.segment.tileZoom&&this.node.equalizedSideWithNodeId[e]!==t.equalizedSideWithNodeId[ci[e]]}equalize(){if(this.tileZoom<2||this.gridSize<2)return;this.readyToEngage=!0;let e=this.node.neighbors,t=this.tempVertices,s=this.tempVerticesHigh,n=this.tempVerticesLow,o=this.gridSize,a=o+1,h=e[0][0];if(this._checkEqualization(0,h)){this.node.equalizedSideWithNodeId[0]=h.equalizedSideWithNodeId[2],this.readyToEngage=!0;let c=this.node.getOffsetOppositeNeighbourSide(h,0),d=h.segment.tempVertices,u=h.segment.tempVerticesHigh,_=h.segment.tempVerticesLow,f=h.segment.gridSize,v=f+1,g=1/(1<<this.tileZoom-h.segment.tileZoom),y=Math.max(o/(f*g),1),p=Math.max(f*g/o,1);for(let x=0,T=c*f;x<a;x+=y,T+=p){const w=3*x,C=3*(v*f+T);t[w]=d[C],t[w+1]=d[C+1],t[w+2]=d[C+2],s[w]=u[C],s[w+1]=u[C+1],s[w+2]=u[C+2],n[w]=_[C],n[w+1]=_[C+1],n[w+2]=_[C+2]}}if(h=e[1][0],this._checkEqualization(1,h)){this.node.equalizedSideWithNodeId[1]=h.equalizedSideWithNodeId[3],this.readyToEngage=!0;let c=this.node.getOffsetOppositeNeighbourSide(h,1),d=h.segment.tempVertices,u=h.segment.tempVerticesHigh,_=h.segment.tempVerticesLow,f=h.segment.gridSize,v=f+1,g=1/(1<<this.tileZoom-h.segment.tileZoom),y=Math.max(o/(f*g),1),p=Math.max(f*g/o,1);for(let x=0,T=c*f;x<a;x+=y,T+=p){const w=3*(a*x+o),C=v*T*3;t[w]=d[C],t[w+1]=d[C+1],t[w+2]=d[C+2],s[w]=u[C],s[w+1]=u[C+1],s[w+2]=u[C+2],n[w]=_[C],n[w+1]=_[C+1],n[w+2]=_[C+2]}}if(h=e[2][0],this._checkEqualization(2,h)){this.node.equalizedSideWithNodeId[2]=h.equalizedSideWithNodeId[0],this.readyToEngage=!0;let c=this.node.getOffsetOppositeNeighbourSide(h,2),d=h.segment.tempVertices,u=h.segment.tempVerticesHigh,_=h.segment.tempVerticesLow,f=h.segment.gridSize,v=1/(1<<this.tileZoom-h.segment.tileZoom),g=Math.max(o/(f*v),1),y=Math.max(f*v/o,1);for(let p=0,x=c*f;p<a;p+=g,x+=y){const T=3*(a*o+p),w=3*x;t[T]=d[w],t[T+1]=d[w+1],t[T+2]=d[w+2],s[T]=u[w],s[T+1]=u[w+1],s[T+2]=u[w+2],n[T]=_[w],n[T+1]=_[w+1],n[T+2]=_[w+2]}}if(h=e[3][0],this._checkEqualization(3,h)){this.node.equalizedSideWithNodeId[3]=h.equalizedSideWithNodeId[1],this.readyToEngage=!0;let c=this.node.getOffsetOppositeNeighbourSide(h,3),d=h.segment.tempVertices,u=h.segment.tempVerticesHigh,_=h.segment.tempVerticesLow,f=h.segment.gridSize,v=f+1,g=1/(1<<this.tileZoom-h.segment.tileZoom),y=Math.max(o/(f*g),1),p=Math.max(f*g/o,1);for(let x=0,T=c*f;x<a;x+=y,T+=p){const w=a*x*3,C=3*(v*T+f);t[w]=d[C],t[w+1]=d[C+1],t[w+2]=d[C+2],s[w]=u[C],s[w+1]=u[C+1],s[w+2]=u[C+2],n[w]=_[C],n[w+1]=_[C+1],n[w+2]=_[C+2]}}}engage(){this.readyToEngage=!1,this.createCoordsBuffers(this.tempVerticesHigh,this.tempVerticesLow,this.gridSize)}_terrainWorkerCallback(e){if(this.plainReady){this.readyToEngage=!0,this.normalMapNormals=null,this.normalMapVertices=null,this.normalMapVerticesHigh=null,this.normalMapVerticesLow=null,this.terrainVertices=null,this.terrainVerticesHigh=null,this.terrainVerticesLow=null,this.noDataVertices=null,this.tempVertices=null,this.tempVerticesHigh=null,this.tempVerticesLow=null,this.normalMapNormals=e.normalMapNormals,this.normalMapVertices=e.normalMapVertices,this.normalMapVerticesHigh=e.normalMapVerticesHigh,this.normalMapVerticesLow=e.normalMapVerticesLow,this.terrainVertices=e.terrainVertices,this.terrainVerticesHigh=e.terrainVerticesHigh,this.terrainVerticesLow=e.terrainVerticesLow,this.noDataVertices=e.noDataVertices,this.tempVertices=this.terrainVertices,this.tempVerticesHigh=this.terrainVerticesHigh,this.tempVerticesLow=this.terrainVerticesLow,this.setBoundingVolumeArr(e.bounds),this.gridSize=Math.sqrt(this.terrainVertices.length/3)-1;let t=this.node;if(t.appliedTerrainNodeId=t.nodeId,t.equalizedSideWithNodeId[0]=t.equalizedSideWithNodeId[1]=t.equalizedSideWithNodeId[2]=t.equalizedSideWithNodeId[3]=t.appliedTerrainNodeId,this.terrainReady=!0,this.terrainIsLoading=!1,this.terrainExists=!0,!this.normalMapTexturePtr){const s=this.planet._normalMapCreator;this.normalMapTexturePtr=this.planet.renderer.handler.createEmptyTexture_l(s.width,s.height)}this.planet.lightEnabled&&this.planet._normalMapCreator.queue(this)}}_normalMapEdgeEqualize(e){let t=this.node.neighbors,s=t[e],n=s&&s[0],o=this.planet.terrain.maxZoom;this.tileZoom===o&&s&&!(t[0].length||t[1].length||t[2].length||t[3].length)&&(n=this.node.getEqualNeighbor(e));let a=n&&n.segment,h=this;if(n&&a&&a.terrainReady&&a.terrainExists&&a.tileZoom<=o&&h._appliedNeighborsZoom[e]!==a.tileZoom){h._appliedNeighborsZoom[e]=a.tileZoom;let c=h.normalMapNormals,d=a.normalMapNormals;if(!c||!d)return;let u=h.normalMapNormals,_=a.normalMapNormals,f=Math.sqrt(c.length/3),v=f-1;const g=v*ai[e];let y,p,x,T;if(h.tileZoom===a.tileZoom){const w=v-g;if(li[e])for(let C=0;C<f;C++){let E=3*(C*f+g),L=3*(C*f+w);y=u[E]+_[L],p=u[E+1]+_[L+1],x=u[E+2]+_[L+2],T=1/Math.sqrt(y*y+p*p+x*x),d[L]=c[E]=y*T,d[L+1]=c[E+1]=p*T,d[L+2]=c[E+2]=x*T}else for(let C=0;C<f;C++){let E=3*(g*f+C),L=3*(w*f+C);y=u[E]+_[L],p=u[E+1]+_[L+1],x=u[E+2]+_[L+2],T=1/Math.sqrt(y*y+p*p+x*x),d[L]=c[E]=y*T,d[L+1]=c[E+1]=p*T,d[L+2]=c[E+2]=x*T}a._inTheQueue||a._appliedNeighborsZoom[ci[e]]===h.tileZoom||(a._appliedNeighborsZoom[ci[e]]=h.tileZoom,h.planet._normalMapCreator.queue(a))}}}applyTerrain(e){e?this.elevationsExists(e):this.elevationsNotExists()}deleteBuffers(){const e=this.handler.gl;e.deleteBuffer(this.vertexNormalBuffer),e.deleteBuffer(this.vertexPositionBuffer),e.deleteBuffer(this.vertexPositionBufferHigh),e.deleteBuffer(this.vertexPositionBufferLow),this.vertexNormalBuffer=null,this.vertexPositionBuffer=null,this.vertexPositionBufferHigh=null,this.vertexPositionBufferLow=null,this.vertexTextureCoordBuffer=null}deleteMaterials(){let e=this.materials;for(let t=0;t<e.length;t++){let s=e[t];s&&s.clear()}this.materials.length=0}deleteElevations(){this.terrainExists=!1,this.terrainReady=!1,this.terrainIsLoading=!1,this.normalMapVertices=null,this.normalMapVerticesHigh=null,this.normalMapVerticesLow=null,this.normalMapNormals=null,this.tempVertices=null,this.tempVerticesHigh=null,this.tempVerticesLow=null,this.terrainVertices=null,this.terrainVerticesHigh=null,this.terrainVerticesLow=null,this.noDataVertices=null,this.plainVertices=null,this.plainVerticesHigh=null,this.plainVerticesLow=null,this.plainNormals=null,this.normalMapReady&&(this.handler.gl.deleteTexture(this.normalMapTexture),this.normalMapReady=!1),this._appliedNeighborsZoom=[0,0,0,0],this.normalMapTextureBias[0]=0,this.normalMapTextureBias[1]=0,this.normalMapTextureBias[2]=1,this._inTheQueue=!1}clearSegment(){this.plainReady=!1,this.initialized=!1,this.deleteBuffers(),this.deleteMaterials(),this.deleteElevations()}childrenInitialized(){let e=this.node.nodes;return e.length===4&&e[0].segment.initialized&&e[1].segment.initialized&&e[2].segment.initialized&&e[3].segment.initialized}destroySegment(){this.clearSegment();let e=this._slices.length;for(;e--;)this._slices[e].clear();this._slices=null,this.node=null,this.planet=null,this.handler=null,this.bbox=null,this.bsphere=null,this._extent=null,this.materials=null,this.plainVertices=null,this.plainVerticesHigh=null,this.plainVerticesLow=null,this.plainNormals=null,this.terrainVertices=null,this.terrainVerticesHigh=null,this.terrainVerticesLow=null,this.noDataVertices=null,this.tempVertices=null,this.tempVerticesHigh=null,this.tempVerticesLow=null,this.normalMapTextureBias=null,this.normalMapTexture=null,this.normalMapVertices=null,this.normalMapVerticesHigh=null,this.normalMapVerticesLow=null,this.normalMapNormals=null,this.vertexNormalBuffer=null,this.vertexPositionBuffer=null,this.vertexPositionBufferHigh=null,this.vertexPositionBufferLow=null,this.vertexTextureCoordBuffer=null,this._projection=null,this._appliedNeighborsZoom=null,this._globalTextureCoordinates=null}_setExtentLonLat(){this._extentLonLat=this._extent.inverseMercator()}_createExtentNormals(){const e=this.planet.ellipsoid,t=this._extentLonLat,s=e.geodeticToCartesian(t.southWest.lon,t.southWest.lat),n=e.geodeticToCartesian(t.northEast.lon,t.northEast.lat),o=e.geodeticToCartesian(t.southWest.lon,t.northEast.lat),a=e.geodeticToCartesian(t.northEast.lon,t.southWest.lat);this._sw.copy(s),this._nw.copy(o),this._ne.copy(n),this._se.copy(a)}createBoundsByExtent(){this._createExtentNormals(),this.setBoundingVolume3v(this._sw,this._ne)}createBoundsByParent(){let e=this.node;for(;e.parentNode&&!e.segment.terrainReady;)e=e.parentNode;let t=1<<this.tileZoom-e.segment.tileZoom,s=this.tileX-e.segment.tileX*t,n=this.tileY-e.segment.tileY*t;if(e.segment.terrainReady&&e.segment.tileZoom>=this.planet.terrain.minZoom){let o=e.segment.gridSize/t;if(o>=1){this.bsphere.center.x=e.segment.bsphere.center.x,this.bsphere.center.y=e.segment.bsphere.center.y,this.bsphere.center.z=e.segment.bsphere.center.z,this.bsphere.radius=e.segment.bsphere.radius;let a=o*n,h=o*s,c=e.segment.gridSize+1,d=3*((a+o)*c+h),u=3*(a*c+h),_=3*(a*c+h+o),f=3*((a+o)*c+h+o),v=e.segment.tempVertices,g=new m(v[d],v[d+1],v[d+2]),y=new m(v[_],v[_+1],v[_+2]),p=new m(v[u],v[u+1],v[u+2]),x=new m(v[f],v[f+1],v[f+2]);this._sw.copy(g),this._nw.copy(p),this._ne.copy(y),this._se.copy(x)}else{let a,h=e.segment,c=Math.floor(o*n),d=Math.floor(o*s),u=1/o,_=n-u*c,f=s-u*d;a=h.gridSize===1?h.tempVertices:$r(h.tempVertices,h.gridSize,c,d,1);let v,g,y=new m(a[0],a[1],a[2]),p=new m(a[9],a[10],a[11]),x=new m(a[3]-a[0],a[4]-a[1],a[5]-a[2]),T=new m(a[6]-a[0],a[7]-a[1],a[8]-a[2]),w=new m(a[3]-a[9],a[4]-a[10],a[5]-a[11]),C=new m(a[6]-a[9],a[7]-a[10],a[8]-a[11]),E=_,L=f;v=E+L<u?m.add(x.scaleTo(L/u),T.scaleTo(E/u)).addA(y):m.add(C.scaleTo(1-L/u),w.scaleTo(1-E/u)).addA(p),E=_+1,L=f+1,g=E+L<u?m.add(x.scaleTo(L/u),T.scaleTo(E/u)).addA(y):m.add(C.scaleTo(1-L/u),w.scaleTo(1-E/u)).addA(p),this._createExtentNormals(),this.setBoundingVolume3v(v,g)}}else this.createBoundsByExtent()}setBoundingSphere(e,t,s,n){this.bsphere.center.x=e,this.bsphere.center.y=t,this.bsphere.center.z=s,this.bsphere.radius=this.bsphere.center.distance(n)}setBoundingVolume(e,t,s,n,o,a){this.bbox.setFromBoundsArr([e,t,s,n,o,a]);let h=e+.5*(n-e),c=t+.5*(o-t),d=s+.5*(a-s);this.bsphere.center.set(h,c,d),this.bsphere.radius=this.bsphere.center.distance(new m(e,t,s))}setBoundingVolume3v(e,t){this.bbox.setFromBoundsArr([e.x,e.y,e.z,t.x,t.y,t.z]);let s=e.x+.5*(t.x-e.x),n=e.y+.5*(t.y-e.y),o=e.z+.5*(t.z-e.z);this.bsphere.center.set(s,n,o),this.bsphere.radius=this.bsphere.center.distance(new m(e.x,e.y,e.z))}setBoundingVolumeArr(e){this.bbox.setFromBoundsArr(e);let t=e[0]+.5*(e[3]-e[0]),s=e[1]+.5*(e[4]-e[1]),n=e[2]+.5*(e[5]-e[2]);this.bsphere.center.set(t,s,n),this.bsphere.radius=this.bsphere.center.distance(new m(e[0],e[1],e[2]))}createCoordsBuffers(e,t,s){const n=(s+1)*(s+1),o=this.handler;this.vertexPositionBufferHigh&&this.vertexPositionBufferHigh.numItems===n?(o.setStreamArrayBuffer(this.vertexPositionBufferHigh,e),o.setStreamArrayBuffer(this.vertexPositionBufferLow,t)):(o.gl.deleteBuffer(this.vertexPositionBufferHigh),o.gl.deleteBuffer(this.vertexPositionBufferLow),this.vertexTextureCoordBuffer=this.planet._textureCoordsBufferCache[Math.log2(s)],this.vertexPositionBufferHigh=o.createArrayBuffer(e,3,n),this.vertexPositionBufferLow=o.createArrayBuffer(t,3,n))}_addViewExtent(){const e=this._extentLonLat;let t=this.quadTreeStrategy._viewExtent;e.southWest.lon<t.southWest.lon&&(t.southWest.lon=e.southWest.lon),e.northEast.lon>t.northEast.lon&&(t.northEast.lon=e.northEast.lon),e.southWest.lat<t.southWest.lat&&(t.southWest.lat=e.southWest.lat),e.northEast.lat>t.northEast.lat&&(t.northEast.lat=e.northEast.lat)}_assignTileIndexes(){this._tileGroup=0;const e=this.tileZoom,t=this._extent,s=At;this.tileX=Et(t.getCenter().lon,t.getWidth(),-2003750834e-2),this.tileY=Et(t.getCenter().lat,t.getHeight(),s);const n=this.powTileZoom;this.tileXE=(this.tileX+1)%n,this.tileXW=(n+this.tileX-1)%n,this.tileYN=this.tileY-1,this.tileYS=this.tileY+1,this.tileIndex=It.getTileIndex(this.tileX,this.tileY,e,this._tileGroup)}initialize(){const e=this.planet,t=this.node;if(this.gridSize=e.terrain.gridSizeByZoom[this.tileZoom]||e.terrain.plainGridSize,t.sideSizeLog2[0]=t.sideSizeLog2[1]=t.sideSizeLog2[2]=t.sideSizeLog2[3]=Math.log2(this.gridSize),this.tileZoom<=e.terrain.maxZoom){const s=this.planet._normalMapCreator;this.normalMapTexturePtr=e.renderer.handler.createEmptyTexture_l(s.width,s.height)}this.normalMapTexture=this.planet.transparentTexture,this._assignGlobalTextureCoordinates(),this.initialized=!0}_assignGlobalTextureCoordinates(){const e=this._extent;this._globalTextureCoordinates[0]=(e.southWest.lon+At)*ii,this._globalTextureCoordinates[1]=(At-e.northEast.lat)*ii,this._globalTextureCoordinates[2]=(e.northEast.lon+At)*ii,this._globalTextureCoordinates[3]=(At-e.southWest.lat)*ii}createPlainSegmentAsync(){let e=this.planet,t=e.terrain;t.isReady()&&!this.plainReady&&this.tileZoom<=t.maxZoom&&(this.plainProcessing=!0,e._plainSegmentWorker.make(this))}_plainSegmentWorkerCallback(e){this.plainProcessing=!1,this.initialized&&!this.terrainReady&&(this.plainReady=!0,this.plainVertices=e.plainVertices,this.plainVerticesHigh=e.plainVerticesHigh,this.plainVerticesLow=e.plainVerticesLow,this.plainNormals=e.plainNormals,this._plainRadius=e.plainRadius,this.normalMapNormals=e.normalMapNormals,this.normalMapVertices=e.normalMapVertices,this.normalMapVerticesHigh=e.normalMapVerticesHigh,this.normalMapVerticesLow=e.normalMapVerticesLow,this.fileGridSize=Math.sqrt(e.normalMapVertices.length/3)-1)}createPlainSegment(){this.initialize(),this._createPlainVertices(),this.readyToEngage=!0}_projToDeg(e,t){return A.inverseMercator(e,t)}_createPlainVertices(){const e=this.planet.terrain.gridSizeByZoom[this.tileZoom],t=this.planet.terrain.plainGridSize,s=Math.max(t,e),n=this._extent,o=n.getWidth()/s,a=n.getHeight()/s,h=n.southWest.lon,c=n.northEast.lat,d=Math.max(t/e,1),u=s+1,_=this.planet.ellipsoid._invRadii2,f=u*u,v=(e+1)*(e+1)*3;let g=0,y=0;this.plainNormals=new Float32Array(v),this.plainVertices=new Float64Array(v),this.plainVerticesHigh=new Float32Array(v),this.plainVerticesLow=new Float32Array(v),this.normalMapNormals=new Float32Array(3*f),this.normalMapVertices=new Float64Array(3*f),this.normalMapVerticesHigh=new Float32Array(3*f),this.normalMapVerticesLow=new Float32Array(3*f);let p=this.plainVertices,x=this.plainVerticesHigh,T=this.plainVerticesLow,w=this.plainNormals,C=this.normalMapVertices,E=this.normalMapVerticesHigh,L=this.normalMapVerticesLow,S=this.normalMapNormals;for(let P=0;P<f;P++){let R=P%u,M=~~(P/u),B=this.planet.ellipsoid.lonLatToCartesian(this._projToDeg(h+R*o,c-M*a)),z=B.x*_.x,ue=B.y*_.y,I=B.z*_.z,se=1/Math.sqrt(z*z+ue*ue+I*I),G=z*se,k=ue*se,F=I*se;m.doubleToTwoFloats(B,ve,ye),C[y]=B.x,E[y]=ve.x,L[y]=ye.x,S[y++]=G,C[y]=B.y,E[y]=ve.y,L[y]=ye.y,S[y++]=k,C[y]=B.z,E[y]=ve.z,L[y]=ye.z,S[y++]=F,M%d==0&&R%d==0&&(p[g]=B.x,x[g]=ve.x,T[g]=ye.x,w[g++]=G,p[g]=B.y,x[g]=ve.y,T[g]=ye.y,w[g++]=k,p[g]=B.z,x[g]=ve.z,T[g]=ye.z,w[g++]=F)}this.terrainVertices=p,this.terrainVerticesHigh=x,this.terrainVerticesLow=T,this.plainReady=!0}getMaterialByLayer(e){return this.materials[e.__id]}_getLayerExtentOffset(e){const t=e._extentMerc,s=this._extent,n=t.northEast.lon-t.southWest.lon,o=t.northEast.lat-t.southWest.lat;return[(s.southWest.lon-t.southWest.lon)/n,(t.northEast.lat-s.northEast.lat)/o,(s.northEast.lon-s.southWest.lon)/n,(s.northEast.lat-s.southWest.lat)/o]}initSlice(e){let t=this._slices[e];return t?t.layers=[]:t=this._slices[e]=new Gh(this),t}screenRendering(e,t,s,n,o=!1,a){const h=this.handler.gl,c=e.attributes,d=e.uniforms,u=this.materials,_=this.planet,f=this.quadTreeStrategy;let v,g;t&&t.length?(g=t[0],v=g._height):v=0,h.activeTexture(h.TEXTURE0+_.SLICE_SIZE+2),h.bindTexture(h.TEXTURE_2D,n||this.getDefaultTexture()),h.uniform1i(d.defaultTexture,_.SLICE_SIZE+2);let y=0,p=0,x=!1,T=this.initSlice(s);for(this._indexBuffer=this._getIndexBuffer();g;){if(this.layerOverlap(g)&&(g._fading&&g._fadingOpacity>0||(g.minZoom>=f.minCurrZoom||g.maxZoom>=f.minCurrZoom)&&(g.minZoom<=f.maxCurrZoom||g.maxZoom<=f.maxCurrZoom))){x=!0;let w=u[g.__id];w||(w=u[g.__id]=g.createMaterial(this)),w.isReady||(f._renderCompleted=!1),T.append(g,w),_._samplerArr[y]=y,h.activeTexture(h.TEXTURE0+y),h.bindTexture(h.TEXTURE_2D,w.texture||_.transparentTexture),y++}p++,g=t[p]}!x&&o||(h.uniform1f(d.transitionOpacity,a||this._transitionOpacity>1?1:this._transitionOpacity),h.uniform1i(d.samplerCount,y),h.uniform1f(d.height,v),h.uniform1iv(d.samplerArr,_._samplerArr),h.uniform4fv(d.tileOffsetArr,T.tileOffsetArr),h.uniform1fv(d.layerOpacityArr,T.layerOpacityArr),_.lightEnabled&&(h.activeTexture(h.TEXTURE0+_.SLICE_SIZE+3),h.bindTexture(h.TEXTURE_2D,this.normalMapTexture||_.transparentTexture),h.uniform1i(d.uNormalMap,_.SLICE_SIZE+3),h.uniform3fv(d.uNormalMapBias,this.normalMapTextureBias),h.uniform4fv(d.uGlobalTextureCoord,this._globalTextureCoordinates)),h.bindBuffer(h.ARRAY_BUFFER,this.vertexPositionBufferHigh),h.vertexAttribPointer(c.aVertexPositionHigh,this.vertexPositionBufferHigh.itemSize,h.FLOAT,!1,0,0),h.bindBuffer(h.ARRAY_BUFFER,this.vertexPositionBufferLow),h.vertexAttribPointer(c.aVertexPositionLow,this.vertexPositionBufferLow.itemSize,h.FLOAT,!1,0,0),h.bindBuffer(h.ARRAY_BUFFER,this.vertexTextureCoordBuffer),h.vertexAttribPointer(c.aTextureCoord,2,h.UNSIGNED_SHORT,!0,0,0),h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,this._indexBuffer),h.drawElements(_.drawMode,this._indexBuffer.numItems,h.UNSIGNED_INT,0))}increaseTransitionOpacity(){this._transitionOpacity+=(window.performance.now()-this._transitionTimestamp)/this.planet.transitionTime,this._transitionTimestamp=window.performance.now(),this._transitionOpacity>2&&(this._transitionOpacity=2);let e=this.node._fadingNodes.length;for(;e--;){let t=this.node._fadingNodes[e];if(!t.segment){this._transitionOpacity=1;break}t.segment._transitionOpacity>0&&!this.quadTreeStrategy._fadingNodes.has(t.__id)&&(this.quadTreeStrategy._fadingNodes.set(t.__id,t),t.segment._transitionOpacity=2-this._transitionOpacity,t.segment._transitionOpacity===0&&this.node._fadingNodes.splice(e,1))}}fadingTransitionOpacity(){this._transitionOpacity-=.01,this._transitionTimestamp=window.performance.now(),this._transitionOpacity<0&&(this._transitionOpacity=0)}colorPickingRendering(e,t,s,n,o=!1){const a=this.handler.gl,h=e.attributes,c=e.uniforms;let d,u=this.materials,_=this.planet;d=t&&t.length?t[0]._height:0;let f=!1,v=this._slices[s],g=v.layers.length;for(let y=0;y<g;y++){f=!0;let p=v.layers[y],x=4*y;_._pickingColorArr[x]=p._pickingColor.x/255,_._pickingColorArr[x+1]=p._pickingColor.y/255,_._pickingColorArr[x+2]=p._pickingColor.z/255,_._pickingColorArr[x+3]=Number(p._pickingEnabled),_._samplerArr[y]=y,a.activeTexture(a.TEXTURE0+y),a.bindTexture(a.TEXTURE_2D,u[p.__id].texture||this.planet.transparentTexture),_._pickingMaskArr[y]=y+_.SLICE_SIZE,a.activeTexture(a.TEXTURE0+y+_.SLICE_SIZE),a.bindTexture(a.TEXTURE_2D,u[p.__id].pickingMask||this.planet.transparentTexture)}!f&&o||(a.uniform1i(c.samplerCount,g),a.uniform1f(c.height,d),a.uniform1iv(c.samplerArr,_._samplerArr),a.uniform1iv(c.pickingMaskArr,_._pickingMaskArr),a.uniform4fv(c.pickingColorArr,_._pickingColorArr),a.uniform4fv(c.tileOffsetArr,v.tileOffsetArr),a.uniform1fv(c.layerOpacityArr,v.layerOpacityArr),a.bindBuffer(a.ARRAY_BUFFER,this.vertexPositionBufferHigh),a.vertexAttribPointer(h.aVertexPositionHigh,this.vertexPositionBufferHigh.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this.vertexPositionBufferLow),a.vertexAttribPointer(h.aVertexPositionLow,this.vertexPositionBufferLow.itemSize,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this.vertexTextureCoordBuffer),a.vertexAttribPointer(h.aTextureCoord,2,a.UNSIGNED_SHORT,!0,0,0),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,this._indexBuffer),a.drawElements(a.TRIANGLE_STRIP,this._indexBuffer.numItems,a.UNSIGNED_INT,0))}depthRendering(e,t){const s=this.handler.gl,n=e.attributes,o=e.uniforms;var a;a=t&&t.length?t[0]._height:0,s.uniform1f(o.height,a),s.bindBuffer(s.ARRAY_BUFFER,this.vertexPositionBufferHigh),s.vertexAttribPointer(n.aVertexPositionHigh,this.vertexPositionBufferHigh.itemSize,s.FLOAT,!1,0,0),s.bindBuffer(s.ARRAY_BUFFER,this.vertexPositionBufferLow),s.vertexAttribPointer(n.aVertexPositionLow,this.vertexPositionBufferLow.itemSize,s.FLOAT,!1,0,0),s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,this._indexBuffer),s.drawElements(s.TRIANGLE_STRIP,this._indexBuffer.numItems,s.UNSIGNED_INT,0)}_getIndexBuffer(){const e=this.node.sideSizeLog2;let t=this.planet._indexesCache[Math.log2(this.gridSize)][e[0]][e[1]][e[2]][e[3]];if(!t.buffer){let s=Yi().createSegmentIndexes(Math.log2(this.gridSize),[e[0],e[1],e[2],e[3]]);t.buffer=this.planet.renderer.handler.createElementArrayBuffer(s,1),this.planet._indexesCacheToRemoveCounter++}return t.buffer}layerOverlap(e){return this._extent.overlaps(e._extentMerc)}getDefaultTexture(){return this.planet.solidTextureOne}getExtentLonLat(){return this._extentLonLat}getExtentMerc(){return this._extentMerc}getExtent(){return this._extent}getNeighborSide(e){if(this.tileY===e.tileY){if(this.tileX===e.tileXE)return 3;if(this.tileX===e.tileXW)return 1}else if(this.tileX===e.tileX){if(this.tileY===e.tileYS)return 0;if(this.tileY===e.tileYN)return 2}return-1}}let Di=new m,Fi=new m;const xe=[new O(0,0),new O(1,0),new O(0,1),new O(1,1)],jh=Math.sqrt(xe.length)-1;let rt={xmin:0,ymin:0,zmin:0,xmax:0,ymax:0,zmax:0},qh=0;class jt{constructor(e,t,s,n,o,a){t.planet._createdNodesCount++,this.__id=qh++,this.SegmentPrototype=e,this.quadTreeStrategy=t,this.parentNode=n,this.partId=s,this.nodeId=s+(n?4*n.nodeId+1:0),this.state=null,this.prevState=null,this.appliedTerrainNodeId=-1,this.sideSizeLog2=[0,0,0,0],this.ready=!1,this.neighbors=[[],[],[],[]],this.equalizedSideWithNodeId=[this.nodeId,this.nodeId,this.nodeId,this.nodeId],this.nodes=[],this.segment=new e(this,t,o,a),this._cameraInside=!1,this.inFrustum=0,this._fadingNodes=[],this.createBounds()}createChildNodes(){this.ready=!0;const e=this.quadTreeStrategy,t=this.segment,s=t._extent,n=t.tileZoom+1,o=.5*s.getWidth(),a=.5*s.getHeight(),h=s.northEast,c=s.southWest,d=new A(c.lon+o,c.lat+a),u=this.nodes;u[0]=new jt(this.SegmentPrototype,e,0,this,n,new H(new A(c.lon,c.lat+a),new A(c.lon+o,h.lat))),u[1]=new jt(this.SegmentPrototype,e,1,this,n,new H(d,new A(h.lon,h.lat))),u[2]=new jt(this.SegmentPrototype,e,2,this,n,new H(new A(c.lon,c.lat),d)),u[3]=new jt(this.SegmentPrototype,e,3,this,n,new H(new A(c.lon+o,c.lat),new A(h.lon,c.lat+a)))}createBounds(){let e=this.segment;e._setExtentLonLat(),e.tileZoom===0?e.setBoundingSphere(0,0,0,new m(0,0,e.planet.ellipsoid.equatorialSize)):e.tileZoom<e.planet.terrain.minZoom?e.createBoundsByExtent():e.createBoundsByParent();let t=e.bsphere.center.x,s=e.bsphere.center.y,n=e.bsphere.center.z,o=1/Math.sqrt(t*t+s*s+n*n);e.centerNormal.x=t*o,e.centerNormal.y=s*o,e.centerNormal.z=n*o}getState(){if(this.state===-1)return this.state;let e=this.parentNode;for(;e;){if(e.state!==2)return 0;e=e.parentNode}return this.state}getEqualNeighbor(e){let t=this,s=yn[e][t.partId];if(s!==-1)return t.parentNode.nodes[s];{let n=[];for(;t.parentNode;)if(n.push(t.partId),s=yn[e][t.partId],t=t.parentNode,s!==-1){let o=n.length;for(e=ci[e];t&&o--;)s=ja[e][n[o]],t=t.nodes[s];return t}}}traverseNodes(e,t,s,n,o){this.ready||this.createChildNodes();let a=this.nodes;a[0].renderTree(e,t,s,n,o),a[1].renderTree(e,t,s,n,o),a[2].renderTree(e,t,s,n,o),a[3].renderTree(e,t,s,n,o)}renderTree(e,t,s,n,o){if(this.quadTreeStrategy._renderedNodes.length>=1e3)return;(!t||o&&this.segment.tileZoom>o.segment.tileZoom)&&(this.prevState=this.state),this.state=2,this.clearNeighbors();let a=this.segment,h=this.quadTreeStrategy.planet;if(this._cameraInside=!1,!this.parentNode||this.parentNode._cameraInside){let u;u=a._projection.id===an.id?a._extent.isInside(e._lonLatMerc):a._extent.isInside(e._lonLat),u&&(e._insideSegment=a,this._cameraInside=!0)}this.inFrustum=0;let c=e.frustums,d=c.length;if(a.tileZoom<6)for(let u=0;u<d;u++)c[u].containsSphere(a.bsphere)&&(this.inFrustum|=1<<u);else for(let u=0;u<d;u++)a.terrainReady?c[u].containsBox(a.bbox)&&(this.inFrustum|=1<<u):c[u].containsSphere(a.bsphere)&&(this.inFrustum|=1<<u);if(this.inFrustum||this._cameraInside||a.tileZoom<3){let u=Math.abs(e._lonLat.height),_=e.eye.length2()-h.ellipsoid.polarSizeSqr,f=10687647287563281e-5*h._heightFactor;_=_<f?f:_;let v=a.tileZoom<2||a.tileZoom>19||a.tileZoom<6&&!a.terrainReady;if(e.isOrthographic){let g=e.getForward();v=v||g.dot(a._sw.getNormal())<-0||g.dot(a._nw.getNormal())<-0||g.dot(a._ne.getNormal())<-0||g.dot(a._se.getNormal())<-0}else v=v||e.eye.distance2(a._sw)<_||e.eye.distance2(a._nw)<_||e.eye.distance2(a._ne)<_||e.eye.distance2(a._se)<_;(this.inFrustum&&(v||u>1e4)||this._cameraInside)&&this.quadTreeStrategy.collectVisibleNode(this),a.tileZoom<2?this.traverseNodes(e,t,s,n,o):a.terrainReady&&(!t&&e.projectedSize(a.bsphere.center,a._plainRadius)<this.quadTreeStrategy.lodSize||t&&(a.tileZoom===t||!v))?v?(a.passReady=!0,this.renderNode(this.inFrustum,!this.inFrustum,s,n)):this.state=0:a.terrainReady&&a.checkZoom()&&(!t||e.projectedSize(a.bsphere.center,a.bsphere.radius)>this.quadTreeStrategy._maxLodSize)?this.traverseNodes(e,t,a,n,o):v?(a.passReady=!!t&&a.terrainReady,this.renderNode(this.inFrustum,!this.inFrustum,s,n)):this.state=0}else this.state=0}renderNode(e,t,s,n){let o=this.segment;o.terrainReady||(o.initialized||o.initialize(),this.whileTerrainLoading(s),o.plainProcessing||o.createPlainSegmentAsync(),o.plainReady&&!n&&o.loadTerrain()),o.planet.lightEnabled&&!o.normalMapReady&&this.whileNormalMapCreating(),t?this.state=-1:(!this._cameraInside&&o.tileZoom>this.quadTreeStrategy.maxCurrZoom&&(this.quadTreeStrategy.maxCurrZoom=o.tileZoom),o.tileZoom<this.quadTreeStrategy.minCurrZoom&&(this.quadTreeStrategy.minCurrZoom=o.tileZoom),o._addViewExtent(),this.addToRender(e))}childrenPrevStateEquals(e){let t=this.nodes;return t.length===4&&t[0].prevState===e&&t[1].prevState===e&&t[2].prevState===e&&t[3].prevState===e}isFading(){let e=this.nodes;return this.state===2&&this.segment._transitionOpacity>0&&e.length===4&&e[0].state===1&&e[1].state===1&&e[2].state===1&&e[3].state===1}_collectFadingNodes(){if(this.segment.tileZoom<3)this.segment._transitionOpacity=1;else if(this.prevState!==1){this.segment._transitionOpacity=0,this._fadingNodes=[];let e=window.performance.now();if(this.segment._transitionTimestamp=e,this.parentNode){if(this.parentNode.prevState===1){let t=this.parentNode.parentNode;for(;t;){if(t.isFading()){for(let s=0;s<t.nodes.length;s++)t.nodes[s].segment._transitionOpacity=1,t.nodes[s]._fadingNodes=[];t.segment._transitionOpacity=0;break}t=t.parentNode}this.parentNode.whileTerrainLoading(),this._fadingNodes.push(this.parentNode),this.parentNode.segment._transitionOpacity=2,this.parentNode.segment._transitionTimestamp=e}else if(this.segment.childrenInitialized()&&this.childrenPrevStateEquals(1))for(let t=0;t<this.nodes.length;t++){let s=this.nodes[t];s.whileTerrainLoading(),this._fadingNodes.push(s),s.segment._transitionOpacity=2,s.segment._transitionTimestamp=e,s.prevState=s.state,s.state=0}}}}clearNeighbors(){this.neighbors&&(this.neighbors[0]=this.neighbors[1]=this.neighbors[2]=this.neighbors[3]=null,this.neighbors[0]=[],this.neighbors[1]=[],this.neighbors[2]=[],this.neighbors[3]=[])}_refreshTransitionOpacity(){if(this._fadingNodes.length===0)this.segment._transitionOpacity=1;else if(this._fadingNodes.length!==4||this.childrenPrevStateEquals(1)){for(let e=0;e<this._fadingNodes.length;e++)this.segment._transitionOpacity<1&&this._fadingNodes[e].segment._transitionOpacity===0&&(this._fadingNodes[e].segment._transitionOpacity=0,this.segment._transitionOpacity=1);this.segment.increaseTransitionOpacity()}else this.segment._transitionOpacity=1,this._fadingNodes=[]}addToRender(e){this.state=1;let t=this.quadTreeStrategy._renderedNodes;this.quadTreeStrategy._transitionOpacityEnabled?Wr(t,this,(o,a)=>o.segment.tileZoom-a.segment.tileZoom):(this.getRenderedNodesNeighbors(t),t.push(this)),this.segment.terrainReady||(this.quadTreeStrategy._renderCompleted=!1,this.quadTreeStrategy._terrainCompleted=!1);let s=0,n=this.quadTreeStrategy._renderedNodesInFrustum;for(;e;)1&e&&n[s].push(this),s++,e>>=1}applyNeighbor(e,t){const s=ci[t];if(this.neighbors[t].length===0||e.neighbors[s].length===0){const n=this.segment,o=e.segment,a=n.gridSize/(o.gridSize*Math.pow(2,o.tileZoom-n.tileZoom));let h=n.gridSize,c=o.gridSize;a>1?(h=Math.ceil(n.gridSize/a),c=o.gridSize):a<1&&(h=n.gridSize,c=Math.ceil(o.gridSize*a)),this.sideSizeLog2[t]=Math.log2(h),e.sideSizeLog2[s]=Math.log2(c)}this.neighbors[t].push(e),e.neighbors[s].push(this)}getRenderedNodesNeighbors(e){for(let t=e.length-1;t>=0;--t){let s=e[t],n=this.getCommonSide(s);n!==-1&&this.applyNeighbor(s,n)}}getCommonSide(e){const t=this.segment,s=e.segment;if(t.tileZoom===s.tileZoom&&t._tileGroup===s._tileGroup)return t.getNeighborSide(s);{const n=t._extentLonLat,o=s._extentLonLat;let a=n.northEast,h=n.southWest,c=o.northEast,d=o.southWest,u=a.lon,_=a.lat,f=h.lon,v=h.lat,g=c.lon,y=c.lat,p=d.lon,x=d.lat;if(t._tileGroup===s._tileGroup){if(u===p&&(_<=y&&v>=x||_>=y&&v<=x))return 1;if(f===g&&(_<=y&&v>=x||_>=y&&v<=x))return 3;if(_===x&&(f>=p&&u<=g||f<=p&&u>=g))return 0;if(v===y&&(f>=p&&u<=g||f<=p&&u>=g))return 2;if(s.tileX===0&&p===-u&&(_<=y&&v>=x||_>=y&&v<=x))return 1;if(t.tileX===0&&f===-g&&(_<=y&&v>=x||_>=y&&v<=x))return 3}if(t._tileGroup===0&&s._tileGroup===20&&t.tileY===0&&s.tileY===s.powTileZoom-1&&(f>=p&&u<=g||f<=p&&u>=g))return 0;if(t._tileGroup===0&&s._tileGroup===Le&&t.tileY===t.powTileZoom-1&&s.tileY===0&&(f>=p&&u<=g||f<=p&&u>=g))return 2;if(t._tileGroup===Le&&s._tileGroup===0&&t.tileY===0&&s.tileY===s.powTileZoom-1&&(f>=p&&u<=g||f<=p&&u>=g))return 0;if(t._tileGroup===20&&s._tileGroup===0&&t.tileY===t.powTileZoom-1&&s.tileY===0&&(f>=p&&u<=g||f<=p&&u>=g))return 2}return-1}whileNormalMapCreating(){const e=this.segment;e.terrainIsLoading||!e.terrainExists||e._inTheQueue||e.planet._normalMapCreator.queue(e);let t=this;for(;t.parentNode&&!t.segment.normalMapReady;)t=t.parentNode;const s=2<<e.tileZoom-t.segment.tileZoom-1;e.normalMapTexture=t.segment.normalMapTexture,e.normalMapTextureBias[0]=e.tileX-t.segment.tileX*s,e.normalMapTextureBias[1]=e.tileY-t.segment.tileY*s,e.normalMapTextureBias[2]=1/s}whileTerrainLoading(e){const t=this.segment;let s=this;if(e&&e.terrainReady)s=e.node;else for(;s.parentNode&&!s.segment.terrainReady;)s=s.parentNode;if(s.segment.terrainReady&&this.appliedTerrainNodeId!==s.nodeId){let n=2<<t.tileZoom-s.segment.tileZoom-1,o=t.tileX-s.segment.tileX*n,a=t.tileY-s.segment.tileY*n;const h=s.segment;let c,d,u,_;this.appliedTerrainNodeId=s.nodeId,this.equalizedSideWithNodeId[0]=this.equalizedSideWithNodeId[1]=this.equalizedSideWithNodeId[2]=this.equalizedSideWithNodeId[3]=this.appliedTerrainNodeId;let f=s.segment.gridSize/n,v=s.segment.fileGridSize/n;if(rt.xmin=yt,rt.xmax=Tt,rt.ymin=yt,rt.ymax=Tt,rt.zmin=yt,rt.zmax=Tt,f>=1){t.gridSize=f;let g=(f+1)*(f+1)*3;c=new Float64Array(g),d=new Float32Array(g),u=new Float32Array(g),h.noDataVertices&&(_=new Uint8Array(g/3)),lr(h.terrainVertices,h.terrainVerticesHigh,h.terrainVerticesLow,h.noDataVertices,h.gridSize,f*a,f*o,f,c,d,u,rt,_)}else if(v>=1&&s.segment.terrainExists){t.gridSize=v;let g=(v+1)*(v+1)*3;c=new Float64Array(g),d=new Float32Array(g),u=new Float32Array(g),h.noDataVertices&&(_=new Uint8Array(g/3)),lr(h.normalMapVertices,h.normalMapVerticesHigh,h.normalMapVerticesLow,h.noDataVertices,s.segment.fileGridSize,v*a,v*o,v,c,d,u,rt,_)}else{t.gridSize=jh;let g,y=Math.floor(f*a),p=Math.floor(f*o);g=h.gridSize===1?h.terrainVertices:$r(h.terrainVertices,h.gridSize,y,p,1);let x=1/f,T=a-x*y,w=o-x*p,C=new m(g[0],g[1],g[2]),E=new m(g[9],g[10],g[11]),L=new m(g[3]-g[0],g[4]-g[1],g[5]-g[2]),S=new m(g[6]-g[0],g[7]-g[1],g[8]-g[2]),P=new m(g[3]-g[9],g[4]-g[10],g[5]-g[11]),R=new m(g[6]-g[9],g[7]-g[10],g[8]-g[11]),M=new m;c=new Float64Array(3*xe.length),d=new Float32Array(3*xe.length),u=new Float32Array(3*xe.length);for(let B=0;B<xe.length;B++){let z=xe[B].y+T,ue=xe[B].x+w,I=ue*f,se=z*f;M=z+ue<x?L.scaleTo(I).addA(S.scaleTo(se)).addA(C):R.scaleTo(1-I).addA(P.scaleTo(1-se)).addA(E),m.doubleToTwoFloats(M,Di,Fi);let G=3*B;c[G]=M.x,c[G+1]=M.y,c[G+2]=M.z,d[G]=Di.x,d[G+1]=Di.y,d[G+2]=Di.z,u[G]=Fi.x,u[G+1]=Fi.y,u[G+2]=Fi.z,M.x<rt.xmin&&(rt.xmin=M.x),M.x>rt.xmax&&(rt.xmax=M.x),M.y<rt.ymin&&(rt.ymin=M.y),M.y>rt.ymax&&(rt.ymax=M.y),M.z<rt.zmin&&(rt.zmin=M.z),M.z>rt.zmax&&(rt.zmax=M.z)}}if(t.readyToEngage=!0,t.terrainVertices=c,t.terrainVerticesHigh=d,t.terrainVerticesLow=u,t.tempVertices=c,t.tempVerticesHigh=d,t.tempVerticesLow=u,t.noDataVertices=_,t.setBoundingVolume(rt.xmin,rt.ymin,rt.zmin,rt.xmax,rt.ymax,rt.zmax),t.tileZoom>t.planet.terrain.maxZoom&&s.segment.tileZoom>=t.planet.terrain.maxZoom&&(t._plainRadius=s.segment._plainRadius/n,t.terrainReady=!0,t.terrainIsLoading=!1,t.terrainVertices=c,t.terrainVerticesHigh=d,t.terrainVerticesLow=u,t.passReady=!0,this.appliedTerrainNodeId=this.nodeId,this.equalizedSideWithNodeId[0]=this.equalizedSideWithNodeId[1]=this.equalizedSideWithNodeId[2]=this.equalizedSideWithNodeId[3]=this.appliedTerrainNodeId,s.segment.terrainExists)){t.normalMapVertices=c,t.fileGridSize=Math.sqrt(c.length/3)-1;let g=Math.sqrt(h.normalMapNormals.length/3)-1,y=g/n;t.normalMapNormals=g>1?Mo(h.normalMapNormals,g,y*a,y*o,y):h.normalMapNormals}}}destroy(){this.prevState=this.state=0,this.segment.destroySegment();let e=this.neighbors;for(let t=0,s=e.length;t<s;t++){let n=e[t];if(n)for(let o=0;o<n.length;o++){let a=n[o];a&&a.neighbors&&a.clearNeighbors()}}this.neighbors=null,this.parentNode=null,this.sideSizeLog2=null,this.segment=null}clearTree(){const e=this.getState();if(e===0||e===1)this.destroyBranches();else for(let t=0;t<this.nodes.length;t++)this.nodes[t]&&this.nodes[t].clearTree()}clearBranches(){for(let e=0;e<this.nodes.length;e++)this.nodes[e].clearBranches(),this.nodes[e].segment.deleteMaterials()}destroyBranches(){if(this.ready){let e,t=[];for(e=0;e<this.nodes.length;e++)t[e]=this.nodes[e];for(this.ready=!1,this.nodes=[],e=0;e<t.length;e++)t[e].destroyBranches(),t[e].destroy(),t[e]=null;t.length=0,t=null}}traverseTree(e){if(e(this),this.ready)for(let t=0;t<this.nodes.length;t++)this.nodes[t].traverseTree(e)}getOffsetOppositeNeighbourSide(e,t){let s=this,n=e.segment.tileZoom,o=0;for(;s.segment.tileZoom>n;)o+=qa[s.partId][t]/(1<<s.segment.tileZoom-n),s=s.parentNode;return o}}class ln{constructor(e=2048){this._size=e,this._array=new Array(this._size),this._popIndex=Math.floor(.5*this._size),this._shiftIndex=this._popIndex,this.length=0}reset(){this._popIndex=Math.floor(.5*this._size),this._shiftIndex=this._popIndex,this.length=0}clear(){this._array.length=0,this._array=new Array(this._size),this._popIndex=Math.floor(.5*this._size),this._shiftIndex=this._popIndex,this.length=0}push(e){this.length++,this._array[this._popIndex++]=e}pop(){if(this.length){this.length--;let e=this._array[--this._popIndex];return this._array[this._popIndex]=null,this._array[this._popIndex-1]||(this._popIndex=Math.floor(.5*this._size),this._shiftIndex=this._popIndex),e}}unshift(e){this.length++,this._array[--this._shiftIndex]=e}shift(){if(this.length){this.length--;let e=this._array[this._shiftIndex];return this._array[this._shiftIndex++]=null,this._array[this._shiftIndex]||(this._popIndex=Math.floor(.5*this._size),this._shiftIndex=this._popIndex),e}}forEach(e){for(let t=this._shiftIndex;t<this._popIndex;t++)e(this._array[t])}}class hn{constructor(e,t,s){this.quadTreeStrategy=e,this._layer=t,this._nodeCapacity=s,this._secondPASS=[],this._counter=0,this._deferredEntitiesPendingQueue=new ln,this._renderingNodes={}}insertEntity(e,t=!1){}setPickingEnabled(e){}dispose(){}insertEntities(e){}collectVisibleEntityCollections(e){}_queueDeferredNode(e){this._layer.getVisibility()&&(e._inTheQueue=!0,this._counter>=1?this._deferredEntitiesPendingQueue.push(e):this._execDeferredNode(e))}_execDeferredNode(e){this._counter++,requestAnimationFrame(()=>{if(e.applyCollection(),this._counter--,this._deferredEntitiesPendingQueue.length&&this._counter<1)for(;this._deferredEntitiesPendingQueue.length;){let t=this._deferredEntitiesPendingQueue.pop();if(t._inTheQueue=!1,t.isVisible())return void this._execDeferredNode(t)}})}}class Bs{constructor(e){this._skipPreRender=!1,this.events=ot(Yh),this.name=e.name||"",this.projection=e.proj||an,this.planet=e.planet,this._quadTreeList=[],this._visibleNodes={},this._renderedNodes=[],this._renderedNodesInFrustum=[],this._fadingNodes=new Map,this._fadingNodesInFrustum=[],this._fadingOpaqueSegments=[],this.minCurrZoom=yt,this.maxCurrZoom=Tt,this._viewExtent=new H(new A(180,180),new A(-180,-180)),this._lodSize=256,this._curLodSize=256,this._minLodSize=512,this._maxLodSize=256,this.maxEqualZoomAltitude=e.maxEqualZoomAltitude||15e6,this.minEqualZoomAltitude=e.minEqualZoomAltitude||1e4,this.minEqualZoomCameraSlope=e.minEqualZoomCameraSlope||.8,this._renderCompleted=!1,this._renderCompletedActivated=!1,this._terrainCompleted=!1,this._terrainCompletedActivated=!1,this._transitionOpacityEnabled=e.transitionOpacityEnabled==null||e.transitionOpacityEnabled}get lodSize(){return this._lodSize}setLodSize(e,t,s){this._maxLodSize=s||this._maxLodSize,this._minLodSize=t||this._minLodSize,this._curLodSize=e,this._renderCompletedActivated=!1,this._terrainCompletedActivated=!1}createEntityCollectionsTreeStrategy(e,t){return new hn(this,e,t)}destroyBranches(){this._renderCompletedActivated=!1,this._terrainCompletedActivated=!1;for(let e=0,t=this._quadTreeList.length;e<t;e++)this._quadTreeList[e].destroyBranches()}clearLayerMaterial(e,t=!1){let s=e.__id;for(let n=0,o=this._quadTreeList.length;n<o;n++)this._quadTreeList[n].traverseTree(a=>{if(t&&this._renderedNodes.includes(a))return;let h=a.segment.materials;h[s]&&(h[s].clear(),h[s]=null)})}get terrainReady(){return this._terrainCompleted&&this._terrainCompletedActivated}_checkRendercompleted(){this._renderCompleted?this._renderCompletedActivated||(this._renderCompletedActivated=!0,this.events.dispatch(this.events.rendercompleted,!0)):this._renderCompletedActivated=!1,this._renderCompleted=!0,this._terrainCompleted?this._terrainCompletedActivated||(this._terrainCompletedActivated=!0,this.events.dispatch(this.events.terraincompleted,!0)):this._terrainCompletedActivated=!1,this._terrainCompleted=!0}_initEvents(){this.planet.renderer.events.on("resize",()=>{this._renderCompletedActivated=!1,this._terrainCompletedActivated=!1}),this.planet.renderer.events.on("postdraw",()=>{this._checkRendercompleted()})}init(e){this._initEvents(),this._renderedNodesInFrustum=new Array(e.frustums.length);for(let t=0,s=this._renderedNodesInFrustum.length;t<s;t++)this._renderedNodesInFrustum[t]=[];this.preRender(),this.clearRenderedNodes(),this.preLoad()}clearRenderedNodes(){this._clearRenderedNodeList(),this._clearRenderNodesInFrustum()}_clearRenderedNodeList(){this._renderedNodes.length=0,this._renderedNodes=[]}_clearRenderNodesInFrustum(){for(let e=0,t=this._renderedNodesInFrustum.length;e<t;e++)this._renderedNodesInFrustum[e].length=0,this._renderedNodesInFrustum[e]=[]}_collectRenderedNodesMaxZoom(e){if(e.isOrthographic||e.slope>this.minEqualZoomCameraSlope&&e._lonLat.height<this.maxEqualZoomAltitude&&e._lonLat.height>this.minEqualZoomAltitude){this.minCurrZoom=this.maxCurrZoom;let t=this._renderedNodes,s=this._renderedNodesInFrustum,n=[];this._clearRenderNodesInFrustum(),this._renderedNodes=[];for(let o=0,a=t.length;o<a;o++){let h=t[o],c=h.segment.centerNormal.dot(e.getBackward());if(h.segment.tileZoom===this.maxCurrZoom||c<.81){this._renderedNodes.push(h);let d=0,u=h.inFrustum;for(;u;)1&u&&s[d].push(h),d++,u>>=1}else n.push(h)}for(let o=0,a=n.length;o<a;o++)n[o].renderTree(e,this.maxCurrZoom,null,!1,n[o])}}set transitionOpacityEnabled(e){this._transitionOpacityEnabled=e}get transitionOpacityEnabled(){return this._transitionOpacityEnabled}collectRenderNodes(e){if(this._skipPreRender&&(this._lodSize=yo(e.slope<0?0:e.slope,this._curLodSize,this._minLodSize),e._insideSegment=null,this._clearRenderedNodeList(),this._clearRenderNodesInFrustum(),this._viewExtent.southWest.set(180,180),this._viewExtent.northEast.set(-180,-180),this.minCurrZoom=yt,this.maxCurrZoom=Tt,this._collectRenderNodes(e),this._collectRenderedNodesMaxZoom(e),this._fadingNodes.clear(),this._transitionOpacityEnabled)){let t=[];for(let s=0;s<this._renderedNodes.length;s++){let n=this._renderedNodes[s];if(n._collectFadingNodes(),n._refreshTransitionOpacity(),n.segment._transitionOpacity>=1)n.clearNeighbors(),n.getRenderedNodesNeighbors(t),t.push(n);else for(let o=0;o<n._fadingNodes.length;o++){let a=n._fadingNodes[o];a.segment&&a.segment._transitionOpacity>=1&&(a.clearNeighbors(),a.getRenderedNodesNeighbors(t),t.push(a))}}}this._skipPreRender=!0}preRender(){this._skipPreRender=!1;for(let e=0;e<this._quadTreeList.length;e++){let t=this._quadTreeList[e];t.createChildNodes(),t.segment.createPlainSegment();for(let s=0;s<t.nodes.length;s++)t.nodes[s].segment.createPlainSegment()}}preLoad(){for(let e=0;e<this._quadTreeList.length;e++){let t=this._quadTreeList[e];t.segment.passReady=!0,t.renderNode(1),this.planet.normalMapCreator.drawSingle(t.segment);for(let s=0;s<t.nodes.length;s++)t.nodes[s].segment.passReady=!0,t.nodes[s].renderNode(1),this.planet._normalMapCreator.drawSingle(t.nodes[s].segment)}}_clearVisibleNodes(){this._visibleNodes={}}_collectRenderNodes(e){this._clearVisibleNodes();for(let t=0;t<this._quadTreeList.length;t++)this._quadTreeList[t].renderTree(e,0,null)}clear(){for(let e=0;e<this._quadTreeList.length;e++)this._quadTreeList[e].clearTree()}get quadTreeList(){return this._quadTreeList}getTileXY(e,t){let s,n,o=t,a=1<<o;return s=Et(e.lon,360/a,-180),n=Et(e.lat,180/a,90),[s,n,o,0]}getLonLatTileOffset(e,t,s,n,o){let a;a=Pi(t,s,n,H.createFromArray([-180,-90,180,90]));let h=a.getWidth()/(o-1),c=a.getHeight()/(o-1);return[o-Math.ceil((e.lat-a.southWest.lat)/c)-1,Math.floor((e.lon-a.southWest.lon)/h)]}collectVisibleNode(e){this._visibleNodes[e.nodeId]=e}}const Yh=["rendercompleted","terraincompleted"],ks=new on({code:"epsg:4326",units:Ta}),oo=(90-ht)/Math.pow(2,7);class Fr extends Ca{constructor(e,t,s,n){super(e,t,s,n),this._projection=ks,this._extentLonLat=this._extent,this._extentMerc=new H(n.southWest.forwardMercatorEPS01(),n.northEast.forwardMercatorEPS01()),this._isNorth=this._extent.northEast.lat>0,this.isPole=!0}_setExtentLonLat(){this._extentLonLat=this._extent}projectNative(e){return e}getInsideLonLat(e){return e._lonLat}_getMaxZoom(){let e;if(this._isNorth){let t=Math.floor((90-this._extent.northEast.lat)/oo);e=Math.floor(t/16)+7}else{let t=Math.floor((Ft-this._extent.northEast.lat)/oo);e=12-Math.floor(t/16)}return e}checkZoom(){return super.checkZoom()&&this.tileZoom<=this._getMaxZoom()}_assignTileIndexes(){this._assignTileXIndexes(this._extent),this._assignTileYIndexes(this._extent),this.tileIndex=It.getTileIndex(this.tileX,this.tileY,this.tileZoom,this._tileGroup)}_assignTileXIndexes(e){this.tileX=Et(e.getCenter().lon,e.getWidth(),-180);let t=1<<this.tileZoom;this.tileXE=(this.tileX+1)%t,this.tileXW=(t+this.tileX-1)%t}_assignTileYIndexes(e){const t=e.getCenter().lat;t>0?(this._tileGroup=20,this.tileY=Et(t,e.getHeight(),90)):(this._tileGroup=Le,this.tileY=Et(t,e.getHeight(),Ft)),this.tileYN=this.tileY-1,this.tileYS=this.tileY+1}_projToDeg(e,t){return new A(e,t)}_assignGlobalTextureCoordinates(){const e=this._extent;this._globalTextureCoordinates[0]=(e.southWest.lon+180)/360,this._globalTextureCoordinates[1]=(90-e.northEast.lat)/180,this._globalTextureCoordinates[2]=(e.northEast.lon+180)/360,this._globalTextureCoordinates[3]=(90-e.southWest.lat)/180}_getLayerExtentOffset(e){const t=e._extent,s=this._extent,n=t.northEast.lon-t.southWest.lon,o=t.northEast.lat-t.southWest.lat;return[(s.southWest.lon-t.southWest.lon)/n,(t.northEast.lat-s.northEast.lat)/o,(s.northEast.lon-s.southWest.lon)/n,(s.northEast.lat-s.southWest.lat)/o]}layerOverlap(e){return this._extent.overlaps(e._extent)}getDefaultTexture(){return this._isNorth?this.planet.solidTextureOne:this.planet.solidTextureTwo}getExtentLonLat(){return this._extent}}class ge{constructor(e,t,s,n,o,a){this.strategy=e,this.layer=e._layer,this.parentNode=s,this.childNodes=[],this.partId=t,this.nodeId=t+(s?4*s.nodeId+1:0),this.state=null,this.extent=n,this.count=0,this.deferredEntities=[],this.entityCollection=null,this.zoom=a,this._inTheQueue=!1,this.bsphere=new Dt,o&&this._setExtentBounds()}insertEntity(e,t=!1){this.buildTree([e],t)}_addEntitiesToCollection(e,t=!1){if(e.length){const s=this.layer,n=s._planet;let o=this.entityCollection;o||(o=new ee({pickingEnabled:s._pickingEnabled,labelMaxLetters:s.labelMaxLetters}),o._layer=this.layer,o.addTo(n,!0),o._quadNode=this,s._bindEventsDefault(o),this.entityCollection=o),t||!s.async?this.entityCollection.addEntities(e):this.deferredEntities.push.apply(this.deferredEntities,e)}}_setExtentBounds(){this.nodeId?this.bsphere.setFromExtent(this.layer._planet.ellipsoid,this.extent.inverseMercator()):(this.bsphere.radius=this.layer._planet.ellipsoid.equatorialSize,this.bsphere.center=new m)}__setLonLat__(e){return e._lonLat.isZero()&&!e._cartesian.isZero()&&(e._lonLat=this.layer._planet.ellipsoid.cartesianToLonLat(e._cartesian)),Math.abs(e._lonLat.lat)<ht?e._lonLatMerc=e._lonLat.forwardMercator():e._lonLatMerc=new A,e._lonLatMerc}buildTree(e,t=!1){if(this.count+=e.length,e.length>this.layer._nodeCapacity){const s=this.childNodes;s.length||this.createChildNodes();let n=[],o=[],a=[],h=[],c=e.length;for(;c--;){const d=e[c];s[0].isInside(d)?(d._nodePtr=s[0],n.push(d)):s[1].isInside(d)?(d._nodePtr=s[1],o.push(d)):s[2].isInside(d)?(d._nodePtr=s[2],a.push(d)):s[3].isInside(d)&&(d._nodePtr=s[3],h.push(d))}n.length&&s[0].buildTree(n,t),o.length&&s[1].buildTree(o,t),a.length&&s[2].buildTree(a,t),h.length&&s[3].buildTree(h,t)}else this._addEntitiesToCollection(e,t)}isInside(e){return!!e._lonLatMerc&&this.extent.isInside(e._lonLatMerc)}createChildNodes(){const e=this.strategy,t=this.extent,s=.5*t.getWidth(),n=.5*t.getHeight(),o=t.northEast,a=t.southWest,h=new A(a.lon+s,a.lat+n),c=this.childNodes,d=this.layer._planet,u=this.zoom+1;c[0]=new ge(e,0,this,new H(new A(a.lon,a.lat+n),new A(a.lon+s,o.lat)),d,u),c[1]=new ge(e,1,this,new H(h,new A(o.lon,o.lat)),d,u),c[2]=new ge(e,2,this,new H(new A(a.lon,a.lat),h),d,u),c[3]=new ge(e,3,this,new H(new A(a.lon+s,a.lat),new A(o.lon,a.lat+n)),d,u)}collectRenderCollectionsPASS1(e,t){const s=e[this.nodeId];if(s){const n=this.childNodes;this.entityCollection?this.renderCollection(t,e):n.length&&(s.state===1?this.strategy._secondPASS.push(this):(n[0].collectRenderCollectionsPASS1(e,t),n[1].collectRenderCollectionsPASS1(e,t),n[2].collectRenderCollectionsPASS1(e,t),n[3].collectRenderCollectionsPASS1(e,t)))}}collectRenderCollectionsPASS2(e,t,s){const n=this.layer._planet.camera,o=n.eye.distance(this.bsphere.center)-this.bsphere.radius<3570*Math.sqrt(n._lonLat.height)||n._lonLat.height>1e4;if(this.count>0&&o&&n.containsSphere(this.bsphere)){const a=this.childNodes;this.entityCollection?this.renderCollection(t,e,s):a.length&&(a[0].collectRenderCollectionsPASS2(e,t,s),a[1].collectRenderCollectionsPASS2(e,t,s),a[2].collectRenderCollectionsPASS2(e,t,s),a[3].collectRenderCollectionsPASS2(e,t,s))}}applyCollection(){this.entityCollection.addEntities(this.deferredEntities),this.deferredEntities.length=0,this.deferredEntities=[],this._inTheQueue=!1}traverseTree(e){const t=this.childNodes;this.entityCollection?e(this):t.length&&(t[0].traverseTree(e),t[1].traverseTree(e),t[2].traverseTree(e),t[3].traverseTree(e))}renderCollection(e,t,s){const n=this.strategy;n._renderingNodes[this.nodeId]=!0,this.deferredEntities.length&&!this._inTheQueue&&(this.layer.async?n._queueDeferredNode(this):this.applyCollection());let o=this.entityCollection,a=this.layer;if(o._fadingOpacity=a._fadingOpacity,o.scaleByDistance=a.scaleByDistance,o.pickingScale=a.pickingScale,o.polygonOffsetUnits=a.polygonOffsetUnits,e.push(o),a.clampToGround||a.relativeToGround){const h=o._entities;let c=h.length;if(t[this.nodeId]&&t[this.nodeId].state===1)for(;c--;){let d=h[c];this.alignEntityToTheGround(d,t[this.nodeId].segment)}else if(s)for(;c--;){let d=h[c];this.alignEntityToTheGround(d,t[s].segment)}else{const d=this.strategy.quadTreeStrategy._renderedNodes;for(;c--;){let u=h[c],_=d.length;for(;_--;)if(d[_].segment.isEntityInside(u)){this.alignEntityToTheGround(u,d[_].segment);break}}}}}alignEntityToTheGround(e,t){let s=new m;t.getEntityTerrainPoint(e,s);let n=Number(this.layer.relativeToGround)&&e._altitude||0;if(n){let o=this.layer._planet.ellipsoid.getSurfaceNormal3v(s);e._setCartesian3vSilent(s.addA(o.scale(n)))}else e._setCartesian3vSilent(s)}isVisible(){return!!this.strategy._renderingNodes[this.nodeId]}}class Te extends ge{constructor(e,t,s,n,o,a){super(e,t,s,n,o,a),this.strategy=e,this.isNorth=!1}createChildNodes(){const e=this.strategy,t=this.extent,s=.5*t.getWidth(),n=.5*t.getHeight(),o=t.northEast,a=t.southWest,h=new A(a.lon+s,a.lat+n),c=this.childNodes,d=this.layer._planet,u=this.zoom+1;c[0]=new Te(e,0,this,new H(new A(a.lon,a.lat+n),new A(a.lon+s,o.lat)),d,u),c[1]=new Te(e,1,this,new H(h,new A(o.lon,o.lat)),d,u),c[2]=new Te(e,2,this,new H(new A(a.lon,a.lat),h),d,u),c[3]=new Te(e,3,this,new H(new A(a.lon+s,a.lat),new A(o.lon,a.lat+n)),d,u)}_setExtentBounds(){this.extent.northEast.lat>0&&(this.isNorth=!0),this.bsphere.setFromExtent(this.layer._planet.ellipsoid,this.extent)}__setLonLat__(e){return e._lonLat.isZero()&&(e._lonLat=this.layer._planet.ellipsoid.cartesianToLonLat(e._cartesian)),e._lonLat}isVisible(){return!(!this.isNorth||!this.strategy._renderingNodesNorth[this.nodeId])||!!this.strategy._renderingNodesSouth[this.nodeId]}isInside(e){return this.extent.isInside(e._lonLat)}renderCollection(e,t,s){this.isNorth?this.strategy._renderingNodesNorth[this.nodeId]=!0:this.strategy._renderingNodesSouth[this.nodeId]=!0,this.deferredEntities.length&&!this._inTheQueue&&(this.layer.async?this.strategy._queueDeferredNode(this):this.applyCollection());const n=this.entityCollection;n._fadingOpacity=this.layer._fadingOpacity,n.scaleByDistance=this.layer.scaleByDistance,n.pickingScale=this.layer.pickingScale,n.isEmpty()||e.push(n)}}class Wh extends hn{constructor(e,t,s){super(e,t,s);let n=t._planet;this._entityCollectionsTree=new ge(this,0,null,H.createFromArray([-2003750834e-2,-2003750834e-2,2003750834e-2,2003750834e-2]),n,0),this._entityCollectionsTreeNorth=new Te(this,0,null,H.createFromArray([-180,ht,180,90]),n,0),this._entityCollectionsTreeSouth=new Te(this,0,null,H.createFromArray([-180,-90,180,Ft]),n,0),this._renderingNodes={},this._renderingNodesNorth={},this._renderingNodesSouth={}}insertEntity(e,t=!1){e._lonLat.lat>ht?(this._entityCollectionsTreeNorth.__setLonLat__(e),this._entityCollectionsTreeNorth.insertEntity(e,t)):e._lonLat.lat<Ft?(this._entityCollectionsTreeSouth.__setLonLat__(e),this._entityCollectionsTreeSouth.insertEntity(e,t)):(this._entityCollectionsTree.__setLonLat__(e),this._entityCollectionsTree.insertEntity(e,t))}setPickingEnabled(e){this._entityCollectionsTree&&this._entityCollectionsTree.traverseTree(t=>{t.entityCollection.setPickingEnabled(e)}),this._entityCollectionsTreeNorth&&this._entityCollectionsTreeNorth.traverseTree(t=>{t.entityCollection.setPickingEnabled(e)}),this._entityCollectionsTreeSouth&&this._entityCollectionsTreeSouth.traverseTree(t=>{t.entityCollection.setPickingEnabled(e)})}dispose(){this._entityCollectionsTree=null,this._entityCollectionsTreeNorth=null,this._entityCollectionsTreeSouth=null,this._renderingNodes={},this._renderingNodesNorth={},this._renderingNodesSouth={}}insertEntities(e){let t=[],s=[],n=[];for(let o=0,a=e.length;o<a;o++){let h=e[o];h._lonLat.lat>ht?(t.push(h),this._entityCollectionsTreeNorth.__setLonLat__(h)):h._lonLat.lat<Ft?(s.push(h),this._entityCollectionsTreeSouth.__setLonLat__(h)):(n.push(h),this._entityCollectionsTree.__setLonLat__(h))}this._entityCollectionsTree.buildTree(n),this._entityCollectionsTreeNorth.buildTree(t),this._entityCollectionsTreeSouth.buildTree(s)}collectVisibleEntityCollections(e){this._renderingNodes={},this._renderingNodesNorth={},this._renderingNodesSouth={};let t=this._layer._planet.quadTreeStrategy;this._secondPASS=[],this._entityCollectionsTree.collectRenderCollectionsPASS1(t._visibleNodes,e);let s=this._secondPASS.length;for(;s--;)this._secondPASS[s].collectRenderCollectionsPASS2(t._visibleNodes,e,this._secondPASS[s].nodeId);for(this._secondPASS=[],this._entityCollectionsTreeNorth.collectRenderCollectionsPASS1(t._visibleNodesNorth,e),s=this._secondPASS.length;s--;)this._secondPASS[s].collectRenderCollectionsPASS2(t._visibleNodesNorth,e,this._secondPASS[s].nodeId);for(this._secondPASS=[],this._entityCollectionsTreeSouth.collectRenderCollectionsPASS1(t._visibleNodesSouth,e),s=this._secondPASS.length;s--;)this._secondPASS[s].collectRenderCollectionsPASS2(t._visibleNodesSouth,e,this._secondPASS[s].nodeId)}}class Ea extends Bs{constructor(e){super({name:"Earth",...e}),this._visibleNodesNorth={},this._visibleNodesSouth={}}collectVisibleNode(e){let t=e.segment._tileGroup;t===20?this._visibleNodesNorth[e.nodeId]=e:t===Le?this._visibleNodesSouth[e.nodeId]=e:this._visibleNodes[e.nodeId]=e}_clearVisibleNodes(){super._clearVisibleNodes(),this._visibleNodesNorth={},this._visibleNodesSouth={}}createEntityCollectionsTreeStrategy(e,t){return new Wh(this,e,t)}init(e){this._quadTreeList=[new jt(Ca,this,0,null,0,H.createFromArray([-2003750834e-2,-2003750834e-2,2003750834e-2,2003750834e-2])),new jt(Fr,this,0,null,0,H.createFromArray([-180,ht,180,90])),new jt(Fr,this,0,null,0,H.createFromArray([-180,-90,180,Ft]))],super.init(e)}getTileXY(e,t){let s,n,o=function(c,d=ht){return c>d?20:c<-d?Le:0}(e.lat,ht),a=t,h=1<<a;if(o===20)s=Et(e.lon,360/h,-180),n=Et(e.lat,(90-ht)/h,90);else if(o===Le)s=Et(e.lon,360/h,-180),n=Et(e.lat,(90-ht)/h,Ft);else{let c=Ki(e);s=Et(c.lon,Zi/h,-2003750834e-2),n=Et(c.lat,Zi/h,At)}return[s,n,a,o]}getLonLatTileOffset(e,t,s,n,o){let a,h=e;e.lat>ht?a=Pi(t,s,n,H.createFromArray([-180,ht,180,90])):e.lat<Ft?a=Pi(t,s,n,H.createFromArray([-180,-90,180,Ft])):(h=Ki(e),a=$e(t,s,n));let c=a.getWidth()/(o-1),d=a.getHeight()/(o-1);return[o-Math.ceil((h.lat-a.southWest.lat)/d)-1,Math.floor((h.lon-a.southWest.lon)/c)]}}class Aa{constructor(e={}){this.model=e.model||null,this.src=e.src||null,this._cached_ix=0,this._cached_iy=0,this._v00=0,this._v01=0,this._v10=0,this._v11=0,this._t=0}static loadModel(e){return e?fetch(e,{}).then(t=>{if(!t.ok)throw Error("Geoid model file: HTTP error "+t.status);return t.arrayBuffer()}).then(t=>{if(t)return new Uint8Array(t);throw Error("Geoid model file: no data from "+e)}).then(function(t){if(t[0]!==80||t[1]!==53||(t[2]!==13||t[3]!==10)&&t[2]!==10)throw new Error("Geoid model file: no PGM header");var s,n,o=t[2]===13?4:3,a=null,h=null;function c(){let _=o;for(var f=o;;f++){if(f>=t.length)throw new Error("Geoid model file: missing newline in header");if(t[f]===10){o=f+1;break}}return f>_&&t[f-1]===13&&f--,String.fromCharCode.apply(null,t.slice(_,f))}for(;(n=c())[0]==="#";)if(s=n.match(/^# Offset (.*)$/)){if(a=parseInt(s[1],10),!isFinite(a))throw new Error("Geoid model file: bad offset "+s[1])}else if((s=n.match(/^# Scale (.*)$/))&&(h=parseFloat(s[1]),!isFinite(h)))throw new Error("Geoid model file: bad scale "+s[1]);let d=0,u=0;if((s=n.match(/^\s*(\d+)\s+(\d+)\s*$/))&&(d=parseInt(s[1],10),u=parseInt(s[2],10)),!(s&&d>=0&&u>=0))throw new Error("Geoid model file: bad PGM width&height line");if(parseInt(c())!=65535)throw new Error("Geoid model file: PGM file must have 65535 gray levels");if(a===null)throw new Error("Geoid model file: PGM file does not contain offset");if(h===null)throw new Error("Geoid model file: PGM file does not contain scale");if(d<2||u<2)throw new Error("Geoid model file: Raster size too small");if(t.length-o!=d*u*2)throw new Error("Geoid model file: File has the wrong length");return{scale:h,offset:a,width:d,height:u,rlonres:d/360,rlatres:(u-1)/180,i:o,rawfile:t}}):new Promise(t=>{t(null)})}setModel(e){this.model=e}_rawval(e,t){let s=this.model;t<0?(t=-t,e+=s.width/2):t>=s.height&&(t=2*(s.height-1)-t,e+=s.width/2),e<0?e+=s.width:e>=s.width&&(e-=s.width);let n=2*(t*s.width+e)+s.i;return s.rawfile[n]<<8|s.rawfile[n+1]}getHeightLonLat(e){return this.getHeight(e.lon,e.lat)}getHeight(e,t){if(!this.model)return 0;let s=this.model;e<0&&(e+=360);let n=(90-t)*s.rlatres,o=e*s.rlonres,a=Math.floor(n),h=Math.floor(o);o-=h,n-=a,a===s.height-1&&a--,this._cached_ix===h&&this._cached_iy===a||(this._cached_ix=h,this._cached_iy=a,this._v00=this._rawval(h,a),this._v01=this._rawval(h+1,a),this._v10=this._rawval(h,a+1),this._v11=this._rawval(h+1,a+1));let c=(1-n)*((1-o)*this._v00+o*this._v01)+n*((1-o)*this._v10+o*this._v11);return s.offset+s.scale*c}}class $h{constructor(e,t=5){this.MAX_FRAMES=t,this._gridSize=64,this._planet=e,this._framebuffer=null,this._framebufferMercProj=null,this._texCoordsBuffer=null,this._indexBuffer=null,this._currentFrame=0,this._queue=[],this._animate=[],this._quadTexCoordsBuffer=null,this._quadVertexBuffer=null}init(){this._initShaders(),this._initBuffers()}createGridBuffer(e,t=!1){let s=this._gridSize,n=new A((e[3].lon-e[0].lon)/s,(e[3].lat-e[0].lat)/s),o=new A((e[2].lon-e[1].lon)/s,(e[2].lat-e[1].lat)/s),a=new A((e[1].lon-e[0].lon)/s,(e[1].lat-e[0].lat)/s),h=new A((e[2].lon-e[3].lon)/s,(e[2].lat-e[3].lat)/s);const c=(s+1)*(s+1)*2,d=c/2;let u=new Float32Array(c),_=new Float32Array(c),f=new Array(d),v=0,g=0,y=0,p=new Float32Array(2);for(let x=0;x<=s;x++){let T=new A(e[0].lon+x*n.lon,e[0].lat+x*n.lat),w=new A(e[1].lon+x*o.lon,e[1].lat+x*o.lat);for(let C=0;C<=s;C++){let E=Ro(T,w,new A(e[0].lon+C*a.lon,e[0].lat+C*a.lat),new A(e[3].lon+C*h.lon,e[3].lat+C*h.lat));oe(E.lon,p),u[v++]=p[0],_[g++]=p[1],oe(E.lat,p),u[v++]=p[0],_[g++]=p[1],f[y++]=E}}if(t)for(let x=0;x<d;x++){let T=f[x].forwardMercator();oe(T.lon,p),u[2*x]=p[0],_[2*x]=p[1],oe(T.lat,p),u[2*x+1]=p[0],_[2*x+1]=p[1]}return[this._planet.renderer.handler.createArrayBuffer(u,2,d),this._planet.renderer.handler.createArrayBuffer(_,2,d)]}frame(){let e=this.MAX_FRAMES;for(;e--&&this._queue.length;){const t=this._queue.shift();t._isRendering=!1,t.rendering(),t.events.dispatch(t.events.loadend)}for(e=this._animate.length;e--;)this._animate[e].rendering()}add(e){e._isRendering||(e._isRendering=!0,e._animate?this._animate.push(e):this._queue.push(e))}remove(e){if(e._isRendering){let t;e._creationProceeding=!1,e._isRendering=!1,t=e._animate?this._animate:this._queue;for(let s=0;s<t.length;s++)if(t[s].isEqual(e))return void t.splice(s,1)}}_initBuffers(){let e=this._planet.renderer.handler;this._framebuffer=new St(e,{width:2,height:2,useDepth:!1}),this._framebuffer.init(),this._framebufferMercProj=new St(e,{width:2,height:2,useDepth:!1}),this._framebufferMercProj.init();let t=Math.log2(this._gridSize);this._texCoordsBuffer=this._planet._textureCoordsBufferCache[t],this._indexBuffer=this._planet._indexesCache[t][t][t][t][t].buffer,this._quadTexCoordsBuffer=e.createArrayBuffer(new Float32Array([0,1,1,1,0,0,1,0]),2,4),this._quadVertexBuffer=e.createArrayBuffer(new Float32Array([-1,1,1,1,-1,-1,1,-1]),2,4)}_initShaders(){this._planet.renderer.handler.addProgram(new $("geoImageTransform",{uniforms:{sourceTexture:"sampler2d",extentParamsHigh:"vec4",extentParamsLow:"vec4",isFullExtent:"bool"},attributes:{cornersHigh:"vec2",cornersLow:"vec2",texCoords:"vec2"},vertexShader:`attribute vec2 cornersHigh; 
                     attribute vec2 cornersLow;
                      attribute vec2 texCoords; 
                      uniform vec4 extentParamsHigh; 
                      uniform vec4 extentParamsLow; 
                      varying vec2 v_texCoords;
                      void main() {                                                             
                          v_texCoords = texCoords; 
                          vec2 highDiff = cornersHigh - extentParamsHigh.xy;
                          vec2 lowDiff = cornersLow - extentParamsLow.xy;                                        
                          gl_Position = vec4((-1.0 + (highDiff * step(1.0, length(highDiff)) + lowDiff) * extentParamsHigh.zw) * vec2(1.0, -1.0), 0.0, 1.0); 
                      }`,fragmentShader:`precision highp float;
                        uniform sampler2D sourceTexture;
                        uniform bool isFullExtent;
                        varying vec2 v_texCoords;
                        void main () {
                            if(!isFullExtent && (v_texCoords.x <= 0.001 || v_texCoords.x >= 0.999 ||
                                v_texCoords.y <= 0.001 || v_texCoords.y >= 0.999)) {
                                discard;
                            }
                            gl_FragColor = texture2D(sourceTexture, v_texCoords);
                        }`}))}}const Xh=["loadend","layerloadend"];class La{constructor(e=24){this.MAX_REQUESTS=e,this.events=ot(Xh),this._loading=0,this._queue=[],this._senderRequestCounter=[],this._promises={json:t=>t.json(),blob:t=>t.blob(),arrayBuffer:t=>t.arrayBuffer(),imageBitmap:t=>t.blob().then(s=>createImageBitmap(s,{premultiplyAlpha:"premultiply"})),text:t=>t.text()}}load(e,t){e.sender&&(this._senderRequestCounter[e.sender.__id]||(this._senderRequestCounter[e.sender.__id]={sender:e.sender,counter:0,__requestCounterFrame__:0}),this._senderRequestCounter[e.sender.__id].counter++),this._queue.push({params:e,callback:t}),this._exec()}fetch(e){return fetch(e.src,e.options||{}).then(t=>{if(!t.ok)throw Error(`Unable to load '${e.src}'`);return this._promises[e.type||"blob"](t)}).then(t=>({status:"ready",data:t})).catch(t=>({status:"error",msg:t.toString()}))}getRequestCounter(e){if(e){let t=this._senderRequestCounter[e.__id];if(t)return t.counter}return 0}isIdle(e){return e.isIdle}_checkLoadend(e,t){e.counter===0&&(!t._planet||t.quadTreeStrategy&&t.quadTreeStrategy._terrainCompletedActivated)?(t.events.dispatch(t.events.loadend,t),this.events.dispatch(this.events.layerloadend,t),e.__requestCounterFrame__=0):e.__requestCounterFrame__=requestAnimationFrame(()=>{this._checkLoadend(e,t)})}_handleResponse(e,t){e.callback(t);let s=e.params.sender;if(s&&(s.events.loadend.handlers.length||this.events.layerloadend.handlers.length)){let n=this._senderRequestCounter[s.__id];n&&n.counter>0&&(n.counter--,cancelAnimationFrame(n.__requestCounterFrame__),n.__requestCounterFrame__=requestAnimationFrame(()=>{this._checkLoadend(n,s)}))}this._exec()}_exec(){if(this._queue.length>0&&this._loading<this.MAX_REQUESTS){let e=this._queue.pop();if(!e)return;let t=e.params;if(!t.filter||t.filter(t))return this._loading++,fetch(t.src,t.options||{}).then(s=>{if(!s.ok)throw Error(`Unable to load '${t.src}'`);return this._promises[t.type||"blob"](s)}).then(s=>{this._loading--,this._handleResponse(e,{status:"ready",data:s})}).catch(s=>{this._loading--,this._handleResponse(e,{status:"error",msg:s.toString()})});this._handleResponse(e,{status:"abort"})}else this._loading===0&&this.events.dispatch(this.events.loadend)}abort(e){this._senderRequestCounter[e.__id]&&(this._senderRequestCounter[e.__id].counter=0,cancelAnimationFrame(this._senderRequestCounter[e.__id].__requestCounterFrame__),this._senderRequestCounter[e.__id].__requestCounterFrame__=0);for(let t=0,s=this._queue.length;t<s;t++){let n=this._queue[t];n&&n.params.sender&&e.isEqual(n.params.sender)&&(n.callback({status:"abort"}),this._queue[t]=null)}}abortAll(){for(let e=0,t=this._queue.length;e<t;e++){let s=this._queue[e];if(s){let n=s.params.sender;n&&this._senderRequestCounter[n.__id]&&(this._senderRequestCounter[n.__id].counter=0,cancelAnimationFrame(this._senderRequestCounter[n.__id].__requestCounterFrame__),this._senderRequestCounter[n.__id].__requestCounterFrame__=0),s.callback({status:"abort"}),this._queue[e]=null}}this._queue=[]}get loading(){return this._loading}get queue(){return this._queue}}class Zh{constructor(e,t={}){this._minTabelSize=t.minTableSize||1,this._maxTableSize=t.maxTableSize||8,this._planet=e,this._handler=null,this._verticesBufferArray=[],this._indexBufferArray=[],this._positionBuffer=null,this._framebuffer=null,this._normalMapVerticesTexture=null,this._width=t.width||128,this._height=t.height||128,this._queue=new ln(1024),this._lock=new Br}get width(){return this._width}get height(){return this._height}init(){this._maxTableSize=this._planet.maxGridSize||8,this._handler=this._planet.renderer.handler;const e=new $("normalMapBlur",{attributes:{a_position:"vec2"},uniforms:{s_texture:"sampler2d"},vertexShader:`attribute vec2 a_position;
                       attribute vec2 a_texCoord;

                      varying vec2 blurCoordinates[5];

                      void main() {
                          vec2 vt = a_position * 0.5 + 0.5; 
                           
                          gl_Position = vec4(a_position, 0.0, 1.0);
                          blurCoordinates[0] = vt;
                          blurCoordinates[1] = vt + ${1/this._width*1.407333};
                          blurCoordinates[2] = vt - ${1/this._height*1.407333};
                          blurCoordinates[3] = vt + ${1/this._width*3.294215};
                          blurCoordinates[4] = vt - ${1/this._height*3.294215};
                }`,fragmentShader:`precision lowp float;
                        uniform sampler2D s_texture;                        
                        varying vec2 blurCoordinates[5];                        

                        void main() {
                            lowp vec4 sum = vec4(0.0);
                            //if(blurCoordinates[0].x <= 0.01 || blurCoordinates[0].x >= 0.99 ||
                            //    blurCoordinates[0].y <= 0.01 || blurCoordinates[0].y >= 0.99){
                            //    sum = texture2D(s_texture, blurCoordinates[0]);
                            //} else {
                                sum += texture2D(s_texture, blurCoordinates[0]) * 0.204164;
                                sum += texture2D(s_texture, blurCoordinates[1]) * 0.304005;
                                sum += texture2D(s_texture, blurCoordinates[2]) * 0.304005;
                                sum += texture2D(s_texture, blurCoordinates[3]) * 0.093913;
                                sum += texture2D(s_texture, blurCoordinates[4]) * 0.093913;
                            //}
                            gl_FragColor = sum;
                        }`}),t=new $("normalMap",{attributes:{a_position:"vec2",a_normal:"vec3"},uniforms:{},vertexShader:`attribute vec2 a_position;
                      attribute vec3 a_normal;
                      
                      varying vec3 v_color;
                      
                      void main() {
                          gl_Position = vec4(a_position, 0, 1);
                          v_color = normalize(a_normal) * 0.5 + 0.5;
                      }`,fragmentShader:`precision highp float;
                        
                        varying vec3 v_color;
                        
                        void main () {
                            gl_FragColor = vec4(v_color, 1.0);
                        }`});this._handler.addProgram(e),this._handler.addProgram(t),this._framebuffer=new St(this._handler,{width:this._width,height:this._height,useDepth:!1}),this._framebuffer.init(),this._normalMapVerticesTexture=this._handler.createEmptyTexture_l(this._width,this._height);for(let n=this._minTabelSize;n<=this._maxTableSize;n++){const o=1<<n,a=o/2;let h=new Float32Array((o+1)*(o+1)*2);for(let c=0;c<=o;c++)for(let d=0;d<=o;d++){let u=2*(c*(o+1)+d);h[u]=d/a-1,h[u+1]=c/a-1}this._verticesBufferArray[o]=this._handler.createArrayBuffer(h,2,h.length/2),this._indexBufferArray[o]=this._planet._indexesCache[Math.log2(o)][Math.log2(o)][Math.log2(o)][Math.log2(o)][Math.log2(o)].buffer}const s=new Float32Array([-1,-1,1,-1,-1,1,1,1]);this._positionBuffer=this._handler.createArrayBuffer(s,2,s.length/2)}_drawNormalMapBlur(e){let t=e.normalMapNormals;if(e.node&&e.node.getState()!==0&&t&&t.length){const s=t.length/3,n=Math.sqrt(s)-1;let o=this._verticesBufferArray[n];if(o){e.planet.terrain.equalizeNormals&&(e._normalMapEdgeEqualize(0),e._normalMapEdgeEqualize(2),e._normalMapEdgeEqualize(3),e._normalMapEdgeEqualize(1));let a=e.normalMapTexturePtr;const h=this._handler,c=h.gl;let d=h.createArrayBuffer(t,3,s,c.DYNAMIC_DRAW);const u=this._framebuffer;let _=h.programs.normalMap,f=_._program.attributes;return u.bindOutputTexture(this._normalMapVerticesTexture),_.activate(),c.bindBuffer(c.ARRAY_BUFFER,o),c.vertexAttribPointer(f.a_position,o.itemSize,c.FLOAT,!1,0,0),c.bindBuffer(c.ARRAY_BUFFER,d),c.vertexAttribPointer(f.a_normal,d.itemSize,c.FLOAT,!1,0,0),c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,this._indexBufferArray[n]),c.drawElements(c.TRIANGLE_STRIP,this._indexBufferArray[n].numItems,c.UNSIGNED_INT,0),c.deleteBuffer(d),u.bindOutputTexture(a),_=h.programs.normalMapBlur,_.activate(),c.bindBuffer(c.ARRAY_BUFFER,this._positionBuffer),c.vertexAttribPointer(_._program.attributes.a_position,this._positionBuffer.itemSize,c.FLOAT,!1,0,0),c.activeTexture(c.TEXTURE0),c.bindTexture(c.TEXTURE_2D,this._normalMapVerticesTexture),c.uniform1i(_._program.uniforms.s_texture,0),c.drawArrays(c.TRIANGLE_STRIP,0,this._positionBuffer.numItems),!0}return!0}return!1}_drawNormalMapNoBlur(e){let t=e.normalMapNormals;if(e.node&&e.node.getState()!==0&&t&&t.length){const s=t.length/3,n=Math.sqrt(s)-1;let o=this._verticesBufferArray[n];if(o){e.planet.terrain.equalizeNormals&&(e._normalMapEdgeEqualize(0),e._normalMapEdgeEqualize(2),e._normalMapEdgeEqualize(3),e._normalMapEdgeEqualize(1));let a=e.normalMapTexturePtr;const h=this._handler,c=h.gl;let d=h.createArrayBuffer(t,3,s,c.DYNAMIC_DRAW);const u=this._framebuffer,_=h.programs.normalMap,f=_._program.attributes;return u.bindOutputTexture(a),_.activate(),c.bindBuffer(c.ARRAY_BUFFER,o),c.vertexAttribPointer(f.a_position,o.itemSize,c.FLOAT,!1,0,0),c.bindBuffer(c.ARRAY_BUFFER,d),c.vertexAttribPointer(f.a_normal,d.itemSize,c.FLOAT,!1,0,0),c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,this._indexBufferArray[n]),c.drawElements(c.TRIANGLE_STRIP,this._indexBufferArray[n].numItems,c.UNSIGNED_INT,0),c.deleteBuffer(d),!0}return!0}return!1}_drawNormalMap(e){return e.planet.terrain.isBlur(e)?this._drawNormalMapBlur(e):this._drawNormalMapNoBlur(e)}drawSingle(e){const t=this._handler.gl;this._framebuffer.activate(),t.disable(t.CULL_FACE),t.disable(t.DEPTH_TEST),t.disable(t.BLEND),e.terrainReady&&this._drawNormalMap(e)&&(e.normalMapReady=!0,e.normalMapTexture=e.normalMapTexturePtr,e.normalMapTextureBias[0]=0,e.normalMapTextureBias[1]=0,e.normalMapTextureBias[2]=1),e._inTheQueue=!1,t.enable(t.DEPTH_TEST),t.enable(t.CULL_FACE),t.enable(t.BLEND),this._framebuffer.deactivate()}frame(){if(this._queue.length){const e=this._handler.gl;this._framebuffer.activate(),e.disable(e.CULL_FACE),e.disable(e.DEPTH_TEST),e.disable(e.BLEND);let t=0,s=window.performance.now();for(;this._lock.isFree()&&this._queue.length&&t<.25;){const n=this._queue.shift();n.terrainReady&&this._drawNormalMap(n)&&(n.normalMapReady=!0,n.normalMapTexture=n.normalMapTexturePtr,n.normalMapTextureBias[0]=0,n.normalMapTextureBias[1]=0,n.normalMapTextureBias[2]=1),n._inTheQueue=!1,t=window.performance.now()-s}e.enable(e.BLEND),e.enable(e.DEPTH_TEST),e.enable(e.CULL_FACE),this._framebuffer.deactivate()}}get queueSize(){return this._queue.length}queue(e){e._inTheQueue=!0,this._queue.push(e)}unshift(e){e._inTheQueue=!0,this._queue.unshift(e)}remove(e){}clear(){for(;this._queue.length;)this._queue.pop()._inTheQueue=!1}lock(e){this._lock.lock(e)}free(e){this._lock.free(e)}}const cn=new on({code:"equi",units:Ta}),Pa=`(function(){"use strict";let l=null,K=null,O=null,Q=null,S=null,T=null,U=null;function P(a,t){t<0?(t=-t,a+=l.width/2):t>=l.height&&(t=2*(l.height-1)-t,a+=l.width/2),a<0?a+=l.width:a>=l.width&&(a-=l.width);var n=2*(t*l.width+a)+l.i;return l.rawfile[n]<<8|l.rawfile[n+1]}const sa=.5*Math.PI,W=2003750834e-2,ia=Math.PI/W,ua=180/W,X=180/Math.PI,Ma=X*sa,Y=Math.PI/180,da=2*X;let k=0,Z=0,_=null;const B=function(a,t,n){this.x=a,this.y=t,this.z=n};var $=function(a,t,n,o){let f=function(c,C){if(!l)return 0;c<0&&(c+=360);var w=(90-C)*l.rlatres,M=c*l.rlonres,u=Math.floor(w),d=Math.floor(M);M-=d,w-=u,u===l.height-1&&u--,K===d&&O===u||(K=d,O=u,Q=P(d,u),S=P(d+1,u),T=P(d,u+1),U=P(d+1,u+1));let L=null;return L=(1-w)*((1-M)*Q+M*S)+w*((1-M)*T+M*U),l.offset+l.scale*L}(a,t)*n,h=Y*t,r=Y*a,m=Math.sin(h),x=Z/Math.sqrt(1-k*m*m),H=(x+f)*Math.cos(h);o.x=H*Math.cos(r),o.y=H*Math.sin(r),o.z=(x*(1-k)+f)*m},ma=function(a,t,n,o){$(a*ua,da*Math.atan(Math.exp(t*ia))-Ma,n,o)},e=new B(0,0,0),p=new B(0,0,0),y=new B(0,0,0),pa=function(a,t,n){let o=a.x,f=a.y,h=a.z;var r;o>=0?(r=65536*Math.floor(o/65536),t.x=Math.fround(r),n.x=Math.fround(o-r)):(r=65536*Math.floor(-o/65536),t.x=Math.fround(-r),n.x=Math.fround(o+r)),f>=0?(r=65536*Math.floor(f/65536),t.y=Math.fround(r),n.y=Math.fround(f-r)):(r=65536*Math.floor(-f/65536),t.y=Math.fround(-r),n.y=Math.fround(f+r)),h>=0?(r=65536*Math.floor(h/65536),t.z=Math.fround(r),n.z=Math.fround(h-r)):(r=65536*Math.floor(-h/65536),t.z=Math.fround(-r),n.z=Math.fround(h+r))};self.onmessage=function(a){if(a.data.model)l=a.data.model,l.rawfile=a.data.rawfile;else if(a.data.params){let t=549755748352,n=-549755748352,o=549755748352,f=-549755748352,h=549755748352,r=-549755748352;k=a.data.params[8],Z=a.data.params[9];let m=a.data.params[2],x=a.data.params[3],H=a.data.params[10],c=a.data.params[11],C=a.data.params[12],w=a.data.params[13];_=a.data.params[1]===0?ma:$;let M=Math.max(x,m),u=(a.data.params[6]-a.data.params[4])/M,d=(a.data.params[7]-a.data.params[5])/M,L=a.data.params[4],ya=a.data.params[7],aa=Math.max(x/m,1),N=M+1;const z=N*N,R=(m+1)*(m+1)*3;let b=new Float32Array(R),A=new Float64Array(R),F=new Float32Array(R),g=new Float32Array(R),V=new Float32Array(3*z),q=new Float64Array(3*z),v=new Float32Array(3*z),I=new Float32Array(3*z),s=0,i=0;for(let j=0;j<z;j++){let la=j%N,na=~~(j/N);_(L+la*u,ya-na*d,w,e);let D=e.x*H,E=e.y*c,G=e.z*C,J=1/Math.sqrt(D*D+E*E+G*G),oa=D*J,fa=E*J,ha=G*J;pa(e,p,y),q[i]=e.x,v[i]=p.x,I[i]=y.x,V[i++]=oa,q[i]=e.y,v[i]=p.y,I[i]=y.y,V[i++]=fa,q[i]=e.z,v[i]=p.z,I[i]=y.z,V[i++]=ha,na%aa==0&&la%aa==0&&(A[s]=e.x,F[s]=p.x,g[s]=y.x,b[s++]=oa,A[s]=e.y,F[s]=p.y,g[s]=y.y,b[s++]=fa,A[s]=e.z,F[s]=p.z,g[s]=y.z,b[s++]=ha,e.x<t&&(t=e.x),e.x>n&&(n=e.x),e.y<o&&(o=e.y),e.y>f&&(f=e.y),e.z<h&&(h=e.z),e.z>r&&(r=e.z))}let ta=.5*(n-t),ra=.5*(f-o),ea=.5*(r-h),wa=Math.sqrt(ta*ta+ra*ra+ea*ea);self.postMessage({id:a.data.params[0],plainVertices:A,plainVerticesHigh:F,plainVerticesLow:g,plainNormals:b,normalMapNormals:V,normalMapVertices:q,normalMapVerticesHigh:v,normalMapVerticesLow:I,plainRadius:wa},[A.buffer,F.buffer,g.buffer,b.buffer,V.buffer,q.buffer,v.buffer,I.buffer])}}})();
//# sourceMappingURL=PlainSegmentWorker.worker-CT1cj8jj.js.map
`,ao=typeof self<"u"&&self.Blob&&new Blob([Pa],{type:"text/javascript;charset=utf-8"});function Kh(l){let e;try{if(e=ao&&(self.URL||self.webkitURL).createObjectURL(ao),!e)throw"";const t=new Worker(e,{name:l==null?void 0:l.name});return t.addEventListener("error",()=>{(self.URL||self.webkitURL).revokeObjectURL(e)}),t}catch{return new Worker("data:text/javascript;charset=utf-8,"+encodeURIComponent(Pa),{name:l==null?void 0:l.name})}finally{e&&(self.URL||self.webkitURL).revokeObjectURL(e)}}class Qh extends Qr{constructor(e=2){super(e,Kh)}_onMessage(e){this._source.get(e.data.id)._plainSegmentWorkerCallback(e.data),e.data.plainVertices=null,e.data.plainVerticesHigh=null,e.data.plainVerticesLow=null,e.data.plainNormals=null,e.data.normalMapNormals=null,e.data.normalMapVertices=null,e.data.normalMapVerticesHigh=null,e.data.normalMapVerticesLow=null,this._source.delete(e.data.id)}setGeoid(e){if(e.model){let t=e.model,s={scale:t.scale,offset:t.offset,width:t.width,height:t.height,rlonres:t.rlonres,rlatres:t.rlatres,i:t.i};this._workerQueue.forEach(n=>{let o=new Uint8Array(t.rawfile.length);o.set(t.rawfile),n.postMessage({model:s,rawfile:o},[o.buffer])})}else this._workerQueue.forEach(t=>{t.postMessage({model:null})})}make(e){if(e.initialized)if(this._workerQueue.length){let t=this._workerQueue.pop();this._source.set(this._sourceId,e);let s=e._projection.id===ks.id||e._projection.id===cn.id?1:0,n=new Float64Array([this._sourceId,s,e.planet.terrain.gridSizeByZoom[e.tileZoom],e.planet.terrain.plainGridSize,e._extent.southWest.lon,e._extent.southWest.lat,e._extent.northEast.lon,e._extent.northEast.lat,e.planet.ellipsoid._e2,e.planet.ellipsoid.equatorialSize,e.planet.ellipsoid._invRadii2.x,e.planet.ellipsoid._invRadii2.y,e.planet.ellipsoid._invRadii2.z,e.planet._heightFactor]);this._sourceId++,t.postMessage({params:n},[n.buffer])}else this._pendingQueue.push(e);else this.check()}}const Sa=`(function(){"use strict";function H(r,e){return function(z,b){let v=0,N=z.length-1;for(;v<=N;){let n=Math.floor(.5*(v+N));if(Math.abs(z[n]-b)<.001)return n;z[n]<b?v=n+1:N=n-1}return-1}(r,e)!==-1}var y=function(r,e,z){this.x=r,this.y=e,this.z=z},Y=function(r,e,z){let b=r.x,v=r.y,N=r.z;var n;b>=0?(n=65536*Math.floor(b/65536),e.x=Math.fround(n),z.x=Math.fround(b-n)):(n=65536*Math.floor(-b/65536),e.x=Math.fround(-n),z.x=Math.fround(b+n)),v>=0?(n=65536*Math.floor(v/65536),e.y=Math.fround(n),z.y=Math.fround(v-n)):(n=65536*Math.floor(-v/65536),e.y=Math.fround(-n),z.y=Math.fround(v+n)),N>=0?(n=65536*Math.floor(N/65536),e.z=Math.fround(n),z.z=Math.fround(N-n)):(n=65536*Math.floor(-N/65536),e.z=Math.fround(-n),z.z=Math.fround(N+n))};y.prototype.sub=function(r){return new y(this.x-r.x,this.y-r.y,this.z-r.z)},y.prototype.add=function(r){return new y(this.x+r.x,this.y+r.y,this.z+r.z)},y.prototype.cross=function(r){return new y(this.y*r.z-this.z*r.y,this.z*r.x-this.x*r.z,this.x*r.y-this.y*r.x)},y.prototype.normalize=function(r){var e=this.x,z=this.y,b=this.z,v=1/Math.sqrt(e*e+z*z+b*b);return this.x=e*v,this.y=z*v,this.z=b*v,this},y.prototype.distance=function(r){return this.sub(r).length()},y.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)};var x=new y(0,0,0),i=new y(0,0,0),t=new y(0,0,0);self.onmessage=function(r){var e=r.data.elevations,z=r.data.this_plainVertices,b=r.data.this_plainNormals,v=r.data.this_normalMapVertices,N=r.data.this_normalMapNormals,n=r.data.heightFactor,Dr=r.data.gridSize,D=r.data.noDataValues,Hr=r.data.id,Q=549755748352,W=-549755748352,T=549755748352,$=-549755748352,Z=549755748352,X=-549755748352;const J=Math.sqrt(e.length)-1,K=J+1,R=K*K,C=Dr,vr=J/C,L=C+1,tr=n;var a,d,p,m,yr,sr,S=0,xr=0,U=L*L*3,h=new Float64Array(U),j=new Float32Array(U),k=new Float32Array(U),lr=new Uint8Array(L*L),u=v,g=N;if(J>=C){a=new Float32Array(3*R),d=new Float64Array(3*R),p=new Float32Array(3*R),m=new Float32Array(3*R);for(let f=0;f<R;f++){var Ar=f%K,Fr=~~(f/K),ur=f,o=3*ur,rr=e[ur];H(D,rr)&&(rr=0);var Mr=tr*rr,s=new y(u[o]+Mr*g[o],u[o+1]+Mr*g[o+1],u[o+2]+Mr*g[o+2]);if(Y(s,i,t),d[o]=s.x,d[o+1]=s.y,d[o+2]=s.z,p[o]=i.x,p[o+1]=i.y,p[o+2]=i.z,m[o]=t.x,m[o+1]=t.y,m[o+2]=t.z,Fr%vr==0&&Ar%vr==0){let A=new y(u[o],u[o+1],u[o+2]),V=new y(u[o+3],u[o+4],u[o+5]),F=e[ur+1];H(D,F)&&(F=0);let q=!1;if(D.length===0){let _=A.distance(V);q=Math.abs(rr-F)/_>10||rr<-5e3}q?lr[xr]=1:(lr[xr]=0,s.x<Q&&(Q=s.x),s.x>W&&(W=s.x),s.y<T&&(T=s.y),s.y>$&&($=s.y),s.z<Z&&(Z=s.z),s.z>X&&(X=s.z)),j[S]=i.x,k[S]=t.x,h[S++]=s.x,j[S]=i.y,k[S]=t.y,h[S++]=s.y,j[S]=i.z,k[S]=t.z,h[S++]=s.z,xr++}if(Fr!==J&&Ar!==J){var gr=f+1,M=3*gr,B=e[gr];H(D,B)&&(B=0);var cr=tr*B,ar=new y(u[M]+cr*g[M],u[M+1]+cr*g[M+1],u[M+2]+cr*g[M+2]);Y(ar,i,t),d[M]=ar.x,d[M+1]=ar.y,d[M+2]=ar.z,p[M]=i.x,p[M+1]=i.y,p[M+2]=i.z,m[M]=t.x,m[M+1]=t.y,m[M+2]=t.z;var Vr=f+K,c=3*Vr;H(D,B=e[Vr])&&(B=0);var wr=tr*B,nr=new y(u[c]+wr*g[c],u[c+1]+wr*g[c+1],u[c+2]+wr*g[c+2]);Y(nr,i,t),d[c]=nr.x,d[c+1]=nr.y,d[c+2]=nr.z,p[c]=i.x,p[c+1]=i.y,p[c+2]=i.z,m[c]=t.x,m[c+1]=t.y,m[c+2]=t.z;var qr=f+K+1,w=3*qr;H(D,B=e[qr])&&(B=0);var dr=tr*B,er=new y(u[w]+dr*g[w],u[w+1]+dr*g[w+1],u[w+2]+dr*g[w+2]);Y(er,i,t),d[w]=er.x,d[w+1]=er.y,d[w+2]=er.z,p[w]=i.x,p[w+1]=i.y,p[w+2]=i.z,m[w]=t.x,m[w+1]=t.y,m[w+2]=t.z;var Lr=ar.sub(s),Sr=nr.sub(s),Nr=er.sub(s),hr=Sr.cross(Nr).normalize(),zr=Nr.cross(Lr).normalize(),O=zr.add(hr).normalize();a[o]+=O.x,a[o+1]+=O.y,a[o+2]+=O.z,a[M]+=zr.x,a[M+1]+=zr.y,a[M+2]+=zr.z,a[c]+=hr.x,a[c+1]+=hr.y,a[c+2]+=hr.z,a[w]+=O.x,a[w+1]+=O.y,a[w+2]+=O.z}}}else{a=new Float32Array(U),d=new Float64Array(U),p=new Float32Array(U),m=new Float32Array(U),a=new Float32Array(U);var E=C/J,_r=U/3,pr=J+1;for(let f=0;f<_r;f++){let A=Math.floor(f/L),V=f%L,F=A%E,q=V%E,_=Math.floor(A/E)*pr+Math.floor(V/E);V===C&&(_-=1,q=E),A===C&&(_-=pr,F=E);let mr=_+1,fr=_+pr,br=fr+1,or=e[_],ir=e[mr],P=e[fr],G=e[br];H(D,or)&&(or=0),H(D,ir)&&(ir=0),H(D,P)&&(P=0),H(D,G)&&(G=0);let I=or*(1-(yr=q/E))*(1-(sr=F/E))+ir*yr*(1-sr)+P*(1-yr)*sr+G*yr*sr,l=3*f;x.x=z[l]+I*b[l],x.y=z[l+1]+I*b[l+1],x.z=z[l+2]+I*b[l+2],Y(x,i,t),h[l]=x.x,h[l+1]=x.y,h[l+2]=x.z,j[l]=i.x,j[l+1]=i.y,j[l+2]=i.z,k[l]=t.x,k[l+1]=t.y,k[l+2]=t.z,x.x<Q&&(Q=x.x),x.x>W&&(W=x.x),x.y<T&&(T=x.y),x.y>$&&($=x.y),x.z<Z&&(Z=x.z),x.z>X&&(X=x.z)}d.set(h),p.set(j),m.set(k);for(let f=0;f<_r;f++)if(~~(f/L)!==C&&f%L!==C){let A=3*f,V=A+3,F=A+3*L,q=F+3,_=new y(h[A],h[A+1],h[A+2]),mr=new y(h[V],h[V+1],h[V+2]),fr=new y(h[F],h[F+1],h[F+2]),br=new y(h[q],h[q+1],h[q+2]),or=mr.sub(_).normalize(),ir=fr.sub(_).normalize(),P=br.sub(_).normalize(),G=ir.cross(P).normalize(),I=P.cross(or).normalize(),l=I.add(G).normalize();a[A]+=l.x,a[A+1]+=l.y,a[A+2]+=l.z,a[V]+=I.x,a[V+1]+=I.y,a[V+2]+=I.z,a[F]+=G.x,a[F+1]+=G.y,a[F+2]+=G.z,a[q]+=l.x,a[q+1]+=l.y,a[q+2]+=l.z}}self.postMessage({id:Hr,normalMapNormals:a,normalMapVertices:d,normalMapVerticesHigh:p,normalMapVerticesLow:m,terrainVertices:h,terrainVerticesHigh:j,terrainVerticesLow:k,noDataVertices:lr,bounds:[Q,T,Z,W,$,X]},[a.buffer,d.buffer,p.buffer,m.buffer,h.buffer,j.buffer,k.buffer,lr.buffer])}})();
//# sourceMappingURL=TerrainWorker.worker-DmikdfB2.js.map
`,lo=typeof self<"u"&&self.Blob&&new Blob([Sa],{type:"text/javascript;charset=utf-8"});function Jh(l){let e;try{if(e=lo&&(self.URL||self.webkitURL).createObjectURL(lo),!e)throw"";const t=new Worker(e,{name:l==null?void 0:l.name});return t.addEventListener("error",()=>{(self.URL||self.webkitURL).revokeObjectURL(e)}),t}catch{return new Worker("data:text/javascript;charset=utf-8,"+encodeURIComponent(Sa),{name:l==null?void 0:l.name})}finally{e&&(self.URL||self.webkitURL).revokeObjectURL(e)}}class tc extends Qr{constructor(e=2){super(e,Jh)}_onMessage(e){this._source.get(e.data.id).segment._terrainWorkerCallback(e.data),this._source.delete(e.data.id),e.data.normalMapNormals=null,e.data.normalMapVertices=null,e.data.normalMapVerticesHigh=null,e.data.normalMapVerticesLow=null,e.data.terrainVertices=null,e.data.terrainVerticesHigh=null,e.data.terrainVerticesLow=null}make(e){if(e.segment.plainReady&&e.segment.terrainIsLoading)if(this._workerQueue.length){const t=this._workerQueue.pop();this._source.set(this._sourceId,e);let s=e.segment;t.postMessage({elevations:e.elevations,this_plainVertices:s.plainVertices,this_plainNormals:s.plainNormals,this_normalMapVertices:s.normalMapVertices,this_normalMapNormals:s.normalMapNormals,heightFactor:s.planet._heightFactor,gridSize:s.planet.terrain.gridSizeByZoom[s.tileZoom],noDataValues:s.planet.terrain.noDataValues,id:this._sourceId},[e.elevations.buffer,s.plainVertices.buffer,s.plainNormals.buffer,s.normalMapVertices.buffer,s.normalMapNormals.buffer]),this._sourceId++}else this._pendingQueue.push(e);else this.check()}}let Oe=new Float32Array(2);class ec{constructor(e,t=256,s=256){this._width=t,this._height=s,this._planet=e,this._framebuffer=null,this._queue=[],this._handler=null}init(){this._handler=this._planet.renderer.handler,this._handler.programs.vectorTileLineRasterization||this._handler.addProgram(new $("vectorTileLineRasterization",{uniforms:{viewport:"vec2",thicknessOutline:"float",alpha:"float",extentParamsHigh:"vec4",extentParamsLow:"vec4"},attributes:{prevHigh:"vec2",currentHigh:"vec2",nextHigh:"vec2",prevLow:"vec2",currentLow:"vec2",nextLow:"vec2",order:"float",color:"vec4",thickness:"float"},vertexShader:`attribute vec2 prevHigh;
                attribute vec2 currentHigh;
                attribute vec2 nextHigh;

                attribute vec2 prevLow;
                attribute vec2 currentLow;
                attribute vec2 nextLow;

                attribute float order;
                attribute float thickness;
                attribute vec4 color;
                uniform float thicknessOutline;
                uniform vec2 viewport;
                uniform vec4 extentParamsHigh;
                uniform vec4 extentParamsLow;
                varying vec4 vColor;
                
                vec2 proj(vec2 coordHigh, vec2 coordLow) {
                    vec2 highDiff = coordHigh - extentParamsHigh.xy;
                    vec2 lowDiff = coordLow - extentParamsLow.xy;                    
                    return vec2(-1.0 + (highDiff * step(1.0, length(highDiff)) + lowDiff) * extentParamsHigh.zw) * vec2(1.0, -1.0);
                }
                
                void main(){
                    vColor = color;

                    vec2 vNext = proj(nextHigh, nextLow),
                         vCurrent = proj(currentHigh, currentLow),
                         vPrev = proj(prevHigh, prevLow);

                    vec2 _next = vNext;
                    vec2 _prev = vPrev;
                    vec2 _current = vCurrent;

                    if(_prev == _current){
                        if(_next == _current){
                            _next = _current + vec2(1.0, 0.0);
                            _prev = _current - _next;
                        }else{
                            _prev = _current + normalize(_current - _next);
                        }
                    }

                    if(_next == _current){
                        _next = _current + normalize(_current - _prev);
                    }

                    vec2 sNext = _next;
                    vec2 sCurrent = _current;
                    vec2 sPrev = _prev;
                    
                    vec2 dirNext = normalize(sNext - sCurrent);
                    vec2 dirPrev = normalize(sPrev - sCurrent);
                    float dotNP = dot(dirNext, dirPrev);
                    
                    vec2 normalNext = normalize(vec2(-dirNext.y, dirNext.x));
                    vec2 normalPrev = normalize(vec2(dirPrev.y, -dirPrev.x));
                    vec2 d = (thickness + thicknessOutline) * 0.5 * sign(order) / viewport;
                    
                    vec2 m;
                    if(dotNP >= 0.99991){
                        m = sCurrent - normalPrev * d;
                    }else{
                        vec2 dir = normalPrev + normalNext;
                        m = sCurrent + dir * d / (dirNext.x * dir.y - dirNext.y * dir.x);
                        
                        if( dotNP > 0.5 && dot(dirNext + dirPrev, m - sCurrent) < 0.0 ){
                            float occw = order * sign(dirNext.x * dirPrev.y - dirNext.y * dirPrev.x);
                            if(occw == -1.0){
                                m = sCurrent + normalPrev * d;
                            }else if(occw == 1.0){
                                m = sCurrent + normalNext * d;
                            }else if(occw == -2.0){
                                m = sCurrent + normalNext * d;
                            }else if(occw == 2.0){
                                m = sCurrent + normalPrev * d;
                            }
                        }else if(distance(sCurrent, m) > min(distance(sCurrent, sNext), distance(sCurrent, sPrev))){
                            m = sCurrent + normalNext * d;
                        }
                    }
                    gl_Position = vec4(m.x, m.y, 0.0, 1.0);
                }`,fragmentShader:`precision highp float;
                uniform float alpha;
                varying vec4 vColor;
                void main() {
                    gl_FragColor = vec4(vColor.rgb, alpha * vColor.a);
                }`})),this._handler.programs.vectorTilePolygonRasterization||this._handler.addProgram(new $("vectorTilePolygonRasterization",{uniforms:{extentParamsHigh:"vec4",extentParamsLow:"vec4"},attributes:{coordinatesHigh:"vec2",coordinatesLow:"vec2",colors:"vec4"},vertexShader:`attribute vec2 coordinatesHigh;
                attribute vec2 coordinatesLow; 
                attribute vec4 colors; 
                uniform vec4 extentParamsHigh; 
                uniform vec4 extentParamsLow; 
                varying vec4 color;

                vec2 proj(vec2 coordHigh, vec2 coordLow) {
                    vec2 highDiff = coordHigh - extentParamsHigh.xy;
                    vec2 lowDiff = coordLow - extentParamsLow.xy;
                    return vec2(-1.0 + (highDiff * step(1.0, length(highDiff)) + lowDiff) * extentParamsHigh.zw) * vec2(1.0, -1.0);
                }

                void main() { 
                    color = colors;
                    gl_Position = vec4(proj(coordinatesHigh, coordinatesLow), 0.0, 1.0); 
                }`,fragmentShader:`precision highp float;
                varying vec4 color;
                void main () {  
                    gl_FragColor = color; 
                }`})),this._framebuffer=new St(this._handler,{width:this._width,height:this._height,useDepth:!1}),this._framebuffer.init()}frame(){if(this._planet.layerLock.isFree()&&this._queue.length){let e=this._handler,t=e.gl;t.disable(t.CULL_FACE),t.disable(t.DEPTH_TEST);let s=e.programs.vectorTileLineRasterization,n=e.programs.vectorTilePolygonRasterization,o=this._width,a=this._height,h=o,c=a,d=h<<1,u=c<<1,_=new Float32Array(4),f=new Float32Array(4),v=this._framebuffer.activate(),g=0,y=window.performance.now();for(;this._queue.length&&g<25;){let p=this._queue.shift();if(p.isLoading&&p.segment.node.getState()===1){let x=p.layer._pickingEnabled;p.segment.tileZoom<4?(h=d,c=u):(h=o,c=a);let T=p._updateTexture||e.createEmptyTexture_l(h,c),w=x?p._updatePickingMask||e.createEmptyTexture_n(h,c):null;p.applyTexture(T,w),v.setSize(h,c),v.bindOutputTexture(T),t.clearColor(0,0,0,0),t.clear(t.COLOR_BUFFER_BIT);let C=p.segment.getExtentMerc();oe(C.southWest.lon,Oe),_[0]=Oe[0],f[0]=Oe[1],oe(C.southWest.lat,Oe),_[1]=Oe[0],f[1]=Oe[1],_[2]=2/C.getWidth(),_[3]=2/C.getHeight(),n.activate();let E=n._program,L=E.attributes,S=E.uniforms,P=p.layer._geometryHandler;t.uniform4fv(S.extentParamsHigh,_),t.uniform4fv(S.extentParamsLow,f),t.bindBuffer(t.ARRAY_BUFFER,P._polyVerticesHighBufferMerc),t.vertexAttribPointer(L.coordinatesHigh,P._polyVerticesHighBufferMerc.itemSize,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,P._polyVerticesLowBufferMerc),t.vertexAttribPointer(L.coordinatesLow,P._polyVerticesLowBufferMerc.itemSize,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,P._polyColorsBuffer),t.vertexAttribPointer(L.colors,P._polyColorsBuffer.itemSize,t.FLOAT,!1,0,0),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,P._polyIndexesBuffer),t.drawElements(t.TRIANGLES,P._polyIndexesBuffer.numItems,t.UNSIGNED_INT,0),x&&(v.bindOutputTexture(w),t.clearColor(0,0,0,0),t.clear(t.COLOR_BUFFER_BIT),t.bindBuffer(t.ARRAY_BUFFER,P._polyPickingColorsBuffer),t.vertexAttribPointer(L.colors,P._polyPickingColorsBuffer.itemSize,t.FLOAT,!1,0,0),t.drawElements(t.TRIANGLES,P._polyIndexesBuffer.numItems,t.UNSIGNED_INT,0)),v.bindOutputTexture(T),s.activate(),E=s._program,L=E.attributes,S=E.uniforms,t.uniform2fv(S.viewport,[h,c]),t.uniform4fv(S.extentParamsHigh,_),t.uniform4fv(S.extentParamsLow,f);let R=P._lineVerticesHighBufferMerc;t.bindBuffer(t.ARRAY_BUFFER,R),t.vertexAttribPointer(L.prevHigh,R.itemSize,t.FLOAT,!1,8,0),t.vertexAttribPointer(L.currentHigh,R.itemSize,t.FLOAT,!1,8,32),t.vertexAttribPointer(L.nextHigh,R.itemSize,t.FLOAT,!1,8,64),R=P._lineVerticesLowBufferMerc,t.bindBuffer(t.ARRAY_BUFFER,R),t.vertexAttribPointer(L.prevLow,R.itemSize,t.FLOAT,!1,8,0),t.vertexAttribPointer(L.currentLow,R.itemSize,t.FLOAT,!1,8,32),t.vertexAttribPointer(L.nextLow,R.itemSize,t.FLOAT,!1,8,64),t.bindBuffer(t.ARRAY_BUFFER,P._lineOrdersBuffer),t.vertexAttribPointer(L.order,P._lineOrdersBuffer.itemSize,t.FLOAT,!1,4,0),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,P._lineIndexesBuffer),t.bindBuffer(t.ARRAY_BUFFER,P._lineStrokesBuffer),t.vertexAttribPointer(L.thickness,P._lineStrokesBuffer.itemSize,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,P._lineStrokeColorsBuffer),t.vertexAttribPointer(L.color,P._lineStrokeColorsBuffer.itemSize,t.FLOAT,!1,0,0),t.uniform1f(S.thicknessOutline,2),t.uniform1f(S.alpha,.54),t.drawElements(t.TRIANGLE_STRIP,P._lineIndexesBuffer.numItems,t.UNSIGNED_INT,0),t.uniform1f(S.thicknessOutline,1),t.uniform1f(S.alpha,1),t.drawElements(t.TRIANGLE_STRIP,P._lineIndexesBuffer.numItems,t.UNSIGNED_INT,0),t.bindBuffer(t.ARRAY_BUFFER,P._lineThicknessBuffer),t.vertexAttribPointer(L.thickness,P._lineThicknessBuffer.itemSize,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,P._lineColorsBuffer),t.vertexAttribPointer(L.color,P._lineColorsBuffer.itemSize,t.FLOAT,!1,0,0),t.uniform1f(S.thicknessOutline,2),t.uniform1f(S.alpha,.54),t.drawElements(t.TRIANGLE_STRIP,P._lineIndexesBuffer.numItems,t.UNSIGNED_INT,0),t.uniform1f(S.thicknessOutline,1),t.uniform1f(S.alpha,1),t.drawElements(t.TRIANGLE_STRIP,P._lineIndexesBuffer.numItems,t.UNSIGNED_INT,0),x&&(v.bindOutputTexture(w),t.uniform1f(S.thicknessOutline,8),t.bindBuffer(t.ARRAY_BUFFER,P._linePickingColorsBuffer),t.vertexAttribPointer(L.color,P._linePickingColorsBuffer.itemSize,t.FLOAT,!1,0,0),t.drawElements(t.TRIANGLE_STRIP,P._lineIndexesBuffer.numItems,t.UNSIGNED_INT,0))}else p.isLoading=!1;g=window.performance.now()-y}t.enable(t.DEPTH_TEST),t.enable(t.CULL_FACE),v.deactivate()}}add(e){this._queue.push(e)}remove(e){}get queueSize(){return this._queue.length}}class Si extends ce{constructor(e={}){super(e.name),this._minDistanceBeforeMemClear=0,this._renderingFadingNodes=(h,c,d,u,_,f,v,g)=>{let y=f===0,p=this.terrain.equalizeVertices;for(let x=0,T=u._fadingNodes.length;x<T;x++){let w=u._fadingNodes[x].segment;h._fadingNodes.has(u._fadingNodes[0].__id)&&!c.has(w.node.__id)&&(c.set(w.node.__id,!0),w._transitionOpacity<1?v.push(w):y?(p&&w.equalize(),w.readyToEngage&&w.engage(),w.screenRendering(d,_,f),g.push(w)):w.screenRendering(d,_,f,this.transparentTexture,!0))}},this._renderingFadingNodesNoDepth=(h,c,d,u,_,f,v)=>{let g=f===0,y=this.terrain.equalizeVertices,p=d.gl;p.disable(p.DEPTH_TEST);for(let x=0,T=u._fadingNodes.length;x<T;x++){let w=u._fadingNodes[x].segment;h._fadingNodes.has(u._fadingNodes[0].__id)&&!c.has(w.node.__id)&&(c.set(w.node.__id,!0),g?(y&&w.equalize(),w.readyToEngage&&w.engage(),w.screenRendering(d,_,f),v.push(w)):w.screenRendering(d,_,f,this.transparentTexture,!0))}p.enable(p.DEPTH_TEST)},this._createdNodesCount=0,this._atmosphere=new Hh(e.atmosphereParameters),this.transitionTime=580,this.ellipsoid=e.ellipsoid||Ao,this.lightEnabled=!0,this._planetRadius2=(this.ellipsoid.getPolarSize()-1e4)*(this.ellipsoid.getPolarSize()-1e4),this._layers=[],this._updateLayers=!1,this.visibleTileLayers=[],this.visibleVectorLayers=[],this._visibleVectorLayersByDepthOrder=[],this._visibleTileLayerSlices=[],this._visibleEntityCollections=[[]],this.baseLayer=null,this.terrain=null,this.camera=new xa(this,{frustums:e.frustums,eye:new m(25e6,0,0),look:m.ZERO,up:m.NORTH,minAltitude:e.minAltitude,maxAltitude:e.maxAltitude}),this.mousePositionOnEarth=new m,this.emptyTexture=null,this.transparentTexture=null,this.defaultTexture=null,this._initialViewExtent=null,this.layerLock=new Br,this.terrainLock=new Br,this._heightFactor=1,this._indexesCache=[],this._indexesCacheToRemove=[],this._indexesCacheToRemoveCounter=0,this._textureCoordsBufferCache=[];const t={planet:this,maxEqualZoomAltitude:e.maxEqualZoomAltitude,minEqualZoomAltitude:e.minEqualZoomAltitude,minEqualZoomCameraSlope:e.minEqualZoomCameraSlope,transitionOpacityEnabled:e.transitionOpacityEnabled};this.quadTreeStrategyPrototype=e.quadTreeStrategyPrototype||Ea,this.quadTreeStrategy=new this.quadTreeStrategyPrototype(t),this._nightTexture=null,this._specularTexture=null;let s=Gt(e.ambient,new m(.2,.2,.3)),n=Gt(e.diffuse,new m(1,1,1)),o=Gt(e.specular,new m(63e-5,55e-5,32e-5)),a=e.shininess||18;this._ambient=new Float32Array([s.x,s.y,s.z]),this._diffuse=new Float32Array([n.x,n.y,n.z]),this._specular=new Float32Array([o.x,o.y,o.z,a]),this._maxGridSize=Math.log2(e.maxGridSize||256),this.SLICE_SIZE=4,this.SLICE_SIZE_4=4*this.SLICE_SIZE,this.SLICE_SIZE_3=3*this.SLICE_SIZE,this._maxNodes=e.maxNodesCount||200,this._pickingColorArr=new Float32Array(this.SLICE_SIZE_4),this._samplerArr=new Int32Array(this.SLICE_SIZE),this._pickingMaskArr=new Int32Array(this.SLICE_SIZE),this._geoImageCreator=new $h(this),this._vectorTileCreator=new ec(this,e.vectorTileSize,e.vectorTileSize),this._normalMapCreator=new Zh(this),this._terrainWorker=new tc(3),this._plainSegmentWorker=new Qh(3),this._tileLoader=new La(e.maxLoadingRequests||12),this._memKey=new Re,this.events=ot(ic),this._distBeforeMemClear=0,this._prevCamEye=new m,this._initialized=!1,this._collectRenderNodesIsActive=!0,this.nightTextureCoefficient=2,this._renderScreenNodesPASS=this._renderScreenNodesPASSNoAtmos,this._renderScreenNodesWithHeightPASS=this._renderScreenNodesWithHeightPASSNoAtmos,this._atmosphereEnabled=e.atmosphereEnabled||!1,this._atmosphereMaxMinOpacity=new Float32Array([.95,.28]),this.solidTextureOne=null,this.solidTextureTwo=null,this._nightTextureSrc=e.nightTextureSrc||null,this._specularTextureSrc=e.specularTextureSrc||null,this._transparentBackground=e.transparentBackground||!1}get terrainReady(){return this.quadTreeStrategy.terrainReady}get maxGridSize(){return this._maxGridSize}getNorthFrameRotation(e){return this.getFrameRotation(e)}getFrameRotation(e){return this.ellipsoid.getNorthFrameRotation(e)}set atmosphereMaxOpacity(e){this._atmosphereMaxMinOpacity[0]=e}get atmosphereMaxOpacity(){return this._atmosphereMaxMinOpacity[0]}set atmosphereMinOpacity(e){this._atmosphereMaxMinOpacity[1]=e}get atmosphereMinOpacity(){return this._atmosphereMaxMinOpacity[1]}set atmosphereEnabled(e){e!=this._atmosphereEnabled&&(this._atmosphereEnabled=e,this._initializeAtmosphere())}get atmosphereEnabled(){return this._atmosphereEnabled}set diffuse(e){let t=Gt(e);this._diffuse=new Float32Array(t.toArray())}set ambient(e){let t=Gt(e);this._ambient=new Float32Array(t.toArray())}set specular(e){let t=Gt(e);this._specular=new Float32Array([t.x,t.y,t.y,this._specular[3]])}set shininess(e){this._specular[3]=e}get normalMapCreator(){return this._normalMapCreator}get layers(){return[...this._layers]}get sun(){if(this.renderer&&this.renderer.controls.sun)return this.renderer.controls.sun}get sunPos(){return this.sun.sunlight.getPosition()}addControl(e){e.planet=this,e.addTo(this.renderer)}addControls(e){for(let t=0;t<e.length;t++)this.addControl(e[t])}getLayerByName(e){for(let t=0,s=this._layers.length;t<s;t++)if(e===this._layers[t].name)return this._layers[t]}addLayer(e){e.addTo(this)}_onLayerVisibilityChanged(e){this.events.dispatch(this.events.layervisibilitychange,e)}addLayers(e){for(let t=0,s=e.length;t<s;t++)this.addLayer(e[t])}removeLayer(e){e.remove()}_clearLayerMaterial(e){this.quadTreeStrategy.clearLayerMaterial(e)}setBaseLayer(e){this.baseLayer?this.baseLayer.isEqual(e)||(this.baseLayer.setVisibility(!1),this.baseLayer=e,e.setVisibility(!0),this.events.dispatch(this.events.baselayerchange,e)):(this.baseLayer=e,this.baseLayer.setVisibility(!0),this.events.dispatch(this.events.baselayerchange,e))}setHeightFactor(e){this._heightFactor!==e&&(this._heightFactor=e,this.quadTreeStrategy.destroyBranches(),this.quadTreeStrategy.clearRenderedNodes())}getHeightFactor(){return this._heightFactor}setTerrain(e){this._initialized&&this.memClear(),this.terrain&&(this.terrain.abortLoading(),this.terrain.clearCache(),this.terrain._planet=null),this.terrain=e,this.terrain._planet=this,this.quadTreeStrategy.destroyBranches(),e._geoid.model?(this._plainSegmentWorker.setGeoid(e.getGeoid()),e._isReady=!0):Aa.loadModel(e.geoid.src).then(t=>{e.geoid.setModel(t),this._plainSegmentWorker.setGeoid(e.getGeoid()),e._isReady=!0}).catch(t=>{console.warn(t)})}initAtmosphereShader(e){if(this.renderer&&this.renderer.handler&&this._atmosphereEnabled){let t=this.renderer.handler;t.isWebGl2()?(t.removeProgram("drawnode_screen_wl"),t.addProgram(no(e))):console.warn("Atmosphere WebGL2 only")}}get atmosphereControl(){return this._atmosphere}_initializeAtmosphere(){if(!this.renderer)return;let e=this.renderer.handler;e.removeProgram("drawnode_screen_wl"),this._atmosphereEnabled?(this._renderScreenNodesPASS=this._renderScreenNodesPASSAtmos,this._renderScreenNodesWithHeightPASS=this._renderScreenNodesWithHeightPASSAtmos,this.renderer.controls.Atmosphere||this.addControl(this._atmosphere),this._atmosphere.activate(),e.isWebGl2()?e.addProgram(no(this._atmosphere.parameters)):e.addProgram(ro()),this._transparentBackground||this.renderer.controls.SimpleSkyBackground&&this.renderer.controls.SimpleSkyBackground.deactivate()):(this._renderScreenNodesPASS=this._renderScreenNodesPASSNoAtmos,this._renderScreenNodesWithHeightPASS=this._renderScreenNodesWithHeightPASSNoAtmos,this._atmosphere.deactivate(),this._transparentBackground||(this.renderer.controls.SimpleSkyBackground?this.renderer.controls.SimpleSkyBackground.activate():this.addControl(new _a)),e.isWebGl2()?e.addProgram(new $("drawnode_screen_wl",{uniforms:{projectionMatrix:"mat4",viewMatrix:"mat4",eyePositionHigh:"vec3",eyePositionLow:"vec3",height:"float",uGlobalTextureCoord:"vec4",uNormalMapBias:"vec3",samplerCount:"int",tileOffsetArr:"vec4",layerOpacityArr:"float",samplerArr:"sampler2darray",defaultTexture:"sampler2d",uNormalMap:"sampler2d",nightTexture:"sampler2d",specularTexture:"sampler2d",lightPosition:"vec3",diffuse:"vec3",ambient:"vec3",specular:"vec4",camHeight:"float",nightTextureCoefficient:"float",transitionOpacity:"float"},attributes:{aVertexPositionHigh:"vec3",aVertexPositionLow:"vec3",aTextureCoord:"vec2"},vertexShader:`#version 300 es
precision highp float;in vec3 aVertexPositionHigh;in vec3 aVertexPositionLow;in vec2 aTextureCoord;uniform mat4 projectionMatrix;uniform mat4 viewMatrix;uniform vec4 uGlobalTextureCoord;uniform vec3 uNormalMapBias;uniform vec3 eyePositionHigh;uniform vec3 eyePositionLow;uniform float height;out vec4 vTextureCoord;out vec3 v_vertex;out vec3 cameraPosition;out vec2 vGlobalTextureCoord;out float v_height;void main(void){vec3 aVertexPosition=aVertexPositionHigh+aVertexPositionLow;vec3 nh=height*normalize(aVertexPosition);vTextureCoord.xy=aTextureCoord;vGlobalTextureCoord=uGlobalTextureCoord.xy+(uGlobalTextureCoord.zw-uGlobalTextureCoord.xy)*aTextureCoord;vTextureCoord.zw=uNormalMapBias.z*(aTextureCoord+uNormalMapBias.xy);cameraPosition=eyePositionHigh+eyePositionLow;vec3 highDiff=aVertexPositionHigh-eyePositionHigh;vec3 lowDiff=aVertexPositionLow-eyePositionLow+nh;mat4 viewMatrixRTE=viewMatrix;viewMatrixRTE[3]=vec4(0.0,0.0,0.0,1.0);v_height=height;v_vertex=aVertexPosition+nh;gl_Position=projectionMatrix*viewMatrixRTE*vec4(highDiff*step(1.0,length(highDiff))+lowDiff,1.0);}`,fragmentShader:`#version 300 es
precision highp float;float getLerpValue(in float min,in float max,in float between){return(clamp(between,min,max)-min)/(max-min);}vec3 aces(vec3 color){float a=2.51;float b=0.03;float c=2.43;float d=0.59;float e=0.14;return clamp((color*(a*color+b))/(color*(c*color+d)+e),0.0,1.0);}bool intersectSphere(vec3 rayOrigin,vec3 rayDirection,float radius,inout float t1,inout float t2){float b=dot(rayDirection,rayOrigin);float c=dot(rayOrigin,rayOrigin)-radius*radius;float d=b*b-c;if(d<0.0){return false;}t1=-b-sqrt(d);t2=-b+sqrt(d);return true;}bool intersectSphere(vec3 rayOrigin,vec3 rayDirection,float radius,inout float t){float b=dot(rayDirection,rayOrigin);float c=dot(rayOrigin,rayOrigin)-radius*radius;float d=b*b-c;if(d<0.0){return false;}t=-b-sqrt(d);return true;}float intersectSphere(vec3 ro,vec3 rd,vec4 sph){vec3 oc=ro-sph.xyz;float b=dot(oc,rd);float c=dot(oc,oc)-sph.w*sph.w;float h=b*b-c;if(h<0.0)return-1.0;h=sqrt(h);return-b-h;}bool intersectEllipsoid(in vec3 ro,in vec3 rd,in vec3 ra,inout float t){vec3 ocn=ro/ra;vec3 rdn=rd/ra;float a=dot(rdn,rdn);float b=dot(ocn,rdn);float c=dot(ocn,ocn);float h=b*b-a*(c-1.0);if(h<0.0){return false;}t=(-b-sqrt(h))/a;return true;}bool intersectEllipsoid(in vec3 ro,in vec3 rd,in vec3 ra,inout float t1,inout float t2){vec3 ocn=ro/ra;vec3 rdn=rd/ra;float a=dot(rdn,rdn);float b=dot(ocn,rdn);float c=dot(ocn,ocn);float h=b*b-a*(c-1.0);if(h<0.0){return false;}h=sqrt(h);t1=(-b-h)/a;t2=(-b+h)/a;return true;}vec3 normalEllipsoid(in vec3 pos,in vec3 ra){return normalize(pos/(ra*ra));}
#ifdef WEBGL2
#define TEXTURE_FUNC texture
#else
#define TEXTURE_FUNC texture2D
#endif
#define SLICE_SIZE 5
#define blend(DEST, SAMPLER, OFFSET, OPACITY) src = TEXTURE_FUNC(SAMPLER, OFFSET.xy + vTextureCoord.xy * OFFSET.zw); DEST = DEST * (1.0 - src.a * OPACITY) + src * OPACITY;
#define blendPicking(DEST, OFFSET, SAMPLER, MASK, COLOR, OPACITY) tc = OFFSET.xy + vTextureCoord.xy * OFFSET.zw; t = TEXTURE_FUNC(SAMPLER, tc); p = TEXTURE_FUNC(MASK, tc); DEST = mix(DEST, vec4(max(COLOR.rgb, p.rgb), OPACITY), (t.a == 0.0 ? 0.0: 1.0) * COLOR.a);
const vec3 nightStep=10.0*vec3(0.58,0.48,0.25);uniform vec4 specular;uniform vec3 diffuse;uniform vec3 ambient;uniform sampler2D uNormalMap;uniform sampler2D nightTexture;uniform sampler2D specularTexture;uniform sampler2D defaultTexture;uniform sampler2D samplerArr[SLICE_SIZE];uniform vec4 tileOffsetArr[SLICE_SIZE];uniform vec3 lightPosition;uniform float layerOpacityArr[SLICE_SIZE];uniform int samplerCount;uniform float nightTextureCoefficient;uniform float transitionOpacity;uniform float camHeight;in vec4 vTextureCoord;in vec3 v_vertex;in vec3 cameraPosition;in vec2 vGlobalTextureCoord;in float v_height;vec3 sunPos;layout(location=0)out vec4 diffuseColor;void main(void){sunPos=lightPosition;vec3 texNormal=texture(uNormalMap,vTextureCoord.zw).rgb;vec3 normal=normalize((texNormal-0.5)*2.0);float minH=1200000.0;float maxH=minH*3.0;float nightCoef=getLerpValue(minH,maxH,camHeight)*nightTextureCoefficient;vec3 lightDir=normalize(sunPos);vec3 viewDir=normalize(cameraPosition-v_vertex);float overGround=1.0-step(0.1,v_height);float shininess=texture(specularTexture,vGlobalTextureCoord.st).r*255.0*overGround;vec3 reflectionDirection=reflect(-lightDir,normal);float reflection=max(dot(reflectionDirection,viewDir),0.0);vec3 spec=specular.rgb*pow(reflection,specular.w)*shininess;float diffuseLightWeighting=max(dot(normal,lightDir),0.0);vec4 nightImageColor=texture(nightTexture,vGlobalTextureCoord.st);vec3 night=nightStep*(.18-diffuseLightWeighting*3.0)*nightImageColor.rgb*nightCoef;night*=overGround*step(0.0,night);vec4 lightWeighting=vec4(ambient+diffuse*diffuseLightWeighting+night,1.0);diffuseColor=texture(defaultTexture,vTextureCoord.xy);if(samplerCount==0){diffuseColor=diffuseColor*lightWeighting+vec4(spec,0.0);diffuseColor*=transitionOpacity;return;}vec4 src;blend(diffuseColor,samplerArr[0],tileOffsetArr[0],layerOpacityArr[0]);if(samplerCount==1){diffuseColor=diffuseColor*lightWeighting+vec4(spec,0.0);diffuseColor*=transitionOpacity;return;}blend(diffuseColor,samplerArr[1],tileOffsetArr[1],layerOpacityArr[1]);if(samplerCount==2){diffuseColor=diffuseColor*lightWeighting+vec4(spec,0.0);diffuseColor*=transitionOpacity;return;}blend(diffuseColor,samplerArr[2],tileOffsetArr[2],layerOpacityArr[2]);if(samplerCount==3){diffuseColor=diffuseColor*lightWeighting+vec4(spec,0.0);diffuseColor*=transitionOpacity;return;}blend(diffuseColor,samplerArr[3],tileOffsetArr[3],layerOpacityArr[3]);if(samplerCount==4){diffuseColor=diffuseColor*lightWeighting+vec4(spec,0.0);diffuseColor*=transitionOpacity;return;}blend(diffuseColor,samplerArr[4],tileOffsetArr[4],layerOpacityArr[4]);diffuseColor=diffuseColor*lightWeighting+vec4(spec,0.0);diffuseColor*=transitionOpacity;}`})):e.addProgram(ro()))}_initializeShaders(){if(!this.renderer)throw new Error("Renderer is not initialized");let e=this.renderer,t=e.handler;t.addProgram(new $("drawnode_screen_nl",{uniforms:{projectionMatrix:"mat4",viewMatrix:"mat4",eyePositionHigh:"vec3",eyePositionLow:"vec3",samplerCount:"int",tileOffsetArr:"vec4",layerOpacityArr:"float",samplerArr:"sampler2darray",defaultTexture:"sampler2d",height:"float"},attributes:{aVertexPositionHigh:"vec3",aVertexPositionLow:"vec3",aTextureCoord:"vec2"},vertexShader:"precision highp float;attribute vec3 aVertexPositionHigh;attribute vec3 aVertexPositionLow;attribute vec2 aTextureCoord;uniform mat4 projectionMatrix;uniform mat4 viewMatrix;uniform vec3 eyePositionHigh;uniform vec3 eyePositionLow;uniform float height;varying vec2 vTextureCoord;void main(void){vTextureCoord=aTextureCoord;vec3 nh=height*normalize(aVertexPositionHigh+aVertexPositionLow);mat4 viewMatrixRTE=viewMatrix;viewMatrixRTE[3]=vec4(0.0,0.0,0.0,1.0);mat4 m=projectionMatrix*viewMatrixRTE;vec3 highDiff=aVertexPositionHigh-eyePositionHigh;vec3 lowDiff=aVertexPositionLow-eyePositionLow+nh;gl_Position=m*vec4(highDiff*step(1.0,length(highDiff))+lowDiff,1.0);}",fragmentShader:`precision highp float;
#ifdef WEBGL2
#define TEXTURE_FUNC texture
#else
#define TEXTURE_FUNC texture2D
#endif
#define SLICE_SIZE 5
#define blend(DEST, SAMPLER, OFFSET, OPACITY) src = TEXTURE_FUNC(SAMPLER, OFFSET.xy + vTextureCoord.xy * OFFSET.zw); DEST = DEST * (1.0 - src.a * OPACITY) + src * OPACITY;
#define blendPicking(DEST, OFFSET, SAMPLER, MASK, COLOR, OPACITY) tc = OFFSET.xy + vTextureCoord.xy * OFFSET.zw; t = TEXTURE_FUNC(SAMPLER, tc); p = TEXTURE_FUNC(MASK, tc); DEST = mix(DEST, vec4(max(COLOR.rgb, p.rgb), OPACITY), (t.a == 0.0 ? 0.0: 1.0) * COLOR.a);
const vec3 nightStep=10.0*vec3(0.58,0.48,0.25);uniform vec4 tileOffsetArr[SLICE_SIZE];uniform float layerOpacityArr[SLICE_SIZE];uniform sampler2D defaultTexture;uniform sampler2D samplerArr[SLICE_SIZE];uniform int samplerCount;varying vec2 vTextureCoord;void main(void){gl_FragColor=texture2D(defaultTexture,vTextureCoord);if(samplerCount==0)return;vec4 src;blend(gl_FragColor,samplerArr[0],tileOffsetArr[0],layerOpacityArr[0]);if(samplerCount==1)return;blend(gl_FragColor,samplerArr[1],tileOffsetArr[1],layerOpacityArr[1]);if(samplerCount==2)return;blend(gl_FragColor,samplerArr[2],tileOffsetArr[2],layerOpacityArr[2]);if(samplerCount==3)return;blend(gl_FragColor,samplerArr[3],tileOffsetArr[3],layerOpacityArr[3]);if(samplerCount==4)return;blend(gl_FragColor,samplerArr[4],tileOffsetArr[4],layerOpacityArr[4]);}`})),t.addProgram(new $("drawnode_colorPicking",{uniforms:{projectionMatrix:"mat4",viewMatrix:"mat4",eyePositionHigh:"vec3",eyePositionLow:"vec3",samplerCount:"int",tileOffsetArr:"vec4",samplerArr:"sampler2darray",pickingMaskArr:"sampler2darray",pickingColorArr:"vec4",height:"float"},attributes:{aVertexPositionHigh:"vec3",aVertexPositionLow:"vec3",aTextureCoord:"vec2"},vertexShader:"precision highp float;attribute vec3 aVertexPositionHigh;attribute vec3 aVertexPositionLow;attribute vec2 aTextureCoord;uniform mat4 projectionMatrix;uniform mat4 viewMatrix;uniform vec3 eyePositionHigh;uniform vec3 eyePositionLow;uniform float height;varying vec2 vTextureCoord;void main(void){vTextureCoord=aTextureCoord;mat4 viewMatrixRTE=viewMatrix;viewMatrixRTE[3]=vec4(0.0,0.0,0.0,1.0);mat4 m=projectionMatrix*viewMatrixRTE;vec3 nh=height*normalize(aVertexPositionHigh+aVertexPositionLow);vec3 highDiff=aVertexPositionHigh-eyePositionHigh;vec3 lowDiff=aVertexPositionLow-eyePositionLow+nh;gl_Position=m*vec4(highDiff*step(1.0,length(highDiff))+lowDiff,1.0);}",fragmentShader:`precision highp float;
#ifdef WEBGL2
#define TEXTURE_FUNC texture
#else
#define TEXTURE_FUNC texture2D
#endif
#define SLICE_SIZE 5
#define blend(DEST, SAMPLER, OFFSET, OPACITY) src = TEXTURE_FUNC(SAMPLER, OFFSET.xy + vTextureCoord.xy * OFFSET.zw); DEST = DEST * (1.0 - src.a * OPACITY) + src * OPACITY;
#define blendPicking(DEST, OFFSET, SAMPLER, MASK, COLOR, OPACITY) tc = OFFSET.xy + vTextureCoord.xy * OFFSET.zw; t = TEXTURE_FUNC(SAMPLER, tc); p = TEXTURE_FUNC(MASK, tc); DEST = mix(DEST, vec4(max(COLOR.rgb, p.rgb), OPACITY), (t.a == 0.0 ? 0.0: 1.0) * COLOR.a);
const vec3 nightStep=10.0*vec3(0.58,0.48,0.25);uniform vec4 tileOffsetArr[SLICE_SIZE];uniform vec4 pickingColorArr[SLICE_SIZE];uniform sampler2D samplerArr[SLICE_SIZE];uniform sampler2D pickingMaskArr[SLICE_SIZE];uniform int samplerCount;varying vec2 vTextureCoord;void main(void){gl_FragColor=vec4(0.0);if(samplerCount==0)return;vec2 tc;vec4 t;vec4 p;blendPicking(gl_FragColor,tileOffsetArr[0],samplerArr[0],pickingMaskArr[0],pickingColorArr[0],1.0);if(samplerCount==1)return;blendPicking(gl_FragColor,tileOffsetArr[1],samplerArr[1],pickingMaskArr[1],pickingColorArr[1],1.0);if(samplerCount==2)return;blendPicking(gl_FragColor,tileOffsetArr[2],samplerArr[2],pickingMaskArr[2],pickingColorArr[2],1.0);if(samplerCount==3)return;blendPicking(gl_FragColor,tileOffsetArr[3],samplerArr[3],pickingMaskArr[3],pickingColorArr[3],1.0);if(samplerCount==4)return;blendPicking(gl_FragColor,tileOffsetArr[4],samplerArr[4],pickingMaskArr[4],pickingColorArr[4],1.0);}`})),t.addProgram(new $("drawnode_depth",{uniforms:{projectionMatrix:"mat4",viewMatrix:"mat4",height:"float",eyePositionHigh:"vec3",eyePositionLow:"vec3",frustumPickingColor:"float"},attributes:{aVertexPositionHigh:"vec3",aVertexPositionLow:"vec3"},vertexShader:`#version 300 es
precision highp float;in vec3 aVertexPositionHigh;in vec3 aVertexPositionLow;uniform mat4 projectionMatrix;uniform mat4 viewMatrix;uniform vec3 eyePositionHigh;uniform vec3 eyePositionLow;uniform float height;void main(void){mat4 viewMatrixRTE=viewMatrix;viewMatrixRTE[3]=vec4(0.0,0.0,0.0,1.0);mat4 m=projectionMatrix*viewMatrixRTE;vec3 nh=height*normalize(aVertexPositionHigh+aVertexPositionLow);vec3 eyePosition=eyePositionHigh+eyePositionLow;vec3 vertexPosition=aVertexPositionHigh+aVertexPositionLow;vec3 highDiff=aVertexPositionHigh-eyePositionHigh;vec3 lowDiff=aVertexPositionLow-eyePositionLow+nh;gl_Position=m*vec4(highDiff*step(1.0,length(highDiff))+lowDiff,1.0);}`,fragmentShader:`#version 300 es
precision highp float;uniform float frustumPickingColor;layout(location=0)out vec4 frustumColor;layout(location=1)out vec4 depthColor;void main(void){frustumColor=vec4(frustumPickingColor,frustumPickingColor,frustumPickingColor,1.0);depthColor=vec4(gl_FragCoord.z,gl_FragCoord.z,gl_FragCoord.z,1.0);}`})),e.addPickingCallback(this,this._renderColorPickingFramebufferPASS),e.addDepthCallback(this,()=>{this.renderDepthFramebuffer(this.camera,this.quadTreeStrategy)})}_onLayerLoadend(e){this.events.dispatch(this.events.layerloadend,e)}init(){this._tileLoader.events.on("layerloadend",this._onLayerLoadend,this),Yi().setMaxGridSize(this._maxGridSize);const e=this._maxGridSize;let t=0;for(let n=0;n<=e;n++){!this._indexesCache[n]&&(this._indexesCache[n]=new Array(e));for(let o=0;o<=e;o++){!this._indexesCache[n][o]&&(this._indexesCache[n][o]=new Array(e));for(let a=0;a<=e;a++){!this._indexesCache[n][o][a]&&(this._indexesCache[n][o][a]=new Array(e));for(let h=0;h<=e;h++){!this._indexesCache[n][o][a][h]&&(this._indexesCache[n][o][a][h]=new Array(e));for(let c=0;c<=e;c++){let d={buffer:null};if(n>=1&&n===o&&n===a&&n===h&&n===c){let u=Yi().createSegmentIndexes(n,[o,a,h,c]);d.buffer=this.renderer.handler.createElementArrayBuffer(u,1)}else this._indexesCacheToRemove[t++]=d;this._indexesCache[n][o][a][h][c]=d}}}}}this.renderer.events.on("drawtransparent",()=>{this._renderScreenNodesWithHeightPASS()}),this._textureCoordsBufferCache=[];let s=Yi().initTextureCoordsTable(e+1);for(let n=0;n<=e;n++)this._textureCoordsBufferCache[n]=this.renderer.handler.createArrayBuffer(s[n],2,(1+(1<<n))*(1+(1<<n)));if(this.renderer.handler.createDefaultTexture(null,n=>{this.solidTextureOne=n,this.solidTextureTwo=n}),this.transparentTexture=this.renderer.handler.transparentTexture,this.drawMode=this.renderer.handler.gl.TRIANGLE_STRIP,this._initializeShaders(),this._initializeAtmosphere(),this._updateVisibleLayers(),this._nightTextureSrc){let n=new Image;n.crossOrigin="Anonymous",n.onload=()=>{this._nightTexture=this.renderer.handler.createTextureDefault(n),this._nightTexture.default=!0},n.src=this._nightTextureSrc}if(this._specularTextureSrc){let n=new Image;n.crossOrigin="Anonymous",n.onload=()=>{this._specularTexture=this.renderer.handler.createTextureDefault(n),this._specularTexture.default=!0},n.src=this._specularTextureSrc}this._geoImageCreator.init(),this._vectorTileCreator.init(),this._normalMapCreator.init(),this.renderer.events.on("draw",this._globalPreDraw,this,-100),this.quadTreeStrategy.init(this.camera),this.initLayers(),this._initialized=!0,this._initialViewExtent&&this.viewExtent(this._initialViewExtent),this.renderer.activeCamera=this.camera,this.camera.bindFrustumsPickingColors(this.renderer),this.camera.update()}initLayers(){let e=[...this._layers];for(let t=0;t<e.length;t++)this.removeLayer(e[t]),this.addLayer(e[t])}_clearIndexesCache(){this._indexesCacheToRemoveCounter=0;let e=this._indexesCacheToRemove,t=this.renderer.handler.gl;for(let s=0,n=e.length;s<n;s++){let o=e[s];t.deleteBuffer(o.buffer),o.buffer=null}}createDefaultTextures(e,t){this.renderer.handler.gl.deleteTexture(this.solidTextureOne),this.renderer.handler.gl.deleteTexture(this.solidTextureTwo),this.renderer.handler.createDefaultTexture(e,s=>{this.solidTextureOne=s}),this.renderer.handler.createDefaultTexture(t,s=>{this.solidTextureTwo=s})}_getLayerAttributionHTML(e){return`<div class="og-attribution__layer">${e.getAttribution()}</div>`}updateAttributionsList(){let e="";for(let t=0,s=this._layers.length;t<s;t++){let n=this._layers[t];n.getVisibility()&&n.getAttribution().length&&(e+=this._getLayerAttributionHTML(n))}this._applyAttribution(e)}updateVisibleLayers(){this._updateLayers=!0}_updateVisibleLayers(){this.visibleTileLayers=[],this.visibleTileLayers.length=0,this.visibleVectorLayers=[],this.visibleVectorLayers.length=0;let e="";for(let t=0,s=this._layers.length;t<s;t++){let n=this._layers[t];n.getVisibility()?(n.isBaseLayer()&&(this.createDefaultTextures(n._defaultTextures[0],n._defaultTextures[1]),this.baseLayer=n),n.hasImageryTiles()&&this.visibleTileLayers.push(n),n.isVector&&this.visibleVectorLayers.push(n),n.getAttribution().length&&(e+=this._getLayerAttributionHTML(n))):n._fading&&n._fadingOpacity>0&&(n.hasImageryTiles()&&this.visibleTileLayers.push(n),n.isVector&&this.visibleVectorLayers.push(n))}this._applyAttribution(e),this._sortLayers()}_applyAttribution(e){this.renderer&&this.renderer.div&&(e.length?this.renderer.div.attributions.innerHTML!==e&&(this.renderer.div.attributions.innerHTML=e):this.renderer.div.attributions.innerHTML="")}_sortLayers(){this.visibleVectorLayers.sort((t,s)=>t.getZIndex()-s.getZIndex()||t.getHeight()-s.getHeight());let e={0:[]};for(const t of this.visibleVectorLayers)e[t.depthOrder]||(e[t.depthOrder]=[]),e[t.depthOrder].push(t);if(this._visibleVectorLayersByDepthOrder.length=0,this._visibleVectorLayersByDepthOrder=[],this._visibleVectorLayersByDepthOrder=Object.keys(e).sort((t,s)=>Number(t)-Number(s)).map(t=>e[Number(t)]),this._visibleTileLayerSlices=[],this._visibleTileLayerSlices.length=0,this.visibleTileLayers.length){this.visibleTileLayers.sort((n,o)=>n.getHeight()-o.getHeight()||n.getZIndex()-o.getZIndex());let t=-1,s=this.visibleTileLayers[0].getHeight();for(let n=0,o=this.visibleTileLayers.length;n<o;n++)n%this.SLICE_SIZE!=0&&this.visibleTileLayers[n].getHeight()===s||(t++,this._visibleTileLayerSlices[t]=[],s=this.visibleTileLayers[n].getHeight()),this._visibleTileLayerSlices[t].push(this.visibleTileLayers[n])}}_renderScreenNodesPASSNoAtmos(){let e=this.camera,t=this._setUniformsNoAtmos(e);this._renderingScreenNodes(this.quadTreeStrategy,t,e,this.quadTreeStrategy._renderedNodesInFrustum[e.currentFrustumIndex])}_renderScreenNodesPASSAtmos(){let e=this.camera,t=this._setUniformsAtmos(e);this._renderingScreenNodes(this.quadTreeStrategy,t,e,this.quadTreeStrategy._renderedNodesInFrustum[e.currentFrustumIndex])}_renderScreenNodesWithHeightPASSNoAtmos(){let e=this.camera,t=this._setUniformsNoAtmos(e);this._renderingScreenNodesWithHeight(this.quadTreeStrategy,t,e,this.quadTreeStrategy._renderedNodesInFrustum[e.currentFrustumIndex])}_renderScreenNodesWithHeightPASSAtmos(){let e=this.camera,t=this._setUniformsAtmos(e);this._renderingScreenNodesWithHeight(this.quadTreeStrategy,t,e,this.quadTreeStrategy._renderedNodesInFrustum[e.currentFrustumIndex])}_globalPreDraw(){let e=this.camera;this._distBeforeMemClear+=this._prevCamEye.distance(e.eye),this._prevCamEye.copy(e.eye),this._createdNodesCount>this._maxNodes&&this._distBeforeMemClear>this._minDistanceBeforeMemClear&&(this.terrain.clearCache(),this.memClear()),this._indexesCacheToRemoveCounter>600&&this._clearIndexesCache()}preFrame(){this._updateLayers&&(this._updateLayers=!1,this._updateVisibleLayers()),this.camera.isFirstPass&&(this.camera.update(),this._collectRenderNodesIsActive&&this.quadTreeStrategy.collectRenderNodes(this.camera),this._normalMapCreator.frame(),this._geoImageCreator.frame(),this._vectorTileCreator.frame(),this.camera.checkTerrainCollision(),this.camera.update(),this.events.dispatch(this.events.draw,this),this._collectVectorLayerCollections());for(let e=0;e<this._visibleEntityCollections.length;e++)this.drawEntityCollections(this._visibleEntityCollections[e],e)}frame(){this._renderScreenNodesPASS()}lockQuadTree(){this._collectRenderNodesIsActive=!1,this.camera.setTerrainCollisionActivity(!1)}unlockQuadTree(){this._collectRenderNodesIsActive=!0,this.camera.setTerrainCollisionActivity(!0)}_setUniformsNoAtmos(e){let t,s,n=this.renderer,o=n.handler,a=o.gl;return a.enable(a.CULL_FACE),n.enableBlendOneSrcAlpha(),this.lightEnabled?(o.programs.drawnode_screen_wl.activate(),t=o.programs.drawnode_screen_wl._program,s=t.uniforms,a.uniform3fv(s.lightPosition,this._lightPosition),a.uniformMatrix4fv(s.viewMatrix,!1,e.getViewMatrix()),a.uniformMatrix4fv(s.projectionMatrix,!1,e.getProjectionMatrix()),this.baseLayer?(a.uniform3fv(s.diffuse,this.baseLayer._diffuse||this._diffuse),a.uniform3fv(s.ambient,this.baseLayer._ambient||this._ambient),a.uniform4fv(s.specular,this.baseLayer._specular||this._specular),a.uniform1f(s.nightTextureCoefficient,this.baseLayer.nightTextureCoefficient||this.nightTextureCoefficient)):(a.uniform3fv(s.diffuse,this._diffuse),a.uniform3fv(s.ambient,this._ambient),a.uniform4fv(s.specular,this._specular),a.uniform1f(s.nightTextureCoefficient,this.nightTextureCoefficient)),a.activeTexture(a.TEXTURE0+this.SLICE_SIZE),a.bindTexture(a.TEXTURE_2D,this._nightTexture||this.transparentTexture),a.uniform1i(s.nightTexture,this.SLICE_SIZE),a.activeTexture(a.TEXTURE0+this.SLICE_SIZE+1),a.bindTexture(a.TEXTURE_2D,this._specularTexture||this.transparentTexture),a.uniform1i(s.specularTexture,this.SLICE_SIZE+1),a.uniform1f(s.camHeight,e.getHeight())):(o.programs.drawnode_screen_nl.activate(),t=o.programs.drawnode_screen_nl._program,s=t.uniforms,a.uniformMatrix4fv(s.viewMatrix,!1,e.getViewMatrix()),a.uniformMatrix4fv(s.projectionMatrix,!1,e.getProjectionMatrix())),a.uniform3fv(s.eyePositionHigh,e.eyeHigh),a.uniform3fv(s.eyePositionLow,e.eyeLow),t}_setUniformsAtmos(e){let t,s,n=this.renderer,o=n.handler,a=o.gl;return a.enable(a.CULL_FACE),n.enableBlendOneSrcAlpha(),this.lightEnabled?(o.programs.drawnode_screen_wl.activate(),t=o.programs.drawnode_screen_wl._program,s=t.uniforms,a.uniform3fv(s.lightPosition,this._lightPosition),a.uniformMatrix4fv(s.viewMatrix,!1,e.getViewMatrix()),a.uniformMatrix4fv(s.projectionMatrix,!1,e.getProjectionMatrix()),this.baseLayer?(a.uniform3fv(s.diffuse,this.baseLayer._diffuse||this._diffuse),a.uniform3fv(s.ambient,this.baseLayer._ambient||this._ambient),a.uniform4fv(s.specular,this.baseLayer._specular||this._specular),a.uniform1f(s.nightTextureCoefficient,this.baseLayer.nightTextureCoefficient||this.nightTextureCoefficient)):(a.uniform3fv(s.diffuse,this._diffuse),a.uniform3fv(s.ambient,this._ambient),a.uniform4fv(s.specular,this._specular),a.uniform1f(s.nightTextureCoefficient,this.nightTextureCoefficient)),a.uniform2fv(s.maxMinOpacity,this._atmosphereMaxMinOpacity),a.activeTexture(a.TEXTURE0+this.SLICE_SIZE),a.bindTexture(a.TEXTURE_2D,this._nightTexture||this.transparentTexture),a.uniform1i(s.nightTexture,this.SLICE_SIZE),a.activeTexture(a.TEXTURE0+this.SLICE_SIZE+1),a.bindTexture(a.TEXTURE_2D,this._specularTexture||this.transparentTexture),a.uniform1i(s.specularTexture,this.SLICE_SIZE+1),a.activeTexture(a.TEXTURE0+this.SLICE_SIZE+4),a.bindTexture(a.TEXTURE_2D,n.controls.Atmosphere._transmittanceBuffer.textures[0]),a.uniform1i(s.transmittanceTexture,this.SLICE_SIZE+4),a.activeTexture(a.TEXTURE0+this.SLICE_SIZE+5),a.bindTexture(a.TEXTURE_2D,n.controls.Atmosphere._scatteringBuffer.textures[0]),a.uniform1i(s.scatteringTexture,this.SLICE_SIZE+5),a.uniform1f(s.camHeight,e.getHeight())):(o.programs.drawnode_screen_nl.activate(),t=o.programs.drawnode_screen_nl._program,s=t.uniforms,a.uniformMatrix4fv(s.viewMatrix,!1,e.getViewMatrix()),a.uniformMatrix4fv(s.projectionMatrix,!1,e.getProjectionMatrix())),a.uniform3fv(s.eyePositionHigh,e.eyeHigh),a.uniform3fv(s.eyePositionLow,e.eyeLow),t}static __refreshLayersFadingOpacity__(e,t,s){for(let n=e.length-1;n>=0;--n){let o=e[n];o._fading&&o._refreshFadingOpacity(t,s)&&e.splice(n,1)}}_renderingScreenNodes(e,t,s,n){let o=this._visibleTileLayerSlices;o.length&&s.isFirstPass&&Si.__refreshLayersFadingOpacity__(o[0],e.minCurrZoom,e.maxCurrZoom);let a=new Map,h=[],c=this.terrain.equalizeVertices,d=n.length;if(e._fadingOpaqueSegments=[],s.slope>.8||!this.terrain||this.terrain.isEmpty)for(;d--;){let u=n[d],_=u.segment;this._renderingFadingNodesNoDepth(e,a,t,u,o[0],0,e._fadingOpaqueSegments),c&&_.equalize(),_.readyToEngage&&_.engage(),_.screenRendering(t,o[0],0)}else{for(;d--;){let u=n[d],_=u.segment;this._renderingFadingNodes(e,a,t,u,o[0],0,h,e._fadingOpaqueSegments),_._transitionOpacity<1?h.push(_):(c&&_.equalize(),_.readyToEngage&&_.engage(),_.screenRendering(t,o[0],0))}for(let u=0;u<h.length;u++){let _=h[u];c&&_.equalize(),_.readyToEngage&&_.engage(),_.screenRendering(t,o[0],0)}}}_renderingScreenNodesWithHeight(e,t,s,n){let o=this.renderer.handler.gl;o.enable(o.POLYGON_OFFSET_FILL),o.disable(o.CULL_FACE);let a=new Map,h=[],c=this._visibleTileLayerSlices;for(let d=1,u=c.length;d<u;d++){s.isFirstPass&&Si.__refreshLayersFadingOpacity__(c[d],e.minCurrZoom,e.maxCurrZoom),o.polygonOffset(0,-d);let _=n.length;for(;_--;){let f=n[_];this._renderingFadingNodes(e,a,t,f,c[d],d,h),f.segment._transitionOpacity<1?f.segment.initSlice(d):f.segment.screenRendering(t,c[d],d,this.transparentTexture,!0)}}o.disable(o.POLYGON_OFFSET_FILL),o.enable(o.CULL_FACE)}_renderColorPickingFramebufferPASS(){let e,t=this.renderer,s=t.handler,n=s.gl;s.programs.drawnode_colorPicking.activate(),e=s.programs.drawnode_colorPicking._program;let o=e.uniforms,a=t.activeCamera;n.enable(n.CULL_FACE),n.uniformMatrix4fv(o.viewMatrix,!1,a.getViewMatrix()),n.uniformMatrix4fv(o.projectionMatrix,!1,a.getProjectionMatrix()),n.uniform3fv(o.eyePositionHigh,a.eyeHigh),n.uniform3fv(o.eyePositionLow,a.eyeLow);let h=this.quadTreeStrategy._renderedNodesInFrustum[a.getCurrentFrustum()],c=this._visibleTileLayerSlices,d=h.length;for(;d--;)h[d].segment._transitionOpacity>=1&&h[d].segment.colorPickingRendering(e,c[0],0);for(let u=0;u<this.quadTreeStrategy._fadingOpaqueSegments.length;++u)this.quadTreeStrategy._fadingOpaqueSegments[u].colorPickingRendering(e,c[0],0);n.enable(n.POLYGON_OFFSET_FILL);for(let u=1,_=c.length;u<_;u++)for(d=h.length,n.polygonOffset(0,-u);d--;)h[d].segment.colorPickingRendering(e,c[u],u,this.transparentTexture,!0);n.disable(n.POLYGON_OFFSET_FILL)}renderDepthFramebuffer(e,t){let s,n=this.renderer.handler,o=n.gl;n.programs.drawnode_depth.activate(),s=n.programs.drawnode_depth._program;let a=s.uniforms;o.disable(o.BLEND),o.disable(o.POLYGON_OFFSET_FILL),o.uniformMatrix4fv(a.viewMatrix,!1,e.getViewMatrix()),o.uniformMatrix4fv(a.projectionMatrix,!1,e.getProjectionMatrix()),o.uniform3fv(a.eyePositionHigh,e.eyeHigh),o.uniform3fv(a.eyePositionLow,e.eyeLow),o.uniform1f(a.frustumPickingColor,e.frustumColorIndex);let h=t._renderedNodesInFrustum[e.getCurrentFrustum()],c=this._visibleTileLayerSlices,d=h.length;for(;d--;)h[d].segment._transitionOpacity>=1&&h[d].segment.depthRendering(s,c[0]);for(let u=0;u<t._fadingOpaqueSegments.length;++u)t._fadingOpaqueSegments[u].depthRendering(s,c[0]);o.enable(o.BLEND)}_collectVectorLayerCollections(){let e=this._visibleVectorLayersByDepthOrder.length;this._visibleEntityCollections.length=0,this._visibleEntityCollections=new Array(e);for(let t=0;t<this._visibleEntityCollections.length;t++)this._visibleEntityCollections[t]=[];for(;e--;){let t=this._visibleVectorLayersByDepthOrder[e],s=t.length;for(;s--;){let n=t[s];n._fading&&n._refreshFadingOpacity(this.quadTreeStrategy.minCurrZoom,this.quadTreeStrategy.maxCurrZoom)&&(t.splice(s,1),t.length===0&&this._visibleVectorLayersByDepthOrder.splice(e,1)),n.collectVisibleCollections(this._visibleEntityCollections[e]),n.update()}}}memClear(){this._distBeforeMemClear=0,this.camera._insideSegment=null,this.layerLock.lock(this._memKey),this.terrainLock.lock(this._memKey),this._normalMapCreator.lock(this._memKey),this._normalMapCreator.clear(),this.terrain.abortLoading(),this._tileLoader.abortAll(),this.quadTreeStrategy.clear(),this.layerLock.free(this._memKey),this.terrainLock.free(this._memKey),this._normalMapCreator.free(this._memKey),this._createdNodesCount=0}getRayIntersectionEllipsoid(e){return this.ellipsoid.hitRay(e.origin,e.direction)}getCartesianFromPixelEllipsoid(e){let t=this.renderer.activeCamera;return this.ellipsoid.hitRay(t.eye,t.unproject(e.x,e.y))}getLonLatFromPixelEllipsoid(e){let t=this.getCartesianFromPixelEllipsoid(e);if(t)return this.ellipsoid.cartesianToLonLat(t)}getCartesianFromMouseTerrain(){let e=this.renderer.events.mouseState,t=this.getDistanceFromPixel(e);if(t)return e.direction.scaleTo(t).addA(this.renderer.activeCamera.eye)}getCartesianFromPixelTerrain(e){let t=this.getDistanceFromPixel(e);if(t)return(e.direction||this.renderer.activeCamera.unproject(e.x,e.y)).scaleTo(t).addA(this.renderer.activeCamera.eye)}getLonLatFromPixelTerrain(e){let t=this.getCartesianFromPixelTerrain(e);if(t)return this.ellipsoid.cartesianToLonLat(t)}getPixelFromCartesian(e){return this.renderer.activeCamera.project3v(e)}getPixelFromLonLat(e){let t=this.ellipsoid.lonLatToCartesian(e);if(t)return this.renderer.activeCamera.project3v(t)}getDistanceFromPixelEllipsoid(e){let t=this.getCartesianFromPixelEllipsoid(e);if(t)return t.distance(this.renderer.activeCamera.eye)}getDistanceFromPixel(e){return this.renderer.getDistanceFromPixel(e)||this.getDistanceFromPixelEllipsoid(e)||0}viewExtent(e){this.camera?this.camera.viewExtent(e):this._initialViewExtent=e}viewExtentArr(e){this.viewExtent(new H(new A(e[0],e[1]),new A(e[2],e[3])))}getExtent(){if(this.renderer){let e=this.renderer.handler.getWidth(),t=this.renderer.handler.getHeight(),s=[this.getLonLatFromPixelTerrain(new O(0,0)),this.getLonLatFromPixelTerrain(new O(e,0)),this.getLonLatFromPixelTerrain(new O(e,t)),this.getLonLatFromPixelTerrain(new O(0,t))];if(s[0]&&s[1]&&s[2]&&s[3]){let n=s[0].lon,o=s[2].lat,a=s[1].lon,h=s[0].lat;for(let c=0;c<s.length;c++)s[c].lon>a&&(a=s[c].lon),s[c].lat>h&&(h=s[c].lat),s[c].lon<n&&(n=s[c].lon),s[c].lat<o&&(o=s[c].lat);return new H(new A(n,o),new A(a,h))}}return this.quadTreeStrategy._viewExtent}getViewExtent(){return this.quadTreeStrategy._viewExtent}viewLonLat(e,t,s){this.camera.setLonLat(e,t,s)}flyExtent(e,t,s={}){this.camera.flyExtent(e,t,s)}flyCartesian(e,t){this.camera.flyCartesian(e,t)}flyLonLat(e,t={}){this.camera.flyLonLat(e,t)}stopFlying(){this.camera.stopFlying()}updateBillboardsTexCoords(){for(let t=0;t<this.entityCollections.length;t++)this.entityCollections[t].billboardHandler.refreshTexCoordsArr();let e={};for(let t=0;t<this._layers.length;t++){let s=this._layers[t];s instanceof ut&&s.each(function(n){n._entityCollection&&!e[n._entityCollection.id]&&(n._entityCollection.billboardHandler.refreshTexCoordsArr(),e[n._entityCollection.id]=!0)})}}getEntityTerrainPoint(e,t){let s=this.quadTreeStrategy._renderedNodes,n=s.length;for(;n--;)if(s[n].segment.isEntityInside(e))return s[n].segment.getEntityTerrainPoint(e,t)}async getHeightDefault(e){return new Promise(t=>{this.terrain?this.terrain.getHeightAsync(e.clone(),s=>{t(s)}):t(0)})}async getHeightAboveELL(e){return new Promise(t=>{this.terrain?this.terrain.getHeightAsync(e.clone(),s=>{t(s+this.terrain.geoid.getHeightLonLat(e))}):t(0)})}onremove(){this.memClear(),this.quadTreeStrategy.destroyBranches(),this.quadTreeStrategy.clearRenderedNodes()}destroy(){var e;this._terrainWorker.destroy(),this._plainSegmentWorker.destroy(),(e=this.renderer)==null||e.destroy(),this.onremove(),super.destroy()}}const ic=["draw","layeradd","baselayerchange","layerremove","layervisibilitychange","rendercompleted","terraincompleted","layerloadend"];class dn extends ce{constructor(e){super("skybox"),this.params=e,this.vertexPositionBuffer=null,this.texture=null}static createDefault(e){return new dn({nx:e+"skybox/gal/_nx.jpg",px:e+"skybox/gal/_px.jpg",py:e+"skybox/gal/_py.jpg",ny:e+"skybox/gal/_ny.jpg",pz:e+"skybox/gal/_pz.jpg",nz:e+"skybox/gal/_nz.jpg"})}init(){this.renderer.handler.addProgram(new $("skybox",{uniforms:{projectionViewMatrix:{type:lt.MAT4},uSampler:{type:lt.SAMPLERCUBE},pos:{type:lt.VEC3}},attributes:{aVertexPosition:{type:lt.VEC3,enableArray:!0}},vertexShader:`attribute vec3 aVertexPosition;
            uniform mat4 projectionViewMatrix;
            uniform vec3 pos;
            varying vec3 vTextureCoord;
            void main(void) {
                vTextureCoord = aVertexPosition;
                gl_Position = projectionViewMatrix * vec4(aVertexPosition + pos, 1.0);
            }`,fragmentShader:`precision lowp float;
            varying vec3 vTextureCoord;
            uniform samplerCube uSampler;
            void main(void) {
                gl_FragColor = textureCube(uSampler, vTextureCoord);
            }`})),this.texture=this.renderer.handler.loadCubeMapTexture(this.params),this._createBuffers(),this.drawMode=this.renderer.handler.gl.TRIANGLES}preFrame(){let e=this.renderer.handler,t=e.gl,s=this.renderer.activeCamera;t.disable(t.DEPTH_TEST),e.programs.skybox.activate();let n=e.programs.skybox._program,o=n.uniforms;t.uniformMatrix4fv(o.projectionViewMatrix,!1,s.getProjectionViewMatrix()),t.uniform3fv(o.pos,s.eye.toArray()),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_CUBE_MAP,this.texture),t.uniform1i(o.uSampler,0);let a=this.vertexPositionBuffer;t.bindBuffer(t.ARRAY_BUFFER,a),t.vertexAttribPointer(n.attributes.aVertexPosition,a.itemSize,t.FLOAT,!1,0,0),t.drawArrays(this.drawMode,0,a.numItems),t.enable(t.DEPTH_TEST)}_createBuffers(){const e=new Float32Array([-1e8,1e8,-1e8,-1e8,-1e8,-1e8,1e8,-1e8,-1e8,1e8,-1e8,-1e8,1e8,1e8,-1e8,-1e8,1e8,-1e8,-1e8,-1e8,1e8,-1e8,-1e8,-1e8,-1e8,1e8,-1e8,-1e8,1e8,-1e8,-1e8,1e8,1e8,-1e8,-1e8,1e8,1e8,-1e8,-1e8,1e8,-1e8,1e8,1e8,1e8,1e8,1e8,1e8,1e8,1e8,1e8,-1e8,1e8,-1e8,-1e8,-1e8,-1e8,1e8,-1e8,1e8,1e8,1e8,1e8,1e8,1e8,1e8,1e8,1e8,-1e8,1e8,-1e8,-1e8,1e8,-1e8,1e8,-1e8,1e8,1e8,-1e8,1e8,1e8,1e8,1e8,1e8,1e8,-1e8,1e8,1e8,-1e8,1e8,-1e8,-1e8,-1e8,-1e8,-1e8,-1e8,1e8,1e8,-1e8,-1e8,1e8,-1e8,-1e8,-1e8,-1e8,1e8,1e8,-1e8,1e8]);this.vertexPositionBuffer=this.renderer.handler.createArrayBuffer(e,3,e.length/3)}}Object.freeze(Object.defineProperty({__proto__:null,Axes:class extends ce{constructor(l=100){super("Axes"),this.size=l,this.axesBuffer=null,this.axesColorBuffer=null}init(){this.createAxesBuffer(this.size),this.drawMode=this.renderer.handler.gl.LINES,this.renderer.handler.addProgram(new $("axesShader",{uniforms:{projectionViewMatrix:"mat4"},attributes:{aVertexPosition:"vec3",aVertexColor:"vec4"},vertexShader:`attribute vec3 aVertexPosition;
            attribute vec4 aVertexColor;
            uniform mat4 projectionViewMatrix;
            varying vec4 vColor;
            void main(void) {
                gl_Position = projectionViewMatrix * vec4(aVertexPosition, 1.0);
                vColor = aVertexColor;
            }`,fragmentShader:`precision highp float;
            varying vec4 vColor;
            void main(void) {
                gl_FragColor = vColor;
            }`}))}frame(){this.renderer.handler.programs.axesShader.activate().set({projectionViewMatrix:this.renderer.activeCamera.getProjectionViewMatrix(),aVertexPosition:this.axesBuffer,aVertexColor:this.axesColorBuffer}),this.renderer.handler.programs.axesShader.drawArrays(this.drawMode,this.axesBuffer.numItems)}createAxesBuffer(l){const e=[0,0,0,l-1,0,0,0,0,0,0,l-1,0,0,0,0,0,0,l-1];this.axesBuffer=this.renderer.handler.createArrayBuffer(new Float32Array(e),3,6),this.axesColorBuffer=this.renderer.handler.createArrayBuffer(new Float32Array([1,0,0,1,1,0,0,1,0,0,1,1,0,0,1,1,0,1,0,1,0,1,0,1]),4,6)}},Planet:Si,RenderNode:ce,SkyBox:dn},Symbol.toStringTag,{value:"Module"}));const Rs=class Xc{constructor(e={}){this.__id=Xc.__counter__++,this.equalizeVertices=e.equalizeVertices||!1,this.equalizeNormals=!1,this.isEmpty=!0,this.name=e.name||"empty",this.minZoom=e.minZoom||2,this.maxZoom=e.maxZoom||19,this.maxNativeZoom=e.maxNativeZoom||this.maxZoom,this.gridSizeByZoom=e.gridSizeByZoom||[64,32,16,8,4,4,4,4,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2],this._maxNodeZoom=this.gridSizeByZoom.length-1,this.plainGridSize=2,this.noDataValues=[],this._planet=null,this._geoid=e.geoid||new Aa({src:e.geoidSrc||null}),this._isReady=!1}setUrlRewriteCallback(e){}get isIdle(){return!0}isEqual(e){return e.__id===this.__id}static checkNoDataValue(e,t){return Yr(e,t)!==-1}isBlur(e){return!1}set maxNodeZoom(e){e>this.gridSizeByZoom.length-1&&(e=this.gridSizeByZoom.length-1),this._maxNodeZoom=e}get maxNodeZoom(){return this._maxNodeZoom}set geoid(e){this._geoid=e}get geoid(){return this._geoid}getGeoid(){return this._geoid}handleSegmentTerrain(e){e.terrainIsLoading=!1,e.terrainReady=!0,e.terrainExists=!0}isReady(){return this._isReady}abortLoading(){}clearCache(){}getHeightAsync(e,t){return t(0),!0}loadTerrain(e,t=!1){}};Rs.__counter__=0;let Ri=Rs;class un extends Ri{constructor(e="",t={}){super({geoidSrc:"https://openglobus.org/geoid/egm84-30.pgm",maxNativeZoom:t.maxNativeZoom||14,...t}),this._s=t.subdomains||["a","b","c"],this.events=ot(sc,this),this._requestCount=0,this._requestsPeerSubdomain=4,this.isEmpty=!1,this.equalizeNormals=!0,this.name=e||"openglobus",this.url=t.url||"https://{s}.srtm3.openglobus.org/{z}/{y}/{x}.ddm",this.gridSizeByZoom=t.gridSizeByZoom||[64,32,32,16,16,8,8,8,16,16,16,32,32,32,32,16,8,4,2,2,2,2,2,2],this._heightFactor=t.heightFactor!=null?t.heightFactor:1,this.noDataValues=t.noDataValues||[];for(let s=0;s<this.noDataValues.length;s++)this.noDataValues[s]*=this._heightFactor;this.plainGridSize=t.plainGridSize||32,this._extent=qr(t.extent,new H(new A(-180,-90),new A(180,90))),this._dataType="arrayBuffer",this._maxNodeZoom=this.gridSizeByZoom.length-1,this._elevationCache={},this._fetchCache={},this._cache=t.cache||"default",this._loader=new La,this._urlRewriteCallback=t.urlRewrite||null}get loader(){return this._loader}clearCache(){for(let e in this._elevationCache)this._elevationCache[e].heights=null,this._elevationCache[e].extent=null,delete this._elevationCache[e];this._elevationCache=null,this._elevationCache={};for(let e in this._fetchCache)this._fetchCache[e]=null,delete this._fetchCache[e];this._fetchCache=null,this._fetchCache={}}isBlur(e){return e.tileZoom>=6}setElevationCache(e,t){this._elevationCache[e]=t}getElevationCache(e){return this._elevationCache[e]}getHeightAsync(e,t,s,n){if(!e||e.lat>ht||e.lat<Ft)return t(0),!0;n=n==null||n;const[o,a,h,c]=this._planet.quadTreeStrategy.getTileXY(e,s||this.maxZoom);let d=It.getTileIndex(o,a,h,c),u=this.getElevationCache(d),_=Ki(e);if(u)return u.heights?t(this._getGroundHeightMerc(_,u)):t(0),!0;{let f=this._fetchCache[d];f||(f=this._loader.fetch({src:this._urlRewriteCallback&&this._urlRewriteCallback(o,a,h,c)||this.buildURL(o,a,h,c),type:this._dataType,options:{cache:this._cache}}),this._fetchCache[d]=f),f.then(v=>{let g=$e(o,a,h);if(v.status==="ready"){let y={heights:this._createHeights(v.data,null,c,o,a,h,g),extent:g};this.setElevationCache(d,y),t(this._getGroundHeightMerc(_,y))}else if(v.status==="error"){if(n&&h>this.maxNativeZoom)return n=!1,void this.getHeightAsync(e,t,this.maxNativeZoom,!1);this.setElevationCache(d,{heights:null,extent:g}),t(0)}else this._fetchCache[d]=null,delete this._fetchCache[d]})}return!1}_getGroundHeightMerc(e,t){if(!t.extent||!t.heights)return 0;let s=t.extent.getWidth(),n=Math.sqrt(t.heights.length),o=s/(n-1),a=n-Math.ceil((e.lat-t.extent.southWest.lat)/o)-1,h=Math.floor((e.lon-t.extent.southWest.lon)/o),c=(a+1)*n+h,d=c+1,u=a*n+h,_=u+1,f=t.heights[c],v=t.heights[d],g=t.heights[u],y=t.heights[_],p=new m(t.extent.southWest.lon+o*h,f,t.extent.northEast.lat-o*a-o),x=new m(p.x+o,v,p.z),T=new m(p.x,g,p.z+o),w=new m(p.x+o,y,p.z+o),C=new m(e.lon,1e5,e.lat),E=new N(C,new m(0,-1,0)),L=new m,S=E.hitTriangleRes(p,x,T,L);return S===N.INSIDE?L.y:(S=E.hitTriangleRes(x,w,T,L),S===N.INSIDE?L.y:0)}abortLoading(){this._loader.abortAll()}setUrl(e){this.url=e}setName(e){this.name=e}isReadyToLoad(e){return e._tileGroup===0&&this._extent.overlaps(e.getExtentLonLat())}loadTerrain(e,t=!1){if(this._planet.terrainLock.isFree())if(e.terrainReady=!1,e.terrainIsLoading=!0,this.isReadyToLoad(e)){let s=this.getElevationCache(e.tileIndex);s?this._applyElevationsData(e,s.heights):this._loader.load({sender:this,src:this._getHTTPRequestString(e),segment:e,type:this._dataType,options:{cache:this._cache},filter:()=>e.plainReady&&e.node.getState()!==0||t},n=>{if(n.status==="ready"){let o=this._createHeights(n.data,e,e._tileGroup,e.tileX,e.tileY,e.tileZoom,e.getExtent(),e.tileZoom===this.maxZoom);this.setElevationCache(e.tileIndex,{heights:o,extent:e.getExtent()}),this._applyElevationsData(e,o)}else n.status==="abort"?e.terrainIsLoading=!1:n.status==="error"?this._applyElevationsData(e,null):e.terrainIsLoading=!1})}else e.elevationsNotExists();else e.terrainIsLoading=!1}_getSubdomain(){return this._requestCount++,this._s[Math.floor(this._requestCount%(this._requestsPeerSubdomain*this._s.length)/this._requestsPeerSubdomain)]}buildURL(e,t,s,n){return zt(this.url,{s:this._getSubdomain(),x:e.toString(),y:t.toString(),z:s.toString()})}_createUrl(e){return this.buildURL(e.tileX,e.tileY,e.tileZoom,e._tileGroup)}_getHTTPRequestString(e){return this._urlRewriteCallback&&this._urlRewriteCallback(e.tileX,e.tileY,e.tileZoom,e._tileGroup)||this._createUrl(e)}setUrlRewriteCallback(e){this._urlRewriteCallback=e}_createHeights(e,t,s,n,o,a,h,c){if(this._heightFactor!==1){let d=new Float32Array(e);for(let u=0,_=d.length;u<_;u++)d[u]=d[u]*this._heightFactor;return d}return new Float32Array(e)}_applyElevationsData(e,t){if(e){let s=this.events.load;s.handlers.length&&this.events.dispatch(s,{elevations:t,segment:e}),e.applyTerrain(t)}}}const sc=["load","loadend"];class Is extends It{constructor(e,t={}){super(e,t),this.events=this.events.registerNames(rc),this.url=t.url||"",this._s=t.subdomains||["a","b","c"],this.minNativeZoom=t.minNativeZoom||0,this.maxNativeZoom=t.maxNativeZoom||19,this._urlRewriteCallback=t.urlRewrite||null,this._requestsPeerSubdomains=4,this._requestCount=0,this._cache=t.cache||"default"}get isIdle(){return super.isIdle&&this._planet._tileLoader.getRequestCounter(this)===0}get instanceName(){return"XYZ"}abortLoading(){this._planet&&this._planet._tileLoader.abort(this)}setVisibility(e){e!==this._visibility&&(super.setVisibility(e),e||this.abortLoading())}remove(){return this.abortLoading(),super.remove(),this}setUrl(e){this.url=e}_checkSegment(e){return e._projection.id===this._planet.quadTreeStrategy.projection.id}loadMaterial(e,t=!1){let s=e.segment;this._isBaseLayer?e.texture=s.getDefaultTexture():e.texture=s.planet.transparentTexture,(this._planet.layerLock.isFree()||e.segment.tileZoom<2)&&(e.isReady=!1,e.isLoading=!0,this._checkSegment(s)?(e.loadingAttempts++,this._planet._tileLoader.load({sender:this,src:this._getHTTPRequestString(e.segment),type:"imageBitmap",filter:()=>s.initialized&&s.node.getState()===1||t,options:{cache:this._cache}},n=>{if(n.status==="ready"){if(e.isLoading){let o=this.events.load;o.handlers.length&&this.events.dispatch(o,e),e.applyImage(n.data),n.data=null}}else n.status==="abort"?e.isLoading=!1:n.status==="error"&&e.isLoading&&e.textureNotExists()})):e.textureNotExists())}_createUrl(e){return zt(this.url,{s:this._getSubdomain(),x:e.tileX.toString(),y:e.tileY.toString(),z:e.tileZoom.toString()})}_getSubdomain(){return this._requestCount++,this._s[Math.floor(this._requestCount%(this._requestsPeerSubdomains*this._s.length)/this._requestsPeerSubdomains)]}_getHTTPRequestString(e){return this._urlRewriteCallback?this._urlRewriteCallback(e,this.url):this._createUrl(e)}setUrlRewriteCallback(e){this._urlRewriteCallback=e}applyMaterial(e,t=!1){if(e.isReady)return e.texOffset;if(e.segment.tileZoom<this.minNativeZoom)e.textureNotExists();else{let s=e.segment,n=s.node,o=!1,a=this.__id,h=e;for(;n.parentNode;)if(n=n.parentNode,h=n.segment.materials[a],h&&h.textureExists){o=!0;break}if(s.passReady){let c=e.layer.maxNativeZoom;if(n.segment.tileZoom===c)e.textureNotExists();else if(e.segment.tileZoom<=c)!e.isLoading&&!e.isReady&&this.loadMaterial(e,t);else{let d=s.node;for(;d.segment.tileZoom>e.layer.maxNativeZoom;)d=d.parentNode;let u=d.segment.materials[e.layer.__id];u?!u.isLoading&&!u.isReady&&this.loadMaterial(u,!0):(u=d.segment.materials[e.layer.__id]=e.layer.createMaterial(d.segment),this.loadMaterial(u,!0))}}if(o){e.appliedNode=n,e.appliedNodeId=n.nodeId,e.texture=h.texture;let c=1/(2<<s.tileZoom-n.segment.tileZoom-1);e.texOffset[0]=s.tileX*c-n.segment.tileX,e.texOffset[1]=s.tileY*c-n.segment.tileY,e.texOffset[2]=c,e.texOffset[3]=c}else e.texture=s.planet.transparentTexture,e.texOffset[0]=0,e.texOffset[1]=0,e.texOffset[2]=1,e.texOffset[3]=1}return e.texOffset}clearMaterial(e){e.isReady&&e.textureExists&&(!e.texture.default&&e.segment.handler.gl.deleteTexture(e.texture),e.texture=null),e.isReady=!1,e.textureExists=!1,e.isLoading=!1}_correctFullExtent(){let e=this._extent,t=this._extentMerc;e.northEast.lat===90&&(t.northEast.lat=2008750834e-2),e.northEast.lon===180&&(t.northEast.lon=2008750834e-2),e.southWest.lat===-90&&(t.southWest.lat=-2008750834e-2),e.southWest.lon===-180&&(t.southWest.lon=-2008750834e-2)}}const rc=["load","loadend"];class pe extends Is{constructor(e,t){super(e,t),this._extra=new URLSearchParams(t.extra).toString(),t.extent||this.setExtent(new H(new A(-180,-90),new A(180,90))),this.layers=t.layers,this.imageWidth=t.imageWidth||256,this.imageHeight=t.imageHeight||256,this._getBbox=pe.get_bbox_v1_1_1,this._version="",this.setVersion(t.version)}static createRequestUrl(e,t,s="image/png",n="1.1.1",o="GetMap",a,h,c=256,d=256,u){return`${e}?LAYERS=${t}&FORMAT=${s}&SERVICE=WMS&VERSION=${n}&REQUEST=${o}&SRS=${a}&BBOX=${h}&WIDTH=${c}&HEIGHT=${d}`+(u?`&${u}`:"")}static get_bbox_v1_1_1(e){return`${e.getWest()},${e.getSouth()},${e.getEast()},${e.getNorth()}`}static get_bbox_v1_3_0(e,t){return t==="epsg:4326"?`${e.getSouth()},${e.getWest()},${e.getNorth()},${e.getEast()}`:`${e.getWest()},${e.getSouth()},${e.getEast()},${e.getNorth()}`}_checkSegment(e){return!0}get instanceName(){return"WMS"}_createUrl(e){return pe.createRequestUrl(this.url,this.layers,"image/png",this._version,"GetMap",e._projection.code,this._getBbox(e.getExtent(),e._projection.code),this.imageWidth,this.imageHeight,this._extra)}setVersion(e){this._version=e||"1.1.1",this._version==="1.1.1"?this._getBbox=pe.get_bbox_v1_1_1:e==="1.3.0"&&(this._getBbox=pe.get_bbox_v1_3_0)}_correctFullExtent(){const e=this._extent,t=this._extentMerc;e.northEast.lat===90&&(t.northEast.lat=2008750834e-2),e.northEast.lon===180&&(t.northEast.lon=2008750834e-2),e.southWest.lat===-90&&(t.southWest.lat=-2008750834e-2),e.southWest.lon===-180&&(t.southWest.lon=-2008750834e-2)}}class Ge extends un{constructor(e={}){super("BilTerrain",e),this.equalizeVertices=!0,this.equalizeNormals=!0,this.minZoom=e.minZoom||2,this.maxZoom=e.maxZoom||14,this.noDataValues=e.noDataValues||[-9999,32767],this.url=e.url||"",this._format="application/bil16",this._layers=e.layers||"",this._imageSize=e.imageSize||256,this.plainGridSize=e.plainGridSize!=null?e.plainGridSize:Xi(this._imageSize)?this._imageSize/2:Ye(this._imageSize)/2,this._dataType="arrayBuffer"}isBlur(e){return e.tileZoom>=18}_createUrl(e){return pe.createRequestUrl(this.url,this._layers,this._format,"1.1.1","GetMap",e._projection.code,pe.get_bbox_v1_1_1(e.getExtent()),this._imageSize,this._imageSize)}_createHeights(e,t,s,n,o,a,h,c){let d=new Int16Array(e);if(!Xi(this._imageSize)){let y=new Float32Array(d.length);return function(p,x){for(let T=0,w=x.length;T<w;T++)x[T]=p[T]}(d,y),y}let u=(this.plainGridSize+1)*(this.plainGridSize+1),_=new Array(4);for(let y=0;y<4;y++){_[y]=[];for(let p=0;p<4;p++)_[y][p]=new Float32Array(u)}let f=new Float32Array(u);(function(y,p,x,T){let w=Math.sqrt(x.length)-1,C=w+1,E=Math.sqrt(y.length),L=E/w,S=0,P=0;for(let R=0,M=0,B=y.length;R<B;R++){let z=y[R],ue=Ge.checkNoDataValue(p,z),I=!1,se=!1,G=Math.floor(R/E),k=R%E,F=Math.floor(k/w),Ce=Math.floor(G/w),Mt=T[Ce][F],Je=G%w,Ot=k%w,bt=(Je+Ce)*C+Ot+F;if(Mt[bt]=z,(G+Ce)%L==0&&(k+F)%L==0&&(x[M++]=z),(k+1)%w==0&&k!==E-1){S=y[R],I=Ge.checkNoDataValue(p,S);let Ne=z;ue||I||(Ne=.5*(z+S)),bt=(Je+Ce)*C+Ot+1,Mt[bt]=Ne,(G+Ce)%L==0&&(x[M++]=Ne);let Wt=(Je+Ce)*C+(Ot+1)%w;T[Ce][F+1][Wt]=Ne}if((G+1)%w==0&&G!==E-1){P=y[R+E],se=Ge.checkNoDataValue(p,P);let Ne=z;ue||se||(Ne=.5*(z+P)),bt=(Je+1)*C+Ot+F,Mt[bt]=Ne,(k+F)%L==0&&(x[M++]=Ne);let Wt=(Je+1)%w*C+Ot+F;T[Ce+1][F][Wt]=Ne}if((k+1)%w==0&&k!==E-1&&(G+1)%w==0&&G!==E-1){let Ne=y[R+E+1],Wt=Ge.checkNoDataValue(p,Ne),Nt=z;ue||I||se||Wt||(Nt=.25*(z+S+P+Ne)),bt=(Je+1)*C+(Ot+1),Mt[bt]=Nt,x[M++]=Nt;let mc=(Je+1)*C;T[Ce][F+1][mc]=Nt;let vc=w;T[Ce+1][F][vc]=Nt;let yc=0;T[Ce+1][F+1][yc]=Nt}}})(d,this.noDataValues,f,_);let v=It.getTileIndex(n,o,a,s);this.setElevationCache(v,{heights:f,extent:h});let g=this._imageSize/this.plainGridSize;for(let y=0;y<g;y++)for(let p=0;p<g;p++){let x=2*n+p,T=2*o+y,w=a+1,C=It.getTileIndex(x,T,w,s);this.setElevationCache(C,{heights:_[y][p],extent:$e(x,T,w)})}return f}}class Pt extends un{constructor(e,t={}){super(e||"RgbTerrain",{equalizeVertices:t.equalizeVertices==null||t.equalizeVertices,maxZoom:t.maxZoom||17,noDataValues:t.noDataValues||[t.minHeight!=null?t.minHeight:-1e4],plainGridSize:t.plainGridSize||128,url:t.url!=null?t.url:`//api.mapbox.com/v4/mapbox.terrain-rgb/{z}/{x}/{y}.pngraw?access_token=${t.key||"<key>"}`,gridSizeByZoom:t.gridSizeByZoom||[64,32,16,8,8,8,16,16,16,32,32,32,32,32,32,64,64,64,32,32,16,8],...t}),this.equalizeNormals=t.equalizeNormals||!1,this._dataType="imageBitmap",this._imageSize=t.imageSize||256,this._ctx=this._createTemporalCanvas(this._imageSize),this._imageDataCache={},this._minHeight=t.minHeight||-1e4,this._resolution=t.resolution||.1}static checkNoDataValue(e,t){return t>5e4||Yr(e,t)!==-1}rgb2Height(e,t,s){return e===255?this._minHeight:this._minHeight+this._resolution*(256*e*256+256*t+s)}isBlur(e){return e.tileZoom>=16}_createTemporalCanvas(e){let t=document.createElement("canvas");return t.width=e,t.height=e,t.getContext("2d",{willReadFrequently:!0})}_createHeights(e,t,s,n,o,a,h,c){this._ctx.clearRect(0,0,this._imageSize,this._imageSize),this._ctx.drawImage(e,0,0);let d=this._ctx.getImageData(0,0,this._imageSize,this._imageSize).data;const u=e.width;let _=0,f=0,v=0,g=null,y=!1;if(t&&t.tileZoom>this.maxNativeZoom){let E=t.node;for(;E&&!E.segment.terrainExists;)E=E.parentNode;E&&(_=E.segment.tileX,f=E.segment.tileY,v=E.segment.tileZoom,g=E.segment.elevationData,y=v<=8)}if(!Xi(this._imageSize)&&u===this._imageSize){let E=new Float32Array(u*u);return this.extractElevationTilesRgbNonPowerOfTwo(d,E,this._heightFactor),E}if(this._imageSize===this.plainGridSize){let E=(this.plainGridSize+1)*(this.plainGridSize+1),L=new Float32Array(E),[S,P,R]=t?er(t.tileX,t.tileY,t.tileZoom,_,f,v):[0,0,0];return this.extractElevationSimple(d,this.noDataValues,g,S,P,R,y,L,this._heightFactor,this._imageSize),L}let p=(this.plainGridSize+1)*(this.plainGridSize+1),x=u/this.plainGridSize,T=new Float32Array(p),w=new Array(x);for(let E=0;E<x;E++){w[E]=[];for(let L=0;L<x;L++)w[E][L]=new Float32Array(p)}if(c)this.extractElevationTilesRgbNoChildren(d,this._heightFactor,this.noDataValues,g,_,f,v,t?t.tileX:0,t?t.tileY:0,t?t.tileZoom:0,y,T);else{this.extractElevationTilesRgb(d,this._heightFactor,this.noDataValues,g,_,f,v,t?t.tileX:0,t?t.tileY:0,t?t.tileZoom:0,y,T,w);for(let E=0;E<x;E++)for(let L=0;L<x;L++){let[S,P,R]=[2*n+L,2*o+E,a+1],M=It.getTileIndex(S,P,R,s);this.setElevationCache(M,{heights:w[E][L],extent:$e(S,P,R)})}}let C=It.getTileIndex(n,o,a,s);return this.setElevationCache(C,{heights:T,extent:h}),T}getHeightAsync(e,t,s){if((s=s??this.maxZoom)===0)return t(0),!0;const n=this._planet.quadTreeStrategy,[o,a,h,c]=n.getTileXY(e,s),[d,u]=n.getLonLatTileOffset(e,o,a,h,this._imageSize),_=4*(d*this._imageSize+u),f=It.getTileIndex(o,a,h,c);if(this._imageDataCache[f]){let g=this._imageDataCache[f],y=this._heightFactor*this.rgb2Height(g[_],g[_+1],g[_+2]);return Pt.checkNoDataValue(this.noDataValues,y)?this.getHeightAsync(e,t,s-1):(t(this._heightFactor*this.rgb2Height(g[_],g[_+1],g[_+2])),!0)}let v=this._fetchCache[f];return v||(v=this._loader.fetch({src:this._urlRewriteCallback&&this._urlRewriteCallback(o,a,h,c)||this.buildURL(o,a,h,c),type:this._dataType,options:{cache:this._cache}}),this._fetchCache[f]=v),v.then(g=>{if(g.status==="ready"){this._ctx.clearRect(0,0,this._imageSize,this._imageSize),this._ctx.drawImage(g.data,0,0);let y=this._ctx.getImageData(0,0,256,256).data;this._imageDataCache[f]=y;let p=this._heightFactor*this.rgb2Height(y[_],y[_+1],y[_+2]);if(Pt.checkNoDataValue(this.noDataValues,p))return this.getHeightAsync(e,t,s-1);t(this._heightFactor*this.rgb2Height(y[_],y[_+1],y[_+2]))}else{if(g.status==="error")return this.getHeightAsync(e,t,s-1);this._fetchCache[f]=null,delete this._fetchCache[f]}}),!1}extractElevationSimple(e,t,s=null,n,o,a,h,c,d=1,u){for(let f=0,v=u*u;f<v;f++){let g=f%u,y=Math.floor(f/u),p=4*f,x=d*this.rgb2Height(e[p],e[p+1],e[p+2]);(Pt.checkNoDataValue(t,x)||x===0)&&s&&(x=$t(a,n,o,s,y,g,h)),c[y*(u+1)+g]=x}for(let f=0,v=u;f<v;f++){let g=u-1,y=4*(f*u+g),p=d*this.rgb2Height(e[y],e[y+1],e[y+2]);(Pt.checkNoDataValue(t,p)||p===0)&&s&&(p=$t(a,n,o,s,f,g,h)),c[f*(u+1)+u]=p}for(let f=0,v=u;f<v;f++){let g=u-1,y=4*(g*u+f),p=d*this.rgb2Height(e[y],e[y+1],e[y+2]);(Pt.checkNoDataValue(t,p)||p===0)&&s&&(p=$t(a,n,o,s,g,f,h)),c[u*(u+1)+f]=p}let _=d*this.rgb2Height(e[e.length-4],e[e.length-3],e[e.length-2]);(Pt.checkNoDataValue(t,_)||_===0)&&s&&(_=$t(a,n,o,s,u-1,u-1,h)),c[c.length-1]=_}extractElevationTilesRgbNonPowerOfTwo(e,t,s=1){for(let n=0,o=t.length;n<o;n++){let a=4*n;t[n]=s*this.rgb2Height(e[a],e[a+1],e[a+2])}}extractElevationTilesRgb(e,t,s,n=null,o,a,h,c,d,u,_,f,v){let g=Math.sqrt(f.length)-1,y=g+1,p=Math.sqrt(e.length/4),x=p/g,T=0,w=0,C=0,[E,L,S]=er(c,d,u,o,a,h);for(let P=0,R=0,M=e.length/4;P<M;P++){let B=4*P,z=t*this.rgb2Height(e[B],e[B+1],e[B+2]),ue=Pt.checkNoDataValue(s,z),I=!1,se=!1,G=Math.floor(P/p),k=P%p;(ue||z===0)&&n&&(z=$t(S,E,L,n,Math.floor(G/x),Math.floor(k/x),_));let F=Math.floor(k/g),Ce=Math.floor(G/g),Mt=v[Ce][F],Je=G%g,Ot=k%g,bt=(Je+Ce)*y+Ot+F;if(Mt[bt]=z,(G+Ce)%x==0&&(k+F)%x==0&&(f[R++]=z),(k+1)%g==0&&k!==p-1){T=t*this.rgb2Height(e[B+4],e[B+5],e[B+6]),I=Pt.checkNoDataValue(s,T),(I||T===0)&&n&&(T=$t(S,E,L,n,Math.floor(G/x),Math.floor((k+1)/x),_));let Ne=z;ue||I||(Ne=.5*(z+T)),bt=(Je+Ce)*y+Ot+1,Mt[bt]=Ne,(G+Ce)%x==0&&(f[R++]=Ne);let Wt=(Je+Ce)*y+(Ot+1)%g;v[Ce][F+1][Wt]=Ne}if((G+1)%g==0&&G!==p-1){C=4*p,w=t*this.rgb2Height(e[B+C],e[B+C+1],e[B+C+2]),se=Pt.checkNoDataValue(s,w),(se||w===0)&&n&&(w=$t(S,E,L,n,Math.floor((G+1)/x),Math.floor(k/x),_));let Ne=.5*(z+w);ue||se||(Ne=.5*(z+w)),bt=(Je+1)*y+Ot+F,Mt[bt]=Ne,(k+F)%x==0&&(f[R++]=Ne);let Wt=(Je+1)%g*y+Ot+F;v[Ce+1][F][Wt]=Ne}if((k+1)%g==0&&k!==p-1&&(G+1)%g==0&&G!==p-1){let Ne=t*this.rgb2Height(e[B+C+4],e[B+C+5],e[B+C+6]),Wt=Pt.checkNoDataValue(s,Ne);(Wt||Ne===0)&&n&&(Ne=$t(S,E,L,n,Math.floor((G+1)/x),Math.floor((k+1)/x),_));let Nt=z;ue||I||se||Wt||(Nt=.25*(z+T+w+Ne)),bt=(Je+1)*y+(Ot+1),Mt[bt]=Nt,f[R++]=Nt;let mc=(Je+1)*y;v[Ce][F+1][mc]=Nt;let vc=g;v[Ce+1][F][vc]=Nt;let yc=0;v[Ce+1][F+1][yc]=Nt}}}extractElevationTilesRgbNoChildren(e,t,s,n=null,o,a,h,c,d,u,_,f){let v=Math.sqrt(f.length)-1,g=v+1,y=Math.sqrt(e.length/4),p=y/v,x=0,T=0,w=0,[C,E,L]=er(c,d,u,o,a,h);for(let S=0,P=0,R=e.length/4;S<R;S++){let M=4*S,B=t*this.rgb2Height(e[M],e[M+1],e[M+2]),z=Pt.checkNoDataValue(s,B),ue=!1,I=!1,se=Math.floor(S/y),G=S%y;(z||B===0)&&n&&(B=$t(L,C,E,n,Math.floor(P/g),P%g,_));let k=Math.floor(G/v),F=Math.floor(se/v);if((se+F)%p==0&&(G+k)%p==0&&(f[P++]=B),(G+1)%v==0&&G!==y-1){x=t*this.rgb2Height(e[M+4],e[M+5],e[M+6]),ue=Pt.checkNoDataValue(s,x),(ue||x===0)&&n&&(x=$t(L,C,E,n,Math.floor(P/g),P%g,_));let Ce=B;z||ue||(Ce=.5*(B+x)),(se+F)%p==0&&(f[P++]=Ce)}if((se+1)%v==0&&se!==y-1){w=4*y,T=t*this.rgb2Height(e[M+w],e[M+w+1],e[M+w+2]),I=Pt.checkNoDataValue(s,T),(I||T===0)&&n&&(T=$t(L,C,E,n,Math.floor(P/g),P%g,_));let Ce=.5*(B+T);z||I||(Ce=.5*(B+T)),(G+k)%p==0&&(f[P++]=Ce)}if((G+1)%v==0&&G!==y-1&&(se+1)%v==0&&se!==y-1){let Ce=t*this.rgb2Height(e[M+w+4],e[M+w+5],e[M+w+6]),Mt=Pt.checkNoDataValue(s,Ce);(Mt||Ce===0)&&n&&(Ce=$t(L,C,E,n,Math.floor(P/g),P%g,_));let Je=B;z||ue||I||Mt||(Je=.25*(B+x+T+Ce)),f[P++]=Je}}}}function er(l,e,t,s,n,o){let a=2<<t-o-1;return[l-a*s,e-a*n,1/a]}function $t(l,e,t,s,n,o,a){let h=Math.sqrt(s.length),c=s[Math.floor(t*l*h+n*l)*h+Math.floor(e*l*h+o*l)];return a&&c>0?0:c}const nc={[Ae]:"north",[Le]:"south"},oc=(l,e,t,s)=>{let n=nc[s];if(n)return`https://terrain.openglobus.org/poles/${n}/${t}/${l}/${e}.png`};class ac extends Pt{constructor(e,t){super(e||"GlobusEarthRgb",{maxNativeZoom:6,maxZoom:17,url:"https://{s}.terrain.openglobus.org/all/{z}/{x}/{y}.png",urlRewrite:oc,...t})}isReadyToLoad(e){return this._extent.overlaps(e.getExtentLonLat())}}Object.freeze(Object.defineProperty({__proto__:null,BilTerrain:Ge,EmptyTerrain:Ri,GlobusRgbTerrain:ac,GlobusTerrain:un,RgbTerrain:Pt},Symbol.toStringTag,{value:"Module"}));class lc extends Ei{constructor(e,t={}){super(e,t),this._sourceTexture=t.texture||null,t.texture&&(this._sourceReady=!0,this._sourceCreated=!0),this._frameWidth=t.frameWidth!=null?Ye(t.frameWidth):256,this._frameHeight=t.frameHeight!=null?Ye(t.frameHeight):256,this._animate=!0}get instanceName(){return"GeoTexture2d"}loadMaterial(e){this._planet._geoImageCreator.add(this)}bindTexture(e){this._sourceReady=!0,this._sourceCreated=!0,this._sourceTexture=e}setSize(e,t){this._frameWidth=e,this._frameHeight=t,this._frameCreated=!1}abortMaterialLoading(e){this._creationProceeding=!1,e.isLoading=!1,e.isReady=!1}}class hc extends Ei{constructor(e,t={}){super(e,t),this._animate=!0,this._video=t.videoElement||null,this._src=t.src||null}get instanceName(){return"GeoVideo"}setSrc(e){this._planet&&this._planet._geoImageCreator.remove(this),this._src=e,this._sourceReady=!1}setVideoElement(e){this._planet&&this._planet._geoImageCreator.remove(this),this._video=e,this._src=e.src,this._sourceReady=!1}setVisibility(e){e!=this._visibility&&(super.setVisibility(e),this._planet&&(e?(this._sourceReady&&this._planet._geoImageCreator.add(this),this._video&&this._video.play()):(this._sourceReady&&this._planet._geoImageCreator.remove(this),this._video&&this._video.pause())))}_createSourceTexture(){let e=this._planet.renderer.handler.gl;this._sourceCreated?(e.bindTexture(e.TEXTURE_2D,this._sourceTexture),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,this._video)):(this._sourceTexture=this._planet.renderer.handler.createTexture_n_webgl1(this._video),this._sourceCreated=!0)}_onCanPlay(e){this._frameWidth=e.videoWidth,this._frameHeight=e.videoHeight,e.width=e.videoWidth,e.height=e.videoHeight,e.play(),this._sourceReady=!0,this._planet._geoImageCreator.add(this)}_onError(e){let t="unknown error";switch(e.error.code){case 1:t="video loading aborted";break;case 2:t="network loading error";break;case 3:t="video decoding failed / corrupted data or unsupported codec";break;case 4:t="video not supported"}console.warn(`Error: ${t} error-code=${e.error.code})`)}loadMaterial(e){if(e.isLoading=!0,this._creationProceeding=!0,!this._sourceReady&&this._src){if(this._video){if(this._video.readyState===this._video.HAVE_ENOUGH_DATA)this._onCanPlay(this._video);else if(this._video.src){let t=this;this._video.addEventListener("canplay",function(s){t._onCanPlay(this)})}}else{this._video=document.createElement("video"),this._video.crossOrigin="Anonymous";let t=this;this._video.addEventListener("canplay",function(){t._onCanPlay(this)}),this._video.addEventListener("error",function(){t._onError(this)})}this._video.autoplay=!0,this._video.loop=!0,this._video.src=this._src,this._video.muted=!0,this._video.setAttribute("playsinline","true"),this._video.setAttribute("webkit-playsinline","true")}else this._planet._geoImageCreator.add(this)}abortMaterialLoading(e){this._video&&(this._video.src=""),this._creationProceeding=!1,e.isLoading=!1,e.isReady=!1}}class cc extends ut{constructor(e,t={}){super(e,t),this._billboard=t.billboard||{src:"https://openglobus.org/examples/billboards/carrot.png"},this._color=t.color||"#6689db"}get instanceName(){return"KML"}_extractCoordonatesFromKml(e){return Array.from(e.getElementsByTagName("coordinates")).map(t=>t.textContent.trim()).map(t=>t.replace(/\n/g," ").replace(/\t/g," ").replace(/ +/g," ").split(" ").map(s=>s.split(",").map(parseFloat)))}_AGBRtoRGBA(e){if(!e||e.length!=8)return;const t=parseInt(e.slice(0,2),16)/255,s=parseInt(e.slice(2,4),16),n=parseInt(e.slice(4,6),16);return`rgba(${parseInt(e.slice(6,8),16)},${n},${s},${t})`}_parseKMLcoordinates(e){return e.innerHTML.trim().replace(/\n/g," ").replace(/\t/g," ").replace(/ +/g," ").split(" ").map(t=>t.split(",").map(parseFloat))}_kmlPlacemarkToEntity(e,t){if(!e)return;const s=Array.from(e.getElementsByTagName("name")),n=s&&s.length>0?s[0].innerHTML.trim():"",{iconHeading:o,iconURL:a,iconColor:h,lineWidth:c,lineColor:d}=this._extractStyle(e),u=[];for(const _ of e.getElementsByTagName("coordinates")){const f=this._parseKMLcoordinates(_)||[[0,0,0]];for(const v of f){const[g,y,p]=v;u.push(new A(g,y,p)),g<t.southWest.lon&&(t.southWest.lon=g),y<t.southWest.lat&&(t.southWest.lat=y),g>t.northEast.lon&&(t.northEast.lon=g),y>t.northEast.lat&&(t.northEast.lat=y)}}if(u.length===1){const _=.01745329*o;return new V({name:n,lonlat:u[0],billboard:{src:a,size:[24,24],color:h,rotation:_},properties:{color:h,heading:o}})}return new V({name:n,polyline:{pathLonLat:[u],thickness:c,color:d,isClosed:!1},properties:{name:n}})}_extractStyle(e){let t,s,n,o,a;const h=e.getElementsByTagName("Style")[0];if(h){let c=h.getElementsByTagName("IconStyle")[0];if(c){let u=c.getElementsByTagName("color")[0];u&&(t=this._AGBRtoRGBA(u.innerHTML.trim()));let _=c.getElementsByTagName("heading")[0];if(_){const v=parseFloat(_.innerHTML.trim());v>=0&&v<=360&&(s=v%360)}let f=c.getElementsByTagName("Icon")[0];if(f){let v=f.getElementsByTagName("href")[0];v&&(n=v.innerHTML.trim())}}let d=h.getElementsByTagName("LineStyle")[0];if(d){let u=d.getElementsByTagName("color")[0];u&&(o=this._AGBRtoRGBA(u.innerHTML.trim()));let _=d.getElementsByTagName("width")[0];_!==void 0&&(a=parseFloat(_.innerHTML.trim()))}}return t||(t="#FFFFFF"),s||(s=0),n||(n="https://openglobus.org/examples/billboards/carrot.png"),o||(o="#FFFFFF"),a||(a=1),{iconHeading:s,iconURL:n,iconColor:t,lineWidth:a,lineColor:o}}_parseKML(e,t,s){if(s||(s=[]),e.documentElement.nodeName!=="kml")return s;for(const n of e.getElementsByTagName("Placemark")){const o=this._kmlPlacemarkToEntity(n,t);o&&s.push(o)}return s}_convertKMLintoEntities(e){const t=new H(new A(180,90),new A(-180,-90));return{entities:this._parseKML(e,t),extent:t}}_convertCoordonatesIntoEntities(e,t,s){const n=new H(new A(180,90),new A(-180,-90)),o=h=>{const c=h[0],d=h[1];c<n.southWest.lon&&(n.southWest.lon=c),d<n.southWest.lat&&(n.southWest.lat=d),c>n.northEast.lon&&(n.northEast.lon=c),d>n.northEast.lat&&(n.northEast.lat=d)},a=[];return e.forEach(h=>h.forEach(c=>a.push(c))),{entities:a.map(h=>{if(h.length===1){const c=h[0],d=new V({lonlat:c,billboard:s});return o(c),d}if(h.length>1){const c=h.map(d=>(o(d),new A(d[0],d[1],d[2])));return new V({polyline:{pathLonLat:[c],thickness:3,color:t,isClosed:!1}})}}),extent:n}}_getXmlContent(e){return new Promise(t=>{const s=new FileReader;s.onload=async n=>t(new DOMParser().parseFromString(n.target.result,"text/xml")),s.readAsText(e)})}_expandExtents(e,t){return e?(t.southWest.lon<e.southWest.lon&&(e.southWest.lon=t.southWest.lon),t.southWest.lat<e.southWest.lat&&(e.southWest.lat=t.southWest.lat),t.northEast.lon>e.northEast.lon&&(e.northEast.lon=t.northEast.lon),t.northEast.lat>e.northEast.lat&&(e.northEast.lat=t.northEast.lat),e):t}async addKmlFromFiles(e,t,s){if(!Array.isArray(e))return null;const n=(await Promise.all(e.map(this._getXmlContent))).map(this._extractCoordonatesFromKml),{entities:o,extent:a}=this._convertCoordonatesIntoEntities(n,t||this._color,s||this._billboard);return this._extent=this._expandExtents(this._extent,a),o.forEach(this.add.bind(this)),{entities:o,extent:a}}setColor(e){this._color=e,this._billboard.color=e}_getKmlFromUrl(e){return new Promise((t,s)=>{const n=new XMLHttpRequest;n.open("GET",e,!0),n.responseType="document",n.overrideMimeType("text/xml"),n.onload=()=>{n.readyState===n.DONE&&n.status===200?t(n.responseXML):s(new Error("no valid kml file"))},n.send()})}async addKmlFromUrl(e,t,s){const n=await this._getKmlFromUrl(e),{entities:o,extent:a}=this._convertKMLintoEntities(n);return this._extent=this._expandExtents(this._extent,a),o.forEach(this.add.bind(this)),{entities:o,extent:a}}}class dc extends Is{constructor(e,t={}){super(e||"OpenStreetMap",{iconSrc:"https://tile.openstreetmap.org/8/138/95.png",url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",attribution:"Data @ OpenStreetMap contributors, ODbL",isBaseLayer:!0,maxNativeZoom:19,defaultTextures:[{color:"#AAD3DF"},{color:"#F2EFE9"}],isSRGB:!1,shininess:18,specular:[63e-5,55e-5,32e-5],ambient:[.2,.2,.3],diffuse:[.9,.9,.7],...t})}}function uc(l,e,t){var s="";for(let a=t;a>0;a--){var n=0,o=1<<a-1;l&o&&n++,e&o&&(n+=2),s+=n.toString()}return s}class _c extends Is{constructor(e,t={}){super(e||"Bing",{iconSrc:"https://ecn.t0.tiles.virtualearth.net/tiles/a120.jpeg?n=z&g=7146",subdomains:["t0","t1","t2","t3"],url:"https://ecn.{s}.tiles.virtualearth.net/tiles/a{quad}.jpeg?n=z&g=7146",isBaseLayer:!0,textureFilter:"LINEAR",maxNativeZoom:17,defaultTextures:[{color:"#001522"},{color:"#E4E6F3"}],attribution:'<div style="transform: scale(0.8); margin-top:-2px;"><a href="https://www.bing.com" target="_blank"><img style="position: relative; top: 2px;" title="Bing Imagery" src="https://sandcastle.cesium.com/CesiumUnminified/Assets/Images/bing_maps_credit.png"></a> © 2021 Microsoft Corporation</div>',urlRewrite:(s,n)=>zt(n,{s:this._getSubdomain(),quad:uc(s.tileX,s.tileY,s.tileZoom)}),specular:[63e-5,55e-5,32e-5],ambient:[.35,.35,.35],diffuse:[1.5,1.5,1.5],shininess:20,nightTextureCoefficient:2.7,...t})}}Object.freeze(Object.defineProperty({__proto__:null,Bing:_c,CanvasTiles:es,GeoImage:wa,GeoTexture2d:lc,GeoVideo:hc,KML:cc,LAYER_EVENTS:Ho,Layer:It,Material:No,OpenStreetMap:dc,Vector:ut,WMS:pe,XYZ:Is},Symbol.toStringTag,{value:"Module"}));new Ur(3396200,3389508);new Ur(1737400,1737400);var be=(l=>(l[l.byte=5120]="byte",l[l.ubyte=5121]="ubyte",l[l.short=5122]="short",l[l.ushort=5123]="ushort",l[l.uint=5125]="uint",l[l.float=5126]="float",l))(be||{}),_e=(l=>(l.scalar="SCALAR",l.vec2="VEC2",l.vec3="VEC3",l.vec4="VEC4",l.mat2="MAT2",l.mat3="MAT3",l.mat4="MAT4",l))(_e||{}),Nr=(l=>(l[l.points=0]="points",l[l.lines=1]="lines",l[l.lineLoop=2]="lineLoop",l[l.lineStrip=3]="lineStrip",l[l.triangles=4]="triangles",l[l.triangleStrip=5]="triangleStrip",l[l.triangleFan=6]="triangleFan",l))(Nr||{});const enableGlobe=l=>{var e;if(l.shadowRoot){let t=l.shadowRoot.querySelector("#globe");t||(t=document.createElement("div"),t.id="globe",t.style.width="100%",t.style.height="100%",t.style.display="block",(e=l.renderRoot)==null||e.appendChild(t)),l.registerProjectionFromCode("EPSG:3857"),l.globe=window.eoxMapGlobe.create({EOxMap:l,target:t}),l.shadowRoot.querySelector("#map").style.display="none",l.globeEnabled=!0}},disableGlobe=l=>{if(l.globe){const e=l.globe,t=e.planet;let s=t.getCartesianFromPixelTerrain(e.renderer.handler.getCenter());const n=s?s.normal().scaleTo(s.length()+s.distance(t.camera.eye)):t.camera.eye;t.flyCartesian(n,{amplitude:0,completeCallback:()=>{s&&t.camera.look(s);const o=e.planet.camera.getLonLat(),a=Math.log2(2105e4/o.height)+1,h=[o.lon,o.lat],c=l.transform(h,"EPSG:4326",l.OLprojection);l.map.getView().setCenter(c),l.map.getView().setZoom(a),l.globe=null;const d=l.shadowRoot.querySelector("#globe");d&&(d.style.display="none",d.remove());const u=l.shadowRoot.querySelector("#map");u&&(u.style.display=""),l.globeEnabled=!1}})}};addCommonStylesheet();var ho,Or,Ds,co,uo,_o,fo,$a,Xa,Fs,Xt;class EOxMap extends i{constructor(){super();tt(this,ho);tt(this,Or);tt(this,Ds);tt(this,co);tt(this,uo);tt(this,_o);tt(this,fo);tt(this,$a,[0,0]);tt(this,Xa,0);tt(this,Fs,!1);tt(this,Xt,"EPSG:3857");this.map=new Map$1({controls:[],interactions:defaults({altShiftDragRotate:!1,pinchRotate:!1}),layers:[],view:new View({center:[0,0],zoom:0,projection:Ie(this,Xt)})}),this.interactions={},this.selectInteractions={},this.mapControls={},this.globe=null}static get properties(){return{map:{attribute:!1,state:!0},config:{attribute:!1,type:Object},center:{attribute:!1,type:Array},layers:{attribute:!1,type:Array},zoom:{attribute:!1,type:Number},animationOptions:{attribute:!1,type:Object},controls:{attribute:!1,type:Object},interactions:{attribute:!1,type:Object},lonLatCenter:{attribute:!1,type:Array},lonLatExtent:{attribute:!1,type:Array},mapControls:{attribute:!1,state:!0,type:Object},preventScroll:{attribute:"prevent-scroll",type:Boolean},projection:{attribute:"projection",type:String},selectInteractions:{attribute:!1,state:!0,type:Object},sync:{attribute:"sync",type:String},zoomExtent:{attribute:!1,type:Array}}}set center(t){const s=setCenterMethod(t,this);s!==void 0&&(pt(this,$a,s),animateToStateMethod(this))}get center(){return Ie(this,$a)}set config(t){pt(this,uo,setConfigMethod(t,this))}get config(){return Ie(this,uo)}get lonLatCenter(){return getLonLatCenterMethod(this)}get lonLatExtent(){return getLonLatExtentMethod(this)}set zoom(t){t!==void 0&&(pt(this,Xa,t),animateToStateMethod(this))}get zoom(){return Ie(this,Xa)}set zoomExtent(t){pt(this,ho,setZoomExtentMethod(t,this))}get zoomExtent(){return getZoomExtentMethod(this)}set controls(t){pt(this,Or,setControlsMethod(t,Ie(this,Or),this))}get controls(){return Ie(this,Or)}set layers(t){pt(this,Ds,setLayersMethod(t,Ie(this,Ds),this)),this.dispatchEvent(new CustomEvent("layerschanged",{detail:{layers:Ie(this,Ds)}}))}get layers(){return Ie(this,Ds)}set preventScroll(t){pt(this,co,setPreventScrollMethod(t,this))}get preventScroll(){return Ie(this,co)}set animationOptions(t){pt(this,_o,t)}get animationOptions(){return Ie(this,_o)}set projection(t){t==="globe"?(Ie(this,Xt)!=="EPSG:3857"&&pt(this,Xt,setProjectionMethod("EPSG:3857",Ie(this,Xt),this)),setTimeout(()=>{enableGlobe(this)})):(Ie(this,Fs)&&setTimeout(()=>{disableGlobe(this)}),pt(this,Xt,setProjectionMethod(t,Ie(this,Xt),this)))}get projection(){return Ie(this,Fs)?"globe":Ie(this,Xt)}get OLprojection(){return Ie(this,Xt)}get globeEnabled(){return Ie(this,Fs)}set globeEnabled(t){pt(this,Fs,t)}set sync(t){pt(this,fo,setSyncMethod(t,this))}get sync(){return Ie(this,fo)}addOrUpdateLayer(t){return addOrUpdateLayerMethod(t,this)}removeInteraction(t){removeInteractionMethod(t,this)}removeSelect(t){removeSelectMethod(t,this)}removeControl(t){removeControlMethod(t,this)}getLayerById(t){return getLayerById(this,t)}firstUpdated(){firstUpdatedMethod(Ie(this,ho),this)}parseFeature(t){return parseFeature(t)}parseTextToFeature(t,s,n,o,a){parseTextToFeature(t,s,n,o,a)}registerProjectionFromCode(t){return registerProjectionFromCode(t)}registerProjection(t,s,n=void 0){registerProjection(t,s,n)}getFlatLayersArray(t){return getFlatLayersArray(t)}render(){return b`
      <style>
        :host {
          display: block;
          height: 100%;
        }
        .eox-map-tooltip {
          pointer-events: none !important;
        }
        ${olCss}
        ${eoxStyle}
        ${controlCss}
      </style>
      <div id="map" style="width: 100%; height: 100%"></div>
      <slot></slot>
    `}}ho=new WeakMap,Or=new WeakMap,Ds=new WeakMap,co=new WeakMap,uo=new WeakMap,_o=new WeakMap,fo=new WeakMap,$a=new WeakMap,Xa=new WeakMap,Fs=new WeakMap,Xt=new WeakMap;customElements.define("eox-map",EOxMap);export{EOxMap,buffer,transform,transformExtent};

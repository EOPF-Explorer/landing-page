var me=Object.defineProperty;var de=(o,t,e)=>t in o?me(o,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[t]=e;var l=(o,t,e)=>de(o,typeof t!="symbol"?t+"":t,e);import{o as k,S as ge,L as j,r as fe,s as pe,t as Ce,u as _e,v as ye,R as ve,w as we,I as Se,V as z,x as Le,y as be,z as Ee,C as Pe,F as Te,H as Re,J as Ae,O as Q,P as w,Q as V,W as N,X as xe,Y as D,_ as Fe,$ as Oe,a0 as W,a1 as Me,a2 as q,a3 as J,a4 as Ie,a5 as Ge,a6 as ke,a7 as Ve,a8 as Z,a9 as Ne}from"../app.F8sUN9yU.js";let T,ee;function U(){if(T===void 0){const o=document.createElement("canvas");o.setAttribute("style","image-rendering: -moz-crisp-edges; image-rendering: crisp-edges; image-rendering: pixelated;");const t=o.style.imageRendering;T=!!t,T&&(ee=t)}return T}function De(){return U(),ee||""}function F(o){return o.get("olcs_projection")||o.getProjection()}let Ue=0;function y(o){return o.olcs_uid||(o.olcs_uid=++Ue)}function M(o){const t=o,e=t.readyPromise;return e||(t.ready!==void 0?t.ready?Promise.resolve(o):new Promise((i,s)=>{const n=setInterval(()=>{t.ready&&(clearInterval(n),i(o))},20)}):Promise.reject("Not a readyable object"))}function te(){const o=document.createElement("canvas");return o.width=1,o.height=1,o}class ze{constructor(t,e,i){l(this,"source_");l(this,"projection_");l(this,"fallbackProj_");l(this,"map_");l(this,"shouldRequestNextLevel");l(this,"emptyCanvas_",te());l(this,"emptyCanvasPromise_",Promise.resolve(this.emptyCanvas_));l(this,"tilingScheme_");l(this,"ready_");l(this,"rectangle_");l(this,"errorEvent",new Cesium.Event);l(this,"credit");l(this,"proxy");this.source_=e,this.projection_=null,this.ready_=!1,this.fallbackProj_=i||null,this.tilingScheme_=new Cesium.WebMercatorTilingScheme,this.rectangle_=null,this.map_=t,this.shouldRequestNextLevel=!1;const s=this.source_.get("olcs_proxy");s&&(typeof s=="function"?this.proxy={getURL:s}:typeof s=="string"&&(this.proxy=new Cesium.DefaultProxy(s))),this.source_.on("change",n=>{this.handleSourceChanged_()}),this.handleSourceChanged_()}get ready(){return this.ready_}get rectangle(){return this.rectangle_}get tilingScheme(){return this.tilingScheme_}get _ready(){return this.ready_}get tileWidth(){const t=this.source_.getTileGrid();if(t){const e=t.getTileSize(0);return Array.isArray(e)?e[0]:e}return 256}get tileHeight(){const t=this.source_.getTileGrid();if(t){const e=t.getTileSize(0);return Array.isArray(e)?e[1]:e}return 256}get maximumLevel(){const t=this.source_.getTileGrid();return t?t.getMaxZoom():18}get minimumLevel(){return 0}get tileDiscardPolicy(){}get hasAlphaChannel(){return!0}pickFeatures(t,e,i,s,n){}handleSourceChanged_(){if(!this.ready_&&this.source_.getState()=="ready"){this.projection_=F(this.source_)||this.fallbackProj_;const t={numberOfLevelZeroTilesX:1,numberOfLevelZeroTilesY:1};if(this.source_.getTileGrid()!==null&&this.source_.getTileGrid().forEachTileCoord(this.projection_.getExtent(),0,([e,i,s])=>{t.numberOfLevelZeroTilesX=i+1,t.numberOfLevelZeroTilesY=s+1}),this.projection_.getCode()==="EPSG:4326")this.shouldRequestNextLevel=t.numberOfLevelZeroTilesX===1&&t.numberOfLevelZeroTilesY===1,this.tilingScheme_=new Cesium.GeographicTilingScheme(t);else if(this.projection_.getCode()==="EPSG:3857")this.shouldRequestNextLevel=!1,this.tilingScheme_=new Cesium.WebMercatorTilingScheme(t);else return;this.rectangle_=this.tilingScheme_.rectangle,this.ready_=!0}}getTileCredits(t,e,i){const s=this.source_.getAttributions();if(!s)return[];const n=this.map_.getView().calculateExtent(this.map_.getSize()),r=this.map_.getView().getCenter(),a=this.shouldRequestNextLevel?i+1:i;return ae(s,a,r,n)}requestImage(t,e,i,s){const n=this.source_.getTileUrlFunction();if(n&&this.projection_){const r=this.shouldRequestNextLevel?i+1:i;let a=n.call(this.source_,[r,t,e],1,this.projection_);return this.proxy&&(a=this.proxy.getURL(a)),a?Cesium.ImageryProvider.loadImage(this,a):this.emptyCanvasPromise_}else return this.emptyCanvasPromise_}}const He=new Ce({featureClass:ve}),Ke=[new ge({stroke:new ye({color:"blue",width:2})})];class Be{constructor(t){l(this,"urls");l(this,"emptyCanvas_",te());l(this,"emptyCanvasPromise_",Promise.resolve(this.emptyCanvas_));l(this,"tilingScheme_",new Cesium.WebMercatorTilingScheme);l(this,"ready_",!0);l(this,"rectangle_");l(this,"tileRectangle_");l(this,"tileWidth",256);l(this,"tileHeight",256);l(this,"maximumLevel",20);l(this,"minimumLevel_",0);l(this,"featureCache");l(this,"tileCache");l(this,"tileFunction_");l(this,"styleFunction_");l(this,"projection_",k("EPSG:3857"));l(this,"errorEvent",new Cesium.Event);l(this,"credit");l(this,"proxy");this.urls=t.urls,this.rectangle_=t.rectangle||this.tilingScheme.rectangle,this.credit=t.credit,this.styleFunction_=t.styleFunction||(()=>Ke),this.tileRectangle_=new Cesium.Rectangle;const e=t.cacheSize!==void 0?t.cacheSize:50;this.tileCache=new j(e),this.featureCache=t.featureCache||new j(e),this.minimumLevel_=t.minimumLevel||0;const i=fe(this.projection_);this.tileFunction_=pe(this.urls,i)}get minimumLevel(){return this.minimumLevel_}get ready(){return this.ready_}get rectangle(){return this.rectangle_}get tilingScheme(){return this.tilingScheme_}getTileCredits(t,e,i){return[]}get _ready(){return this.ready_}get tileDiscardPolicy(){}get hasAlphaChannel(){return!0}pickFeatures(t,e,i,s,n){}getTileFeatures(t,e,i){const s=this.getCacheKey_(t,e,i);let n;if(this.featureCache.containsKey(s)&&(n=this.featureCache.get(s)),!n){const r=this.getUrl_(t,e,i);if(n=fetch(r).then(a=>a.ok?a:Promise.reject(a)).then(a=>a.arrayBuffer()).then(a=>this.readFeaturesFromBuffer(a)),this.featureCache.set(s,n),this.featureCache.getCount()>2*this.featureCache.highWaterMark)for(;this.featureCache.canExpireCache();)this.featureCache.pop()}return n}readFeaturesFromBuffer(t){const e=He.readFeatures(t),i=this.tileWidth/4096;return e.forEach(s=>{const n=s.getFlatCoordinates();for(let r=0;r<n.length;++r)n[r]*=i}),e}getUrl_(t,e,i){return this.tileFunction_([t,e,i],1,this.projection_)}getCacheKey_(t,e,i){return`${t}_${e}_${i}`}requestImage(t,e,i,s){if(i<this.minimumLevel_)return this.emptyCanvasPromise_;try{const n=this.getCacheKey_(i,t,e);let r;if(this.tileCache.containsKey(n)&&(r=this.tileCache.get(n)),!r&&(r=this.getTileFeatures(i,t,e).then(a=>{this.tilingScheme.tileXYToNativeRectangle(t,e,i,this.tileRectangle_);const c=(this.tileRectangle_.east-this.tileRectangle_.west)/this.tileWidth;return this.rasterizeFeatures(a,this.styleFunction_,c)}),this.tileCache.set(n,r),this.tileCache.getCount()>2*this.tileCache.highWaterMark))for(;this.tileCache.canExpireCache();)this.tileCache.pop();return r}catch(n){console.trace(n),this.errorEvent.raiseEvent("could not render pbf to tile",n)}}rasterizeFeatures(t,e,i){const s=document.createElement("canvas"),n=_e(s.getContext("2d"),{size:[this.tileWidth,this.tileHeight]});return t.forEach(r=>{const a=e(r,i);a&&(Array.isArray(a)?a.forEach(c=>{n.setStyle(c),n.drawGeometry(r)}):(n.setStyle(a),n.drawGeometry(r)))}),s}}function je(o,t){const e=o.camera,i=o.canvas,s=e.frustum,n=Cesium.Cartesian3.magnitude(Cesium.Cartesian3.subtract(e.position,t,new Cesium.Cartesian3));return s.getPixelDimensions(i.clientWidth,i.clientHeight,n,o.pixelRatio,new Cesium.Cartesian2)}function Ct(o,t,e){const i=je(o,t),s=Cesium.Transforms.eastNorthUpToFixedFrame(t),n=Cesium.Matrix4.multiplyByPoint(s,new Cesium.Cartesian3(-i.x*e,-i.y*e,0),new Cesium.Cartesian3),r=Cesium.Matrix4.multiplyByPoint(s,new Cesium.Cartesian3(i.x*e,i.y*e,0),new Cesium.Cartesian3);return Cesium.Ellipsoid.WGS84.cartesianArrayToCartographicArray([n,r])}function _t(o,t){o.applyTransform((e,i,s)=>{if(console.assert(e===i),s!==void 0&&s>=3)for(let n=0;n<i.length;n+=s)i[n+2]=i[n+2]+t;return i})}function yt(o,t=0,e=Cesium.Cartesian3.ZERO,i=new Cesium.Cartesian3(1,1,1)){const s=L(o),n=Cesium.Transforms.eastNorthUpToFixedFrame(s),r=Cesium.Quaternion.fromAxisAngle(Cesium.Cartesian3.UNIT_Z,-t),a=Cesium.Matrix4.fromTranslationQuaternionRotationScale(e,r,i);return Cesium.Matrix4.multiply(n,a,new Cesium.Matrix4)}function H(o,t,e,i,s){const n=Cesium.Math.clamp,r=Cesium.defaultValue,a=s,c=r(a==null?void 0:a.duration,500),h=r(a==null?void 0:a.easing,Le),m=a==null?void 0:a.callback;let u=0;const d=new Cesium.Matrix4,g=Date.now(),f=function(){const C=Date.now()-g,_=h(n(C/c,0,1));console.assert(_>=u),o.transform.clone(d);const v=(_-u)*t;u=_,o.lookAtTransform(i),o.rotate(e,v),o.lookAtTransform(d),_<1?window.requestAnimationFrame(f):m&&m()};window.requestAnimationFrame(f)}function ie(o,t,e,i){const s=o.camera,n=re(o,e),r=s.right,a=Cesium.Quaternion.fromAxisAngle(r,n),c=Cesium.Matrix3.fromQuaternion(a),h=new Cesium.Cartesian3;Cesium.Cartesian3.subtract(s.position,e,h);const m=new Cesium.Cartesian3;Cesium.Matrix3.multiplyByVector(c,h,m),Cesium.Cartesian3.add(m,e,m);const u=Cesium.Matrix4.fromTranslation(m);H(s,t,m,u,i)}function se(o,t){const e=o.camera.getPickRay(t);return o.globe.pick(e,o)||o.camera.pickEllipsoid(t)}function K(o){const t=o.canvas,e=new Cesium.Cartesian2(t.clientWidth/2,t.clientHeight);return se(o,e)}function We(o){const t=o.canvas,e=new Cesium.Cartesian2(t.clientWidth/2,t.clientHeight/2);return se(o,e)}function qe(o){const t=o.camera,e=new Cesium.Ray(t.position,t.direction);let i=o.globe.pick(e,o);if(!i){const a=Cesium.Ellipsoid.WGS84,c=Cesium.IntersectionTests.rayEllipsoid(e,a);c&&(i=Cesium.Ray.getPoint(e,c.start))}if(!i)return;const s=new Cesium.Cartesian3;Cesium.Ellipsoid.WGS84.geocentricSurfaceNormal(i,s);const r=ne(t.direction,s,t.right)-Math.PI;return Cesium.Math.convertLongitudeRange(r)}function Ze(o){const t=o.camera,e=t.frustum.fovy/2,i=t.direction,s=Cesium.Quaternion.fromAxisAngle(t.right,e),n=Cesium.Matrix3.fromQuaternion(s),r=new Cesium.Cartesian3;return Cesium.Matrix3.multiplyByVector(n,i,r),new Cesium.Ray(t.position,r)}function ne(o,t,e){const i=new Cesium.Cartesian3,s=new Cesium.Cartesian3,n=new Cesium.Cartesian3;Cesium.Cartesian3.normalize(o,i),Cesium.Cartesian3.normalize(t,s),Cesium.Cartesian3.cross(i,s,n);const r=Cesium.Cartesian3.dot(i,s),a=Cesium.Cartesian3.magnitude(n),c=Cesium.Cartesian3.dot(e,n),h=Math.atan2(a,r);return c>=0?h:-h}function re(o,t){const e=o.camera,i=e.frustum.fovy/2,s=Ze(o),n=Cesium.Cartesian3.clone(s.direction);Cesium.Cartesian3.negate(n,n);const r=new Cesium.Cartesian3;Cesium.Ellipsoid.WGS84.geocentricSurfaceNormal(t,r);const a=new Cesium.Cartesian3;return Cesium.Cartesian3.negate(e.right,a),ne(r,n,a)+i}function oe(o,t){if(o&&t){const e=be(o,t,"EPSG:4326");return Cesium.Rectangle.fromDegrees(e[0],e[1],e[2],e[3])}else return null}function Ye(o,t,e,i){const s=t.get("olcs_skip");if(s)return null;let n=null;if(t instanceof Ee&&t.getUrl()){const r={olcs_proxy:t.get("olcs_proxy"),olcs_extent:t.get("olcs_extent"),olcs_projection:t.get("olcs_projection"),"olcs.imagesource":t},a=t.getImageLoadFunction(),c=t.get("olcs_tileLoadFunction")||function(m,u){a(m,u)};t=new Pe({url:t.getUrl(),attributions:t.getAttributions(),projection:t.getProjection(),tileLoadFunction:c,params:t.getParams()}),t.setProperties(r)}if(t instanceof Te){let r=F(t);if(r||(r=e),X(r))n=new ze(o,t,e);else return null}else if(t instanceof Re){let r=F(t);if(r||(r=e),X(r)){const a=Cesium.Rectangle.fromDegrees(t.getImageExtent()[0],t.getImageExtent()[1],t.getImageExtent()[2],t.getImageExtent()[3],new Cesium.Rectangle);n=new Cesium.SingleTileImageryProvider({url:t.getUrl(),rectangle:a})}else return null}else if(t instanceof Ae&&i instanceof z){let r=F(t);if(r||(r=e),s===!1){const a=r.getCode().split(":")[1],c=t.urls.map(p=>p.replace(a,"3857")),h=i.getExtent(),m=oe(h,r),u=t.get("olcs_minimumLevel"),d=t.getAttributions(),g=i.getStyleFunction();let f;if(h&&d){const p=Q(h);f=ae(d,0,p,h)[0]}return n=new Be({credit:f,rectangle:m,minimumLevel:u,styleFunction:g,urls:c}),n}return null}else return null;return n}function $e(o,t,e){if(!(t instanceof we)&&!(t instanceof Se)&&!(t instanceof z))return null;const i=t.getSource();if(!i)return null;let s=i.get("olcs_provider");if(s||(s=Ye(o,i,e,t)),!s)return null;const n={},a=t.get("olcs_extent")||t.getExtent();return a&&(n.rectangle=oe(a,e)),new Cesium.ImageryLayer(s,n)}function Y(o,t){let e=1,i=!0;[o.layer].concat(o.parents).forEach(s=>{const n=s.getOpacity();n!==void 0&&(e*=n);const r=s.getVisible();r!==void 0&&(i=i&&r)}),t.alpha=e,t.show=i}function L(o){const t=o;return t.length>2?Cesium.Cartesian3.fromDegrees(t[0],t[1],t[2]):Cesium.Cartesian3.fromDegrees(t[0],t[1])}function I(o){console.assert(o!==null);const t=L,e=[];for(let i=0;i<o.length;++i)e.push(t(o[i]));return e}function R(o,t){console.assert(t);const e=k("EPSG:4326"),i=k(t);if(i.getCode()!==e.getCode()){const s=o.getProperties();o=o.clone(),o.transform(i,e),o.setProperties(s)}return o}function $(o){if(o=o||"black",Array.isArray(o))return new Cesium.Color(Cesium.Color.byteToFloat(o[0]),Cesium.Color.byteToFloat(o[1]),Cesium.Color.byteToFloat(o[2]),o[3]);if(typeof o=="string")return Cesium.Color.fromCssColorString(o);if(o instanceof CanvasPattern||o instanceof CanvasGradient){const t=document.createElement("canvas"),e=t.getContext("2d");return t.width=t.height=256,e.fillStyle=o,e.fillRect(0,0,t.width,t.height),new Cesium.ImageMaterialProperty({image:t})}console.assert(!1,"impossible")}function vt(o){let t="";const e=/\{(\d|[a-z])-(\d|[a-z])\}/,i=e.exec(o);if(i){o=o.replace(e,"{s}");const s=i[1].charCodeAt(0),n=i[2].charCodeAt(0);let r;for(r=s;r<=n;++r)t+=String.fromCharCode(r)}return{url:o,subdomains:t}}function Xe(o,t){return new Promise((e,i)=>{const s=t.camera,n=K(t);if(!n){i("Could not get bottom pivot");return}const r=o.getView().getRotation();if(r===void 0){i("The view is not initialized");return}const a=re(t,n);ie(t,r,n);const c=Cesium.Matrix4.fromTranslation(n),h=s.right,m={callback:()=>{const u=o.getView();Je(u),e(void 0)}};H(s,-a,h,c,m)})}function Qe(o,t){return new Promise((e,i)=>{const s=o.camera,n=K(o);if(!n){i("could not get bottom pivot");return}const r={callback:()=>e(void 0)},a=Cesium.Matrix4.fromTranslation(n),c=s.right;H(s,-t,c,a,r)})}function Je(o,t=0){const e=o.getResolution();o.setRotation(t),o.constrainResolution?o.setResolution(o.constrainResolution(e)):o.setResolution(o.getConstrainedResolution(e))}function X(o){const t=o.getCode()==="EPSG:3857",e=o.getCode()==="EPSG:4326";return t||e}function ae(o,t,e,i){if(!o)return[];let s=o({viewState:{zoom:t,center:e,projection:void 0,resolution:void 0,rotation:void 0},extent:i});return Array.isArray(s)||(s=[s]),s.map(n=>new Cesium.Credit(n,!0))}function et(o,t,e,i){const s=e.canvas,r=e.camera.frustum.fovy;console.assert(!isNaN(r));const a=i.getMetersPerUnit(),c=o*s.clientHeight,h=Math.cos(Math.abs(t));return c*a*h/2/Math.tan(r/2)}function tt(o,t,e,i){const s=e.canvas,r=e.camera.frustum.fovy;console.assert(!isNaN(r));const a=i.getMetersPerUnit(),c=2*o*Math.tan(r/2),h=Math.cos(Math.abs(t));return c/a/h/s.clientHeight}function it(o,t,e){let i=!1;return function(){if(!i){const s=o.position,n=Cesium.Cartographic.fromCartesian(s);if(Cesium.Cartesian3.distance(t.center,s)>t.radius*e(n.height)){if(o.flying===!0)return;{i=!0;const a=()=>i=!1;o.flyToBoundingSphere(t,{complete:a,cancel:a})}}}}}class st{constructor(t){l(this,"ol3d");l(this,"scene_");l(this,"canvas_");l(this,"_boundNotifyRepaintRequired");l(this,"repaintEventNames_",["mousemove","mousedown","mouseup","touchstart","touchend","touchmove","pointerdown","pointerup","pointermove","wheel"]);this.ol3d=t,this.scene_=t.getCesiumScene(),this.canvas_=this.scene_.canvas,this._boundNotifyRepaintRequired=this.notifyRepaintRequired.bind(this),this.enable()}enable(){this.scene_.requestRenderMode=!0,this.scene_.maximumRenderTimeChange=1e3;for(const t of this.repaintEventNames_)this.canvas_.addEventListener(t,this._boundNotifyRepaintRequired,!1);window.addEventListener("resize",this._boundNotifyRepaintRequired,!1),this.ol3d.getOlMap().getLayerGroup().on("change",this._boundNotifyRepaintRequired)}disable(){for(const t of this.repaintEventNames_)this.canvas_.removeEventListener(t,this._boundNotifyRepaintRequired,!1);window.removeEventListener("resize",this._boundNotifyRepaintRequired,!1),this.ol3d.getOlMap().getLayerGroup().un("change",this._boundNotifyRepaintRequired),this.scene_.requestRenderMode=!1}restartRenderLoop(){this.notifyRepaintRequired()}notifyRepaintRequired(){this.scene_.isDestroyed()||this.scene_.requestRender()}}function A(o){return o*180/Math.PI}function b(o){return o*Math.PI/180}function x(o,t,e){const i=e||o.length;if(t)for(let s=0;s<i;++s)t[s]=o[s];return o}class nt{constructor(t,e){l(this,"scene_");l(this,"cam_");l(this,"map_");l(this,"view_");l(this,"viewListenKey_",null);l(this,"toLonLat_",x);l(this,"fromLonLat_",x);l(this,"tilt_",0);l(this,"distance_",0);l(this,"lastCameraViewMatrix_",null);l(this,"viewUpdateInProgress_",!1);this.scene_=t,this.cam_=t.camera,this.map_=e,this.map_.on("change:view",i=>{this.setView_(this.map_.getView())}),this.setView_(this.map_.getView())}destroy(){w(this.viewListenKey_),this.viewListenKey_=null}setView_(t){if(w(this.viewListenKey_),this.viewListenKey_=null,this.view_=t,t){const e=V(t.getProjection(),"EPSG:4326"),i=V("EPSG:4326",t.getProjection());console.assert(e&&i),this.toLonLat_=e,this.fromLonLat_=i,this.viewListenKey_=t.on("propertychange",s=>this.handleViewChangedEvent_()),this.readFromView()}else this.toLonLat_=x,this.fromLonLat_=x}handleViewChangedEvent_(){this.viewUpdateInProgress_||this.readFromView()}setHeading(t){this.view_&&this.view_.setRotation(t)}getHeading(){return this.view_?this.view_.getRotation()||0:void 0}setTilt(t){this.tilt_=t,this.updateCamera_()}getTilt(){return this.tilt_}setDistance(t){this.distance_=t,this.updateCamera_(),this.updateView()}getDistance(){return this.distance_}setCenter(t){this.view_&&this.view_.setCenter(t)}getCenter(){if(this.view_)return this.view_.getCenter()}setPosition(t){if(!this.toLonLat_)return;const e=this.toLonLat_(t);console.assert(e);const i=new Cesium.Cartographic(b(e[0]),b(e[1]),this.getAltitude());this.cam_.setView({destination:Cesium.Ellipsoid.WGS84.cartographicToCartesian(i)}),this.updateView()}getPosition(){if(!this.fromLonLat_)return;const t=Cesium.Ellipsoid.WGS84.cartesianToCartographic(this.cam_.position),e=this.fromLonLat_([A(t.longitude),A(t.latitude)]);return console.assert(e),e}setAltitude(t){const e=Cesium.Ellipsoid.WGS84.cartesianToCartographic(this.cam_.position);e.height=t,this.cam_.position=Cesium.Ellipsoid.WGS84.cartographicToCartesian(e),this.updateView()}getAltitude(){return Cesium.Ellipsoid.WGS84.cartesianToCartographic(this.cam_.position).height}updateCamera_(){if(!this.view_||!this.toLonLat_)return;const t=this.view_.getCenter();if(!t)return;const e=this.toLonLat_(t);console.assert(e);const i=new Cesium.Cartographic(b(e[0]),b(e[1]));if(this.scene_.globe){const r=this.scene_.globe.getHeight(i);i.height=r||0}const s=Cesium.Ellipsoid.WGS84.cartographicToCartesian(i),n={pitch:this.tilt_-Cesium.Math.PI_OVER_TWO,heading:-this.view_.getRotation(),roll:void 0};this.cam_.setView({destination:s,orientation:n}),this.cam_.moveBackward(this.distance_),this.checkCameraChange(!0)}readFromView(){if(!this.view_||!this.toLonLat_)return;const t=this.view_.getCenter();if(t==null)return;const e=this.toLonLat_(t);console.assert(e);const i=this.view_.getResolution();this.distance_=this.calcDistanceForResolution(i||0,b(e[1])),this.updateCamera_()}updateView(){if(!this.view_||!this.fromLonLat_)return;this.viewUpdateInProgress_=!0;const t=Cesium.Ellipsoid.WGS84,e=this.scene_,i=We(e);let s=i;if(!s){const r=e.globe,a=this.cam_.positionCartographic.clone(),c=r.getHeight(a);a.height=c||0,s=Cesium.Ellipsoid.WGS84.cartographicToCartesian(a)}this.distance_=Cesium.Cartesian3.distance(s,this.cam_.position);const n=t.cartesianToCartographic(s);if(this.view_.setCenter(this.fromLonLat_([A(n.longitude),A(n.latitude)])),this.view_.setResolution(this.calcResolutionForDistance(this.distance_,n?n.latitude:0)),i){const r=this.cam_.position,a=new Cesium.Cartesian3;t.geocentricSurfaceNormal(i,a);const c=new Cesium.Cartesian3;Cesium.Cartesian3.subtract(r,i,c),Cesium.Cartesian3.normalize(c,c);const h=this.cam_.up,m=this.cam_.right,u=new Cesium.Cartesian3(-i.y,i.x,0),d=Cesium.Cartesian3.angleBetween(m,u),f=Cesium.Cartesian3.cross(i,h,new Cesium.Cartesian3).z;this.view_.setRotation(f<0?d:-d);const p=Math.acos(Cesium.Cartesian3.dot(a,c));this.tilt_=isNaN(p)?0:p}else this.view_.setRotation(this.cam_.heading),this.tilt_=-this.cam_.pitch+Math.PI/2;setTimeout(()=>this.viewUpdateInProgress_=!1,1e3)}checkCameraChange(t){const e=this.lastCameraViewMatrix_,i=this.cam_.viewMatrix;(!e||!Cesium.Matrix4.equalsEpsilon(e,i,1e-7))&&(this.lastCameraViewMatrix_=i.clone(),t!==!0&&this.updateView())}calcDistanceForResolution(t,e){return et(t,e,this.scene_,this.view_.getProjection())}calcResolutionForDistance(t,e){return tt(t,e,this.scene_,this.view_.getProjection())}}class ce{constructor(t,e){l(this,"map");l(this,"view");l(this,"scene");l(this,"olLayers");l(this,"mapLayerGroup");l(this,"layerMap",{});l(this,"olLayerListenKeys",{});l(this,"olGroupListenKeys_",{});this.map=t,this.view=t.getView(),this.scene=e,this.olLayers=t.getLayerGroup().getLayers(),this.mapLayerGroup=t.getLayerGroup()}synchronize(){this.destroyAll(),this.addLayers_(this.mapLayerGroup)}orderLayers(){}addLayers_(t){const e=[{layer:t,parents:[]}];for(;e.length>0;){const i=e.splice(0,1)[0],s=i.layer,n=y(s).toString();this.olLayerListenKeys[n]=[],console.assert(!this.layerMap[n]);let r=null;if(s instanceof N)this.listenForGroupChanges_(s),s!==this.mapLayerGroup&&(r=this.createSingleLayerCounterparts(i)),r||s.getLayers().forEach(a=>{if(a){const c={layer:a,parents:s===this.mapLayerGroup?[]:[i.layer].concat(i.parents)};e.push(c)}});else if(r=this.createSingleLayerCounterparts(i),!r){const a=n,c=i,h=()=>{const m=this.createSingleLayerCounterparts(c);m&&(c.layer.un("change",h),this.addCesiumObjects_(m,a,c.layer),this.orderLayers())};this.olLayerListenKeys[n].push(c.layer.on("change",h))}r&&this.addCesiumObjects_(r,n,s)}this.orderLayers()}addCesiumObjects_(t,e,i){this.layerMap[e]=t,this.olLayerListenKeys[e].push(i.on("change:zIndex",()=>this.orderLayers())),t.forEach(s=>{this.addCesiumObject(s)})}removeAndDestroySingleLayer_(t){const e=y(t).toString(),i=this.layerMap[e];return i&&(i.forEach(s=>{this.removeSingleCesiumObject(s,!1),this.destroyCesiumObject(s)}),this.olLayerListenKeys[e].forEach(w),delete this.olLayerListenKeys[e]),delete this.layerMap[e],!!i}unlistenSingleGroup_(t){if(t===this.mapLayerGroup)return;const e=y(t).toString();this.olGroupListenKeys_[e].forEach(s=>{w(s)}),delete this.olGroupListenKeys_[e],delete this.layerMap[e]}removeLayer_(t){if(t){const e=[t];for(;e.length>0;){const i=e.splice(0,1)[0],s=this.removeAndDestroySingleLayer_(i);i instanceof N&&(this.unlistenSingleGroup_(i),s||i.getLayers().forEach(n=>{e.push(n)}))}}}listenForGroupChanges_(t){const e=y(t).toString();console.assert(this.olGroupListenKeys_[e]===void 0);const i=[];this.olGroupListenKeys_[e]=i;let s=[];const n=(function(){const r=t.getLayers();r&&(s=[r.on("add",a=>{this.addLayers_(a.element)}),r.on("remove",a=>{this.removeLayer_(a.element)})],i.push(...s))}).bind(this);n(),i.push(t.on("change:layers",r=>{s.forEach(a=>{const c=i.indexOf(a);c>=0&&i.splice(c,1),w(a)}),n()}))}destroyAll(){this.removeAllCesiumObjects(!0);let t;for(t in this.olGroupListenKeys_)this.olGroupListenKeys_[t].forEach(w);for(t in this.olLayerListenKeys)this.olLayerListenKeys[t].forEach(w);this.olGroupListenKeys_={},this.olLayerListenKeys={},this.layerMap={}}}class rt extends ce{constructor(e,i){super(e,i);l(this,"cesiumLayers_");l(this,"ourLayers_");this.cesiumLayers_=i.imageryLayers,this.ourLayers_=new Cesium.ImageryLayerCollection}addCesiumObject(e){this.cesiumLayers_.add(e),this.ourLayers_.add(e)}destroyCesiumObject(e){e.destroy()}removeSingleCesiumObject(e,i){this.cesiumLayers_.remove(e,i),this.ourLayers_.remove(e,!1)}removeAllCesiumObjects(e){for(let i=0;i<this.ourLayers_.length;++i)this.cesiumLayers_.remove(this.ourLayers_.get(i),e);this.ourLayers_.removeAll(!1)}convertLayerToCesiumImageries(e,i){const s=$e(this.map,e,i);return s?[s]:null}createSingleLayerCounterparts(e){const i=e.layer,s=y(i).toString(),n=this.view.getProjection();console.assert(n);const r=this.convertLayerToCesiumImageries(i,n);if(r){const a=[];if([e.layer].concat(e.parents).forEach(c=>{a.push(c.on(["change:opacity","change:visible"],()=>{console.assert(r);for(let h=0;h<r.length;++h)Y(e,r[h])}))}),i instanceof xe){let c=i.getStyleFunction();a.push(i.on("change",()=>{var m;const h=i.getStyleFunction();if(c!==h){c=h;for(let u=0;u<r.length;++u){const d=r[u];d._imageryCache&&(d._imageryCache={});const g=d.imageryProvider;g&&((m=g.tileCache)==null||m.clear(),g.styleFunction_=h)}this.scene.requestRender()}}))}for(let c=0;c<r.length;++c)Y(e,r[c]);a.push(i.on("change:extent",c=>{for(let h=0;h<r.length;++h)this.cesiumLayers_.remove(r[h],!0),this.ourLayers_.remove(r[h],!1);delete this.layerMap[y(i)],this.synchronize()})),a.push(i.on("change",c=>{for(let h=0;h<r.length;++h){const m=this.cesiumLayers_.indexOf(r[h]);m>=0&&(this.cesiumLayers_.remove(r[h],!1),this.cesiumLayers_.add(r[h],m))}})),this.olLayerListenKeys[s].push(...a)}return Array.isArray(r)?r:null}orderLayers(){const e=[],i={},s=[this.mapLayerGroup];for(;s.length>0;){const n=s.splice(0,1)[0];if(e.push(n),i[y(n)]=n.getZIndex()||0,n instanceof N){const r=n.getLayers();r&&s.unshift(...r.getArray())}}e.sort((n,r)=>i[y(n)]-i[y(r)]),e.forEach(n=>{const r=y(n).toString(),a=this.layerMap[r];a&&a.forEach(c=>{this.raiseToTop(c)})})}raiseToTop(e){this.cesiumLayers_.raiseToTop(e)}}class ot{constructor(t,e){l(this,"olListenKeys",[]);l(this,"context");l(this,"rootCollection_");const i=new Cesium.BillboardCollection({scene:e}),s=new Cesium.PrimitiveCollection;this.rootCollection_=new Cesium.PrimitiveCollection,this.context={projection:t,billboards:i,featureToCesiumMap:{},primitives:s},this.rootCollection_.add(i),this.rootCollection_.add(s)}destroy(){this.olListenKeys.forEach(w),this.olListenKeys.length=0}getRootPrimitive(){return this.rootCollection_}}class at{constructor(t){l(this,"scene");l(this,"boundOnRemoveOrClearFeatureListener_",this.onRemoveOrClearFeature_.bind(this));l(this,"defaultBillboardEyeOffset_",new Cesium.Cartesian3(0,0,10));this.scene=t,this.scene=t}onRemoveOrClearFeature_(t){const e=t.target;console.assert(e instanceof D);const i=e.olcs_cancellers;if(i){const s=t.feature;if(s){const n=y(s),r=i[n];r&&(r(),delete i[n])}else{for(const n in i)i.hasOwnProperty(n)&&i[n]();e.olcs_cancellers={}}}}setReferenceForPicking(t,e,i){i.olLayer=t,i.olFeature=e}createColoredPrimitive(t,e,i,s,n,r){const a=function(d,g){const f=new Cesium.GeometryInstance({geometry:d});return g&&!(g instanceof Cesium.ImageMaterialProperty)&&(f.attributes={color:Cesium.ColorGeometryInstanceAttribute.fromColor(g)}),f},c={flat:!0,renderState:{depthTest:{enabled:!0}}};r!==void 0&&(c.renderState.lineWidth=r);const h=a(s,n),m=this.getHeightReference(t,e,i);let u;if(m===Cesium.HeightReference.CLAMP_TO_GROUND){if(!("createShadowVolume"in h.geometry.constructor))return null;u=new Cesium.GroundPrimitive({geometryInstances:h})}else u=new Cesium.Primitive({geometryInstances:h});if(n instanceof Cesium.ImageMaterialProperty){const d=n.image.getValue().toDataURL();u.appearance=new Cesium.MaterialAppearance({flat:!0,renderState:{depthTest:{enabled:!0}},material:new Cesium.Material({fabric:{type:"Image",uniforms:{image:d}}})})}else u.appearance=new Cesium.MaterialAppearance({...c,material:new Cesium.Material({translucent:n.alpha!==1,fabric:{type:"Color",uniforms:{color:n}}})}),u instanceof Cesium.Primitive&&(e.get("olcs_shadows")||t.get("olcs_shadows"))&&(u.shadows=1);return this.setReferenceForPicking(t,e,u),u}extractColorFromOlStyle(t,e){var a;const i=(a=t.getFill())==null?void 0:a.getColor(),s=t.getStroke()?t.getStroke().getColor():null;let n="black";s&&e?n=s:i&&(n=i);const r=$(n);return"red"in r?r:Cesium.Color.BLACK}extractLineWidthFromOlStyle(t){const e=t.getStroke()?t.getStroke().getWidth():void 0;return e!==void 0?e:1}wrapFillAndOutlineGeometries(t,e,i,s,n,r){const a=this.extractColorFromOlStyle(r,!1),c=this.extractColorFromOlStyle(r,!0),h=new Cesium.PrimitiveCollection;if(r.getFill()){const m=this.createColoredPrimitive(t,e,i,s,a);console.assert(!!m),h.add(m)}if(r.getStroke()&&n){const m=this.extractLineWidthFromOlStyle(r),u=this.createColoredPrimitive(t,e,i,n,c,m);u&&h.add(u)}return h}addTextStyle(t,e,i,s,n){let r;if(n instanceof Cesium.PrimitiveCollection?r=n:(r=new Cesium.PrimitiveCollection,r.add(n)),!s.getText())return r;const a=s.getText(),c=this.olGeometry4326TextPartToCesium(t,e,i,a);return c&&r.add(c),r}csAddBillboard(t,e,i,s,n,r){e.eyeOffset||(e.eyeOffset=this.defaultBillboardEyeOffset_);const a=t.add(e);return this.setReferenceForPicking(i,s,a),a}olCircleGeometryToCesium(t,e,i,s,n){i=R(i,s),console.assert(i.getType()=="Circle");const r=i.getCenter(),a=r.length==3?r[2]:0,c=r.slice();c[0]+=i.getRadius();const h=L(r),m=L(c),u=Cesium.Cartesian3.distance(h,m),d=new Cesium.CircleGeometry({center:h,radius:u,height:a});let g,f;if(this.getHeightReference(t,e,i)===Cesium.HeightReference.CLAMP_TO_GROUND){const C=this.extractLineWidthFromOlStyle(n);if(C){const _=Fe(i.getCenter(),u),v=I(_.getLinearRing(0).getCoordinates()),S=g=new Cesium.GroundPolylinePrimitive({geometryInstances:new Cesium.GeometryInstance({geometry:new Cesium.GroundPolylineGeometry({positions:v,width:C})}),appearance:new Cesium.PolylineMaterialAppearance({material:this.olStyleToCesium(e,n,!0)}),classificationType:Cesium.ClassificationType.TERRAIN});M(g).then(()=>{this.setReferenceForPicking(t,e,S._primitive)})}}else f=new Cesium.CircleOutlineGeometry({center:h,radius:u,extrudedHeight:a,height:a});const p=this.wrapFillAndOutlineGeometries(t,e,i,d,f,n);return g&&p.add(g),this.addTextStyle(t,e,i,n,p)}olLineStringGeometryToCesium(t,e,i,s,n){i=R(i,s),console.assert(i.getType()=="LineString");const r=I(i.getCoordinates()),a=this.extractLineWidthFromOlStyle(n);let c;const h=this.getHeightReference(t,e,i),m=new Cesium.PolylineMaterialAppearance({material:this.olStyleToCesium(e,n,!0)});if(h===Cesium.HeightReference.CLAMP_TO_GROUND){const u=new Cesium.GroundPolylineGeometry({positions:r,width:a}),d=c=new Cesium.GroundPolylinePrimitive({appearance:m,geometryInstances:new Cesium.GeometryInstance({geometry:u})});M(c).then(()=>{this.setReferenceForPicking(t,e,d._primitive)})}else{const u=new Cesium.PolylineGeometry({positions:r,width:a,vertexFormat:m.vertexFormat});c=new Cesium.Primitive({appearance:m,geometryInstances:new Cesium.GeometryInstance({geometry:u})})}return this.setReferenceForPicking(t,e,c),this.addTextStyle(t,e,i,n,c)}olPolygonGeometryToCesium(t,e,i,s,n){i=R(i,s),console.assert(i.getType()=="Polygon");const r=this.getHeightReference(t,e,i);let a,c,h;if(i.getCoordinates()[0].length==5&&e.get("olcs_polygon_kind")==="rectangle"){const u=i.getCoordinates()[0],d=Oe(u),g=Cesium.Rectangle.fromDegrees(d[0],d[1],d[2],d[3]);let f=0;if(u[0].length==3)for(let C=0;C<u.length;C++)f=Math.max(f,u[C][2]);const p=e.get("olcs_extruded_height");a=new Cesium.RectangleGeometry({ellipsoid:Cesium.Ellipsoid.WGS84,rectangle:g,height:f,extrudedHeight:p}),c=new Cesium.RectangleOutlineGeometry({ellipsoid:Cesium.Ellipsoid.WGS84,rectangle:g,height:f,extrudedHeight:p})}else{const u=i.getLinearRings(),d={positions:[],holes:[]},g=d;console.assert(u.length>0);for(let p=0;p<u.length;++p){const C=u[p].getCoordinates(),_=I(C);console.assert(_&&_.length>0),p===0?d.positions=_:d.holes.push({positions:_,holes:[]})}const f=e.get("olcs_extruded_height");if(a=new Cesium.PolygonGeometry({polygonHierarchy:g,perPositionHeight:!0,extrudedHeight:f}),r===Cesium.HeightReference.CLAMP_TO_GROUND){const p=this.extractLineWidthFromOlStyle(n);if(p>0){const C=[d.positions];if(d.holes)for(let S=0;S<d.holes.length;++S)C.push(d.holes[S].positions);const _=new Cesium.PolylineMaterialAppearance({material:this.olStyleToCesium(e,n,!0)}),v=[];for(const S of C){const E=new Cesium.GroundPolylineGeometry({positions:S,width:p});v.push(new Cesium.GeometryInstance({geometry:E}))}h=new Cesium.GroundPolylinePrimitive({appearance:_,geometryInstances:v}),M(h).then(()=>{this.setReferenceForPicking(t,e,h._primitive)})}}else c=new Cesium.PolygonOutlineGeometry({polygonHierarchy:d,perPositionHeight:!0,extrudedHeight:f})}const m=this.wrapFillAndOutlineGeometries(t,e,i,a,c,n);return h&&m.add(h),this.addTextStyle(t,e,i,n,m)}getHeightReference(t,e,i){let s=i.get("altitudeMode");s===void 0&&(s=e.get("altitudeMode")),s===void 0&&(s=t.get("altitudeMode"));let n=Cesium.HeightReference.NONE;return s==="clampToGround"?n=Cesium.HeightReference.CLAMP_TO_GROUND:s==="relativeToGround"&&(n=Cesium.HeightReference.RELATIVE_TO_GROUND),n}createBillboardFromImage(t,e,i,s,n,r,a,c){r instanceof W&&r.load();const h=r.getImage(1),m=function(d){return d.src!=""&&d.naturalHeight!=0&&d.naturalWidth!=0&&d.complete},u=(function(){if(!h||!(h instanceof HTMLCanvasElement||h instanceof Image||h instanceof HTMLImageElement))return;const d=i.getCoordinates(),g=L(d);let f;const p=r.getOpacity();p!==void 0&&(f=new Cesium.Color(1,1,1,p));const C=r.getScale(),_=this.getHeightReference(t,e,i),v={image:h,color:f,scale:Array.isArray(C)?(C[0]+C[1])/2:C,heightReference:_,position:g};if(Object.assign(v,e.get("cesiumOptions")),r instanceof W){const E=r.getAnchor();if(E){const he=Array.isArray(C)?C[0]:C,ue=Array.isArray(C)?C[1]:C;v.pixelOffset=new Cesium.Cartesian2((h.width/2-E[0])*he,(h.height/2-E[1])*ue)}}const S=this.csAddBillboard(a,v,t,e,i,n);c&&c(S)}).bind(this);if(h instanceof Image&&!m(h)){let d=!1;const g=t.getSource(),f=function(){d=!0};g.on(["removefeature","clear"],this.boundOnRemoveOrClearFeatureListener_);let p=g.olcs_cancellers;p||(p=g.olcs_cancellers={});const C=y(e);p[C]&&p[C](),p[C]=f;const _=function(){h.removeEventListener("load",_),!a.isDestroyed()&&!d&&u()};h.addEventListener("load",_)}else u()}olPointGeometryToCesium(t,e,i,s,n,r,a){console.assert(i.getType()=="Point"),i=R(i,s);let c=null;const h=n.getImage();if(h){const m=i.get("olcs_model")||e.get("olcs_model");if(m){c=new Cesium.PrimitiveCollection;const u=m(),d=Object.assign({},{scene:this.scene},u.cesiumOptions);if("fromGltf"in Cesium.Model){const g=Cesium.Model.fromGltf(d);c.add(g)}else Cesium.Model.fromGltfAsync(d).then(g=>{c.add(g)});u.debugModelMatrix&&c.add(new Cesium.DebugModelMatrixPrimitive({modelMatrix:u.debugModelMatrix}))}else this.createBillboardFromImage(t,e,i,s,n,h,r,a)}return n.getText()?this.addTextStyle(t,e,i,n,c||new Cesium.Primitive):c}olMultiGeometryToCesium(t,e,i,s,n,r,a){switch(i.getType()){case"MultiPoint":{const c=i.getPoints();if(n.getText()){const h=new Cesium.PrimitiveCollection;return c.forEach(m=>{console.assert(m);const u=this.olPointGeometryToCesium(t,e,m,s,n,r,a);u&&h.add(u)}),h}else return c.forEach(h=>{console.assert(h),this.olPointGeometryToCesium(t,e,h,s,n,r,a)}),null}case"MultiLineString":{const c=i.getLineStrings(),h=new Cesium.PrimitiveCollection;return c.forEach(m=>{const u=this.olLineStringGeometryToCesium(t,e,m,s,n);h.add(u)}),h}case"MultiPolygon":{const c=i.getPolygons(),h=new Cesium.PrimitiveCollection;return c.forEach(m=>{const u=this.olPolygonGeometryToCesium(t,e,m,s,n);h.add(u)}),h}default:console.assert(!1,`Unhandled multi geometry type${i.getType()}`)}}olGeometry4326TextPartToCesium(t,e,i,s){const n=s.getText();if(!n)return null;const r=new Cesium.LabelCollection({scene:this.scene}),a=Q(i.getExtent());if(i instanceof Me){const f=i.getFirstCoordinate();a[2]=f.length==3?f[2]:0}const c={position:L(a)};c.text=Array.isArray(n)?n.join(" "):n,c.heightReference=this.getHeightReference(t,e,i);const h=s.getOffsetX(),m=s.getOffsetY();if(h!=0||m!=0){const f=new Cesium.Cartesian2(h,m);c.pixelOffset=f}c.font=s.getFont()||"10px sans-serif";let u;s.getFill()&&(c.fillColor=this.extractColorFromOlStyle(s,!1),u=Cesium.LabelStyle.FILL),s.getStroke()&&(c.outlineWidth=this.extractLineWidthFromOlStyle(s),c.outlineColor=this.extractColorFromOlStyle(s,!0),u=Cesium.LabelStyle.OUTLINE),s.getFill()&&s.getStroke()&&(u=Cesium.LabelStyle.FILL_AND_OUTLINE),c.style=u;let d;switch(s.getTextAlign()){case"left":d=Cesium.HorizontalOrigin.LEFT;break;case"right":d=Cesium.HorizontalOrigin.RIGHT;break;case"center":default:d=Cesium.HorizontalOrigin.CENTER}if(c.horizontalOrigin=d,s.getTextBaseline()){let f;switch(s.getTextBaseline()){case"top":f=Cesium.VerticalOrigin.TOP;break;case"middle":f=Cesium.VerticalOrigin.CENTER;break;case"bottom":f=Cesium.VerticalOrigin.BOTTOM;break;case"alphabetic":f=Cesium.VerticalOrigin.TOP;break;case"hanging":f=Cesium.VerticalOrigin.BOTTOM;break;default:console.assert(!1,`unhandled baseline ${s.getTextBaseline()}`)}c.verticalOrigin=f}const g=r.add(c);return this.setReferenceForPicking(t,e,g),r}olStyleToCesium(t,e,i){const s=e.getFill(),n=e.getStroke();if(i&&!n||!i&&!s)return null;const r=i?n.getColor():s.getColor(),a=$(r),c=n.getLineDash();return i&&c?Cesium.Material.fromType("PolylineDash",{dashPattern:ct(c),color:a}):Cesium.Material.fromType("Color",{color:a})}computePlainStyle(t,e,i,s){const n=e.getStyleFunction();let r=null;return n&&(r=n(e,s)),!r&&i&&(r=i(e,s)),r?Array.isArray(r)?r:[r]:null}getGeometryFromFeature(t,e,i){if(i)return i;const s=t.get("olcs_3d_geometry");if(s&&s instanceof q)return s;if(e){const n=e.getGeometryFunction()(t);if(n instanceof q)return n}return t.getGeometry()}olFeatureToCesium(t,e,i,s,n){const r=this.getGeometryFromFeature(e,i,n);if(!r)return null;const a=s.projection,c=function(h){const m=s.featureToCesiumMap[y(e)];m instanceof Array?m.push(h):s.featureToCesiumMap[y(e)]=[h]};switch(r.getType()){case"GeometryCollection":const h=new Cesium.PrimitiveCollection;return r.getGeometriesArray().forEach(d=>{if(d){const g=this.olFeatureToCesium(t,e,i,s,d);g&&h.add(g)}}),h;case"Point":const m=s.billboards,u=this.olPointGeometryToCesium(t,e,r,a,i,m,c);return u||null;case"Circle":return this.olCircleGeometryToCesium(t,e,r,a,i);case"LineString":return this.olLineStringGeometryToCesium(t,e,r,a,i);case"Polygon":return this.olPolygonGeometryToCesium(t,e,r,a,i);case"MultiPoint":return this.olMultiGeometryToCesium(t,e,r,a,i,s.billboards,c)||null;case"MultiLineString":return this.olMultiGeometryToCesium(t,e,r,a,i,s.billboards,c)||null;case"MultiPolygon":return this.olMultiGeometryToCesium(t,e,r,a,i,s.billboards,c)||null;case"LinearRing":throw new Error("LinearRing should only be part of polygon.");default:throw new Error(`Ol geom type not handled : ${r.getType()}`)}}olVectorLayerToCesium(t,e,i){const s=e.getProjection(),n=e.getResolution();if(n===void 0||!s)throw console.assert(!1,"View not ready"),new Error("View not ready");let r=t.getSource();r instanceof J&&(r=r.getSource()),console.assert(r instanceof D);const a=r.getFeatures(),c=new ot(s,this.scene),h=c.context;for(let m=0;m<a.length;++m){const u=a[m];if(!u)continue;const d=t.getStyleFunction(),g=this.computePlainStyle(t,u,d,n);if(!g||!g.length)continue;let f=null;for(let p=0;p<g.length;p++){const C=this.olFeatureToCesium(t,u,g[p],h);if(C){if(!f)f=C;else if(C){let _=0,v;for(;v=C.get(_);)f.add(v),_++}}}f&&(i[y(u)]=f,c.getRootPrimitive().add(f))}return c}convert(t,e,i,s){const n=e.getProjection(),r=e.getResolution();if(r==null||!n)return null;const a=t.getStyleFunction(),c=this.computePlainStyle(t,i,a,r);if(!c||!c.length)return null;s.projection=n;let h=null;for(let m=0;m<c.length;m++){const u=this.olFeatureToCesium(t,i,c[m],s);if(!h)h=u;else if(u){let d=0,g;for(;g=u.get(d);)h.add(g),d++}}return h}}function ct(o){o.length<2&&(o=[1,1]);const t=o.length%2===0?o:[...o,...o],i=t.reduce((n,r)=>n+r,0)/16;let s=t.map((n,r)=>{const a=r%2===0?"1":"0";let c=Math.round(n/i);return r===0&&c===0&&(c=1),a.repeat(c)}).join("");return s.length<16?s=s.padEnd(16,"0"):s.length>16&&(s=s.substring(0,16)),s[15]==="1"&&(s=s.substring(0,15)+"0"),console.assert(s.length===16),parseInt(s,2)}class lt extends ce{constructor(e,i,s){super(e,i);l(this,"converter");l(this,"csAllPrimitives_");this.converter=s||new at(i),this.csAllPrimitives_=new Cesium.PrimitiveCollection,i.primitives.add(this.csAllPrimitives_),this.csAllPrimitives_.destroyPrimitives=!1}addCesiumObject(e){console.assert(e);const i=e.getRootPrimitive();i.counterpart=e,this.csAllPrimitives_.add(e.getRootPrimitive())}destroyCesiumObject(e){e.getRootPrimitive().destroy()}removeSingleCesiumObject(e,i){e.destroy(),this.csAllPrimitives_.destroyPrimitives=i,this.csAllPrimitives_.remove(e.getRootPrimitive()),this.csAllPrimitives_.destroyPrimitives=!1}removeAllCesiumObjects(e){if(this.csAllPrimitives_.destroyPrimitives=e,e)for(let i=0;i<this.csAllPrimitives_.length;++i)this.csAllPrimitives_.get(i).counterpart.destroy();this.csAllPrimitives_.removeAll(),this.csAllPrimitives_.destroyPrimitives=!1}updateLayerVisibility(e,i){let s=!0;[e.layer].concat(e.parents).forEach(n=>{const r=n.getVisible();r!==void 0?s=s&&r:s=!1}),i.show=s}createSingleLayerCounterparts(e){const i=e.layer;if(!(i instanceof Ie)||i instanceof z)return null;console.assert(i instanceof Ge);let s=i.getSource();if(s instanceof J&&(s=s.getSource()),!s)return null;console.assert(s instanceof D),console.assert(this.view);const n=this.view,r={},a=this.converter.olVectorLayerToCesium(i,n,r),c=a.getRootPrimitive(),h=a.olListenKeys;[e.layer].concat(e.parents).forEach(d=>{h.push(d.on("change:visible",()=>{this.updateLayerVisibility(e,c)}))}),this.updateLayerVisibility(e,c);const m=d=>{const g=a.context,f=this.converter.convert(i,n,d,g);f&&(r[y(d)]=f,c.add(f))},u=d=>{const g=y(d),f=a.context,p=f.featureToCesiumMap[g];p&&(delete f.featureToCesiumMap[g],p.forEach(_=>{_ instanceof Cesium.Billboard&&f.billboards.remove(_)}));const C=r[g];delete r[g],C&&c.remove(C)};return h.push(s.on("addfeature",d=>{console.assert(d.feature),m(d.feature)})),h.push(s.on("removefeature",d=>{console.assert(d.feature),u(d.feature)})),h.push(s.on("changefeature",d=>{const g=d.feature;console.assert(g),u(g),m(g)})),a?[a]:null}}function ht(o){return o&&o.parentNode?o.parentNode.removeChild(o):null}function ut(o){for(;o.lastChild;)o.removeChild(o.lastChild)}function le(o,t){const e=o.cloneNode();o.nodeName==="CANVAS"&&e.getContext("2d").drawImage(o,0,0),t&&t.appendChild(e),o.nodeType!==Node.TEXT_NODE&&e.addEventListener("click",s=>{o.dispatchEvent(new MouseEvent("click",s)),s.stopPropagation()});const i=o.childNodes;for(let s=0;s<i.length;s++)i[s]&&le(i[s],e);return e}class mt extends ke{constructor(e){const i=e.parent;super(i.getOptions());l(this,"scenePostRenderListenerRemover_",null);l(this,"scene_");l(this,"synchronizer_");l(this,"parent_");l(this,"positionWGS84_");l(this,"observer_");l(this,"attributeObserver_",[]);l(this,"listenerKeys_");this.scene_=e.scene,this.synchronizer_=e.synchronizer,this.parent_=i,this.positionWGS84_=void 0,this.observer_=new MutationObserver(this.handleElementChanged.bind(this)),this.attributeObserver_=[],this.listenerKeys_=[];const s=n=>this.setPropertyFromEvent_(n);this.listenerKeys_.push(this.parent_.on("change:element",s)),this.listenerKeys_.push(this.parent_.on("change:offset",s)),this.listenerKeys_.push(this.parent_.on("change:position",s)),this.listenerKeys_.push(this.parent_.on("change:positioning",s)),this.setProperties(this.parent_.getProperties()),this.handleMapChanged(),this.handleElementChanged(),this.handlePositionChanged()}observeTarget_(e){if(this.observer_){this.observer_.disconnect(),this.observer_.observe(e,{attributes:!1,childList:!0,characterData:!0,subtree:!0}),this.attributeObserver_.forEach(i=>{i.disconnect()}),this.attributeObserver_.length=0;for(let i=0;i<e.childNodes.length;i++){const s=e.childNodes[i];if(s.nodeType===1){const n=new MutationObserver(this.handleElementChanged.bind(this));n.observe(s,{attributes:!0,subtree:!0}),this.attributeObserver_.push(n)}}}}setPropertyFromEvent_(e){e.target&&e.key&&this.set(e.key,e.target.get(e.key))}getScene(){return this.scene_}handleMapChanged(){this.scenePostRenderListenerRemover_&&(this.scenePostRenderListenerRemover_(),ht(this.element)),this.scenePostRenderListenerRemover_=null;const e=this.getScene();if(e){this.scenePostRenderListenerRemover_=e.postRender.addEventListener(this.updatePixelPosition.bind(this)),this.updatePixelPosition();const i=this.stopEvent?this.synchronizer_.getOverlayContainerStopEvent():this.synchronizer_.getOverlayContainer();this.insertFirst?i.insertBefore(this.element,i.childNodes[0]||null):i.appendChild(this.element)}}handlePositionChanged(){if(!this.parent_)return;const e=this.getPosition();if(e){const i=this.parent_.getMap().getView().getProjection();this.positionWGS84_=Ve(e,i,"EPSG:4326")}else this.positionWGS84_=void 0;this.updatePixelPosition()}handleElementChanged(){ut(this.element);const e=this.getElement();if(e&&e.parentNode&&e.parentNode.childNodes)for(const i of Array.from(e.parentNode.childNodes)){const s=le(i,null);this.element.appendChild(s)}e.parentNode&&this.observeTarget_(e.parentNode)}updatePixelPosition(){const e=this.positionWGS84_;if(!this.scene_||!e){this.setVisible(!1);return}let i=0;if(e.length===2){const d=this.scene_.globe.getHeight(Cesium.Cartographic.fromDegrees(e[0],e[1]));d&&this.scene_.globe.tilesLoaded&&(e[2]=d),d&&(i=d)}else i=e[2];const s=Cesium.Cartesian3.fromDegrees(e[0],e[1],i),n=this.scene_.camera,r=new Cesium.BoundingSphere(new Cesium.Cartesian3,6356752);if(!new Cesium.Occluder(r,n.position).isPointVisible(s)){this.setVisible(!1);return}if(n.frustum.computeCullingVolume(n.position,n.direction,n.up).computeVisibility(new Cesium.BoundingSphere(s))!==1){this.setVisible(!1);return}this.setVisible(!0);const h=this.scene_.cartesianToCanvasCoordinates(s),m=[h.x,h.y],u=[this.scene_.canvas.width,this.scene_.canvas.height];this.updateRenderedPosition(m,u)}destroy(){this.scenePostRenderListenerRemover_&&this.scenePostRenderListenerRemover_(),this.observer_&&this.observer_.disconnect(),w(this.listenerKeys_),this.listenerKeys_.splice(0),"removeNode"in this.element?this.element.removeNode(!0):this.element.remove(),this.element=null}}class dt{constructor(t,e){l(this,"map");l(this,"scene");l(this,"overlayCollection_");l(this,"overlayContainerStopEvent_");l(this,"overlayContainer_");l(this,"overlayMap_",new Map);l(this,"overlayEvents",["click","dblclick","mousedown","touchstart","pointerdown","mousewheel","wheel"]);l(this,"listenerKeys_",[]);this.map=t,this.scene=e,this.map=t,this.overlayCollection_=this.map.getOverlays(),this.scene=e,this.overlayContainerStopEvent_=document.createElement("div"),this.overlayContainerStopEvent_.className="ol-overlaycontainer-stopevent",this.overlayEvents.forEach(i=>{this.overlayContainerStopEvent_.addEventListener(i,s=>s.stopPropagation())}),this.scene.canvas.parentElement.appendChild(this.overlayContainerStopEvent_),this.overlayContainer_=document.createElement("div"),this.overlayContainer_.className="ol-overlaycontainer",this.scene.canvas.parentElement.appendChild(this.overlayContainer_)}getOverlayContainerStopEvent(){return this.overlayContainerStopEvent_}getOverlayContainer(){return this.overlayContainer_}synchronize(){this.destroyAll(),this.overlayCollection_.forEach(t=>{this.addOverlay(t)}),this.listenerKeys_.push(this.overlayCollection_.on("add",t=>this.addOverlay(t.element))),this.listenerKeys_.push(this.overlayCollection_.on("remove",t=>this.removeOverlay(t.element)))}addOverlay(t){if(!t)return;const e=new mt({scene:this.scene,synchronizer:this,parent:t});this.overlayMap_.set(y(t),e)}removeOverlay(t){const e=y(t),i=this.overlayMap_.get(e);i&&(i.destroy(),this.overlayMap_.delete(e))}destroyAll(){this.overlayMap_.forEach(t=>{t.destroy()}),this.overlayMap_.clear(),w(this.listenerKeys_),this.listenerKeys_.length=0}}const G={DONE:0,PENDING:1,FAILED:2};class B{constructor(t){l(this,"autoRenderLoop_",null);l(this,"map_");l(this,"time_");l(this,"to4326Transform_");l(this,"resolutionScale_",1);l(this,"canvasClientWidth_",0);l(this,"canvasClientHeight_",0);l(this,"resolutionScaleChanged_",!0);l(this,"container_");l(this,"isOverMap_");l(this,"canvas_");l(this,"enabled_",!1);l(this,"pausedInteractions_",[]);l(this,"hiddenRootGroup_",null);l(this,"scene_");l(this,"camera_");l(this,"globe_");l(this,"dataSourceCollection_");l(this,"dataSourceDisplay_");l(this,"lastFrameTime_",0);l(this,"renderId_");l(this,"targetFrameRate_",Number.POSITIVE_INFINITY);l(this,"blockCesiumRendering_",!1);l(this,"warmingUp_",!1);l(this,"trackedFeature_",null);l(this,"trackedEntity_",null);l(this,"entityView_",null);l(this,"needTrackedEntityUpdate_",!1);l(this,"boundingSphereScratch_",new Cesium.BoundingSphere);l(this,"synchronizers_");l(this,"refresh2DAfterCameraMoveEndOnly",!1);l(this,"moveEndRemoveCallback_");this.map_=t.map,this.time_=t.time||function(){return Cesium.JulianDate.now()},this.to4326Transform_=V(this.map_.getView().getProjection(),"EPSG:4326");const e="position:absolute;top:0;left:0;width:100%;height:100%;touch-action:none;";this.container_=document.createElement("DIV");const i=document.createAttribute("style");i.value=`${e}visibility:hidden;`,this.container_.setAttributeNode(i);let s=t.target||this.map_.getViewport();if(typeof s=="string"&&(s=document.getElementById(s)),s.appendChild(this.container_),this.isOverMap_=!t.target,this.isOverMap_&&t.stopOpenLayersEventsPropagation){const m=["click","dblclick","mousedown","touchstart","pointerdown","mousewheel","wheel"];for(let u=0,d=m.length;u<d;++u)this.container_.addEventListener(m[u],g=>g.stopPropagation())}this.canvas_=document.createElement("canvas");const n=document.createAttribute("style");n.value=e,this.canvas_.setAttributeNode(n),U()&&(this.canvas_.style.imageRendering=De()),this.canvas_.oncontextmenu=function(){return!1},this.canvas_.onselectstart=function(){return!1},this.container_.appendChild(this.canvas_);const r=t.sceneOptions!==void 0?{...t.sceneOptions,canvas:this.canvas_,scene3DOnly:!0}:{canvas:this.canvas_,scene3DOnly:!0};this.scene_=new Cesium.Scene(r);const a=this.scene_.screenSpaceCameraController;Array.isArray(a.tiltEventTypes)?(a.tiltEventTypes.push({eventType:Cesium.CameraEventType.LEFT_DRAG,modifier:Cesium.KeyboardEventModifier.SHIFT}),a.tiltEventTypes.push({eventType:Cesium.CameraEventType.LEFT_DRAG,modifier:Cesium.KeyboardEventModifier.ALT})):console.log("sscc is not an array"),a.enableLook=!1,this.scene_.camera.constrainedAxis=Cesium.Cartesian3.UNIT_Z,this.camera_=new nt(this.scene_,this.map_),this.globe_=new Cesium.Globe(Cesium.Ellipsoid.WGS84),this.globe_.baseColor=Cesium.Color.WHITE,this.scene_.globe=this.globe_,this.scene_.skyAtmosphere=new Cesium.SkyAtmosphere;const c=new Cesium.SingleTileImageryProvider({tileHeight:1,tileWidth:1,url:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=",rectangle:Cesium.Rectangle.fromDegrees(0,0,1,1)});this.globe_.imageryLayers.addImageryProvider(c,0),this.dataSourceCollection_=new Cesium.DataSourceCollection,this.dataSourceDisplay_=new Cesium.DataSourceDisplay({scene:this.scene_,dataSourceCollection:this.dataSourceCollection_}),this.synchronizers_=t.createSynchronizers?t.createSynchronizers(this.map_,this.scene_,this.dataSourceCollection_):[new rt(this.map_,this.scene_),new lt(this.map_,this.scene_),new dt(this.map_,this.scene_)],this.handleResize_();for(let m=this.synchronizers_.length-1;m>=0;--m)this.synchronizers_[m].synchronize();new Cesium.EventHelper().add(this.scene_.postRender,B.prototype.updateTrackedEntity_,this),this.moveEndRemoveCallback_=this.scene_.camera.moveEnd.addEventListener(()=>{this.refresh2DAfterCameraMoveEndOnly&&this.camera_.checkCameraChange()})}destroy(){cancelAnimationFrame(this.renderId_),this.renderId_=void 0,this.synchronizers_.forEach(t=>t.destroyAll()),this.camera_.destroy(),this.scene_.destroy(),this.scene_._postRender=null,this.moveEndRemoveCallback_(),this.container_.remove()}render_(){this.renderId_!==void 0&&(cancelAnimationFrame(this.renderId_),this.renderId_=void 0),(this.enabled_||this.warmingUp_)&&!this.blockCesiumRendering_&&(this.renderId_=requestAnimationFrame(this.onAnimationFrame_.bind(this)))}onAnimationFrame_(t){this.renderId_=void 0;const e=1e3/this.targetFrameRate_;if(t-this.lastFrameTime_<e){this.render_();return}this.lastFrameTime_=t;const s=this.time_();if(this.scene_.initializeFrame(),this.handleResize_(),this.dataSourceDisplay_.update(s),this.entityView_){const n=this.trackedEntity_;this.dataSourceDisplay_.getBoundingSphere(n,!1,this.boundingSphereScratch_)===G.DONE&&(this.boundingSphereScratch_.radius=1,this.entityView_.update(s,this.boundingSphereScratch_))}this.scene_.render(s),this.refresh2DAfterCameraMoveEndOnly||this.camera_.checkCameraChange(),this.render_()}updateTrackedEntity_(){if(!this.needTrackedEntityUpdate_)return;const t=this.trackedEntity_,e=this.scene_,i=this.dataSourceDisplay_.getBoundingSphere(t,!1,this.boundingSphereScratch_);if(i===G.PENDING)return;e.screenSpaceCameraController.enableTilt=!1;const s=i!==G.FAILED?this.boundingSphereScratch_:void 0;s&&(s.radius=1),this.entityView_=new Cesium.EntityView(t,e,e.mapProjection.ellipsoid),this.entityView_.update(this.time_(),s),this.needTrackedEntityUpdate_=!1}handleResize_(){let t=this.canvas_.clientWidth,e=this.canvas_.clientHeight;if(t===0||e===0||t===this.canvasClientWidth_&&e===this.canvasClientHeight_&&!this.resolutionScaleChanged_)return;let i=this.resolutionScale_;U()||(i*=window.devicePixelRatio||1),this.resolutionScaleChanged_=!1,this.canvasClientWidth_=t,this.canvasClientHeight_=e,t*=i,e*=i,this.canvas_.width=t,this.canvas_.height=e,this.scene_.camera.frustum.aspectRatio=t/e}getCamera(){return this.camera_}getOlMap(){return this.map_}getOlView(){const t=this.map_.getView();return console.assert(t),t}getCesiumScene(){return this.scene_}getDataSources(){return this.dataSourceCollection_}getDataSourceDisplay(){return this.dataSourceDisplay_}getEnabled(){return this.enabled_}setEnabled(t){if(this.enabled_===t)return;this.enabled_=t,this.container_.style.visibility=this.enabled_?"visible":"hidden";let e;if(this.enabled_){if(this.throwOnUnitializedMap_(),this.isOverMap_){e=this.map_.getInteractions(),e.forEach((s,n,r)=>{this.pausedInteractions_.push(s)}),e.clear(),this.map_.addInteraction=s=>this.pausedInteractions_.push(s),this.map_.removeInteraction=s=>{let n=!1;return this.pausedInteractions_=this.pausedInteractions_.filter(r=>{const a=r!==s;return n||(n=a),a}),n?s:void 0};const i=this.map_.getLayerGroup();i.getVisible()&&(this.hiddenRootGroup_=i,this.hiddenRootGroup_.setVisible(!1)),this.map_.getOverlayContainer().classList.add("olcs-hideoverlay")}this.camera_.readFromView(),this.render_()}else this.isOverMap_&&(e=this.map_.getInteractions(),this.pausedInteractions_.forEach(i=>{e.push(i)}),this.pausedInteractions_.length=0,this.map_.addInteraction=i=>this.map_.getInteractions().push(i),this.map_.removeInteraction=i=>this.map_.getInteractions().remove(i),this.map_.getOverlayContainer().classList.remove("olcs-hideoverlay"),this.hiddenRootGroup_&&(this.hiddenRootGroup_.setVisible(!0),this.hiddenRootGroup_=null)),this.camera_.updateView()}warmUp(t,e){if(this.enabled_)return;this.throwOnUnitializedMap_(),this.camera_.readFromView();const i=this.globe_.ellipsoid,s=this.scene_.camera,n=i.cartesianToCartographic(s.position);n.height<t&&(n.height=t,s.position=i.cartographicToCartesian(n)),this.warmingUp_=!0,this.render_(),setTimeout(()=>{this.warmingUp_=!1},e)}setBlockCesiumRendering(t){this.blockCesiumRendering_!==t&&(this.blockCesiumRendering_=t,this.render_())}enableAutoRenderLoop(){this.autoRenderLoop_||(this.autoRenderLoop_=new st(this))}getAutoRenderLoop(){return this.autoRenderLoop_}setResolutionScale(t){t=Math.max(0,t),t!==this.resolutionScale_&&(this.resolutionScale_=Math.max(0,t),this.resolutionScaleChanged_=!0,this.autoRenderLoop_&&this.autoRenderLoop_.restartRenderLoop())}setTargetFrameRate(t){this.targetFrameRate_!==t&&(this.targetFrameRate_=t,this.render_())}setRefresh2DAfterCameraMoveEndOnly(t){this.refresh2DAfterCameraMoveEndOnly=t}throwOnUnitializedMap_(){const e=this.map_.getView(),i=e.getCenter();if(!e.isDef()||isNaN(i[0])||isNaN(i[1]))throw new Error(`The OpenLayers map is not properly initialized: ${i} / ${e.getResolution()}`)}get trackedFeature(){return this.trackedFeature_}set trackedFeature(t){if(this.trackedFeature_!==t){const e=this.scene_;if(!t||!t.getGeometry()){this.needTrackedEntityUpdate_=!1,e.screenSpaceCameraController.enableTilt=!0,this.trackedEntity_&&this.dataSourceDisplay_.defaultDataSource.entities.remove(this.trackedEntity_),this.trackedEntity_=null,this.trackedFeature_=null,this.entityView_=null,e.camera.lookAtTransform(Cesium.Matrix4.IDENTITY);return}this.trackedFeature_=t,this.needTrackedEntityUpdate_=!0;const i=this.to4326Transform_,s=function(){const r=t.getGeometry();console.assert(r instanceof Z);const a=r instanceof Z?r.getCoordinates():[],c=i(a,void 0,a.length);return L(c)},n={position:new Cesium.CallbackProperty((r,a)=>s(),!1),point:{pixelSize:1,color:Cesium.Color.TRANSPARENT}};this.trackedEntity_=this.dataSourceDisplay_.defaultDataSource.entities.add(n)}}}function wt(o,t,e){const i=t/e;let s;return i>1?(s=[o.width,o.width/i],s[1]>o.height&&(s=[o.height*i,o.height])):(s=[o.height*i,o.height],s[0]>o.width&&(s=[o.width,o.width/i])),{scaling:[s[0]/o.width,s[1]/o.height],width:s[0],height:s[1],offsetX:(o.width-s[0])/2,offsetY:(o.height-s[1])/2}}let P=null;class O{constructor(t){l(this,"gl");l(this,"programInfo");l(this,"positionBuffer");this.gl=t;const e=this.initShaderProgram();this.programInfo={program:e,attribLocations:{vertexPosition:t.getAttribLocation(e,"aVertexPosition")},uniformLocations:{uScaling:t.getUniformLocation(e,"uScaling")}},this.positionBuffer=t.createBuffer();const i=[1,1,-1,1,1,-1,-1,-1];t.bindBuffer(t.ARRAY_BUFFER,this.positionBuffer),t.bufferData(t.ARRAY_BUFFER,new Float32Array(i),t.STATIC_DRAW)}getVertexShaderSource(){return`
      attribute vec4 aVertexPosition;
      uniform vec2 uScaling;
      void main() {
        gl_Position = vec4(aVertexPosition[0] * uScaling[0], aVertexPosition[1] * uScaling[1], -1.0, 1.0);
      }
    `}getFragmentShaderSource(){return`
      precision highp float;
      void main() {
        gl_FragColor = vec4(.5, .5, .5, .6);
      }
  `}initShaderProgram(){const t=this.gl,e=this.getVertexShaderSource(),i=this.getFragmentShaderSource(),s=O.loadShader(t,t.VERTEX_SHADER,e),n=O.loadShader(t,t.FRAGMENT_SHADER,i),r=t.createProgram();if(t.attachShader(r,s),t.attachShader(r,n),t.linkProgram(r),!t.getProgramParameter(r,t.LINK_STATUS))throw new Error(`Unable to initialize the shader program: ${t.getProgramInfoLog(r)}`);return r}drawMask(t){const e=this.gl,i=this.programInfo;e.enable(e.BLEND),e.bindBuffer(e.ARRAY_BUFFER,this.positionBuffer),e.vertexAttribPointer(i.attribLocations.vertexPosition,2,e.FLOAT,!1,0,0),e.enableVertexAttribArray(i.attribLocations.vertexPosition),e.useProgram(i.program),e.enable(e.STENCIL_TEST),e.stencilFunc(e.ALWAYS,1,255),e.stencilOp(e.KEEP,e.KEEP,e.REPLACE),e.uniform2fv(i.uniformLocations.uScaling,t),e.blendFunc(e.ZERO,e.ONE),e.drawArrays(e.TRIANGLE_STRIP,0,4),e.stencilFunc(e.EQUAL,0,255),e.stencilOp(e.KEEP,e.KEEP,e.KEEP),e.uniform2fv(i.uniformLocations.uScaling,[1,1]),e.blendFunc(e.ZERO,e.SRC_ALPHA),e.drawArrays(e.TRIANGLE_STRIP,0,4)}static loadShader(t,e,i){const s=t.createShader(e);if(t.shaderSource(s,i),t.compileShader(s),!t.getShaderParameter(s,t.COMPILE_STATUS))throw new Error(`An error occurred compiling the shaders: ${t.getShaderInfoLog(s)}`);return s}}function St(o,t){const e=o.canvas,i=e.getContext("webgl2")||e.getContext("webgl");if(t){if(!P){const s=new O(i);P=o.postRender.addEventListener(()=>{s.drawMask(t())})}}else P&&(P(),P=null);o.requestRender()}function Lt(o,t){return new Promise((e,i)=>{const s=o.postRender.addEventListener(()=>{s();try{let n;if(t){const r=document.createElement("canvas");r.width=t.width,r.height=t.height,r.getContext("2d").drawImage(o.canvas,t.offsetX,t.offsetY,t.width,t.height,0,0,t.width,t.height),n=r.toDataURL()}else n=o.canvas.toDataURL();e(n)}catch(n){i(n)}});o.requestRender()})}class gt{constructor(t){l(this,"promise");l(this,"url_");this.url_=t}load(){return this.promise||(this.promise=new Promise((t,e)=>{const i=document.createElement("script");i.onload=()=>t(),i.onerror=()=>e(),document.head.appendChild(i),i.src=this.url_})),this.promise}}class bt extends Ne{constructor(e,{map:i,cameraExtentInRadians:s,cesiumIonDefaultAccessToken:n}){super();l(this,"cesiumUrl_");l(this,"boundingSphere_");l(this,"promise_");l(this,"cesiumIonDefaultAccessToken_");l(this,"map");l(this,"cameraExtentInRadians");l(this,"ol3d");l(this,"cesiumInitialTilt_",b(50));l(this,"fogDensity",1e-4);l(this,"fogSSEFactor",25);l(this,"minimumZoomDistance",2);l(this,"maximumZoomDistance",1e7);l(this,"limitCameraToBoundingSphereRatio",e=>e>3e3?9:3);this.cesiumUrl_=e,console.assert(i),this.map=i,this.cameraExtentInRadians=s||null,this.cesiumIonDefaultAccessToken_=n}load(){if(!this.promise_){const e=new gt(this.cesiumUrl_);this.promise_=e.load().then(()=>this.onCesiumLoaded())}return this.promise_}onCesiumLoaded(){if(this.cameraExtentInRadians){const i=new Cesium.Rectangle(...this.cameraExtentInRadians);Cesium.Camera.DEFAULT_VIEW_RECTANGLE=i,this.boundingSphere_=Cesium.BoundingSphere.fromRectangle3D(i,Cesium.Ellipsoid.WGS84,300)}this.cesiumIonDefaultAccessToken_&&(Cesium.Ion.defaultAccessToken=this.cesiumIonDefaultAccessToken_),this.ol3d=this.instantiateOLCesium();const e=this.ol3d.getCesiumScene();return this.configureForUsability(e),this.configureForPerformance(e),this.dispatchEvent("load"),this.ol3d}instantiateOLCesium(){const e=new B({map:this.map}),i=e.getCesiumScene();return Cesium.createWorldTerrainAsync().then(s=>i.terrainProvider=s),e}configureForPerformance(e){const i=e.fog;i.enabled=!0,i.density=this.fogDensity,i.screenSpaceErrorFactor=this.fogSSEFactor}configureForUsability(e){const i=e.screenSpaceCameraController;i.minimumZoomDistance=this.minimumZoomDistance,i.maximumZoomDistance=this.maximumZoomDistance,e.globe.depthTestAgainstTerrain=!0,e.globe.baseColor=Cesium.Color.WHITE,e.backgroundColor=Cesium.Color.WHITE,this.boundingSphere_&&e.postRender.addEventListener(this.limitCameraToBoundingSphere.bind(this)),this.ol3d.enableAutoRenderLoop()}limitCameraToBoundingSphere(){const e=this.ol3d.getCesiumScene();it(e.camera,this.boundingSphere_,this.limitCameraToBoundingSphereRatio)}toggle3d(){return this.load().then(e=>{const i=e.getEnabled(),s=e.getCesiumScene();return i?(console.assert(this.map),Xe(this.map,s).then(()=>{e.setEnabled(!1),this.dispatchEvent("toggle")})):(e.setEnabled(!0),this.dispatchEvent("toggle"),Qe(s,this.cesiumInitialTilt_))})}set3dWithView(e,i,s,n,r){return this.load().then(a=>{const c=a.getEnabled(),m=a.getCesiumScene().camera,u=Cesium.Cartesian3.fromDegrees(e,i,s),d=Cesium.Math.toRadians(n),g=Cesium.Math.toRadians(r),p={heading:d,pitch:g,roll:0};c||(a.setEnabled(!0),this.dispatchEvent("toggle")),m.setView({destination:u,orientation:p})})}is3dEnabled(){return!!this.ol3d&&this.ol3d.getEnabled()}getHeading(){return this.map&&this.map.getView().getRotation()||0}getTiltOnGlobe(){const e=this.ol3d.getCesiumScene();return-qe(e)}setHeading(e){const i=this.ol3d.getCesiumScene(),s=K(i);s&&ie(i,e,s)}getOl3d(){return this.ol3d}getCesiumViewMatrix(){return this.ol3d.getCesiumScene().camera.viewMatrix}getCesiumScene(){return this.ol3d.getCesiumScene()}flyToRectangle(e,i=0){const s=this.getCesiumScene().camera,n=s.getRectangleCameraCoordinates(e),r=Cesium.Cartesian3.magnitude(n)+i;return Cesium.Cartesian3.normalize(n,n),Cesium.Cartesian3.multiplyByScalar(n,r,n),new Promise((a,c)=>{if(!this.cameraExtentInRadians){c();return}s.flyTo({destination:n,complete:()=>a(),cancel:()=>c(),endTransform:Cesium.Matrix4.IDENTITY})})}}export{ce as AbstractSynchronizer,gt as ContribLazyLoader,bt as ContribManager,at as FeatureConverter,O as MaskDrawer,nt as OLCSCamera,ze as OLImageryProvider,dt as OverlaySynchronizer,rt as RasterSynchronizer,ot as VectorLayerCounterpart,lt as VectorSynchronizer,_t as applyHeightOffsetToGeometry,ae as attributionsFunctionToCredits,St as autoDrawMask,Ze as bottomFovRay,et as calcDistanceForResolution,tt as calcResolutionForDistance,re as computeAngleToZenith,Ct as computeBoundingBoxAtTarget,je as computePixelSizeAtCoordinate,wt as computeRectangle,qe as computeSignedTiltAngleOnGlobe,$ as convertColorToCesium,vt as convertUrlToCesium,yt as createMatrixAtCoordinates,B as default,oe as extentToRectangle,X as isCesiumProjection,it as limitCameraToBoundingSphere,Je as normalizeView,I as ol4326CoordinateArrayToCsCartesians,L as ol4326CoordinateToCesiumCartesian,R as olGeometryCloneTo4326,K as pickBottomPoint,We as pickCenterPoint,se as pickOnTerrainOrEllipsoid,Xe as resetToNorthZenith,H as rotateAroundAxis,Qe as rotateAroundBottomCenter,ie as setHeadingUsingBottomCenter,ne as signedAngleBetween,Ye as sourceToImageryProvider,Lt as takeScreenshot,$e as tileLayerToImageryLayer,Y as updateCesiumLayerProperties};

import{a$ as Xe,aZ as ye,aR as I,aq as we,aJ as V,b0 as Ae,b1 as Ce,as as ve,b2 as Me,a3 as He,E as M,b3 as X,b4 as Le,ar as Ue,l as Y,b5 as We,b6 as ze,b7 as le,b8 as ce,b9 as Ve,ba as je,bb as J,aD as O,aC as K,bc as Ye,bd as ue,be as Ke,aT as ke,bf as Ze,bg as $,bh as qe,bi as he,bj as Je,bk as Qe,bl as et,bm as Q,bn as Se,aM as tt,bo as fe,B as rt,bp as nt,bq as it,br as N,bs as ee,bt as st,bu as Ie,bv as ot,bw as at,bx as lt,by as d,bz as Pe,bA as Te,bB as ct,bC as ut}from"./olcs.Cqh799zv.js";const re=34962,ne=34963,ie=35044,ht=5121,ft=5123,Tt=5125,De=5126,de=["experimental-webgl","webgl","webkit-3d","moz-webgl"];function dt(i,e){e=Object.assign({preserveDrawingBuffer:!0,antialias:!Xe},e);const t=de.length;for(let r=0;r<t;++r)try{const s=i.getContext(de[r],e);if(s)return s}catch{}return null}const _t={STATIC_DRAW:ie};class Ne{constructor(e,t){this.array_=null,this.type_=e,ye(e===re||e===ne,"A `WebGLArrayBuffer` must either be of type `ELEMENT_ARRAY_BUFFER` or `ARRAY_BUFFER`"),this.usage_=t!==void 0?t:_t.STATIC_DRAW}ofSize(e){return this.array_=new(H(this.type_))(e),this}fromArray(e){return this.array_=H(this.type_).from(e),this}fromArrayBuffer(e){return this.array_=new(H(this.type_))(e),this}getType(){return this.type_}getArray(){return this.array_}setArray(e){const t=H(this.type_);if(!(e instanceof t))throw new Error(`Expected ${t}`);this.array_=e}getUsage(){return this.usage_}getSize(){return this.array_?this.array_.length:0}}function H(i){switch(i){case re:return Float32Array;case ne:return Uint32Array;default:return Float32Array}}const W={LOST:"webglcontextlost",RESTORED:"webglcontextrestored"},Et=`
  precision mediump float;

  attribute vec2 a_position;
  varying vec2 v_texCoord;
  varying vec2 v_screenCoord;

  uniform vec2 u_screenSize;

  void main() {
    v_texCoord = a_position * 0.5 + 0.5;
    v_screenCoord = v_texCoord * u_screenSize;
    gl_Position = vec4(a_position, 0.0, 1.0);
  }
`,gt=`
  precision mediump float;

  uniform sampler2D u_image;
  uniform float u_opacity;

  varying vec2 v_texCoord;

  void main() {
    gl_FragColor = texture2D(u_image, v_texCoord) * u_opacity;
  }
`;class _e{constructor(e){this.gl_=e.webGlContext;const t=this.gl_;this.scaleRatio_=e.scaleRatio||1,this.renderTargetTexture_=t.createTexture(),this.renderTargetTextureSize_=null,this.frameBuffer_=t.createFramebuffer(),this.depthBuffer_=t.createRenderbuffer();const r=t.createShader(t.VERTEX_SHADER);t.shaderSource(r,e.vertexShader||Et),t.compileShader(r);const s=t.createShader(t.FRAGMENT_SHADER);t.shaderSource(s,e.fragmentShader||gt),t.compileShader(s),this.renderTargetProgram_=t.createProgram(),t.attachShader(this.renderTargetProgram_,r),t.attachShader(this.renderTargetProgram_,s),t.linkProgram(this.renderTargetProgram_),this.renderTargetVerticesBuffer_=t.createBuffer();const n=[-1,-1,1,-1,-1,1,1,-1,1,1,-1,1];t.bindBuffer(t.ARRAY_BUFFER,this.renderTargetVerticesBuffer_),t.bufferData(t.ARRAY_BUFFER,new Float32Array(n),t.STATIC_DRAW),this.renderTargetAttribLocation_=t.getAttribLocation(this.renderTargetProgram_,"a_position"),this.renderTargetUniformLocation_=t.getUniformLocation(this.renderTargetProgram_,"u_screenSize"),this.renderTargetOpacityLocation_=t.getUniformLocation(this.renderTargetProgram_,"u_opacity"),this.renderTargetTextureLocation_=t.getUniformLocation(this.renderTargetProgram_,"u_image"),this.uniforms_=[],e.uniforms&&Object.keys(e.uniforms).forEach(o=>{this.uniforms_.push({value:e.uniforms[o],location:t.getUniformLocation(this.renderTargetProgram_,o)})})}getRenderTargetTexture(){return this.renderTargetTexture_}getGL(){return this.gl_}init(e){const t=this.getGL(),r=[t.drawingBufferWidth*this.scaleRatio_,t.drawingBufferHeight*this.scaleRatio_];if(t.bindFramebuffer(t.FRAMEBUFFER,this.getFrameBuffer()),t.bindRenderbuffer(t.RENDERBUFFER,this.getDepthBuffer()),t.viewport(0,0,r[0],r[1]),!this.renderTargetTextureSize_||this.renderTargetTextureSize_[0]!==r[0]||this.renderTargetTextureSize_[1]!==r[1]){this.renderTargetTextureSize_=r;const s=0,n=t.RGBA,o=0,a=t.RGBA,u=t.UNSIGNED_BYTE,l=null;t.bindTexture(t.TEXTURE_2D,this.renderTargetTexture_),t.texImage2D(t.TEXTURE_2D,s,n,r[0],r[1],o,a,u,l),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.renderTargetTexture_,0),t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT16,r[0],r[1]),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,this.depthBuffer_)}}apply(e,t,r,s){const n=this.getGL(),o=e.size;if(n.bindFramebuffer(n.FRAMEBUFFER,t?t.getFrameBuffer():null),n.activeTexture(n.TEXTURE0),n.bindTexture(n.TEXTURE_2D,this.renderTargetTexture_),!t){const u=I(n.canvas);if(!e.renderTargets[u]){const l=n.getContextAttributes();l&&l.preserveDrawingBuffer&&(n.clearColor(0,0,0,0),n.clearDepth(1),n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT)),e.renderTargets[u]=!0}}n.disable(n.DEPTH_TEST),n.enable(n.BLEND),n.blendFunc(n.ONE,n.ONE_MINUS_SRC_ALPHA),n.viewport(0,0,n.drawingBufferWidth,n.drawingBufferHeight),n.bindBuffer(n.ARRAY_BUFFER,this.renderTargetVerticesBuffer_),n.useProgram(this.renderTargetProgram_),n.enableVertexAttribArray(this.renderTargetAttribLocation_),n.vertexAttribPointer(this.renderTargetAttribLocation_,2,n.FLOAT,!1,0,0),n.uniform2f(this.renderTargetUniformLocation_,o[0],o[1]),n.uniform1i(this.renderTargetTextureLocation_,0);const a=e.layerStatesArray[e.layerIndex].opacity;n.uniform1f(this.renderTargetOpacityLocation_,a),this.applyUniforms(e),r&&r(n,e),n.drawArrays(n.TRIANGLES,0,6),s&&s(n,e)}getFrameBuffer(){return this.frameBuffer_}getDepthBuffer(){return this.depthBuffer_}applyUniforms(e){const t=this.getGL();let r,s=1;this.uniforms_.forEach(function(n){if(r=typeof n.value=="function"?n.value(e):n.value,r instanceof HTMLCanvasElement||r instanceof ImageData)n.texture||(n.texture=t.createTexture()),t.activeTexture(t[`TEXTURE${s}`]),t.bindTexture(t.TEXTURE_2D,n.texture),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),r instanceof ImageData?t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,r.width,r.height,0,t.UNSIGNED_BYTE,new Uint8Array(r.data)):t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,r),t.uniform1i(n.location,s++);else if(Array.isArray(r))switch(r.length){case 2:t.uniform2f(n.location,r[0],r[1]);return;case 3:t.uniform3f(n.location,r[0],r[1],r[2]);return;case 4:t.uniform4f(n.location,r[0],r[1],r[2],r[3]);return;default:return}else typeof r=="number"&&t.uniform1f(n.location,r)})}}const P={TIME:"u_time",ZOOM:"u_zoom",RESOLUTION:"u_resolution",ROTATION:"u_rotation",VIEWPORT_SIZE_PX:"u_viewportSizePx",PIXEL_RATIO:"u_pixelRatio",HIT_DETECTION:"u_hitDetection"},B={UNSIGNED_BYTE:ht,UNSIGNED_SHORT:ft,UNSIGNED_INT:Tt,FLOAT:De},j={};function Ee(i){return"shared/"+i}let ge=0;function pt(){const i="unique/"+ge;return ge+=1,i}function Rt(i){let e=j[i];if(!e){const t=document.createElement("canvas");t.width=1,t.height=1,t.style.position="absolute",t.style.left="0",e={users:0,context:dt(t)},j[i]=e}return e.users+=1,e.context}function mt(i){const e=j[i];if(!e||(e.users-=1,e.users>0))return;const t=e.context,r=t.getExtension("WEBGL_lose_context");r&&r.loseContext();const s=t.canvas;s.width=1,s.height=1,delete j[i]}class xt extends we{constructor(e){super(),e=e||{},this.boundHandleWebGLContextLost_=this.handleWebGLContextLost.bind(this),this.boundHandleWebGLContextRestored_=this.handleWebGLContextRestored.bind(this),this.canvasCacheKey_=e.canvasCacheKey?Ee(e.canvasCacheKey):pt(),this.gl_=Rt(this.canvasCacheKey_),this.bufferCache_={},this.extensionCache_={},this.currentProgram_=null,this.needsToBeRecreated_=!1;const t=this.gl_.canvas;t.addEventListener(W.LOST,this.boundHandleWebGLContextLost_),t.addEventListener(W.RESTORED,this.boundHandleWebGLContextRestored_),this.offsetRotateMatrix_=V(),this.offsetScaleMatrix_=V(),this.tmpMat4_=Ae(),this.uniformLocationsByProgram_={},this.attribLocationsByProgram_={},this.uniforms_=[],e.uniforms&&this.setUniforms(e.uniforms),this.postProcessPasses_=e.postProcesses?e.postProcesses.map(r=>new _e({webGlContext:this.gl_,scaleRatio:r.scaleRatio,vertexShader:r.vertexShader,fragmentShader:r.fragmentShader,uniforms:r.uniforms})):[new _e({webGlContext:this.gl_})],this.shaderCompileErrors_=null,this.startTime_=Date.now(),this.maxAttributeCount_=this.gl_.getParameter(this.gl_.MAX_VERTEX_ATTRIBS)}setUniforms(e){this.uniforms_=[],this.addUniforms(e)}addUniforms(e){for(const t in e)this.uniforms_.push({name:t,value:e[t]})}canvasCacheKeyMatches(e){return this.canvasCacheKey_===Ee(e)}getExtension(e){if(e in this.extensionCache_)return this.extensionCache_[e];const t=this.gl_.getExtension(e);return this.extensionCache_[e]=t,t}getInstancedRenderingExtension_(){const e=this.getExtension("ANGLE_instanced_arrays");return ye(!!e,"WebGL extension 'ANGLE_instanced_arrays' is required for vector rendering"),e}bindBuffer(e){const t=this.gl_,r=I(e);let s=this.bufferCache_[r];if(!s){const n=t.createBuffer();s={buffer:e,webGlBuffer:n},this.bufferCache_[r]=s}t.bindBuffer(e.getType(),s.webGlBuffer)}flushBufferData(e){const t=this.gl_;this.bindBuffer(e),t.bufferData(e.getType(),e.getArray(),e.getUsage())}deleteBuffer(e){const t=I(e);delete this.bufferCache_[t]}disposeInternal(){const e=this.gl_.canvas;e.removeEventListener(W.LOST,this.boundHandleWebGLContextLost_),e.removeEventListener(W.RESTORED,this.boundHandleWebGLContextRestored_),mt(this.canvasCacheKey_),delete this.gl_}prepareDraw(e,t,r){const s=this.gl_,n=this.getCanvas(),o=e.size,a=e.pixelRatio;(n.width!==o[0]*a||n.height!==o[1]*a)&&(n.width=o[0]*a,n.height=o[1]*a,n.style.width=o[0]+"px",n.style.height=o[1]+"px");for(let u=this.postProcessPasses_.length-1;u>=0;u--)this.postProcessPasses_[u].init(e);s.bindTexture(s.TEXTURE_2D,null),s.clearColor(0,0,0,0),s.depthRange(0,1),s.clearDepth(1),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT),s.enable(s.BLEND),s.blendFunc(s.ONE,t?s.ZERO:s.ONE_MINUS_SRC_ALPHA),r?(s.enable(s.DEPTH_TEST),s.depthFunc(s.LEQUAL)):s.disable(s.DEPTH_TEST)}bindFrameBuffer(e,t){const r=this.getGL();r.bindFramebuffer(r.FRAMEBUFFER,e),t&&r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,t,0)}bindInitialFrameBuffer(){const e=this.getGL(),t=this.postProcessPasses_[0].getFrameBuffer();e.bindFramebuffer(e.FRAMEBUFFER,t);const r=this.postProcessPasses_[0].getRenderTargetTexture();e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,r,0)}bindTexture(e,t,r){const s=this.gl_;s.activeTexture(s.TEXTURE0+t),s.bindTexture(s.TEXTURE_2D,e),s.uniform1i(this.getUniformLocation(r),t)}bindAttribute(e,t,r){const s=this.getGL();this.bindBuffer(e);const n=this.getAttributeLocation(t);s.enableVertexAttribArray(n),s.vertexAttribPointer(n,r,s.FLOAT,!1,0,0)}prepareDrawToRenderTarget(e,t,r,s){const n=this.gl_,o=t.getSize();n.bindFramebuffer(n.FRAMEBUFFER,t.getFramebuffer()),n.bindRenderbuffer(n.RENDERBUFFER,t.getDepthbuffer()),n.viewport(0,0,o[0],o[1]),n.bindTexture(n.TEXTURE_2D,t.getTexture()),n.clearColor(0,0,0,0),n.depthRange(0,1),n.clearDepth(1),n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT),n.enable(n.BLEND),n.blendFunc(n.ONE,r?n.ZERO:n.ONE_MINUS_SRC_ALPHA),s?(n.enable(n.DEPTH_TEST),n.depthFunc(n.LEQUAL)):n.disable(n.DEPTH_TEST)}drawElements(e,t){const r=this.gl_;this.getExtension("OES_element_index_uint");const s=r.UNSIGNED_INT,n=4,o=t-e,a=e*n;r.drawElements(r.TRIANGLES,o,s,a)}drawElementsInstanced(e,t,r){const s=this.gl_;this.getExtension("OES_element_index_uint");const n=this.getInstancedRenderingExtension_(),o=s.UNSIGNED_INT,a=4,u=t-e,l=e*a;n.drawElementsInstancedANGLE(s.TRIANGLES,u,o,l,r);for(let h=0;h<this.maxAttributeCount_;h++)n.vertexAttribDivisorANGLE(h,0)}finalizeDraw(e,t,r){for(let s=0,n=this.postProcessPasses_.length;s<n;s++)s===n-1?this.postProcessPasses_[s].apply(e,null,t,r):this.postProcessPasses_[s].apply(e,this.postProcessPasses_[s+1])}getCanvas(){return this.gl_.canvas}getGL(){return this.gl_}applyFrameState(e){const t=e.size,r=e.viewState.rotation,s=e.pixelRatio;this.setUniformFloatValue(P.TIME,(Date.now()-this.startTime_)*.001),this.setUniformFloatValue(P.ZOOM,e.viewState.zoom),this.setUniformFloatValue(P.RESOLUTION,e.viewState.resolution),this.setUniformFloatValue(P.PIXEL_RATIO,s),this.setUniformFloatVec2(P.VIEWPORT_SIZE_PX,[t[0],t[1]]),this.setUniformFloatValue(P.ROTATION,r)}applyHitDetectionUniform(e){const t=this.getUniformLocation(P.HIT_DETECTION);this.getGL().uniform1i(t,e?1:0),e&&this.setUniformFloatValue(P.PIXEL_RATIO,.5)}applyUniforms(e){const t=this.gl_;let r,s=0;this.uniforms_.forEach(n=>{if(r=typeof n.value=="function"?n.value(e):n.value,r instanceof HTMLCanvasElement||r instanceof HTMLImageElement||r instanceof ImageData||r instanceof WebGLTexture){r instanceof WebGLTexture&&!n.texture?(n.prevValue=void 0,n.texture=r):n.texture||(n.prevValue=void 0,n.texture=t.createTexture()),this.bindTexture(n.texture,s,n.name),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE);const o=!(r instanceof HTMLImageElement)||r.complete;!(r instanceof WebGLTexture)&&o&&n.prevValue!==r&&(n.prevValue=r,t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,r)),s++}else if(Array.isArray(r)&&r.length===6)this.setUniformMatrixValue(n.name,Ce(this.tmpMat4_,r));else if(Array.isArray(r)&&r.length<=4)switch(r.length){case 2:t.uniform2f(this.getUniformLocation(n.name),r[0],r[1]);return;case 3:t.uniform3f(this.getUniformLocation(n.name),r[0],r[1],r[2]);return;case 4:t.uniform4f(this.getUniformLocation(n.name),r[0],r[1],r[2],r[3]);return;default:return}else typeof r=="number"&&t.uniform1f(this.getUniformLocation(n.name),r)})}useProgram(e,t){this.disableAllAttributes_(),this.gl_.useProgram(e),this.currentProgram_=e,t&&(this.applyFrameState(t),this.applyUniforms(t))}compileShader(e,t){const r=this.gl_,s=r.createShader(t);return r.shaderSource(s,e),r.compileShader(s),s}getProgram(e,t){const r=this.gl_,s=this.compileShader(e,r.FRAGMENT_SHADER),n=this.compileShader(t,r.VERTEX_SHADER),o=r.createProgram();if(r.attachShader(o,s),r.attachShader(o,n),r.linkProgram(o),!r.getShaderParameter(s,r.COMPILE_STATUS)){const a=`Fragment shader compilation failed: ${r.getShaderInfoLog(s)}`;throw new Error(a)}if(r.deleteShader(s),!r.getShaderParameter(n,r.COMPILE_STATUS)){const a=`Vertex shader compilation failed: ${r.getShaderInfoLog(n)}`;throw new Error(a)}if(r.deleteShader(n),!r.getProgramParameter(o,r.LINK_STATUS)){const a=`GL program linking failed: ${r.getProgramInfoLog(o)}`;throw new Error(a)}return o}getUniformLocation(e){const t=I(this.currentProgram_);return this.uniformLocationsByProgram_[t]===void 0&&(this.uniformLocationsByProgram_[t]={}),this.uniformLocationsByProgram_[t][e]===void 0&&(this.uniformLocationsByProgram_[t][e]=this.gl_.getUniformLocation(this.currentProgram_,e)),this.uniformLocationsByProgram_[t][e]}getAttributeLocation(e){const t=I(this.currentProgram_);return this.attribLocationsByProgram_[t]===void 0&&(this.attribLocationsByProgram_[t]={}),this.attribLocationsByProgram_[t][e]===void 0&&(this.attribLocationsByProgram_[t][e]=this.gl_.getAttribLocation(this.currentProgram_,e)),this.attribLocationsByProgram_[t][e]}makeProjectionTransform(e,t){const r=e.size,s=e.viewState.rotation,n=e.viewState.resolution,o=e.viewState.center;return ve(t,0,0,2/(n*r[0]),2/(n*r[1]),-s,-o[0],-o[1]),t}setUniformFloatValue(e,t){this.gl_.uniform1f(this.getUniformLocation(e),t)}setUniformFloatVec2(e,t){this.gl_.uniform2fv(this.getUniformLocation(e),t)}setUniformFloatVec4(e,t){this.gl_.uniform4fv(this.getUniformLocation(e),t)}setUniformMatrixValue(e,t){this.gl_.uniformMatrix4fv(this.getUniformLocation(e),!1,t)}disableAllAttributes_(){for(let e=0;e<this.maxAttributeCount_;e++)this.gl_.disableVertexAttribArray(e)}enableAttributeArray_(e,t,r,s,n,o){const a=this.getAttributeLocation(e);a<0||(this.gl_.enableVertexAttribArray(a),this.gl_.vertexAttribPointer(a,t,r,!1,s,n),o&&this.getInstancedRenderingExtension_().vertexAttribDivisorANGLE(a,1))}enableAttributes_(e,t){const r=bt(e);let s=0;for(let n=0;n<e.length;n++){const o=e[n];o.name&&this.enableAttributeArray_(o.name,o.size,o.type||De,r,s,t),s+=o.size*Oe(o.type)}}enableAttributes(e){this.enableAttributes_(e,!1)}enableAttributesInstanced(e){this.enableAttributes_(e,!0)}handleWebGLContextLost(e){Me(this.bufferCache_),this.currentProgram_=null,e.preventDefault()}handleWebGLContextRestored(){this.needsToBeRecreated_=!0}needsToBeRecreated(){return this.needsToBeRecreated_}createTexture(e,t,r,s){const n=this.gl_;r=r||n.createTexture();const o=s?n.NEAREST:n.LINEAR;n.bindTexture(n.TEXTURE_2D,r),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,o),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,o),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE);const a=0,u=n.RGBA,l=0,h=n.RGBA,c=n.UNSIGNED_BYTE;return t instanceof Uint8Array?n.texImage2D(n.TEXTURE_2D,a,u,e[0],e[1],l,h,c,t):t?n.texImage2D(n.TEXTURE_2D,a,u,h,c,t):n.texImage2D(n.TEXTURE_2D,a,u,e[0],e[1],l,h,c,null),r}}function bt(i){let e=0;for(let t=0;t<i.length;t++){const r=i[t];e+=r.size*Oe(r.type)}return e}function Oe(i){switch(i){case B.UNSIGNED_BYTE:return Uint8Array.BYTES_PER_ELEMENT;case B.UNSIGNED_SHORT:return Uint16Array.BYTES_PER_ELEMENT;case B.UNSIGNED_INT:return Uint32Array.BYTES_PER_ELEMENT;case B.FLOAT:default:return Float32Array.BYTES_PER_ELEMENT}}class yt extends He{constructor(e){super(),this.tile,this.handleTileChange_=this.handleTileChange_.bind(this),this.gutter=e.gutter||0,this.helper=e.helper,this.loaded=!1,this.ready=!1}setTile(e){if(e!==this.tile)if(this.tile&&this.tile.removeEventListener(M.CHANGE,this.handleTileChange_),this.tile=e,this.loaded=e.getState()===X.LOADED,this.loaded)this.uploadTile();else{if(e instanceof Le){const t=e.getImage();t instanceof Image&&!t.crossOrigin&&(t.crossOrigin="anonymous")}e.addEventListener(M.CHANGE,this.handleTileChange_)}}uploadTile(){Ue()}setReady(){this.ready=!0,this.dispatchEvent(M.CHANGE)}handleTileChange_(){this.tile.getState()===X.LOADED&&(this.loaded=!0,this.uploadTile())}setHelper(e){this.helper=e,this.helper&&this.loaded&&this.uploadTile()}disposeInternal(){this.setHelper(null),this.tile.removeEventListener(M.CHANGE,this.handleTileChange_)}}function Fe(i,e,t){const r=t?i.LINEAR:i.NEAREST;i.bindTexture(i.TEXTURE_2D,e),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,r),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,r)}function At(i,e,t,r){Fe(i,e,r),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,t)}function pe(i,e,t,r,s,n){const o=i.getGL();let a,u;t instanceof Float32Array?(a=o.FLOAT,i.getExtension("OES_texture_float"),u=i.getExtension("OES_texture_float_linear")!==null):(a=o.UNSIGNED_BYTE,u=!0),Fe(o,e,n&&u);const l=t.byteLength/r[1];let h=1;l%8===0?h=8:l%4===0?h=4:l%2===0&&(h=2);let c;switch(s){case 1:{c=o.LUMINANCE;break}case 2:{c=o.LUMINANCE_ALPHA;break}case 3:{c=o.RGB;break}case 4:{c=o.RGBA;break}default:throw new Error(`Unsupported number of bands: ${s}`)}const _=o.getParameter(o.UNPACK_ALIGNMENT);o.pixelStorei(o.UNPACK_ALIGNMENT,h),o.texImage2D(o.TEXTURE_2D,0,c,r[0],r[1],0,c,a,t),o.pixelStorei(o.UNPACK_ALIGNMENT,_)}let G=null;function Ct(){G=Ve(1,1,void 0,{willReadFrequently:!0})}class vt extends yt{constructor(e){super(e),this.textures=[],this.renderSize_=Y(e.grid.getTileSize(e.tile.tileCoord[0])),this.bandCount=NaN;const t=new Ne(re,ie);t.fromArray([0,1,1,1,1,0,0,0]),this.helper.flushBufferData(t),this.coords=t,this.setTile(e.tile)}setHelper(e){var r;const t=(r=this.helper)==null?void 0:r.getGL();if(t){this.helper.deleteBuffer(this.coords);for(let s=0;s<this.textures.length;++s)t.deleteTexture(this.textures[s])}super.setHelper(e),e&&e.flushBufferData(this.coords)}uploadTile(){const e=this.helper,t=e.getGL(),r=this.tile;this.textures.length=0;let s;r instanceof Le||r instanceof We?s=r.getImage():s=r.getData();const n=ce(s);if(n){const E=t.createTexture();this.textures.push(E),this.bandCount=4,At(t,E,n,r.interpolate),this.setReady();return}s=le(s);const o=r.getSize(),a=[o[0]+2*this.gutter,o[1]+2*this.gutter],u=s instanceof Float32Array,l=a[0]*a[1],h=u?Float32Array:Uint8Array,c=h.BYTES_PER_ELEMENT,_=s.byteLength/a[1];this.bandCount=Math.floor(_/c/a[0]);const f=Math.ceil(this.bandCount/4);if(f===1){const E=t.createTexture();this.textures.push(E),pe(e,E,s,a,this.bandCount,r.interpolate),this.setReady();return}const p=new Array(f);for(let E=0;E<f;++E){const g=t.createTexture();this.textures.push(g);const b=E<f-1?4:(this.bandCount-1)%4+1;p[E]=new h(l*b)}let A=0,C=0;const U=a[0]*this.bandCount;for(let E=0;E<a[1];++E){for(let g=0;g<U;++g){const b=s[C+g],m=Math.floor(A/this.bandCount),x=g%this.bandCount,v=Math.floor(x/4),S=p[v],L=S.length/l,y=x%4;S[m*L+y]=b,++A}C+=_/c}for(let E=0;E<f;++E){const g=this.textures[E],b=p[E],m=b.length/l;pe(e,g,b,a,m,r.interpolate)}this.setReady()}getImagePixelData_(e,t,r){const s=this.gutter,n=this.renderSize_[0],o=this.renderSize_[1];G||Ct(),G.clearRect(0,0,1,1);const a=e.width,u=e.height,l=a-2*s,h=u-2*s,c=s+Math.floor(l*(t/n)),_=s+Math.floor(h*(r/o));let f;try{G.drawImage(e,c,_,1,1,0,0,1,1),f=G.getImageData(0,0,1,1).data}catch{return G=null,null}return f}getArrayPixelData_(e,t,r,s){const n=this.gutter,o=this.renderSize_[0],a=this.renderSize_[1],u=t[0],l=t[1],h=u+2*n,c=l+2*n,_=n+Math.floor(u*(r/o)),f=n+Math.floor(l*(s/a));if(e instanceof DataView){const A=e.byteLength/(h*c),C=A*(f*h+_),U=e.buffer.slice(C,C+A);return new DataView(U)}const p=this.bandCount*(f*h+_);return e.slice(p,p+this.bandCount)}getPixelData(e,t){if(!this.loaded)return null;if(this.tile instanceof ze){const r=this.tile.getData(),s=le(r);if(s){const n=this.tile.getSize();return this.getArrayPixelData_(s,n,e,t)}return this.getImagePixelData_(ce(r),e,t)}return this.getImagePixelData_(this.tile.getImage(),e,t)}}class se extends je{constructor(e,t){super(e),t=t||{},this.inversePixelTransform_=V(),this.postProcesses_=t.postProcesses,this.uniforms_=t.uniforms,this.helper,this.onMapChanged_=()=>{this.clearCache(),this.removeHelper()},e.addChangeListener(J.MAP,this.onMapChanged_),this.dispatchPreComposeEvent=this.dispatchPreComposeEvent.bind(this),this.dispatchPostComposeEvent=this.dispatchPostComposeEvent.bind(this)}dispatchPreComposeEvent(e,t){const r=this.getLayer();if(r.hasListener(O.PRECOMPOSE)){const s=new K(O.PRECOMPOSE,void 0,t,e);r.dispatchEvent(s)}}dispatchPostComposeEvent(e,t){const r=this.getLayer();if(r.hasListener(O.POSTCOMPOSE)){const s=new K(O.POSTCOMPOSE,void 0,t,e);r.dispatchEvent(s)}}reset(e){this.uniforms_=e.uniforms,this.helper&&this.helper.setUniforms(this.uniforms_)}removeHelper(){this.helper&&(this.helper.dispose(),delete this.helper)}prepareFrame(e){if(this.getLayer().getRenderSource()){let t=!0,r=-1,s;for(let o=0,a=e.layerStatesArray.length;o<a;o++){const u=e.layerStatesArray[o].layer,l=u.getRenderer();if(!(l instanceof se)){t=!0;continue}const h=u.getClassName();if((t||h!==s)&&(r+=1,t=!1),s=h,l===this)break}const n="map/"+e.mapId+"/group/"+r;(!this.helper||!this.helper.canvasCacheKeyMatches(n)||this.helper.needsToBeRecreated())&&(this.removeHelper(),this.helper=new xt({postProcesses:this.postProcesses_,uniforms:this.uniforms_,canvasCacheKey:n}),s&&(this.helper.getCanvas().className=s),this.afterHelperCreated())}return this.prepareFrameInternal(e)}afterHelperCreated(){}prepareFrameInternal(e){return!0}clearCache(){}disposeInternal(){var e;this.clearCache(),this.removeHelper(),(e=this.getLayer())==null||e.removeChangeListener(J.MAP,this.onMapChanged_),super.disposeInternal()}dispatchRenderEvent_(e,t,r){const s=this.getLayer();if(s.hasListener(e)){ve(this.inversePixelTransform_,0,0,r.pixelRatio,-r.pixelRatio,0,0,-r.size[1]);const n=new K(e,this.inversePixelTransform_,r,t);s.dispatchEvent(n)}}preRender(e,t){this.dispatchRenderEvent_(O.PRERENDER,e,t)}postRender(e,t){this.dispatchRenderEvent_(O.POSTRENDER,e,t)}}const Lt={TILE_TRANSFORM:"u_tileTransform",TRANSITION_ALPHA:"u_transitionAlpha",DEPTH:"u_depth",RENDER_EXTENT:"u_renderExtent",PATTERN_ORIGIN:"u_patternOrigin",RESOLUTION:"u_resolution",ZOOM:"u_zoom",GLOBAL_ALPHA:"u_globalAlpha",PROJECTION_MATRIX:"u_projectionMatrix",SCREEN_TO_WORLD_MATRIX:"u_screenToWorldMatrix"};function Re(i){return 1/(i+2)}function Ut(){return{tileIds:new Set,representationsByZ:{}}}function me(i,e){return i.tileIds.has(I(e))}function xe(i,e,t){const r=i.representationsByZ;t in r||(r[t]=new Set),r[t].add(e),i.tileIds.add(I(e.tile))}function k(i,e){const t=i.layerStatesArray[i.layerIndex];t.extent&&(e=Q(e,Se(t.extent,i.viewState.projection)));const r=t.layer.getRenderSource();if(!r.getWrapX()){const s=r.getTileGridForProjection(i.viewState.projection).getExtent();s&&(e=Q(e,s))}return e}function te(i,e){return`${I(i)},${i.getKey()},${i.getRevision()},${$(e)}`}class St extends se{constructor(e,t){super(e,{uniforms:t.uniforms,postProcesses:t.postProcesses}),this.renderComplete=!1,this.tileTransform_=V(),this.tempMat4=Ae(),this.tempTileRange_=new Ye(0,0,0,0),this.tempTileCoord_=ue(0,0,0),this.tempSize_=[0,0];const r=t.cacheSize!==void 0?t.cacheSize:512;this.tileRepresentationCache=new Ke(r),this.frameState=null,this.renderedProjection_=void 0}reset(e){super.reset({uniforms:e.uniforms})}prepareFrameInternal(e){this.renderedProjection_?e.viewState.projection!==this.renderedProjection_&&(this.clearCache(),this.renderedProjection_=e.viewState.projection):this.renderedProjection_=e.viewState.projection;const r=this.getLayer().getRenderSource();return!r||ke(k(e,e.extent))?!1:r.getState()==="ready"}createTileRepresentation(e){return Ue()}enqueueTiles(e,t,r,s,n){const o=e.viewState,a=this.getLayer(),u=a.getRenderSource(),l=u.getTileGridForProjection(o.projection),h=u.getGutterForProjection(o.projection),c=I(u);c in e.wantedTiles||(e.wantedTiles[c]={});const _=e.wantedTiles[c],f=this.tileRepresentationCache,p=a.getMapInternal(),A=Math.max(r-n,l.getMinZoom(),l.getZForResolution(Math.min(a.getMaxResolution(),p?p.getView().getResolutionForZoom(Math.max(a.getMinZoom(),0)):l.getResolution(0)),u.zDirection)),C=o.rotation,U=C?Ze(o.center,o.resolution,C,e.size):void 0;for(let E=r;E>=A;--E){const g=l.getTileRangeForExtentAndZ(t,E,this.tempTileRange_),b=l.getResolution(E);for(let m=g.minX;m<=g.maxX;++m)for(let x=g.minY;x<=g.maxY;++x){if(C&&!l.tileCoordIntersectsViewport([E,m,x],U))continue;const v=ue(E,m,x,this.tempTileCoord_),S=te(u,v);let L,y;if(f.containsKey(S)&&(L=f.get(S),y=L.tile),(!L||L.tile.key!==u.getKey())&&(y=u.getTile(E,m,x,e.pixelRatio,o.projection),!y)||me(s,y))continue;L?L.setTile(y):(L=this.createTileRepresentation({tile:y,grid:l,helper:this.helper,gutter:h}),f.set(S,L)),xe(s,L,E);const D=y.getKey();_[D]=!0,y.getState()===X.IDLE&&(e.tileQueue.isKeyQueued(D)||e.tileQueue.enqueue([y,c,l.getTileCoordCenter(v),b]))}}}beforeTilesRender(e,t){this.helper.prepareDraw(this.frameState,!t,!0)}beforeTilesMaskRender(e){return!1}renderTile(e,t,r,s,n,o,a,u,l,h,c){}renderTileMask(e,t,r,s){}drawTile_(e,t,r,s,n,o,a){if(!t.ready)return;const l=t.tile.tileCoord,h=$(l),c=h in o?o[h]:1,_=a.getResolution(r),f=Y(a.getTileSize(r),this.tempSize_),p=a.getOrigin(r),A=a.getTileCoordExtent(l),C=c<1?-1:Re(r);c<1&&(e.animate=!0);const U=e.viewState,E=U.center[0],g=U.center[1],b=f[0]+2*s,m=f[1]+2*s,x=b/m,v=(E-p[0])/(f[0]*_),S=(p[1]-g)/(f[1]*_),L=U.resolution/_,y=l[1],D=l[2];qe(this.tileTransform_),he(this.tileTransform_,2/(e.size[0]*L/b),-2/(e.size[1]*L/b)),Je(this.tileTransform_,U.rotation),he(this.tileTransform_,1,1/x),Qe(this.tileTransform_,(f[0]*(y-v)-s)/b,(f[1]*(D-S)-s)/m),this.renderTile(t,this.tileTransform_,e,n,_,f,p,A,C,s,c)}renderFrame(e){this.frameState=e,this.renderComplete=!0;const t=this.helper.getGL();this.preRender(t,e);const r=e.viewState,s=this.getLayer(),n=s.getRenderSource(),o=n.getTileGridForProjection(r.projection),a=n.getGutterForProjection(r.projection),u=k(e,e.extent),l=o.getZForResolution(r.resolution,n.zDirection),h=Ut(),c=s.getPreload();if(e.nextExtent){const g=o.getZForResolution(r.nextResolution,n.zDirection),b=k(e,e.nextExtent);this.enqueueTiles(e,b,g,h,c)}this.enqueueTiles(e,u,l,h,0),c>0&&setTimeout(()=>{this.enqueueTiles(e,u,l-1,h,c-1)},0);const _={};let f=!1;const p=h.representationsByZ;if(l in p){const g=I(this),b=e.time;for(const m of p[l]){const x=m.tile;if(x.getState()===X.EMPTY)continue;const v=x.tileCoord;if(m.ready){const y=x.getAlpha(g,b);if(y===1){x.endTransition(g);continue}f=!0;const D=$(v);_[D]=y}if(this.renderComplete=!1,this.findAltTiles_(o,v,l+1,h))continue;const L=o.getMinZoom();for(let y=l-1;y>=L&&!this.findAltTiles_(o,v,y,h);--y);}}const A=Object.keys(p).map(Number).sort(et);if(this.beforeTilesMaskRender(e))for(let g=0,b=A.length;g<b;++g){const m=A[g];for(const x of p[m]){const v=x.tile.tileCoord;if($(v)in _)continue;const L=o.getTileCoordExtent(v);this.renderTileMask(x,m,L,Re(m))}}this.beforeTilesRender(e,f);for(let g=0,b=A.length;g<b;++g){const m=A[g];for(const x of p[m]){const v=x.tile.tileCoord;$(v)in _||this.drawTile_(e,x,m,a,u,_,o)}}if(l in p)for(const g of p[l]){const b=g.tile.tileCoord;$(b)in _&&this.drawTile_(e,g,l,a,u,_,o)}this.beforeFinalize(e),this.helper.finalizeDraw(e,this.dispatchPreComposeEvent,this.dispatchPostComposeEvent);const U=this.helper.getCanvas();return this.tileRepresentationCache.expireCache(),this.postRender(t,e),U}beforeFinalize(e){}findAltTiles_(e,t,r,s){const n=e.getTileRangeForTileCoordAndZ(t,r,this.tempTileRange_);if(!n)return!1;let o=!0;const a=this.tileRepresentationCache,u=this.getLayer().getRenderSource();for(let l=n.minX;l<=n.maxX;++l)for(let h=n.minY;h<=n.maxY;++h){const c=te(u,[r,l,h]);let _=!1;if(a.containsKey(c)){const f=a.get(c);f.ready&&!me(s,f.tile)&&(xe(s,f,r),_=!0)}_||(o=!1)}return o}clearCache(){super.clearCache();const e=this.tileRepresentationCache;e.forEach(t=>t.dispose()),e.clear()}afterHelperCreated(){super.afterHelperCreated(),this.tileRepresentationCache.forEach(e=>e.setHelper(this.helper))}disposeInternal(){super.disposeInternal(),delete this.frameState}}const T={...Lt,TILE_TEXTURE_ARRAY:"u_tileTextures",TEXTURE_PIXEL_WIDTH:"u_texturePixelWidth",TEXTURE_PIXEL_HEIGHT:"u_texturePixelHeight",TEXTURE_RESOLUTION:"u_textureResolution",TEXTURE_ORIGIN_X:"u_textureOriginX",TEXTURE_ORIGIN_Y:"u_textureOriginY"},z={TEXTURE_COORD:"a_textureCoord"},It=[{name:z.TEXTURE_COORD,size:2,type:B.FLOAT}];class Pt extends St{constructor(e,t){super(e,t),this.program_,this.vertexShader_=t.vertexShader,this.fragmentShader_=t.fragmentShader,this.indices_=new Ne(ne,ie),this.indices_.fromArray([0,1,3,1,2,3]),this.paletteTextures_=t.paletteTextures||[]}reset(e){if(super.reset(e),this.helper){const t=this.helper.getGL();for(const r of this.paletteTextures_)r.delete(t)}if(this.vertexShader_=e.vertexShader,this.fragmentShader_=e.fragmentShader,this.paletteTextures_=e.paletteTextures||[],this.helper){this.program_=this.helper.getProgram(this.fragmentShader_,this.vertexShader_);const t=this.helper.getGL();for(const r of this.paletteTextures_)r.getTexture(t)}}afterHelperCreated(){super.afterHelperCreated();const e=this.helper.getGL();for(const t of this.paletteTextures_)t.getTexture(e);this.program_=this.helper.getProgram(this.fragmentShader_,this.vertexShader_),this.helper.flushBufferData(this.indices_)}removeHelper(){if(this.helper){const e=this.helper.getGL();for(const t of this.paletteTextures_)t.delete(e)}super.removeHelper()}createTileRepresentation(e){return new vt(e)}beforeTilesRender(e,t){super.beforeTilesRender(e,t),this.helper.useProgram(this.program_,e)}renderTile(e,t,r,s,n,o,a,u,l,h,c){const _=this.helper.getGL();this.helper.bindBuffer(e.coords),this.helper.bindBuffer(this.indices_),this.helper.enableAttributes(It);let f=0;for(;f<e.textures.length;){const x=`${T.TILE_TEXTURE_ARRAY}[${f}]`;this.helper.bindTexture(e.textures[f],f,x),++f}for(let x=0;x<this.paletteTextures_.length;++x){const v=this.paletteTextures_[x],S=v.getTexture(_);this.helper.bindTexture(S,f,v.name),++f}const p=r.viewState,A=o[0]+2*h,C=o[1]+2*h,E=e.tile.tileCoord,g=E[1],b=E[2];this.helper.setUniformMatrixValue(T.TILE_TRANSFORM,Ce(this.tempMat4,t)),this.helper.setUniformFloatValue(T.TRANSITION_ALPHA,c),this.helper.setUniformFloatValue(T.DEPTH,l);let m=s;h>0&&(m=u,Q(m,s,m)),this.helper.setUniformFloatVec4(T.RENDER_EXTENT,m),this.helper.setUniformFloatValue(T.RESOLUTION,p.resolution),this.helper.setUniformFloatValue(T.ZOOM,p.zoom),this.helper.setUniformFloatValue(T.TEXTURE_PIXEL_WIDTH,A),this.helper.setUniformFloatValue(T.TEXTURE_PIXEL_HEIGHT,C),this.helper.setUniformFloatValue(T.TEXTURE_RESOLUTION,n),this.helper.setUniformFloatValue(T.TEXTURE_ORIGIN_X,a[0]+g*o[0]*n-h*n),this.helper.setUniformFloatValue(T.TEXTURE_ORIGIN_Y,a[1]-b*o[1]*n+h*n),this.helper.drawElements(0,this.indices_.getSize())}getData(e){if(!this.helper.getGL())return null;const r=this.frameState;if(!r)return null;const s=this.getLayer(),n=tt(r.pixelToCoordinateTransform,e.slice()),o=r.viewState,a=s.getExtent();if(a&&!fe(Se(a,o.projection),n))return null;const u=s.getSources(rt([n]),o.resolution);let l,h,c;for(l=u.length-1;l>=0;--l)if(h=u[l],h.getState()==="ready"){if(c=h.getTileGridForProjection(o.projection),h.getWrapX())break;const f=c.getExtent();if(!f||fe(f,n))break}if(l<0)return null;const _=this.tileRepresentationCache;for(let f=c.getZForResolution(o.resolution);f>=c.getMinZoom();--f){const p=c.getTileCoordForCoordAndZ(n,f),A=te(h,p);if(!_.containsKey(A))continue;const C=_.get(A);if(C.tile.getState()===X.EMPTY)return null;if(!C.loaded)continue;const E=c.getOrigin(f),g=Y(c.getTileSize(f)),b=c.getResolution(f),m=(n[0]-E[0])/b-p[1]*g[0],x=(E[1]-n[1])/b-p[2]*g[1];return C.getPixelData(m,x)}return null}disposeInternal(){const e=this.helper;if(e){const t=e.getGL();for(const r of this.paletteTextures_)r.delete(t);this.paletteTextures_.length=0,t.deleteProgram(this.program_),delete this.program_,e.deleteBuffer(this.indices_)}super.disposeInternal(),delete this.indices_}}class Dt{constructor(e,t){this.name=e,this.data=t,this.texture_=null}getTexture(e){if(!this.texture_){const t=e.createTexture();e.bindTexture(e.TEXTURE_2D,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,this.data.length/4,1,0,e.RGBA,e.UNSIGNED_BYTE,this.data),this.texture_=t}return this.texture_}delete(e){this.texture_&&e.deleteTexture(this.texture_),this.texture_=null}}function Nt(i,e){return`operator_${i}_${Object.keys(e.functions).length}`}function w(i){const e=i.toString();return e.includes(".")?e:e+".0"}function oe(i){if(i.length<2||i.length>4)throw new Error("`formatArray` can only output `vec2`, `vec3` or `vec4` arrays.");return`vec${i.length}(${i.map(w).join(", ")})`}function Ot(i){const e=Pe(i),t=e.length>3?e[3]:1;return oe([e[0]/255,e[1]/255,e[2]/255,t])}function Ft(i){const e=Y(i);return oe(e)}const Z={};let $t=0;function $e(i){return i in Z||(Z[i]=$t++),Z[i]}function Gt(i){return w($e(i))}function Ge(i){return"u_var_"+i}function Bt(){return{variables:{},properties:{},functions:{},bandCount:0,featureId:!1,geometryType:!1}}const q="getBandValue",Be="u_paletteTextures",Xt="featureId",wt="geometryType",Mt=-9999999;function Ht(i,e,t,r){const s=nt(i,e,t);return ae(s,e,r)}function R(i){return(e,t,r)=>{const s=t.args.length,n=new Array(s);for(let o=0;o<s;++o)n[o]=ae(t.args[o],r,e);return i(n,e)}}const Wt={[d.Get]:(i,e)=>{const r=e.args[0].value;r in i.properties||(i.properties[r]={name:r,type:e.type});let n="a_prop_"+r;return Te(e.type,ee)&&(n=`(${n} > 0.0)`),n},[d.Id]:i=>(i.featureId=!0,"a_"+Xt),[d.GeometryType]:i=>(i.geometryType=!0,"a_"+wt),[d.LineMetric]:()=>"currentLineMetric",[d.Var]:(i,e)=>{const r=e.args[0].value;r in i.variables||(i.variables[r]={name:r,type:e.type});let n=Ge(r);return Te(e.type,ee)&&(n=`(${n} > 0.0)`),n},[d.Has]:(i,e)=>{const r=e.args[0].value;return r in i.properties||(i.properties[r]={name:r,type:e.type}),`(a_prop_${r} != ${w(Mt)})`},[d.Resolution]:()=>"u_resolution",[d.Zoom]:()=>"u_zoom",[d.Time]:()=>"u_time",[d.Any]:R(i=>`(${i.join(" || ")})`),[d.All]:R(i=>`(${i.join(" && ")})`),[d.Not]:R(([i])=>`(!${i})`),[d.Equal]:R(([i,e])=>`(${i} == ${e})`),[d.NotEqual]:R(([i,e])=>`(${i} != ${e})`),[d.GreaterThan]:R(([i,e])=>`(${i} > ${e})`),[d.GreaterThanOrEqualTo]:R(([i,e])=>`(${i} >= ${e})`),[d.LessThan]:R(([i,e])=>`(${i} < ${e})`),[d.LessThanOrEqualTo]:R(([i,e])=>`(${i} <= ${e})`),[d.Multiply]:R(i=>`(${i.join(" * ")})`),[d.Divide]:R(([i,e])=>`(${i} / ${e})`),[d.Add]:R(i=>`(${i.join(" + ")})`),[d.Subtract]:R(([i,e])=>`(${i} - ${e})`),[d.Clamp]:R(([i,e,t])=>`clamp(${i}, ${e}, ${t})`),[d.Mod]:R(([i,e])=>`mod(${i}, ${e})`),[d.Pow]:R(([i,e])=>`pow(${i}, ${e})`),[d.Abs]:R(([i])=>`abs(${i})`),[d.Floor]:R(([i])=>`floor(${i})`),[d.Ceil]:R(([i])=>`ceil(${i})`),[d.Round]:R(([i])=>`floor(${i} + 0.5)`),[d.Sin]:R(([i])=>`sin(${i})`),[d.Cos]:R(([i])=>`cos(${i})`),[d.Atan]:R(([i,e])=>e!==void 0?`atan(${i}, ${e})`:`atan(${i})`),[d.Sqrt]:R(([i])=>`sqrt(${i})`),[d.Match]:R(i=>{const e=i[0],t=i[i.length-1];let r=null;for(let s=i.length-3;s>=1;s-=2){const n=i[s],o=i[s+1];r=`(${e} == ${n} ? ${o} : ${r||t})`}return r}),[d.Between]:R(([i,e,t])=>`(${i} >= ${e} && ${i} <= ${t})`),[d.Interpolate]:R(([i,e,...t])=>{let r="";for(let s=0;s<t.length-2;s+=2){const n=t[s],o=r||t[s+1],a=t[s+2],u=t[s+3];let l;i===w(1)?l=`(${e} - ${n}) / (${a} - ${n})`:l=`(pow(${i}, (${e} - ${n})) - 1.0) / (pow(${i}, (${a} - ${n})) - 1.0)`,r=`mix(${o}, ${u}, clamp(${l}, 0.0, 1.0))`}return r}),[d.Case]:R(i=>{const e=i[i.length-1];let t=null;for(let r=i.length-3;r>=0;r-=2){const s=i[r],n=i[r+1];t=`(${s} ? ${n} : ${t||e})`}return t}),[d.In]:R(([i,...e],t)=>{const r=Nt("in",t),s=[];for(let n=0;n<e.length;n+=1)s.push(`  if (inputValue == ${e[n]}) { return true; }`);return t.functions[r]=`bool ${r}(float inputValue) {
${s.join(`
`)}
  return false;
}`,`${r}(${i})`}),[d.Array]:R(i=>`vec${i.length}(${i.join(", ")})`),[d.Color]:R(i=>{if(i.length===1)return`vec4(vec3(${i[0]} / 255.0), 1.0)`;if(i.length===2)return`vec4(vec3(${i[0]} / 255.0), ${i[1]})`;const e=i.slice(0,3).map(r=>`${r} / 255.0`);if(i.length===3)return`vec4(${e.join(", ")}, 1.0)`;const t=i[3];return`vec4(${e.join(", ")}, ${t})`}),[d.Band]:R(([i,e,t],r)=>{if(!(q in r.functions)){let s="";const n=r.bandCount||1;for(let o=0;o<n;o++){const a=Math.floor(o/4);let u=o%4;o===n-1&&u===1&&(u=3);const l=`${T.TILE_TEXTURE_ARRAY}[${a}]`;s+=`  if (band == ${o+1}.0) {
    return texture2D(${l}, v_textureCoord + vec2(dx, dy))[${u}];
  }
`}r.functions[q]=`float getBandValue(float band, float xOffset, float yOffset) {
  float dx = xOffset / ${T.TEXTURE_PIXEL_WIDTH};
  float dy = yOffset / ${T.TEXTURE_PIXEL_HEIGHT};
${s}
}`}return`${q}(${i}, ${e??"0.0"}, ${t??"0.0"})`}),[d.Palette]:(i,e)=>{const[t,...r]=e.args,s=r.length,n=new Uint8Array(s*4);for(let l=0;l<r.length;l++){const h=r[l].value,c=Pe(h),_=l*4;n[_]=c[0],n[_+1]=c[1],n[_+2]=c[2],n[_+3]=c[3]*255}i.paletteTextures||(i.paletteTextures=[]);const o=`${Be}[${i.paletteTextures.length}]`,a=new Dt(o,n);i.paletteTextures.push(a);const u=ae(t,N,i);return`texture2D(${o}, vec2((${u} + 0.5) / ${s}.0, 0.5))`}};function ae(i,e,t){if(i instanceof it){const r=Wt[i.operator];if(r===void 0)throw new Error(`No compiler defined for this operator: ${JSON.stringify(i.operator)}`);return r(t,i,e)}if((i.type&N)>0)return w(i.value);if((i.type&ee)>0)return i.value.toString();if((i.type&st)>0)return Gt(i.value.toString());if((i.type&Ie)>0)return Ot(i.value);if((i.type&ot)>0)return oe(i.value);if((i.type&at)>0)return Ft(i.value);throw new Error(`Unexpected expression ${i.value} (expected type ${lt(e)})`)}function F(i,e,t){const r=ct();return Ht(e,t,r,i)}function be(i,e){const t=`
    attribute vec2 ${z.TEXTURE_COORD};
    uniform mat4 ${T.TILE_TRANSFORM};
    uniform float ${T.TEXTURE_PIXEL_WIDTH};
    uniform float ${T.TEXTURE_PIXEL_HEIGHT};
    uniform float ${T.TEXTURE_RESOLUTION};
    uniform float ${T.TEXTURE_ORIGIN_X};
    uniform float ${T.TEXTURE_ORIGIN_Y};
    uniform float ${T.DEPTH};

    varying vec2 v_textureCoord;
    varying vec2 v_mapCoord;

    void main() {
      v_textureCoord = ${z.TEXTURE_COORD};
      v_mapCoord = vec2(
        ${T.TEXTURE_ORIGIN_X} + ${T.TEXTURE_RESOLUTION} * ${T.TEXTURE_PIXEL_WIDTH} * v_textureCoord[0],
        ${T.TEXTURE_ORIGIN_Y} - ${T.TEXTURE_RESOLUTION} * ${T.TEXTURE_PIXEL_HEIGHT} * v_textureCoord[1]
      );
      gl_Position = ${T.TILE_TRANSFORM} * vec4(${z.TEXTURE_COORD}, ${T.DEPTH}, 1.0);
    }
  `,r={...Bt(),bandCount:e},s=[];if(i.color!==void 0){const c=F(r,i.color,Ie);s.push(`color = ${c};`)}if(i.contrast!==void 0){const c=F(r,i.contrast,N);s.push(`color.rgb = clamp((${c} + 1.0) * color.rgb - (${c} / 2.0), vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0));`)}if(i.exposure!==void 0){const c=F(r,i.exposure,N);s.push(`color.rgb = clamp((${c} + 1.0) * color.rgb, vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0));`)}if(i.saturation!==void 0){const c=F(r,i.saturation,N);s.push(`
      float saturation = ${c} + 1.0;
      float sr = (1.0 - saturation) * 0.2126;
      float sg = (1.0 - saturation) * 0.7152;
      float sb = (1.0 - saturation) * 0.0722;
      mat3 saturationMatrix = mat3(
        sr + saturation, sr, sr,
        sg, sg + saturation, sg,
        sb, sb, sb + saturation
      );
      color.rgb = clamp(saturationMatrix * color.rgb, vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0));
    `)}if(i.gamma!==void 0){const c=F(r,i.gamma,N);s.push(`color.rgb = pow(color.rgb, vec3(1.0 / ${c}));`)}if(i.brightness!==void 0){const c=F(r,i.brightness,N);s.push(`color.rgb = clamp(color.rgb + ${c}, vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0));`)}const n={},o=Object.keys(r.variables).length;if(o>1&&!i.variables)throw new Error(`Missing variables in style (expected ${r.variables})`);for(let c=0;c<o;++c){const _=r.variables[Object.keys(r.variables)[c]];if(!(_.name in i.variables))throw new Error(`Missing '${_.name}' in style variables`);const f=Ge(_.name);n[f]=function(){let p=i.variables[_.name];return typeof p=="string"&&(p=$e(p)),p!==void 0?p:-9999999}}const a=Object.keys(n).map(function(c){return`uniform float ${c};`}),u=Math.ceil(e/4);a.push(`uniform sampler2D ${T.TILE_TEXTURE_ARRAY}[${u}];`),r.paletteTextures&&a.push(`uniform sampler2D ${Be}[${r.paletteTextures.length}];`);const l=Object.keys(r.functions).map(function(c){return r.functions[c]}),h=`
    #ifdef GL_FRAGMENT_PRECISION_HIGH
    precision highp float;
    #else
    precision mediump float;
    #endif

    varying vec2 v_textureCoord;
    varying vec2 v_mapCoord;
    uniform vec4 ${T.RENDER_EXTENT};
    uniform float ${T.TRANSITION_ALPHA};
    uniform float ${T.TEXTURE_PIXEL_WIDTH};
    uniform float ${T.TEXTURE_PIXEL_HEIGHT};
    uniform float ${T.RESOLUTION};
    uniform float ${T.ZOOM};

    ${a.join(`
`)}

    ${l.join(`
`)}

    void main() {
      if (
        v_mapCoord[0] < ${T.RENDER_EXTENT}[0] ||
        v_mapCoord[1] < ${T.RENDER_EXTENT}[1] ||
        v_mapCoord[0] > ${T.RENDER_EXTENT}[2] ||
        v_mapCoord[1] > ${T.RENDER_EXTENT}[3]
      ) {
        discard;
      }

      vec4 color = texture2D(${T.TILE_TEXTURE_ARRAY}[0],  v_textureCoord);

      ${s.join(`
`)}

      gl_FragColor = color;
      gl_FragColor.rgb *= gl_FragColor.a;
      gl_FragColor *= ${T.TRANSITION_ALPHA};
    }`;return{vertexShader:t,fragmentShader:h,uniforms:n,paletteTextures:r.paletteTextures}}class zt extends ut{constructor(e){e=e?Object.assign({},e):{};const t=e.style||{};delete e.style,super(e),this.sources_=e.sources,this.renderedSource_=null,this.renderedResolution_=NaN,this.style_=t,this.styleVariables_=this.style_.variables||{},this.handleSourceUpdate_(),this.addChangeListener(J.SOURCE,this.handleSourceUpdate_)}getSources(e,t){const r=this.getSource();return this.sources_?typeof this.sources_=="function"?this.sources_(e,t):this.sources_:r?[r]:[]}getRenderSource(){return this.renderedSource_||this.getSource()}getSourceState(){const e=this.getRenderSource();return e?e.getState():"undefined"}handleSourceUpdate_(){this.hasRenderer()&&this.getRenderer().clearCache();const e=this.getSource();if(e)if(e.getState()==="loading"){const t=()=>{e.getState()==="ready"&&(e.removeEventListener("change",t),this.setStyle(this.style_))};e.addEventListener("change",t)}else this.setStyle(this.style_)}getSourceBandCount_(){const e=Number.MAX_SAFE_INTEGER,t=this.getSources([-e,-e,e,e],e);return t&&t.length&&"bandCount"in t[0]?t[0].bandCount:4}createRenderer(){const e=be(this.style_,this.getSourceBandCount_());return new Pt(this,{vertexShader:e.vertexShader,fragmentShader:e.fragmentShader,uniforms:e.uniforms,cacheSize:this.getCacheSize(),paletteTextures:e.paletteTextures})}renderSources(e,t){const r=this.getRenderer();let s;for(let n=0,o=t.length;n<o;++n)this.renderedSource_=t[n],r.prepareFrame(e)&&(s=r.renderFrame(e));return s}render(e,t){this.rendered=!0;const r=e.viewState,s=this.getSources(e.extent,r.resolution);let n=!0;for(let a=0,u=s.length;a<u;++a){const l=s[a],h=l.getState();if(h=="loading"){const c=()=>{l.getState()=="ready"&&(l.removeEventListener("change",c),this.changed())};l.addEventListener("change",c)}n=n&&h=="ready"}const o=this.renderSources(e,s);if(this.getRenderer().renderComplete&&n)return this.renderedResolution_=r.resolution,o;if(this.renderedResolution_>.5*r.resolution){const a=this.getSources(e.extent,this.renderedResolution_).filter(u=>!s.includes(u));if(a.length>0)return this.renderSources(e,a)}return o}setStyle(e){if(this.styleVariables_=e.variables||{},this.style_=e,this.hasRenderer()){const t=be(this.style_,this.getSourceBandCount_());this.getRenderer().reset({vertexShader:t.vertexShader,fragmentShader:t.fragmentShader,uniforms:t.uniforms,paletteTextures:t.paletteTextures}),this.changed()}}updateStyleVariables(e){Object.assign(this.styleVariables_,e),this.changed()}}zt.prototype.dispose;export{zt as W};

const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/chunks/index.BWVV-4Km.js","assets/chunks/olcs.Cqh799zv.js","assets/chunks/cesium.DzXtLnwn.js","assets/chunks/addCommonStyleSheet.SqMauTqt.js","assets/chunks/index.BtQ3GkzH.js","assets/chunks/index.Du0sVlOV.js","assets/chunks/getElement.CdRlZPdn.js","assets/chunks/geojson.C01JoNzj.js","assets/chunks/WebGLTile.D_NuozSC.js","assets/chunks/item.C4vh4W0H.js","assets/chunks/Map.hMK3qLcu.js","assets/chunks/eo-dash.C1XGZ0Eg.js","assets/chunks/runtime-dom.esm-bundler.CVWPxwnJ.js","assets/chunks/runtime-core.esm-bundler.MgDDUQih.js","assets/chunks/mdi.C8D1Z8V3.js","assets/chunks/create-layers-config-BrGl0JJZ.DSR0yk3j.js","assets/chunks/easing-CH0-9wR8.CTB3jml5.js","assets/chunks/EodashMapBtns-C6qznNP_.UqTyhmqj.js","assets/chunks/ExportState-Cq9eqmKk.BITBLzL4.js","assets/chunks/PopUp-CZjSPnvI.BoiPdQUA.js","assets/chunks/forwardRefs-64mgSLjK.BpVEf6-p.js","assets/chunks/transition-BwFOaDL9.CcFMTQO6.js","assets/chunks/main.8saUv_hF.js","assets/chunks/sequential.BcvVcPN9.js","assets/chunks/orient2d.DArCjZZA.js","assets/chunks/VImg-D-DGacjc.CSxDldPR.js","assets/chunks/EodashItemFilter-dQfMpu1q.B_2I1hIP.js","assets/chunks/handling-Df_d9h0M.CP2A6qYa.js","assets/chunks/async-D_q14ueQ.D9OdMPdm.js","assets/chunks/utils.CdF70kIP.js","assets/chunks/index.2GfG_t-c.js","assets/chunks/mosaic-ByH9wgDF.BEWy634w.js","assets/chunks/directive.CvdRHFdJ.js","assets/chunks/unsafe-html.hV7nDmyB.js","assets/chunks/index.B3SgK6yd.js"])))=>i.map(i=>d[i]);
var Sd=Object.defineProperty;var $u=l=>{throw TypeError(l)};var Cd=(l,t,n)=>t in l?Sd(l,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):l[t]=n;var Cu=(l,t,n)=>Cd(l,typeof t!="symbol"?t+"":t,n),Nu=(l,t,n)=>t.has(l)||$u("Cannot "+n);var qi=(l,t,n)=>(Nu(l,t,"read from private field"),n?n.call(l):t.get(l)),mo=(l,t,n)=>t.has(l)?$u("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(l):t.set(l,n),Pc=(l,t,n,s)=>(Nu(l,t,"write to private field"),s?s.call(l,n):t.set(l,n),n),Mc=(l,t,n)=>(Nu(l,t,"access private method"),n);import{cd as Pbf,Z as fromBlob,$ as fromUrls,a0 as fromUrl,a1 as Pool,a2 as photometricInterpretations,_ as __vitePreload}from"./olcs.Cqh799zv.js";import{i,b,A,a as addCommonStylesheet,e as eoxStyle}from"./addCommonStyleSheet.SqMauTqt.js";import{q as quickselect}from"./cesium.DzXtLnwn.js";import{r,s as serialize$1}from"./index.BtQ3GkzH.js";import{p as proj4}from"./index.Du0sVlOV.js";import{g as getElement}from"./getElement.CdRlZPdn.js";import{a as apply$1,S as STACLayer,d as deserialize}from"./geojson.C01JoNzj.js";import{_ as _export_sfc,b1 as mapPosition,W as useDisplay,af as storeToRefs,u as useSTAcStore,an as mapEl,ba as timesliderUpdateRef,am as mapCompareEl,k as datetime,ak as eodashCollections,bb as useLayout,i as indicator,j as compareIndicator,p as poi,aw as isGlobe,n as log,aq as useOnLayersUpdate,o as mustache,au as layerControlFormValue,at as layerControlFormValueCompare,al as eodashCompareCollections,bc as setMapProjFromCol,F as useEmitLayersUpdate,q as isFirstLoad,ar as sanitizeBbox}from"./eo-dash.C1XGZ0Eg.js";import{c as createLayersConfig}from"./create-layers-config-BrGl0JJZ.DSR0yk3j.js";import{i as inAndOut$1}from"./easing-CH0-9wR8.CTB3jml5.js";import EodashMapBtns from"./EodashMapBtns-C6qznNP_.UqTyhmqj.js";import{g as computed,aH as withAsyncContext,L as useTemplateRef,ad as toRaw,j as ref,l as onMounted,c as createElementBlock,o as openBlock,i as createBaseVNode,f as createCommentVNode,u as unref,C as normalizeStyle,y as createVNode,m as onUnmounted,w as watch}from"./runtime-core.esm-bundler.MgDDUQih.js";const CollectionEventType={ADD:"add",REMOVE:"remove"},ObjectEventType={PROPERTYCHANGE:"propertychange"},EventType$1={CHANGE:"change",ERROR:"error",CONTEXTMENU:"contextmenu",CLICK:"click",DBLCLICK:"dblclick",KEYDOWN:"keydown",KEYPRESS:"keypress",LOAD:"load",TOUCHMOVE:"touchmove",WHEEL:"wheel"};class Disposable{constructor(){this.disposed=!1}dispose(){this.disposed||(this.disposed=!0,this.disposeInternal())}disposeInternal(){}}function binarySearch(l,t,n){let s,o;n=n||ascending;let a=0,h=l.length,c=!1;for(;a<h;)s=a+(h-a>>1),o=+n(l[s],t),o<0?a=s+1:(h=s,c=!o);return c?a:~a}function ascending(l,t){return l>t?1:l<t?-1:0}function descending(l,t){return l<t?1:l>t?-1:0}function linearFindNearest(l,t,n){if(l[0]<=t)return 0;const s=l.length;if(t<=l[s-1])return s-1;if(typeof n=="function"){for(let o=1;o<s;++o){const a=l[o];if(a===t)return o;if(a<t)return n(t,l[o-1],a)>0?o-1:o}return s-1}if(n>0){for(let o=1;o<s;++o)if(l[o]<t)return o-1;return s-1}if(n<0){for(let o=1;o<s;++o)if(l[o]<=t)return o;return s-1}for(let o=1;o<s;++o){if(l[o]==t)return o;if(l[o]<t)return l[o-1]-t<t-l[o]?o-1:o}return s-1}function reverseSubArray(l,t,n){for(;t<n;){const s=l[t];l[t]=l[n],l[n]=s,++t,--n}}function extend$2(l,t){const n=Array.isArray(t)?t:[t],s=n.length;for(let o=0;o<s;o++)l[l.length]=n[o]}function equals$2(l,t){const n=l.length;if(n!==t.length)return!1;for(let s=0;s<n;s++)if(l[s]!==t[s])return!1;return!0}function isSorted(l,t,n){const s=t||ascending;return l.every(function(o,a){if(a===0)return!0;const h=s(l[a-1],o);return!(h>0||h===0)})}function TRUE(){return!0}function FALSE(){return!1}function VOID(){}function memoizeOne(l){let t,n,s;return function(){const o=Array.prototype.slice.call(arguments);return(!n||this!==s||!equals$2(o,n))&&(s=this,n=o,t=l.apply(this,arguments)),t}}function toPromise(l){function t(){let n;try{n=l()}catch(s){return Promise.reject(s)}return n instanceof Promise?n:Promise.resolve(n)}return t()}function clear(l){for(const t in l)delete l[t]}function isEmpty$1(l){let t;for(t in l)return!1;return!t}class BaseEvent{constructor(t){this.propagationStopped,this.defaultPrevented,this.type=t,this.target=null}preventDefault(){this.defaultPrevented=!0}stopPropagation(){this.propagationStopped=!0}}function stopPropagation(l){l.stopPropagation()}class Target extends Disposable{constructor(t){super(),this.eventTarget_=t,this.pendingRemovals_=null,this.dispatching_=null,this.listeners_=null}addEventListener(t,n){if(!t||!n)return;const s=this.listeners_||(this.listeners_={}),o=s[t]||(s[t]=[]);o.includes(n)||o.push(n)}dispatchEvent(t){const n=typeof t=="string",s=n?t:t.type,o=this.listeners_&&this.listeners_[s];if(!o)return;const a=n?new BaseEvent(t):t;a.target||(a.target=this.eventTarget_||this);const h=this.dispatching_||(this.dispatching_={}),c=this.pendingRemovals_||(this.pendingRemovals_={});s in h||(h[s]=0,c[s]=0),++h[s];let u;for(let d=0,f=o.length;d<f;++d)if("handleEvent"in o[d]?u=o[d].handleEvent(a):u=o[d].call(this,a),u===!1||a.propagationStopped){u=!1;break}if(--h[s]===0){let d=c[s];for(delete c[s];d--;)this.removeEventListener(s,VOID);delete h[s]}return u}disposeInternal(){this.listeners_&&clear(this.listeners_)}getListeners(t){return this.listeners_&&this.listeners_[t]||void 0}hasListener(t){return this.listeners_?t?t in this.listeners_:Object.keys(this.listeners_).length>0:!1}removeEventListener(t,n){if(!this.listeners_)return;const s=this.listeners_[t];if(!s)return;const o=s.indexOf(n);o!==-1&&(this.pendingRemovals_&&t in this.pendingRemovals_?(s[o]=VOID,++this.pendingRemovals_[t]):(s.splice(o,1),s.length===0&&delete this.listeners_[t]))}}function listen(l,t,n,s,o){if(o){const h=n;n=function(c){return l.removeEventListener(t,n),h.call(s??this,c)}}else s&&s!==l&&(n=n.bind(s));const a={target:l,type:t,listener:n};return l.addEventListener(t,n),a}function listenOnce(l,t,n,s){return listen(l,t,n,s,!0)}function unlistenByKey(l){l&&l.target&&(l.target.removeEventListener(l.type,l.listener),clear(l))}class Observable extends Target{constructor(){super(),this.on=this.onInternal,this.once=this.onceInternal,this.un=this.unInternal,this.revision_=0}changed(){++this.revision_,this.dispatchEvent(EventType$1.CHANGE)}getRevision(){return this.revision_}onInternal(t,n){if(Array.isArray(t)){const s=t.length,o=new Array(s);for(let a=0;a<s;++a)o[a]=listen(this,t[a],n);return o}return listen(this,t,n)}onceInternal(t,n){let s;if(Array.isArray(t)){const o=t.length;s=new Array(o);for(let a=0;a<o;++a)s[a]=listenOnce(this,t[a],n)}else s=listenOnce(this,t,n);return n.ol_key=s,s}unInternal(t,n){const s=n.ol_key;if(s)unByKey(s);else if(Array.isArray(t))for(let o=0,a=t.length;o<a;++o)this.removeEventListener(t[o],n);else this.removeEventListener(t,n)}}Observable.prototype.on;Observable.prototype.once;Observable.prototype.un;function unByKey(l){if(Array.isArray(l))for(let t=0,n=l.length;t<n;++t)unlistenByKey(l[t]);else unlistenByKey(l)}function abstract(){throw new Error("Unimplemented abstract method.")}let uidCounter_=0;function getUid(l){return l.ol_uid||(l.ol_uid=String(++uidCounter_))}class ObjectEvent extends BaseEvent{constructor(t,n,s){super(t),this.key=n,this.oldValue=s}}class BaseObject extends Observable{constructor(t){super(),this.on,this.once,this.un,getUid(this),this.values_=null,t!==void 0&&this.setProperties(t)}get(t){let n;return this.values_&&this.values_.hasOwnProperty(t)&&(n=this.values_[t]),n}getKeys(){return this.values_&&Object.keys(this.values_)||[]}getProperties(){return this.values_&&Object.assign({},this.values_)||{}}getPropertiesInternal(){return this.values_}hasProperties(){return!!this.values_}notify(t,n){let s;s=`change:${t}`,this.hasListener(s)&&this.dispatchEvent(new ObjectEvent(s,t,n)),s=ObjectEventType.PROPERTYCHANGE,this.hasListener(s)&&this.dispatchEvent(new ObjectEvent(s,t,n))}addChangeListener(t,n){this.addEventListener(`change:${t}`,n)}removeChangeListener(t,n){this.removeEventListener(`change:${t}`,n)}set(t,n,s){const o=this.values_||(this.values_={});if(s)o[t]=n;else{const a=o[t];o[t]=n,a!==n&&this.notify(t,a)}}setProperties(t,n){for(const s in t)this.set(s,t[s],n)}applyProperties(t){t.values_&&Object.assign(this.values_||(this.values_={}),t.values_)}unset(t,n){if(this.values_&&t in this.values_){const s=this.values_[t];delete this.values_[t],isEmpty$1(this.values_)&&(this.values_=null),n||this.notify(t,s)}}}const Property$5={LENGTH:"length"};class CollectionEvent extends BaseEvent{constructor(t,n,s){super(t),this.element=n,this.index=s}}class Collection extends BaseObject{constructor(t,n){if(super(),this.on,this.once,this.un,n=n||{},this.unique_=!!n.unique,this.array_=t??[],this.unique_)for(let s=1,o=this.array_.length;s<o;++s)this.assertUnique_(this.array_[s],s);this.updateLength_()}clear(){for(;this.getLength()>0;)this.pop()}extend(t){for(let n=0,s=t.length;n<s;++n)this.push(t[n]);return this}forEach(t){const n=this.array_;for(let s=0,o=n.length;s<o;++s)t(n[s],s,n)}getArray(){return this.array_}item(t){return this.array_[t]}getLength(){return this.get(Property$5.LENGTH)}insertAt(t,n){if(t<0||t>this.getLength())throw new Error("Index out of bounds: "+t);this.unique_&&this.assertUnique_(n),this.array_.splice(t,0,n),this.updateLength_(),this.dispatchEvent(new CollectionEvent(CollectionEventType.ADD,n,t))}pop(){return this.removeAt(this.getLength()-1)}push(t){const n=this.getLength();return this.insertAt(n,t),this.getLength()}remove(t){const n=this.array_;for(let s=0,o=n.length;s<o;++s)if(n[s]===t)return this.removeAt(s)}removeAt(t){if(t<0||t>=this.getLength())return;const n=this.array_[t];return this.array_.splice(t,1),this.updateLength_(),this.dispatchEvent(new CollectionEvent(CollectionEventType.REMOVE,n,t)),n}setAt(t,n){const s=this.getLength();if(t>=s){this.insertAt(t,n);return}if(t<0)throw new Error("Index out of bounds: "+t);this.unique_&&this.assertUnique_(n,t);const o=this.array_[t];this.array_[t]=n,this.dispatchEvent(new CollectionEvent(CollectionEventType.REMOVE,o,t)),this.dispatchEvent(new CollectionEvent(CollectionEventType.ADD,n,t))}updateLength_(){this.set(Property$5.LENGTH,this.array_.length)}assertUnique_(t,n){const s=this.array_;for(let o=0,a=s.length;o<a;++o)if(s[o]===t&&o!==n)throw new Error("Duplicate item added to a unique collection")}}class MapEvent extends BaseEvent{constructor(t,n,s){super(t),this.map=n,this.frameState=s!==void 0?s:null}}class MapBrowserEvent extends MapEvent{constructor(t,n,s,o,a,h){super(t,n,a),this.originalEvent=s,this.pixel_=null,this.coordinate_=null,this.dragging=o!==void 0?o:!1,this.activePointers=h}get pixel(){return this.pixel_||(this.pixel_=this.map.getEventPixel(this.originalEvent)),this.pixel_}set pixel(t){this.pixel_=t}get coordinate(){return this.coordinate_||(this.coordinate_=this.map.getCoordinateFromPixel(this.pixel)),this.coordinate_}set coordinate(t){this.coordinate_=t}preventDefault(){super.preventDefault(),"preventDefault"in this.originalEvent&&this.originalEvent.preventDefault()}stopPropagation(){super.stopPropagation(),"stopPropagation"in this.originalEvent&&this.originalEvent.stopPropagation()}}const MapBrowserEventType={SINGLECLICK:"singleclick",CLICK:EventType$1.CLICK,DBLCLICK:EventType$1.DBLCLICK,POINTERDRAG:"pointerdrag",POINTERMOVE:"pointermove",POINTERDOWN:"pointerdown",POINTERUP:"pointerup",POINTEROVER:"pointerover",POINTEROUT:"pointerout",POINTERENTER:"pointerenter",POINTERLEAVE:"pointerleave",POINTERCANCEL:"pointercancel"},ua$1=typeof navigator<"u"&&typeof navigator.userAgent<"u"?navigator.userAgent.toLowerCase():"",SAFARI=ua$1.includes("safari")&&!ua$1.includes("chrom"),SAFARI_BUG_237906=SAFARI&&(ua$1.includes("version/15.4")||/cpu (os|iphone os) 15_4 like mac os x/.test(ua$1)),WEBKIT=ua$1.includes("webkit")&&!ua$1.includes("edge"),MAC=ua$1.includes("macintosh"),DEVICE_PIXEL_RATIO=typeof devicePixelRatio<"u"?devicePixelRatio:1,WORKER_OFFSCREEN_CANVAS=typeof WorkerGlobalScope<"u"&&typeof OffscreenCanvas<"u"&&self instanceof WorkerGlobalScope,IMAGE_DECODE=typeof Image<"u"&&Image.prototype.decode,CREATE_IMAGE_BITMAP=typeof createImageBitmap=="function",PASSIVE_EVENT_LISTENERS=function(){let l=!1;try{const t=Object.defineProperty({},"passive",{get:function(){l=!0}});window.addEventListener("_",null,t),window.removeEventListener("_",null,t)}catch{}return l}(),EventType={POINTERMOVE:"pointermove",POINTERDOWN:"pointerdown",POINTERUP:"pointerup",POINTEROUT:"pointerout"};class MapBrowserEventHandler extends Target{constructor(t,n){super(t),this.map_=t,this.clickTimeoutId_,this.emulateClicks_=!1,this.dragging_=!1,this.dragListenerKeys_=[],this.moveTolerance_=n===void 0?1:n,this.down_=null;const s=this.map_.getViewport();this.activePointers_=[],this.trackedTouches_={},this.element_=s,this.pointerdownListenerKey_=listen(s,EventType.POINTERDOWN,this.handlePointerDown_,this),this.originalPointerMoveEvent_,this.relayedListenerKey_=listen(s,EventType.POINTERMOVE,this.relayMoveEvent_,this),this.boundHandleTouchMove_=this.handleTouchMove_.bind(this),this.element_.addEventListener(EventType$1.TOUCHMOVE,this.boundHandleTouchMove_,PASSIVE_EVENT_LISTENERS?{passive:!1}:!1)}emulateClick_(t){let n=new MapBrowserEvent(MapBrowserEventType.CLICK,this.map_,t);this.dispatchEvent(n),this.clickTimeoutId_!==void 0?(clearTimeout(this.clickTimeoutId_),this.clickTimeoutId_=void 0,n=new MapBrowserEvent(MapBrowserEventType.DBLCLICK,this.map_,t),this.dispatchEvent(n)):this.clickTimeoutId_=setTimeout(()=>{this.clickTimeoutId_=void 0;const s=new MapBrowserEvent(MapBrowserEventType.SINGLECLICK,this.map_,t);this.dispatchEvent(s)},250)}updateActivePointers_(t){const n=t,s=n.pointerId;if(n.type==MapBrowserEventType.POINTERUP||n.type==MapBrowserEventType.POINTERCANCEL){delete this.trackedTouches_[s];for(const o in this.trackedTouches_)if(this.trackedTouches_[o].target!==n.target){delete this.trackedTouches_[o];break}}else(n.type==MapBrowserEventType.POINTERDOWN||n.type==MapBrowserEventType.POINTERMOVE)&&(this.trackedTouches_[s]=n);this.activePointers_=Object.values(this.trackedTouches_)}handlePointerUp_(t){this.updateActivePointers_(t);const n=new MapBrowserEvent(MapBrowserEventType.POINTERUP,this.map_,t,void 0,void 0,this.activePointers_);this.dispatchEvent(n),this.emulateClicks_&&!n.defaultPrevented&&!this.dragging_&&this.isMouseActionButton_(t)&&this.emulateClick_(this.down_),this.activePointers_.length===0&&(this.dragListenerKeys_.forEach(unlistenByKey),this.dragListenerKeys_.length=0,this.dragging_=!1,this.down_=null)}isMouseActionButton_(t){return t.button===0}handlePointerDown_(t){this.emulateClicks_=this.activePointers_.length===0,this.updateActivePointers_(t);const n=new MapBrowserEvent(MapBrowserEventType.POINTERDOWN,this.map_,t,void 0,void 0,this.activePointers_);if(this.dispatchEvent(n),this.down_=new PointerEvent(t.type,t),Object.defineProperty(this.down_,"target",{writable:!1,value:t.target}),this.dragListenerKeys_.length===0){const s=this.map_.getOwnerDocument();this.dragListenerKeys_.push(listen(s,MapBrowserEventType.POINTERMOVE,this.handlePointerMove_,this),listen(s,MapBrowserEventType.POINTERUP,this.handlePointerUp_,this),listen(this.element_,MapBrowserEventType.POINTERCANCEL,this.handlePointerUp_,this)),this.element_.getRootNode&&this.element_.getRootNode()!==s&&this.dragListenerKeys_.push(listen(this.element_.getRootNode(),MapBrowserEventType.POINTERUP,this.handlePointerUp_,this))}}handlePointerMove_(t){if(this.isMoving_(t)){this.updateActivePointers_(t),this.dragging_=!0;const n=new MapBrowserEvent(MapBrowserEventType.POINTERDRAG,this.map_,t,this.dragging_,void 0,this.activePointers_);this.dispatchEvent(n)}}relayMoveEvent_(t){this.originalPointerMoveEvent_=t;const n=!!(this.down_&&this.isMoving_(t));this.dispatchEvent(new MapBrowserEvent(MapBrowserEventType.POINTERMOVE,this.map_,t,n))}handleTouchMove_(t){const n=this.originalPointerMoveEvent_;(!n||n.defaultPrevented)&&(typeof t.cancelable!="boolean"||t.cancelable===!0)&&t.preventDefault()}isMoving_(t){return this.dragging_||Math.abs(t.clientX-this.down_.clientX)>this.moveTolerance_||Math.abs(t.clientY-this.down_.clientY)>this.moveTolerance_}disposeInternal(){this.relayedListenerKey_&&(unlistenByKey(this.relayedListenerKey_),this.relayedListenerKey_=null),this.element_.removeEventListener(EventType$1.TOUCHMOVE,this.boundHandleTouchMove_),this.pointerdownListenerKey_&&(unlistenByKey(this.pointerdownListenerKey_),this.pointerdownListenerKey_=null),this.dragListenerKeys_.forEach(unlistenByKey),this.dragListenerKeys_.length=0,this.element_=null,super.disposeInternal()}}const MapEventType={POSTRENDER:"postrender",MOVESTART:"movestart",MOVEEND:"moveend",LOADSTART:"loadstart",LOADEND:"loadend"},MapProperty={LAYERGROUP:"layergroup",SIZE:"size",TARGET:"target",VIEW:"view"},TileState={IDLE:0,LOADING:1,LOADED:2,ERROR:3,EMPTY:4};function assert(l,t){if(!l)throw new Error(t)}const DROP=1/0;class PriorityQueue{constructor(t,n){this.priorityFunction_=t,this.keyFunction_=n,this.elements_=[],this.priorities_=[],this.queuedElements_={}}clear(){this.elements_.length=0,this.priorities_.length=0,clear(this.queuedElements_)}dequeue(){const t=this.elements_,n=this.priorities_,s=t[0];t.length==1?(t.length=0,n.length=0):(t[0]=t.pop(),n[0]=n.pop(),this.siftUp_(0));const o=this.keyFunction_(s);return delete this.queuedElements_[o],s}enqueue(t){assert(!(this.keyFunction_(t)in this.queuedElements_),"Tried to enqueue an `element` that was already added to the queue");const n=this.priorityFunction_(t);return n!=DROP?(this.elements_.push(t),this.priorities_.push(n),this.queuedElements_[this.keyFunction_(t)]=!0,this.siftDown_(0,this.elements_.length-1),!0):!1}getCount(){return this.elements_.length}getLeftChildIndex_(t){return t*2+1}getRightChildIndex_(t){return t*2+2}getParentIndex_(t){return t-1>>1}heapify_(){let t;for(t=(this.elements_.length>>1)-1;t>=0;t--)this.siftUp_(t)}isEmpty(){return this.elements_.length===0}isKeyQueued(t){return t in this.queuedElements_}isQueued(t){return this.isKeyQueued(this.keyFunction_(t))}siftUp_(t){const n=this.elements_,s=this.priorities_,o=n.length,a=n[t],h=s[t],c=t;for(;t<o>>1;){const u=this.getLeftChildIndex_(t),d=this.getRightChildIndex_(t),f=d<o&&s[d]<s[u]?d:u;n[t]=n[f],s[t]=s[f],t=f}n[t]=a,s[t]=h,this.siftDown_(c,t)}siftDown_(t,n){const s=this.elements_,o=this.priorities_,a=s[n],h=o[n];for(;n>t;){const c=this.getParentIndex_(n);if(o[c]>h)s[n]=s[c],o[n]=o[c],n=c;else break}s[n]=a,o[n]=h}reprioritize(){const t=this.priorityFunction_,n=this.elements_,s=this.priorities_;let o=0;const a=n.length;let h,c,u;for(c=0;c<a;++c)h=n[c],u=t(h),u==DROP?delete this.queuedElements_[this.keyFunction_(h)]:(s[o]=u,n[o++]=h);n.length=o,s.length=o,this.heapify_()}}class TileQueue extends PriorityQueue{constructor(t,n){super(s=>t.apply(null,s),s=>s[0].getKey()),this.boundHandleTileChange_=this.handleTileChange.bind(this),this.tileChangeCallback_=n,this.tilesLoading_=0,this.tilesLoadingKeys_={}}enqueue(t){const n=super.enqueue(t);return n&&t[0].addEventListener(EventType$1.CHANGE,this.boundHandleTileChange_),n}getTilesLoading(){return this.tilesLoading_}handleTileChange(t){const n=t.target,s=n.getState();if(s===TileState.LOADED||s===TileState.ERROR||s===TileState.EMPTY){s!==TileState.ERROR&&n.removeEventListener(EventType$1.CHANGE,this.boundHandleTileChange_);const o=n.getKey();o in this.tilesLoadingKeys_&&(delete this.tilesLoadingKeys_[o],--this.tilesLoading_),this.tileChangeCallback_()}}loadMoreTiles(t,n){let s=0;for(;this.tilesLoading_<t&&s<n&&this.getCount()>0;){const o=this.dequeue()[0],a=o.getKey();o.getState()===TileState.IDLE&&!(a in this.tilesLoadingKeys_)&&(this.tilesLoadingKeys_[a]=!0,++this.tilesLoading_,++s,o.load())}}}function getTilePriority(l,t,n,s,o){if(!l||!(n in l.wantedTiles)||!l.wantedTiles[n][t.getKey()])return DROP;const a=l.viewState.center,h=s[0]-a[0],c=s[1]-a[1];return 65536*Math.log(o)+Math.sqrt(h*h+c*c)/o}const ViewHint={ANIMATING:0,INTERACTING:1},ViewProperty={CENTER:"center",RESOLUTION:"resolution",ROTATION:"rotation"};function clamp(l,t,n){return Math.min(Math.max(l,t),n)}function squaredSegmentDistance(l,t,n,s,o,a){const h=o-n,c=a-s;if(h!==0||c!==0){const u=((l-n)*h+(t-s)*c)/(h*h+c*c);u>1?(n=o,s=a):u>0&&(n+=h*u,s+=c*u)}return squaredDistance$1(l,t,n,s)}function squaredDistance$1(l,t,n,s){const o=n-l,a=s-t;return o*o+a*a}function solveLinearSystem(l){const t=l.length;for(let s=0;s<t;s++){let o=s,a=Math.abs(l[s][s]);for(let c=s+1;c<t;c++){const u=Math.abs(l[c][s]);u>a&&(a=u,o=c)}if(a===0)return null;const h=l[o];l[o]=l[s],l[s]=h;for(let c=s+1;c<t;c++){const u=-l[c][s]/l[s][s];for(let d=s;d<t+1;d++)s==d?l[c][d]=0:l[c][d]+=u*l[s][d]}}const n=new Array(t);for(let s=t-1;s>=0;s--){n[s]=l[s][t]/l[s][s];for(let o=s-1;o>=0;o--)l[o][t]-=l[o][s]*n[s]}return n}function toDegrees(l){return l*180/Math.PI}function toRadians(l){return l*Math.PI/180}function modulo(l,t){const n=l%t;return n*t<0?n+t:n}function lerp(l,t,n){return l+n*(t-l)}function toFixed(l,t){const n=Math.pow(10,t);return Math.round(l*n)/n}function round(l,t){return Math.round(toFixed(l,t))}function floor(l,t){return Math.floor(toFixed(l,t))}function ceil(l,t){return Math.ceil(toFixed(l,t))}function wrap(l,t,n){if(l>=t&&l<n)return l;const s=n-t;return((l-t)%s+s)%s+t}function createExtent(l,t,n){return function(s,o,a,h,c){if(!s)return;if(!o&&!t)return s;const u=t?0:a[0]*o,d=t?0:a[1]*o,f=c?c[0]:0,g=c?c[1]:0;let _=l[0]+u/2+f,m=l[2]-u/2+f,p=l[1]+d/2+g,x=l[3]-d/2+g;_>m&&(_=(m+_)/2,m=_),p>x&&(p=(x+p)/2,x=p);let y=clamp(s[0],_,m),T=clamp(s[1],p,x);if(h&&n&&o){const S=30*o;y+=-S*Math.log(1+Math.max(0,_-s[0])/S)+S*Math.log(1+Math.max(0,s[0]-m)/S),T+=-S*Math.log(1+Math.max(0,p-s[1])/S)+S*Math.log(1+Math.max(0,s[1]-x)/S)}return[y,T]}}function none$1(l){return l}const Relationship={UNKNOWN:0,INTERSECTING:1,ABOVE:2,RIGHT:4,BELOW:8,LEFT:16};function boundingExtent(l){const t=createEmpty();for(let n=0,s=l.length;n<s;++n)extendCoordinate(t,l[n]);return t}function _boundingExtentXYs(l,t,n){const s=Math.min.apply(null,l),o=Math.min.apply(null,t),a=Math.max.apply(null,l),h=Math.max.apply(null,t);return createOrUpdate$2(s,o,a,h,n)}function buffer(l,t,n){return n?(n[0]=l[0]-t,n[1]=l[1]-t,n[2]=l[2]+t,n[3]=l[3]+t,n):[l[0]-t,l[1]-t,l[2]+t,l[3]+t]}function clone(l,t){return t?(t[0]=l[0],t[1]=l[1],t[2]=l[2],t[3]=l[3],t):l.slice()}function closestSquaredDistanceXY(l,t,n){let s,o;return t<l[0]?s=l[0]-t:l[2]<t?s=t-l[2]:s=0,n<l[1]?o=l[1]-n:l[3]<n?o=n-l[3]:o=0,s*s+o*o}function containsCoordinate(l,t){return containsXY(l,t[0],t[1])}function containsExtent(l,t){return l[0]<=t[0]&&t[2]<=l[2]&&l[1]<=t[1]&&t[3]<=l[3]}function containsXY(l,t,n){return l[0]<=t&&t<=l[2]&&l[1]<=n&&n<=l[3]}function coordinateRelationship(l,t){const n=l[0],s=l[1],o=l[2],a=l[3],h=t[0],c=t[1];let u=Relationship.UNKNOWN;return h<n?u=u|Relationship.LEFT:h>o&&(u=u|Relationship.RIGHT),c<s?u=u|Relationship.BELOW:c>a&&(u=u|Relationship.ABOVE),u===Relationship.UNKNOWN&&(u=Relationship.INTERSECTING),u}function createEmpty(){return[1/0,1/0,-1/0,-1/0]}function createOrUpdate$2(l,t,n,s,o){return o?(o[0]=l,o[1]=t,o[2]=n,o[3]=s,o):[l,t,n,s]}function createOrUpdateEmpty(l){return createOrUpdate$2(1/0,1/0,-1/0,-1/0,l)}function createOrUpdateFromCoordinate(l,t){const n=l[0],s=l[1];return createOrUpdate$2(n,s,n,s,t)}function createOrUpdateFromFlatCoordinates(l,t,n,s,o){const a=createOrUpdateEmpty(o);return extendFlatCoordinates(a,l,t,n,s)}function equals$1(l,t){return l[0]==t[0]&&l[2]==t[2]&&l[1]==t[1]&&l[3]==t[3]}function approximatelyEquals(l,t,n){return Math.abs(l[0]-t[0])<n&&Math.abs(l[2]-t[2])<n&&Math.abs(l[1]-t[1])<n&&Math.abs(l[3]-t[3])<n}function extend$1(l,t){return t[0]<l[0]&&(l[0]=t[0]),t[2]>l[2]&&(l[2]=t[2]),t[1]<l[1]&&(l[1]=t[1]),t[3]>l[3]&&(l[3]=t[3]),l}function extendCoordinate(l,t){t[0]<l[0]&&(l[0]=t[0]),t[0]>l[2]&&(l[2]=t[0]),t[1]<l[1]&&(l[1]=t[1]),t[1]>l[3]&&(l[3]=t[1])}function extendFlatCoordinates(l,t,n,s,o){for(;n<s;n+=o)extendXY(l,t[n],t[n+1]);return l}function extendXY(l,t,n){l[0]=Math.min(l[0],t),l[1]=Math.min(l[1],n),l[2]=Math.max(l[2],t),l[3]=Math.max(l[3],n)}function forEachCorner(l,t){let n;return n=t(getBottomLeft(l)),n||(n=t(getBottomRight(l)),n)||(n=t(getTopRight(l)),n)||(n=t(getTopLeft(l)),n)?n:!1}function getArea$1(l){let t=0;return isEmpty(l)||(t=getWidth(l)*getHeight(l)),t}function getBottomLeft(l){return[l[0],l[1]]}function getBottomRight(l){return[l[2],l[1]]}function getCenter(l){return[(l[0]+l[2])/2,(l[1]+l[3])/2]}function getCorner(l,t){let n;if(t==="bottom-left")n=getBottomLeft(l);else if(t==="bottom-right")n=getBottomRight(l);else if(t==="top-left")n=getTopLeft(l);else if(t==="top-right")n=getTopRight(l);else throw new Error("Invalid corner");return n}function getForViewAndSize(l,t,n,s,o){const[a,h,c,u,d,f,g,_]=getRotatedViewport(l,t,n,s);return createOrUpdate$2(Math.min(a,c,d,g),Math.min(h,u,f,_),Math.max(a,c,d,g),Math.max(h,u,f,_),o)}function getRotatedViewport(l,t,n,s){const o=t*s[0]/2,a=t*s[1]/2,h=Math.cos(n),c=Math.sin(n),u=o*h,d=o*c,f=a*h,g=a*c,_=l[0],m=l[1];return[_-u+g,m-d-f,_-u-g,m-d+f,_+u-g,m+d+f,_+u+g,m+d-f,_-u+g,m-d-f]}function getHeight(l){return l[3]-l[1]}function getIntersection(l,t,n){const s=n||createEmpty();return intersects$1(l,t)?(l[0]>t[0]?s[0]=l[0]:s[0]=t[0],l[1]>t[1]?s[1]=l[1]:s[1]=t[1],l[2]<t[2]?s[2]=l[2]:s[2]=t[2],l[3]<t[3]?s[3]=l[3]:s[3]=t[3]):createOrUpdateEmpty(s),s}function getTopLeft(l){return[l[0],l[3]]}function getTopRight(l){return[l[2],l[3]]}function getWidth(l){return l[2]-l[0]}function intersects$1(l,t){return l[0]<=t[2]&&l[2]>=t[0]&&l[1]<=t[3]&&l[3]>=t[1]}function isEmpty(l){return l[2]<l[0]||l[3]<l[1]}function returnOrUpdate(l,t){return t?(t[0]=l[0],t[1]=l[1],t[2]=l[2],t[3]=l[3],t):l}function scaleFromCenter(l,t){const n=(l[2]-l[0])/2*(t-1),s=(l[3]-l[1])/2*(t-1);l[0]-=n,l[2]+=n,l[1]-=s,l[3]+=s}function intersectsSegment(l,t,n){let s=!1;const o=coordinateRelationship(l,t),a=coordinateRelationship(l,n);if(o===Relationship.INTERSECTING||a===Relationship.INTERSECTING)s=!0;else{const h=l[0],c=l[1],u=l[2],d=l[3],f=t[0],g=t[1],_=n[0],m=n[1],p=(m-g)/(_-f);let x,y;a&Relationship.ABOVE&&!(o&Relationship.ABOVE)&&(x=_-(m-d)/p,s=x>=h&&x<=u),!s&&a&Relationship.RIGHT&&!(o&Relationship.RIGHT)&&(y=m-(_-u)*p,s=y>=c&&y<=d),!s&&a&Relationship.BELOW&&!(o&Relationship.BELOW)&&(x=_-(m-c)/p,s=x>=h&&x<=u),!s&&a&Relationship.LEFT&&!(o&Relationship.LEFT)&&(y=m-(_-h)*p,s=y>=c&&y<=d)}return s}function applyTransform(l,t,n,s){if(isEmpty(l))return createOrUpdateEmpty(n);let o=[];if(s>1){const c=l[2]-l[0],u=l[3]-l[1];for(let d=0;d<s;++d)o.push(l[0]+c*d/s,l[1],l[2],l[1]+u*d/s,l[2]-c*d/s,l[3],l[0],l[3]-u*d/s)}else o=[l[0],l[1],l[2],l[1],l[2],l[3],l[0],l[3]];t(o,o,2);const a=[],h=[];for(let c=0,u=o.length;c<u;c+=2)a.push(o[c]),h.push(o[c+1]);return _boundingExtentXYs(a,h,n)}function wrapX$2(l,t){const n=t.getExtent(),s=getCenter(l);if(t.canWrapX()&&(s[0]<n[0]||s[0]>=n[2])){const o=getWidth(n),h=Math.floor((s[0]-n[0])/o)*o;l[0]-=h,l[2]-=h}return l}function wrapAndSliceX(l,t,n){if(t.canWrapX()){const s=t.getExtent();if(!isFinite(l[0])||!isFinite(l[2]))return[[s[0],l[1],s[2],l[3]]];wrapX$2(l,t);const o=getWidth(s);if(getWidth(l)>o&&!n)return[[s[0],l[1],s[2],l[3]]];if(l[0]<s[0])return[[l[0]+o,l[1],s[2],l[3]],[s[0],l[1],l[2],l[3]]];if(l[2]>s[2])return[[l[0],l[1],s[2],l[3]],[s[0],l[1],l[2]-o,l[3]]]}return[l]}function padNumber(l,t,n){const s=n!==void 0?l.toFixed(n):""+l;let o=s.indexOf(".");return o=o===-1?s.length:o,o>t?s:new Array(1+t-o).join("0")+s}function compareVersions(l,t){const n=(""+l).split("."),s=(""+t).split(".");for(let o=0;o<Math.max(n.length,s.length);o++){const a=parseInt(n[o]||"0",10),h=parseInt(s[o]||"0",10);if(a>h)return 1;if(h>a)return-1}return 0}function add$2(l,t){return l[0]+=+t[0],l[1]+=+t[1],l}function closestOnSegment(l,t){const n=l[0],s=l[1],o=t[0],a=t[1],h=o[0],c=o[1],u=a[0],d=a[1],f=u-h,g=d-c,_=f===0&&g===0?0:(f*(n-h)+g*(s-c))/(f*f+g*g||0);let m,p;return _<=0?(m=h,p=c):_>=1?(m=u,p=d):(m=h+_*f,p=c+_*g),[m,p]}function degreesToStringHDMS(l,t,n){const s=modulo(t+180,360)-180,o=Math.abs(3600*s),a=n||0;let h=Math.floor(o/3600),c=Math.floor((o-h*3600)/60),u=toFixed(o-h*3600-c*60,a);u>=60&&(u=0,c+=1),c>=60&&(c=0,h+=1);let d=h+"°";return(c!==0||u!==0)&&(d+=" "+padNumber(c,2)+"′"),u!==0&&(d+=" "+padNumber(u,2,a)+"″"),s!==0&&(d+=" "+l.charAt(s<0?1:0)),d}function equals(l,t){let n=!0;for(let s=l.length-1;s>=0;--s)if(l[s]!=t[s]){n=!1;break}return n}function rotate$2(l,t){const n=Math.cos(t),s=Math.sin(t),o=l[0]*n-l[1]*s,a=l[1]*n+l[0]*s;return l[0]=o,l[1]=a,l}function scale$4(l,t){return l[0]*=t,l[1]*=t,l}function squaredDistance(l,t){const n=l[0]-t[0],s=l[1]-t[1];return n*n+s*s}function distance(l,t){return Math.sqrt(squaredDistance(l,t))}function squaredDistanceToSegment(l,t){return squaredDistance(l,closestOnSegment(l,t))}function wrapX$1(l,t){if(t.canWrapX()){const n=getWidth(t.getExtent()),s=getWorldsAway(l,t,n);s&&(l[0]-=s*n)}return l}function getWorldsAway(l,t,n){const s=t.getExtent();let o=0;return t.canWrapX()&&(l[0]<s[0]||l[0]>s[2])&&(n=n||getWidth(s),o=Math.floor((l[0]-s[0])/n)),o}function easeIn(l){return Math.pow(l,3)}function easeOut(l){return 1-easeIn(1-l)}function inAndOut(l){return 3*l*l-2*l*l*l}function linear(l){return l}const DEFAULT_RADIUS=63710088e-1;function getDistance(l,t,n){n=n||DEFAULT_RADIUS;const s=toRadians(l[1]),o=toRadians(t[1]),a=(o-s)/2,h=toRadians(t[0]-l[0])/2,c=Math.sin(a)*Math.sin(a)+Math.sin(h)*Math.sin(h)*Math.cos(s)*Math.cos(o);return 2*n*Math.atan2(Math.sqrt(c),Math.sqrt(1-c))}function getLengthInternal(l,t){let n=0;for(let s=0,o=l.length;s<o-1;++s)n+=getDistance(l[s],l[s+1],t);return n}function getLength(l,t){t=t||{};const n=t.radius||DEFAULT_RADIUS,s=t.projection||"EPSG:3857",o=l.getType();o!=="GeometryCollection"&&(l=l.clone().transform(s,"EPSG:4326"));let a=0,h,c,u,d,f,g;switch(o){case"Point":case"MultiPoint":break;case"LineString":case"LinearRing":{h=l.getCoordinates(),a=getLengthInternal(h,n);break}case"MultiLineString":case"Polygon":{for(h=l.getCoordinates(),u=0,d=h.length;u<d;++u)a+=getLengthInternal(h[u],n);break}case"MultiPolygon":{for(h=l.getCoordinates(),u=0,d=h.length;u<d;++u)for(c=h[u],f=0,g=c.length;f<g;++f)a+=getLengthInternal(c[f],n);break}case"GeometryCollection":{const _=l.getGeometries();for(u=0,d=_.length;u<d;++u)a+=getLength(_[u],t);break}default:throw new Error("Unsupported geometry type: "+o)}return a}function getAreaInternal(l,t){let n=0;const s=l.length;let o=l[s-1][0],a=l[s-1][1];for(let h=0;h<s;h++){const c=l[h][0],u=l[h][1];n+=toRadians(c-o)*(2+Math.sin(toRadians(a))+Math.sin(toRadians(u))),o=c,a=u}return n*t*t/2}function getArea(l,t){t=t||{};const n=t.radius||DEFAULT_RADIUS,s=t.projection||"EPSG:3857",o=l.getType();o!=="GeometryCollection"&&(l=l.clone().transform(s,"EPSG:4326"));let a=0,h,c,u,d,f,g;switch(o){case"Point":case"MultiPoint":case"LineString":case"MultiLineString":case"LinearRing":break;case"Polygon":{for(h=l.getCoordinates(),a=Math.abs(getAreaInternal(h[0],n)),u=1,d=h.length;u<d;++u)a-=Math.abs(getAreaInternal(h[u],n));break}case"MultiPolygon":{for(h=l.getCoordinates(),u=0,d=h.length;u<d;++u)for(c=h[u],a+=Math.abs(getAreaInternal(c[0],n)),f=1,g=c.length;f<g;++f)a-=Math.abs(getAreaInternal(c[f],n));break}case"GeometryCollection":{const _=l.getGeometries();for(u=0,d=_.length;u<d;++u)a+=getArea(_[u],t);break}default:throw new Error("Unsupported geometry type: "+o)}return a}function offset(l,t,n,s){s=s||DEFAULT_RADIUS;const o=toRadians(l[1]),a=toRadians(l[0]),h=t/s,c=Math.asin(Math.sin(o)*Math.cos(h)+Math.cos(o)*Math.sin(h)*Math.cos(n)),u=a+Math.atan2(Math.sin(n)*Math.sin(h)*Math.cos(o),Math.cos(h)-Math.sin(o)*Math.sin(c));return[toDegrees(u),toDegrees(c)]}function warn(...l){console.warn(...l)}function error(...l){console.error(...l)}const unitByCode={9001:"m",9002:"ft",9003:"us-ft",9101:"radians",9102:"degrees"};function fromCode(l){return unitByCode[l]}const METERS_PER_UNIT$1={radians:6370997/(2*Math.PI),degrees:2*Math.PI*6370997/360,ft:.3048,m:1,"us-ft":1200/3937};class Projection{constructor(t){this.code_=t.code,this.units_=t.units,this.extent_=t.extent!==void 0?t.extent:null,this.worldExtent_=t.worldExtent!==void 0?t.worldExtent:null,this.axisOrientation_=t.axisOrientation!==void 0?t.axisOrientation:"enu",this.global_=t.global!==void 0?t.global:!1,this.canWrapX_=!!(this.global_&&this.extent_),this.getPointResolutionFunc_=t.getPointResolution,this.defaultTileGrid_=null,this.metersPerUnit_=t.metersPerUnit}canWrapX(){return this.canWrapX_}getCode(){return this.code_}getExtent(){return this.extent_}getUnits(){return this.units_}getMetersPerUnit(){return this.metersPerUnit_||METERS_PER_UNIT$1[this.units_]}getWorldExtent(){return this.worldExtent_}getAxisOrientation(){return this.axisOrientation_}isGlobal(){return this.global_}setGlobal(t){this.global_=t,this.canWrapX_=!!(t&&this.extent_)}getDefaultTileGrid(){return this.defaultTileGrid_}setDefaultTileGrid(t){this.defaultTileGrid_=t}setExtent(t){this.extent_=t,this.canWrapX_=!!(this.global_&&t)}setWorldExtent(t){this.worldExtent_=t}setGetPointResolution(t){this.getPointResolutionFunc_=t}getPointResolutionFunc(){return this.getPointResolutionFunc_}}const RADIUS$1=6378137,HALF_SIZE=Math.PI*RADIUS$1,EXTENT$1=[-HALF_SIZE,-HALF_SIZE,HALF_SIZE,HALF_SIZE],WORLD_EXTENT=[-180,-85,180,85],MAX_SAFE_Y=RADIUS$1*Math.log(Math.tan(Math.PI/2));class EPSG3857Projection extends Projection{constructor(t){super({code:t,units:"m",extent:EXTENT$1,global:!0,worldExtent:WORLD_EXTENT,getPointResolution:function(n,s){return n/Math.cosh(s[1]/RADIUS$1)}})}}const PROJECTIONS$1=[new EPSG3857Projection("EPSG:3857"),new EPSG3857Projection("EPSG:102100"),new EPSG3857Projection("EPSG:102113"),new EPSG3857Projection("EPSG:900913"),new EPSG3857Projection("http://www.opengis.net/def/crs/EPSG/0/3857"),new EPSG3857Projection("http://www.opengis.net/gml/srs/epsg.xml#3857")];function fromEPSG4326(l,t,n,s){const o=l.length;n=n>1?n:2,s=s??n,t===void 0&&(n>2?t=l.slice():t=new Array(o));for(let a=0;a<o;a+=s){t[a]=HALF_SIZE*l[a]/180;let h=RADIUS$1*Math.log(Math.tan(Math.PI*(+l[a+1]+90)/360));h>MAX_SAFE_Y?h=MAX_SAFE_Y:h<-MAX_SAFE_Y&&(h=-MAX_SAFE_Y),t[a+1]=h}return t}function toEPSG4326(l,t,n,s){const o=l.length;n=n>1?n:2,s=s??n,t===void 0&&(n>2?t=l.slice():t=new Array(o));for(let a=0;a<o;a+=s)t[a]=180*l[a]/HALF_SIZE,t[a+1]=360*Math.atan(Math.exp(l[a+1]/RADIUS$1))/Math.PI-90;return t}const RADIUS=6378137,EXTENT=[-180,-90,180,90],METERS_PER_UNIT=Math.PI*RADIUS/180;class EPSG4326Projection extends Projection{constructor(t,n){super({code:t,units:"degrees",extent:EXTENT,axisOrientation:n,global:!0,metersPerUnit:METERS_PER_UNIT,worldExtent:EXTENT})}}const PROJECTIONS=[new EPSG4326Projection("CRS:84"),new EPSG4326Projection("EPSG:4326","neu"),new EPSG4326Projection("urn:ogc:def:crs:OGC:1.3:CRS84"),new EPSG4326Projection("urn:ogc:def:crs:OGC:2:84"),new EPSG4326Projection("http://www.opengis.net/def/crs/OGC/1.3/CRS84"),new EPSG4326Projection("http://www.opengis.net/gml/srs/epsg.xml#4326","neu"),new EPSG4326Projection("http://www.opengis.net/def/crs/EPSG/0/4326","neu")];let cache$1={};function get$3(l){return cache$1[l]||cache$1[l.replace(/urn:(x-)?ogc:def:crs:EPSG:(.*:)?(\w+)$/,"EPSG:$3")]||null}function add$1(l,t){cache$1[l]=t}let transforms={};function add(l,t,n){const s=l.getCode(),o=t.getCode();s in transforms||(transforms[s]={}),transforms[s][o]=n}function get$2(l,t){return l in transforms&&t in transforms[l]?transforms[l][t]:null}const K0=.9996,E=.00669438,E2=E*E,E3=E2*E,E_P2=E/(1-E),SQRT_E=Math.sqrt(1-E),_E=(1-SQRT_E)/(1+SQRT_E),_E2=_E*_E,_E3=_E2*_E,_E4=_E3*_E,_E5=_E4*_E,M1=1-E/4-3*E2/64-5*E3/256,M2=3*E/8+3*E2/32+45*E3/1024,M3=15*E2/256+45*E3/1024,M4=35*E3/3072,P2=3/2*_E-27/32*_E3+269/512*_E5,P3=21/16*_E2-55/32*_E4,P4=151/96*_E3-417/128*_E5,P5=1097/512*_E4,R=6378137;function toLonLat$1(l,t,n){const s=l-5e5,h=(n.north?t:t-1e7)/K0/(R*M1),c=h+P2*Math.sin(2*h)+P3*Math.sin(4*h)+P4*Math.sin(6*h)+P5*Math.sin(8*h),u=Math.sin(c),d=u*u,f=Math.cos(c),g=u/f,_=g*g,m=_*_,p=1-E*d,x=Math.sqrt(1-E*d),y=R/x,T=(1-E)/p,S=E_P2*f**2,C=S*S,P=s/(y*K0),w=P*P,I=w*P,O=I*P,N=O*P,k=N*P,D=c-g/T*(w/2-O/24*(5+3*_+10*S-4*C-9*E_P2))+k/720*(61+90*_+298*S+45*m-252*E_P2-3*C);let ze=(P-I/6*(1+2*_+S)+N/120*(5-2*S+28*_-3*C+8*E_P2+24*m))/f;return ze=wrap(ze+toRadians(zoneToCentralLongitude(n.number)),-Math.PI,Math.PI),[toDegrees(ze),toDegrees(D)]}const MIN_LATITUDE=-80,MAX_LATITUDE=84,MIN_LONGITUDE=-180,MAX_LONGITUDE=180;function fromLonLat$1(l,t,n){l=wrap(l,MIN_LONGITUDE,MAX_LONGITUDE),t<MIN_LATITUDE?t=MIN_LATITUDE:t>MAX_LATITUDE&&(t=MAX_LATITUDE);const s=toRadians(t),o=Math.sin(s),a=Math.cos(s),h=o/a,c=h*h,u=c*c,d=toRadians(l),f=zoneToCentralLongitude(n.number),g=toRadians(f),_=R/Math.sqrt(1-E*o**2),m=E_P2*a**2,p=a*wrap(d-g,-Math.PI,Math.PI),x=p*p,y=x*p,T=y*p,S=T*p,C=S*p,P=R*(M1*s-M2*Math.sin(2*s)+M3*Math.sin(4*s)-M4*Math.sin(6*s)),w=K0*_*(p+y/6*(1-c+m)+S/120*(5-18*c+u+72*m-58*E_P2))+5e5;let I=K0*(P+_*h*(x/2+T/24*(5-c+9*m+4*m**2)+C/720*(61-58*c+u+600*m-330*E_P2)));return n.north||(I+=1e7),[w,I]}function zoneToCentralLongitude(l){return(l-1)*6-180+3}const epsgRegExes=[/^EPSG:(\d+)$/,/^urn:ogc:def:crs:EPSG::(\d+)$/,/^http:\/\/www\.opengis\.net\/def\/crs\/EPSG\/0\/(\d+)$/];function zoneFromCode(l){let t=0;for(const o of epsgRegExes){const a=l.match(o);if(a){t=parseInt(a[1]);break}}if(!t)return null;let n=0,s=!1;return t>32700&&t<32761?n=t-32700:t>32600&&t<32661&&(s=!0,n=t-32600),n?{number:n,north:s}:null}function makeTransformFunction(l,t){return function(n,s,o,a){const h=n.length;o=o>1?o:2,a=a??o,s||(o>2?s=n.slice():s=new Array(h));for(let c=0;c<h;c+=a){const u=n[c],d=n[c+1],f=l(u,d,t);s[c]=f[0],s[c+1]=f[1]}return s}}function makeProjection(l){return zoneFromCode(l)?new Projection({code:l,units:"m"}):null}function makeTransforms(l){const t=zoneFromCode(l.getCode());return t?{forward:makeTransformFunction(fromLonLat$1,t),inverse:makeTransformFunction(toLonLat$1,t)}:null}const transformFactories=[makeTransforms],projectionFactories=[makeProjection];let showCoordinateWarning=!0;function disableCoordinateWarning(l){showCoordinateWarning=!1}function cloneTransform(l,t){if(t!==void 0){for(let n=0,s=l.length;n<s;++n)t[n]=l[n];t=t}else t=l.slice();return t}function identityTransform(l,t){if(t!==void 0&&l!==t){for(let n=0,s=l.length;n<s;++n)t[n]=l[n];l=t}return l}function addProjection(l){add$1(l.getCode(),l),add(l,l,cloneTransform)}function addProjections(l){l.forEach(addProjection)}function get$1(l){if(typeof l!="string")return l;const t=get$3(l);if(t)return t;for(const n of projectionFactories){const s=n(l);if(s)return s}return null}function getPointResolution(l,t,n,s){l=get$1(l);let o;const a=l.getPointResolutionFunc();if(a){if(o=a(t,n),s&&s!==l.getUnits()){const h=l.getMetersPerUnit();h&&(o=o*h/METERS_PER_UNIT$1[s])}}else{const h=l.getUnits();if(h=="degrees"&&!s||s=="degrees")o=t;else{const c=getTransformFromProjections(l,get$1("EPSG:4326"));if(!c&&h!=="degrees")o=t*l.getMetersPerUnit();else{let d=[n[0]-t/2,n[1],n[0]+t/2,n[1],n[0],n[1]-t/2,n[0],n[1]+t/2];d=c(d,d,2);const f=getDistance(d.slice(0,2),d.slice(2,4)),g=getDistance(d.slice(4,6),d.slice(6,8));o=(f+g)/2}const u=s?METERS_PER_UNIT$1[s]:l.getMetersPerUnit();u!==void 0&&(o/=u)}}return o}function addEquivalentProjections(l){addProjections(l),l.forEach(function(t){l.forEach(function(n){t!==n&&add(t,n,cloneTransform)})})}function addEquivalentTransforms(l,t,n,s){l.forEach(function(o){t.forEach(function(a){add(o,a,n),add(a,o,s)})})}function createProjection(l,t){return l?typeof l=="string"?get$1(l):l:get$1(t)}function createTransformFromCoordinateTransform(l){return function(t,n,s,o){const a=t.length;s=s!==void 0?s:2,o=o??s,n=n!==void 0?n:new Array(a);for(let h=0;h<a;h+=o){const c=l(t.slice(h,h+s)),u=c.length;for(let d=0,f=o;d<f;++d)n[h+d]=d>=u?t[h+d]:c[d]}return n}}function addCoordinateTransforms(l,t,n,s){const o=get$1(l),a=get$1(t);add(o,a,createTransformFromCoordinateTransform(n)),add(a,o,createTransformFromCoordinateTransform(s))}function fromLonLat(l,t){return disableCoordinateWarning(),transform$1(l,"EPSG:4326","EPSG:3857")}function toLonLat(l,t){const n=transform$1(l,t!==void 0?t:"EPSG:3857","EPSG:4326"),s=n[0];return(s<-180||s>180)&&(n[0]=modulo(s+180,360)-180),n}function equivalent$1(l,t){if(l===t)return!0;const n=l.getUnits()===t.getUnits();return(l.getCode()===t.getCode()||getTransformFromProjections(l,t)===cloneTransform)&&n}function getTransformFromProjections(l,t){const n=l.getCode(),s=t.getCode();let o=get$2(n,s);if(o)return o;let a=null,h=null;for(const u of transformFactories)a||(a=u(l)),h||(h=u(t));if(!a&&!h)return null;const c="EPSG:4326";if(h)if(a)o=composeTransformFuncs(a.inverse,h.forward);else{const u=get$2(n,c);u&&(o=composeTransformFuncs(u,h.forward))}else{const u=get$2(c,s);u&&(o=composeTransformFuncs(a.inverse,u))}return o&&(addProjection(l),addProjection(t),add(l,t,o)),o}function composeTransformFuncs(l,t){return function(n,s,o,a){return s=l(n,s,o,a),t(s,s,o,a)}}function getTransform(l,t){const n=get$1(l),s=get$1(t);return getTransformFromProjections(n,s)}function transform$1(l,t,n){const s=getTransform(t,n);if(!s){const o=get$1(t).getCode(),a=get$1(n).getCode();throw new Error(`No transform available between ${o} and ${a}`)}return s(l,void 0,l.length)}function transformExtent$1(l,t,n,s){const o=getTransform(t,n);return applyTransform(l,o,void 0,s)}let userProjection=null;function getUserProjection(){return userProjection}function toUserCoordinate(l,t){return l}function fromUserCoordinate(l,t){return showCoordinateWarning&&!equals(l,[0,0])&&l[0]>=-180&&l[0]<=180&&l[1]>=-90&&l[1]<=90&&(showCoordinateWarning=!1,warn("Call useGeographic() from ol/proj once to work with [longitude, latitude] coordinates.")),l}function toUserExtent(l,t){return l}function fromUserExtent(l,t){return l}function createSafeCoordinateTransform(l,t,n){return function(s){let o,a;if(l.canWrapX()){const h=l.getExtent(),c=getWidth(h);s=s.slice(0),a=getWorldsAway(s,l,c),a&&(s[0]=s[0]-a*c),s[0]=clamp(s[0],h[0],h[2]),s[1]=clamp(s[1],h[1],h[3]),o=n(s)}else o=n(s);return a&&t.canWrapX()&&(o[0]+=a*getWidth(t.getExtent())),o}}function addCommon(){addEquivalentProjections(PROJECTIONS$1),addEquivalentProjections(PROJECTIONS),addEquivalentTransforms(PROJECTIONS,PROJECTIONS$1,fromEPSG4326,toEPSG4326)}addCommon();const tmp_=new Array(6);function create$2(){return[1,0,0,1,0,0]}function reset(l){return set(l,1,0,0,1,0,0)}function multiply(l,t){const n=l[0],s=l[1],o=l[2],a=l[3],h=l[4],c=l[5],u=t[0],d=t[1],f=t[2],g=t[3],_=t[4],m=t[5];return l[0]=n*u+o*d,l[1]=s*u+a*d,l[2]=n*f+o*g,l[3]=s*f+a*g,l[4]=n*_+o*m+h,l[5]=s*_+a*m+c,l}function set(l,t,n,s,o,a,h){return l[0]=t,l[1]=n,l[2]=s,l[3]=o,l[4]=a,l[5]=h,l}function setFromArray(l,t){return l[0]=t[0],l[1]=t[1],l[2]=t[2],l[3]=t[3],l[4]=t[4],l[5]=t[5],l}function apply(l,t){const n=t[0],s=t[1];return t[0]=l[0]*n+l[2]*s+l[4],t[1]=l[1]*n+l[3]*s+l[5],t}function rotate$1(l,t){const n=Math.cos(t),s=Math.sin(t);return multiply(l,set(tmp_,n,s,-s,n,0,0))}function scale$3(l,t,n){return multiply(l,set(tmp_,t,0,0,n,0,0))}function translate$2(l,t,n){return multiply(l,set(tmp_,1,0,0,1,t,n))}function compose(l,t,n,s,o,a,h,c){const u=Math.sin(a),d=Math.cos(a);return l[0]=s*d,l[1]=o*u,l[2]=-s*u,l[3]=o*d,l[4]=h*s*d-c*s*u+t,l[5]=h*o*u+c*o*d+n,l}function makeInverse(l,t){const n=determinant(t);assert(n!==0,"Transformation matrix cannot be inverted");const s=t[0],o=t[1],a=t[2],h=t[3],c=t[4],u=t[5];return l[0]=h/n,l[1]=-o/n,l[2]=-a/n,l[3]=s/n,l[4]=(a*u-h*c)/n,l[5]=-(s*u-o*c)/n,l}function determinant(l){return l[0]*l[3]-l[1]*l[2]}const matrixPrecision=[1e5,1e5,1e5,1e5,2,2];function toString$1(l){return"matrix("+l.join(", ")+")"}function fromString$1(l){return l.substring(7,l.length-1).split(",").map(parseFloat)}function equivalent(l,t){const n=fromString$1(l),s=fromString$1(t);for(let o=0;o<6;++o)if(Math.round((n[o]-s[o])*matrixPrecision[o])!==0)return!1;return!0}function transform2D(l,t,n,s,o,a,h){a=a||[],h=h||2;let c=0;for(let u=t;u<n;u+=s){const d=l[u],f=l[u+1];a[c++]=o[0]*d+o[2]*f+o[4],a[c++]=o[1]*d+o[3]*f+o[5];for(let g=2;g<h;g++)a[c++]=l[u+g]}return a&&a.length!=c&&(a.length=c),a}function rotate(l,t,n,s,o,a,h){h=h||[];const c=Math.cos(o),u=Math.sin(o),d=a[0],f=a[1];let g=0;for(let _=t;_<n;_+=s){const m=l[_]-d,p=l[_+1]-f;h[g++]=d+m*c-p*u,h[g++]=f+m*u+p*c;for(let x=_+2;x<_+s;++x)h[g++]=l[x]}return h&&h.length!=g&&(h.length=g),h}function scale$2(l,t,n,s,o,a,h,c){c=c||[];const u=h[0],d=h[1];let f=0;for(let g=t;g<n;g+=s){const _=l[g]-u,m=l[g+1]-d;c[f++]=u+o*_,c[f++]=d+a*m;for(let p=g+2;p<g+s;++p)c[f++]=l[p]}return c&&c.length!=f&&(c.length=f),c}function translate$1(l,t,n,s,o,a,h){h=h||[];let c=0;for(let u=t;u<n;u+=s){h[c++]=l[u]+o,h[c++]=l[u+1]+a;for(let d=u+2;d<u+s;++d)h[c++]=l[d]}return h&&h.length!=c&&(h.length=c),h}const tmpTransform$1=create$2(),tmpPoint=[NaN,NaN];class Geometry extends BaseObject{constructor(){super(),this.extent_=createEmpty(),this.extentRevision_=-1,this.simplifiedGeometryMaxMinSquaredTolerance=0,this.simplifiedGeometryRevision=0,this.simplifyTransformedInternal=memoizeOne((t,n,s)=>{if(!s)return this.getSimplifiedGeometry(n);const o=this.clone();return o.applyTransform(s),o.getSimplifiedGeometry(n)})}simplifyTransformed(t,n){return this.simplifyTransformedInternal(this.getRevision(),t,n)}clone(){return abstract()}closestPointXY(t,n,s,o){return abstract()}containsXY(t,n){return this.closestPointXY(t,n,tmpPoint,Number.MIN_VALUE)===0}getClosestPoint(t,n){return n=n||[NaN,NaN],this.closestPointXY(t[0],t[1],n,1/0),n}intersectsCoordinate(t){return this.containsXY(t[0],t[1])}computeExtent(t){return abstract()}getExtent(t){if(this.extentRevision_!=this.getRevision()){const n=this.computeExtent(this.extent_);(isNaN(n[0])||isNaN(n[1]))&&createOrUpdateEmpty(n),this.extentRevision_=this.getRevision()}return returnOrUpdate(this.extent_,t)}rotate(t,n){abstract()}scale(t,n,s){abstract()}simplify(t){return this.getSimplifiedGeometry(t*t)}getSimplifiedGeometry(t){return abstract()}getType(){return abstract()}applyTransform(t){abstract()}intersectsExtent(t){return abstract()}translate(t,n){abstract()}transform(t,n){const s=get$1(t),o=s.getUnits()=="tile-pixels"?function(a,h,c){const u=s.getExtent(),d=s.getWorldExtent(),f=getHeight(d)/getHeight(u);compose(tmpTransform$1,d[0],d[3],f,-f,0,0,0);const g=transform2D(a,0,a.length,c,tmpTransform$1,h),_=getTransform(s,n);return _?_(g,g,c):g}:getTransform(s,n);return this.applyTransform(o),this}}class SimpleGeometry extends Geometry{constructor(){super(),this.layout="XY",this.stride=2,this.flatCoordinates}computeExtent(t){return createOrUpdateFromFlatCoordinates(this.flatCoordinates,0,this.flatCoordinates.length,this.stride,t)}getCoordinates(){return abstract()}getFirstCoordinate(){return this.flatCoordinates.slice(0,this.stride)}getFlatCoordinates(){return this.flatCoordinates}getLastCoordinate(){return this.flatCoordinates.slice(this.flatCoordinates.length-this.stride)}getLayout(){return this.layout}getSimplifiedGeometry(t){if(this.simplifiedGeometryRevision!==this.getRevision()&&(this.simplifiedGeometryMaxMinSquaredTolerance=0,this.simplifiedGeometryRevision=this.getRevision()),t<0||this.simplifiedGeometryMaxMinSquaredTolerance!==0&&t<=this.simplifiedGeometryMaxMinSquaredTolerance)return this;const n=this.getSimplifiedGeometryInternal(t);return n.getFlatCoordinates().length<this.flatCoordinates.length?n:(this.simplifiedGeometryMaxMinSquaredTolerance=t,this)}getSimplifiedGeometryInternal(t){return this}getStride(){return this.stride}setFlatCoordinates(t,n){this.stride=getStrideForLayout(t),this.layout=t,this.flatCoordinates=n}setCoordinates(t,n){abstract()}setLayout(t,n,s){let o;if(t)o=getStrideForLayout(t);else{for(let a=0;a<s;++a){if(n.length===0){this.layout="XY",this.stride=2;return}n=n[0]}o=n.length,t=getLayoutForStride(o)}this.layout=t,this.stride=o}applyTransform(t){this.flatCoordinates&&(t(this.flatCoordinates,this.flatCoordinates,this.layout.startsWith("XYZ")?3:2,this.stride),this.changed())}rotate(t,n){const s=this.getFlatCoordinates();if(s){const o=this.getStride();rotate(s,0,s.length,o,t,n,s),this.changed()}}scale(t,n,s){n===void 0&&(n=t),s||(s=getCenter(this.getExtent()));const o=this.getFlatCoordinates();if(o){const a=this.getStride();scale$2(o,0,o.length,a,t,n,s,o),this.changed()}}translate(t,n){const s=this.getFlatCoordinates();if(s){const o=this.getStride();translate$1(s,0,s.length,o,t,n,s),this.changed()}}}function getLayoutForStride(l){let t;return l==2?t="XY":l==3?t="XYZ":l==4&&(t="XYZM"),t}function getStrideForLayout(l){let t;return l=="XY"?t=2:l=="XYZ"||l=="XYM"?t=3:l=="XYZM"&&(t=4),t}function transformGeom2D(l,t,n){const s=l.getFlatCoordinates();if(!s)return null;const o=l.getStride();return transform2D(s,0,s.length,o,t,n)}function linearRing(l,t,n,s){let o=0;const a=l[n-s],h=l[n-s+1];let c=0,u=0;for(;t<n;t+=s){const d=l[t]-a,f=l[t+1]-h;o+=u*d-c*f,c=d,u=f}return o/2}function linearRings(l,t,n,s){let o=0;for(let a=0,h=n.length;a<h;++a){const c=n[a];o+=linearRing(l,t,c,s),t=c}return o}function linearRingss$1(l,t,n,s){let o=0;for(let a=0,h=n.length;a<h;++a){const c=n[a];o+=linearRings(l,t,c,s),t=c[c.length-1]}return o}function assignClosest(l,t,n,s,o,a,h){const c=l[t],u=l[t+1],d=l[n]-c,f=l[n+1]-u;let g;if(d===0&&f===0)g=t;else{const _=((o-c)*d+(a-u)*f)/(d*d+f*f);if(_>1)g=n;else if(_>0){for(let m=0;m<s;++m)h[m]=lerp(l[t+m],l[n+m],_);h.length=s;return}else g=t}for(let _=0;_<s;++_)h[_]=l[g+_];h.length=s}function maxSquaredDelta(l,t,n,s,o){let a=l[t],h=l[t+1];for(t+=s;t<n;t+=s){const c=l[t],u=l[t+1],d=squaredDistance$1(a,h,c,u);d>o&&(o=d),a=c,h=u}return o}function arrayMaxSquaredDelta(l,t,n,s,o){for(let a=0,h=n.length;a<h;++a){const c=n[a];o=maxSquaredDelta(l,t,c,s,o),t=c}return o}function multiArrayMaxSquaredDelta(l,t,n,s,o){for(let a=0,h=n.length;a<h;++a){const c=n[a];o=arrayMaxSquaredDelta(l,t,c,s,o),t=c[c.length-1]}return o}function assignClosestPoint(l,t,n,s,o,a,h,c,u,d,f){if(t==n)return d;let g,_;if(o===0){if(_=squaredDistance$1(h,c,l[t],l[t+1]),_<d){for(g=0;g<s;++g)u[g]=l[t+g];return u.length=s,_}return d}f=f||[NaN,NaN];let m=t+s;for(;m<n;)if(assignClosest(l,m-s,m,s,h,c,f),_=squaredDistance$1(h,c,f[0],f[1]),_<d){for(d=_,g=0;g<s;++g)u[g]=f[g];u.length=s,m+=s}else m+=s*Math.max((Math.sqrt(_)-Math.sqrt(d))/o|0,1);if(a&&(assignClosest(l,n-s,t,s,h,c,f),_=squaredDistance$1(h,c,f[0],f[1]),_<d)){for(d=_,g=0;g<s;++g)u[g]=f[g];u.length=s}return d}function assignClosestArrayPoint(l,t,n,s,o,a,h,c,u,d,f){f=f||[NaN,NaN];for(let g=0,_=n.length;g<_;++g){const m=n[g];d=assignClosestPoint(l,t,m,s,o,a,h,c,u,d,f),t=m}return d}function assignClosestMultiArrayPoint(l,t,n,s,o,a,h,c,u,d,f){f=f||[NaN,NaN];for(let g=0,_=n.length;g<_;++g){const m=n[g];d=assignClosestArrayPoint(l,t,m,s,o,a,h,c,u,d,f),t=m[m.length-1]}return d}function deflateCoordinate(l,t,n,s){for(let o=0,a=n.length;o<a;++o)l[t++]=n[o];return t}function deflateCoordinates(l,t,n,s){for(let o=0,a=n.length;o<a;++o){const h=n[o];for(let c=0;c<s;++c)l[t++]=h[c]}return t}function deflateCoordinatesArray(l,t,n,s,o){o=o||[];let a=0;for(let h=0,c=n.length;h<c;++h){const u=deflateCoordinates(l,t,n[h],s);o[a++]=u,t=u}return o.length=a,o}function deflateMultiCoordinatesArray(l,t,n,s,o){o=o||[];let a=0;for(let h=0,c=n.length;h<c;++h){const u=deflateCoordinatesArray(l,t,n[h],s,o[a]);u.length===0&&(u[0]=t),o[a++]=u,t=u[u.length-1]}return o.length=a,o}function inflateCoordinates(l,t,n,s,o){o=o!==void 0?o:[];let a=0;for(let h=t;h<n;h+=s)o[a++]=l.slice(h,h+s);return o.length=a,o}function inflateCoordinatesArray(l,t,n,s,o){o=o!==void 0?o:[];let a=0;for(let h=0,c=n.length;h<c;++h){const u=n[h];o[a++]=inflateCoordinates(l,t,u,s,o[a]),t=u}return o.length=a,o}function inflateMultiCoordinatesArray(l,t,n,s,o){o=o!==void 0?o:[];let a=0;for(let h=0,c=n.length;h<c;++h){const u=n[h];o[a++]=u.length===1&&u[0]===t?[]:inflateCoordinatesArray(l,t,u,s,o[a]),t=u[u.length-1]}return o.length=a,o}function douglasPeucker(l,t,n,s,o,a,h){const c=(n-t)/s;if(c<3){for(;t<n;t+=s)a[h++]=l[t],a[h++]=l[t+1];return h}const u=new Array(c);u[0]=1,u[c-1]=1;const d=[t,n-s];let f=0;for(;d.length>0;){const g=d.pop(),_=d.pop();let m=0;const p=l[_],x=l[_+1],y=l[g],T=l[g+1];for(let S=_+s;S<g;S+=s){const C=l[S],P=l[S+1],w=squaredSegmentDistance(C,P,p,x,y,T);w>m&&(f=S,m=w)}m>o&&(u[(f-t)/s]=1,_+s<f&&d.push(_,f),f+s<g&&d.push(f,g))}for(let g=0;g<c;++g)u[g]&&(a[h++]=l[t+g*s],a[h++]=l[t+g*s+1]);return h}function douglasPeuckerArray(l,t,n,s,o,a,h,c){for(let u=0,d=n.length;u<d;++u){const f=n[u];h=douglasPeucker(l,t,f,s,o,a,h),c.push(h),t=f}return h}function snap(l,t){return t*Math.round(l/t)}function quantize(l,t,n,s,o,a,h){if(t==n)return h;let c=snap(l[t],o),u=snap(l[t+1],o);t+=s,a[h++]=c,a[h++]=u;let d,f;do if(d=snap(l[t],o),f=snap(l[t+1],o),t+=s,t==n)return a[h++]=d,a[h++]=f,h;while(d==c&&f==u);for(;t<n;){const g=snap(l[t],o),_=snap(l[t+1],o);if(t+=s,g==d&&_==f)continue;const m=d-c,p=f-u,x=g-c,y=_-u;if(m*y==p*x&&(m<0&&x<m||m==x||m>0&&x>m)&&(p<0&&y<p||p==y||p>0&&y>p)){d=g,f=_;continue}a[h++]=d,a[h++]=f,c=d,u=f,d=g,f=_}return a[h++]=d,a[h++]=f,h}function quantizeArray(l,t,n,s,o,a,h,c){for(let u=0,d=n.length;u<d;++u){const f=n[u];h=quantize(l,t,f,s,o,a,h),c.push(h),t=f}return h}function quantizeMultiArray(l,t,n,s,o,a,h,c){for(let u=0,d=n.length;u<d;++u){const f=n[u],g=[];h=quantizeArray(l,t,f,s,o,a,h,g),c.push(g),t=f[f.length-1]}return h}class LinearRing extends SimpleGeometry{constructor(t,n){super(),this.maxDelta_=-1,this.maxDeltaRevision_=-1,n!==void 0&&!Array.isArray(t[0])?this.setFlatCoordinates(n,t):this.setCoordinates(t,n)}clone(){return new LinearRing(this.flatCoordinates.slice(),this.layout)}closestPointXY(t,n,s,o){return o<closestSquaredDistanceXY(this.getExtent(),t,n)?o:(this.maxDeltaRevision_!=this.getRevision()&&(this.maxDelta_=Math.sqrt(maxSquaredDelta(this.flatCoordinates,0,this.flatCoordinates.length,this.stride,0)),this.maxDeltaRevision_=this.getRevision()),assignClosestPoint(this.flatCoordinates,0,this.flatCoordinates.length,this.stride,this.maxDelta_,!0,t,n,s,o))}getArea(){return linearRing(this.flatCoordinates,0,this.flatCoordinates.length,this.stride)}getCoordinates(){return inflateCoordinates(this.flatCoordinates,0,this.flatCoordinates.length,this.stride)}getSimplifiedGeometryInternal(t){const n=[];return n.length=douglasPeucker(this.flatCoordinates,0,this.flatCoordinates.length,this.stride,t,n,0),new LinearRing(n,"XY")}getType(){return"LinearRing"}intersectsExtent(t){return!1}setCoordinates(t,n){this.setLayout(n,t,1),this.flatCoordinates||(this.flatCoordinates=[]),this.flatCoordinates.length=deflateCoordinates(this.flatCoordinates,0,t,this.stride),this.changed()}}class Point extends SimpleGeometry{constructor(t,n){super(),this.setCoordinates(t,n)}clone(){const t=new Point(this.flatCoordinates.slice(),this.layout);return t.applyProperties(this),t}closestPointXY(t,n,s,o){const a=this.flatCoordinates,h=squaredDistance$1(t,n,a[0],a[1]);if(h<o){const c=this.stride;for(let u=0;u<c;++u)s[u]=a[u];return s.length=c,h}return o}getCoordinates(){return this.flatCoordinates.slice()}computeExtent(t){return createOrUpdateFromCoordinate(this.flatCoordinates,t)}getType(){return"Point"}intersectsExtent(t){return containsXY(t,this.flatCoordinates[0],this.flatCoordinates[1])}setCoordinates(t,n){this.setLayout(n,t,0),this.flatCoordinates||(this.flatCoordinates=[]),this.flatCoordinates.length=deflateCoordinate(this.flatCoordinates,0,t,this.stride),this.changed()}}function linearRingContainsExtent(l,t,n,s,o){return!forEachCorner(o,function(h){return!linearRingContainsXY(l,t,n,s,h[0],h[1])})}function linearRingContainsXY(l,t,n,s,o,a){let h=0,c=l[n-s],u=l[n-s+1];for(;t<n;t+=s){const d=l[t],f=l[t+1];u<=a?f>a&&(d-c)*(a-u)-(o-c)*(f-u)>0&&h++:f<=a&&(d-c)*(a-u)-(o-c)*(f-u)<0&&h--,c=d,u=f}return h!==0}function linearRingsContainsXY(l,t,n,s,o,a){if(n.length===0||!linearRingContainsXY(l,t,n[0],s,o,a))return!1;for(let h=1,c=n.length;h<c;++h)if(linearRingContainsXY(l,n[h-1],n[h],s,o,a))return!1;return!0}function linearRingssContainsXY(l,t,n,s,o,a){if(n.length===0)return!1;for(let h=0,c=n.length;h<c;++h){const u=n[h];if(linearRingsContainsXY(l,t,u,s,o,a))return!0;t=u[u.length-1]}return!1}function getInteriorPointOfArray(l,t,n,s,o,a,h){let c,u,d,f,g,_,m;const p=o[a+1],x=[];for(let S=0,C=n.length;S<C;++S){const P=n[S];for(f=l[P-s],_=l[P-s+1],c=t;c<P;c+=s)g=l[c],m=l[c+1],(p<=_&&m<=p||_<=p&&p<=m)&&(d=(p-_)/(m-_)*(g-f)+f,x.push(d)),f=g,_=m}let y=NaN,T=-1/0;for(x.sort(ascending),f=x[0],c=1,u=x.length;c<u;++c){g=x[c];const S=Math.abs(g-f);S>T&&(d=(f+g)/2,linearRingsContainsXY(l,t,n,s,d,p)&&(y=d,T=S)),f=g}return isNaN(y)&&(y=o[a]),h?(h.push(y,p,T),h):[y,p,T]}function getInteriorPointsOfMultiArray(l,t,n,s,o){let a=[];for(let h=0,c=n.length;h<c;++h){const u=n[h];a=getInteriorPointOfArray(l,t,u,s,o,2*h,a),t=u[u.length-1]}return a}function forEach(l,t,n,s,o){let a;for(t+=s;t<n;t+=s)if(a=o(l.slice(t-s,t),l.slice(t,t+s)),a)return a;return!1}function intersectsLineString(l,t,n,s,o,a){return a=a??extendFlatCoordinates(createEmpty(),l,t,n,s),intersects$1(o,a)?a[0]>=o[0]&&a[2]<=o[2]||a[1]>=o[1]&&a[3]<=o[3]?!0:forEach(l,t,n,s,function(h,c){return intersectsSegment(o,h,c)}):!1}function intersectsLineStringArray(l,t,n,s,o){for(let a=0,h=n.length;a<h;++a){if(intersectsLineString(l,t,n[a],s,o))return!0;t=n[a]}return!1}function intersectsLinearRing(l,t,n,s,o){return!!(intersectsLineString(l,t,n,s,o)||linearRingContainsXY(l,t,n,s,o[0],o[1])||linearRingContainsXY(l,t,n,s,o[0],o[3])||linearRingContainsXY(l,t,n,s,o[2],o[1])||linearRingContainsXY(l,t,n,s,o[2],o[3]))}function intersectsLinearRingArray(l,t,n,s,o){if(!intersectsLinearRing(l,t,n[0],s,o))return!1;if(n.length===1)return!0;for(let a=1,h=n.length;a<h;++a)if(linearRingContainsExtent(l,n[a-1],n[a],s,o)&&!intersectsLineString(l,n[a-1],n[a],s,o))return!1;return!0}function intersectsLinearRingMultiArray(l,t,n,s,o){for(let a=0,h=n.length;a<h;++a){const c=n[a];if(intersectsLinearRingArray(l,t,c,s,o))return!0;t=c[c.length-1]}return!1}function coordinates(l,t,n,s){for(;t<n-s;){for(let o=0;o<s;++o){const a=l[t+o];l[t+o]=l[n-s+o],l[n-s+o]=a}t+=s,n-=s}}function linearRingIsClockwise(l,t,n,s){let o=0,a=l[n-s],h=l[n-s+1];for(;t<n;t+=s){const c=l[t],u=l[t+1];o+=(c-a)*(u+h),a=c,h=u}return o===0?void 0:o>0}function linearRingsAreOriented(l,t,n,s,o){o=o!==void 0?o:!1;for(let a=0,h=n.length;a<h;++a){const c=n[a],u=linearRingIsClockwise(l,t,c,s);if(a===0){if(o&&u||!o&&!u)return!1}else if(o&&!u||!o&&u)return!1;t=c}return!0}function linearRingssAreOriented(l,t,n,s,o){for(let a=0,h=n.length;a<h;++a){const c=n[a];if(!linearRingsAreOriented(l,t,c,s,o))return!1;c.length&&(t=c[c.length-1])}return!0}function orientLinearRings(l,t,n,s,o){o=o!==void 0?o:!1;for(let a=0,h=n.length;a<h;++a){const c=n[a],u=linearRingIsClockwise(l,t,c,s);(a===0?o&&u||!o&&!u:o&&!u||!o&&u)&&coordinates(l,t,c,s),t=c}return t}function orientLinearRingsArray(l,t,n,s,o){for(let a=0,h=n.length;a<h;++a)t=orientLinearRings(l,t,n[a],s,o);return t}function inflateEnds(l,t){const n=[];let s=0,o=0,a;for(let h=0,c=t.length;h<c;++h){const u=t[h],d=linearRingIsClockwise(l,s,u,2);if(a===void 0&&(a=d),d===a)n.push(t.slice(o,h+1));else{if(n.length===0)continue;n[n.length-1].push(t[o])}o=h+1,s=u}return n}class Polygon extends SimpleGeometry{constructor(t,n,s){super(),this.ends_=[],this.flatInteriorPointRevision_=-1,this.flatInteriorPoint_=null,this.maxDelta_=-1,this.maxDeltaRevision_=-1,this.orientedRevision_=-1,this.orientedFlatCoordinates_=null,n!==void 0&&s?(this.setFlatCoordinates(n,t),this.ends_=s):this.setCoordinates(t,n)}appendLinearRing(t){this.flatCoordinates?extend$2(this.flatCoordinates,t.getFlatCoordinates()):this.flatCoordinates=t.getFlatCoordinates().slice(),this.ends_.push(this.flatCoordinates.length),this.changed()}clone(){const t=new Polygon(this.flatCoordinates.slice(),this.layout,this.ends_.slice());return t.applyProperties(this),t}closestPointXY(t,n,s,o){return o<closestSquaredDistanceXY(this.getExtent(),t,n)?o:(this.maxDeltaRevision_!=this.getRevision()&&(this.maxDelta_=Math.sqrt(arrayMaxSquaredDelta(this.flatCoordinates,0,this.ends_,this.stride,0)),this.maxDeltaRevision_=this.getRevision()),assignClosestArrayPoint(this.flatCoordinates,0,this.ends_,this.stride,this.maxDelta_,!0,t,n,s,o))}containsXY(t,n){return linearRingsContainsXY(this.getOrientedFlatCoordinates(),0,this.ends_,this.stride,t,n)}getArea(){return linearRings(this.getOrientedFlatCoordinates(),0,this.ends_,this.stride)}getCoordinates(t){let n;return t!==void 0?(n=this.getOrientedFlatCoordinates().slice(),orientLinearRings(n,0,this.ends_,this.stride,t)):n=this.flatCoordinates,inflateCoordinatesArray(n,0,this.ends_,this.stride)}getEnds(){return this.ends_}getFlatInteriorPoint(){if(this.flatInteriorPointRevision_!=this.getRevision()){const t=getCenter(this.getExtent());this.flatInteriorPoint_=getInteriorPointOfArray(this.getOrientedFlatCoordinates(),0,this.ends_,this.stride,t,0),this.flatInteriorPointRevision_=this.getRevision()}return this.flatInteriorPoint_}getInteriorPoint(){return new Point(this.getFlatInteriorPoint(),"XYM")}getLinearRingCount(){return this.ends_.length}getLinearRing(t){return t<0||this.ends_.length<=t?null:new LinearRing(this.flatCoordinates.slice(t===0?0:this.ends_[t-1],this.ends_[t]),this.layout)}getLinearRings(){const t=this.layout,n=this.flatCoordinates,s=this.ends_,o=[];let a=0;for(let h=0,c=s.length;h<c;++h){const u=s[h],d=new LinearRing(n.slice(a,u),t);o.push(d),a=u}return o}getOrientedFlatCoordinates(){if(this.orientedRevision_!=this.getRevision()){const t=this.flatCoordinates;linearRingsAreOriented(t,0,this.ends_,this.stride)?this.orientedFlatCoordinates_=t:(this.orientedFlatCoordinates_=t.slice(),this.orientedFlatCoordinates_.length=orientLinearRings(this.orientedFlatCoordinates_,0,this.ends_,this.stride)),this.orientedRevision_=this.getRevision()}return this.orientedFlatCoordinates_}getSimplifiedGeometryInternal(t){const n=[],s=[];return n.length=quantizeArray(this.flatCoordinates,0,this.ends_,this.stride,Math.sqrt(t),n,0,s),new Polygon(n,"XY",s)}getType(){return"Polygon"}intersectsExtent(t){return intersectsLinearRingArray(this.getOrientedFlatCoordinates(),0,this.ends_,this.stride,t)}setCoordinates(t,n){this.setLayout(n,t,2),this.flatCoordinates||(this.flatCoordinates=[]);const s=deflateCoordinatesArray(this.flatCoordinates,0,t,this.stride,this.ends_);this.flatCoordinates.length=s.length===0?0:s[s.length-1],this.changed()}}function circular(l,t,n,s){n=n||32;const o=[];for(let a=0;a<n;++a)extend$2(o,offset(l,t,2*Math.PI*a/n,s));return o.push(o[0],o[1]),new Polygon(o,"XY",[o.length])}function fromExtent(l){if(isEmpty(l))throw new Error("Cannot create polygon from empty extent");const t=l[0],n=l[1],s=l[2],o=l[3],a=[t,n,t,o,s,o,s,n,t,n];return new Polygon(a,"XY",[a.length])}function getViewportClampedResolution(l,t,n,s){const o=getWidth(t)/n[0],a=getHeight(t)/n[1];return s?Math.min(l,Math.max(o,a)):Math.min(l,Math.min(o,a))}function getSmoothClampedResolution(l,t,n){let s=Math.min(l,t);const o=50;return s*=Math.log(1+o*Math.max(0,l/t-1))/o+1,n&&(s=Math.max(s,n),s/=Math.log(1+o*Math.max(0,n/l-1))/o+1),clamp(s,n/2,t*2)}function createSnapToResolutions(l,t,n,s){return t=t!==void 0?t:!0,function(o,a,h,c){if(o!==void 0){const u=l[0],d=l[l.length-1],f=n?getViewportClampedResolution(u,n,h,s):u;if(c)return t?getSmoothClampedResolution(o,f,d):clamp(o,d,f);const g=Math.min(f,o),_=Math.floor(linearFindNearest(l,g,a));return l[_]>f&&_<l.length-1?l[_+1]:l[_]}}}function createSnapToPower(l,t,n,s,o,a){return s=s!==void 0?s:!0,n=n!==void 0?n:0,function(h,c,u,d){if(h!==void 0){const f=o?getViewportClampedResolution(t,o,u,a):t;if(d)return s?getSmoothClampedResolution(h,f,n):clamp(h,n,f);const g=1e-9,_=Math.ceil(Math.log(t/f)/Math.log(l)-g),m=-c*(.5-g)+.5,p=Math.min(f,h),x=Math.floor(Math.log(t/p)/Math.log(l)+m),y=Math.max(_,x),T=t/Math.pow(l,y);return clamp(T,n,f)}}}function createMinMaxResolution(l,t,n,s,o){return n=n!==void 0?n:!0,function(a,h,c,u){if(a!==void 0){const d=s?getViewportClampedResolution(l,s,c,o):l;return!n||!u?clamp(a,t,d):getSmoothClampedResolution(a,d,t)}}}function disable(l){if(l!==void 0)return 0}function none(l){if(l!==void 0)return l}function createSnapToN(l){const t=2*Math.PI/l;return function(n,s){if(s)return n;if(n!==void 0)return n=Math.floor(n/t+.5)*t,n}}function createSnapToZero(l){const t=toRadians(5);return function(n,s){return s||n===void 0?n:Math.abs(n)<=t?0:n}}const DEFAULT_MAX_ZOOM=42,DEFAULT_TILE_SIZE=256,DEFAULT_MIN_ZOOM=0;class View extends BaseObject{constructor(t){super(),this.on,this.once,this.un,t=Object.assign({},t),this.hints_=[0,0],this.animations_=[],this.updateAnimationKey_,this.projection_=createProjection(t.projection,"EPSG:3857"),this.viewportSize_=[100,100],this.targetCenter_=null,this.targetResolution_,this.targetRotation_,this.nextCenter_=null,this.nextResolution_,this.nextRotation_,this.cancelAnchor_=void 0,t.projection&&disableCoordinateWarning(),t.center&&(t.center=fromUserCoordinate(t.center,this.projection_)),t.extent&&(t.extent=fromUserExtent(t.extent,this.projection_)),this.applyOptions_(t)}applyOptions_(t){const n=Object.assign({},t);for(const c in ViewProperty)delete n[c];this.setProperties(n,!0);const s=createResolutionConstraint(t);this.maxResolution_=s.maxResolution,this.minResolution_=s.minResolution,this.zoomFactor_=s.zoomFactor,this.resolutions_=t.resolutions,this.padding_=t.padding,this.minZoom_=s.minZoom;const o=createCenterConstraint(t),a=s.constraint,h=createRotationConstraint(t);this.constraints_={center:o,resolution:a,rotation:h},this.setRotation(t.rotation!==void 0?t.rotation:0),this.setCenterInternal(t.center!==void 0?t.center:null),t.resolution!==void 0?this.setResolution(t.resolution):t.zoom!==void 0&&this.setZoom(t.zoom)}get padding(){return this.padding_}set padding(t){let n=this.padding_;this.padding_=t;const s=this.getCenterInternal();if(s){const o=t||[0,0,0,0];n=n||[0,0,0,0];const a=this.getResolution(),h=a/2*(o[3]-n[3]+n[1]-o[1]),c=a/2*(o[0]-n[0]+n[2]-o[2]);this.setCenterInternal([s[0]+h,s[1]-c])}}getUpdatedOptions_(t){const n=this.getProperties();return n.resolution!==void 0?n.resolution=this.getResolution():n.zoom=this.getZoom(),n.center=this.getCenterInternal(),n.rotation=this.getRotation(),Object.assign({},n,t)}animate(t){this.isDef()&&!this.getAnimating()&&this.resolveConstraints(0);const n=new Array(arguments.length);for(let s=0;s<n.length;++s){let o=arguments[s];o.center&&(o=Object.assign({},o),o.center=fromUserCoordinate(o.center,this.getProjection())),o.anchor&&(o=Object.assign({},o),o.anchor=fromUserCoordinate(o.anchor,this.getProjection())),n[s]=o}this.animateInternal.apply(this,n)}animateInternal(t){let n=arguments.length,s;n>1&&typeof arguments[n-1]=="function"&&(s=arguments[n-1],--n);let o=0;for(;o<n&&!this.isDef();++o){const f=arguments[o];f.center&&this.setCenterInternal(f.center),f.zoom!==void 0?this.setZoom(f.zoom):f.resolution&&this.setResolution(f.resolution),f.rotation!==void 0&&this.setRotation(f.rotation)}if(o===n){s&&animationCallback(s,!0);return}let a=Date.now(),h=this.targetCenter_.slice(),c=this.targetResolution_,u=this.targetRotation_;const d=[];for(;o<n;++o){const f=arguments[o],g={start:a,complete:!1,anchor:f.anchor,duration:f.duration!==void 0?f.duration:1e3,easing:f.easing||inAndOut,callback:s};if(f.center&&(g.sourceCenter=h,g.targetCenter=f.center.slice(),h=g.targetCenter),f.zoom!==void 0?(g.sourceResolution=c,g.targetResolution=this.getResolutionForZoom(f.zoom),c=g.targetResolution):f.resolution&&(g.sourceResolution=c,g.targetResolution=f.resolution,c=g.targetResolution),f.rotation!==void 0){g.sourceRotation=u;const _=modulo(f.rotation-u+Math.PI,2*Math.PI)-Math.PI;g.targetRotation=u+_,u=g.targetRotation}isNoopAnimation(g)?g.complete=!0:a+=g.duration,d.push(g)}this.animations_.push(d),this.setHint(ViewHint.ANIMATING,1),this.updateAnimations_()}getAnimating(){return this.hints_[ViewHint.ANIMATING]>0}getInteracting(){return this.hints_[ViewHint.INTERACTING]>0}cancelAnimations(){this.setHint(ViewHint.ANIMATING,-this.hints_[ViewHint.ANIMATING]);let t;for(let n=0,s=this.animations_.length;n<s;++n){const o=this.animations_[n];if(o[0].callback&&animationCallback(o[0].callback,!1),!t)for(let a=0,h=o.length;a<h;++a){const c=o[a];if(!c.complete){t=c.anchor;break}}}this.animations_.length=0,this.cancelAnchor_=t,this.nextCenter_=null,this.nextResolution_=NaN,this.nextRotation_=NaN}updateAnimations_(){if(this.updateAnimationKey_!==void 0&&(cancelAnimationFrame(this.updateAnimationKey_),this.updateAnimationKey_=void 0),!this.getAnimating())return;const t=Date.now();let n=!1;for(let s=this.animations_.length-1;s>=0;--s){const o=this.animations_[s];let a=!0;for(let h=0,c=o.length;h<c;++h){const u=o[h];if(u.complete)continue;const d=t-u.start;let f=u.duration>0?d/u.duration:1;f>=1?(u.complete=!0,f=1):a=!1;const g=u.easing(f);if(u.sourceCenter){const _=u.sourceCenter[0],m=u.sourceCenter[1],p=u.targetCenter[0],x=u.targetCenter[1];this.nextCenter_=u.targetCenter;const y=_+g*(p-_),T=m+g*(x-m);this.targetCenter_=[y,T]}if(u.sourceResolution&&u.targetResolution){const _=g===1?u.targetResolution:u.sourceResolution+g*(u.targetResolution-u.sourceResolution);if(u.anchor){const m=this.getViewportSize_(this.getRotation()),p=this.constraints_.resolution(_,0,m,!0);this.targetCenter_=this.calculateCenterZoom(p,u.anchor)}this.nextResolution_=u.targetResolution,this.targetResolution_=_,this.applyTargetState_(!0)}if(u.sourceRotation!==void 0&&u.targetRotation!==void 0){const _=g===1?modulo(u.targetRotation+Math.PI,2*Math.PI)-Math.PI:u.sourceRotation+g*(u.targetRotation-u.sourceRotation);if(u.anchor){const m=this.constraints_.rotation(_,!0);this.targetCenter_=this.calculateCenterRotate(m,u.anchor)}this.nextRotation_=u.targetRotation,this.targetRotation_=_}if(this.applyTargetState_(!0),n=!0,!u.complete)break}if(a){this.animations_[s]=null,this.setHint(ViewHint.ANIMATING,-1),this.nextCenter_=null,this.nextResolution_=NaN,this.nextRotation_=NaN;const h=o[0].callback;h&&animationCallback(h,!0)}}this.animations_=this.animations_.filter(Boolean),n&&this.updateAnimationKey_===void 0&&(this.updateAnimationKey_=requestAnimationFrame(this.updateAnimations_.bind(this)))}calculateCenterRotate(t,n){let s;const o=this.getCenterInternal();return o!==void 0&&(s=[o[0]-n[0],o[1]-n[1]],rotate$2(s,t-this.getRotation()),add$2(s,n)),s}calculateCenterZoom(t,n){let s;const o=this.getCenterInternal(),a=this.getResolution();if(o!==void 0&&a!==void 0){const h=n[0]-t*(n[0]-o[0])/a,c=n[1]-t*(n[1]-o[1])/a;s=[h,c]}return s}getViewportSize_(t){const n=this.viewportSize_;if(t){const s=n[0],o=n[1];return[Math.abs(s*Math.cos(t))+Math.abs(o*Math.sin(t)),Math.abs(s*Math.sin(t))+Math.abs(o*Math.cos(t))]}return n}setViewportSize(t){this.viewportSize_=Array.isArray(t)?t.slice():[100,100],this.getAnimating()||this.resolveConstraints(0)}getCenter(){const t=this.getCenterInternal();return t&&toUserCoordinate(t,this.getProjection())}getCenterInternal(){return this.get(ViewProperty.CENTER)}getConstraints(){return this.constraints_}getConstrainResolution(){return this.get("constrainResolution")}getHints(t){return t!==void 0?(t[0]=this.hints_[0],t[1]=this.hints_[1],t):this.hints_.slice()}calculateExtent(t){const n=this.calculateExtentInternal(t);return toUserExtent(n,this.getProjection())}calculateExtentInternal(t){t=t||this.getViewportSizeMinusPadding_();const n=this.getCenterInternal();assert(n,"The view center is not defined");const s=this.getResolution();assert(s!==void 0,"The view resolution is not defined");const o=this.getRotation();return assert(o!==void 0,"The view rotation is not defined"),getForViewAndSize(n,s,o,t)}getMaxResolution(){return this.maxResolution_}getMinResolution(){return this.minResolution_}getMaxZoom(){return this.getZoomForResolution(this.minResolution_)}setMaxZoom(t){this.applyOptions_(this.getUpdatedOptions_({maxZoom:t}))}getMinZoom(){return this.getZoomForResolution(this.maxResolution_)}setMinZoom(t){this.applyOptions_(this.getUpdatedOptions_({minZoom:t}))}setConstrainResolution(t){this.applyOptions_(this.getUpdatedOptions_({constrainResolution:t}))}getProjection(){return this.projection_}getResolution(){return this.get(ViewProperty.RESOLUTION)}getResolutions(){return this.resolutions_}getResolutionForExtent(t,n){return this.getResolutionForExtentInternal(fromUserExtent(t,this.getProjection()),n)}getResolutionForExtentInternal(t,n){n=n||this.getViewportSizeMinusPadding_();const s=getWidth(t)/n[0],o=getHeight(t)/n[1];return Math.max(s,o)}getResolutionForValueFunction(t){t=t||2;const n=this.getConstrainedResolution(this.maxResolution_),s=this.minResolution_,o=Math.log(n/s)/Math.log(t);return function(a){return n/Math.pow(t,a*o)}}getRotation(){return this.get(ViewProperty.ROTATION)}getValueForResolutionFunction(t){const n=Math.log(t||2),s=this.getConstrainedResolution(this.maxResolution_),o=this.minResolution_,a=Math.log(s/o)/n;return function(h){return Math.log(s/h)/n/a}}getViewportSizeMinusPadding_(t){let n=this.getViewportSize_(t);const s=this.padding_;return s&&(n=[n[0]-s[1]-s[3],n[1]-s[0]-s[2]]),n}getState(){const t=this.getProjection(),n=this.getResolution(),s=this.getRotation();let o=this.getCenterInternal();const a=this.padding_;if(a){const h=this.getViewportSizeMinusPadding_();o=calculateCenterOn(o,this.getViewportSize_(),[h[0]/2+a[3],h[1]/2+a[0]],n,s)}return{center:o.slice(0),projection:t!==void 0?t:null,resolution:n,nextCenter:this.nextCenter_,nextResolution:this.nextResolution_,nextRotation:this.nextRotation_,rotation:s,zoom:this.getZoom()}}getViewStateAndExtent(){return{viewState:this.getState(),extent:this.calculateExtent()}}getZoom(){let t;const n=this.getResolution();return n!==void 0&&(t=this.getZoomForResolution(n)),t}getZoomForResolution(t){let n=this.minZoom_||0,s,o;if(this.resolutions_){const a=linearFindNearest(this.resolutions_,t,1);n=a,s=this.resolutions_[a],a==this.resolutions_.length-1?o=2:o=s/this.resolutions_[a+1]}else s=this.maxResolution_,o=this.zoomFactor_;return n+Math.log(s/t)/Math.log(o)}getResolutionForZoom(t){var n;if((n=this.resolutions_)!=null&&n.length){if(this.resolutions_.length===1)return this.resolutions_[0];const s=clamp(Math.floor(t),0,this.resolutions_.length-2),o=this.resolutions_[s]/this.resolutions_[s+1];return this.resolutions_[s]/Math.pow(o,clamp(t-s,0,1))}return this.maxResolution_/Math.pow(this.zoomFactor_,t-this.minZoom_)}fit(t,n){let s;if(assert(Array.isArray(t)||typeof t.getSimplifiedGeometry=="function","Invalid extent or geometry provided as `geometry`"),Array.isArray(t)){assert(!isEmpty(t),"Cannot fit empty extent provided as `geometry`");const o=fromUserExtent(t,this.getProjection());s=fromExtent(o)}else if(t.getType()==="Circle"){const o=fromUserExtent(t.getExtent(),this.getProjection());s=fromExtent(o),s.rotate(this.getRotation(),getCenter(o))}else s=t;this.fitInternal(s,n)}rotatedExtentForGeometry(t){const n=this.getRotation(),s=Math.cos(n),o=Math.sin(-n),a=t.getFlatCoordinates(),h=t.getStride();let c=1/0,u=1/0,d=-1/0,f=-1/0;for(let g=0,_=a.length;g<_;g+=h){const m=a[g]*s-a[g+1]*o,p=a[g]*o+a[g+1]*s;c=Math.min(c,m),u=Math.min(u,p),d=Math.max(d,m),f=Math.max(f,p)}return[c,u,d,f]}fitInternal(t,n){n=n||{};let s=n.size;s||(s=this.getViewportSizeMinusPadding_());const o=n.padding!==void 0?n.padding:[0,0,0,0],a=n.nearest!==void 0?n.nearest:!1;let h;n.minResolution!==void 0?h=n.minResolution:n.maxZoom!==void 0?h=this.getResolutionForZoom(n.maxZoom):h=0;const c=this.rotatedExtentForGeometry(t);let u=this.getResolutionForExtentInternal(c,[s[0]-o[1]-o[3],s[1]-o[0]-o[2]]);u=isNaN(u)?h:Math.max(u,h),u=this.getConstrainedResolution(u,a?0:1);const d=this.getRotation(),f=Math.sin(d),g=Math.cos(d),_=getCenter(c);_[0]+=(o[1]-o[3])/2*u,_[1]+=(o[0]-o[2])/2*u;const m=_[0]*g-_[1]*f,p=_[1]*g+_[0]*f,x=this.getConstrainedCenter([m,p],u),y=n.callback?n.callback:VOID;n.duration!==void 0?this.animateInternal({resolution:u,center:x,duration:n.duration,easing:n.easing},y):(this.targetResolution_=u,this.targetCenter_=x,this.applyTargetState_(!1,!0),animationCallback(y,!0))}centerOn(t,n,s){this.centerOnInternal(fromUserCoordinate(t,this.getProjection()),n,s)}centerOnInternal(t,n,s){this.setCenterInternal(calculateCenterOn(t,n,s,this.getResolution(),this.getRotation()))}calculateCenterShift(t,n,s,o){let a;const h=this.padding_;if(h&&t){const c=this.getViewportSizeMinusPadding_(-s),u=calculateCenterOn(t,o,[c[0]/2+h[3],c[1]/2+h[0]],n,s);a=[t[0]-u[0],t[1]-u[1]]}return a}isDef(){return!!this.getCenterInternal()&&this.getResolution()!==void 0}adjustCenter(t){const n=toUserCoordinate(this.targetCenter_,this.getProjection());this.setCenter([n[0]+t[0],n[1]+t[1]])}adjustCenterInternal(t){const n=this.targetCenter_;this.setCenterInternal([n[0]+t[0],n[1]+t[1]])}adjustResolution(t,n){n=n&&fromUserCoordinate(n,this.getProjection()),this.adjustResolutionInternal(t,n)}adjustResolutionInternal(t,n){const s=this.getAnimating()||this.getInteracting(),o=this.getViewportSize_(this.getRotation()),a=this.constraints_.resolution(this.targetResolution_*t,0,o,s);n&&(this.targetCenter_=this.calculateCenterZoom(a,n)),this.targetResolution_*=t,this.applyTargetState_()}adjustZoom(t,n){this.adjustResolution(Math.pow(this.zoomFactor_,-t),n)}adjustRotation(t,n){n&&(n=fromUserCoordinate(n,this.getProjection())),this.adjustRotationInternal(t,n)}adjustRotationInternal(t,n){const s=this.getAnimating()||this.getInteracting(),o=this.constraints_.rotation(this.targetRotation_+t,s);n&&(this.targetCenter_=this.calculateCenterRotate(o,n)),this.targetRotation_+=t,this.applyTargetState_()}setCenter(t){this.setCenterInternal(t&&fromUserCoordinate(t,this.getProjection()))}setCenterInternal(t){this.targetCenter_=t,this.applyTargetState_()}setHint(t,n){return this.hints_[t]+=n,this.changed(),this.hints_[t]}setResolution(t){this.targetResolution_=t,this.applyTargetState_()}setRotation(t){this.targetRotation_=t,this.applyTargetState_()}setZoom(t){this.setResolution(this.getResolutionForZoom(t))}applyTargetState_(t,n){const s=this.getAnimating()||this.getInteracting()||n,o=this.constraints_.rotation(this.targetRotation_,s),a=this.getViewportSize_(o),h=this.constraints_.resolution(this.targetResolution_,0,a,s),c=this.constraints_.center(this.targetCenter_,h,a,s,this.calculateCenterShift(this.targetCenter_,h,o,a));this.get(ViewProperty.ROTATION)!==o&&this.set(ViewProperty.ROTATION,o),this.get(ViewProperty.RESOLUTION)!==h&&(this.set(ViewProperty.RESOLUTION,h),this.set("zoom",this.getZoom(),!0)),(!c||!this.get(ViewProperty.CENTER)||!equals(this.get(ViewProperty.CENTER),c))&&this.set(ViewProperty.CENTER,c),this.getAnimating()&&!t&&this.cancelAnimations(),this.cancelAnchor_=void 0}resolveConstraints(t,n,s){t=t!==void 0?t:200;const o=n||0,a=this.constraints_.rotation(this.targetRotation_),h=this.getViewportSize_(a),c=this.constraints_.resolution(this.targetResolution_,o,h),u=this.constraints_.center(this.targetCenter_,c,h,!1,this.calculateCenterShift(this.targetCenter_,c,a,h));if(t===0&&!this.cancelAnchor_){this.targetResolution_=c,this.targetRotation_=a,this.targetCenter_=u,this.applyTargetState_();return}s=s||(t===0?this.cancelAnchor_:void 0),this.cancelAnchor_=void 0,(this.getResolution()!==c||this.getRotation()!==a||!this.getCenterInternal()||!equals(this.getCenterInternal(),u))&&(this.getAnimating()&&this.cancelAnimations(),this.animateInternal({rotation:a,center:u,resolution:c,duration:t,easing:easeOut,anchor:s}))}beginInteraction(){this.resolveConstraints(0),this.setHint(ViewHint.INTERACTING,1)}endInteraction(t,n,s){s=s&&fromUserCoordinate(s,this.getProjection()),this.endInteractionInternal(t,n,s)}endInteractionInternal(t,n,s){this.getInteracting()&&(this.setHint(ViewHint.INTERACTING,-1),this.resolveConstraints(t,n,s))}getConstrainedCenter(t,n){const s=this.getViewportSize_(this.getRotation());return this.constraints_.center(t,n||this.getResolution(),s)}getConstrainedZoom(t,n){const s=this.getResolutionForZoom(t);return this.getZoomForResolution(this.getConstrainedResolution(s,n))}getConstrainedResolution(t,n){n=n||0;const s=this.getViewportSize_(this.getRotation());return this.constraints_.resolution(t,n,s)}}function animationCallback(l,t){setTimeout(function(){l(t)},0)}function createCenterConstraint(l){if(l.extent!==void 0){const n=l.smoothExtentConstraint!==void 0?l.smoothExtentConstraint:!0;return createExtent(l.extent,l.constrainOnlyCenter,n)}const t=createProjection(l.projection,"EPSG:3857");if(l.multiWorld!==!0&&t.isGlobal()){const n=t.getExtent().slice();return n[0]=-1/0,n[2]=1/0,createExtent(n,!1,!1)}return none$1}function createResolutionConstraint(l){let t,n,s,h=l.minZoom!==void 0?l.minZoom:DEFAULT_MIN_ZOOM,c=l.maxZoom!==void 0?l.maxZoom:28;const u=l.zoomFactor!==void 0?l.zoomFactor:2,d=l.multiWorld!==void 0?l.multiWorld:!1,f=l.smoothResolutionConstraint!==void 0?l.smoothResolutionConstraint:!0,g=l.showFullExtent!==void 0?l.showFullExtent:!1,_=createProjection(l.projection,"EPSG:3857"),m=_.getExtent();let p=l.constrainOnlyCenter,x=l.extent;if(!d&&!x&&_.isGlobal()&&(p=!1,x=m),l.resolutions!==void 0){const y=l.resolutions;n=y[h],s=y[c]!==void 0?y[c]:y[y.length-1],l.constrainResolution?t=createSnapToResolutions(y,f,!p&&x,g):t=createMinMaxResolution(n,s,f,!p&&x,g)}else{const T=(m?Math.max(getWidth(m),getHeight(m)):360*METERS_PER_UNIT$1.degrees/_.getMetersPerUnit())/DEFAULT_TILE_SIZE/Math.pow(2,DEFAULT_MIN_ZOOM),S=T/Math.pow(2,28-DEFAULT_MIN_ZOOM);n=l.maxResolution,n!==void 0?h=0:n=T/Math.pow(u,h),s=l.minResolution,s===void 0&&(l.maxZoom!==void 0?l.maxResolution!==void 0?s=n/Math.pow(u,c):s=T/Math.pow(u,c):s=S),c=h+Math.floor(Math.log(n/s)/Math.log(u)),s=n/Math.pow(u,c-h),l.constrainResolution?t=createSnapToPower(u,n,s,f,!p&&x,g):t=createMinMaxResolution(n,s,f,!p&&x,g)}return{constraint:t,maxResolution:n,minResolution:s,minZoom:h,zoomFactor:u}}function createRotationConstraint(l){if(l.enableRotation!==void 0?l.enableRotation:!0){const n=l.constrainRotation;return n===void 0||n===!0?createSnapToZero():n===!1?none:typeof n=="number"?createSnapToN(n):none}return disable}function isNoopAnimation(l){return!(l.sourceCenter&&l.targetCenter&&!equals(l.sourceCenter,l.targetCenter)||l.sourceResolution!==l.targetResolution||l.sourceRotation!==l.targetRotation)}function calculateCenterOn(l,t,n,s,o){const a=Math.cos(-o);let h=Math.sin(-o),c=l[0]*a-l[1]*h,u=l[1]*a+l[0]*h;c+=(t[0]/2-n[0])*s,u+=(n[1]-t[1]/2)*s,h=-h;const d=c*a-u*h,f=u*a+c*h;return[d,f]}const CLASS_HIDDEN="ol-hidden",CLASS_SELECTABLE="ol-selectable",CLASS_UNSELECTABLE="ol-unselectable",CLASS_UNSUPPORTED="ol-unsupported",CLASS_CONTROL="ol-control",CLASS_COLLAPSED="ol-collapsed",fontRegEx=new RegExp(["^\\s*(?=(?:(?:[-a-z]+\\s*){0,2}(italic|oblique))?)","(?=(?:(?:[-a-z]+\\s*){0,2}(small-caps))?)","(?=(?:(?:[-a-z]+\\s*){0,2}(bold(?:er)?|lighter|[1-9]00 ))?)","(?:(?:normal|\\1|\\2|\\3)\\s*){0,3}((?:xx?-)?","(?:small|large)|medium|smaller|larger|[\\.\\d]+(?:\\%|in|[cem]m|ex|p[ctx]))","(?:\\s*\\/\\s*(normal|[\\.\\d]+(?:\\%|in|[cem]m|ex|p[ctx])?))",`?\\s*([-,\\"\\'\\sa-z0-9]+?)\\s*$`].join(""),"i"),fontRegExMatchIndex=["style","variant","weight","size","lineHeight","family"],fontWeights={normal:400,bold:700},getFontParameters=function(l){const t=l.match(fontRegEx);if(!t)return null;const n={lineHeight:"normal",size:"1.2em",style:"normal",weight:"400",variant:"normal"};for(let s=0,o=fontRegExMatchIndex.length;s<o;++s){const a=t[s+1];a!==void 0&&(n[fontRegExMatchIndex[s]]=typeof a=="string"?a.trim():a)}return isNaN(Number(n.weight))&&n.weight in fontWeights&&(n.weight=fontWeights[n.weight]),n.families=n.family.split(/,\s?/).map(s=>s.trim().replace(/^['"]|['"]$/g,"")),n};function createCanvasContext2D(l,t,n,s){let o;return n&&n.length?o=n.shift():WORKER_OFFSCREEN_CANVAS?o=new class extends OffscreenCanvas{constructor(){super(...arguments);Cu(this,"style",{})}}(l??300,t??150):o=document.createElement("canvas"),l&&(o.width=l),t&&(o.height=t),o.getContext("2d",s)}let sharedCanvasContext;function getSharedCanvasContext2D(){return sharedCanvasContext||(sharedCanvasContext=createCanvasContext2D(1,1)),sharedCanvasContext}function releaseCanvas$1(l){const t=l.canvas;t.width=1,t.height=1,l.clearRect(0,0,1,1)}function outerWidth(l){let t=l.offsetWidth;const n=getComputedStyle(l);return t+=parseInt(n.marginLeft,10)+parseInt(n.marginRight,10),t}function outerHeight(l){let t=l.offsetHeight;const n=getComputedStyle(l);return t+=parseInt(n.marginTop,10)+parseInt(n.marginBottom,10),t}function replaceNode(l,t){const n=t.parentNode;n&&n.replaceChild(l,t)}function removeChildren(l){for(;l.lastChild;)l.lastChild.remove()}function replaceChildren(l,t){const n=l.childNodes;for(let s=0;;++s){const o=n[s],a=t[s];if(!o&&!a)break;if(o!==a){if(!o){l.appendChild(a);continue}if(!a){l.removeChild(o),--s;continue}l.insertBefore(a,o)}}}function createMockDiv(){return new Proxy({childNodes:[],appendChild:function(t){return this.childNodes.push(t),t},remove:function(){},removeChild:function(t){const n=this.childNodes.indexOf(t);if(n===-1)throw new Error("Node to remove was not found");return this.childNodes.splice(n,1),t},insertBefore:function(t,n){const s=this.childNodes.indexOf(n);if(s===-1)throw new Error("Reference node not found");return this.childNodes.splice(s,0,t),t},style:{}},{get(t,n,s){return n==="firstElementChild"?t.childNodes.length>0?t.childNodes[0]:null:Reflect.get(t,n,s)}})}function isCanvas(l){return typeof HTMLCanvasElement<"u"&&l instanceof HTMLCanvasElement||typeof OffscreenCanvas<"u"&&l instanceof OffscreenCanvas}class Control extends BaseObject{constructor(t){super();const n=t.element;n&&!t.target&&!n.style.pointerEvents&&(n.style.pointerEvents="auto"),this.element=n||null,this.target_=null,this.map_=null,this.listenerKeys=[],t.render&&(this.render=t.render),t.target&&this.setTarget(t.target)}disposeInternal(){var t;(t=this.element)==null||t.remove(),super.disposeInternal()}getMap(){return this.map_}setMap(t){var n;this.map_&&((n=this.element)==null||n.remove());for(let s=0,o=this.listenerKeys.length;s<o;++s)unlistenByKey(this.listenerKeys[s]);if(this.listenerKeys.length=0,this.map_=t,t){const s=this.target_??t.getOverlayContainerStopEvent();this.element&&s.appendChild(this.element),this.render!==VOID&&this.listenerKeys.push(listen(t,MapEventType.POSTRENDER,this.render,this)),t.render()}}render(t){}setTarget(t){this.target_=typeof t=="string"?document.getElementById(t):t}}class Attribution extends Control{constructor(t){t=t||{},super({element:document.createElement("div"),render:t.render,target:t.target}),this.ulElement_=document.createElement("ul"),this.collapsed_=t.collapsed!==void 0?t.collapsed:!0,this.userCollapsed_=this.collapsed_,this.overrideCollapsible_=t.collapsible!==void 0,this.collapsible_=t.collapsible!==void 0?t.collapsible:!0,this.collapsible_||(this.collapsed_=!1),this.attributions_=t.attributions;const n=t.className!==void 0?t.className:"ol-attribution",s=t.tipLabel!==void 0?t.tipLabel:"Attributions",o=t.expandClassName!==void 0?t.expandClassName:n+"-expand",a=t.collapseLabel!==void 0?t.collapseLabel:"›",h=t.collapseClassName!==void 0?t.collapseClassName:n+"-collapse";typeof a=="string"?(this.collapseLabel_=document.createElement("span"),this.collapseLabel_.textContent=a,this.collapseLabel_.className=h):this.collapseLabel_=a;const c=t.label!==void 0?t.label:"i";typeof c=="string"?(this.label_=document.createElement("span"),this.label_.textContent=c,this.label_.className=o):this.label_=c;const u=this.collapsible_&&!this.collapsed_?this.collapseLabel_:this.label_;this.toggleButton_=document.createElement("button"),this.toggleButton_.setAttribute("type","button"),this.toggleButton_.setAttribute("aria-expanded",String(!this.collapsed_)),this.toggleButton_.title=s,this.toggleButton_.appendChild(u),this.toggleButton_.addEventListener(EventType$1.CLICK,this.handleClick_.bind(this),!1);const d=n+" "+CLASS_UNSELECTABLE+" "+CLASS_CONTROL+(this.collapsed_&&this.collapsible_?" "+CLASS_COLLAPSED:"")+(this.collapsible_?"":" ol-uncollapsible"),f=this.element;f.className=d,f.appendChild(this.toggleButton_),f.appendChild(this.ulElement_),this.renderedAttributions_=[],this.renderedVisible_=!0}collectSourceAttributions_(t){const n=this.getMap().getAllLayers(),s=new Set(n.flatMap(o=>o.getAttributions(t)));if(this.attributions_!==void 0&&(Array.isArray(this.attributions_)?this.attributions_.forEach(o=>s.add(o)):s.add(this.attributions_)),!this.overrideCollapsible_){const o=!n.some(a=>{var h;return((h=a.getSource())==null?void 0:h.getAttributionsCollapsible())===!1});this.setCollapsible(o)}return Array.from(s)}async updateElement_(t){if(!t){this.renderedVisible_&&(this.element.style.display="none",this.renderedVisible_=!1);return}const n=await Promise.all(this.collectSourceAttributions_(t).map(o=>toPromise(()=>o))),s=n.length>0;if(this.renderedVisible_!=s&&(this.element.style.display=s?"":"none",this.renderedVisible_=s),!equals$2(n,this.renderedAttributions_)){removeChildren(this.ulElement_);for(let o=0,a=n.length;o<a;++o){const h=document.createElement("li");h.innerHTML=n[o],this.ulElement_.appendChild(h)}this.renderedAttributions_=n}}handleClick_(t){t.preventDefault(),this.handleToggle_(),this.userCollapsed_=this.collapsed_}handleToggle_(){this.element.classList.toggle(CLASS_COLLAPSED),this.collapsed_?replaceNode(this.collapseLabel_,this.label_):replaceNode(this.label_,this.collapseLabel_),this.collapsed_=!this.collapsed_,this.toggleButton_.setAttribute("aria-expanded",String(!this.collapsed_))}getCollapsible(){return this.collapsible_}setCollapsible(t){this.collapsible_!==t&&(this.collapsible_=t,this.element.classList.toggle("ol-uncollapsible"),this.userCollapsed_&&this.handleToggle_())}setCollapsed(t){this.userCollapsed_=t,!(!this.collapsible_||this.collapsed_===t)&&this.handleToggle_()}getCollapsed(){return this.collapsed_}render(t){this.updateElement_(t.frameState)}}class Rotate extends Control{constructor(t){t=t||{},super({element:document.createElement("div"),render:t.render,target:t.target});const n=t.className!==void 0?t.className:"ol-rotate",s=t.label!==void 0?t.label:"⇧",o=t.compassClassName!==void 0?t.compassClassName:"ol-compass";this.label_=null,typeof s=="string"?(this.label_=document.createElement("span"),this.label_.className=o,this.label_.textContent=s):(this.label_=s,this.label_.classList.add(o));const a=t.tipLabel?t.tipLabel:"Reset rotation",h=document.createElement("button");h.className=n+"-reset",h.setAttribute("type","button"),h.title=a,h.appendChild(this.label_),h.addEventListener(EventType$1.CLICK,this.handleClick_.bind(this),!1);const c=n+" "+CLASS_UNSELECTABLE+" "+CLASS_CONTROL,u=this.element;u.className=c,u.appendChild(h),this.callResetNorth_=t.resetNorth?t.resetNorth:void 0,this.duration_=t.duration!==void 0?t.duration:250,this.autoHide_=t.autoHide!==void 0?t.autoHide:!0,this.rotation_=void 0,this.autoHide_&&this.element.classList.add(CLASS_HIDDEN)}handleClick_(t){t.preventDefault(),this.callResetNorth_!==void 0?this.callResetNorth_():this.resetNorth_()}resetNorth_(){const n=this.getMap().getView();if(!n)return;const s=n.getRotation();s!==void 0&&(this.duration_>0&&s%(2*Math.PI)!==0?n.animate({rotation:0,duration:this.duration_,easing:easeOut}):n.setRotation(0))}render(t){const n=t.frameState;if(!n)return;const s=n.viewState.rotation;if(s!=this.rotation_){const o="rotate("+s+"rad)";if(this.autoHide_){const a=this.element.classList.contains(CLASS_HIDDEN);!a&&s===0?this.element.classList.add(CLASS_HIDDEN):a&&s!==0&&this.element.classList.remove(CLASS_HIDDEN)}this.label_.style.transform=o}this.rotation_=s}}class Zoom extends Control{constructor(t){t=t||{},super({element:document.createElement("div"),target:t.target});const n=t.className!==void 0?t.className:"ol-zoom",s=t.delta!==void 0?t.delta:1,o=t.zoomInClassName!==void 0?t.zoomInClassName:n+"-in",a=t.zoomOutClassName!==void 0?t.zoomOutClassName:n+"-out",h=t.zoomInLabel!==void 0?t.zoomInLabel:"+",c=t.zoomOutLabel!==void 0?t.zoomOutLabel:"–",u=t.zoomInTipLabel!==void 0?t.zoomInTipLabel:"Zoom in",d=t.zoomOutTipLabel!==void 0?t.zoomOutTipLabel:"Zoom out",f=document.createElement("button");f.className=o,f.setAttribute("type","button"),f.title=u,f.appendChild(typeof h=="string"?document.createTextNode(h):h),f.addEventListener(EventType$1.CLICK,this.handleClick_.bind(this,s),!1);const g=document.createElement("button");g.className=a,g.setAttribute("type","button"),g.title=d,g.appendChild(typeof c=="string"?document.createTextNode(c):c),g.addEventListener(EventType$1.CLICK,this.handleClick_.bind(this,-s),!1);const _=n+" "+CLASS_UNSELECTABLE+" "+CLASS_CONTROL,m=this.element;m.className=_,m.appendChild(f),m.appendChild(g),this.duration_=t.duration!==void 0?t.duration:250}handleClick_(t,n){n.preventDefault(),this.zoomByDelta_(t)}zoomByDelta_(t){const s=this.getMap().getView();if(!s)return;const o=s.getZoom();if(o!==void 0){const a=s.getConstrainedZoom(o+t);this.duration_>0?(s.getAnimating()&&s.cancelAnimations(),s.animate({zoom:a,duration:this.duration_,easing:easeOut})):s.setZoom(a)}}}function defaults$1(l){l=l||{};const t=new Collection;return(l.zoom!==void 0?l.zoom:!0)&&t.push(new Zoom(l.zoomOptions)),(l.rotate!==void 0?l.rotate:!0)&&t.push(new Rotate(l.rotateOptions)),(l.attribution!==void 0?l.attribution:!0)&&t.push(new Attribution(l.attributionOptions)),t}class Kinetic{constructor(t,n,s){this.decay_=t,this.minVelocity_=n,this.delay_=s,this.points_=[],this.angle_=0,this.initialVelocity_=0}begin(){this.points_.length=0,this.angle_=0,this.initialVelocity_=0}update(t,n){this.points_.push(t,n,Date.now())}end(){if(this.points_.length<6)return!1;const t=Date.now()-this.delay_,n=this.points_.length-3;if(this.points_[n+2]<t)return!1;let s=n-3;for(;s>0&&this.points_[s+2]>t;)s-=3;const o=this.points_[n+2]-this.points_[s+2];if(o<1e3/60)return!1;const a=this.points_[n]-this.points_[s],h=this.points_[n+1]-this.points_[s+1];return this.angle_=Math.atan2(h,a),this.initialVelocity_=Math.sqrt(a*a+h*h)/o,this.initialVelocity_>this.minVelocity_}getDistance(){return(this.minVelocity_-this.initialVelocity_)/this.decay_}getAngle(){return this.angle_}}const InteractionProperty={ACTIVE:"active"};class Interaction extends BaseObject{constructor(t){super(),this.on,this.once,this.un,t&&t.handleEvent&&(this.handleEvent=t.handleEvent),this.map_=null,this.setActive(!0)}getActive(){return this.get(InteractionProperty.ACTIVE)}getMap(){return this.map_}handleEvent(t){return!0}setActive(t){this.set(InteractionProperty.ACTIVE,t)}setMap(t){this.map_=t}}function pan(l,t,n){const s=l.getCenterInternal();if(s){const o=[s[0]+t[0],s[1]+t[1]];l.animateInternal({duration:n!==void 0?n:250,easing:linear,center:l.getConstrainedCenter(o)})}}function zoomByDelta(l,t,n,s){const o=l.getZoom();if(o===void 0)return;const a=l.getConstrainedZoom(o+t),h=l.getResolutionForZoom(a);l.getAnimating()&&l.cancelAnimations(),l.animate({resolution:h,anchor:n,duration:s!==void 0?s:250,easing:easeOut})}class DoubleClickZoom extends Interaction{constructor(t){super(),t=t||{},this.delta_=t.delta?t.delta:1,this.duration_=t.duration!==void 0?t.duration:250}handleEvent(t){let n=!1;if(t.type==MapBrowserEventType.DBLCLICK){const s=t.originalEvent,o=t.map,a=t.coordinate,h=s.shiftKey?-this.delta_:this.delta_,c=o.getView();zoomByDelta(c,h,a,this.duration_),s.preventDefault(),n=!0}return!n}}function all$1(l){const t=arguments;return function(n){let s=!0;for(let o=0,a=t.length;o<a&&(s=s&&t[o](n),!!s);++o);return s}}const altKeyOnly=function(l){const t=l.originalEvent;return t.altKey&&!(t.metaKey||t.ctrlKey)&&!t.shiftKey},altShiftKeysOnly=function(l){const t=l.originalEvent;return t.altKey&&!(t.metaKey||t.ctrlKey)&&t.shiftKey},focus=function(l){const t=l.map.getTargetElement(),n=t.getRootNode(),s=l.map.getOwnerDocument().activeElement;return n instanceof ShadowRoot?n.host.contains(s):t.contains(s)},focusWithTabindex=function(l){const t=l.map.getTargetElement(),n=t.getRootNode();return(n instanceof ShadowRoot?n.host:t).hasAttribute("tabindex")?focus(l):!0},always$1=TRUE,mouseActionButton=function(l){const t=l.originalEvent;return"pointerId"in t&&t.button==0&&!(WEBKIT&&MAC&&t.ctrlKey)},never=FALSE,singleClick=function(l){return l.type==MapBrowserEventType.SINGLECLICK},noModifierKeys=function(l){const t=l.originalEvent;return!t.altKey&&!(t.metaKey||t.ctrlKey)&&!t.shiftKey},platformModifierKeyOnly=function(l){const t=l.originalEvent;return!t.altKey&&(MAC?t.metaKey:t.ctrlKey)&&!t.shiftKey},platformModifierKey=function(l){const t=l.originalEvent;return MAC?t.metaKey:t.ctrlKey},shiftKeyOnly=function(l){const t=l.originalEvent;return!t.altKey&&!(t.metaKey||t.ctrlKey)&&t.shiftKey},targetNotEditable=function(l){const t=l.originalEvent,n=t.target.tagName;return n!=="INPUT"&&n!=="SELECT"&&n!=="TEXTAREA"&&!t.target.isContentEditable},mouseOnly=function(l){const t=l.originalEvent;return"pointerId"in t&&t.pointerType=="mouse"},primaryAction=function(l){const t=l.originalEvent;return"pointerId"in t&&t.isPrimary&&t.button===0};class PointerInteraction extends Interaction{constructor(t){t=t||{},super(t),t.handleDownEvent&&(this.handleDownEvent=t.handleDownEvent),t.handleDragEvent&&(this.handleDragEvent=t.handleDragEvent),t.handleMoveEvent&&(this.handleMoveEvent=t.handleMoveEvent),t.handleUpEvent&&(this.handleUpEvent=t.handleUpEvent),t.stopDown&&(this.stopDown=t.stopDown),this.handlingDownUpSequence=!1,this.targetPointers=[]}getPointerCount(){return this.targetPointers.length}handleDownEvent(t){return!1}handleDragEvent(t){}handleEvent(t){if(!t.originalEvent)return!0;let n=!1;if(this.updateTrackedPointers_(t),this.handlingDownUpSequence){if(t.type==MapBrowserEventType.POINTERDRAG)this.handleDragEvent(t),t.originalEvent.preventDefault();else if(t.type==MapBrowserEventType.POINTERUP){const s=this.handleUpEvent(t);this.handlingDownUpSequence=s&&this.targetPointers.length>0}}else if(t.type==MapBrowserEventType.POINTERDOWN){const s=this.handleDownEvent(t);this.handlingDownUpSequence=s,n=this.stopDown(s)}else t.type==MapBrowserEventType.POINTERMOVE&&this.handleMoveEvent(t);return!n}handleMoveEvent(t){}handleUpEvent(t){return!1}stopDown(t){return t}updateTrackedPointers_(t){t.activePointers&&(this.targetPointers=t.activePointers)}}function centroid(l){const t=l.length;let n=0,s=0;for(let o=0;o<t;o++)n+=l[o].clientX,s+=l[o].clientY;return{clientX:n/t,clientY:s/t}}class DragPan extends PointerInteraction{constructor(t){super({stopDown:FALSE}),t=t||{},this.kinetic_=t.kinetic,this.lastCentroid=null,this.lastPointersCount_,this.panning_=!1;const n=t.condition?t.condition:all$1(noModifierKeys,primaryAction);this.condition_=t.onFocusOnly?all$1(focusWithTabindex,n):n,this.noKinetic_=!1}handleDragEvent(t){const n=t.map;this.panning_||(this.panning_=!0,n.getView().beginInteraction());const s=this.targetPointers,o=n.getEventPixel(centroid(s));if(s.length==this.lastPointersCount_){if(this.kinetic_&&this.kinetic_.update(o[0],o[1]),this.lastCentroid){const a=[this.lastCentroid[0]-o[0],o[1]-this.lastCentroid[1]],c=t.map.getView();scale$4(a,c.getResolution()),rotate$2(a,c.getRotation()),c.adjustCenterInternal(a)}}else this.kinetic_&&this.kinetic_.begin();this.lastCentroid=o,this.lastPointersCount_=s.length,t.originalEvent.preventDefault()}handleUpEvent(t){const n=t.map,s=n.getView();if(this.targetPointers.length===0){if(!this.noKinetic_&&this.kinetic_&&this.kinetic_.end()){const o=this.kinetic_.getDistance(),a=this.kinetic_.getAngle(),h=s.getCenterInternal(),c=n.getPixelFromCoordinateInternal(h),u=n.getCoordinateFromPixelInternal([c[0]-o*Math.cos(a),c[1]-o*Math.sin(a)]);s.animateInternal({center:s.getConstrainedCenter(u),duration:500,easing:easeOut})}return this.panning_&&(this.panning_=!1,s.endInteraction()),!1}return this.kinetic_&&this.kinetic_.begin(),this.lastCentroid=null,!0}handleDownEvent(t){if(this.targetPointers.length>0&&this.condition_(t)){const s=t.map.getView();return this.lastCentroid=null,s.getAnimating()&&s.cancelAnimations(),this.kinetic_&&this.kinetic_.begin(),this.noKinetic_=this.targetPointers.length>1,!0}return!1}}class DragRotate extends PointerInteraction{constructor(t){t=t||{},super({stopDown:FALSE}),this.condition_=t.condition?t.condition:altShiftKeysOnly,this.lastAngle_=void 0,this.duration_=t.duration!==void 0?t.duration:250}handleDragEvent(t){if(!mouseOnly(t))return;const n=t.map,s=n.getView();if(s.getConstraints().rotation===disable)return;const o=n.getSize(),a=t.pixel,h=Math.atan2(o[1]/2-a[1],a[0]-o[0]/2);if(this.lastAngle_!==void 0){const c=h-this.lastAngle_;s.adjustRotationInternal(-c)}this.lastAngle_=h}handleUpEvent(t){return mouseOnly(t)?(t.map.getView().endInteraction(this.duration_),!1):!0}handleDownEvent(t){return mouseOnly(t)&&mouseActionButton(t)&&this.condition_(t)?(t.map.getView().beginInteraction(),this.lastAngle_=void 0,!0):!1}}class RenderBox extends Disposable{constructor(t){super(),this.geometry_=null,this.element_=document.createElement("div"),this.element_.style.position="absolute",this.element_.style.pointerEvents="auto",this.element_.className="ol-box "+t,this.map_=null,this.startPixel_=null,this.endPixel_=null}disposeInternal(){this.setMap(null)}render_(){const t=this.startPixel_,n=this.endPixel_,s="px",o=this.element_.style;o.left=Math.min(t[0],n[0])+s,o.top=Math.min(t[1],n[1])+s,o.width=Math.abs(n[0]-t[0])+s,o.height=Math.abs(n[1]-t[1])+s}setMap(t){if(this.map_){this.map_.getOverlayContainer().removeChild(this.element_);const n=this.element_.style;n.left="inherit",n.top="inherit",n.width="inherit",n.height="inherit"}this.map_=t,this.map_&&this.map_.getOverlayContainer().appendChild(this.element_)}setPixels(t,n){this.startPixel_=t,this.endPixel_=n,this.createOrUpdateGeometry(),this.render_()}createOrUpdateGeometry(){if(!this.map_)return;const t=this.startPixel_,n=this.endPixel_,o=[t,[t[0],n[1]],n,[n[0],t[1]]].map(this.map_.getCoordinateFromPixelInternal,this.map_);o[4]=o[0].slice(),this.geometry_?this.geometry_.setCoordinates([o]):this.geometry_=new Polygon([o])}getGeometry(){return this.geometry_}}const DragBoxEventType={BOXSTART:"boxstart",BOXDRAG:"boxdrag",BOXEND:"boxend",BOXCANCEL:"boxcancel"};class DragBoxEvent extends BaseEvent{constructor(t,n,s){super(t),this.coordinate=n,this.mapBrowserEvent=s}}class DragBox extends PointerInteraction{constructor(t){super(),this.on,this.once,this.un,t=t??{},this.box_=new RenderBox(t.className||"ol-dragbox"),this.minArea_=t.minArea??64,t.onBoxEnd&&(this.onBoxEnd=t.onBoxEnd),this.startPixel_=null,this.condition_=t.condition??mouseActionButton,this.boxEndCondition_=t.boxEndCondition??this.defaultBoxEndCondition}defaultBoxEndCondition(t,n,s){const o=s[0]-n[0],a=s[1]-n[1];return o*o+a*a>=this.minArea_}getGeometry(){return this.box_.getGeometry()}handleDragEvent(t){this.startPixel_&&(this.box_.setPixels(this.startPixel_,t.pixel),this.dispatchEvent(new DragBoxEvent(DragBoxEventType.BOXDRAG,t.coordinate,t)))}handleUpEvent(t){if(!this.startPixel_)return!1;const n=this.boxEndCondition_(t,this.startPixel_,t.pixel);return n&&this.onBoxEnd(t),this.dispatchEvent(new DragBoxEvent(n?DragBoxEventType.BOXEND:DragBoxEventType.BOXCANCEL,t.coordinate,t)),this.box_.setMap(null),this.startPixel_=null,!1}handleDownEvent(t){return this.condition_(t)?(this.startPixel_=t.pixel,this.box_.setMap(t.map),this.box_.setPixels(this.startPixel_,this.startPixel_),this.dispatchEvent(new DragBoxEvent(DragBoxEventType.BOXSTART,t.coordinate,t)),!0):!1}onBoxEnd(t){}setActive(t){t||(this.box_.setMap(null),this.startPixel_&&(this.dispatchEvent(new DragBoxEvent(DragBoxEventType.BOXCANCEL,this.startPixel_,null)),this.startPixel_=null)),super.setActive(t)}setMap(t){this.getMap()&&(this.box_.setMap(null),this.startPixel_&&(this.dispatchEvent(new DragBoxEvent(DragBoxEventType.BOXCANCEL,this.startPixel_,null)),this.startPixel_=null)),super.setMap(t)}}class DragZoom extends DragBox{constructor(t){t=t||{};const n=t.condition?t.condition:shiftKeyOnly;super({condition:n,className:t.className||"ol-dragzoom",minArea:t.minArea}),this.duration_=t.duration!==void 0?t.duration:200,this.out_=t.out!==void 0?t.out:!1}onBoxEnd(t){const s=this.getMap().getView();let o=this.getGeometry();if(this.out_){const a=s.rotatedExtentForGeometry(o),h=s.getResolutionForExtentInternal(a),c=s.getResolution()/h;o=o.clone(),o.scale(c*c)}s.fitInternal(o,{duration:this.duration_,easing:easeOut})}}const Key={LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",DOWN:"ArrowDown"};class KeyboardPan extends Interaction{constructor(t){super(),t=t||{},this.defaultCondition_=function(n){return noModifierKeys(n)&&targetNotEditable(n)},this.condition_=t.condition!==void 0?t.condition:this.defaultCondition_,this.duration_=t.duration!==void 0?t.duration:100,this.pixelDelta_=t.pixelDelta!==void 0?t.pixelDelta:128}handleEvent(t){let n=!1;if(t.type==EventType$1.KEYDOWN){const s=t.originalEvent,o=s.key;if(this.condition_(t)&&(o==Key.DOWN||o==Key.LEFT||o==Key.RIGHT||o==Key.UP)){const h=t.map.getView(),c=h.getResolution()*this.pixelDelta_;let u=0,d=0;o==Key.DOWN?d=-c:o==Key.LEFT?u=-c:o==Key.RIGHT?u=c:d=c;const f=[u,d];rotate$2(f,h.getRotation()),pan(h,f,this.duration_),s.preventDefault(),n=!0}}return!n}}class KeyboardZoom extends Interaction{constructor(t){super(),t=t||{},this.condition_=t.condition?t.condition:function(n){return!platformModifierKey(n)&&targetNotEditable(n)},this.delta_=t.delta?t.delta:1,this.duration_=t.duration!==void 0?t.duration:100}handleEvent(t){let n=!1;if(t.type==EventType$1.KEYDOWN||t.type==EventType$1.KEYPRESS){const s=t.originalEvent,o=s.key;if(this.condition_(t)&&(o==="+"||o==="-")){const a=t.map,h=o==="+"?this.delta_:-this.delta_,c=a.getView();zoomByDelta(c,h,void 0,this.duration_),s.preventDefault(),n=!0}}return!n}}const DELTA_LINE_MULTIPLIER=40,DELTA_PAGE_MULTIPLIER=300;class MouseWheelZoom extends Interaction{constructor(t){t=t||{},super(t),this.totalDelta_=0,this.lastDelta_=0,this.maxDelta_=t.maxDelta!==void 0?t.maxDelta:1,this.duration_=t.duration!==void 0?t.duration:250,this.timeout_=t.timeout!==void 0?t.timeout:80,this.useAnchor_=t.useAnchor!==void 0?t.useAnchor:!0,this.constrainResolution_=t.constrainResolution!==void 0?t.constrainResolution:!1;const n=t.condition?t.condition:always$1;this.condition_=t.onFocusOnly?all$1(focusWithTabindex,n):n,this.lastAnchor_=null,this.startTime_=void 0,this.timeoutId_,this.mode_=void 0,this.trackpadEventGap_=400,this.trackpadTimeoutId_,this.deltaPerZoom_=300}endInteraction_(){this.trackpadTimeoutId_=void 0;const t=this.getMap();if(!t)return;t.getView().endInteraction(void 0,this.lastDelta_?this.lastDelta_>0?1:-1:0,this.lastAnchor_?t.getCoordinateFromPixel(this.lastAnchor_):null)}handleEvent(t){if(!this.condition_(t)||t.type!==EventType$1.WHEEL)return!0;const s=t.map,o=t.originalEvent;o.preventDefault(),this.useAnchor_&&(this.lastAnchor_=t.pixel);let a=o.deltaY;switch(o.deltaMode){case WheelEvent.DOM_DELTA_LINE:a*=DELTA_LINE_MULTIPLIER;break;case WheelEvent.DOM_DELTA_PAGE:a*=DELTA_PAGE_MULTIPLIER;break}if(a===0)return!1;this.lastDelta_=a;const h=Date.now();this.startTime_===void 0&&(this.startTime_=h),(!this.mode_||h-this.startTime_>this.trackpadEventGap_)&&(this.mode_=Math.abs(a)<4?"trackpad":"wheel");const c=s.getView();if(this.mode_==="trackpad"&&!(c.getConstrainResolution()||this.constrainResolution_))return this.trackpadTimeoutId_?clearTimeout(this.trackpadTimeoutId_):(c.getAnimating()&&c.cancelAnimations(),c.beginInteraction()),this.trackpadTimeoutId_=setTimeout(this.endInteraction_.bind(this),this.timeout_),c.adjustZoom(-a/this.deltaPerZoom_,this.lastAnchor_?s.getCoordinateFromPixel(this.lastAnchor_):null),this.startTime_=h,!1;this.totalDelta_+=a;const u=Math.max(this.timeout_-(h-this.startTime_),0);return clearTimeout(this.timeoutId_),this.timeoutId_=setTimeout(this.handleWheelZoom_.bind(this,s),u),!1}handleWheelZoom_(t){const n=t.getView();n.getAnimating()&&n.cancelAnimations();let s=-clamp(this.totalDelta_,-this.maxDelta_*this.deltaPerZoom_,this.maxDelta_*this.deltaPerZoom_)/this.deltaPerZoom_;(n.getConstrainResolution()||this.constrainResolution_)&&(s=s?s>0?1:-1:0),zoomByDelta(n,s,this.lastAnchor_?t.getCoordinateFromPixel(this.lastAnchor_):null,this.duration_),this.mode_=void 0,this.totalDelta_=0,this.lastAnchor_=null,this.startTime_=void 0,this.timeoutId_=void 0}setMouseAnchor(t){this.useAnchor_=t,t||(this.lastAnchor_=null)}}class PinchRotate extends PointerInteraction{constructor(t){t=t||{};const n=t;n.stopDown||(n.stopDown=FALSE),super(n),this.anchor_=null,this.lastAngle_=void 0,this.rotating_=!1,this.rotationDelta_=0,this.threshold_=t.threshold!==void 0?t.threshold:.3,this.duration_=t.duration!==void 0?t.duration:250}handleDragEvent(t){let n=0;const s=this.targetPointers[0],o=this.targetPointers[1],a=Math.atan2(o.clientY-s.clientY,o.clientX-s.clientX);if(this.lastAngle_!==void 0){const u=a-this.lastAngle_;this.rotationDelta_+=u,!this.rotating_&&Math.abs(this.rotationDelta_)>this.threshold_&&(this.rotating_=!0),n=u}this.lastAngle_=a;const h=t.map,c=h.getView();c.getConstraints().rotation!==disable&&(this.anchor_=h.getCoordinateFromPixelInternal(h.getEventPixel(centroid(this.targetPointers))),this.rotating_&&(h.render(),c.adjustRotationInternal(n,this.anchor_)))}handleUpEvent(t){return this.targetPointers.length<2?(t.map.getView().endInteraction(this.duration_),!1):!0}handleDownEvent(t){if(this.targetPointers.length>=2){const n=t.map;return this.anchor_=null,this.lastAngle_=void 0,this.rotating_=!1,this.rotationDelta_=0,this.handlingDownUpSequence||n.getView().beginInteraction(),!0}return!1}}class PinchZoom extends PointerInteraction{constructor(t){t=t||{};const n=t;n.stopDown||(n.stopDown=FALSE),super(n),this.anchor_=null,this.duration_=t.duration!==void 0?t.duration:400,this.lastDistance_=void 0,this.lastScaleDelta_=1}handleDragEvent(t){let n=1;const s=this.targetPointers[0],o=this.targetPointers[1],a=s.clientX-o.clientX,h=s.clientY-o.clientY,c=Math.sqrt(a*a+h*h);this.lastDistance_!==void 0&&(n=this.lastDistance_/c),this.lastDistance_=c;const u=t.map,d=u.getView();n!=1&&(this.lastScaleDelta_=n),this.anchor_=u.getCoordinateFromPixelInternal(u.getEventPixel(centroid(this.targetPointers))),u.render(),d.adjustResolutionInternal(n,this.anchor_)}handleUpEvent(t){if(this.targetPointers.length<2){const s=t.map.getView(),o=this.lastScaleDelta_>1?1:-1;return s.endInteraction(this.duration_,o),!1}return!0}handleDownEvent(t){if(this.targetPointers.length>=2){const n=t.map;return this.anchor_=null,this.lastDistance_=void 0,this.lastScaleDelta_=1,this.handlingDownUpSequence||n.getView().beginInteraction(),!0}return!1}}function defaults(l){l=l||{};const t=new Collection,n=new Kinetic(-.005,.05,100);return(l.altShiftDragRotate!==void 0?l.altShiftDragRotate:!0)&&t.push(new DragRotate),(l.doubleClickZoom!==void 0?l.doubleClickZoom:!0)&&t.push(new DoubleClickZoom({delta:l.zoomDelta,duration:l.zoomDuration})),(l.dragPan!==void 0?l.dragPan:!0)&&t.push(new DragPan({onFocusOnly:l.onFocusOnly,kinetic:n})),(l.pinchRotate!==void 0?l.pinchRotate:!0)&&t.push(new PinchRotate),(l.pinchZoom!==void 0?l.pinchZoom:!0)&&t.push(new PinchZoom({duration:l.zoomDuration})),(l.keyboard!==void 0?l.keyboard:!0)&&(t.push(new KeyboardPan),t.push(new KeyboardZoom({delta:l.zoomDelta,duration:l.zoomDuration}))),(l.mouseWheelZoom!==void 0?l.mouseWheelZoom:!0)&&t.push(new MouseWheelZoom({onFocusOnly:l.onFocusOnly,duration:l.zoomDuration})),(l.shiftDragZoom!==void 0?l.shiftDragZoom:!0)&&t.push(new DragZoom({duration:l.zoomDuration})),t}const LayerProperty={OPACITY:"opacity",VISIBLE:"visible",EXTENT:"extent",Z_INDEX:"zIndex",MAX_RESOLUTION:"maxResolution",MIN_RESOLUTION:"minResolution",MAX_ZOOM:"maxZoom",MIN_ZOOM:"minZoom",SOURCE:"source",MAP:"map"};class BaseLayer extends BaseObject{constructor(t){super(),this.on,this.once,this.un,this.background_=t.background;const n=Object.assign({},t);typeof t.properties=="object"&&(delete n.properties,Object.assign(n,t.properties)),n[LayerProperty.OPACITY]=t.opacity!==void 0?t.opacity:1,assert(typeof n[LayerProperty.OPACITY]=="number","Layer opacity must be a number"),n[LayerProperty.VISIBLE]=t.visible!==void 0?t.visible:!0,n[LayerProperty.Z_INDEX]=t.zIndex,n[LayerProperty.MAX_RESOLUTION]=t.maxResolution!==void 0?t.maxResolution:1/0,n[LayerProperty.MIN_RESOLUTION]=t.minResolution!==void 0?t.minResolution:0,n[LayerProperty.MIN_ZOOM]=t.minZoom!==void 0?t.minZoom:-1/0,n[LayerProperty.MAX_ZOOM]=t.maxZoom!==void 0?t.maxZoom:1/0,this.className_=n.className!==void 0?n.className:"ol-layer",delete n.className,this.setProperties(n),this.state_=null}getBackground(){return this.background_}getClassName(){return this.className_}getLayerState(t){const n=this.state_||{layer:this,managed:t===void 0?!0:t},s=this.getZIndex();return n.opacity=clamp(Math.round(this.getOpacity()*100)/100,0,1),n.visible=this.getVisible(),n.extent=this.getExtent(),n.zIndex=s===void 0&&!n.managed?1/0:s,n.maxResolution=this.getMaxResolution(),n.minResolution=Math.max(this.getMinResolution(),0),n.minZoom=this.getMinZoom(),n.maxZoom=this.getMaxZoom(),this.state_=n,n}getLayersArray(t){return abstract()}getLayerStatesArray(t){return abstract()}getExtent(){return this.get(LayerProperty.EXTENT)}getMaxResolution(){return this.get(LayerProperty.MAX_RESOLUTION)}getMinResolution(){return this.get(LayerProperty.MIN_RESOLUTION)}getMinZoom(){return this.get(LayerProperty.MIN_ZOOM)}getMaxZoom(){return this.get(LayerProperty.MAX_ZOOM)}getOpacity(){return this.get(LayerProperty.OPACITY)}getSourceState(){return abstract()}getVisible(){return this.get(LayerProperty.VISIBLE)}getZIndex(){return this.get(LayerProperty.Z_INDEX)}setBackground(t){this.background_=t,this.changed()}setExtent(t){this.set(LayerProperty.EXTENT,t)}setMaxResolution(t){this.set(LayerProperty.MAX_RESOLUTION,t)}setMinResolution(t){this.set(LayerProperty.MIN_RESOLUTION,t)}setMaxZoom(t){this.set(LayerProperty.MAX_ZOOM,t)}setMinZoom(t){this.set(LayerProperty.MIN_ZOOM,t)}setOpacity(t){assert(typeof t=="number","Layer opacity must be a number"),this.set(LayerProperty.OPACITY,t)}setVisible(t){this.set(LayerProperty.VISIBLE,t)}setZIndex(t){this.set(LayerProperty.Z_INDEX,t)}disposeInternal(){this.state_&&(this.state_.layer=null,this.state_=null),super.disposeInternal()}}const GroupEventType={ADDLAYER:"addlayer",REMOVELAYER:"removelayer"};class GroupEvent extends BaseEvent{constructor(t,n){super(t),this.layer=n}}const Property$4={LAYERS:"layers"};class LayerGroup extends BaseLayer{constructor(t){t=t||{};const n=Object.assign({},t);delete n.layers;let s=t.layers;super(n),this.on,this.once,this.un,this.layersListenerKeys_=[],this.listenerKeys_={},this.addChangeListener(Property$4.LAYERS,this.handleLayersChanged_),s?Array.isArray(s)?s=new Collection(s.slice(),{unique:!0}):assert(typeof s.getArray=="function","Expected `layers` to be an array or a `Collection`"):s=new Collection(void 0,{unique:!0}),this.setLayers(s)}handleLayerChange_(){this.changed()}handleLayersChanged_(){this.layersListenerKeys_.forEach(unlistenByKey),this.layersListenerKeys_.length=0;const t=this.getLayers();this.layersListenerKeys_.push(listen(t,CollectionEventType.ADD,this.handleLayersAdd_,this),listen(t,CollectionEventType.REMOVE,this.handleLayersRemove_,this));for(const s in this.listenerKeys_)this.listenerKeys_[s].forEach(unlistenByKey);clear(this.listenerKeys_);const n=t.getArray();for(let s=0,o=n.length;s<o;s++){const a=n[s];this.registerLayerListeners_(a),this.dispatchEvent(new GroupEvent(GroupEventType.ADDLAYER,a))}this.changed()}registerLayerListeners_(t){const n=[listen(t,ObjectEventType.PROPERTYCHANGE,this.handleLayerChange_,this),listen(t,EventType$1.CHANGE,this.handleLayerChange_,this)];t instanceof LayerGroup&&n.push(listen(t,GroupEventType.ADDLAYER,this.handleLayerGroupAdd_,this),listen(t,GroupEventType.REMOVELAYER,this.handleLayerGroupRemove_,this)),this.listenerKeys_[getUid(t)]=n}handleLayerGroupAdd_(t){this.dispatchEvent(new GroupEvent(GroupEventType.ADDLAYER,t.layer))}handleLayerGroupRemove_(t){this.dispatchEvent(new GroupEvent(GroupEventType.REMOVELAYER,t.layer))}handleLayersAdd_(t){const n=t.element;this.registerLayerListeners_(n),this.dispatchEvent(new GroupEvent(GroupEventType.ADDLAYER,n)),this.changed()}handleLayersRemove_(t){const n=t.element,s=getUid(n);this.listenerKeys_[s].forEach(unlistenByKey),delete this.listenerKeys_[s],this.dispatchEvent(new GroupEvent(GroupEventType.REMOVELAYER,n)),this.changed()}getLayers(){return this.get(Property$4.LAYERS)}setLayers(t){const n=this.getLayers();if(n){const s=n.getArray();for(let o=0,a=s.length;o<a;++o)this.dispatchEvent(new GroupEvent(GroupEventType.REMOVELAYER,s[o]))}this.set(Property$4.LAYERS,t)}getLayersArray(t){return t=t!==void 0?t:[],this.getLayers().forEach(function(n){n.getLayersArray(t)}),t}getLayerStatesArray(t){const n=t!==void 0?t:[],s=n.length;this.getLayers().forEach(function(h){h.getLayerStatesArray(n)});const o=this.getLayerState();let a=o.zIndex;!t&&o.zIndex===void 0&&(a=0);for(let h=s,c=n.length;h<c;h++){const u=n[h];u.opacity*=o.opacity,u.visible=u.visible&&o.visible,u.maxResolution=Math.min(u.maxResolution,o.maxResolution),u.minResolution=Math.max(u.minResolution,o.minResolution),u.minZoom=Math.max(u.minZoom,o.minZoom),u.maxZoom=Math.min(u.maxZoom,o.maxZoom),o.extent!==void 0&&(u.extent!==void 0?u.extent=getIntersection(u.extent,o.extent):u.extent=o.extent),u.zIndex===void 0&&(u.zIndex=a)}return n}getSourceState(){return"ready"}}const RenderEventType={PRERENDER:"prerender",POSTRENDER:"postrender",PRECOMPOSE:"precompose",POSTCOMPOSE:"postcompose",RENDERCOMPLETE:"rendercomplete"};class Layer extends BaseLayer{constructor(t){const n=Object.assign({},t);delete n.source,super(n),this.on,this.once,this.un,this.mapPrecomposeKey_=null,this.mapRenderKey_=null,this.sourceChangeKey_=null,this.renderer_=null,this.sourceReady_=!1,this.rendered=!1,t.render&&(this.render=t.render),t.map&&this.setMap(t.map),this.addChangeListener(LayerProperty.SOURCE,this.handleSourcePropertyChange_);const s=t.source?t.source:null;this.setSource(s)}getLayersArray(t){return t=t||[],t.push(this),t}getLayerStatesArray(t){return t=t||[],t.push(this.getLayerState()),t}getSource(){return this.get(LayerProperty.SOURCE)||null}getRenderSource(){return this.getSource()}getSourceState(){const t=this.getSource();return t?t.getState():"undefined"}handleSourceChange_(){this.changed(),!(this.sourceReady_||this.getSource().getState()!=="ready")&&(this.sourceReady_=!0,this.dispatchEvent("sourceready"))}handleSourcePropertyChange_(){this.sourceChangeKey_&&(unlistenByKey(this.sourceChangeKey_),this.sourceChangeKey_=null),this.sourceReady_=!1;const t=this.getSource();t&&(this.sourceChangeKey_=listen(t,EventType$1.CHANGE,this.handleSourceChange_,this),t.getState()==="ready"&&(this.sourceReady_=!0,setTimeout(()=>{this.dispatchEvent("sourceready")},0))),this.changed()}getFeatures(t){return this.renderer_?this.renderer_.getFeatures(t):Promise.resolve([])}getData(t){return!this.renderer_||!this.rendered?null:this.renderer_.getData(t)}isVisible(t){let n;const s=this.getMapInternal();!t&&s&&(t=s.getView()),t instanceof View?n={viewState:t.getState(),extent:t.calculateExtent()}:n=t,!n.layerStatesArray&&s&&(n.layerStatesArray=s.getLayerGroup().getLayerStatesArray());let o;if(n.layerStatesArray){if(o=n.layerStatesArray.find(h=>h.layer===this),!o)return!1}else o=this.getLayerState();const a=this.getExtent();return inView(o,n.viewState)&&(!a||intersects$1(a,n.extent))}getAttributions(t){var a;if(!this.isVisible(t))return[];const n=(a=this.getSource())==null?void 0:a.getAttributions();if(!n)return[];const s=t instanceof View?t.getViewStateAndExtent():t;let o=n(s);return Array.isArray(o)||(o=[o]),o}render(t,n){const s=this.getRenderer();return s.prepareFrame(t)?(this.rendered=!0,s.renderFrame(t,n)):null}unrender(){this.rendered=!1}getDeclutter(){}renderDeclutter(t,n){}renderDeferred(t){const n=this.getRenderer();n&&n.renderDeferred(t)}setMapInternal(t){t||this.unrender(),this.set(LayerProperty.MAP,t)}getMapInternal(){return this.get(LayerProperty.MAP)}setMap(t){this.mapPrecomposeKey_&&(unlistenByKey(this.mapPrecomposeKey_),this.mapPrecomposeKey_=null),t||this.changed(),this.mapRenderKey_&&(unlistenByKey(this.mapRenderKey_),this.mapRenderKey_=null),t&&(this.mapPrecomposeKey_=listen(t,RenderEventType.PRECOMPOSE,this.handlePrecompose_,this),this.mapRenderKey_=listen(this,EventType$1.CHANGE,t.render,t),this.changed())}handlePrecompose_(t){const n=t.frameState.layerStatesArray,s=this.getLayerState(!1);assert(!n.some(o=>o.layer===s.layer),"A layer can only be added to the map once. Use either `layer.setMap()` or `map.addLayer()`, not both."),n.push(s)}setSource(t){this.set(LayerProperty.SOURCE,t)}getRenderer(){return this.renderer_||(this.renderer_=this.createRenderer()),this.renderer_}hasRenderer(){return!!this.renderer_}createRenderer(){return null}clearRenderer(){this.renderer_&&(this.renderer_.dispose(),delete this.renderer_)}disposeInternal(){this.clearRenderer(),this.setSource(null),super.disposeInternal()}}function inView(l,t){if(!l.visible)return!1;const n=t.resolution;if(n<l.minResolution||n>=l.maxResolution)return!1;const s=t.zoom;return s>l.minZoom&&s<=l.maxZoom}let RBush$1=class{constructor(t=9){this._maxEntries=Math.max(4,t),this._minEntries=Math.max(2,Math.ceil(this._maxEntries*.4)),this.clear()}all(){return this._all(this.data,[])}search(t){let n=this.data;const s=[];if(!intersects(t,n))return s;const o=this.toBBox,a=[];for(;n;){for(let h=0;h<n.children.length;h++){const c=n.children[h],u=n.leaf?o(c):c;intersects(t,u)&&(n.leaf?s.push(c):contains(t,u)?this._all(c,s):a.push(c))}n=a.pop()}return s}collides(t){let n=this.data;if(!intersects(t,n))return!1;const s=[];for(;n;){for(let o=0;o<n.children.length;o++){const a=n.children[o],h=n.leaf?this.toBBox(a):a;if(intersects(t,h)){if(n.leaf||contains(t,h))return!0;s.push(a)}}n=s.pop()}return!1}load(t){if(!(t&&t.length))return this;if(t.length<this._minEntries){for(let s=0;s<t.length;s++)this.insert(t[s]);return this}let n=this._build(t.slice(),0,t.length-1,0);if(!this.data.children.length)this.data=n;else if(this.data.height===n.height)this._splitRoot(this.data,n);else{if(this.data.height<n.height){const s=this.data;this.data=n,n=s}this._insert(n,this.data.height-n.height-1,!0)}return this}insert(t){return t&&this._insert(t,this.data.height-1),this}clear(){return this.data=createNode([]),this}remove(t,n){if(!t)return this;let s=this.data;const o=this.toBBox(t),a=[],h=[];let c,u,d;for(;s||a.length;){if(s||(s=a.pop(),u=a[a.length-1],c=h.pop(),d=!0),s.leaf){const f=findItem(t,s.children,n);if(f!==-1)return s.children.splice(f,1),a.push(s),this._condense(a),this}!d&&!s.leaf&&contains(s,o)?(a.push(s),h.push(c),c=0,u=s,s=s.children[0]):u?(c++,s=u.children[c],d=!1):s=null}return this}toBBox(t){return t}compareMinX(t,n){return t.minX-n.minX}compareMinY(t,n){return t.minY-n.minY}toJSON(){return this.data}fromJSON(t){return this.data=t,this}_all(t,n){const s=[];for(;t;)t.leaf?n.push(...t.children):s.push(...t.children),t=s.pop();return n}_build(t,n,s,o){const a=s-n+1;let h=this._maxEntries,c;if(a<=h)return c=createNode(t.slice(n,s+1)),calcBBox(c,this.toBBox),c;o||(o=Math.ceil(Math.log(a)/Math.log(h)),h=Math.ceil(a/Math.pow(h,o-1))),c=createNode([]),c.leaf=!1,c.height=o;const u=Math.ceil(a/h),d=u*Math.ceil(Math.sqrt(h));multiSelect(t,n,s,d,this.compareMinX);for(let f=n;f<=s;f+=d){const g=Math.min(f+d-1,s);multiSelect(t,f,g,u,this.compareMinY);for(let _=f;_<=g;_+=u){const m=Math.min(_+u-1,g);c.children.push(this._build(t,_,m,o-1))}}return calcBBox(c,this.toBBox),c}_chooseSubtree(t,n,s,o){for(;o.push(n),!(n.leaf||o.length-1===s);){let a=1/0,h=1/0,c;for(let u=0;u<n.children.length;u++){const d=n.children[u],f=bboxArea(d),g=enlargedArea(t,d)-f;g<h?(h=g,a=f<a?f:a,c=d):g===h&&f<a&&(a=f,c=d)}n=c||n.children[0]}return n}_insert(t,n,s){const o=s?t:this.toBBox(t),a=[],h=this._chooseSubtree(o,this.data,n,a);for(h.children.push(t),extend(h,o);n>=0&&a[n].children.length>this._maxEntries;)this._split(a,n),n--;this._adjustParentBBoxes(o,a,n)}_split(t,n){const s=t[n],o=s.children.length,a=this._minEntries;this._chooseSplitAxis(s,a,o);const h=this._chooseSplitIndex(s,a,o),c=createNode(s.children.splice(h,s.children.length-h));c.height=s.height,c.leaf=s.leaf,calcBBox(s,this.toBBox),calcBBox(c,this.toBBox),n?t[n-1].children.push(c):this._splitRoot(s,c)}_splitRoot(t,n){this.data=createNode([t,n]),this.data.height=t.height+1,this.data.leaf=!1,calcBBox(this.data,this.toBBox)}_chooseSplitIndex(t,n,s){let o,a=1/0,h=1/0;for(let c=n;c<=s-n;c++){const u=distBBox(t,0,c,this.toBBox),d=distBBox(t,c,s,this.toBBox),f=intersectionArea(u,d),g=bboxArea(u)+bboxArea(d);f<a?(a=f,o=c,h=g<h?g:h):f===a&&g<h&&(h=g,o=c)}return o||s-n}_chooseSplitAxis(t,n,s){const o=t.leaf?this.compareMinX:compareNodeMinX,a=t.leaf?this.compareMinY:compareNodeMinY,h=this._allDistMargin(t,n,s,o),c=this._allDistMargin(t,n,s,a);h<c&&t.children.sort(o)}_allDistMargin(t,n,s,o){t.children.sort(o);const a=this.toBBox,h=distBBox(t,0,n,a),c=distBBox(t,s-n,s,a);let u=bboxMargin(h)+bboxMargin(c);for(let d=n;d<s-n;d++){const f=t.children[d];extend(h,t.leaf?a(f):f),u+=bboxMargin(h)}for(let d=s-n-1;d>=n;d--){const f=t.children[d];extend(c,t.leaf?a(f):f),u+=bboxMargin(c)}return u}_adjustParentBBoxes(t,n,s){for(let o=s;o>=0;o--)extend(n[o],t)}_condense(t){for(let n=t.length-1,s;n>=0;n--)t[n].children.length===0?n>0?(s=t[n-1].children,s.splice(s.indexOf(t[n]),1)):this.clear():calcBBox(t[n],this.toBBox)}};function findItem(l,t,n){if(!n)return t.indexOf(l);for(let s=0;s<t.length;s++)if(n(l,t[s]))return s;return-1}function calcBBox(l,t){distBBox(l,0,l.children.length,t,l)}function distBBox(l,t,n,s,o){o||(o=createNode(null)),o.minX=1/0,o.minY=1/0,o.maxX=-1/0,o.maxY=-1/0;for(let a=t;a<n;a++){const h=l.children[a];extend(o,l.leaf?s(h):h)}return o}function extend(l,t){return l.minX=Math.min(l.minX,t.minX),l.minY=Math.min(l.minY,t.minY),l.maxX=Math.max(l.maxX,t.maxX),l.maxY=Math.max(l.maxY,t.maxY),l}function compareNodeMinX(l,t){return l.minX-t.minX}function compareNodeMinY(l,t){return l.minY-t.minY}function bboxArea(l){return(l.maxX-l.minX)*(l.maxY-l.minY)}function bboxMargin(l){return l.maxX-l.minX+(l.maxY-l.minY)}function enlargedArea(l,t){return(Math.max(t.maxX,l.maxX)-Math.min(t.minX,l.minX))*(Math.max(t.maxY,l.maxY)-Math.min(t.minY,l.minY))}function intersectionArea(l,t){const n=Math.max(l.minX,t.minX),s=Math.max(l.minY,t.minY),o=Math.min(l.maxX,t.maxX),a=Math.min(l.maxY,t.maxY);return Math.max(0,o-n)*Math.max(0,a-s)}function contains(l,t){return l.minX<=t.minX&&l.minY<=t.minY&&t.maxX<=l.maxX&&t.maxY<=l.maxY}function intersects(l,t){return t.minX<=l.maxX&&t.minY<=l.maxY&&t.maxX>=l.minX&&t.maxY>=l.minY}function createNode(l){return{children:l,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function multiSelect(l,t,n,s,o){const a=[t,n];for(;a.length;){if(n=a.pop(),t=a.pop(),n-t<=s)continue;const h=t+Math.ceil((n-t)/s/2)*s;quickselect(l,h,t,n,o),a.push(t,h,h,n)}}const NO_COLOR=[NaN,NaN,NaN,0];let colorParseContext;function getColorParseContext(){return colorParseContext||(colorParseContext=createCanvasContext2D(1,1,void 0,{willReadFrequently:!0,desynchronized:!0})),colorParseContext}const rgbModernRegEx=/^rgba?\(\s*(\d+%?)\s+(\d+%?)\s+(\d+%?)(?:\s*\/\s*(\d+%|\d*\.\d+|[01]))?\s*\)$/i,rgbLegacyAbsoluteRegEx=/^rgba?\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)(?:\s*,\s*(\d+%|\d*\.\d+|[01]))?\s*\)$/i,rgbLegacyPercentageRegEx=/^rgba?\(\s*(\d+%)\s*,\s*(\d+%)\s*,\s*(\d+%)(?:\s*,\s*(\d+%|\d*\.\d+|[01]))?\s*\)$/i,hexRegEx=/^#([\da-f]{3,4}|[\da-f]{6}|[\da-f]{8})$/i;function toColorComponent(l,t){return l.endsWith("%")?Number(l.substring(0,l.length-1))/t:Number(l)}function throwInvalidColor(l){throw new Error('failed to parse "'+l+'" as color')}function parseRgba(l){if(l.toLowerCase().startsWith("rgb")){const a=l.match(rgbLegacyAbsoluteRegEx)||l.match(rgbModernRegEx)||l.match(rgbLegacyPercentageRegEx);if(a){const h=a[4],c=100/255;return[clamp(toColorComponent(a[1],c)+.5|0,0,255),clamp(toColorComponent(a[2],c)+.5|0,0,255),clamp(toColorComponent(a[3],c)+.5|0,0,255),h!==void 0?clamp(toColorComponent(h,100),0,1):1]}throwInvalidColor(l)}if(l.startsWith("#")){if(hexRegEx.test(l)){const a=l.substring(1),h=a.length<=4?1:2,c=[0,0,0,255];for(let u=0,d=a.length;u<d;u+=h){let f=parseInt(a.substring(u,u+h),16);h===1&&(f+=f<<4),c[u/h]=f}return c[3]=c[3]/255,c}throwInvalidColor(l)}const t=getColorParseContext();t.fillStyle="#abcdef";let n=t.fillStyle;t.fillStyle=l,t.fillStyle===n&&(t.fillStyle="#fedcba",n=t.fillStyle,t.fillStyle=l,t.fillStyle===n&&throwInvalidColor(l));const s=t.fillStyle;if(s.startsWith("#")||s.startsWith("rgba"))return parseRgba(s);t.clearRect(0,0,1,1),t.fillRect(0,0,1,1);const o=Array.from(t.getImageData(0,0,1,1).data);return o[3]=toFixed(o[3]/255,3),o}function asString(l){return typeof l=="string"?l:toString(l)}const MAX_CACHE_SIZE=1024,cache={};let cacheSize=0;function withAlpha(l){if(l.length===4)return l;const t=l.slice();return t[3]=1,t}function b1(l){return l>.0031308?Math.pow(l,1/2.4)*269.025-14.025:l*3294.6}function b2(l){return l>.2068965?Math.pow(l,3):(l-4/29)*(108/841)}function a1(l){return l>10.314724?Math.pow((l+14.025)/269.025,2.4):l/3294.6}function a2(l){return l>.0088564?Math.pow(l,1/3):l/(108/841)+4/29}function rgbaToLcha(l){const t=a1(l[0]),n=a1(l[1]),s=a1(l[2]),o=a2(t*.222488403+n*.716873169+s*.06060791),a=500*(a2(t*.452247074+n*.399439023+s*.148375274)-o),h=200*(o-a2(t*.016863605+n*.117638439+s*.865350722)),c=Math.atan2(h,a)*(180/Math.PI);return[116*o-16,Math.sqrt(a*a+h*h),c<0?c+360:c,l[3]]}function lchaToRgba(l){const t=(l[0]+16)/116,n=l[1],s=l[2]*Math.PI/180,o=b2(t),a=b2(t+n/500*Math.cos(s)),h=b2(t-n/200*Math.sin(s)),c=b1(a*3.021973625-o*1.617392459-h*.404875592),u=b1(a*-.943766287+o*1.916279586+h*.027607165),d=b1(a*.069407491-o*.22898585+h*1.159737864);return[clamp(c+.5|0,0,255),clamp(u+.5|0,0,255),clamp(d+.5|0,0,255),l[3]]}function fromString(l){if(l==="none")return NO_COLOR;if(cache.hasOwnProperty(l))return cache[l];if(cacheSize>=MAX_CACHE_SIZE){let n=0;for(const s in cache)n++&3||(delete cache[s],--cacheSize)}const t=parseRgba(l);t.length!==4&&throwInvalidColor(l);for(const n of t)isNaN(n)&&throwInvalidColor(l);return cache[l]=t,++cacheSize,t}function asArray(l){return Array.isArray(l)?l:fromString(l)}function toString(l){let t=l[0];t!=(t|0)&&(t=t+.5|0);let n=l[1];n!=(n|0)&&(n=n+.5|0);let s=l[2];s!=(s|0)&&(s=s+.5|0);const o=l[3]===void 0?1:Math.round(l[3]*1e3)/1e3;return"rgba("+t+","+n+","+s+","+o+")"}function hasArea(l){return l[0]>0&&l[1]>0}function scale$1(l,t,n){return n===void 0&&(n=[0,0]),n[0]=l[0]*t+.5|0,n[1]=l[1]*t+.5|0,n}function toSize(l,t){return Array.isArray(l)?l:(t===void 0?t=[l,l]:(t[0]=l,t[1]=l),t)}let numTypes=0;const BooleanType=1<<numTypes++,NumberType=1<<numTypes++,StringType=1<<numTypes++,ColorType=1<<numTypes++,NumberArrayType=1<<numTypes++,SizeType=1<<numTypes++,AnyType=Math.pow(2,numTypes)-1,typeNames={[BooleanType]:"boolean",[NumberType]:"number",[StringType]:"string",[ColorType]:"color",[NumberArrayType]:"number[]",[SizeType]:"size"},namedTypes=Object.keys(typeNames).map(Number).sort(ascending);function isSpecific(l){return l in typeNames}function typeName(l){const t=[];for(const n of namedTypes)includesType(l,n)&&t.push(typeNames[n]);return t.length===0?"untyped":t.length<3?t.join(" or "):t.slice(0,-1).join(", ")+", or "+t[t.length-1]}function includesType(l,t){return(l&t)===t}function isType(l,t){return l===t}class LiteralExpression{constructor(t,n){if(!isSpecific(t))throw new Error(`literal expressions must have a specific type, got ${typeName(t)}`);this.type=t,this.value=n}}class CallExpression{constructor(t,n,...s){this.type=t,this.operator=n,this.args=s}}function newParsingContext(){return{variables:new Set,properties:new Set,featureId:!1,geometryType:!1,mapState:!1}}function parse$1(l,t,n){switch(typeof l){case"boolean":{if(isType(t,StringType))return new LiteralExpression(StringType,l?"true":"false");if(!includesType(t,BooleanType))throw new Error(`got a boolean, but expected ${typeName(t)}`);return new LiteralExpression(BooleanType,l)}case"number":{if(isType(t,SizeType))return new LiteralExpression(SizeType,toSize(l));if(isType(t,BooleanType))return new LiteralExpression(BooleanType,!!l);if(isType(t,StringType))return new LiteralExpression(StringType,l.toString());if(!includesType(t,NumberType))throw new Error(`got a number, but expected ${typeName(t)}`);return new LiteralExpression(NumberType,l)}case"string":{if(isType(t,ColorType))return new LiteralExpression(ColorType,fromString(l));if(isType(t,BooleanType))return new LiteralExpression(BooleanType,!!l);if(!includesType(t,StringType))throw new Error(`got a string, but expected ${typeName(t)}`);return new LiteralExpression(StringType,l)}}if(!Array.isArray(l))throw new Error("expression must be an array or a primitive value");if(l.length===0)throw new Error("empty expression");if(typeof l[0]=="string")return parseCallExpression(l,t,n);for(const s of l)if(typeof s!="number")throw new Error("expected an array of numbers");if(isType(t,SizeType)){if(l.length!==2)throw new Error(`expected an array of two values for a size, got ${l.length}`);return new LiteralExpression(SizeType,l)}if(isType(t,ColorType)){if(l.length===3)return new LiteralExpression(ColorType,[...l,1]);if(l.length===4)return new LiteralExpression(ColorType,l);throw new Error(`expected an array of 3 or 4 values for a color, got ${l.length}`)}if(!includesType(t,NumberArrayType))throw new Error(`got an array of numbers, but expected ${typeName(t)}`);return new LiteralExpression(NumberArrayType,l)}const Ops={Get:"get",Var:"var",Concat:"concat",GeometryType:"geometry-type",LineMetric:"line-metric",Any:"any",All:"all",Not:"!",Resolution:"resolution",Zoom:"zoom",Time:"time",Equal:"==",NotEqual:"!=",GreaterThan:">",GreaterThanOrEqualTo:">=",LessThan:"<",LessThanOrEqualTo:"<=",Multiply:"*",Divide:"/",Add:"+",Subtract:"-",Clamp:"clamp",Mod:"%",Pow:"^",Abs:"abs",Floor:"floor",Ceil:"ceil",Round:"round",Sin:"sin",Cos:"cos",Atan:"atan",Sqrt:"sqrt",Match:"match",Between:"between",Interpolate:"interpolate",Coalesce:"coalesce",Case:"case",In:"in",Number:"number",String:"string",Array:"array",Color:"color",Id:"id",Band:"band",Palette:"palette",ToString:"to-string",Has:"has"},parsers={[Ops.Get]:createCallExpressionParser(hasArgsCount(1,1/0),withGetArgs),[Ops.Var]:createCallExpressionParser(hasArgsCount(1,1),withVarArgs),[Ops.Has]:createCallExpressionParser(hasArgsCount(1,1/0),withGetArgs),[Ops.Id]:createCallExpressionParser(usesFeatureId,withNoArgs),[Ops.Concat]:createCallExpressionParser(hasArgsCount(2,1/0),withArgsOfType(StringType)),[Ops.GeometryType]:createCallExpressionParser(usesGeometryType,withNoArgs),[Ops.LineMetric]:createCallExpressionParser(withNoArgs),[Ops.Resolution]:createCallExpressionParser(usesMapState,withNoArgs),[Ops.Zoom]:createCallExpressionParser(usesMapState,withNoArgs),[Ops.Time]:createCallExpressionParser(usesMapState,withNoArgs),[Ops.Any]:createCallExpressionParser(hasArgsCount(2,1/0),withArgsOfType(BooleanType)),[Ops.All]:createCallExpressionParser(hasArgsCount(2,1/0),withArgsOfType(BooleanType)),[Ops.Not]:createCallExpressionParser(hasArgsCount(1,1),withArgsOfType(BooleanType)),[Ops.Equal]:createCallExpressionParser(hasArgsCount(2,2),withArgsOfType(AnyType)),[Ops.NotEqual]:createCallExpressionParser(hasArgsCount(2,2),withArgsOfType(AnyType)),[Ops.GreaterThan]:createCallExpressionParser(hasArgsCount(2,2),withArgsOfType(NumberType)),[Ops.GreaterThanOrEqualTo]:createCallExpressionParser(hasArgsCount(2,2),withArgsOfType(NumberType)),[Ops.LessThan]:createCallExpressionParser(hasArgsCount(2,2),withArgsOfType(NumberType)),[Ops.LessThanOrEqualTo]:createCallExpressionParser(hasArgsCount(2,2),withArgsOfType(NumberType)),[Ops.Multiply]:createCallExpressionParser(hasArgsCount(2,1/0),withArgsOfReturnType),[Ops.Coalesce]:createCallExpressionParser(hasArgsCount(2,1/0),withArgsOfReturnType),[Ops.Divide]:createCallExpressionParser(hasArgsCount(2,2),withArgsOfType(NumberType)),[Ops.Add]:createCallExpressionParser(hasArgsCount(2,1/0),withArgsOfType(NumberType)),[Ops.Subtract]:createCallExpressionParser(hasArgsCount(2,2),withArgsOfType(NumberType)),[Ops.Clamp]:createCallExpressionParser(hasArgsCount(3,3),withArgsOfType(NumberType)),[Ops.Mod]:createCallExpressionParser(hasArgsCount(2,2),withArgsOfType(NumberType)),[Ops.Pow]:createCallExpressionParser(hasArgsCount(2,2),withArgsOfType(NumberType)),[Ops.Abs]:createCallExpressionParser(hasArgsCount(1,1),withArgsOfType(NumberType)),[Ops.Floor]:createCallExpressionParser(hasArgsCount(1,1),withArgsOfType(NumberType)),[Ops.Ceil]:createCallExpressionParser(hasArgsCount(1,1),withArgsOfType(NumberType)),[Ops.Round]:createCallExpressionParser(hasArgsCount(1,1),withArgsOfType(NumberType)),[Ops.Sin]:createCallExpressionParser(hasArgsCount(1,1),withArgsOfType(NumberType)),[Ops.Cos]:createCallExpressionParser(hasArgsCount(1,1),withArgsOfType(NumberType)),[Ops.Atan]:createCallExpressionParser(hasArgsCount(1,2),withArgsOfType(NumberType)),[Ops.Sqrt]:createCallExpressionParser(hasArgsCount(1,1),withArgsOfType(NumberType)),[Ops.Match]:createCallExpressionParser(hasArgsCount(4,1/0),hasEvenArgs,withMatchArgs),[Ops.Between]:createCallExpressionParser(hasArgsCount(3,3),withArgsOfType(NumberType)),[Ops.Interpolate]:createCallExpressionParser(hasArgsCount(6,1/0),hasEvenArgs,withInterpolateArgs),[Ops.Case]:createCallExpressionParser(hasArgsCount(3,1/0),hasOddArgs,withCaseArgs),[Ops.In]:createCallExpressionParser(hasArgsCount(2,2),withInArgs),[Ops.Number]:createCallExpressionParser(hasArgsCount(1,1/0),withArgsOfType(AnyType)),[Ops.String]:createCallExpressionParser(hasArgsCount(1,1/0),withArgsOfType(AnyType)),[Ops.Array]:createCallExpressionParser(hasArgsCount(1,1/0),withArgsOfType(NumberType)),[Ops.Color]:createCallExpressionParser(hasArgsCount(1,4),withArgsOfType(NumberType)),[Ops.Band]:createCallExpressionParser(hasArgsCount(1,3),withArgsOfType(NumberType)),[Ops.Palette]:createCallExpressionParser(hasArgsCount(2,2),withPaletteArgs),[Ops.ToString]:createCallExpressionParser(hasArgsCount(1,1),withArgsOfType(BooleanType|NumberType|StringType|ColorType))};function withGetArgs(l,t,n){const s=l.length-1,o=new Array(s);for(let a=0;a<s;++a){const h=l[a+1];switch(typeof h){case"number":{o[a]=new LiteralExpression(NumberType,h);break}case"string":{o[a]=new LiteralExpression(StringType,h);break}default:throw new Error(`expected a string key or numeric array index for a get operation, got ${h}`)}a===0&&n.properties.add(String(h))}return o}function withVarArgs(l,t,n){const s=l[1];if(typeof s!="string")throw new Error("expected a string argument for var operation");return n.variables.add(s),[new LiteralExpression(StringType,s)]}function usesFeatureId(l,t,n){n.featureId=!0}function usesGeometryType(l,t,n){n.geometryType=!0}function usesMapState(l,t,n){n.mapState=!0}function withNoArgs(l,t,n){const s=l[0];if(l.length!==1)throw new Error(`expected no arguments for ${s} operation`);return[]}function hasArgsCount(l,t){return function(n,s,o){const a=n[0],h=n.length-1;if(l===t){if(h!==l){const c=l===1?"":"s";throw new Error(`expected ${l} argument${c} for ${a}, got ${h}`)}}else if(h<l||h>t){const c=t===1/0?`${l} or more`:`${l} to ${t}`;throw new Error(`expected ${c} arguments for ${a}, got ${h}`)}}}function withArgsOfReturnType(l,t,n){const s=l.length-1,o=new Array(s);for(let a=0;a<s;++a){const h=parse$1(l[a+1],t,n);o[a]=h}return o}function withArgsOfType(l){return function(t,n,s){const o=t.length-1,a=new Array(o);for(let h=0;h<o;++h){const c=parse$1(t[h+1],l,s);a[h]=c}return a}}function hasOddArgs(l,t,n){const s=l[0],o=l.length-1;if(o%2===0)throw new Error(`expected an odd number of arguments for ${s}, got ${o} instead`)}function hasEvenArgs(l,t,n){const s=l[0],o=l.length-1;if(o%2===1)throw new Error(`expected an even number of arguments for operation ${s}, got ${o} instead`)}function withMatchArgs(l,t,n){const s=l.length-1,o=StringType|NumberType|BooleanType,a=parse$1(l[1],o,n),h=parse$1(l[l.length-1],t,n),c=new Array(s-2);for(let u=0;u<s-2;u+=2){try{const d=parse$1(l[u+2],a.type,n);c[u]=d}catch(d){throw new Error(`failed to parse argument ${u+1} of match expression: ${d.message}`)}try{const d=parse$1(l[u+3],h.type,n);c[u+1]=d}catch(d){throw new Error(`failed to parse argument ${u+2} of match expression: ${d.message}`)}}return[a,...c,h]}function withInterpolateArgs(l,t,n){const s=l[1];let o;switch(s[0]){case"linear":o=1;break;case"exponential":const u=s[1];if(typeof u!="number"||u<=0)throw new Error(`expected a number base for exponential interpolation, got ${JSON.stringify(u)} instead`);o=u;break;default:throw new Error(`invalid interpolation type: ${JSON.stringify(s)}`)}const a=new LiteralExpression(NumberType,o);let h;try{h=parse$1(l[2],NumberType,n)}catch(u){throw new Error(`failed to parse argument 1 in interpolate expression: ${u.message}`)}const c=new Array(l.length-3);for(let u=0;u<c.length;u+=2){try{const d=parse$1(l[u+3],NumberType,n);c[u]=d}catch(d){throw new Error(`failed to parse argument ${u+2} for interpolate expression: ${d.message}`)}try{const d=parse$1(l[u+4],t,n);c[u+1]=d}catch(d){throw new Error(`failed to parse argument ${u+3} for interpolate expression: ${d.message}`)}}return[a,h,...c]}function withCaseArgs(l,t,n){const s=parse$1(l[l.length-1],t,n),o=new Array(l.length-1);for(let a=0;a<o.length-1;a+=2){try{const h=parse$1(l[a+1],BooleanType,n);o[a]=h}catch(h){throw new Error(`failed to parse argument ${a} of case expression: ${h.message}`)}try{const h=parse$1(l[a+2],s.type,n);o[a+1]=h}catch(h){throw new Error(`failed to parse argument ${a+1} of case expression: ${h.message}`)}}return o[o.length-1]=s,o}function withInArgs(l,t,n){let s=l[2];if(!Array.isArray(s))throw new Error('the second argument for the "in" operator must be an array');let o;if(typeof s[0]=="string"){if(s[0]!=="literal")throw new Error('for the "in" operator, a string array should be wrapped in a "literal" operator to disambiguate from expressions');if(!Array.isArray(s[1]))throw new Error('failed to parse "in" expression: the literal operator must be followed by an array');s=s[1],o=StringType}else o=NumberType;const a=new Array(s.length);for(let c=0;c<a.length;c++)try{const u=parse$1(s[c],o,n);a[c]=u}catch(u){throw new Error(`failed to parse haystack item ${c} for "in" expression: ${u.message}`)}return[parse$1(l[1],o,n),...a]}function withPaletteArgs(l,t,n){let s;try{s=parse$1(l[1],NumberType,n)}catch(h){throw new Error(`failed to parse first argument in palette expression: ${h.message}`)}const o=l[2];if(!Array.isArray(o))throw new Error("the second argument of palette must be an array");const a=new Array(o.length);for(let h=0;h<a.length;h++){let c;try{c=parse$1(o[h],ColorType,n)}catch(u){throw new Error(`failed to parse color at index ${h} in palette expression: ${u.message}`)}if(!(c instanceof LiteralExpression))throw new Error(`the palette color at index ${h} must be a literal value`);a[h]=c}return[s,...a]}function createCallExpressionParser(...l){return function(t,n,s){const o=t[0];let a;for(let h=0;h<l.length;h++){const c=l[h](t,n,s);if(h==l.length-1){if(!c)throw new Error("expected last argument validator to return the parsed args");a=c}}return new CallExpression(n,o,...a)}}function parseCallExpression(l,t,n){const s=l[0],o=parsers[s];if(!o)throw new Error(`unknown operator: ${s}`);return o(l,t,n)}function computeGeometryType(l){if(!l)return"";const t=l.getType();switch(t){case"Point":case"LineString":case"Polygon":return t;case"MultiPoint":case"MultiLineString":case"MultiPolygon":return t.substring(5);case"Circle":return"Polygon";case"GeometryCollection":return computeGeometryType(l.getGeometries()[0]);default:return""}}function newEvaluationContext(){return{variables:{},properties:{},resolution:NaN,featureId:null,geometryType:""}}function buildExpression$1(l,t,n){const s=parse$1(l,t,n);return compileExpression(s)}function compileExpression(l,t){if(l instanceof LiteralExpression){if(l.type===ColorType&&typeof l.value=="string"){const s=fromString(l.value);return function(){return s}}return function(){return l.value}}const n=l.operator;switch(n){case Ops.Number:case Ops.String:case Ops.Coalesce:return compileAssertionExpression(l);case Ops.Get:case Ops.Var:case Ops.Has:return compileAccessorExpression(l);case Ops.Id:return s=>s.featureId;case Ops.GeometryType:return s=>s.geometryType;case Ops.Concat:{const s=l.args.map(o=>compileExpression(o));return o=>"".concat(...s.map(a=>a(o).toString()))}case Ops.Resolution:return s=>s.resolution;case Ops.Any:case Ops.All:case Ops.Between:case Ops.In:case Ops.Not:return compileLogicalExpression(l);case Ops.Equal:case Ops.NotEqual:case Ops.LessThan:case Ops.LessThanOrEqualTo:case Ops.GreaterThan:case Ops.GreaterThanOrEqualTo:return compileComparisonExpression(l);case Ops.Multiply:case Ops.Divide:case Ops.Add:case Ops.Subtract:case Ops.Clamp:case Ops.Mod:case Ops.Pow:case Ops.Abs:case Ops.Floor:case Ops.Ceil:case Ops.Round:case Ops.Sin:case Ops.Cos:case Ops.Atan:case Ops.Sqrt:return compileNumericExpression(l);case Ops.Case:return compileCaseExpression(l);case Ops.Match:return compileMatchExpression(l);case Ops.Interpolate:return compileInterpolateExpression(l);case Ops.ToString:return compileConvertExpression(l);default:throw new Error(`Unsupported operator ${n}`)}}function compileAssertionExpression(l,t){const n=l.operator,s=l.args.length,o=new Array(s);for(let a=0;a<s;++a)o[a]=compileExpression(l.args[a]);switch(n){case Ops.Coalesce:return a=>{for(let h=0;h<s;++h){const c=o[h](a);if(typeof c<"u"&&c!==null)return c}throw new Error("Expected one of the values to be non-null")};case Ops.Number:case Ops.String:return a=>{for(let h=0;h<s;++h){const c=o[h](a);if(typeof c===n)return c}throw new Error(`Expected one of the values to be a ${n}`)};default:throw new Error(`Unsupported assertion operator ${n}`)}}function compileAccessorExpression(l,t){const s=l.args[0].value;switch(l.operator){case Ops.Get:return o=>{const a=l.args;let h=o.properties[s];for(let c=1,u=a.length;c<u;++c){const f=a[c].value;h=h[f]}return h};case Ops.Var:return o=>o.variables[s];case Ops.Has:return o=>{const a=l.args;if(!(s in o.properties))return!1;let h=o.properties[s];for(let c=1,u=a.length;c<u;++c){const f=a[c].value;if(!h||!Object.hasOwn(h,f))return!1;h=h[f]}return!0};default:throw new Error(`Unsupported accessor operator ${l.operator}`)}}function compileComparisonExpression(l,t){const n=l.operator,s=compileExpression(l.args[0]),o=compileExpression(l.args[1]);switch(n){case Ops.Equal:return a=>s(a)===o(a);case Ops.NotEqual:return a=>s(a)!==o(a);case Ops.LessThan:return a=>s(a)<o(a);case Ops.LessThanOrEqualTo:return a=>s(a)<=o(a);case Ops.GreaterThan:return a=>s(a)>o(a);case Ops.GreaterThanOrEqualTo:return a=>s(a)>=o(a);default:throw new Error(`Unsupported comparison operator ${n}`)}}function compileLogicalExpression(l,t){const n=l.operator,s=l.args.length,o=new Array(s);for(let a=0;a<s;++a)o[a]=compileExpression(l.args[a]);switch(n){case Ops.Any:return a=>{for(let h=0;h<s;++h)if(o[h](a))return!0;return!1};case Ops.All:return a=>{for(let h=0;h<s;++h)if(!o[h](a))return!1;return!0};case Ops.Between:return a=>{const h=o[0](a),c=o[1](a),u=o[2](a);return h>=c&&h<=u};case Ops.In:return a=>{const h=o[0](a);for(let c=1;c<s;++c)if(h===o[c](a))return!0;return!1};case Ops.Not:return a=>!o[0](a);default:throw new Error(`Unsupported logical operator ${n}`)}}function compileNumericExpression(l,t){const n=l.operator,s=l.args.length,o=new Array(s);for(let a=0;a<s;++a)o[a]=compileExpression(l.args[a]);switch(n){case Ops.Multiply:return a=>{let h=1;for(let c=0;c<s;++c)h*=o[c](a);return h};case Ops.Divide:return a=>o[0](a)/o[1](a);case Ops.Add:return a=>{let h=0;for(let c=0;c<s;++c)h+=o[c](a);return h};case Ops.Subtract:return a=>o[0](a)-o[1](a);case Ops.Clamp:return a=>{const h=o[0](a),c=o[1](a);if(h<c)return c;const u=o[2](a);return h>u?u:h};case Ops.Mod:return a=>o[0](a)%o[1](a);case Ops.Pow:return a=>Math.pow(o[0](a),o[1](a));case Ops.Abs:return a=>Math.abs(o[0](a));case Ops.Floor:return a=>Math.floor(o[0](a));case Ops.Ceil:return a=>Math.ceil(o[0](a));case Ops.Round:return a=>Math.round(o[0](a));case Ops.Sin:return a=>Math.sin(o[0](a));case Ops.Cos:return a=>Math.cos(o[0](a));case Ops.Atan:return s===2?a=>Math.atan2(o[0](a),o[1](a)):a=>Math.atan(o[0](a));case Ops.Sqrt:return a=>Math.sqrt(o[0](a));default:throw new Error(`Unsupported numeric operator ${n}`)}}function compileCaseExpression(l,t){const n=l.args.length,s=new Array(n);for(let o=0;o<n;++o)s[o]=compileExpression(l.args[o]);return o=>{for(let a=0;a<n-1;a+=2)if(s[a](o))return s[a+1](o);return s[n-1](o)}}function compileMatchExpression(l,t){const n=l.args.length,s=new Array(n);for(let o=0;o<n;++o)s[o]=compileExpression(l.args[o]);return o=>{const a=s[0](o);for(let h=1;h<n-1;h+=2)if(a===s[h](o))return s[h+1](o);return s[n-1](o)}}function compileInterpolateExpression(l,t){const n=l.args.length,s=new Array(n);for(let o=0;o<n;++o)s[o]=compileExpression(l.args[o]);return o=>{const a=s[0](o),h=s[1](o);let c,u;for(let d=2;d<n;d+=2){const f=s[d](o);let g=s[d+1](o);const _=Array.isArray(g);if(_&&(g=withAlpha(g)),f>=h)return d===2?g:_?interpolateColor(a,h,c,u,f,g):interpolateNumber(a,h,c,u,f,g);c=f,u=g}return u}}function compileConvertExpression(l,t){const n=l.operator,s=l.args.length,o=new Array(s);for(let a=0;a<s;++a)o[a]=compileExpression(l.args[a]);switch(n){case Ops.ToString:return a=>{const h=o[0](a);return l.args[0].type===ColorType?toString(h):h.toString()};default:throw new Error(`Unsupported convert operator ${n}`)}}function interpolateNumber(l,t,n,s,o,a){const h=o-n;if(h===0)return s;const c=t-n,u=l===1?c/h:(Math.pow(l,c)-1)/(Math.pow(l,h)-1);return s+u*(a-s)}function interpolateColor(l,t,n,s,o,a){if(o-n===0)return s;const c=rgbaToLcha(s),u=rgbaToLcha(a);let d=u[2]-c[2];d>180?d-=360:d<-180&&(d+=360);const f=[interpolateNumber(l,t,n,c[0],o,u[0]),interpolateNumber(l,t,n,c[1],o,u[1]),c[2]+interpolateNumber(l,t,n,0,o,d),interpolateNumber(l,t,n,s[3],o,a[3])];return lchaToRgba(f)}const ImageState={IDLE:0,LOADING:1,LOADED:2,ERROR:3,EMPTY:4};class ImageWrapper extends Target{constructor(t,n,s,o){super(),this.extent=t,this.pixelRatio_=s,this.resolution=n,this.state=typeof o=="function"?ImageState.IDLE:o,this.image_=null,this.loader=typeof o=="function"?o:null}changed(){this.dispatchEvent(EventType$1.CHANGE)}getExtent(){return this.extent}getImage(){return this.image_}getPixelRatio(){return this.pixelRatio_}getResolution(){return this.resolution}getState(){return this.state}load(){if(this.state==ImageState.IDLE&&this.loader){this.state=ImageState.LOADING,this.changed();const t=this.getResolution(),n=Array.isArray(t)?t[0]:t;toPromise(()=>this.loader(this.getExtent(),n,this.getPixelRatio())).then(s=>{"image"in s&&(this.image_=s.image),"extent"in s&&(this.extent=s.extent),"resolution"in s&&(this.resolution=s.resolution),"pixelRatio"in s&&(this.pixelRatio_=s.pixelRatio),(s instanceof HTMLImageElement||CREATE_IMAGE_BITMAP&&s instanceof ImageBitmap||s instanceof HTMLCanvasElement||s instanceof HTMLVideoElement)&&(this.image_=s),this.state=ImageState.LOADED}).catch(s=>{this.state=ImageState.ERROR,console.error(s)}).finally(()=>this.changed())}}setImage(t){this.image_=t}setResolution(t){this.resolution=t}}function listenImage(l,t,n){const s=l;let o=!0,a=!1,h=!1;const c=[listenOnce(s,EventType$1.LOAD,function(){h=!0,a||t()})];return s.src&&IMAGE_DECODE?(a=!0,s.decode().then(function(){o&&t()}).catch(function(u){o&&(h?t():n())})):c.push(listenOnce(s,EventType$1.ERROR,n)),function(){o=!1,c.forEach(unlistenByKey)}}function load(l,t){return new Promise((n,s)=>{function o(){h(),n(l)}function a(){h(),s(new Error("Image load error"))}function h(){l.removeEventListener("load",o),l.removeEventListener("error",a)}l.addEventListener("load",o),l.addEventListener("error",a)})}function decodeFallback(l,t){return t&&(l.src=t),l.src&&IMAGE_DECODE?new Promise((n,s)=>l.decode().then(()=>n(l)).catch(o=>l.complete&&l.width?n(l):s(o))):load(l)}function decode(l,t){return t&&(l.src=t),l.src&&IMAGE_DECODE&&CREATE_IMAGE_BITMAP?l.decode().then(()=>createImageBitmap(l)).catch(n=>{if(l.complete&&l.width)return l;throw n}):decodeFallback(l)}class IconImageCache{constructor(){this.cache_={},this.patternCache_={},this.cacheSize_=0,this.maxCacheSize_=1024}clear(){this.cache_={},this.patternCache_={},this.cacheSize_=0}canExpireCache(){return this.cacheSize_>this.maxCacheSize_}expire(){if(this.canExpireCache()){let t=0;for(const n in this.cache_){const s=this.cache_[n];!(t++&3)&&!s.hasListener()&&(delete this.cache_[n],delete this.patternCache_[n],--this.cacheSize_)}}}get(t,n,s){const o=getCacheKey$2(t,n,s);return o in this.cache_?this.cache_[o]:null}getPattern(t,n,s){const o=getCacheKey$2(t,n,s);return o in this.patternCache_?this.patternCache_[o]:null}set(t,n,s,o,a){const h=getCacheKey$2(t,n,s),c=h in this.cache_;this.cache_[h]=o,a&&(o.getImageState()===ImageState.IDLE&&o.load(),o.getImageState()===ImageState.LOADING?o.ready().then(()=>{this.patternCache_[h]=getSharedCanvasContext2D().createPattern(o.getImage(1),"repeat")}):this.patternCache_[h]=getSharedCanvasContext2D().createPattern(o.getImage(1),"repeat")),c||++this.cacheSize_}setSize(t){this.maxCacheSize_=t,this.expire()}}function getCacheKey$2(l,t,n){const s=n?asArray(n):"null";return t+":"+l+":"+s}const shared=new IconImageCache;let taintedTestContext=null;class IconImage extends Target{constructor(t,n,s,o,a){super(),this.hitDetectionImage_=null,this.image_=t,this.crossOrigin_=s,this.canvas_={},this.color_=a,this.imageState_=o===void 0?ImageState.IDLE:o,this.size_=t&&t.width&&t.height?[t.width,t.height]:null,this.src_=n,this.tainted_,this.ready_=null}initializeImage_(){this.image_=new Image,this.crossOrigin_!==null&&(this.image_.crossOrigin=this.crossOrigin_)}isTainted_(){if(this.tainted_===void 0&&this.imageState_===ImageState.LOADED){taintedTestContext||(taintedTestContext=createCanvasContext2D(1,1,void 0,{willReadFrequently:!0})),taintedTestContext.drawImage(this.image_,0,0);try{taintedTestContext.getImageData(0,0,1,1),this.tainted_=!1}catch{taintedTestContext=null,this.tainted_=!0}}return this.tainted_===!0}dispatchChangeEvent_(){this.dispatchEvent(EventType$1.CHANGE)}handleImageError_(){this.imageState_=ImageState.ERROR,this.dispatchChangeEvent_()}handleImageLoad_(){this.imageState_=ImageState.LOADED,this.size_=[this.image_.width,this.image_.height],this.dispatchChangeEvent_()}getImage(t){return this.image_||this.initializeImage_(),this.replaceColor_(t),this.canvas_[t]?this.canvas_[t]:this.image_}getPixelRatio(t){return this.replaceColor_(t),this.canvas_[t]?t:1}getImageState(){return this.imageState_}getHitDetectionImage(){if(this.image_||this.initializeImage_(),!this.hitDetectionImage_)if(this.isTainted_()){const t=this.size_[0],n=this.size_[1],s=createCanvasContext2D(t,n);s.fillRect(0,0,t,n),this.hitDetectionImage_=s.canvas}else this.hitDetectionImage_=this.image_;return this.hitDetectionImage_}getSize(){return this.size_}getSrc(){return this.src_}load(){if(this.imageState_===ImageState.IDLE){this.image_||this.initializeImage_(),this.imageState_=ImageState.LOADING;try{this.src_!==void 0&&(this.image_.src=this.src_)}catch{this.handleImageError_()}this.image_ instanceof HTMLImageElement&&decodeFallback(this.image_,this.src_).then(t=>{this.image_=t,this.handleImageLoad_()}).catch(this.handleImageError_.bind(this))}}replaceColor_(t){if(!this.color_||this.canvas_[t]||this.imageState_!==ImageState.LOADED)return;const n=this.image_,s=createCanvasContext2D(Math.ceil(n.width*t),Math.ceil(n.height*t)),o=s.canvas;s.scale(t,t),s.drawImage(n,0,0),s.globalCompositeOperation="multiply",s.fillStyle=asString(this.color_),s.fillRect(0,0,o.width/t,o.height/t),s.globalCompositeOperation="destination-in",s.drawImage(n,0,0),this.canvas_[t]=o}ready(){return this.ready_||(this.ready_=new Promise(t=>{if(this.imageState_===ImageState.LOADED||this.imageState_===ImageState.ERROR)t();else{const n=()=>{(this.imageState_===ImageState.LOADED||this.imageState_===ImageState.ERROR)&&(this.removeEventListener(EventType$1.CHANGE,n),t())};this.addEventListener(EventType$1.CHANGE,n)}})),this.ready_}}function get(l,t,n,s,o,a){let h=t===void 0?void 0:shared.get(t,n,o);return h||(h=new IconImage(l,l&&"src"in l?l.src||void 0:t,n,s,o),shared.set(t,n,o,h,a)),a&&h&&!shared.getPattern(t,n,o)&&shared.set(t,n,o,h,a),h}function asColorLike(l){return l?Array.isArray(l)?toString(l):typeof l=="object"&&"src"in l?asCanvasPattern(l):l:null}function asCanvasPattern(l){if(!l.offset||!l.size)return shared.getPattern(l.src,"anonymous",l.color);const t=l.src+":"+l.offset,n=shared.getPattern(t,void 0,l.color);if(n)return n;const s=shared.get(l.src,"anonymous",null);if(s.getImageState()!==ImageState.LOADED)return null;const o=createCanvasContext2D(l.size[0],l.size[1]);return o.drawImage(s.getImage(1),l.offset[0],l.offset[1],l.size[0],l.size[1],0,0,l.size[0],l.size[1]),get(o.canvas,t,void 0,ImageState.LOADED,l.color,!0),shared.getPattern(t,void 0,l.color)}const defaultFont="10px sans-serif",defaultFillStyle="#000",defaultLineCap="round",defaultLineDash=[],defaultLineDashOffset=0,defaultLineJoin="round",defaultMiterLimit=10,defaultStrokeStyle="#000",defaultTextAlign="center",defaultTextBaseline="middle",defaultPadding=[0,0,0,0],defaultLineWidth=1,checkedFonts=new BaseObject;let measureContext=null,measureFont;const textHeights={},genericFontFamilies=new Set(["serif","sans-serif","monospace","cursive","fantasy","system-ui","ui-serif","ui-sans-serif","ui-monospace","ui-rounded","emoji","math","fangsong"]);function getFontKey(l,t,n){return`${l} ${t} 16px "${n}"`}const registerFont=function(){let t,n;async function s(a){await n.ready;const h=await n.load(a);if(h.length===0)return!1;const c=getFontParameters(a),u=c.families[0].toLowerCase(),d=c.weight;return h.some(f=>{const g=f.family.replace(/^['"]|['"]$/g,"").toLowerCase(),_=fontWeights[f.weight]||f.weight;return g===u&&f.style===c.style&&_==d})}async function o(){await n.ready;let a=!0;const h=checkedFonts.getProperties(),c=Object.keys(h).filter(u=>h[u]<100);for(let u=c.length-1;u>=0;--u){const d=c[u];let f=h[d];f<100&&(await s(d)?(clear(textHeights),checkedFonts.set(d,100)):(f+=10,checkedFonts.set(d,f,!0),f<100&&(a=!1)))}t=void 0,a||(t=setTimeout(o,100))}return async function(a){n||(n=WORKER_OFFSCREEN_CANVAS?self.fonts:document.fonts);const h=getFontParameters(a);if(!h)return;const c=h.families;let u=!1;for(const d of c){if(genericFontFamilies.has(d))continue;const f=getFontKey(h.style,h.weight,d);checkedFonts.get(f)===void 0&&(checkedFonts.set(f,0,!0),u=!0)}u&&(clearTimeout(t),t=setTimeout(o,100))}}(),measureTextHeight=function(){let l;return function(t){let n=textHeights[t];if(n==null){if(WORKER_OFFSCREEN_CANVAS){const s=getFontParameters(t),o=measureText(t,"Žg");n=(isNaN(Number(s.lineHeight))?1.2:Number(s.lineHeight))*(o.actualBoundingBoxAscent+o.actualBoundingBoxDescent)}else l||(l=document.createElement("div"),l.innerHTML="M",l.style.minHeight="0",l.style.maxHeight="none",l.style.height="auto",l.style.padding="0",l.style.border="none",l.style.position="absolute",l.style.display="block",l.style.left="-99999px"),l.style.font=t,document.body.appendChild(l),n=l.offsetHeight,document.body.removeChild(l);textHeights[t]=n}return n}}();function measureText(l,t){return measureContext||(measureContext=createCanvasContext2D(1,1)),l!=measureFont&&(measureContext.font=l,measureFont=measureContext.font),measureContext.measureText(t)}function measureTextWidth(l,t){return measureText(l,t).width}function measureAndCacheTextWidth(l,t,n){if(t in n)return n[t];const s=t.split(`
`).reduce((o,a)=>Math.max(o,measureTextWidth(l,a)),0);return n[t]=s,s}function getTextDimensions(l,t){const n=[],s=[],o=[];let a=0,h=0,c=0,u=0;for(let d=0,f=t.length;d<=f;d+=2){const g=t[d];if(g===`
`||d===f){a=Math.max(a,h),o.push(h),h=0,c+=u,u=0;continue}const _=t[d+1]||l.font,m=measureTextWidth(_,g);n.push(m),h+=m;const p=measureTextHeight(_);s.push(p),u=Math.max(u,p)}return{width:a,height:c,widths:n,heights:s,lineWidths:o}}function drawImageOrLabel(l,t,n,s,o,a,h,c,u,d,f){l.save(),n!==1&&(l.globalAlpha===void 0?l.globalAlpha=g=>g.globalAlpha*=n:l.globalAlpha*=n),t&&l.transform.apply(l,t),s.contextInstructions?(l.translate(u,d),l.scale(f[0],f[1]),executeLabelInstructions(s,l)):f[0]<0||f[1]<0?(l.translate(u,d),l.scale(f[0],f[1]),l.drawImage(s,o,a,h,c,0,0,h,c)):l.drawImage(s,o,a,h,c,u,d,h*f[0],c*f[1]),l.restore()}function executeLabelInstructions(l,t){const n=l.contextInstructions;for(let s=0,o=n.length;s<o;s+=2)Array.isArray(n[s+1])?t[n[s]].apply(t,n[s+1]):t[n[s]]=n[s+1]}class ImageStyle{constructor(t){this.opacity_=t.opacity,this.rotateWithView_=t.rotateWithView,this.rotation_=t.rotation,this.scale_=t.scale,this.scaleArray_=toSize(t.scale),this.displacement_=t.displacement,this.declutterMode_=t.declutterMode}clone(){const t=this.getScale();return new ImageStyle({opacity:this.getOpacity(),scale:Array.isArray(t)?t.slice():t,rotation:this.getRotation(),rotateWithView:this.getRotateWithView(),displacement:this.getDisplacement().slice(),declutterMode:this.getDeclutterMode()})}getOpacity(){return this.opacity_}getRotateWithView(){return this.rotateWithView_}getRotation(){return this.rotation_}getScale(){return this.scale_}getScaleArray(){return this.scaleArray_}getDisplacement(){return this.displacement_}getDeclutterMode(){return this.declutterMode_}getAnchor(){return abstract()}getImage(t){return abstract()}getHitDetectionImage(){return abstract()}getPixelRatio(t){return 1}getImageState(){return abstract()}getImageSize(){return abstract()}getOrigin(){return abstract()}getSize(){return abstract()}setDisplacement(t){this.displacement_=t}setOpacity(t){this.opacity_=t}setRotateWithView(t){this.rotateWithView_=t}setRotation(t){this.rotation_=t}setScale(t){this.scale_=t,this.scaleArray_=toSize(t)}listenImageChange(t){abstract()}load(){abstract()}unlistenImageChange(t){abstract()}ready(){return Promise.resolve()}}class RegularShape extends ImageStyle{constructor(t){super({opacity:1,rotateWithView:t.rotateWithView!==void 0?t.rotateWithView:!1,rotation:t.rotation!==void 0?t.rotation:0,scale:t.scale!==void 0?t.scale:1,displacement:t.displacement!==void 0?t.displacement:[0,0],declutterMode:t.declutterMode}),this.hitDetectionCanvas_=null,this.fill_=t.fill!==void 0?t.fill:null,this.origin_=[0,0],this.points_=t.points,this.radius=t.radius,this.radius2_=t.radius2,this.angle_=t.angle!==void 0?t.angle:0,this.stroke_=t.stroke!==void 0?t.stroke:null,this.size_,this.renderOptions_,this.imageState_=this.fill_&&this.fill_.loading()?ImageState.LOADING:ImageState.LOADED,this.imageState_===ImageState.LOADING&&this.ready().then(()=>this.imageState_=ImageState.LOADED),this.render()}clone(){const t=this.getScale(),n=new RegularShape({fill:this.getFill()?this.getFill().clone():void 0,points:this.getPoints(),radius:this.getRadius(),radius2:this.getRadius2(),angle:this.getAngle(),stroke:this.getStroke()?this.getStroke().clone():void 0,rotation:this.getRotation(),rotateWithView:this.getRotateWithView(),scale:Array.isArray(t)?t.slice():t,displacement:this.getDisplacement().slice(),declutterMode:this.getDeclutterMode()});return n.setOpacity(this.getOpacity()),n}getAnchor(){const t=this.size_,n=this.getDisplacement(),s=this.getScaleArray();return[t[0]/2-n[0]/s[0],t[1]/2+n[1]/s[1]]}getAngle(){return this.angle_}getFill(){return this.fill_}setFill(t){this.fill_=t,this.render()}getHitDetectionImage(){return this.hitDetectionCanvas_||(this.hitDetectionCanvas_=this.createHitDetectionCanvas_(this.renderOptions_)),this.hitDetectionCanvas_}getImage(t){var a,h;const n=(a=this.fill_)==null?void 0:a.getKey(),s=`${t},${this.angle_},${this.radius},${this.radius2_},${this.points_},${n}`+Object.values(this.renderOptions_).join(",");let o=(h=shared.get(s,null,null))==null?void 0:h.getImage(1);if(!o){const c=this.renderOptions_,u=Math.ceil(c.size*t),d=createCanvasContext2D(u,u);this.draw_(c,d,t),o=d.canvas,shared.set(s,null,null,new IconImage(o,void 0,null,ImageState.LOADED,null))}return o}getPixelRatio(t){return t}getImageSize(){return this.size_}getImageState(){return this.imageState_}getOrigin(){return this.origin_}getPoints(){return this.points_}getRadius(){return this.radius}getRadius2(){return this.radius2_}getSize(){return this.size_}getStroke(){return this.stroke_}setStroke(t){this.stroke_=t,this.render()}listenImageChange(t){}load(){}unlistenImageChange(t){}calculateLineJoinSize_(t,n,s){if(n===0||this.points_===1/0||t!=="bevel"&&t!=="miter")return n;let o=this.radius,a=this.radius2_===void 0?o:this.radius2_;if(o<a){const I=o;o=a,a=I}const h=this.radius2_===void 0?this.points_:this.points_*2,c=2*Math.PI/h,u=a*Math.sin(c),d=Math.sqrt(a*a-u*u),f=o-d,g=Math.sqrt(u*u+f*f),_=g/u;if(t==="miter"&&_<=s)return _*n;const m=n/2/_,p=n/2*(f/g),y=Math.sqrt((o+m)*(o+m)+p*p)-o;if(this.radius2_===void 0||t==="bevel")return y*2;const T=o*Math.sin(c),S=Math.sqrt(o*o-T*T),C=a-S,w=Math.sqrt(T*T+C*C)/T;if(w<=s){const I=w*n/2-a-o;return 2*Math.max(y,I)}return y*2}createRenderOptions(){let t=defaultLineCap,n=defaultLineJoin,s=0,o=null,a=0,h,c=0;this.stroke_&&(h=asColorLike(this.stroke_.getColor()??defaultStrokeStyle),c=this.stroke_.getWidth()??defaultLineWidth,o=this.stroke_.getLineDash(),a=this.stroke_.getLineDashOffset()??0,n=this.stroke_.getLineJoin()??defaultLineJoin,t=this.stroke_.getLineCap()??defaultLineCap,s=this.stroke_.getMiterLimit()??defaultMiterLimit);const u=this.calculateLineJoinSize_(n,c,s),d=Math.max(this.radius,this.radius2_||0),f=Math.ceil(2*d+u);return{strokeStyle:h,strokeWidth:c,size:f,lineCap:t,lineDash:o,lineDashOffset:a,lineJoin:n,miterLimit:s}}render(){this.renderOptions_=this.createRenderOptions();const t=this.renderOptions_.size;this.hitDetectionCanvas_=null,this.size_=[t,t]}draw_(t,n,s){if(n.scale(s,s),n.translate(t.size/2,t.size/2),this.createPath_(n),this.fill_){let o=this.fill_.getColor();o===null&&(o=defaultFillStyle),n.fillStyle=asColorLike(o),n.fill()}t.strokeStyle&&(n.strokeStyle=t.strokeStyle,n.lineWidth=t.strokeWidth,t.lineDash&&(n.setLineDash(t.lineDash),n.lineDashOffset=t.lineDashOffset),n.lineCap=t.lineCap,n.lineJoin=t.lineJoin,n.miterLimit=t.miterLimit,n.stroke())}createHitDetectionCanvas_(t){let n;if(this.fill_){let s=this.fill_.getColor(),o=0;typeof s=="string"&&(s=asArray(s)),s===null?o=1:Array.isArray(s)&&(o=s.length===4?s[3]:1),o===0&&(n=createCanvasContext2D(t.size,t.size),this.drawHitDetectionCanvas_(t,n))}return n?n.canvas:this.getImage(1)}createPath_(t){let n=this.points_;const s=this.radius;if(n===1/0)t.arc(0,0,s,0,2*Math.PI);else{const o=this.radius2_===void 0?s:this.radius2_;this.radius2_!==void 0&&(n*=2);const a=this.angle_-Math.PI/2,h=2*Math.PI/n;for(let c=0;c<n;c++){const u=a+c*h,d=c%2===0?s:o;t.lineTo(d*Math.cos(u),d*Math.sin(u))}t.closePath()}}drawHitDetectionCanvas_(t,n){n.translate(t.size/2,t.size/2),this.createPath_(n),n.fillStyle=defaultFillStyle,n.fill(),t.strokeStyle&&(n.strokeStyle=t.strokeStyle,n.lineWidth=t.strokeWidth,t.lineDash&&(n.setLineDash(t.lineDash),n.lineDashOffset=t.lineDashOffset),n.lineJoin=t.lineJoin,n.miterLimit=t.miterLimit,n.stroke())}ready(){return this.fill_?this.fill_.ready():Promise.resolve()}}class CircleStyle extends RegularShape{constructor(t){t=t||{radius:5},super({points:1/0,fill:t.fill,radius:t.radius,stroke:t.stroke,scale:t.scale!==void 0?t.scale:1,rotation:t.rotation!==void 0?t.rotation:0,rotateWithView:t.rotateWithView!==void 0?t.rotateWithView:!1,displacement:t.displacement!==void 0?t.displacement:[0,0],declutterMode:t.declutterMode})}clone(){const t=this.getScale(),n=new CircleStyle({fill:this.getFill()?this.getFill().clone():void 0,stroke:this.getStroke()?this.getStroke().clone():void 0,radius:this.getRadius(),scale:Array.isArray(t)?t.slice():t,rotation:this.getRotation(),rotateWithView:this.getRotateWithView(),displacement:this.getDisplacement().slice(),declutterMode:this.getDeclutterMode()});return n.setOpacity(this.getOpacity()),n}setRadius(t){this.radius=t,this.render()}}class Fill{constructor(t){t=t||{},this.patternImage_=null,this.color_=null,t.color!==void 0&&this.setColor(t.color)}clone(){const t=this.getColor();return new Fill({color:Array.isArray(t)?t.slice():t||void 0})}getColor(){return this.color_}setColor(t){if(t!==null&&typeof t=="object"&&"src"in t){const n=get(null,t.src,"anonymous",void 0,t.offset?null:t.color?t.color:null,!(t.offset&&t.size));n.ready().then(()=>{this.patternImage_=null}),n.getImageState()===ImageState.IDLE&&n.load(),n.getImageState()===ImageState.LOADING&&(this.patternImage_=n)}this.color_=t}getKey(){const t=this.getColor();return t?t instanceof CanvasPattern||t instanceof CanvasGradient?getUid(t):typeof t=="object"&&"src"in t?t.src+":"+t.offset:asArray(t).toString():""}loading(){return!!this.patternImage_}ready(){return this.patternImage_?this.patternImage_.ready():Promise.resolve()}}function calculateScale(l,t,n,s){return n!==void 0&&s!==void 0?[n/l,s/t]:n!==void 0?n/l:s!==void 0?s/t:1}class Icon extends ImageStyle{constructor(t){t=t||{};const n=t.opacity!==void 0?t.opacity:1,s=t.rotation!==void 0?t.rotation:0,o=t.scale!==void 0?t.scale:1,a=t.rotateWithView!==void 0?t.rotateWithView:!1;super({opacity:n,rotation:s,scale:o,displacement:t.displacement!==void 0?t.displacement:[0,0],rotateWithView:a,declutterMode:t.declutterMode}),this.anchor_=t.anchor!==void 0?t.anchor:[.5,.5],this.normalizedAnchor_=null,this.anchorOrigin_=t.anchorOrigin!==void 0?t.anchorOrigin:"top-left",this.anchorXUnits_=t.anchorXUnits!==void 0?t.anchorXUnits:"fraction",this.anchorYUnits_=t.anchorYUnits!==void 0?t.anchorYUnits:"fraction",this.crossOrigin_=t.crossOrigin!==void 0?t.crossOrigin:null;const h=t.img!==void 0?t.img:null;let c=t.src;assert(!(c!==void 0&&h),"`image` and `src` cannot be provided at the same time"),(c===void 0||c.length===0)&&h&&(c=h.src||getUid(h)),assert(c!==void 0&&c.length>0,"A defined and non-empty `src` or `image` must be provided"),assert(!((t.width!==void 0||t.height!==void 0)&&t.scale!==void 0),"`width` or `height` cannot be provided together with `scale`");let u;if(t.src!==void 0?u=ImageState.IDLE:h!==void 0&&("complete"in h?h.complete?u=h.src?ImageState.LOADED:ImageState.IDLE:u=ImageState.LOADING:u=ImageState.LOADED),this.color_=t.color!==void 0?asArray(t.color):null,this.iconImage_=get(h,c,this.crossOrigin_,u,this.color_),this.offset_=t.offset!==void 0?t.offset:[0,0],this.offsetOrigin_=t.offsetOrigin!==void 0?t.offsetOrigin:"top-left",this.origin_=null,this.size_=t.size!==void 0?t.size:null,this.initialOptions_,t.width!==void 0||t.height!==void 0){let d,f;if(t.size)[d,f]=t.size;else{const g=this.getImage(1);if(g.width&&g.height)d=g.width,f=g.height;else if(g instanceof HTMLImageElement){this.initialOptions_=t;const _=()=>{if(this.unlistenImageChange(_),!this.initialOptions_)return;const m=this.iconImage_.getSize();this.setScale(calculateScale(m[0],m[1],t.width,t.height))};this.listenImageChange(_);return}}d!==void 0&&this.setScale(calculateScale(d,f,t.width,t.height))}}clone(){let t,n,s;return this.initialOptions_?(n=this.initialOptions_.width,s=this.initialOptions_.height):(t=this.getScale(),t=Array.isArray(t)?t.slice():t),new Icon({anchor:this.anchor_.slice(),anchorOrigin:this.anchorOrigin_,anchorXUnits:this.anchorXUnits_,anchorYUnits:this.anchorYUnits_,color:this.color_&&this.color_.slice?this.color_.slice():this.color_||void 0,crossOrigin:this.crossOrigin_,offset:this.offset_.slice(),offsetOrigin:this.offsetOrigin_,opacity:this.getOpacity(),rotateWithView:this.getRotateWithView(),rotation:this.getRotation(),scale:t,width:n,height:s,size:this.size_!==null?this.size_.slice():void 0,src:this.getSrc(),displacement:this.getDisplacement().slice(),declutterMode:this.getDeclutterMode()})}getAnchor(){let t=this.normalizedAnchor_;if(!t){t=this.anchor_;const o=this.getSize();if(this.anchorXUnits_=="fraction"||this.anchorYUnits_=="fraction"){if(!o)return null;t=this.anchor_.slice(),this.anchorXUnits_=="fraction"&&(t[0]*=o[0]),this.anchorYUnits_=="fraction"&&(t[1]*=o[1])}if(this.anchorOrigin_!="top-left"){if(!o)return null;t===this.anchor_&&(t=this.anchor_.slice()),(this.anchorOrigin_=="top-right"||this.anchorOrigin_=="bottom-right")&&(t[0]=-t[0]+o[0]),(this.anchorOrigin_=="bottom-left"||this.anchorOrigin_=="bottom-right")&&(t[1]=-t[1]+o[1])}this.normalizedAnchor_=t}const n=this.getDisplacement(),s=this.getScaleArray();return[t[0]-n[0]/s[0],t[1]+n[1]/s[1]]}setAnchor(t){this.anchor_=t,this.normalizedAnchor_=null}getColor(){return this.color_}getImage(t){return this.iconImage_.getImage(t)}getPixelRatio(t){return this.iconImage_.getPixelRatio(t)}getImageSize(){return this.iconImage_.getSize()}getImageState(){return this.iconImage_.getImageState()}getHitDetectionImage(){return this.iconImage_.getHitDetectionImage()}getOrigin(){if(this.origin_)return this.origin_;let t=this.offset_;if(this.offsetOrigin_!="top-left"){const n=this.getSize(),s=this.iconImage_.getSize();if(!n||!s)return null;t=t.slice(),(this.offsetOrigin_=="top-right"||this.offsetOrigin_=="bottom-right")&&(t[0]=s[0]-n[0]-t[0]),(this.offsetOrigin_=="bottom-left"||this.offsetOrigin_=="bottom-right")&&(t[1]=s[1]-n[1]-t[1])}return this.origin_=t,this.origin_}getSrc(){return this.iconImage_.getSrc()}setSrc(t){this.iconImage_=get(null,t,this.crossOrigin_,ImageState.IDLE,this.color_)}getSize(){return this.size_?this.size_:this.iconImage_.getSize()}getWidth(){const t=this.getScaleArray();if(this.size_)return this.size_[0]*t[0];if(this.iconImage_.getImageState()==ImageState.LOADED)return this.iconImage_.getSize()[0]*t[0]}getHeight(){const t=this.getScaleArray();if(this.size_)return this.size_[1]*t[1];if(this.iconImage_.getImageState()==ImageState.LOADED)return this.iconImage_.getSize()[1]*t[1]}setScale(t){delete this.initialOptions_,super.setScale(t)}listenImageChange(t){this.iconImage_.addEventListener(EventType$1.CHANGE,t)}load(){this.iconImage_.load()}unlistenImageChange(t){this.iconImage_.removeEventListener(EventType$1.CHANGE,t)}ready(){return this.iconImage_.ready()}}class Stroke{constructor(t){t=t||{},this.color_=t.color!==void 0?t.color:null,this.lineCap_=t.lineCap,this.lineDash_=t.lineDash!==void 0?t.lineDash:null,this.lineDashOffset_=t.lineDashOffset,this.lineJoin_=t.lineJoin,this.miterLimit_=t.miterLimit,this.width_=t.width}clone(){const t=this.getColor();return new Stroke({color:Array.isArray(t)?t.slice():t||void 0,lineCap:this.getLineCap(),lineDash:this.getLineDash()?this.getLineDash().slice():void 0,lineDashOffset:this.getLineDashOffset(),lineJoin:this.getLineJoin(),miterLimit:this.getMiterLimit(),width:this.getWidth()})}getColor(){return this.color_}getLineCap(){return this.lineCap_}getLineDash(){return this.lineDash_}getLineDashOffset(){return this.lineDashOffset_}getLineJoin(){return this.lineJoin_}getMiterLimit(){return this.miterLimit_}getWidth(){return this.width_}setColor(t){this.color_=t}setLineCap(t){this.lineCap_=t}setLineDash(t){this.lineDash_=t}setLineDashOffset(t){this.lineDashOffset_=t}setLineJoin(t){this.lineJoin_=t}setMiterLimit(t){this.miterLimit_=t}setWidth(t){this.width_=t}}class Style{constructor(t){t=t||{},this.geometry_=null,this.geometryFunction_=defaultGeometryFunction,t.geometry!==void 0&&this.setGeometry(t.geometry),this.fill_=t.fill!==void 0?t.fill:null,this.image_=t.image!==void 0?t.image:null,this.renderer_=t.renderer!==void 0?t.renderer:null,this.hitDetectionRenderer_=t.hitDetectionRenderer!==void 0?t.hitDetectionRenderer:null,this.stroke_=t.stroke!==void 0?t.stroke:null,this.text_=t.text!==void 0?t.text:null,this.zIndex_=t.zIndex}clone(){let t=this.getGeometry();return t&&typeof t=="object"&&(t=t.clone()),new Style({geometry:t??void 0,fill:this.getFill()?this.getFill().clone():void 0,image:this.getImage()?this.getImage().clone():void 0,renderer:this.getRenderer()??void 0,stroke:this.getStroke()?this.getStroke().clone():void 0,text:this.getText()?this.getText().clone():void 0,zIndex:this.getZIndex()})}getRenderer(){return this.renderer_}setRenderer(t){this.renderer_=t}setHitDetectionRenderer(t){this.hitDetectionRenderer_=t}getHitDetectionRenderer(){return this.hitDetectionRenderer_}getGeometry(){return this.geometry_}getGeometryFunction(){return this.geometryFunction_}getFill(){return this.fill_}setFill(t){this.fill_=t}getImage(){return this.image_}setImage(t){this.image_=t}getStroke(){return this.stroke_}setStroke(t){this.stroke_=t}getText(){return this.text_}setText(t){this.text_=t}getZIndex(){return this.zIndex_}setGeometry(t){typeof t=="function"?this.geometryFunction_=t:typeof t=="string"?this.geometryFunction_=function(n){return n.get(t)}:t?t!==void 0&&(this.geometryFunction_=function(){return t}):this.geometryFunction_=defaultGeometryFunction,this.geometry_=t}setZIndex(t){this.zIndex_=t}}function toFunction(l){let t;if(typeof l=="function")t=l;else{let n;Array.isArray(l)?n=l:(assert(typeof l.getZIndex=="function","Expected an `Style` or an array of `Style`"),n=[l]),t=function(){return n}}return t}let defaultStyles=null;function createDefaultStyle$1(l,t){if(!defaultStyles){const n=new Fill({color:"rgba(255,255,255,0.4)"}),s=new Stroke({color:"#3399CC",width:1.25});defaultStyles=[new Style({image:new CircleStyle({fill:n,stroke:s,radius:5}),fill:n,stroke:s})]}return defaultStyles}function createEditingStyle(){const l={},t=[255,255,255,1],n=[0,153,255,1],s=3;return l.Polygon=[new Style({fill:new Fill({color:[255,255,255,.5]})})],l.MultiPolygon=l.Polygon,l.LineString=[new Style({stroke:new Stroke({color:t,width:s+2})}),new Style({stroke:new Stroke({color:n,width:s})})],l.MultiLineString=l.LineString,l.Circle=l.Polygon.concat(l.LineString),l.Point=[new Style({image:new CircleStyle({radius:s*2,fill:new Fill({color:n}),stroke:new Stroke({color:t,width:s/2})}),zIndex:1/0})],l.MultiPoint=l.Point,l.GeometryCollection=l.Polygon.concat(l.LineString,l.Point),l}function defaultGeometryFunction(l){return l.getGeometry()}const DEFAULT_FILL_COLOR="#333";class Text{constructor(t){t=t||{},this.font_=t.font,this.rotation_=t.rotation,this.rotateWithView_=t.rotateWithView,this.keepUpright_=t.keepUpright,this.scale_=t.scale,this.scaleArray_=toSize(t.scale!==void 0?t.scale:1),this.text_=t.text,this.textAlign_=t.textAlign,this.justify_=t.justify,this.repeat_=t.repeat,this.textBaseline_=t.textBaseline,this.fill_=t.fill!==void 0?t.fill:new Fill({color:DEFAULT_FILL_COLOR}),this.maxAngle_=t.maxAngle!==void 0?t.maxAngle:Math.PI/4,this.placement_=t.placement!==void 0?t.placement:"point",this.overflow_=!!t.overflow,this.stroke_=t.stroke!==void 0?t.stroke:null,this.offsetX_=t.offsetX!==void 0?t.offsetX:0,this.offsetY_=t.offsetY!==void 0?t.offsetY:0,this.backgroundFill_=t.backgroundFill?t.backgroundFill:null,this.backgroundStroke_=t.backgroundStroke?t.backgroundStroke:null,this.padding_=t.padding===void 0?null:t.padding,this.declutterMode_=t.declutterMode}clone(){const t=this.getScale();return new Text({font:this.getFont(),placement:this.getPlacement(),repeat:this.getRepeat(),maxAngle:this.getMaxAngle(),overflow:this.getOverflow(),rotation:this.getRotation(),rotateWithView:this.getRotateWithView(),keepUpright:this.getKeepUpright(),scale:Array.isArray(t)?t.slice():t,text:this.getText(),textAlign:this.getTextAlign(),justify:this.getJustify(),textBaseline:this.getTextBaseline(),fill:this.getFill()instanceof Fill?this.getFill().clone():this.getFill(),stroke:this.getStroke()?this.getStroke().clone():void 0,offsetX:this.getOffsetX(),offsetY:this.getOffsetY(),backgroundFill:this.getBackgroundFill()?this.getBackgroundFill().clone():void 0,backgroundStroke:this.getBackgroundStroke()?this.getBackgroundStroke().clone():void 0,padding:this.getPadding()||void 0,declutterMode:this.getDeclutterMode()})}getOverflow(){return this.overflow_}getFont(){return this.font_}getMaxAngle(){return this.maxAngle_}getPlacement(){return this.placement_}getRepeat(){return this.repeat_}getOffsetX(){return this.offsetX_}getOffsetY(){return this.offsetY_}getFill(){return this.fill_}getRotateWithView(){return this.rotateWithView_}getKeepUpright(){return this.keepUpright_}getRotation(){return this.rotation_}getScale(){return this.scale_}getScaleArray(){return this.scaleArray_}getStroke(){return this.stroke_}getText(){return this.text_}getTextAlign(){return this.textAlign_}getJustify(){return this.justify_}getTextBaseline(){return this.textBaseline_}getBackgroundFill(){return this.backgroundFill_}getBackgroundStroke(){return this.backgroundStroke_}getPadding(){return this.padding_}getDeclutterMode(){return this.declutterMode_}setOverflow(t){this.overflow_=t}setFont(t){this.font_=t}setMaxAngle(t){this.maxAngle_=t}setOffsetX(t){this.offsetX_=t}setOffsetY(t){this.offsetY_=t}setPlacement(t){this.placement_=t}setRepeat(t){this.repeat_=t}setRotateWithView(t){this.rotateWithView_=t}setKeepUpright(t){this.keepUpright_=t}setFill(t){this.fill_=t}setRotation(t){this.rotation_=t}setScale(t){this.scale_=t,this.scaleArray_=toSize(t!==void 0?t:1)}setStroke(t){this.stroke_=t}setText(t){this.text_=t}setTextAlign(t){this.textAlign_=t}setJustify(t){this.justify_=t}setTextBaseline(t){this.textBaseline_=t}setBackgroundFill(t){this.backgroundFill_=t}setBackgroundStroke(t){this.backgroundStroke_=t}setPadding(t){this.padding_=t}}function always(l){return!0}function rulesToStyleFunction(l){const t=newParsingContext(),n=buildRuleSet(l,t),s=newEvaluationContext();return function(o,a){if(s.properties=o.getPropertiesInternal(),s.resolution=a,t.featureId){const h=o.getId();h!==void 0?s.featureId=h:s.featureId=null}return t.geometryType&&(s.geometryType=computeGeometryType(o.getGeometry())),n(s)}}function flatStylesToStyleFunction(l){const t=newParsingContext(),n=l.length,s=new Array(n);for(let h=0;h<n;++h)s[h]=buildStyle(l[h],t);const o=newEvaluationContext(),a=new Array(n);return function(h,c){if(o.properties=h.getPropertiesInternal(),o.resolution=c,t.featureId){const d=h.getId();d!==void 0?o.featureId=d:o.featureId=null}let u=0;for(let d=0;d<n;++d){const f=s[d](o);f&&(a[u]=f,u+=1)}return a.length=u,a}}function buildRuleSet(l,t){const n=l.length,s=new Array(n);for(let o=0;o<n;++o){const a=l[o],h="filter"in a?buildExpression$1(a.filter,BooleanType,t):always;let c;if(Array.isArray(a.style)){const u=a.style.length;c=new Array(u);for(let d=0;d<u;++d)c[d]=buildStyle(a.style[d],t)}else c=[buildStyle(a.style,t)];s[o]={filter:h,styles:c}}return function(o){const a=[];let h=!1;for(let c=0;c<n;++c){const u=s[c].filter;if(u(o)&&!(l[c].else&&h)){h=!0;for(const d of s[c].styles){const f=d(o);f&&a.push(f)}}}return a}}function buildStyle(l,t){const n=buildFill(l,"",t),s=buildStroke(l,"",t),o=buildText(l,t),a=buildImage(l,t),h=numberEvaluator(l,"z-index",t);if(!n&&!s&&!o&&!a&&!isEmpty$1(l))throw new Error("No fill, stroke, point, or text symbolizer properties in style: "+JSON.stringify(l));const c=new Style;return function(u){let d=!0;if(n){const f=n(u);f&&(d=!1),c.setFill(f)}if(s){const f=s(u);f&&(d=!1),c.setStroke(f)}if(o){const f=o(u);f&&(d=!1),c.setText(f)}if(a){const f=a(u);f&&(d=!1),c.setImage(f)}return h&&c.setZIndex(h(u)),d?null:c}}function buildFill(l,t,n){let s;if(t+"fill-pattern-src"in l)s=patternEvaluator(l,t+"fill-",n);else{if(l[t+"fill-color"]==="none")return a=>null;s=colorLikeEvaluator(l,t+"fill-color",n)}if(!s)return null;const o=new Fill;return function(a){const h=s(a);return h===NO_COLOR?null:(o.setColor(h),o)}}function buildStroke(l,t,n){const s=numberEvaluator(l,t+"stroke-width",n),o=colorLikeEvaluator(l,t+"stroke-color",n);if(!s&&!o)return null;const a=stringEvaluator(l,t+"stroke-line-cap",n),h=stringEvaluator(l,t+"stroke-line-join",n),c=numberArrayEvaluator(l,t+"stroke-line-dash",n),u=numberEvaluator(l,t+"stroke-line-dash-offset",n),d=numberEvaluator(l,t+"stroke-miter-limit",n),f=new Stroke;return function(g){if(o){const _=o(g);if(_===NO_COLOR)return null;f.setColor(_)}if(s&&f.setWidth(s(g)),a){const _=a(g);if(_!=="butt"&&_!=="round"&&_!=="square")throw new Error("Expected butt, round, or square line cap");f.setLineCap(_)}if(h){const _=h(g);if(_!=="bevel"&&_!=="round"&&_!=="miter")throw new Error("Expected bevel, round, or miter line join");f.setLineJoin(_)}return c&&f.setLineDash(c(g)),u&&f.setLineDashOffset(u(g)),d&&f.setMiterLimit(d(g)),f}}function buildText(l,t){const n="text-",s=stringEvaluator(l,n+"value",t);if(!s)return null;const o=buildFill(l,n,t),a=buildFill(l,n+"background-",t),h=buildStroke(l,n,t),c=buildStroke(l,n+"background-",t),u=stringEvaluator(l,n+"font",t),d=numberEvaluator(l,n+"max-angle",t),f=numberEvaluator(l,n+"offset-x",t),g=numberEvaluator(l,n+"offset-y",t),_=booleanEvaluator(l,n+"overflow",t),m=stringEvaluator(l,n+"placement",t),p=numberEvaluator(l,n+"repeat",t),x=sizeLikeEvaluator(l,n+"scale",t),y=booleanEvaluator(l,n+"rotate-with-view",t),T=numberEvaluator(l,n+"rotation",t),S=stringEvaluator(l,n+"align",t),C=stringEvaluator(l,n+"justify",t),P=stringEvaluator(l,n+"baseline",t),w=booleanEvaluator(l,n+"keep-upright",t),I=numberArrayEvaluator(l,n+"padding",t),O=optionalDeclutterMode(l,n+"declutter-mode"),N=new Text({declutterMode:O});return function(k){if(N.setText(s(k)),o&&N.setFill(o(k)),a&&N.setBackgroundFill(a(k)),h&&N.setStroke(h(k)),c&&N.setBackgroundStroke(c(k)),u&&N.setFont(u(k)),d&&N.setMaxAngle(d(k)),f&&N.setOffsetX(f(k)),g&&N.setOffsetY(g(k)),_&&N.setOverflow(_(k)),m){const D=m(k);if(D!=="point"&&D!=="line")throw new Error("Expected point or line for text-placement");N.setPlacement(D)}if(p&&N.setRepeat(p(k)),x&&N.setScale(x(k)),y&&N.setRotateWithView(y(k)),T&&N.setRotation(T(k)),S){const D=S(k);if(D!=="left"&&D!=="center"&&D!=="right"&&D!=="end"&&D!=="start")throw new Error("Expected left, right, center, start, or end for text-align");N.setTextAlign(D)}if(C){const D=C(k);if(D!=="left"&&D!=="right"&&D!=="center")throw new Error("Expected left, right, or center for text-justify");N.setJustify(D)}if(P){const D=P(k);if(D!=="bottom"&&D!=="top"&&D!=="middle"&&D!=="alphabetic"&&D!=="hanging")throw new Error("Expected bottom, top, middle, alphabetic, or hanging for text-baseline");N.setTextBaseline(D)}return I&&N.setPadding(I(k)),w&&N.setKeepUpright(w(k)),N}}function buildImage(l,t){return"icon-src"in l?buildIcon(l,t):"shape-points"in l?buildShape(l,t):"circle-radius"in l?buildCircle(l,t):null}function buildIcon(l,t){const n="icon-",s=n+"src",o=requireString(l[s],s),a=coordinateEvaluator(l,n+"anchor",t),h=sizeLikeEvaluator(l,n+"scale",t),c=numberEvaluator(l,n+"opacity",t),u=coordinateEvaluator(l,n+"displacement",t),d=numberEvaluator(l,n+"rotation",t),f=booleanEvaluator(l,n+"rotate-with-view",t),g=optionalIconOrigin(l,n+"anchor-origin"),_=optionalIconAnchorUnits(l,n+"anchor-x-units"),m=optionalIconAnchorUnits(l,n+"anchor-y-units"),p=optionalColorLike(l,n+"color"),x=optionalString(l,n+"cross-origin"),y=optionalNumberArray(l,n+"offset"),T=optionalIconOrigin(l,n+"offset-origin"),S=optionalNumber(l,n+"width"),C=optionalNumber(l,n+"height"),P=optionalSize(l,n+"size"),w=optionalDeclutterMode(l,n+"declutter-mode"),I=new Icon({src:o,anchorOrigin:g,anchorXUnits:_,anchorYUnits:m,color:p,crossOrigin:x,offset:y,offsetOrigin:T,height:C,width:S,size:P,declutterMode:w});return function(O){return c&&I.setOpacity(c(O)),u&&I.setDisplacement(u(O)),d&&I.setRotation(d(O)),f&&I.setRotateWithView(f(O)),h&&I.setScale(h(O)),a&&I.setAnchor(a(O)),I}}function buildShape(l,t){const n="shape-",s=n+"points",o=n+"radius",a=requireNumber(l[s],s),h=requireNumber(l[o],o),c=buildFill(l,n,t),u=buildStroke(l,n,t),d=sizeLikeEvaluator(l,n+"scale",t),f=coordinateEvaluator(l,n+"displacement",t),g=numberEvaluator(l,n+"rotation",t),_=booleanEvaluator(l,n+"rotate-with-view",t),m=optionalNumber(l,n+"radius2"),p=optionalNumber(l,n+"angle"),x=optionalDeclutterMode(l,n+"declutter-mode"),y=new RegularShape({points:a,radius:h,radius2:m,angle:p,declutterMode:x});return function(T){return c&&y.setFill(c(T)),u&&y.setStroke(u(T)),f&&y.setDisplacement(f(T)),g&&y.setRotation(g(T)),_&&y.setRotateWithView(_(T)),d&&y.setScale(d(T)),y}}function buildCircle(l,t){const n="circle-",s=buildFill(l,n,t),o=buildStroke(l,n,t),a=numberEvaluator(l,n+"radius",t),h=sizeLikeEvaluator(l,n+"scale",t),c=coordinateEvaluator(l,n+"displacement",t),u=numberEvaluator(l,n+"rotation",t),d=booleanEvaluator(l,n+"rotate-with-view",t),f=optionalDeclutterMode(l,n+"declutter-mode"),g=new CircleStyle({radius:5,declutterMode:f});return function(_){return a&&g.setRadius(a(_)),s&&g.setFill(s(_)),o&&g.setStroke(o(_)),c&&g.setDisplacement(c(_)),u&&g.setRotation(u(_)),d&&g.setRotateWithView(d(_)),h&&g.setScale(h(_)),g}}function numberEvaluator(l,t,n){if(!(t in l))return;const s=buildExpression$1(l[t],NumberType,n);return function(o){return requireNumber(s(o),t)}}function stringEvaluator(l,t,n){if(!(t in l))return null;const s=buildExpression$1(l[t],StringType,n);return function(o){return requireString(s(o),t)}}function patternEvaluator(l,t,n){const s=stringEvaluator(l,t+"pattern-src",n),o=sizeEvaluator(l,t+"pattern-offset",n),a=sizeEvaluator(l,t+"pattern-size",n),h=colorLikeEvaluator(l,t+"color",n);return function(c){return{src:s(c),offset:o&&o(c),size:a&&a(c),color:h&&h(c)}}}function booleanEvaluator(l,t,n){if(!(t in l))return null;const s=buildExpression$1(l[t],BooleanType,n);return function(o){const a=s(o);if(typeof a!="boolean")throw new Error(`Expected a boolean for ${t}`);return a}}function colorLikeEvaluator(l,t,n){if(!(t in l))return null;const s=buildExpression$1(l[t],ColorType,n);return function(o){return requireColorLike(s(o),t)}}function numberArrayEvaluator(l,t,n){if(!(t in l))return null;const s=buildExpression$1(l[t],NumberArrayType,n);return function(o){return requireNumberArray(s(o),t)}}function coordinateEvaluator(l,t,n){if(!(t in l))return null;const s=buildExpression$1(l[t],NumberArrayType,n);return function(o){const a=requireNumberArray(s(o),t);if(a.length!==2)throw new Error(`Expected two numbers for ${t}`);return a}}function sizeEvaluator(l,t,n){if(!(t in l))return null;const s=buildExpression$1(l[t],NumberArrayType,n);return function(o){return requireSize(s(o),t)}}function sizeLikeEvaluator(l,t,n){if(!(t in l))return null;const s=buildExpression$1(l[t],NumberArrayType|NumberType,n);return function(o){return requireSizeLike(s(o),t)}}function optionalNumber(l,t){const n=l[t];if(n!==void 0){if(typeof n!="number")throw new Error(`Expected a number for ${t}`);return n}}function optionalSize(l,t){const n=l[t];if(n!==void 0){if(typeof n=="number")return toSize(n);if(!Array.isArray(n))throw new Error(`Expected a number or size array for ${t}`);if(n.length!==2||typeof n[0]!="number"||typeof n[1]!="number")throw new Error(`Expected a number or size array for ${t}`);return n}}function optionalString(l,t){const n=l[t];if(n!==void 0){if(typeof n!="string")throw new Error(`Expected a string for ${t}`);return n}}function optionalIconOrigin(l,t){const n=l[t];if(n!==void 0){if(n!=="bottom-left"&&n!=="bottom-right"&&n!=="top-left"&&n!=="top-right")throw new Error(`Expected bottom-left, bottom-right, top-left, or top-right for ${t}`);return n}}function optionalIconAnchorUnits(l,t){const n=l[t];if(n!==void 0){if(n!=="pixels"&&n!=="fraction")throw new Error(`Expected pixels or fraction for ${t}`);return n}}function optionalNumberArray(l,t){const n=l[t];if(n!==void 0)return requireNumberArray(n,t)}function optionalDeclutterMode(l,t){const n=l[t];if(n!==void 0){if(typeof n!="string")throw new Error(`Expected a string for ${t}`);if(n!=="declutter"&&n!=="obstacle"&&n!=="none")throw new Error(`Expected declutter, obstacle, or none for ${t}`);return n}}function optionalColorLike(l,t){const n=l[t];if(n!==void 0)return requireColorLike(n,t)}function requireNumberArray(l,t){if(!Array.isArray(l))throw new Error(`Expected an array for ${t}`);const n=l.length;for(let s=0;s<n;++s)if(typeof l[s]!="number")throw new Error(`Expected an array of numbers for ${t}`);return l}function requireString(l,t){if(typeof l!="string")throw new Error(`Expected a string for ${t}`);return l}function requireNumber(l,t){if(typeof l!="number")throw new Error(`Expected a number for ${t}`);return l}function requireColorLike(l,t){if(typeof l=="string")return l;const n=requireNumberArray(l,t),s=n.length;if(s<3||s>4)throw new Error(`Expected a color with 3 or 4 values for ${t}`);return n}function requireSize(l,t){const n=requireNumberArray(l,t);if(n.length!==2)throw new Error(`Expected an array of two numbers for ${t}`);return n}function requireSizeLike(l,t){return typeof l=="number"?l:requireSize(l,t)}const Property$3={RENDER_ORDER:"renderOrder"};class BaseVectorLayer extends Layer{constructor(t){t=t||{};const n=Object.assign({},t);delete n.style,delete n.renderBuffer,delete n.updateWhileAnimating,delete n.updateWhileInteracting,super(n),this.declutter_=t.declutter?String(t.declutter):void 0,this.renderBuffer_=t.renderBuffer!==void 0?t.renderBuffer:100,this.style_=null,this.styleFunction_=void 0,this.setStyle(t.style),this.updateWhileAnimating_=t.updateWhileAnimating!==void 0?t.updateWhileAnimating:!1,this.updateWhileInteracting_=t.updateWhileInteracting!==void 0?t.updateWhileInteracting:!1}getDeclutter(){return this.declutter_}getFeatures(t){return super.getFeatures(t)}getRenderBuffer(){return this.renderBuffer_}getRenderOrder(){return this.get(Property$3.RENDER_ORDER)}getStyle(){return this.style_}getStyleFunction(){return this.styleFunction_}getUpdateWhileAnimating(){return this.updateWhileAnimating_}getUpdateWhileInteracting(){return this.updateWhileInteracting_}renderDeclutter(t,n){const s=this.getDeclutter();s in t.declutter||(t.declutter[s]=new RBush$1(9)),this.getRenderer().renderDeclutter(t,n)}setRenderOrder(t){this.set(Property$3.RENDER_ORDER,t)}setStyle(t){this.style_=t===void 0?createDefaultStyle$1:t;const n=toStyleLike(t);this.styleFunction_=t===null?void 0:toFunction(n),this.changed()}setDeclutter(t){this.declutter_=t?String(t):void 0,this.changed()}}function toStyleLike(l){if(l===void 0)return createDefaultStyle$1;if(!l)return null;if(typeof l=="function"||l instanceof Style)return l;if(!Array.isArray(l))return flatStylesToStyleFunction([l]);if(l.length===0)return[];const t=l.length,n=l[0];if(n instanceof Style){const o=new Array(t);for(let a=0;a<t;++a){const h=l[a];if(!(h instanceof Style))throw new Error("Expected a list of style instances");o[a]=h}return o}if("style"in n){const o=new Array(t);for(let a=0;a<t;++a){const h=l[a];if(!("style"in h))throw new Error("Expected a list of rules with a style property");o[a]=h}return rulesToStyleFunction(o)}return flatStylesToStyleFunction(l)}class RenderEvent extends BaseEvent{constructor(t,n,s,o){super(t),this.inversePixelTransform=n,this.frameState=s,this.context=o}}class MapRenderer extends Disposable{constructor(t){super(),this.map_=t}dispatchRenderEvent(t,n){abstract()}calculateMatrices2D(t){const n=t.viewState,s=t.coordinateToPixelTransform,o=t.pixelToCoordinateTransform;compose(s,t.size[0]/2,t.size[1]/2,1/n.resolution,-1/n.resolution,-n.rotation,-n.center[0],-n.center[1]),makeInverse(o,s)}forEachFeatureAtCoordinate(t,n,s,o,a,h,c,u){let d;const f=n.viewState;function g(P,w,I,O){return a.call(h,w,P?I:null,O)}const _=f.projection,m=wrapX$1(t.slice(),_),p=[[0,0]];if(_.canWrapX()&&o){const P=_.getExtent(),w=getWidth(P);p.push([-w,0],[w,0])}const x=n.layerStatesArray,y=x.length,T=[],S=[];for(let P=0;P<p.length;P++)for(let w=y-1;w>=0;--w){const I=x[w],O=I.layer;if(O.hasRenderer()&&inView(I,f)&&c.call(u,O)){const N=O.getRenderer(),k=O.getSource();if(N&&k){const D=k.getWrapX()?m:t,ze=g.bind(null,I.managed);S[0]=D[0]+p[P][0],S[1]=D[1]+p[P][1],d=N.forEachFeatureAtCoordinate(S,n,s,ze,T)}if(d)return d}}if(T.length===0)return;const C=1/T.length;return T.forEach((P,w)=>P.distanceSq+=w*C),T.sort((P,w)=>P.distanceSq-w.distanceSq),T.some(P=>d=P.callback(P.feature,P.layer,P.geometry)),d}hasFeatureAtCoordinate(t,n,s,o,a,h){return this.forEachFeatureAtCoordinate(t,n,s,o,TRUE,this,a,h)!==void 0}getMap(){return this.map_}renderFrame(t){abstract()}scheduleExpireIconCache(t){shared.canExpireCache()&&t.postRenderFunctions.push(expireIconCache)}}function expireIconCache(l,t){shared.expire()}class CompositeMapRenderer extends MapRenderer{constructor(t){super(t),this.fontChangeListenerKey_=listen(checkedFonts,ObjectEventType.PROPERTYCHANGE,t.redrawText,t),this.element_=WORKER_OFFSCREEN_CANVAS?createMockDiv():document.createElement("div");const n=this.element_.style;n.position="absolute",n.width="100%",n.height="100%",n.zIndex="0",this.element_.className=CLASS_UNSELECTABLE+" ol-layers";const s=t.getViewport();s&&s.insertBefore(this.element_,s.firstChild||null),this.children_=[],this.renderedVisible_=!0}dispatchRenderEvent(t,n){const s=this.getMap();if(s.hasListener(t)){const o=new RenderEvent(t,void 0,n);s.dispatchEvent(o)}}disposeInternal(){unlistenByKey(this.fontChangeListenerKey_),this.element_.remove(),super.disposeInternal()}renderFrame(t){if(!t){this.renderedVisible_&&(this.element_.style.display="none",this.renderedVisible_=!1);return}this.calculateMatrices2D(t),this.dispatchRenderEvent(RenderEventType.PRECOMPOSE,t);const n=t.layerStatesArray.sort((d,f)=>d.zIndex-f.zIndex);n.some(d=>d.layer instanceof BaseVectorLayer&&d.layer.getDeclutter())&&(t.declutter={});const o=t.viewState;this.children_.length=0;const a=[];let h=null;for(let d=0,f=n.length;d<f;++d){const g=n[d];t.layerIndex=d;const _=g.layer,m=_.getSourceState();if(!inView(g,o)||m!="ready"&&m!="undefined"){_.unrender();continue}const p=_.render(t,h);p&&(p!==h&&(this.children_.push(p),h=p),a.push(g))}this.declutter(t,a),replaceChildren(this.element_,this.children_);const u=this.getMap().getTargetElement();if(isCanvas(u)){const d=u.getContext("2d");for(const f of this.children_){const g=f.firstElementChild||f,_=f.style.backgroundColor;if(_&&(!isCanvas(g)||g.width>0)&&(d.fillStyle=_,d.fillRect(0,0,u.width,u.height)),isCanvas(g)&&g.width>0){const m=f.style.opacity||g.style.opacity;d.globalAlpha=m===""?1:Number(m);const p=g.style.transform;if(p)d.setTransform(...fromString$1(p));else{const x=parseFloat(g.style.width)/g.width,y=parseFloat(g.style.height)/g.height;d.setTransform(x,0,0,y,0,0)}d.drawImage(g,0,0)}}d.globalAlpha=1,d.setTransform(1,0,0,1,0,0)}this.dispatchRenderEvent(RenderEventType.POSTCOMPOSE,t),this.renderedVisible_||(this.element_.style.display="",this.renderedVisible_=!0),this.scheduleExpireIconCache(t)}declutter(t,n){if(t.declutter){for(let s=n.length-1;s>=0;--s){const o=n[s],a=o.layer;a.getDeclutter()&&a.renderDeclutter(t,o)}n.forEach(s=>s.layer.renderDeferred(t))}}}function removeLayerMapProperty(l){if(l instanceof Layer){l.setMapInternal(null);return}l instanceof LayerGroup&&l.getLayers().forEach(removeLayerMapProperty)}function setLayerMapProperty(l,t){if(l instanceof Layer){l.setMapInternal(t);return}if(l instanceof LayerGroup){const n=l.getLayers().getArray();for(let s=0,o=n.length;s<o;++s)setLayerMapProperty(n[s],t)}}let Map$1=class extends BaseObject{constructor(t){super(),t=t||{},this.on,this.once,this.un;const n=createOptionsInternal(t);this.renderComplete_=!1,this.loaded_=!0,this.boundHandleBrowserEvent_=this.handleBrowserEvent.bind(this),this.maxTilesLoading_=t.maxTilesLoading!==void 0?t.maxTilesLoading:16,this.pixelRatio_=t.pixelRatio!==void 0?t.pixelRatio:DEVICE_PIXEL_RATIO,this.postRenderTimeoutHandle_,this.animationDelayKey_,this.animationDelay_=this.animationDelay_.bind(this),this.coordinateToPixelTransform_=create$2(),this.pixelToCoordinateTransform_=create$2(),this.frameIndex_=0,this.frameState_=null,this.previousExtent_=null,this.viewPropertyListenerKey_=null,this.viewChangeListenerKey_=null,this.layerGroupPropertyListenerKeys_=null,WORKER_OFFSCREEN_CANVAS||(this.viewport_=document.createElement("div"),this.viewport_.className="ol-viewport"+("ontouchstart"in window?" ol-touch":""),this.viewport_.style.position="relative",this.viewport_.style.overflow="hidden",this.viewport_.style.width="100%",this.viewport_.style.height="100%",this.overlayContainer_=document.createElement("div"),this.overlayContainer_.style.position="absolute",this.overlayContainer_.style.zIndex="0",this.overlayContainer_.style.width="100%",this.overlayContainer_.style.height="100%",this.overlayContainer_.style.pointerEvents="none",this.overlayContainer_.className="ol-overlaycontainer",this.viewport_.appendChild(this.overlayContainer_),this.overlayContainerStopEvent_=document.createElement("div"),this.overlayContainerStopEvent_.style.position="absolute",this.overlayContainerStopEvent_.style.zIndex="0",this.overlayContainerStopEvent_.style.width="100%",this.overlayContainerStopEvent_.style.height="100%",this.overlayContainerStopEvent_.style.pointerEvents="none",this.overlayContainerStopEvent_.className="ol-overlaycontainer-stopevent",this.viewport_.appendChild(this.overlayContainerStopEvent_)),this.mapBrowserEventHandler_=null,this.moveTolerance_=t.moveTolerance,this.keyboardEventTarget_=n.keyboardEventTarget,this.targetChangeHandlerKeys_=null,this.targetElement_=null,WORKER_OFFSCREEN_CANVAS||(this.resizeObserver_=new ResizeObserver(()=>this.updateSize())),this.controls=n.controls||(WORKER_OFFSCREEN_CANVAS?new Collection:defaults$1()),this.interactions=n.interactions||(WORKER_OFFSCREEN_CANVAS?new Collection:defaults({onFocusOnly:!0})),this.overlays_=n.overlays,this.overlayIdIndex_={},this.renderer_=null,this.postRenderFunctions_=[],this.tileQueue_=new TileQueue(this.getTilePriority.bind(this),this.handleTileChange_.bind(this)),this.addChangeListener(MapProperty.LAYERGROUP,this.handleLayerGroupChanged_),this.addChangeListener(MapProperty.VIEW,this.handleViewChanged_),this.addChangeListener(MapProperty.SIZE,this.handleSizeChanged_),this.addChangeListener(MapProperty.TARGET,this.handleTargetChanged_),this.setProperties(n.values);const s=this;t.view&&!(t.view instanceof View)&&t.view.then(function(o){s.setView(new View(o))}),this.controls.addEventListener(CollectionEventType.ADD,o=>{o.element.setMap(this)}),this.controls.addEventListener(CollectionEventType.REMOVE,o=>{o.element.setMap(null)}),this.interactions.addEventListener(CollectionEventType.ADD,o=>{o.element.setMap(this)}),this.interactions.addEventListener(CollectionEventType.REMOVE,o=>{o.element.setMap(null)}),this.overlays_.addEventListener(CollectionEventType.ADD,o=>{this.addOverlayInternal_(o.element)}),this.overlays_.addEventListener(CollectionEventType.REMOVE,o=>{const a=o.element.getId();a!==void 0&&delete this.overlayIdIndex_[a.toString()],o.element.setMap(null)}),this.controls.forEach(o=>{o.setMap(this)}),this.interactions.forEach(o=>{o.setMap(this)}),this.overlays_.forEach(this.addOverlayInternal_.bind(this))}addControl(t){this.getControls().push(t)}addInteraction(t){this.getInteractions().push(t)}addLayer(t){this.getLayerGroup().getLayers().push(t)}handleLayerAdd_(t){setLayerMapProperty(t.layer,this)}addOverlay(t){this.getOverlays().push(t)}addOverlayInternal_(t){const n=t.getId();n!==void 0&&(this.overlayIdIndex_[n.toString()]=t),t.setMap(this)}disposeInternal(){var t;this.controls.clear(),this.interactions.clear(),this.overlays_.clear(),(t=this.resizeObserver_)==null||t.disconnect(),this.setTarget(null),super.disposeInternal()}forEachFeatureAtPixel(t,n,s){if(!this.frameState_||!this.renderer_)return;const o=this.getCoordinateFromPixelInternal(t);s=s!==void 0?s:{};const a=s.hitTolerance!==void 0?s.hitTolerance:0,h=s.layerFilter!==void 0?s.layerFilter:TRUE,c=s.checkWrapped!==!1;return this.renderer_.forEachFeatureAtCoordinate(o,this.frameState_,a,c,n,null,h,null)}getFeaturesAtPixel(t,n){const s=[];return this.forEachFeatureAtPixel(t,function(o){s.push(o)},n),s}getAllLayers(){const t=[];function n(s){s.forEach(function(o){o instanceof LayerGroup?n(o.getLayers()):t.push(o)})}return n(this.getLayers()),t}hasFeatureAtPixel(t,n){if(!this.frameState_||!this.renderer_)return!1;const s=this.getCoordinateFromPixelInternal(t);n=n!==void 0?n:{};const o=n.layerFilter!==void 0?n.layerFilter:TRUE,a=n.hitTolerance!==void 0?n.hitTolerance:0,h=n.checkWrapped!==!1;return this.renderer_.hasFeatureAtCoordinate(s,this.frameState_,a,h,o,null)}getEventCoordinate(t){return this.getCoordinateFromPixel(this.getEventPixel(t))}getEventCoordinateInternal(t){return this.getCoordinateFromPixelInternal(this.getEventPixel(t))}getEventPixel(t){const s=this.viewport_.getBoundingClientRect(),o=this.getSize(),a=s.width/o[0],h=s.height/o[1],c="changedTouches"in t?t.changedTouches[0]:t;return[(c.clientX-s.left)/a,(c.clientY-s.top)/h]}getTarget(){return this.get(MapProperty.TARGET)}getTargetElement(){return this.targetElement_}getCoordinateFromPixel(t){return toUserCoordinate(this.getCoordinateFromPixelInternal(t),this.getView().getProjection())}getCoordinateFromPixelInternal(t){const n=this.frameState_;return n?apply(n.pixelToCoordinateTransform,t.slice()):null}getControls(){return this.controls}getOverlays(){return this.overlays_}getOverlayById(t){const n=this.overlayIdIndex_[t.toString()];return n!==void 0?n:null}getInteractions(){return this.interactions}getLayerGroup(){return this.get(MapProperty.LAYERGROUP)}setLayers(t){const n=this.getLayerGroup();if(t instanceof Collection){n.setLayers(t);return}const s=n.getLayers();s.clear(),s.extend(t)}getLayers(){return this.getLayerGroup().getLayers()}getLoadingOrNotReady(){const t=this.getLayerGroup().getLayerStatesArray();for(let n=0,s=t.length;n<s;++n){const o=t[n];if(!o.visible)continue;const a=o.layer.getRenderer();if(a&&!a.ready)return!0;const h=o.layer.getSource();if(h&&h.loading)return!0}return!1}getPixelFromCoordinate(t){const n=fromUserCoordinate(t,this.getView().getProjection());return this.getPixelFromCoordinateInternal(n)}getPixelFromCoordinateInternal(t){const n=this.frameState_;return n?apply(n.coordinateToPixelTransform,t.slice(0,2)):null}getRenderer(){return this.renderer_}getSize(){return this.get(MapProperty.SIZE)}getView(){return this.get(MapProperty.VIEW)}getViewport(){return this.viewport_}getOverlayContainer(){return this.overlayContainer_}getOverlayContainerStopEvent(){return this.overlayContainerStopEvent_}getOwnerDocument(){const t=this.getTargetElement();return t?t.ownerDocument:document}getTilePriority(t,n,s,o){return getTilePriority(this.frameState_,t,n,s,o)}handleBrowserEvent(t,n){n=n||t.type;const s=new MapBrowserEvent(n,this,t);this.handleMapBrowserEvent(s)}handleMapBrowserEvent(t){if(!this.frameState_)return;const n=t.originalEvent,s=n.type;if(s===EventType.POINTERDOWN||s===EventType$1.WHEEL||s===EventType$1.KEYDOWN){const o=this.getOwnerDocument(),a=this.viewport_.getRootNode?this.viewport_.getRootNode():o,h=n.target,c=a instanceof ShadowRoot?a.host===h?a.host.ownerDocument:a:a===o?o.documentElement:a;if(this.overlayContainerStopEvent_.contains(h)||!c.contains(h))return}if(t.frameState=this.frameState_,this.dispatchEvent(t)!==!1){const o=this.getInteractions().getArray().slice();for(let a=o.length-1;a>=0;a--){const h=o[a];if(h.getMap()!==this||!h.getActive()||!this.getTargetElement())continue;if(!h.handleEvent(t)||t.propagationStopped)break}}}handlePostRender(){const t=this.frameState_,n=this.tileQueue_;if(!n.isEmpty()){let o=this.maxTilesLoading_,a=o;if(t){const h=t.viewHints;if(h[ViewHint.ANIMATING]||h[ViewHint.INTERACTING]){const c=Date.now()-t.time>8;o=c?0:8,a=c?0:2}}n.getTilesLoading()<o&&(n.reprioritize(),n.loadMoreTiles(o,a))}t&&this.renderer_&&!t.animate&&(this.renderComplete_?(this.hasListener(RenderEventType.RENDERCOMPLETE)&&this.renderer_.dispatchRenderEvent(RenderEventType.RENDERCOMPLETE,t),this.loaded_===!1&&(this.loaded_=!0,this.dispatchEvent(new MapEvent(MapEventType.LOADEND,this,t)))):this.loaded_===!0&&(this.loaded_=!1,this.dispatchEvent(new MapEvent(MapEventType.LOADSTART,this,t))));const s=this.postRenderFunctions_;if(t)for(let o=0,a=s.length;o<a;++o)s[o](this,t);s.length=0}handleSizeChanged_(){this.getView()&&!this.getView().getAnimating()&&this.getView().resolveConstraints(0),this.render()}handleTargetChanged_(){var s,o;if(this.mapBrowserEventHandler_){for(let a=0,h=this.targetChangeHandlerKeys_.length;a<h;++a)unlistenByKey(this.targetChangeHandlerKeys_[a]);this.targetChangeHandlerKeys_=null,this.viewport_.removeEventListener(EventType$1.CONTEXTMENU,this.boundHandleBrowserEvent_),this.viewport_.removeEventListener(EventType$1.WHEEL,this.boundHandleBrowserEvent_),this.mapBrowserEventHandler_.dispose(),this.mapBrowserEventHandler_=null,this.viewport_.remove()}if(this.targetElement_&&!isCanvas(this.targetElement_)){(s=this.resizeObserver_)==null||s.unobserve(this.targetElement_);const a=this.targetElement_.getRootNode();a instanceof ShadowRoot&&this.resizeObserver_.unobserve(a.host),this.setSize(void 0)}const t=this.getTarget(),n=typeof t=="string"?document.getElementById(t):t;if(this.targetElement_=n,!n)this.renderer_&&(clearTimeout(this.postRenderTimeoutHandle_),this.postRenderTimeoutHandle_=void 0,this.postRenderFunctions_.length=0,this.renderer_.dispose(),this.renderer_=null),this.animationDelayKey_&&(cancelAnimationFrame(this.animationDelayKey_),this.animationDelayKey_=void 0);else{if(isCanvas(n)||n.appendChild(this.viewport_),this.renderer_||(this.renderer_=new CompositeMapRenderer(this)),!isCanvas(n)){this.mapBrowserEventHandler_=new MapBrowserEventHandler(this,this.moveTolerance_);for(const h in MapBrowserEventType)this.mapBrowserEventHandler_.addEventListener(MapBrowserEventType[h],this.handleMapBrowserEvent.bind(this));this.viewport_.addEventListener(EventType$1.CONTEXTMENU,this.boundHandleBrowserEvent_,!1),this.viewport_.addEventListener(EventType$1.WHEEL,this.boundHandleBrowserEvent_,PASSIVE_EVENT_LISTENERS?{passive:!1}:!1);let a;if(this.keyboardEventTarget_)a=this.keyboardEventTarget_;else{const h=n.getRootNode();a=h instanceof ShadowRoot?h.host:n}if(this.targetChangeHandlerKeys_=[listen(a,EventType$1.KEYDOWN,this.handleBrowserEvent,this),listen(a,EventType$1.KEYPRESS,this.handleBrowserEvent,this)],n instanceof HTMLElement){const h=n.getRootNode();h instanceof ShadowRoot&&this.resizeObserver_.observe(h.host),(o=this.resizeObserver_)==null||o.observe(n)}}this.updateSize()}}handleTileChange_(){this.render()}handleViewPropertyChanged_(){this.render()}handleViewChanged_(){this.viewPropertyListenerKey_&&(unlistenByKey(this.viewPropertyListenerKey_),this.viewPropertyListenerKey_=null),this.viewChangeListenerKey_&&(unlistenByKey(this.viewChangeListenerKey_),this.viewChangeListenerKey_=null);const t=this.getView();t&&(this.updateViewportSize_(this.getSize()),this.viewPropertyListenerKey_=listen(t,ObjectEventType.PROPERTYCHANGE,this.handleViewPropertyChanged_,this),this.viewChangeListenerKey_=listen(t,EventType$1.CHANGE,this.handleViewPropertyChanged_,this),t.resolveConstraints(0)),this.render()}handleLayerGroupChanged_(){this.layerGroupPropertyListenerKeys_&&(this.layerGroupPropertyListenerKeys_.forEach(unlistenByKey),this.layerGroupPropertyListenerKeys_=null);const t=this.getLayerGroup();t&&(this.handleLayerAdd_(new GroupEvent("addlayer",t)),this.layerGroupPropertyListenerKeys_=[listen(t,ObjectEventType.PROPERTYCHANGE,this.render,this),listen(t,EventType$1.CHANGE,this.render,this),listen(t,"addlayer",this.handleLayerAdd_,this),listen(t,"removelayer",this.handleLayerRemove_,this)]),this.render()}isRendered(){return!!this.frameState_}animationDelay_(){this.animationDelayKey_=void 0,this.renderFrame_(Date.now())}renderSync(){this.animationDelayKey_&&cancelAnimationFrame(this.animationDelayKey_),this.animationDelay_()}redrawText(){if(!this.frameState_)return;const t=this.frameState_.layerStatesArray;for(let n=0,s=t.length;n<s;++n){const o=t[n].layer;o.hasRenderer()&&o.getRenderer().handleFontsChanged()}}render(){this.renderer_&&this.animationDelayKey_===void 0&&(this.animationDelayKey_=requestAnimationFrame(this.animationDelay_))}removeControl(t){return this.getControls().remove(t)}removeInteraction(t){return this.getInteractions().remove(t)}removeLayer(t){return this.getLayerGroup().getLayers().remove(t)}handleLayerRemove_(t){removeLayerMapProperty(t.layer)}removeOverlay(t){return this.getOverlays().remove(t)}renderFrame_(t){const n=this.getSize(),s=this.getView(),o=this.frameState_;let a=null;if(n!==void 0&&hasArea(n)&&s&&s.isDef()){const h=s.getHints(this.frameState_?this.frameState_.viewHints:void 0),c=s.getState();if(a={animate:!1,coordinateToPixelTransform:this.coordinateToPixelTransform_,declutter:null,extent:getForViewAndSize(c.center,c.resolution,c.rotation,n),index:this.frameIndex_++,layerIndex:0,layerStatesArray:this.getLayerGroup().getLayerStatesArray(),pixelRatio:this.pixelRatio_,pixelToCoordinateTransform:this.pixelToCoordinateTransform_,postRenderFunctions:[],size:n,tileQueue:this.tileQueue_,time:t,usedTiles:{},viewState:c,viewHints:h,wantedTiles:{},mapId:getUid(this),renderTargets:{}},c.nextCenter&&c.nextResolution){const u=isNaN(c.nextRotation)?c.rotation:c.nextRotation;a.nextExtent=getForViewAndSize(c.nextCenter,c.nextResolution,u,n)}}this.frameState_=a,this.renderer_.renderFrame(a),a&&(a.animate&&this.render(),Array.prototype.push.apply(this.postRenderFunctions_,a.postRenderFunctions),o&&(!this.previousExtent_||!isEmpty(this.previousExtent_)&&!equals$1(a.extent,this.previousExtent_))&&(this.dispatchEvent(new MapEvent(MapEventType.MOVESTART,this,o)),this.previousExtent_=createOrUpdateEmpty(this.previousExtent_)),this.previousExtent_&&!a.viewHints[ViewHint.ANIMATING]&&!a.viewHints[ViewHint.INTERACTING]&&!equals$1(a.extent,this.previousExtent_)&&(this.dispatchEvent(new MapEvent(MapEventType.MOVEEND,this,a)),clone(a.extent,this.previousExtent_))),this.dispatchEvent(new MapEvent(MapEventType.POSTRENDER,this,a)),this.renderComplete_=(this.hasListener(MapEventType.LOADSTART)||this.hasListener(MapEventType.LOADEND)||this.hasListener(RenderEventType.RENDERCOMPLETE))&&!this.tileQueue_.getTilesLoading()&&!this.tileQueue_.getCount()&&!this.getLoadingOrNotReady(),this.postRenderTimeoutHandle_||(this.postRenderTimeoutHandle_=setTimeout(()=>{this.postRenderTimeoutHandle_=void 0,this.handlePostRender()},0))}setLayerGroup(t){const n=this.getLayerGroup();n&&this.handleLayerRemove_(new GroupEvent("removelayer",n)),this.set(MapProperty.LAYERGROUP,t)}setSize(t){this.set(MapProperty.SIZE,t)}setTarget(t){this.set(MapProperty.TARGET,t)}setView(t){if(!t||t instanceof View){this.set(MapProperty.VIEW,t);return}this.set(MapProperty.VIEW,new View);const n=this;t.then(function(s){n.setView(new View(s))})}updateSize(){const t=this.getTargetElement();let n;if(t){let o,a;if(isCanvas(t))o=t.width,a=t.height;else{const h=getComputedStyle(t);o=t.offsetWidth-parseFloat(h.borderLeftWidth)-parseFloat(h.paddingLeft)-parseFloat(h.paddingRight)-parseFloat(h.borderRightWidth),a=t.offsetHeight-parseFloat(h.borderTopWidth)-parseFloat(h.paddingTop)-parseFloat(h.paddingBottom)-parseFloat(h.borderBottomWidth)}!isNaN(o)&&!isNaN(a)&&(n=[Math.max(0,o),Math.max(0,a)],!hasArea(n)&&(t.offsetWidth||t.offsetHeight||t.getClientRects().length)&&warn("No map visible because the map container's width or height are 0."))}const s=this.getSize();n&&(!s||!equals$2(n,s))&&(this.setSize(n),this.updateViewportSize_(n))}updateViewportSize_(t){const n=this.getView();n&&n.setViewportSize(t)}};function createOptionsInternal(l){let t=null;l.keyboardEventTarget!==void 0&&(t=typeof l.keyboardEventTarget=="string"?document.getElementById(l.keyboardEventTarget):l.keyboardEventTarget);const n={},s=l.layers&&typeof l.layers.getLayers=="function"?l.layers:new LayerGroup({layers:l.layers});n[MapProperty.LAYERGROUP]=s,n[MapProperty.TARGET]=l.target,n[MapProperty.VIEW]=l.view instanceof View?l.view:new View;let o;l.controls!==void 0&&(Array.isArray(l.controls)?o=new Collection(l.controls.slice()):(assert(typeof l.controls.getArray=="function","Expected `controls` to be an array or an `ol/Collection.js`"),o=l.controls));let a;l.interactions!==void 0&&(Array.isArray(l.interactions)?a=new Collection(l.interactions.slice()):(assert(typeof l.interactions.getArray=="function","Expected `interactions` to be an array or an `ol/Collection.js`"),a=l.interactions));let h;return l.overlays!==void 0?Array.isArray(l.overlays)?h=new Collection(l.overlays.slice()):(assert(typeof l.overlays.getArray=="function","Expected `overlays` to be an array or an `ol/Collection.js`"),h=l.overlays):h=new Collection,{controls:o,interactions:a,keyboardEventTarget:t,overlays:h,values:n}}const olCss=':root,:host{--ol-background-color: white;--ol-accent-background-color: #F5F5F5;--ol-subtle-background-color: rgba(128, 128, 128, .25);--ol-partial-background-color: rgba(255, 255, 255, .75);--ol-foreground-color: #333333;--ol-subtle-foreground-color: #666666;--ol-brand-color: #00AAFF}.ol-box{box-sizing:border-box;border-radius:2px;border:1.5px solid var(--ol-background-color);background-color:var(--ol-partial-background-color)}.ol-mouse-position{top:8px;right:8px;position:absolute}.ol-scale-line{background:var(--ol-partial-background-color);border-radius:4px;bottom:8px;left:8px;padding:2px;position:absolute}.ol-scale-line-inner{border:1px solid var(--ol-subtle-foreground-color);border-top:none;color:var(--ol-foreground-color);font-size:10px;text-align:center;margin:1px;will-change:contents,width;transition:all .25s}.ol-scale-bar{position:absolute;bottom:8px;left:8px}.ol-scale-bar-inner{display:flex}.ol-scale-step-marker{width:1px;height:15px;background-color:var(--ol-foreground-color);float:right;z-index:10}.ol-scale-step-text{position:absolute;bottom:-5px;font-size:10px;z-index:11;color:var(--ol-foreground-color);text-shadow:-1.5px 0 var(--ol-partial-background-color),0 1.5px var(--ol-partial-background-color),1.5px 0 var(--ol-partial-background-color),0 -1.5px var(--ol-partial-background-color)}.ol-scale-text{position:absolute;font-size:12px;text-align:center;bottom:25px;color:var(--ol-foreground-color);text-shadow:-1.5px 0 var(--ol-partial-background-color),0 1.5px var(--ol-partial-background-color),1.5px 0 var(--ol-partial-background-color),0 -1.5px var(--ol-partial-background-color)}.ol-scale-singlebar{position:relative;height:10px;z-index:9;box-sizing:border-box;border:1px solid var(--ol-foreground-color)}.ol-scale-singlebar-even{background-color:var(--ol-subtle-foreground-color)}.ol-scale-singlebar-odd{background-color:var(--ol-background-color)}.ol-unsupported{display:none}.ol-viewport,.ol-unselectable{-webkit-touch-callout:none;-webkit-user-select:none;-moz-user-select:none;user-select:none;-webkit-tap-highlight-color:transparent}.ol-viewport canvas{all:unset;overflow:hidden}.ol-viewport{touch-action:pan-x pan-y}.ol-selectable{-webkit-touch-callout:default;-webkit-user-select:text;-moz-user-select:text;user-select:text}.ol-grabbing{cursor:-webkit-grabbing;cursor:-moz-grabbing;cursor:grabbing}.ol-grab{cursor:move;cursor:-webkit-grab;cursor:-moz-grab;cursor:grab}.ol-control{position:absolute;background-color:var(--ol-subtle-background-color);border-radius:4px}.ol-zoom{top:.5em;left:.5em}.ol-rotate{top:.5em;right:.5em;transition:opacity .25s linear,visibility 0s linear}.ol-rotate.ol-hidden{opacity:0;visibility:hidden;transition:opacity .25s linear,visibility 0s linear .25s}.ol-zoom-extent{top:4.643em;left:.5em}.ol-full-screen{right:.5em;top:.5em}.ol-control button{display:block;margin:1px;padding:0;color:var(--ol-subtle-foreground-color);font-weight:700;text-decoration:none;font-size:inherit;text-align:center;height:1.375em;width:1.375em;line-height:.4em;background-color:var(--ol-background-color);border:none;border-radius:2px}.ol-control button::-moz-focus-inner{border:none;padding:0}.ol-zoom-extent button{line-height:1.4em}.ol-compass{display:block;font-weight:400;will-change:transform}.ol-touch .ol-control button{font-size:1.5em}.ol-touch .ol-zoom-extent{top:5.5em}.ol-control button:hover,.ol-control button:focus{text-decoration:none;outline:1px solid var(--ol-subtle-foreground-color);color:var(--ol-foreground-color)}.ol-zoom .ol-zoom-in{border-radius:2px 2px 0 0}.ol-zoom .ol-zoom-out{border-radius:0 0 2px 2px}.ol-attribution{text-align:right;bottom:.5em;right:.5em;max-width:calc(100% - 1.3em);display:flex;flex-flow:row-reverse;align-items:center}.ol-attribution a{color:var(--ol-subtle-foreground-color);text-decoration:none}.ol-attribution ul{margin:0;padding:1px .5em;color:var(--ol-foreground-color);text-shadow:0 0 2px var(--ol-background-color);font-size:12px}.ol-attribution li{display:inline;list-style:none}.ol-attribution li:not(:last-child):after{content:" "}.ol-attribution img{max-height:2em;max-width:inherit;vertical-align:middle}.ol-attribution button{flex-shrink:0}.ol-attribution.ol-collapsed ul{display:none}.ol-attribution:not(.ol-collapsed){background:var(--ol-partial-background-color)}.ol-attribution.ol-uncollapsible{bottom:0;right:0;border-radius:4px 0 0}.ol-attribution.ol-uncollapsible img{margin-top:-.2em;max-height:1.6em}.ol-attribution.ol-uncollapsible button{display:none}.ol-zoomslider{top:4.5em;left:.5em;height:200px}.ol-zoomslider button{position:relative;height:10px}.ol-touch .ol-zoomslider{top:5.5em}.ol-overviewmap{left:.5em;bottom:.5em}.ol-overviewmap.ol-uncollapsible{bottom:0;left:0;border-radius:0 4px 0 0}.ol-overviewmap .ol-overviewmap-map,.ol-overviewmap button{display:block}.ol-overviewmap .ol-overviewmap-map{border:1px solid var(--ol-subtle-foreground-color);height:150px;width:150px}.ol-overviewmap:not(.ol-collapsed) button{bottom:0;left:0;position:absolute}.ol-overviewmap.ol-collapsed .ol-overviewmap-map,.ol-overviewmap.ol-uncollapsible button{display:none}.ol-overviewmap:not(.ol-collapsed){background:var(--ol-subtle-background-color)}.ol-overviewmap-box{border:1.5px dotted var(--ol-subtle-foreground-color)}.ol-overviewmap .ol-overviewmap-box:hover{cursor:move}.ol-overviewmap .ol-viewport:hover{cursor:pointer}';class Feature extends BaseObject{constructor(t){if(super(),this.on,this.once,this.un,this.id_=void 0,this.geometryName_="geometry",this.style_=null,this.styleFunction_=void 0,this.geometryChangeKey_=null,this.addChangeListener(this.geometryName_,this.handleGeometryChanged_),t)if(typeof t.getSimplifiedGeometry=="function"){const n=t;this.setGeometry(n)}else{const n=t;this.setProperties(n)}}clone(){const t=new Feature(this.hasProperties()?this.getProperties():null);t.setGeometryName(this.getGeometryName());const n=this.getGeometry();n&&t.setGeometry(n.clone());const s=this.getStyle();return s&&t.setStyle(s),t}getGeometry(){return this.get(this.geometryName_)}getId(){return this.id_}getGeometryName(){return this.geometryName_}getStyle(){return this.style_}getStyleFunction(){return this.styleFunction_}handleGeometryChange_(){this.changed()}handleGeometryChanged_(){this.geometryChangeKey_&&(unlistenByKey(this.geometryChangeKey_),this.geometryChangeKey_=null);const t=this.getGeometry();t&&(this.geometryChangeKey_=listen(t,EventType$1.CHANGE,this.handleGeometryChange_,this)),this.changed()}setGeometry(t){this.set(this.geometryName_,t)}setStyle(t){this.style_=t,this.styleFunction_=t?createStyleFunction(t):void 0,this.changed()}setId(t){this.id_=t,this.changed()}setGeometryName(t){this.removeChangeListener(this.geometryName_,this.handleGeometryChanged_),this.geometryName_=t,this.addChangeListener(this.geometryName_,this.handleGeometryChanged_),this.handleGeometryChanged_()}}function createStyleFunction(l){if(typeof l=="function")return l;let t;return Array.isArray(l)?t=l:(assert(typeof l.getZIndex=="function","Expected an `ol/style/Style` or an array of `ol/style/Style.js`"),t=[l]),function(){return t}}class Circle extends SimpleGeometry{constructor(t,n,s){super(),s!==void 0&&n===void 0?this.setFlatCoordinates(s,t):(n=n||0,this.setCenterAndRadius(t,n,s))}clone(){const t=new Circle(this.flatCoordinates.slice(),void 0,this.layout);return t.applyProperties(this),t}closestPointXY(t,n,s,o){const a=this.flatCoordinates,h=t-a[0],c=n-a[1],u=h*h+c*c;if(u<o){if(u===0)for(let d=0;d<this.stride;++d)s[d]=a[d];else{const d=this.getRadius()/Math.sqrt(u);s[0]=a[0]+d*h,s[1]=a[1]+d*c;for(let f=2;f<this.stride;++f)s[f]=a[f]}return s.length=this.stride,u}return o}containsXY(t,n){const s=this.flatCoordinates,o=t-s[0],a=n-s[1];return o*o+a*a<=this.getRadiusSquared_()}getCenter(){return this.flatCoordinates.slice(0,this.stride)}computeExtent(t){const n=this.flatCoordinates,s=n[this.stride]-n[0];return createOrUpdate$2(n[0]-s,n[1]-s,n[0]+s,n[1]+s,t)}getRadius(){return Math.sqrt(this.getRadiusSquared_())}getRadiusSquared_(){const t=this.flatCoordinates[this.stride]-this.flatCoordinates[0],n=this.flatCoordinates[this.stride+1]-this.flatCoordinates[1];return t*t+n*n}getType(){return"Circle"}intersectsExtent(t){const n=this.getExtent();if(intersects$1(t,n)){const s=this.getCenter();return t[0]<=s[0]&&t[2]>=s[0]||t[1]<=s[1]&&t[3]>=s[1]?!0:forEachCorner(t,this.intersectsCoordinate.bind(this))}return!1}setCenter(t){const n=this.stride,s=this.flatCoordinates[n]-this.flatCoordinates[0],o=t.slice();o[n]=o[0]+s;for(let a=1;a<n;++a)o[n+a]=t[a];this.setFlatCoordinates(this.layout,o),this.changed()}setCenterAndRadius(t,n,s){this.setLayout(s,t,0),this.flatCoordinates||(this.flatCoordinates=[]);const o=this.flatCoordinates;let a=deflateCoordinate(o,0,t,this.stride);o[a++]=o[0]+n;for(let h=1,c=this.stride;h<c;++h)o[a++]=o[h];o.length=a,this.changed()}getCoordinates(){return null}setCoordinates(t,n){}setRadius(t){this.flatCoordinates[this.stride]=this.flatCoordinates[0]+t,this.changed()}rotate(t,n){const s=this.getCenter(),o=this.getStride();this.setCenter(rotate(s,0,s.length,o,t,n,s)),this.changed()}}Circle.prototype.transform;function interpolatePoint(l,t,n,s,o,a,h){let c,u;const d=(n-t)/s;if(d===1)c=t;else if(d===2)c=t,u=o;else if(d!==0){let f=l[t],g=l[t+1],_=0;const m=[0];for(let y=t+s;y<n;y+=s){const T=l[y],S=l[y+1];_+=Math.sqrt((T-f)*(T-f)+(S-g)*(S-g)),m.push(_),f=T,g=S}const p=o*_,x=binarySearch(m,p);x<0?(u=(p-m[-x-2])/(m[-x-1]-m[-x-2]),c=t+(-x-2)*s):c=t+x*s}h=h>1?h:2,a=a||new Array(h);for(let f=0;f<h;++f)a[f]=c===void 0?NaN:u===void 0?l[c+f]:lerp(l[c+f],l[c+s+f],u);return a}function lineStringCoordinateAtM(l,t,n,s,o,a){if(n==t)return null;let h;if(o<l[t+s-1])return a?(h=l.slice(t,t+s),h[s-1]=o,h):null;if(l[n-1]<o)return a?(h=l.slice(n-s,n),h[s-1]=o,h):null;if(o==l[t+s-1])return l.slice(t,t+s);let c=t/s,u=n/s;for(;c<u;){const _=c+u>>1;o<l[(_+1)*s-1]?u=_:c=_+1}const d=l[c*s-1];if(o==d)return l.slice((c-1)*s,(c-1)*s+s);const f=l[(c+1)*s-1],g=(o-d)/(f-d);h=[];for(let _=0;_<s-1;++_)h.push(lerp(l[(c-1)*s+_],l[c*s+_],g));return h.push(o),h}function lineStringsCoordinateAtM(l,t,n,s,o,a,h){if(h)return lineStringCoordinateAtM(l,t,n[n.length-1],s,o,a);let c;if(o<l[s-1])return a?(c=l.slice(0,s),c[s-1]=o,c):null;if(l[l.length-1]<o)return a?(c=l.slice(l.length-s),c[s-1]=o,c):null;for(let u=0,d=n.length;u<d;++u){const f=n[u];if(t!=f){if(o<l[t+s-1])return null;if(o<=l[f-1])return lineStringCoordinateAtM(l,t,f,s,o,!1);t=f}}return null}function lineStringLength(l,t,n,s){let o=l[t],a=l[t+1],h=0;for(let c=t+s;c<n;c+=s){const u=l[c],d=l[c+1];h+=Math.sqrt((u-o)*(u-o)+(d-a)*(d-a)),o=u,a=d}return h}class LineString extends SimpleGeometry{constructor(t,n){super(),this.flatMidpoint_=null,this.flatMidpointRevision_=-1,this.maxDelta_=-1,this.maxDeltaRevision_=-1,n!==void 0&&!Array.isArray(t[0])?this.setFlatCoordinates(n,t):this.setCoordinates(t,n)}appendCoordinate(t){extend$2(this.flatCoordinates,t),this.changed()}clone(){const t=new LineString(this.flatCoordinates.slice(),this.layout);return t.applyProperties(this),t}closestPointXY(t,n,s,o){return o<closestSquaredDistanceXY(this.getExtent(),t,n)?o:(this.maxDeltaRevision_!=this.getRevision()&&(this.maxDelta_=Math.sqrt(maxSquaredDelta(this.flatCoordinates,0,this.flatCoordinates.length,this.stride,0)),this.maxDeltaRevision_=this.getRevision()),assignClosestPoint(this.flatCoordinates,0,this.flatCoordinates.length,this.stride,this.maxDelta_,!1,t,n,s,o))}forEachSegment(t){return forEach(this.flatCoordinates,0,this.flatCoordinates.length,this.stride,t)}getCoordinateAtM(t,n){return this.layout!="XYM"&&this.layout!="XYZM"?null:(n=n!==void 0?n:!1,lineStringCoordinateAtM(this.flatCoordinates,0,this.flatCoordinates.length,this.stride,t,n))}getCoordinates(){return inflateCoordinates(this.flatCoordinates,0,this.flatCoordinates.length,this.stride)}getCoordinateAt(t,n){return interpolatePoint(this.flatCoordinates,0,this.flatCoordinates.length,this.stride,t,n,this.stride)}getLength(){return lineStringLength(this.flatCoordinates,0,this.flatCoordinates.length,this.stride)}getFlatMidpoint(){return this.flatMidpointRevision_!=this.getRevision()&&(this.flatMidpoint_=this.getCoordinateAt(.5,this.flatMidpoint_??void 0),this.flatMidpointRevision_=this.getRevision()),this.flatMidpoint_}getSimplifiedGeometryInternal(t){const n=[];return n.length=douglasPeucker(this.flatCoordinates,0,this.flatCoordinates.length,this.stride,t,n,0),new LineString(n,"XY")}getType(){return"LineString"}intersectsExtent(t){return intersectsLineString(this.flatCoordinates,0,this.flatCoordinates.length,this.stride,t,this.getExtent())}setCoordinates(t,n){this.setLayout(n,t,1),this.flatCoordinates||(this.flatCoordinates=[]),this.flatCoordinates.length=deflateCoordinates(this.flatCoordinates,0,t,this.stride),this.changed()}}class MultiLineString extends SimpleGeometry{constructor(t,n,s){if(super(),this.ends_=[],this.maxDelta_=-1,this.maxDeltaRevision_=-1,Array.isArray(t[0]))this.setCoordinates(t,n);else if(n!==void 0&&s)this.setFlatCoordinates(n,t),this.ends_=s;else{const o=t,a=[],h=[];for(let u=0,d=o.length;u<d;++u){const f=o[u];extend$2(a,f.getFlatCoordinates()),h.push(a.length)}const c=o.length===0?this.getLayout():o[0].getLayout();this.setFlatCoordinates(c,a),this.ends_=h}}appendLineString(t){extend$2(this.flatCoordinates,t.getFlatCoordinates().slice()),this.ends_.push(this.flatCoordinates.length),this.changed()}clone(){const t=new MultiLineString(this.flatCoordinates.slice(),this.layout,this.ends_.slice());return t.applyProperties(this),t}closestPointXY(t,n,s,o){return o<closestSquaredDistanceXY(this.getExtent(),t,n)?o:(this.maxDeltaRevision_!=this.getRevision()&&(this.maxDelta_=Math.sqrt(arrayMaxSquaredDelta(this.flatCoordinates,0,this.ends_,this.stride,0)),this.maxDeltaRevision_=this.getRevision()),assignClosestArrayPoint(this.flatCoordinates,0,this.ends_,this.stride,this.maxDelta_,!1,t,n,s,o))}getCoordinateAtM(t,n,s){return this.layout!="XYM"&&this.layout!="XYZM"||this.flatCoordinates.length===0?null:(n=n!==void 0?n:!1,s=s!==void 0?s:!1,lineStringsCoordinateAtM(this.flatCoordinates,0,this.ends_,this.stride,t,n,s))}getCoordinates(){return inflateCoordinatesArray(this.flatCoordinates,0,this.ends_,this.stride)}getEnds(){return this.ends_}getLineString(t){return t<0||this.ends_.length<=t?null:new LineString(this.flatCoordinates.slice(t===0?0:this.ends_[t-1],this.ends_[t]),this.layout)}getLineStrings(){const t=this.flatCoordinates,n=this.ends_,s=this.layout,o=[];let a=0;for(let h=0,c=n.length;h<c;++h){const u=n[h],d=new LineString(t.slice(a,u),s);o.push(d),a=u}return o}getLength(){const t=this.ends_;let n=0,s=0;for(let o=0,a=t.length;o<a;++o)s+=lineStringLength(this.flatCoordinates,n,t[o],this.stride),n=t[o];return s}getFlatMidpoints(){const t=[],n=this.flatCoordinates;let s=0;const o=this.ends_,a=this.stride;for(let h=0,c=o.length;h<c;++h){const u=o[h],d=interpolatePoint(n,s,u,a,.5);extend$2(t,d),s=u}return t}getSimplifiedGeometryInternal(t){const n=[],s=[];return n.length=douglasPeuckerArray(this.flatCoordinates,0,this.ends_,this.stride,t,n,0,s),new MultiLineString(n,"XY",s)}getType(){return"MultiLineString"}intersectsExtent(t){return intersectsLineStringArray(this.flatCoordinates,0,this.ends_,this.stride,t)}setCoordinates(t,n){this.setLayout(n,t,2),this.flatCoordinates||(this.flatCoordinates=[]);const s=deflateCoordinatesArray(this.flatCoordinates,0,t,this.stride,this.ends_);this.flatCoordinates.length=s.length===0?0:s[s.length-1],this.changed()}}class MultiPoint extends SimpleGeometry{constructor(t,n){super(),n&&!Array.isArray(t[0])?this.setFlatCoordinates(n,t):this.setCoordinates(t,n)}appendPoint(t){extend$2(this.flatCoordinates,t.getFlatCoordinates()),this.changed()}clone(){const t=new MultiPoint(this.flatCoordinates.slice(),this.layout);return t.applyProperties(this),t}closestPointXY(t,n,s,o){if(o<closestSquaredDistanceXY(this.getExtent(),t,n))return o;const a=this.flatCoordinates,h=this.stride;for(let c=0,u=a.length;c<u;c+=h){const d=squaredDistance$1(t,n,a[c],a[c+1]);if(d<o){o=d;for(let f=0;f<h;++f)s[f]=a[c+f];s.length=h}}return o}getCoordinates(){return inflateCoordinates(this.flatCoordinates,0,this.flatCoordinates.length,this.stride)}getPoint(t){const n=this.flatCoordinates.length/this.stride;return t<0||n<=t?null:new Point(this.flatCoordinates.slice(t*this.stride,(t+1)*this.stride),this.layout)}getPoints(){const t=this.flatCoordinates,n=this.layout,s=this.stride,o=[];for(let a=0,h=t.length;a<h;a+=s){const c=new Point(t.slice(a,a+s),n);o.push(c)}return o}getType(){return"MultiPoint"}intersectsExtent(t){const n=this.flatCoordinates,s=this.stride;for(let o=0,a=n.length;o<a;o+=s){const h=n[o],c=n[o+1];if(containsXY(t,h,c))return!0}return!1}setCoordinates(t,n){this.setLayout(n,t,1),this.flatCoordinates||(this.flatCoordinates=[]),this.flatCoordinates.length=deflateCoordinates(this.flatCoordinates,0,t,this.stride),this.changed()}}function linearRingss(l,t,n,s){const o=[];let a=createEmpty();for(let h=0,c=n.length;h<c;++h){const u=n[h];a=createOrUpdateFromFlatCoordinates(l,t,u[0],s),o.push((a[0]+a[2])/2,(a[1]+a[3])/2),t=u[u.length-1]}return o}class MultiPolygon extends SimpleGeometry{constructor(t,n,s){if(super(),this.endss_=[],this.flatInteriorPointsRevision_=-1,this.flatInteriorPoints_=null,this.maxDelta_=-1,this.maxDeltaRevision_=-1,this.orientedRevision_=-1,this.orientedFlatCoordinates_=null,!s&&!Array.isArray(t[0])){const o=t,a=[],h=[];for(let c=0,u=o.length;c<u;++c){const d=o[c],f=a.length,g=d.getEnds();for(let _=0,m=g.length;_<m;++_)g[_]+=f;extend$2(a,d.getFlatCoordinates()),h.push(g)}n=o.length===0?this.getLayout():o[0].getLayout(),t=a,s=h}n!==void 0&&s?(this.setFlatCoordinates(n,t),this.endss_=s):this.setCoordinates(t,n)}appendPolygon(t){let n;if(!this.flatCoordinates)this.flatCoordinates=t.getFlatCoordinates().slice(),n=t.getEnds().slice(),this.endss_.push();else{const s=this.flatCoordinates.length;extend$2(this.flatCoordinates,t.getFlatCoordinates()),n=t.getEnds().slice();for(let o=0,a=n.length;o<a;++o)n[o]+=s}this.endss_.push(n),this.changed()}clone(){const t=this.endss_.length,n=new Array(t);for(let o=0;o<t;++o)n[o]=this.endss_[o].slice();const s=new MultiPolygon(this.flatCoordinates.slice(),this.layout,n);return s.applyProperties(this),s}closestPointXY(t,n,s,o){return o<closestSquaredDistanceXY(this.getExtent(),t,n)?o:(this.maxDeltaRevision_!=this.getRevision()&&(this.maxDelta_=Math.sqrt(multiArrayMaxSquaredDelta(this.flatCoordinates,0,this.endss_,this.stride,0)),this.maxDeltaRevision_=this.getRevision()),assignClosestMultiArrayPoint(this.getOrientedFlatCoordinates(),0,this.endss_,this.stride,this.maxDelta_,!0,t,n,s,o))}containsXY(t,n){return linearRingssContainsXY(this.getOrientedFlatCoordinates(),0,this.endss_,this.stride,t,n)}getArea(){return linearRingss$1(this.getOrientedFlatCoordinates(),0,this.endss_,this.stride)}getCoordinates(t){let n;return t!==void 0?(n=this.getOrientedFlatCoordinates().slice(),orientLinearRingsArray(n,0,this.endss_,this.stride,t)):n=this.flatCoordinates,inflateMultiCoordinatesArray(n,0,this.endss_,this.stride)}getEndss(){return this.endss_}getFlatInteriorPoints(){if(this.flatInteriorPointsRevision_!=this.getRevision()){const t=linearRingss(this.flatCoordinates,0,this.endss_,this.stride);this.flatInteriorPoints_=getInteriorPointsOfMultiArray(this.getOrientedFlatCoordinates(),0,this.endss_,this.stride,t),this.flatInteriorPointsRevision_=this.getRevision()}return this.flatInteriorPoints_}getInteriorPoints(){return new MultiPoint(this.getFlatInteriorPoints().slice(),"XYM")}getOrientedFlatCoordinates(){if(this.orientedRevision_!=this.getRevision()){const t=this.flatCoordinates;linearRingssAreOriented(t,0,this.endss_,this.stride)?this.orientedFlatCoordinates_=t:(this.orientedFlatCoordinates_=t.slice(),this.orientedFlatCoordinates_.length=orientLinearRingsArray(this.orientedFlatCoordinates_,0,this.endss_,this.stride)),this.orientedRevision_=this.getRevision()}return this.orientedFlatCoordinates_}getSimplifiedGeometryInternal(t){const n=[],s=[];return n.length=quantizeMultiArray(this.flatCoordinates,0,this.endss_,this.stride,Math.sqrt(t),n,0,s),new MultiPolygon(n,"XY",s)}getPolygon(t){if(t<0||this.endss_.length<=t)return null;let n;if(t===0)n=0;else{const a=this.endss_[t-1];n=a[a.length-1]}const s=this.endss_[t].slice(),o=s[s.length-1];if(n!==0)for(let a=0,h=s.length;a<h;++a)s[a]-=n;return new Polygon(this.flatCoordinates.slice(n,o),this.layout,s)}getPolygons(){const t=this.layout,n=this.flatCoordinates,s=this.endss_,o=[];let a=0;for(let h=0,c=s.length;h<c;++h){const u=s[h].slice(),d=u[u.length-1];if(a!==0)for(let g=0,_=u.length;g<_;++g)u[g]-=a;const f=new Polygon(n.slice(a,d),t,u);o.push(f),a=d}return o}getType(){return"MultiPolygon"}intersectsExtent(t){return intersectsLinearRingMultiArray(this.getOrientedFlatCoordinates(),0,this.endss_,this.stride,t)}setCoordinates(t,n){this.setLayout(n,t,3),this.flatCoordinates||(this.flatCoordinates=[]);const s=deflateMultiCoordinatesArray(this.flatCoordinates,0,t,this.stride,this.endss_);if(s.length===0)this.flatCoordinates.length=0;else{const o=s[s.length-1];this.flatCoordinates.length=o.length===0?0:o[o.length-1]}this.changed()}}class VectorContext{drawCustom(t,n,s,o,a){}drawGeometry(t){}setStyle(t){}drawCircle(t,n,s){}drawFeature(t,n,s){}drawGeometryCollection(t,n,s){}drawLineString(t,n,s){}drawMultiLineString(t,n,s){}drawMultiPoint(t,n,s){}drawMultiPolygon(t,n,s){}drawPoint(t,n,s){}drawPolygon(t,n,s){}drawText(t,n,s){}setFillStrokeStyle(t,n){}setImageStyle(t,n){}setTextStyle(t,n){}}const Instruction={BEGIN_GEOMETRY:0,BEGIN_PATH:1,CIRCLE:2,CLOSE_PATH:3,CUSTOM:4,DRAW_CHARS:5,DRAW_IMAGE:6,END_GEOMETRY:7,FILL:8,MOVE_TO_LINE_TO:9,SET_FILL_STYLE:10,SET_STROKE_STYLE:11,STROKE:12},fillInstruction=[Instruction.FILL],strokeInstruction=[Instruction.STROKE],beginPathInstruction=[Instruction.BEGIN_PATH],closePathInstruction=[Instruction.CLOSE_PATH];class CanvasBuilder extends VectorContext{constructor(t,n,s,o){super(),this.tolerance=t,this.maxExtent=n,this.pixelRatio=o,this.maxLineWidth=0,this.resolution=s,this.beginGeometryInstruction1_=null,this.beginGeometryInstruction2_=null,this.bufferedMaxExtent_=null,this.instructions=[],this.coordinates=[],this.tmpCoordinate_=[],this.hitDetectionInstructions=[],this.state={}}applyPixelRatio(t){const n=this.pixelRatio;return n==1?t:t.map(function(s){return s*n})}appendFlatPointCoordinates(t,n){const s=this.getBufferedMaxExtent(),o=this.tmpCoordinate_,a=this.coordinates;let h=a.length;for(let c=0,u=t.length;c<u;c+=n)o[0]=t[c],o[1]=t[c+1],containsCoordinate(s,o)&&(a[h++]=o[0],a[h++]=o[1]);return h}appendFlatLineCoordinates(t,n,s,o,a,h){const c=this.coordinates;let u=c.length;const d=this.getBufferedMaxExtent();h&&(n+=o);let f=t[n],g=t[n+1];const _=this.tmpCoordinate_;let m=!0,p,x,y;for(p=n+o;p<s;p+=o)_[0]=t[p],_[1]=t[p+1],y=coordinateRelationship(d,_),y!==x?(m&&(c[u++]=f,c[u++]=g,m=!1),c[u++]=_[0],c[u++]=_[1]):y===Relationship.INTERSECTING?(c[u++]=_[0],c[u++]=_[1],m=!1):m=!0,f=_[0],g=_[1],x=y;return(a&&m||p===n+o)&&(c[u++]=f,c[u++]=g),u}drawCustomCoordinates_(t,n,s,o,a){for(let h=0,c=s.length;h<c;++h){const u=s[h],d=this.appendFlatLineCoordinates(t,n,u,o,!1,!1);a.push(d),n=u}return n}drawCustom(t,n,s,o,a){this.beginGeometry(t,n,a);const h=t.getType(),c=t.getStride(),u=this.coordinates.length;let d,f,g,_,m;switch(h){case"MultiPolygon":d=t.getOrientedFlatCoordinates(),_=[];const p=t.getEndss();m=0;for(let x=0,y=p.length;x<y;++x){const T=[];m=this.drawCustomCoordinates_(d,m,p[x],c,T),_.push(T)}this.instructions.push([Instruction.CUSTOM,u,_,t,s,inflateMultiCoordinatesArray,a]),this.hitDetectionInstructions.push([Instruction.CUSTOM,u,_,t,o||s,inflateMultiCoordinatesArray,a]);break;case"Polygon":case"MultiLineString":g=[],d=h=="Polygon"?t.getOrientedFlatCoordinates():t.getFlatCoordinates(),m=this.drawCustomCoordinates_(d,0,t.getEnds(),c,g),this.instructions.push([Instruction.CUSTOM,u,g,t,s,inflateCoordinatesArray,a]),this.hitDetectionInstructions.push([Instruction.CUSTOM,u,g,t,o||s,inflateCoordinatesArray,a]);break;case"LineString":case"Circle":d=t.getFlatCoordinates(),f=this.appendFlatLineCoordinates(d,0,d.length,c,!1,!1),this.instructions.push([Instruction.CUSTOM,u,f,t,s,inflateCoordinates,a]),this.hitDetectionInstructions.push([Instruction.CUSTOM,u,f,t,o||s,inflateCoordinates,a]);break;case"MultiPoint":d=t.getFlatCoordinates(),f=this.appendFlatPointCoordinates(d,c),f>u&&(this.instructions.push([Instruction.CUSTOM,u,f,t,s,inflateCoordinates,a]),this.hitDetectionInstructions.push([Instruction.CUSTOM,u,f,t,o||s,inflateCoordinates,a]));break;case"Point":d=t.getFlatCoordinates(),this.coordinates.push(d[0],d[1]),f=this.coordinates.length,this.instructions.push([Instruction.CUSTOM,u,f,t,s,void 0,a]),this.hitDetectionInstructions.push([Instruction.CUSTOM,u,f,t,o||s,void 0,a]);break}this.endGeometry(n)}beginGeometry(t,n,s){this.beginGeometryInstruction1_=[Instruction.BEGIN_GEOMETRY,n,0,t,s],this.instructions.push(this.beginGeometryInstruction1_),this.beginGeometryInstruction2_=[Instruction.BEGIN_GEOMETRY,n,0,t,s],this.hitDetectionInstructions.push(this.beginGeometryInstruction2_)}finish(){return{instructions:this.instructions,hitDetectionInstructions:this.hitDetectionInstructions,coordinates:this.coordinates}}reverseHitDetectionInstructions(){const t=this.hitDetectionInstructions;t.reverse();let n;const s=t.length;let o,a,h=-1;for(n=0;n<s;++n)o=t[n],a=o[0],a==Instruction.END_GEOMETRY?h=n:a==Instruction.BEGIN_GEOMETRY&&(o[2]=n,reverseSubArray(this.hitDetectionInstructions,h,n),h=-1)}fillStyleToState(t,n={}){if(t){const s=t.getColor();n.fillPatternScale=s&&typeof s=="object"&&"src"in s?this.pixelRatio:1,n.fillStyle=asColorLike(s||defaultFillStyle)}else n.fillStyle=void 0;return n}strokeStyleToState(t,n={}){if(t){const s=t.getColor();n.strokeStyle=asColorLike(s||defaultStrokeStyle);const o=t.getLineCap();n.lineCap=o!==void 0?o:defaultLineCap;const a=t.getLineDash();n.lineDash=a?a.slice():defaultLineDash;const h=t.getLineDashOffset();n.lineDashOffset=h||defaultLineDashOffset;const c=t.getLineJoin();n.lineJoin=c!==void 0?c:defaultLineJoin;const u=t.getWidth();n.lineWidth=u!==void 0?u:defaultLineWidth;const d=t.getMiterLimit();n.miterLimit=d!==void 0?d:defaultMiterLimit,n.lineWidth>this.maxLineWidth&&(this.maxLineWidth=n.lineWidth,this.bufferedMaxExtent_=null)}else n.strokeStyle=void 0,n.lineCap=void 0,n.lineDash=null,n.lineDashOffset=void 0,n.lineJoin=void 0,n.lineWidth=void 0,n.miterLimit=void 0;return n}setFillStrokeStyle(t,n){const s=this.state;this.fillStyleToState(t,s),this.strokeStyleToState(n,s)}createFill(t){const n=t.fillStyle,s=[Instruction.SET_FILL_STYLE,n];return typeof n!="string"&&s.push(t.fillPatternScale),s}applyStroke(t){this.instructions.push(this.createStroke(t))}createStroke(t){return[Instruction.SET_STROKE_STYLE,t.strokeStyle,t.lineWidth*this.pixelRatio,t.lineCap,t.lineJoin,t.miterLimit,t.lineDash?this.applyPixelRatio(t.lineDash):null,t.lineDashOffset*this.pixelRatio]}updateFillStyle(t,n){const s=t.fillStyle;(typeof s!="string"||t.currentFillStyle!=s)&&(this.instructions.push(n.call(this,t)),t.currentFillStyle=s)}updateStrokeStyle(t,n){const s=t.strokeStyle,o=t.lineCap,a=t.lineDash,h=t.lineDashOffset,c=t.lineJoin,u=t.lineWidth,d=t.miterLimit;(t.currentStrokeStyle!=s||t.currentLineCap!=o||a!=t.currentLineDash&&!equals$2(t.currentLineDash,a)||t.currentLineDashOffset!=h||t.currentLineJoin!=c||t.currentLineWidth!=u||t.currentMiterLimit!=d)&&(n.call(this,t),t.currentStrokeStyle=s,t.currentLineCap=o,t.currentLineDash=a,t.currentLineDashOffset=h,t.currentLineJoin=c,t.currentLineWidth=u,t.currentMiterLimit=d)}endGeometry(t){this.beginGeometryInstruction1_[2]=this.instructions.length,this.beginGeometryInstruction1_=null,this.beginGeometryInstruction2_[2]=this.hitDetectionInstructions.length,this.beginGeometryInstruction2_=null;const n=[Instruction.END_GEOMETRY,t];this.instructions.push(n),this.hitDetectionInstructions.push(n)}getBufferedMaxExtent(){if(!this.bufferedMaxExtent_&&(this.bufferedMaxExtent_=clone(this.maxExtent),this.maxLineWidth>0)){const t=this.resolution*(this.maxLineWidth+1)/2;buffer(this.bufferedMaxExtent_,t,this.bufferedMaxExtent_)}return this.bufferedMaxExtent_}}class CanvasImageBuilder extends CanvasBuilder{constructor(t,n,s,o){super(t,n,s,o),this.hitDetectionImage_=null,this.image_=null,this.imagePixelRatio_=void 0,this.anchorX_=void 0,this.anchorY_=void 0,this.height_=void 0,this.opacity_=void 0,this.originX_=void 0,this.originY_=void 0,this.rotateWithView_=void 0,this.rotation_=void 0,this.scale_=void 0,this.width_=void 0,this.declutterMode_=void 0,this.declutterImageWithText_=void 0}drawPoint(t,n,s){if(!this.image_||this.maxExtent&&!containsCoordinate(this.maxExtent,t.getFlatCoordinates()))return;this.beginGeometry(t,n,s);const o=t.getFlatCoordinates(),a=t.getStride(),h=this.coordinates.length,c=this.appendFlatPointCoordinates(o,a);this.instructions.push([Instruction.DRAW_IMAGE,h,c,this.image_,this.anchorX_*this.imagePixelRatio_,this.anchorY_*this.imagePixelRatio_,Math.ceil(this.height_*this.imagePixelRatio_),this.opacity_,this.originX_*this.imagePixelRatio_,this.originY_*this.imagePixelRatio_,this.rotateWithView_,this.rotation_,[this.scale_[0]*this.pixelRatio/this.imagePixelRatio_,this.scale_[1]*this.pixelRatio/this.imagePixelRatio_],Math.ceil(this.width_*this.imagePixelRatio_),this.declutterMode_,this.declutterImageWithText_]),this.hitDetectionInstructions.push([Instruction.DRAW_IMAGE,h,c,this.hitDetectionImage_,this.anchorX_,this.anchorY_,this.height_,1,this.originX_,this.originY_,this.rotateWithView_,this.rotation_,this.scale_,this.width_,this.declutterMode_,this.declutterImageWithText_]),this.endGeometry(n)}drawMultiPoint(t,n,s){if(!this.image_)return;this.beginGeometry(t,n,s);const o=t.getFlatCoordinates(),a=[];for(let u=0,d=o.length;u<d;u+=t.getStride())(!this.maxExtent||containsCoordinate(this.maxExtent,o.slice(u,u+2)))&&a.push(o[u],o[u+1]);const h=this.coordinates.length,c=this.appendFlatPointCoordinates(a,2);this.instructions.push([Instruction.DRAW_IMAGE,h,c,this.image_,this.anchorX_*this.imagePixelRatio_,this.anchorY_*this.imagePixelRatio_,Math.ceil(this.height_*this.imagePixelRatio_),this.opacity_,this.originX_*this.imagePixelRatio_,this.originY_*this.imagePixelRatio_,this.rotateWithView_,this.rotation_,[this.scale_[0]*this.pixelRatio/this.imagePixelRatio_,this.scale_[1]*this.pixelRatio/this.imagePixelRatio_],Math.ceil(this.width_*this.imagePixelRatio_),this.declutterMode_,this.declutterImageWithText_]),this.hitDetectionInstructions.push([Instruction.DRAW_IMAGE,h,c,this.hitDetectionImage_,this.anchorX_,this.anchorY_,this.height_,1,this.originX_,this.originY_,this.rotateWithView_,this.rotation_,this.scale_,this.width_,this.declutterMode_,this.declutterImageWithText_]),this.endGeometry(n)}finish(){return this.reverseHitDetectionInstructions(),this.anchorX_=void 0,this.anchorY_=void 0,this.hitDetectionImage_=null,this.image_=null,this.imagePixelRatio_=void 0,this.height_=void 0,this.scale_=void 0,this.opacity_=void 0,this.originX_=void 0,this.originY_=void 0,this.rotateWithView_=void 0,this.rotation_=void 0,this.width_=void 0,super.finish()}setImageStyle(t,n){const s=t.getAnchor(),o=t.getSize(),a=t.getOrigin();this.imagePixelRatio_=t.getPixelRatio(this.pixelRatio),this.anchorX_=s[0],this.anchorY_=s[1],this.hitDetectionImage_=t.getHitDetectionImage(),this.image_=t.getImage(this.pixelRatio),this.height_=o[1],this.opacity_=t.getOpacity(),this.originX_=a[0],this.originY_=a[1],this.rotateWithView_=t.getRotateWithView(),this.rotation_=t.getRotation(),this.scale_=t.getScaleArray(),this.width_=o[0],this.declutterMode_=t.getDeclutterMode(),this.declutterImageWithText_=n}}class CanvasLineStringBuilder extends CanvasBuilder{constructor(t,n,s,o){super(t,n,s,o)}drawFlatCoordinates_(t,n,s,o){const a=this.coordinates.length,h=this.appendFlatLineCoordinates(t,n,s,o,!1,!1),c=[Instruction.MOVE_TO_LINE_TO,a,h];return this.instructions.push(c),this.hitDetectionInstructions.push(c),s}drawLineString(t,n,s){const o=this.state,a=o.strokeStyle,h=o.lineWidth;if(a===void 0||h===void 0)return;this.updateStrokeStyle(o,this.applyStroke),this.beginGeometry(t,n,s),this.hitDetectionInstructions.push([Instruction.SET_STROKE_STYLE,o.strokeStyle,o.lineWidth,o.lineCap,o.lineJoin,o.miterLimit,defaultLineDash,defaultLineDashOffset],beginPathInstruction);const c=t.getFlatCoordinates(),u=t.getStride();this.drawFlatCoordinates_(c,0,c.length,u),this.hitDetectionInstructions.push(strokeInstruction),this.endGeometry(n)}drawMultiLineString(t,n,s){const o=this.state,a=o.strokeStyle,h=o.lineWidth;if(a===void 0||h===void 0)return;this.updateStrokeStyle(o,this.applyStroke),this.beginGeometry(t,n,s),this.hitDetectionInstructions.push([Instruction.SET_STROKE_STYLE,o.strokeStyle,o.lineWidth,o.lineCap,o.lineJoin,o.miterLimit,defaultLineDash,defaultLineDashOffset],beginPathInstruction);const c=t.getEnds(),u=t.getFlatCoordinates(),d=t.getStride();let f=0;for(let g=0,_=c.length;g<_;++g)f=this.drawFlatCoordinates_(u,f,c[g],d);this.hitDetectionInstructions.push(strokeInstruction),this.endGeometry(n)}finish(){const t=this.state;return t.lastStroke!=null&&t.lastStroke!=this.coordinates.length&&this.instructions.push(strokeInstruction),this.reverseHitDetectionInstructions(),this.state=null,super.finish()}applyStroke(t){t.lastStroke!=null&&t.lastStroke!=this.coordinates.length&&(this.instructions.push(strokeInstruction),t.lastStroke=this.coordinates.length),t.lastStroke=0,super.applyStroke(t),this.instructions.push(beginPathInstruction)}}class CanvasPolygonBuilder extends CanvasBuilder{constructor(t,n,s,o){super(t,n,s,o)}drawFlatCoordinatess_(t,n,s,o){const a=this.state,h=a.fillStyle!==void 0,c=a.strokeStyle!==void 0,u=s.length;this.instructions.push(beginPathInstruction),this.hitDetectionInstructions.push(beginPathInstruction);for(let d=0;d<u;++d){const f=s[d],g=this.coordinates.length,_=this.appendFlatLineCoordinates(t,n,f,o,!0,!c),m=[Instruction.MOVE_TO_LINE_TO,g,_];this.instructions.push(m),this.hitDetectionInstructions.push(m),c&&(this.instructions.push(closePathInstruction),this.hitDetectionInstructions.push(closePathInstruction)),n=f}return h&&(this.instructions.push(fillInstruction),this.hitDetectionInstructions.push(fillInstruction)),c&&(this.instructions.push(strokeInstruction),this.hitDetectionInstructions.push(strokeInstruction)),n}drawCircle(t,n,s){const o=this.state,a=o.fillStyle,h=o.strokeStyle;if(a===void 0&&h===void 0)return;this.setFillStrokeStyles_(),this.beginGeometry(t,n,s),o.fillStyle!==void 0&&this.hitDetectionInstructions.push([Instruction.SET_FILL_STYLE,defaultFillStyle]),o.strokeStyle!==void 0&&this.hitDetectionInstructions.push([Instruction.SET_STROKE_STYLE,o.strokeStyle,o.lineWidth,o.lineCap,o.lineJoin,o.miterLimit,defaultLineDash,defaultLineDashOffset]);const c=t.getFlatCoordinates(),u=t.getStride(),d=this.coordinates.length;this.appendFlatLineCoordinates(c,0,c.length,u,!1,!1);const f=[Instruction.CIRCLE,d];this.instructions.push(beginPathInstruction,f),this.hitDetectionInstructions.push(beginPathInstruction,f),o.fillStyle!==void 0&&(this.instructions.push(fillInstruction),this.hitDetectionInstructions.push(fillInstruction)),o.strokeStyle!==void 0&&(this.instructions.push(strokeInstruction),this.hitDetectionInstructions.push(strokeInstruction)),this.endGeometry(n)}drawPolygon(t,n,s){const o=this.state,a=o.fillStyle,h=o.strokeStyle;if(a===void 0&&h===void 0)return;this.setFillStrokeStyles_(),this.beginGeometry(t,n,s),o.fillStyle!==void 0&&this.hitDetectionInstructions.push([Instruction.SET_FILL_STYLE,defaultFillStyle]),o.strokeStyle!==void 0&&this.hitDetectionInstructions.push([Instruction.SET_STROKE_STYLE,o.strokeStyle,o.lineWidth,o.lineCap,o.lineJoin,o.miterLimit,defaultLineDash,defaultLineDashOffset]);const c=t.getEnds(),u=t.getOrientedFlatCoordinates(),d=t.getStride();this.drawFlatCoordinatess_(u,0,c,d),this.endGeometry(n)}drawMultiPolygon(t,n,s){const o=this.state,a=o.fillStyle,h=o.strokeStyle;if(a===void 0&&h===void 0)return;this.setFillStrokeStyles_(),this.beginGeometry(t,n,s),o.fillStyle!==void 0&&this.hitDetectionInstructions.push([Instruction.SET_FILL_STYLE,defaultFillStyle]),o.strokeStyle!==void 0&&this.hitDetectionInstructions.push([Instruction.SET_STROKE_STYLE,o.strokeStyle,o.lineWidth,o.lineCap,o.lineJoin,o.miterLimit,defaultLineDash,defaultLineDashOffset]);const c=t.getEndss(),u=t.getOrientedFlatCoordinates(),d=t.getStride();let f=0;for(let g=0,_=c.length;g<_;++g)f=this.drawFlatCoordinatess_(u,f,c[g],d);this.endGeometry(n)}finish(){this.reverseHitDetectionInstructions(),this.state=null;const t=this.tolerance;if(t!==0){const n=this.coordinates;for(let s=0,o=n.length;s<o;++s)n[s]=snap(n[s],t)}return super.finish()}setFillStrokeStyles_(){const t=this.state;this.updateFillStyle(t,this.createFill),this.updateStrokeStyle(t,this.applyStroke)}}function lineChunk(l,t,n,s,o){const a=[];let h=n,c=0,u=t.slice(n,2);for(;c<l&&h+o<s;){const[d,f]=u.slice(-2),g=t[h+o],_=t[h+o+1],m=Math.sqrt((g-d)*(g-d)+(_-f)*(_-f));if(c+=m,c>=l){const p=(l-c+m)/m,x=lerp(d,g,p),y=lerp(f,_,p);u.push(x,y),a.push(u),u=[x,y],c==l&&(h+=o),c=0}else if(c<l)u.push(t[h+o],t[h+o+1]),h+=o;else{const p=m-c,x=lerp(d,g,p/m),y=lerp(f,_,p/m);u.push(x,y),a.push(u),u=[x,y],c=0,h+=o}}return c>0&&a.push(u),a}function matchingChunk(l,t,n,s,o){let a=n,h=n,c=0,u=0,d=n,f,g,_,m,p,x,y,T,S,C;for(g=n;g<s;g+=o){const P=t[g],w=t[g+1];p!==void 0&&(S=P-p,C=w-x,m=Math.sqrt(S*S+C*C),y!==void 0&&(u+=_,f=Math.acos((y*S+T*C)/(_*m)),f>l&&(u>c&&(c=u,a=d,h=g),u=0,d=g-o)),_=m,y=S,T=C),p=P,x=w}return u+=m,u>c?[d,g]:[a,h]}const TEXT_ALIGN={left:0,center:.5,right:1,top:0,middle:.5,hanging:.2,alphabetic:.8,ideographic:.8,bottom:1};class CanvasTextBuilder extends CanvasBuilder{constructor(t,n,s,o){super(t,n,s,o),this.labels_=null,this.text_="",this.textOffsetX_=0,this.textOffsetY_=0,this.textRotateWithView_=void 0,this.textKeepUpright_=void 0,this.textRotation_=0,this.textFillState_=null,this.fillStates={},this.fillStates[defaultFillStyle]={fillStyle:defaultFillStyle},this.textStrokeState_=null,this.strokeStates={},this.textState_={},this.textStates={},this.textKey_="",this.fillKey_="",this.strokeKey_="",this.declutterMode_=void 0,this.declutterImageWithText_=void 0}finish(){const t=super.finish();return t.textStates=this.textStates,t.fillStates=this.fillStates,t.strokeStates=this.strokeStates,t}drawText(t,n,s){const o=this.textFillState_,a=this.textStrokeState_,h=this.textState_;if(this.text_===""||!h||!o&&!a)return;const c=this.coordinates;let u=c.length;const d=t.getType();let f=null,g=t.getStride();if(h.placement==="line"&&(d=="LineString"||d=="MultiLineString"||d=="Polygon"||d=="MultiPolygon")){if(!intersects$1(this.maxExtent,t.getExtent()))return;let _;if(f=t.getFlatCoordinates(),d=="LineString")_=[f.length];else if(d=="MultiLineString")_=t.getEnds();else if(d=="Polygon")_=t.getEnds().slice(0,1);else if(d=="MultiPolygon"){const y=t.getEndss();_=[];for(let T=0,S=y.length;T<S;++T)_.push(y[T][0])}this.beginGeometry(t,n,s);const m=h.repeat,p=m?void 0:h.textAlign;let x=0;for(let y=0,T=_.length;y<T;++y){let S;m?S=lineChunk(m*this.resolution,f,x,_[y],g):S=[f.slice(x,_[y])];for(let C=0,P=S.length;C<P;++C){const w=S[C];let I=0,O=w.length;if(p==null){const k=matchingChunk(h.maxAngle,w,0,w.length,2);I=k[0],O=k[1]}for(let k=I;k<O;k+=g)c.push(w[k],w[k+1]);const N=c.length;x=_[y],this.drawChars_(u,N),u=N}}this.endGeometry(n)}else{let _=h.overflow?null:[];switch(d){case"Point":case"MultiPoint":f=t.getFlatCoordinates();break;case"LineString":f=t.getFlatMidpoint();break;case"Circle":f=t.getCenter();break;case"MultiLineString":f=t.getFlatMidpoints(),g=2;break;case"Polygon":f=t.getFlatInteriorPoint(),h.overflow||_.push(f[2]/this.resolution),g=3;break;case"MultiPolygon":const P=t.getFlatInteriorPoints();f=[];for(let w=0,I=P.length;w<I;w+=3)h.overflow||_.push(P[w+2]/this.resolution),f.push(P[w],P[w+1]);if(f.length===0)return;g=2;break}const m=this.appendFlatPointCoordinates(f,g);if(m===u)return;if(_&&(m-u)/2!==f.length/g){let P=u/2;_=_.filter((w,I)=>{const O=c[(P+I)*2]===f[I*g]&&c[(P+I)*2+1]===f[I*g+1];return O||--P,O})}this.saveTextStates_();const p=h.backgroundFill?this.createFill(this.fillStyleToState(h.backgroundFill)):null,x=h.backgroundStroke?this.createStroke(this.strokeStyleToState(h.backgroundStroke)):null;this.beginGeometry(t,n,s);let y=h.padding;if(y!=defaultPadding&&(h.scale[0]<0||h.scale[1]<0)){let P=h.padding[0],w=h.padding[1],I=h.padding[2],O=h.padding[3];h.scale[0]<0&&(w=-w,O=-O),h.scale[1]<0&&(P=-P,I=-I),y=[P,w,I,O]}const T=this.pixelRatio;this.instructions.push([Instruction.DRAW_IMAGE,u,m,null,NaN,NaN,NaN,1,0,0,this.textRotateWithView_,this.textRotation_,[1,1],NaN,this.declutterMode_,this.declutterImageWithText_,y==defaultPadding?defaultPadding:y.map(function(P){return P*T}),p,x,this.text_,this.textKey_,this.strokeKey_,this.fillKey_,this.textOffsetX_,this.textOffsetY_,_]);const S=1/T,C=p?p.slice(0):null;C&&(C[1]=defaultFillStyle),this.hitDetectionInstructions.push([Instruction.DRAW_IMAGE,u,m,null,NaN,NaN,NaN,1,0,0,this.textRotateWithView_,this.textRotation_,[S,S],NaN,this.declutterMode_,this.declutterImageWithText_,y,C,x,this.text_,this.textKey_,this.strokeKey_,this.fillKey_?defaultFillStyle:this.fillKey_,this.textOffsetX_,this.textOffsetY_,_]),this.endGeometry(n)}}saveTextStates_(){const t=this.textStrokeState_,n=this.textState_,s=this.textFillState_,o=this.strokeKey_;t&&(o in this.strokeStates||(this.strokeStates[o]={strokeStyle:t.strokeStyle,lineCap:t.lineCap,lineDashOffset:t.lineDashOffset,lineWidth:t.lineWidth,lineJoin:t.lineJoin,miterLimit:t.miterLimit,lineDash:t.lineDash}));const a=this.textKey_;a in this.textStates||(this.textStates[a]={font:n.font,textAlign:n.textAlign||defaultTextAlign,justify:n.justify,textBaseline:n.textBaseline||defaultTextBaseline,scale:n.scale});const h=this.fillKey_;s&&(h in this.fillStates||(this.fillStates[h]={fillStyle:s.fillStyle}))}drawChars_(t,n){const s=this.textStrokeState_,o=this.textState_,a=this.strokeKey_,h=this.textKey_,c=this.fillKey_;this.saveTextStates_();const u=this.pixelRatio,d=TEXT_ALIGN[o.textBaseline],f=this.textOffsetY_*u,g=this.text_,_=s?s.lineWidth*Math.abs(o.scale[0])/2:0;this.instructions.push([Instruction.DRAW_CHARS,t,n,d,o.overflow,c,o.maxAngle,u,f,a,_*u,g,h,1,this.declutterMode_,this.textKeepUpright_]),this.hitDetectionInstructions.push([Instruction.DRAW_CHARS,t,n,d,o.overflow,c&&defaultFillStyle,o.maxAngle,u,f,a,_*u,g,h,1/u,this.declutterMode_,this.textKeepUpright_])}setTextStyle(t,n){let s,o,a;if(!t)this.text_="";else{const h=t.getFill();h?(o=this.textFillState_,o||(o={},this.textFillState_=o),o.fillStyle=asColorLike(h.getColor()||defaultFillStyle)):(o=null,this.textFillState_=o);const c=t.getStroke();if(!c)a=null,this.textStrokeState_=a;else{a=this.textStrokeState_,a||(a={},this.textStrokeState_=a);const x=c.getLineDash(),y=c.getLineDashOffset(),T=c.getWidth(),S=c.getMiterLimit();a.lineCap=c.getLineCap()||defaultLineCap,a.lineDash=x?x.slice():defaultLineDash,a.lineDashOffset=y===void 0?defaultLineDashOffset:y,a.lineJoin=c.getLineJoin()||defaultLineJoin,a.lineWidth=T===void 0?defaultLineWidth:T,a.miterLimit=S===void 0?defaultMiterLimit:S,a.strokeStyle=asColorLike(c.getColor()||defaultStrokeStyle)}s=this.textState_;const u=t.getFont()||defaultFont;registerFont(u);const d=t.getScaleArray();s.overflow=t.getOverflow(),s.font=u,s.maxAngle=t.getMaxAngle(),s.placement=t.getPlacement(),s.textAlign=t.getTextAlign(),s.repeat=t.getRepeat(),s.justify=t.getJustify(),s.textBaseline=t.getTextBaseline()||defaultTextBaseline,s.backgroundFill=t.getBackgroundFill(),s.backgroundStroke=t.getBackgroundStroke(),s.padding=t.getPadding()||defaultPadding,s.scale=d===void 0?[1,1]:d;const f=t.getOffsetX(),g=t.getOffsetY(),_=t.getRotateWithView(),m=t.getKeepUpright(),p=t.getRotation();this.text_=t.getText()||"",this.textOffsetX_=f===void 0?0:f,this.textOffsetY_=g===void 0?0:g,this.textRotateWithView_=_===void 0?!1:_,this.textKeepUpright_=m===void 0?!0:m,this.textRotation_=p===void 0?0:p,this.strokeKey_=a?(typeof a.strokeStyle=="string"?a.strokeStyle:getUid(a.strokeStyle))+a.lineCap+a.lineDashOffset+"|"+a.lineWidth+a.lineJoin+a.miterLimit+"["+a.lineDash.join()+"]":"",this.textKey_=s.font+s.scale+(s.textAlign||"?")+(s.repeat||"?")+(s.justify||"?")+(s.textBaseline||"?"),this.fillKey_=o&&o.fillStyle?typeof o.fillStyle=="string"?o.fillStyle:"|"+getUid(o.fillStyle):""}this.declutterMode_=t.getDeclutterMode(),this.declutterImageWithText_=n}}const BATCH_CONSTRUCTORS={Circle:CanvasPolygonBuilder,Default:CanvasBuilder,Image:CanvasImageBuilder,LineString:CanvasLineStringBuilder,Polygon:CanvasPolygonBuilder,Text:CanvasTextBuilder};class BuilderGroup{constructor(t,n,s,o){this.tolerance_=t,this.maxExtent_=n,this.pixelRatio_=o,this.resolution_=s,this.buildersByZIndex_={}}finish(){const t={};for(const n in this.buildersByZIndex_){t[n]=t[n]||{};const s=this.buildersByZIndex_[n];for(const o in s){const a=s[o].finish();t[n][o]=a}}return t}getBuilder(t,n){const s=t!==void 0?t.toString():"0";let o=this.buildersByZIndex_[s];o===void 0&&(o={},this.buildersByZIndex_[s]=o);let a=o[n];if(a===void 0){const h=BATCH_CONSTRUCTORS[n];a=new h(this.tolerance_,this.maxExtent_,this.resolution_,this.pixelRatio_),o[n]=a}return a}}function drawTextOnPath(l,t,n,s,o,a,h,c,u,d,f,g,_=!0){let m=l[t],p=l[t+1],x=0,y=0,T=0,S=0;function C(){x=m,y=p,t+=s,m=l[t],p=l[t+1],S+=T,T=Math.sqrt((m-x)*(m-x)+(p-y)*(p-y))}do C();while(t<n-s&&S+T<a);let P=T===0?0:(a-S)/T;const w=lerp(x,m,P),I=lerp(y,p,P),O=t-s,N=S,k=a+c*u(d,o,f);for(;t<n-s&&S+T<k;)C();P=T===0?0:(k-S)/T;const D=lerp(x,m,P),ze=lerp(y,p,P);let z=!1;if(_)if(g){const re=[w,I,D,ze];rotate(re,0,4,2,g,re,re),z=re[0]>re[2]}else z=w>D;const Ee=Math.PI,B=[],rt=O+s===t;t=O,T=0,S=N,m=l[t],p=l[t+1];let wt;if(rt){C(),wt=Math.atan2(p-y,m-x),z&&(wt+=wt>0?-Ee:Ee);const re=(D+w)/2,mt=(ze+I)/2;return B[0]=[re,mt,(k-a)/2,wt,o],B}o=o.replace(/\n/g," ");for(let re=0,mt=o.length;re<mt;){C();let Mt=Math.atan2(p-y,m-x);if(z&&(Mt+=Mt>0?-Ee:Ee),wt!==void 0){let Zt=Mt-wt;if(Zt+=Zt>Ee?-2*Ee:Zt<-Ee?2*Ee:0,Math.abs(Zt)>h)return null}wt=Mt;const Bt=re;let Ht=0;for(;re<mt;++re){const Zt=z?mt-re-1:re,ki=c*u(d,o[Zt],f);if(t+s<n&&S+T<a+Ht+ki/2)break;Ht+=ki}if(re===Bt)continue;const Nt=z?o.substring(mt-Bt,mt-re):o.substring(Bt,re);P=T===0?0:(a+Ht/2-S)/T;const Wt=lerp(x,m,P),$t=lerp(y,p,P);B.push([Wt,$t,Ht/2,Mt,Nt]),a+=Ht}return B}class ZIndexContext{constructor(){Cu(this,"pushMethodArgs_",(...t)=>(this.push_(t),this));this.instructions_=[],this.zIndex=0,this.offset_=0,this.context_=new Proxy(getSharedCanvasContext2D(),{get:(t,n)=>{if(typeof getSharedCanvasContext2D()[n]=="function")return this.push_(n),this.pushMethodArgs_},set:(t,n,s)=>(this.push_(n,s),!0)})}push_(...t){const n=this.instructions_,s=this.zIndex+this.offset_;n[s]||(n[s]=[]),n[s].push(...t)}pushFunction(t){this.push_(t)}getContext(){return this.context_}draw(t){this.instructions_.forEach(n=>{for(let s=0,o=n.length;s<o;++s){const a=n[s];if(typeof a=="function"){a(t);continue}const h=n[++s];if(typeof t[a]=="function")t[a](...h);else{if(typeof h=="function"){t[a]=h(t);continue}t[a]=h}}})}clear(){this.instructions_.length=0,this.zIndex=0,this.offset_=0}offset(){this.offset_=this.instructions_.length,this.zIndex=0}}const tmpExtent=createEmpty(),p1=[],p2=[],p3=[],p4=[];function getDeclutterBox(l){return l[3].declutterBox}const rtlRegEx=new RegExp("[֑-ࣿיִ-﷿ﹰ-ﻼࠀ-࿿-]");function horizontalTextAlign(l,t){return t==="start"?t=rtlRegEx.test(l)?"right":"left":t==="end"&&(t=rtlRegEx.test(l)?"left":"right"),TEXT_ALIGN[t]}function createTextChunks(l,t,n){return n>0&&l.push(`
`,""),l.push(t,""),l}function richTextToPlainText(l,t,n){return n%2===0&&(l+=t),l}class Executor{constructor(t,n,s,o,a){this.overlaps=s,this.pixelRatio=n,this.resolution=t,this.alignAndScaleFill_,this.instructions=o.instructions,this.coordinates=o.coordinates,this.coordinateCache_={},this.renderedTransform_=create$2(),this.hitDetectionInstructions=o.hitDetectionInstructions,this.pixelCoordinates_=null,this.viewRotation_=0,this.fillStates=o.fillStates||{},this.strokeStates=o.strokeStates||{},this.textStates=o.textStates||{},this.widths_={},this.labels_={},this.zIndexContext_=a?new ZIndexContext:null}getZIndexContext(){return this.zIndexContext_}createLabel(t,n,s,o){const a=t+n+s+o;if(this.labels_[a])return this.labels_[a];const h=o?this.strokeStates[o]:null,c=s?this.fillStates[s]:null,u=this.textStates[n],d=this.pixelRatio,f=[u.scale[0]*d,u.scale[1]*d],g=u.justify?TEXT_ALIGN[u.justify]:horizontalTextAlign(Array.isArray(t)?t[0]:t,u.textAlign||defaultTextAlign),_=o&&h.lineWidth?h.lineWidth:0,m=Array.isArray(t)?t:String(t).split(`
`).reduce(createTextChunks,[]),{width:p,height:x,widths:y,heights:T,lineWidths:S}=getTextDimensions(u,m),C=p+_,P=[],w=(C+2)*f[0],I=(x+_)*f[1],O={width:w<0?Math.floor(w):Math.ceil(w),height:I<0?Math.floor(I):Math.ceil(I),contextInstructions:P};(f[0]!=1||f[1]!=1)&&P.push("scale",f),o&&(P.push("strokeStyle",h.strokeStyle),P.push("lineWidth",_),P.push("lineCap",h.lineCap),P.push("lineJoin",h.lineJoin),P.push("miterLimit",h.miterLimit),P.push("setLineDash",[h.lineDash]),P.push("lineDashOffset",h.lineDashOffset)),s&&P.push("fillStyle",c.fillStyle),P.push("textBaseline","middle"),P.push("textAlign","center");const N=.5-g;let k=g*C+N*_;const D=[],ze=[];let z=0,Ee=0,B=0,rt=0,wt;for(let re=0,mt=m.length;re<mt;re+=2){const Mt=m[re];if(Mt===`
`){Ee+=z,z=0,k=g*C+N*_,++rt;continue}const Bt=m[re+1]||u.font;Bt!==wt&&(o&&D.push("font",Bt),s&&ze.push("font",Bt),wt=Bt),z=Math.max(z,T[B]);const Ht=[Mt,k+N*y[B]+g*(y[B]-S[rt]),.5*(_+z)+Ee];k+=y[B],o&&D.push("strokeText",Ht),s&&ze.push("fillText",Ht),++B}return Array.prototype.push.apply(P,D),Array.prototype.push.apply(P,ze),this.labels_[a]=O,O}replayTextBackground_(t,n,s,o,a,h,c){t.beginPath(),t.moveTo.apply(t,n),t.lineTo.apply(t,s),t.lineTo.apply(t,o),t.lineTo.apply(t,a),t.lineTo.apply(t,n),h&&(this.alignAndScaleFill_=h[2],t.fillStyle=h[1],this.fill_(t)),c&&(this.setStrokeStyle_(t,c),t.stroke())}calculateImageOrLabelDimensions_(t,n,s,o,a,h,c,u,d,f,g,_,m,p,x,y){c*=_[0],u*=_[1];let T=s-c,S=o-u;const C=a+d>t?t-d:a,P=h+f>n?n-f:h,w=p[3]+C*_[0]+p[1],I=p[0]+P*_[1]+p[2],O=T-p[3],N=S-p[0];(x||g!==0)&&(p1[0]=O,p4[0]=O,p1[1]=N,p2[1]=N,p2[0]=O+w,p3[0]=p2[0],p3[1]=N+I,p4[1]=p3[1]);let k;return g!==0?(k=compose(create$2(),s,o,1,1,g,-s,-o),apply(k,p1),apply(k,p2),apply(k,p3),apply(k,p4),createOrUpdate$2(Math.min(p1[0],p2[0],p3[0],p4[0]),Math.min(p1[1],p2[1],p3[1],p4[1]),Math.max(p1[0],p2[0],p3[0],p4[0]),Math.max(p1[1],p2[1],p3[1],p4[1]),tmpExtent)):createOrUpdate$2(Math.min(O,O+w),Math.min(N,N+I),Math.max(O,O+w),Math.max(N,N+I),tmpExtent),m&&(T=Math.round(T),S=Math.round(S)),{drawImageX:T,drawImageY:S,drawImageW:C,drawImageH:P,originX:d,originY:f,declutterBox:{minX:tmpExtent[0],minY:tmpExtent[1],maxX:tmpExtent[2],maxY:tmpExtent[3],value:y},canvasTransform:k,scale:_}}replayImageOrLabel_(t,n,s,o,a,h,c){const u=!!(h||c),d=o.declutterBox,f=c?c[2]*o.scale[0]/2:0;return d.minX-f<=n[0]&&d.maxX+f>=0&&d.minY-f<=n[1]&&d.maxY+f>=0&&(u&&this.replayTextBackground_(t,p1,p2,p3,p4,h,c),drawImageOrLabel(t,o.canvasTransform,a,s,o.originX,o.originY,o.drawImageW,o.drawImageH,o.drawImageX,o.drawImageY,o.scale)),!0}fill_(t){const n=this.alignAndScaleFill_;if(n){const s=apply(this.renderedTransform_,[0,0]),o=512*this.pixelRatio;t.save(),t.translate(s[0]%o,s[1]%o),n!==1&&t.scale(n,n),t.rotate(this.viewRotation_)}t.fill(),n&&t.restore()}setStrokeStyle_(t,n){t.strokeStyle=n[1],n[1]&&(t.lineWidth=n[2],t.lineCap=n[3],t.lineJoin=n[4],t.miterLimit=n[5],t.lineDashOffset=n[7],t.setLineDash(n[6]))}drawLabelWithPointPlacement_(t,n,s,o){const a=this.textStates[n],h=this.createLabel(t,n,o,s),c=this.strokeStates[s],u=this.pixelRatio,d=horizontalTextAlign(Array.isArray(t)?t[0]:t,a.textAlign||defaultTextAlign),f=TEXT_ALIGN[a.textBaseline||defaultTextBaseline],g=c&&c.lineWidth?c.lineWidth:0,_=h.width/u-2*a.scale[0],m=d*_+2*(.5-d)*g,p=f*h.height/u+2*(.5-f)*g;return{label:h,anchorX:m,anchorY:p}}execute_(t,n,s,o,a,h,c,u){const d=this.zIndexContext_;let f;this.pixelCoordinates_&&equals$2(s,this.renderedTransform_)?f=this.pixelCoordinates_:(this.pixelCoordinates_||(this.pixelCoordinates_=[]),f=transform2D(this.coordinates,0,this.coordinates.length,2,s,this.pixelCoordinates_),setFromArray(this.renderedTransform_,s));let g=0;const _=o.length;let m=0,p,x,y,T,S,C,P,w,I,O,N,k,D,ze=0,z=0;const Ee=this.coordinateCache_,B=this.viewRotation_,rt=Math.round(Math.atan2(-s[1],s[0])*1e12)/1e12,wt={context:t,pixelRatio:this.pixelRatio,resolution:this.resolution,rotation:B},re=this.instructions!=o||this.overlaps?0:200;let mt,Mt,Bt,Ht;for(;g<_;){const Nt=o[g];switch(Nt[0]){case Instruction.BEGIN_GEOMETRY:mt=Nt[1],Ht=Nt[3],mt.getGeometry()?c!==void 0&&!intersects$1(c,Ht.getExtent())?g=Nt[2]+1:++g:g=Nt[2],d&&(d.zIndex=Nt[4]);break;case Instruction.BEGIN_PATH:ze>re&&(this.fill_(t),ze=0),z>re&&(t.stroke(),z=0),!ze&&!z&&(t.beginPath(),S=NaN,C=NaN),++g;break;case Instruction.CIRCLE:m=Nt[1];const $t=f[m],Zt=f[m+1],ki=f[m+2],Os=f[m+3],Rc=ki-$t,Sc=Os-Zt,Lc=Math.sqrt(Rc*Rc+Sc*Sc);t.moveTo($t+Lc,Zt),t.arc($t,Zt,Lc,0,2*Math.PI,!0),++g;break;case Instruction.CLOSE_PATH:t.closePath(),++g;break;case Instruction.CUSTOM:m=Nt[1],p=Nt[2];const tu=Nt[3],hu=Nt[4],qc=Nt[5];wt.geometry=tu,wt.feature=mt,g in Ee||(Ee[g]=[]);const jc=Ee[g];qc?qc(f,m,p,2,jc):(jc[0]=f[m],jc[1]=f[m+1],jc.length=2),d&&(d.zIndex=Nt[6]),hu(jc,wt),++g;break;case Instruction.DRAW_IMAGE:m=Nt[1],p=Nt[2],I=Nt[3],x=Nt[4],y=Nt[5];let Oc=Nt[6];const Fc=Nt[7],iu=Nt[8],ru=Nt[9],cu=Nt[10];let Zc=Nt[11];const nu=Nt[12];let su=Nt[13];T=Nt[14]||"declutter";const po=Nt[15];if(!I&&Nt.length>=20){O=Nt[19],N=Nt[20],k=Nt[21],D=Nt[22];const Nc=this.drawLabelWithPointPlacement_(O,N,k,D);I=Nc.label,Nt[3]=I;const Kc=Nt[23];x=(Nc.anchorX-Kc)*this.pixelRatio,Nt[4]=x;const Dc=Nt[24];y=(Nc.anchorY-Dc)*this.pixelRatio,Nt[5]=y,Oc=I.height,Nt[6]=Oc,su=I.width,Nt[13]=su}let Lu;Nt.length>25&&(Lu=Nt[25]);let Iu,Tu,Su;Nt.length>17?(Iu=Nt[16],Tu=Nt[17],Su=Nt[18]):(Iu=defaultPadding,Tu=null,Su=null),cu&&rt?Zc+=B:!cu&&!rt&&(Zc-=B);let yd=0;for(;m<p;m+=2){if(Lu&&Lu[yd++]<su/this.pixelRatio)continue;const Nc=this.calculateImageOrLabelDimensions_(I.width,I.height,f[m],f[m+1],su,Oc,x,y,iu,ru,Zc,nu,a,Iu,!!Tu||!!Su,mt),Kc=[t,n,I,Nc,Fc,Tu,Su];if(u){let Dc,Gc,kc;if(po){const Fs=p-m;if(!po[Fs]){po[Fs]={args:Kc,declutterMode:T};continue}const Ic=po[Fs];Dc=Ic.args,Gc=Ic.declutterMode,delete po[Fs],kc=getDeclutterBox(Dc)}let $c,Yc;if(Dc&&(Gc!=="declutter"||!u.collides(kc))&&($c=!0),(T!=="declutter"||!u.collides(Nc.declutterBox))&&(Yc=!0),Gc==="declutter"&&T==="declutter"){const Fs=$c&&Yc;$c=Fs,Yc=Fs}$c&&(Gc!=="none"&&u.insert(kc),this.replayImageOrLabel_.apply(this,Dc)),Yc&&(T!=="none"&&u.insert(Nc.declutterBox),this.replayImageOrLabel_.apply(this,Kc))}else this.replayImageOrLabel_.apply(this,Kc)}++g;break;case Instruction.DRAW_CHARS:const Bu=Nt[1],zu=Nt[2],Mu=Nt[3],vd=Nt[4];D=Nt[5];const xd=Nt[6],Gu=Nt[7],Uu=Nt[8];k=Nt[9];const Ou=Nt[10];O=Nt[11],Array.isArray(O)&&(O=O.reduce(richTextToPlainText,"")),N=Nt[12];const Vu=[Nt[13],Nt[13]];T=Nt[14]||"declutter";const Ed=Nt[15],Fu=this.textStates[N],uu=Fu.font,du=[Fu.scale[0]*Gu,Fu.scale[1]*Gu];let fu;uu in this.widths_?fu=this.widths_[uu]:(fu={},this.widths_[uu]=fu);const Hu=lineStringLength(f,Bu,zu,2),ju=Math.abs(du[0])*measureAndCacheTextWidth(uu,O,fu);if(vd||ju<=Hu){const Nc=this.textStates[N].textAlign,Kc=(Hu-ju)*horizontalTextAlign(O,Nc),Dc=drawTextOnPath(f,Bu,zu,2,O,Kc,xd,Math.abs(du[0]),measureAndCacheTextWidth,uu,fu,rt?0:this.viewRotation_,Ed);e:if(Dc){const Gc=[];let kc,$c,Yc,Fs,Ic;if(k)for(kc=0,$c=Dc.length;kc<$c;++kc){Ic=Dc[kc],Yc=Ic[4],Fs=this.createLabel(Yc,N,"",k),x=Ic[2]+(du[0]<0?-Ou:Ou),y=Mu*Fs.height+(.5-Mu)*2*Ou*du[1]/du[0]-Uu;const Wc=this.calculateImageOrLabelDimensions_(Fs.width,Fs.height,Ic[0],Ic[1],Fs.width,Fs.height,x,y,0,0,Ic[3],Vu,!1,defaultPadding,!1,mt);if(u&&T==="declutter"&&u.collides(Wc.declutterBox))break e;Gc.push([t,n,Fs,Wc,1,null,null])}if(D)for(kc=0,$c=Dc.length;kc<$c;++kc){Ic=Dc[kc],Yc=Ic[4],Fs=this.createLabel(Yc,N,D,""),x=Ic[2],y=Mu*Fs.height-Uu;const Wc=this.calculateImageOrLabelDimensions_(Fs.width,Fs.height,Ic[0],Ic[1],Fs.width,Fs.height,x,y,0,0,Ic[3],Vu,!1,defaultPadding,!1,mt);if(u&&T==="declutter"&&u.collides(Wc.declutterBox))break e;Gc.push([t,n,Fs,Wc,1,null,null])}u&&T!=="none"&&u.load(Gc.map(getDeclutterBox));for(let Wc=0,Td=Gc.length;Wc<Td;++Wc)this.replayImageOrLabel_.apply(this,Gc[Wc])}}++g;break;case Instruction.END_GEOMETRY:if(h!==void 0){mt=Nt[1];const Nc=h(mt,Ht,T);if(Nc)return Nc}++g;break;case Instruction.FILL:re?ze++:this.fill_(t),++g;break;case Instruction.MOVE_TO_LINE_TO:for(m=Nt[1],p=Nt[2],Mt=f[m],Bt=f[m+1],t.moveTo(Mt,Bt),S=Mt+.5|0,C=Bt+.5|0,m+=2;m<p;m+=2)Mt=f[m],Bt=f[m+1],P=Mt+.5|0,w=Bt+.5|0,(m==p-2||P!==S||w!==C)&&(t.lineTo(Mt,Bt),S=P,C=w);++g;break;case Instruction.SET_FILL_STYLE:this.alignAndScaleFill_=Nt[2],ze&&(this.fill_(t),ze=0,z&&(t.stroke(),z=0)),t.fillStyle=Nt[1],++g;break;case Instruction.SET_STROKE_STYLE:z&&(t.stroke(),z=0),this.setStrokeStyle_(t,Nt),++g;break;case Instruction.STROKE:re?z++:t.stroke(),++g;break;default:++g;break}}ze&&this.fill_(t),z&&t.stroke()}execute(t,n,s,o,a,h){this.viewRotation_=o,this.execute_(t,n,s,this.instructions,a,void 0,void 0,h)}executeHitDetection(t,n,s,o,a){return this.viewRotation_=s,this.execute_(t,[t.canvas.width,t.canvas.height],n,this.hitDetectionInstructions,!0,o,a)}}const ALL=["Polygon","Circle","LineString","Image","Text","Default"],DECLUTTER=["Image","Text"],NON_DECLUTTER=ALL.filter(l=>!DECLUTTER.includes(l));class ExecutorGroup{constructor(t,n,s,o,a,h,c){this.maxExtent_=t,this.overlaps_=o,this.pixelRatio_=s,this.resolution_=n,this.renderBuffer_=h,this.executorsByZIndex_={},this.hitDetectionContext_=null,this.hitDetectionTransform_=create$2(),this.renderedContext_=null,this.deferredZIndexContexts_={},this.createExecutors_(a,c)}clip(t,n){const s=this.getClipCoords(n);t.beginPath(),t.moveTo(s[0],s[1]),t.lineTo(s[2],s[3]),t.lineTo(s[4],s[5]),t.lineTo(s[6],s[7]),t.clip()}createExecutors_(t,n){for(const s in t){let o=this.executorsByZIndex_[s];o===void 0&&(o={},this.executorsByZIndex_[s]=o);const a=t[s];for(const h in a){const c=a[h];o[h]=new Executor(this.resolution_,this.pixelRatio_,this.overlaps_,c,n)}}}hasExecutors(t){for(const n in this.executorsByZIndex_){const s=this.executorsByZIndex_[n];for(let o=0,a=t.length;o<a;++o)if(t[o]in s)return!0}return!1}forEachFeatureAtCoordinate(t,n,s,o,a,h){o=Math.round(o);const c=o*2+1,u=compose(this.hitDetectionTransform_,o+.5,o+.5,1/n,-1/n,-s,-t[0],-t[1]),d=!this.hitDetectionContext_;d&&(this.hitDetectionContext_=createCanvasContext2D(c,c));const f=this.hitDetectionContext_;f.canvas.width!==c||f.canvas.height!==c?(f.canvas.width=c,f.canvas.height=c):d||f.clearRect(0,0,c,c);let g;this.renderBuffer_!==void 0&&(g=createEmpty(),extendCoordinate(g,t),buffer(g,n*(this.renderBuffer_+o),g));const _=getPixelIndexArray(o);let m;function p(w,I,O){const N=f.getImageData(0,0,c,c).data;for(let k=0,D=_.length;k<D;k++)if(N[_[k]]>0){if(!h||O==="none"||m!=="Image"&&m!=="Text"||h.includes(w)){const ze=(_[k]-3)/4,z=o-ze%c,Ee=o-(ze/c|0),B=a(w,I,z*z+Ee*Ee);if(B)return B}f.clearRect(0,0,c,c);break}}const x=Object.keys(this.executorsByZIndex_).map(Number);x.sort(ascending);let y,T,S,C,P;for(y=x.length-1;y>=0;--y){const w=x[y].toString();for(S=this.executorsByZIndex_[w],T=ALL.length-1;T>=0;--T)if(m=ALL[T],C=S[m],C!==void 0&&(P=C.executeHitDetection(f,u,s,p,g),P))return P}}getClipCoords(t){const n=this.maxExtent_;if(!n)return null;const s=n[0],o=n[1],a=n[2],h=n[3],c=[s,o,s,h,a,h,a,o];return transform2D(c,0,8,2,t,c),c}isEmpty(){return isEmpty$1(this.executorsByZIndex_)}execute(t,n,s,o,a,h,c){const u=Object.keys(this.executorsByZIndex_).map(Number);u.sort(c?descending:ascending),h=h||ALL;const d=ALL.length;for(let f=0,g=u.length;f<g;++f){const _=u[f].toString(),m=this.executorsByZIndex_[_];for(let p=0,x=h.length;p<x;++p){const y=h[p],T=m[y];if(T!==void 0){const S=c===null?void 0:T.getZIndexContext(),C=S?S.getContext():t,P=this.maxExtent_&&y!=="Image"&&y!=="Text";if(P&&(C.save(),this.clip(C,s)),!S||y==="Text"||y==="Image"?T.execute(C,n,s,o,a,c):S.pushFunction(w=>T.execute(w,n,s,o,a,c)),P&&C.restore(),S){S.offset();const w=u[f]*d+ALL.indexOf(y);this.deferredZIndexContexts_[w]||(this.deferredZIndexContexts_[w]=[]),this.deferredZIndexContexts_[w].push(S)}}}}this.renderedContext_=t}getDeferredZIndexContexts(){return this.deferredZIndexContexts_}getRenderedContext(){return this.renderedContext_}renderDeferred(){const t=this.deferredZIndexContexts_,n=Object.keys(t).map(Number).sort(ascending);for(let s=0,o=n.length;s<o;++s)t[n[s]].forEach(a=>{a.draw(this.renderedContext_),a.clear()}),t[n[s]].length=0}}const circlePixelIndexArrayCache={};function getPixelIndexArray(l){if(circlePixelIndexArrayCache[l]!==void 0)return circlePixelIndexArrayCache[l];const t=l*2+1,n=l*l,s=new Array(n+1);for(let a=0;a<=l;++a)for(let h=0;h<=l;++h){const c=a*a+h*h;if(c>n)break;let u=s[c];u||(u=[],s[c]=u),u.push(((l+a)*t+(l+h))*4+3),a>0&&u.push(((l-a)*t+(l+h))*4+3),h>0&&(u.push(((l+a)*t+(l-h))*4+3),a>0&&u.push(((l-a)*t+(l-h))*4+3))}const o=[];for(let a=0,h=s.length;a<h;++a)s[a]&&o.push(...s[a]);return circlePixelIndexArrayCache[l]=o,o}class CanvasImmediateRenderer extends VectorContext{constructor(t,n,s,o,a,h,c){super(),this.context_=t,this.pixelRatio_=n,this.extent_=s,this.transform_=o,this.transformRotation_=o?toFixed(Math.atan2(o[1],o[0]),10):0,this.viewRotation_=a,this.squaredTolerance_=h,this.userTransform_=c,this.contextFillState_=null,this.contextStrokeState_=null,this.contextTextState_=null,this.fillState_=null,this.strokeState_=null,this.image_=null,this.imageAnchorX_=0,this.imageAnchorY_=0,this.imageHeight_=0,this.imageOpacity_=0,this.imageOriginX_=0,this.imageOriginY_=0,this.imageRotateWithView_=!1,this.imageRotation_=0,this.imageScale_=[0,0],this.imageWidth_=0,this.text_="",this.textOffsetX_=0,this.textOffsetY_=0,this.textRotateWithView_=!1,this.textRotation_=0,this.textScale_=[0,0],this.textFillState_=null,this.textStrokeState_=null,this.textState_=null,this.pixelCoordinates_=[],this.tmpLocalTransform_=create$2()}drawImages_(t,n,s,o){if(!this.image_)return;const a=transform2D(t,n,s,o,this.transform_,this.pixelCoordinates_),h=this.context_,c=this.tmpLocalTransform_,u=h.globalAlpha;this.imageOpacity_!=1&&(h.globalAlpha=u*this.imageOpacity_);let d=this.imageRotation_;this.transformRotation_===0&&(d-=this.viewRotation_),this.imageRotateWithView_&&(d+=this.viewRotation_);for(let f=0,g=a.length;f<g;f+=2){const _=a[f]-this.imageAnchorX_,m=a[f+1]-this.imageAnchorY_;if(d!==0||this.imageScale_[0]!=1||this.imageScale_[1]!=1){const p=_+this.imageAnchorX_,x=m+this.imageAnchorY_;compose(c,p,x,1,1,d,-p,-x),h.save(),h.transform.apply(h,c),h.translate(p,x),h.scale(this.imageScale_[0],this.imageScale_[1]),h.drawImage(this.image_,this.imageOriginX_,this.imageOriginY_,this.imageWidth_,this.imageHeight_,-this.imageAnchorX_,-this.imageAnchorY_,this.imageWidth_,this.imageHeight_),h.restore()}else h.drawImage(this.image_,this.imageOriginX_,this.imageOriginY_,this.imageWidth_,this.imageHeight_,_,m,this.imageWidth_,this.imageHeight_)}this.imageOpacity_!=1&&(h.globalAlpha=u)}drawText_(t,n,s,o){if(!this.textState_||this.text_==="")return;this.textFillState_&&this.setContextFillState_(this.textFillState_),this.textStrokeState_&&this.setContextStrokeState_(this.textStrokeState_),this.setContextTextState_(this.textState_);const a=transform2D(t,n,s,o,this.transform_,this.pixelCoordinates_),h=this.context_;let c=this.textRotation_;for(this.transformRotation_===0&&(c-=this.viewRotation_),this.textRotateWithView_&&(c+=this.viewRotation_);n<s;n+=o){const u=a[n]+this.textOffsetX_,d=a[n+1]+this.textOffsetY_;c!==0||this.textScale_[0]!=1||this.textScale_[1]!=1?(h.save(),h.translate(u-this.textOffsetX_,d-this.textOffsetY_),h.rotate(c),h.translate(this.textOffsetX_,this.textOffsetY_),h.scale(this.textScale_[0],this.textScale_[1]),this.textStrokeState_&&h.strokeText(this.text_,0,0),this.textFillState_&&h.fillText(this.text_,0,0),h.restore()):(this.textStrokeState_&&h.strokeText(this.text_,u,d),this.textFillState_&&h.fillText(this.text_,u,d))}}moveToLineTo_(t,n,s,o,a){const h=this.context_,c=transform2D(t,n,s,o,this.transform_,this.pixelCoordinates_);h.moveTo(c[0],c[1]);let u=c.length;a&&(u-=2);for(let d=2;d<u;d+=2)h.lineTo(c[d],c[d+1]);return a&&h.closePath(),s}drawRings_(t,n,s,o){for(let a=0,h=s.length;a<h;++a)n=this.moveToLineTo_(t,n,s[a],o,!0);return n}drawCircle(t){if(this.squaredTolerance_&&(t=t.simplifyTransformed(this.squaredTolerance_,this.userTransform_)),!!intersects$1(this.extent_,t.getExtent())){if(this.fillState_||this.strokeState_){this.fillState_&&this.setContextFillState_(this.fillState_),this.strokeState_&&this.setContextStrokeState_(this.strokeState_);const n=transformGeom2D(t,this.transform_,this.pixelCoordinates_),s=n[2]-n[0],o=n[3]-n[1],a=Math.sqrt(s*s+o*o),h=this.context_;h.beginPath(),h.arc(n[0],n[1],a,0,2*Math.PI),this.fillState_&&h.fill(),this.strokeState_&&h.stroke()}this.text_!==""&&this.drawText_(t.getCenter(),0,2,2)}}setStyle(t){this.setFillStrokeStyle(t.getFill(),t.getStroke()),this.setImageStyle(t.getImage()),this.setTextStyle(t.getText())}setTransform(t){this.transform_=t}drawGeometry(t){switch(t.getType()){case"Point":this.drawPoint(t);break;case"LineString":this.drawLineString(t);break;case"Polygon":this.drawPolygon(t);break;case"MultiPoint":this.drawMultiPoint(t);break;case"MultiLineString":this.drawMultiLineString(t);break;case"MultiPolygon":this.drawMultiPolygon(t);break;case"GeometryCollection":this.drawGeometryCollection(t);break;case"Circle":this.drawCircle(t);break}}drawFeature(t,n){const s=n.getGeometryFunction()(t);s&&(this.setStyle(n),this.drawGeometry(s))}drawGeometryCollection(t){const n=t.getGeometriesArray();for(let s=0,o=n.length;s<o;++s)this.drawGeometry(n[s])}drawPoint(t){this.squaredTolerance_&&(t=t.simplifyTransformed(this.squaredTolerance_,this.userTransform_));const n=t.getFlatCoordinates(),s=t.getStride();this.image_&&this.drawImages_(n,0,n.length,s),this.text_!==""&&this.drawText_(n,0,n.length,s)}drawMultiPoint(t){this.squaredTolerance_&&(t=t.simplifyTransformed(this.squaredTolerance_,this.userTransform_));const n=t.getFlatCoordinates(),s=t.getStride();this.image_&&this.drawImages_(n,0,n.length,s),this.text_!==""&&this.drawText_(n,0,n.length,s)}drawLineString(t){if(this.squaredTolerance_&&(t=t.simplifyTransformed(this.squaredTolerance_,this.userTransform_)),!!intersects$1(this.extent_,t.getExtent())){if(this.strokeState_){this.setContextStrokeState_(this.strokeState_);const n=this.context_,s=t.getFlatCoordinates();n.beginPath(),this.moveToLineTo_(s,0,s.length,t.getStride(),!1),n.stroke()}if(this.text_!==""){const n=t.getFlatMidpoint();this.drawText_(n,0,2,2)}}}drawMultiLineString(t){this.squaredTolerance_&&(t=t.simplifyTransformed(this.squaredTolerance_,this.userTransform_));const n=t.getExtent();if(intersects$1(this.extent_,n)){if(this.strokeState_){this.setContextStrokeState_(this.strokeState_);const s=this.context_,o=t.getFlatCoordinates();let a=0;const h=t.getEnds(),c=t.getStride();s.beginPath();for(let u=0,d=h.length;u<d;++u)a=this.moveToLineTo_(o,a,h[u],c,!1);s.stroke()}if(this.text_!==""){const s=t.getFlatMidpoints();this.drawText_(s,0,s.length,2)}}}drawPolygon(t){if(this.squaredTolerance_&&(t=t.simplifyTransformed(this.squaredTolerance_,this.userTransform_)),!!intersects$1(this.extent_,t.getExtent())){if(this.strokeState_||this.fillState_){this.fillState_&&this.setContextFillState_(this.fillState_),this.strokeState_&&this.setContextStrokeState_(this.strokeState_);const n=this.context_;n.beginPath(),this.drawRings_(t.getOrientedFlatCoordinates(),0,t.getEnds(),t.getStride()),this.fillState_&&n.fill(),this.strokeState_&&n.stroke()}if(this.text_!==""){const n=t.getFlatInteriorPoint();this.drawText_(n,0,2,2)}}}drawMultiPolygon(t){if(this.squaredTolerance_&&(t=t.simplifyTransformed(this.squaredTolerance_,this.userTransform_)),!!intersects$1(this.extent_,t.getExtent())){if(this.strokeState_||this.fillState_){this.fillState_&&this.setContextFillState_(this.fillState_),this.strokeState_&&this.setContextStrokeState_(this.strokeState_);const n=this.context_,s=t.getOrientedFlatCoordinates();let o=0;const a=t.getEndss(),h=t.getStride();n.beginPath();for(let c=0,u=a.length;c<u;++c){const d=a[c];o=this.drawRings_(s,o,d,h)}this.fillState_&&n.fill(),this.strokeState_&&n.stroke()}if(this.text_!==""){const n=t.getFlatInteriorPoints();this.drawText_(n,0,n.length,2)}}}setContextFillState_(t){const n=this.context_,s=this.contextFillState_;s?s.fillStyle!=t.fillStyle&&(s.fillStyle=t.fillStyle,n.fillStyle=t.fillStyle):(n.fillStyle=t.fillStyle,this.contextFillState_={fillStyle:t.fillStyle})}setContextStrokeState_(t){const n=this.context_,s=this.contextStrokeState_;s?(s.lineCap!=t.lineCap&&(s.lineCap=t.lineCap,n.lineCap=t.lineCap),equals$2(s.lineDash,t.lineDash)||n.setLineDash(s.lineDash=t.lineDash),s.lineDashOffset!=t.lineDashOffset&&(s.lineDashOffset=t.lineDashOffset,n.lineDashOffset=t.lineDashOffset),s.lineJoin!=t.lineJoin&&(s.lineJoin=t.lineJoin,n.lineJoin=t.lineJoin),s.lineWidth!=t.lineWidth&&(s.lineWidth=t.lineWidth,n.lineWidth=t.lineWidth),s.miterLimit!=t.miterLimit&&(s.miterLimit=t.miterLimit,n.miterLimit=t.miterLimit),s.strokeStyle!=t.strokeStyle&&(s.strokeStyle=t.strokeStyle,n.strokeStyle=t.strokeStyle)):(n.lineCap=t.lineCap,n.setLineDash(t.lineDash),n.lineDashOffset=t.lineDashOffset,n.lineJoin=t.lineJoin,n.lineWidth=t.lineWidth,n.miterLimit=t.miterLimit,n.strokeStyle=t.strokeStyle,this.contextStrokeState_={lineCap:t.lineCap,lineDash:t.lineDash,lineDashOffset:t.lineDashOffset,lineJoin:t.lineJoin,lineWidth:t.lineWidth,miterLimit:t.miterLimit,strokeStyle:t.strokeStyle})}setContextTextState_(t){const n=this.context_,s=this.contextTextState_,o=t.textAlign?t.textAlign:defaultTextAlign;s?(s.font!=t.font&&(s.font=t.font,n.font=t.font),s.textAlign!=o&&(s.textAlign=o,n.textAlign=o),s.textBaseline!=t.textBaseline&&(s.textBaseline=t.textBaseline,n.textBaseline=t.textBaseline)):(n.font=t.font,n.textAlign=o,n.textBaseline=t.textBaseline,this.contextTextState_={font:t.font,textAlign:o,textBaseline:t.textBaseline})}setFillStrokeStyle(t,n){if(!t)this.fillState_=null;else{const s=t.getColor();this.fillState_={fillStyle:asColorLike(s||defaultFillStyle)}}if(!n)this.strokeState_=null;else{const s=n.getColor(),o=n.getLineCap(),a=n.getLineDash(),h=n.getLineDashOffset(),c=n.getLineJoin(),u=n.getWidth(),d=n.getMiterLimit(),f=a||defaultLineDash;this.strokeState_={lineCap:o!==void 0?o:defaultLineCap,lineDash:this.pixelRatio_===1?f:f.map(g=>g*this.pixelRatio_),lineDashOffset:(h||defaultLineDashOffset)*this.pixelRatio_,lineJoin:c!==void 0?c:defaultLineJoin,lineWidth:(u!==void 0?u:defaultLineWidth)*this.pixelRatio_,miterLimit:d!==void 0?d:defaultMiterLimit,strokeStyle:asColorLike(s||defaultStrokeStyle)}}}setImageStyle(t){let n;if(!t||!(n=t.getSize())){this.image_=null;return}const s=t.getPixelRatio(this.pixelRatio_),o=t.getAnchor(),a=t.getOrigin();this.image_=t.getImage(this.pixelRatio_),this.imageAnchorX_=o[0]*s,this.imageAnchorY_=o[1]*s,this.imageHeight_=n[1]*s,this.imageOpacity_=t.getOpacity(),this.imageOriginX_=a[0],this.imageOriginY_=a[1],this.imageRotateWithView_=t.getRotateWithView(),this.imageRotation_=t.getRotation();const h=t.getScaleArray();this.imageScale_=[h[0]*this.pixelRatio_/s,h[1]*this.pixelRatio_/s],this.imageWidth_=n[0]*s}setTextStyle(t){if(!t)this.text_="";else{const n=t.getFill();if(!n)this.textFillState_=null;else{const m=n.getColor();this.textFillState_={fillStyle:asColorLike(m||defaultFillStyle)}}const s=t.getStroke();if(!s)this.textStrokeState_=null;else{const m=s.getColor(),p=s.getLineCap(),x=s.getLineDash(),y=s.getLineDashOffset(),T=s.getLineJoin(),S=s.getWidth(),C=s.getMiterLimit();this.textStrokeState_={lineCap:p!==void 0?p:defaultLineCap,lineDash:x||defaultLineDash,lineDashOffset:y||defaultLineDashOffset,lineJoin:T!==void 0?T:defaultLineJoin,lineWidth:S!==void 0?S:defaultLineWidth,miterLimit:C!==void 0?C:defaultMiterLimit,strokeStyle:asColorLike(m||defaultStrokeStyle)}}const o=t.getFont(),a=t.getOffsetX(),h=t.getOffsetY(),c=t.getRotateWithView(),u=t.getRotation(),d=t.getScaleArray(),f=t.getText(),g=t.getTextAlign(),_=t.getTextBaseline();this.textState_={font:o!==void 0?o:defaultFont,textAlign:g!==void 0?g:defaultTextAlign,textBaseline:_!==void 0?_:defaultTextBaseline},this.text_=f!==void 0?Array.isArray(f)?f.reduce((m,p,x)=>m+=x%2?" ":p,""):f:"",this.textOffsetX_=a!==void 0?this.pixelRatio_*a:0,this.textOffsetY_=h!==void 0?this.pixelRatio_*h:0,this.textRotateWithView_=c!==void 0?c:!1,this.textRotation_=u!==void 0?u:0,this.textScale_=[this.pixelRatio_*d[0],this.pixelRatio_*d[1]]}}}const HIT_DETECT_RESOLUTION=.5;function createHitDetectionImageData(l,t,n,s,o,a,h,c,u){const d=u?toUserExtent(o):o,f=l[0]*HIT_DETECT_RESOLUTION,g=l[1]*HIT_DETECT_RESOLUTION,_=createCanvasContext2D(f,g);_.imageSmoothingEnabled=!1;const m=_.canvas,p=new CanvasImmediateRenderer(_,HIT_DETECT_RESOLUTION,o,null,h,c,u?getTransformFromProjections(getUserProjection(),u):null),x=n.length,y=Math.floor((256*256*256-1)/x),T={};for(let C=1;C<=x;++C){const P=n[C-1],w=P.getStyleFunction()||s;if(!w)continue;let I=w(P,a);if(!I)continue;Array.isArray(I)||(I=[I]);const N=(C*y).toString(16).padStart(7,"#00000");for(let k=0,D=I.length;k<D;++k){const ze=I[k],z=ze.getGeometryFunction()(P);if(!z||!intersects$1(d,z.getExtent()))continue;const Ee=ze.clone(),B=Ee.getFill();B&&B.setColor(N);const rt=Ee.getStroke();rt&&(rt.setColor(N),rt.setLineDash(null)),Ee.setText(void 0);const wt=ze.getImage();if(wt){const Bt=wt.getImageSize();if(!Bt)continue;const Ht=createCanvasContext2D(Bt[0],Bt[1],void 0,{alpha:!1}),Nt=Ht.canvas;Ht.fillStyle=N,Ht.fillRect(0,0,Nt.width,Nt.height),Ee.setImage(new Icon({img:Nt,anchor:wt.getAnchor(),anchorXUnits:"pixels",anchorYUnits:"pixels",offset:wt.getOrigin(),opacity:1,size:wt.getSize(),scale:wt.getScale(),rotation:wt.getRotation(),rotateWithView:wt.getRotateWithView()}))}const re=Ee.getZIndex()||0;let mt=T[re];mt||(mt={},T[re]=mt,mt.Polygon=[],mt.Circle=[],mt.LineString=[],mt.Point=[]);const Mt=z.getType();if(Mt==="GeometryCollection"){const Bt=z.getGeometriesArrayRecursive();for(let Ht=0,Nt=Bt.length;Ht<Nt;++Ht){const Wt=Bt[Ht];mt[Wt.getType().replace("Multi","")].push(Wt,Ee)}}else mt[Mt.replace("Multi","")].push(z,Ee)}}const S=Object.keys(T).map(Number).sort(ascending);for(let C=0,P=S.length;C<P;++C){const w=T[S[C]];for(const I in w){const O=w[I];for(let N=0,k=O.length;N<k;N+=2){p.setStyle(O[N+1]);for(let D=0,ze=t.length;D<ze;++D)p.setTransform(t[D]),p.drawGeometry(O[N])}}}return _.getImageData(0,0,m.width,m.height)}function hitDetect(l,t,n){const s=[];if(n){const o=Math.floor(Math.round(l[0])*HIT_DETECT_RESOLUTION),a=Math.floor(Math.round(l[1])*HIT_DETECT_RESOLUTION),h=(clamp(o,0,n.width-1)+clamp(a,0,n.height-1)*n.width)*4,c=n.data[h],u=n.data[h+1],f=n.data[h+2]+256*(u+256*c),g=Math.floor((256*256*256-1)/t.length);f&&f%g===0&&s.push(t[f/g-1])}return s}const SIMPLIFY_TOLERANCE=.5,GEOMETRY_RENDERERS={Point:renderPointGeometry,LineString:renderLineStringGeometry,Polygon:renderPolygonGeometry,MultiPoint:renderMultiPointGeometry,MultiLineString:renderMultiLineStringGeometry,MultiPolygon:renderMultiPolygonGeometry,GeometryCollection:renderGeometryCollectionGeometry,Circle:renderCircleGeometry};function defaultOrder(l,t){return parseInt(getUid(l),10)-parseInt(getUid(t),10)}function getSquaredTolerance(l,t){const n=getTolerance(l,t);return n*n}function getTolerance(l,t){return SIMPLIFY_TOLERANCE*l/t}function renderCircleGeometry(l,t,n,s,o){const a=n.getFill(),h=n.getStroke();if(a||h){const u=l.getBuilder(n.getZIndex(),"Circle");u.setFillStrokeStyle(a,h),u.drawCircle(t,s,o)}const c=n.getText();if(c&&c.getText()){const u=l.getBuilder(n.getZIndex(),"Text");u.setTextStyle(c),u.drawText(t,s)}}function renderFeature(l,t,n,s,o,a,h,c){const u=[],d=n.getImage();if(d){let _=!0;const m=d.getImageState();m==ImageState.LOADED||m==ImageState.ERROR?_=!1:m==ImageState.IDLE&&d.load(),_&&u.push(d.ready())}const f=n.getFill();f&&f.loading()&&u.push(f.ready());const g=u.length>0;return g&&Promise.all(u).then(()=>o(null)),renderFeatureInternal(l,t,n,s,a,h,c),g}function renderFeatureInternal(l,t,n,s,o,a,h){const c=n.getGeometryFunction()(t);if(!c)return;const u=c.simplifyTransformed(s,o);if(n.getRenderer())renderGeometry(l,u,n,t,h);else{const f=GEOMETRY_RENDERERS[u.getType()];f(l,u,n,t,h,a)}}function renderGeometry(l,t,n,s,o){if(t.getType()=="GeometryCollection"){const h=t.getGeometries();for(let c=0,u=h.length;c<u;++c)renderGeometry(l,h[c],n,s,o);return}l.getBuilder(n.getZIndex(),"Default").drawCustom(t,s,n.getRenderer(),n.getHitDetectionRenderer(),o)}function renderGeometryCollectionGeometry(l,t,n,s,o,a){const h=t.getGeometriesArray();let c,u;for(c=0,u=h.length;c<u;++c){const d=GEOMETRY_RENDERERS[h[c].getType()];d(l,h[c],n,s,o,a)}}function renderLineStringGeometry(l,t,n,s,o){const a=n.getStroke();if(a){const c=l.getBuilder(n.getZIndex(),"LineString");c.setFillStrokeStyle(null,a),c.drawLineString(t,s,o)}const h=n.getText();if(h&&h.getText()){const c=l.getBuilder(n.getZIndex(),"Text");c.setTextStyle(h),c.drawText(t,s,o)}}function renderMultiLineStringGeometry(l,t,n,s,o){const a=n.getStroke();if(a){const c=l.getBuilder(n.getZIndex(),"LineString");c.setFillStrokeStyle(null,a),c.drawMultiLineString(t,s,o)}const h=n.getText();if(h&&h.getText()){const c=l.getBuilder(n.getZIndex(),"Text");c.setTextStyle(h),c.drawText(t,s,o)}}function renderMultiPolygonGeometry(l,t,n,s,o){const a=n.getFill(),h=n.getStroke();if(h||a){const u=l.getBuilder(n.getZIndex(),"Polygon");u.setFillStrokeStyle(a,h),u.drawMultiPolygon(t,s,o)}const c=n.getText();if(c&&c.getText()){const u=l.getBuilder(n.getZIndex(),"Text");u.setTextStyle(c),u.drawText(t,s,o)}}function renderPointGeometry(l,t,n,s,o,a){const h=n.getImage(),c=n.getText(),u=c&&c.getText(),d=a&&h&&u?{}:void 0;if(h){if(h.getImageState()!=ImageState.LOADED)return;const f=l.getBuilder(n.getZIndex(),"Image");f.setImageStyle(h,d),f.drawPoint(t,s,o)}if(u){const f=l.getBuilder(n.getZIndex(),"Text");f.setTextStyle(c,d),f.drawText(t,s,o)}}function renderMultiPointGeometry(l,t,n,s,o,a){const h=n.getImage(),c=h&&h.getOpacity()!==0,u=n.getText(),d=u&&u.getText(),f=a&&c&&d?{}:void 0;if(c){if(h.getImageState()!=ImageState.LOADED)return;const g=l.getBuilder(n.getZIndex(),"Image");g.setImageStyle(h,f),g.drawMultiPoint(t,s,o)}if(d){const g=l.getBuilder(n.getZIndex(),"Text");g.setTextStyle(u,f),g.drawText(t,s,o)}}function renderPolygonGeometry(l,t,n,s,o){const a=n.getFill(),h=n.getStroke();if(a||h){const u=l.getBuilder(n.getZIndex(),"Polygon");u.setFillStrokeStyle(a,h),u.drawPolygon(t,s,o)}const c=n.getText();if(c&&c.getText()){const u=l.getBuilder(n.getZIndex(),"Text");u.setTextStyle(c),u.drawText(t,s,o)}}const maxStaleKeys=5;class LayerRenderer extends Observable{constructor(t){super(),this.ready=!0,this.boundHandleImageChange_=this.handleImageChange_.bind(this),this.layer_=t,this.staleKeys_=new Array,this.maxStaleKeys=maxStaleKeys}getStaleKeys(){return this.staleKeys_}prependStaleKey(t){this.staleKeys_.unshift(t),this.staleKeys_.length>this.maxStaleKeys&&(this.staleKeys_.length=this.maxStaleKeys)}getFeatures(t){return abstract()}getData(t){return null}prepareFrame(t){return abstract()}renderFrame(t,n){return abstract()}forEachFeatureAtCoordinate(t,n,s,o,a){}getLayer(){return this.layer_}handleFontsChanged(){}handleImageChange_(t){const n=t.target;(n.getState()===ImageState.LOADED||n.getState()===ImageState.ERROR)&&this.renderIfReadyAndVisible()}loadImage(t){let n=t.getState();return n!=ImageState.LOADED&&n!=ImageState.ERROR&&t.addEventListener(EventType$1.CHANGE,this.boundHandleImageChange_),n==ImageState.IDLE&&(t.load(),n=t.getState()),n==ImageState.LOADED}renderIfReadyAndVisible(){const t=this.getLayer();t&&t.getVisible()&&t.getSourceState()==="ready"&&t.changed()}renderDeferred(t){}disposeInternal(){delete this.layer_,super.disposeInternal()}}const canvasPool$2=[];let pixelContext$1=null;function createPixelContext$1(){pixelContext$1=createCanvasContext2D(1,1,void 0,{willReadFrequently:!0})}class CanvasLayerRenderer extends LayerRenderer{constructor(t){super(t),this.container=null,this.renderedResolution,this.tempTransform=create$2(),this.pixelTransform=create$2(),this.inversePixelTransform=create$2(),this.context=null,this.deferredContext_=null,this.containerReused=!1,this.frameState=null}getImageData(t,n,s){pixelContext$1||createPixelContext$1(),pixelContext$1.clearRect(0,0,1,1);let o;try{pixelContext$1.drawImage(t,n,s,1,1,0,0,1,1),o=pixelContext$1.getImageData(0,0,1,1).data}catch{return pixelContext$1=null,null}return o}getBackground(t){let s=this.getLayer().getBackground();return typeof s=="function"&&(s=s(t.viewState.resolution)),s||void 0}useContainer(t,n,s){const o=this.getLayer().getClassName();let a,h;if(t&&t.className===o&&(!s||t&&t.style.backgroundColor&&equals$2(asArray(t.style.backgroundColor),asArray(s)))){const c=t.firstElementChild;isCanvas(c)&&(h=c.getContext("2d"))}if(h&&equivalent(h.canvas.style.transform,n)?(this.container=t,this.context=h,this.containerReused=!0):this.containerReused?(this.container=null,this.context=null,this.containerReused=!1):this.container&&(this.container.style.backgroundColor=null),!this.container){a=WORKER_OFFSCREEN_CANVAS?createMockDiv():document.createElement("div"),a.className=o;let c=a.style;c.position="absolute",c.width="100%",c.height="100%",h=createCanvasContext2D();const u=h.canvas;a.appendChild(u),c=u.style,c.position="absolute",c.left="0",c.transformOrigin="top left",this.container=a,this.context=h}!this.containerReused&&s&&!this.container.style.backgroundColor&&(this.container.style.backgroundColor=s)}clipUnrotated(t,n,s){const o=getTopLeft(s),a=getTopRight(s),h=getBottomRight(s),c=getBottomLeft(s);apply(n.coordinateToPixelTransform,o),apply(n.coordinateToPixelTransform,a),apply(n.coordinateToPixelTransform,h),apply(n.coordinateToPixelTransform,c);const u=this.inversePixelTransform;apply(u,o),apply(u,a),apply(u,h),apply(u,c),t.save(),t.beginPath(),t.moveTo(Math.round(o[0]),Math.round(o[1])),t.lineTo(Math.round(a[0]),Math.round(a[1])),t.lineTo(Math.round(h[0]),Math.round(h[1])),t.lineTo(Math.round(c[0]),Math.round(c[1])),t.clip()}prepareContainer(t,n){const s=t.extent,o=t.viewState.resolution,a=t.viewState.rotation,h=t.pixelRatio,c=Math.round(getWidth(s)/o*h),u=Math.round(getHeight(s)/o*h);compose(this.pixelTransform,t.size[0]/2,t.size[1]/2,1/h,1/h,a,-c/2,-u/2),makeInverse(this.inversePixelTransform,this.pixelTransform);const d=toString$1(this.pixelTransform);if(this.useContainer(n,d,this.getBackground(t)),!this.containerReused){const f=this.context.canvas;f.width!=c||f.height!=u?(f.width=c,f.height=u):this.context.clearRect(0,0,c,u),d!==f.style.transform&&(f.style.transform=d)}}dispatchRenderEvent_(t,n,s){const o=this.getLayer();if(o.hasListener(t)){const a=new RenderEvent(t,this.inversePixelTransform,s,n);o.dispatchEvent(a)}}preRender(t,n){this.frameState=n,!n.declutter&&this.dispatchRenderEvent_(RenderEventType.PRERENDER,t,n)}postRender(t,n){n.declutter||this.dispatchRenderEvent_(RenderEventType.POSTRENDER,t,n)}renderDeferredInternal(t){}getRenderContext(t){return t.declutter&&!this.deferredContext_&&(this.deferredContext_=new ZIndexContext),t.declutter?this.deferredContext_.getContext():this.context}renderDeferred(t){t.declutter&&(this.dispatchRenderEvent_(RenderEventType.PRERENDER,this.context,t),t.declutter&&this.deferredContext_&&(this.deferredContext_.draw(this.context),this.deferredContext_.clear()),this.renderDeferredInternal(t),this.dispatchRenderEvent_(RenderEventType.POSTRENDER,this.context,t))}getRenderTransform(t,n,s,o,a,h,c){const u=a/2,d=h/2,f=o/n,g=-f,_=-t[0]+c,m=-t[1];return compose(this.tempTransform,u,d,f,g,-s,_,m)}disposeInternal(){delete this.frameState,super.disposeInternal()}}class CanvasVectorLayerRenderer extends CanvasLayerRenderer{constructor(t){super(t),this.boundHandleStyleImageChange_=this.handleStyleImageChange_.bind(this),this.animatingOrInteracting_,this.hitDetectionImageData_=null,this.clipped_=!1,this.renderedFeatures_=null,this.renderedRevision_=-1,this.renderedResolution_=NaN,this.renderedExtent_=createEmpty(),this.wrappedRenderedExtent_=createEmpty(),this.renderedRotation_,this.renderedCenter_=null,this.renderedProjection_=null,this.renderedPixelRatio_=1,this.renderedRenderOrder_=null,this.renderedFrameDeclutter_,this.replayGroup_=null,this.replayGroupChanged=!0,this.clipping=!0,this.targetContext_=null,this.opacity_=1}renderWorlds(t,n,s){const o=n.extent,a=n.viewState,h=a.center,c=a.resolution,u=a.projection,d=a.rotation,f=u.getExtent(),g=this.getLayer().getSource(),_=this.getLayer().getDeclutter(),m=n.pixelRatio,p=n.viewHints,x=!(p[ViewHint.ANIMATING]||p[ViewHint.INTERACTING]),y=this.context,T=Math.round(getWidth(o)/c*m),S=Math.round(getHeight(o)/c*m),C=g.getWrapX()&&u.canWrapX(),P=C?getWidth(f):null,w=C?Math.ceil((o[2]-f[2])/P)+1:1;let I=C?Math.floor((o[0]-f[0])/P):0;do{let O=this.getRenderTransform(h,c,0,m,T,S,I*P);n.declutter&&(O=O.slice(0)),t.execute(y,[y.canvas.width,y.canvas.height],O,d,x,s===void 0?ALL:s?DECLUTTER:NON_DECLUTTER,s?_&&n.declutter[_]:void 0)}while(++I<w)}setDrawContext_(){this.opacity_!==1&&(this.targetContext_=this.context,this.context=createCanvasContext2D(this.context.canvas.width,this.context.canvas.height,canvasPool$2))}resetDrawContext_(){if(this.opacity_!==1&&this.targetContext_){const t=this.targetContext_.globalAlpha;this.targetContext_.globalAlpha=this.opacity_,this.targetContext_.drawImage(this.context.canvas,0,0),this.targetContext_.globalAlpha=t,releaseCanvas$1(this.context),canvasPool$2.push(this.context.canvas),this.context=this.targetContext_,this.targetContext_=null}}renderDeclutter(t){!this.replayGroup_||!this.getLayer().getDeclutter()||this.renderWorlds(this.replayGroup_,t,!0)}renderDeferredInternal(t){this.replayGroup_&&(this.replayGroup_.renderDeferred(),this.clipped_&&this.context.restore(),this.resetDrawContext_())}renderFrame(t,n){const s=t.layerStatesArray[t.layerIndex];this.opacity_=s.opacity;const o=t.viewState;this.prepareContainer(t,n);const a=this.context,h=this.replayGroup_;let c=h&&!h.isEmpty();if(!c&&!(this.getLayer().hasListener(RenderEventType.PRERENDER)||this.getLayer().hasListener(RenderEventType.POSTRENDER)))return this.container;if(this.setDrawContext_(),this.preRender(a,t),o.projection,this.clipped_=!1,c&&s.extent&&this.clipping){const u=fromUserExtent(s.extent);c=intersects$1(u,t.extent),this.clipped_=c&&!containsExtent(u,t.extent),this.clipped_&&this.clipUnrotated(a,t,u)}return c&&this.renderWorlds(h,t,this.getLayer().getDeclutter()?!1:void 0),!t.declutter&&this.clipped_&&a.restore(),this.postRender(a,t),this.renderedRotation_!==o.rotation&&(this.renderedRotation_=o.rotation,this.hitDetectionImageData_=null),t.declutter||this.resetDrawContext_(),this.container}getFeatures(t){return new Promise(n=>{if(this.frameState&&!this.hitDetectionImageData_&&!this.animatingOrInteracting_){const s=this.frameState.size.slice(),o=this.renderedCenter_,a=this.renderedResolution_,h=this.renderedRotation_,c=this.renderedProjection_,u=this.wrappedRenderedExtent_,d=this.getLayer(),f=[],g=s[0]*HIT_DETECT_RESOLUTION,_=s[1]*HIT_DETECT_RESOLUTION;f.push(this.getRenderTransform(o,a,h,HIT_DETECT_RESOLUTION,g,_,0).slice());const m=d.getSource(),p=c.getExtent();if(m.getWrapX()&&c.canWrapX()&&!containsExtent(p,u)){let x=u[0];const y=getWidth(p);let T=0,S;for(;x<p[0];)--T,S=y*T,f.push(this.getRenderTransform(o,a,h,HIT_DETECT_RESOLUTION,g,_,S).slice()),x+=y;for(T=0,x=u[2];x>p[2];)++T,S=y*T,f.push(this.getRenderTransform(o,a,h,HIT_DETECT_RESOLUTION,g,_,S).slice()),x-=y}this.hitDetectionImageData_=createHitDetectionImageData(s,f,this.renderedFeatures_,d.getStyleFunction(),u,a,h,getSquaredTolerance(a,this.renderedPixelRatio_),null)}n(hitDetect(t,this.renderedFeatures_,this.hitDetectionImageData_))})}forEachFeatureAtCoordinate(t,n,s,o,a){var _,m;if(!this.replayGroup_)return;const h=n.viewState.resolution,c=n.viewState.rotation,u=this.getLayer(),d={},f=function(p,x,y){const T=getUid(p),S=d[T];if(S){if(S!==!0&&y<S.distanceSq){if(y===0)return d[T]=!0,a.splice(a.lastIndexOf(S),1),o(p,u,x);S.geometry=x,S.distanceSq=y}}else{if(y===0)return d[T]=!0,o(p,u,x);a.push(d[T]={feature:p,layer:u,geometry:x,distanceSq:y,callback:o})}},g=this.getLayer().getDeclutter();return this.replayGroup_.forEachFeatureAtCoordinate(t,h,c,s,f,g?(m=(_=n.declutter)==null?void 0:_[g])==null?void 0:m.all().map(p=>p.value):null)}handleFontsChanged(){const t=this.getLayer();t.getVisible()&&this.replayGroup_&&t.changed()}handleStyleImageChange_(t){this.renderIfReadyAndVisible()}prepareFrame(t){const n=this.getLayer(),s=n.getSource();if(!s)return!1;const o=t.viewHints[ViewHint.ANIMATING],a=t.viewHints[ViewHint.INTERACTING],h=n.getUpdateWhileAnimating(),c=n.getUpdateWhileInteracting();if(this.ready&&!h&&o||!c&&a)return this.animatingOrInteracting_=!0,!0;this.animatingOrInteracting_=!1;const u=t.extent,d=t.viewState,f=d.projection,g=d.resolution,_=t.pixelRatio,m=n.getRevision(),p=n.getRenderBuffer();let x=n.getRenderOrder();x===void 0&&(x=defaultOrder);const y=d.center.slice(),T=buffer(u,p*g),S=T.slice(),C=[T.slice()],P=f.getExtent();if(s.getWrapX()&&f.canWrapX()&&!containsExtent(P,t.extent)){const B=getWidth(P),rt=Math.max(getWidth(T)/2,B);T[0]=P[0]-rt,T[2]=P[2]+rt,wrapX$1(y,f);const wt=wrapX$2(C[0],f);wt[0]<P[0]&&wt[2]<P[2]?C.push([wt[0]+B,wt[1],wt[2]+B,wt[3]]):wt[0]>P[0]&&wt[2]>P[2]&&C.push([wt[0]-B,wt[1],wt[2]-B,wt[3]])}if(this.ready&&this.renderedResolution_==g&&this.renderedRevision_==m&&this.renderedRenderOrder_==x&&this.renderedFrameDeclutter_===!!t.declutter&&containsExtent(this.wrappedRenderedExtent_,T))return equals$2(this.renderedExtent_,S)||(this.hitDetectionImageData_=null,this.renderedExtent_=S),this.renderedCenter_=y,this.replayGroupChanged=!1,!0;this.replayGroup_=null;const w=new BuilderGroup(getTolerance(g,_),T,g,_);let I;for(let B=0,rt=C.length;B<rt;++B)s.loadFeatures(C[B],g,f);const O=getSquaredTolerance(g,_);let N=!0;const k=(B,rt)=>{let wt;const re=B.getStyleFunction()||n.getStyleFunction();if(re&&(wt=re(B,g)),wt){const mt=this.renderFeature(B,O,wt,w,I,this.getLayer().getDeclutter(),rt);N=N&&!mt}},D=toUserExtent(T),ze=s.getFeaturesInExtent(D);x&&ze.sort(x);for(let B=0,rt=ze.length;B<rt;++B)k(ze[B],B);this.renderedFeatures_=ze,this.ready=N;const z=w.finish(),Ee=new ExecutorGroup(T,g,_,s.getOverlaps(),z,n.getRenderBuffer(),!!t.declutter);return this.renderedResolution_=g,this.renderedRevision_=m,this.renderedRenderOrder_=x,this.renderedFrameDeclutter_=!!t.declutter,this.renderedExtent_=S,this.wrappedRenderedExtent_=T,this.renderedCenter_=y,this.renderedProjection_=f,this.renderedPixelRatio_=_,this.replayGroup_=Ee,this.hitDetectionImageData_=null,this.replayGroupChanged=!0,!0}renderFeature(t,n,s,o,a,h,c){if(!s)return!1;let u=!1;if(Array.isArray(s))for(let d=0,f=s.length;d<f;++d)u=renderFeature(o,t,s[d],n,this.boundHandleStyleImageChange_,a,h,c)||u;else u=renderFeature(o,t,s,n,this.boundHandleStyleImageChange_,a,h,c);return u}}class VectorLayer extends BaseVectorLayer{constructor(t){super(t)}createRenderer(){return new CanvasVectorLayerRenderer(this)}}let withCredentials=!1;function loadFeaturesXhr(l,t,n,s,o,a,h){const c=new XMLHttpRequest;c.open("GET",typeof l=="function"?l(n,s,o):l,!0),t.getType()=="arraybuffer"&&(c.responseType="arraybuffer"),c.withCredentials=withCredentials,c.onload=function(u){if(!c.status||c.status>=200&&c.status<300){const d=t.getType();try{let f;d=="text"||d=="json"?f=c.responseText:d=="xml"?f=c.responseXML||c.responseText:d=="arraybuffer"&&(f=c.response),f?a(t.readFeatures(f,{extent:n,featureProjection:o}),t.readProjection(f)):h()}catch{h()}}else h()},c.onerror=h,c.send()}function xhr(l,t){return function(n,s,o,a,h){loadFeaturesXhr(l,t,n,s,o,(c,u)=>{this.addFeatures(c),a!==void 0&&a(c)},()=>{this.changed(),h!==void 0&&h()})}}function all(l,t){return[[-1/0,-1/0,1/0,1/0]]}function bbox$1(l,t){return[l]}class GeometryCollection extends Geometry{constructor(t){super(),this.geometries_=t,this.changeEventsKeys_=[],this.listenGeometriesChange_()}unlistenGeometriesChange_(){this.changeEventsKeys_.forEach(unlistenByKey),this.changeEventsKeys_.length=0}listenGeometriesChange_(){const t=this.geometries_;for(let n=0,s=t.length;n<s;++n)this.changeEventsKeys_.push(listen(t[n],EventType$1.CHANGE,this.changed,this))}clone(){const t=new GeometryCollection(cloneGeometries(this.geometries_));return t.applyProperties(this),t}closestPointXY(t,n,s,o){if(o<closestSquaredDistanceXY(this.getExtent(),t,n))return o;const a=this.geometries_;for(let h=0,c=a.length;h<c;++h)o=a[h].closestPointXY(t,n,s,o);return o}containsXY(t,n){const s=this.geometries_;for(let o=0,a=s.length;o<a;++o)if(s[o].containsXY(t,n))return!0;return!1}computeExtent(t){createOrUpdateEmpty(t);const n=this.geometries_;for(let s=0,o=n.length;s<o;++s)extend$1(t,n[s].getExtent());return t}getGeometries(){return cloneGeometries(this.geometries_)}getGeometriesArray(){return this.geometries_}getGeometriesArrayRecursive(){let t=[];const n=this.geometries_;for(let s=0,o=n.length;s<o;++s)n[s].getType()===this.getType()?t=t.concat(n[s].getGeometriesArrayRecursive()):t.push(n[s]);return t}getSimplifiedGeometry(t){if(this.simplifiedGeometryRevision!==this.getRevision()&&(this.simplifiedGeometryMaxMinSquaredTolerance=0,this.simplifiedGeometryRevision=this.getRevision()),t<0||this.simplifiedGeometryMaxMinSquaredTolerance!==0&&t<this.simplifiedGeometryMaxMinSquaredTolerance)return this;const n=[],s=this.geometries_;let o=!1;for(let a=0,h=s.length;a<h;++a){const c=s[a],u=c.getSimplifiedGeometry(t);n.push(u),u!==c&&(o=!0)}return o?new GeometryCollection(n):(this.simplifiedGeometryMaxMinSquaredTolerance=t,this)}getType(){return"GeometryCollection"}intersectsExtent(t){const n=this.geometries_;for(let s=0,o=n.length;s<o;++s)if(n[s].intersectsExtent(t))return!0;return!1}isEmpty(){return this.geometries_.length===0}rotate(t,n){const s=this.geometries_;for(let o=0,a=s.length;o<a;++o)s[o].rotate(t,n);this.changed()}scale(t,n,s){s||(s=getCenter(this.getExtent()));const o=this.geometries_;for(let a=0,h=o.length;a<h;++a)o[a].scale(t,n,s);this.changed()}setGeometries(t){this.setGeometriesArray(cloneGeometries(t))}setGeometriesArray(t){this.unlistenGeometriesChange_(),this.geometries_=t,this.listenGeometriesChange_(),this.changed()}applyTransform(t){const n=this.geometries_;for(let s=0,o=n.length;s<o;++s)n[s].applyTransform(t);this.changed()}translate(t,n){const s=this.geometries_;for(let o=0,a=s.length;o<a;++o)s[o].translate(t,n);this.changed()}disposeInternal(){this.unlistenGeometriesChange_(),super.disposeInternal()}}function cloneGeometries(l){return l.map(t=>t.clone())}const tmpTransform=create$2();class RenderFeature{constructor(t,n,s,o,a,h){this.styleFunction,this.extent_,this.id_=h,this.type_=t,this.flatCoordinates_=n,this.flatInteriorPoints_=null,this.flatMidpoints_=null,this.ends_=s||null,this.properties_=a,this.squaredTolerance_,this.stride_=o,this.simplifiedGeometry_}get(t){return this.properties_[t]}getExtent(){return this.extent_||(this.extent_=this.type_==="Point"?createOrUpdateFromCoordinate(this.flatCoordinates_):createOrUpdateFromFlatCoordinates(this.flatCoordinates_,0,this.flatCoordinates_.length,2)),this.extent_}getFlatInteriorPoint(){if(!this.flatInteriorPoints_){const t=getCenter(this.getExtent());this.flatInteriorPoints_=getInteriorPointOfArray(this.flatCoordinates_,0,this.ends_,2,t,0)}return this.flatInteriorPoints_}getFlatInteriorPoints(){if(!this.flatInteriorPoints_){const t=inflateEnds(this.flatCoordinates_,this.ends_),n=linearRingss(this.flatCoordinates_,0,t,2);this.flatInteriorPoints_=getInteriorPointsOfMultiArray(this.flatCoordinates_,0,t,2,n)}return this.flatInteriorPoints_}getFlatMidpoint(){return this.flatMidpoints_||(this.flatMidpoints_=interpolatePoint(this.flatCoordinates_,0,this.flatCoordinates_.length,2,.5)),this.flatMidpoints_}getFlatMidpoints(){if(!this.flatMidpoints_){this.flatMidpoints_=[];const t=this.flatCoordinates_;let n=0;const s=this.ends_;for(let o=0,a=s.length;o<a;++o){const h=s[o],c=interpolatePoint(t,n,h,2,.5);extend$2(this.flatMidpoints_,c),n=h}}return this.flatMidpoints_}getId(){return this.id_}getOrientedFlatCoordinates(){return this.flatCoordinates_}getGeometry(){return this}getSimplifiedGeometry(t){return this}simplifyTransformed(t,n){return this}getProperties(){return this.properties_}getPropertiesInternal(){return this.properties_}getStride(){return this.stride_}getStyleFunction(){return this.styleFunction}getType(){return this.type_}transform(t){t=get$1(t);const n=t.getExtent(),s=t.getWorldExtent();if(n&&s){const o=getHeight(s)/getHeight(n);compose(tmpTransform,s[0],s[3],o,-o,0,0,0),transform2D(this.flatCoordinates_,0,this.flatCoordinates_.length,2,tmpTransform,this.flatCoordinates_)}}applyTransform(t){t(this.flatCoordinates_,this.flatCoordinates_,this.stride_)}clone(){var t;return new RenderFeature(this.type_,this.flatCoordinates_.slice(),(t=this.ends_)==null?void 0:t.slice(),this.stride_,Object.assign({},this.properties_),this.id_)}getEnds(){return this.ends_}enableSimplifyTransformed(){return this.simplifyTransformed=memoizeOne((t,n)=>{if(t===this.squaredTolerance_)return this.simplifiedGeometry_;this.simplifiedGeometry_=this.clone(),n&&this.simplifiedGeometry_.applyTransform(n);const s=this.simplifiedGeometry_.getFlatCoordinates();let o;switch(this.type_){case"LineString":s.length=douglasPeucker(s,0,this.simplifiedGeometry_.flatCoordinates_.length,this.simplifiedGeometry_.stride_,t,s,0),o=[s.length];break;case"MultiLineString":o=[],s.length=douglasPeuckerArray(s,0,this.simplifiedGeometry_.ends_,this.simplifiedGeometry_.stride_,t,s,0,o);break;case"Polygon":o=[],s.length=quantizeArray(s,0,this.simplifiedGeometry_.ends_,this.simplifiedGeometry_.stride_,Math.sqrt(t),s,0,o);break}return o&&(this.simplifiedGeometry_=new RenderFeature(this.type_,s,o,2,this.properties_,this.id_)),this.squaredTolerance_=t,this.simplifiedGeometry_}),this}}RenderFeature.prototype.getFlatCoordinates=RenderFeature.prototype.getOrientedFlatCoordinates;class RBush{constructor(t){this.rbush_=new RBush$1(t),this.items_={}}insert(t,n){const s={minX:t[0],minY:t[1],maxX:t[2],maxY:t[3],value:n};this.rbush_.insert(s),this.items_[getUid(n)]=s}load(t,n){const s=new Array(n.length);for(let o=0,a=n.length;o<a;o++){const h=t[o],c=n[o],u={minX:h[0],minY:h[1],maxX:h[2],maxY:h[3],value:c};s[o]=u,this.items_[getUid(c)]=u}this.rbush_.load(s)}remove(t){const n=getUid(t),s=this.items_[n];return delete this.items_[n],this.rbush_.remove(s)!==null}update(t,n){const s=this.items_[getUid(n)],o=[s.minX,s.minY,s.maxX,s.maxY];equals$1(o,t)||(this.remove(n),this.insert(t,n))}getAll(){return this.rbush_.all().map(function(n){return n.value})}getInExtent(t){const n={minX:t[0],minY:t[1],maxX:t[2],maxY:t[3]};return this.rbush_.search(n).map(function(o){return o.value})}forEach(t){return this.forEach_(this.getAll(),t)}forEachInExtent(t,n){return this.forEach_(this.getInExtent(t),n)}forEach_(t,n){let s;for(let o=0,a=t.length;o<a;o++)if(s=n(t[o]),s)return s;return s}isEmpty(){return isEmpty$1(this.items_)}clear(){this.rbush_.clear(),this.items_={}}getExtent(t){const n=this.rbush_.toJSON();return createOrUpdate$2(n.minX,n.minY,n.maxX,n.maxY,t)}concat(t){this.rbush_.load(t.rbush_.all());for(const n in t.items_)this.items_[n]=t.items_[n]}}class Source extends BaseObject{constructor(t){super(),this.projection=get$1(t.projection),this.attributions_=adaptAttributions(t.attributions),this.attributionsCollapsible_=t.attributionsCollapsible??!0,this.loading=!1,this.state_=t.state!==void 0?t.state:"ready",this.wrapX_=t.wrapX!==void 0?t.wrapX:!1,this.interpolate_=!!t.interpolate,this.viewResolver=null,this.viewRejector=null;const n=this;this.viewPromise_=new Promise(function(s,o){n.viewResolver=s,n.viewRejector=o})}getAttributions(){return this.attributions_}getAttributionsCollapsible(){return this.attributionsCollapsible_}getProjection(){return this.projection}getResolutions(t){return null}getView(){return this.viewPromise_}getState(){return this.state_}getWrapX(){return this.wrapX_}getInterpolate(){return this.interpolate_}refresh(){this.changed()}setAttributions(t){this.attributions_=adaptAttributions(t),this.changed()}setState(t){this.state_=t,this.changed()}}function adaptAttributions(l){return l?typeof l=="function"?l:(Array.isArray(l)||(l=[l]),t=>l):null}const VectorEventType={ADDFEATURE:"addfeature",CHANGEFEATURE:"changefeature",CLEAR:"clear",REMOVEFEATURE:"removefeature",FEATURESLOADSTART:"featuresloadstart",FEATURESLOADEND:"featuresloadend",FEATURESLOADERROR:"featuresloaderror"};class VectorSourceEvent extends BaseEvent{constructor(t,n,s){super(t),this.feature=n,this.features=s}}class VectorSource extends Source{constructor(t){t=t||{},super({attributions:t.attributions,interpolate:!0,projection:void 0,state:"ready",wrapX:t.wrapX!==void 0?t.wrapX:!0}),this.on,this.once,this.un,this.loader_=VOID,this.format_=t.format||null,this.overlaps_=t.overlaps===void 0?!0:t.overlaps,this.url_=t.url,t.loader!==void 0?this.loader_=t.loader:this.url_!==void 0&&(assert(this.format_,"`format` must be set when `url` is set"),this.loader_=xhr(this.url_,this.format_)),this.strategy_=t.strategy!==void 0?t.strategy:all;const n=t.useSpatialIndex!==void 0?t.useSpatialIndex:!0;this.featuresRtree_=n?new RBush:null,this.loadedExtentsRtree_=new RBush,this.loadingExtentsCount_=0,this.nullGeometryFeatures_={},this.idIndex_={},this.uidIndex_={},this.featureChangeKeys_={},this.featuresCollection_=null;let s,o;Array.isArray(t.features)?o=t.features:t.features&&(s=t.features,o=s.getArray()),!n&&s===void 0&&(s=new Collection(o)),o!==void 0&&this.addFeaturesInternal(o),s!==void 0&&this.bindFeaturesCollection_(s)}addFeature(t){this.addFeatureInternal(t),this.changed()}addFeatureInternal(t){const n=getUid(t);if(!this.addToIndex_(n,t)){this.featuresCollection_&&this.featuresCollection_.remove(t);return}this.setupChangeEvents_(n,t);const s=t.getGeometry();if(s){const o=s.getExtent();this.featuresRtree_&&this.featuresRtree_.insert(o,t)}else this.nullGeometryFeatures_[n]=t;this.dispatchEvent(new VectorSourceEvent(VectorEventType.ADDFEATURE,t))}setupChangeEvents_(t,n){n instanceof RenderFeature||(this.featureChangeKeys_[t]=[listen(n,EventType$1.CHANGE,this.handleFeatureChange_,this),listen(n,ObjectEventType.PROPERTYCHANGE,this.handleFeatureChange_,this)])}addToIndex_(t,n){let s=!0;if(n.getId()!==void 0){const o=String(n.getId());if(!(o in this.idIndex_))this.idIndex_[o]=n;else if(n instanceof RenderFeature){const a=this.idIndex_[o];a instanceof RenderFeature?Array.isArray(a)?a.push(n):this.idIndex_[o]=[a,n]:s=!1}else s=!1}return s&&(assert(!(t in this.uidIndex_),"The passed `feature` was already added to the source"),this.uidIndex_[t]=n),s}addFeatures(t){this.addFeaturesInternal(t),this.changed()}addFeaturesInternal(t){const n=[],s=[],o=[];for(let a=0,h=t.length;a<h;a++){const c=t[a],u=getUid(c);this.addToIndex_(u,c)&&s.push(c)}for(let a=0,h=s.length;a<h;a++){const c=s[a],u=getUid(c);this.setupChangeEvents_(u,c);const d=c.getGeometry();if(d){const f=d.getExtent();n.push(f),o.push(c)}else this.nullGeometryFeatures_[u]=c}if(this.featuresRtree_&&this.featuresRtree_.load(n,o),this.hasListener(VectorEventType.ADDFEATURE))for(let a=0,h=s.length;a<h;a++)this.dispatchEvent(new VectorSourceEvent(VectorEventType.ADDFEATURE,s[a]))}bindFeaturesCollection_(t){let n=!1;this.addEventListener(VectorEventType.ADDFEATURE,function(s){n||(n=!0,t.push(s.feature),n=!1)}),this.addEventListener(VectorEventType.REMOVEFEATURE,function(s){n||(n=!0,t.remove(s.feature),n=!1)}),t.addEventListener(CollectionEventType.ADD,s=>{n||(n=!0,this.addFeature(s.element),n=!1)}),t.addEventListener(CollectionEventType.REMOVE,s=>{n||(n=!0,this.removeFeature(s.element),n=!1)}),this.featuresCollection_=t}clear(t){if(t){for(const s in this.featureChangeKeys_)this.featureChangeKeys_[s].forEach(unlistenByKey);this.featuresCollection_||(this.featureChangeKeys_={},this.idIndex_={},this.uidIndex_={})}else if(this.featuresRtree_){this.featuresRtree_.forEach(s=>{this.removeFeatureInternal(s)});for(const s in this.nullGeometryFeatures_)this.removeFeatureInternal(this.nullGeometryFeatures_[s])}this.featuresCollection_&&this.featuresCollection_.clear(),this.featuresRtree_&&this.featuresRtree_.clear(),this.nullGeometryFeatures_={};const n=new VectorSourceEvent(VectorEventType.CLEAR);this.dispatchEvent(n),this.changed()}forEachFeature(t){if(this.featuresRtree_)return this.featuresRtree_.forEach(t);this.featuresCollection_&&this.featuresCollection_.forEach(t)}forEachFeatureAtCoordinateDirect(t,n){const s=[t[0],t[1],t[0],t[1]];return this.forEachFeatureInExtent(s,function(o){const a=o.getGeometry();if(a instanceof RenderFeature||a.intersectsCoordinate(t))return n(o)})}forEachFeatureInExtent(t,n){if(this.featuresRtree_)return this.featuresRtree_.forEachInExtent(t,n);this.featuresCollection_&&this.featuresCollection_.forEach(n)}forEachFeatureIntersectingExtent(t,n){return this.forEachFeatureInExtent(t,function(s){const o=s.getGeometry();if(o instanceof RenderFeature||o.intersectsExtent(t)){const a=n(s);if(a)return a}})}getFeaturesCollection(){return this.featuresCollection_}getFeatures(){let t;return this.featuresCollection_?t=this.featuresCollection_.getArray().slice(0):this.featuresRtree_&&(t=this.featuresRtree_.getAll(),isEmpty$1(this.nullGeometryFeatures_)||extend$2(t,Object.values(this.nullGeometryFeatures_))),t}getFeaturesAtCoordinate(t){const n=[];return this.forEachFeatureAtCoordinateDirect(t,function(s){n.push(s)}),n}getFeaturesInExtent(t,n){if(this.featuresRtree_){if(!(n&&n.canWrapX()&&this.getWrapX()))return this.featuresRtree_.getInExtent(t);const o=wrapAndSliceX(t,n);return[].concat(...o.map(a=>this.featuresRtree_.getInExtent(a)))}return this.featuresCollection_?this.featuresCollection_.getArray().slice(0):[]}getClosestFeatureToCoordinate(t,n){const s=t[0],o=t[1];let a=null;const h=[NaN,NaN];let c=1/0;const u=[-1/0,-1/0,1/0,1/0];return n=n||TRUE,this.featuresRtree_.forEachInExtent(u,function(d){if(n(d)){const f=d.getGeometry(),g=c;if(c=f instanceof RenderFeature?0:f.closestPointXY(s,o,h,c),c<g){a=d;const _=Math.sqrt(c);u[0]=s-_,u[1]=o-_,u[2]=s+_,u[3]=o+_}}}),a}getExtent(t){return this.featuresRtree_.getExtent(t)}getFeatureById(t){const n=this.idIndex_[t.toString()];return n!==void 0?n:null}getFeatureByUid(t){const n=this.uidIndex_[t];return n!==void 0?n:null}getFormat(){return this.format_}getOverlaps(){return this.overlaps_}getUrl(){return this.url_}handleFeatureChange_(t){const n=t.target,s=getUid(n),o=n.getGeometry();if(!o)s in this.nullGeometryFeatures_||(this.featuresRtree_&&this.featuresRtree_.remove(n),this.nullGeometryFeatures_[s]=n);else{const h=o.getExtent();s in this.nullGeometryFeatures_?(delete this.nullGeometryFeatures_[s],this.featuresRtree_&&this.featuresRtree_.insert(h,n)):this.featuresRtree_&&this.featuresRtree_.update(h,n)}const a=n.getId();if(a!==void 0){const h=a.toString();this.idIndex_[h]!==n&&(this.removeFromIdIndex_(n),this.idIndex_[h]=n)}else this.removeFromIdIndex_(n),this.uidIndex_[s]=n;this.changed(),this.dispatchEvent(new VectorSourceEvent(VectorEventType.CHANGEFEATURE,n))}hasFeature(t){const n=t.getId();return n!==void 0?n in this.idIndex_:getUid(t)in this.uidIndex_}isEmpty(){return this.featuresRtree_?this.featuresRtree_.isEmpty()&&isEmpty$1(this.nullGeometryFeatures_):this.featuresCollection_?this.featuresCollection_.getLength()===0:!0}loadFeatures(t,n,s){const o=this.loadedExtentsRtree_,a=this.strategy_(t,n,s);for(let h=0,c=a.length;h<c;++h){const u=a[h];o.forEachInExtent(u,function(f){return containsExtent(f.extent,u)})||(++this.loadingExtentsCount_,this.dispatchEvent(new VectorSourceEvent(VectorEventType.FEATURESLOADSTART)),this.loader_.call(this,u,n,s,f=>{--this.loadingExtentsCount_,this.dispatchEvent(new VectorSourceEvent(VectorEventType.FEATURESLOADEND,void 0,f))},()=>{--this.loadingExtentsCount_,this.dispatchEvent(new VectorSourceEvent(VectorEventType.FEATURESLOADERROR))}),o.insert(u,{extent:u.slice()}))}this.loading=this.loader_.length<4?!1:this.loadingExtentsCount_>0}refresh(){this.clear(!0),this.loadedExtentsRtree_.clear(),super.refresh()}removeLoadedExtent(t){const n=this.loadedExtentsRtree_,s=n.forEachInExtent(t,function(o){if(equals$1(o.extent,t))return o});s&&n.remove(s)}removeFeatures(t){let n=!1;for(let s=0,o=t.length;s<o;++s)n=this.removeFeatureInternal(t[s])||n;n&&this.changed()}removeFeature(t){if(!t)return;this.removeFeatureInternal(t)&&this.changed()}removeFeatureInternal(t){const n=getUid(t);if(!(n in this.uidIndex_))return!1;n in this.nullGeometryFeatures_?delete this.nullGeometryFeatures_[n]:this.featuresRtree_&&this.featuresRtree_.remove(t);const s=this.featureChangeKeys_[n];s==null||s.forEach(unlistenByKey),delete this.featureChangeKeys_[n];const o=t.getId();if(o!==void 0){const a=o.toString(),h=this.idIndex_[a];h===t?delete this.idIndex_[a]:Array.isArray(h)&&(h.splice(h.indexOf(t),1),h.length===1&&(this.idIndex_[a]=h[0]))}return delete this.uidIndex_[n],this.hasListener(VectorEventType.REMOVEFEATURE)&&this.dispatchEvent(new VectorSourceEvent(VectorEventType.REMOVEFEATURE,t)),!0}removeFromIdIndex_(t){for(const n in this.idIndex_)if(this.idIndex_[n]===t){delete this.idIndex_[n];break}}setLoader(t){this.loader_=t}setUrl(t){assert(this.format_,"`format` must be set when `url` is set"),this.url_=t,this.setLoader(xhr(t,this.format_))}setOverlaps(t){this.overlaps_=t,this.changed()}}function getCoordinate(l,t){const n=l.length;return t<0?l[t+n]:t>=n?l[t-n]:l[t]}function interpolateCoordinate(l,t){const n=l.length;let s=Math.floor(t);const o=t-s;s>=n?s-=n:s<0&&(s+=n);let a=s+1;a>=n&&(a-=n);const h=l[s],c=h[0],u=h[1],d=l[a],f=d[0]-c,g=d[1]-u;return[c+f*o,u+g*o]}const sharedUpdateInfo={index:-1,endIndex:NaN,closestTargetDistance:1/0};function getTraceTargetUpdate(l,t,n,s){const o=l[0],a=l[1];let h=1/0,c=-1,u=NaN;for(let g=0;g<t.targets.length;++g){const _=t.targets[g],m=_.coordinates;let p=1/0,x;for(let y=0;y<m.length-1;++y){const T=m[y],S=m[y+1],C=getPointSegmentRelationship(o,a,T,S);C.squaredDistance<p&&(p=C.squaredDistance,x=y+C.along)}p<h&&(h=p,_.ring&&t.targetIndex===g&&(_.endIndex>_.startIndex?x<_.startIndex&&(x+=m.length):_.endIndex<_.startIndex&&x>_.startIndex&&(x-=m.length)),u=x,c=g)}const d=t.targets[c];let f=d.ring;if(t.targetIndex===c&&f){const g=interpolateCoordinate(d.coordinates,u),_=n.getPixelFromCoordinate(g),m=n.getPixelFromCoordinate(t.startCoord);distance(_,m)>s&&(f=!1)}if(f){const g=d.coordinates,_=g.length,m=d.startIndex,p=u;if(m<p){const x=getCumulativeSquaredDistance(g,m,p);getCumulativeSquaredDistance(g,m,p-_)<x&&(u-=_)}else{const x=getCumulativeSquaredDistance(g,m,p);getCumulativeSquaredDistance(g,m,p+_)<x&&(u+=_)}}return sharedUpdateInfo.index=c,sharedUpdateInfo.endIndex=u,sharedUpdateInfo.closestTargetDistance=h,sharedUpdateInfo}function getTraceTargets(l,t){const n=[];for(let s=0;s<t.length;++s){const a=t[s].getGeometry();appendGeometryTraceTargets(l,a,n)}return n}function appendGeometryTraceTargets(l,t,n){if(t instanceof LineString){appendTraceTarget(l,t.getCoordinates(),!1,n);return}if(t instanceof MultiLineString){const s=t.getCoordinates();for(let o=0,a=s.length;o<a;++o)appendTraceTarget(l,s[o],!1,n);return}if(t instanceof Polygon){const s=t.getCoordinates();for(let o=0,a=s.length;o<a;++o)appendTraceTarget(l,s[o],!0,n);return}if(t instanceof MultiPolygon){const s=t.getCoordinates();for(let o=0,a=s.length;o<a;++o){const h=s[o];for(let c=0,u=h.length;c<u;++c)appendTraceTarget(l,h[c],!0,n)}return}if(t instanceof GeometryCollection){const s=t.getGeometries();for(let o=0;o<s.length;++o)appendGeometryTraceTargets(l,s[o],n);return}}function appendTraceTarget(l,t,n,s){const o=l[0],a=l[1];for(let h=0,c=t.length-1;h<c;++h){const u=t[h],d=t[h+1],f=getPointSegmentRelationship(o,a,u,d);if(f.squaredDistance===0){const g=h+f.along;s.push({coordinates:t,ring:n,startIndex:g,endIndex:g});return}}}function getSquaredDistance(l,t){return squaredDistance$1(l[0],l[1],t[0],t[1])}function getCumulativeSquaredDistance(l,t,n){let s,o;t<n?(s=t,o=n):(s=n,o=t);const a=Math.ceil(s),h=Math.floor(o);if(a>h){const u=interpolateCoordinate(l,s),d=interpolateCoordinate(l,o);return getSquaredDistance(u,d)}let c=0;if(s<a){const u=interpolateCoordinate(l,s),d=getCoordinate(l,a);c+=getSquaredDistance(u,d)}if(h<o){const u=getCoordinate(l,h),d=interpolateCoordinate(l,o);c+=getSquaredDistance(u,d)}for(let u=a;u<h-1;++u){const d=getCoordinate(l,u),f=getCoordinate(l,u+1);c+=getSquaredDistance(d,f)}return c}const sharedRel={along:0,squaredDistance:0};function getPointSegmentRelationship(l,t,n,s){const o=n[0],a=n[1],h=s[0],c=s[1],u=h-o,d=c-a;let f=0,g=o,_=a;return(u!==0||d!==0)&&(f=clamp(((l-o)*u+(t-a)*d)/(u*u+d*d),0,1),g+=u*f,_+=d*f),sharedRel.along=f,sharedRel.squaredDistance=toFixed(squaredDistance$1(l,t,g,_),10),sharedRel}const DrawEventType={DRAWSTART:"drawstart",DRAWEND:"drawend",DRAWABORT:"drawabort"};class DrawEvent extends BaseEvent{constructor(t,n){super(t),this.feature=n}}class Draw extends PointerInteraction{constructor(t){const n=t;n.stopDown||(n.stopDown=FALSE),super(n),this.on,this.once,this.un,this.options_=t,this.shouldHandle_=!1,this.downPx_=null,this.downTimeout_,this.lastDragTime_,this.pointerType_,this.freehand_=!1,this.source_=t.source?t.source:null,this.features_=t.features?t.features:null,this.snapTolerance_=t.snapTolerance?t.snapTolerance:12,this.type_=t.type,this.mode_=getMode(this.type_),this.stopClick_=!!t.stopClick,this.ignoreNextUpEvent_=!1,this.minPoints_=t.minPoints?t.minPoints:this.mode_==="Polygon"?3:2,this.maxPoints_=this.mode_==="Circle"?2:t.maxPoints?t.maxPoints:1/0,this.finishCondition_=t.finishCondition?t.finishCondition:TRUE,this.geometryLayout_=t.geometryLayout?t.geometryLayout:"XY";let s=t.geometryFunction;if(!s){const o=this.mode_;if(o==="Circle")s=(a,h,c)=>{const u=h||new Circle([NaN,NaN]),d=fromUserCoordinate(a[0]),f=squaredDistance(d,fromUserCoordinate(a[a.length-1]));return u.setCenterAndRadius(d,Math.sqrt(f),this.geometryLayout_),u};else{let a;o==="Point"?a=Point:o==="LineString"?a=LineString:o==="Polygon"&&(a=Polygon),s=(h,c,u)=>(c?o==="Polygon"?h[0].length?c.setCoordinates([h[0].concat([h[0][0]])],this.geometryLayout_):c.setCoordinates([],this.geometryLayout_):c.setCoordinates(h,this.geometryLayout_):c=new a(h,this.geometryLayout_),c)}}this.geometryFunction_=s,this.dragVertexDelay_=t.dragVertexDelay!==void 0?t.dragVertexDelay:500,this.finishCoordinate_=null,this.sketchFeature_=null,this.sketchPoint_=null,this.sketchCoords_=null,this.sketchLine_=null,this.sketchLineCoords_=null,this.squaredClickTolerance_=t.clickTolerance?t.clickTolerance*t.clickTolerance:36,this.overlay_=new VectorLayer({source:new VectorSource({useSpatialIndex:!1,wrapX:t.wrapX?t.wrapX:!1}),style:t.style?t.style:getDefaultStyleFunction$1(),updateWhileInteracting:!0}),this.geometryName_=t.geometryName,this.condition_=t.condition?t.condition:noModifierKeys,this.freehandCondition_,t.freehand?this.freehandCondition_=always$1:this.freehandCondition_=t.freehandCondition?t.freehandCondition:shiftKeyOnly,this.traceCondition_,this.setTrace(t.trace||!1),this.traceState_={active:!1},this.traceSource_=t.traceSource||t.source||null,this.addChangeListener(InteractionProperty.ACTIVE,this.updateState_)}setTrace(t){let n;t?t===!0?n=always$1:n=t:n=never,this.traceCondition_=n}setMap(t){super.setMap(t),this.updateState_()}setFreehand(t){this.freehand_=t,this.freehand_?this.freehandCondition_=always$1:this.freehandCondition_=this.options_&&this.options_.freehandCondition?this.options_.freehandCondition:shiftKeyOnly}getOverlay(){return this.overlay_}getFreehand(){return this.freehand_}handleEvent(t){t.originalEvent.type===EventType$1.CONTEXTMENU&&t.originalEvent.preventDefault(),this.freehand_=this.mode_!=="Point"&&this.freehandCondition_(t);let n=t.type===MapBrowserEventType.POINTERMOVE,s=!0;return!this.freehand_&&this.lastDragTime_&&t.type===MapBrowserEventType.POINTERDRAG&&(Date.now()-this.lastDragTime_>=this.dragVertexDelay_?(this.downPx_=t.pixel,this.shouldHandle_=!this.freehand_,n=!0):this.lastDragTime_=void 0,this.shouldHandle_&&this.downTimeout_!==void 0&&(clearTimeout(this.downTimeout_),this.downTimeout_=void 0)),this.freehand_&&t.type===MapBrowserEventType.POINTERDRAG&&this.sketchFeature_!==null?(this.addToDrawing_(t.coordinate),s=!1):this.freehand_&&t.type===MapBrowserEventType.POINTERDOWN?s=!1:n&&this.getPointerCount()<2?(s=t.type===MapBrowserEventType.POINTERMOVE,s&&this.freehand_?(this.handlePointerMove_(t),this.shouldHandle_&&t.originalEvent.preventDefault()):(t.originalEvent.pointerType==="mouse"||t.type===MapBrowserEventType.POINTERDRAG&&this.downTimeout_===void 0)&&this.handlePointerMove_(t)):t.type===MapBrowserEventType.DBLCLICK&&(s=!1),super.handleEvent(t)&&s}handleDownEvent(t){return this.shouldHandle_=!this.freehand_,this.freehand_?(this.downPx_=t.pixel,this.finishCoordinate_||this.startDrawing_(t.coordinate),!0):this.condition_(t)?(this.lastDragTime_=Date.now(),this.downTimeout_=setTimeout(()=>{this.handlePointerMove_(new MapBrowserEvent(MapBrowserEventType.POINTERMOVE,t.map,t.originalEvent,!1,t.frameState))},this.dragVertexDelay_),this.downPx_=t.pixel,!0):(this.lastDragTime_=void 0,!1)}deactivateTrace_(){this.traceState_={active:!1}}toggleTraceState_(t){if(!this.traceSource_||!this.traceCondition_(t))return;if(this.traceState_.active){this.deactivateTrace_();return}const n=this.getMap(),s=n.getCoordinateFromPixel([t.pixel[0]-this.snapTolerance_,t.pixel[1]+this.snapTolerance_]),o=n.getCoordinateFromPixel([t.pixel[0]+this.snapTolerance_,t.pixel[1]-this.snapTolerance_]),a=boundingExtent([s,o]),h=this.traceSource_.getFeaturesInExtent(a);if(h.length===0)return;const c=getTraceTargets(t.coordinate,h);c.length&&(this.traceState_={active:!0,startCoord:t.coordinate.slice(),targets:c,targetIndex:-1})}addOrRemoveTracedCoordinates_(t,n){const s=t.startIndex<=t.endIndex,o=t.startIndex<=n;s===o?s&&n>t.endIndex||!s&&n<t.endIndex?this.addTracedCoordinates_(t,t.endIndex,n):(s&&n<t.endIndex||!s&&n>t.endIndex)&&this.removeTracedCoordinates_(n,t.endIndex):(this.removeTracedCoordinates_(t.startIndex,t.endIndex),this.addTracedCoordinates_(t,t.startIndex,n))}removeTracedCoordinates_(t,n){if(t===n)return;let s=0;if(t<n){const o=Math.ceil(t);let a=Math.floor(n);a===n&&(a-=1),s=a-o+1}else{const o=Math.floor(t);let a=Math.ceil(n);a===n&&(a+=1),s=o-a+1}s>0&&this.removeLastPoints_(s)}addTracedCoordinates_(t,n,s){if(n===s)return;const o=[];if(n<s){const a=Math.ceil(n);let h=Math.floor(s);h===s&&(h-=1);for(let c=a;c<=h;++c)o.push(getCoordinate(t.coordinates,c))}else{const a=Math.floor(n);let h=Math.ceil(s);h===s&&(h+=1);for(let c=a;c>=h;--c)o.push(getCoordinate(t.coordinates,c))}o.length&&this.appendCoordinates(o)}updateTrace_(t){const n=this.traceState_;if(!n.active)return;if(n.targetIndex===-1){const c=t.map.getPixelFromCoordinate(n.startCoord);if(distance(c,t.pixel)<this.snapTolerance_)return}const s=getTraceTargetUpdate(t.coordinate,n,this.getMap(),this.snapTolerance_);if(n.targetIndex!==s.index){if(n.targetIndex!==-1){const u=n.targets[n.targetIndex];this.removeTracedCoordinates_(u.startIndex,u.endIndex)}const c=n.targets[s.index];this.addTracedCoordinates_(c,c.startIndex,s.endIndex)}else{const c=n.targets[n.targetIndex];this.addOrRemoveTracedCoordinates_(c,s.endIndex)}n.targetIndex=s.index;const o=n.targets[n.targetIndex];o.endIndex=s.endIndex;const a=interpolateCoordinate(o.coordinates,o.endIndex),h=this.getMap().getPixelFromCoordinate(a);t.coordinate=a,t.pixel=[Math.round(h[0]),Math.round(h[1])]}handleDragEvent(t){this.ignoreNextUpEvent_=!0,super.handleDragEvent(t)}handleUpEvent(t){let n=!0;if(this.getPointerCount()===0){this.downTimeout_&&(clearTimeout(this.downTimeout_),this.downTimeout_=void 0),this.handlePointerMove_(t);const s=this.traceState_.active;if(this.ignoreNextUpEvent_||this.toggleTraceState_(t),this.shouldHandle_){const o=!this.finishCoordinate_;o&&this.startDrawing_(t.coordinate),!o&&this.freehand_?this.finishDrawing():!this.freehand_&&(!o||this.mode_==="Point")&&(this.atFinish_(t.pixel,s)?this.finishCondition_(t)&&this.finishDrawing():this.addToDrawing_(t.coordinate)),n=!1}else this.freehand_&&this.abortDrawing()}return this.ignoreNextUpEvent_=!1,!n&&this.stopClick_&&t.preventDefault(),n}handlePointerMove_(t){if(this.pointerType_=t.originalEvent.pointerType,this.downPx_&&(!this.freehand_&&this.shouldHandle_||this.freehand_&&!this.shouldHandle_)){const n=this.downPx_,s=t.pixel,o=n[0]-s[0],a=n[1]-s[1],h=o*o+a*a;if(this.shouldHandle_=this.freehand_?h>this.squaredClickTolerance_:h<=this.squaredClickTolerance_,!this.shouldHandle_)return}if(!this.finishCoordinate_){this.createOrUpdateSketchPoint_(t.coordinate.slice());return}this.updateTrace_(t),this.modifyDrawing_(t.coordinate)}atFinish_(t,n){let s=!1;if(this.sketchFeature_){let o=!1,a=[this.finishCoordinate_];const h=this.mode_;if(h==="Point")s=!0;else if(h==="Circle")s=this.sketchCoords_.length===2;else if(h==="LineString")o=!n&&this.sketchCoords_.length>this.minPoints_;else if(h==="Polygon"){const c=this.sketchCoords_;o=c[0].length>this.minPoints_,a=[c[0][0],c[0][c[0].length-2]],n?a=[c[0][0]]:a=[c[0][0],c[0][c[0].length-2]]}if(o){const c=this.getMap();for(let u=0,d=a.length;u<d;u++){const f=a[u],g=c.getPixelFromCoordinate(f),_=t[0]-g[0],m=t[1]-g[1],p=this.freehand_?1:this.snapTolerance_;if(s=Math.sqrt(_*_+m*m)<=p,s){this.finishCoordinate_=f;break}}}}return s}createOrUpdateSketchPoint_(t){this.sketchPoint_?this.sketchPoint_.getGeometry().setCoordinates(t):(this.sketchPoint_=new Feature(new Point(t)),this.updateSketchFeatures_())}createOrUpdateCustomSketchLine_(t){this.sketchLine_||(this.sketchLine_=new Feature);const n=t.getLinearRing(0);let s=this.sketchLine_.getGeometry();s?(s.setFlatCoordinates(n.getLayout(),n.getFlatCoordinates()),s.changed()):(s=new LineString(n.getFlatCoordinates(),n.getLayout()),this.sketchLine_.setGeometry(s))}startDrawing_(t){const n=this.getMap().getView().getProjection(),s=getStrideForLayout(this.geometryLayout_);for(;t.length<s;)t.push(0);this.finishCoordinate_=t,this.mode_==="Point"?this.sketchCoords_=t.slice():this.mode_==="Polygon"?(this.sketchCoords_=[[t.slice(),t.slice()]],this.sketchLineCoords_=this.sketchCoords_[0]):this.sketchCoords_=[t.slice(),t.slice()],this.sketchLineCoords_&&(this.sketchLine_=new Feature(new LineString(this.sketchLineCoords_)));const o=this.geometryFunction_(this.sketchCoords_,void 0,n);this.sketchFeature_=new Feature,this.geometryName_&&this.sketchFeature_.setGeometryName(this.geometryName_),this.sketchFeature_.setGeometry(o),this.updateSketchFeatures_(),this.dispatchEvent(new DrawEvent(DrawEventType.DRAWSTART,this.sketchFeature_))}modifyDrawing_(t){const n=this.getMap(),s=this.sketchFeature_.getGeometry(),o=n.getView().getProjection(),a=getStrideForLayout(this.geometryLayout_);let h,c;for(;t.length<a;)t.push(0);this.mode_==="Point"?c=this.sketchCoords_:this.mode_==="Polygon"?(h=this.sketchCoords_[0],c=h[h.length-1],this.atFinish_(n.getPixelFromCoordinate(t))&&(t=this.finishCoordinate_.slice())):(h=this.sketchCoords_,c=h[h.length-1]),c[0]=t[0],c[1]=t[1],this.geometryFunction_(this.sketchCoords_,s,o),this.sketchPoint_&&this.sketchPoint_.getGeometry().setCoordinates(t),s.getType()==="Polygon"&&this.mode_!=="Polygon"?this.createOrUpdateCustomSketchLine_(s):this.sketchLineCoords_&&this.sketchLine_.getGeometry().setCoordinates(this.sketchLineCoords_),this.updateSketchFeatures_()}addToDrawing_(t){const n=this.sketchFeature_.getGeometry(),s=this.getMap().getView().getProjection();let o,a;const h=this.mode_;return h==="LineString"||h==="Circle"?(this.finishCoordinate_=t.slice(),a=this.sketchCoords_,a.length>=this.maxPoints_&&(this.freehand_?a.pop():o=!0),a.push(t.slice()),this.geometryFunction_(a,n,s)):h==="Polygon"&&(a=this.sketchCoords_[0],a.length>=this.maxPoints_&&(this.freehand_?a.pop():o=!0),a.push(t.slice()),o&&(this.finishCoordinate_=a[0]),this.geometryFunction_(this.sketchCoords_,n,s)),this.createOrUpdateSketchPoint_(t.slice()),this.updateSketchFeatures_(),o?this.finishDrawing():this.sketchFeature_}removeLastPoints_(t){if(!this.sketchFeature_)return;const n=this.sketchFeature_.getGeometry(),s=this.getMap().getView().getProjection(),o=this.mode_;for(let a=0;a<t;++a){let h;if(o==="LineString"||o==="Circle"){if(h=this.sketchCoords_,h.splice(-2,1),h.length>=2){this.finishCoordinate_=h[h.length-2].slice();const c=this.finishCoordinate_.slice();h[h.length-1]=c,this.createOrUpdateSketchPoint_(c)}this.geometryFunction_(h,n,s),n.getType()==="Polygon"&&this.sketchLine_&&this.createOrUpdateCustomSketchLine_(n)}else if(o==="Polygon"){h=this.sketchCoords_[0],h.splice(-2,1);const c=this.sketchLine_.getGeometry();if(h.length>=2){const u=h[h.length-2].slice();h[h.length-1]=u,this.createOrUpdateSketchPoint_(u)}c.setCoordinates(h),this.geometryFunction_(this.sketchCoords_,n,s)}if(h.length===1){this.abortDrawing();break}}this.updateSketchFeatures_()}removeLastPoint(){this.removeLastPoints_(1)}finishDrawing(){const t=this.abortDrawing_();if(!t)return null;let n=this.sketchCoords_;const s=t.getGeometry(),o=this.getMap().getView().getProjection();return this.mode_==="LineString"?(n.pop(),this.geometryFunction_(n,s,o)):this.mode_==="Polygon"&&(n[0].pop(),this.geometryFunction_(n,s,o),n=s.getCoordinates()),this.type_==="MultiPoint"?t.setGeometry(new MultiPoint([n])):this.type_==="MultiLineString"?t.setGeometry(new MultiLineString([n])):this.type_==="MultiPolygon"&&t.setGeometry(new MultiPolygon([n])),this.dispatchEvent(new DrawEvent(DrawEventType.DRAWEND,t)),this.features_&&this.features_.push(t),this.source_&&this.source_.addFeature(t),t}abortDrawing_(){this.finishCoordinate_=null;const t=this.sketchFeature_;return this.sketchFeature_=null,this.sketchPoint_=null,this.sketchLine_=null,this.overlay_.getSource().clear(!0),this.deactivateTrace_(),t}abortDrawing(){const t=this.abortDrawing_();t&&this.dispatchEvent(new DrawEvent(DrawEventType.DRAWABORT,t))}appendCoordinates(t){const n=this.mode_,s=!this.sketchFeature_;s&&this.startDrawing_(t[0]);let o;if(n==="LineString"||n==="Circle")o=this.sketchCoords_;else if(n==="Polygon")o=this.sketchCoords_&&this.sketchCoords_.length?this.sketchCoords_[0]:[];else return;s&&o.shift(),o.pop();for(let h=0;h<t.length;h++)this.addToDrawing_(t[h]);const a=t[t.length-1];this.sketchFeature_=this.addToDrawing_(a),this.modifyDrawing_(a)}extend(t){const s=t.getGeometry();this.sketchFeature_=t,this.sketchCoords_=s.getCoordinates();const o=this.sketchCoords_[this.sketchCoords_.length-1];this.finishCoordinate_=o.slice(),this.sketchCoords_.push(o.slice()),this.sketchPoint_=new Feature(new Point(o)),this.updateSketchFeatures_(),this.dispatchEvent(new DrawEvent(DrawEventType.DRAWSTART,this.sketchFeature_))}updateSketchFeatures_(){const t=[];this.sketchFeature_&&t.push(this.sketchFeature_),this.sketchLine_&&t.push(this.sketchLine_),this.sketchPoint_&&t.push(this.sketchPoint_);const n=this.overlay_.getSource();n.clear(!0),n.addFeatures(t)}updateState_(){const t=this.getMap(),n=this.getActive();(!t||!n)&&this.abortDrawing(),this.overlay_.setMap(n?t:null)}}function getDefaultStyleFunction$1(){const l=createEditingStyle();return function(t,n){return l[t.getGeometry().getType()]}}function createBox(){return function(l,t,n){const s=boundingExtent([l[0],l[l.length-1]].map(function(a){return fromUserCoordinate(a)})),o=[[getBottomLeft(s),getBottomRight(s),getTopRight(s),getTopLeft(s),getBottomLeft(s)]];return t?t.setCoordinates(o):t=new Polygon(o),t}}function getMode(l){switch(l){case"Point":case"MultiPoint":return"Point";case"LineString":case"MultiLineString":return"LineString";case"Polygon":case"MultiPolygon":return"Polygon";case"Circle":return"Circle";default:throw new Error("Invalid type: "+l)}}const CIRCLE_CENTER_INDEX=0,CIRCLE_CIRCUMFERENCE_INDEX=1,tempExtent=[0,0,0,0],tempSegment=[],ModifyEventType={MODIFYSTART:"modifystart",MODIFYEND:"modifyend"};function getCoordinatesArray(l,t,n){let s;switch(t){case"LineString":s=l;break;case"MultiLineString":case"Polygon":s=l[n[0]];break;case"MultiPolygon":s=l[n[1]][n[0]];break}return s}class ModifyEvent extends BaseEvent{constructor(t,n,s){super(t),this.features=n,this.mapBrowserEvent=s}}class Modify extends PointerInteraction{constructor(t){super(t),this.on,this.once,this.un,this.boundHandleFeatureChange_=this.handleFeatureChange_.bind(this),this.condition_=t.condition?t.condition:primaryAction,this.defaultDeleteCondition_=function(s){return altKeyOnly(s)&&singleClick(s)},this.deleteCondition_=t.deleteCondition?t.deleteCondition:this.defaultDeleteCondition_,this.insertVertexCondition_=t.insertVertexCondition?t.insertVertexCondition:always$1,this.vertexFeature_=null,this.vertexSegments_=null,this.lastCoordinate_=[0,0],this.ignoreNextSingleClick_=!1,this.featuresBeingModified_=null,this.rBush_=new RBush,this.pixelTolerance_=t.pixelTolerance!==void 0?t.pixelTolerance:10,this.snappedToVertex_=!1,this.changingFeature_=!1,this.dragSegments_=[],this.overlay_=new VectorLayer({source:new VectorSource({useSpatialIndex:!1,wrapX:!!t.wrapX}),style:t.style?t.style:getDefaultStyleFunction(),updateWhileAnimating:!0,updateWhileInteracting:!0}),this.SEGMENT_WRITERS_={Point:this.writePointGeometry_.bind(this),LineString:this.writeLineStringGeometry_.bind(this),LinearRing:this.writeLineStringGeometry_.bind(this),Polygon:this.writePolygonGeometry_.bind(this),MultiPoint:this.writeMultiPointGeometry_.bind(this),MultiLineString:this.writeMultiLineStringGeometry_.bind(this),MultiPolygon:this.writeMultiPolygonGeometry_.bind(this),Circle:this.writeCircleGeometry_.bind(this),GeometryCollection:this.writeGeometryCollectionGeometry_.bind(this)},this.source_=null,this.traceSource_=t.traceSource||t.source||null,this.traceCondition_,this.setTrace(t.trace||!1),this.traceState_={active:!1},this.traceSegments_=null,this.hitDetection_=null;let n;if(t.features?n=t.features:t.source&&(this.source_=t.source,n=new Collection(this.source_.getFeatures()),this.source_.addEventListener(VectorEventType.ADDFEATURE,this.handleSourceAdd_.bind(this)),this.source_.addEventListener(VectorEventType.REMOVEFEATURE,this.handleSourceRemove_.bind(this))),!n)throw new Error("The modify interaction requires features, a source or a layer");t.hitDetection&&(this.hitDetection_=t.hitDetection),this.features_=n,this.features_.forEach(this.addFeature_.bind(this)),this.features_.addEventListener(CollectionEventType.ADD,this.handleFeatureAdd_.bind(this)),this.features_.addEventListener(CollectionEventType.REMOVE,this.handleFeatureRemove_.bind(this)),this.lastPointerEvent_=null,this.delta_=[0,0],this.snapToPointer_=t.snapToPointer===void 0?!this.hitDetection_:t.snapToPointer}setTrace(t){let n;t?t===!0?n=always$1:n=t:n=never,this.traceCondition_=n}addFeature_(t){const n=t.getGeometry();if(n){const o=this.SEGMENT_WRITERS_[n.getType()];o&&o(t,n)}const s=this.getMap();s&&s.isRendered()&&this.getActive()&&this.handlePointerAtPixel_(this.lastCoordinate_),t.addEventListener(EventType$1.CHANGE,this.boundHandleFeatureChange_)}willModifyFeatures_(t,n){if(!this.featuresBeingModified_){this.featuresBeingModified_=new Collection;const s=this.featuresBeingModified_.getArray();for(let o=0,a=n.length;o<a;++o){const h=n[o].feature;h&&!s.includes(h)&&this.featuresBeingModified_.push(h)}this.featuresBeingModified_.getLength()===0?this.featuresBeingModified_=null:this.dispatchEvent(new ModifyEvent(ModifyEventType.MODIFYSTART,this.featuresBeingModified_,t))}}removeFeature_(t){this.removeFeatureSegmentData_(t),this.vertexFeature_&&this.features_.getLength()===0&&(this.overlay_.getSource().removeFeature(this.vertexFeature_),this.vertexFeature_=null),t.removeEventListener(EventType$1.CHANGE,this.boundHandleFeatureChange_)}removeFeatureSegmentData_(t){const n=this.rBush_,s=[];n.forEach(function(o){t===o.feature&&s.push(o)});for(let o=s.length-1;o>=0;--o){const a=s[o];for(let h=this.dragSegments_.length-1;h>=0;--h)this.dragSegments_[h][0]===a&&this.dragSegments_.splice(h,1);n.remove(a)}}setActive(t){this.vertexFeature_&&!t&&(this.overlay_.getSource().removeFeature(this.vertexFeature_),this.vertexFeature_=null),super.setActive(t)}setMap(t){this.overlay_.setMap(t),super.setMap(t)}getOverlay(){return this.overlay_}handleSourceAdd_(t){t.feature&&this.features_.push(t.feature)}handleSourceRemove_(t){t.feature&&this.features_.remove(t.feature)}handleFeatureAdd_(t){this.addFeature_(t.element)}handleFeatureChange_(t){if(!this.changingFeature_){const n=t.target;this.removeFeature_(n),this.addFeature_(n)}}handleFeatureRemove_(t){this.removeFeature_(t.element)}writePointGeometry_(t,n){const s=n.getCoordinates(),o={feature:t,geometry:n,segment:[s,s]};this.rBush_.insert(n.getExtent(),o)}writeMultiPointGeometry_(t,n){const s=n.getCoordinates();for(let o=0,a=s.length;o<a;++o){const h=s[o],c={feature:t,geometry:n,depth:[o],index:o,segment:[h,h]};this.rBush_.insert(n.getExtent(),c)}}writeLineStringGeometry_(t,n){const s=n.getCoordinates();for(let o=0,a=s.length-1;o<a;++o){const h=s.slice(o,o+2),c={feature:t,geometry:n,index:o,segment:h};this.rBush_.insert(boundingExtent(h),c)}}writeMultiLineStringGeometry_(t,n){const s=n.getCoordinates();for(let o=0,a=s.length;o<a;++o){const h=s[o];for(let c=0,u=h.length-1;c<u;++c){const d=h.slice(c,c+2),f={feature:t,geometry:n,depth:[o],index:c,segment:d};this.rBush_.insert(boundingExtent(d),f)}}}writePolygonGeometry_(t,n){const s=n.getCoordinates();for(let o=0,a=s.length;o<a;++o){const h=s[o];for(let c=0,u=h.length-1;c<u;++c){const d=h.slice(c,c+2),f={feature:t,geometry:n,depth:[o],index:c,segment:d};this.rBush_.insert(boundingExtent(d),f)}}}writeMultiPolygonGeometry_(t,n){const s=n.getCoordinates();for(let o=0,a=s.length;o<a;++o){const h=s[o];for(let c=0,u=h.length;c<u;++c){const d=h[c];for(let f=0,g=d.length-1;f<g;++f){const _=d.slice(f,f+2),m={feature:t,geometry:n,depth:[c,o],index:f,segment:_};this.rBush_.insert(boundingExtent(_),m)}}}}writeCircleGeometry_(t,n){const s=n.getCenter(),o={feature:t,geometry:n,index:CIRCLE_CENTER_INDEX,segment:[s,s]},a={feature:t,geometry:n,index:CIRCLE_CIRCUMFERENCE_INDEX,segment:[s,s]},h=[o,a];o.featureSegments=h,a.featureSegments=h,this.rBush_.insert(createOrUpdateFromCoordinate(s),o);let c=n;this.rBush_.insert(c.getExtent(),a)}writeGeometryCollectionGeometry_(t,n){const s=n.getGeometriesArray();for(let o=0;o<s.length;++o){const a=s[o],h=this.SEGMENT_WRITERS_[a.getType()];h(t,a)}}createOrUpdateVertexFeature_(t,n,s,o){let a=this.vertexFeature_;return a?a.getGeometry().setCoordinates(t):(a=new Feature(new Point(t)),this.vertexFeature_=a,this.overlay_.getSource().addFeature(a)),a.set("features",n),a.set("geometries",s),a.set("existing",o),a}handleEvent(t){if(!t.originalEvent)return!0;this.lastPointerEvent_=t;let n;return!t.map.getView().getInteracting()&&t.type==MapBrowserEventType.POINTERMOVE&&!this.handlingDownUpSequence&&this.handlePointerMove_(t),this.vertexFeature_&&this.deleteCondition_(t)&&(t.type!=MapBrowserEventType.SINGLECLICK||!this.ignoreNextSingleClick_?n=this.removePoint():n=!0),t.type==MapBrowserEventType.SINGLECLICK&&(this.ignoreNextSingleClick_=!1),super.handleEvent(t)&&!n}findInsertVerticesAndUpdateDragSegments_(t){if(this.handlePointerAtPixel_(t),this.dragSegments_.length=0,this.featuresBeingModified_=null,!this.vertexFeature_)return;this.getMap().getView().getProjection();const s=[],o=this.vertexFeature_.getGeometry().getCoordinates(),a=boundingExtent([o]),h=this.rBush_.getInExtent(a),c={};h.sort(compareIndexes);for(let u=0,d=h.length;u<d;++u){const f=h[u],g=f.segment;let _=getUid(f.geometry);const m=f.depth;if(m&&(_+="-"+m.join("-")),c[_]||(c[_]=new Array(2)),f.geometry.getType()==="Circle"&&f.index===CIRCLE_CIRCUMFERENCE_INDEX){const p=closestOnSegmentData(t,f);equals(p,o)&&!c[_][0]&&(this.dragSegments_.push([f,0]),c[_][0]=f);continue}if(equals(g[0],o)&&!c[_][0]){this.dragSegments_.push([f,0]),c[_][0]=f;continue}if(equals(g[1],o)&&!c[_][1]){if(c[_][0]&&c[_][0].index===0){let p=f.geometry.getCoordinates();switch(f.geometry.getType()){case"LineString":case"MultiLineString":continue;case"MultiPolygon":p=p[m[1]];case"Polygon":if(f.index!==p[m[0]].length-2)continue;break}}this.dragSegments_.push([f,1]),c[_][1]=f;continue}getUid(g)in this.vertexSegments_&&!c[_][0]&&!c[_][1]&&s.push(f)}return s}deactivateTrace_(){this.traceState_={active:!1}}updateTrace_(t){const n=this.traceState_;if(!n.active)return;if(n.targetIndex===-1){const a=t.map.getPixelFromCoordinate(n.startCoord);if(distance(a,t.pixel)<this.pixelTolerance_)return}const s=getTraceTargetUpdate(t.coordinate,n,t.map,this.pixelTolerance_);if(n.targetIndex===-1&&Math.sqrt(s.closestTargetDistance)/t.map.getView().getResolution()>this.pixelTolerance_)return;if(n.targetIndex!==s.index){if(n.targetIndex!==-1){const h=n.targets[n.targetIndex];this.removeTracedCoordinates_(h.startIndex,h.endIndex)}else for(const h of this.traceSegments_){const c=h[0],u=c.geometry,d=h[1],f=u.getCoordinates();getCoordinatesArray(f,u.getType(),c.depth).splice(c.index+d,1),u.setCoordinates(f),d===0&&(c.index-=1)}const a=n.targets[s.index];this.addTracedCoordinates_(a,a.startIndex,s.endIndex)}else{const a=n.targets[n.targetIndex];this.addOrRemoveTracedCoordinates_(a,s.endIndex)}n.targetIndex=s.index;const o=n.targets[n.targetIndex];o.endIndex=s.endIndex}getTraceCandidates_(t){const n=this.getMap(),s=this.pixelTolerance_,o=n.getCoordinateFromPixel([t.pixel[0]-s,t.pixel[1]+s]),a=n.getCoordinateFromPixel([t.pixel[0]+s,t.pixel[1]-s]),h=boundingExtent([o,a]);return this.traceSource_.getFeaturesInExtent(h)}toggleTraceState_(t){if(!this.traceSource_||!this.traceCondition_(t))return;if(this.traceState_.active){this.deactivateTrace_(),this.traceSegments_=null;return}const n=this.getTraceCandidates_(t);if(n.length===0)return;const s=getTraceTargets(t.coordinate,n);s.length&&(this.traceState_={active:!0,startCoord:t.coordinate.slice(),targets:s,targetIndex:-1})}addOrRemoveTracedCoordinates_(t,n){const s=t.startIndex<=t.endIndex,o=t.startIndex<=n;s===o?s&&n>t.endIndex||!s&&n<t.endIndex?this.addTracedCoordinates_(t,t.endIndex,n):(s&&n<t.endIndex||!s&&n>t.endIndex)&&this.removeTracedCoordinates_(n,t.endIndex):(this.removeTracedCoordinates_(t.startIndex,t.endIndex),this.addTracedCoordinates_(t,t.startIndex,n))}removeTracedCoordinates_(t,n){if(t===n)return;let s=0;if(t<n){const o=Math.ceil(t);let a=Math.floor(n);a===n&&(a-=1),s=a-o+1}else{const o=Math.floor(t);let a=Math.ceil(n);a===n&&(a+=1),s=o-a+1}if(s>0)for(const o of this.traceSegments_){const a=o[0],h=a.geometry,c=o[1];let u=o[0].index+1;c===1&&(u-=s);const d=h.getCoordinates();getCoordinatesArray(d,h.getType(),a.depth).splice(u,s),h.setCoordinates(d),c===1&&(a.index-=s)}}addTracedCoordinates_(t,n,s){if(n===s)return;const o=[];if(n<s){const a=Math.ceil(n);let h=Math.floor(s);h===s&&(h-=1);for(let c=a;c<=h;++c)o.push(getCoordinate(t.coordinates,c))}else{const a=Math.floor(n);let h=Math.ceil(s);h===s&&(h+=1);for(let c=a;c>=h;--c)o.push(getCoordinate(t.coordinates,c))}if(o.length)for(const a of this.traceSegments_){const h=a[0],c=h.geometry,u=a[1],d=h.index+1;u===0&&o.reverse();const f=c.getCoordinates();getCoordinatesArray(f,c.getType(),h.depth).splice(d,0,...o),c.setCoordinates(f),u===1&&(h.index+=o.length)}}updateGeometry_(t,n){const s=n[0],o=s.depth;let a;const h=s.segment,c=s.geometry,u=n[1];for(;t.length<c.getStride();)t.push(h[u][t.length]);switch(c.getType()){case"Point":a=t,h[0]=t,h[1]=t;break;case"MultiPoint":a=c.getCoordinates(),a[s.index]=t,h[0]=t,h[1]=t;break;case"LineString":a=c.getCoordinates(),a[s.index+u]=t,h[u]=t;break;case"MultiLineString":a=c.getCoordinates(),a[o[0]][s.index+u]=t,h[u]=t;break;case"Polygon":a=c.getCoordinates(),a[o[0]][s.index+u]=t,h[u]=t;break;case"MultiPolygon":a=c.getCoordinates(),a[o[1]][o[0]][s.index+u]=t,h[u]=t;break;case"Circle":const d=c;if(h[0]=t,h[1]=t,s.index===CIRCLE_CENTER_INDEX)this.changingFeature_=!0,d.setCenter(t),this.changingFeature_=!1;else{this.changingFeature_=!0,this.getMap().getView().getProjection();let f=distance(fromUserCoordinate(d.getCenter()),fromUserCoordinate(t));d.setRadius(f),this.changingFeature_=!1}break}a&&this.setGeometryCoordinates_(c,a)}handleDragEvent(t){this.ignoreNextSingleClick_=!1,this.willModifyFeatures_(t,this.dragSegments_.map(([h])=>h));const n=[t.coordinate[0]+this.delta_[0],t.coordinate[1]+this.delta_[1]],s=[],o=[],a=this.traceState_.active&&!this.traceSegments_?this.traceState_.startCoord:null;if(a){this.traceSegments_=[];for(const h of this.dragSegments_){const c=h[0];distance(closestOnSegment(a,c.segment),a)/t.map.getView().getResolution()<1&&this.traceSegments_.push(h)}}for(let h=0,c=this.dragSegments_.length;h<c;++h){const u=this.dragSegments_[h],d=u[0],f=d.feature;s.includes(f)||s.push(f);const g=d.geometry;o.includes(g)||o.push(g),this.updateGeometry_(n,u)}this.updateTrace_(t),this.createOrUpdateVertexFeature_(n,s,o,!0)}handleDownEvent(t){if(!this.condition_(t))return!1;const n=t.coordinate,s=this.findInsertVerticesAndUpdateDragSegments_(n);if(s!=null&&s.length&&this.insertVertexCondition_(t)&&(this.willModifyFeatures_(t,s),this.vertexFeature_)){const o=this.vertexFeature_.getGeometry().getCoordinates();for(let a=s.length-1;a>=0;--a)this.insertVertex_(s[a],o);this.ignoreNextSingleClick_=!0}return!!this.vertexFeature_}handleUpEvent(t){for(let n=this.dragSegments_.length-1;n>=0;--n){const s=this.dragSegments_[n][0],o=s.geometry;if(o.getType()==="Circle"){const a=o,h=a.getCenter(),c=s.featureSegments[0],u=s.featureSegments[1];c.segment[0]=h,c.segment[1]=h,u.segment[0]=h,u.segment[1]=h,this.rBush_.update(createOrUpdateFromCoordinate(h),c);let d=a;this.rBush_.update(d.getExtent(),u)}else this.rBush_.update(boundingExtent(s.segment),s)}return this.featuresBeingModified_&&(this.toggleTraceState_(t),this.dispatchEvent(new ModifyEvent(ModifyEventType.MODIFYEND,this.featuresBeingModified_,t)),this.featuresBeingModified_=null),!1}handlePointerMove_(t){this.lastCoordinate_=t.coordinate,this.handlePointerAtPixel_(this.lastCoordinate_)}handlePointerAtPixel_(t){const n=this.getMap(),s=n.getPixelFromCoordinate(t);n.getView().getProjection();const o=function(c,u){return projectedDistanceToSegmentDataSquared(t,c)-projectedDistanceToSegmentDataSquared(t,u)};let a,h;if(this.hitDetection_){const c=typeof this.hitDetection_=="object"?u=>u===this.hitDetection_:void 0;n.forEachFeatureAtPixel(s,(u,d,f)=>{f&&f.getType()==="Point"&&(f=new Point(toUserCoordinate(f.getCoordinates())));const g=f||u.getGeometry();if(g&&g.getType()==="Point"&&u instanceof Feature&&this.features_.getArray().includes(u)){h=g;const _=u.getGeometry().getFlatCoordinates().slice(0,2);a=[{feature:u,geometry:h,segment:[_,_]}]}return!0},{layerFilter:c})}if(!a){const c=fromUserExtent(createOrUpdateFromCoordinate(t,tempExtent)),u=n.getView().getResolution()*this.pixelTolerance_,d=toUserExtent(buffer(c,u,tempExtent));a=this.rBush_.getInExtent(d)}if(a&&a.length>0){const c=a.sort(o)[0],u=c.segment;let d=closestOnSegmentData(t,c);const f=n.getPixelFromCoordinate(d);let g=distance(s,f);if(h||g<=this.pixelTolerance_){const _={};if(_[getUid(u)]=!0,this.snapToPointer_||(this.delta_[0]=d[0]-t[0],this.delta_[1]=d[1]-t[1]),c.geometry.getType()==="Circle"&&c.index===CIRCLE_CIRCUMFERENCE_INDEX)this.snappedToVertex_=!0,this.createOrUpdateVertexFeature_(d,[c.feature],[c.geometry],this.snappedToVertex_);else{const m=n.getPixelFromCoordinate(u[0]),p=n.getPixelFromCoordinate(u[1]),x=squaredDistance(f,m),y=squaredDistance(f,p);if(g=Math.sqrt(Math.min(x,y)),this.snappedToVertex_=g<=this.pixelTolerance_,!this.snappedToVertex_&&!this.insertVertexCondition_(this.lastPointerEvent_)){this.vertexFeature_&&(this.overlay_.getSource().removeFeature(this.vertexFeature_),this.vertexFeature_=null);return}this.snappedToVertex_&&(d=x>y?u[1]:u[0]),this.createOrUpdateVertexFeature_(d,[c.feature],[c.geometry],this.snappedToVertex_);const T={};T[getUid(c.geometry)]=!0;for(let S=1,C=a.length;S<C;++S){const P=a[S].segment;if(equals(u[0],P[0])&&equals(u[1],P[1])||equals(u[0],P[1])&&equals(u[1],P[0])){const w=getUid(a[S].geometry);w in T||(T[w]=!0,_[getUid(P)]=!0)}else break}}this.vertexSegments_=_;return}}this.vertexFeature_&&(this.overlay_.getSource().removeFeature(this.vertexFeature_),this.vertexFeature_=null)}insertVertex_(t,n){const s=t.segment,o=t.feature,a=t.geometry,h=t.depth,c=t.index;let u;for(;n.length<a.getStride();)n.push(0);switch(a.getType()){case"MultiLineString":u=a.getCoordinates(),u[h[0]].splice(c+1,0,n);break;case"Polygon":u=a.getCoordinates(),u[h[0]].splice(c+1,0,n);break;case"MultiPolygon":u=a.getCoordinates(),u[h[1]][h[0]].splice(c+1,0,n);break;case"LineString":u=a.getCoordinates(),u.splice(c+1,0,n);break;default:return!1}this.setGeometryCoordinates_(a,u);const d=this.rBush_;d.remove(t),this.updateSegmentIndices_(a,c,h,1);const f={segment:[s[0],n],feature:o,geometry:a,depth:h,index:c};d.insert(boundingExtent(f.segment),f),this.dragSegments_.push([f,1]);const g={segment:[n,s[1]],feature:o,geometry:a,depth:h,index:c+1};return d.insert(boundingExtent(g.segment),g),this.dragSegments_.push([g,0]),!0}updatePointer_(t){var n;return t&&this.findInsertVerticesAndUpdateDragSegments_(t),(n=this.vertexFeature_)==null?void 0:n.getGeometry().getCoordinates()}getPoint(){var n;const t=(n=this.vertexFeature_)==null?void 0:n.getGeometry().getCoordinates();return t?toUserCoordinate(t,this.getMap().getView().getProjection()):null}canRemovePoint(){if(!this.vertexFeature_||this.vertexFeature_.get("geometries").every(s=>s.getType()==="Circle"||s.getType().endsWith("Point")))return!1;const t=this.vertexFeature_.getGeometry().getCoordinates();return this.rBush_.getInExtent(boundingExtent([t])).some(({segment:s})=>equals(s[0],t)||equals(s[1],t))}removePoint(t){if(t&&(t=fromUserCoordinate(t,this.getMap().getView().getProjection()),this.updatePointer_(t)),!this.lastPointerEvent_||this.lastPointerEvent_&&this.lastPointerEvent_.type!=MapBrowserEventType.POINTERDRAG){const n=this.lastPointerEvent_;this.willModifyFeatures_(n,this.dragSegments_.map(([o])=>o));const s=this.removeVertex_();return this.featuresBeingModified_&&this.dispatchEvent(new ModifyEvent(ModifyEventType.MODIFYEND,this.featuresBeingModified_,n)),this.featuresBeingModified_=null,s}return!1}removeVertex_(){const t=this.dragSegments_,n={};let s=!1,o,a,h,c,u,d,f,g,_,m,p;for(u=t.length-1;u>=0;--u)h=t[u],m=h[0],p=getUid(m.feature),m.depth&&(p+="-"+m.depth.join("-")),p in n||(n[p]={}),h[1]===0?(n[p].right=m,n[p].index=m.index):h[1]==1&&(n[p].left=m,n[p].index=m.index+1);for(p in n){switch(_=n[p].right,f=n[p].left,d=n[p].index,g=d-1,f!==void 0?m=f:m=_,g<0&&(g=0),c=m.geometry,a=c.getCoordinates(),o=a,s=!1,c.getType()){case"MultiLineString":a[m.depth[0]].length>2&&(a[m.depth[0]].splice(d,1),s=!0);break;case"LineString":a.length>2&&(a.splice(d,1),s=!0);break;case"MultiPolygon":o=o[m.depth[1]];case"Polygon":o=o[m.depth[0]],o.length>4&&(d==o.length-1&&(d=0),o.splice(d,1),s=!0,d===0&&(o.pop(),o.push(o[0]),g=o.length-1));break}if(s){this.setGeometryCoordinates_(c,a);const x=[];if(f!==void 0&&(this.rBush_.remove(f),x.push(f.segment[0])),_!==void 0&&(this.rBush_.remove(_),x.push(_.segment[1])),f!==void 0&&_!==void 0){const y={depth:m.depth,feature:m.feature,geometry:m.geometry,index:g,segment:x};this.rBush_.insert(boundingExtent(y.segment),y)}this.updateSegmentIndices_(c,d,m.depth,-1),this.vertexFeature_&&(this.overlay_.getSource().removeFeature(this.vertexFeature_),this.vertexFeature_=null),t.length=0}}return s}canInsertPoint(){if(!this.vertexFeature_||this.vertexFeature_.get("geometries").every(s=>s.getType()==="Circle"||s.getType().endsWith("Point")))return!1;const t=this.vertexFeature_.getGeometry().getCoordinates();return this.rBush_.getInExtent(boundingExtent([t])).some(({segment:s})=>!(equals(s[0],t)||equals(s[1],t)))}insertPoint(t){var o;const n=t?fromUserCoordinate(t,this.getMap().getView().getProjection()):(o=this.vertexFeature_)==null?void 0:o.getGeometry().getCoordinates();return n?this.findInsertVerticesAndUpdateDragSegments_(n).reduce((a,h)=>a||this.insertVertex_(h,n),!1):!1}setGeometryCoordinates_(t,n){this.changingFeature_=!0,t.setCoordinates(n),this.changingFeature_=!1}updateSegmentIndices_(t,n,s,o){this.rBush_.forEachInExtent(t.getExtent(),function(a){a.geometry===t&&(s===void 0||a.depth===void 0||equals$2(a.depth,s))&&a.index>n&&(a.index+=o)})}}function compareIndexes(l,t){return l.index-t.index}function projectedDistanceToSegmentDataSquared(l,t,n){const s=t.geometry;if(s.getType()==="Circle"){let a=s;if(t.index===CIRCLE_CIRCUMFERENCE_INDEX){const h=squaredDistance(a.getCenter(),fromUserCoordinate(l)),c=Math.sqrt(h)-a.getRadius();return c*c}}const o=fromUserCoordinate(l);return tempSegment[0]=fromUserCoordinate(t.segment[0]),tempSegment[1]=fromUserCoordinate(t.segment[1]),squaredDistanceToSegment(o,tempSegment)}function closestOnSegmentData(l,t,n){const s=t.geometry;if(s.getType()==="Circle"&&t.index===CIRCLE_CIRCUMFERENCE_INDEX)return toUserCoordinate(s.getClosestPoint(fromUserCoordinate(l)));const o=fromUserCoordinate(l);return tempSegment[0]=fromUserCoordinate(t.segment[0]),tempSegment[1]=fromUserCoordinate(t.segment[1]),toUserCoordinate(closestOnSegment(o,tempSegment))}function getDefaultStyleFunction(){const l=createEditingStyle();return function(t,n){return l.Point}}const controlCss='.geolocation{top:85px;left:.5em}.geolocation button{background:var(--primary);color:var(--on-primary)}.geolocation button>svg{fill:var(--on-primary);min-inline-size:1.25rem!important;max-inline-size:1.25rem!important;min-block-size:1.25rem!important;max-block-size:1.25rem!important}.ol-touch.geolocation{top:100px}.loading-indicator{position:absolute;pointer-events:none!important;display:flex;align-items:center;justify-content:center;background-color:#0000}.loading-indicator.small{bottom:.5em;left:.5em;width:30px;height:30px}.loading-indicator.fullscreen{width:100%;height:100%}.disabled{filter:brightness(1.7);pointer-events:none}.ol-unselectable{pointer-events:none}.ol-control{background:none}.ol-control button,.ol-control button:hover,.ol-control button:focus{--_round: 32px;border-radius:var(--_round);background:var(--primary);color:var(--on-primary);width:32px;height:32px;cursor:pointer;border:none;outline:none;pointer-events:all;position:relative;font-size:1rem}.ol-control button:hover:after{background-size:15000%;opacity:.1;transition:background-size var(--speed2) linear;content:"";position:absolute;top:0;right:0;bottom:0;left:0;z-index:1;border-radius:inherit;inline-size:100%;block-size:100%;background-position:center;background-image:radial-gradient(circle,currentColor 1%,transparent 1%)}.ol-control button.ol-zoom-in,.ol-control button.ol-zoom-in:hover{border-top-left-radius:var(--_round);border-top-right-radius:var(--_round);border-bottom-left-radius:.5rem;border-bottom-right-radius:.5rem;margin-bottom:.125rem}.ol-control button.ol-zoom-out,.ol-control button.ol-zoom-out:hover{border-top-left-radius:.5rem;border-top-right-radius:.5rem;border-bottom-left-radius:var(--_round);border-bottom-right-radius:var(--_round)}';var Pu,Wu;class EOxMapCompare extends i{constructor(){super();mo(this,Pu);this.value=50,this.enabled="true"}static get properties(){return{value:{attribute:"value",type:Number},enabled:{attribute:"enabled",type:String}}}render(){return b`
      <style>
        :host {
          display: block;
          --thumb-size: 3rem;
        }
        .eox-map-compare {
          --thumb-bgc: #fff;
          --thumb-w: var(--thumb-size);

          position: relative;
          height: 100%;
        }
        .eox-map-compare::after {
          content: "";
          display: block;
        }
        .eox-map-compare__first,
        .eox-map-compare__second {
          height: 100%;
          object-fit: cover;
          position: absolute;
          top: 0;
          width: 100%;
        }
        .eox-map-compare__first {
          clip-path: polygon(
            0% 0%,
            ${this.value}% 0%,
            ${this.value}% 100%,
            0% 100%
          );
        }
        .eox-map-compare__second {
          clip-path: polygon(
            100% 0%,
            ${this.value}% 0%,
            ${this.value}% 100%,
            100% 100%
          );
        }
        .eox-map-compare__range {
          background-color: transparent;
          box-sizing: border-box;
          font-family: inherit;
          height: 100%;
          margin: 0;
          outline: none;
          position: absolute;
          top: 0;
          width: 100%;
          pointer-events: none;
        }
        .eox-map-compare__range::-moz-range-thumb {
          cursor: ew-resize;
          height: 100%;
          width: var(--thumb-w);
          pointer-events: all;
          background: transparent;
          border: none;
        }
        .eox-map-compare__range::-webkit-slider-thumb {
          cursor: ew-resize;
          height: 100%;
          width: var(--thumb-w);
          pointer-events: all;
          position: relative;
          background: transparent;
          border: none;
        }
        .eox-map-compare__range::-moz-range-track {
          background: transparent;
          background-size: 100%;
          box-sizing: border-box;
        }
        .eox-map-compare__range::-webkit-slider-runnable-track {
          background: transparent;
          background-size: 100%;
          box-sizing: border-box;
          height: 100%;
        }
        .eox-map-compare__range,
        .eox-map-compare__range::-webkit-slider-runnable-track,
        .eox-map-compare__range::-webkit-slider-thumb {
          -webkit-appearance: none;
          appearance: none;
        }
        .slider-bar,
        .slider-thumb {
          position: absolute;
          box-shadow: 0 0.125rem 0.125rem 0 rgb(0 0 0 / 0.32);
        }
        .slider-bar {
          pointer-events: none;
          top: 0;
          width: 0.3rem;
          height: 100%;
          background-color: var(--thumb-bgc);
          z-index: 2;
          left: calc(${this.value}% - 0.15rem);
          -webkit-clip-path: inset(0 -5px 0 -5px);
          clip-path: inset(0 -5px 0 -5px);
        }
        .slider-thumb {
          pointer-events: none;
          top: calc(50% - var(--thumb-size) / 2);
          background: var(--primary);
          z-index: 3;
          width: var(--thumb-size);
          aspect-ratio: 1;
          left: calc(${this.value}% - var(--thumb-size) / 2);
          border-radius: 50%;
          padding: 0.7rem;
          color: var(--on-primary);
          display: flex;
          align-items: center;
          justify-content: center;
          box-sizing: border-box;
        }
        .slider-thumb svg {
          fill: currentColor;
        }
      </style>
      ${r(this.enabled,[["first",()=>b`<slot name="first"></slot>`],["second",()=>b`<slot name="second"></slot>`]],()=>b`
          <div class="eox-map-compare">
            <div class="eox-map-compare__first">
              <slot name="first"></slot>
            </div>
            <div class="eox-map-compare__second">
              <slot name="second"></slot>
            </div>
            <input
              type="range"
              class="eox-map-compare__range"
              min="0"
              max="100"
              value=${this.value}
              @input=${Mc(this,Pu,Wu)}
            />
            <div class="slider-bar"></div>
            <div class="slider-thumb">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <title>arrow-left-right</title>
                <path
                  d="M6.45,17.45L1,12L6.45,6.55L7.86,7.96L4.83,11H19.17L16.14,7.96L17.55,6.55L23,12L17.55,17.45L16.14,16.04L19.17,13H4.83L7.86,16.04L6.45,17.45Z"
                />
              </svg>
            </div>
          </div>
        `)}
    `}}Pu=new WeakSet,Wu=function(n){this.value=parseInt(n.target.value)};customElements.define("eox-map-compare",EOxMapCompare);class FeatureFormat{constructor(){this.dataProjection=void 0,this.defaultFeatureProjection=void 0,this.featureClass=Feature,this.supportedMediaTypes=null}getReadOptions(t,n){if(n){let s=n.dataProjection?get$1(n.dataProjection):this.readProjection(t);n.extent&&s&&s.getUnits()==="tile-pixels"&&(s=get$1(s),s.setWorldExtent(n.extent)),n={dataProjection:s,featureProjection:n.featureProjection}}return this.adaptOptions(n)}adaptOptions(t){return Object.assign({dataProjection:this.dataProjection,featureProjection:this.defaultFeatureProjection,featureClass:this.featureClass},t)}getType(){return abstract()}readFeature(t,n){return abstract()}readFeatures(t,n){return abstract()}readGeometry(t,n){return abstract()}readProjection(t){return abstract()}writeFeature(t,n){return abstract()}writeFeatures(t,n){return abstract()}writeGeometry(t,n){return abstract()}}function transformGeometryWithOptions(l,t,n){const s=n?get$1(n.featureProjection):null,o=n?get$1(n.dataProjection):null;let a=l;if(s&&o&&!equivalent$1(s,o)){t&&(a=l.clone());const h=t?s:o,c=t?o:s;h.getUnits()==="tile-pixels"?a.transform(h,c):a.applyTransform(getTransform(h,c))}if(t&&n&&n.decimals!==void 0){const h=Math.pow(10,n.decimals),c=function(u){for(let d=0,f=u.length;d<f;++d)u[d]=Math.round(u[d]*h)/h;return u};a===l&&(a=l.clone()),a.applyTransform(c)}return a}function transformExtentWithOptions(l,t){const n=t?get$1(t.featureProjection):null,s=t?get$1(t.dataProjection):null;return n&&s&&!equivalent$1(n,s)?transformExtent$1(l,s,n):l}const GeometryConstructor$1={Point,LineString,Polygon,MultiPoint,MultiLineString,MultiPolygon};function orientFlatCoordinates(l,t,n){return Array.isArray(t[0])?(linearRingssAreOriented(l,0,t,n)||(l=l.slice(),orientLinearRingsArray(l,0,t,n)),l):(linearRingsAreOriented(l,0,t,n)||(l=l.slice(),orientLinearRings(l,0,t,n)),l)}function createRenderFeature(l,t){var a;const n=l.geometry;if(!n)return[];if(Array.isArray(n))return n.map(h=>createRenderFeature({...l,geometry:h})).flat();const s=n.type==="MultiPolygon"?"Polygon":n.type;if(s==="GeometryCollection"||s==="Circle")throw new Error("Unsupported geometry type: "+s);const o=n.layout.length;return transformGeometryWithOptions(new RenderFeature(s,s==="Polygon"?orientFlatCoordinates(n.flatCoordinates,n.ends,o):n.flatCoordinates,(a=n.ends)==null?void 0:a.flat(),o,l.properties||{},l.id).enableSimplifyTransformed(),!1,t)}function createGeometry(l,t){if(!l)return null;if(Array.isArray(l)){const s=l.map(o=>createGeometry(o,t));return new GeometryCollection(s)}const n=GeometryConstructor$1[l.type];return transformGeometryWithOptions(new n(l.flatCoordinates,l.layout||"XY",l.ends),!1,t)}class JSONFeature extends FeatureFormat{constructor(){super()}getType(){return"json"}readFeature(t,n){return this.readFeatureFromObject(getObject(t),this.getReadOptions(t,n))}readFeatures(t,n){return this.readFeaturesFromObject(getObject(t),this.getReadOptions(t,n))}readFeatureFromObject(t,n){return abstract()}readFeaturesFromObject(t,n){return abstract()}readGeometry(t,n){return this.readGeometryFromObject(getObject(t),this.getReadOptions(t,n))}readGeometryFromObject(t,n){return abstract()}readProjection(t){return this.readProjectionFromObject(getObject(t))}readProjectionFromObject(t){return abstract()}writeFeature(t,n){return JSON.stringify(this.writeFeatureObject(t,n))}writeFeatureObject(t,n){return abstract()}writeFeatures(t,n){return JSON.stringify(this.writeFeaturesObject(t,n))}writeFeaturesObject(t,n){return abstract()}writeGeometry(t,n){return JSON.stringify(this.writeGeometryObject(t,n))}writeGeometryObject(t,n){return abstract()}}function getObject(l){if(typeof l=="string"){const t=JSON.parse(l);return t||null}return l!==null?l:null}class GeoJSON extends JSONFeature{constructor(t){t=t||{},super(),this.dataProjection=get$1(t.dataProjection?t.dataProjection:"EPSG:4326"),t.featureProjection&&(this.defaultFeatureProjection=get$1(t.featureProjection)),t.featureClass&&(this.featureClass=t.featureClass),this.geometryName_=t.geometryName,this.extractGeometryName_=t.extractGeometryName,this.supportedMediaTypes=["application/geo+json","application/vnd.geo+json"]}readFeatureFromObject(t,n){let s=null;t.type==="Feature"?s=t:s={type:"Feature",geometry:t,properties:null};const o=readGeometryInternal(s.geometry);if(this.featureClass===RenderFeature)return createRenderFeature({geometry:o,id:s.id,properties:s.properties},n);const a=new Feature;return this.geometryName_?a.setGeometryName(this.geometryName_):this.extractGeometryName_&&s.geometry_name&&a.setGeometryName(s.geometry_name),a.setGeometry(createGeometry(o,n)),"id"in s&&a.setId(s.id),s.properties&&a.setProperties(s.properties,!0),a}readFeaturesFromObject(t,n){const s=t;let o=null;if(s.type==="FeatureCollection"){const a=t;o=[];const h=a.features;for(let c=0,u=h.length;c<u;++c){const d=this.readFeatureFromObject(h[c],n);d&&o.push(d)}}else o=[this.readFeatureFromObject(t,n)];return o.flat()}readGeometryFromObject(t,n){return readGeometry$1(t,n)}readProjectionFromObject(t){const n=t.crs;let s;if(n)if(n.type=="name")s=get$1(n.properties.name);else if(n.type==="EPSG")s=get$1("EPSG:"+n.properties.code);else throw new Error("Unknown SRS type");else s=this.dataProjection;return s}writeFeatureObject(t,n){n=this.adaptOptions(n);const s={type:"Feature",geometry:null,properties:null},o=t.getId();if(o!==void 0&&(s.id=o),!t.hasProperties())return s;const a=t.getProperties(),h=t.getGeometry();return h&&(s.geometry=writeGeometry$1(h,n),delete a[t.getGeometryName()]),isEmpty$1(a)||(s.properties=a),s}writeFeaturesObject(t,n){n=this.adaptOptions(n);const s=[];for(let o=0,a=t.length;o<a;++o)s.push(this.writeFeatureObject(t[o],n));return{type:"FeatureCollection",features:s}}writeGeometryObject(t,n){return writeGeometry$1(t,this.adaptOptions(n))}}function readGeometryInternal(l,t){if(!l)return null;let n;switch(l.type){case"Point":{n=readPointGeometry$2(l);break}case"LineString":{n=readLineStringGeometry$2(l);break}case"Polygon":{n=readPolygonGeometry$2(l);break}case"MultiPoint":{n=readMultiPointGeometry$2(l);break}case"MultiLineString":{n=readMultiLineStringGeometry$2(l);break}case"MultiPolygon":{n=readMultiPolygonGeometry$2(l);break}case"GeometryCollection":{n=readGeometryCollectionGeometry(l);break}default:throw new Error("Unsupported GeoJSON type: "+l.type)}return n}function readGeometry$1(l,t){const n=readGeometryInternal(l);return createGeometry(n,t)}function readGeometryCollectionGeometry(l,t){return l.geometries.map(function(s){return readGeometryInternal(s)})}function readPointGeometry$2(l){const t=l.coordinates;return{type:"Point",flatCoordinates:t,layout:getLayoutForStride(t.length)}}function readLineStringGeometry$2(l){var s;const t=l.coordinates,n=t.flat();return{type:"LineString",flatCoordinates:n,ends:[n.length],layout:getLayoutForStride(((s=t[0])==null?void 0:s.length)||2)}}function readMultiLineStringGeometry$2(l){var a,h;const t=l.coordinates,n=((h=(a=t[0])==null?void 0:a[0])==null?void 0:h.length)||2,s=[],o=deflateCoordinatesArray(s,0,t,n);return{type:"MultiLineString",flatCoordinates:s,ends:o,layout:getLayoutForStride(n)}}function readMultiPointGeometry$2(l){var n;const t=l.coordinates;return{type:"MultiPoint",flatCoordinates:t.flat(),layout:getLayoutForStride(((n=t[0])==null?void 0:n.length)||2)}}function readMultiPolygonGeometry$2(l){var a,h;const t=l.coordinates,n=[],s=((h=(a=t[0])==null?void 0:a[0])==null?void 0:h[0].length)||2,o=deflateMultiCoordinatesArray(n,0,t,s);return{type:"MultiPolygon",flatCoordinates:n,ends:o,layout:getLayoutForStride(s)}}function readPolygonGeometry$2(l){var a,h;const t=l.coordinates,n=[],s=(h=(a=t[0])==null?void 0:a[0])==null?void 0:h.length,o=deflateCoordinatesArray(n,0,t,s);return{type:"Polygon",flatCoordinates:n,ends:o,layout:getLayoutForStride(s)}}function writeGeometry$1(l,t){l=transformGeometryWithOptions(l,!0,t);const n=l.getType();let s;switch(n){case"Point":{s=writePointGeometry$1(l);break}case"LineString":{s=writeLineStringGeometry$1(l);break}case"Polygon":{s=writePolygonGeometry$1(l,t);break}case"MultiPoint":{s=writeMultiPointGeometry$1(l);break}case"MultiLineString":{s=writeMultiLineStringGeometry$1(l);break}case"MultiPolygon":{s=writeMultiPolygonGeometry$1(l,t);break}case"GeometryCollection":{s=writeGeometryCollectionGeometry(l,t);break}case"Circle":{s={type:"GeometryCollection",geometries:[]};break}default:throw new Error("Unsupported geometry type: "+n)}return s}function writeGeometryCollectionGeometry(l,t){return t=Object.assign({},t),delete t.featureProjection,{type:"GeometryCollection",geometries:l.getGeometriesArray().map(function(s){return writeGeometry$1(s,t)})}}function writeLineStringGeometry$1(l,t){return{type:"LineString",coordinates:l.getCoordinates()}}function writeMultiLineStringGeometry$1(l,t){return{type:"MultiLineString",coordinates:l.getCoordinates()}}function writeMultiPointGeometry$1(l,t){return{type:"MultiPoint",coordinates:l.getCoordinates()}}function writeMultiPolygonGeometry$1(l,t){let n;return t&&(n=t.rightHanded),{type:"MultiPolygon",coordinates:l.getCoordinates(n)}}function writePointGeometry$1(l,t){return{type:"Point",coordinates:l.getCoordinates()}}function writePolygonGeometry$1(l,t){let n;return t&&(n=t.rightHanded),{type:"Polygon",coordinates:l.getCoordinates(n)}}const READ_FEATURES_OPTIONS={dataProjection:"EPSG:4326",featureProjection:"EPSG:3857"};function addNewFeature(l,t,n,s=!1,o=!1,a=!0){const h=s?[l.feature]:l.features;o&&t.getSource().clear();const c=t.getSource().getFeatures();if(!t.get("multipleFeatures")&&(c.length||h.length>1))return console.error("Multiple features detected!");h.forEach(f=>{const g=f.getGeometry();if(g instanceof LineString){const m=getLength(g,{radius:6378137,projection:n.projection});f.set("measure",m)}else if(g instanceof Polygon){const m=getArea(g,{radius:6378137,projection:n.projection});f.set("measure",m)}const _=getUid(f);f.set("id",_),f.setId(_)}),!s&&h.length&&(t.getSource().addFeatures(h),n.map.getView().fit(t.getSource().getExtent(),{duration:a?750:0}));const u=new GeoJSON,d=JSON.parse(u.writeFeatures(h,READ_FEATURES_OPTIONS));(s||o)&&dispatchEvt(n,"drawend",l,d),dispatchEvt(n,"addfeatures",l,d)}function dispatchEvt(l,t,n,s){const o=new CustomEvent(t,{detail:{originalEvent:n,geoJSON:s}});l.dispatchEvent(o)}function cancelAnimation(l){l.setRotation(l.getRotation())}class TopoJSON extends JSONFeature{constructor(t){super(),t=t||{},this.layerName_=t.layerName,this.layers_=t.layers?t.layers:null,this.dataProjection=get$1(t.dataProjection?t.dataProjection:"EPSG:4326")}readFeaturesFromObject(t,n){if(t.type=="Topology"){const s=t;let o,a=null,h=null;s.transform&&(o=s.transform,a=o.scale,h=o.translate);const c=s.arcs;o&&transformArcs(c,a,h);const u=[],d=s.objects,f=this.layerName_;let g;for(const _ in d)this.layers_&&!this.layers_.includes(_)||(d[_].type==="GeometryCollection"?(g=d[_],u.push.apply(u,readFeaturesFromGeometryCollection(g,c,a,h,f,_,n))):(g=d[_],u.push(readFeatureFromGeometry(g,c,a,h,f,_,n))));return u}return[]}readProjectionFromObject(t){return this.dataProjection}}const GEOMETRY_READERS$1={Point:readPointGeometry$1,LineString:readLineStringGeometry$1,Polygon:readPolygonGeometry$1,MultiPoint:readMultiPointGeometry$1,MultiLineString:readMultiLineStringGeometry$1,MultiPolygon:readMultiPolygonGeometry$1};function concatenateArcs(l,t){const n=[];let s;for(let o=0,a=l.length;o<a;++o)if(s=l[o],o>0&&n.pop(),s>=0){const h=t[s];for(let c=0,u=h.length;c<u;++c)n.push(h[c].slice(0))}else{const h=t[~s];for(let c=h.length-1;c>=0;--c)n.push(h[c].slice(0))}return n}function readPointGeometry$1(l,t,n){const s=l.coordinates;return t&&n&&transformVertex(s,t,n),new Point(s)}function readMultiPointGeometry$1(l,t,n){const s=l.coordinates;if(t&&n)for(let o=0,a=s.length;o<a;++o)transformVertex(s[o],t,n);return new MultiPoint(s)}function readLineStringGeometry$1(l,t){const n=concatenateArcs(l.arcs,t);return new LineString(n)}function readMultiLineStringGeometry$1(l,t){const n=[];for(let s=0,o=l.arcs.length;s<o;++s)n[s]=concatenateArcs(l.arcs[s],t);return new MultiLineString(n)}function readPolygonGeometry$1(l,t){const n=[];for(let s=0,o=l.arcs.length;s<o;++s)n[s]=concatenateArcs(l.arcs[s],t);return new Polygon(n)}function readMultiPolygonGeometry$1(l,t){const n=[];for(let s=0,o=l.arcs.length;s<o;++s){const a=l.arcs[s],h=[];for(let c=0,u=a.length;c<u;++c)h[c]=concatenateArcs(a[c],t);n[s]=h}return new MultiPolygon(n)}function readFeaturesFromGeometryCollection(l,t,n,s,o,a,h){const c=l.geometries,u=[];for(let d=0,f=c.length;d<f;++d)u[d]=readFeatureFromGeometry(c[d],t,n,s,o,a,h);return u}function readFeatureFromGeometry(l,t,n,s,o,a,h){let c=null;const u=l.type;if(u){const g=GEOMETRY_READERS$1[u];u==="Point"||u==="MultiPoint"?c=g(l,n,s):c=g(l,t),c=transformGeometryWithOptions(c,!1,h)}const d=new Feature({geometry:c});l.id!==void 0&&d.setId(l.id);let f=l.properties;return o&&(f||(f={}),f[o]=a),f&&d.setProperties(f,!0),d}function transformArcs(l,t,n){for(let s=0,o=l.length;s<o;++s)transformArc(l[s],t,n)}function transformArc(l,t,n){let s=0,o=0;for(let a=0,h=l.length;a<h;++a){const c=l[a];s+=c[0],o+=c[1],c[0]=s,c[1]=o,transformVertex(c,t,n)}}function transformVertex(l,t,n){l[0]=l[0]*t[0]+n[0],l[1]=l[1]*t[1]+n[1]}const XML_SCHEMA_INSTANCE_URI="http://www.w3.org/2001/XMLSchema-instance";function createElementNS(l,t){return getDocument().createElementNS(l,t)}function getAllTextContent(l,t){return getAllTextContent_(l,t,[]).join("")}function getAllTextContent_(l,t,n){if(l.nodeType==Node.CDATA_SECTION_NODE||l.nodeType==Node.TEXT_NODE)n.push(l.nodeValue);else{let s;for(s=l.firstChild;s;s=s.nextSibling)getAllTextContent_(s,t,n)}return n}function isDocument(l){return"documentElement"in l}function getAttributeNS(l,t,n){return l.getAttributeNS(t,n)||""}function parse(l){return new DOMParser().parseFromString(l,"application/xml")}function makeArrayExtender(l,t){return function(n,s){const o=l.call(t??this,n,s);if(o!==void 0){const a=s[s.length-1];extend$2(a,o)}}}function makeArrayPusher(l,t){return function(n,s){const o=l.call(t??this,n,s);o!==void 0&&s[s.length-1].push(o)}}function makeReplacer(l,t){return function(n,s){const o=l.call(t??this,n,s);o!==void 0&&(s[s.length-1]=o)}}function makeObjectPropertyPusher(l,t,n){return function(s,o){const a=l.call(this,s,o);if(a!==void 0){const h=o[o.length-1],c=s.localName;let u;c in h?u=h[c]:(u=[],h[c]=u),u.push(a)}}}function makeObjectPropertySetter(l,t,n){return function(s,o){const a=l.call(this,s,o);if(a!==void 0){const h=o[o.length-1],c=t!==void 0?t:s.localName;h[c]=a}}}function makeChildAppender(l,t){return function(n,s,o){l.call(t??this,n,s,o),o[o.length-1].node.appendChild(n)}}function makeArraySerializer(l,t){let n,s;return function(o,a,h){if(n===void 0){n={};const c={};c[o.localName]=l,n[o.namespaceURI]=c,s=makeSimpleNodeFactory(o.localName)}serialize(n,s,a,h)}}function makeSimpleNodeFactory(l,t){return function(n,s,o){const h=s[s.length-1].node;let c=l;c===void 0&&(c=o);const u=t!==void 0?t:h.namespaceURI;return createElementNS(u,c)}}const OBJECT_PROPERTY_NODE_FACTORY=makeSimpleNodeFactory();function makeSequence(l,t){const n=t.length,s=new Array(n);for(let o=0;o<n;++o)s[o]=l[t[o]];return s}function makeStructureNS(l,t,n){n=n!==void 0?n:{};let s,o;for(s=0,o=l.length;s<o;++s)n[l[s]]=t;return n}function parseNode(l,t,n,s){let o;for(o=t.firstElementChild;o;o=o.nextElementSibling){const a=l[o.namespaceURI];if(a!==void 0){const h=a[o.localName];h!==void 0&&h.call(s,o,n)}}}function pushParseAndPop(l,t,n,s,o){return s.push(l),parseNode(t,n,s,o),s.pop()}function serialize(l,t,n,s,o,a){const h=(o!==void 0?o:n).length;let c,u;for(let d=0;d<h;++d)c=n[d],c!==void 0&&(u=t.call(a,c,s,o!==void 0?o[d]:void 0),u!==void 0&&l[u.namespaceURI][u.localName].call(a,u,c,s))}function pushSerializeAndPop(l,t,n,s,o,a,h){return o.push(l),serialize(t,n,s,o,a,h),o.pop()}let xmlSerializer_;function getXMLSerializer(){return xmlSerializer_===void 0&&typeof XMLSerializer<"u"&&(xmlSerializer_=new XMLSerializer),xmlSerializer_}let document_;function getDocument(){return document_===void 0&&typeof document<"u"&&(document_=document.implementation.createDocument("","",null)),document_}class XMLFeature extends FeatureFormat{constructor(){super(),this.xmlSerializer_=getXMLSerializer()}getType(){return"xml"}readFeature(t,n){if(!t)return null;if(typeof t=="string"){const s=parse(t);return this.readFeatureFromDocument(s,n)}return isDocument(t)?this.readFeatureFromDocument(t,n):this.readFeatureFromNode(t,n)}readFeatureFromDocument(t,n){const s=this.readFeaturesFromDocument(t,n);return s.length>0?s[0]:null}readFeatureFromNode(t,n){return null}readFeatures(t,n){if(!t)return[];if(typeof t=="string"){const s=parse(t);return this.readFeaturesFromDocument(s,n)}return isDocument(t)?this.readFeaturesFromDocument(t,n):this.readFeaturesFromNode(t,n)}readFeaturesFromDocument(t,n){const s=[];for(let o=t.firstChild;o;o=o.nextSibling)o.nodeType==Node.ELEMENT_NODE&&extend$2(s,this.readFeaturesFromNode(o,n));return s}readFeaturesFromNode(t,n){return abstract()}readGeometry(t,n){if(!t)return null;if(typeof t=="string"){const s=parse(t);return this.readGeometryFromDocument(s,n)}return isDocument(t)?this.readGeometryFromDocument(t,n):this.readGeometryFromNode(t,n)}readGeometryFromDocument(t,n){return null}readGeometryFromNode(t,n){return null}readProjection(t){if(!t)return null;if(typeof t=="string"){const n=parse(t);return this.readProjectionFromDocument(n)}return isDocument(t)?this.readProjectionFromDocument(t):this.readProjectionFromNode(t)}readProjectionFromDocument(t){return this.dataProjection}readProjectionFromNode(t){return this.dataProjection}writeFeature(t,n){const s=this.writeFeatureNode(t,n);return this.xmlSerializer_.serializeToString(s)}writeFeatureNode(t,n){return null}writeFeatures(t,n){const s=this.writeFeaturesNode(t,n);return this.xmlSerializer_.serializeToString(s)}writeFeaturesNode(t,n){return null}writeGeometry(t,n){const s=this.writeGeometryNode(t,n);return this.xmlSerializer_.serializeToString(s)}writeGeometryNode(t,n){return null}}function readBoolean(l){const t=getAllTextContent(l,!1);return readBooleanString(t)}function readBooleanString(l){const t=/^\s*(true|1)|(false|0)\s*$/.exec(l);if(t)return t[1]!==void 0||!1}function readDateTime(l){const t=getAllTextContent(l,!1),n=Date.parse(t);return isNaN(n)?void 0:n/1e3}function readDecimal(l){const t=getAllTextContent(l,!1);return readDecimalString(t)}function readDecimalString(l){const t=/^\s*([+\-]?\d*\.?\d+(?:e[+\-]?\d+)?)\s*$/i.exec(l);if(t)return parseFloat(t[1])}function readPositiveInteger(l){const t=getAllTextContent(l,!1);return readNonNegativeIntegerString(t)}function readNonNegativeIntegerString(l){const t=/^\s*(\d+)\s*$/.exec(l);if(t)return parseInt(t[1],10)}function readString(l){return getAllTextContent(l,!1).trim()}function writeBooleanTextNode(l,t){writeStringTextNode(l,t?"1":"0")}function writeCDATASection(l,t){l.appendChild(getDocument().createCDATASection(t))}function writeDateTimeTextNode(l,t){const n=new Date(t*1e3),s=n.getUTCFullYear()+"-"+padNumber(n.getUTCMonth()+1,2)+"-"+padNumber(n.getUTCDate(),2)+"T"+padNumber(n.getUTCHours(),2)+":"+padNumber(n.getUTCMinutes(),2)+":"+padNumber(n.getUTCSeconds(),2)+"Z";l.appendChild(getDocument().createTextNode(s))}function writeDecimalTextNode(l,t){const n=t.toPrecision();l.appendChild(getDocument().createTextNode(n))}function writeNonNegativeIntegerTextNode(l,t){const n=t.toString();l.appendChild(getDocument().createTextNode(n))}const whiteSpaceStart=/^\s/,whiteSpaceEnd=/\s$/,cdataCharacters=/(\n|\t|\r|<|&| {2})/;function writeStringTextNode(l,t){typeof t=="string"&&(whiteSpaceStart.test(t)||whiteSpaceEnd.test(t)||cdataCharacters.test(t))?t.split("]]>").forEach((n,s,o)=>{s<o.length-1&&(n+="]]"),s>0&&(n=">"+n),writeCDATASection(l,n)}):l.appendChild(getDocument().createTextNode(t))}const GX_NAMESPACE_URIS=["http://www.google.com/kml/ext/2.2"],NAMESPACE_URIS$4=[null,"http://earth.google.com/kml/2.0","http://earth.google.com/kml/2.1","http://earth.google.com/kml/2.2","http://www.opengis.net/kml/2.2"],SCHEMA_LOCATION$1="http://www.opengis.net/kml/2.2 https://developers.google.com/kml/schema/kml22gx.xsd",ICON_ANCHOR_UNITS_MAP={fraction:"fraction",pixels:"pixels",insetPixels:"pixels"},PLACEMARK_PARSERS=makeStructureNS(NAMESPACE_URIS$4,{ExtendedData:extendedDataParser,Region:regionParser,MultiGeometry:makeObjectPropertySetter(readMultiGeometry,"geometry"),LineString:makeObjectPropertySetter(readLineString,"geometry"),LinearRing:makeObjectPropertySetter(readLinearRing,"geometry"),Point:makeObjectPropertySetter(readPoint,"geometry"),Polygon:makeObjectPropertySetter(readPolygon,"geometry"),Style:makeObjectPropertySetter(readStyle$2),StyleMap:placemarkStyleMapParser,address:makeObjectPropertySetter(readString),description:makeObjectPropertySetter(readString),name:makeObjectPropertySetter(readString),open:makeObjectPropertySetter(readBoolean),phoneNumber:makeObjectPropertySetter(readString),styleUrl:makeObjectPropertySetter(readStyleURL),visibility:makeObjectPropertySetter(readBoolean)},makeStructureNS(GX_NAMESPACE_URIS,{MultiTrack:makeObjectPropertySetter(readGxMultiTrack,"geometry"),Track:makeObjectPropertySetter(readGxTrack,"geometry")})),NETWORK_LINK_PARSERS=makeStructureNS(NAMESPACE_URIS$4,{ExtendedData:extendedDataParser,Region:regionParser,Link:linkParser,address:makeObjectPropertySetter(readString),description:makeObjectPropertySetter(readString),name:makeObjectPropertySetter(readString),open:makeObjectPropertySetter(readBoolean),phoneNumber:makeObjectPropertySetter(readString),visibility:makeObjectPropertySetter(readBoolean)}),LINK_PARSERS$1=makeStructureNS(NAMESPACE_URIS$4,{href:makeObjectPropertySetter(readURI)}),CAMERA_PARSERS=makeStructureNS(NAMESPACE_URIS$4,{Altitude:makeObjectPropertySetter(readDecimal),Longitude:makeObjectPropertySetter(readDecimal),Latitude:makeObjectPropertySetter(readDecimal),Tilt:makeObjectPropertySetter(readDecimal),AltitudeMode:makeObjectPropertySetter(readString),Heading:makeObjectPropertySetter(readDecimal),Roll:makeObjectPropertySetter(readDecimal)}),REGION_PARSERS=makeStructureNS(NAMESPACE_URIS$4,{LatLonAltBox:latLonAltBoxParser,Lod:lodParser}),KML_SEQUENCE=makeStructureNS(NAMESPACE_URIS$4,["Document","Placemark"]),KML_SERIALIZERS=makeStructureNS(NAMESPACE_URIS$4,{Document:makeChildAppender(writeDocument),Placemark:makeChildAppender(writePlacemark)});let DEFAULT_COLOR,DEFAULT_FILL_STYLE=null,DEFAULT_IMAGE_STYLE_ANCHOR,DEFAULT_IMAGE_STYLE_ANCHOR_X_UNITS,DEFAULT_IMAGE_STYLE_ANCHOR_Y_UNITS,DEFAULT_IMAGE_STYLE_SIZE,DEFAULT_IMAGE_STYLE_SRC,DEFAULT_IMAGE_STYLE=null,DEFAULT_NO_IMAGE_STYLE,DEFAULT_STROKE_STYLE$1=null,DEFAULT_TEXT_STROKE_STYLE,DEFAULT_TEXT_STYLE=null,DEFAULT_STYLE$1=null,DEFAULT_STYLE_ARRAY=null;function scaleForSize(l){return 32/Math.min(l[0],l[1])}function createStyleDefaults(){DEFAULT_COLOR=[255,255,255,1],DEFAULT_FILL_STYLE=new Fill({color:DEFAULT_COLOR}),DEFAULT_IMAGE_STYLE_ANCHOR=[20,2],DEFAULT_IMAGE_STYLE_ANCHOR_X_UNITS="pixels",DEFAULT_IMAGE_STYLE_ANCHOR_Y_UNITS="pixels",DEFAULT_IMAGE_STYLE_SIZE=[64,64],DEFAULT_IMAGE_STYLE_SRC="https://maps.google.com/mapfiles/kml/pushpin/ylw-pushpin.png",DEFAULT_IMAGE_STYLE=new Icon({anchor:DEFAULT_IMAGE_STYLE_ANCHOR,anchorOrigin:"bottom-left",anchorXUnits:DEFAULT_IMAGE_STYLE_ANCHOR_X_UNITS,anchorYUnits:DEFAULT_IMAGE_STYLE_ANCHOR_Y_UNITS,crossOrigin:"anonymous",rotation:0,scale:scaleForSize(DEFAULT_IMAGE_STYLE_SIZE),size:DEFAULT_IMAGE_STYLE_SIZE,src:DEFAULT_IMAGE_STYLE_SRC}),DEFAULT_NO_IMAGE_STYLE="NO_IMAGE",DEFAULT_STROKE_STYLE$1=new Stroke({color:DEFAULT_COLOR,width:1}),DEFAULT_TEXT_STROKE_STYLE=new Stroke({color:[51,51,51,1],width:2}),DEFAULT_TEXT_STYLE=new Text({font:"bold 16px Helvetica",fill:DEFAULT_FILL_STYLE,stroke:DEFAULT_TEXT_STROKE_STYLE,scale:.8}),DEFAULT_STYLE$1=new Style({fill:DEFAULT_FILL_STYLE,image:DEFAULT_IMAGE_STYLE,text:DEFAULT_TEXT_STYLE,stroke:DEFAULT_STROKE_STYLE$1,zIndex:0}),DEFAULT_STYLE_ARRAY=[DEFAULT_STYLE$1]}let TEXTAREA;function defaultIconUrlFunction(l){return l}class KML extends XMLFeature{constructor(t){super(),t=t||{},DEFAULT_STYLE_ARRAY||createStyleDefaults(),this.dataProjection=get$1("EPSG:4326"),this.defaultStyle_=t.defaultStyle?t.defaultStyle:DEFAULT_STYLE_ARRAY,this.extractStyles_=t.extractStyles!==void 0?t.extractStyles:!0,this.writeStyles_=t.writeStyles!==void 0?t.writeStyles:!0,this.sharedStyles_={},this.showPointNames_=t.showPointNames!==void 0?t.showPointNames:!0,this.crossOrigin_=t.crossOrigin!==void 0?t.crossOrigin:"anonymous",this.iconUrlFunction_=t.iconUrlFunction?t.iconUrlFunction:defaultIconUrlFunction,this.supportedMediaTypes=["application/vnd.google-earth.kml+xml"]}readDocumentOrFolder_(t,n){const s=makeStructureNS(NAMESPACE_URIS$4,{Document:makeArrayExtender(this.readDocumentOrFolder_,this),Folder:makeArrayExtender(this.readDocumentOrFolder_,this),Placemark:makeArrayPusher(this.readPlacemark_,this),Style:this.readSharedStyle_.bind(this),StyleMap:this.readSharedStyleMap_.bind(this)}),o=pushParseAndPop([],s,t,n,this);if(o)return o}readPlacemark_(t,n){const s=pushParseAndPop({geometry:null},PLACEMARK_PARSERS,t,n,this);if(!s)return;const o=new Feature,a=t.getAttribute("id");a!==null&&o.setId(a);const h=n[0],c=s.geometry;if(c&&transformGeometryWithOptions(c,!1,h),o.setGeometry(c),delete s.geometry,this.extractStyles_){const u=s.Style,d=s.styleUrl,f=createFeatureStyleFunction(u,d,this.defaultStyle_,this.sharedStyles_,this.showPointNames_);o.setStyle(f)}return delete s.Style,o.setProperties(s,!0),o}readSharedStyle_(t,n){const s=t.getAttribute("id");if(s!==null){const o=readStyle$2.call(this,t,n);if(o){let a,h=t.baseURI;(!h||h=="about:blank")&&(h=window.location.href),h?a=new URL("#"+s,h).href:a="#"+s,this.sharedStyles_[a]=o}}}readSharedStyleMap_(t,n){const s=t.getAttribute("id");if(s===null)return;const o=readStyleMapValue.call(this,t,n);if(!o)return;let a,h=t.baseURI;(!h||h=="about:blank")&&(h=window.location.href),h?a=new URL("#"+s,h).href:a="#"+s,this.sharedStyles_[a]=o}readFeatureFromNode(t,n){if(!NAMESPACE_URIS$4.includes(t.namespaceURI))return null;const s=this.readPlacemark_(t,[this.getReadOptions(t,n)]);return s||null}readFeaturesFromNode(t,n){if(!NAMESPACE_URIS$4.includes(t.namespaceURI))return[];let s;const o=t.localName;if(o=="Document"||o=="Folder")return s=this.readDocumentOrFolder_(t,[this.getReadOptions(t,n)]),s||[];if(o=="Placemark"){const a=this.readPlacemark_(t,[this.getReadOptions(t,n)]);return a?[a]:[]}if(o=="kml"){s=[];for(let a=t.firstElementChild;a;a=a.nextElementSibling){const h=this.readFeaturesFromNode(a,n);h&&extend$2(s,h)}return s}return[]}readName(t){if(t){if(typeof t=="string"){const n=parse(t);return this.readNameFromDocument(n)}return isDocument(t)?this.readNameFromDocument(t):this.readNameFromNode(t)}}readNameFromDocument(t){for(let n=t.firstChild;n;n=n.nextSibling)if(n.nodeType==Node.ELEMENT_NODE){const s=this.readNameFromNode(n);if(s)return s}}readNameFromNode(t){for(let n=t.firstElementChild;n;n=n.nextElementSibling)if(NAMESPACE_URIS$4.includes(n.namespaceURI)&&n.localName=="name")return readString(n);for(let n=t.firstElementChild;n;n=n.nextElementSibling){const s=n.localName;if(NAMESPACE_URIS$4.includes(n.namespaceURI)&&(s=="Document"||s=="Folder"||s=="Placemark"||s=="kml")){const o=this.readNameFromNode(n);if(o)return o}}}readNetworkLinks(t){const n=[];if(typeof t=="string"){const s=parse(t);extend$2(n,this.readNetworkLinksFromDocument(s))}else isDocument(t)?extend$2(n,this.readNetworkLinksFromDocument(t)):extend$2(n,this.readNetworkLinksFromNode(t));return n}readNetworkLinksFromDocument(t){const n=[];for(let s=t.firstChild;s;s=s.nextSibling)s.nodeType==Node.ELEMENT_NODE&&extend$2(n,this.readNetworkLinksFromNode(s));return n}readNetworkLinksFromNode(t){const n=[];for(let s=t.firstElementChild;s;s=s.nextElementSibling)if(NAMESPACE_URIS$4.includes(s.namespaceURI)&&s.localName=="NetworkLink"){const o=pushParseAndPop({},NETWORK_LINK_PARSERS,s,[]);n.push(o)}for(let s=t.firstElementChild;s;s=s.nextElementSibling){const o=s.localName;NAMESPACE_URIS$4.includes(s.namespaceURI)&&(o=="Document"||o=="Folder"||o=="kml")&&extend$2(n,this.readNetworkLinksFromNode(s))}return n}readRegion(t){const n=[];if(typeof t=="string"){const s=parse(t);extend$2(n,this.readRegionFromDocument(s))}else isDocument(t)?extend$2(n,this.readRegionFromDocument(t)):extend$2(n,this.readRegionFromNode(t));return n}readRegionFromDocument(t){const n=[];for(let s=t.firstChild;s;s=s.nextSibling)s.nodeType==Node.ELEMENT_NODE&&extend$2(n,this.readRegionFromNode(s));return n}readRegionFromNode(t){const n=[];for(let s=t.firstElementChild;s;s=s.nextElementSibling)if(NAMESPACE_URIS$4.includes(s.namespaceURI)&&s.localName=="Region"){const o=pushParseAndPop({},REGION_PARSERS,s,[]);n.push(o)}for(let s=t.firstElementChild;s;s=s.nextElementSibling){const o=s.localName;NAMESPACE_URIS$4.includes(s.namespaceURI)&&(o=="Document"||o=="Folder"||o=="kml")&&extend$2(n,this.readRegionFromNode(s))}return n}readCamera(t){const n=[];if(typeof t=="string"){const s=parse(t);extend$2(n,this.readCameraFromDocument(s))}else isDocument(t)?extend$2(n,this.readCameraFromDocument(t)):extend$2(n,this.readCameraFromNode(t));return n}readCameraFromDocument(t){const n=[];for(let s=t.firstChild;s;s=s.nextSibling)s.nodeType===Node.ELEMENT_NODE&&extend$2(n,this.readCameraFromNode(s));return n}readCameraFromNode(t){const n=[];for(let s=t.firstElementChild;s;s=s.nextElementSibling)if(NAMESPACE_URIS$4.includes(s.namespaceURI)&&s.localName==="Camera"){const o=pushParseAndPop({},CAMERA_PARSERS,s,[]);n.push(o)}for(let s=t.firstElementChild;s;s=s.nextElementSibling){const o=s.localName;NAMESPACE_URIS$4.includes(s.namespaceURI)&&(o==="Document"||o==="Folder"||o==="Placemark"||o==="kml")&&extend$2(n,this.readCameraFromNode(s))}return n}writeFeaturesNode(t,n){n=this.adaptOptions(n);const s=createElementNS(NAMESPACE_URIS$4[4],"kml"),o="http://www.w3.org/2000/xmlns/";s.setAttributeNS(o,"xmlns:gx",GX_NAMESPACE_URIS[0]),s.setAttributeNS(o,"xmlns:xsi",XML_SCHEMA_INSTANCE_URI),s.setAttributeNS(XML_SCHEMA_INSTANCE_URI,"xsi:schemaLocation",SCHEMA_LOCATION$1);const a={node:s},h={};t.length>1?h.Document=t:t.length==1&&(h.Placemark=t[0]);const c=KML_SEQUENCE[s.namespaceURI],u=makeSequence(h,c);return pushSerializeAndPop(a,KML_SERIALIZERS,OBJECT_PROPERTY_NODE_FACTORY,u,[n],c,this),s}}function createNameStyleFunction(l,t){const n=[0,0];let s="start";const o=l.getImage();if(o){const c=o.getSize();if(c&&c.length==2){const u=o.getScaleArray(),d=o.getAnchor();n[0]=u[0]*(c[0]-d[0]),n[1]=u[1]*(c[1]/2-d[1]),s="left"}}let a=l.getText();return a?(a=a.clone(),a.setFont(a.getFont()||DEFAULT_TEXT_STYLE.getFont()),a.setScale(a.getScale()||DEFAULT_TEXT_STYLE.getScale()),a.setFill(a.getFill()||DEFAULT_TEXT_STYLE.getFill()),a.setStroke(a.getStroke()||DEFAULT_TEXT_STROKE_STYLE)):a=DEFAULT_TEXT_STYLE.clone(),a.setText(t),a.setOffsetX(n[0]),a.setOffsetY(n[1]),a.setTextAlign(s),new Style({image:o,text:a})}function createFeatureStyleFunction(l,t,n,s,o){return function(a,h){let c=o,u="",d=[];if(c){const g=a.getGeometry();if(g)if(g instanceof GeometryCollection)d=g.getGeometriesArrayRecursive().filter(function(_){const m=_.getType();return m==="Point"||m==="MultiPoint"}),c=d.length>0;else{const _=g.getType();c=_==="Point"||_==="MultiPoint"}}c&&(u=a.get("name"),c=c&&!!u,c&&/&[^&]+;/.test(u)&&(TEXTAREA||(TEXTAREA=document.createElement("textarea")),TEXTAREA.innerHTML=u,u=TEXTAREA.value));let f=n;if(l?f=l:t&&(f=findStyle(t,n,s)),c){const g=createNameStyleFunction(f[0],u);if(d.length>0){g.setGeometry(new GeometryCollection(d));const _=new Style({geometry:f[0].getGeometry(),image:null,fill:f[0].getFill(),stroke:f[0].getStroke(),text:null});return[g,_].concat(f.slice(1))}return g}return f}}function findStyle(l,t,n){return Array.isArray(l)?l:typeof l=="string"?findStyle(n[l],t,n):t}function readColor(l){const t=getAllTextContent(l,!1),n=/^\s*#?\s*([0-9A-Fa-f]{8})\s*$/.exec(t);if(n){const s=n[1];return[parseInt(s.substr(6,2),16),parseInt(s.substr(4,2),16),parseInt(s.substr(2,2),16),parseInt(s.substr(0,2),16)/255]}}function readFlatCoordinates(l){let t=getAllTextContent(l,!1);const n=[];t=t.replace(/\s*,\s*/g,",");const s=/^\s*([+\-]?\d*\.?\d+(?:e[+\-]?\d+)?),([+\-]?\d*\.?\d+(?:e[+\-]?\d+)?)(?:\s+|,|$)(?:([+\-]?\d*\.?\d+(?:e[+\-]?\d+)?)(?:\s+|$))?\s*/i;let o;for(;o=s.exec(t);){const a=parseFloat(o[1]),h=parseFloat(o[2]),c=o[3]?parseFloat(o[3]):0;n.push(a,h,c),t=t.substr(o[0].length)}if(t==="")return n}function readURI(l){const t=getAllTextContent(l,!1).trim();let n=l.baseURI;return(!n||n=="about:blank")&&(n=window.location.href),n?new URL(t,n).href:t}function readStyleURL(l){const t=getAllTextContent(l,!1).trim().replace(/^(?!.*#)/,"#");let n=l.baseURI;return(!n||n=="about:blank")&&(n=window.location.href),n?new URL(t,n).href:t}function readVec2(l){const t=l.getAttribute("xunits"),n=l.getAttribute("yunits");let s;return t!=="insetPixels"?n!=="insetPixels"?s="bottom-left":s="top-left":n!=="insetPixels"?s="bottom-right":s="top-right",{x:parseFloat(l.getAttribute("x")),xunits:ICON_ANCHOR_UNITS_MAP[t],y:parseFloat(l.getAttribute("y")),yunits:ICON_ANCHOR_UNITS_MAP[n],origin:s}}function readScale(l){return readDecimal(l)}const STYLE_MAP_PARSERS=makeStructureNS(NAMESPACE_URIS$4,{Pair:pairDataParser});function readStyleMapValue(l,t){return pushParseAndPop(void 0,STYLE_MAP_PARSERS,l,t,this)}const ICON_STYLE_PARSERS=makeStructureNS(NAMESPACE_URIS$4,{Icon:makeObjectPropertySetter(readIcon),color:makeObjectPropertySetter(readColor),heading:makeObjectPropertySetter(readDecimal),hotSpot:makeObjectPropertySetter(readVec2),scale:makeObjectPropertySetter(readScale)});function iconStyleParser(l,t){const n=pushParseAndPop({},ICON_STYLE_PARSERS,l,t);if(!n)return;const s=t[t.length-1],o="Icon"in n?n.Icon:{},a=!("Icon"in n)||Object.keys(o).length>0;let h;const c=o.href;c?h=c:a&&(h=DEFAULT_IMAGE_STYLE_SRC);let u,d,f,g="bottom-left";const _=n.hotSpot;_?(u=[_.x,_.y],d=_.xunits,f=_.yunits,g=_.origin):/^https?:\/\/maps\.(?:google|gstatic)\.com\//.test(h)&&(h.includes("pushpin")?(u=DEFAULT_IMAGE_STYLE_ANCHOR,d=DEFAULT_IMAGE_STYLE_ANCHOR_X_UNITS,f=DEFAULT_IMAGE_STYLE_ANCHOR_Y_UNITS):h.includes("arrow-reverse")?(u=[54,42],d=DEFAULT_IMAGE_STYLE_ANCHOR_X_UNITS,f=DEFAULT_IMAGE_STYLE_ANCHOR_Y_UNITS):h.includes("paddle")&&(u=[32,1],d=DEFAULT_IMAGE_STYLE_ANCHOR_X_UNITS,f=DEFAULT_IMAGE_STYLE_ANCHOR_Y_UNITS));let m;const p=o.x,x=o.y;p!==void 0&&x!==void 0&&(m=[p,x]);let y;const T=o.w,S=o.h;T!==void 0&&S!==void 0&&(y=[T,S]);let C;const P=n.heading;P!==void 0&&(C=toRadians(P));const w=n.scale,I=n.color;if(a){h==DEFAULT_IMAGE_STYLE_SRC&&(y=DEFAULT_IMAGE_STYLE_SIZE);const O=new Icon({anchor:u,anchorOrigin:g,anchorXUnits:d,anchorYUnits:f,crossOrigin:this.crossOrigin_,offset:m,offsetOrigin:"bottom-left",rotation:C,scale:w,size:y,src:this.iconUrlFunction_(h),color:I}),N=O.getScaleArray()[0],k=O.getSize();if(k===null){const D=O.getImageState();if(D===ImageState.IDLE||D===ImageState.LOADING){const ze=function(){const z=O.getImageState();if(!(z===ImageState.IDLE||z===ImageState.LOADING)){const Ee=O.getSize();if(Ee&&Ee.length==2){const B=scaleForSize(Ee);O.setScale(N*B)}O.unlistenImageChange(ze)}};O.listenImageChange(ze),D===ImageState.IDLE&&O.load()}}else if(k.length==2){const D=scaleForSize(k);O.setScale(N*D)}s.imageStyle=O}else s.imageStyle=DEFAULT_NO_IMAGE_STYLE}const LABEL_STYLE_PARSERS=makeStructureNS(NAMESPACE_URIS$4,{color:makeObjectPropertySetter(readColor),scale:makeObjectPropertySetter(readScale)});function labelStyleParser(l,t){const n=pushParseAndPop({},LABEL_STYLE_PARSERS,l,t);if(!n)return;const s=t[t.length-1],o=new Text({fill:new Fill({color:"color"in n?n.color:DEFAULT_COLOR}),scale:n.scale});s.textStyle=o}const LINE_STYLE_PARSERS=makeStructureNS(NAMESPACE_URIS$4,{color:makeObjectPropertySetter(readColor),width:makeObjectPropertySetter(readDecimal)});function lineStyleParser(l,t){const n=pushParseAndPop({},LINE_STYLE_PARSERS,l,t);if(!n)return;const s=t[t.length-1],o=new Stroke({color:"color"in n?n.color:DEFAULT_COLOR,width:"width"in n?n.width:1});s.strokeStyle=o}const POLY_STYLE_PARSERS=makeStructureNS(NAMESPACE_URIS$4,{color:makeObjectPropertySetter(readColor),fill:makeObjectPropertySetter(readBoolean),outline:makeObjectPropertySetter(readBoolean)});function polyStyleParser(l,t){const n=pushParseAndPop({},POLY_STYLE_PARSERS,l,t);if(!n)return;const s=t[t.length-1],o=new Fill({color:"color"in n?n.color:DEFAULT_COLOR});s.fillStyle=o;const a=n.fill;a!==void 0&&(s.fill=a);const h=n.outline;h!==void 0&&(s.outline=h)}const FLAT_LINEAR_RING_PARSERS=makeStructureNS(NAMESPACE_URIS$4,{coordinates:makeReplacer(readFlatCoordinates)});function readFlatLinearRing(l,t){return pushParseAndPop(null,FLAT_LINEAR_RING_PARSERS,l,t)}function gxCoordParser(l,t){const s=t[t.length-1].coordinates,o=getAllTextContent(l,!1),h=/^\s*([+\-]?\d+(?:\.\d*)?(?:e[+\-]?\d*)?)\s+([+\-]?\d+(?:\.\d*)?(?:e[+\-]?\d*)?)\s+([+\-]?\d+(?:\.\d*)?(?:e[+\-]?\d*)?)\s*$/i.exec(o);if(h){const c=parseFloat(h[1]),u=parseFloat(h[2]),d=parseFloat(h[3]);s.push([c,u,d])}else s.push([])}const GX_MULTITRACK_GEOMETRY_PARSERS=makeStructureNS(GX_NAMESPACE_URIS,{Track:makeArrayPusher(readGxTrack)});function readGxMultiTrack(l,t){const n=pushParseAndPop([],GX_MULTITRACK_GEOMETRY_PARSERS,l,t);if(n)return new MultiLineString(n)}const GX_TRACK_PARSERS=makeStructureNS(NAMESPACE_URIS$4,{when:whenParser},makeStructureNS(GX_NAMESPACE_URIS,{coord:gxCoordParser}));function readGxTrack(l,t){const n=pushParseAndPop({coordinates:[],whens:[]},GX_TRACK_PARSERS,l,t);if(!n)return;const s=[],o=n.coordinates,a=n.whens;for(let h=0,c=Math.min(o.length,a.length);h<c;++h)o[h].length==3&&s.push(o[h][0],o[h][1],o[h][2],a[h]);return new LineString(s,"XYZM")}const ICON_PARSERS=makeStructureNS(NAMESPACE_URIS$4,{href:makeObjectPropertySetter(readURI)},makeStructureNS(GX_NAMESPACE_URIS,{x:makeObjectPropertySetter(readDecimal),y:makeObjectPropertySetter(readDecimal),w:makeObjectPropertySetter(readDecimal),h:makeObjectPropertySetter(readDecimal)}));function readIcon(l,t){const n=pushParseAndPop({},ICON_PARSERS,l,t);return n||null}const GEOMETRY_FLAT_COORDINATES_PARSERS=makeStructureNS(NAMESPACE_URIS$4,{coordinates:makeReplacer(readFlatCoordinates)});function readFlatCoordinatesFromNode(l,t){return pushParseAndPop(null,GEOMETRY_FLAT_COORDINATES_PARSERS,l,t)}const EXTRUDE_AND_ALTITUDE_MODE_PARSERS=makeStructureNS(NAMESPACE_URIS$4,{extrude:makeObjectPropertySetter(readBoolean),tessellate:makeObjectPropertySetter(readBoolean),altitudeMode:makeObjectPropertySetter(readString)});function readLineString(l,t){const n=pushParseAndPop({},EXTRUDE_AND_ALTITUDE_MODE_PARSERS,l,t),s=readFlatCoordinatesFromNode(l,t);if(s){const o=new LineString(s,"XYZ");return o.setProperties(n,!0),o}}function readLinearRing(l,t){const n=pushParseAndPop({},EXTRUDE_AND_ALTITUDE_MODE_PARSERS,l,t),s=readFlatCoordinatesFromNode(l,t);if(s){const o=new Polygon(s,"XYZ",[s.length]);return o.setProperties(n,!0),o}}const MULTI_GEOMETRY_PARSERS=makeStructureNS(NAMESPACE_URIS$4,{LineString:makeArrayPusher(readLineString),LinearRing:makeArrayPusher(readLinearRing),MultiGeometry:makeArrayPusher(readMultiGeometry),Point:makeArrayPusher(readPoint),Polygon:makeArrayPusher(readPolygon)});function readMultiGeometry(l,t){const n=pushParseAndPop([],MULTI_GEOMETRY_PARSERS,l,t);if(!n)return null;if(n.length===0)return new GeometryCollection(n);let s,o=!0;const a=n[0].getType();let h;for(let c=1,u=n.length;c<u;++c)if(h=n[c],h.getType()!=a){o=!1;break}if(o){let c,u;if(a=="Point"){const d=n[0];c=d.getLayout(),u=d.getFlatCoordinates();for(let f=1,g=n.length;f<g;++f)h=n[f],extend$2(u,h.getFlatCoordinates());s=new MultiPoint(u,c),setCommonGeometryProperties(s,n)}else if(a=="LineString")s=new MultiLineString(n),setCommonGeometryProperties(s,n);else if(a=="Polygon")s=new MultiPolygon(n),setCommonGeometryProperties(s,n);else if(a=="GeometryCollection"||a.startsWith("Multi"))s=new GeometryCollection(n);else throw new Error("Unknown geometry type found")}else s=new GeometryCollection(n);return s}function readPoint(l,t){const n=pushParseAndPop({},EXTRUDE_AND_ALTITUDE_MODE_PARSERS,l,t),s=readFlatCoordinatesFromNode(l,t);if(s){const o=new Point(s,"XYZ");return o.setProperties(n,!0),o}}const FLAT_LINEAR_RINGS_PARSERS=makeStructureNS(NAMESPACE_URIS$4,{innerBoundaryIs:innerBoundaryIsParser,outerBoundaryIs:outerBoundaryIsParser});function readPolygon(l,t){const n=pushParseAndPop({},EXTRUDE_AND_ALTITUDE_MODE_PARSERS,l,t),s=pushParseAndPop([null],FLAT_LINEAR_RINGS_PARSERS,l,t);if(s&&s[0]){const o=s[0],a=[o.length];for(let c=1,u=s.length;c<u;++c)extend$2(o,s[c]),a.push(o.length);const h=new Polygon(o,"XYZ",a);return h.setProperties(n,!0),h}}const STYLE_PARSERS$2=makeStructureNS(NAMESPACE_URIS$4,{IconStyle:iconStyleParser,LabelStyle:labelStyleParser,LineStyle:lineStyleParser,PolyStyle:polyStyleParser});function readStyle$2(l,t){const n=pushParseAndPop({},STYLE_PARSERS$2,l,t,this);if(!n)return null;let s="fillStyle"in n?n.fillStyle:DEFAULT_FILL_STYLE;const o=n.fill;o!==void 0&&!o&&(s=null);let a;"imageStyle"in n?n.imageStyle!=DEFAULT_NO_IMAGE_STYLE&&(a=n.imageStyle):a=DEFAULT_IMAGE_STYLE;const h="textStyle"in n?n.textStyle:DEFAULT_TEXT_STYLE,c="strokeStyle"in n?n.strokeStyle:DEFAULT_STROKE_STYLE$1,u=n.outline;return u!==void 0&&!u?[new Style({geometry:function(d){const f=d.getGeometry(),g=f.getType();if(g==="GeometryCollection"){const _=f;return new GeometryCollection(_.getGeometriesArrayRecursive().filter(function(m){const p=m.getType();return p!=="Polygon"&&p!=="MultiPolygon"}))}if(g!=="Polygon"&&g!=="MultiPolygon")return f},fill:s,image:a,stroke:c,text:h,zIndex:void 0}),new Style({geometry:function(d){const f=d.getGeometry(),g=f.getType();if(g==="GeometryCollection"){const _=f;return new GeometryCollection(_.getGeometriesArrayRecursive().filter(function(m){const p=m.getType();return p==="Polygon"||p==="MultiPolygon"}))}if(g==="Polygon"||g==="MultiPolygon")return f},fill:s,stroke:null,zIndex:void 0})]:[new Style({fill:s,image:a,stroke:c,text:h,zIndex:void 0})]}function setCommonGeometryProperties(l,t){const n=t.length,s=new Array(t.length),o=new Array(t.length),a=new Array(t.length);let h,c,u;h=!1,c=!1,u=!1;for(let d=0;d<n;++d){const f=t[d];s[d]=f.get("extrude"),o[d]=f.get("tessellate"),a[d]=f.get("altitudeMode"),h=h||s[d]!==void 0,c=c||o[d]!==void 0,u=u||a[d]}h&&l.set("extrude",s),c&&l.set("tessellate",o),u&&l.set("altitudeMode",a)}const DATA_PARSERS=makeStructureNS(NAMESPACE_URIS$4,{displayName:makeObjectPropertySetter(readString),value:makeObjectPropertySetter(readString)});function dataParser(l,t){const n=l.getAttribute("name");parseNode(DATA_PARSERS,l,t);const s=t[t.length-1];n&&s.displayName?s[n]={value:s.value,displayName:s.displayName,toString:function(){return s.value}}:n!==null?s[n]=s.value:s.displayName!==null&&(s[s.displayName]=s.value),delete s.value}const EXTENDED_DATA_PARSERS=makeStructureNS(NAMESPACE_URIS$4,{Data:dataParser,SchemaData:schemaDataParser});function extendedDataParser(l,t){parseNode(EXTENDED_DATA_PARSERS,l,t)}function regionParser(l,t){parseNode(REGION_PARSERS,l,t)}const PAIR_PARSERS=makeStructureNS(NAMESPACE_URIS$4,{Style:makeObjectPropertySetter(readStyle$2),key:makeObjectPropertySetter(readString),styleUrl:makeObjectPropertySetter(readStyleURL)});function pairDataParser(l,t){const n=pushParseAndPop({},PAIR_PARSERS,l,t,this);if(!n)return;const s=n.key;if(s&&s=="normal"){const o=n.styleUrl;o&&(t[t.length-1]=o);const a=n.Style;a&&(t[t.length-1]=a)}}function placemarkStyleMapParser(l,t){const n=readStyleMapValue.call(this,l,t);if(!n)return;const s=t[t.length-1];if(Array.isArray(n))s.Style=n;else if(typeof n=="string")s.styleUrl=n;else throw new Error("`styleMapValue` has an unknown type")}const SCHEMA_DATA_PARSERS=makeStructureNS(NAMESPACE_URIS$4,{SimpleData:simpleDataParser});function schemaDataParser(l,t){parseNode(SCHEMA_DATA_PARSERS,l,t)}function simpleDataParser(l,t){const n=l.getAttribute("name");if(n!==null){const s=readString(l),o=t[t.length-1];o[n]=s}}const LAT_LON_ALT_BOX_PARSERS=makeStructureNS(NAMESPACE_URIS$4,{altitudeMode:makeObjectPropertySetter(readString),minAltitude:makeObjectPropertySetter(readDecimal),maxAltitude:makeObjectPropertySetter(readDecimal),north:makeObjectPropertySetter(readDecimal),south:makeObjectPropertySetter(readDecimal),east:makeObjectPropertySetter(readDecimal),west:makeObjectPropertySetter(readDecimal)});function latLonAltBoxParser(l,t){const n=pushParseAndPop({},LAT_LON_ALT_BOX_PARSERS,l,t);if(!n)return;const s=t[t.length-1],o=[parseFloat(n.west),parseFloat(n.south),parseFloat(n.east),parseFloat(n.north)];s.extent=o,s.altitudeMode=n.altitudeMode,s.minAltitude=parseFloat(n.minAltitude),s.maxAltitude=parseFloat(n.maxAltitude)}const LOD_PARSERS=makeStructureNS(NAMESPACE_URIS$4,{minLodPixels:makeObjectPropertySetter(readDecimal),maxLodPixels:makeObjectPropertySetter(readDecimal),minFadeExtent:makeObjectPropertySetter(readDecimal),maxFadeExtent:makeObjectPropertySetter(readDecimal)});function lodParser(l,t){const n=pushParseAndPop({},LOD_PARSERS,l,t);if(!n)return;const s=t[t.length-1];s.minLodPixels=parseFloat(n.minLodPixels),s.maxLodPixels=parseFloat(n.maxLodPixels),s.minFadeExtent=parseFloat(n.minFadeExtent),s.maxFadeExtent=parseFloat(n.maxFadeExtent)}const INNER_BOUNDARY_IS_PARSERS=makeStructureNS(NAMESPACE_URIS$4,{LinearRing:makeArrayPusher(readFlatLinearRing)});function innerBoundaryIsParser(l,t){const n=pushParseAndPop([],INNER_BOUNDARY_IS_PARSERS,l,t);n.length>0&&t[t.length-1].push(...n)}const OUTER_BOUNDARY_IS_PARSERS=makeStructureNS(NAMESPACE_URIS$4,{LinearRing:makeReplacer(readFlatLinearRing)});function outerBoundaryIsParser(l,t){const n=pushParseAndPop(void 0,OUTER_BOUNDARY_IS_PARSERS,l,t);if(n){const s=t[t.length-1];s[0]=n}}function linkParser(l,t){parseNode(LINK_PARSERS$1,l,t)}function whenParser(l,t){const s=t[t.length-1].whens,o=getAllTextContent(l,!1),a=Date.parse(o);s.push(isNaN(a)?0:a)}function writeColorTextNode(l,t){const n=asArray(t),o=[(n.length==4?n[3]:1)*255,n[2],n[1],n[0]];for(let a=0;a<4;++a){const h=Math.floor(o[a]).toString(16);o[a]=h.length==1?"0"+h:h}writeStringTextNode(l,o.join(""))}function writeCoordinatesTextNode(l,t,n){const s=n[n.length-1],o=s.layout,a=s.stride;let h;if(o=="XY"||o=="XYM")h=2;else if(o=="XYZ"||o=="XYZM")h=3;else throw new Error("Invalid geometry layout");const c=t.length;let u="";if(c>0){u+=t[0];for(let d=1;d<h;++d)u+=","+t[d];for(let d=a;d<c;d+=a){u+=" "+t[d];for(let f=1;f<h;++f)u+=","+t[d+f]}}writeStringTextNode(l,u)}const EXTENDEDDATA_NODE_SERIALIZERS=makeStructureNS(NAMESPACE_URIS$4,{Data:makeChildAppender(writeDataNode),value:makeChildAppender(writeDataNodeValue),displayName:makeChildAppender(writeDataNodeName)});function writeDataNode(l,t,n){l.setAttribute("name",t.name);const s={node:l},o=t.value;typeof o=="object"?(o!==null&&o.displayName&&pushSerializeAndPop(s,EXTENDEDDATA_NODE_SERIALIZERS,OBJECT_PROPERTY_NODE_FACTORY,[o.displayName],n,["displayName"]),o!==null&&o.value&&pushSerializeAndPop(s,EXTENDEDDATA_NODE_SERIALIZERS,OBJECT_PROPERTY_NODE_FACTORY,[o.value],n,["value"])):pushSerializeAndPop(s,EXTENDEDDATA_NODE_SERIALIZERS,OBJECT_PROPERTY_NODE_FACTORY,[o],n,["value"])}function writeDataNodeName(l,t){writeStringTextNode(l,t)}function writeDataNodeValue(l,t){writeStringTextNode(l,t)}const DOCUMENT_SERIALIZERS=makeStructureNS(NAMESPACE_URIS$4,{Placemark:makeChildAppender(writePlacemark)}),DOCUMENT_NODE_FACTORY=function(l,t,n){const s=t[t.length-1].node;return createElementNS(s.namespaceURI,"Placemark")};function writeDocument(l,t,n){pushSerializeAndPop({node:l},DOCUMENT_SERIALIZERS,DOCUMENT_NODE_FACTORY,t,n,void 0,this)}const DATA_NODE_FACTORY=makeSimpleNodeFactory("Data");function writeExtendedData(l,t,n){const s={node:l},o=t.names,a=t.values,h=o.length;for(let c=0;c<h;c++)pushSerializeAndPop(s,EXTENDEDDATA_NODE_SERIALIZERS,DATA_NODE_FACTORY,[{name:o[c],value:a[c]}],n)}const ICON_SEQUENCE=makeStructureNS(NAMESPACE_URIS$4,["href"],makeStructureNS(GX_NAMESPACE_URIS,["x","y","w","h"])),ICON_SERIALIZERS=makeStructureNS(NAMESPACE_URIS$4,{href:makeChildAppender(writeStringTextNode)},makeStructureNS(GX_NAMESPACE_URIS,{x:makeChildAppender(writeDecimalTextNode),y:makeChildAppender(writeDecimalTextNode),w:makeChildAppender(writeDecimalTextNode),h:makeChildAppender(writeDecimalTextNode)})),GX_NODE_FACTORY=function(l,t,n){return createElementNS(GX_NAMESPACE_URIS[0],"gx:"+n)};function writeIcon(l,t,n){const s={node:l},o=n[n.length-1].node;let a=ICON_SEQUENCE[o.namespaceURI],h=makeSequence(t,a);pushSerializeAndPop(s,ICON_SERIALIZERS,OBJECT_PROPERTY_NODE_FACTORY,h,n,a),a=ICON_SEQUENCE[GX_NAMESPACE_URIS[0]],h=makeSequence(t,a),pushSerializeAndPop(s,ICON_SERIALIZERS,GX_NODE_FACTORY,h,n,a)}const ICON_STYLE_SEQUENCE=makeStructureNS(NAMESPACE_URIS$4,["scale","heading","Icon","color","hotSpot"]),ICON_STYLE_SERIALIZERS=makeStructureNS(NAMESPACE_URIS$4,{Icon:makeChildAppender(writeIcon),color:makeChildAppender(writeColorTextNode),heading:makeChildAppender(writeDecimalTextNode),hotSpot:makeChildAppender(writeVec2),scale:makeChildAppender(writeScaleTextNode)});function writeIconStyle(l,t,n){const s={node:l},o={},a=t.getSrc(),h=t.getSize(),c=t.getImageSize(),u={href:a};if(h){u.w=h[0],u.h=h[1];const y=t.getAnchor(),T=t.getOrigin();if(T&&c&&T[0]!==0&&T[1]!==h[1]&&(u.x=T[0],u.y=c[1]-(T[1]+h[1])),y&&(y[0]!==h[0]/2||y[1]!==h[1]/2)){const S={x:y[0],xunits:"pixels",y:h[1]-y[1],yunits:"pixels"};o.hotSpot=S}}o.Icon=u;let d=t.getScaleArray()[0],f=h;if(f===null&&(f=DEFAULT_IMAGE_STYLE_SIZE),f.length==2){const y=scaleForSize(f);d=d/y}d!==1&&(o.scale=d);const g=t.getRotation();g!==0&&(o.heading=g);const _=t.getColor();_&&(o.color=_);const m=n[n.length-1].node,p=ICON_STYLE_SEQUENCE[m.namespaceURI],x=makeSequence(o,p);pushSerializeAndPop(s,ICON_STYLE_SERIALIZERS,OBJECT_PROPERTY_NODE_FACTORY,x,n,p)}const LABEL_STYLE_SEQUENCE=makeStructureNS(NAMESPACE_URIS$4,["color","scale"]),LABEL_STYLE_SERIALIZERS=makeStructureNS(NAMESPACE_URIS$4,{color:makeChildAppender(writeColorTextNode),scale:makeChildAppender(writeScaleTextNode)});function writeLabelStyle(l,t,n){const s={node:l},o={},a=t.getFill();a&&(o.color=a.getColor());const h=t.getScale();h&&h!==1&&(o.scale=h);const c=n[n.length-1].node,u=LABEL_STYLE_SEQUENCE[c.namespaceURI],d=makeSequence(o,u);pushSerializeAndPop(s,LABEL_STYLE_SERIALIZERS,OBJECT_PROPERTY_NODE_FACTORY,d,n,u)}const LINE_STYLE_SEQUENCE=makeStructureNS(NAMESPACE_URIS$4,["color","width"]),LINE_STYLE_SERIALIZERS=makeStructureNS(NAMESPACE_URIS$4,{color:makeChildAppender(writeColorTextNode),width:makeChildAppender(writeDecimalTextNode)});function writeLineStyle(l,t,n){const s={node:l},o={color:t.getColor(),width:Number(t.getWidth())||1},a=n[n.length-1].node,h=LINE_STYLE_SEQUENCE[a.namespaceURI],c=makeSequence(o,h);pushSerializeAndPop(s,LINE_STYLE_SERIALIZERS,OBJECT_PROPERTY_NODE_FACTORY,c,n,h)}const GEOMETRY_TYPE_TO_NODENAME$1={Point:"Point",LineString:"LineString",LinearRing:"LinearRing",Polygon:"Polygon",MultiPoint:"MultiGeometry",MultiLineString:"MultiGeometry",MultiPolygon:"MultiGeometry",GeometryCollection:"MultiGeometry"},GEOMETRY_NODE_FACTORY=function(l,t,n){if(l){const s=t[t.length-1].node;return createElementNS(s.namespaceURI,GEOMETRY_TYPE_TO_NODENAME$1[l.getType()])}},POINT_NODE_FACTORY=makeSimpleNodeFactory("Point"),LINE_STRING_NODE_FACTORY=makeSimpleNodeFactory("LineString"),LINEAR_RING_NODE_FACTORY=makeSimpleNodeFactory("LinearRing"),POLYGON_NODE_FACTORY=makeSimpleNodeFactory("Polygon"),MULTI_GEOMETRY_SERIALIZERS=makeStructureNS(NAMESPACE_URIS$4,{LineString:makeChildAppender(writePrimitiveGeometry),Point:makeChildAppender(writePrimitiveGeometry),Polygon:makeChildAppender(writePolygon),GeometryCollection:makeChildAppender(writeMultiGeometry)});function writeMultiGeometry(l,t,n){const s={node:l},o=t.getType();let a=[],h;if(o==="GeometryCollection")t.getGeometriesArrayRecursive().forEach(function(c){const u=c.getType();if(u==="MultiPoint")a=a.concat(c.getPoints());else if(u==="MultiLineString")a=a.concat(c.getLineStrings());else if(u==="MultiPolygon")a=a.concat(c.getPolygons());else if(u==="Point"||u==="LineString"||u==="Polygon")a.push(c);else throw new Error("Unknown geometry type")}),h=GEOMETRY_NODE_FACTORY;else if(o==="MultiPoint")a=t.getPoints(),h=POINT_NODE_FACTORY;else if(o==="MultiLineString")a=t.getLineStrings(),h=LINE_STRING_NODE_FACTORY;else if(o==="MultiPolygon")a=t.getPolygons(),h=POLYGON_NODE_FACTORY;else throw new Error("Unknown geometry type");pushSerializeAndPop(s,MULTI_GEOMETRY_SERIALIZERS,h,a,n)}const BOUNDARY_IS_SERIALIZERS=makeStructureNS(NAMESPACE_URIS$4,{LinearRing:makeChildAppender(writePrimitiveGeometry)});function writeBoundaryIs(l,t,n){pushSerializeAndPop({node:l},BOUNDARY_IS_SERIALIZERS,LINEAR_RING_NODE_FACTORY,[t],n)}const PLACEMARK_SERIALIZERS=makeStructureNS(NAMESPACE_URIS$4,{ExtendedData:makeChildAppender(writeExtendedData),MultiGeometry:makeChildAppender(writeMultiGeometry),LineString:makeChildAppender(writePrimitiveGeometry),LinearRing:makeChildAppender(writePrimitiveGeometry),Point:makeChildAppender(writePrimitiveGeometry),Polygon:makeChildAppender(writePolygon),Style:makeChildAppender(writeStyle),address:makeChildAppender(writeStringTextNode),description:makeChildAppender(writeStringTextNode),name:makeChildAppender(writeStringTextNode),open:makeChildAppender(writeBooleanTextNode),phoneNumber:makeChildAppender(writeStringTextNode),styleUrl:makeChildAppender(writeStringTextNode),visibility:makeChildAppender(writeBooleanTextNode)}),PLACEMARK_SEQUENCE=makeStructureNS(NAMESPACE_URIS$4,["name","open","visibility","address","phoneNumber","description","styleUrl","Style"]),EXTENDEDDATA_NODE_FACTORY=makeSimpleNodeFactory("ExtendedData");function writePlacemark(l,t,n){const s={node:l};t.getId()&&l.setAttribute("id",t.getId());const o=t.getProperties(),a={address:1,description:1,name:1,open:1,phoneNumber:1,styleUrl:1,visibility:1};a[t.getGeometryName()]=1;const h=Object.keys(o||{}).sort().filter(function(m){return!a[m]}),c=t.getStyleFunction();if(c){const m=c(t,0);if(m){const p=Array.isArray(m)?m:[m];let x=p;if(t.getGeometry()&&(x=p.filter(function(y){const T=y.getGeometryFunction()(t);if(T){const S=T.getType();return S==="GeometryCollection"?T.getGeometriesArrayRecursive().filter(function(C){const P=C.getType();return P==="Point"||P==="MultiPoint"}).length:S==="Point"||S==="MultiPoint"}})),this.writeStyles_){let y=p,T=p;t.getGeometry()&&(y=p.filter(function(S){const C=S.getGeometryFunction()(t);if(C){const P=C.getType();return P==="GeometryCollection"?C.getGeometriesArrayRecursive().filter(function(w){const I=w.getType();return I==="LineString"||I==="MultiLineString"}).length:P==="LineString"||P==="MultiLineString"}}),T=p.filter(function(S){const C=S.getGeometryFunction()(t);if(C){const P=C.getType();return P==="GeometryCollection"?C.getGeometriesArrayRecursive().filter(function(w){const I=w.getType();return I==="Polygon"||I==="MultiPolygon"}).length:P==="Polygon"||P==="MultiPolygon"}})),o.Style={pointStyles:x,lineStyles:y,polyStyles:T}}if(x.length&&o.name===void 0){const y=x[0].getText();y&&(o.name=y.getText())}}}const u=n[n.length-1].node,d=PLACEMARK_SEQUENCE[u.namespaceURI],f=makeSequence(o,d);if(pushSerializeAndPop(s,PLACEMARK_SERIALIZERS,OBJECT_PROPERTY_NODE_FACTORY,f,n,d),h.length>0){const m=makeSequence(o,h);pushSerializeAndPop(s,PLACEMARK_SERIALIZERS,EXTENDEDDATA_NODE_FACTORY,[{names:h,values:m}],n)}const g=n[0];let _=t.getGeometry();_&&(_=transformGeometryWithOptions(_,!0,g)),pushSerializeAndPop(s,PLACEMARK_SERIALIZERS,GEOMETRY_NODE_FACTORY,[_],n)}const PRIMITIVE_GEOMETRY_SEQUENCE=makeStructureNS(NAMESPACE_URIS$4,["extrude","tessellate","altitudeMode","coordinates"]),PRIMITIVE_GEOMETRY_SERIALIZERS=makeStructureNS(NAMESPACE_URIS$4,{extrude:makeChildAppender(writeBooleanTextNode),tessellate:makeChildAppender(writeBooleanTextNode),altitudeMode:makeChildAppender(writeStringTextNode),coordinates:makeChildAppender(writeCoordinatesTextNode)});function writePrimitiveGeometry(l,t,n){const s=t.getFlatCoordinates(),o={node:l};o.layout=t.getLayout(),o.stride=t.getStride();const a=t.getProperties();a.coordinates=s;const h=n[n.length-1].node,c=PRIMITIVE_GEOMETRY_SEQUENCE[h.namespaceURI],u=makeSequence(a,c);pushSerializeAndPop(o,PRIMITIVE_GEOMETRY_SERIALIZERS,OBJECT_PROPERTY_NODE_FACTORY,u,n,c)}const POLY_STYLE_SEQUENCE=makeStructureNS(NAMESPACE_URIS$4,["color","fill","outline"]),POLYGON_SERIALIZERS=makeStructureNS(NAMESPACE_URIS$4,{outerBoundaryIs:makeChildAppender(writeBoundaryIs),innerBoundaryIs:makeChildAppender(writeBoundaryIs)}),INNER_BOUNDARY_NODE_FACTORY=makeSimpleNodeFactory("innerBoundaryIs"),OUTER_BOUNDARY_NODE_FACTORY=makeSimpleNodeFactory("outerBoundaryIs");function writePolygon(l,t,n){const s=t.getLinearRings(),o=s.shift(),a={node:l};pushSerializeAndPop(a,POLYGON_SERIALIZERS,INNER_BOUNDARY_NODE_FACTORY,s,n),pushSerializeAndPop(a,POLYGON_SERIALIZERS,OUTER_BOUNDARY_NODE_FACTORY,[o],n)}const POLY_STYLE_SERIALIZERS=makeStructureNS(NAMESPACE_URIS$4,{color:makeChildAppender(writeColorTextNode),fill:makeChildAppender(writeBooleanTextNode),outline:makeChildAppender(writeBooleanTextNode)});function writePolyStyle(l,t,n){const s={node:l},o=t.getFill(),a=t.getStroke(),h={color:o?o.getColor():void 0,fill:o?void 0:!1,outline:a?void 0:!1},c=n[n.length-1].node,u=POLY_STYLE_SEQUENCE[c.namespaceURI],d=makeSequence(h,u);pushSerializeAndPop(s,POLY_STYLE_SERIALIZERS,OBJECT_PROPERTY_NODE_FACTORY,d,n,u)}function writeScaleTextNode(l,t){writeDecimalTextNode(l,Math.round(t*1e6)/1e6)}const STYLE_SEQUENCE=makeStructureNS(NAMESPACE_URIS$4,["IconStyle","LabelStyle","LineStyle","PolyStyle"]),STYLE_SERIALIZERS=makeStructureNS(NAMESPACE_URIS$4,{IconStyle:makeChildAppender(writeIconStyle),LabelStyle:makeChildAppender(writeLabelStyle),LineStyle:makeChildAppender(writeLineStyle),PolyStyle:makeChildAppender(writePolyStyle)});function writeStyle(l,t,n){const s={node:l},o={};if(t.pointStyles.length){const u=t.pointStyles[0].getText();u&&(o.LabelStyle=u);const d=t.pointStyles[0].getImage();d&&typeof d.getSrc=="function"&&(o.IconStyle=d)}if(t.lineStyles.length){const u=t.lineStyles[0].getStroke();u&&(o.LineStyle=u)}if(t.polyStyles.length){const u=t.polyStyles[0].getStroke();u&&!o.LineStyle&&(o.LineStyle=u),o.PolyStyle=t.polyStyles[0]}const a=n[n.length-1].node,h=STYLE_SEQUENCE[a.namespaceURI],c=makeSequence(o,h);pushSerializeAndPop(s,STYLE_SERIALIZERS,OBJECT_PROPERTY_NODE_FACTORY,c,n,h)}function writeVec2(l,t){l.setAttribute("x",String(t.x)),l.setAttribute("y",String(t.y)),l.setAttribute("xunits",t.xunits),l.setAttribute("yunits",t.yunits)}function getProj(l,t){const a=l.readFeatures(t)[0].getGeometry().getCoordinates();if(a&&a.length>0){const h=findFirstCoordinateValue(a);if(typeof h=="number")return h>=-180&&h<=180?"EPSG:4326":"EPSG:3857"}}function findFirstCoordinateValue(l){if(typeof l=="number")return l;if(Array.isArray(l)&&l.length>0)return findFirstCoordinateValue(l[0])}function parseTextToFeature(l,t,n,s=!1,o=!0){try{const a=getFormatReader(l);if(!a){console.error("Unsupported format or invalid data");return}const h=getProj(a,l),c=a.readFeatures(l,{dataProjection:h||READ_FEATURES_OPTIONS.dataProjection,featureProjection:n.projection});addNewFeature({features:c},t,n,!1,s,o)}catch(a){console.error("Error parsing data:",a)}}function getFormatReader(l){return isGeoJSON(l)?new GeoJSON:isKML(l)?new KML({extractStyles:!1}):isTopoJSON(l)?new TopoJSON:null}function isGeoJSON(l){try{const t=JSON.parse(l);return t.type==="FeatureCollection"||t.type==="Feature"}catch{return!1}}function isKML(l){return l.includes("<kml")&&l.includes("</kml>")}function isTopoJSON(l){try{const t=JSON.parse(l);return t.type==="Topology"&&t.objects}catch{return!1}}let registered=null;function register(l){registered=l;const t=Object.keys(l.defs),n=t.length;let s,o;for(s=0;s<n;++s){const a=t[s];if(!get$3(a)){const h=l.defs(a);let c=h.units;!c&&h.projName==="longlat"&&(c="degrees"),addProjection(new Projection({code:a,axisOrientation:h.axis,metersPerUnit:h.to_meter,units:c}))}}for(s=0;s<n;++s){const a=t[s],h=get$3(a);for(o=0;o<n;++o){const c=t[o],u=get$3(c);if(!get$2(a,c))if(l.defs[a]===l.defs[c])addEquivalentProjections([h,u]);else{const d=l(a,c);addCoordinateTransforms(h,u,createSafeCoordinateTransform(h,u,d.forward),createSafeCoordinateTransform(u,h,d.inverse))}}}}let epsgLookup=async function(l){const t=await fetch(`https://epsg.io/${l}.proj4`);if(!t.ok)throw new Error(`Unexpected response from epsg.io: ${t.status}`);return t.text()};async function fromEPSGCode(l){typeof l=="string"&&(l=parseInt(l.split(":").pop(),10));const t=registered;if(!t)throw new Error("Proj4 must be registered first with register(proj4)");const n="EPSG:"+l;return t.defs(n)||(t.defs(n,await epsgLookup(l)),register(t)),get$3(n)}function registerProjection(l,t,n=void 0){proj4.defs(l,t),register(proj4),typeof n<"u"&&get$1(l).setExtent(n)}async function registerProjectionFromCode(l){return register(proj4),await fromEPSGCode(l)}function parseFeature(l){return new GeoJSON().writeFeaturesObject(l)}function transform(l,t,n=void 0){return n||(n="EPSG:4326"),transform$1(l,t,n)}function transformExtent(l,t,n=void 0){return n||(n="EPSG:4326"),transformExtent$1(l,t,n)}function addScrollInteractions(l,t=!1){t?(l.addInteraction(new MouseWheelZoom({condition:platformModifierKeyOnly})),"ontouchstart"in window||navigator.maxTouchPoints>0?l.addInteraction(new DragPan({condition:function(s){return this.getPointerCount()===2||platformModifierKeyOnly(s)}})):l.addInteraction(new DragPan)):(l.addInteraction(new MouseWheelZoom),l.addInteraction(new DragPan))}function removeDefaultScrollInteractions(l){l.getInteractions().getArray().forEach(t=>{(t instanceof MouseWheelZoom||t instanceof DragPan)&&l.removeInteraction(t)})}function coordinatesRoughlyEquals(l,t,n=.001){let s=!0;for(let o=l.length-1;o>=0;--o)if(!numbersRoughlyEquals(l[o],t[o],n)){s=!1;break}return s}function numbersRoughlyEquals(l,t,n=.001){return Math.abs(l-t)<n}function getCenterFromProperty(l){if(l){const t=l;return!equals(t,[0,0])&&t[0]>=-180&&t[0]<=180&&t[1]>=-90&&t[1]<=90?fromLonLat(t):t}return[0,0]}function addDraw(l,t,n){const s=Object.assign({},n);if(l.interactions[s.id])throw Error(`Interaction with id: ${s.id} already exists.`);s.modify=typeof s.modify=="boolean"?s.modify:!0;const o=t.getSource();s.type==="Box"&&(s.geometryFunction=createBox(),s.type="Circle");const a=new Draw({...s,source:o});s.active===!1&&a.setActive(!1),a.on("drawend",u=>{t.get("isDrawingEnabled")&&addNewFeature(u,t,l,!0)}),l.map.addInteraction(a),l.interactions[s.id]=a;const h=new Modify({source:o});h.setActive(s.modify),l.map.addInteraction(h),l.interactions[`${s.id}_modify`]=h;const c=()=>{l.getLayerById(t.get("id"))||(l.removeInteraction(s.id),l.removeInteraction(`${s.id}_modify`),l.map.getLayerGroup().un("change",c))};l.map.getLayerGroup().on("change",c)}const Property$2={ELEMENT:"element",MAP:"map",OFFSET:"offset",POSITION:"position",POSITIONING:"positioning"};class Overlay extends BaseObject{constructor(t){super(),this.on,this.once,this.un,this.options=t,this.id=t.id,this.insertFirst=t.insertFirst!==void 0?t.insertFirst:!0,this.stopEvent=t.stopEvent!==void 0?t.stopEvent:!0,this.element=document.createElement("div"),this.element.className=t.className!==void 0?t.className:"ol-overlay-container "+CLASS_SELECTABLE,this.element.style.position="absolute",this.element.style.pointerEvents="auto",this.autoPan=t.autoPan===!0?{}:t.autoPan||void 0,this.rendered={transform_:"",visible:!0},this.mapPostrenderListenerKey=null,this.addChangeListener(Property$2.ELEMENT,this.handleElementChanged),this.addChangeListener(Property$2.MAP,this.handleMapChanged),this.addChangeListener(Property$2.OFFSET,this.handleOffsetChanged),this.addChangeListener(Property$2.POSITION,this.handlePositionChanged),this.addChangeListener(Property$2.POSITIONING,this.handlePositioningChanged),t.element!==void 0&&this.setElement(t.element),this.setOffset(t.offset!==void 0?t.offset:[0,0]),this.setPositioning(t.positioning||"top-left"),t.position!==void 0&&this.setPosition(t.position)}getElement(){return this.get(Property$2.ELEMENT)}getId(){return this.id}getMap(){return this.get(Property$2.MAP)||null}getOffset(){return this.get(Property$2.OFFSET)}getPosition(){return this.get(Property$2.POSITION)}getPositioning(){return this.get(Property$2.POSITIONING)}handleElementChanged(){removeChildren(this.element);const t=this.getElement();t&&this.element.appendChild(t)}handleMapChanged(){var n;this.mapPostrenderListenerKey&&((n=this.element)==null||n.remove(),unlistenByKey(this.mapPostrenderListenerKey),this.mapPostrenderListenerKey=null);const t=this.getMap();if(t){this.mapPostrenderListenerKey=listen(t,MapEventType.POSTRENDER,this.render,this),this.updatePixelPosition();const s=this.stopEvent?t.getOverlayContainerStopEvent():t.getOverlayContainer();this.insertFirst?s.insertBefore(this.element,s.childNodes[0]||null):s.appendChild(this.element),this.performAutoPan()}}render(){this.updatePixelPosition()}handleOffsetChanged(){this.updatePixelPosition()}handlePositionChanged(){this.updatePixelPosition(),this.performAutoPan()}handlePositioningChanged(){this.updatePixelPosition()}setElement(t){this.set(Property$2.ELEMENT,t)}setMap(t){this.set(Property$2.MAP,t)}setOffset(t){this.set(Property$2.OFFSET,t)}setPosition(t){this.set(Property$2.POSITION,t)}performAutoPan(){this.autoPan&&this.panIntoView(this.autoPan)}panIntoView(t){const n=this.getMap();if(!n||!n.getTargetElement()||!this.get(Property$2.POSITION))return;const s=this.getRect(n.getTargetElement(),n.getSize()),o=this.getElement(),a=this.getRect(o,[outerWidth(o),outerHeight(o)]);t=t||{};const h=t.margin===void 0?20:t.margin;if(!containsExtent(s,a)){const c=a[0]-s[0],u=s[2]-a[2],d=a[1]-s[1],f=s[3]-a[3],g=[0,0];if(c<0?g[0]=c-h:u<0&&(g[0]=Math.abs(u)+h),d<0?g[1]=d-h:f<0&&(g[1]=Math.abs(f)+h),g[0]!==0||g[1]!==0){const _=n.getView().getCenterInternal(),m=n.getPixelFromCoordinateInternal(_);if(!m)return;const p=[m[0]+g[0],m[1]+g[1]],x=t.animation||{};n.getView().animateInternal({center:n.getCoordinateFromPixelInternal(p),duration:x.duration,easing:x.easing})}}}getRect(t,n){const s=t.getBoundingClientRect(),o=s.left+window.pageXOffset,a=s.top+window.pageYOffset;return[o,a,o+n[0],a+n[1]]}setPositioning(t){this.set(Property$2.POSITIONING,t)}setVisible(t){this.rendered.visible!==t&&(this.element.style.display=t?"":"none",this.rendered.visible=t)}updatePixelPosition(){const t=this.getMap(),n=this.getPosition();if(!t||!t.isRendered()||!n){this.setVisible(!1);return}const s=t.getPixelFromCoordinate(n),o=t.getSize();this.updateRenderedPosition(s,o)}updateRenderedPosition(t,n){const s=this.element.style,o=this.getOffset(),a=this.getPositioning();this.setVisible(!0);const h=`${t[0]+o[0]}px`,c=`${t[1]+o[1]}px`;let u="0%",d="0%";a=="bottom-right"||a=="center-right"||a=="top-right"?u="-100%":(a=="bottom-center"||a=="center-center"||a=="top-center")&&(u="-50%"),a=="bottom-left"||a=="bottom-center"||a=="bottom-right"?d="-100%":(a=="center-left"||a=="center-center"||a=="center-right")&&(d="-50%");const f=`translate(${u}, ${d}) translate(${h}, ${c})`;this.rendered.transform_!=f&&(this.rendered.transform_=f,s.transform=f)}getOptions(){return this.options}}class EOxMapTooltip extends i{static get properties(){return{feature:{attribute:!1,property:!0,type:Object},propertyTransform:{attribute:!1,property:!0,type:Function}}}constructor(){super(),this.feature=null,this.propertyTransform=(t,n)=>t}render(){return this.feature?b` <style>
            ul {
              margin: 0;
              padding: 1rem 1rem 1rem 2rem;
              border-radius: 0.5rem;
              max-width: 250px;
              font-size: small;
              background-color: var(--inverse-surface);
              color: var(--inverse-on-surface);
              box-shadow: 0 0.25rem 0.5rem 0 rgb(0 0 0 / 0.4);
              line-height: normal;
              white-space: normal;
            }
            span {
              font-weight: bold;
            }
          </style>
          <ul>
            ${Object.entries(this.feature.getProperties()).map(([t,n])=>this.propertyTransform({key:t,value:n},this.feature)).filter(t=>t).map(({key:t,value:n})=>b`<li><span>${t}</span>: ${n}</li>`)}
          </ul>`:A}}customElements.get("eox-map-tooltip")||customElements.define("eox-map-tooltip",EOxMapTooltip);class MVT extends FeatureFormat{constructor(t){super(),t=t||{},this.dataProjection=new Projection({code:"",units:"tile-pixels"}),this.featureClass=t.featureClass?t.featureClass:RenderFeature,this.geometryName_=t.geometryName,this.layerName_=t.layerName?t.layerName:"layer",this.layers_=t.layers?t.layers:null,this.idProperty_=t.idProperty,this.supportedMediaTypes=["application/vnd.mapbox-vector-tile","application/x-protobuf"]}readRawGeometry_(t,n,s,o){t.pos=n.geometry;const a=t.readVarint()+t.pos;let h=1,c=0,u=0,d=0,f=0,g=0;for(;t.pos<a;){if(!c){const _=t.readVarint();h=_&7,c=_>>3}if(c--,h===1||h===2)u+=t.readSVarint(),d+=t.readSVarint(),h===1&&f>g&&(o.push(f),g=f),s.push(u,d),f+=2;else if(h===7)f>g&&(s.push(s[g],s[g+1]),f+=2);else throw new Error("Invalid command found in the PBF")}f>g&&(o.push(f),g=f)}createFeature_(t,n,s){const o=n.type;if(o===0)return null;let a;const h=n.properties;let c;this.idProperty_?(c=h[this.idProperty_],delete h[this.idProperty_]):c=n.id,h[this.layerName_]=n.layer.name;const u=[],d=[];this.readRawGeometry_(t,n,u,d);const f=getGeometryType(o,d.length);if(this.featureClass===RenderFeature)a=new this.featureClass(f,u,d,2,h,c),a.transform(s.dataProjection);else{let g;if(f=="Polygon"){const p=inflateEnds(u,d);g=p.length>1?new MultiPolygon(u,"XY",p):new Polygon(u,"XY",d)}else g=f==="Point"?new Point(u,"XY"):f==="LineString"?new LineString(u,"XY"):f==="MultiPoint"?new MultiPoint(u,"XY"):f==="MultiLineString"?new MultiLineString(u,"XY",d):null;const _=this.featureClass;a=new _,this.geometryName_&&a.setGeometryName(this.geometryName_);const m=transformGeometryWithOptions(g,!1,s);a.setGeometry(m),c!==void 0&&a.setId(c),a.setProperties(h,!0)}return a}getType(){return"arraybuffer"}readFeatures(t,n){const s=this.layers_;n=this.adaptOptions(n);const o=get$1(n.dataProjection);o.setWorldExtent(n.extent),n.dataProjection=o;const a=new Pbf(t),h=a.readFields(layersPBFReader,{}),c=[];for(const u in h){if(s&&!s.includes(u))continue;const d=h[u],f=d?[0,0,d.extent,d.extent]:null;o.setExtent(f);for(let g=0,_=d.length;g<_;++g){const m=readRawFeature(a,d,g),p=this.createFeature_(a,m,n);p!==null&&c.push(p)}}return c}readProjection(t){return this.dataProjection}setLayers(t){this.layers_=t}}function layersPBFReader(l,t,n){if(l===3){const s={keys:[],values:[],features:[]},o=n.readVarint()+n.pos;n.readFields(layerPBFReader,s,o),s.length=s.features.length,s.length&&(t[s.name]=s)}}function layerPBFReader(l,t,n){if(l===15)t.version=n.readVarint();else if(l===1)t.name=n.readString();else if(l===5)t.extent=n.readVarint();else if(l===2)t.features.push(n.pos);else if(l===3)t.keys.push(n.readString());else if(l===4){let s=null;const o=n.readVarint()+n.pos;for(;n.pos<o;)l=n.readVarint()>>3,s=l===1?n.readString():l===2?n.readFloat():l===3?n.readDouble():l===4?n.readVarint64():l===5?n.readVarint():l===6?n.readSVarint():l===7?n.readBoolean():null;t.values.push(s)}}function featurePBFReader(l,t,n){if(l==1)t.id=n.readVarint();else if(l==2){const s=n.readVarint()+n.pos;for(;n.pos<s;){const o=t.layer.keys[n.readVarint()],a=t.layer.values[n.readVarint()];t.properties[o]=a}}else l==3?t.type=n.readVarint():l==4&&(t.geometry=n.pos)}function readRawFeature(l,t,n){l.pos=t.features[n];const s=l.readVarint()+l.pos,o={layer:t,type:0,properties:{}};return l.readFields(featurePBFReader,o,s),o}function getGeometryType(l,t){let n;return l===1?n=t===1?"Point":"MultiPoint":l===2?n=t===1?"LineString":"MultiLineString":l===3&&(n="Polygon"),n}class CanvasImageLayerRenderer extends CanvasLayerRenderer{constructor(t){super(t),this.image=null}getImage(){return this.image?this.image.getImage():null}prepareFrame(t){const n=t.layerStatesArray[t.layerIndex],s=t.pixelRatio,o=t.viewState,a=o.resolution,h=this.getLayer().getSource(),c=t.viewHints;let u=t.extent;if(n.extent!==void 0&&(u=getIntersection(u,fromUserExtent(n.extent,o.projection))),!c[ViewHint.ANIMATING]&&!c[ViewHint.INTERACTING]&&!isEmpty(u))if(h){const d=o.projection,f=h.getImage(u,a,s,d);f&&(this.loadImage(f)?this.image=f:f.getState()===ImageState.EMPTY&&(this.image=null))}else this.image=null;return!!this.image}getData(t){const n=this.frameState;if(!n)return null;const s=this.getLayer(),o=apply(n.pixelToCoordinateTransform,t.slice()),a=s.getExtent();if(a&&!containsCoordinate(a,o))return null;const h=this.image.getExtent(),c=this.image.getImage(),u=getWidth(h),d=Math.floor(c.width*((o[0]-h[0])/u));if(d<0||d>=c.width)return null;const f=getHeight(h),g=Math.floor(c.height*((h[3]-o[1])/f));return g<0||g>=c.height?null:this.getImageData(c,d,g)}renderFrame(t,n){const s=this.image,o=s.getExtent(),a=s.getResolution(),[h,c]=Array.isArray(a)?a:[a,a],u=s.getPixelRatio(),d=t.layerStatesArray[t.layerIndex],f=t.pixelRatio,g=t.viewState,_=g.center,m=g.resolution,p=f*h/(m*u),x=f*c/(m*u);this.prepareContainer(t,n);const y=this.context.canvas.width,T=this.context.canvas.height,S=this.getRenderContext(t);let C=!1,P=!0;if(d.extent){const k=fromUserExtent(d.extent,g.projection);P=intersects$1(k,t.extent),C=P&&!containsExtent(k,t.extent),C&&this.clipUnrotated(S,t,k)}const w=s.getImage(),I=compose(this.tempTransform,y/2,T/2,p,x,0,u*(o[0]-_[0])/h,u*(_[1]-o[3])/c);this.renderedResolution=c*f/u;const O=w.width*I[0],N=w.height*I[3];if(this.getLayer().getSource().getInterpolate()||(S.imageSmoothingEnabled=!1),this.preRender(S,t),P&&O>=.5&&N>=.5){const k=I[4],D=I[5],ze=d.opacity;ze!==1&&(S.save(),S.globalAlpha=ze),S.drawImage(w,0,0,+w.width,+w.height,k,D,O,N),ze!==1&&S.restore()}return this.postRender(this.context,t),C&&S.restore(),S.imageSmoothingEnabled=!0,this.container}}class BaseImageLayer extends Layer{constructor(t){t=t||{},super(t)}}class ImageLayer extends BaseImageLayer{constructor(t){super(t)}createRenderer(){return new CanvasImageLayerRenderer(this)}getData(t){return super.getData(t)}}class Tile extends Target{constructor(t,n,s){super(),s=s||{},this.tileCoord=t,this.state=n,this.key="",this.transition_=s.transition===void 0?250:s.transition,this.transitionStarts_={},this.interpolate=!!s.interpolate}changed(){this.dispatchEvent(EventType$1.CHANGE)}release(){this.setState(TileState.EMPTY)}getKey(){return this.key+"/"+this.tileCoord}getTileCoord(){return this.tileCoord}getState(){return this.state}setState(t){if(this.state!==TileState.EMPTY){if(this.state!==TileState.ERROR&&this.state>t)throw new Error("Tile load sequence violation");this.state=t,this.changed()}}load(){abstract()}getAlpha(t,n){if(!this.transition_)return 1;let s=this.transitionStarts_[t];if(!s)s=n,this.transitionStarts_[t]=s;else if(s===-1)return 1;const o=n-s+1e3/60;return o>=this.transition_?1:easeIn(o/this.transition_)}inTransition(t){return this.transition_?this.transitionStarts_[t]!==-1:!1}endTransition(t){this.transition_&&(this.transitionStarts_[t]=-1)}disposeInternal(){this.release(),super.disposeInternal()}}function asImageLike(l){return l instanceof Image||l instanceof HTMLCanvasElement||l instanceof HTMLVideoElement||l instanceof ImageBitmap?l:null}function asArrayLike(l){return l instanceof Uint8Array||l instanceof Uint8ClampedArray||l instanceof Float32Array||l instanceof DataView?l:null}const disposedError=new Error("disposed");let sharedContext$1=null;function toArray(l){sharedContext$1||(sharedContext$1=createCanvasContext2D(l.width,l.height,void 0,{willReadFrequently:!0}));const t=sharedContext$1.canvas,n=l.width;t.width!==n&&(t.width=n);const s=l.height;return t.height!==s&&(t.height=s),sharedContext$1.clearRect(0,0,n,s),sharedContext$1.drawImage(l,0,0),sharedContext$1.getImageData(0,0,n,s).data}const defaultSize=[256,256];class DataTile extends Tile{constructor(t){const n=TileState.IDLE;super(t.tileCoord,n,{transition:t.transition,interpolate:t.interpolate}),this.loader_=t.loader,this.data_=null,this.error_=null,this.size_=t.size||null,this.controller_=t.controller||null}getSize(){if(this.size_)return this.size_;const t=asImageLike(this.data_);return t?[t.width,t.height]:defaultSize}getData(){return this.data_}getError(){return this.error_}load(){if(this.state!==TileState.IDLE&&this.state!==TileState.ERROR)return;this.state=TileState.LOADING,this.changed();const t=this;this.loader_().then(function(n){t.data_=n,t.state=TileState.LOADED,t.changed()}).catch(function(n){t.error_=n,t.state=TileState.ERROR,t.changed()})}disposeInternal(){this.controller_&&(this.controller_.abort(disposedError),this.controller_=null),super.disposeInternal()}}class ImageTile extends Tile{constructor(t,n,s,o,a,h){super(t,n,h),this.crossOrigin_=o,this.src_=s,this.key=s,this.image_,WORKER_OFFSCREEN_CANVAS?this.image_=new OffscreenCanvas(1,1):(this.image_=new Image,o!==null&&(this.image_.crossOrigin=o)),this.unlisten_=null,this.tileLoadFunction_=a}getImage(){return this.image_}setImage(t){this.image_=t,this.state=TileState.LOADED,this.unlistenImage_(),this.changed()}getCrossOrigin(){return this.crossOrigin_}handleImageError_(){this.state=TileState.ERROR,this.unlistenImage_(),this.image_=getBlankImage(),this.changed()}handleImageLoad_(){if(WORKER_OFFSCREEN_CANVAS)this.state=TileState.LOADED;else{const t=this.image_;t.naturalWidth&&t.naturalHeight?this.state=TileState.LOADED:this.state=TileState.EMPTY}this.unlistenImage_(),this.changed()}load(){this.state==TileState.ERROR&&(this.state=TileState.IDLE,this.image_=new Image,this.crossOrigin_!==null&&(this.image_.crossOrigin=this.crossOrigin_)),this.state==TileState.IDLE&&(this.state=TileState.LOADING,this.changed(),this.tileLoadFunction_(this,this.src_),this.unlisten_=listenImage(this.image_,this.handleImageLoad_.bind(this),this.handleImageError_.bind(this)))}unlistenImage_(){this.unlisten_&&(this.unlisten_(),this.unlisten_=null)}disposeInternal(){this.unlistenImage_(),this.image_=null,super.disposeInternal()}}function getBlankImage(){const l=createCanvasContext2D(1,1);return l.fillStyle="rgba(0,0,0,0)",l.fillRect(0,0,1,1),l.canvas}class TileRange{constructor(t,n,s,o){this.minX=t,this.maxX=n,this.minY=s,this.maxY=o}contains(t){return this.containsXY(t[1],t[2])}containsTileRange(t){return this.minX<=t.minX&&t.maxX<=this.maxX&&this.minY<=t.minY&&t.maxY<=this.maxY}containsXY(t,n){return this.minX<=t&&t<=this.maxX&&this.minY<=n&&n<=this.maxY}equals(t){return this.minX==t.minX&&this.minY==t.minY&&this.maxX==t.maxX&&this.maxY==t.maxY}extend(t){t.minX<this.minX&&(this.minX=t.minX),t.maxX>this.maxX&&(this.maxX=t.maxX),t.minY<this.minY&&(this.minY=t.minY),t.maxY>this.maxY&&(this.maxY=t.maxY)}getHeight(){return this.maxY-this.minY+1}getSize(){return[this.getWidth(),this.getHeight()]}getWidth(){return this.maxX-this.minX+1}intersects(t){return this.minX<=t.maxX&&this.maxX>=t.minX&&this.minY<=t.maxY&&this.maxY>=t.minY}}function createOrUpdate$1(l,t,n,s,o){return o!==void 0?(o.minX=l,o.maxX=t,o.minY=n,o.maxY=s,o):new TileRange(l,t,n,s)}let brokenDiagonalRendering_;const canvasPool$1=[];function drawTestTriangle(l,t,n,s,o){l.beginPath(),l.moveTo(0,0),l.lineTo(t,n),l.lineTo(s,o),l.closePath(),l.save(),l.clip(),l.fillRect(0,0,Math.max(t,s)+1,Math.max(n,o)),l.restore()}function verifyBrokenDiagonalRendering(l,t){return Math.abs(l[t*4]-210)>2||Math.abs(l[t*4+3]-.75*255)>2}function isBrokenDiagonalRendering(){if(brokenDiagonalRendering_===void 0){const l=createCanvasContext2D(6,6,canvasPool$1);l.globalCompositeOperation="lighter",l.fillStyle="rgba(210, 0, 0, 0.75)",drawTestTriangle(l,4,5,4,0),drawTestTriangle(l,4,5,0,5);const t=l.getImageData(0,0,3,3).data;brokenDiagonalRendering_=verifyBrokenDiagonalRendering(t,0)||verifyBrokenDiagonalRendering(t,4)||verifyBrokenDiagonalRendering(t,8),releaseCanvas$1(l),canvasPool$1.push(l.canvas)}return brokenDiagonalRendering_}function calculateSourceResolution(l,t,n,s){const o=transform$1(n,t,l);let a=getPointResolution(t,s,n);const h=t.getMetersPerUnit();h!==void 0&&(a*=h);const c=l.getMetersPerUnit();c!==void 0&&(a/=c);const u=l.getExtent();if(!u||containsCoordinate(u,o)){const d=getPointResolution(l,a,o)/a;isFinite(d)&&d>0&&(a/=d)}return a}function calculateSourceExtentResolution(l,t,n,s){const o=getCenter(n);let a=calculateSourceResolution(l,t,o,s);return(!isFinite(a)||a<=0)&&forEachCorner(n,function(h){return a=calculateSourceResolution(l,t,h,s),isFinite(a)&&a>0}),a}function render$1(l,t,n,s,o,a,h,c,u,d,f,g,_,m){const p=createCanvasContext2D(Math.round(n*l),Math.round(n*t),canvasPool$1);if(g||(p.imageSmoothingEnabled=!1),u.length===0)return p.canvas;p.scale(n,n);function x(w){return Math.round(w*n)/n}p.globalCompositeOperation="lighter";const y=createEmpty();u.forEach(function(w,I,O){extend$1(y,w.extent)});let T;const S=n/s,C=(g?1:1+Math.pow(2,-24))/S;if(!_||u.length!==1||d!==0){if(T=createCanvasContext2D(Math.round(getWidth(y)*S),Math.round(getHeight(y)*S),canvasPool$1),g||(T.imageSmoothingEnabled=!1),o&&m){const w=(o[0]-y[0])*S,I=-(o[3]-y[3])*S,O=getWidth(o)*S,N=getHeight(o)*S;T.rect(w,I,O,N),T.clip()}u.forEach(function(w,I,O){if(w.image.width>0&&w.image.height>0){if(w.clipExtent){T.save();const z=(w.clipExtent[0]-y[0])*S,Ee=-(w.clipExtent[3]-y[3])*S,B=getWidth(w.clipExtent)*S,rt=getHeight(w.clipExtent)*S;T.rect(g?z:Math.round(z),g?Ee:Math.round(Ee),g?B:Math.round(z+B)-Math.round(z),g?rt:Math.round(Ee+rt)-Math.round(Ee)),T.clip()}const N=(w.extent[0]-y[0])*S,k=-(w.extent[3]-y[3])*S,D=getWidth(w.extent)*S,ze=getHeight(w.extent)*S;T.drawImage(w.image,d,d,w.image.width-2*d,w.image.height-2*d,g?N:Math.round(N),g?k:Math.round(k),g?D:Math.round(N+D)-Math.round(N),g?ze:Math.round(k+ze)-Math.round(k)),w.clipExtent&&T.restore()}})}const P=getTopLeft(h);return c.getTriangles().forEach(function(w,I,O){const N=w.source,k=w.target;let D=N[0][0],ze=N[0][1],z=N[1][0],Ee=N[1][1],B=N[2][0],rt=N[2][1];const wt=x((k[0][0]-P[0])/a),re=x(-(k[0][1]-P[1])/a),mt=x((k[1][0]-P[0])/a),Mt=x(-(k[1][1]-P[1])/a),Bt=x((k[2][0]-P[0])/a),Ht=x(-(k[2][1]-P[1])/a),Nt=D,Wt=ze;D=0,ze=0,z-=Nt,Ee-=Wt,B-=Nt,rt-=Wt;const $t=[[z,Ee,0,0,mt-wt],[B,rt,0,0,Bt-wt],[0,0,z,Ee,Mt-re],[0,0,B,rt,Ht-re]],Zt=solveLinearSystem($t);if(!Zt)return;if(p.save(),p.beginPath(),isBrokenDiagonalRendering()||!g){p.moveTo(mt,Mt);const Os=4,Rc=wt-mt,Sc=re-Mt;for(let Lc=0;Lc<Os;Lc++)p.lineTo(mt+x((Lc+1)*Rc/Os),Mt+x(Lc*Sc/(Os-1))),Lc!=Os-1&&p.lineTo(mt+x((Lc+1)*Rc/Os),Mt+x((Lc+1)*Sc/(Os-1)));p.lineTo(Bt,Ht)}else p.moveTo(mt,Mt),p.lineTo(wt,re),p.lineTo(Bt,Ht);p.clip(),p.transform(Zt[0],Zt[2],Zt[1],Zt[3],wt,re),p.translate(y[0]-Nt,y[3]-Wt);let ki;if(T)ki=T.canvas,p.scale(C,-C);else{const Os=u[0],Rc=Os.extent;ki=Os.image,p.scale(getWidth(Rc)/ki.width,-getHeight(Rc)/ki.height)}p.drawImage(ki,0,0),p.restore()}),T&&(releaseCanvas$1(T),canvasPool$1.push(T.canvas)),f&&(p.save(),p.globalCompositeOperation="source-over",p.strokeStyle="black",p.lineWidth=1,c.getTriangles().forEach(function(w,I,O){const N=w.target,k=(N[0][0]-P[0])/a,D=-(N[0][1]-P[1])/a,ze=(N[1][0]-P[0])/a,z=-(N[1][1]-P[1])/a,Ee=(N[2][0]-P[0])/a,B=-(N[2][1]-P[1])/a;p.beginPath(),p.moveTo(ze,z),p.lineTo(k,D),p.lineTo(Ee,B),p.closePath(),p.stroke()}),p.restore()),p.canvas}const MAX_SUBDIVISION=10,MAX_TRIANGLE_WIDTH=.25;class Triangulation{constructor(t,n,s,o,a,h,c){this.sourceProj_=t,this.targetProj_=n;let u={};const d=c?createTransformFromCoordinateTransform(C=>apply(c,transform$1(C,this.targetProj_,this.sourceProj_))):getTransform(this.targetProj_,this.sourceProj_);this.transformInv_=function(C){const P=C[0]+"/"+C[1];return u[P]||(u[P]=d(C)),u[P]},this.maxSourceExtent_=o,this.errorThresholdSquared_=a*a,this.triangles_=[],this.wrapsXInSource_=!1,this.canWrapXInSource_=this.sourceProj_.canWrapX()&&!!o&&!!this.sourceProj_.getExtent()&&getWidth(o)>=getWidth(this.sourceProj_.getExtent()),this.sourceWorldWidth_=this.sourceProj_.getExtent()?getWidth(this.sourceProj_.getExtent()):null,this.targetWorldWidth_=this.targetProj_.getExtent()?getWidth(this.targetProj_.getExtent()):null;const f=getTopLeft(s),g=getTopRight(s),_=getBottomRight(s),m=getBottomLeft(s),p=this.transformInv_(f),x=this.transformInv_(g),y=this.transformInv_(_),T=this.transformInv_(m),S=MAX_SUBDIVISION+(h?Math.max(0,Math.ceil(Math.log2(getArea$1(s)/(h*h*256*256)))):0);if(this.addQuad_(f,g,_,m,p,x,y,T,S),this.wrapsXInSource_){let C=1/0;this.triangles_.forEach(function(P,w,I){C=Math.min(C,P.source[0][0],P.source[1][0],P.source[2][0])}),this.triangles_.forEach(P=>{if(Math.max(P.source[0][0],P.source[1][0],P.source[2][0])-C>this.sourceWorldWidth_/2){const w=[[P.source[0][0],P.source[0][1]],[P.source[1][0],P.source[1][1]],[P.source[2][0],P.source[2][1]]];w[0][0]-C>this.sourceWorldWidth_/2&&(w[0][0]-=this.sourceWorldWidth_),w[1][0]-C>this.sourceWorldWidth_/2&&(w[1][0]-=this.sourceWorldWidth_),w[2][0]-C>this.sourceWorldWidth_/2&&(w[2][0]-=this.sourceWorldWidth_);const I=Math.min(w[0][0],w[1][0],w[2][0]);Math.max(w[0][0],w[1][0],w[2][0])-I<this.sourceWorldWidth_/2&&(P.source=w)}})}u={}}addTriangle_(t,n,s,o,a,h){this.triangles_.push({source:[o,a,h],target:[t,n,s]})}addQuad_(t,n,s,o,a,h,c,u,d){const f=boundingExtent([a,h,c,u]),g=this.sourceWorldWidth_?getWidth(f)/this.sourceWorldWidth_:null,_=this.sourceWorldWidth_,m=this.sourceProj_.canWrapX()&&g>.5&&g<1;let p=!1;if(d>0){if(this.targetProj_.isGlobal()&&this.targetWorldWidth_){const y=boundingExtent([t,n,s,o]);p=getWidth(y)/this.targetWorldWidth_>MAX_TRIANGLE_WIDTH||p}!m&&this.sourceProj_.isGlobal()&&g&&(p=g>MAX_TRIANGLE_WIDTH||p)}if(!p&&this.maxSourceExtent_&&isFinite(f[0])&&isFinite(f[1])&&isFinite(f[2])&&isFinite(f[3])&&!intersects$1(f,this.maxSourceExtent_))return;let x=0;if(!p&&(!isFinite(a[0])||!isFinite(a[1])||!isFinite(h[0])||!isFinite(h[1])||!isFinite(c[0])||!isFinite(c[1])||!isFinite(u[0])||!isFinite(u[1]))){if(d>0)p=!0;else if(x=(!isFinite(a[0])||!isFinite(a[1])?8:0)+(!isFinite(h[0])||!isFinite(h[1])?4:0)+(!isFinite(c[0])||!isFinite(c[1])?2:0)+(!isFinite(u[0])||!isFinite(u[1])?1:0),x!=1&&x!=2&&x!=4&&x!=8)return}if(d>0){if(!p){const y=[(t[0]+s[0])/2,(t[1]+s[1])/2],T=this.transformInv_(y);let S;m?S=(modulo(a[0],_)+modulo(c[0],_))/2-modulo(T[0],_):S=(a[0]+c[0])/2-T[0];const C=(a[1]+c[1])/2-T[1];p=S*S+C*C>this.errorThresholdSquared_}if(p){if(Math.abs(t[0]-s[0])<=Math.abs(t[1]-s[1])){const y=[(n[0]+s[0])/2,(n[1]+s[1])/2],T=this.transformInv_(y),S=[(o[0]+t[0])/2,(o[1]+t[1])/2],C=this.transformInv_(S);this.addQuad_(t,n,y,S,a,h,T,C,d-1),this.addQuad_(S,y,s,o,C,T,c,u,d-1)}else{const y=[(t[0]+n[0])/2,(t[1]+n[1])/2],T=this.transformInv_(y),S=[(s[0]+o[0])/2,(s[1]+o[1])/2],C=this.transformInv_(S);this.addQuad_(t,y,S,o,a,T,C,u,d-1),this.addQuad_(y,n,s,S,T,h,c,C,d-1)}return}}if(m){if(!this.canWrapXInSource_)return;this.wrapsXInSource_=!0}x&11||this.addTriangle_(t,s,o,a,c,u),x&14||this.addTriangle_(t,s,n,a,c,h),x&&(x&13||this.addTriangle_(n,o,t,h,u,a),x&7||this.addTriangle_(n,o,s,h,u,c))}calculateSourceExtent(){const t=createEmpty();return this.triangles_.forEach(function(n,s,o){const a=n.source;extendCoordinate(t,a[0]),extendCoordinate(t,a[1]),extendCoordinate(t,a[2])}),t}getTriangles(){return this.triangles_}}const ERROR_THRESHOLD=.5;class ReprojTile extends Tile{constructor(t,n,s,o,a,h,c,u,d,f,g,_){super(a,TileState.IDLE,_),this.renderEdges_=g!==void 0?g:!1,this.pixelRatio_=c,this.gutter_=u,this.canvas_=null,this.sourceTileGrid_=n,this.targetTileGrid_=o,this.wrappedTileCoord_=h||a,this.sourceTiles_=[],this.sourcesListenerKeys_=null,this.sourceZ_=0,this.clipExtent_=t.canWrapX()?t.getExtent():void 0;const m=o.getTileCoordExtent(this.wrappedTileCoord_),p=this.targetTileGrid_.getExtent();let x=this.sourceTileGrid_.getExtent();const y=p?getIntersection(m,p):m;if(getArea$1(y)===0){this.state=TileState.EMPTY;return}const T=t.getExtent();T&&(x?x=getIntersection(x,T):x=T);const S=o.getResolution(this.wrappedTileCoord_[0]),C=calculateSourceExtentResolution(t,s,y,S);if(!isFinite(C)||C<=0){this.state=TileState.EMPTY;return}const P=f!==void 0?f:ERROR_THRESHOLD;if(this.triangulation_=new Triangulation(t,s,y,x,C*P,S),this.triangulation_.getTriangles().length===0){this.state=TileState.EMPTY;return}this.sourceZ_=n.getZForResolution(C);let w=this.triangulation_.calculateSourceExtent();if(x&&(t.canWrapX()?(w[1]=clamp(w[1],x[1],x[3]),w[3]=clamp(w[3],x[1],x[3])):w=getIntersection(w,x)),!getArea$1(w))this.state=TileState.EMPTY;else{let I=0,O=0;t.canWrapX()&&(I=getWidth(T),O=Math.floor((w[0]-T[0])/I)),wrapAndSliceX(w.slice(),t,!0).forEach(k=>{const D=n.getTileRangeForExtentAndZ(k,this.sourceZ_);for(let ze=D.minX;ze<=D.maxX;ze++)for(let z=D.minY;z<=D.maxY;z++){const Ee=d(this.sourceZ_,ze,z,c);if(Ee){const B=O*I;this.sourceTiles_.push({tile:Ee,offset:B})}}++O}),this.sourceTiles_.length===0&&(this.state=TileState.EMPTY)}}getImage(){return this.canvas_}reproject_(){const t=[];if(this.sourceTiles_.forEach(n=>{var o;const s=n.tile;if(s&&s.getState()==TileState.LOADED){const a=this.sourceTileGrid_.getTileCoordExtent(s.tileCoord);a[0]+=n.offset,a[2]+=n.offset;const h=(o=this.clipExtent_)==null?void 0:o.slice();h&&(h[0]+=n.offset,h[2]+=n.offset),t.push({extent:a,clipExtent:h,image:s.getImage()})}}),this.sourceTiles_.length=0,t.length===0)this.state=TileState.ERROR;else{const n=this.wrappedTileCoord_[0],s=this.targetTileGrid_.getTileSize(n),o=typeof s=="number"?s:s[0],a=typeof s=="number"?s:s[1],h=this.targetTileGrid_.getResolution(n),c=this.sourceTileGrid_.getResolution(this.sourceZ_),u=this.targetTileGrid_.getTileCoordExtent(this.wrappedTileCoord_);this.canvas_=render$1(o,a,this.pixelRatio_,c,this.sourceTileGrid_.getExtent(),h,u,this.triangulation_,t,this.gutter_,this.renderEdges_,this.interpolate),this.state=TileState.LOADED}this.changed()}load(){if(this.state==TileState.IDLE){this.state=TileState.LOADING,this.changed();let t=0;this.sourcesListenerKeys_=[],this.sourceTiles_.forEach(({tile:n})=>{const s=n.getState();if(s==TileState.IDLE||s==TileState.LOADING){t++;const o=listen(n,EventType$1.CHANGE,a=>{const h=n.getState();(h==TileState.LOADED||h==TileState.ERROR||h==TileState.EMPTY)&&(unlistenByKey(o),t--,t===0&&(this.unlistenSources_(),this.reproject_()))});this.sourcesListenerKeys_.push(o)}}),t===0?setTimeout(this.reproject_.bind(this),0):this.sourceTiles_.forEach(function({tile:n},s,o){n.getState()==TileState.IDLE&&n.load()})}}unlistenSources_(){this.sourcesListenerKeys_.forEach(unlistenByKey),this.sourcesListenerKeys_=null}release(){this.canvas_&&(releaseCanvas$1(this.canvas_.getContext("2d")),canvasPool$1.push(this.canvas_),this.canvas_=null),super.release()}}class LRUCache{constructor(t){this.highWaterMark=t!==void 0?t:2048,this.count_=0,this.entries_={},this.oldest_=null,this.newest_=null}deleteOldest(){const t=this.pop();t instanceof Disposable&&t.dispose()}canExpireCache(){return this.highWaterMark>0&&this.getCount()>this.highWaterMark}expireCache(t){for(;this.canExpireCache();)this.deleteOldest()}clear(){for(;this.oldest_;)this.deleteOldest()}containsKey(t){return this.entries_.hasOwnProperty(t)}forEach(t){let n=this.oldest_;for(;n;)t(n.value_,n.key_,this),n=n.newer}get(t,n){const s=this.entries_[t];return assert(s!==void 0,"Tried to get a value for a key that does not exist in the cache"),s===this.newest_||(s===this.oldest_?(this.oldest_=this.oldest_.newer,this.oldest_.older=null):(s.newer.older=s.older,s.older.newer=s.newer),s.newer=null,s.older=this.newest_,this.newest_.newer=s,this.newest_=s),s.value_}remove(t){const n=this.entries_[t];return assert(n!==void 0,"Tried to get a value for a key that does not exist in the cache"),n===this.newest_?(this.newest_=n.older,this.newest_&&(this.newest_.newer=null)):n===this.oldest_?(this.oldest_=n.newer,this.oldest_&&(this.oldest_.older=null)):(n.newer.older=n.older,n.older.newer=n.newer),delete this.entries_[t],--this.count_,n.value_}getCount(){return this.count_}getKeys(){const t=new Array(this.count_);let n=0,s;for(s=this.newest_;s;s=s.older)t[n++]=s.key_;return t}getValues(){const t=new Array(this.count_);let n=0,s;for(s=this.newest_;s;s=s.older)t[n++]=s.value_;return t}peekLast(){return this.oldest_.value_}peekLastKey(){return this.oldest_.key_}peekFirstKey(){return this.newest_.key_}peek(t){var n;return(n=this.entries_[t])==null?void 0:n.value_}pop(){const t=this.oldest_;return delete this.entries_[t.key_],t.newer&&(t.newer.older=null),this.oldest_=t.newer,this.oldest_||(this.newest_=null),--this.count_,t.value_}replace(t,n){this.get(t),this.entries_[t].value_=n}set(t,n){assert(!(t in this.entries_),"Tried to set a value for a key that is used already");const s={key_:t,newer:null,older:this.newest_,value_:n};this.newest_?this.newest_.newer=s:this.oldest_=s,this.newest_=s,this.entries_[t]=s,++this.count_}setSize(t){this.highWaterMark=t}}function createOrUpdate(l,t,n,s){return s!==void 0?(s[0]=l,s[1]=t,s[2]=n,s):[l,t,n]}function getKeyZXY(l,t,n){return l+"/"+t+"/"+n}function getKey(l){return getKeyZXY(l[0],l[1],l[2])}function getCacheKey$1(l,t,n,s,o){return`${getUid(l)},${t},${getKeyZXY(n,s,o)}`}function hash(l){return hashZXY(l[0],l[1],l[2])}function hashZXY(l,t,n){return(t<<l)+n}function withinExtentAndZ(l,t){const n=l[0],s=l[1],o=l[2];if(t.getMinZoom()>n||n>t.getMaxZoom())return!1;const a=t.getFullTileRange(n);return a?a.containsXY(s,o):!0}function addTileToLookup(l,t,n){if(!(n in l))return l[n]=new Set([t]),!0;const s=l[n],o=s.has(t);return o||s.add(t),!o}function removeTileFromLookup(l,t,n){const s=l[n];return s?s.delete(t):!1}function getRenderExtent$1(l,t){const n=l.layerStatesArray[l.layerIndex];n.extent&&(t=getIntersection(t,fromUserExtent(n.extent,l.viewState.projection)));const s=n.layer.getRenderSource();if(!s.getWrapX()){const o=s.getTileGridForProjection(l.viewState.projection).getExtent();o&&(t=getIntersection(t,o))}return t}class CanvasTileLayerRenderer extends CanvasLayerRenderer{constructor(t,n){super(t),n=n||{},this.extentChanged=!0,this.renderComplete=!1,this.renderedExtent_=null,this.renderedPixelRatio,this.renderedProjection=null,this.renderedTiles=[],this.renderedSourceKey_,this.renderedSourceRevision_,this.tempExtent=createEmpty(),this.tempTileRange_=new TileRange(0,0,0,0),this.tempTileCoord_=createOrUpdate(0,0,0);const s=n.cacheSize!==void 0?n.cacheSize:512;this.tileCache_=new LRUCache(s),this.sourceTileCache_=null,this.maxStaleKeys=s*.5}getTileCache(){return this.tileCache_}getSourceTileCache(){return this.sourceTileCache_||(this.sourceTileCache_=new LRUCache(512)),this.sourceTileCache_}getOrCreateTile(t,n,s,o){const a=this.tileCache_,c=this.getLayer().getSource(),u=getCacheKey$1(c,c.getKey(),t,n,s);let d;if(a.containsKey(u))d=a.get(u);else{const f=o.viewState.projection,g=c.getProjection();if(d=c.getTile(t,n,s,o.pixelRatio,f,!g||equivalent$1(g,f)?void 0:this.getSourceTileCache()),!d)return null;a.set(u,d)}return d}getTile(t,n,s,o){const a=this.getOrCreateTile(t,n,s,o);return a||null}getData(t){const n=this.frameState;if(!n)return null;const s=this.getLayer(),o=apply(n.pixelToCoordinateTransform,t.slice()),a=s.getExtent();if(a&&!containsCoordinate(a,o))return null;const h=n.viewState,c=s.getRenderSource(),u=c.getTileGridForProjection(h.projection),d=c.getTilePixelRatio(n.pixelRatio);for(let f=u.getZForResolution(h.resolution);f>=u.getMinZoom();--f){const g=u.getTileCoordForCoordAndZ(o,f),_=this.getTile(f,g[1],g[2],n);if(!_||_.getState()!==TileState.LOADED)continue;const m=u.getOrigin(f),p=toSize(u.getTileSize(f)),x=u.getResolution(f);let y;if(_ instanceof ImageTile||_ instanceof ReprojTile)y=_.getImage();else if(_ instanceof DataTile){if(y=asImageLike(_.getData()),!y)continue}else continue;const T=Math.floor(d*((o[0]-m[0])/x-g[1]*p[0])),S=Math.floor(d*((m[1]-o[1])/x-g[2]*p[1])),C=Math.round(d*c.getGutterForProjection(h.projection));return this.getImageData(y,T+C,S+C)}return null}prepareFrame(t){var o;this.renderedProjection?t.viewState.projection!==this.renderedProjection&&(this.tileCache_.clear(),this.renderedProjection=t.viewState.projection):this.renderedProjection=t.viewState.projection;const n=this.getLayer().getSource();if(!n)return!1;const s=n.getRevision();return this.renderedSourceRevision_?this.renderedSourceRevision_!==s&&(this.renderedSourceRevision_=s,this.renderedSourceKey_===n.getKey()&&(this.tileCache_.clear(),(o=this.sourceTileCache_)==null||o.clear())):this.renderedSourceRevision_=s,!0}enqueueTilesForNextExtent(){return!0}enqueueTiles(t,n,s,o,a){const h=t.viewState,c=this.getLayer(),u=c.getRenderSource(),d=u.getTileGridForProjection(h.projection),f=getUid(u);f in t.wantedTiles||(t.wantedTiles[f]={});const g=t.wantedTiles[f],_=c.getMapInternal(),m=Math.max(s-a,d.getMinZoom(),d.getZForResolution(Math.min(c.getMaxResolution(),_?_.getView().getResolutionForZoom(Math.max(c.getMinZoom(),0)):d.getResolution(0)),u.zDirection)),p=h.rotation,x=p?getRotatedViewport(h.center,h.resolution,p,t.size):void 0;for(let y=s;y>=m;--y){const T=d.getTileRangeForExtentAndZ(n,y,this.tempTileRange_),S=d.getResolution(y);for(let C=T.minX;C<=T.maxX;++C)for(let P=T.minY;P<=T.maxY;++P){if(p&&!d.tileCoordIntersectsViewport([y,C,P],x))continue;const w=this.getTile(y,C,P,t);if(!w||!addTileToLookup(o,w,y))continue;const O=w.getKey();if(g[O]=!0,w.getState()===TileState.IDLE&&!t.tileQueue.isKeyQueued(O)){const N=createOrUpdate(y,C,P,this.tempTileCoord_);t.tileQueue.enqueue([w,f,d.getTileCoordCenter(N),S])}}}}findStaleTile_(t,n){const s=this.tileCache_,o=t[0],a=t[1],h=t[2],c=this.getStaleKeys();for(let u=0;u<c.length;++u){const d=getCacheKey$1(this.getLayer().getSource(),c[u],o,a,h);if(s.containsKey(d)){const f=s.peek(d);if(f.getState()===TileState.LOADED)return f.endTransition(getUid(this)),addTileToLookup(n,f,o),!0}}return!1}findAltTiles_(t,n,s,o){const a=t.getTileRangeForTileCoordAndZ(n,s,this.tempTileRange_);if(!a)return!1;let h=!0;const c=this.tileCache_,u=this.getLayer().getRenderSource(),d=u.getKey();for(let f=a.minX;f<=a.maxX;++f)for(let g=a.minY;g<=a.maxY;++g){const _=getCacheKey$1(u,d,s,f,g);let m=!1;if(c.containsKey(_)){const p=c.peek(_);p.getState()===TileState.LOADED&&(addTileToLookup(o,p,s),m=!0)}m||(h=!1)}return h}renderFrame(t,n){this.renderComplete=!0;const s=t.layerStatesArray[t.layerIndex],o=t.viewState,a=o.projection,h=o.resolution,c=o.center,u=t.pixelRatio,d=this.getLayer(),f=d.getSource(),g=f.getTileGridForProjection(a),_=g.getZForResolution(h,f.zDirection),m=g.getResolution(_),p=f.getKey();this.renderedSourceKey_?this.renderedSourceKey_!==p&&(this.prependStaleKey(this.renderedSourceKey_),this.renderedSourceKey_=p):this.renderedSourceKey_=p;let x=t.extent;const y=f.getTilePixelRatio(u);this.prepareContainer(t,n);const T=this.context.canvas.width,S=this.context.canvas.height,C=s.extent&&fromUserExtent(s.extent);C&&(x=getIntersection(x,fromUserExtent(s.extent)));const P=m*T/2/y,w=m*S/2/y,I=[c[0]-P,c[1]-w,c[0]+P,c[1]+w],O={};this.renderedTiles.length=0;const N=d.getPreload();if(t.nextExtent&&this.enqueueTilesForNextExtent()){const mt=g.getZForResolution(o.nextResolution,f.zDirection),Mt=getRenderExtent$1(t,t.nextExtent);this.enqueueTiles(t,Mt,mt,O,N)}const k=getRenderExtent$1(t,x);if(this.enqueueTiles(t,k,_,O,0),N>0&&setTimeout(()=>{this.enqueueTiles(t,k,_-1,O,N-1)},0),!(_ in O))return this.container;const D=getUid(this),ze=t.time;for(const mt of O[_]){const Mt=mt.getState();if(Mt===TileState.EMPTY)continue;const Bt=mt.tileCoord;if(Mt===TileState.LOADED&&mt.getAlpha(D,ze)===1){mt.endTransition(D);continue}if(Mt!==TileState.ERROR&&(this.renderComplete=!1),this.findStaleTile_(Bt,O)){removeTileFromLookup(O,mt,_),t.animate=!0;continue}if(this.findAltTiles_(g,Bt,_+1,O))continue;const Wt=g.getMinZoom();for(let $t=_-1;$t>=Wt&&!this.findAltTiles_(g,Bt,$t,O);--$t);}const z=m/h*u/y,Ee=this.getRenderContext(t);compose(this.tempTransform,T/2,S/2,z,z,0,-T/2,-S/2),s.extent&&this.clipUnrotated(Ee,t,C),f.getInterpolate()||(Ee.imageSmoothingEnabled=!1),this.preRender(Ee,t);const B=Object.keys(O).map(Number);B.sort(ascending);let rt;const wt=[],re=[];for(let mt=B.length-1;mt>=0;--mt){const Mt=B[mt],Bt=f.getTilePixelSize(Mt,u,a),Nt=g.getResolution(Mt)/m,Wt=Bt[0]*Nt*z,$t=Bt[1]*Nt*z,Zt=g.getTileCoordForCoordAndZ(getTopLeft(I),Mt),ki=g.getTileCoordExtent(Zt),Os=apply(this.tempTransform,[y*(ki[0]-I[0])/m,y*(I[3]-ki[3])/m]),Rc=y*f.getGutterForProjection(a);for(const Sc of O[Mt]){if(Sc.getState()!==TileState.LOADED)continue;const Lc=Sc.tileCoord,tu=Zt[1]-Lc[1],hu=Math.round(Os[0]-(tu-1)*Wt),qc=Zt[2]-Lc[2],jc=Math.round(Os[1]-(qc-1)*$t),Oc=Math.round(Os[0]-tu*Wt),Fc=Math.round(Os[1]-qc*$t),iu=hu-Oc,ru=jc-Fc,cu=B.length===1;let Zc=!1;rt=[Oc,Fc,Oc+iu,Fc,Oc+iu,Fc+ru,Oc,Fc+ru];for(let nu=0,su=wt.length;nu<su;++nu)if(!cu&&Mt<re[nu]){const po=wt[nu];intersects$1([Oc,Fc,Oc+iu,Fc+ru],[po[0],po[3],po[4],po[7]])&&(Zc||(Ee.save(),Zc=!0),Ee.beginPath(),Ee.moveTo(rt[0],rt[1]),Ee.lineTo(rt[2],rt[3]),Ee.lineTo(rt[4],rt[5]),Ee.lineTo(rt[6],rt[7]),Ee.moveTo(po[6],po[7]),Ee.lineTo(po[4],po[5]),Ee.lineTo(po[2],po[3]),Ee.lineTo(po[0],po[1]),Ee.clip())}wt.push(rt),re.push(Mt),this.drawTile(Sc,t,Oc,Fc,iu,ru,Rc,cu),Zc&&Ee.restore(),this.renderedTiles.unshift(Sc),this.updateUsedTiles(t.usedTiles,f,Sc)}}if(this.renderedResolution=m,this.extentChanged=!this.renderedExtent_||!equals$1(this.renderedExtent_,I),this.renderedExtent_=I,this.renderedPixelRatio=u,this.postRender(this.context,t),s.extent&&Ee.restore(),Ee.imageSmoothingEnabled=!0,this.renderComplete){const mt=(Mt,Bt)=>{var $t;const Ht=getUid(f),Nt=Bt.wantedTiles[Ht],Wt=Nt?Object.keys(Nt).length:0;this.updateCacheSize(Wt),this.tileCache_.expireCache(),($t=this.sourceTileCache_)==null||$t.expireCache()};t.postRenderFunctions.push(mt)}return this.container}updateCacheSize(t){this.tileCache_.highWaterMark=Math.max(this.tileCache_.highWaterMark,t*2)}drawTile(t,n,s,o,a,h,c,u){let d;if(t instanceof DataTile){if(d=asImageLike(t.getData()),!d)throw new Error("Rendering array data is not yet supported")}else d=this.getTileImage(t);if(!d)return;const f=this.getRenderContext(n),g=getUid(this),_=n.layerStatesArray[n.layerIndex],m=_.opacity*(u?t.getAlpha(g,n.time):1),p=m!==f.globalAlpha;p&&(f.save(),f.globalAlpha=m),f.drawImage(d,c,c,d.width-2*c,d.height-2*c,s,o,a,h),p&&f.restore(),m!==_.opacity?n.animate=!0:u&&t.endTransition(g)}getImage(){const t=this.context;return t?t.canvas:null}getTileImage(t){return t.getImage()}updateUsedTiles(t,n,s){const o=getUid(n);o in t||(t[o]={}),t[o][s.getKey()]=!0}}const TileProperty={PRELOAD:"preload",USE_INTERIM_TILES_ON_ERROR:"useInterimTilesOnError"};class BaseTileLayer extends Layer{constructor(t){t=t||{};const n=Object.assign({},t),s=t.cacheSize;delete t.cacheSize,delete n.preload,delete n.useInterimTilesOnError,super(n),this.on,this.once,this.un,this.cacheSize_=s,this.setPreload(t.preload!==void 0?t.preload:0),this.setUseInterimTilesOnError(t.useInterimTilesOnError!==void 0?t.useInterimTilesOnError:!0)}getCacheSize(){return this.cacheSize_}getPreload(){return this.get(TileProperty.PRELOAD)}setPreload(t){this.set(TileProperty.PRELOAD,t)}getUseInterimTilesOnError(){return this.get(TileProperty.USE_INTERIM_TILES_ON_ERROR)}setUseInterimTilesOnError(t){this.set(TileProperty.USE_INTERIM_TILES_ON_ERROR,t)}getData(t){return super.getData(t)}}class TileLayer extends BaseTileLayer{constructor(t){super(t)}createRenderer(){return new CanvasTileLayerRenderer(this,{cacheSize:this.getCacheSize()})}}const IMAGE_REPLAYS={image:["Polygon","Circle","LineString","Image","Text"],hybrid:["Polygon","LineString"],vector:[]},VECTOR_REPLAYS={hybrid:["Image","Text","Default"],vector:["Polygon","Circle","LineString","Image","Text","Default"]};class CanvasVectorTileLayerRenderer extends CanvasTileLayerRenderer{constructor(t,n){super(t,n),this.boundHandleStyleImageChange_=this.handleStyleImageChange_.bind(this),this.renderedLayerRevision_,this.renderedPixelToCoordinateTransform_=null,this.renderedRotation_,this.renderedOpacity_=1,this.tmpTransform_=create$2(),this.tileClipContexts_=null}enqueueTilesForNextExtent(){return this.getLayer().getRenderMode()!=="vector"}drawTile(t,n,s,o,a,h,c,u){this.updateExecutorGroup_(t,n.pixelRatio,n.viewState.projection),this.tileImageNeedsRender_(t)&&this.renderTileImage_(t,n),super.drawTile(t,n,s,o,a,h,c,u)}getTile(t,n,s,o){const a=this.getOrCreateTile(t,n,s,o);if(!a)return null;const h=o.viewState,c=h.resolution,u=o.viewHints,d=this.getLayer().getSource(),f=d.getTileGridForProjection(h.projection),g=!(u[ViewHint.ANIMATING]||u[ViewHint.INTERACTING]),_=f.getZForResolution(c,d.zDirection)===t;return g&&_?a.wantedResolution=c:a.wantedResolution||(a.wantedResolution=f.getResolution(t)),a}prepareFrame(t){const n=this.getLayer().getRevision();return this.renderedLayerRevision_!==n&&(this.renderedLayerRevision_=n,this.renderedTiles.length=0),super.prepareFrame(t)}updateExecutorGroup_(t,n,s){const o=this.getLayer(),a=o.getRevision(),h=o.getRenderOrder()||null,c=t.wantedResolution,u=t.getReplayState(o);if(!u.dirty&&u.renderedResolution===c&&u.renderedRevision==a&&u.renderedRenderOrder==h)return;const d=o.getSource(),f=!!o.getDeclutter(),g=d.getTileGrid(),m=d.getTileGridForProjection(s).getTileCoordExtent(t.wrappedTileCoord),p=d.getSourceTiles(n,s,t),x=getUid(o);delete t.hitDetectionImageData[x],t.executorGroups[x]=[],u.dirty=!1;for(let y=0,T=p.length;y<T;++y){const S=p[y];if(S.getState()!=TileState.LOADED)continue;const C=d.getProjection(),P=S.tileCoord;let w=g.getTileCoordExtent(P);s&&C&&!equivalent$1(s,C)&&(w=transformExtent$1(w,C,s,32));const I=getIntersection(m,w),O=buffer(I,o.getRenderBuffer()*c,this.tempExtent),N=equals$1(w,I)?null:O,k=new BuilderGroup(0,I,c,n),D=getSquaredTolerance(c,n),ze=function(wt,re){let mt;const Mt=wt.getStyleFunction()||o.getStyleFunction();if(Mt&&(mt=Mt(wt,c)),mt){const Bt=this.renderFeature(wt,D,mt,k,f,re);u.dirty=u.dirty||Bt}},z=S.getFeatures();h&&h!==u.renderedRenderOrder&&z.sort(h);for(let wt=0,re=z.length;wt<re;++wt){let mt=z[wt];s&&S.projection&&!equivalent$1(s,S.projection)&&(mt=mt.clone(),mt.getGeometry().applyTransform(getTransform(S.projection,s))),(!N||intersects$1(N,mt.getGeometry().getExtent()))&&ze.call(this,mt,wt)}const Ee=k.finish(),B=o.getRenderMode()!=="vector"&&f&&p.length===1?null:I,rt=new ExecutorGroup(B,c,n,d.getOverlaps(),Ee,o.getRenderBuffer(),!0);t.executorGroups[x].push(rt)}u.renderedRevision=a,u.renderedRenderOrder=h,u.renderedResolution=c}forEachFeatureAtCoordinate(t,n,s,o,a){var C,P;const h=n.viewState.resolution,c=n.viewState.rotation;s=s??0;const u=this.getLayer(),f=u.getSource().getTileGridForProjection(n.viewState.projection),g=boundingExtent([t]);buffer(g,h*s,g);const _={},m=function(w,I,O){let N=w.getId();N===void 0&&(N=getUid(w));const k=_[N];if(k){if(k!==!0&&O<k.distanceSq){if(O===0)return _[N]=!0,a.splice(a.lastIndexOf(k),1),o(w,u,I);k.geometry=I,k.distanceSq=O}}else{if(O===0)return _[N]=!0,o(w,u,I);a.push(_[N]={feature:w,layer:u,geometry:I,distanceSq:O,callback:o})}},p=this.renderedTiles,x=getUid(u),y=u.getDeclutter(),T=y?(P=(C=n.declutter)==null?void 0:C[y])==null?void 0:P.all().map(w=>w.value):null;let S;e:for(let w=0,I=p.length;w<I;++w){const O=p[w],N=f.getTileCoordExtent(O.wrappedTileCoord);if(!intersects$1(N,g))continue;const k=O.executorGroups[x];for(let D=0,ze=k.length;D<ze;++D)if(S=k[D].forEachFeatureAtCoordinate(t,h,c,s,m,T),S)break e}return S}getFeatures(t){return this.renderedTiles.length===0?Promise.resolve([]):new Promise((n,s)=>{const o=this.getLayer(),a=o.getSource(),h=this.renderedProjection,c=h.getExtent(),u=this.renderedResolution,d=a.getTileGridForProjection(h),f=apply(this.renderedPixelToCoordinateTransform_,t.slice()),g=d.getTileCoordForCoordAndResolution(f,u).toString(),_=this.renderedTiles.find(C=>C.tileCoord.toString()===g&&C.getState()===TileState.LOADED);if(!_||_.loadingSourceTiles>0){n([]);return}a.getWrapX()&&h.canWrapX()&&!containsExtent(c,d.getTileCoordExtent(_.tileCoord))&&wrapX$1(f,h);const m=getUid(o),p=d.getTileCoordExtent(_.wrappedTileCoord),x=getTopLeft(p),y=[(f[0]-x[0])/u,(x[1]-f[1])/u],T=_.getSourceTiles().reduce((C,P)=>C.concat(P.getFeatures()),[]);let S=_.hitDetectionImageData[m];if(!S){const C=toSize(d.getTileSize(d.getZForResolution(u,a.zDirection))),P=this.renderedRotation_,w=[this.getRenderTransform(d.getTileCoordCenter(_.wrappedTileCoord),u,0,HIT_DETECT_RESOLUTION,C[0]*HIT_DETECT_RESOLUTION,C[1]*HIT_DETECT_RESOLUTION,0)];S=createHitDetectionImageData(C,w,T,o.getStyleFunction(),d.getTileCoordExtent(_.wrappedTileCoord),_.getReplayState(o).renderedResolution,P),_.hitDetectionImageData[m]=S}n(hitDetect(y,T,S))})}getFeaturesInExtent(t){const n=[],s=this.getTileCache();if(s.getCount()===0)return n;const a=this.getLayer().getSource().getTileGridForProjection(this.frameState.viewState.projection),h=a.getZForResolution(this.renderedResolution),c={};return s.forEach(u=>{if(u.tileCoord[0]!==h||u.getState()!==TileState.LOADED)return;const d=u.getSourceTiles();for(let f=0,g=d.length;f<g;++f){const _=d[f],m=_.getKey();if(m in c)continue;c[m]=!0;const p=_.tileCoord;if(intersects$1(t,a.getTileCoordExtent(p))){const x=_.getFeatures();if(x)for(let y=0,T=x.length;y<T;++y){const S=x[y],C=S.getGeometry();intersects$1(t,C.getExtent())&&n.push(S)}}}}),n}handleFontsChanged(){const t=this.getLayer();t.getVisible()&&this.renderedLayerRevision_!==void 0&&t.changed()}handleStyleImageChange_(t){this.renderIfReadyAndVisible()}renderDeclutter(t,n){var _;const s=this.context,o=s.globalAlpha;s.globalAlpha=n.opacity;const a=t.viewHints,h=!(a[ViewHint.ANIMATING]||a[ViewHint.INTERACTING]),c=[this.context.canvas.width,this.context.canvas.height],u=this.getLayer().getDeclutter(),d=u?(_=t.declutter)==null?void 0:_[u]:void 0,f=getUid(this.getLayer()),g=this.renderedTiles;for(let m=0,p=g.length;m<p;++m){const x=g[m],y=x.executorGroups[f];if(y)for(let T=y.length-1;T>=0;--T)y[T].execute(this.context,c,this.getTileRenderTransform(x,t),t.viewState.rotation,h,DECLUTTER,d)}s.globalAlpha=o}renderDeferredInternal(t){const n=this.renderedTiles,s=getUid(this.getLayer()),o=n.reduce((u,d,f)=>(d.executorGroups[s].forEach(g=>u.push({executorGroup:g,index:f})),u),[]),a=o.map(({executorGroup:u})=>u.getDeferredZIndexContexts()),h={};for(let u=0,d=o.length;u<d;++u){const f=o[u].executorGroup.getDeferredZIndexContexts();for(const g in f)h[g]=!0}Object.keys(h).map(Number).sort(ascending).forEach(u=>{a.forEach((d,f)=>{d[u]&&(d[u].forEach(g=>{const{executorGroup:_,index:m}=o[f],p=_.getRenderedContext(),x=p.globalAlpha;p.globalAlpha=this.renderedOpacity_;const y=this.tileClipContexts_[m];y&&y.draw(p),g.draw(p),y&&p.restore(),p.globalAlpha=x,g.clear()}),d[u].length=0)})})}getTileRenderTransform(t,n){const s=n.pixelRatio,o=n.viewState,a=o.center,h=o.resolution,c=o.rotation,u=n.size,d=Math.round(u[0]*s),f=Math.round(u[1]*s),_=this.getLayer().getSource().getTileGridForProjection(n.viewState.projection),m=t.tileCoord,p=_.getTileCoordExtent(t.wrappedTileCoord),x=_.getTileCoordExtent(m,this.tempExtent)[0]-p[0];return multiply(scale$3(this.inversePixelTransform.slice(),1/s,1/s),this.getRenderTransform(a,h,c,s,d,f,x))}postRender(t,n){var w;const s=n.viewHints,o=!(s[ViewHint.ANIMATING]||s[ViewHint.INTERACTING]);this.renderedPixelToCoordinateTransform_=n.pixelToCoordinateTransform.slice(),this.renderedRotation_=n.viewState.rotation,this.renderedOpacity_=n.layerStatesArray[n.layerIndex].opacity;const a=this.getLayer(),h=a.getRenderMode(),c=t.globalAlpha;t.globalAlpha=this.renderedOpacity_;const u=a.getDeclutter(),d=u?VECTOR_REPLAYS[h].filter(I=>!DECLUTTER.includes(I)):VECTOR_REPLAYS[h],f=n.viewState,g=f.rotation,_=a.getSource(),p=_.getTileGridForProjection(f.projection).getZForResolution(f.resolution,_.zDirection),x=this.renderedTiles,y=[],T=[],S=[],C=getUid(a);let P=!0;for(let I=x.length-1;I>=0;--I){const O=x[I];P=P&&!O.getReplayState(a).dirty;const N=O.executorGroups[C].filter(rt=>rt.hasExecutors(d));if(N.length===0)continue;const k=this.getTileRenderTransform(O,n),D=O.tileCoord[0];let ze=!1;const z=N[0].getClipCoords(k);let Ee=t,B;if(z){B=new ZIndexContext,Ee=B.getContext();for(let rt=0,wt=y.length;rt<wt;++rt)if(p!==D&&D<T[rt]){const re=y[rt];intersects$1([z[0],z[3],z[4],z[7]],[re[0],re[3],re[4],re[7]])&&(ze||(Ee.save(),ze=!0),Ee.beginPath(),Ee.moveTo(z[0],z[1]),Ee.lineTo(z[2],z[3]),Ee.lineTo(z[4],z[5]),Ee.lineTo(z[6],z[7]),Ee.moveTo(re[6],re[7]),Ee.lineTo(re[4],re[5]),Ee.lineTo(re[2],re[3]),Ee.lineTo(re[0],re[1]),Ee.clip())}y.push(z),T.push(D)}for(let rt=0,wt=N.length;rt<wt;++rt)N[rt].execute(t,[t.canvas.width,t.canvas.height],k,g,o,d,(w=n.declutter)==null?void 0:w[u]);ze&&(Ee===t?Ee.restore():S[I]=B)}t.globalAlpha=c,this.ready=P,this.tileClipContexts_=S,n.declutter||this.renderDeferredInternal(n),super.postRender(t,n)}renderFeature(t,n,s,o,a,h){if(!s)return!1;let c=!1;if(Array.isArray(s))for(let u=0,d=s.length;u<d;++u)c=renderFeature(o,t,s[u],n,this.boundHandleStyleImageChange_,void 0,a,h)||c;else c=renderFeature(o,t,s,n,this.boundHandleStyleImageChange_,void 0,a,h);return c}tileImageNeedsRender_(t){const n=this.getLayer();if(n.getRenderMode()==="vector")return!1;const s=t.getReplayState(n),o=n.getRevision(),a=t.wantedResolution;return s.renderedTileResolution!==a||s.renderedTileRevision!==o}renderTileImage_(t,n){const s=this.getLayer(),o=t.getReplayState(s),a=s.getRevision(),h=t.executorGroups[getUid(s)];o.renderedTileRevision=a;const c=t.wrappedTileCoord,u=c[0],d=s.getSource();let f=n.pixelRatio;const _=n.viewState.projection,m=d.getTileGridForProjection(_),p=m.getResolution(t.tileCoord[0]),x=n.pixelRatio/t.wantedResolution*p,y=m.getResolution(u),T=t.getContext();f=Math.round(Math.max(f,x/f));const S=d.getTilePixelSize(u,f,_);T.canvas.width=S[0],T.canvas.height=S[1];const C=f/x;if(C!==1){const O=reset(this.tmpTransform_);scale$3(O,C,C),T.setTransform.apply(T,O)}const P=m.getTileCoordExtent(c,this.tempExtent),w=x/y,I=reset(this.tmpTransform_);scale$3(I,w,-w),translate$2(I,-P[0],-P[3]);for(let O=0,N=h.length;O<N;++O)h[O].execute(T,[T.canvas.width*C,T.canvas.height*C],I,0,!0,IMAGE_REPLAYS[s.getRenderMode()],null);o.renderedTileResolution=t.wantedResolution}}class VectorTileLayer extends BaseVectorLayer{constructor(t){t=t||{};const n=Object.assign({},t);delete n.preload;const s=t.cacheSize===void 0?0:t.cacheSize;delete t.cacheSize,delete n.useInterimTilesOnError,super(n),this.on,this.once,this.un,this.cacheSize_=s;const o=t.renderMode||"hybrid";assert(o=="hybrid"||o=="vector","`renderMode` must be `'hybrid'` or `'vector'`"),this.renderMode_=o,this.setPreload(t.preload?t.preload:0),this.setUseInterimTilesOnError(t.useInterimTilesOnError!==void 0?t.useInterimTilesOnError:!0),this.getBackground,this.setBackground}createRenderer(){return new CanvasVectorTileLayerRenderer(this,{cacheSize:this.cacheSize_})}getFeatures(t){return super.getFeatures(t)}getFeaturesInExtent(t){return this.getRenderer().getFeaturesInExtent(t)}getRenderMode(){return this.renderMode_}getPreload(){return this.get(TileProperty.PRELOAD)}getUseInterimTilesOnError(){return this.get(TileProperty.USE_INTERIM_TILES_ON_ERROR)}setPreload(t){this.set(TileProperty.PRELOAD,t)}setUseInterimTilesOnError(t){this.set(TileProperty.USE_INTERIM_TILES_ON_ERROR,t)}}function fromResolutionLike(l){return Array.isArray(l)?Math.min(...l):l}class ReprojImage extends ImageWrapper{constructor(t,n,s,o,a,h,c){let u=t.getExtent();u&&t.canWrapX()&&(u=u.slice(),u[0]=-1/0,u[2]=1/0);let d=n.getExtent();d&&n.canWrapX()&&(d=d.slice(),d[0]=-1/0,d[2]=1/0);const f=d?getIntersection(s,d):s,g=getCenter(f),_=calculateSourceResolution(t,n,g,o),m=ERROR_THRESHOLD,p=new Triangulation(t,n,f,u,_*m,o),x=p.calculateSourceExtent(),y=isEmpty(x)?null:h(x,_,a),T=y?ImageState.IDLE:ImageState.EMPTY,S=y?y.getPixelRatio():1;super(s,o,S,T),this.targetProj_=n,this.maxSourceExtent_=u,this.triangulation_=p,this.targetResolution_=o,this.targetExtent_=s,this.sourceImage_=y,this.sourcePixelRatio_=S,this.interpolate_=c,this.canvas_=null,this.sourceListenerKey_=null}disposeInternal(){this.state==ImageState.LOADING&&this.unlistenSource_(),super.disposeInternal()}getImage(){return this.canvas_}getProjection(){return this.targetProj_}reproject_(){const t=this.sourceImage_.getState();if(t==ImageState.LOADED){const n=getWidth(this.targetExtent_)/this.targetResolution_,s=getHeight(this.targetExtent_)/this.targetResolution_;this.canvas_=render$1(n,s,this.sourcePixelRatio_,fromResolutionLike(this.sourceImage_.getResolution()),this.maxSourceExtent_,this.targetResolution_,this.targetExtent_,this.triangulation_,[{extent:this.sourceImage_.getExtent(),image:this.sourceImage_.getImage()}],0,void 0,this.interpolate_,!0)}this.state=t,this.changed()}load(){if(this.state==ImageState.IDLE){this.state=ImageState.LOADING,this.changed();const t=this.sourceImage_.getState();t==ImageState.LOADED||t==ImageState.ERROR?this.reproject_():(this.sourceListenerKey_=listen(this.sourceImage_,EventType$1.CHANGE,n=>{const s=this.sourceImage_.getState();(s==ImageState.LOADED||s==ImageState.ERROR)&&(this.unlistenSource_(),this.reproject_())}),this.sourceImage_.load())}}unlistenSource_(){unlistenByKey(this.sourceListenerKey_),this.sourceListenerKey_=null}}const DECIMALS$1=4,ImageSourceEventType={IMAGELOADSTART:"imageloadstart",IMAGELOADEND:"imageloadend",IMAGELOADERROR:"imageloaderror"};class ImageSourceEvent extends BaseEvent{constructor(t,n){super(t),this.image=n}}class ImageSource extends Source{constructor(t){super({attributions:t.attributions,projection:t.projection,state:t.state,interpolate:t.interpolate!==void 0?t.interpolate:!0}),this.on,this.once,this.un,this.loader=t.loader||null,this.resolutions_=t.resolutions!==void 0?t.resolutions:null,this.reprojectedImage_=null,this.reprojectedRevision_=0,this.image=null,this.wantedExtent_,this.wantedResolution_,this.static_=t.loader?t.loader.length===0:!1,this.wantedProjection_=null}getResolutions(){return this.resolutions_}setResolutions(t){this.resolutions_=t}findNearestResolution(t){const n=this.getResolutions();if(n){const s=linearFindNearest(n,t,0);t=n[s]}return t}getImage(t,n,s,o){const a=this.getProjection();if(!a||!o||equivalent$1(a,o))return a&&(o=a),this.getImageInternal(t,n,s,o);if(this.reprojectedImage_){if(this.reprojectedRevision_==this.getRevision()&&equivalent$1(this.reprojectedImage_.getProjection(),o)&&this.reprojectedImage_.getResolution()==n&&equals$1(this.reprojectedImage_.getExtent(),t))return this.reprojectedImage_;this.reprojectedImage_.dispose(),this.reprojectedImage_=null}return this.reprojectedImage_=new ReprojImage(a,o,t,n,s,(h,c,u)=>this.getImageInternal(h,c,u,a),this.getInterpolate()),this.reprojectedRevision_=this.getRevision(),this.reprojectedImage_}getImageInternal(t,n,s,o){if(this.loader){const a=getRequestExtent(t,n,s,1),h=this.findNearestResolution(n);if(this.image&&(this.static_||this.wantedProjection_===o&&(this.wantedExtent_&&containsExtent(this.wantedExtent_,a)||containsExtent(this.image.getExtent(),a))&&(this.wantedResolution_&&fromResolutionLike(this.wantedResolution_)===h||fromResolutionLike(this.image.getResolution())===h)))return this.image;this.wantedProjection_=o,this.wantedExtent_=a,this.wantedResolution_=h,this.image=new ImageWrapper(a,h,s,this.loader),this.image.addEventListener(EventType$1.CHANGE,this.handleImageChange.bind(this))}return this.image}handleImageChange(t){const n=t.target;let s;switch(n.getState()){case ImageState.LOADING:this.loading=!0,s=ImageSourceEventType.IMAGELOADSTART;break;case ImageState.LOADED:this.loading=!1,s=ImageSourceEventType.IMAGELOADEND;break;case ImageState.ERROR:this.loading=!1,s=ImageSourceEventType.IMAGELOADERROR;break;default:return}this.hasListener(s)&&this.dispatchEvent(new ImageSourceEvent(s,n))}}function defaultImageLoadFunction(l,t){l.getImage().src=t}function getRequestExtent(l,t,n,s){const o=t/n,a=getCenter(l),h=ceil(getWidth(l)/o,DECIMALS$1),c=ceil(getHeight(l)/o,DECIMALS$1),u=ceil((s-1)*h/2,DECIMALS$1),d=h+2*u,f=ceil((s-1)*c/2,DECIMALS$1),g=c+2*f;return getForViewAndSize(a,o,0,[d,g])}function appendParams(l,t){const n=[];Object.keys(t).forEach(function(o){t[o]!==null&&t[o]!==void 0&&n.push(o+"="+encodeURIComponent(t[o]))});const s=n.join("&");return l=l.replace(/[?&]$/,""),l+=l.includes("?")?"&":"?",l+s}const zRegEx=/\{z\}/g,xRegEx=/\{x\}/g,yRegEx=/\{y\}/g,dashYRegEx=/\{-y\}/g;function renderXYZTemplate(l,t,n,s,o){return l.replace(zRegEx,t.toString()).replace(xRegEx,n.toString()).replace(yRegEx,s.toString()).replace(dashYRegEx,function(){if(o===void 0)throw new Error("If the URL template has a {-y} placeholder, the grid extent must be known");return(o-s).toString()})}function pickUrl(l,t,n,s){const o=hashZXY(t,n,s),a=modulo(o,l.length);return l[a]}function expandUrl(l){const t=[];let n=/\{([a-z])-([a-z])\}/.exec(l);if(n){const s=n[1].charCodeAt(0),o=n[2].charCodeAt(0);let a;for(a=s;a<=o;++a)t.push(l.replace(n[0],String.fromCharCode(a)));return t}if(n=/\{(\d+)-(\d+)\}/.exec(l),n){const s=parseInt(n[2],10);for(let o=parseInt(n[1],10);o<=s;o++)t.push(l.replace(n[0],o.toString()));return t}return t.push(l),t}const DEFAULT_VERSION$1="1.3.0",GETFEATUREINFO_IMAGE_SIZE=[101,101];function getRequestUrl$1(l,t,n,s,o){o.WIDTH=n[0],o.HEIGHT=n[1];const a=s.getAxisOrientation(),h=compareVersions(o.VERSION,"1.3")>=0;o[h?"CRS":"SRS"]=s.getCode();const c=h&&a.startsWith("ne")?[t[1],t[0],t[3],t[2]]:t;return o.BBOX=c.join(","),appendParams(l,o)}function getImageSrc(l,t,n,s,o,a,h){a=Object.assign({REQUEST:"GetMap"},a);const c=t/n,u=[round(getWidth(l)/c,DECIMALS$1),round(getHeight(l)/c,DECIMALS$1)];if(n!=1)switch(h){case"geoserver":const f=90*n+.5|0;"FORMAT_OPTIONS"in a?a.FORMAT_OPTIONS+=";dpi:"+f:a.FORMAT_OPTIONS="dpi:"+f;break;case"mapserver":a.MAP_RESOLUTION=90*n;break;case"carmentaserver":case"qgis":a.DPI=90*n;break;default:throw new Error("Unknown `serverType` configured")}return getRequestUrl$1(o,l,u,s,a)}function getRequestParams(l,t){return Object.assign({REQUEST:t,SERVICE:"WMS",VERSION:DEFAULT_VERSION$1,FORMAT:"image/png",STYLES:"",TRANSPARENT:"TRUE"},l)}function createLoader$3(l){const t=l.hidpi===void 0?!0:l.hidpi,n=get$1(l.projection||"EPSG:3857"),s=l.ratio||1.5,o=l.load||decode,a=l.crossOrigin??null;return(h,c,u)=>{h=getRequestExtent(h,c,u,s),u!=1&&(!t||l.serverType===void 0)&&(u=1);const d=getImageSrc(h,c,u,n,l.url,getRequestParams(l.params,"GetMap"),l.serverType),f=new Image;return f.crossOrigin=a,o(f,d).then(g=>({image:g,extent:h,pixelRatio:u}))}}function getFeatureInfoUrl(l,t,n){if(l.url===void 0)return;const s=get$1(l.projection||"EPSG:3857"),o=getForViewAndSize(t,n,0,GETFEATUREINFO_IMAGE_SIZE),a={QUERY_LAYERS:l.params.LAYERS,INFO_FORMAT:"application/json"};Object.assign(a,getRequestParams(l.params,"GetFeatureInfo"),l.params);const h=floor((t[0]-o[0])/n,DECIMALS$1),c=floor((o[3]-t[1])/n,DECIMALS$1),u=compareVersions(a.VERSION,"1.3")>=0;return a[u?"I":"X"]=h,a[u?"J":"Y"]=c,getRequestUrl$1(l.url,o,GETFEATUREINFO_IMAGE_SIZE,s,a)}function getLegendUrl(l,t){if(l.url===void 0)return;const n={SERVICE:"WMS",VERSION:DEFAULT_VERSION$1,REQUEST:"GetLegendGraphic",FORMAT:"image/png"};if(t!==void 0){const s=get$1(l.projection||"EPSG:3857").getMetersPerUnit()||1,o=28e-5;n.SCALE=t*s/o}if(Object.assign(n,l.params),l.params!==void 0&&n.LAYER===void 0){const s=n.LAYERS;if(!(!Array.isArray(s)||s.length!==1))return;n.LAYER=s}return appendParams(l.url,n)}class ImageWMS extends ImageSource{constructor(t){t=t||{},super({attributions:t.attributions,interpolate:t.interpolate,projection:t.projection,resolutions:t.resolutions}),this.crossOrigin_=t.crossOrigin!==void 0?t.crossOrigin:null,this.url_=t.url,this.imageLoadFunction_=t.imageLoadFunction!==void 0?t.imageLoadFunction:defaultImageLoadFunction,this.params_=Object.assign({},t.params),this.serverType_=t.serverType,this.hidpi_=t.hidpi!==void 0?t.hidpi:!0,this.renderedRevision_=0,this.ratio_=t.ratio!==void 0?t.ratio:1.5,this.loaderProjection_=null}getFeatureInfoUrl(t,n,s,o){const a=get$1(s),h=this.getProjection();h&&h!==a&&(n=calculateSourceResolution(h,a,t,n),t=transform$1(t,a,h));const c={url:this.url_,params:{...this.params_,...o},projection:h||a};return getFeatureInfoUrl(c,t,n)}getLegendUrl(t,n){return getLegendUrl({url:this.url_,params:{...this.params_,...n}},t)}getParams(){return this.params_}getImageInternal(t,n,s,o){return this.url_===void 0?null:((!this.loader||this.loaderProjection_!==o)&&(this.loaderProjection_=o,this.loader=createLoader$3({crossOrigin:this.crossOrigin_,params:this.params_,projection:o,serverType:this.serverType_,hidpi:this.hidpi_,url:this.url_,ratio:this.ratio_,load:(a,h)=>(this.image.setImage(a),this.imageLoadFunction_(this.image,h),decode(a))})),super.getImageInternal(t,n,s,o))}getImageLoadFunction(){return this.imageLoadFunction_}getUrl(){return this.url_}setImageLoadFunction(t){this.imageLoadFunction_=t,this.changed()}setUrl(t){t!=this.url_&&(this.url_=t,this.loader=null,this.changed())}setParams(t){this.params_=Object.assign({},t),this.changed()}updateParams(t){Object.assign(this.params_,t),this.changed()}changed(){this.image=null,super.changed()}}const tmpTileCoord=[0,0,0],DECIMALS=5;class TileGrid{constructor(t){this.minZoom=t.minZoom!==void 0?t.minZoom:0,this.resolutions_=t.resolutions,assert(isSorted(this.resolutions_,(o,a)=>a-o),"`resolutions` must be sorted in descending order");let n;if(!t.origins){for(let o=0,a=this.resolutions_.length-1;o<a;++o)if(!n)n=this.resolutions_[o]/this.resolutions_[o+1];else if(this.resolutions_[o]/this.resolutions_[o+1]!==n){n=void 0;break}}this.zoomFactor_=n,this.maxZoom=this.resolutions_.length-1,this.origin_=t.origin!==void 0?t.origin:null,this.origins_=null,t.origins!==void 0&&(this.origins_=t.origins,assert(this.origins_.length==this.resolutions_.length,"Number of `origins` and `resolutions` must be equal"));const s=t.extent;s!==void 0&&!this.origin_&&!this.origins_&&(this.origin_=getTopLeft(s)),assert(!this.origin_&&this.origins_||this.origin_&&!this.origins_,"Either `origin` or `origins` must be configured, never both"),this.tileSizes_=null,t.tileSizes!==void 0&&(this.tileSizes_=t.tileSizes,assert(this.tileSizes_.length==this.resolutions_.length,"Number of `tileSizes` and `resolutions` must be equal")),this.tileSize_=t.tileSize!==void 0?t.tileSize:this.tileSizes_?null:DEFAULT_TILE_SIZE,assert(!this.tileSize_&&this.tileSizes_||this.tileSize_&&!this.tileSizes_,"Either `tileSize` or `tileSizes` must be configured, never both"),this.extent_=s!==void 0?s:null,this.fullTileRanges_=null,this.tmpSize_=[0,0],this.tmpExtent_=[0,0,0,0],t.sizes!==void 0?this.fullTileRanges_=t.sizes.map((o,a)=>{const h=new TileRange(Math.min(0,o[0]),Math.max(o[0]-1,-1),Math.min(0,o[1]),Math.max(o[1]-1,-1));if(s){const c=this.getTileRangeForExtentAndZ(s,a);h.minX=Math.max(c.minX,h.minX),h.maxX=Math.min(c.maxX,h.maxX),h.minY=Math.max(c.minY,h.minY),h.maxY=Math.min(c.maxY,h.maxY)}return h}):s&&this.calculateTileRanges_(s)}forEachTileCoord(t,n,s){const o=this.getTileRangeForExtentAndZ(t,n);for(let a=o.minX,h=o.maxX;a<=h;++a)for(let c=o.minY,u=o.maxY;c<=u;++c)s([n,a,c])}forEachTileCoordParentTileRange(t,n,s,o){let a,h,c,u=null,d=t[0]-1;for(this.zoomFactor_===2?(h=t[1],c=t[2]):u=this.getTileCoordExtent(t,o);d>=this.minZoom;){if(h!==void 0&&c!==void 0?(h=Math.floor(h/2),c=Math.floor(c/2),a=createOrUpdate$1(h,h,c,c,s)):a=this.getTileRangeForExtentAndZ(u,d,s),n(d,a))return!0;--d}return!1}getExtent(){return this.extent_}getMaxZoom(){return this.maxZoom}getMinZoom(){return this.minZoom}getOrigin(t){return this.origin_?this.origin_:this.origins_[t]}getResolution(t){return this.resolutions_[t]}getResolutions(){return this.resolutions_}getTileCoordChildTileRange(t,n,s){if(t[0]<this.maxZoom){if(this.zoomFactor_===2){const a=t[1]*2,h=t[2]*2;return createOrUpdate$1(a,a+1,h,h+1,n)}const o=this.getTileCoordExtent(t,s||this.tmpExtent_);return this.getTileRangeForExtentAndZ(o,t[0]+1,n)}return null}getTileRangeForTileCoordAndZ(t,n,s){if(n>this.maxZoom||n<this.minZoom)return null;const o=t[0],a=t[1],h=t[2];if(n===o)return createOrUpdate$1(a,h,a,h,s);if(this.zoomFactor_){const u=Math.pow(this.zoomFactor_,n-o),d=Math.floor(a*u),f=Math.floor(h*u);if(n<o)return createOrUpdate$1(d,d,f,f,s);const g=Math.floor(u*(a+1))-1,_=Math.floor(u*(h+1))-1;return createOrUpdate$1(d,g,f,_,s)}const c=this.getTileCoordExtent(t,this.tmpExtent_);return this.getTileRangeForExtentAndZ(c,n,s)}getTileRangeForExtentAndZ(t,n,s){this.getTileCoordForXYAndZ_(t[0],t[3],n,!1,tmpTileCoord);const o=tmpTileCoord[1],a=tmpTileCoord[2];this.getTileCoordForXYAndZ_(t[2],t[1],n,!0,tmpTileCoord);const h=tmpTileCoord[1],c=tmpTileCoord[2];return createOrUpdate$1(o,h,a,c,s)}getTileCoordCenter(t){const n=this.getOrigin(t[0]),s=this.getResolution(t[0]),o=toSize(this.getTileSize(t[0]),this.tmpSize_);return[n[0]+(t[1]+.5)*o[0]*s,n[1]-(t[2]+.5)*o[1]*s]}getTileCoordExtent(t,n){const s=this.getOrigin(t[0]),o=this.getResolution(t[0]),a=toSize(this.getTileSize(t[0]),this.tmpSize_),h=s[0]+t[1]*a[0]*o,c=s[1]-(t[2]+1)*a[1]*o,u=h+a[0]*o,d=c+a[1]*o;return createOrUpdate$2(h,c,u,d,n)}getTileCoordForCoordAndResolution(t,n,s){return this.getTileCoordForXYAndResolution_(t[0],t[1],n,!1,s)}getTileCoordForXYAndResolution_(t,n,s,o,a){const h=this.getZForResolution(s),c=s/this.getResolution(h),u=this.getOrigin(h),d=toSize(this.getTileSize(h),this.tmpSize_);let f=c*(t-u[0])/s/d[0],g=c*(u[1]-n)/s/d[1];return o?(f=ceil(f,DECIMALS)-1,g=ceil(g,DECIMALS)-1):(f=floor(f,DECIMALS),g=floor(g,DECIMALS)),createOrUpdate(h,f,g,a)}getTileCoordForXYAndZ_(t,n,s,o,a){const h=this.getOrigin(s),c=this.getResolution(s),u=toSize(this.getTileSize(s),this.tmpSize_);let d=(t-h[0])/c/u[0],f=(h[1]-n)/c/u[1];return o?(d=ceil(d,DECIMALS)-1,f=ceil(f,DECIMALS)-1):(d=floor(d,DECIMALS),f=floor(f,DECIMALS)),createOrUpdate(s,d,f,a)}getTileCoordForCoordAndZ(t,n,s){return this.getTileCoordForXYAndZ_(t[0],t[1],n,!1,s)}getTileCoordResolution(t){return this.resolutions_[t[0]]}getTileSize(t){return this.tileSize_?this.tileSize_:this.tileSizes_[t]}getFullTileRange(t){return this.fullTileRanges_?this.fullTileRanges_[t]:this.extent_?this.getTileRangeForExtentAndZ(this.extent_,t):null}getZForResolution(t,n){const s=linearFindNearest(this.resolutions_,t,n||0);return clamp(s,this.minZoom,this.maxZoom)}tileCoordIntersectsViewport(t,n){return intersectsLinearRing(n,0,n.length,2,this.getTileCoordExtent(t))}calculateTileRanges_(t){const n=this.resolutions_.length,s=new Array(n);for(let o=this.minZoom;o<n;++o)s[o]=this.getTileRangeForExtentAndZ(t,o);this.fullTileRanges_=s}}class WMTSTileGrid extends TileGrid{constructor(t){super({extent:t.extent,origin:t.origin,origins:t.origins,resolutions:t.resolutions,tileSize:t.tileSize,tileSizes:t.tileSizes,sizes:t.sizes}),this.matrixIds_=t.matrixIds}getMatrixId(t){return this.matrixIds_[t]}getMatrixIds(){return this.matrixIds_}}function createFromCapabilitiesMatrixSet(l,t,n){const s=[],o=[],a=[],h=[],c=[];n=n!==void 0?n:[];const u="SupportedCRS",d="TileMatrix",f="Identifier",g="ScaleDenominator",_="TopLeftCorner",m="TileWidth",p="TileHeight",x=l[u],y=get$1(x),T=y.getMetersPerUnit(),S=y.getAxisOrientation().startsWith("ne");return l[d].sort(function(C,P){return P[g]-C[g]}),l[d].forEach(function(C){let P;if(n.length>0?P=n.find(function(w){return C[f]==w[d]?!0:C[f].includes(":")?!1:l[f]+":"+C[f]===w[d]}):P=!0,P){o.push(C[f]);const w=C[g]*28e-5/T,I=C[m],O=C[p];S?a.push([C[_][1],C[_][0]]):a.push(C[_]),s.push(w),h.push(I==O?I:[I,O]),c.push([C.MatrixWidth,C.MatrixHeight])}}),new WMTSTileGrid({extent:t,origins:a,resolutions:s,matrixIds:o,tileSizes:h,sizes:c})}function getForProjection(l){let t=l.getDefaultTileGrid();return t||(t=createForProjection(l),l.setDefaultTileGrid(t)),t}function wrapX(l,t,n){const s=t[0],o=l.getTileCoordCenter(t),a=extentFromProjection(n);if(!containsCoordinate(a,o)){const h=getWidth(a),c=Math.ceil((a[0]-o[0])/h);return o[0]+=h*c,l.getTileCoordForCoordAndZ(o,s)}return t}function createForExtent(l,t,n,s){s=s!==void 0?s:"top-left";const o=resolutionsFromExtent(l,t,n);return new TileGrid({extent:l,origin:getCorner(l,s),resolutions:o,tileSize:n})}function createXYZ(l){const t=l||{},n=t.extent||get$1("EPSG:3857").getExtent(),s={extent:n,minZoom:t.minZoom,tileSize:t.tileSize,resolutions:resolutionsFromExtent(n,t.maxZoom,t.tileSize,t.maxResolution)};return new TileGrid(s)}function resolutionsFromExtent(l,t,n,s){t=t!==void 0?t:DEFAULT_MAX_ZOOM,n=toSize(n!==void 0?n:DEFAULT_TILE_SIZE);const o=getHeight(l),a=getWidth(l);s=s>0?s:Math.max(a/n[0],o/n[1]);const h=t+1,c=new Array(h);for(let u=0;u<h;++u)c[u]=s/Math.pow(2,u);return c}function createForProjection(l,t,n,s){const o=extentFromProjection(l);return createForExtent(o,t,n,s)}function extentFromProjection(l){l=get$1(l);let t=l.getExtent();if(!t){const n=180*METERS_PER_UNIT$1.degrees/l.getMetersPerUnit();t=createOrUpdate$2(-n,-n,n,n)}return t}function createFromTemplate(l,t){return function(n,s,o){if(!n)return;let a;const h=n[0];if(t){const c=t.getFullTileRange(h);c&&(a=c.getHeight()-1)}return renderXYZTemplate(l,h,n[1],n[2],a)}}function createFromTemplates(l,t){const n=l.length,s=new Array(n);for(let o=0;o<n;++o)s[o]=createFromTemplate(l[o],t);return createFromTileUrlFunctions(s)}function createFromTileUrlFunctions(l){return l.length===1?l[0]:function(t,n,s){if(!t)return;const o=hash(t),a=modulo(o,l.length);return l[a](t,n,s)}}function nullTileUrlFunction(l,t,n){}class TileSource extends Source{constructor(t){super({attributions:t.attributions,attributionsCollapsible:t.attributionsCollapsible,projection:t.projection,state:t.state,wrapX:t.wrapX,interpolate:t.interpolate}),this.on,this.once,this.un,this.tilePixelRatio_=t.tilePixelRatio!==void 0?t.tilePixelRatio:1,this.tileGrid=t.tileGrid!==void 0?t.tileGrid:null;const n=[256,256];this.tileGrid&&toSize(this.tileGrid.getTileSize(this.tileGrid.getMinZoom()),n),this.tmpSize=[0,0],this.key_=t.key||getUid(this),this.tileOptions={transition:t.transition,interpolate:t.interpolate},this.zDirection=t.zDirection?t.zDirection:0}getGutterForProjection(t){return 0}getKey(){return this.key_}setKey(t){this.key_!==t&&(this.key_=t,this.changed())}getResolutions(t){const n=t?this.getTileGridForProjection(t):this.tileGrid;return n?n.getResolutions():null}getTile(t,n,s,o,a,h){return abstract()}getTileGrid(){return this.tileGrid}getTileGridForProjection(t){return this.tileGrid?this.tileGrid:getForProjection(t)}getTilePixelRatio(t){return this.tilePixelRatio_}getTilePixelSize(t,n,s){const o=this.getTileGridForProjection(s),a=this.getTilePixelRatio(n),h=toSize(o.getTileSize(t),this.tmpSize);return a==1?h:scale$1(h,a,this.tmpSize)}getTileCoordForTileUrlFunction(t,n){const s=n!==void 0?n:this.getProjection(),o=n!==void 0?this.getTileGridForProjection(s):this.tileGrid||this.getTileGridForProjection(s);return this.getWrapX()&&s.isGlobal()&&(t=wrapX(o,t,s)),withinExtentAndZ(t,o)?t:null}clear(){}refresh(){this.clear(),super.refresh()}}class TileSourceEvent extends BaseEvent{constructor(t,n){super(t),this.tile=n}}const TileEventType={TILELOADSTART:"tileloadstart",TILELOADEND:"tileloadend",TILELOADERROR:"tileloaderror"};class UrlTile extends TileSource{constructor(t){super({attributions:t.attributions,cacheSize:t.cacheSize,projection:t.projection,state:t.state,tileGrid:t.tileGrid,tilePixelRatio:t.tilePixelRatio,wrapX:t.wrapX,transition:t.transition,interpolate:t.interpolate,key:t.key,attributionsCollapsible:t.attributionsCollapsible,zDirection:t.zDirection}),this.generateTileUrlFunction_=this.tileUrlFunction===UrlTile.prototype.tileUrlFunction,this.tileLoadFunction=t.tileLoadFunction,t.tileUrlFunction&&(this.tileUrlFunction=t.tileUrlFunction),this.urls=null,t.urls?this.setUrls(t.urls):t.url&&this.setUrl(t.url),this.tileLoadingKeys_={}}getTileLoadFunction(){return this.tileLoadFunction}getTileUrlFunction(){return Object.getPrototypeOf(this).tileUrlFunction===this.tileUrlFunction?this.tileUrlFunction.bind(this):this.tileUrlFunction}getUrls(){return this.urls}handleTileChange(t){const n=t.target,s=getUid(n),o=n.getState();let a;o==TileState.LOADING?(this.tileLoadingKeys_[s]=!0,a=TileEventType.TILELOADSTART):s in this.tileLoadingKeys_&&(delete this.tileLoadingKeys_[s],a=o==TileState.ERROR?TileEventType.TILELOADERROR:o==TileState.LOADED?TileEventType.TILELOADEND:void 0),a!=null&&this.dispatchEvent(new TileSourceEvent(a,n))}setTileLoadFunction(t){this.tileLoadFunction=t,this.changed()}setTileUrlFunction(t,n){this.tileUrlFunction=t,typeof n<"u"?this.setKey(n):this.changed()}setUrl(t){const n=expandUrl(t);this.urls=n,this.setUrls(n)}setUrls(t){this.urls=t;const n=t.join(`
`);this.generateTileUrlFunction_?this.setTileUrlFunction(createFromTemplates(t,this.tileGrid),n):this.setKey(n)}tileUrlFunction(t,n,s){}}class TileImage extends UrlTile{constructor(t){super({attributions:t.attributions,cacheSize:t.cacheSize,projection:t.projection,state:t.state,tileGrid:t.tileGrid,tileLoadFunction:t.tileLoadFunction?t.tileLoadFunction:defaultTileLoadFunction,tilePixelRatio:t.tilePixelRatio,tileUrlFunction:t.tileUrlFunction,url:t.url,urls:t.urls,wrapX:t.wrapX,transition:t.transition,interpolate:t.interpolate!==void 0?t.interpolate:!0,key:t.key,attributionsCollapsible:t.attributionsCollapsible,zDirection:t.zDirection}),this.crossOrigin=t.crossOrigin!==void 0?t.crossOrigin:null,this.tileClass=t.tileClass!==void 0?t.tileClass:ImageTile,this.tileGridForProjection={},this.reprojectionErrorThreshold_=t.reprojectionErrorThreshold,this.renderReprojectionEdges_=!1}getGutterForProjection(t){return this.getProjection()&&t&&!equivalent$1(this.getProjection(),t)?0:this.getGutter()}getGutter(){return 0}getKey(){let t=super.getKey();return this.getInterpolate()||(t+=":disable-interpolation"),t}getTileGridForProjection(t){const n=this.getProjection();if(this.tileGrid&&(!n||equivalent$1(n,t)))return this.tileGrid;const s=getUid(t);return s in this.tileGridForProjection||(this.tileGridForProjection[s]=getForProjection(t)),this.tileGridForProjection[s]}createTile_(t,n,s,o,a,h){const c=[t,n,s],u=this.getTileCoordForTileUrlFunction(c,a),d=u?this.tileUrlFunction(u,o,a):void 0,f=new this.tileClass(c,d!==void 0?TileState.IDLE:TileState.EMPTY,d!==void 0?d:"",this.crossOrigin,this.tileLoadFunction,this.tileOptions);return f.key=h,f.addEventListener(EventType$1.CHANGE,this.handleTileChange.bind(this)),f}getTile(t,n,s,o,a,h){const c=this.getProjection();if(!c||!a||equivalent$1(c,a))return this.getTileInternal(t,n,s,o,c||a);const u=[t,n,s],d=this.getKey(),f=this.getTileGridForProjection(c),g=this.getTileGridForProjection(a),_=this.getTileCoordForTileUrlFunction(u,a),m=new ReprojTile(c,f,a,g,u,_,this.getTilePixelRatio(o),this.getGutter(),(p,x,y,T)=>this.getTileInternal(p,x,y,T,c,h),this.reprojectionErrorThreshold_,this.renderReprojectionEdges_,this.tileOptions);return m.key=d,m}getTileInternal(t,n,s,o,a,h){const c=this.getKey(),u=getCacheKey$1(this,c,t,n,s);if(h&&h.containsKey(u))return h.get(u);const d=this.createTile_(t,n,s,o,a,c);return h==null||h.set(u,d),d}setRenderReprojectionEdges(t){this.renderReprojectionEdges_!=t&&(this.renderReprojectionEdges_=t,this.changed())}setTileGridForProjection(t,n){const s=get$1(t);if(s){const o=getUid(s);o in this.tileGridForProjection||(this.tileGridForProjection[o]=n)}}}function defaultTileLoadFunction(l,t){if(WORKER_OFFSCREEN_CANVAS){const n=l.getCrossOrigin();let s="same-origin",o="same-origin";n==="anonymous"||n===""?(s="cors",o="omit"):n==="use-credentials"&&(s="cors",o="include"),fetch(t,{mode:s,credentials:o}).then(a=>{if(!a.ok)throw new Error(`HTTP ${a.status}`);return a.blob()}).then(a=>createImageBitmap(a)).then(a=>{var u;const h=l.getImage();h.width=a.width,h.height=a.height,h.getContext("2d").drawImage(a,0,0),(u=a.close)==null||u.call(a),h.dispatchEvent(new Event("load"))}).catch(()=>{l.getImage().dispatchEvent(new Event("error"))});return}l.getImage().src=t}class XYZ extends TileImage{constructor(t){t=t||{};const n=t.projection!==void 0?t.projection:"EPSG:3857",s=t.tileGrid!==void 0?t.tileGrid:createXYZ({extent:extentFromProjection(n),maxResolution:t.maxResolution,maxZoom:t.maxZoom,minZoom:t.minZoom,tileSize:t.tileSize});super({attributions:t.attributions,cacheSize:t.cacheSize,crossOrigin:t.crossOrigin,interpolate:t.interpolate,projection:n,reprojectionErrorThreshold:t.reprojectionErrorThreshold,tileGrid:s,tileLoadFunction:t.tileLoadFunction,tilePixelRatio:t.tilePixelRatio,tileUrlFunction:t.tileUrlFunction,url:t.url,urls:t.urls,wrapX:t.wrapX!==void 0?t.wrapX:!0,transition:t.transition,attributionsCollapsible:t.attributionsCollapsible,zDirection:t.zDirection}),this.gutter_=t.gutter!==void 0?t.gutter:0}getGutter(){return this.gutter_}}const ATTRIBUTION='&#169; <a href="https://www.openstreetmap.org/copyright" target="_blank">OpenStreetMap</a> contributors.';class OSM extends XYZ{constructor(t){t=t||{};let n;t.attributions!==void 0?n=t.attributions:n=[ATTRIBUTION];const s=t.crossOrigin!==void 0?t.crossOrigin:"anonymous",o=t.url!==void 0?t.url:"https://tile.openstreetmap.org/{z}/{x}/{y}.png";super({attributions:n,attributionsCollapsible:!1,cacheSize:t.cacheSize,crossOrigin:s,interpolate:t.interpolate,maxZoom:t.maxZoom!==void 0?t.maxZoom:19,reprojectionErrorThreshold:t.reprojectionErrorThreshold,tileLoadFunction:(a,h)=>{const c=a.getImage();!WORKER_OFFSCREEN_CANVAS&&c instanceof HTMLImageElement&&(c.referrerPolicy="origin-when-cross-origin"),(t.tileLoadFunction||defaultTileLoadFunction)(a,h)},transition:t.transition,url:o,wrapX:t.wrapX,zDirection:t.zDirection})}}class TileWMS extends TileImage{constructor(t){t=t||{};const n=Object.assign({},t.params);super({attributions:t.attributions,attributionsCollapsible:t.attributionsCollapsible,cacheSize:t.cacheSize,crossOrigin:t.crossOrigin,interpolate:t.interpolate,projection:t.projection,reprojectionErrorThreshold:t.reprojectionErrorThreshold,tileClass:t.tileClass,tileGrid:t.tileGrid,tileLoadFunction:t.tileLoadFunction,url:t.url,urls:t.urls,wrapX:t.wrapX!==void 0?t.wrapX:!0,transition:t.transition,zDirection:t.zDirection}),this.gutter_=t.gutter!==void 0?t.gutter:0,this.params_=n,this.v13_=!0,this.serverType_=t.serverType,this.hidpi_=t.hidpi!==void 0?t.hidpi:!0,this.tmpExtent_=createEmpty(),this.updateV13_(),this.setKey(this.getKeyForParams_())}getFeatureInfoUrl(t,n,s,o){const a=get$1(s),h=this.getProjection()||a;let c=this.getTileGrid();c||(c=this.getTileGridForProjection(h));const u=transform$1(t,a,h),d=calculateSourceResolution(h,a,t,n),f=c.getZForResolution(d,this.zDirection),g=c.getResolution(f),_=c.getTileCoordForCoordAndZ(u,f);if(c.getResolutions().length<=_[0])return;let m=c.getTileCoordExtent(_,this.tmpExtent_);const p=this.gutter_;p!==0&&(m=buffer(m,g*p,m));const x={QUERY_LAYERS:this.params_.LAYERS};Object.assign(x,getRequestParams(this.params_,"GetFeatureInfo"),o);const y=Math.floor((u[0]-m[0])/g),T=Math.floor((m[3]-u[1])/g);return x[this.v13_?"I":"X"]=y,x[this.v13_?"J":"Y"]=T,this.getRequestUrl_(_,m,1,h||a,x)}getLegendUrl(t,n){if(this.urls[0]===void 0)return;const s={SERVICE:"WMS",VERSION:DEFAULT_VERSION$1,REQUEST:"GetLegendGraphic",FORMAT:"image/png"};if(n===void 0||n.LAYER===void 0){const o=this.params_.LAYERS;if(!(!Array.isArray(o)||o.length===1))return;s.LAYER=o}if(t!==void 0){const o=this.getProjection()?this.getProjection().getMetersPerUnit():1,a=28e-5;s.SCALE=t*o/a}return Object.assign(s,n),appendParams(this.urls[0],s)}getGutter(){return this.gutter_}getParams(){return this.params_}getRequestUrl_(t,n,s,o,a){const h=this.urls;if(!h)return;let c;if(h.length==1)c=h[0];else{const u=modulo(hash(t),h.length);c=h[u]}return getImageSrc(n,(this.tileGrid||this.getTileGridForProjection(o)).getResolution(t[0]),s,o,c,a,this.serverType_)}getTilePixelRatio(t){return!this.hidpi_||this.serverType_===void 0?1:t}getKeyForParams_(){let t=0;const n=[];for(const s in this.params_)n[t++]=s+"-"+this.params_[s];return n.join("/")}setParams_(t){this.params_=t,this.updateV13_(),this.setKey(this.getKeyForParams_())}setParams(t){this.setParams_(Object.assign({},t))}updateParams(t){this.setParams_(Object.assign(this.params_,t))}updateV13_(){const t=this.params_.VERSION||DEFAULT_VERSION$1;this.v13_=compareVersions(t,"1.3")>=0}tileUrlFunction(t,n,s){let o=this.getTileGrid();if(o||(o=this.getTileGridForProjection(s)),o.getResolutions().length<=t[0])return;n!=1&&(!this.hidpi_||this.serverType_===void 0)&&(n=1);const a=o.getResolution(t[0]);let h=o.getTileCoordExtent(t,this.tmpExtent_);const c=this.gutter_;c!==0&&(h=buffer(h,a*c,h));const u=Object.assign({},getRequestParams(this.params_,"GetMap"));return this.getRequestUrl_(t,h,n,s,u)}}const canvasPool=[];class VectorRenderTile extends Tile{constructor(t,n,s,o,a){super(t,n,{transition:0}),this.context_=null,this.executorGroups={},this.loadingSourceTiles=0,this.hitDetectionImageData={},this.replayState_={},this.sourceTiles=[],this.errorTileKeys={},this.wantedResolution,this.getSourceTiles=o.bind(void 0,this),this.removeSourceTiles_=a,this.wrappedTileCoord=s}getContext(){return this.context_||(this.context_=createCanvasContext2D(1,1,canvasPool)),this.context_}hasContext(){return!!this.context_}getImage(){return this.hasContext()?this.getContext().canvas:null}getReplayState(t){const n=getUid(t);return n in this.replayState_||(this.replayState_[n]={dirty:!1,renderedRenderOrder:null,renderedResolution:NaN,renderedRevision:-1,renderedTileResolution:NaN,renderedTileRevision:-1,renderedTileZ:-1}),this.replayState_[n]}load(){this.getSourceTiles()}release(){this.context_&&(releaseCanvas$1(this.context_),canvasPool.push(this.context_.canvas),this.context_=null),this.removeSourceTiles_(this),this.sourceTiles.length=0,super.release()}}let VectorTile$1=class extends Tile{constructor(t,n,s,o,a,h){super(t,n,h),this.extent=null,this.format_=o,this.features_=null,this.loader_,this.projection=null,this.resolution,this.tileLoadFunction_=a,this.url_=s,this.key=s}getTileUrl(){return this.url_}getFormat(){return this.format_}getFeatures(){return this.features_}load(){this.state==TileState.IDLE&&(this.setState(TileState.LOADING),this.tileLoadFunction_(this,this.url_),this.loader_&&this.loader_(this.extent,this.resolution,this.projection))}onLoad(t,n){this.setFeatures(t)}onError(){this.setState(TileState.ERROR)}setFeatures(t){this.features_=t,this.setState(TileState.LOADED)}setLoader(t){this.loader_=t}};class VectorTile extends UrlTile{constructor(t){const n=t.projection||"EPSG:3857",s=t.extent||extentFromProjection(n),o=t.tileGrid||createXYZ({extent:s,maxResolution:t.maxResolution,maxZoom:t.maxZoom!==void 0?t.maxZoom:22,minZoom:t.minZoom,tileSize:t.tileSize||512});super({attributions:t.attributions,attributionsCollapsible:t.attributionsCollapsible,cacheSize:t.cacheSize,interpolate:!0,projection:n,state:t.state,tileGrid:o,tileLoadFunction:t.tileLoadFunction?t.tileLoadFunction:defaultLoadFunction,tileUrlFunction:t.tileUrlFunction,url:t.url,urls:t.urls,wrapX:t.wrapX===void 0?!0:t.wrapX,transition:t.transition,zDirection:t.zDirection===void 0?1:t.zDirection}),this.format_=t.format?t.format:null,this.tileKeysBySourceTileUrl_={},this.sourceTiles_={},this.overlaps_=t.overlaps==null?!0:t.overlaps,this.tileClass=t.tileClass?t.tileClass:VectorTile$1,this.tileGrids_={}}getOverlaps(){return this.overlaps_}getSourceTiles(t,n,s){if(s.getState()===TileState.IDLE){s.setState(TileState.LOADING);const o=s.wrappedTileCoord,a=this.getTileGridForProjection(n);let h=a.getTileCoordExtent(o);const c=o[0],u=a.getResolution(c);buffer(h,-u,h);const d=this.projection;n&&this.projection&&!equivalent$1(n,d)&&(h=transformExtent$1(h,n,d));const f=this.tileGrid,g=f.getExtent();g&&getIntersection(h,g,h);let _=u;n&&d&&!equivalent$1(n,d)&&(_=u/d.getMetersPerUnit()/n.getMetersPerUnit());const m=f.getZForResolution(_,this.zDirection);f.forEachTileCoord(h,m,p=>{const x=this.tileUrlFunction(p,t,n);this.sourceTiles_[x]||(this.sourceTiles_[x]=new this.tileClass(p,x?TileState.IDLE:TileState.EMPTY,x,this.format_,this.tileLoadFunction));const y=this.sourceTiles_[x];s.sourceTiles.push(y),this.tileKeysBySourceTileUrl_[x]||(this.tileKeysBySourceTileUrl_[x]=[]),this.tileKeysBySourceTileUrl_[x].push(s.getKey());const T=y.getState();if(T<TileState.LOADED){const S=C=>{this.handleTileChange(C);const P=y.getState();if(P===TileState.LOADED||P===TileState.ERROR){const w=y.getKey();w in s.errorTileKeys?y.getState()===TileState.LOADED&&delete s.errorTileKeys[w]:s.loadingSourceTiles--,P===TileState.ERROR?s.errorTileKeys[w]=!0:y.removeEventListener(EventType$1.CHANGE,S),s.loadingSourceTiles===0&&s.setState(isEmpty$1(s.errorTileKeys)?TileState.LOADED:TileState.ERROR)}};y.addEventListener(EventType$1.CHANGE,S),s.loadingSourceTiles++}T===TileState.IDLE&&(y.extent=f.getTileCoordExtent(p),y.projection=this.projection,y.resolution=f.getResolution(p[0]),y.load())}),s.loadingSourceTiles||s.setState(s.sourceTiles.some(p=>p.getState()===TileState.ERROR)?TileState.ERROR:TileState.LOADED)}return s.sourceTiles}removeSourceTiles(t){const n=t.getKey(),s=t.sourceTiles;for(let o=0,a=s.length;o<a;++o){const h=s[o].getTileUrl();if(!this.tileKeysBySourceTileUrl_[h])return;const c=this.tileKeysBySourceTileUrl_[h].indexOf(n);c!==-1&&(this.tileKeysBySourceTileUrl_[h].splice(c,1),this.tileKeysBySourceTileUrl_[h].length===0&&(delete this.tileKeysBySourceTileUrl_[h],delete this.sourceTiles_[h]))}}getTile(t,n,s,o,a){const h=[t,n,s];let c=this.getTileCoordForTileUrlFunction(h,a);const u=this.getTileGrid().getExtent(),d=this.projection,f=this.getTileGridForProjection(a);if(c&&u){const m=f.getTileCoordExtent(c);buffer(m,-f.getResolution(t),m),intersects$1(u,!a||!d||equivalent$1(a,d)?m:transformExtent$1(m,a,d))||(c=null)}let g=!0;if(c!==null){const m=this.tileGrid,p=f.getResolution(t);let x=p;a&&d&&!equivalent$1(a,d)&&(x=p/d.getMetersPerUnit()/a.getMetersPerUnit());const y=m.getZForResolution(x,1),T=f.getTileCoordExtent(c);buffer(T,-p,T),m.forEachTileCoord(!a||!d||equivalent$1(a,d)?T:transformExtent$1(T,a,d),y,S=>{g=g&&!this.tileUrlFunction(S,o,d)})}const _=new VectorRenderTile(h,g?TileState.EMPTY:TileState.IDLE,c,this.getSourceTiles.bind(this,o,a),this.removeSourceTiles.bind(this));return _.key=this.getKey(),_}getTileGridForProjection(t){const n=t.getCode();let s=this.tileGrids_[n];if(!s){const o=this.projection;if(o!==null&&!equivalent$1(o,t))return getForProjection(t);const a=this.tileGrid,h=a.getResolutions().slice(),c=h.map(function(f,g){return a.getOrigin(g)}),u=h.map(function(f,g){return a.getTileSize(g)}),d=DEFAULT_MAX_ZOOM+1;for(let f=h.length;f<d;++f)h.push(h[f-1]/2),c.push(c[f-1]),u.push(u[f-1]);s=new TileGrid({extent:a.getExtent(),origins:c,resolutions:h,tileSizes:u}),this.tileGrids_[n]=s}return s}getTilePixelRatio(t){return t}getTilePixelSize(t,n,s){const o=this.getTileGridForProjection(s),a=toSize(o.getTileSize(t),this.tmpSize);return[Math.round(a[0]*n),Math.round(a[1]*n)]}setOverlaps(t){this.overlaps_=t,this.changed()}}function defaultLoadFunction(l,t){l.setLoader(function(n,s,o){loadFeaturesXhr(t,l.getFormat(),n,s,o,l.onLoad.bind(l),l.onError.bind(l))})}class WMTS extends TileImage{constructor(t){const n=t.requestEncoding!==void 0?t.requestEncoding:"KVP",s=t.tileGrid;let o=t.urls;o===void 0&&t.url!==void 0&&(o=expandUrl(t.url)),super({attributions:t.attributions,attributionsCollapsible:t.attributionsCollapsible,cacheSize:t.cacheSize,crossOrigin:t.crossOrigin,interpolate:t.interpolate,projection:t.projection,reprojectionErrorThreshold:t.reprojectionErrorThreshold,tileClass:t.tileClass,tileGrid:s,tileLoadFunction:t.tileLoadFunction,tilePixelRatio:t.tilePixelRatio,urls:o,wrapX:t.wrapX!==void 0?t.wrapX:!1,transition:t.transition,zDirection:t.zDirection}),this.version_=t.version!==void 0?t.version:"1.0.0",this.format_=t.format!==void 0?t.format:"image/jpeg",this.dimensions_=t.dimensions!==void 0?t.dimensions:{},this.layer_=t.layer,this.matrixSet_=t.matrixSet,this.style_=t.style,this.requestEncoding_=n,this.setKey(this.getKeyForDimensions_()),o&&o.length>0&&(this.tileUrlFunction=createFromTileUrlFunctions(o.map(this.createFromWMTSTemplate.bind(this))))}setUrls(t){this.urls=t;const n=t.join(`
`);this.setTileUrlFunction(createFromTileUrlFunctions(t.map(this.createFromWMTSTemplate.bind(this))),n)}getDimensions(){return this.dimensions_}getFormat(){return this.format_}getLayer(){return this.layer_}getMatrixSet(){return this.matrixSet_}getRequestEncoding(){return this.requestEncoding_}getStyle(){return this.style_}getVersion(){return this.version_}getKeyForDimensions_(){const t=this.urls?this.urls.slice(0):[];for(const n in this.dimensions_)t.push(n+"-"+this.dimensions_[n]);return t.join("/")}updateDimensions(t){Object.assign(this.dimensions_,t),this.setKey(this.getKeyForDimensions_())}createFromWMTSTemplate(t){const n=this.requestEncoding_,s={layer:this.layer_,style:this.style_,tilematrixset:this.matrixSet_};n=="KVP"&&Object.assign(s,{Service:"WMTS",Request:"GetTile",Version:this.version_,Format:this.format_}),t=n=="KVP"?appendParams(t,s):t.replace(/\{(\w+?)\}/g,function(h,c){return c.toLowerCase()in s?s[c.toLowerCase()]:h});const o=this.tileGrid,a=this.dimensions_;return function(h,c,u){if(!h)return;const d={TileMatrix:o.getMatrixId(h[0]),TileCol:h[1],TileRow:h[2]};Object.assign(d,a);let f=t;return n=="KVP"?f=appendParams(f,d):f=f.replace(/\{(\w+?)\}/g,function(g,_){return encodeURIComponent(d[_])}),f}}}function optionsFromCapabilities(l,t){var Ee;const n=l.Contents.Layer,s=n==null?void 0:n.find(function(B){return B.Identifier==t.layer});if(!s)return null;const o=l.Contents.TileMatrixSet;let a;s.TileMatrixSetLink.length>1?"projection"in t?a=s.TileMatrixSetLink.findIndex(function(B){const wt=o.find(function(Mt){return Mt.Identifier==B.TileMatrixSet}).SupportedCRS,re=get$1(wt),mt=get$1(t.projection);return re&&mt?equivalent$1(re,mt):wt==t.projection}):a=s.TileMatrixSetLink.findIndex(function(B){return B.TileMatrixSet==t.matrixSet}):a=0,a<0&&(a=0);const h=s.TileMatrixSetLink[a].TileMatrixSet,c=s.TileMatrixSetLink[a].TileMatrixSetLimits;let u=s.Format[0];"format"in t&&(u=t.format),a=s.Style.findIndex(function(B){return"style"in t?B.Title==t.style:B.isDefault}),a<0&&(a=0);const d=s.Style[a].Identifier,f={};"Dimension"in s&&s.Dimension.forEach(function(B,rt,wt){const re=B.Identifier;let mt=B.Default;mt===void 0&&(mt=B.Value[0]),f[re]=mt});const _=l.Contents.TileMatrixSet.find(function(B){return B.Identifier==h});let m;const p=_.SupportedCRS;if(p&&(m=get$1(p)),"projection"in t){const B=get$1(t.projection);B&&(!m||equivalent$1(B,m))&&(m=B)}let x=!1;const y=m.getAxisOrientation().startsWith("ne");let T=_.TileMatrix[0],S={MinTileCol:0,MinTileRow:0,MaxTileCol:T.MatrixWidth-1,MaxTileRow:T.MatrixHeight-1};if(c){S=c[c.length-1];const B=_.TileMatrix.find(rt=>rt.Identifier===S.TileMatrix||_.Identifier+":"+rt.Identifier===S.TileMatrix);B&&(T=B)}const C=(Ee=s.BoundingBox)==null?void 0:Ee.find(B=>get$1(B.crs)&&equivalent$1(get$1(B.crs),m)),P=T.ScaleDenominator*28e-5/m.getMetersPerUnit(),w=y?[T.TopLeftCorner[1],T.TopLeftCorner[0]]:T.TopLeftCorner,I=T.TileWidth*P,O=T.TileHeight*P;let N=(C==null?void 0:C.extent)??_.BoundingBox;N&&y&&(N=[N[1],N[0],N[3],N[2]]);let k=[w[0]+I*S.MinTileCol,w[1]-O*(1+S.MaxTileRow),w[0]+I*(1+S.MaxTileCol),w[1]-O*S.MinTileRow];if(N!==void 0&&!containsExtent(N,k)){const B=s.WGS84BoundingBox,rt=get$1("EPSG:4326").getExtent();if(k=N,B)x=B[0]===rt[0]&&B[2]===rt[2];else{const wt=transformExtent$1(N,_.SupportedCRS,"EPSG:4326");x=wt[0]-1e-10<=rt[0]&&wt[2]+1e-10>=rt[2]}}const D=createFromCapabilitiesMatrixSet(_,k,c),ze=[];let z=t.requestEncoding;if(z=z!==void 0?z:"","OperationsMetadata"in l&&"GetTile"in l.OperationsMetadata){const B=l.OperationsMetadata.GetTile.DCP.HTTP.Get;for(let rt=0,wt=B.length;rt<wt;++rt)if(B[rt].Constraint){const mt=B[rt].Constraint.find(function(Mt){return Mt.name=="GetEncoding"}).AllowedValues.Value;if(z===""&&(z=mt[0]),z==="KVP")mt.includes("KVP")&&ze.push(B[rt].href);else break}else B[rt].href&&(z="KVP",ze.push(B[rt].href))}return ze.length===0&&(z="REST",s.ResourceURL.forEach(function(B){B.resourceType==="tile"&&(u=B.format,ze.push(B.template))})),{urls:ze,layer:t.layer,matrixSet:h,format:u,projection:m,requestEncoding:z,tileGrid:D,style:d,dimensions:f,wrapX:x,crossOrigin:t.crossOrigin}}const basicOlFormats={GeoJSON,MVT},basicOlLayers={Group:LayerGroup,Image:ImageLayer,Tile:TileLayer,Vector:VectorLayer,VectorTile:VectorTileLayer},basicOlSources={ImageWMS,OSM,Tile:TileSource,TileWMS,Vector:VectorSource,VectorTile,WMTS,XYZ};function createLayer$1(l,t,n=!0){var h;const o={...window.eoxMapAdvancedOlLayers,...basicOlLayers}[t.type];if(!o)throw new Error(`Layer type ${t.type} not supported!`);const a=new o({...t,...t.type!=="MapboxStyle"&&t.source&&{source:createOlSourceFromDefinition(t.source)},...t.type==="Group"&&{layers:[]},...t.properties,style:void 0});if(a.set("_jsonDefinition",t,!0),t.type==="Group"){const c=t.layers.map(u=>createLayer$1(l,u));c.forEach(u=>u.set("_group",a,!0)),a.setLayers(new Collection(c))}if("style"in t&&a.setStyle(t.style),n&&((h=t.interactions)!=null&&h.length))for(let c=0;c<t.interactions.length;c++){const u=t.interactions[c];addInteraction(l,a,u)}return setSyncListeners(a,t),a}function createOlSourceFromDefinition(l){const n={...window.eoxMapAdvancedOlSources,...basicOlSources}[l.type];if(l&&!n)throw new Error(`Source type ${l.type} not supported!`);const s={...window.eoxMapAdvancedOlFormats,...basicOlFormats},o=generateTileGrid(l);return new n({...l,..."format"in l&&l.type!=="WMTS"&&{format:new s[typeof l.format=="object"?l.format.type:l.format]({...typeof l.format=="object"&&{...l.format}})},..."source"in l&&{source:createOlSourceFromDefinition(l.source)},..."tileGrid"in l&&{tileGrid:o},..."projection"in l&&{projection:get$1(l.projection)}})}function addInteraction(l,t,n){n.type==="draw"?addDraw(l,t,n.options):n.type==="select"?addSelect(l,t,n.options):n.type==="clusterExplode"&&addClusterExplode(l,t,n.options)}function updateLayer(l,t,n){var a,h,c,u;const s=n.get("_jsonDefinition");if(t.type!==s.type||t.type!=="MapboxStyle"&&((a=t.source)==null?void 0:a.type)!==((h=s.source)==null?void 0:h.type))throw new Error("Layers are not compatible to be updated");const o=createLayer$1(l,t,!1);if(t.type!=="MapboxStyle"&&serialize$1(t.source)!==serialize$1(s.source)&&n.setSource(o.getSource()),t.type==="MapboxStyle"&&serialize$1(t.properties.mapboxStyle)!==serialize$1(s.properties.mapboxStyle)&&(n.getLayers().clear(),n.applyMapboxStyle(t.properties.mapboxStyle,t.properties.applyOptions)),["Vector","VectorTile"].includes(t.type)&&serialize$1(t.style)!==serialize$1(s.style)&&n.setStyle(o.getStyle()),serialize$1(t.properties)!==serialize$1(s.properties)&&n.setProperties(t.properties),t.visible!==s.visible&&n.setVisible(t.visible),t.opacity&&t.opacity!==s.opacity&&n.setOpacity(t.opacity),serialize$1(t.interactions)!==serialize$1(s.interactions)&&((c=s.interactions)==null||c.forEach(d=>{const f=t.interactions.find(g=>{var _,m;return g.type===d.type&&((_=g.options)==null?void 0:_.id)===((m=d.options)==null?void 0:m.id)});f?f.type==="draw"?(l.interactions[f.options.id].setActive(f.options.active),l.interactions[`${f.options.id}_modify`].setActive(f.options.modify)):(l.selectInteractions[f.options.id]||l.interactions[f.options.id]).setActive(f.options.active):d.type==="select"?l.removeSelect(d.options.id):l.removeInteraction(d.options.id)}),(u=t.interactions)==null||u.forEach(d=>{s.interactions.find(g=>{var _,m;return g.type===d.type&&((_=g.options)==null?void 0:_.id)===((m=d.options)==null?void 0:m.id)})||addInteraction(l,n,d)})),t.type==="Group"){const d=t.layers.map(m=>{var p;return(p=m.properties)==null?void 0:p.id}),f=n.getLayers();f.getArray().slice().forEach(m=>{d.includes(m.get("id"))||f.remove(m)}),t.layers.forEach(m=>{const p=m.properties.id;if(f.getArray().map(x=>x.get("id")).includes(p))updateLayer(l,m,l.getLayerById(p));else{const x=createLayer$1(l,m);f.push(x)}});const _=d;f.getArray().sort((m,p)=>_.indexOf(m.get("id"))-_.indexOf(p.get("id"))),f.changed()}return setSyncListeners(n,t),n.set("_jsonDefinition",t,!0),n}const generateLayers=(l,t)=>t?[...t].map(n=>createLayer$1(l,n)):[];function setSyncListeners(l,t){l.on("change:opacity",()=>{t.opacity=l.getOpacity()}),l.on("change:visible",()=>{t.visible=l.getVisible()}),l.on("change:zIndex",()=>{t.zIndex=l.getZIndex()}),l.on("propertychange",n=>{n.key==="map"||n.key==="source"||t.properties&&(t.properties[n.key]=n.target.get(n.key))})}class EOxSelectInteraction{constructor(t,n,s){Cu(this,"panIntoFeature",(t,n)=>{const s=t instanceof Feature||t instanceof RenderFeature?t.getGeometry().getExtent():t;this.eoxMap.map.getView().fit(s,n||{duration:750})});var d,f,g;this.eoxMap=t,this.selectLayer=n,this.options=s,this.active=s.active||n.getVisible(),this.panIn=s.panIn||!1,this.tooltip=s.tooltip!==!1;const o=this.eoxMap.map.getOverlayById("eox-map-tooltip");let a;this.tooltip&&(o?(this.tooltipElement=o.getElement(),a=o):(this.tooltipElement=this.eoxMap.querySelector("eox-map-tooltip")||this.eoxMap.querySelector("[is=eox-map-tooltip]")||((d=s.overlay)==null?void 0:d.element),this.tooltipElement&&(a=new Overlay({element:this.tooltipElement,position:void 0,offset:[0,0],positioning:"top-left",className:"eox-map-tooltip",id:"eox-map-tooltip",...s.overlay}),this.eoxMap.map.addOverlay(a))));const h=()=>{a&&s.condition==="pointermove"&&a.setPosition(void 0)};t.map.on("change:target",_=>{var m,p;(m=_.oldValue)==null||m.removeEventListener("pointerleave",h),(p=_.target.getTargetElement())==null||p.addEventListener("pointerleave",h)}),(f=t.map.getTargetElement())==null||f.addEventListener("pointerleave",h);const c=_=>{var y,T,S,C;s!=null&&s.projection&&(proj4.defs((y=s.projection)==null?void 0:y.name)||(proj4.defs((T=s.projection)==null?void 0:T.name,(S=s==null?void 0:s.projection)==null?void 0:S.proj4_string),register(proj4)));const m=get$1(((C=s==null?void 0:s.projection)==null?void 0:C.name)||"EPSG:4326"),p=t.map.getView().getProjection().getCode(),x=transform$1(_.coordinate,p,m);return{lon:x[0].toFixed((s==null?void 0:s.precision)||2),lat:x[1].toFixed((s==null?void 0:s.precision)||2)}},u=_=>Object.values(_).every(m=>m===0);if(this.selectLayer instanceof VectorLayer||this.selectLayer instanceof VectorTileLayer){this.selectedFids=[];let _;if(this.options.layer)_=this.options.layer;else{const x=this.selectLayer.get("_jsonDefinition");_={...x,style:s.style,properties:{id:this.selectLayer.get("id")+"_select"},source:{type:x.type}}}_.renderMode="vector",delete _.interactions,this.selectStyleLayer=createLayer$1(t,_),this.selectStyleLayer.setSource(this.selectLayer.getSource()),this.selectStyleLayer.setMap(this.eoxMap.map);const m=this.selectStyleLayer.getStyleFunction();this.selectStyleLayer.setStyle((x,y)=>this.selectedFids.length&&this.selectedFids.includes(this.getId(x))?m(x,y):null),this.listener=x=>{if(!this.active||x.dragging)return;const y=this.eoxMap.map.getView().getZoom();if(y<this.selectLayer.getMinZoom()||y>this.selectLayer.getMaxZoom())return;const T=this.eoxMap.map.forEachFeatureAtPixel(x.pixel,w=>w,{layerFilter:w=>w===this.selectLayer}),S=T?[this.getId(T)]:[],C=this.selectedFids[0]!==S[0];if(this.selectedFids=S,C&&(this.selectStyleLayer.changed(),T&&this.panIn&&this.panIntoFeature(T)),a){const w=x.pixel[0]>this.eoxMap.offsetWidth/2?"right":"left",I=x.pixel[1]>this.eoxMap.offsetHeight/2?"bottom":"top";a.setPositioning(`${I}-${w}`),a.setPosition(T?x.coordinate:null),T&&this.tooltipElement&&(this.tooltipElement.feature=T)}const P=new CustomEvent("select",{detail:{id:s.id,originalEvent:x,feature:T}});this.eoxMap.dispatchEvent(P)},this.eoxMap.map.on(s.condition||"click",this.listener),this.selectLayer.on("change:opacity",()=>{this.selectStyleLayer.setOpacity(this.selectLayer.getOpacity())}),this.selectLayer.on("change:visible",()=>{const x=this.selectLayer.getVisible();this.selectStyleLayer.setVisible(x),this.setActive(x)}),this.changeSourceListener=()=>{this.selectStyleLayer.setSource(this.selectLayer.getSource())},this.selectLayer.on("change:source",this.changeSourceListener);const p=()=>{var x,y;t.getLayerById(n.get("id"))?((x=this.selectStyleLayer)==null||x.setMap(this.eoxMap.map),a==null||a.setMap(this.eoxMap.map)):((y=this.selectStyleLayer)==null||y.setMap(null),a==null||a.setMap(null))};t.map.getLayerGroup().on("change",p),this.pointerMoveListener=x=>{var y;x.dragging||(t.map.getTargetElement().style.cursor=t.map.hasFeatureAtPixel(x.pixel,{layerFilter:T=>{var S,C;return(C=(S=T.get("_jsonDefinition"))==null?void 0:S.interactions)==null?void 0:C.find(P=>{var w;return P.type=="select"&&((w=P.options)==null?void 0:w.condition)==="click"})},...s.atPixelOptions})?s.cursor||"pointer":(y=this.eoxMap.interactions.drawInteraction)!=null&&y.getActive()?"crosshair":"auto")},t.map.on("pointermove",this.pointerMoveListener)}(this.selectLayer.getSource()instanceof ImageWMS||this.selectLayer.getSource()instanceof TileWMS)&&(this.listener=_=>{if(!this.active||_.dragging)return;const m=t.map.getView().getResolution(),p=this.selectLayer.getSource().getFeatureInfoUrl(_.coordinate,m,t.map.getView().getProjection(),{INFO_FORMAT:"application/json"});p&&fetch(p).then(x=>x.text()).then(x=>{if(a){const y=_.pixel[0]>this.eoxMap.offsetWidth/2?"right":"left",T=_.pixel[1]>this.eoxMap.offsetHeight/2?"bottom":"top";a.setPositioning(`${T}-${y}`)}if(x&&this.tooltipElement){const y=JSON.parse(x);let T;y.type==="FeatureCollection"&&y.features.length>0?T=y.features[0]:y.type==="Feature"?(T=y,this.tooltipElement.innerHTML=`<pre>${JSON.stringify(T.properties,null,2)}</pre>`):a==null||a.setPosition(null),s!=null&&s.coordinates&&T&&Object.assign(T==null?void 0:T.properties,c(_));const S=new Feature({...T==null?void 0:T.properties});this.tooltipElement.feature=S,a.setPosition(T?_.coordinate:null)}})},s.condition=="click"&&this.eoxMap.map.on(s.condition,this.listener)),((g=this.selectLayer.getProperties())==null?void 0:g.type)==="WebGLTile"&&(this.listener=_=>{if(!this.active||_.dragging)return;const m=this.selectLayer.getData(_.pixel);if(m){if(a){const p=_.pixel[0]>this.eoxMap.offsetWidth/2?"right":"left",x=_.pixel[1]>this.eoxMap.offsetHeight/2?"bottom":"top";a.setPositioning(`${x}-${p}`),a.setPosition(_.coordinate);let y={};for(const[T,S]of m.entries()){const C=(T+1).toString();y[`band${C}`]=S}if(u(y))a==null||a.setPosition(null);else if(this.tooltipElement){s!=null&&s.coordinates&&Object.assign(y,c(_));const T=new Feature({...y});this.tooltipElement.feature=T,a.setPosition(Object.keys(y).length>0?_.coordinate:null)}}}else a==null||a.setPosition(null)},this.eoxMap.map.on(s.condition||"click",this.listener))}setActive(t){this.active=t}highlightById(t,n){if(this.selectedFids=t,t.length&&n){const s=createEmpty();if(this.selectLayer instanceof VectorLayer)for(let o=0;o<this.selectedFids.length;o++){const a=this.selectedFids[o],h=this.selectLayer.getSource().getFeatureById(a);h&&h.getGeometry()&&extend$1(s,h.getGeometry().getExtent())}else if(this.selectLayer instanceof VectorTileLayer){const o=this.eoxMap.map,a=this.selectLayer.getFeaturesInExtent(o.getView().calculateExtent(o.getSize()));for(let h=0;h<a.length;h++){const c=a[h];this.selectedFids.includes(this.getId(c))&&extend$1(s,c.getGeometry().getExtent())}}isEmpty(s)||this.panIntoFeature(s,n)}this.selectStyleLayer.changed()}remove(){this.eoxMap.map.un(this.options.condition||"click",this.listener),(this.selectLayer instanceof VectorLayer||this.selectLayer instanceof VectorTileLayer)&&(this.selectStyleLayer.setMap(null),delete this.eoxMap.selectInteractions[this.options.id],this.selectLayer.un("change:source",this.changeSourceListener),this.eoxMap.map.un("pointermove",this.pointerMoveListener))}getId(t){if(this.options.idProperty)return t.get(this.options.idProperty);if(t.getId()!==void 0)return t.getId();if(t.get("id")!==void 0)return t.get("id");if(getUid(t)!==void 0)return getUid(t);throw Error("No feature id found. Please provide which feature property should be taken instead using idProperty.")}}function addSelect(l,t,n){if(l.interactions[n.id])throw Error(`Interaction with id: ${n.id} already exists.`);return l.selectInteractions[n.id]=new EOxSelectInteraction(l,t,n),l.selectInteractions[n.id]}const circleDistanceMultiplier=1,circleFootSeparation=28,circleStartAngle=Math.PI/2;var Xc,gu,Hc,Ns,Du,ou,Ru,bu,Xu,ku;class EOxClusterExplodeInteraction extends Interaction{constructor(n,s,o){super(o);mo(this,Ns);mo(this,Xc,null);mo(this,gu,null);mo(this,Hc,null);mo(this,Ru,n=>new Promise(s=>{const o=this.eoxMap.map.getView().getZoom(),a={...qi(this,Xc).fitOptions};a.callback=h=>{var c,u;s(this.eoxMap.map.getView().getZoom()!==o),(u=(c=qi(this,Xc).fitOptions).callback)==null||u.call(c,h)},this.eoxMap.map.getView().fit(n,a)}));this.clusterLayer=s,this.eoxMap=n;const a={maxZoom:20,atPixelOptions:{},fitOptions:{duration:500,padding:[40,40,40,40]}},h=structuredClone(o);h.fitOptions&&(a.fitOptions={...a.fitOptions,...h.fitOptions},delete h.fitOptions),Pc(this,Xc,{...a,...h}),this.active=o.active||s.getVisible();const c=new VectorLayer;c.setStyle(o.style),Pc(this,gu,c.getStyleFunction())}handleEvent(n){if(!this.getActive())return!0;if(n.type==="pointermove"){const s=this.eoxMap.map.hasFeatureAtPixel(n.pixel,{layerFilter:o=>o===this.clusterLayer,...qi(this,Xc).atPixelOptions});return this.eoxMap.map.getTargetElement().style.cursor=s?"pointer":"default",!s}if(n.type==="click"){const s=this.eoxMap.map.getFeaturesAtPixel(n.pixel,{layerFilter:c=>c===this.clusterLayer,...qi(this,Xc).atPixelOptions});if(s.length===0)return Mc(this,Ns,ou).call(this),!0;const o=s[0],a=o.get("features");if(a.length===1)return Mc(this,Ns,Du).call(this,n,a[0]),Mc(this,Ns,ou).call(this),!0;if(qi(this,Hc)&&qi(this,Hc)===o){const c=Mc(this,Ns,Xu).call(this,o,n.coordinate);Mc(this,Ns,Du).call(this,n,c.feature)}if(this.eoxMap.map.getView().getZoom()>qi(this,Xc).maxZoom-1)return Mc(this,Ns,bu).call(this,o),!1;const h=createEmpty();return a.forEach(c=>{extend$1(h,c.getGeometry().getExtent())}),getArea$1(h)<100?(Mc(this,Ns,bu).call(this,o),!1):(qi(this,Ru).call(this,h).then(c=>{c||Mc(this,Ns,bu).call(this,o)}),!1)}return!0}setActive(n){n||(Mc(this,Ns,ou).call(this),this.eoxMap.map.getTargetElement().style.cursor="default"),super.setActive(n)}setMap(n){n||(Mc(this,Ns,ou).call(this),this.eoxMap.map.getTargetElement().style.cursor="default"),super.setMap(n)}remove(){this.setMap(null)}}Xc=new WeakMap,gu=new WeakMap,Hc=new WeakMap,Ns=new WeakSet,Du=function(n,s){const o=new CustomEvent("clusterSelect",{detail:{originalEvent:n,feature:s}});this.eoxMap.dispatchEvent(o)},ou=function(){qi(this,Hc)&&(qi(this,Hc).setStyle(void 0),Pc(this,Hc,null))},Ru=new WeakMap,bu=function(n){qi(this,Hc)&&Mc(this,Ns,ou).call(this);const s=n.getGeometry().getCoordinates(),o=n.get("features"),a=Mc(this,Ns,ku).call(this,o.length,s,this.eoxMap.map.getView().getResolution()).reduce((h,c,u)=>{const d=new Point(c),f=new LineString([s,c]);h.unshift(new Style({geometry:f,stroke:new Stroke({color:"rgba(50, 50, 50, 0.5)",width:2.5})}));const g=new Feature({...o[u].getProperties()}),_=qi(this,gu).call(this,g,this.eoxMap.map.getView().getResolution());return _!=null&&_.length&&_.forEach(m=>{const p=m.clone();p.setGeometry(d),h.unshift(p)}),h},[]);n.setStyle(a),Pc(this,Hc,n)},Xu=function(n,s){const o=n.get("features"),a=Mc(this,Ns,ku).call(this,o.length,n.getGeometry().getCoordinates(),this.eoxMap.map.getView().getResolution());let h=1/0,c;for(let u=0,d=a.length;u<d;++u){const f=(s[0]-a[u][0])**2+(s[1]-a[u][1])**2;f<h&&(c=u,h=f)}return{feature:o[c],coords:a[c]}},ku=function(n,s,o){let h=circleDistanceMultiplier*circleFootSeparation*(2+n)/(Math.PI*2);const c=Math.PI*2/n,u=[];let d;h=Math.max(h,35)*o;for(let f=0;f<n;++f)d=circleStartAngle+f*c,u.push([s[0]+h*Math.cos(d),s[1]+h*Math.sin(d)]);return u};function addClusterExplode(l,t,n){if(l.interactions[n.id])throw Error(`Interaction with id: ${n.id} already exists.`);const s=new EOxClusterExplodeInteraction(l,t,n);l.interactions[n.id]=s,l.map.addInteraction(s)}function generateTileGrid(l){let t;if(!(!l||!("tileGrid"in l))){if(l.type==="WMTS"){const s=get$1("EPSG:3857").getExtent(),o=getWidth(s)/128,a=new Array(19),h=new Array(19);for(let c=0;c<19;++c)a[c]=o/Math.pow(2,c),h[c]=c;t=new WMTSTileGrid({resolutions:a,origin:getTopLeft(s),projection:l.tileGrid.projection||"EPSG:3857",matrixIds:h,...l.tileGrid})}else t=createXYZ({...l.tileGrid});return t}}function getLayerById(l,t){return getFlatLayersArray(l.map.getLayers().getArray()).find(s=>s.get("id")===t)}function getFlatLayersArray(l){const t=[];t.push(...l);let n=t.filter(s=>s instanceof LayerGroup);for(;n.length;){const s=[];for(let o=0;o<n.length;o++){const a=n[o].getLayers().getArray();t.push(...a),s.push(...a.filter(h=>h instanceof LayerGroup))}n=s}return t}function animateToStateMethod(l){const t=Object.assign({},l.animationOptions),n=l.map.getView();if(cancelAnimation(n),!t||!Object.keys(t).length){n.setCenter(l.center),n.setZoom(l.zoom);return}t.center=getCenterFromProperty(l.center),t.zoom=l.zoom,n.animate(t)}const UNITS_PROP="units",LEADING_DIGITS=[1,2,5],DEFAULT_DPI=25.4/.28;class ScaleLine extends Control{constructor(t){t=t||{};const n=document.createElement("div");n.style.pointerEvents="none",super({element:n,render:t.render,target:t.target}),this.on,this.once,this.un;const s=t.className!==void 0?t.className:t.bar?"ol-scale-bar":"ol-scale-line";this.innerElement_=document.createElement("div"),this.innerElement_.className=s+"-inner",this.element.className=s+" "+CLASS_UNSELECTABLE,this.element.appendChild(this.innerElement_),this.viewState_=null,this.minWidth_=t.minWidth!==void 0?t.minWidth:64,this.maxWidth_=t.maxWidth,this.renderedVisible_=!1,this.renderedWidth_=void 0,this.renderedHTML_="",this.addChangeListener(UNITS_PROP,this.handleUnitsChanged_),this.setUnits(t.units||"metric"),this.scaleBar_=t.bar||!1,this.scaleBarSteps_=t.steps||4,this.scaleBarText_=t.text||!1,this.dpi_=t.dpi||void 0}getUnits(){return this.get(UNITS_PROP)}handleUnitsChanged_(){this.updateElement_()}setUnits(t){this.set(UNITS_PROP,t)}setDpi(t){this.dpi_=t}updateElement_(){const t=this.viewState_;if(!t){this.renderedVisible_&&(this.element.style.display="none",this.renderedVisible_=!1);return}const n=t.center,s=t.projection,o=this.getUnits(),a=o=="degrees"?"degrees":"m";let h=getPointResolution(s,t.resolution,n,a);const c=this.minWidth_*(this.dpi_||DEFAULT_DPI)/DEFAULT_DPI,u=this.maxWidth_!==void 0?this.maxWidth_*(this.dpi_||DEFAULT_DPI)/DEFAULT_DPI:void 0;let d=c*h,f="";if(o=="degrees"){const C=METERS_PER_UNIT$1.degrees;d*=C,d<C/60?(f="″",h*=3600):d<C?(f="′",h*=60):f="°"}else if(o=="imperial")d<.9144?(f="in",h/=.0254):d<1609.344?(f="ft",h/=.3048):(f="mi",h/=1609.344);else if(o=="nautical")h/=1852,f="NM";else if(o=="metric")d<1e-6?(f="nm",h*=1e9):d<.001?(f="μm",h*=1e6):d<1?(f="mm",h*=1e3):d<1e3?f="m":(f="km",h/=1e3);else if(o=="us")d<.9144?(f="in",h*=39.37):d<1609.344?(f="ft",h/=.30480061):(f="mi",h/=1609.3472);else throw new Error("Invalid units");let g=3*Math.floor(Math.log(c*h)/Math.log(10)),_,m,p,x=0,y,T;for(;;){p=Math.floor(g/3);const C=Math.pow(10,p);if(_=LEADING_DIGITS[(g%3+3)%3]*C,m=Math.round(_/h),isNaN(m)){this.element.style.display="none",this.renderedVisible_=!1;return}if(u!==void 0&&m>=u){_=x,m=y,p=T;break}else if(m>=c)break;x=_,y=m,T=p,++g}const S=this.scaleBar_?this.createScaleBar(m,_,f):_.toFixed(p<0?-p:0)+" "+f;this.renderedHTML_!=S&&(this.innerElement_.innerHTML=S,this.renderedHTML_=S),this.renderedWidth_!=m&&(this.innerElement_.style.width=m+"px",this.renderedWidth_=m),this.renderedVisible_||(this.element.style.display="",this.renderedVisible_=!0)}createScaleBar(t,n,s){const o=this.getScaleForResolution(),a=o<1?Math.round(1/o).toLocaleString()+" : 1":"1 : "+Math.round(o).toLocaleString(),h=this.scaleBarSteps_,c=t/h,u=[this.createMarker("absolute")];for(let f=0;f<h;++f){const g=f%2===0?"ol-scale-singlebar-odd":"ol-scale-singlebar-even";u.push(`<div><div class="ol-scale-singlebar ${g}" style="width: ${c}px;"></div>`+this.createMarker("relative")+(f%2===0||h===2?this.createStepText(f,t,!1,n,s):"")+"</div>")}return u.push(this.createStepText(h,t,!0,n,s)),(this.scaleBarText_?`<div class="ol-scale-text" style="width: ${t}px;">`+a+"</div>":"")+u.join("")}createMarker(t){return`<div class="ol-scale-step-marker" style="position: ${t}; top: ${t==="absolute"?3:-10}px;"></div>`}createStepText(t,n,s,o,a){const c=(t===0?0:Math.round(o/this.scaleBarSteps_*t*100)/100)+(t===0?"":" "+a),u=t===0?-3:n/this.scaleBarSteps_*-1,d=t===0?0:n/this.scaleBarSteps_*2;return`<div class="ol-scale-step-text" style="margin-left: ${u}px;text-align: ${t===0?"left":"center"};min-width: ${d}px;left: ${s?n+"px":"unset"};">`+c+"</div>"}getScaleForResolution(){const t=getPointResolution(this.viewState_.projection,this.viewState_.resolution,this.viewState_.center,"m"),n=this.dpi_||DEFAULT_DPI,s=1e3/25.4;return t*s*n}render(t){const n=t.frameState;n?this.viewState_=n.viewState:this.viewState_=null,this.updateElement_()}}const events=["fullscreenchange","webkitfullscreenchange"],FullScreenEventType={ENTERFULLSCREEN:"enterfullscreen",LEAVEFULLSCREEN:"leavefullscreen"};class FullScreen extends Control{constructor(t){t=t||{},super({element:document.createElement("div"),target:t.target}),this.on,this.once,this.un,this.keys_=t.keys!==void 0?t.keys:!1,this.source_=t.source,this.isInFullscreen_=!1,this.boundHandleMapTargetChange_=this.handleMapTargetChange_.bind(this),this.cssClassName_=t.className!==void 0?t.className:"ol-full-screen",this.documentListeners_=[],this.activeClassName_=t.activeClassName!==void 0?t.activeClassName.split(" "):[this.cssClassName_+"-true"],this.inactiveClassName_=t.inactiveClassName!==void 0?t.inactiveClassName.split(" "):[this.cssClassName_+"-false"];const n=t.label!==void 0?t.label:"⤢";this.labelNode_=typeof n=="string"?document.createTextNode(n):n;const s=t.labelActive!==void 0?t.labelActive:"×";this.labelActiveNode_=typeof s=="string"?document.createTextNode(s):s;const o=t.tipLabel?t.tipLabel:"Toggle full-screen";this.button_=document.createElement("button"),this.button_.title=o,this.button_.setAttribute("type","button"),this.button_.appendChild(this.labelNode_),this.button_.addEventListener(EventType$1.CLICK,this.handleClick_.bind(this),!1),this.setClassName_(this.button_,this.isInFullscreen_),this.element.className=`${this.cssClassName_} ${CLASS_UNSELECTABLE} ${CLASS_CONTROL}`,this.element.appendChild(this.button_)}handleClick_(t){t.preventDefault(),this.handleFullScreen_()}handleFullScreen_(){const t=this.getMap();if(!t)return;const n=t.getOwnerDocument();if(isFullScreenSupported(n))if(isFullScreen(n))exitFullScreen(n);else{let s;this.source_?s=typeof this.source_=="string"?n.getElementById(this.source_):this.source_:s=t.getTargetElement(),this.keys_?requestFullScreenWithKeys(s):requestFullScreen(s)}}handleFullScreenChange_(){const t=this.getMap();if(!t)return;const n=this.isInFullscreen_;this.isInFullscreen_=isFullScreen(t.getOwnerDocument()),n!==this.isInFullscreen_&&(this.setClassName_(this.button_,this.isInFullscreen_),this.isInFullscreen_?(replaceNode(this.labelActiveNode_,this.labelNode_),this.dispatchEvent(FullScreenEventType.ENTERFULLSCREEN)):(replaceNode(this.labelNode_,this.labelActiveNode_),this.dispatchEvent(FullScreenEventType.LEAVEFULLSCREEN)),t.updateSize())}setClassName_(t,n){n?(t.classList.remove(...this.inactiveClassName_),t.classList.add(...this.activeClassName_)):(t.classList.remove(...this.activeClassName_),t.classList.add(...this.inactiveClassName_))}setMap(t){const n=this.getMap();n&&n.removeChangeListener(MapProperty.TARGET,this.boundHandleMapTargetChange_),super.setMap(t),this.handleMapTargetChange_(),t&&t.addChangeListener(MapProperty.TARGET,this.boundHandleMapTargetChange_)}handleMapTargetChange_(){const t=this.documentListeners_;for(let s=0,o=t.length;s<o;++s)unlistenByKey(t[s]);t.length=0;const n=this.getMap();if(n){const s=n.getOwnerDocument();isFullScreenSupported(s)?this.element.classList.remove(CLASS_UNSUPPORTED):this.element.classList.add(CLASS_UNSUPPORTED);for(let o=0,a=events.length;o<a;++o)t.push(listen(s,events[o],this.handleFullScreenChange_,this));this.handleFullScreenChange_()}}}function isFullScreenSupported(l){const t=l.body;return!!(t.webkitRequestFullscreen||t.requestFullscreen&&l.fullscreenEnabled)}function isFullScreen(l){return!!(l.webkitIsFullScreen||l.fullscreenElement)}function requestFullScreen(l){l.requestFullscreen?l.requestFullscreen():l.webkitRequestFullscreen&&l.webkitRequestFullscreen()}function requestFullScreenWithKeys(l){l.webkitRequestFullscreen?l.webkitRequestFullscreen():requestFullScreen(l)}function exitFullScreen(l){l.exitFullscreen?l.exitFullscreen():l.webkitExitFullscreen&&l.webkitExitFullscreen()}const Direction={VERTICAL:0,HORIZONTAL:1};class ZoomSlider extends Control{constructor(t){t=t||{},super({target:t.target,element:document.createElement("div"),render:t.render}),this.dragListenerKeys_=[],this.currentResolution_=void 0,this.direction_=Direction.VERTICAL,this.dragging_,this.heightLimit_=0,this.widthLimit_=0,this.startX_,this.startY_,this.thumbSize_=null,this.sliderInitialized_=!1,this.duration_=t.duration!==void 0?t.duration:200;const n=t.className!==void 0?t.className:"ol-zoomslider",s=document.createElement("button");s.setAttribute("type","button"),s.className=n+"-thumb "+CLASS_UNSELECTABLE;const o=this.element;o.className=n+" "+CLASS_UNSELECTABLE+" "+CLASS_CONTROL,o.appendChild(s),o.addEventListener(EventType.POINTERDOWN,this.handleDraggerStart_.bind(this),!1),o.addEventListener(EventType.POINTERMOVE,this.handleDraggerDrag_.bind(this),!1),o.addEventListener(EventType.POINTERUP,this.handleDraggerEnd_.bind(this),!1),o.addEventListener(EventType$1.CLICK,this.handleContainerClick_.bind(this),!1),s.addEventListener(EventType$1.CLICK,stopPropagation,!1)}setMap(t){super.setMap(t),t&&t.render()}initSlider_(){const t=this.element;let n=t.offsetWidth,s=t.offsetHeight;if(n===0&&s===0)return this.sliderInitialized_=!1;const o=getComputedStyle(t);n-=parseFloat(o.paddingRight)+parseFloat(o.paddingLeft),s-=parseFloat(o.paddingTop)+parseFloat(o.paddingBottom);const a=t.firstElementChild,h=getComputedStyle(a),c=a.offsetWidth+parseFloat(h.marginRight)+parseFloat(h.marginLeft),u=a.offsetHeight+parseFloat(h.marginTop)+parseFloat(h.marginBottom);return this.thumbSize_=[c,u],n>s?(this.direction_=Direction.HORIZONTAL,this.widthLimit_=n-c):(this.direction_=Direction.VERTICAL,this.heightLimit_=s-u),this.sliderInitialized_=!0}handleContainerClick_(t){const n=this.getMap().getView(),s=this.getRelativePosition_(t.offsetX-this.thumbSize_[0]/2,t.offsetY-this.thumbSize_[1]/2),o=this.getResolutionForPosition_(s),a=n.getConstrainedZoom(n.getZoomForResolution(o));n.animateInternal({zoom:a,duration:this.duration_,easing:easeOut})}handleDraggerStart_(t){if(!this.dragging_&&t.target===this.element.firstElementChild){const n=this.element.firstElementChild;if(this.getMap().getView().beginInteraction(),this.startX_=t.clientX-parseFloat(n.style.left),this.startY_=t.clientY-parseFloat(n.style.top),this.dragging_=!0,this.dragListenerKeys_.length===0){const s=this.handleDraggerDrag_,o=this.handleDraggerEnd_,a=this.getMap().getOwnerDocument();this.dragListenerKeys_.push(listen(a,EventType.POINTERMOVE,s,this),listen(a,EventType.POINTERUP,o,this))}}}handleDraggerDrag_(t){if(this.dragging_){const n=t.clientX-this.startX_,s=t.clientY-this.startY_,o=this.getRelativePosition_(n,s);this.currentResolution_=this.getResolutionForPosition_(o),this.getMap().getView().setResolution(this.currentResolution_)}}handleDraggerEnd_(t){this.dragging_&&(this.getMap().getView().endInteraction(),this.dragging_=!1,this.startX_=void 0,this.startY_=void 0,this.dragListenerKeys_.forEach(unlistenByKey),this.dragListenerKeys_.length=0)}setThumbPosition_(t){const n=this.getPositionForResolution_(t),s=this.element.firstElementChild;this.direction_==Direction.HORIZONTAL?s.style.left=this.widthLimit_*n+"px":s.style.top=this.heightLimit_*n+"px"}getRelativePosition_(t,n){let s;return this.direction_===Direction.HORIZONTAL?s=t/this.widthLimit_:s=n/this.heightLimit_,clamp(s,0,1)}getResolutionForPosition_(t){return this.getMap().getView().getResolutionForValueFunction()(1-t)}getPositionForResolution_(t){const n=this.getMap().getView().getValueForResolutionFunction();return clamp(1-n(t),0,1)}render(t){if(!t.frameState||!this.sliderInitialized_&&!this.initSlider_())return;const n=t.frameState.viewState.resolution;this.currentResolution_=n,this.setThumbPosition_(n)}}const MAX_RATIO=.75,MIN_RATIO=.1;class OverviewMap extends Control{constructor(t){t=t||{},super({element:document.createElement("div"),render:t.render,target:t.target}),this.boundHandleRotationChanged_=this.handleRotationChanged_.bind(this),this.collapsed_=t.collapsed!==void 0?t.collapsed:!0,this.collapsible_=t.collapsible!==void 0?t.collapsible:!0,this.collapsible_||(this.collapsed_=!1),this.rotateWithView_=t.rotateWithView!==void 0?t.rotateWithView:!1,this.viewExtent_=void 0;const n=t.className!==void 0?t.className:"ol-overviewmap",s=t.tipLabel!==void 0?t.tipLabel:"Overview map",o=t.collapseLabel!==void 0?t.collapseLabel:"‹";typeof o=="string"?(this.collapseLabel_=document.createElement("span"),this.collapseLabel_.textContent=o):this.collapseLabel_=o;const a=t.label!==void 0?t.label:"›";typeof a=="string"?(this.label_=document.createElement("span"),this.label_.textContent=a):this.label_=a;const h=this.collapsible_&&!this.collapsed_?this.collapseLabel_:this.label_,c=document.createElement("button");c.setAttribute("type","button"),c.title=s,c.appendChild(h),c.addEventListener(EventType$1.CLICK,this.handleClick_.bind(this),!1),this.ovmapDiv_=document.createElement("div"),this.ovmapDiv_.className="ol-overviewmap-map",this.view_=t.view;const u=new Map$1({view:t.view,controls:new Collection,interactions:new Collection});this.ovmap_=u,t.layers&&t.layers.forEach(function(T){u.addLayer(T)});const d=document.createElement("div");d.className="ol-overviewmap-box",d.style.boxSizing="border-box",this.boxOverlay_=new Overlay({position:[0,0],positioning:"center-center",element:d}),this.ovmap_.addOverlay(this.boxOverlay_);const f=n+" "+CLASS_UNSELECTABLE+" "+CLASS_CONTROL+(this.collapsed_&&this.collapsible_?" "+CLASS_COLLAPSED:"")+(this.collapsible_?"":" ol-uncollapsible"),g=this.element;g.className=f,g.appendChild(this.ovmapDiv_),g.appendChild(c);const _=this.boxOverlay_,m=this.boxOverlay_.getElement(),p=T=>({clientX:T.clientX,clientY:T.clientY}),x=function(T){const S=p(T),C=u.getEventCoordinate(S);_.setPosition(C)},y=T=>{const S=u.getEventCoordinateInternal(T),C=this.getMap();C.getView().setCenterInternal(S);const P=C.getOwnerDocument();P.removeEventListener("pointermove",x),P.removeEventListener("pointerup",y)};this.ovmapDiv_.addEventListener("pointerdown",T=>{const S=this.getMap().getOwnerDocument();T.target===m&&S.addEventListener("pointermove",x),S.addEventListener("pointerup",y)})}setMap(t){const n=this.getMap();if(t!==n){if(n){const s=n.getView();s&&this.unbindView_(s),this.ovmap_.setTarget(null)}if(super.setMap(t),t){this.ovmap_.setTarget(this.ovmapDiv_),this.listenerKeys.push(listen(t,ObjectEventType.PROPERTYCHANGE,this.handleMapPropertyChange_,this));const s=t.getView();s&&this.bindView_(s),this.ovmap_.isRendered()||this.updateBoxAfterOvmapIsRendered_()}}}handleMapPropertyChange_(t){if(t.key===MapProperty.VIEW){const n=t.oldValue;n&&this.unbindView_(n);const s=this.getMap().getView();this.bindView_(s)}else!this.ovmap_.isRendered()&&(t.key===MapProperty.TARGET||t.key===MapProperty.SIZE)&&this.ovmap_.updateSize()}bindView_(t){if(!this.view_){const n=new View({projection:t.getProjection()});this.ovmap_.setView(n)}t.addChangeListener(ViewProperty.ROTATION,this.boundHandleRotationChanged_),this.handleRotationChanged_(),t.isDef()&&(this.ovmap_.updateSize(),this.resetExtent_())}unbindView_(t){t.removeChangeListener(ViewProperty.ROTATION,this.boundHandleRotationChanged_)}handleRotationChanged_(){this.rotateWithView_&&this.ovmap_.getView().setRotation(this.getMap().getView().getRotation())}validateExtent_(){const t=this.getMap(),n=this.ovmap_;if(!t.isRendered()||!n.isRendered())return;const s=t.getSize(),a=t.getView().calculateExtentInternal(s);if(this.viewExtent_&&equals$1(a,this.viewExtent_))return;this.viewExtent_=a;const h=n.getSize(),u=n.getView().calculateExtentInternal(h),d=n.getPixelFromCoordinateInternal(getTopLeft(a)),f=n.getPixelFromCoordinateInternal(getBottomRight(a)),g=Math.abs(d[0]-f[0]),_=Math.abs(d[1]-f[1]),m=h[0],p=h[1];g<m*MIN_RATIO||_<p*MIN_RATIO||g>m*MAX_RATIO||_>p*MAX_RATIO?this.resetExtent_():containsExtent(u,a)||this.recenter_()}resetExtent_(){const t=this.getMap(),n=this.ovmap_,s=t.getSize(),a=t.getView().calculateExtentInternal(s),h=n.getView(),c=Math.log(MAX_RATIO/MIN_RATIO)/Math.LN2,u=1/(Math.pow(2,c/2)*MIN_RATIO);scaleFromCenter(a,u),h.fitInternal(fromExtent(a))}recenter_(){const t=this.getMap(),n=this.ovmap_,s=t.getView();n.getView().setCenterInternal(s.getCenterInternal())}updateBox_(){const t=this.getMap(),n=this.ovmap_;if(!t.isRendered()||!n.isRendered())return;const s=t.getSize(),o=t.getView(),a=n.getView(),h=this.rotateWithView_?0:-o.getRotation(),c=this.boxOverlay_,u=this.boxOverlay_.getElement(),d=o.getCenter(),f=o.getResolution(),g=a.getResolution(),_=s[0]*f/g,m=s[1]*f/g;if(c.setPosition(d),u){u.style.width=_+"px",u.style.height=m+"px";const p="rotate("+h+"rad)";u.style.transform=p}}updateBoxAfterOvmapIsRendered_(){this.ovmapPostrenderKey_||(this.ovmapPostrenderKey_=listenOnce(this.ovmap_,MapEventType.POSTRENDER,t=>{delete this.ovmapPostrenderKey_,this.updateBox_()}))}handleClick_(t){t.preventDefault(),this.handleToggle_()}handleToggle_(){this.element.classList.toggle(CLASS_COLLAPSED),this.collapsed_?replaceNode(this.collapseLabel_,this.label_):replaceNode(this.label_,this.collapseLabel_),this.collapsed_=!this.collapsed_;const t=this.ovmap_;if(!this.collapsed_){if(t.isRendered()){this.viewExtent_=void 0,t.render();return}t.updateSize(),this.resetExtent_(),this.updateBoxAfterOvmapIsRendered_()}}getCollapsible(){return this.collapsible_}setCollapsible(t){this.collapsible_!==t&&(this.collapsible_=t,this.element.classList.toggle("ol-uncollapsible"),!t&&this.collapsed_&&this.handleToggle_())}setCollapsed(t){!this.collapsible_||this.collapsed_===t||this.handleToggle_()}getCollapsed(){return this.collapsed_}getRotateWithView(){return this.rotateWithView_}setRotateWithView(t){this.rotateWithView_!==t&&(this.rotateWithView_=t,this.getMap().getView().getRotation()!==0&&(this.rotateWithView_?this.handleRotationChanged_():this.ovmap_.getView().setRotation(0),this.viewExtent_=void 0,this.validateExtent_(),this.updateBox_()))}getOverviewMap(){return this.ovmap_}render(t){this.validateExtent_(),this.updateBox_()}}class ZoomToExtent extends Control{constructor(t){t=t||{},super({element:document.createElement("div"),target:t.target}),this.extent=t.extent?t.extent:null,this.fitOptions=t.fitOptions||{};const n=t.className!==void 0?t.className:"ol-zoom-extent",s=t.label!==void 0?t.label:"E",o=t.tipLabel!==void 0?t.tipLabel:"Fit to extent",a=document.createElement("button");a.setAttribute("type","button"),a.title=o,a.appendChild(typeof s=="string"?document.createTextNode(s):s),a.addEventListener(EventType$1.CLICK,this.handleClick_.bind(this),!1);const h=n+" "+CLASS_UNSELECTABLE+" "+CLASS_CONTROL,c=this.element;c.className=h,c.appendChild(a)}handleClick_(t){t.preventDefault(),this.handleZoomToExtent()}handleZoomToExtent(){const n=this.getMap().getView(),s=this.extent?fromUserExtent(this.extent,n.getProjection()):n.getProjection().getExtent();n.fitInternal(fromExtent(s),this.fitOptions)}}const PROJECTION="projection",COORDINATE_FORMAT="coordinateFormat";class MousePosition extends Control{constructor(t){t=t||{};const n=document.createElement("div");n.className=t.className!==void 0?t.className:"ol-mouse-position",super({element:n,render:t.render,target:t.target}),this.on,this.once,this.un,this.addChangeListener(PROJECTION,this.handleProjectionChanged_),t.coordinateFormat&&this.setCoordinateFormat(t.coordinateFormat),t.projection&&this.setProjection(t.projection),this.renderOnMouseOut_=t.placeholder!==void 0,this.placeholder_=this.renderOnMouseOut_?t.placeholder:"&#160;",this.renderedHTML_=n.innerHTML,this.mapProjection_=null,this.transform_=null,this.wrapX_=t.wrapX!==!1}handleProjectionChanged_(){this.transform_=null}getCoordinateFormat(){return this.get(COORDINATE_FORMAT)}getProjection(){return this.get(PROJECTION)}handleMouseMove(t){const n=this.getMap();this.updateHTML_(n.getEventPixel(t))}handleMouseOut(t){this.updateHTML_(null)}setMap(t){if(super.setMap(t),t){const n=t.getViewport();this.listenerKeys.push(listen(n,EventType.POINTERMOVE,this.handleMouseMove,this)),this.renderOnMouseOut_&&this.listenerKeys.push(listen(n,EventType.POINTEROUT,this.handleMouseOut,this)),this.updateHTML_(null)}}setCoordinateFormat(t){this.set(COORDINATE_FORMAT,t)}setProjection(t){this.set(PROJECTION,get$1(t))}updateHTML_(t){let n=this.placeholder_;if(t&&this.mapProjection_){if(!this.transform_){const a=this.getProjection();a?this.transform_=getTransformFromProjections(this.mapProjection_,a):this.transform_=identityTransform}const o=this.getMap().getCoordinateFromPixelInternal(t);if(o){if(this.transform_(o,o),this.wrapX_){const h=this.getProjection()||this.mapProjection_;wrapX$1(o,h)}const a=this.getCoordinateFormat();a?n=a(o):n=o.toString()}}(!this.renderedHTML_||n!==this.renderedHTML_)&&(this.element.innerHTML=n,this.renderedHTML_=n)}render(t){const n=t.frameState;n?this.mapProjection_!=n.viewState.projection&&(this.mapProjection_=n.viewState.projection,this.transform_=null):this.mapProjection_=null}}const Property$1={ACCURACY:"accuracy",ACCURACY_GEOMETRY:"accuracyGeometry",ALTITUDE:"altitude",ALTITUDE_ACCURACY:"altitudeAccuracy",HEADING:"heading",POSITION:"position",PROJECTION:"projection",SPEED:"speed",TRACKING:"tracking",TRACKING_OPTIONS:"trackingOptions"},GeolocationErrorType={ERROR:"error"};class GeolocationError extends BaseEvent{constructor(t){super(GeolocationErrorType.ERROR),this.code=t.code,this.message=t.message}}class Geolocation extends BaseObject{constructor(t){super(),this.on,this.once,this.un,t=t||{},this.position_=null,this.transform_=identityTransform,this.watchId_=void 0,this.addChangeListener(Property$1.PROJECTION,this.handleProjectionChanged_),this.addChangeListener(Property$1.TRACKING,this.handleTrackingChanged_),t.projection!==void 0&&this.setProjection(t.projection),t.trackingOptions!==void 0&&this.setTrackingOptions(t.trackingOptions),this.setTracking(t.tracking!==void 0?t.tracking:!1)}disposeInternal(){this.setTracking(!1),super.disposeInternal()}handleProjectionChanged_(){const t=this.getProjection();t&&(this.transform_=getTransformFromProjections(get$1("EPSG:4326"),t),this.position_&&this.set(Property$1.POSITION,this.transform_(this.position_)))}handleTrackingChanged_(){if("geolocation"in navigator){const t=this.getTracking();t&&this.watchId_===void 0?this.watchId_=navigator.geolocation.watchPosition(this.positionChange_.bind(this),this.positionError_.bind(this),this.getTrackingOptions()):!t&&this.watchId_!==void 0&&(navigator.geolocation.clearWatch(this.watchId_),this.watchId_=void 0)}}positionChange_(t){const n=t.coords;this.set(Property$1.ACCURACY,n.accuracy),this.set(Property$1.ALTITUDE,n.altitude===null?void 0:n.altitude),this.set(Property$1.ALTITUDE_ACCURACY,n.altitudeAccuracy===null?void 0:n.altitudeAccuracy),this.set(Property$1.HEADING,n.heading===null?void 0:toRadians(n.heading)),this.position_?(this.position_[0]=n.longitude,this.position_[1]=n.latitude):this.position_=[n.longitude,n.latitude];const s=this.transform_(this.position_);this.set(Property$1.POSITION,s.slice()),this.set(Property$1.SPEED,n.speed===null?void 0:n.speed);const o=circular(this.position_,n.accuracy);o.applyTransform(this.transform_),this.set(Property$1.ACCURACY_GEOMETRY,o),this.changed()}positionError_(t){this.dispatchEvent(new GeolocationError(t))}getAccuracy(){return this.get(Property$1.ACCURACY)}getAccuracyGeometry(){return this.get(Property$1.ACCURACY_GEOMETRY)||null}getAltitude(){return this.get(Property$1.ALTITUDE)}getAltitudeAccuracy(){return this.get(Property$1.ALTITUDE_ACCURACY)}getHeading(){return this.get(Property$1.HEADING)}getPosition(){return this.get(Property$1.POSITION)}getProjection(){return this.get(Property$1.PROJECTION)}getSpeed(){return this.get(Property$1.SPEED)}getTracking(){return this.get(Property$1.TRACKING)}getTrackingOptions(){return this.get(Property$1.TRACKING_OPTIONS)}setProjection(t){this.set(Property$1.PROJECTION,get$1(t))}setTracking(t){this.set(Property$1.TRACKING,t)}setTrackingOptions(t){this.set(Property$1.TRACKING_OPTIONS,t)}}class GeolocationControl extends Control{constructor(t){const n=t||{},s=document.createElement("div");s.className="geolocation ol-unselectable ol-control";const o=document.createElement("button");o.title="Show your location",o.innerHTML=n.buttonIcon?`
      <img src="${n.buttonIcon}" alt="Geolocation" />
    `:`
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><title>crosshairs-gps</title><path d="M12,8A4,4 0 0,1 16,12A4,4 0 0,1 12,16A4,4 0 0,1 8,12A4,4 0 0,1 12,8M3.05,13H1V11H3.05C3.5,6.83 6.83,3.5 11,3.05V1H13V3.05C17.17,3.5 20.5,6.83 20.95,11H23V13H20.95C20.5,17.17 17.17,20.5 13,20.95V23H11V20.95C6.83,20.5 3.5,17.17 3.05,13M12,5A7,7 0 0,0 5,12A7,7 0 0,0 12,19A7,7 0 0,0 19,12A7,7 0 0,0 12,5Z" /></svg>
    `,s.appendChild(o),super({element:s}),this._centerWhenReady=n.centerWhenReady,this._highAccuracy=n.highAccuracy,this._trackAccuracy=n.trackAccuracy,this._trackHeading=n.trackHeading,this._positionFeature=new Feature({geometry:new Point([NaN,NaN]),heading:0}),this._source=new VectorSource({features:[this._positionFeature]}),this._trackAccuracy&&(this._accuracyFeature=new Feature,this._accuracyFeature.setStyle(new Style({fill:new Fill({color:"rgba(0, 0, 0, 0.2)"}),stroke:new Stroke({width:2,color:"rgba(0, 0, 0, 0.7)"})})),this._source.addFeature(this._accuracyFeature)),this._layer=new VectorLayer({source:this._source}),n.style&&this._layer.setStyle(n.style),o.addEventListener("click",this.centerOnPosition.bind(this),!1)}setMap(t){this._layer.setMap(t),super.setMap(t),t&&this._centerWhenReady&&this.initGeolocation()}initGeolocation(){return new Promise((t,n)=>{const s=this.getMap();s&&(this._geolocation=new Geolocation({tracking:!0,trackingOptions:{enableHighAccuracy:this._highAccuracy},projection:s.getView().getProjection()})),this._centerWhenReady&&this._geolocation.once("change:position",o=>{s.getView().setCenter(o.target.getPosition())}),this._geolocation.on("error",o=>n(o)),this._geolocation.on("change:accuracyGeometry",()=>{this._trackAccuracy&&this._accuracyFeature.setGeometry(this._geolocation.getAccuracyGeometry())}),this._geolocation.on("change:heading",o=>{this._trackHeading&&this._highAccuracy&&this._positionFeature.set("heading",o.target.getHeading())}),this._geolocation.on("change:position",()=>{const o=this._geolocation.getPosition();this._positionFeature.getGeometry().setCoordinates(o||null),t(o)})})}getElement(){return this.element}async centerOnPosition(){var t,n;try{await this.initGeolocation();const s=(t=this._geolocation)==null?void 0:t.getPosition();s&&((n=this.getMap())==null||n.getView().setCenter(s))}catch(s){console.error(s)}}}class LoadingIndicatorControl extends Control{constructor(t){const n=t||{};n.opacity===void 0&&(n.opacity=1),n.type===void 0&&(n.type="small");const s=document.createElement("div");s.className="LoadingIndicator ol-unselectable ol-control",s.classList.add("loading-indicator"),s.style.opacity=String(n.opacity),n.spinnerSvg?s.innerHTML=n.spinnerSvg:s.innerHTML=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid" width="50" height="50" style="shape-rendering: auto; display: block; background: transparent;" xmlns:xlink="http://www.w3.org/1999/xlink"><g><circle stroke-dasharray="164.93361431346415 56.97787143782138" r="35" stroke-width="12" stroke="#1a467c" fill="none" cy="50" cx="50">
      <animateTransform keyTimes="0;1" values="0 50 50;360 50 50" dur="1.2222222222222223s" repeatCount="indefinite" type="rotate" attributeName="transform"></animateTransform>
      </circle></g></svg>`,n.type==="fullscreen"?s.classList.add("fullscreen"):s.classList.add("small"),super({element:s})}setMap(t){super.setMap(t),t&&(t.on("loadstart",()=>{this.getElement().style.visibility="visible"}),t.on("loadend",()=>{this.getElement().style.visibility="hidden"}))}getElement(){return this.element}}const availableControls={Zoom,Rotate,ScaleLine,FullScreen,ZoomSlider,Attribution,OverviewMap,ZoomToExtent,MousePosition,Geolocation:GeolocationControl,LoadingIndicator:LoadingIndicatorControl};function addOrUpdateControl(l,t,n,s){t&&t[n]?serialize$1(t[n])!==serialize$1(s)&&(l.removeControl(n),addControl(l,n,s)):addControl(l,n,s)}function addControl(l,t,n){const s=Object.assign({},n);n&&n.layers&&(s.layers=generateLayers(l,n.layers));const o=new availableControls[t](s);l.map.addControl(o),l.mapControls[t]=o}function setCenterMethod(l,t){let n;const s=(l==null?void 0:l.length)&&coordinatesRoughlyEquals(l,t.map.getView().getCenter());return l&&!s&&(!t.projection||t.projection==="EPSG:3857"?n=getCenterFromProperty(l):n=l),n}function setZoomExtentMethod(l,t){if(!l||!l.length)return;const n=t.map.getView();return cancelAnimation(n),setTimeout(()=>n.fit(l,t.animationOptions),0),l}function setControlsMethod(l,t,n){const s=l;if(t){const o=Object.keys(t),a=Object.keys(s);for(let h=0,c=o.length;h<c;h++){const u=o[h];a.includes(u)||n.removeControl(u)}}if(s){const o=Object.keys(l);for(let a=0,h=o.length;a<h;a++){const c=o[a];addOrUpdateControl(n,t,c,l[c])}}return s}function setLayersMethod(layers,oldLayers,EOxMap){const newLayers=eval("("+serialize$1(layers)+")");oldLayers&&oldLayers.forEach(l=>{var t,n;if(!((t=l.properties)!=null&&t.id)||!newLayers.find(s=>s.properties.id===l.properties.id)){const s=getLayerById(EOxMap,(n=l.properties)==null?void 0:n.id),a=s.get("_jsonDefinition").interactions;a==null||a.forEach(h=>{h.type==="select"?EOxMap.removeSelect(h.options.id):EOxMap.removeInteraction(h.options.id)}),EOxMap.map.removeLayer(s)}}),newLayers.forEach(l=>{EOxMap.addOrUpdateLayer(l)});const sortedIds=newLayers.map(l=>{var t;return(t=l.properties)==null?void 0:t.id});EOxMap.map.getLayers().getArray().sort((l,t)=>sortedIds.indexOf(l.get("id"))-sortedIds.indexOf(t.get("id")));let minMax=EOxMap.map.getLayers().getArray().reduce((l,t)=>{var n,s,o,a,h,c,u,d;return l.maxZoom=(s=(n=EOxMap.config)==null?void 0:n.view)!=null&&s.maxZoom?(a=(o=EOxMap.config)==null?void 0:o.view)==null?void 0:a.maxZoom:l.maxZoom===void 0||t.get("maxZoom")<l.maxZoom?t.get("maxZoom"):l.maxZoom,l.minZoom=(c=(h=EOxMap.config)==null?void 0:h.view)!=null&&c.minZoom?(d=(u=EOxMap.config)==null?void 0:u.view)==null?void 0:d.minZoom:l.minZoom===void 0||t.get("minZoom")>l.minZoom?t.get("minZoom"):l.minZoom,l},{minZoom:0,maxZoom:1/0});EOxMap.map.getLayers().getArray().map(l=>l.setMinZoom(l.get("minZoom")-1e-12));const currentMinZoom=EOxMap.map.getView().getMinZoom(),currentMaxZoom=EOxMap.map.getView().getMaxZoom();return currentMinZoom!==minMax.minZoom&&EOxMap.map.getView().setMinZoom(minMax.minZoom>=0?minMax.minZoom:0),currentMaxZoom!==minMax.maxZoom&&EOxMap.map.getView().setMaxZoom(minMax.maxZoom),EOxMap.map.on("moveend",()=>{var n;if(!((n=EOxMap==null?void 0:EOxMap.controls)!=null&&n.Zoom))return;const l=EOxMap.renderRoot.querySelector("button.ol-zoom-out"),t=EOxMap.renderRoot.querySelector("button.ol-zoom-in");EOxMap.map.getView().getZoom()>=minMax.maxZoom?t==null||t.classList.add("disabled"):t==null||t.classList.remove("disabled"),EOxMap.map.getView().getZoom()-1e-12<=minMax.minZoom?l==null||l.classList.add("disabled"):l==null||l.classList.remove("disabled")}),newLayers}function setPreventScrollMethod(l,t){return l?(removeDefaultScrollInteractions(t.map),addScrollInteractions(t.map,!0)):addScrollInteractions(t.map),l}function setConfigMethod(l,t){var n,s,o,a,h,c,u,d;return Object.assign(t,{...(l==null?void 0:l.animationOptions)!==void 0?{animationOptions:l.animationOptions}:{},projection:((n=l==null?void 0:l.view)==null?void 0:n.projection)||"EPSG:3857",layers:(l==null?void 0:l.layers)||[],controls:(l==null?void 0:l.controls)||{},...(l==null?void 0:l.preventScroll)!==void 0&&t.preventScroll===void 0?{preventScroll:l==null?void 0:l.preventScroll}:{},zoom:((s=l==null?void 0:l.view)==null?void 0:s.zoom)||0,center:((o=l==null?void 0:l.view)==null?void 0:o.center)||[0,0],zoomExtent:(a=l==null?void 0:l.view)==null?void 0:a.zoomExtent}),(h=l==null?void 0:l.view)!=null&&h.minZoom&&t.map.getView().setMinZoom((c=l==null?void 0:l.view)==null?void 0:c.minZoom),(u=l==null?void 0:l.view)!=null&&u.maxZoom&&t.map.getView().setMaxZoom((d=l==null?void 0:l.view)==null?void 0:d.maxZoom),l}function setProjectionMethod(l,t,n){let s=t;const o=n.map.getView();if(l&&get$1(l)&&l!==o.getProjection().getCode()){const a=transform$1(o.getCenter(),o.getProjection().getCode(),l),h=get$1(l),c=o.getResolution(),u=o.getProjection().getMetersPerUnit(),d=h.getMetersPerUnit(),f=getPointResolution(o.getProjection(),1/u,o.getCenter(),"m")*u,g=getPointResolution(h,1/d,a,"m")*d,_=c*f/g,m=new View({zoom:o.getZoom(),center:a,resolution:_,rotation:o.getRotation(),projection:l});["change:center","change:resolution","change:rotation","propertychange"].forEach(x=>{const y=o.getListeners(x);if(y!=null&&y.length)for(let T=y.length-1;T>=0;T--){const S=y[T];o.un(x,S),m.on(x,S)}}),n.map.setView(m),n.getFlatLayersArray(n.map.getLayers().getArray()).filter(x=>x instanceof VectorLayer).forEach(x=>x.getSource().refresh()),s=l,n.center=a}return s}function setSyncMethod(l,t){return l&&setTimeout(()=>{const n=getElement(l);n&&(t.clientHeight<1&&!n.zoom?n.map.setView(t.map.getView()):t.map.setView(n.map.getView()))}),l}function getLonLatCenterMethod(l){var t;if(l.projection==="globe"){const n=(t=l.globe)==null?void 0:t.planet.camera.getLonLat();return[(n==null?void 0:n.lon)??0,(n==null?void 0:n.lat)??0]}return l.projection==="EPSG:4326"?l.map.getView().getCenter():transform(l.map.getView().getCenter(),l.projection)}function getLonLatExtentMethod(l){var n;if(l.projection==="globe"){const s=(n=l.globe)==null?void 0:n.planet.camera.getLonLat();if(!s||typeof s.height>"u")return[-180,-90,180,90];const o=Math.log2(2705e4/s.height)+1,a=[s.lon,s.lat],h=new View({zoom:o,center:transform(a,"EPSG:4326",l.projection),projection:l.projection});return h.setCenter(transform(a,"EPSG:4326",l.projection)),transformExtent(h.calculateExtent(l.map.getSize()),l.projection)}const t=l.map.getView().calculateExtent(l.map.getSize());return l.projection==="EPSG:4326"?t:transformExtent(t,l.projection)}function getZoomExtentMethod(l){return l.map.getView().calculateExtent(l.map.getSize())}function addOrUpdateLayerMethod(l,t){var a;l.interactions||(l.interactions=[]);const n=(a=l.properties)==null?void 0:a.id,s=n?getLayerById(t,n):!1;let o;return s?(updateLayer(t,l,s),o=s):(o=createLayer$1(t,l),t.map.addLayer(o)),o}function removeInteractionMethod(l,t){t.map.removeInteraction(t.interactions[l]),delete t.interactions[l],t.interactions[`${l}_modify`]&&(t.map.removeInteraction(t.interactions[`${l}_modify`]),delete t.interactions[`${l}_modify`])}function removeSelectMethod(l,t){t.selectInteractions[l].remove(),delete t.selectInteractions[l]}function removeControlMethod(l,t){t.map.removeControl(t.mapControls[l]),delete t.mapControls[l]}function firstUpdatedMethod(l,t){t.map.once("change:target",s=>{s.target.getView().setCenter(t.center)});const n=t.renderRoot.querySelector("div#map");t.map.setTarget(n),l?t.map.getView().fit(l,t.animationOptions):animateToStateMethod(t),t.map.on("loadend",()=>{t.dispatchEvent(new CustomEvent("loadend",{detail:t.map}))}),t.dispatchEvent(new CustomEvent("mapmounted",{detail:t.map}))}const Xi=2*Math.PI,vo=Math.PI/2,or=Number.MAX_VALUE||17976931348623157e292,pn=Math.log(2),Ae=2147483647,xt=549755748352,Ct=-549755748352,j=Math.PI/180,J=180/Math.PI,Gr=2*J,Qt=.5*j,yo=Math.sqrt(.5),xo=1e-5,ne=1e-10,ar=1e-12,lr=1e-14;function Zi(l,t,n){return Math.max(t,Math.min(l,n))}function Ki(l){return!(l&l-1)}function $e(l,t=4096){--l;for(let n=1;n<32;n<<=1)l|=l>>n;return l+1>t?t:l+1}function Ni(l=0,t=1){return Math.floor(Math.random()*(t-l))+l}function bo(l,t){return(l%t+t)%t}function Ue(l){const t=bo(l,Xi);return Math.abs(t)<lr&&Math.abs(l)>lr?Xi:t}function si(l){const t=Math.abs(l);return t-Math.floor(t)}function wo(l,t,n){return n+l*(t-n)}function Hs(l){return l*l*l}function Vs(l){return l*l}function hr(l){return l-360*Math.floor(l/360)}Object.freeze(Object.defineProperty({__proto__:null,ARCSECONDS_TO_RADIANS:484813681109536e-20,DEG2RAD:function(l){return l*j},DEGREES:J,DEGREES_DOUBLE:Gr,DEGREES_TO_HOURS:1/15,EPS1:.1,EPS10:ne,EPS11:1e-11,EPS12:ar,EPS13:1e-13,EPS14:lr,EPS15:1e-15,EPS16:1e-16,EPS17:1e-17,EPS18:1e-18,EPS19:1e-19,EPS2:.01,EPS20:1e-20,EPS3:.001,EPS4:1e-4,EPS5:xo,EPS6:1e-6,EPS7:1e-7,EPS8:1e-8,EPS9:1e-9,HOURS_TO_DEGREES:15,HOURS_TO_RADIANS:.26179938779914946,LOG2:pn,MAX:xt,MAX32:Ae,MAX_FLOAT:or,MIN:Ct,PI_TWO:vo,RAD2DEG:function(l){return l*J},RADIANS:j,RADIANS_HALF:Qt,RADIANS_TO_HOURS:3.819718634205488,SQRT_HALF:yo,TWO_PI:Xi,W:3,X:0,Y:1,Z:2,bezier1v:function(l,t,n,s,o){return Hs(1-l)*t+3*Vs(1-l)*l*n+3*(1-l)*Vs(l)*s+Hs(l)*o},bezier3v:function(l,t,n,s,o){let a=1-l,h=l*l,c=a*a,u=c*a,d=h*l;return t.scaleTo(u).addA(n.scaleTo(3*c*l)).addA(s.scaleTo(3*a*h)).addA(o.scaleTo(d))},clamp:Zi,cube:Hs,degToDec:function(l,t,n,s){return s?l+t/60+n/3600:-l-t/60-n/3600},exp2:function(l){return Math.pow(2,l)},frac:si,getAngleBetweenAzimuths:function(l,t){return(((l=Ue(l))-(t=Ue(t)))%360+360+180)%360-180},isPowerOfTwo:Ki,lerp:wo,log:function(l,t){return Math.log(l)/Math.log(t)},log2:function(l){return Math.log(l)/pn},mod:bo,negativePItoPI:function(l){return Ue(l+Math.PI)-Math.PI},nextHighestPowerOfTwo:$e,norm_lon:function(l){return l>180?(l+180)%360-180:l<-180?(l-180)%360+180:l},pow2i:function(l){return 2<<l-1},random:function(l=0,t=1){return Math.random()*(t-l)+l},randomi:Ni,rev:hr,slice:function(l,t,n){return l*(t-n)},solve_iteration:function(l,t,n,s=50){let o=0,a=t;for(let h=0;h<s;h++)if(o=a,a=l(o),Math.abs(a-o)<n)return a;return a},solve_iteration_fixed:function(l,t,n){let s=0,o=t;for(let a=0;a<n;a++)s=o,o=l(s);return o},square:Vs,step:function(l,t){return t<l?0:1},zeroTwoPI:Ue},Symbol.toStringTag,{value:"Module"}));const Ba=.5*Math.PI,To=180/Math.PI,ka=2*To,Us=Math.PI/360,Ia=To*Ba;class L{constructor(t=0,n=0,s=0){this.lon=0,this.lat=0,this.height=0,this.lon=t,this.lat=n,this.height=s}isZero(){return this.lon===0&&this.lat===0&&this.height===0}static join(t){let n=[];for(let s=0;s<t.length;s++){let o=t[s];n[s]=new L(o[0],o[1],o[2])}return n}static createFromArray(t){return new L(t[0],t[1],t[2])}static toArray(t){return[t.lon,t.lat,t.height]}toArray(){return L.toArray(this)}static forwardMercator(t,n,s){return new L(t*Hi,Math.log(Math.tan((90+n)*Us))*We,s)}static forwardMercatorRes(t,n){return n.lon=t.lon*Hi,n.lat=Math.log(Math.tan((90+t.lat)*Us))*We,n.height=t.height,n}static inverseMercator(t,n,s=0){return new L(t*Co,ka*Math.atan(Math.exp(n*jr))-Ia,s)}set(t=0,n=0,s=0){return this.lon=t,this.lat=n,this.height=s,this}copy(t){return this.lon=t.lon,this.lat=t.lat,this.height=t.height,this}clone(){return new L(this.lon,this.lat,this.height)}forwardMercator(){return L.forwardMercator(this.lon,this.lat,this.height)}forwardMercatorEPS01(){let t=this.lat;return t>89.9?t=89.9:t<-89.9&&(t=-89.9),new L(this.lon*Hi,Math.log(Math.tan((90+t)*Us))*We)}inverseMercator(){return L.inverseMercator(this.lon,this.lat,this.height)}equal(t){return t.height?this.lon===t.lon&&this.lat===t.lat&&this.height===t.height:this.lon===t.lon&&this.lat===t.lat}}const Lt=2003750834e-2,Qi=2*Lt,jr=Math.PI/Lt,We=Lt/Math.PI,za=.5*Math.PI,Hi=Lt/180,Co=180/Lt,Eo=Math.PI/360,mn=Math.PI/180,Da=180/Math.PI,Ao=2*Lt,ri=1/Ao;function Ji(l){return new L(l.lon*Lt/180,Math.log(Math.tan((90+l.lat)*Eo))*We,l.height)}function ni(l){return l*Lt/180}function oi(l){return Math.log(Math.tan((90+l)*Eo))*We}function Lo(l){return Da*(2*Math.atan(Math.exp(l*jr))-za)}function Ze(l,t,n){let s=Qi/(1<<n),o=new L(l*s-2003750834e-2,Lt-t*s-s);return new U(o,new L(o.lon+s,o.lat+s))}const ct=Lo(Lt),Ot=-ct;Object.freeze(Object.defineProperty({__proto__:null,INV_POLE_BY_180:Co,MAX_LAT:ct,MIN_LAT:Ot,ONE_BY_POLE_DOUBLE:ri,PI_BY_POLE:jr,POLE:Lt,POLE2:Qi,POLE_BY_180:Hi,POLE_BY_PI:We,POLE_DOUBLE:Ao,forward:Ji,forwardArray:function(l){let t=[];for(let n=0;n<l.length;n++)t.push(l[n].forwardMercator());return t},forward_lat:oi,forward_lon:ni,getTileExtent:Ze,getTileX:function(l,t){return Math.floor((l+180)/360*Math.pow(2,t))},getTileY:function(l,t){return Math.floor(.5*(1-Math.log(Math.tan(l*mn)+1/Math.cos(l*mn))/Math.PI)*Math.pow(2,t))},inverse_lat:Lo,inverse_lon:function(l){return 180*l/Lt}},Symbol.toStringTag,{value:"Module"}));class U{constructor(t=new L,n=new L){this.southWest=t,this.northEast=n}static createFromArray(t){return new U(new L(t[0],t[1]),new L(t[2],t[3]))}static createByCoordinates(t){let n=xt,s=Ct,o=xt,a=Ct;for(let h=0;h<t.length;h++){const c=t[h];c.lon<n&&(n=c.lon),c.lon>s&&(s=c.lon),c.lat<o&&(o=c.lat),c.lat>a&&(a=c.lat)}return new U(new L(n,o),new L(s,a))}static createByCoordinatesArr(t){let n=xt,s=Ct,o=xt,a=Ct;for(let h=0;h<t.length;h++){const c=t[h];c[0]<n&&(n=c[0]),c[0]>s&&(s=c[0]),c[1]<o&&(o=c[1]),c[1]>a&&(a=c[1])}return new U(new L(n,o),new L(s,a))}static fromTile(t,n,s,o=4007501668e-2,a=4007501668e-2){const h=1<<s,c=o/h,u=a/h,d=.5*-o+t*c,f=.5*a-n*u,g=d+c;return new U(new L(d,f-u),new L(g,f))}setByCoordinates(t){let n=xt,s=Ct,o=xt,a=Ct;for(let h=0;h<t.length;h++){const c=t[h];c.lon<n&&(n=c.lon),c.lon>s&&(s=c.lon),c.lat<o&&(o=c.lat),c.lat>a&&(a=c.lat)}return this.southWest.lon=n,this.southWest.lat=o,this.northEast.lon=s,this.northEast.lat=a,this}isInside(t){const n=this.southWest,s=this.northEast;return t.lon>=n.lon&&t.lon<=s.lon&&t.lat>=n.lat&&t.lat<=s.lat}overlaps(t){const n=this.southWest,s=this.northEast;return n.lon<=t.northEast.lon&&s.lon>=t.southWest.lon&&n.lat<=t.northEast.lat&&s.lat>=t.southWest.lat}getWidth(){return this.northEast.lon-this.southWest.lon}getHeight(){return this.northEast.lat-this.southWest.lat}clone(){return new U(this.southWest.clone(),this.northEast.clone())}getCenter(){const t=this.southWest,n=this.northEast;return new L(t.lon+.5*(n.lon-t.lon),t.lat+.5*(n.lat-t.lat))}getNorthWest(){return new L(this.southWest.lon,this.northEast.lat)}getNorthEast(){return new L(this.northEast.lon,this.northEast.lat)}getSouthWest(){return new L(this.southWest.lon,this.southWest.lat)}getSouthEast(){return new L(this.northEast.lon,this.southWest.lat)}getNorth(){return this.northEast.lat}getEast(){return this.northEast.lon}getWest(){return this.southWest.lon}getSouth(){return this.southWest.lat}equals(t){return this.southWest.lon===t.southWest.lon&&this.southWest.lat===t.southWest.lat&&this.northEast.lon===t.northEast.lon&&this.northEast.lat===t.northEast.lat}forwardMercator(){return new U(this.southWest.forwardMercator(),this.northEast.forwardMercator())}inverseMercator(){return new U(this.southWest.inverseMercator(),this.northEast.inverseMercator())}getCartesianBounds(t){let n=xt,s=Ct,o=xt,a=Ct,h=xt,c=Ct;const u=[new L(this.southWest.lon,this.southWest.lat),new L(this.southWest.lon,this.northEast.lat),new L(this.northEast.lon,this.northEast.lat),new L(this.northEast.lon,this.southWest.lat)];for(let d=0;d<u.length;d++){const f=t.lonLatToCartesian(u[d]),g=f.x,_=f.y,m=f.z;g<n&&(n=g),g>s&&(s=g),_<o&&(o=_),_>a&&(a=_),m<h&&(h=m),m>c&&(c=m)}return[n,o,h,s,a,c]}toString(){return`[${this.southWest.lon.toFixed(5)}, ${this.southWest.lat.toFixed(5)}, ${this.northEast.lon.toFixed(5)}, ${this.northEast.lat.toFixed(5)}]`}}class Se{constructor(){this._m=[0,0,0,0,0,0,0,0,0]}set(t){return this._m[0]=t[0],this._m[1]=t[1],this._m[2]=t[2],this._m[3]=t[3],this._m[4]=t[4],this._m[5]=t[5],this._m[6]=t[6],this._m[7]=t[7],this._m[8]=t[8],this}clone(){let t=new Se;return t.set(this._m),t}copy(t){return this.set(t._m)}transposeTo(){let t=new Se,n=this._m;return t._m[0]=n[0],t._m[1]=n[3],t._m[2]=n[6],t._m[3]=n[1],t._m[4]=n[4],t._m[5]=n[7],t._m[6]=n[2],t._m[7]=n[5],t._m[8]=n[8],t}setIdentity(){return this._m[0]=1,this._m[1]=0,this._m[2]=0,this._m[3]=0,this._m[4]=1,this._m[5]=0,this._m[6]=0,this._m[7]=0,this._m[8]=1,this}mulVec(t){let n=t.x,s=t.y,o=t.z,a=this._m;return new v(a[0]*n+a[3]*s+a[6]*o,a[1]*n+a[4]*s+a[7]*o,a[2]*n+a[5]*s+a[8]*o)}getMat4(){let t=new tt,n=t._m,s=this._m;return n[0]=s[0],n[1]=s[1],n[2]=s[2],n[3]=0,n[4]=s[3],n[5]=s[4],n[6]=s[5],n[7]=0,n[8]=s[6],n[9]=s[7],n[10]=s[8],n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,t}}class et{constructor(t=0,n=0,s=0,o=0){this.x=t,this.y=n,this.z=s,this.w=o}static get identity(){return new et(0,0,0,1)}static fromVec(t){return new et(t[0],t[1],t[2],t[3])}toVec3(){return new v(this.x,this.y,this.z)}clone(){return new et(this.x,this.y,this.z,this.w)}equal(t){return this.x===t.x&&this.y===t.y&&this.z===t.z&&this.w===t.w}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this}toArray(){return[this.x,this.y,this.z,this.w]}toArray3(){return[this.x,this.y,this.z]}set(t,n,s,o){return this.x=t,this.y=n,this.z=s,this.w=o,this}addA(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this.w+=t.w,this}subA(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this.w-=t.w,this}scale(t){return this.x*=t,this.y*=t,this.z*=t,this.w*=t,this}affinity(){let t=1/this.w;return this.x*=t,this.y*=t,this.z*=t,this.w=1,this}scaleTo(t){return new et(this.x*t,this.y*t,this.z*t,this.w*t)}getStep(t){return new et(this.x<t?0:1,this.y<t?0:1,this.z<t?0:1,this.w<t?0:1)}getFrac(t){return new et(si(t.x),si(t.y),si(t.z),si(t.w))}dot(t){return t.x*this.x+t.y*this.y+t.z*this.z+t.w*this.w}isZero(){return!(this.x||this.y||this.z||this.w)}}class tt{constructor(){this._m=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]}static identity(){let t=new tt;return t._m[0]=1,t._m[1]=0,t._m[2]=0,t._m[3]=0,t._m[4]=0,t._m[5]=1,t._m[6]=0,t._m[7]=0,t._m[8]=0,t._m[9]=0,t._m[10]=1,t._m[11]=0,t._m[12]=0,t._m[13]=0,t._m[14]=0,t._m[15]=1,t}static getRotationAroundPoint(t,n=v.ZERO,s=v.UP){let o=tt.getRotation(t,s),a=new tt().setIdentity().translate(n),h=new tt().setIdentity().translate(n.negateTo());return a.mul(o).mul(h)}static getRotation(t,n=v.UP){return new tt().setRotation(n,t)}getPosition(){return new v(this._m[12],this._m[13],this._m[14])}getScaling(){let t=this._m[0],n=this._m[1],s=this._m[2],o=this._m[4],a=this._m[5],h=this._m[6],c=this._m[8],u=this._m[9],d=this._m[10];return new v(Math.sqrt(t*t+n*n+s*s),Math.sqrt(o*o+a*a+h*h),Math.sqrt(c*c+u*u+d*d))}getQuat(){let t=this.getScaling();const n=[0,0,0,1];let s=1/t.x,o=1/t.y,a=1/t.z,h=this._m[0]*s,c=this._m[1]*o,u=this._m[2]*a,d=this._m[4]*s,f=this._m[5]*o,g=this._m[6]*a,_=this._m[8]*s,m=this._m[9]*o,p=this._m[10]*a,x=h+f+p,y=0;return x>0?(y=2*Math.sqrt(x+1),n[3]=.25*y,n[0]=(g-m)/y,n[1]=(_-u)/y,n[2]=(c-d)/y):h>f&&h>p?(y=2*Math.sqrt(1+h-f-p),n[3]=(g-m)/y,n[0]=.25*y,n[1]=(c+d)/y,n[2]=(_+u)/y):f>p?(y=2*Math.sqrt(1+f-h-p),n[3]=(_-u)/y,n[0]=(c+d)/y,n[1]=.25*y,n[2]=(g+m)/y):(y=2*Math.sqrt(1+p-h-f),n[3]=(c-d)/y,n[0]=(_+u)/y,n[1]=(g+m)/y,n[2]=.25*y),new F(...n)}set(t){return this._m[0]=t[0],this._m[1]=t[1],this._m[2]=t[2],this._m[3]=t[3],this._m[4]=t[4],this._m[5]=t[5],this._m[6]=t[6],this._m[7]=t[7],this._m[8]=t[8],this._m[9]=t[9],this._m[10]=t[10],this._m[11]=t[11],this._m[12]=t[12],this._m[13]=t[13],this._m[14]=t[14],this._m[15]=t[15],this}clone(){let t=new tt;return t.set(this._m),t}copy(t){return this.set(t._m)}getMat3(){let t=new Se,n=this._m,s=t._m;return s[0]=n[0],s[1]=n[1],s[2]=n[2],s[3]=n[4],s[4]=n[5],s[5]=n[6],s[6]=n[8],s[7]=n[9],s[8]=n[10],t}mulVec3(t){let n=t.x,s=t.y,o=t.z;return new v(this._m[0]*n+this._m[4]*s+this._m[8]*o+this._m[12],this._m[1]*n+this._m[5]*s+this._m[9]*o+this._m[13],this._m[2]*n+this._m[6]*s+this._m[10]*o+this._m[14])}mulVec4(t){let n=t.x,s=t.y,o=t.z,a=t.w;return new et(this._m[0]*n+this._m[4]*s+this._m[8]*o+this._m[12]*a,this._m[1]*n+this._m[5]*s+this._m[9]*o+this._m[13]*a,this._m[2]*n+this._m[6]*s+this._m[10]*o+this._m[14]*a,this._m[3]*n+this._m[7]*s+this._m[11]*o+this._m[15]*a)}toInverseMatrix3(){let t=this._m,n=t[0],s=t[1],o=t[2],a=t[4],h=t[5],c=t[6],u=t[8],d=t[9],f=t[10],g=f*h-c*d,_=-f*a+c*u,m=d*a-h*u,p=n*g+s*_+o*m;if(!p)return;p=1/p;let x=new Se;return x._m[0]=g*p,x._m[1]=(-f*s+o*d)*p,x._m[2]=(c*s-o*h)*p,x._m[3]=_*p,x._m[4]=(f*n-o*u)*p,x._m[5]=(-c*n+o*a)*p,x._m[6]=m*p,x._m[7]=(-d*n+s*u)*p,x._m[8]=(h*n-s*a)*p,x}inverseTo(t=new tt){let n=this._m[0],s=this._m[1],o=this._m[2],a=this._m[3],h=this._m[4],c=this._m[5],u=this._m[6],d=this._m[7],f=this._m[8],g=this._m[9],_=this._m[10],m=this._m[11],p=this._m[12],x=this._m[13],y=this._m[14],T=this._m[15],S=n*c-s*h,C=n*u-o*h,P=n*d-a*h,w=s*u-o*c,I=s*d-a*c,O=o*d-a*u,N=f*x-g*p,k=f*y-_*p,D=f*T-m*p,ze=g*y-_*x,z=g*T-m*x,Ee=_*T-m*y,B=1/(S*Ee-C*z+P*ze+w*D-I*k+O*N);return t._m[0]=(c*Ee-u*z+d*ze)*B,t._m[1]=(-s*Ee+o*z-a*ze)*B,t._m[2]=(x*O-y*I+T*w)*B,t._m[3]=(-g*O+_*I-m*w)*B,t._m[4]=(-h*Ee+u*D-d*k)*B,t._m[5]=(n*Ee-o*D+a*k)*B,t._m[6]=(-p*O+y*P-T*C)*B,t._m[7]=(f*O-_*P+m*C)*B,t._m[8]=(h*z-c*D+d*N)*B,t._m[9]=(-n*z+s*D-a*N)*B,t._m[10]=(p*I-x*P+T*S)*B,t._m[11]=(-f*I+g*P-m*S)*B,t._m[12]=(-h*ze+c*k-u*N)*B,t._m[13]=(n*ze-s*k+o*N)*B,t._m[14]=(-p*w+x*C-y*S)*B,t._m[15]=(f*w-g*C+_*S)*B,t}transposeTo(){let t=new tt;return t._m[0]=this._m[0],t._m[1]=this._m[4],t._m[2]=this._m[8],t._m[3]=this._m[12],t._m[4]=this._m[1],t._m[5]=this._m[5],t._m[6]=this._m[9],t._m[7]=this._m[13],t._m[8]=this._m[2],t._m[9]=this._m[6],t._m[10]=this._m[10],t._m[11]=this._m[14],t._m[12]=this._m[3],t._m[13]=this._m[7],t._m[14]=this._m[11],t._m[15]=this._m[15],t}setIdentity(){return this._m[0]=1,this._m[1]=0,this._m[2]=0,this._m[3]=0,this._m[4]=0,this._m[5]=1,this._m[6]=0,this._m[7]=0,this._m[8]=0,this._m[9]=0,this._m[10]=1,this._m[11]=0,this._m[12]=0,this._m[13]=0,this._m[14]=0,this._m[15]=1,this}mul(t){let n=this._m[0],s=this._m[1],o=this._m[2],a=this._m[3],h=this._m[4],c=this._m[5],u=this._m[6],d=this._m[7],f=this._m[8],g=this._m[9],_=this._m[10],m=this._m[11],p=this._m[12],x=this._m[13],y=this._m[14],T=this._m[15],S=t._m[0],C=t._m[1],P=t._m[2],w=t._m[3],I=t._m[4],O=t._m[5],N=t._m[6],k=t._m[7],D=t._m[8],ze=t._m[9],z=t._m[10],Ee=t._m[11],B=t._m[12],rt=t._m[13],wt=t._m[14],re=t._m[15],mt=new tt;return mt._m[0]=S*n+C*h+P*f+w*p,mt._m[1]=S*s+C*c+P*g+w*x,mt._m[2]=S*o+C*u+P*_+w*y,mt._m[3]=S*a+C*d+P*m+w*T,mt._m[4]=I*n+O*h+N*f+k*p,mt._m[5]=I*s+O*c+N*g+k*x,mt._m[6]=I*o+O*u+N*_+k*y,mt._m[7]=I*a+O*d+N*m+k*T,mt._m[8]=D*n+ze*h+z*f+Ee*p,mt._m[9]=D*s+ze*c+z*g+Ee*x,mt._m[10]=D*o+ze*u+z*_+Ee*y,mt._m[11]=D*a+ze*d+z*m+Ee*T,mt._m[12]=B*n+rt*h+wt*f+re*p,mt._m[13]=B*s+rt*c+wt*g+re*x,mt._m[14]=B*o+rt*u+wt*_+re*y,mt._m[15]=B*a+rt*d+wt*m+re*T,mt}translate(t){let n=t.x,s=t.y,o=t.z,a=this._m;return a[12]=a[0]*n+a[4]*s+a[8]*o+a[12],a[13]=a[1]*n+a[5]*s+a[9]*o+a[13],a[14]=a[2]*n+a[6]*s+a[10]*o+a[14],a[15]=a[3]*n+a[7]*s+a[11]*o+a[15],this}translateToPosition(t){let n=this._m;return n[12]=t.x,n[13]=t.y,n[14]=t.z,this}rotate(t,n){let s=Math.cos(n),o=Math.sin(n),a=new tt,h=a._m;return h[0]=s+(1-s)*t.x*t.x,h[1]=(1-s)*t.y*t.x-o*t.z,h[2]=(1-s)*t.z*t.x+o*t.y,h[3]=0,h[4]=(1-s)*t.x*t.y+o*t.z,h[5]=s+(1-s)*t.y*t.y,h[6]=(1-s)*t.z*t.y-o*t.x,h[7]=0,h[8]=(1-s)*t.x*t.z-o*t.y,h[9]=(1-s)*t.y*t.z+o*t.x,h[10]=s+(1-s)*t.z*t.z,h[11]=0,h[12]=0,h[13]=0,h[14]=0,h[15]=1,this.mul(a)}setRotation(t,n){let s=Math.cos(n),o=Math.sin(n),a=this._m;return a[0]=s+(1-s)*t.x*t.x,a[1]=(1-s)*t.y*t.x-o*t.z,a[2]=(1-s)*t.z*t.x+o*t.y,a[3]=0,a[4]=(1-s)*t.x*t.y+o*t.z,a[5]=s+(1-s)*t.y*t.y,a[6]=(1-s)*t.z*t.y-o*t.x,a[7]=0,a[8]=(1-s)*t.x*t.z-o*t.y,a[9]=(1-s)*t.y*t.z+o*t.x,a[10]=s+(1-s)*t.z*t.z,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,this}rotateBetweenVectors(t,n){return F.getRotationBetweenVectors(t,n).getMat4()}scale(t){let n=this._m;return n[0]=n[0]*t.x,n[1]=n[1]*t.x,n[2]=n[2]*t.x,n[3]=n[3]*t.x,n[4]=n[4]*t.y,n[5]=n[5]*t.y,n[6]=n[6]*t.y,n[7]=n[7]*t.y,n[8]=n[8]*t.z,n[9]=n[9]*t.z,n[10]=n[10]*t.z,n[11]=n[11]*t.z,this}setPerspective(t,n,s,o,a,h){let c=n-t,u=o-s,d=a-h,f=2*a,g=this._m;return g[0]=f/c,g[1]=0,g[2]=0,g[3]=0,g[4]=0,g[5]=f/u,g[6]=0,g[7]=0,g[8]=(n+t)/c,g[9]=(o+s)/u,g[10]=(h+a)/d,g[11]=-1,g[12]=0,g[13]=0,g[14]=f*h/d,g[15]=0,this}setOrthographic(t,n,s,o,a,h){let c=1/(t-n),u=1/(s-o),d=1/(a-h),f=this._m;return f[0]=-2*c,f[1]=0,f[2]=0,f[3]=0,f[4]=0,f[5]=-2*u,f[6]=0,f[7]=0,f[8]=0,f[9]=0,f[10]=2*d,f[11]=0,f[12]=(t+n)*c,f[13]=(o+s)*u,f[14]=(h+a)*d,f[15]=1,this}eulerToMatrix(t,n,s){let o=Math.cos(t),a=Math.sin(t),h=Math.cos(n),c=Math.sin(n),u=Math.cos(s),d=Math.sin(s),f=o*c,g=a*c,_=this._m;return _[0]=h*u,_[1]=-h*d,_[2]=-c,_[4]=-g*u+o*d,_[5]=g*d+o*u,_[6]=-a*h,_[8]=f*u+a*d,_[9]=-f*d+a*u,_[10]=o*h,_[3]=_[7]=_[11]=_[12]=_[13]=_[14]=0,_[15]=1,this}}class F{constructor(t=0,n=0,s=0,o=0){this.x=t,this.y=n,this.z=s,this.w=o}static get IDENTITY(){return new F(0,0,0,1)}static xRotation(t){return t*=.5,new F(Math.sin(t),0,0,Math.cos(t))}static yRotation(t){return t*=.5,new F(0,Math.sin(t),0,Math.cos(t))}static zRotation(t){return t*=.5,new F(0,0,Math.sin(t),Math.cos(t))}static axisAngleToQuat(t,n=0){let s=t.getNormal(),o=.5*n,a=Math.sin(o);return new F(s.x*a,s.y*a,s.z*a,Math.cos(o))}static getLookRotation(t,n){let s=t.getNormal().negate(),o=n.cross(s).normalize(),a=s.cross(o),h=1+o.x+a.y+s.z;if(h>1e-6){let u=1/(2*Math.sqrt(h));return new F((s.y-a.z)*u,(o.z-s.x)*u,(a.x-o.y)*u,.25/u)}if(o.x>a.y&&o.x>s.z){let u=1/(2*Math.sqrt(1+o.x-a.y-s.z));return new F(.25/u,(a.x+o.y)*u,(o.z+s.x)*u,(s.y-a.z)*u)}if(a.y>s.z){let u=1/(2*Math.sqrt(1+a.y-o.x-s.z));return new F((a.x+o.y)*u,.25/u,(s.y+a.z)*u,(o.z-s.x)*u)}let c=1/(2*Math.sqrt(1+s.z-o.x-a.y));return new F((o.z+s.x)*c,(s.y+a.z)*c,.25/c,(a.x-o.y)*c)}static getLookAtSourceDest(t,n){let s=n.subA(t).normalize(),o=v.FORWARD.dot(s);if(Math.abs(o- -1)<1e-6)return F.axisAngleToQuat(v.UP,Math.PI);if(Math.abs(o-1)<1e-6)return new F(0,0,0,1);let a=Math.acos(o),h=v.FORWARD.cross(s).normalize();return F.axisAngleToQuat(h,a)}static getRotationBetweenVectors(t,n){let s=t.cross(n);return new F(s.x,s.y,s.z,1+t.dot(n)).normalize()}static getRotationBetweenVectorsRes(t,n,s){let o=t.cross(n);return s.set(o.x,o.y,o.z,1+t.dot(n)),s.normalize()}static getRotationBetweenVectorsUp(t,n,s){let o=t.dot(n);if(Math.abs(o+1)<1e-6)return F.axisAngleToQuat(s,Math.PI);if(Math.abs(o-1)<1e-6)return new F(0,0,0,1);let a=Math.acos(o),h=t.cross(n).normalize();return F.axisAngleToQuat(h,a)}isZero(){return this.x===0&&this.y===0&&this.z===0&&this.w===0}isNaN(){return isNaN(this.x)||isNaN(this.y)||isNaN(this.z)||isNaN(this.w)}clear(){return this.x=this.y=this.z=this.w=0,this}set(t,n,s,o){return this.x=t,this.y=n,this.z=s,this.w=o,this}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this}setIdentity(){return this.x=0,this.y=0,this.z=0,this.w=1,this}clone(){return new F(this.x,this.y,this.z,this.w)}add(t){return new F(this.x+t.x,this.y+t.y,this.z+t.z,this.w+t.w)}addRes(t,n){return n.set(this.x+t.x,this.y+t.y,this.z+t.z,this.w+t.w)}sub(t){return new F(this.x-t.x,this.y-t.y,this.z-t.z,this.w-t.w)}scaleTo(t){return new F(this.x*t,this.y*t,this.z*t,this.w*t)}scale(t){return this.x*=t,this.y*=t,this.z*=t,this.w*=t,this}toVec(){return[this.x,this.y,this.z,this.w]}get xyz(){return new v(this.x,this.y,this.z)}setLookRotation(t,n){let s=t.getNormal().negate(),o=n.cross(s).normalize(),a=s.cross(o),h=1+o.x+a.y+s.z;if(h>1e-6){let c=1/(2*Math.sqrt(h));this.x=(s.y-a.z)*c,this.y=(o.z-s.x)*c,this.z=(a.x-o.y)*c,this.w=.25/c}else if(o.x>a.y&&o.x>s.z){let c=1/(2*Math.sqrt(1+o.x-a.y-s.z));this.x=.25/c,this.y=(a.x+o.y)*c,this.z=(o.z+s.x)*c,this.w=(s.y-a.z)*c}else if(a.y>s.z){let c=1/(2*Math.sqrt(1+a.y-o.x-s.z));this.x=(a.x+o.y)*c,this.y=.25/c,this.z=(s.y+a.z)*c,this.w=(o.z-s.x)*c}else{let c=1/(2*Math.sqrt(1+s.z-o.x-a.y));this.x=(o.z+s.x)*c,this.y=(s.y+a.z)*c,this.z=.25/c,this.w=(a.x-o.y)*c}return this}setFromSphericalCoords(t,n,s){let o=Math.sin(s/2),a=Math.cos(s/2),h=Math.sin(t),c=Math.cos(t),u=Math.sin(n),d=Math.cos(n);return this.x=o*c*u,this.y=o*h,this.z=o*h*d,this.w=a,this}getSphericalCoords(){let t=this.w,n=Math.sqrt(1-t*t);Math.abs(n)<5e-4&&(n=1);let s,o=this.x/n,a=this.y/n,h=this.z/n,c=-Math.asin(a);return s=o*o+h*h<5e-4?0:Math.atan2(o,h),s<0&&(s+=360),{lat:c,lon:s,alpha:Math.acos(t)}}setFromAxisAngle(t,n){let s=t.getNormal(),o=.5*n,a=Math.sin(o);return this.set(s.x*a,s.y*a,s.z*a,Math.cos(o)),this}getAxisAngle(){let t,n,s=this.x,o=this.y,a=this.z,h=this.w,c=Math.sqrt(s*s+o*o+a*a);if(c>1e-7){let u=1/c;t=new v(s*u,o*u,a*u),n=h<0?2*Math.atan2(-c,-h):2*Math.atan2(c,h)}else t=new v(0,0,0),n=0;return{axis:t,angle:n}}getPitch(){let t=-2*(this.y*this.z-this.w*this.x);return Math.abs(t)>=1?Math.sign(t)*vo:Math.asin(t)}getYaw(){return-Math.atan2(2*(this.x*this.z+this.w*this.y),1-2*(this.y*this.y+this.x*this.x))}getRoll(){return Math.atan2(2*(this.x*this.y+this.w*this.z),1-2*(this.z*this.z+this.x*this.x))}setPitchYawRoll(t,n,s,o=F.IDENTITY){let a=F.xRotation(-t),h=F.yRotation(n),c=F.zRotation(-s);return this.copy(c.mul(a).mul(h).mul(o).conjugate())}setFromEulerAngles(t,n,s){let o=t*Qt,a=n*Qt,h=s*Qt,c=Math.cos(o),u=Math.cos(a),d=Math.cos(h),f=Math.sin(o),g=Math.sin(a),_=Math.sin(h),m=u*d,p=g*_;return this.w=c*m+f*p,this.x=f*m-c*p,this.y=c*g*d+f*u*_,this.z=c*u*_-f*g*d,this.normalize()}getEulerAngles(){let t=this.x,n=this.y,s=this.z,o=this.w,a=n*n,h=o*n-s*t;return h<-1?h=-1:h>1&&(h=1),{roll:Math.atan2(2*(o*t+n*s),1-2*(t*t+a)),pitch:Math.asin(2*h),yaw:Math.atan2(2*(o*s+t*n),1-2*(a+s*s))}}setFromMatrix4(t){let n,s,o,a,h,c=[],u=t._m,d=[1,2,0];return n=u[0]+u[5]+u[10],n>0?(s=Math.sqrt(n+1),this.w=s/2,s=.5/s,this.x=(u[6]-u[9])*s,this.y=(u[8]-u[2])*s,this.z=(u[1]-u[4])*s):(o=0,u[5]>u[0]&&(o=1),u[10]>u[5*o]&&(o=2),a=d[o],h=d[a],s=Math.sqrt(u[5*o]-(u[5*a]+u[5*h])+1),c[o]=.5*s,s!==0&&(s=.5/s),c[3]=(u[4*a+h]-u[4*h+a])*s,c[a]=(u[4*o+a]+u[4*a+o])*s,c[h]=(u[4*o+h]+u[4*h+o])*s,this.x=c[0],this.y=c[1],this.z=c[2],this.w=c[3]),this}getMat4(t=new tt){let n=this.x+this.x,s=this.y+this.y,o=this.z+this.z,a=this.w*n,h=this.w*s,c=this.w*o,u=this.x*n,d=this.x*s,f=this.x*o,g=this.y*s,_=this.y*o,m=this.z*o;return t.set([1-(g+m),d-c,f+h,0,d+c,1-(u+m),_-a,0,f-h,_+a,1-(u+g),0,0,0,0,1])}getMat3(){let t=new Se,n=t._m,s=this.x,o=this.y,a=this.z,h=this.w,c=s+s,u=o+o,d=a+a,f=s*c,g=s*u;s*=d;let _=o*u;return o*=d,a*=d,c*=h,u*=h,h*=d,n[0]=1-(_+a),n[1]=g-h,n[2]=s+u,n[3]=g+h,n[4]=1-(f+a),n[5]=o-c,n[6]=s-u,n[7]=o+c,n[8]=1-(f+_),t}mulVec3(t){let n=t.x,s=t.y,o=t.z,a=this.x,h=this.y,c=this.z,u=this.w,d=u*n+h*o-c*s,f=u*s+c*n-a*o,g=u*o+a*s-h*n;return n=-a*n-h*s-c*o,new v(d*u+n*-a+f*-c-g*-h,f*u+n*-h+g*-a-d*-c,g*u+n*-c+d*-h-f*-a)}mulVec3Res(t,n){let s=t.x,o=t.y,a=t.z,h=this.x,c=this.y,u=this.z,d=this.w,f=d*s+c*a-u*o,g=d*o+u*s-h*a,_=d*a+h*o-c*s;return s=-h*s-c*o-u*a,n.set(f*d+s*-h+g*-u-_*-c,g*d+s*-c+_*-h-f*-u,_*d+s*-u+f*-c-g*-h)}mul(t){let n=this.x,s=this.y,o=this.z,a=this.w,h=t.x,c=t.y,u=t.z,d=t.w;return new F(n*d+a*h+s*u-o*c,s*d+a*c+o*h-n*u,o*d+a*u+n*c-s*h,a*d-n*h-s*c-o*u)}mulRes(t,n){let s=this.x,o=this.y,a=this.z,h=this.w,c=t.x,u=t.y,d=t.z,f=t.w;return n.set(s*f+h*c+o*d-a*u,o*f+h*u+a*c-s*d,a*f+h*d+s*u-o*c,h*f-s*c-o*u-a*d)}mulA(t){let n=this.x,s=this.y,o=this.z,a=this.w,h=t.x,c=t.y,u=t.z,d=t.w;return this.x=n*d+a*h+s*u-o*c,this.y=s*d+a*c+o*h-n*u,this.z=o*d+a*u+n*c-s*h,this.w=a*d-n*h-s*c-o*u,this}conjugate(){return new F(-this.x,-this.y,-this.z,this.w)}inverse(){let t=1/this.magnitude2();return new F(-this.x*t,-this.y*t,-this.z*t,this.w*t)}magnitude(){let t=this.x,n=this.y,s=this.z,o=this.w;return Math.sqrt(t*t+n*n+s*s+o*o)}magnitude2(){let t=this.x,n=this.y,s=this.z,o=this.w;return t*t+n*n+s*s+o*o}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}normalize(){let t=this.x,n=this.y,s=this.z,o=this.w,a=Math.sqrt(t*t+n*n+s*s+o*o);return a===0?(this.x=0,this.y=0,this.z=0,this.w=0,this):(a=1/a,this.x=t*a,this.y=n*a,this.z=s*a,this.w=o*a,this)}isEqual(t){let n=this.dot(t);return Math.abs(n-1)<.001}slerp(t,n){let s,o,a,h,c,u=this.x,d=this.y,f=this.z,g=this.w,_=t.x,m=t.y,p=t.z,x=t.w;return o=u*_+d*m+f*p+g*x,o<0&&(o=-o,_=-_,m=-m,p=-p,x=-x),1-o>1e-6?(s=Math.acos(o),a=Math.sin(s),h=Math.sin((1-n)*s)/a,c=Math.sin(n*s)/a):(h=1-n,c=n),new F(h*u+c*_,h*d+c*m,h*f+c*p,h*g+c*x)}}class v{constructor(t=0,n=0,s=0){this.x=t,this.y=n,this.z=s}static get UP(){return new v(0,1,0)}static get DOWN(){return new v(0,-1,0)}static get RIGHT(){return new v(1,0,0)}static get LEFT(){return new v(-1,0,0)}static get FORWARD(){return new v(0,0,-1)}static get BACKWARD(){return new v(0,0,1)}static get ZERO(){return new v}static get UNIT_X(){return new v(1,0,0)}static get UNIT_Y(){return new v(0,1,0)}static get UNIT_Z(){return new v(0,0,1)}static get NORTH(){return v.UNIT_Z}static doubleToTwoFloats(t,n,s){let o=t.x,a=t.y,h=t.z;if(o>=0){let c=65536*Math.floor(o/65536);n.x=Math.fround(c),s.x=Math.fround(o-c)}else{let c=65536*Math.floor(-o/65536);n.x=Math.fround(-c),s.x=Math.fround(o+c)}if(a>=0){let c=65536*Math.floor(a/65536);n.y=Math.fround(c),s.y=Math.fround(a-c)}else{let c=65536*Math.floor(-a/65536);n.y=Math.fround(-c),s.y=Math.fround(a+c)}if(h>=0){let c=65536*Math.floor(h/65536);n.z=Math.fround(c),s.z=Math.fround(h-c)}else{let c=65536*Math.floor(-h/65536);n.z=Math.fround(-c),s.z=Math.fround(h+c)}}static doubleToTwoFloat32Array(t,n,s){let o=t.x,a=t.y,h=t.z;if(o>=0){let c=65536*Math.floor(o/65536);n[0]=Math.fround(c),s[0]=Math.fround(o-c)}else{let c=65536*Math.floor(-o/65536);n[0]=Math.fround(-c),s[0]=Math.fround(o+c)}if(a>=0){let c=65536*Math.floor(a/65536);n[1]=Math.fround(c),s[1]=Math.fround(a-c)}else{let c=65536*Math.floor(-a/65536);n[1]=Math.fround(-c),s[1]=Math.fround(a+c)}if(h>=0){let c=65536*Math.floor(h/65536);n[2]=Math.fround(c),s[2]=Math.fround(h-c)}else{let c=65536*Math.floor(-h/65536);n[2]=Math.fround(-c),s[2]=Math.fround(h+c)}}static fromVec(t){return new v(t[0],t[1],t[2])}static angle(t,n){let s=t.dot(n),o=t.cross(n).length();return Math.atan2(o,s)}static lerp(t,n,s){return new v(t.x+(n.x-t.x)*s,t.y+(n.y-t.y)*s,t.z+(n.z-t.z)*s)}static add(t,n){let s=new v(t.x,t.y,t.z);return s.addA(n),s}static sub(t,n){let s=new v(t.x,t.y,t.z);return s.subA(n),s}static scale(t,n){return t.scaleTo(n)}static mul(t,n){let s=new v(t.x,t.y,t.z);return s.mulA(n),s}static noncollinear(t,n){return!!(t.y*n.z-t.z*n.y||t.z*n.x-t.x*n.z||t.x*n.y-t.y*n.z)}static proj_b_to_plane(t,n,s){let o=t.sub(n.scaleTo(n.dot(t)/n.dot(n)));return s&&o.isZero()?new v(s.x,s.y,s.z):o}static proj_b_to_a(t,n){return n.scaleTo(n.dot(t)/n.dot(n))}static orthoNormalize(t,n){return(t=t.getNormal()).scale(n.dot(t)),n.subA(t).normalize()}static isOrthogonal(t,n,s=1e-6){const o=t.x*n.x+t.y*n.y+t.z*n.z;return Math.abs(o)<s}isOrthogonal(t,n=1e-6){const s=this.x*t.x+this.y*t.y+this.z*t.z;return Math.abs(s)<n}static div(t,n){let s=new v(t.x,t.y,t.z);return s.divA(n),s}static length2(t){return t.length2()}static dot(t,n){return t.dot(n)}toVec4(){return new et(this.x,this.y,this.z,1)}clone(){return new v(this.x,this.y,this.z)}toString(){return`(${this.x},${this.y},${this.z})`}isZero(){return!(this.x||this.y||this.z)}projToVec(t){return t.scaleTo(t.dot(this)/t.dot(t))}equal(t){return this.x===t.x&&this.y===t.y&&this.z===t.z}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}length2(){return this.x*this.x+this.y*this.y+this.z*this.z}getQuat(){return new F(this.x,this.y,this.z)}addA(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this}add(t){return new v(this.x+t.x,this.y+t.y,this.z+t.z)}addRes(t,n){return n.set(this.x+t.x,this.y+t.y,this.z+t.z)}subA(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this}sub(t){return new v(this.x-t.x,this.y-t.y,this.z-t.z)}scale(t){return this.x*=t,this.y*=t,this.z*=t,this}scaleTo(t){return new v(this.x*t,this.y*t,this.z*t)}mulA(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this}mul(t){return new v(this.x*t.x,this.y*t.y,this.z*t.z)}mulRes(t,n){return n.set(this.x*t.x,this.y*t.y,this.z*t.z)}divA(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this}div(t){return new v(this.x/t.x,this.y/t.y,this.z/t.z)}dot(t){return t.x*this.x+t.y*this.y+t.z*this.z}dotArr(t){return t[0]*this.x+t[1]*this.y+t[2]*this.z}cross(t){return new v(this.y*t.z-this.z*t.y,this.z*t.x-this.x*t.z,this.x*t.y-this.y*t.x)}clear(){return this.x=this.y=this.z=0,this}getNormal(){let t=new v;t.copy(this);let n=1/t.length();return t.x*=n,t.y*=n,t.z*=n,t}normal(){let t=new v;t.copy(this);let n=1/t.length();return t.x*=n,t.y*=n,t.z*=n,t}normalNegate(){let t=new v;t.copy(this);let n=-1/t.length();return t.x*=n,t.y*=n,t.z*=n,t}normalNegateScale(t){let n=new v;n.copy(this);let s=-t/n.length();return n.x*=s,n.y*=s,n.z*=s,n}normalScale(t){let n=new v;n.copy(this);let s=t/n.length();return n.x*=s,n.y*=s,n.z*=s,n}normalize(){let t=1/this.length();return this.x*=t,this.y*=t,this.z*=t,this}toVec(){return[this.x,this.y,this.z]}toArray(){return[this.x,this.y,this.z]}distance(t){let n=this.x-t.x,s=this.y-t.y,o=this.z-t.z;return Math.sqrt(n*n+s*s+o*o)}distance2(t){let n=this.x-t.x,s=this.y-t.y,o=this.z-t.z;return n*n+s*s+o*o}set(t,n,s){return this.x=t,this.y=n,this.z=s,this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}negateTo(){return new v(-this.x,-this.y,-this.z)}projToRay(t,n){let s=v.proj_b_to_a(v.sub(this,t),n);return s.addA(t),s}angle(t){return v.angle(this,t)}lerp(t,n){return new v(this.x+(t.x-this.x)*n,this.y+(t.y-this.y)*n,this.z+(t.z-this.z)*n)}smerp(t,n){let s=1-n;return new v(this.x*n+t.x*s,this.y*n+t.y*s,this.z*n+t.z*s)}static get LERP_DELTA(){return 1e-6}slerp(t,n){let s,o,a,h,c=new v;if(n<=0)return c.copy(this),c;if(n>=1)return c.copy(t),c;let u=this.dot(t);return 1-u>v.LERP_DELTA?(s=Math.acos(u),o=Math.sin(s),a=Math.sin((1-n)*s)/o,h=Math.sin(n*s)/o):(a=1-n,h=n),v.add(this.scaleTo(a),t.scale(h))}mulVecA(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this}getRotationTo(t,n){let s=this.clone(),o=t.clone();s.normalize(),o.normalize();let a=s.dot(o);if(a>=1)return F.IDENTITY.clone();if(a<-.999999){if(n.equal(v.ZERO)){let h=v.UNIT_X.cross(s);return h.isZero()&&(h=v.UNIT_Y.cross(s)),h.normalize(),F.axisAngleToQuat(h,Math.PI)}return F.axisAngleToQuat(n,Math.PI)}{let h=Math.sqrt(2*(1+a)),c=1/h,u=s.cross(o),d=new F(u.x*c,u.y*c,u.z*c,.5*h);return d.normalize(),d}}}class H{constructor(t=0,n=0){this.x=t,this.y=n}static get UP(){return new H(0,1)}static get DOWN(){return new H(0,-1)}static get RIGHT(){return new H(1,0)}static get LEFT(){return new H(-1,0)}static get ZERO(){return new H}static add(t,n){const s=new H(t.x,t.y);return s.addA(n),s}static sub(t,n){var s=new H(t.x,t.y);return s.subA(n),s}static scale(t,n){let s=new H(t.x,t.y);return s.scale(n),s}static mul(t,n){let s=new H(t.x,t.y);return s.mulA(n),s}static div(t,n){let s=new H(t.x,t.y);return s.divA(n),s}static proj_b_to_a(t,n){return n.scaleTo(n.dot(t)/n.dot(n))}static angle(t,n){return Math.acos(t.dot(n)/Math.sqrt(t.length2()*n.length2()))}static orthoNormalize(t,n){return(t=t.normal()).scale(n.dot(t)),n.sub(t).normalize()}static proj_b_to_plane(t,n,s){let o=t.sub(n.scaleTo(n.dot(t)/n.dot(n)));return s&&o.isZero()?new H(s.x,s.y):o}toVector3(){return new v(this.x,this.y,0)}clone(){return new H(this.x,this.y)}equal(t){return this.x===t.x&&this.y===t.y}copy(t){return this.x=t.x,this.y=t.y,this}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}length2(){return this.x*this.x+this.y*this.y}addA(t){return this.x+=t.x,this.y+=t.y,this}add(t){return new H(this.x+t.x,this.y+t.y)}subA(t){return this.x-=t.x,this.y-=t.y,this}sub(t){return new H(this.x-t.x,this.y-t.y)}scale(t){return this.x*=t,this.y*=t,this}scaleTo(t){return new H(this.x*t,this.y*t)}mulA(t){return this.x*=t.x,this.y*=t.y,this}mul(t){return new H(this.x*t.x,this.y*t.y)}divA(t){return this.x/=t.x,this.y/=t.y,this}dot(t){return t.x*this.x+t.y*this.y}dotArr(t){return t[0]*this.x+t[1]*this.y}cross(t){return this.x*t.y-this.y*t.x}clear(){return this.x=this.y=0,this}normal(){return this.getNormal()}getNormal(){let t=new H;t.copy(this);let n=1/t.length();return t.x*=n,t.y*=n,t}normalize(){let t=1/this.length();return this.x*=t,this.y*=t,this}toVec(){return[this.x,this.y]}distance(t){return H.sub(this,t).length()}set(t,n){return this.x=t,this.y=n,this}negate(){return this.x=-this.x,this.y=-this.y,this}negateTo(){return new H(-this.x,-this.y)}projToRay(t,n){let s=H.proj_b_to_a(H.sub(this,t),n);return s.add(t),s}angle(t){return H.angle(this,t)}lerp(t,n,s){let o=this.clone();return s<=0?o.copy(t):s>=1?o.copy(n):o=H.add(t,H.sub(n,t).scale(s)),o}static get LERP_DELTA(){return 1e-6}slerp(t,n){let s,o,a,h,c=new H;if(n<=0)return c.copy(this),c;if(n>=1)return c.copy(t),c;let u=this.dot(t);return 1-u>H.LERP_DELTA?(s=Math.acos(u),o=Math.sin(s),a=Math.sin((1-n)*s)/o,h=Math.sin(n*s)/o):(a=1-n,h=n),H.add(this.scale(a),t.scale(h))}isZero(){return!(this.x||this.y)}}const Po={aliceblue:"#f0f8ff",antiquewhite:"#faebd7",aqua:"#00ffff",aquamarine:"#7fffd4",azure:"#f0ffff",beige:"#f5f5dc",bisque:"#ffe4c4",black:"#000000",blanchedalmond:"#ffebcd",blue:"#0000ff",blueviolet:"#8a2be2",brown:"#a52a2a",burlywood:"#deb887",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",cornflowerblue:"#6495ed",cornsilk:"#fff8dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkgray:"#a9a9a9",darkgreen:"#006400",darkkhaki:"#bdb76b",darkmagenta:"#8b008b",darkolivegreen:"#556b2f",darkorange:"#ff8c00",darkorchid:"#9932cc",darkred:"#8b0000",darksalmon:"#e9967a",darkseagreen:"#8fbc8f",darkslateblue:"#483d8b",darkslategray:"#2f4f4f",darkturquoise:"#00ced1",darkviolet:"#9400d3",deeppink:"#ff1493",deepskyblue:"#00bfff",dimgray:"#696969",dodgerblue:"#1e90ff",firebrick:"#b22222",floralwhite:"#fffaf0",forestgreen:"#228b22",fuchsia:"#ff00ff",gainsboro:"#dcdcdc",ghostwhite:"#f8f8ff",gold:"#ffd700",goldenrod:"#daa520",gray:"#808080",green:"#008000",greenyellow:"#adff2f",honeydew:"#f0fff0",hotpink:"#ff69b4","indianred ":"#cd5c5c",indigo:"#4b0082",ivory:"#fffff0",khaki:"#f0e68c",lavender:"#e6e6fa",lavenderblush:"#fff0f5",lawngreen:"#7cfc00",lemonchiffon:"#fffacd",lightblue:"#add8e6",lightcoral:"#f08080",lightcyan:"#e0ffff",lightgoldenrodyellow:"#fafad2",lightgrey:"#d3d3d3",lightgreen:"#90ee90",lightpink:"#ffb6c1",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",lightskyblue:"#87cefa",lightslategray:"#778899",lightsteelblue:"#b0c4de",lightyellow:"#ffffe0",lime:"#00ff00",limegreen:"#32cd32",linen:"#faf0e6",magenta:"#ff00ff",maroon:"#800000",mediumaquamarine:"#66cdaa",mediumblue:"#0000cd",mediumorchid:"#ba55d3",mediumpurple:"#9370d8",mediumseagreen:"#3cb371",mediumslateblue:"#7b68ee",mediumspringgreen:"#00fa9a",mediumturquoise:"#48d1cc",mediumvioletred:"#c71585",midnightblue:"#191970",mintcream:"#f5fffa",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",navajowhite:"#ffdead",navy:"#000080",oldlace:"#fdf5e6",olive:"#808000",olivedrab:"#6b8e23",orange:"#ffa500",orangered:"#ff4500",orchid:"#da70d6",palegoldenrod:"#eee8aa",palegreen:"#98fb98",paleturquoise:"#afeeee",palevioletred:"#d87093",papayawhip:"#ffefd5",peachpuff:"#ffdab9",peru:"#cd853f",pink:"#ffc0cb",plum:"#dda0dd",powderblue:"#b0e0e6",purple:"#800080",rebeccapurple:"#663399",red:"#ff0000",rosybrown:"#bc8f8f",royalblue:"#4169e1",saddlebrown:"#8b4513",salmon:"#fa8072",sandybrown:"#f4a460",seagreen:"#2e8b57",seashell:"#fff5ee",sienna:"#a0522d",silver:"#c0c0c0",skyblue:"#87ceeb",slateblue:"#6a5acd",slategray:"#708090",snow:"#fffafa",springgreen:"#00ff7f",steelblue:"#4682b4",tan:"#d2b48c",teal:"#008080",thistle:"#d8bfd8",tomato:"#ff6347",turquoise:"#40e0d0",violet:"#ee82ee",wheat:"#f5deb3",white:"#ffffff",whitesmoke:"#f5f5f5",yellow:"#ffff00",yellowgreen:"#9acd32"};class qr{constructor(t=1,n=1){this._a=t,this._b=n,this._flattening=(t-n)/t,this._f=1/this._flattening,this._a2=t*t,this._b2=n*n;const s=Math.sqrt(this._a2-this._b2);this._e=s/t,this._e2=this._e*this._e,this._e22=this._e2*this._e2,this._k=s/n,this._k2=this._k*this._k,this._radii=new v(t,t,n),this._radii2=new v(this._a2,this._a2,this._b2),this._invRadii=new v(1/t,1/t,1/n),this._invRadii2=new v(1/this._a2,1/this._a2,1/this._b2)}rhumbDistanceTo(t,n){const s=t.lat*j,o=n.lat*j,a=o-s;let h=Math.abs(n.lon-t.lon)*j;Math.abs(h)>Math.PI&&(h=h>0?-(2*Math.PI-h):2*Math.PI+h);const c=Math.log(Math.tan(o/2+Math.PI/4)/Math.tan(s/2+Math.PI/4)),u=Math.abs(c)>1e-11?a/c:Math.cos(s);return Math.sqrt(a*a+u*u*h*h)*this._a}getIntermediatePointOnGreatCircle(t,n,s){if(s==0)return t.clone();if(s==1)return n.clone();const o=this.inverse(t,n),a=o.distance,h=o.initialAzimuth;return isNaN(h)?t:this.getGreatCircleDestination(t,h,a*s)}static getBearing(t,n){let s=t.lat*j,o=t.lon*j,a=n.lat*j,h=n.lon*j,c=Math.sin(h-o)*Math.cos(a),u=Math.cos(s)*Math.sin(a)-Math.sin(s)*Math.cos(a)*Math.cos(h-o);return Math.atan2(c,u)*J}getFlattening(){return this._flattening}getEquatorialSize(){return this._a}get equatorialSize(){return this._a}get equatorialSizeSqr(){return this._a2}getPolarSize(){return this._b}get polarSize(){return this._b}get polarSizeSqr(){return this._b2}lonLatToCartesian(t){return this.geodeticToCartesian(t.lon,t.lat,t.height)}lonLatToCartesianRes(t,n){return this.geodeticToCartesian(t.lon,t.lat,t.height,n)}geodeticToCartesian(t,n,s=0,o=new v){let a=j*n,h=j*t,c=Math.sin(a),u=this._a/Math.sqrt(1-this._e2*c*c),d=(u+s)*Math.cos(a);return o.x=d*Math.cos(h),o.y=d*Math.sin(h),o.z=(u*(1-this._e2)+s)*c,o}projToSurface(t){let n=t.x||0,s=t.y||0,o=t.z||0,a=Math.sqrt(n*n+s*s+o*o);if(a===0)return this.lonLatToCartesian(new L);let h=this._invRadii2.x,c=this._invRadii2.y,u=this._invRadii2.z,d=n*n*h,f=s*s*c,g=o*o*u,_=d+f+g,m=Math.sqrt(1/_),p=t.scaleTo(m);if(_<.1)return Number.isFinite(m)?p:new v;let x=(1-m)*a/p.mulA(this._invRadii2).length(),y=0,T=0,S=0;for(;;){y=1/(1+x*h),T=1/(1+x*c),S=1/(1+x*u);let C=y*y,P=T*T,w=S*S,I=d*C+f*P+g*w-1;if(Math.abs(I)<ar)break;x+=.5*I/(d*(C*y)*h+f*(P*T)*c+g*(w*S)*u)}return new v(n*y,s*T,o*S)}cartesianToLonLat(t){return this.cartesianToLonLatRes(t)}cartesianToLonLatRes(t,n=new L){let s=this.projToSurface(t),o=this.getSurfaceNormal3v(s),a=t.sub(s);return n.lon=Math.atan2(o.y,o.x)*J,n.lat=Math.asin(o.z)*J,n.height=Math.sign(a.dot(t))*a.length(),n}getSurfaceNormal3v(t){let n=this._invRadii2,s=t.x*n.x,o=t.y*n.y,a=t.z*n.z,h=1/Math.sqrt(s*s+o*o+a*a);return new v(s*h,o*h,a*h)}getGreatCircleDistance(t,n){return this.inverse(t,n).distance}getGreatCircleDestination(t,n,s){return this.direct(t,n,s).destination}inverse(t,n){let s=this._a,o=this._b,a=this._flattening;const h=t.lat*j,c=t.lon*j,u=n.lat*j,d=n.lon*j-c,f=(1-a)*Math.tan(h),g=1/Math.sqrt(1+f*f),_=f*g,m=(1-a)*Math.tan(u),p=1/Math.sqrt(1+m*m),x=m*p,y=Math.abs(d)>Math.PI/2||Math.abs(u-h)>Math.PI/2;let T=d,S=null,C=null,P=y?Math.PI:0,w=0,I=y?-1:1,O=null,N=1,k=1,D=null,ze=0;do{if(S=Math.sin(T),C=Math.cos(T),O=(p*S)**2+(g*x-_*p*C)**2,Math.abs(O)<1e-24)break;w=Math.sqrt(O),I=_*x+g*p*C,P=Math.atan2(w,I);const re=g*p*S/w;k=1-re*re,N=k!=0?I-2*_*x/k:0;const mt=a/16*k*(4+a*(4-3*k));D=T,T=d+(1-mt)*a*re*(P+mt*w*(N+mt*I*(2*N*N-1)))}while(Math.abs(T-D)>ar&&++ze<1e3);const z=k*(s*s-o*o)/(o*o),Ee=z/1024*(256+z*(z*(74-47*z)-128)),B=o*(1+z/16384*(4096+z*(z*(320-175*z)-768)))*(P-Ee*w*(N+Ee/4*(I*(2*N*N-1)-Ee/6*N*(4*w*w-3)*(4*N*N-3)))),rt=Math.abs(O)<Number.EPSILON?0:Math.atan2(p*S,g*x-_*p*C),wt=Math.abs(O)<Number.EPSILON?Math.PI:Math.atan2(g*S,-_*p+g*x*C);return{distance:B,initialAzimuth:Math.abs(B)<Number.EPSILON?NaN:Ue(rt)*J,finalAzimuth:Math.abs(B)<Number.EPSILON?NaN:Ue(wt)*J}}direct(t,n,s){let o=t.lon,a=t.lat,h=this._a,c=this._b,u=this._flattening,d=s,f=n*j,g=Math.sin(f),_=Math.cos(f),m=(1-u)*Math.tan(a*j),p=1/Math.sqrt(1+m*m),x=m*p,y=Math.atan2(m,_),T=p*g,S=1-T*T,C=S*(h*h-c*c)/(c*c),P=1+C/16384*(4096+C*(C*(320-175*C)-768)),w=C/1024*(256+C*(C*(74-47*C)-128)),I=d/(c*P),O=2*Math.PI,N=0,k=0,D=0,ze=0;for(;Math.abs(I-O)>1e-12;)N=Math.cos(2*y+I),k=Math.sin(I),D=Math.cos(I),ze=w*k*(N+w/4*(D*(2*N*N-1)-w/6*N*(4*k*k-3)*(4*N*N-3))),O=I,I=d/(c*P)+ze;let z=x*k-p*D*_,Ee=Math.atan2(x*D+p*k*_,(1-u)*Math.sqrt(T*T+z*z)),B=u/16*S*(4+u*(4-3*S)),rt=Math.atan2(k*g,p*D-x*k*_)-(1-B)*u*T*(I+B*k*(N+B*D*(2*N*N-1))),wt=Math.atan2(T,-z);return{destination:new L(o+rt*J,Ee*J),finalAzimuth:wt*J}}hitRay(t,n){let s,o,a,h,c,u=this._invRadii.mul(t),d=this._invRadii.mul(n),f=u.dot(u),g=u.dot(d);if(f>1){if(g>=0)return;var _=g*g;if(s=f-1,o=d.dot(d),a=o*s,Math.abs(_-a)>1e-15&&_<a)return;if(_>a){h=g*g-a,c=-g+Math.sqrt(h);var m=c/o,p=s/c;return m<p?t.add(n.scaleTo(m)):t.add(n.scaleTo(p))}var x=Math.sqrt(s/o);return t.add(n.scaleTo(x))}return f<1?(s=f-1,o=d.dot(d),a=o*s,h=g*g-a,c=-g+Math.sqrt(h),t.add(n.scaleTo(c/o))):g<0?(o=d.dot(d),t.add(n.scaleTo(-g/o))):void 0}getNorthFrameRotation(t){let n=this.getSurfaceNormal3v(t),s=v.proj_b_to_plane(v.NORTH,n);return F.getLookRotation(s,n)}getBearingDestination(t,n=0,s=0){n*=j;var o=(t.lon+540)%360-180,a=t.lat*j,h=o*j,c=s/this._a,u=Math.asin(Math.sin(a)*Math.cos(c)+Math.cos(a)*Math.sin(c)*Math.cos(n));return new L((h+Math.atan2(Math.sin(n)*Math.sin(c)*Math.cos(a),Math.cos(c)-Math.sin(a)*Math.sin(u)))*J,u*J)}static getIntermediatePointOnGreatCircle(t,n,s){var o=t.lat*j,a=t.lon*j,h=n.lat*j,c=n.lon*j,u=Math.sin(o),d=Math.cos(o),f=Math.sin(a),g=Math.cos(a),_=Math.sin(h),m=Math.cos(h),p=Math.sin(c),x=Math.cos(c),y=h-o,T=c-a,S=Math.sin(y/2)*Math.sin(y/2)+Math.cos(o)*Math.cos(h)*Math.sin(T/2)*Math.sin(T/2),C=2*Math.atan2(Math.sqrt(S),Math.sqrt(1-S)),P=Math.sin((1-s)*C)/Math.sin(C),w=Math.sin(s*C)/Math.sin(C),I=P*d*g+w*m*x,O=P*d*f+w*m*p,N=P*u+w*_,k=Math.atan2(N,Math.sqrt(I*I+O*O)),D=Math.atan2(O,I);return new L((D*J+540)%360-180,k*J)}static getRhumbBearing(t,n){var s=(n.lon-t.lon)*j,o=Math.log(Math.tan(n.lat*j/2+Math.PI/4)/Math.tan(t.lat*j/2+Math.PI/4));return Math.abs(s)>Math.PI&&(s=s>0?-1*(2*Math.PI-s):2*Math.PI+s),(Math.atan2(s,o)*J+360)%360}getLonLatVisibilitySimple(t,n,s){const o=this.lonLatToCartesian(n),a=n.height,h=this.polarSize+a,c=Math.max(t.length()-this.polarSize,0),u=o.sub(t);let d;return d=c>0?Math.sqrt((h+c)**2-h**2):h,d>u.length()&&(!s||s.dot(u.normalize())>0)}}const So=new qr(6378137,6356752314245179e-9);function Vi(l,t){return l??t}function Gt(l){return l==null}function vn(l){return l===void 0}let Fa=0;function Yr(l){let t=l._openglobus_id;return t||(t=l._openglobus_id=++Fa),t}function ks(l){return typeof l=="string"||l instanceof String}function ke(l){return l.toString(16).padStart(2,"0")}function cr(l){let t,n,s;return l instanceof Array?(t=ke(l[0]),n=ke(l[1]),s=ke(l[2])):(t=ke(l.x),n=ke(l.y),s=ke(l.z)),`#${t}${n}${s}`}function he(l,t){let n=Po[l];if(n&&(l=n),l[0]==="#"){let s=/^#?([a-f\d])([a-f\d])([a-f\d])$/i,o=l.replace(s,function(h,c,u,d){return c+c+u+u+d+d}),a=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(o);return a?new et(parseInt(a[1],16)/255,parseInt(a[2],16)/255,parseInt(a[3],16)/255,Gt(t)?1:t):new et}{Gt(t)&&(t=1);let s=l.split(",");return new et(parseInt(s[0].split("(")[1])/255,parseInt(s[1])/255,parseInt(s[2])/255,Gt(s[3])?t:parseFloat(s[3]))}}function ve(l,t){let n=he(l,t);return new Float32Array([n.x,n.y,n.z,n.w])}function ts(l){let t=Po[l];if(t&&(l=t),l[0]==="#"){let n=/^#?([a-f\d])([a-f\d])([a-f\d])$/i,s=l.replace(n,function(a,h,c,u){return h+h+c+c+u+u}),o=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(s);return o?new v(parseInt(o[1],16)/255,parseInt(o[2],16)/255,parseInt(o[3],16)/255):new v}{let n=l.split(",");return new v(parseInt(n[0].split("(")[1])/255,parseInt(n[1])/255,parseInt(n[2])/255)}}function Dt(l,t){return l.replace(/{[^{}]+}/g,function(n){return t[n.replace(/[{}]+/g,"")]||""})}function di(l,t){return l.replace(/\$\{([^}]+)\}/g,(n,s)=>(t==null?void 0:t[s.trim()])??"")}function Wr(l){let t=document.createElement("div");t.innerHTML=l;let n=[];for(let s=0;s<t.childNodes.length;s++)n.push(t.childNodes[s]),t.removeChild(t.childNodes[s]);return n}function Ro(l,t,n,s){let o=document.getElementById(l);o||(o=document.createElement("div"),o.id=l,o.classList.add("defaultText"),document.body.appendChild(o)),o.innerHTML=t,o.style.left=`${n}px`,o.style.top=`${s}px`}function Mo(l){return typeof l=="number"}function Bo(l,t=""){return l?l.trim():t}function Yt(l,t){if(l){if(Mo(l))return new v(l,l,l);if(l instanceof v)return l.clone();if(l instanceof Array)return v.fromVec(l);if(l instanceof H)return new v(l.x,l.y,0)}else if(t)return t;return new v}function le(l,t){if(l){if(ks(l))return he(l);if(l instanceof Array)return et.fromVec(l);if(l instanceof et)return l.clone()}else if(t)return t;return new et(1,1,1,1)}function jt(l,t){if(l){if(ks(l))return ts(l);if(l instanceof Array)return v.fromVec(l);if(l instanceof v)return l.clone()}else if(t)return t;return new v(1,1,1)}function $r(l,t){if(l){if(l instanceof Array)return new U(vi(l[0]),vi(l[1]));if(l instanceof U)return l.clone()}else if(t)return t;return new U}function vi(l,t){if(l){if(l instanceof Array)return new L(l[0],l[1],l[2]);if(l instanceof L)return l.clone()}else if(t)return t;return new L}function Xr(l,t){let n=0,s=l.length-1;for(;n<=s;){let o=Math.floor(.5*(n+s));if(Math.abs(l[o]-t)<.001)return o;l[o]<t?n=o+1:s=o-1}return-1}function Re(l,t,n){let s=0,o=l.length-1;for(;s<=o;){let a=o+s>>1,h=n(t,l[a],a);if(h>0)s=a+1;else{if(!(h<0))return a;o=a-1}}return-s-1}function Zr(l,t,n){let s=Re(l,t,n);return s<0&&(s=~s),l.splice(s,0,t),s}function ko(l,t,n,s,o=!1){let a=new L(t.lon-l.lon,t.lat-l.lat),h=new L(s.lon-n.lon,s.lat-n.lat),c=-a.lat,u=+a.lon,d=-(c*l.lon+u*l.lat),f=-h.lat,g=+h.lon,_=-(f*n.lon+g*n.lat),m=f*l.lon+g*l.lat+_,p=f*t.lon+g*t.lat+_,x=c*n.lon+u*n.lat+d,y=c*s.lon+u*s.lat+d;if(o&&(m*p>0||x*y>0))return;let T=m/(m-p);return new L(l.lon+T*a.lon,l.lat+T*a.lat)}const Oa={string:function(l){return Gt(l)?l:l.toString()},date:function(l){return Gt(l)?l:new Date(1e3*l)},datetime:function(l){return Gt(l)?l:new Date(1e3*l)},time:function(l){return Gt(l)?l:parseInt(l)},integer:function(l){return Gt(l)?l:parseInt(l)},float:function(l){return Gt(l)?l:parseFloat(l)},boolean:function(l){if(l===null)return l;if(typeof l=="boolean")return l===!0;if(typeof l=="string"){if(l==="")return!1;if((l=l.replace(/^\s+|\s+$/g,"")).toLowerCase()==="true"||l.toLowerCase()==="yes")return!0;l=(l=l.replace(/,/g,".")).replace(/^\s*\-\s*/g,"-")}return!isNaN(l)&&parseFloat(l)!==0}};function yn(l,t=""){let n=1024,s=atob(l),o=s.length,a=Math.ceil(o/n),h=new Array(a);for(let c=0;c<a;++c){let u=c*n,d=Math.min(u+n,o),f=new Array(d-u);for(let g=u,_=0;g<d;++_,++g)f[_]=s[g].charCodeAt(0);h[c]=new Uint8Array(f)}return new Blob(h,{type:t})}function yi(l,t,n=!1){let s,o=0;return function(){const a=arguments;o?(n&&clearTimeout(s),s=setTimeout(()=>{Date.now()-o>=t&&(l.apply(null,a),o=Date.now())},t-(Date.now()-o))):(l.apply(null,a),o=Date.now())}}function it(l,t){let n=new l.constructor(l.length+t.length);return n.set(l,0),n.set(t,l.length),n}function bt(l=[],t=[]){if(ArrayBuffer.isView(l))return it(l,t);for(let n=0;n<t.length;n++)l.push(t[n]);return l}function st(l,t=Float32Array){if(ArrayBuffer.isView(l))return l;{const n=new t(l.length);return n.set(l,0),n}}function Ve(l){return ArrayBuffer.isView(l)?Array.from(l):l}function Et(l,t,n,s){if(ArrayBuffer.isView(l))return t<0&&(n=Math.abs(t),t+=l.length),ot(l,t,n,s);{let o;return o=t<0?l.splice(t):l.splice(t,n),s&&(s.result=o),l}}function ot(l,t,n,s){if(l.length===0)return l;const o=l.length-n,a=new l.constructor(o);return a.set(l.subarray(0,t)),a.set(l.subarray(t+n),t),s&&(s.result=l.subarray(t,t+n)),a}function Kr(l,t,n,s,o){const a=o+1,h=n+a,c=s+a;let u=new Float64Array(a*a*3),d=0;for(let f=n;f<h;f++)for(let g=s;g<c;g++){let _=3*(f*(t+1)+g);u[d++]=l[_],u[d++]=l[_+1],u[d++]=l[_+2]}return u}function Io(l,t,n,s,o){const a=o+1,h=n+a,c=s+a;let u=new Float32Array(a*a*3),d=0;for(let f=n;f<h;f++)for(let g=s;g<c;g++){let _=3*(f*(t+1)+g);u[d++]=l[_],u[d++]=l[_+1],u[d++]=l[_+2]}return u}function dr(l,t,n,s,o,a,h,c,u,d,f,g,_){const m=a+c+1,p=h+c+1;o+=1;let x=0,y=0;for(let T=a;T<m;T++)for(let S=h;S<p;S++){let C=T*o+S,P=3*C,w=l[P],I=l[P+1],O=l[P+2];s&&s[C]!==0?_[y]=1:(w<g.xmin&&(g.xmin=w),w>g.xmax&&(g.xmax=w),I<g.ymin&&(g.ymin=I),I>g.ymax&&(g.ymax=I),O<g.zmin&&(g.zmin=O),O>g.zmax&&(g.zmax=O)),y++,u[x]=w,f[x]=n[P],d[x++]=t[P],u[x]=I,f[x]=n[P+1],d[x++]=t[P+1],u[x]=O,f[x]=n[P+2],d[x++]=t[P+2]}}function Qr(l){return l.map(t=>Array.isArray(t)?Qr(t):t)}async function Ui(l){return new Promise(t=>{const n=new Image;return n.addEventListener("load",()=>{t(n)}),n.src=l,n.crossOrigin="",n})}function ur(l){return l.complete&&l.naturalHeight!==0}function Ge(l){return l>1e3?l-Math.floor(l)!=0?[(l/1e3).toFixed(2),"km"]:[(l/1e3).toFixed(0),"km"]:l>9?[Math.round(l).toString(),"m"]:l<=.01?["0","m"]:[l.toFixed(1),"m"]}function zo(l){let t=new URLSearchParams(location.search).get(l);if(t)return Number(t)}function _r(l,t=-1){if(t<0)return l.toString();const n=Math.pow(10,t);return(Math.round(l*n)/n).toString()}Object.freeze(Object.defineProperty({__proto__:null,base64StringToBlog:function(l){let t=l.split(";"),n=t[0].split(":")[1];return yn(t[1].split(",")[1],n)},base64toBlob:yn,binaryInsert:Zr,binarySearch:Re,binarySearchFast:Xr,blerp:function(l,t,n,s,o,a,h=0,c=1,u=0,d=1){return(n*(c-l)*(d-t)+s*(l-h)*(d-t)+o*(c-l)*(t-u)+a*(l-h)*(t-u))/((c-h)*(d-u))},blerp2:function(l,t,n,s,o,a){return n*(1-l)*(1-t)+s*l*(1-t)+o*(1-l)*t+a*l*t},castType:Oa,cloneArray:Qr,concatArrays:bt,concatTypedArrays:it,createColorRGB:jt,createColorRGBA:le,createExtent:$r,createLonLat:vi,createVector3:Yt,createVector4:function(l,t){if(l){if(l instanceof et)return l.clone();if(l instanceof Array)return et.fromVec(l)}else if(t)return t;return new et},defaultString:Bo,distanceFormat:function(l){return l>1e3?`${(l/1e3).toFixed(2)} km`:l>9?`${Math.round(l)} m`:`${l.toFixed(1)} m`},distanceFormatExt:Ge,extractElevationTiles:function(l,t,n){let s=Math.sqrt(t.length)-1,o=s+1,a=Math.sqrt(l.length/4),h=a/s,c=0,u=0;for(let d=0,f=0,g=l.length/4;d<g;d++){let _=l[4*d],m=Math.floor(d/a),p=d%a,x=Math.floor(p/s),y=Math.floor(m/s),T=n[y][x],S=m%s,C=p%s,P=(S+y)*o+C+x;if(T[P]=_,(m+y)%h==0&&(p+x)%h==0&&(t[f++]=_),(p+1)%s==0&&p!==a-1){c=l[4*(d+1)];let w=.5*(_+c);P=(S+y)*o+C+1,T[P]=w,(m+y)%h==0&&(t[f++]=w);let I=(S+y)*o+(C+1)%s;n[y][x+1][I]=w}if((m+1)%s==0&&m!==a-1){u=l[4*(d+a)];let w=.5*(_+u);P=(S+1)*o+C+x,T[P]=w,(p+x)%h==0&&(t[f++]=w);let I=(S+1)%s*o+C+x;n[y+1][x][I]=w}if((p+1)%s==0&&p!==a-1&&(m+1)%s==0&&m!==a-1){let w=.25*(_+c+u+l[4*(d+a+1)]);P=(S+1)*o+(C+1),T[P]=w,t[f++]=w;let I=(S+1)*o;n[y][x+1][I]=w;let O=s;n[y+1][x][O]=w;let N=0;n[y+1][x+1][N]=w}}},getDefault:Vi,getHTML:function(l,t){return Dt(l,t)},getLinesIntersection2v:function(l,t,n,s,o){let a=t.sub(l),h=s.sub(n),c=-a.y,u=+a.x,d=-(c*l.x+u*l.y),f=-h.y,g=+h.x,_=-(f*n.x+g*n.y),m=f*l.x+g*l.y+_,p=f*t.x+g*t.y+_,x=c*n.x+u*n.y+d,y=c*s.x+u*s.y+d;if(o&&(m*p>0||x*y>0))return;let T=m/(m-p);return new H(l.x+T*a.x,l.y+T*a.y)},getLinesIntersectionLonLat:ko,getMatrixSubArray32:Io,getMatrixSubArray64:Kr,getMatrixSubArrayBoundsExt:dr,getTileImageResolution:function(l,t,n,s=256,o=So){let a=Ze(l,t,n),h=a.getSouthWest().inverseMercator(),c=a.getNorthEast().inverseMercator();return[o.getGreatCircleDistance(h,new L(c.lon,h.lat))/s,o.getGreatCircleDistance(h,new L(h.lon,c.lat))/s]},getUrlParam:zo,htmlColorToFloat32Array:ve,htmlColorToRgb:ts,htmlColorToRgba:he,isEmpty:Gt,isImageLoaded:ur,isNumber:Mo,isString:ks,isUndef:vn,isUndefExt:function(l,t){return vn(l)?t:l},loadImage:Ui,makeArray:Ve,makeArrayTyped:st,parseHTML:Wr,print2d:Ro,rgbToStringHTML:cr,spliceArray:Et,spliceTypedArray:ot,stamp:Yr,stringTemplate:Dt,stringTemplate2:di,throttle:yi,toFixedMax:_r,xmlToJson:function l(t){let n={};if(t.nodeType===1){if(t.attributes.length>0){n["@attributes"]={};for(let s=0;s<t.attributes.length;s++){let o=t.attributes.item(s);n["@attributes"][o.nodeName]=o.nodeValue}}}else t.nodeType===3&&(n=t.nodeValue);if(t.hasChildNodes())for(let s=0;s<t.childNodes.length;s++){let o=t.childNodes.item(s),a=o.nodeName;if(n[a]===void 0)n[a]=l(o);else{if(n[a].push===void 0){let h=n[a];n[a]=[],n[a].push(h)}n[a].push(l(o))}}return n}},Symbol.toStringTag,{value:"Module"}));const Gi=1e3,fr=1/60,xn=1/24,xi=3600,gr=1/xi,Jr=43200,ji=1440,Na=1/ji,ee=86400,Ha=864e5,tn=11574074074074074e-24,oe=1/ee,es=2451545;function Do(l,t,n){let s=(t-14)/12|0,o=l+4800+s;return(1461*o/4|0)+(367*(t-2-12*s)/12|0)-(3*((o+100)/100|0)/4|0)+n-32075}function is(l){let t=Do(l.getUTCFullYear(),l.getUTCMonth()+1,l.getUTCDate()),n=l.getUTCHours()-12;n<0&&(n+=24);let s=l.getUTCSeconds()+n*xi+60*l.getUTCMinutes()+.001*l.getUTCMilliseconds();s>=Jr&&t--;let o=s*oe|0;return t+=o,s-=ee*o,s<0&&(t--,s+=ee),t+s*oe}function pr(l){let t=Oo,n=Re(t,l,function(o,a){return o-a.jd});n<0&&(n=~n),n>=t.length&&(n=t.length-1);let s=t[n].leapSeconds;return n!==0&&(t[n].jd-l)*ee>s&&(s=t[n-1].leapSeconds),l+s*oe}function Gs(l){let t=Oo,n=Re(t,l,function(o,a){return o-a.jd});if(n<0&&(n=~n),n>=t.length)return l-t[n-1].leapSeconds*oe;if(n===0)return l-t[0].leapSeconds*oe;let s=(t[n].jd-l)*ee;return s===0?l-t[n].leapSeconds*oe:s<=1?void 0:l-t[n-1].leapSeconds*oe}function mr(l){let t=0|l,n=(l-t)*ee;n>=Jr&&t++;let s=t+68569|0,o=4*s/146097|0;s=s-((146097*o+3)/4|0)|0;let a=4e3*(s+1)/1461001|0;s=s-(1461*a/4|0)+31|0;let h=80*s/2447|0,c=s-(2447*h/80|0)|0;s=h/11|0;let u=h+2-12*s|0,d=100*(o-49)+a+s|0,f=n*gr|0,g=n-f*xi,_=g*fr|0;g-=60*_;let m=0|g,p=(g-m)*Gi|0;return f+=12,f>23&&(f-=24),new Date(Date.UTC(d,u-1,c,f,_,m,p))}function Fo(l,t){return l+t*tn}function bn(l,t){return l+t*oe}function nt(l,t){return{jd:l,leapSeconds:t}}const Oo=[nt(24413175e-1,10),nt(24414995e-1,11),nt(24416835e-1,12),nt(24420485e-1,13),nt(24424135e-1,14),nt(24427785e-1,15),nt(24431445e-1,16),nt(24435095e-1,17),nt(24438745e-1,18),nt(24442395e-1,19),nt(24447865e-1,20),nt(24451515e-1,21),nt(24455165e-1,22),nt(24462475e-1,23),nt(24471615e-1,24),nt(24478925e-1,25),nt(24482575e-1,26),nt(24488045e-1,27),nt(24491695e-1,28),nt(24495345e-1,29),nt(24500835e-1,30),nt(24506305e-1,31),nt(24511795e-1,32),nt(24537365e-1,33),nt(24548325e-1,34),nt(24561095e-1,35),nt(24572045e-1,36)],Va=pr(es);Object.freeze(Object.defineProperty({__proto__:null,DAYS_PER_JULIAN_CENTURY:36525,DAYS_PER_JULIAN_YEAR:365.25,DateToTAI:function(l){return pr(is(l))},DateToUTC:is,HOURS_PER_DAY:24,J2000:es,J2000TAI:Va,MILLISECONDS_PER_DAY:Ha,MILLISECONDS_PER_SECOND:Gi,MINUTES_PER_DAY:ji,MINUTES_PER_HOUR:60,MODIFIED_JULIAN_DATE_DIFFERENCE:24000005e-1,ONE_BY_HOURS_PER_DAY:xn,ONE_BY_MILLISECONDS_PER_DAY:tn,ONE_BY_MINUTES_PER_DAY:Na,ONE_BY_SECONDS_PER_DAY:oe,ONE_BY_SECONDS_PER_HOUR:gr,ONE_BY_SECONDS_PER_MINUTE:fr,PICOSECOND:1e-9,SECONDS_PER_12_HOURS:Jr,SECONDS_PER_DAY:ee,SECONDS_PER_HOUR:xi,SECONDS_PER_MILLISECOND:.001,SECONDS_PER_MINUTE:60,T:function(l){return(l-es)/36525},TAItoDate:function(l){let t=Gs(l);return t||(t=Gs(bn(l,-1)),console.trace(`TAItoDate - can't convert ${l.toString()} to utc.`)),mr(t)},TAItoUTC:Gs,UTCtoDate:mr,UTCtoTAI:pr,addDays:function(l,t){return l+t},addHours:function(l,t){return l+t*xn},addMilliseconds:Fo,addMinutes:function(l,t){return l+t*ji},addSeconds:bn,daysToSeconds:function(l){return l*ee},getDayNumber:Do,getDays:function(l){return 0|l},getHours:function(l){let t=(l-(0|l))*ee,n=t*gr|0,s=t-n*xi,o=s*fr|0;s-=60*o;let a=0|s;return n+=12+o/60+a/3600+((s-a)*Gi|0)/1e3,n>23&&(n-=24),n},getMilliseconds:function(l){let t=l-(0|l);return t*=ee,(t-(0|t))*Gi|0},getMinutes:function(l){return(l-(0|l))*ji|0},getSeconds:function(l){return(l-(0|l))*ee},secondsToDays:function(l){return l*oe}},Symbol.toStringTag,{value:"Module"}));class No{constructor(t){this.vertices=[new v,new v,new v,new v,new v,new v,new v,new v],t&&this.setFromBoundsArr(t)}copy(t){for(let n=0,s=this.vertices.length;n<s;n++)this.vertices[n].copy(t.vertices[n])}setFromBoundsArr(t){let n=t[0],s=t[3],o=t[1],a=t[4],h=t[2],c=t[5],u=this.vertices;u[0].set(n,o,h),u[1].set(s,o,h),u[2].set(s,o,c),u[3].set(n,o,c),u[4].set(n,a,h),u[5].set(s,a,h),u[6].set(s,a,c),u[7].set(n,a,c)}setFromExtent(t,n){this.setFromBoundsArr(n.getCartesianBounds(t))}}class Ft{constructor(t=0,n){this.radius=t,this.center=n?n.clone():new v}setFromBounds(t){let n=new v(t[0],t[1],t[2]);this.center.set(n.x+.5*(t[3]-n.x),n.y+.5*(t[3]-n.y),n.z+.5*(t[5]-n.z)),this.radius=this.center.distance(n)}setFromExtent(t,n){this.setFromBounds(n.getCartesianBounds(t))}}Object.freeze(Object.defineProperty({__proto__:null,Box:No,Sphere:Ft},Symbol.toStringTag,{value:"Module"}));function lt(l,t){return new bi(l,t)}const cs=class qu{constructor(t,n){this.__id=qu.__counter__++,this._eventNames=[],t&&this.registerNames(t),this._sender=n||this,this._stopPropagation=!1,this._stampCache={}}bindSender(t){this._sender=t||this}registerNames(t){for(let n=0;n<t.length;n++)this[t[n]]={active:!0,handlers:[]},this._eventNames.push(t[n]);return this}_getStamp(t,n,s){return`${t}_${n}_${s}`}_stamp(t,n){let s=Yr(n),o=this._getStamp(t,this.__id,s);return!this._stampCache[o]&&(this._stampCache[o]=s,!0)}on(t,n,s,o=0){if(this._stamp(t,n)&&this[t]){let a=n.bind(s||this._sender);a._openglobus_id=n._openglobus_id,a._openglobus_priority=o,Zr(this[t].handlers,a,(h,c)=>(c._openglobus_priority||0)-(h._openglobus_priority||0))}}off(t,n){if(n){let s=this._getStamp(t,this.__id,n._openglobus_id);if(n._openglobus_id&&this._stampCache[s]){let o=this[t].handlers,a=o.length,h=-1;for(;a--;)if(o[a]._openglobus_id===n._openglobus_id){h=a;break}h!==-1&&(o.splice(h,1),this._stampCache[s]=void 0,delete this._stampCache[s])}}}dispatch(t,...n){let s=!0;if(t&&t.active&&!this._stopPropagation){let o=t.handlers.slice(0),a=o.length;for(;a--;)o[a](...n)===!1&&(s=!1)}return this._stopPropagation=!1,s}stopPropagation(){this._stopPropagation=!0}clear(){for(let t=0;t<this._eventNames.length;t++){let n=this[this._eventNames[t]];n.handlers.length=0,n.handlers=[]}this._eventNames.length=0,this._eventNames=[]}};cs.__counter__=0;let bi=cs;const Ua=["render"],Vt=class Bc{constructor(t={}){this.__id=Bc.__counter__++,this.events=lt(Ua),this.model=t.model||null,this.template=t.template||"",this.parent=t.parent||null,this._classList=t.classList||[],this.el=null,t.initRender&&this.render()}on(t,n,s,o){this.events.on(t,n,s,o)}off(t,n){this.events.off(t,n)}static getHTML(t,n){return Dt(t,n)}static parseHTML(t){return Wr(t)}static insertAfter(t,n){Array.isArray(t)||(t=[t]);for(let s=0;s<t.length;s++)n.parentNode&&n.parentNode.insertBefore(t[s],n.nextSibling);return t}static insertBefore(t,n){Array.isArray(t)||(t=[t]);for(let s=0;s<t.length;s++)n.parentNode&&n.parentNode.insertBefore(t[s],n);return t}insertBefore(t){this.el||this.render(),this.el&&(t instanceof HTMLElement&&t.parentNode&&Bc.insertBefore(this.el,t),t instanceof Bc&&t.el&&t.el.parentNode&&Bc.insertBefore(this.el,t.el))}insertAfter(t){this.el||this.render(),this.el&&(t instanceof HTMLElement&&t.parentNode&&Bc.insertAfter(this.el,t),t instanceof Bc&&t.el&&t.el.parentNode&&Bc.insertAfter(this.el,t.el))}isEqual(t){return t.__id===this.__id}appendTo(t,n=!1,s=!1){return t&&(this.el||(this.beforeRender(t),this.render()),this.el&&this.el.parentNode&&this.el.parentNode.removeChild(this.el),n&&(t.innerHTML=""),this.el&&(s&&t.childNodes[0]?Bc.insertBefore(this.el,t.childNodes[0]):t.appendChild(this.el)),this.afterRender(t)),this}afterRender(t){}beforeRender(t){}stopPropagation(){this.events.stopPropagation()}renderTemplate(t){return Bc.parseHTML(Bc.getHTML(this.template,t||{}))[0]}render(t){this.el=this.renderTemplate(t);for(let n=0,s=this._classList.length;n<s;n++)this.el.classList.add(this._classList[n]);return this.events.dispatch(this.events.render,this),this}select(t){return this.el?this.el.querySelector(t):null}selectRemove(t){if(this.el){let n=this.select(t);if(n&&n.parentNode)return n.parentNode.removeChild(n),n}}selectAll(t,n){if(this.el){const s=this.el.querySelectorAll(t);if(n)for(let o=0,a=s.length;o<a;o++)n(s[o],o);return s}}remove(){this.el&&this.el.parentNode&&this.el.parentNode.removeChild(this.el)}};Vt.__counter__=0;let ut=Vt;const Ga=["click","mousedown","mouseup","touchstart","touchend","touchcancel"];class ce extends ut{constructor(t={}){super({template:Dt(`<div class="og-button" title="{title}">
       <div class="og-button-icon">{icon}</div>
       <div class="og-button-text">{text}</div>
    </div>`,{icon:t.icon||"",text:t.text||"",title:t.title||""}),...t}),this._onMouseDown=n=>{n.preventDefault(),this.events.dispatch(this.events.mousedown,this,n)},this._onMouseUp=n=>{n.preventDefault(),this.events.dispatch(this.events.mouseup,this,n)},this._onTouchStart=n=>{n.preventDefault(),this.events.dispatch(this.events.touchstart,this,n)},this._onTouchEnd=n=>{n.preventDefault(),this.events.dispatch(this.events.touchend,this,n)},this._onTouchCancel=n=>{n.preventDefault(),this.events.dispatch(this.events.touchcancel,this,n)},this._onMouseClick=n=>{this._mouseClickHandler(n)},this.events=this.events.registerNames(Ga),this.el=null,this.name=t.name||"",this.$icon=null,this.$text=null}render(t){return super.render(t),this.$icon=this.select(".og-button-icon"),this.$text=this.select(".og-button-text"),this.el.__og_button__=this,this._initEvents(),this}_initEvents(){this.el&&(this.el.addEventListener("click",this._onMouseClick),this.el.addEventListener("mousedown",this._onMouseDown),this.el.addEventListener("mouseup",this._onMouseUp),this.el.addEventListener("touchstart",this._onTouchStart),this.el.addEventListener("touchend",this._onTouchEnd),this.el.addEventListener("touchcancel",this._onTouchCancel))}_mouseClickHandler(t){t.preventDefault(),this.events.dispatch(this.events.click,this,t)}remove(){this._clearEvents(),super.remove()}_clearEvents(){this.el&&this.el.removeEventListener("click",this._onMouseClick)}}const ds=class Zu{constructor(t={}){this.__id=Zu.__counter__++,this._name=t.name||`_control_${this.__id.toString()}`,this.planet=null,this._initialized=!1,this.renderer=null,this.autoActivate=t.autoActivate||!1,this._active=!1,this._deferredActive=!0}get name(){return this._name}oninit(){}onadd(){}onremove(){}onactivate(){}ondeactivate(){}addTo(t){t&&(this.renderer=t,t.controls[this.name]=this,this.onadd&&this.onadd(),t.isInitialized()&&!this._initialized&&(this._initialized=!0,this.oninit&&this.oninit(),this.autoActivate&&this.activate()))}remove(){this.deactivate(),this.onremove&&this.onremove();let t=this.renderer,n=this.name;if(!t)return;let s=t.controls[n];s&&this.isEqual(s)&&delete t.controls[n],this.renderer=null,this._active=!1,this._initialized=!1}activate(){this._active||(this._initialized||(this._initialized=!0,this.oninit&&this.oninit()),this._deferredActive?(this._active=!0,this.onactivate&&this.onactivate()):this._deferredActive=!0)}deactivate(){this._active?(this._active=!1,this.ondeactivate&&this.ondeactivate()):this._initialized||(this._deferredActive=!1)}isActive(){return this._active}isEqual(t){return t.__id===this.__id}};ds.__counter__=0;let Q=ds;class Ho extends Q{constructor(t={}){super(t),this._heading=0,this._svg=null}oninit(){let t=new ce({classList:["og-map-button","og-compass-button"],icon:`<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<svg
   xmlns:dc="http://purl.org/dc/elements/1.1/"
   xmlns:cc="http://creativecommons.org/ns#"
   xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
   xmlns:svg="http://www.w3.org/2000/svg"
   xmlns="http://www.w3.org/2000/svg"
   xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd"
   xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"
   viewBox="0 0 110.6 110.3"
   version="1.1"
   id="svg21"
   sodipodi:docname="aaa.svg"
   inkscape:version="0.92.3 (2405546, 2018-03-11)">
  <metadata
     id="metadata11">
    <rdf:RDF>
      <cc:Work
         rdf:about="">
        <dc:format>image/svg+xml</dc:format>
        <dc:type
           rdf:resource="http://purl.org/dc/dcmitype/StillImage" />
      </cc:Work>
    </rdf:RDF>
  </metadata>
  <defs
     id="defs25" />
  <sodipodi:namedview
     pagecolor="#ffffff"
     bordercolor="#666666"
     borderopacity="1"
     objecttolerance="10"
     gridtolerance="10"
     guidetolerance="10"
     inkscape:pageopacity="0"
     inkscape:pageshadow="2"
     inkscape:window-width="1920"
     inkscape:window-height="1001"
     id="namedview23"
     showgrid="false"
     inkscape:zoom="9.4900968"
     inkscape:cx="28.376998"
     inkscape:cy="60.17054"
     inkscape:window-x="-9"
     inkscape:window-y="-9"
     inkscape:window-maximized="1"
     inkscape:current-layer="svg21" />
  <g
     id="Layer_2"
     data-name="Layer 2"
     transform="matrix(1,0,0,-1,0,110.3)">
    <g
       id="Слой_1"
       data-name="Слой 1">
      <g
         id="_Group_"
         data-name="&lt;Group&gt;">
        <g
           id="_Group_7"
           data-name="&lt;Group&gt;">
          <polygon
             id="_Path_7"
             data-name="&lt;Path&gt;"
             points="55.2,97.6 55.3,97.4 55.3,97.6 55.3,97.2 65.3,55.1 55.3,55.1 55.2,55.1 45.3,55.1 55.2,97.2 "
             style="fill:#ff2b45" />
          <polygon
             id="_Path_8"
             data-name="&lt;Path&gt;"
             points="55.3,12.7 55.3,12.9 55.2,12.7 55.2,13.1 45.3,55.1 55.2,55.1 55.3,55.1 65.3,55.1 55.3,13.1 "
             style="fill:#cecece;" />
        </g>
      </g>
    </g>
  </g>
</svg>`});t.appendTo(this.renderer.div),t.events.on("click",this._onClick,this),t.events.on("touchstart",this._onClick,this),this._svg=t.select("svg"),this.renderer.events.on("draw",this._draw,this)}_onClick(){const t=this.planet;let n=t.getCartesianFromPixelTerrain(this.renderer.handler.getCenter());n?t.flyCartesian(n.normal().scaleTo(n.length()+n.distance(t.camera.eye)),{amplitude:0,completeCallback:()=>{t.camera.look(n)}}):t.flyCartesian(t.camera.eye)}_draw(){this.setHeading(this.planet.camera.getHeading())}setHeading(t){this._heading!==t&&(this._heading=t,this._svg.style.transform=`rotateZ(${-t}deg)`)}}const Vo=`<svg className="svg-icon" style="width: 1em; height: 1em;vertical-align: middle;fill: currentColor; overflow: hidden;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
    <path d="M777.856 280.192l-33.92-33.952-231.872 231.872-231.84-231.872-33.984 33.888 231.872 231.904-231.84 231.84 33.888 33.984 231.904-231.904 231.84 231.872 33.952-33.888-231.872-231.904z"/>
</svg>`,ja=["resize","focus","visibility","dragstart","dragend"],us=class Ku extends ut{constructor(t={}){super({template:Dt(`<div class="og-ddialog" 
        style="display:{display}; resize:{resize}; width: {width}px; {height}; top: {top}px; left: {left}px; min-height: {minHeight}; max-height: {maxHeight}; min-width: {minWidth}; max-width: {maxWidth};">
       <div class="og-ddialog-header">
         <div class="og-ddialog-header__title">{title}</div>      
         <div class="og-ddialog-header__buttons"></div>      
        </div>
       <div class="og-ddialog-container"></div>
    </div>>`,{title:t.title||"",display:Vi(t.visible,!0)?"flex":"none",resize:Vi(t.resizable,!0)?"both":"none",width:t.width||300,height:t.height?`height: ${t.height||200}px`:"",left:t.left||0,top:t.top||0,minHeight:t.minHeight?`${t.minHeight}px`:"unset",maxHeight:t.maxHeight?`${t.maxHeight}px`:"unset",minWidth:t.minWidth?`${t.minWidth}px`:"unset",maxWidth:t.maxWidth?`${t.maxWidth}px`:"unset"}),...t}),this._onCloseBtnClick=()=>{this.close()},this._onMouseDownAll=()=>{this.bringToFront()},this._onMouseDown=n=>{n.preventDefault(),this._startDragging(),this._startPosX=n.clientX,this._startPosY=n.clientY,document.addEventListener("mousemove",this._onMouseMove),document.addEventListener("mouseup",this._onMouseUp)},this._onMouseMove=n=>{n.preventDefault();let s=this._startPosX-n.clientX,o=this._startPosY-n.clientY;this._startPosX=n.clientX,this._startPosY=n.clientY,this.setPosition(this.el.offsetLeft-s,this.el.offsetTop-o)},this._onMouseUp=()=>{this._clearDragging(),document.removeEventListener("mouseup",this._onMouseUp),document.removeEventListener("mousemove",this._onMouseMove)},this.events=this.events.registerNames(ja),this._width=t.width||300,this._height=t.height||200,this._startPosX=0,this._startPosY=0,this.$header=null,this.$title=null,this.$container=null,this.$buttons=null,this._closeBtn=new ce({icon:Vo,classList:["og-button-size__20"]}),this.useHide=t.useHide||!1,this._visibility=Vi(t.visible,!0),this._right=t.right!=null?t.right:null}setContainer(t){this.$container.innerHTML=t}get container(){return this.$container}get width(){return this.el?parseFloat(this.el.style.width):this._width}get height(){return this.el?parseFloat(this.el.style.height):this._height}bringToFront(){this.el.style.zIndex=String(Ku.__zIndex__++)}render(t){return super.render(t),this.bringToFront(),this.$header=this.select(".og-ddialog-header"),this.$title=this.select(".og-ddialog-header__title"),this.$container=this.select(".og-ddialog-container"),this.$buttons=this.select(".og-ddialog-header__buttons"),this._initEvents(),this._initButtons(),this._right!=null&&(this.el.style.visibility="hidden",new IntersectionObserver((n,s)=>{n.forEach(o=>{o.isIntersecting&&(this.el.style.visibility="visible",this.el.parentNode&&(this.setPosition(this.el.parentNode.clientWidth-this.el.clientWidth-this._right),s.disconnect()))})}).observe(this.el)),this}show(){this._visibility||(this._visibility=!0,this.el.style.display="flex",this.bringToFront(),this.events.dispatch(this.events.visibility,!0,this))}hide(){this._visibility&&(this._visibility=!1,this.el.style.display="none",this.events.dispatch(this.events.visibility,!1,this))}close(){this.useHide?this.hide():this.remove()}setVisibility(t){t?this.show():this.hide()}getVisibility(){return this._visibility}_initButtons(){this._closeBtn.events.on("click",this._onCloseBtnClick),this._closeBtn.appendTo(this.$buttons)}_initEvents(){this.$header.addEventListener("mousedown",this._onMouseDown),this.el.addEventListener("mousedown",this._onMouseDownAll)}setPosition(t,n){t!=null&&(this.el.style.left=`${t}px`),n!=null&&(this.el.style.top=`${n}px`)}_startDragging(){this.el.classList.contains("dragging")||(this.el.classList.add("dragging"),this.events.dispatch(this.events.dragstart,this))}_clearDragging(){this.el.classList.contains("dragging")&&(this.events.dispatch(this.events.dragend,this),this.el.classList.remove("dragging"))}remove(){this._clearDragging(),this._clearEvents(),super.remove()}_clearEvents(){this._closeBtn.events.off("click",this._onCloseBtnClick),document.removeEventListener("mouseup",this._onMouseUp),document.removeEventListener("mousemove",this._onMouseMove),this.$header.removeEventListener("mousedown",this._onMouseDown),this.el.removeEventListener("mousedown",this._onMouseDownAll)}};us.__zIndex__=0;let Kt=us;const qa=["change"];class dt extends ce{constructor(t){super({...t}),this._onMouseClick=n=>{this.preventClick||(this._mouseClickHandler(n),this.setActive(!this.isActive))},this.events=this.events.registerNames(qa),this._isActive=t.isActive||!1,this.preventClick=t.preventClick||!1}setActive(t,n=!1){t!==this._isActive&&(this._isActive=t,this._toggle(),n||this.events.dispatch(this.events.change,t,this))}_toggle(){this.el&&this.el.classList.toggle("og-button__active")}get isActive(){return this._isActive}render(t){return super.render(t),this._isActive&&this._toggle(),this}}const ui=[2,3,0,1],wn=[[-1,-1,0,1],[1,-1,3,-1],[2,3,-1,-1],[-1,0,-1,2]],Ya=[[2,3,0,1],[1,0,3,2],[2,3,0,1],[1,0,3,2]],Wa=[[0,1,0,0],[1,0,0,0],[0,1,0,1],[1,1,1,1]];class Uo{constructor(t,n){this.segment=t,this.layer=n,this.isReady=!1,this.isLoading=!1,this.texture=null,this.pickingMask=null,this.textureExists=!1,this.appliedNodeId=0,this.appliedNode=null,this.texOffset=[0,0,1,1],this.loadingAttempts=0,this._updateTexture=null,this._updatePickingMask=null,this.pickingReady=!1}abortLoading(){this.layer.abortMaterialLoading(this)}_createTexture(t){return this.layer._planet&&this.layer.createTexture(t,this.layer._internalFormat,this.isReady?this.texture:null)}applyImage(t){this.segment.initialized&&(this._updateTexture=null,this.texture=this._createTexture(t),this.isReady=!0,this.pickingReady=!0,this.textureExists=!0,this.isLoading=!1,this.appliedNodeId=this.segment.node.nodeId,this.texOffset=[0,0,1,1])}applyTexture(t,n){this.segment.initialized&&(this.texture=t,this._updateTexture=null,this.pickingMask=n||null,this._updatePickingMask=null,this.isReady=!0,this.pickingReady=!0,this.textureExists=!0,this.isLoading=!1,this.appliedNodeId=this.segment.node.nodeId,this.texOffset=[0,0,1,1])}textureNotExists(){this.segment.initialized&&(this.pickingReady=!0,this.isLoading=!1,this.isReady=!0,this.textureExists=!1)}clear(){this.loadingAttempts=0,this.layer.clearMaterial(this)}}const _s=class Qu{constructor(t,n={}){if(this.isVector=!1,this.__id=Qu.__counter__++,this._iconSrc=n.iconSrc||null,this.events=lt(Go,this),this.name=t||"noname",this.properties=n.properties||{},this.hideInLayerSwitcher=n.hideInLayerSwitcher||!1,this._hasImageryTiles=!0,this._opacity=n.opacity!=null?n.opacity:1,this.minZoom=n.minZoom||0,this.maxZoom=n.maxZoom!=null?n.maxZoom:50,this._planet=null,this.isVector=!1,this._attribution=n.attribution||"",this._zIndex=n.zIndex||0,this._isBaseLayer=n.isBaseLayer||!1,this._defaultTextures=n.defaultTextures||[null,null],this._visibility=n.visibility===void 0||n.visibility,this._fading=n.fading||!1,this._fadingFactor=this._opacity/30,this._fading?this._fadingOpacity=0:this._fadingOpacity=this._opacity,this._height=n.height||0,this._extent=new U,this.createTexture=null,this._textureFilter=n.textureFilter?n.textureFilter.trim().toUpperCase():"MIPMAP",this._isSRGB=n.isSRGB!=null&&n.isSRGB,this._internalFormat=null,this._extentMerc=new U,this.setExtent($r(n.extent,new U(new L(-180,-90),new L(180,90)))),this._pickingColor=new v,this._pickingEnabled=n.pickingEnabled===void 0||n.pickingEnabled,this._isPreloadDone=!1,this._preLoadZoomLevels=n.preLoadZoomLevels||[0,1],this._ambient=null,this._diffuse=null,this._specular=null,n.ambient){let s=jt(n.ambient,new v(.2,.2,.2));this._ambient=new Float32Array([s.x,s.y,s.z])}if(n.diffuse){let s=jt(n.diffuse,new v(.8,.8,.8));this._diffuse=new Float32Array([s.x,s.y,s.z])}if(n.specular){let s=jt(n.specular,new v(3e-4,3e-4,3e-4)),o=n.shininess||20;this._specular=new Float32Array([s.x,s.y,s.z,o])}this.nightTextureCoefficient=n.nightTextureCoefficient||1}get iconSrc(){return this._iconSrc}set iconSrc(t){this._iconSrc=t}set diffuse(t){if(t){let n=jt(t);this._diffuse=new Float32Array(n.toArray())}else this._diffuse=null}set ambient(t){if(t){let n=jt(t);this._ambient=new Float32Array(n.toArray())}else this._ambient=null}set specular(t){if(t){let n=jt(t);this._specular=new Float32Array([n.x,n.y,n.y,this._specular?this._specular[3]:0])}else this._specular=null}set shininess(t){this._specular&&(this._specular[3]=t)}static getTMS(t,n,s){return{x:t,y:(1<<s)-n-1,z:s}}static getTileIndex(t,n,s,o){return`${o}::${t}_${n}_${s}`}get instanceName(){return"Layer"}get rendererEvents(){return this.events}set opacity(t){t!==this._opacity&&(this._fading?t>this._opacity?this._fadingFactor=(t-this._opacity)/30:t<this._opacity&&(this._fadingFactor=(this._opacity-t)/30):this._fadingOpacity=t,this._opacity=t)}set pickingEnabled(t){this._pickingEnabled=t}get pickingEnabled(){return this._pickingEnabled}hasImageryTiles(){return this._hasImageryTiles}getID(){return this.__id}get id(){return this.__id}get _id(){return this.__id}isEqual(t){return t.__id===this.__id}_assignPlanet(t){this._planet=t,t._layers.push(this),t.renderer&&t.renderer.isInitialized()&&(this._isSRGB?this._internalFormat=t.renderer.handler.gl.SRGB8_ALPHA8:this._internalFormat=t.renderer.handler.gl.RGBA8,this.createTexture=t.renderer.handler.createTexture[this._textureFilter],this.events.on("visibilitychange",t._onLayerVisibilityChanged,t),this._isBaseLayer&&this._visibility&&t.setBaseLayer(this),t.events.dispatch(t.events.layeradd,this),this.events.dispatch(this.events.add,t),t.updateVisibleLayers(),this._bindPicking(),this._visibility&&this.hasImageryTiles()&&this._preLoad())}get isIdle(){return this._planet&&this._planet.quadTreeStrategy._terrainCompletedActivated||!1}_bindPicking(){this._planet&&this._planet.renderer&&this._planet.renderer.assignPickingColor(this)}addTo(t){this._planet||this._assignPlanet(t)}remove(){let t=this._planet;if(t){for(let n=0;n<t._layers.length;n++)if(this.isEqual(t._layers[n]))return t.renderer&&t.renderer.clearPickingColor(this),t._layers.splice(n,1),t.updateVisibleLayers(),this.clear(),t.events.dispatch(t.events.layerremove,this),this.events.dispatch(this.events.remove,t),this._planet=null,this._internalFormat=null,this.createTexture=null,this}return this}clear(){this._planet&&this._planet._clearLayerMaterial(this)}get planet(){return this._planet}setAttribution(t){this._attribution!==t&&(this._attribution=t,this._planet&&this._planet.updateAttributionsList())}getAttribution(){return this._attribution}setHeight(t){this._height=t,this._planet&&this._planet.updateVisibleLayers()}getHeight(){return this._height}setZIndex(t){this._zIndex=t,this._planet&&this._planet.updateVisibleLayers()}getZIndex(){return this._zIndex}bringToFront(){if(this._planet){let t=this._planet.visibleTileLayers,n=t[t.length-1];n.isEqual(this)||this.setZIndex(n.getZIndex()+1)}}isBaseLayer(){return this._isBaseLayer}setBaseLayer(t){this._isBaseLayer=t,this._planet&&(!t&&this._planet.baseLayer&&this.isEqual(this._planet.baseLayer)&&(this._planet.baseLayer=null),this._planet.updateVisibleLayers())}setVisibility(t){t!==this._visibility&&(this._visibility=t,this._planet&&(this._isBaseLayer&&t&&this._planet.setBaseLayer(this),this._planet.updateVisibleLayers(),!t||this._isPreloadDone||this.isVector||(this._isPreloadDone=!0,this._preLoad())),this.events.dispatch(this.events.visibilitychange,this))}_forceMaterialApply(t){let n=t.materials,s=n[this.__id];s||(s=n[this.__id]=this.createMaterial(t)),s.isReady||(t.quadTreeStrategy._renderCompleted=!1),this.applyMaterial(s,!0)}clearMaterial(t){}loadMaterial(t,n=!1){}applyMaterial(t,n=!1){return[0,0,1,1]}_preLoadRecursive(t,n){if(!(t.segment.tileZoom>n)){this._preLoadZoomLevels.includes(t.segment.tileZoom)&&this._forceMaterialApply(t.segment);for(let s=0,o=t.nodes.length;s<o;s++)t.nodes[s]&&this._preLoadRecursive(t.nodes[s],n)}}_preLoad(){if(this._planet&&this._preLoadZoomLevels.length){let t=this._planet,n=Math.max(...this._preLoadZoomLevels);for(let s=0,o=t.quadTreeStrategy.quadTreeList.length;s<o;s++)this._preLoadRecursive(t.quadTreeStrategy.quadTreeList[s],n)}}getVisibility(){return this._visibility}setExtent(t){let n=t.southWest.clone(),s=t.northEast.clone();n.lat<Ot&&(n.lat=Ot),s.lat>ct&&(s.lat=ct),this._extent=t.clone(),this._extentMerc=new U(n.forwardMercator(),s.forwardMercator()),this._correctFullExtent()}getExtent(){return this._extent}getExtentMerc(){return this._extentMerc}flyExtent(){var t;(t=this._planet)==null||t.flyExtent(this.getExtent())}viewExtent(){var t;(t=this._planet)==null||t.viewExtent(this.getExtent())}_correctFullExtent(){}get opacity(){return this._opacity}get screenOpacity(){return this._fading?this._fadingOpacity:this._opacity}_refreshFadingOpacity(t,n){let s=this._planet;return this._visibility&&s.getViewExtent().overlaps(this._extent)&&n>=this.minZoom&&t<=this.maxZoom?(this._fadingOpacity+=this._fadingFactor,(this._fadingFactor>0&&this._fadingOpacity>this._opacity||this._fadingFactor<0&&this._fadingOpacity<this._opacity)&&(this._fadingOpacity=this._opacity),!1):(this._fadingOpacity-=this._fadingFactor,this._fadingOpacity<=0&&(this._fadingOpacity=0),!1)}createMaterial(t){return new Uo(t,this)}redraw(){var t;(t=this._planet)==null||t.quadTreeStrategy.clearLayerMaterial(this)}abortMaterialLoading(t){}abortLoading(){}};_s.__counter__=0;let zt=_s;const Go=["visibilitychange","add","remove","mousemove","mouseenter","mouseleave","lclick","rclick","mclick","ldblclick","rdblclick","mdblclick","lup","rup","mup","ldown","rdown","mdown","lhold","rhold","mhold","mousewheel","touchmove","touchstart","touchend","doubletouch","touchleave","touchenter"],$a=["load","loadend"],Ut=class Uc extends zt{constructor(t,n){super(t,n),this.events=this.events.registerNames($a),this.animated=n.animated||!1,this.minNativeZoom=n.minNativeZoom||0,this.maxNativeZoom=n.maxNativeZoom||100,this._counter=0,this._pendingsQueue=[],this.drawTile=n.drawTile,this._onLoadend_=null}addTo(t){return this._onLoadend_=this._onLoadend.bind(this),this.events.on("loadend",this._onLoadend_,this),super.addTo(t)}remove(){return this.events.off("loadend",this._onLoadend_),this._onLoadend_=null,super.remove()}_onLoadend(){this._planet&&this._planet.quadTreeStrategy._terrainCompletedActivated&&this._planet.events.dispatch(this._planet.events.layerloadend,this)}get instanceName(){return"CanvasTiles"}get isIdle(){return super.isIdle&&this._counter===0}abortLoading(){this._pendingsQueue.forEach(t=>{this.abortMaterialLoading(t)}),this._pendingsQueue=[]}setVisibility(t){t!==this._visibility&&(super.setVisibility(t),t||this.abortLoading())}loadMaterial(t){let n=t.segment;this._isBaseLayer?t.texture=n.getDefaultTexture():t.texture=n.planet.transparentTexture,(this._planet.layerLock.isFree()||t.segment.tileZoom<2)&&(t.isReady=!1,t.isLoading=!0,Uc.__requestsCounter>=Uc.MAX_REQUESTS&&this._counter?this._pendingsQueue.push(t):this._exec(t))}_exec(t){Uc.__requestsCounter++,this._counter++;const n=this.events.load;n.handlers.length&&this.events.dispatch(n,t),requestAnimationFrame(()=>{this.drawTile(t,s=>{this._counter--,Uc.__requestsCounter--,this._correctCounter(),t.isLoading&&t.applyImage(s),this._dequeueRequest()})})}_correctCounter(){this._counter<0&&(this._counter=0),Uc.__requestsCounter<0&&(Uc.__requestsCounter=0)}abortMaterialLoading(t){t.isLoading&&(this._counter--,Uc.__requestsCounter--,this._correctCounter(),this._dequeueRequest()),t.isLoading=!1,t.isReady=!1}_dequeueRequest(){if(this._pendingsQueue.length){if(Uc.__requestsCounter<Uc.MAX_REQUESTS){const t=this._whilePendings();t&&this._exec(t)}}else this._counter===0&&this._planet&&this._planet.quadTreeStrategy._terrainCompletedActivated&&this.events.dispatch(this.events.loadend)}_whilePendings(){for(;this._pendingsQueue.length;){const t=this._pendingsQueue.pop();if(t&&t.segment&&t.segment.node){if(t.segment.initialized&&t.segment.node.getState()===1)return t;t.isLoading=!1}}return null}applyMaterial(t){if(t.isReady)return t.layer.animated&&requestAnimationFrame(()=>{this.drawTile(t,function(n){t.applyImage(n)})}),t.texOffset;if(t.segment.tileZoom<this.minNativeZoom)t.textureNotExists();else{let n=t.segment,s=n.node,o=!1,a=t.layer.maxNativeZoom;n.passReady&&!t.isLoading&&n.tileZoom<=a&&this.loadMaterial(t);let h=this._id,c=t;for(;s.parentNode;)if(s=s.parentNode,c=s.segment.materials[h],c&&c.textureExists){o=!0;break}if(n.passReady){if(s.segment.tileZoom===a)n.tileZoom>a&&t.textureNotExists();else if(s.segment.tileZoom<a){let u=n.node;for(;u.segment.tileZoom>a;)u=u.parentNode;let d=u.segment.materials[h];d?!d.isLoading&&!d.isReady&&this.loadMaterial(d):(d=u.segment.materials[t.layer._id]=t.layer.createMaterial(u.segment),this.loadMaterial(d))}}if(o){t.layer.animated&&requestAnimationFrame(()=>{t.segment&&this.drawTile(t,function(d){t.applyImage(d)})}),t.appliedNodeId=s.nodeId,t.texture=c.texture;let u=1/(2<<n.tileZoom-s.segment.tileZoom-1);t.texOffset[0]=n.tileX*u-s.segment.tileX,t.texOffset[1]=n.tileY*u-s.segment.tileY,t.texOffset[2]=u,t.texOffset[3]=u}else t.texture=n.planet.transparentTexture,t.texOffset[0]=0,t.texOffset[1]=0,t.texOffset[2]=1,t.texOffset[3]=1}return t.texOffset}clearMaterial(t){t.isReady&&(t.isReady=!1,t.textureExists&&t.texture&&!t.texture.default&&(t.segment.handler.gl.deleteTexture(t.texture),t.texture=null)),this.abortMaterialLoading(t),t.isLoading=!1,t.textureExists=!1,t.layer=null,t.segment=null}};Ut.MAX_REQUESTS=20,Ut.__requestsCounter=0;let ss=Ut;const Xa=["change"];class jo{constructor(t={}){this._onChange=(n,s)=>{if(n){s.preventClick=!0;for(let o=0;o<this._buttons.length;o++){let a=this._buttons[o];a.isEqual(s)||(a.setActive(!1),a.preventClick=!1)}this.events.dispatch(this.events.change,s)}},this.events=lt(Xa),this._buttons=t.buttons||[];for(let n=0;n<this._buttons.length;n++)this._bindButton(this._buttons[n])}_bindButton(t){t.events.on("change",this._onChange)}add(t){this._buttons.push(t),this._bindButton(t)}remove(t){for(let n=0;n<this._buttons.length;n++)if(this._buttons[n].isEqual(t))return this._buttons.splice(n),void t.events.off("change",this._onChange)}}class en{constructor(t=2,n){this._sourceId=0,this._source=new Map,this._pendingQueue=[],this._numWorkers=t,this._workerQueue=[],n&&this.setProgram(n)}check(){this._pendingQueue.length&&this.make(this._pendingQueue.pop())}setProgram(t){if(ks(t)){let n=new Blob([t],{type:"application/javascript"});for(let s=0;s<this._numWorkers;s++){let o=new Worker(URL.createObjectURL(n));o.onmessage=a=>{this._onMessage(a),this._workerQueue&&this._workerQueue.unshift(a.target),this.check()},this._workerQueue.push(o)}}else for(let n=0;n<this._numWorkers;n++){let s=new t;s.onmessage=o=>{this._onMessage(o),this._workerQueue&&this._workerQueue.unshift(o.target),this.check()},this._workerQueue.push(s)}}make(t){}_onMessage(t){}destroy(){for(let t=0;t<this._workerQueue.length;t++){const n=this._workerQueue[t];n.onmessage=null,n.terminate()}this._pendingQueue=[],this._workerQueue=[]}get pendingQueue(){return this._pendingQueue}}const qo=`(function(){"use strict";function n(i,f,u){let o=u.length,b=f*o;for(let A=0;A<o;A++)i[b+A]=u[A]}self.onmessage=function(i){var f=i.data.labelData,u=f[0],o=f[1],b=f[2],A=f[3],z=f[4],D=f[5],H=f[6],I=f[7],L=f[8],M=f[9],P=f[10],j=f[11],q=f[12],B=f[13],E=f[14],G=f[15],J=f[16],K=f[17],N=f[18],O=f[19],Q=f[20],R=f[21],S=f[22],T=f[23],U=f[24],Z=f[25],_=f[26],$=f[27],V=f[28],X=f[29];let w=new Float32Array(12*o),s=new Float32Array(24*o),y=new Float32Array(24*o),F=new Float32Array(18*o),g=new Float32Array(18*o),c=new Float32Array(6*o),d=new Float32Array(18*o),p=new Float32Array(24*o),x=new Float32Array(6*o),h=new Float32Array(18*o),v=new Float32Array(6*o),C=new Float32Array(6*o),m=new Float32Array(24*o),k=new Float32Array(18*o);for(let t=0;t<o;t++){n(w,t,b!==0?[0,0,0,-1,1,-1,1,-1,1,0,0,0]:[0,0,0,0,0,0,0,0,0,0,0,0]),n(s,t,[0,0,-1,0,0,0,-1,0,0,0,-1,0,0,0,-1,0,0,0,-1,0,0,0,-1,0]),n(y,t,[1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0]);var l,r=A,e=z,a=D;n(F,t,[r,e,a,r,e,a,r,e,a,r,e,a,r,e,a,r,e,a]),n(g,t,[r=H,e=I,a=L,r,e,a,r,e,a,r,e,a,r,e,a,r,e,a]),n(c,t,[r=M,r,r,r,r,r]),n(d,t,[r=P,e=j,a=q,r,e,a,r,e,a,r,e,a,r,e,a,r,e,a]),n(p,t,[r=B,e=E,a=G,l=J,r,e,a,l,r,e,a,l,r,e,a,l,r,e,a,l,r,e,a,l]),n(x,t,[r=K,r,r,r,r,r]),n(h,t,[r=N,e=O,a=Q,r,e,a,r,e,a,r,e,a,r,e,a,r,e,a]),n(v,t,[r=R,r,r,r,r,r]),n(C,t,[r=S,r,r,r,r,r]),n(m,t,[r=T,e=U,a=Z,l=_,r,e,a,l,r,e,a,l,r,e,a,l,r,e,a,l,r,e,a,l]),n(k,t,[r=$/255,e=V/255,a=X/255,r,e,a,r,e,a,r,e,a,r,e,a,r,e,a])}self.postMessage({id:u,vertexArr:w,texCoordArr:s,gliphParamArr:y,positionHighArr:F,positionLowArr:g,sizeArr:c,offsetArr:d,rgbaArr:p,rotationArr:x,alignedAxisArr:h,fontIndexArr:v,outlineArr:C,outlineColorArr:m,pickingColorArr:k},[w.buffer,s.buffer,y.buffer,F.buffer,g.buffer,c.buffer,d.buffer,p.buffer,x.buffer,h.buffer,v.buffer,C.buffer,m.buffer,k.buffer])}})();
//# sourceMappingURL=LabelWorker.worker-BT1uJgYn.js.map
`,Tn=typeof self<"u"&&self.Blob&&new Blob([qo],{type:"text/javascript;charset=utf-8"});function Za(l){let t;try{if(t=Tn&&(self.URL||self.webkitURL).createObjectURL(Tn),!t)throw"";const n=new Worker(t,{name:l==null?void 0:l.name});return n.addEventListener("error",()=>{(self.URL||self.webkitURL).revokeObjectURL(t)}),n}catch{return new Worker("data:text/javascript;charset=utf-8,"+encodeURIComponent(qo),{name:l==null?void 0:l.name})}finally{t&&(self.URL||self.webkitURL).revokeObjectURL(t)}}class Ka extends en{constructor(t=4){super(t,Za)}_onMessage(t){let n=this._source.get(t.data.id);n.label._lockId===-2?requestAnimationFrame(()=>{this.make({handler:n.handler,label:n.label})}):n.handler.workerCallback(t.data,n.label),this._source.delete(t.data.id)}make(t){let n=t.label;if(t.handler._entityCollection){let s=n.serializeWorkerData(this._sourceId);if(s)if(this._workerQueue.length){let o=this._workerQueue.pop();this._source.set(this._sourceId,t),n._lockId=this._sourceId,this._sourceId++,o.postMessage({labelData:s},[s.buffer])}else this._pendingQueue.push(t)}}}const fs=class Ju{constructor(t={}){this.__id=Ju.__counter__++,this._position=Yt(t.position),this._positionHigh=new v,this._positionLow=new v,v.doubleToTwoFloats(this._position,this._positionHigh,this._positionLow),this._rotation=t.rotation||0,this._color=le(t.color),this._alignedAxis=Yt(t.alignedAxis),this._offset=Yt(t.offset),this._visibility=t.visibility==null||t.visibility,this._entity=null,this._handler=null,this._handlerIndex=-1,this._isReady=!1,this._lockId=-1}setPosition(t,n,s){this._position.x=t,this._position.y=n,this._position.z=s,v.doubleToTwoFloats(this._position,this._positionHigh,this._positionLow),this._isReady&&this._handler?this._handler.setPositionArr(this._handlerIndex,this._positionHigh,this._positionLow):this._lockId!==-1&&(this._lockId=-2)}setPosition3v(t){this._position.x=t.x,this._position.y=t.y,this._position.z=t.z,v.doubleToTwoFloats(t,this._positionHigh,this._positionLow),this._isReady&&this._handler?this._handler.setPositionArr(this._handlerIndex,this._positionHigh,this._positionLow):this._lockId!==-1&&(this._lockId=-2)}getPosition(){return this._position}setOffset(t,n,s){this._offset.x=t,this._offset.y=n,s!=null&&(this._offset.z=s),this._isReady&&this._handler?this._handler.setOffsetArr(this._handlerIndex,this._offset):this._lockId!==-1&&(this._lockId=-2)}setOffset3v(t){this.setOffset(t.x,t.y,t.z)}getOffset(){return this._offset}setRotation(t){t!==this._rotation&&(this._rotation=t,this._isReady&&this._handler?this._handler.setRotationArr(this._handlerIndex,t):this._lockId!==-1&&(this._lockId=-2))}getRotation(){return this._rotation}setOpacity(t){t!==this._color.w&&(t!=null&&(this._color.w=t),this._isReady&&this._handler?this._handler.setRgbaArr(this._handlerIndex,this._color):this._lockId!==-1&&(this._lockId=-2))}setColor(t,n,s,o){o===this._color.w&&t===this._color.x&&n===this._color.y&&this._color.z===s||(this._color.x=t,this._color.y=n,this._color.z=s,o!=null&&(this._color.w=o),this._isReady&&this._handler?this._handler.setRgbaArr(this._handlerIndex,this._color):this._lockId!==-1&&(this._lockId=-2))}setColor4v(t){this.setColor(t.x,t.y,t.z,t.w)}setColorHTML(t){this.setColor4v(he(t))}getColor(){return this._color}setVisibility(t){t!==this._visibility&&(this._visibility=t,this._isReady&&this._handler?this._handler.setVisibility(this._handlerIndex,t):this._lockId!==-1&&(this._lockId=-2))}getVisibility(){return this._visibility}setAlignedAxis(t,n,s){this._alignedAxis.x=t,this._alignedAxis.y=n,this._alignedAxis.z=s,this._isReady&&this._handler?this._handler.setAlignedAxisArr(this._handlerIndex,this._alignedAxis):this._lockId!==-1&&(this._lockId=-2)}setAlignedAxis3v(t){this.setAlignedAxis(t.x,t.y,t.z)}getAlignedAxis(){return this._alignedAxis}remove(){this._entity=null,this._handler&&this._handler.remove(this)}setPickingColor3v(t){this._isReady&&this._handler?this._handler.setPickingColorArr(this._handlerIndex,t):this._lockId!==-1&&(this._lockId=-2)}serializeWorkerData(t){return this._handler?new Float32Array([]):null}};fs.__counter__=0;let rs=fs;class Qa extends rs{constructor(t={}){super(t),this._handler=null,this._src=t.src||null,this._image=t.image||null,this._scale=1,this._width=t.width||(t.size?t.size[0]:30),this._height=t.height||(t.size?t.size[1]:30)}setSrc(t){this._src=t;let n=this._handler;if(n&&t&&t.length){let s=n._entityCollection.renderNode;if(s&&s.renderer){let o=s.renderer.billboardsTextureAtlas,a=this;o.loadImage(t,function(h){h.__nodeIndex!=null&&o.get(h.__nodeIndex)?(a._image=h,n.setTexCoordArr(a._handlerIndex,o.get(a._image.__nodeIndex).texCoords)):(o.addImage(h),o.createTexture(),a._image=h,s.updateBillboardsTexCoords())})}}}getSrc(){return this._src}setImage(t){this.setSrc(t.src)}getImage(){return this._image}setSize(t,n){this._width=t,this._height=n,this._handler&&this._handler.setSizeArr(this._handlerIndex,t*this._scale,n*this._scale)}getSize(){return{width:this._width,height:this._height}}setWidth(t){this.setSize(t,this._height)}getWidth(){return this._width}setHeight(t){this.setSize(this._width,t)}getHeight(){return this._height}}var ai=(l=>(l[l.POINT=1]="POINT",l[l.LINESTRING=2]="LINESTRING",l[l.POLYGON=3]="POLYGON",l[l.MULTIPOLYGON=4]="MULTIPOLYGON",l[l.MULTILINESTRING=5]="MULTILINESTRING",l))(ai||{});const Ja={POINT:1,LINESTRING:2,POLYGON:3,MULTIPOLYGON:4,MULTILINESTRING:5},ue=class Qc{constructor(t={}){this.__id=Qc.__counter__++,this._entity=null,this._handler=null,this._handlerIndex=-1,this._polyVerticesHighMerc=[],this._polyVerticesLowMerc=[],this._polyVerticesLength=-1,this._polyIndexesLength=-1,this._polyVerticesHandlerIndex=-1,this._polyIndexesHandlerIndex=-1,this._lineVerticesHighMerc=[],this._lineVerticesLowMerc=[],this._lineVerticesLength=-1,this._lineOrdersLength=-1,this._lineIndexesLength=-1,this._lineColorsLength=-1,this._lineThicknessLength=-1,this._lineVerticesHandlerIndex=-1,this._lineOrdersHandlerIndex=-1,this._lineIndexesHandlerIndex=-1,this._lineThicknessHandlerIndex=-1,this._lineColorsHandlerIndex=-1,this._type=t.type&&Qc.getType(t.type)||1,this._coordinates=t.coordinates||[],this._extent=Qc.getExtent({type:t.type||"POINT",coordinates:t.coordinates||[]},this._coordinates),t.style=t.style||{},this._style={fillColor:le(t.style.fillColor,new et(.19,.62,.85,.4)),lineColor:le(t.style.lineColor,new et(.19,.62,.85,1)),strokeColor:le(t.style.strokeColor,new et(1,1,1,.95)),lineWidth:t.style.lineWidth||3,strokeWidth:t.style.strokeWidth||0},this._visibility=t.visibility||!0,this._pickingReady=!1}get id(){return this.__id}get type(){return this._type}static getType(t){return Ja[t.toUpperCase()]}static getExtent(t,n){let s=new U(new L(180,90),new L(-180,-90)),o=Qc.getType(t.type);if(o===1){let a=t.coordinates[0],h=t.coordinates[1];s.southWest.lon=a,s.southWest.lat=h,s.northEast.lon=a,s.northEast.lat=h,n&&(n[0]=a)&&(n[1]=h)}else if(o===2){let a=t.coordinates;for(let h=0;h<a.length;h++){let c=a[h][0],u=a[h][1];c<s.southWest.lon&&(s.southWest.lon=c),u<s.southWest.lat&&(s.southWest.lat=u),c>s.northEast.lon&&(s.northEast.lon=c),u>s.northEast.lat&&(s.northEast.lat=u),n&&(n[h]=[c,u])}}else if(o===3){let a=t.coordinates;for(let h=0;h<a.length;h++){let c=a[h];n&&(n[h]=[]);for(let u=0;u<c.length;u++){let d=c[u],f=d[0],g=d[1];f<s.southWest.lon&&(s.southWest.lon=f),g<s.southWest.lat&&(s.southWest.lat=g),f>s.northEast.lon&&(s.northEast.lon=f),g>s.northEast.lat&&(s.northEast.lat=g),n&&(n[h][u]=[f,g])}}}else if(o===4){let a=t.coordinates;for(let h=0;h<a.length;h++){let c=a[h];n&&(n[h]=[]);for(let u=0;u<c.length;u++){let d=c[u];n&&(n[h][u]=[]);for(let f=0;f<d.length;f++){let g=d[f],_=g[0],m=g[1];_<s.southWest.lon&&(s.southWest.lon=_),m<s.southWest.lat&&(s.southWest.lat=m),_>s.northEast.lon&&(s.northEast.lon=_),m>s.northEast.lat&&(s.northEast.lat=m),n&&(n[h][u][f]=[_,m])}}}}else if(o===5){let a=t.coordinates;for(let h=0;h<a.length;h++){let c=a[h];n&&(n[h]=[]);for(let u=0;u<c.length;u++){let d=c[u],f=d[0],g=d[1];f<s.southWest.lon&&(s.southWest.lon=f),g<s.southWest.lat&&(s.southWest.lat=g),f>s.northEast.lon&&(s.northEast.lon=f),g>s.northEast.lat&&(s.northEast.lat=g),n&&(n[h][u]=[f,g])}}}else s.southWest.lon=s.southWest.lat=s.northEast.lon=s.northEast.lat=0,n&&(n[0]=0)&&(n[1]=0);return s}setGeometry(t){let n=this._handler;return n&&(this.remove(),this._type=Qc.getType(t.type||"Point"),this._extent=Qc.getExtent(t,this._coordinates),n.add(this)),this}setFillColor(t,n,s,o=1){let a=this._style.fillColor;return(a.w===0&&o!==0||a.w!==0&&o===0)&&(this._pickingReady=!1),a.x=t,a.y=n,a.z=s,a.w=o,this._handler&&this._handler.setPolyColorArr(this,a),this}overlaps(t){return this._extent.overlaps(t)}setFillColor4v(t){return this.setFillColor(t.x,t.y,t.z,t.w)}setStrokeColor(t,n,s,o=1){let a=this._style.strokeColor;return(a.w===0&&o!==0||a.w!==0&&o===0)&&(this._pickingReady=!1),a.x=t,a.y=n,a.z=s,a.w=o,this._handler&&this._handler.setLineStrokeColorArr(this,a),this}setLineColor(t,n,s,o=1){let a=this._style.lineColor;return(a.w===0&&o!==0||a.w!==0&&o===0)&&(this._pickingReady=!1),a.x=t,a.y=n,a.z=s,a.w=o,this._handler&&this._handler.setLineColorArr(this,a),this}setStrokeColor4v(t){return this.setStrokeColor(t.x,t.y,t.z,t.w)}setLineColor4v(t){return this.setLineColor(t.x,t.y,t.z,t.w)}setStrokeOpacity(t){let n=this._style.strokeColor;return n.w=t,this.setStrokeColor(n.x,n.y,n.z,t)}setLineOpacity(t){let n=this._style.lineColor;return n.w=t,this.setLineColor(n.x,n.y,n.z,t)}setStrokeWidth(t){return this._style.strokeWidth=t,this._pickingReady=!1,this._handler&&this._handler.setLineStrokeArr(this,t),this}bringToFront(){return this._handler&&this._handler.bringToFront(this),this}setLineWidth(t){return this._style.lineWidth=t,this._pickingReady=!1,this._handler&&this._handler.setLineThicknessArr(this,t),this}setFillOpacity(t){let n=this._style.fillColor;return(n.w===0&&t!==0||n.w!==0&&t===0)&&(this._pickingReady=!1),n.w=t,this._handler&&this._handler.setPolyColorArr(this,n),this}setVisibility(t){return this._visibility=t,this._handler&&this._handler.setGeometryVisibility(this),this}getVisibility(){return this._visibility}remove(){this._handler&&this._handler.remove(this)}getExtent(){return this._extent.clone()}getType(){return this._type}};ue.__counter__=0;let vr=ue;class Jt{constructor(t,n){this.p0=t||new v,this.p1=n||new v}getMagnitude(){return this.p0.distance(this.p1)}getSphereIntersection(t){let n=this.p0,s=this.p1,o=t.center.x,a=t.center.y,h=t.center.z,c=n.x,u=n.y,d=n.z,f=s.x-c,g=s.y-u,_=s.z-d,m=f*f+g*g+_*_,p=2*(c*f+u*g+d*_-f*o-g*a-_*h),x=p*p-4*m*(c*c-2*c*o+o*o+u*u-2*u*a+a*a+d*d-2*d*h+h*h-t.radius*t.radius);if(x<0)return[];let y=(-p-Math.sqrt(x))/(2*m),T=new v(n.x*(1-y)+y*s.x,n.y*(1-y)+y*s.y,n.z*(1-y)+y*s.z);if(x==0)return[T];let S=(-p+Math.sqrt(x))/(2*m),C=new v(n.x*(1-S)+S*s.x,n.y*(1-S)+S*s.y,n.z*(1-S)+S*s.z);return Math.abs(y-.5)<Math.abs(S-.5)?[T,C]:[C,T]}intersects(t,n,s){let o=this.p0.sub(t.p0),a=t.p1.sub(t.p0);if(Math.abs(a.x)<ne&&Math.abs(a.y)<ne&&Math.abs(a.z)<ne)return!1;let h=this.p1.sub(this.p0);if(Math.abs(h.x)<ne&&Math.abs(h.y)<ne&&Math.abs(h.z)<ne)return!1;let c=o.x*a.x+o.y*a.y+o.z*a.z,u=a.x*h.x+a.y*h.y+a.z*h.z,d=o.x*h.x+o.y*h.y+o.z*h.z,f=a.x*a.x+a.y*a.y+a.z*a.z,g=(h.x*h.x+h.y*h.y+h.z*h.z)*f-u*u;if(Math.abs(g)<ne)return!1;let _=(c*u-d*f)/g;if(n.x=this.p0.x+_*h.x,n.y=this.p0.y+_*h.y,n.z=this.p0.z+_*h.z,s){let m=(c+u*_)/f;s.x=t.p0.x+m*a.x,s.y=t.p0.y+m*a.y,s.z=t.p0.z+m*a.z}return!0}getNearestDistancePoint(t,n){let s=this.p0,o=this.p1,a=this.getMagnitude(),h=((t.x-s.x)*(o.x-s.x)+(t.y-s.y)*(o.y-s.y)+(t.z-s.z)*(o.z-s.z))/(a*a);return n.x=s.x+h*(o.x-s.x),n.y=s.y+h*(o.y-s.y),n.z=s.z+h*(o.z-s.z),!(h<0||h>1)}}class vt{constructor(t,n){this.p=t?t.clone():new v,this.n=n?n.clone():this.p.isZero()?v.UP:this.p.getNormal()}setByPoints(t,n,s){let o=v.sub(n,t),a=v.sub(s,t);return this.n=o.cross(a),this.p.copy(t),this}static fromPoints(t,n,s){return new vt().setByPoints(t,n,s)}set(t,n){this.p.copy(t),this.n.copy(n)}getNormal(){return this.n.clone()}distance(t){let n=this.getProjection(t);return t.distance(n)}getProjection(t,n){return v.proj_b_to_plane(t,this.n,n)}getProjectionPoint(t,n){let s=t.sub(this.p),o=this.n,a=s.dot(o);return n?n.copy(o.scale(a)):n=o.scale(a),t.sub(n)}getIntersection(t,n,s){let o,a=t.n.cross(n.n),h=a.x>=0?a.x:-a.x,c=a.y>=0?a.y:-a.y,u=a.z>=0?a.z:-a.z;if(h+c+u<xo){let _=n.p.sub(t.p);return t.n.dot(_)==0?1:0}o=h>c?h>u?1:3:c>u?2:3;let d,f,g=new v;return d=-t.n.dot(t.p),f=-n.n.dot(n.p),o===1?(g.x=0,g.y=(f*t.n.z-d*n.n.z)/a.x,g.z=(d*n.n.y-f*t.n.y)/a.x):o===2?(g.x=(d*n.n.z-f*t.n.z)/a.y,g.y=0,g.z=(f*t.n.x-d*n.n.x)/a.y):o===3&&(g.x=(f*t.n.y-d*n.n.y)/a.z,g.y=(d*n.n.x-f*t.n.x)/a.z,g.z=0),s.p0.copy(g),s.p1.copy(g.add(a)),2}}let V=class Vc{constructor(t=v.ZERO,n=v.ZERO){this.origin=t,this.direction=n}static get OUTSIDE(){return 0}static get INSIDE(){return 1}static get INPLANE(){return 2}static get AWAY(){return 3}set(t,n){return this.origin=t,this.direction=n,this}getPoint(t){return v.add(this.origin,this.direction.scaleTo(t))}hitTriangleRes(t,n,s,o){let a=n.sub(t),h=s.sub(t),c=a.cross(h),u=this.origin.sub(t),d=-c.dot(u),f=c.dot(this.direction);if(Math.abs(f)<ne)return d===0?(o.copy(this.origin),Vc.INPLANE):Vc.OUTSIDE;let g=d/f;if(o.copy(this.origin.add(this.direction.scaleTo(g))),g<0)return Vc.AWAY;let _=a.dot(a),m=a.dot(h),p=h.dot(h),x=o.sub(t),y=x.dot(a),T=x.dot(h),S=m*m-_*p,C=(m*T-p*y)/S;if(C<0||C>1)return Vc.OUTSIDE;let P=(m*y-_*T)/S;return P<0||C+P>1?Vc.OUTSIDE:Vc.INSIDE}hitPlaneRes(t,n){const s=this.direction.dot(t.n);if(Math.abs(s)<ne)return Vc.OUTSIDE;const o=t.p.sub(this.origin).dot(t.n)/s;return o<0?Vc.AWAY:(n.copy(this.getPoint(o)),Vc.INSIDE)}hitSphere(t){const n=v.sub(this.origin,t.center),s=this.direction.dot(this.direction),o=2*n.dot(this.direction),a=o*o-4*s*(n.dot(n)-t.radius*t.radius);if(a<0)return null;const h=Math.sqrt(a);let c=(-o-h)/(2*s);return c<0&&(c=(-o+h)/(2*s)),c<0?null:v.add(this.origin,this.direction.scaleTo(c))}hitBox(t){}};function js(l){let t=l.split("/"),n=t[t.length-1],s=t[t.length-2];return`${s?s+"/":""}${n}`}class Cn{constructor(){this.objPositions=[],this.objTexcoords=[],this.objNormals=[],this.objVertexData=[this.objPositions,this.objTexcoords,this.objNormals],this.vertexData=[[],[],[]],this._materialLibs=[],this.geometries=[],this.geometry=null,this.materials={},this.material={},this.object="default",this.groups=["default"],this._path="",this.keywords={v:t=>{this.objPositions.push(t.map(parseFloat))},vn:t=>{this.objNormals.push(t.map(parseFloat))},vt:t=>{this.objTexcoords.push([parseFloat(t[0]),1-parseFloat(t[1])])},f:t=>{this.setGeometry();const n=t.length-2;for(let s=0;s<n;++s)this.addVertex(t[0]),this.addVertex(t[s+1]),this.addVertex(t[s+2])},s:()=>{},mtllib:(t,n)=>{this._materialLibs.push(n)},usemtl:(t,n)=>{this.newGeometry(),this.setGeometry(),this.geometry&&(this.geometry.material=n)},g:t=>{this.groups=t,this.newGeometry()},o:(t,n)=>{this.object=n,this.newGeometry()},newmtl:(t,n)=>{const s={};this.material=s,this.materials[n]=s},Ns:(t,n)=>{this.material.shininess=parseFloat(n)},Ni:(t,n)=>{},Ka:(t,n)=>{this.material.ambient=t.map(s=>parseFloat(s))},Kd:(t,n)=>{this.material.diffuse=t.map(s=>parseFloat(s))},Ks:(t,n)=>{this.material.specular=t.map(s=>parseFloat(s))},Ke:(t,n)=>{this.material.color=t.map(s=>parseFloat(s))},illum:(t,n)=>{this.material.illum=parseFloat(n)},d:(t,n)=>{this.material.opacity=parseFloat(n)},Tr:(t,n)=>{this.material.opacity=parseFloat(n)},Tf:(t,n)=>{},map_Ka:(t,n)=>{},map_Kd:(t,n)=>{this.material.colorTexture=`${this._path}/${js(n)}`},map_Bump:(t,n)=>{this.material.normalTexture=`${this._path}/${js(n)}`},map_Ns:(t,n)=>{this.material.metallicRoughnessTexture=`${this._path}/${js(n)}`}}}newGeometry(){this.geometry&&this.geometry.data.vertices.length&&(this.geometry=null)}setGeometry(){if(!this.geometry){const t=[],n=[],s=[];this.vertexData=[t,n,s],this.geometry={object:this.object,groups:this.groups,material:"",data:{vertices:t,texCoords:n,normals:s}},this.geometries.push(this.geometry)}}addVertex(t){let n=t.split("/");for(let s=0;s<n.length;s++){let o=n[s];if(!o)continue;let a=parseInt(o)-1,h=this.vertexData[s],c=h.length,u=this.objVertexData[s][a],d=u.length;this.vertexData[s].length=c+d;for(let f=0;f<d;f++)h[c+f]=u[f]}}_innerParser(t,n){const s=/(\w*)(?: )*(.*)/,o=t.split(`
`);for(let a=0;a<o.length;++a){const h=o[a].trim();if(h===""||h.startsWith("#"))continue;const c=s.exec(h);if(!c)continue;const[,u,d]=c,f=h.split(/\s+/).slice(1),g=this.keywords[u];g?g(f,d):console.warn(`Unknown keyword '${u}' in '${n}:${a}'`)}}get data(){return{geometries:this.geometries,materials:this.materials}}async load(t){this._path=t.substring(0,t.lastIndexOf("/"));const n=await fetch(t);if(!n.ok)throw new Error(`Unable to load '${t}'`);const s=n.body.getReader(),o=new TextDecoder;let{value:a,done:h}=await s.read(),c="";for(;!h;){const d=(c+o.decode(a,{stream:!0})).split(`
`);c=d.pop();for(const f of d)this._innerParser(f,t);({value:a,done:h}=await s.read())}c&&this._innerParser(c,t),this._cleanupGeometryArrays();let u=this._materialLibs.map(d=>(d=`${this._path}/${d}`,fetch(d).then(f=>f.text()).then(f=>({text:f,filename:d}))));return await Promise.all(u).then(d=>{d.forEach(f=>this._innerParser(f.text,f.filename))}),this.data}async _readAndParse(t){const n=t.stream().getReader(),s=new TextDecoder;let{value:o,done:a}=await n.read(),h="";for(;!a;){const c=(h+s.decode(o,{stream:!0})).split(`
`);h=c.pop();for(const u of c)this._innerParser(u,t.name);({value:o,done:a}=await n.read())}h&&this._innerParser(h,t.name)}async readFile(t,n){return this._path="",await this._readAndParse(t),this._cleanupGeometryArrays(),n&&await this._readAndParse(n),this.data}_cleanupGeometryArrays(){for(const t of this.geometries)t.data=Object.fromEntries(Object.entries(t.data).filter(([n,s])=>s.length>0))}}function Ie(l){let t=new Float32Array([1,1,1]);if(l instanceof Array)t[0]=l[0],t[1]=l[1],t[2]=l[2];else if(typeof l=="string"){let n=ve(l);t[0]=n[0],t[1]=n[1],t[2]=n[2]}return t}class ${constructor(t={}){var n;if(this._name=t.name||"noname",this._vertices=t.vertices||[],this._numVertices=this._vertices.length/3,this._texCoords=t.texCoords||new Array(2*this._numVertices),this.color=(n=t.color)instanceof Array?new Float32Array(n):typeof n=="string"?ve(n):new Float32Array([.5,.5,.5,1]),this.ambient=Ie(t.ambient),this.diffuse=Ie(t.diffuse),this.specular=Ie(t.specular),this.shininess=t.shininess||100,this.colorTextureSrc=t.colorTextureSrc||null,this.colorTextureImage=t.colorTextureImage||null,this.normalTextureSrc=t.normalTextureSrc||null,this.normalTextureImage=t.normalTextureImage||null,this.metallicRoughnessTextureSrc=t.metallicRoughnessTextureSrc||null,this.metallicRoughnessTextureImage=t.metallicRoughnessTextureImage||null,t.scale){let s,o=t.scale;s=typeof o=="number"?new v(o,o,o):o,$.scale(this._vertices,s)}if(t.center&&$.centering(this._vertices),this.center=$.getCenter(this._vertices),t.indices)this._indices=t.indices,this._normals=t.normals||[];else{this._normals=t.normals||$.getNormals(this._vertices),this._indices=new Array(this._vertices.length/3);for(let s=0,o=this._indices.length;s<o;s++)this._indices[s]=s}}static getCenter(t){let n=xt,s=xt,o=xt,a=Ct,h=Ct,c=Ct;for(let u=0,d=t.length;u<d;u+=3){let f=t[u],g=t[u+1],_=t[u+2];f<n&&(n=f),g<s&&(s=g),_<o&&(o=_),f>a&&(a=f),g>h&&(h=g),_>c&&(c=_)}return new v(n+.5*(a-n),s+.5*(h-s),o+.5*(c-o))}static centering(t){let n=$.getCenter(t);for(let s=0,o=t.length;s<o;s+=3)t[s]-=n.x,t[s+1]-=n.y,t[s+2]-=n.z}setMaterial(t){return t.ambient&&(this.ambient=Ie(t.ambient)),t.diffuse&&(this.diffuse=Ie(t.diffuse)),t.specular&&(this.specular=Ie(t.specular)),t.shininess!==void 0&&(this.shininess=t.shininess),this}centering(){return $.centering(this._vertices),this}applyMat4(t){for(let n=0,s=this._vertices.length;n<s;n+=3){let o=new v(this._vertices[n],this._vertices[n+1],this._vertices[n+2]),a=new v(this._normals[n],this._normals[n+1],this._normals[n+2]);o=t.mulVec3(o),a=t.mulVec3(a),this._vertices[n]=o.x,this._vertices[n+1]=o.y,this._vertices[n+2]=o.z,this._normals[n]=a.x,this._normals[n+1]=a.y,this._normals[n+2]=a.z}return this}scale(t){return $.scale(this._vertices,t),this}translate(t){for(let n=0,s=this._vertices.length;n<s;n+=3)this._vertices[n]+=t.x,this._vertices[n+1]+=t.y,this._vertices[n+2]+=t.z;return this}get name(){return this._name}get vertices(){return this._vertices}get normals(){return this._normals}get indices(){return this._indices}get texCoords(){return this._texCoords}get numVertices(){return this._numVertices}static scale(t,n){for(let s=0;s<t.length;s+=3)t[s]*=n.x,t[s+1]*=n.y,t[s+2]*=n.z}static centroid(t){let n=1e3,s=1e3,o=1e3,a=-1e3,h=-1e3,c=-1e3;for(let u=0;u<t.length;u+=3){let d=t[u],f=t[u+1],g=t[u+2];d<n&&(n=d),f<s&&(s=f),g<o&&(o=g),d>a&&(a=d),f>h&&(h=f),g>c&&(c=g)}return[n+.5*(a-n),s+.5*(h-s),o+.5*(c-o)]}static translate(t,n){for(let s=0;s<t.length;s+=3)t[s]+=n[0],t[s+1]+=n[1],t[s+2]+=n[2]}static getNormals(t){let n=new Array(t.length);for(let s=0;s<t.length;s+=9){let o=s,a=s+3,h=s+6,c=t[o],u=t[o+1],d=t[o+2],f=t[a]-c,g=t[a+1]-u,_=t[a+2]-d,m=t[h]-c,p=t[h+1]-u,x=t[h+2]-d,y=g*x-_*p,T=_*m-f*x,S=f*p-g*m,C=Math.sqrt(y*y+T*T+S*S);y/=C,T/=C,S/=C,n[o]=y,n[o+1]=T,n[o+2]=S,n[a]=y,n[a+1]=T,n[a+2]=S,n[h]=y,n[h+1]=T,n[h+2]=S}return n}static createSphere(t=16,n=16,s=1,o=0,a=0,h=0){let c=[],u=[],d=[];for(let f=0;f<=n;f++){let g=f*Math.PI/n,_=Math.sin(g),m=Math.cos(g);for(let p=0;p<=t;p++){let x=2*p*Math.PI/t,y=Math.sin(x),T=Math.cos(x)*_+o,S=m+a,C=y*_+h;d.push(T),d.push(S),d.push(C),c.push(s*T),c.push(s*S),c.push(s*C)}}for(let f=0;f<n;f++)for(let g=0;g<t;g++){let _=f*(t+1)+g,m=_+t+1;u.push(_),u.push(_+1),u.push(m),u.push(m),u.push(_+1),u.push(m+1)}return new $({vertices:c,normals:d,indices:u})}static createDisc(t=1,n=0,s=8,o=!0,a=0,h=0,c=0,u=0){let d=[],f=[],g=[],_=2*Math.PI,m=o?1:-1,p=a;for(let y=1;y<=s;y++)d.push(h,n*m+c,u),g.push(0,m,0),a++;let x=a;for(let y=0;y<=s;y++){let T=y/s*_+0,S=Math.cos(T),C=Math.sin(T);d.push(t*C+h,n*m+c,t*S+u),g.push(0,m,0),a++}for(let y=0;y<s;y++){let T=p+y,S=x+y;o?f.push(S,S+1,T):f.push(S+1,S,T)}return new $({vertices:d,normals:g,indices:f})}static getFrustumScaleByCameraAngles(t,n,s){return new v(2*t*Math.tan(Qt*n),2*t*Math.tan(Qt*s),t)}static getFrustumScaleByCameraAspectRatio(t,n,s){let o=Gr*Math.atan(Math.tan(Qt*n)/s);return $.getFrustumScaleByCameraAngles(t,n,o)}static createFrustum(t=1,n=1,s=1,o=0,a=0,h=0){return new $({vertices:[0+o,0+a,0+h,-1*(n*=.5)+o,1*(s*=.5)+a,-1*t+h,1*n+o,1*s+a,-1*t+h,0+o,0+a,0+h,1*n+o,-1*s+a,-1*t+h,-1*n+o,-1*s+a,-1*t+h,0+o,0+a,0+h,1*n+o,1*s+a,-1*t+h,1*n+o,-1*s+a,-1*t+h,0+o,0+a,0+h,-1*n+o,-1*s+a,-1*t+h,-1*n+o,1*s+a,-1*t+h,0+o,0+a,0+h,1*n+o,1*s+a,-1*t+h,-1*n+o,1*s+a,-1*t+h,0+o,0+a,0+h,-1*n+o,-1*s+a,-1*t+h,1*n+o,-1*s+a,-1*t+h,0+o,0+a,0+h,1*n+o,-1*s+a,-1*t+h,1*n+o,1*s+a,-1*t+h,0+o,0+a,0+h,-1*n+o,1*s+a,-1*t+h,-1*n+o,-1*s+a,-1*t+h]})}static createCylinder(t=1,n=1,s=1,o=32,a=1,h=!0,c=!0,u=0,d=0,f=0){let g=[],_=[],m=[],p=2*Math.PI,x=0,y=[],T=new v,S=(n-t)/s;for(let C=0;C<=a;C++){let P=[],w=C/a,I=w*(n-t)+t;for(let O=0;O<=o;O++){let N=O/o*p+0,k=Math.sin(N),D=Math.cos(N);g.push(I*k+u,-w*s+s+d,I*D+f),T.set(k,S,D).normalize(),m.push(T.x,T.y,T.z),P.push(x++)}y.push(P)}for(let C=0;C<o;C++)for(let P=0;P<a;P++){let w=y[P][C],I=y[P+1][C],O=y[P+1][C+1],N=y[P][C+1];_.push(w,I,N),_.push(I,O,N)}if(t!==0&&h){let C=$.createDisc(t,s,o,!0,x,u,d,f);g.push(...C.vertices),m.push(...C.normals),_.push(...C.indices)}if(n!==0&&c){let C=$.createDisc(n,0,o,!1,x+(h?1+2*o:0),u,d,f);g.push(...C.vertices),m.push(...C.normals),_.push(...C.indices)}return new $({vertices:g,normals:m,indices:_})}static createCube(t=1,n=1,s=1,o=0,a=0,h=0){let c=.5*t+o,u=.5*n+a,d=.5*s+h;return new $({vertices:[-c,-u,d,c,-u,-d,c,-u,d,-c,-u,d,-c,-u,-d,c,-u,-d,-c,u,d,c,u,d,c,u,-d,-c,u,d,c,u,-d,-c,u,-d,-c,-u,d,c,-u,d,-c,u,d,-c,u,d,c,-u,d,c,u,d,-c,-u,-d,-c,u,-d,c,-u,-d,-c,u,-d,c,u,-d,c,-u,-d,c,-u,d,c,-u,-d,c,u,d,c,u,d,c,-u,-d,c,u,-d,-c,-u,d,-c,u,d,-c,-u,-d,-c,u,d,-c,u,-d,-c,-u,-d]})}static createPlane(t=1,n=1,s=0,o=0,a=0){let h=.5*t,c=.5*n;return new $({vertices:[-h+s,o,c+a,h+s,o,-c+a,h+s,o,c+a,-h+s,o,c+a,-h+s,o,-c+a,h+s,o,-c+a,-h+s,o,c+a,h+s,o,c+a,h+s,o,-c+a,-h+s,o,c+a,h+s,o,-c+a,-h+s,o,-c+a]})}static createArrow(t=0,n=2.1,s=-15){return new $({vertices:[0,n,0,7,0,6,0,0,s,0,0,t,7,0,6,0,n,0,-7,0,6,0,0,t,0,n,0,-7,0,6,0,n,0,0,0,s,-7,0,6,0,0,s,0,0,t,0,0,t,0,0,s,7,0,6]})}static async readFileObj(t,n,s){const o=await new Cn().readFile(t,n);let a=o.materials;return o.geometries.map(h=>{let c=a[h.material]||{};return new $({name:h.object,vertices:h.data.vertices,normals:h.data.normals,texCoords:h.data.texCoords,ambient:c.ambient,diffuse:c.diffuse,specular:c.specular,shininess:c.shininess,color:c.color,colorTextureSrc:s?`${s}/${c.colorTexture}`:c.colorTexture,normalTextureSrc:s?`${s}/${c.normalTexture}`:c.normalTexture,metallicRoughnessTextureSrc:s?`${s}/${c.metallicRoughnessTexture}`:c.metallicRoughnessTexture})})}static async loadObj(t){const n=await new Cn().load(t);let s=n.materials;return n.geometries.map(o=>{let a=s[o.material]||{};return new $({name:o.object,vertices:o.data.vertices,normals:o.data.normals,texCoords:o.data.texCoords,ambient:a.ambient,diffuse:a.diffuse,specular:a.specular,shininess:a.shininess,color:a.color,colorTextureSrc:a.colorTexture,normalTextureSrc:a.normalTexture,metallicRoughnessTextureSrc:a.metallicRoughnessTexture})})}merge(t){const n=this._vertices.length/3;let s=this._vertices.length;this._vertices.length=s+t._vertices.length;for(let o=0;o<t._vertices.length;o++)this._vertices[s+o]=t._vertices[o];s=this._normals.length,this._normals.length=s+t._normals.length;for(let o=0;o<t._normals.length;o++)this._normals[s+o]=t._normals[o];s=this._texCoords.length,this._texCoords.length=s+t._texCoords.length;for(let o=0;o<t._texCoords.length;o++)this._texCoords[s+o]=t._texCoords[o];s=this._indices.length,this._indices.length=s+t._indices.length;for(let o=0;o<t._indices.length;o++)this._indices[s+o]=t._indices[o]+n;return this._numVertices=this._vertices.length/3,this}static merge(t,n){let s=new $,o=n||t.length;for(let a=0;a<o;a++)s.merge(t[a]);return s}}const tl=new v(0,0,-1),gs=class ed{constructor(t){var n,s;this._handlerIndex=-1,this._tag=t.tag||"tag_"+ed.__counter__++,this._entity=null,this._position=Yt(t.position),this._rtcPositionHigh=new v,this._rtcPositionLow=new v,this._scale=Yt(t.scale,new v(1,1,1)),this._translate=Yt(t.translate,new v),this._localPosition=new v;const[o=.15,a=.15,h=.15,c=1]=(n=t.object3d)!=null&&n.color?Array.from(t.object3d.color):[];this._color=le(t.color,new et(o,a,h,c)),this._handler=null,this._handlerIndex=-1,this._tagData=null,this._tagDataIndex=-1;let u=t.object3d;t.object3d&&((s=t.object3d)==null?void 0:s.vertices.length)!==0||(u=new $),t.objSrc&&(this.setObjectSrc(t.objSrc),this._objectSrc=t.objSrc),this._object3d=u,this._visibility=t.visibility==null||t.visibility,this._children=[],this._direction=new v,this._qFrame=new F,this._qRot=F.IDENTITY}get tag(){return this._tag}getPosition(){return this._position}get object3d(){return this._object3d}get vertices(){return this._object3d.vertices}get normals(){return this._object3d.normals}get texCoords(){return this._object3d.texCoords}get indices(){return this._object3d.indices}setOpacity(t){this._color.w=t,this.setColor(this._color.x,this._color.y,this._color.z,t)}getOpacity(){return this._color.w}setColor(t,n,s,o){this._color.x=t,this._color.y=n,this._color.z=s,o!=null&&(this._color.w=o),this._handler&&this._handler.setRgbaArr(this._tagData,this._tagDataIndex,this._color)}setColor4v(t){this._color.x=t.x,this._color.y=t.y,this._color.z=t.z,t.w!=null&&(this._color.w=t.w),this._handler&&this._handler.setRgbaArr(this._tagData,this._tagDataIndex,this._color)}setVisibility(t){this._visibility=t,this._handler&&this._handler.setVisibility(this._tagData,this._tagDataIndex,t)}getVisibility(){return this._visibility}setPosition(t,n,s){this._position.x=t,this._position.y=n,this._position.z=s,this.updateRTCPosition(),this.updateRotation()}updateRTCPosition(){this._handler&&(this._handler.getRTCPosition(this._position,this._rtcPositionHigh,this._rtcPositionLow),this._handler.setRTCPositionArr(this._tagData,this._tagDataIndex,this._rtcPositionHigh,this._rtcPositionLow))}setPosition3v(t){this.setPosition(t.x,t.y,t.z)}setObject(t){this._object3d=t}setObjectSrc(t){this._objectSrc=t,this._handler&&this._handler.setObjectSrc(t,this.tag)}setColorHTML(t){this.setColor4v(he(t))}setScale(t){this._scale.x=this._scale.y=this._scale.z=t,this._handler&&this._handler.setScaleArr(this._tagData,this._tagDataIndex,this._scale)}setScale3v(t){this._scale.copy(t),this._handler&&this._handler.setScaleArr(this._tagData,this._tagDataIndex,t)}getScale(){return this._scale}setTranslate3v(t){this._translate.copy(t),this._handler&&this._handler.setTranslateArr(this._tagData,this._tagDataIndex,t)}getTranslate(){return this._translate.clone()}setLocalPosition3v(t){this._localPosition.copy(t),this._handler&&this._handler.setLocalPositionArr(this._tagData,this._tagDataIndex,t)}getLocalPosition(){return this._localPosition.clone()}remove(){this._entity=null,this._handler&&this._handler.remove(this)}setPickingColor3v(t){this._handler&&this._handler.setPickingColorArr(this._tagData,this._tagDataIndex,t)}setRotation(t){this._qRot.copy(t),this._qRot.mulVec3Res(tl,this._direction).normalize(),this.updateRotation()}getRotation(){return this._qRot}updateRotation(){this._handler&&this._handler.setQRotArr(this._tagData,this._tagDataIndex,this._qRot)}getDirection(){return this._direction.clone()}};gs.__counter__=0;let yr=gs;const _i={RIGHT:0,LEFT:1,CENTER:2},En={left:_i.LEFT,right:_i.RIGHT,center:_i.CENTER};class el extends rs{constructor(t={}){super(t),this._handler=null,this._text=t.text||"",this._face=Bo(t.face,"arial"),this._size=t.size||24,this._outline=t.outline!=null?t.outline:0,this._outlineColor=le(t.outlineColor,new et(0,0,0,1)),this._align=t.align&&En[t.align.trim().toLowerCase()]||_i.RIGHT,this._fontIndex=0,this._fontAtlas=null,this._isRTL=t.isRTL||!1,this._letterSpacing=t.letterSpacing||0}setText(t){this._text=t.toString(),this._isReady&&this._handler&&this._handler.setText(this._handlerIndex,t,this._fontIndex,this._align,this._letterSpacing,this._isRTL)}setLetterSpacing(t){this._letterSpacing=t,this._isReady&&this._handler&&this._handler.setText(this._handlerIndex,this._text,this._fontIndex,this._align,t,this._isRTL)}getLetterSpacing(){return this._letterSpacing}setRtl(t){this._isRTL=t,this._isReady&&this._handler&&this._handler.setText(this._handlerIndex,this._text,this._fontIndex,this._align,this._letterSpacing,this._isRTL)}getText(){return this._text}setAlign(t){this._align=En[t.trim().toLowerCase()],this._isReady&&this._handler?this._handler.setText(this._handlerIndex,this._text,this._fontIndex,this._align,this._letterSpacing,this._isRTL):this._lockId!==-1&&(this._lockId=-2)}getAlign(){return this._align}setFace(t){this._face=t.trim(),this.update()}getFace(){return this._face}setSize(t){t!==this._size&&(this._size=t,this._isReady&&this._handler?this._handler.setSizeArr(this._handlerIndex,t):this._lockId!==-1&&(this._lockId=-2))}getSize(){return this._size}setOutline(t){this._outline=t,this._isReady&&this._handler?this._handler.setOutlineArr(this._handlerIndex,t):this._lockId!==-1&&(this._lockId=-2)}getOutline(){return this._outline}setOpacity(t){super.setOpacity(t),this.setOutlineOpacity(t)}setOutlineColor(t,n,s,o){o===this._outlineColor.w&&t===this._outlineColor.x&&n===this._outlineColor.y&&s===this._outlineColor.z||(this._outlineColor.x=t,this._outlineColor.y=n,this._outlineColor.z=s,this._outlineColor.w=o,this._isReady&&this._handler?this._handler.setOutlineColorArr(this._handlerIndex,this._outlineColor):this._lockId!==-1&&(this._lockId=-2))}setOutlineColor4v(t){this.setOutlineColor(t.x,t.y,t.z,t.w)}setOutlineColorHTML(t){this.setOutlineColor4v(he(t))}getOutlineColor(){return this._outlineColor}setOutlineOpacity(t){t!==this._outlineColor.w&&(this._outlineColor.w=t,this._isReady&&this._handler?this._handler.setOutlineColorArr(this._handlerIndex,this._outlineColor):this._lockId!==-1&&(this._lockId=-2))}getOutlineOpacity(){return this._outlineColor.w}async update(){if(this._fontAtlas){const t=await this._fontAtlas.getFontIndex(this._face);this._applyFontIndex(t)}}_applyFontIndex(t){this._fontIndex=t,this._isReady&&this._handler?(this._handler.setFontIndexArr(this._handlerIndex,this._fontIndex),this._handler.setText(this._handlerIndex,this._text,this._fontIndex,this._align,this._letterSpacing,this._isRTL)):this._lockId!==-1&&(this._lockId=-2)}assignFontAtlas(t){this._fontAtlas||(this._fontAtlas=t),this.update()}serializeWorkerData(t){return this._handler?new Float32Array([t,this._handler._maxLetters,this.getVisibility()?1:0,this._positionHigh.x,this._positionHigh.y,this._positionHigh.z,this._positionLow.x,this._positionLow.y,this._positionLow.z,this._size,this._offset.x,this._offset.y,this._offset.z,this._color.x,this._color.y,this._color.z,this._color.w,this._rotation,this._alignedAxis.x,this._alignedAxis.y,this._alignedAxis.z,this._fontIndex,this._outline,this._outlineColor.x,this._outlineColor.y,this._outlineColor.z,this._outlineColor.w,this._entity._pickingColor.x,this._entity._pickingColor.y,this._entity._pickingColor.z]):null}}const ps=class td{constructor(t={}){this.__id=td.__counter__++,this.visibility=t.visibility==null||t.visibility,this.pointSize=t.pointSize||3,this.pickingScale=t.pickingScale||0,this._renderNode=null,this._entity=null,this._points=[],this._coordinatesData=[],this._colorData=[],this._pickingColorData=[],this._coordinatesBuffer=null,this._colorBuffer=null,this._pickingColorBuffer=null,this._handler=null,this._handlerIndex=-1,this._buffersUpdateCallbacks=[],this._buffersUpdateCallbacks[0]=this._createCoordinatesBuffer,this._buffersUpdateCallbacks[1]=this._createColorBuffer,this._buffersUpdateCallbacks[2]=this._createPickingColorBuffer,this._changedBuffers=new Array(this._buffersUpdateCallbacks.length),t.points&&this.setPoints(t.points)}clear(){this._points.length=0,this._points=[],this._coordinatesData.length=0,this._coordinatesData=[],this._colorData.length=0,this._colorData=[],this._pickingColorData.length=0,this._pickingColorData=[],this._deleteBuffers()}setVisibility(t){this.visibility=t}getVisibility(){return this.visibility}setRenderNode(t){this._renderNode=t,this._setPickingColors()}remove(){this._entity=null,this._handler&&this._handler.remove(this)}setPoints(t){this.clear();for(let n=0;n<t.length;n++){let s=t[n],o=new v(s[0],s[1],s[2]),a=new et(s[3],s[4],s[5],s[6]==null?255:s[6]);this._coordinatesData.push(o.x,o.y,o.z),this._colorData.push(a.x/255,a.y/255,a.z/255,a.w/255);let h={_entity:this._entity,_pickingColor:new v,_entityCollection:this._entity?this._entity._entityCollection:null,index:n,position:o,color:a,pointCloud:this,properties:s[7]||{}};this._points.push(h),this._renderNode&&this._renderNode.renderer&&(this._renderNode.renderer.assignPickingColor(h),this._pickingColorData.push(h._pickingColor.x/255,h._pickingColor.y/255,h._pickingColor.z/255,1))}this._changedBuffers[0]=!0,this._changedBuffers[1]=!0,this._changedBuffers[2]=!0}setPointPosition(t,n,s,o){this._changedBuffers[0]=!0}setPointColor(t,n,s,o,a){this._changedBuffers[1]=!0}addPoints(t){this._changedBuffers[0]=!0,this._changedBuffers[1]=!0,this._changedBuffers[2]=!0}addPoint(t,n){this._changedBuffers[0]=!0,this._changedBuffers[1]=!0,this._changedBuffers[2]=!0}getPoint(t){return this._points[t]}removePoint(t){this._changedBuffers[0]=!0,this._changedBuffers[1]=!0,this._changedBuffers[2]=!0}insertPoint(t,n){this._changedBuffers[0]=!0,this._changedBuffers[1]=!0,this._changedBuffers[2]=!0}draw(){if(this.visibility&&this._coordinatesData.length){this._update();let t=this._renderNode.renderer,n=t.handler.programs.pointCloud,s=n._program,o=t.handler.gl,a=s.attributes,h=s.uniforms;n.activate(),o.uniformMatrix4fv(h.projectionViewMatrix,!1,t.activeCamera.getProjectionViewMatrix()),o.uniform1f(h.opacity,this._handler._entityCollection._fadingOpacity),o.uniform1f(h.pointSize,this.pointSize),o.bindBuffer(o.ARRAY_BUFFER,this._coordinatesBuffer),o.vertexAttribPointer(a.coordinates,this._coordinatesBuffer.itemSize,o.FLOAT,!1,0,0),o.bindBuffer(o.ARRAY_BUFFER,this._colorBuffer),o.vertexAttribPointer(a.colors,this._colorBuffer.itemSize,o.FLOAT,!1,0,0),o.drawArrays(o.POINTS,0,this._coordinatesBuffer.numItems)}}drawPicking(){if(this.visibility&&this._coordinatesData.length){let t=this._renderNode.renderer,n=t.handler.programs.pointCloud,s=n._program,o=t.handler.gl,a=s.attributes,h=s.uniforms;n.activate(),o.uniformMatrix4fv(h.projectionViewMatrix,!1,t.activeCamera.getProjectionViewMatrix()),o.uniform1f(h.opacity,this._handler._entityCollection._fadingOpacity),o.uniform1f(h.pointSize,this.pointSize+this.pickingScale),o.bindBuffer(o.ARRAY_BUFFER,this._coordinatesBuffer),o.vertexAttribPointer(a.coordinates,this._coordinatesBuffer.itemSize,o.FLOAT,!1,0,0),o.bindBuffer(o.ARRAY_BUFFER,this._pickingColorBuffer),o.vertexAttribPointer(a.colors,this._pickingColorBuffer.itemSize,o.FLOAT,!1,0,0),o.drawArrays(o.POINTS,0,this._coordinatesBuffer.numItems)}}_update(){if(this._renderNode){let t=this._changedBuffers.length;for(;t--;)this._changedBuffers[t]&&(this._buffersUpdateCallbacks[t].call(this),this._changedBuffers[t]=!1)}}_deleteBuffers(){if(this._renderNode){let t=this._renderNode.renderer.handler.gl;t.deleteBuffer(this._coordinatesBuffer),t.deleteBuffer(this._colorBuffer),t.deleteBuffer(this._pickingColorBuffer)}this._coordinatesBuffer=null,this._colorBuffer=null,this._pickingColorBuffer=null}_createCoordinatesBuffer(){let t=this._renderNode.renderer.handler;t.gl.deleteBuffer(this._coordinatesBuffer),this._coordinatesBuffer=t.createArrayBuffer(new Float32Array(this._coordinatesData),3,this._coordinatesData.length/3)}_createColorBuffer(){let t=this._renderNode.renderer.handler;t.gl.deleteBuffer(this._colorBuffer),this._colorBuffer=t.createArrayBuffer(new Float32Array(this._colorData),4,this._colorData.length/4)}_createPickingColorBuffer(){let t=this._renderNode.renderer.handler;t.gl.deleteBuffer(this._pickingColorBuffer),this._pickingColorBuffer=t.createArrayBuffer(new Float32Array(this._pickingColorData),4,this._pickingColorData.length/4)}_setPickingColors(){if(this._renderNode&&this._renderNode.renderer){for(let t=0;t<this._points.length;t++){let n=this._points[t];n._entity=this._entity,n._entityCollection=this._entity._entityCollection,this._renderNode.renderer.assignPickingColor(n),this._pickingColorData.push(n._pickingColor.x/255,n._pickingColor.y/255,n._pickingColor.z/255,1)}this._changedBuffers[2]=!0}}};ps.__counter__=0;let xr=ps;const qe=class wu{constructor(t={}){this.__id=wu.__counter__++,this.__doubleToTwoFloats=v.doubleToTwoFloats,this.altitude=t.altitude||0,this.thickness=t.thickness||1.5,this._opacity=t.opacity!=null?t.opacity:1,this._defaultColor=ve(t.color||"#0000FF",t.opacity),this.visibility=t.visibility==null||t.visibility,this._closedLine=t.isClosed||!1,this._path3v=[],this._pathLengths=[],this._pathLonLat=[],this._pathLonLatMerc=[],this._pathColors=t.pathColors?Qr(t.pathColors):[],this._extent=new U,this._verticesHigh=[],this._verticesLow=[],this._orders=[],this._indexes=[],this._colors=[],this._texCoordArr=[],this._atlasTexCoords=[],this._verticesHighBuffer=null,this._verticesLowBuffer=null,this._ordersBuffer=null,this._indexesBuffer=null,this._colorsBuffer=null,this._texCoordBuffer=null,this._pickingColor=[0,0,0],this._renderNode=null,this._entity=null,this._handler=null,this._handlerIndex=-1,this._image=t.image||null,this._src=t.src||null,this._texOffset=t.texOffset||0,this._strokeSize=t.strokeSize!=null?t.strokeSize:32,this._buffersUpdateCallbacks=[],this._buffersUpdateCallbacks[0]=this._createVerticesBuffer,this._buffersUpdateCallbacks[1]=this._createIndexBuffer,this._buffersUpdateCallbacks[2]=this._createColorsBuffer,this._buffersUpdateCallbacks[3]=this._createTexCoordBuffer,this._changedBuffers=new Array(this._buffersUpdateCallbacks.length);let n=Yt(t.visibleSpherePosition).toArray(),s=t.visibleSphereRadius||0;this._visibleSphere=new Float32Array([...n,s]),t.pathLonLat?this.setPathLonLat(t.pathLonLat):t.path3v&&this.setPath3v(t.path3v),this._refresh()}get texOffset(){return this._texOffset}set texOffset(t){this._texOffset=t}get strokeSize(){return this._strokeSize}set strokeSize(t){this._strokeSize=t}setSrc(t){this._src=t;let n=this._handler;if(n){let s=n._entityCollection.renderNode;if(s&&s.renderer){let o=s.renderer.strokeTextureAtlas;t&&t.length?o.loadImage(t,a=>{if(a.__nodeIndex!=null&&o.get(a.__nodeIndex)){this._image=a;let h=o.get(a.__nodeIndex);this._setTexCoordArr(h.texCoords)}else o.addImage(a),o.createTexture(),this._image=a,s.updateStrokeTexCoords()}):(this.setTextureDisabled(),s.updateStrokeTexCoords())}}}getSrc(){return this._src}setImage(t){this.setSrc(t.src)}getImage(){return this._image}_setTexCoordArr(t){this._texCoordArr=[],this._atlasTexCoords=t,wu.setPathTexCoords(this._path3v,t,this._texCoordArr),this._changedBuffers[3]=!0}setTextureDisabled(){this._strokeSize=0}__appendLineData3v(t,n,s,o,a,h,c,u,d,f,g,_,m,p){var x=0,y=new v,T=new v;m&&(m.southWest.set(180,90),m.northEast.set(-180,-90)),u.length>0?(x=u[u.length-5]+9,u.push(x,x)):u.push(0,0);for(let ze=0,z=t.length;ze<z;ze++){var S=t[ze],C=n[ze];if(f[ze]=[],_[ze]=[],g[ze]=[],S.length===0)continue;var P,w=x;if(o)(P=S[S.length-1])instanceof Array&&(P=new v(P[0],P[1],P[2]));else{var I=S[0],O=S[1]||I;I instanceof Array&&(I=new v(I[0],I[1],I[2])),O instanceof Array&&(O=new v(O[0],O[1],O[2])),P=new v(I.x+I.x-O.x,I.y+I.y-O.y,I.z+I.z-O.z)}let Ee=s;C&&C[0]&&(Ee=C[0]),this.__doubleToTwoFloats(P,y,T),a.push(y.x,y.y,y.z,y.x,y.y,y.z,y.x,y.y,y.z,y.x,y.y,y.z),h.push(T.x,T.y,T.z,T.x,T.y,T.z,T.x,T.y,T.z,T.x,T.y,T.z);let B=Ee[0],rt=Ee[1],wt=Ee[2],re=Ee[3]!=null?Ee[3]:1;ze>0&&p.push(B,rt,wt,re,B,rt,wt,re,B,rt,wt,re,B,rt,wt,re),c.push(1,-1,2,-2);for(let mt=0,Mt=S.length;mt<Mt;mt++){var N=S[mt];if(N instanceof Array&&(N=new v(N[0],N[1],N[2])),g[ze].push(N),d){var k=d.cartesianToLonLat(N);f[ze].push(k),_[ze].push(k.forwardMercator()),k.lon<m.southWest.lon&&(m.southWest.lon=k.lon),k.lat<m.southWest.lat&&(m.southWest.lat=k.lat),k.lon>m.northEast.lon&&(m.northEast.lon=k.lon),k.lat>m.northEast.lat&&(m.northEast.lat=k.lat)}C&&C[mt]&&(Ee=C[mt]),B=Ee[0],rt=Ee[1],wt=Ee[2],re=Ee[3]!=null?Ee[3]:1,this.__doubleToTwoFloats(N,y,T),a.push(y.x,y.y,y.z,y.x,y.y,y.z,y.x,y.y,y.z,y.x,y.y,y.z),h.push(T.x,T.y,T.z,T.x,T.y,T.z,T.x,T.y,T.z,T.x,T.y,T.z),p.push(B,rt,wt,re,B,rt,wt,re,B,rt,wt,re,B,rt,wt,re),c.push(1,-1,2,-2),u.push(x++,x++,x++,x++)}var D;if(o)(D=S[0])instanceof Array&&(D=new v(D[0],D[1],D[2])),u.push(w,w+1,w+1,w+1);else{let mt=S[S.length-1],Mt=S[S.length-2]||mt;mt instanceof Array&&(mt=new v(mt[0],mt[1],mt[2])),Mt instanceof Array&&(Mt=new v(Mt[0],Mt[1],Mt[2])),D=new v(mt.x+mt.x-Mt.x,mt.y+mt.y-Mt.y,mt.z+mt.z-Mt.z),u.push(x-1,x-1,x-1,x-1)}C&&C[S.length-1]&&(Ee=C[S.length-1]),B=Ee[0],rt=Ee[1],wt=Ee[2],re=Ee[3]!=null?Ee[3]:1,this.__doubleToTwoFloats(D,y,T),a.push(y.x,y.y,y.z,y.x,y.y,y.z,y.x,y.y,y.z,y.x,y.y,y.z),h.push(T.x,T.y,T.z,T.x,T.y,T.z,T.x,T.y,T.z,T.x,T.y,T.z),p.push(B,rt,wt,re,B,rt,wt,re,B,rt,wt,re,B,rt,wt,re),c.push(1,-1,2,-2),ze<t.length-1&&t[ze+1].length!==0&&(x+=8,u.push(x,x))}}__appendPoint3v(t,n,s,o,a,h,c,u,d,f,g,_,m,p){var x=new v,y=new v,T=f.length-4,S=f[T-1]+1;t.length===0?(t.push([]),s[0]||(s[0]=[])):s[t.length-1]||(s[t.length-1]=[]);var C=t[t.length-1],P=C.length;C.push(n);let w=o[0],I=o[1],O=o[2],N=o[3]!=null?o[3]:1,k=s[t.length-1];if(k[P]?(k[P][0]=w,k[P][1]=I,k[P][2]=O,k[P][3]=N):k.push(o),P===1){var D;if(a)(D=C[P-1])instanceof Array&&(D=new v(D[0],D[1],D[2]));else{let mt=C[0],Mt=C[1]||mt;mt instanceof Array&&(mt=new v(mt[0],mt[1],mt[2])),Mt instanceof Array&&(Mt=new v(Mt[0],Mt[1],Mt[2])),D=new v(mt.x+mt.x-Mt.x,mt.y+mt.y-Mt.y,mt.z+mt.z-Mt.z)}this.__doubleToTwoFloats(D,x,y);let re=h.length-36;h[re]=x.x,h[re+1]=x.y,h[re+2]=x.z,h[re+3]=x.x,h[re+4]=x.y,h[re+5]=x.z,h[re+6]=x.x,h[re+7]=x.y,h[re+8]=x.z,h[re+9]=x.x,h[re+10]=x.y,h[re+11]=x.z,c[re]=y.x,c[re+1]=y.y,c[re+2]=y.z,c[re+3]=y.x,c[re+4]=y.y,c[re+5]=y.z,c[re+6]=y.x,c[re+7]=y.y,c[re+8]=y.z,c[re+9]=y.x,c[re+10]=y.y,c[re+11]=y.z}var ze=S;if(g){_.length===0&&_.push([]),m.length===0&&m.push([]);var z=_[_.length-1],Ee=m[m.length-1];let re=g.cartesianToLonLat(n);z.push(re),Ee.push(re.forwardMercator()),re.lon<p.southWest.lon&&(p.southWest.lon=re.lon),re.lat<p.southWest.lat&&(p.southWest.lat=re.lat),re.lon>p.northEast.lon&&(p.northEast.lon=re.lon),re.lat>p.northEast.lat&&(p.northEast.lat=re.lat)}this.__doubleToTwoFloats(n,x,y);let B=h.length-12;h[B]=x.x,h[B+1]=x.y,h[B+2]=x.z,h[B+3]=x.x,h[B+4]=x.y,h[B+5]=x.z,h[B+6]=x.x,h[B+7]=x.y,h[B+8]=x.z,h[B+9]=x.x,h[B+10]=x.y,h[B+11]=x.z,c[B]=y.x,c[B+1]=y.y,c[B+2]=y.z,c[B+3]=y.x,c[B+4]=y.y,c[B+5]=y.z,c[B+6]=y.x,c[B+7]=y.y,c[B+8]=y.z,c[B+9]=y.x,c[B+10]=y.y,c[B+11]=y.z;let rt=u.length-16;var wt;if(u[rt]=w,u[rt+1]=I,u[rt+2]=O,u[rt+3]=N,u[rt+4]=w,u[rt+5]=I,u[rt+6]=O,u[rt+7]=N,u[rt+8]=w,u[rt+9]=I,u[rt+10]=O,u[rt+11]=N,u[rt+12]=w,u[rt+13]=I,u[rt+14]=O,u[rt+15]=N,f[T]=S++,f[T+1]=S++,f[T+2]=S++,f[T+3]=S++,a)wt=C[0],f.push(ze,ze+1,ze+1,ze+1);else{let re=C[C.length-1],mt=C[C.length-2]||re;wt=new v(re.x+re.x-mt.x,re.y+re.y-mt.y,re.z+re.z-mt.z),f.push(S-1,S-1,S-1,S-1)}this.__doubleToTwoFloats(wt,x,y),h.push(x.x,x.y,x.z,x.x,x.y,x.z,x.x,x.y,x.z,x.x,x.y,x.z),c.push(y.x,y.y,y.z,y.x,y.y,y.z,y.x,y.y,y.z,y.x,y.y,y.z),u.push(w,I,O,N,w,I,O,N,w,I,O,N,w,I,O,N),d.push(1,-1,2,-2)}static setPathTexCoords(t,n,s){let o=n[1],a=n[3]-o,h=new H(n[4],n[5]),c=new H(n[2],n[3]),u=new H(n[8],n[9]),d=new H(n[0],n[1]);for(let g=0,_=t.length;g<_;g++){var f=t[g];if(f.length!==0){g>0&&s.push(h.x,h.y,o,a,c.x,c.y,o,a,u.x,u.y,o,a,d.x,d.y,o,a);for(let m=0,p=f.length;m<p;m++)s.push(h.x,h.y,o,a,c.x,c.y,o,a,u.x,u.y,o,a,d.x,d.y,o,a);s.push(h.x,h.y,o,a,c.x,c.y,o,a,u.x,u.y,o,a,d.x,d.y,o,a)}}}static setPathColors(t,n,s,o){for(let c=0,u=t.length;c<u;c++){var a=t[c],h=n[c];if(a.length===0)continue;let d=s;h&&h[0]&&(d=h[0]);let f=d[0],g=d[1],_=d[2],m=d[3]!=null?d[3]:1;c>0&&o.push(f,g,_,m,f,g,_,m,f,g,_,m,f,g,_,m);for(let p=0,x=a.length;p<x;p++)h&&h[p]&&(d=h[p]),f=d[0],g=d[1],_=d[2],m=d[3]!=null?d[3]:1,o.push(f,g,_,m,f,g,_,m,f,g,_,m,f,g,_,m);h&&h[a.length-1]&&(d=h[a.length-1]),f=d[0],g=d[1],_=d[2],m=d[3]!=null?d[3]:1,o.push(f,g,_,m,f,g,_,m,f,g,_,m,f,g,_,m)}}__appendLineDataLonLat(t,n,s,o,a,h,c,u,d,f,g,_,m,p,x){var y=0,T=new v,S=new v;p&&(p.southWest.set(180,90),p.northEast.set(-180,-90)),u.length>0?(y=u[u.length-5]+9,u.push(y)):u.push(0);for(let D=0,ze=t.length;D<ze;D++){var C=t[D],P=n[D];if(g[D]=[],m[D]=[],_[D]=[],C.length===0)continue;var w,I=y;if(o){let re=C[C.length-1];w=re instanceof Array?f.lonLatToCartesian(new L(re[0],re[1],re[2])):f.lonLatToCartesian(re)}else{let re,mt,Mt=C[0];re=Mt instanceof Array?f.lonLatToCartesian(new L(Mt[0],Mt[1],Mt[2])):f.lonLatToCartesian(Mt),Mt=C[1],Mt||(Mt=C[0]),mt=Mt instanceof Array?f.lonLatToCartesian(new L(Mt[0],Mt[1],Mt[2])):f.lonLatToCartesian(Mt),w=new v(re.x+re.x-mt.x,re.y+re.y-mt.y,re.z+re.z-mt.z)}let z=s;P&&P[0]&&(z=P[0]),this.__doubleToTwoFloats(w,T,S),a.push(T.x,T.y,T.z,T.x,T.y,T.z,T.x,T.y,T.z,T.x,T.y,T.z),h.push(S.x,S.y,S.z,S.x,S.y,S.z,S.x,S.y,S.z,S.x,S.y,S.z);let Ee=z[0],B=z[1],rt=z[2],wt=z[3]!=null?z[3]:1;D>0&&x.push(Ee,B,rt,wt,Ee,B,rt,wt,Ee,B,rt,wt,Ee,B,rt,wt),c.push(1,-1,2,-2),d.push(0,0,0,0,1,0,0,0,1,0,0,0,1,1,0,0);for(let re=0,mt=C.length;re<mt;re++){var O=C[re];O instanceof Array&&(O=new L(O[0],O[1],O[2])),P&&P[re]&&(z=P[re]),Ee=z[0],B=z[1],rt=z[2],wt=z[3]!=null?z[3]:1;var N=f.lonLatToCartesian(O);g[D].push(N),_[D].push(O),m[D].push(O.forwardMercator()),this.__doubleToTwoFloats(N,T,S),a.push(T.x,T.y,T.z,T.x,T.y,T.z,T.x,T.y,T.z,T.x,T.y,T.z),h.push(S.x,S.y,S.z,S.x,S.y,S.z,S.x,S.y,S.z,S.x,S.y,S.z),x.push(Ee,B,rt,wt,Ee,B,rt,wt,Ee,B,rt,wt,Ee,B,rt,wt),c.push(1,-1,2,-2),u.push(y++,y++,y++,y++),d.push(0,0,0,0,1,0,0,0,1,0,0,0,1,1,0,0),O.lon<p.southWest.lon&&(p.southWest.lon=O.lon),O.lat<p.southWest.lat&&(p.southWest.lat=O.lat),O.lon>p.northEast.lon&&(p.northEast.lon=O.lon),O.lat>p.northEast.lat&&(p.northEast.lat=O.lat)}var k;if(o){let re=C[0];k=re instanceof Array?f.lonLatToCartesian(new L(re[0],re[1],re[2])):f.lonLatToCartesian(re),u.push(I,I+1,I+1,I+1)}else{let re,mt,Mt=C[C.length-1];re=Mt instanceof Array?f.lonLatToCartesian(new L(Mt[0],Mt[1],Mt[2])):f.lonLatToCartesian(Mt),Mt=C[C.length-2],Mt||(Mt=C[0]),mt=Mt instanceof Array?f.lonLatToCartesian(new L(Mt[0],Mt[1],Mt[2])):f.lonLatToCartesian(Mt),k=new v(re.x+re.x-mt.x,re.y+re.y-mt.y,re.z+re.z-mt.z),u.push(y-1,y-1,y-1,y-1)}P&&P[C.length-1]&&(z=P[C.length-1]),Ee=z[0],B=z[1],rt=z[2],wt=z[3]!=null?z[3]:1,this.__doubleToTwoFloats(k,T,S),a.push(T.x,T.y,T.z,T.x,T.y,T.z,T.x,T.y,T.z,T.x,T.y,T.z),h.push(S.x,S.y,S.z,S.x,S.y,S.z,S.x,S.y,S.z,S.x,S.y,S.z),x.push(Ee,B,rt,wt,Ee,B,rt,wt,Ee,B,rt,wt,Ee,B,rt,wt),c.push(1,-1,2,-2),d.push(0,0,0,0,1,0,0,0,1,0,0,0,1,1,0,0),D<t.length-1&&t[D+1].length!==0&&(y+=8,u.push(y,y))}}_setEqualPath3v(t){var n=this._extent;n.southWest.set(180,90),n.northEast.set(-180,-90);var s=new v,o=new v,a=this._verticesHigh,h=this._verticesLow,c=this._pathLonLat,u=this._pathLonLatMerc,d=0,f=this._renderNode.ellipsoid;for(let S=0;S<t.length;S++){var g,_,m=t[S];g=this._closedLine?m[m.length-1]:new v(m[0].x+m[0].x-m[1].x,m[0].y+m[0].y-m[1].y,m[0].z+m[0].z-m[1].z),this.__doubleToTwoFloats(g,s,o),a[d]=s.x,h[d++]=o.x,a[d]=s.y,h[d++]=o.y,a[d]=s.z,h[d++]=o.z,a[d]=s.x,h[d++]=o.x,a[d]=s.y,h[d++]=o.y,a[d]=s.z,h[d++]=o.z,a[d]=s.x,h[d++]=o.x,a[d]=s.y,h[d++]=o.y,a[d]=s.z,h[d++]=o.z,a[d]=s.x,h[d++]=o.x,a[d]=s.y,h[d++]=o.y,a[d]=s.z,h[d++]=o.z;for(let C=0;C<m.length;C++){var p=m[C],x=this._path3v[S][C];if(x.x=p.x,x.y=p.y,x.z=p.z,f){var y=f.cartesianToLonLat(p);this._pathLonLat[S][C]=y,c[S][C]=y,u[S][C]=y.forwardMercator(),y.lon<n.southWest.lon&&(n.southWest.lon=y.lon),y.lat<n.southWest.lat&&(n.southWest.lat=y.lat),y.lon>n.northEast.lon&&(n.northEast.lon=y.lon),y.lat>n.northEast.lat&&(n.northEast.lat=y.lat)}this.__doubleToTwoFloats(p,s,o),a[d]=s.x,h[d++]=o.x,a[d]=s.y,h[d++]=o.y,a[d]=s.z,h[d++]=o.z,a[d]=s.x,h[d++]=o.x,a[d]=s.y,h[d++]=o.y,a[d]=s.z,h[d++]=o.z,a[d]=s.x,h[d++]=o.x,a[d]=s.y,h[d++]=o.y,a[d]=s.z,h[d++]=o.z,a[d]=s.x,h[d++]=o.x,a[d]=s.y,h[d++]=o.y,a[d]=s.z,h[d++]=o.z}if(this._closedLine)_=m[0];else{var T=m.length-1;_=new v(m[T].x+m[T].x-m[T-1].x,m[T].y+m[T].y-m[T-1].y,m[T].z+m[T].z-m[T-1].z)}this.__doubleToTwoFloats(_,s,o),a[d]=s.x,h[d++]=o.x,a[d]=s.y,h[d++]=o.y,a[d]=s.z,h[d++]=o.z,a[d]=s.x,h[d++]=o.x,a[d]=s.y,h[d++]=o.y,a[d]=s.z,h[d++]=o.z,a[d]=s.x,h[d++]=o.x,a[d]=s.y,h[d++]=o.y,a[d]=s.z,h[d++]=o.z,a[d]=s.x,h[d++]=o.x,a[d]=s.y,h[d++]=o.y,a[d]=s.z,h[d++]=o.z}}_setEqualPathLonLat(t){var n=this._extent;n.southWest.set(180,90),n.northEast.set(-180,-90);var s=new v,o=new v,a=this._verticesHigh,h=this._verticesLow,c=this._pathLonLat,u=this._pathLonLatMerc,d=this._path3v,f=0,g=this._renderNode.ellipsoid;for(let T=0;T<t.length;T++){var _,m,p=t[T];if(this._closedLine)_=g.lonLatToCartesian(p[p.length-1]);else{let S=g.lonLatToCartesian(p[0]),C=g.lonLatToCartesian(p[1]);_=new v(S.x+S.x-C.x,S.y+S.y-C.y,S.z+S.z-C.z)}this.__doubleToTwoFloats(_,s,o),a[f]=s.x,h[f++]=o.x,a[f]=s.y,h[f++]=o.y,a[f]=s.z,h[f++]=o.z,a[f]=s.x,h[f++]=o.x,a[f]=s.y,h[f++]=o.y,a[f]=s.z,h[f++]=o.z,a[f]=s.x,h[f++]=o.x,a[f]=s.y,h[f++]=o.y,a[f]=s.z,h[f++]=o.z,a[f]=s.x,h[f++]=o.x,a[f]=s.y,h[f++]=o.y,a[f]=s.z,h[f++]=o.z;for(let S=0;S<p.length;S++){var x=p[S],y=g.lonLatToCartesian(x);d[T][S]=y,u[T][S]=x.forwardMercator(),c[T][S]=x,this.__doubleToTwoFloats(y,s,o),a[f]=s.x,h[f++]=o.x,a[f]=s.y,h[f++]=o.y,a[f]=s.z,h[f++]=o.z,a[f]=s.x,h[f++]=o.x,a[f]=s.y,h[f++]=o.y,a[f]=s.z,h[f++]=o.z,a[f]=s.x,h[f++]=o.x,a[f]=s.y,h[f++]=o.y,a[f]=s.z,h[f++]=o.z,a[f]=s.x,h[f++]=o.x,a[f]=s.y,h[f++]=o.y,a[f]=s.z,h[f++]=o.z,x.lon<n.southWest.lon&&(n.southWest.lon=x.lon),x.lat<n.southWest.lat&&(n.southWest.lat=x.lat),x.lon>n.northEast.lon&&(n.northEast.lon=x.lon),x.lat>n.northEast.lat&&(n.northEast.lat=x.lat)}if(this._closedLine)m=g.lonLatToCartesian(p[0]);else{let S=g.lonLatToCartesian(p[p.length-1]),C=g.lonLatToCartesian(p[p.length-2]);m=new v(S.x+S.x-C.x,S.y+S.y-C.y,S.z+S.z-C.z)}this.__doubleToTwoFloats(m,s,o),a[f]=s.x,h[f++]=o.x,a[f]=s.y,h[f++]=o.y,a[f]=s.z,h[f++]=o.z,a[f]=s.x,h[f++]=o.x,a[f]=s.y,h[f++]=o.y,a[f]=s.z,h[f++]=o.z,a[f]=s.x,h[f++]=o.x,a[f]=s.y,h[f++]=o.y,a[f]=s.z,h[f++]=o.z,a[f]=s.x,h[f++]=o.x,a[f]=s.y,h[f++]=o.y,a[f]=s.z,h[f++]=o.z}}setPointLonLat(t,n,s){if(this._renderNode&&this._renderNode.ellipsoid){let u=this._pathLonLat,d=this._pathLonLatMerc;u[s][n]=t,d[s][n]=t.forwardMercator();var o=this._extent;o.southWest.set(180,90),o.northEast.set(-180,-90);for(let f=0;f<u.length;f++){var a=u[f];for(let g=0;g<a.length;g++){var h=a[g].lon,c=a[g].lat;h>o.northEast.lon&&(o.northEast.lon=h),c>o.northEast.lat&&(o.northEast.lat=c),h<o.southWest.lon&&(o.southWest.lon=h),c<o.southWest.lat&&(o.southWest.lat=c)}}this.setPoint3v(this._renderNode.ellipsoid.lonLatToCartesian(t),n,s,!0)}else{let u=this._pathLonLat[s];u[n].lon=t.lon,u[n].lat=t.lat,u[n].height=t.height}}setPoint3v(t,n=0,s=0,o=!1){if(this._renderNode){var a,h=new v,c=new v,u=this._verticesHigh,d=this._verticesLow,f=this._pathLonLat,g=this._pathLonLatMerc,_=0;a=12*this._pathLengths[s]+24*s;let w=this._path3v[s];w[n].x=t.x,w[n].y=t.y,w[n].z=t.z;let I=this._closedLine||w.length===1;var m;if((n===0||n===1)&&(m=I?w[w.length-1]:new v(w[0].x+w[0].x-w[1].x,w[0].y+w[0].y-w[1].y,w[0].z+w[0].z-w[1].z),_=a,this.__doubleToTwoFloats(m,h,c),u[_]=h.x,u[_+1]=h.y,u[_+2]=h.z,u[_+3]=h.x,u[_+4]=h.y,u[_+5]=h.z,u[_+6]=h.x,u[_+7]=h.y,u[_+8]=h.z,u[_+9]=h.x,u[_+10]=h.y,u[_+11]=h.z,d[_]=c.x,d[_+1]=c.y,d[_+2]=c.z,d[_+3]=c.x,d[_+4]=c.y,d[_+5]=c.z,d[_+6]=c.x,d[_+7]=c.y,d[_+8]=c.z,d[_+9]=c.x,d[_+10]=c.y,d[_+11]=c.z),!o&&this._renderNode.ellipsoid){var p=this._renderNode.ellipsoid.cartesianToLonLat(t);f[s][n]=p,g[s][n]=p.forwardMercator();var x=this._extent;x.southWest.set(180,90),x.northEast.set(-180,-90);for(let O=0;O<f.length;O++){var y=f[O];for(let N=0;N<y.length;N++){var T=y[N].lon,S=y[N].lat;T>x.northEast.lon&&(x.northEast.lon=T),S>x.northEast.lat&&(x.northEast.lat=S),T<x.southWest.lon&&(x.southWest.lon=T),S<x.southWest.lat&&(x.southWest.lat=S)}}}if(_=a+12*n+12,this.__doubleToTwoFloats(t,h,c),u[_]=h.x,u[_+1]=h.y,u[_+2]=h.z,u[_+3]=h.x,u[_+4]=h.y,u[_+5]=h.z,u[_+6]=h.x,u[_+7]=h.y,u[_+8]=h.z,u[_+9]=h.x,u[_+10]=h.y,u[_+11]=h.z,d[_]=c.x,d[_+1]=c.y,d[_+2]=c.z,d[_+3]=c.x,d[_+4]=c.y,d[_+5]=c.z,d[_+6]=c.x,d[_+7]=c.y,d[_+8]=c.z,d[_+9]=c.x,d[_+10]=c.y,d[_+11]=c.z,n===w.length-1||n===w.length-2){var C;if(I)C=w[0];else{var P=w.length-1;C=new v(w[P].x+w[P].x-w[P-1].x,w[P].y+w[P].y-w[P-1].y,w[P].z+w[P].z-w[P-1].z)}_=a+12*w.length+12,this.__doubleToTwoFloats(C,h,c),u[_]=h.x,u[_+1]=h.y,u[_+2]=h.z,u[_+3]=h.x,u[_+4]=h.y,u[_+5]=h.z,u[_+6]=h.x,u[_+7]=h.y,u[_+8]=h.z,u[_+9]=h.x,u[_+10]=h.y,u[_+11]=h.z,d[_]=c.x,d[_+1]=c.y,d[_+2]=c.z,d[_+3]=c.x,d[_+4]=c.y,d[_+5]=c.z,d[_+6]=c.x,d[_+7]=c.y,d[_+8]=c.z,d[_+9]=c.x,d[_+10]=c.y,d[_+11]=c.z}this._changedBuffers[0]=!0}else{let w=this._path3v[s];w[n].x=t.x,w[n].y=t.y,w[n].z=t.z}}_resizePathLengths(t=0){this._pathLengths[0]=0;for(let n=t+1,s=this._path3v.length;n<=s;n++)this._pathLengths[n]=this._pathLengths[n-1]+this._path3v[n-1].length}removeSegment(t){this._path3v.splice(t,1),this.setPath3v([].concat(this._path3v))}removePoint(t,n=0){this._path3v[n].splice(t,1),this._path3v[n].length===0&&this._path3v.splice(n,1),this.setPath3v([].concat(this._path3v))}insertPoint3v(t,n=0,s,o=0){let a=[].concat(this._path3v),h=a[o];if(h){let c=[].concat(this._pathColors);if(h.splice(n,0,t),s){let u=c[o];u||(u=new Array(h.length)),u.splice(n,0,s)}this.setPath3v(a,c)}else this.addPoint3v(t,o)}appendPoint3v(t,n,s){this._path3v.length!==0&&this._renderNode?(this._verticesHigh=Ve(this._verticesHigh),this._verticesLow=Ve(this._verticesLow),this._colors=Ve(this._colors),this._orders=Ve(this._orders),this._indexes=Ve(this._indexes),this.__appendPoint3v(this._path3v,t,this._pathColors,n||this._defaultColor,this._closedLine,this._verticesHigh,this._verticesLow,this._colors,this._orders,this._indexes,s?null:this._renderNode.ellipsoid,this._pathLonLat,this._pathLonLatMerc,this._extent),this._pathLengths[this._path3v.length]+=1,this._changedBuffers[0]=!0,this._changedBuffers[2]=!0,this._changedBuffers[1]=!0):(this._pathColors.push([n||this._defaultColor]),this.addPoint3v(t))}addPoint3v(t,n=0){n>=this._path3v.length&&this._path3v.push([]),this._path3v[n].push(t),this.setPath3v([].concat(this._path3v))}addPointLonLat(t,n=0){n>=this._pathLonLat.length&&this._pathLonLat.push([]),this._pathLonLat[n].push(t),this.setPathLonLat([].concat(this._pathLonLat))}clear(){this._clearData()}setPointColor(t,n=0,s=0){if(this._renderNode&&n<this._path3v[s].length){let o=this._pathColors[s];if(!o){if(!(this._path3v[s]&&n<this._path3v[s].length))return;this._pathColors[s]=new Array(this._path3v[s].length)}o[n]?(o[n][0]=t[0],o[n][1]=t[1],o[n][2]=t[2],o[n][3]=t[3]||1):o[n]=[t[0],t[1],t[2],t[3]||1];let a=this._colors,h=16*n+16*this._pathLengths[s]+32*s;a[h]=a[h+4]=a[h+8]=a[h+12]=t[0],a[h+1]=a[h+5]=a[h+9]=a[h+13]=t[1],a[h+2]=a[h+6]=a[h+10]=a[h+14]=t[2],a[h+3]=a[h+7]=a[h+11]=a[h+15]=t[3]||1,this._changedBuffers[2]=!0}else this._pathColors[s][n]=t}setOpacity(t){this._opacity=t}getOpacity(){return this._opacity}setAltitude(t){this.altitude=t}setThickness(t){this.thickness=t}getThickness(){return this.thickness}setVisibility(t){this.visibility=t}getVisibility(){return this.visibility}setRenderNode(t){t&&(this._renderNode=t,this._pathLonLat.length?this._createDataLonLat([].concat(this._pathLonLat)):this._createData3v([].concat(this._path3v)),this._refresh(),t.renderer&&t.renderer.isInitialized()&&this._update())}_clearData(){this._verticesHigh=null,this._verticesLow=null,this._orders=null,this._indexes=null,this._colors=null,this._texCoordArr=null,this._verticesHigh=[],this._verticesLow=[],this._orders=[],this._indexes=[],this._colors=[],this._texCoordArr=[],this._path3v.length=0,this._pathLonLat.length=0,this._pathLonLatMerc.length=0,this._path3v=[],this._pathLonLat=[],this._pathLonLatMerc=[]}_createData3v(t){this._clearData(),this.__appendLineData3v(t,this._pathColors,this._defaultColor,this._closedLine,this._verticesHigh,this._verticesLow,this._orders,this._indexes,this._renderNode.ellipsoid,this._pathLonLat,this._path3v,this._pathLonLatMerc,this._extent,this._colors),this._resizePathLengths(0)}_createDataLonLat(t){this._clearData(),this.__appendLineDataLonLat(t,this._pathColors,this._defaultColor,this._closedLine,this._verticesHigh,this._verticesLow,this._orders,this._indexes,this._texCoordArr,this._renderNode.ellipsoid,this._path3v,this._pathLonLat,this._pathLonLatMerc,this._extent,this._colors),this._resizePathLengths(0)}remove(){this._entity=null,this._pathColors.length=0,this._pathColors=[],this._verticesHigh=null,this._verticesLow=null,this._orders=null,this._indexes=null,this._colors=null,this._texCoordArr=null,this._verticesHigh=[],this._verticesLow=[],this._orders=[],this._indexes=[],this._colors=[],this._texCoordArr=[],this._deleteBuffers(),this._handler&&this._handler.remove(this)}setPickingColor3v(t){this._pickingColor[0]=t.x/255,this._pickingColor[1]=t.y/255,this._pickingColor[2]=t.z/255}getExtent(){return this._extent.clone()}getPath3v(){return this._path3v}getPathLonLat(){return this._pathLonLat}getPathColors(){return this._pathColors}setPathColors(t){t&&(this._colors=[],this._pathColors=[].concat(t),wu.setPathColors(this._pathLonLat,t,this._defaultColor,this._colors),this._changedBuffers[2]=!0)}setColorHTML(t){this._defaultColor=ve(t);let n=he(t),s=this._pathColors;for(let a=0,h=s.length;a<h;a++){let c=s[a];for(let u=0,d=c.length;u<d;u++)c[u][0]=n.x,c[u][1]=n.y,c[u][2]=n.z,c[u][3]=n.w}let o=this._colors;for(let a=0,h=o.length;a<h;a+=4)o[a]=n.x,o[a+1]=n.y,o[a+2]=n.z,o[a+3]=n.w;this._changedBuffers[2]=!0}setPathLonLatFast(t,n){this.setPathLonLat(t,n,!0)}setPath3vFast(t,n){this.setPath3v(t,n,!0)}setPathLonLat(t,n,s=!1){n&&(this._pathColors=[].concat(n)),this._renderNode&&this._renderNode.ellipsoid?s?(this._setEqualPathLonLat(t),this._changedBuffers[0]=!0,this._changedBuffers[2]=!0):(this._createDataLonLat(t),this._changedBuffers[0]=!0,this._changedBuffers[1]=!0,this._changedBuffers[2]=!0):this._pathLonLat=[].concat(t)}getSize(t=0){return this._path3v[t].length}setPath3v(t,n,s=!1){n&&(this._pathColors=[].concat(n)),this._renderNode?s?(this._setEqualPath3v(t),this._changedBuffers[0]=!0,this._changedBuffers[2]=!0):(this._createData3v(t),this._changedBuffers[0]=!0,this._changedBuffers[1]=!0,this._changedBuffers[2]=!0):this._path3v=[].concat(t)}draw(){if(this.visibility&&this._path3v.length){this._update();let t=this._renderNode.renderer,n=t.handler.programs.polyline_screen,s=n._program,o=t.handler.gl,a=s.attributes,h=s.uniforms,c=this._handler._entityCollection;n.activate(),o.disable(o.CULL_FACE),o.uniform1f(h.depthOffset,c.polygonOffsetUnits),o.uniformMatrix4fv(h.proj,!1,t.activeCamera.getProjectionMatrix()),o.uniformMatrix4fv(h.view,!1,t.activeCamera.getViewMatrix()),o.uniform3fv(h.rtcEyePositionHigh,this._handler._rtcEyePositionHigh),o.uniform3fv(h.rtcEyePositionLow,this._handler._rtcEyePositionLow),o.uniform4fv(h.visibleSphere,this._visibleSphere),o.uniform2fv(h.viewport,[t.handler.canvas.width,t.handler.canvas.height]),o.uniform1f(h.thickness,.5*this.thickness),o.uniform1f(h.opacity,this._opacity*c._fadingOpacity),o.uniform1f(h.texOffset,this._texOffset),o.uniform1f(h.strokeSize,this._strokeSize),o.bindBuffer(o.ARRAY_BUFFER,this._colorsBuffer),o.vertexAttribPointer(a.color,this._colorsBuffer.itemSize,o.FLOAT,!1,0,0),o.bindBuffer(o.ARRAY_BUFFER,this._texCoordBuffer),o.vertexAttribPointer(a.texCoord,this._texCoordBuffer.itemSize,o.FLOAT,!1,0,0);let u=this._verticesHighBuffer;o.bindBuffer(o.ARRAY_BUFFER,u),o.vertexAttribPointer(a.prevHigh,u.itemSize,o.FLOAT,!1,12,0),o.vertexAttribPointer(a.currentHigh,u.itemSize,o.FLOAT,!1,12,48),o.vertexAttribPointer(a.nextHigh,u.itemSize,o.FLOAT,!1,12,96),u=this._verticesLowBuffer,o.bindBuffer(o.ARRAY_BUFFER,u),o.vertexAttribPointer(a.prevLow,u.itemSize,o.FLOAT,!1,12,0),o.vertexAttribPointer(a.currentLow,u.itemSize,o.FLOAT,!1,12,48),o.vertexAttribPointer(a.nextLow,u.itemSize,o.FLOAT,!1,12,96),o.bindBuffer(o.ARRAY_BUFFER,this._ordersBuffer),o.vertexAttribPointer(a.order,this._ordersBuffer.itemSize,o.FLOAT,!1,4,0),o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,this._indexesBuffer),o.drawElements(o.TRIANGLE_STRIP,this._indexesBuffer.numItems,o.UNSIGNED_INT,0),o.enable(o.CULL_FACE)}}drawPicking(){if(this.visibility&&this._path3v.length){let t=this._renderNode.renderer,n=t.handler.programs.polyline_picking,s=n._program,o=t.handler.gl,a=s.attributes,h=s.uniforms,c=this._handler._entityCollection;n.activate(),o.disable(o.CULL_FACE),o.uniform1f(h.depthOffset,c.polygonOffsetUnits),o.uniformMatrix4fv(h.proj,!1,t.activeCamera.getProjectionMatrix()),o.uniformMatrix4fv(h.view,!1,t.activeCamera.getViewMatrix()),o.uniform4fv(h.color,[this._pickingColor[0],this._pickingColor[1],this._pickingColor[2],1]),o.uniform3fv(h.rtcEyePositionHigh,this._handler._rtcEyePositionHigh),o.uniform3fv(h.rtcEyePositionLow,this._handler._rtcEyePositionLow),o.uniform4fv(h.visibleSphere,this._visibleSphere),o.uniform2fv(h.viewport,[t.handler.canvas.width,t.handler.canvas.height]),o.uniform1f(h.thickness,.5*this.thickness*c.pickingScale[0]);let u=this._verticesHighBuffer;o.bindBuffer(o.ARRAY_BUFFER,u),o.vertexAttribPointer(a.prevHigh,u.itemSize,o.FLOAT,!1,12,0),o.vertexAttribPointer(a.currentHigh,u.itemSize,o.FLOAT,!1,12,48),o.vertexAttribPointer(a.nextHigh,u.itemSize,o.FLOAT,!1,12,96),u=this._verticesLowBuffer,o.bindBuffer(o.ARRAY_BUFFER,u),o.vertexAttribPointer(a.prevLow,u.itemSize,o.FLOAT,!1,12,0),o.vertexAttribPointer(a.currentLow,u.itemSize,o.FLOAT,!1,12,48),o.vertexAttribPointer(a.nextLow,u.itemSize,o.FLOAT,!1,12,96),o.bindBuffer(o.ARRAY_BUFFER,this._ordersBuffer),o.vertexAttribPointer(a.order,this._ordersBuffer.itemSize,o.FLOAT,!1,4,0),o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,this._indexesBuffer),o.drawElements(o.TRIANGLE_STRIP,this._indexesBuffer.numItems,o.UNSIGNED_INT,0),o.enable(o.CULL_FACE)}}_refresh(){let t=this._changedBuffers.length;for(;t--;)this._changedBuffers[t]=!0}_update(){if(this._renderNode){let t=this._changedBuffers.length;for(;t--;)this._changedBuffers[t]&&(this._buffersUpdateCallbacks[t].call(this),this._changedBuffers[t]=!1)}}_deleteBuffers(){if(this._renderNode){let t=this._renderNode.renderer.handler.gl;t.deleteBuffer(this._verticesHighBuffer),t.deleteBuffer(this._verticesLowBuffer),t.deleteBuffer(this._ordersBuffer),t.deleteBuffer(this._indexesBuffer),t.deleteBuffer(this._colorsBuffer),t.deleteBuffer(this._texCoordBuffer),this._verticesHighBuffer=null,this._verticesLowBuffer=null,this._ordersBuffer=null,this._indexesBuffer=null,this._colorsBuffer=null,this._texCoordBuffer=null}}_createVerticesBuffer(){let t=this._renderNode.renderer.handler,n=this._verticesHigh.length/3;this._verticesHighBuffer&&this._verticesHighBuffer.numItems===n||(t.gl.deleteBuffer(this._verticesHighBuffer),t.gl.deleteBuffer(this._verticesLowBuffer),this._verticesHighBuffer=t.createStreamArrayBuffer(3,n),this._verticesLowBuffer=t.createStreamArrayBuffer(3,n)),this._verticesHigh=st(this._verticesHigh),this._verticesLow=st(this._verticesLow),t.setStreamArrayBuffer(this._verticesHighBuffer,this._verticesHigh),t.setStreamArrayBuffer(this._verticesLowBuffer,this._verticesLow)}_createIndexBuffer(){let t=this._renderNode.renderer.handler;t.gl.deleteBuffer(this._ordersBuffer),t.gl.deleteBuffer(this._indexesBuffer),this._orders=st(this._orders),this._ordersBuffer=t.createArrayBuffer(this._orders,1,this._orders.length/2),this._indexes=st(this._indexes,Uint32Array),this._indexesBuffer=t.createElementArrayBuffer(this._indexes,1,this._indexes.length)}_createColorsBuffer(){let t=this._renderNode.renderer.handler;t.gl.deleteBuffer(this._colorsBuffer),this._colors=st(this._colors),this._colorsBuffer=t.createArrayBuffer(this._colors,4,this._colors.length/4)}_createTexCoordBuffer(){let t=this._renderNode.renderer.handler;t.gl.deleteBuffer(this._texCoordBuffer),this._texCoordArr=st(this._texCoordArr),this._texCoordBuffer=t.createArrayBuffer(this._texCoordArr,4,this._texCoordArr.length/4)}setVisibleSphere(t,n){this._handler&&(this._visibleSphere[0]=t.x-this._handler._relativeCenter.x,this._visibleSphere[1]=t.y-this._handler._relativeCenter.y,this._visibleSphere[2]=t.z-this._handler._relativeCenter.z),this._visibleSphere[3]=n}updateRTCPosition(){this._handler&&this._renderNode&&(this._visibleSphere[0]=this._visibleSphere[0]-this._handler._relativeCenter.x,this._visibleSphere[1]=this._visibleSphere[1]-this._handler._relativeCenter.y,this._visibleSphere[2]=this._visibleSphere[2]-this._handler._relativeCenter.z,this._setEqualPath3v(this._path3v)),this._changedBuffers[0]=!0}};qe.__counter__=0;let br=qe;const ms=class id{constructor(t={}){this.__id=id.__counter__++,this._thickness=t.thickness||2,this._startPosition=Yt(t.startPosition),this._startPositionHigh=new v,this._startPositionLow=new v,v.doubleToTwoFloats(this._startPosition,this._startPositionHigh,this._startPositionLow),this._endPosition=Yt(t.endPosition),this._endPositionHigh=new v,this._endPositionLow=new v,v.doubleToTwoFloats(this._endPosition,this._endPositionHigh,this._endPositionLow),this._startColor=le(t.startColor),this._endColor=le(t.endColor),this._visibility=t.visibility==null||t.visibility,this._entity=null,this._handler=null,this._handlerIndex=-1,this._image=t.image||null,this._src=t.src||null,this._texOffset=t.texOffset||0,this._strokeSize=t.strokeSize!=null?t.strokeSize:32}setStartPosition(t,n,s){this._startPosition.x=t,this._startPosition.y=n,this._startPosition.z=s,v.doubleToTwoFloats(this._startPosition,this._startPositionHigh,this._startPositionLow),this._handler&&this._handler.setStartPositionArr(this._handlerIndex,this._startPositionHigh,this._startPositionLow)}getLength(){return this._startPosition.distance(this._endPosition)}setSrc(t){this._src=t;let n=this._handler;if(n){let s=n._entityCollection.renderNode;if(s&&s.renderer){let o=s.renderer.strokeTextureAtlas;t&&t.length?o.loadImage(t,a=>{if(a.__nodeIndex!=null&&o.get(a.__nodeIndex)){this._image=a;let h=o.get(a.__nodeIndex);n.setTexCoordArr(this._handlerIndex,h.texCoords)}else o.addImage(a),o.createTexture(),this._image=a,s.updateStrokeTexCoords()}):(n.setTextureDisabled(this._handlerIndex),s.updateStrokeTexCoords())}}}getSrc(){return this._src}setImage(t){this.setSrc(t.src)}getImage(){return this._image}setStartPosition3v(t){this._startPosition.x=t.x,this._startPosition.y=t.y,this._startPosition.z=t.z,v.doubleToTwoFloats(this._startPosition,this._startPositionHigh,this._startPositionLow),this._handler&&this._handler.setStartPositionArr(this._handlerIndex,this._startPositionHigh,this._startPositionLow)}setEndPosition(t,n,s){this._endPosition.x=t,this._endPosition.y=n,this._endPosition.z=s,v.doubleToTwoFloats(this._endPosition,this._endPositionHigh,this._endPositionLow),this._handler&&this._handler.setEndPositionArr(this._handlerIndex,this._endPositionHigh,this._endPositionLow)}setEndPosition3v(t){this._endPosition.x=t.x,this._endPosition.y=t.y,this._endPosition.z=t.z,v.doubleToTwoFloats(this._endPosition,this._endPositionHigh,this._endPositionLow),this._handler&&this._handler.setEndPositionArr(this._handlerIndex,this._endPositionHigh,this._endPositionLow)}setThickness(t){this._thickness=t,this._handler&&this._handler.setThicknessArr(this._handlerIndex,t)}setColors4v(t,n){t&&(this._startColor.x=t.x,this._startColor.y=t.y,this._startColor.z=t.z,this._startColor.w=t.w),n&&(this._endColor.x=n.x,this._endColor.y=n.y,this._endColor.z=n.z,this._endColor.w=n.w),this._handler&&this._handler.setRgbaArr(this._handlerIndex,this._startColor,this._endColor)}setColorsHTML(t,n){t&&(this._startColor=he(t)),n&&(this._endColor=he(n)),this._handler&&this._handler.setRgbaArr(this._handlerIndex,this._startColor,this._endColor)}get texOffset(){return this._texOffset}set texOffset(t){this._texOffset=t,this._handler&&this._handler.setTexOffsetArr(this._handlerIndex,t)}get strokeSize(){return this._strokeSize}set strokeSize(t){this._strokeSize=t,this._handler&&this._handler.setStrokeSizeArr(this._handlerIndex,t)}getStartPosition(){return this._startPosition}getEndPosition(){return this._endPosition}setVisibility(t){this._visibility=t,this._handler&&this._handler.setVisibility(this._handlerIndex,t)}getVisibility(){return this._visibility}remove(){this._entity=null,this._handler&&this._handler.remove(this)}setPickingColor3v(t){this._handler&&this._handler.setPickingColorArr(this._handlerIndex,t)}};ms.__counter__=0;let wr=ms,ft=new v,gt=new v;const vs=class rd{constructor(t={}){if(this.__id=rd.__counter__++,this.visibility=t.visibility==null||t.visibility,this.color=new Float32Array([1,1,1,.5]),t.color){let n=le(t.color);this.setColor(n.x,n.y,n.z,n.w)}t.opacity&&this.setOpacity(t.opacity),this._renderNode=null,this._entity=null,this._verticesHighBuffer=null,this._verticesLowBuffer=null,this._indexBuffer=null,this._verticesHigh=[],this._verticesLow=[],this._indexes=[],this._path=[],this._pickingColor=new Float32Array(4),this._gridSize=1,this._handler=null,this._handlerIndex=-1,t.path&&this.setPath(t.path)}setPickingColor3v(t){this._pickingColor[0]=t.x/255,this._pickingColor[1]=t.y/255,this._pickingColor[2]=t.z/255,this._pickingColor[3]=1}clear(){this._path.length=0,this._path=[],this._verticesHigh.length=0,this._verticesHigh=[],this._verticesLow.length=0,this._verticesLow=[],this._indexes.length=0,this._indexes=[],this._deleteBuffers()}setColor4v(t){this.setColor(t.x,t.y,t.z,t.w)}setColorHTML(t){this.setColor4v(he(t))}setColor(t,n,s,o){o=o||this.color[3],this.color[0]=t,this.color[1]=n,this.color[2]=s,this.color[3]=o}setOpacity(t){this.color[3]=t||0}setVisibility(t){this.visibility=t}getVisibility(){return this.visibility}setRenderNode(t){this._renderNode=t,this._createBuffers()}remove(){this._entity=null,this._handler&&this._handler.remove(this)}draw(){if(this.visibility&&this._verticesHigh.length){let t=this._renderNode.renderer,n=t.handler.gl,s=t.handler.programs.strip,o=s._program,a=o.attributes,h=o.uniforms;s.activate(),n.disable(n.CULL_FACE),n.uniformMatrix4fv(h.viewMatrix,!1,t.activeCamera.getViewMatrix()),n.uniformMatrix4fv(h.projectionMatrix,!1,t.activeCamera.getProjectionMatrix()),n.uniform3fv(h.eyePositionHigh,t.activeCamera.eyeHigh),n.uniform3fv(h.eyePositionLow,t.activeCamera.eyeLow),n.uniform4fv(h.uColor,this.color),n.uniform1f(h.uOpacity,this._entity._entityCollection._fadingOpacity),n.bindBuffer(n.ARRAY_BUFFER,this._verticesHighBuffer),n.vertexAttribPointer(a.aVertexPositionHigh,this._verticesHighBuffer.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,this._verticesLowBuffer),n.vertexAttribPointer(a.aVertexPositionLow,this._verticesLowBuffer.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,this._indexBuffer),n.drawElements(t.handler.gl.TRIANGLE_STRIP,this._indexBuffer.numItems,n.UNSIGNED_INT,0),n.enable(n.CULL_FACE)}}drawPicking(){if(this.visibility&&this._verticesHigh.length){let t=this._renderNode.renderer,n=t.handler.gl,s=t.handler.programs.strip,o=s._program,a=o.attributes,h=o.uniforms;s.activate(),n.disable(n.CULL_FACE),n.uniformMatrix4fv(h.viewMatrix,!1,t.activeCamera.getViewMatrix()),n.uniformMatrix4fv(h.projectionMatrix,!1,t.activeCamera.getProjectionMatrix()),n.uniform3fv(h.eyePositionHigh,t.activeCamera.eyeHigh),n.uniform3fv(h.eyePositionLow,t.activeCamera.eyeLow),n.uniform1f(h.uOpacity,this._entity._entityCollection._fadingOpacity!=0?1:0),n.uniform4fv(h.uColor,this._pickingColor),n.bindBuffer(n.ARRAY_BUFFER,this._verticesHighBuffer),n.vertexAttribPointer(a.aVertexPositionHigh,this._verticesHighBuffer.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,this._verticesLowBuffer),n.vertexAttribPointer(a.aVertexPositionLow,this._verticesLowBuffer.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,this._indexBuffer),n.drawElements(t.handler.gl.TRIANGLE_STRIP,this._indexBuffer.numItems,n.UNSIGNED_INT,0),n.enable(n.CULL_FACE)}}_deleteBuffers(){if(this._renderNode&&this._renderNode.renderer){let t=this._renderNode.renderer.handler.gl;t.deleteBuffer(this._indexBuffer),t.deleteBuffer(this._verticesHighBuffer),t.deleteBuffer(this._verticesLowBuffer)}this._verticesHighBuffer=null,this._verticesLowBuffer=null,this._indexBuffer=null}_createBuffers(){if(this._renderNode&&this._renderNode.renderer&&this._renderNode.renderer.isInitialized()){let t=this._renderNode.renderer.handler.gl;t.deleteBuffer(this._indexBuffer),t.deleteBuffer(this._verticesHighBuffer),t.deleteBuffer(this._verticesLowBuffer),this._verticesHighBuffer=this._renderNode.renderer.handler.createArrayBuffer(new Float32Array(this._verticesHigh),3,this._verticesHigh.length/3),this._verticesLowBuffer=this._renderNode.renderer.handler.createArrayBuffer(new Float32Array(this._verticesLow),3,this._verticesLow.length/3),this._indexBuffer=this._renderNode.renderer.handler.createElementArrayBuffer(new Uint32Array(this._indexes),1,this._indexes.length)}}addEdge3v(t,n){let s=this._path.length;if(s===0)this._path.push([t.clone(),n.clone()]);else{let o=this._path[s-1][0],a=this._path[s-1][1];this._path.push([t.clone(),n.clone()]);let h=this._verticesHigh,c=this._verticesLow,u=this._gridSize,d=u+1,f=new v,g=this._verticesHigh.length/3,_=g,m=Math.abs(o.sub(a).normal().dot(t.sub(o).normal()));for(let p=0;p<d;p++){let x=p/u,y=o.lerp(t,x),T=a.lerp(n,x);for(let S=0;S<d;S++){let C=S/u,P=o.lerp(a,C),w=t.lerp(n,C);m!==1?new Jt(y,T).intersects(new Jt(P,w),f):f=w,_=g+p*d+S,v.doubleToTwoFloats(f,ft,gt);let I=3*_;h[I]=ft.x,h[I+1]=ft.y,h[I+2]=ft.z,c[I]=gt.x,c[I+1]=gt.y,c[I+2]=gt.z,p<u&&this._indexes.push(_,_+d)}p<u&&this._indexes.push(_+d,_+1)}this._createBuffers()}}setEdge3v(t,n,s){if(s!==this._path.length)if(this._path[s]){if(this._path[s][0]=t,this._path[s][1]=n,this._path.length>1){let o=this._gridSize,a=o+1,h=a*a,c=new v,u=this._verticesHigh,d=this._verticesLow;if(s===this._path.length-1){let f=this._path[s-1][0],g=this._path[s-1][1],_=this._verticesHigh.length/3-h,m=_,p=Math.abs(f.sub(g).normal().dot(t.sub(f).normal()));for(let x=0;x<a;x++){let y=x/o,T=f.lerp(t,y),S=g.lerp(n,y);for(let C=0;C<a;C++){let P=C/o,w=f.lerp(g,P),I=t.lerp(n,P);p!==1?new Jt(T,S).intersects(new Jt(w,I),c):c=I,m=_+x*a+C,v.doubleToTwoFloats(c,ft,gt);let O=3*m;u[O]=ft.x,u[O+1]=ft.y,u[O+2]=ft.z,d[O]=gt.x,d[O+1]=gt.y,d[O+2]=gt.z}}}else if(s===0){let f=0,g=t,_=n;t=this._path[1][0],n=this._path[1][1];for(let m=0;m<a;m++){let p=m/o,x=g.lerp(t,p),y=_.lerp(n,p);for(let T=0;T<a;T++){let S=T/o,C=g.lerp(_,S),P=t.lerp(n,S);new Jt(x,y).intersects(new Jt(C,P),c),f=m*a+T,v.doubleToTwoFloats(c,ft,gt);let w=3*f;u[w]=ft.x,u[w+1]=ft.y,u[w+2]=ft.z,d[w]=gt.x,d[w+1]=gt.y,d[w+2]=gt.z}}}else if(s>0&&s<this._path.length){let f=this._path[s-1][0],g=this._path[s-1][1],_=this._path[s+1][0],m=this._path[s+1][1],p=s*h,x=(s-1)*h,y=x;for(let T=0;T<a;T++){let S=T/o,C=f.lerp(t,S),P=n.lerp(m,S),w=t.lerp(_,S),I=g.lerp(n,S);for(let O=0;O<a;O++){let N=O/o,k=f.lerp(g,N),D=t.lerp(n,N);new Jt(C,I).intersects(new Jt(k,D),c);let ze=T*a+O;y=x+ze,v.doubleToTwoFloats(c,ft,gt);let z=3*y;u[z]=ft.x,u[z+1]=ft.y,u[z+2]=ft.z,d[z]=gt.x,d[z+1]=gt.y,d[z+2]=gt.z;let Ee=_.lerp(m,N);D=t.lerp(n,N),new Jt(w,P).intersects(new Jt(D,Ee),c),y=p+ze,v.doubleToTwoFloats(c,ft,gt),z=3*y,u[z]=ft.x,u[z+1]=ft.y,u[z+2]=ft.z,d[z]=gt.x,d[z+1]=gt.y,d[z+2]=gt.z}}}this._createBuffers()}}else console.warn(`strip index ${s} is out of range`);else this.addEdge3v(t,n)}removeEdge(t){this._path.splice(t,1),this.setPath([].concat(this._path))}setGridSize(t){this._gridSize=t,this.setPath([].concat(this._path))}getPath(){return this._path}setPath(t){this._verticesHigh=[],this._verticesLow=[],this._indexes=[],this._path=[];for(let n=0;n<t.length;n++){let s=t[n][0],o=t[n][1];s instanceof Array&&(s=new v(s[0],s[1],s[2])),o instanceof Array&&(o=new v(o[0],o[1],o[2])),this.addEdge3v(s,o)}}insertEdge3v(t,n,s){if(s<this._path.length){let o=[].concat(this._path);o.splice(s,0,[t,n]),this.setPath(o)}else s===this._path.length&&this.addEdge3v(t,n)}};vs.__counter__=0;let Tr=vs;const ys=class nd{constructor(t={}){t.properties=t.properties||{},this.__id=nd.__counter__++,this._name=t.name||`entity:${this.__id}`,this.properties=t.properties||{},this.childEntities=[],this.parent=null,this.forceGlobalPosition=t.forceGlobalPosition||!1,this.forceGlobalRotation=t.forceGlobalRotation||!1,this.forceGlobalScale=t.forceGlobalScale||!1,this._cartesian=Yt(t.cartesian),this._rootCartesian=new v,this._localPosition=Yt(t.localPosition),this._absoluteLocalPosition=new v,this._lonLat=vi(t.lonlat),this._lonLatMerc=new L,this._altitude=t.altitude||0,this._visibility=t.visibility==null||t.visibility,this._entityCollection=null,this._entityCollectionIndex=-1,this._layer=null,this._layerIndex=-1,this._pickingColor=new v(0,0,0),this._independentPicking=t.independentPicking||!1,this._relativePosition=t.relativePosition||!1,this._pitchRad=t.pitch||0,this._yawRad=t.yaw||0,this._rollRad=t.roll||0,this._scale=Yt(t.scale,new v(1,1,1)),this._absoluteScale=new v,this._qFrame=F.IDENTITY,this._qRot=F.IDENTITY,this._absoluteQRot=F.IDENTITY,this._useDirectQuaternion=!1,this._featureConstructorArray={billboard:[Qa,this.setBillboard],label:[el,this.setLabel],polyline:[br,this.setPolyline],pointCloud:[xr,this.setPointCloud],geometry:[vr,this.setGeometry],geoObject:[yr,this.setGeoObject],strip:[Tr,this.setStrip],ray:[wr,this.setRay]},this.billboard=this._createOptionFeature("billboard",t.billboard),this.label=this._createOptionFeature("label",t.label),this.polyline=this._createOptionFeature("polyline",t.polyline),this.ray=this._createOptionFeature("ray",t.ray),this.pointCloud=this._createOptionFeature("pointCloud",t.pointCloud),this.geometry=this._createOptionFeature("geometry",t.geometry),this.geoObject=this._createOptionFeature("geoObject",t.geoObject),this.strip=this._createOptionFeature("strip",t.strip)}get name(){return this._name}set name(t){t!==this._name&&(this._name=t)}get isEmpty(){return!(this.strip||this.polyline||this.ray||this.geoObject||this.geometry||this.billboard||this.label||this.pointCloud)}get rootEntity(){let t=this;for(;t;){if(!t.parent)return t;t=t.parent}return this}set relativePosition(t){if(t!==this._relativePosition){let n=this.getAbsoluteCartesian(),s=this.getAbsolutePitch(),o=this.getAbsoluteYaw(),a=this.getAbsoluteRoll();this._relativePosition=t,this.parent&&this._rootCartesian.copy(this.parent._rootCartesian),t?this.parent&&(this.setAbsoluteCartesian3v(n),this.setAbsolutePitch(s),this.setAbsoluteYaw(o),this.setAbsoluteRoll(a)):(this.setCartesian3v(n),this.setPitch(s),this.setYaw(o),this.setRoll(a))}}get relativePosition(){return this._relativePosition}get entityCollection(){return this._entityCollection}get id(){return this.__id}isEqual(t){return this.__id===t.__id}get layerIndex(){return this._layerIndex}get instanceName(){return"Entity"}_createOptionFeature(t,n){if(n){let s=this._featureConstructorArray[t];return s[1].call(this,new s[0](n))}return null}getCollectionIndex(){return this._entityCollectionIndex}addTo(t){return t.add(this),this}remove(){return this._layer&&this._layer.removeEntity(this),this._entityCollection&&this._entityCollection.removeEntity(this),this}setVisibility(t){this._visibility=t,this.billboard&&this.billboard.setVisibility(t),this.geoObject&&this.geoObject.setVisibility(t),this.label&&this.label.setVisibility(t),this.polyline&&this.polyline.setVisibility(t),this.ray&&this.ray.setVisibility(t),this.geometry&&this.geometry.setVisibility(t);for(let n=0;n<this.childEntities.length;n++)this.childEntities[n].setVisibility(t)}getVisibility(){return this._visibility}setCartesian3v(t){this.setCartesian(t.x,t.y,t.z)}getScale(){return this._scale}setScale3v(t){this._scale.copy(t),this._updateAbsolutePosition();for(let n=0;n<this.childEntities.length;n++){let s=this.childEntities[n];s.forceGlobalScale?s.setScale3v(this._scale):s.setScale3v(this.childEntities[n].getScale())}}setScale(t){this.setScale3v(new v(t,t,t))}getAbsoluteRotation(){return this._absoluteQRot.clone()}getRotation(){return this._qRot}setLook3v(t){let n,s=new F,o=this.getAbsoluteCartesian();if(this._entityCollection){let a=this._entityCollection.renderNode.ellipsoid.getSurfaceNormal3v(o);n=s.setLookRotation(t.sub(o),a).conjugate()}else n=s.setLookRotation(t.sub(o),v.UP).conjugate();this.setAbsoluteRotation(n)}setLookLonLat(t){if(this._entityCollection){let n=this._entityCollection.renderNode.ellipsoid.lonLatToCartesian(t);this.setLook3v(n)}}setAbsoluteRotation(t){this._absoluteQRot.copy(t),this._updatePitchYawRoll()}setRotation(t){this._useDirectQuaternion=!1,this._pitchRad=t.getPitch(),this._yawRad=t.getYaw(),this._rollRad=t.getRoll(),this._updateAbsolutePosition()}setDirectQuaternionRotation(t){this._qRot.copy(t),this._useDirectQuaternion=!0,this._pitchRad=this._qRot.getPitch(),this._yawRad=this._qRot.getYaw(),this._rollRad=this._qRot.getRoll(),this._updateAbsolutePosition()}setPitch(t){this._useDirectQuaternion=!1,this._pitchRad=t,this._updateAbsolutePosition()}setYaw(t){this._useDirectQuaternion=!1,this._yawRad=t,this._updateAbsolutePosition()}setRoll(t){this._useDirectQuaternion=!1,this._rollRad=t,this._updateAbsolutePosition()}getPitch(){return this._pitchRad}getYaw(){return this._yawRad}getRoll(){return this._rollRad}setAbsolutePitch(t){this._relativePosition?(this._absoluteQRot.setPitchYawRoll(t,this.getAbsoluteYaw(),this.getAbsoluteRoll(),this._qFrame),this._updatePitchYawRoll()):this.setPitch(t)}setAbsoluteYaw(t){this._relativePosition?(this._absoluteQRot.setPitchYawRoll(this.getAbsolutePitch(),t,this.getAbsoluteRoll(),this._qFrame),this._updatePitchYawRoll()):this.setYaw(t)}setAbsoluteRoll(t){this._relativePosition?(this._absoluteQRot.setPitchYawRoll(this.getAbsolutePitch(),this.getAbsoluteYaw(),t,this._qFrame),this._updatePitchYawRoll()):this.setRoll(t)}getAbsolutePitch(){return this.parent&&this._relativePosition?this._qFrame.conjugate().inverse().mul(this._absoluteQRot).getPitch():this._pitchRad}getAbsoluteYaw(){return this.parent&&this._relativePosition?this._qFrame.conjugate().inverse().mul(this._absoluteQRot).getYaw():this._yawRad}getAbsoluteRoll(){return this.parent&&this._relativePosition?this._qFrame.conjugate().inverse().mul(this._absoluteQRot).getRoll():this._rollRad}_getScaleByDistance(){let t=1;if(this._entityCollection){let n=this._entityCollection.scaleByDistance,s=1;this._entityCollection.renderNode&&this._entityCollection.renderNode.renderer&&(s=this._entityCollection.renderNode.renderer.activeCamera.eye.distance(this._rootCartesian)),t=n[2]*Zi(s,n[0],n[1])/n[0]}return t}setAbsoluteCartesian(t,n,s){this.setAbsoluteCartesian3v(new v(t,n,s))}setAbsoluteCartesian3v(t){let n=t;if(this.parent&&this._relativePosition){let s=this._getScaleByDistance();n=t.sub(this.parent.getAbsoluteCartesian()).scale(1/s).divA(this.parent._absoluteScale),n=this.parent._absoluteQRot.conjugate().mulVec3(n)}this.setCartesian3v(n)}getAbsoluteCartesian(){if(this.parent&&this._relativePosition){let t=this._getScaleByDistance();return this._rootCartesian.add(this._absoluteLocalPosition.scaleTo(t))}return this._cartesian.clone()}setCartesian(t,n,s){this._cartesian.set(t,n,s),this._updateAbsolutePosition();for(let o=0;o<this.childEntities.length;o++){let a=this.childEntities[o];a._relativePosition?a.setCartesian3v(a.getCartesian()):a.forceGlobalPosition&&a.setCartesian(t,n,s)}this._updateLonLat()}_updatePitchYawRoll(){if(this.parent){this._qRot=this.parent._absoluteQRot.conjugate().mul(this._absoluteQRot),this._pitchRad=this._qRot.getPitch(),this._yawRad=this._qRot.getYaw(),this._rollRad=this._qRot.getRoll(),this.geoObject&&this.geoObject.setRotation(this._absoluteQRot);for(let t=0;t<this.childEntities.length;t++)this.childEntities[t]._updateAbsolutePosition()}}_updateAbsolutePosition(){let t=this.parent;if(t&&this._relativePosition){this._scale.mulRes(t._absoluteScale,this._absoluteScale),this._qFrame.copy(t._qFrame),this._rootCartesian.copy(t._rootCartesian),this._useDirectQuaternion||(t&&this.forceGlobalRotation?this._qRot.setPitchYawRoll(t._pitchRad,t._yawRad,t._rollRad):this._qRot.setPitchYawRoll(this._pitchRad,this._yawRad,this._rollRad)),t._absoluteQRot.mulRes(this._qRot,this._absoluteQRot);let n=t._absoluteQRot.mulVec3(this._cartesian.add(this._localPosition)).mulA(t._absoluteScale);t._absoluteLocalPosition.addRes(n,this._absoluteLocalPosition)}else this._qFrame=F.IDENTITY,this._entityCollection&&this._entityCollection.renderNode&&(this._qFrame=this._entityCollection.renderNode.getFrameRotation(this._cartesian)),this._useDirectQuaternion?this._qFrame.isEqual(F.IDENTITY)||(this._qRot=this._qRot.mul(this._qFrame)):t&&this.forceGlobalRotation?this._qRot.setPitchYawRoll(t._pitchRad,t._yawRad,t._rollRad,this._qFrame):this._qRot.setPitchYawRoll(this._pitchRad,this._yawRad,this._rollRad,this._qFrame),this._absoluteScale.copy(this._scale),this._absoluteQRot.copy(this._qRot),this._rootCartesian.copy(this._cartesian),this._absoluteLocalPosition.copy(this._localPosition);this.geoObject&&(this.geoObject.setScale3v(this._absoluteScale),this.geoObject.setRotation(this._absoluteQRot),this.geoObject.setPosition3v(this._rootCartesian),this.geoObject.setLocalPosition3v(this._absoluteLocalPosition)),this.billboard&&this.billboard.setPosition3v(this._rootCartesian),this.label&&this.label.setPosition3v(this._rootCartesian);for(let n=0,s=this.childEntities.length;n<s;n++)this.childEntities[n]._updateAbsolutePosition();this._updateLonLat()}_setCartesian3vSilent(t,n=!1){this._cartesian.copy(t),this._updateAbsolutePosition();for(let s=0;s<this.childEntities.length;s++)this.childEntities[s].setCartesian(this._cartesian.x,this._cartesian.y,this._cartesian.z);n||this._updateLonLat()}_updateLonLat(){let t=this._entityCollection;t&&t.renderNode&&t.renderNode.ellipsoid&&(this._lonLat=t.renderNode.ellipsoid.cartesianToLonLat(this.getAbsoluteCartesian()),Math.abs(this._lonLat.lat)<ct?this._lonLatMerc=this._lonLat.forwardMercator():this._lonLatMerc.lon=this._lonLatMerc.lat=0)}getLonLat(){return this._lonLat.clone()}setLonLat(t){let n=this._lonLat;n.lon=t.lon,n.lat=t.lat,n.height=t.height;let s=this._entityCollection;if(s&&s.renderNode&&s.renderNode.ellipsoid){Math.abs(n.lat)<ct&&(this._lonLatMerc=n.forwardMercator());let o=new v;s.renderNode.ellipsoid.lonLatToCartesianRes(n,o),this.setAbsoluteCartesian3v(o)}}setLonLat2(t,n,s){let o=this._lonLat;o.lon=t,o.lat=n,o.height=s??o.height;let a=this._entityCollection;if(a&&a.renderNode&&a.renderNode.ellipsoid){Math.abs(o.lat)<ct?this._lonLatMerc=o.forwardMercator():this._lonLatMerc.lon=this._lonLatMerc.lat=this._lonLatMerc.height=0;let h=new v;a.renderNode.ellipsoid.lonLatToCartesianRes(o,h),this.setAbsoluteCartesian3v(h)}}setAltitude(t){this._altitude=t}getAltitude(){return this._altitude}getCartesian(){return this._cartesian.clone()}setBillboard(t){return this.billboard&&this.billboard.remove(),this.billboard=t,this.billboard._entity=this,this.billboard.setPosition3v(this._cartesian),this.billboard.setVisibility(this._visibility),this._entityCollection&&this._entityCollection.billboardHandler.add(t),t}setLabel(t){return this.label&&this.label.remove(),this.label=t,this.label._entity=this,this.label.setPosition3v(this._cartesian),this.label.setVisibility(this._visibility),this._entityCollection&&this._entityCollection.labelHandler.add(t),t}setRay(t){return this.ray&&this.ray.remove(),this.ray=t,this.ray._entity=this,this.ray.setVisibility(this._visibility),this._entityCollection&&this._entityCollection.rayHandler.add(t),t}setPolyline(t){return this.polyline&&this.polyline.remove(),this.polyline=t,this.polyline._entity=this,this.polyline.setVisibility(this._visibility),this._entityCollection&&this._entityCollection.polylineHandler.add(t),t}setPointCloud(t){return this.pointCloud&&this.pointCloud.remove(),this.pointCloud=t,this.pointCloud._entity=this,this.pointCloud.setVisibility(this._visibility),this._entityCollection&&this._entityCollection.pointCloudHandler.add(t),t}setGeometry(t){this.geometry&&this.geometry.remove(),this.geometry=t,this.geometry._entity=this,this.geometry.setVisibility(this._visibility);let n=this._layer;return this._layer&&this._layer.removeEntity(this),n&&n.add(this),t}setGeoObject(t){return this.geoObject&&this.geoObject.remove(),this.geoObject=t,this.geoObject._entity=this,this.geoObject.setPosition3v(this._cartesian),this.geoObject.setVisibility(this._visibility),this._entityCollection&&this._entityCollection.geoObjectHandler.add(t),t}setStrip(t){return this.strip&&this.strip.remove(),this.strip=t,this.strip._entity=this,this.strip.setVisibility(this._visibility),this._entityCollection&&this._entityCollection.stripHandler.add(t),t}get layer(){return this._layer}get rendererEvents(){return this._layer?this._layer.events:this._entityCollection?this._entityCollection.events:null}appendChildren(t,n){for(let s=0;s<t.length;s++)n!==void 0&&(t[s].relativePosition=n),this.appendChild(t[s])}appendChild(t){t._entityCollection=this._entityCollection,t._independentPicking||(t._pickingColor=this._pickingColor),t.parent=this,this.childEntities.push(t),this._entityCollection&&this._entityCollection.appendChildEntity(t)}setPickingColor(){let t=this._pickingColor;this.billboard&&this.billboard.setPickingColor3v(t),this.label&&this.label.setPickingColor3v(t),this.polyline&&this.polyline.setPickingColor3v(t),this.ray&&this.ray.setPickingColor3v(t),this.strip&&this.strip.setPickingColor3v(t),this.geoObject&&this.geoObject.setPickingColor3v(t);for(let n=0;n<this.childEntities.length;n++)this.childEntities[n].setPickingColor()}getExtent(){let t,n=this._lonLat;t=this.billboard||this.label?new U(new L(n.lon,n.lat),new L(n.lon,n.lat)):new U(new L(180,90),new L(-180,-90));let s=t.southWest,o=t.northEast;if(this.polyline){let a=this.polyline.getExtent();a.southWest.lon<s.lon&&(s.lon=a.southWest.lon),a.southWest.lat<s.lat&&(s.lat=a.southWest.lat),a.northEast.lon>o.lon&&(o.lon=a.northEast.lon),a.northEast.lat>o.lat&&(o.lat=a.northEast.lat)}if(this.geometry){let a=this.geometry.getExtent();a.southWest.lon<s.lon&&(s.lon=a.southWest.lon),a.southWest.lat<s.lat&&(s.lat=a.southWest.lat),a.northEast.lon>o.lon&&(o.lon=a.northEast.lon),a.northEast.lat>o.lat&&(o.lat=a.northEast.lat)}for(let a=0;a<this.childEntities.length;a++){let h=this.childEntities[a].getExtent();h.southWest.lon<s.lon&&(s.lon=h.southWest.lon),h.southWest.lat<s.lat&&(s.lat=h.southWest.lat),h.northEast.lon>o.lon&&(o.lon=h.northEast.lon),h.northEast.lat>o.lat&&(o.lat=h.northEast.lat)}return t}};ys.__counter__=0;let G=ys;const xs=class sd{constructor(t){this.__id=sd.__counter__++,this._name=t||`nonameNode:${this.__id}`,this.topNode=this,this._dictionary={},this._dictionary[this._name]=this,this.childNodes=[],this.parentNode=null}get name(){return this._name}addNode(t){this.parentNode==null?t.topNode=this:t.topNode=this.topNode,t.parentNode=this,t._dictionary=this.topNode._dictionary,this.childNodes.push(t),this.topNode._dictionary[t.name]=t}destroy(){for(let t=0;t<this.childNodes.length;t++)this.childNodes[t].destroy();this._clear()}getNodeByName(t){return this._dictionary[t]}_clear(){this.parentNode=null,this.topNode=this,this.childNodes.length=0}isEqual(t){return t.__id===this.__id}};xs.__counter__=0;let Cr=xs;class de extends Cr{constructor(t){super(t),this.childNodes=[],this.renderer=null,this.drawMode=0,this.show=!0,this._isActive=!0,this.lightEnabled=!1,this._lightPosition=new Float32Array([100,100,100]),this._lightParams=new Float32Array(9),this._lightShininess=100,this.entityCollections=[],this._entityCollectionsByDepthOrder=[],this._pickingId=-1}getFrameRotation(t){return F.IDENTITY}addNode(t){super.addNode(t),this.renderer&&t.assign(this.renderer)}assign(t){this.renderer=t,this._pickingId=t.addPickingCallback(this,this._entityCollectionPickingCallback),this.initialize()}initialize(){if(this.renderer&&this.renderer.isInitialized()){for(let t=0;t<this.entityCollections.length;t++)this.entityCollections[t].bindRenderNode(this);this.init()}}init(){}onremove(){}remove(){let t=this.renderer,n=this.name;if(t){t.renderNodes[n]&&t.renderNodes[n].isEqual(this)&&(t.renderNodes[n]=null,delete t.renderNodes[n]);for(let s=0;s<t._renderNodesArr.length;s++)if(t._renderNodesArr[s].isEqual(this)){t._renderNodesArr.splice(s,1);break}t.removePickingCallback(this._pickingId),this._pickingId=-1,this.onremove&&this.onremove()}}addEntityCollection(t,n){t.renderNode||(t.renderNode=this,n||(this.entityCollections.push(t),this.updateEntityCollectionsDepthOrder()),this.ellipsoid&&t._updateGeodeticCoordinates(this.ellipsoid),t.bindRenderNode(this),t.events.dispatch(t.events.add,this))}removeEntityCollection(t){for(let n=0;n<this.entityCollections.length;n++)if(this.entityCollections[n].isEqual(t))return this.entityCollections.splice(n,1),void this.updateEntityCollectionsDepthOrder()}updateEntityCollectionsDepthOrder(){let t={0:[]};for(const n of this.entityCollections)n.getVisibility()&&(t[n.depthOrder]||(t[n.depthOrder]=[]),t[n.depthOrder].push(n));this._entityCollectionsByDepthOrder.length=0,this._entityCollectionsByDepthOrder=[],this._entityCollectionsByDepthOrder=Object.keys(t).sort((n,s)=>Number(n)-Number(s)).map(n=>t[Number(n)])}addLight(t){return t.addTo(this),this}preDrawNode(){this._isActive&&this._preDrawNodes()}drawNode(){this._isActive&&this._drawNodes()}isActive(){return this._isActive}setActive(t){this._isActive=t,this.renderer&&(this._isActive&&this._pickingId===-1?this._pickingId=this.renderer.addPickingCallback(this,this._entityCollectionPickingCallback):this._isActive||this._pickingId===-1||(this.renderer.removePickingCallback(this._pickingId),this._pickingId=-1));for(let n=0;n<this.childNodes.length;n++)this.childNodes[n].setActive(t)}setDrawMode(t){this.drawMode=t;for(let n=0;n<this.childNodes.length;n++)this.childNodes[n].setDrawMode(t)}updateBillboardsTexCoords(){for(let t=0;t<this.entityCollections.length;t++)this.entityCollections[t].billboardHandler.refreshTexCoordsArr()}updateStrokeTexCoords(){for(let t=0;t<this.entityCollections.length;t++){let n=this.entityCollections[t];n.rayHandler.refreshTexCoordsArr(),n.polylineHandler.refreshTexCoordsArr()}}frame(){}preFrame(){}_preDrawNodes(){for(let t=0;t<this.childNodes.length;t++)this.childNodes[t]._isActive&&this.childNodes[t]._preDrawNodes();if(this.show){this.preFrame();for(let t=0;t<this._entityCollectionsByDepthOrder.length;t++)this.drawEntityCollections(this._entityCollectionsByDepthOrder[t],t)}}_drawNodes(){for(let t=0;t<this.childNodes.length;t++)this.childNodes[t]._isActive&&this.childNodes[t]._drawNodes();this.show&&this.frame()}drawEntityCollections(t,n=0){this.renderer.enqueueEntityCollectionsToDraw(t,n)}drawPickingEntityCollections(t){if(t.length){let n=t.length;for(;n--;)t[n]._fadingOpacity&&t[n].billboardHandler.drawPicking();for(n=t.length;n--;)t[n]._fadingOpacity&&t[n].geoObjectHandler.drawPicking();for(n=t.length;n--;)t[n]._fadingOpacity&&t[n].labelHandler.drawPicking();for(n=t.length;n--;)t[n]._fadingOpacity&&t[n].rayHandler.drawPicking();for(n=t.length;n--;)t[n]._visibility&&t[n].polylineHandler.drawPicking();for(n=t.length;n--;)t[n]._visibility&&t[n].stripHandler.drawPicking()}}_entityCollectionPickingCallback(){}}const ie=new class{constructor(){this._container=document.createElement("div"),this._container.classList.add("ogConsole"),this._container.style.display="none",document.body&&document.body.appendChild(this._container),this._visibility=!1}getVisibility(){return this._visibility}setVisibility(l){this._visibility!=l&&(this._visibility=l,this._visibility?this.show():this.hide())}show(){this._container.parentNode||document.body&&document.body.appendChild(this._container),this._container.style.display="block",this._visibility=!0}hide(){this._container.style.display="none",this._visibility=!1}logErr(l){let t=document.createElement("div");t.classList.add("ogConsole-text"),t.classList.add("ogConsole-error"),t.innerHTML="error: "+l,console.trace(t.innerHTML),this._container.appendChild(t),this.show()}logWrn(l){let t=document.createElement("div");t.classList.add("ogConsole-text"),t.classList.add("ogConsole-warning"),t.innerHTML="warning: "+l,console.trace(t.innerHTML),this._container.appendChild(t),this.show()}log(l){let t=document.createElement("div");t.classList.add("ogConsole-text"),t.innerHTML=l,console.trace(l),this._container.appendChild(t),this.show()}};let fi=["FLOAT","DOUBLE","BOOL","INT","UINT","VEC2","VEC3","VEC4","DVEC2","DVEC3","DVEC4","BVEC2","BVEC3","BVEC4","IVEC2","IVEC3","IVEC4","UVEC2","UVEC3","UVEC4","MAT2","DMAT2","MAT3","DMAT3","MAT4","DMAT4","MAT2X3","MAT2X4","MAT3X2","MAT3X4","MAT4X2","MAT4X3","DMAT2X3","DMAT2X4","DMAT3X2","DMAT3X4","DMAT4X2","DMAT4X3","SAMPLER1D","SAMPLER2D","SAMPLER3D","SAMPLERCUBE","SAMPLER2DSHADOW","SAMPLER2DARRAY","INTXX","FLOATXX"];const ht={};for(let l=0;l<fi.length;l++)ht[fi[l]]=l;const Er={};for(let l=0;l<fi.length;l++)Er[fi[l].toLowerCase()]=ht[fi[l]];const Pt={u:[],a:[]};Pt.u[ht.MAT4]=function(l,t){l.gl.uniformMatrix4fv(t._pName,!1,t.value)},Pt.u[ht.MAT3]=function(l,t){l.gl.uniformMatrix3fv(t._pName,!1,t.value)},Pt.u[ht.FLOAT]=function(l,t){l.gl.uniform1f(t._pName,t.value)},Pt.u[ht.INT]=function(l,t){l.gl.uniform1i(t._pName,t.value)},Pt.u[ht.VEC2]=function(l,t){l.gl.uniform2fv(t._pName,t.value)},Pt.u[ht.VEC3]=function(l,t){l.gl.uniform3fv(t._pName,t.value)},Pt.u[ht.VEC4]=function(l,t){l.gl.uniform4fv(t._pName,t.value)},Pt.u[ht.SAMPLER2D]=function(l,t){let n=l.gl;n.activeTexture(n.TEXTURE0+l._textureID),n.bindTexture(n.TEXTURE_2D,t.value),n.uniform1i(t._pName,l._textureID),l._textureID++},Pt.u[ht.SAMPLERCUBE]=function(l,t){let n=l.gl;n.activeTexture(n.TEXTURE0+l._textureID),n.bindTexture(n.TEXTURE_CUBE_MAP,t.value),n.uniform1i(t._pName,l._textureID),l._textureID++},Pt.u[ht.SAMPLER2DARRAY]=function(l,t){let n=t.value,s=l.gl,o=n.length,a=new Int32Array(o);for(let h=0;h<o;h++)s.activeTexture(s.TEXTURE0+l._textureID+h),s.bindTexture(s.TEXTURE_2D,n[h]),a[h]=h;s.uniform1iv(t._pName,a)},Pt.u[ht.INTXX]=function(l,t){l.gl.uniform1iv(t._pName,t.value)},Pt.u[ht.FLOATXX]=function(l,t){l.gl.uniform1fv(t._pName,t.value)},Pt.a[ht.FLOAT]=function(l,t){l.gl.vertexAttrib1f(t._pName,t.value)},Pt.a[ht.VEC2]=function(l,t){l.gl.vertexAttrib2fv(t._pName,t.value)},Pt.a[ht.VEC3]=function(l,t){l.gl.vertexAttrib3fv(t._pName,t.value)};const il=["BYTE","SHORT","UNSIGNED_BYTE","UNSIGNED_SHORT","FLOAT","HALF_FLOAT"];class X{constructor(t,n){this.name=t,this._programController=null,this._attributes={};for(let s in n.attributes)typeof n.attributes[s]=="string"||typeof n.attributes[s]=="number"?this._attributes[s]={type:n.attributes[s]}:this._attributes[s]=n.attributes[s];this._uniforms={};for(let s in n.uniforms)typeof n.uniforms[s]=="string"||typeof n.uniforms[s]=="number"?this._uniforms[s]={type:n.uniforms[s]}:this._uniforms[s]=n.uniforms[s];this.vertexShader=n.vertexShader,this.fragmentShader=n.fragmentShader,this.gl=null,this._variables={},this._p=null,this._textureID=0,this._attribArrays=[],this._attribDivisor=[],this.attributes={},this.uniforms={},this.vertexAttribDivisor=null,this.drawElementsInstanced=null}static bindBuffer(t,n){let s=t.gl;s&&(s.bindBuffer(s.ARRAY_BUFFER,n.value),s.vertexAttribPointer(n._pName,n.value.itemSize,n.itemType,n.normalized,0,0))}use(){this.gl&&this.gl.useProgram(this._p)}set(t){this._textureID=0;for(let n in t)this._variables[n].value=t[n],this._variables[n].func(this,this._variables[n])}apply(){this._textureID=0;let t=this._variables;for(let n in t)t[n].func(this,t[n])}drawIndexBuffer(t,n){let s=this.gl;s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,n),s.drawElements(t,n.numItems,s.UNSIGNED_SHORT,0)}drawArrays(t,n){this.gl.drawArrays(t,0,n)}_getShaderCompileStatus(t,n){if(!this.gl)return!1;const s=this.gl instanceof WebGL2RenderingContext;return this.gl.shaderSource(t,function(o,a){if(!a)return o;const h=o.split(`
`),c=h.findIndex(u=>u.startsWith("#version"));return c!==-1?(h.splice(c+1,0,"#define WEBGL2"),h.join(`
`)):o}(n,s)),this.gl.compileShader(t),!!this.gl.getShaderParameter(t,this.gl.COMPILE_STATUS)||(ie.logErr(`Shader program "${this.name}":${this.gl.getShaderInfoLog(t)}.`),!1)}_createVertexShader(t){if(!this.gl)return;let n=this.gl.createShader(this.gl.VERTEX_SHADER);return n&&this._getShaderCompileStatus(n,t)?n:void 0}_createFragmentShader(t){if(!this.gl)return;let n=this.gl.createShader(this.gl.FRAGMENT_SHADER);return n&&this._getShaderCompileStatus(n,t)?n:void 0}disableAttribArrays(){let t=this.gl,n=this._attribArrays;for(let s=0,o=n.length;s<o;s++)t.disableVertexAttribArray(n[s]),this.vertexAttribDivisor(n[s],0)}enableAttribArrays(){let t=this.gl,n=this._attribArrays,s=this._attribDivisor;for(let o=0,a=n.length;o<a;o++)t.enableVertexAttribArray(n[o]),this.vertexAttribDivisor(n[o],s[o])}delete(){this.gl&&this.gl.deleteProgram(this._p)}createProgram(t){if(this.gl=t,this._p=this.gl.createProgram(),!this._p)return;let n=this._createFragmentShader(this.fragmentShader),s=this._createVertexShader(this.vertexShader);if(n&&s){if(t.attachShader(this._p,n),t.attachShader(this._p,s),t.linkProgram(this._p),!this.drawElementsInstanced)if(t.drawElementsInstanced)this.drawElementsInstanced=t.drawElementsInstanced.bind(t);else{let o=t.getExtension("ANGLE_instanced_arrays");o&&(this.drawElementsInstanced=o.drawElementsInstancedANGLE.bind(o))}if(!this.vertexAttribDivisor)if(t.vertexAttribDivisor)this.vertexAttribDivisor=t.vertexAttribDivisor.bind(t);else{let o=t.getExtension("ANGLE_instanced_arrays");o&&(this.vertexAttribDivisor=o.vertexAttribDivisorANGLE.bind(o))}if(!t.getProgramParameter(this._p,t.LINK_STATUS))return ie.logErr(`Shader program "${this.name}": initialization failed. ${t.getProgramInfoLog(this._p)}.`),void t.deleteProgram(this._p);this.use();for(let o in this._attributes){this._variables[o]=this._attributes[o],this._attributes[o].func=X.bindBuffer;let a=this._attributes[o].itemType,h=a?a.trim().toUpperCase():"FLOAT";if(il.indexOf(h)==-1?(ie.logErr(`Shader program "${this.name}": attribute '${o}', item type '${this._attributes[o].itemType}' not exists.`),this._attributes[o].itemType=t.FLOAT):this._attributes[o].itemType=t[h],this._attributes[o].normalized=this._attributes[o].normalized||!1,this._attributes[o].divisor=this._attributes[o].divisor||0,this._p[o]=t.getAttribLocation(this._p,o),this._p[o]==null)return ie.logErr(`Shader program "${this.name}":  attribute '${o}' not exists.`),void t.deleteProgram(this._p);let c=this._attributes[o].type;typeof c=="string"&&(c=Er[c.trim().toLowerCase()]);let u=this._attributes[o].divisor;if(c===ht.MAT4){let d=this._p[o];this._attribArrays.push(d,d+1,d+2,d+3),this._attribDivisor.push(u,u,u,u)}else this._attribArrays.push(this._p[o]),this._attribDivisor.push(u);t.enableVertexAttribArray(this._p[o]),this._attributes[o]._pName=this._p[o],this.attributes[o]=this._p[o]}for(let o in this._uniforms){if(typeof this._uniforms[o].type=="string"){let a=this._uniforms[o].type;this._uniforms[o].func=Pt.u[Er[a.trim().toLowerCase()]]}else this._uniforms[o].func=Pt.u[this._uniforms[o].type];if(this._variables[o]=this._uniforms[o],this._p[o]=t.getUniformLocation(this._p,o),this._p[o]==null)return ie.logErr(`Shader program "${this.name}": uniform '${o}' not exists.`),void t.deleteProgram(this._p);this._uniforms[o]._pName=this._p[o],this.uniforms[o]=this._p[o]}t.detachShader(this._p,n),t.detachShader(this._p,s),t.deleteShader(n),t.deleteShader(s)}}}const bs=class od{constructor(t){this.__id=od.__counter__++,this.pickingEnabled=!0,this._entityCollection=t,this._renderer=null,this._billboards=[],this._positionHighBuffer=null,this._positionLowBuffer=null,this._sizeBuffer=null,this._offsetBuffer=null,this._rgbaBuffer=null,this._rotationBuffer=null,this._texCoordBuffer=null,this._vertexBuffer=null,this._pickingColorBuffer=null,this._texCoordArr=new Float32Array([]),this._vertexArr=new Float32Array([]),this._positionHighArr=new Float32Array([]),this._positionLowArr=new Float32Array([]),this._sizeArr=new Float32Array([]),this._offsetArr=new Float32Array([]),this._rgbaArr=new Float32Array([]),this._rotationArr=new Float32Array([]),this._pickingColorArr=new Float32Array([]),this._buffersUpdateCallbacks=[],this._buffersUpdateCallbacks[0]=this.createPickingColorBuffer,this._buffersUpdateCallbacks[1]=this.createPositionBuffer,this._buffersUpdateCallbacks[2]=this.createSizeBuffer,this._buffersUpdateCallbacks[3]=this.createOffsetBuffer,this._buffersUpdateCallbacks[4]=this.createRgbaBuffer,this._buffersUpdateCallbacks[5]=this.createRotationBuffer,this._buffersUpdateCallbacks[6]=this.createTexCoordBuffer,this._buffersUpdateCallbacks[7]=this.createVertexBuffer,this._changedBuffers=new Array(this._buffersUpdateCallbacks.length)}isEqual(t){return t&&t.__id===this.__id}static concArr(t,n){for(let s=0;s<n.length;s++)t.push(n[s])}initProgram(){this._renderer&&this._renderer.handler&&(this._renderer.handler.programs.billboard||this._renderer.handler.addProgram(new X("billboard",{uniforms:{viewport:"vec2",u_texture:"sampler2d",projectionMatrix:"mat4",viewMatrix:"mat4",eyePositionHigh:"vec3",eyePositionLow:"vec3",planetRadius:"float",uScaleByDistance:"vec3",opacity:"float",depthOffset:"float"},attributes:{a_vertices:"vec2",a_texCoord:"vec2",a_positionsHigh:"vec3",a_positionsLow:"vec3",a_offset:"vec3",a_size:"vec2",a_rotation:"float",a_rgba:"vec4"},vertexShader:`precision highp float;
#define EMPTY - 1.0
#define RTL 1.0
vec2 project(vec4 p,vec2 viewport){return(0.5*p.xyz/p.w+0.5).xy*viewport;}mat2 rotate2d(float angle){return mat2(cos(angle),-sin(angle),sin(angle),cos(angle));}attribute vec2 a_vertices;attribute vec2 a_texCoord;attribute vec3 a_positionsHigh;attribute vec3 a_positionsLow;attribute vec3 a_offset;attribute vec2 a_size;attribute float a_rotation;attribute vec4 a_rgba;varying vec2 v_texCoords;varying vec4 v_rgba;uniform mat4 viewMatrix;uniform mat4 projectionMatrix;uniform vec3 eyePositionHigh;uniform vec3 eyePositionLow;uniform vec3 uScaleByDistance;uniform float opacity;uniform float planetRadius;uniform vec2 viewport;uniform float depthOffset;const vec3 ZERO3=vec3(0.0);void main(){vec3 a_positions=a_positionsHigh+a_positionsLow;vec3 cameraPos=eyePositionHigh+eyePositionLow;v_texCoords=a_texCoord;vec3 look=a_positions-cameraPos;float lookDist=length(look);v_rgba=a_rgba;if(opacity*step(lookDist,sqrt(dot(cameraPos,cameraPos)-planetRadius)+sqrt(dot(a_positions,a_positions)-planetRadius))==0.0){return;}float scd=(1.0-smoothstep(uScaleByDistance[0],uScaleByDistance[1],lookDist))*(1.0-step(uScaleByDistance[2],lookDist));mat4 viewMatrixRTE=viewMatrix;viewMatrixRTE[3]=vec4(0.0,0.0,0.0,1.0);vec3 highDiff=a_positionsHigh-eyePositionHigh;vec3 lowDiff=a_positionsLow-eyePositionLow;vec4 posRTE=viewMatrixRTE*vec4(highDiff+lowDiff,1.0);vec4 projPos=projectionMatrix*posRTE;float camSlope=dot(vec3(viewMatrix[0][2],viewMatrix[1][2],viewMatrix[2][2]),normalize(cameraPos));if(camSlope>0.5){float dist=dot(look,normalize(cameraPos));projPos.z+=dist*0.02;}else{projPos.z+=-(abs(projPos.z))*0.002;}projPos.z+=depthOffset+a_offset.z;vec2 screenPos=project(projPos,viewport);vec2 v=screenPos+rotate2d(a_rotation)*(a_vertices*a_size*scd+a_offset.xy);gl_Position=vec4((2.0*v/viewport-1.0)*projPos.w,projPos.z,projPos.w);}`,fragmentShader:"precision highp float;uniform sampler2D u_texture;varying vec2 v_texCoords;varying vec4 v_rgba;void main(){vec4 color=texture2D(u_texture,v_texCoords);if(color.a<0.1)discard;gl_FragColor=color*v_rgba;}"})),this._renderer.handler.programs.billboardPicking||this._renderer.handler.addProgram(new X("billboardPicking",{uniforms:{viewport:"vec2",projectionMatrix:"mat4",viewMatrix:"mat4",eyePositionHigh:"vec3",eyePositionLow:"vec3",planetRadius:"float",uScaleByDistance:"vec3",opacity:"float",depthOffset:"float"},attributes:{a_vertices:"vec2",a_positionsHigh:"vec3",a_positionsLow:"vec3",a_offset:"vec3",a_size:"vec2",a_rotation:"float",a_rgba:"vec4"},vertexShader:`precision highp float;
#define EMPTY - 1.0
#define RTL 1.0
vec2 project(vec4 p,vec2 viewport){return(0.5*p.xyz/p.w+0.5).xy*viewport;}mat2 rotate2d(float angle){return mat2(cos(angle),-sin(angle),sin(angle),cos(angle));}attribute vec2 a_vertices;attribute vec3 a_positionsHigh;attribute vec3 a_positionsLow;attribute vec3 a_offset;attribute vec2 a_size;attribute float a_rotation;attribute vec4 a_rgba;varying vec3 v_rgb;uniform mat4 viewMatrix;uniform mat4 projectionMatrix;uniform vec3 eyePositionHigh;uniform vec3 eyePositionLow;uniform vec3 uScaleByDistance;uniform float opacity;uniform float planetRadius;uniform vec2 viewport;uniform float depthOffset;const vec3 ZERO3=vec3(0.0);void main(){vec3 a_positions=a_positionsHigh+a_positionsLow;vec3 cameraPos=eyePositionHigh+eyePositionLow;vec3 look=a_positions-cameraPos;float lookDist=length(look);v_rgb=a_rgba.rgb;if(opacity*step(lookDist,sqrt(dot(cameraPos,cameraPos)-planetRadius)+sqrt(dot(a_positions,a_positions)-planetRadius))==0.0){return;}float scd=(1.0-smoothstep(uScaleByDistance[0],uScaleByDistance[1],lookDist))*(1.0-step(uScaleByDistance[2],lookDist));mat4 viewMatrixRTE=viewMatrix;viewMatrixRTE[3]=vec4(0.0,0.0,0.0,1.0);vec3 highDiff=a_positionsHigh-eyePositionHigh;vec3 lowDiff=a_positionsLow-eyePositionLow;vec4 posRTE=viewMatrixRTE*vec4(highDiff+lowDiff,1.0);vec4 projPos=projectionMatrix*posRTE;float camSlope=dot(vec3(viewMatrix[0][2],viewMatrix[1][2],viewMatrix[2][2]),normalize(cameraPos));if(camSlope>0.5){float dist=dot(look,normalize(cameraPos));projPos.z+=dist*0.02;}else{projPos.z+=-(abs(projPos.z))*0.002;}projPos.z+=depthOffset+a_offset.z;vec2 screenPos=project(projPos,viewport);vec2 v=screenPos+rotate2d(a_rotation)*(a_vertices*a_size*scd+a_offset.xy);gl_Position=vec4((2.0*v/viewport-1.0)*projPos.w,projPos.z,projPos.w);}`,fragmentShader:"precision highp float;varying vec3 v_rgb;void main(){gl_FragColor=vec4(v_rgb,1.0);}"})))}setRenderer(t){this._renderer=t,this.initProgram()}refresh(){let t=this._changedBuffers.length;for(;t--;)this._changedBuffers[t]=!0}_removeBillboards(){let t=this._billboards.length;for(;t--;){let n=this._billboards[t];n._handlerIndex=-1,n._handler=null,n._isReady=!1,n._lockId=-1}this._billboards.length=0,this._billboards=[]}clear(){this._texCoordArr=null,this._vertexArr=null,this._positionHighArr=null,this._positionLowArr=null,this._sizeArr=null,this._offsetArr=null,this._rgbaArr=null,this._rotationArr=null,this._pickingColorArr=null,this._texCoordArr=new Float32Array([]),this._vertexArr=new Float32Array([]),this._positionHighArr=new Float32Array([]),this._positionLowArr=new Float32Array([]),this._sizeArr=new Float32Array([]),this._offsetArr=new Float32Array([]),this._rgbaArr=new Float32Array([]),this._rotationArr=new Float32Array([]),this._pickingColorArr=new Float32Array([]),this._removeBillboards(),this._deleteBuffers(),this.refresh()}_deleteBuffers(){if(this._renderer){let t=this._renderer.handler.gl;t.deleteBuffer(this._positionHighBuffer),t.deleteBuffer(this._positionLowBuffer),t.deleteBuffer(this._sizeBuffer),t.deleteBuffer(this._offsetBuffer),t.deleteBuffer(this._rgbaBuffer),t.deleteBuffer(this._rotationBuffer),t.deleteBuffer(this._vertexBuffer),t.deleteBuffer(this._texCoordBuffer),t.deleteBuffer(this._pickingColorBuffer)}this._positionHighBuffer=null,this._positionLowBuffer=null,this._sizeBuffer=null,this._offsetBuffer=null,this._rgbaBuffer=null,this._rotationBuffer=null,this._vertexBuffer=null,this._texCoordBuffer=null,this._pickingColorBuffer=null}update(){if(this._renderer){let t=this._changedBuffers.length;for(;t--;)this._changedBuffers[t]&&(this._buffersUpdateCallbacks[t].call(this),this._changedBuffers[t]=!1)}}add(t){t._handlerIndex==-1&&(t._isReady=!0,t._handler=this,t._handlerIndex=this._billboards.length,this._billboards.push(t))}_displayPASS(){let t=this._renderer,n=t.handler;n.programs.billboard.activate();let s=n.programs.billboard._program,o=s.attributes,a=s.uniforms,h=n.gl,c=this._entityCollection;h.disable(h.CULL_FACE),h.uniform1f(a.depthOffset,c.polygonOffsetUnits),h.uniform1i(a.u_texture,0),h.uniformMatrix4fv(a.viewMatrix,!1,t.activeCamera.getViewMatrix()),h.uniformMatrix4fv(a.projectionMatrix,!1,t.activeCamera.getProjectionMatrix()),h.uniform3fv(a.eyePositionHigh,t.activeCamera.eyeHigh),h.uniform3fv(a.eyePositionLow,t.activeCamera.eyeLow),h.uniform3fv(a.uScaleByDistance,c.scaleByDistance),h.uniform1f(a.opacity,c._fadingOpacity),h.bindBuffer(h.ARRAY_BUFFER,this._texCoordBuffer),h.vertexAttribPointer(o.a_texCoord,this._texCoordBuffer.itemSize,h.FLOAT,!1,0,0),h.bindBuffer(h.ARRAY_BUFFER,this._vertexBuffer),h.vertexAttribPointer(o.a_vertices,this._vertexBuffer.itemSize,h.FLOAT,!1,0,0),h.bindBuffer(h.ARRAY_BUFFER,this._positionHighBuffer),h.vertexAttribPointer(o.a_positionsHigh,this._positionHighBuffer.itemSize,h.FLOAT,!1,0,0),h.bindBuffer(h.ARRAY_BUFFER,this._positionLowBuffer),h.vertexAttribPointer(o.a_positionsLow,this._positionLowBuffer.itemSize,h.FLOAT,!1,0,0),h.bindBuffer(h.ARRAY_BUFFER,this._rgbaBuffer),h.vertexAttribPointer(o.a_rgba,this._rgbaBuffer.itemSize,h.FLOAT,!1,0,0),h.bindBuffer(h.ARRAY_BUFFER,this._sizeBuffer),h.vertexAttribPointer(o.a_size,this._sizeBuffer.itemSize,h.FLOAT,!1,0,0),h.bindBuffer(h.ARRAY_BUFFER,this._offsetBuffer),h.vertexAttribPointer(o.a_offset,this._offsetBuffer.itemSize,h.FLOAT,!1,0,0),h.uniform1f(a.planetRadius,c.renderNode._planetRadius2||0),h.uniform2fv(a.viewport,[n.canvas.clientWidth,n.canvas.clientHeight]),h.bindBuffer(h.ARRAY_BUFFER,this._rotationBuffer),h.vertexAttribPointer(o.a_rotation,this._rotationBuffer.itemSize,h.FLOAT,!1,0,0),h.drawArrays(h.TRIANGLES,0,this._vertexBuffer.numItems),h.enable(h.CULL_FACE)}_pickingPASS(){let t=this._renderer,n=t.handler;n.programs.billboardPicking.activate();let s=n.programs.billboardPicking._program,o=s.attributes,a=s.uniforms,h=n.gl,c=this._entityCollection;h.disable(h.CULL_FACE),h.uniform1f(a.depthOffset,c.polygonOffsetUnits),h.uniformMatrix4fv(a.viewMatrix,!1,t.activeCamera.getViewMatrix()),h.uniformMatrix4fv(a.projectionMatrix,!1,t.activeCamera.getProjectionMatrix()),h.uniform3fv(a.eyePositionHigh,t.activeCamera.eyeHigh),h.uniform3fv(a.eyePositionLow,t.activeCamera.eyeLow),h.uniform3fv(a.uScaleByDistance,c.scaleByDistance),h.uniform1f(a.opacity,c._fadingOpacity),h.bindBuffer(h.ARRAY_BUFFER,this._vertexBuffer),h.vertexAttribPointer(o.a_vertices,this._vertexBuffer.itemSize,h.FLOAT,!1,0,0),h.bindBuffer(h.ARRAY_BUFFER,this._positionHighBuffer),h.vertexAttribPointer(o.a_positionsHigh,this._positionHighBuffer.itemSize,h.FLOAT,!1,0,0),h.bindBuffer(h.ARRAY_BUFFER,this._positionLowBuffer),h.vertexAttribPointer(o.a_positionsLow,this._positionLowBuffer.itemSize,h.FLOAT,!1,0,0),h.bindBuffer(h.ARRAY_BUFFER,this._pickingColorBuffer),h.vertexAttribPointer(o.a_rgba,this._pickingColorBuffer.itemSize,h.FLOAT,!1,0,0),h.bindBuffer(h.ARRAY_BUFFER,this._sizeBuffer),h.vertexAttribPointer(o.a_size,this._sizeBuffer.itemSize,h.FLOAT,!1,0,0),h.bindBuffer(h.ARRAY_BUFFER,this._offsetBuffer),h.vertexAttribPointer(o.a_offset,this._offsetBuffer.itemSize,h.FLOAT,!1,0,0),h.uniform1f(a.planetRadius,c.renderNode._planetRadius2||0),h.uniform2fv(a.viewport,[n.canvas.clientWidth,n.canvas.clientHeight]),h.bindBuffer(h.ARRAY_BUFFER,this._rotationBuffer),h.vertexAttribPointer(o.a_rotation,this._rotationBuffer.itemSize,h.FLOAT,!1,0,0),h.drawArrays(h.TRIANGLES,0,this._vertexBuffer.numItems),h.enable(h.CULL_FACE)}draw(){this._billboards.length&&(this.update(),this._displayPASS())}drawPicking(){this._billboards.length&&this.pickingEnabled&&this._pickingPASS()}reindexBillboardsArray(t){let n=this._billboards;for(let s=t;s<n.length;s++)n[s]._handlerIndex=s}_removeBillboard(t){let n=t._handlerIndex;this._billboards.splice(n,1);let s=24*n;this._rgbaArr=ot(this._rgbaArr,s,24),s=18*n,this._positionHighArr=ot(this._positionHighArr,s,18),this._positionLowArr=ot(this._positionLowArr,s,18),this._offsetArr=ot(this._offsetArr,s,18),this._pickingColorArr=ot(this._pickingColorArr,s,18),s=12*n,this._vertexArr=ot(this._vertexArr,s,12),this._sizeArr=ot(this._sizeArr,s,12),this._texCoordArr=ot(this._texCoordArr,s,12),s=6*n,this._rotationArr=ot(this._rotationArr,s,6),this.reindexBillboardsArray(n),this.refresh(),t._handlerIndex=-1,t._handler=null,t._isReady=!1,t._lockId=-1}setAlignedAxisArr(t,n){}remove(t){t._handler&&(t._isReady&&this.__id===t._handler.__id?this._removeBillboard(t):t._handler=null)}setPositionArr(t,n,s){let o=18*t,a=this._positionHighArr,h=n.x,c=n.y,u=n.z;a[o]=h,a[o+1]=c,a[o+2]=u,a[o+3]=h,a[o+4]=c,a[o+5]=u,a[o+6]=h,a[o+7]=c,a[o+8]=u,a[o+9]=h,a[o+10]=c,a[o+11]=u,a[o+12]=h,a[o+13]=c,a[o+14]=u,a[o+15]=h,a[o+16]=c,a[o+17]=u,a=this._positionLowArr,h=s.x,c=s.y,u=s.z,a[o]=h,a[o+1]=c,a[o+2]=u,a[o+3]=h,a[o+4]=c,a[o+5]=u,a[o+6]=h,a[o+7]=c,a[o+8]=u,a[o+9]=h,a[o+10]=c,a[o+11]=u,a[o+12]=h,a[o+13]=c,a[o+14]=u,a[o+15]=h,a[o+16]=c,a[o+17]=u,this._changedBuffers[1]=!0}setPickingColorArr(t,n){let s=18*t,o=this._pickingColorArr,a=n.x/255,h=n.y/255,c=n.z/255;o[s]=a,o[s+1]=h,o[s+2]=c,o[s+3]=a,o[s+4]=h,o[s+5]=c,o[s+6]=a,o[s+7]=h,o[s+8]=c,o[s+9]=a,o[s+10]=h,o[s+11]=c,o[s+12]=a,o[s+13]=h,o[s+14]=c,o[s+15]=a,o[s+16]=h,o[s+17]=c,this._changedBuffers[0]=!0}setSizeArr(t,n,s){let o=12*t,a=this._sizeArr,h=n,c=s;a[o]=h,a[o+1]=c,a[o+2]=h,a[o+3]=c,a[o+4]=h,a[o+5]=c,a[o+6]=h,a[o+7]=c,a[o+8]=h,a[o+9]=c,a[o+10]=h,a[o+11]=c,this._changedBuffers[2]=!0}setOffsetArr(t,n){let s=18*t,o=this._offsetArr,a=n.x,h=n.y,c=n.z;o[s]=a,o[s+1]=h,o[s+2]=c,o[s+3]=a,o[s+4]=h,o[s+5]=c,o[s+6]=a,o[s+7]=h,o[s+8]=c,o[s+9]=a,o[s+10]=h,o[s+11]=c,o[s+12]=a,o[s+13]=h,o[s+14]=c,o[s+15]=a,o[s+16]=h,o[s+17]=c,this._changedBuffers[3]=!0}setRgbaArr(t,n){let s=24*t,o=this._rgbaArr,a=n.x,h=n.y,c=n.z,u=n.w;o[s]=a,o[s+1]=h,o[s+2]=c,o[s+3]=u,o[s+4]=a,o[s+5]=h,o[s+6]=c,o[s+7]=u,o[s+8]=a,o[s+9]=h,o[s+10]=c,o[s+11]=u,o[s+12]=a,o[s+13]=h,o[s+14]=c,o[s+15]=u,o[s+16]=a,o[s+17]=h,o[s+18]=c,o[s+19]=u,o[s+20]=a,o[s+21]=h,o[s+22]=c,o[s+23]=u,this._changedBuffers[4]=!0}setRotationArr(t,n){let s=6*t,o=this._rotationArr;o[s]=n,o[s+1]=n,o[s+2]=n,o[s+3]=n,o[s+4]=n,o[s+5]=n,this._changedBuffers[5]=!0}setTexCoordArr(t,n){let s=12*t,o=this._texCoordArr;o[s]=n[0],o[s+1]=n[1],o[s+2]=n[2],o[s+3]=n[3],o[s+4]=n[4],o[s+5]=n[5],o[s+6]=n[6],o[s+7]=n[7],o[s+8]=n[8],o[s+9]=n[9],o[s+10]=n[10],o[s+11]=n[11],this._changedBuffers[6]=!0}setVisibility(t,n){let s;s=n?[-.5,.5,-.5,-.5,.5,-.5,.5,-.5,.5,.5,-.5,.5]:[0,0,0,0,0,0,0,0,0,0,0,0],this.setVertexArr(t,s)}setVertexArr(t,n){let s=12*t,o=this._vertexArr;o[s]=n[0],o[s+1]=n[1],o[s+2]=n[2],o[s+3]=n[3],o[s+4]=n[4],o[s+5]=n[5],o[s+6]=n[6],o[s+7]=n[7],o[s+8]=n[8],o[s+9]=n[9],o[s+10]=n[10],o[s+11]=n[11],this._changedBuffers[7]=!0}createPositionBuffer(){let t=this._renderer.handler,n=this._positionHighArr.length/3;this._positionHighBuffer&&this._positionHighBuffer.numItems===n||(t.gl.deleteBuffer(this._positionHighBuffer),t.gl.deleteBuffer(this._positionLowBuffer),this._positionHighBuffer=t.createStreamArrayBuffer(3,n),this._positionLowBuffer=t.createStreamArrayBuffer(3,n)),t.setStreamArrayBuffer(this._positionHighBuffer,this._positionHighArr),t.setStreamArrayBuffer(this._positionLowBuffer,this._positionLowArr)}createSizeBuffer(){let t=this._renderer.handler;t.gl.deleteBuffer(this._sizeBuffer),this._sizeBuffer=t.createArrayBuffer(this._sizeArr,2,this._sizeArr.length/2)}createOffsetBuffer(){let t=this._renderer.handler;t.gl.deleteBuffer(this._offsetBuffer),this._offsetBuffer=t.createArrayBuffer(this._offsetArr,3,this._offsetArr.length/3)}createRgbaBuffer(){let t=this._renderer.handler;t.gl.deleteBuffer(this._rgbaBuffer),this._rgbaBuffer=t.createArrayBuffer(this._rgbaArr,4,this._rgbaArr.length/4)}createRotationBuffer(){let t=this._renderer.handler;this._rotationBuffer&&this._rotationBuffer.numItems===this._rotationArr.length||(t.gl.deleteBuffer(this._rotationBuffer),this._rotationBuffer=t.createStreamArrayBuffer(1,this._rotationArr.length)),t.setStreamArrayBuffer(this._rotationBuffer,this._rotationArr)}createVertexBuffer(){let t=this._renderer.handler;t.gl.deleteBuffer(this._vertexBuffer),this._vertexBuffer=t.createArrayBuffer(this._vertexArr,2,this._vertexArr.length/2)}createTexCoordBuffer(){let t=this._renderer.handler;t.gl.deleteBuffer(this._texCoordBuffer),this._texCoordBuffer=t.createArrayBuffer(this._texCoordArr,2,this._texCoordArr.length/2)}createPickingColorBuffer(){let t=this._renderer.handler;t.gl.deleteBuffer(this._pickingColorBuffer),this._pickingColorBuffer=t.createArrayBuffer(this._pickingColorArr,3,this._pickingColorArr.length/3)}refreshTexCoordsArr(){}};bs.__counter__=0;let ns=bs;class sl extends ns{constructor(t){super(t),this._billboards=[]}add(t){if(t._handlerIndex==-1){super.add(t),this._addBillboardToArrays(t),this.refresh();let n=t.getSrc()||t.getImage()&&t.getImage().src;n&&t.setSrc(n)}}_addBillboardToArrays(t){t.getVisibility()?this._vertexArr=it(this._vertexArr,[-.5,.5,-.5,-.5,.5,-.5,.5,-.5,.5,.5,-.5,.5]):this._vertexArr=it(this._vertexArr,[0,0,0,0,0,0,0,0,0,0,0,0]),this._texCoordArr=it(this._texCoordArr,[0,0,0,0,0,0,0,0,0,0,0,0]);let n,s=t._positionHigh.x,o=t._positionHigh.y,a=t._positionHigh.z;this._positionHighArr=it(this._positionHighArr,[s,o,a,s,o,a,s,o,a,s,o,a,s,o,a,s,o,a]),s=t._positionLow.x,o=t._positionLow.y,a=t._positionLow.z,this._positionLowArr=it(this._positionLowArr,[s,o,a,s,o,a,s,o,a,s,o,a,s,o,a,s,o,a]),s=t._width,o=t._height,this._sizeArr=it(this._sizeArr,[s,o,s,o,s,o,s,o,s,o,s,o]),s=t._offset.x,o=t._offset.y,a=t._offset.z,this._offsetArr=it(this._offsetArr,[s,o,a,s,o,a,s,o,a,s,o,a,s,o,a,s,o,a]),s=t._color.x,o=t._color.y,a=t._color.z,n=t._color.w,this._rgbaArr=it(this._rgbaArr,[s,o,a,n,s,o,a,n,s,o,a,n,s,o,a,n,s,o,a,n,s,o,a,n]),s=t._rotation,this._rotationArr=it(this._rotationArr,[s,s,s,s,s,s]),s=t._entity._pickingColor.x/255,o=t._entity._pickingColor.y/255,a=t._entity._pickingColor.z/255,this._pickingColorArr=it(this._pickingColorArr,[s,o,a,s,o,a,s,o,a,s,o,a,s,o,a,s,o,a])}get billboards(){return this._billboards}refreshTexCoordsArr(){if(this._entityCollection&&this._renderer){let t=this._renderer.billboardsTextureAtlas;for(let n=0;n<this._billboards.length;n++){let s=this._billboards[n],o=s.getImage();if(o){let a=t.get(o.__nodeIndex);a&&this.setTexCoordArr(s._handlerIndex,a.texCoords)}}}}}class rl{constructor(t){this.isFree=!0,this._geoObjectHandler=t,this.geoObjects=[],this.numInstances=0,this._colorTexture=null,this._colorTextureSrc=null,this._colorTextureImage=null,this._normalTexture=null,this._normalTextureSrc=null,this._normalTextureImage=null,this._metallicRoughnessTexture=null,this._metallicRoughnessTextureSrc=null,this._metallicRoughnessTextureImage=null,this._sizeArr=[],this._translateArr=[],this._vertexArr=[],this._rtcPositionHighArr=[],this._rtcPositionLowArr=[],this._qRotArr=[],this._rgbaArr=[],this._normalsArr=[],this._indicesArr=[],this._pickingColorArr=[],this._visibleArr=[],this._texCoordArr=[],this._localPositionArr=[],this._sizeBuffer=null,this._translateBuffer=null,this._vertexBuffer=null,this._rtcPositionHighBuffer=null,this._rtcPositionLowBuffer=null,this._qRotBuffer=null,this._rgbaBuffer=null,this._normalsBuffer=null,this._indicesBuffer=null,this._pickingColorBuffer=null,this._visibleBuffer=null,this._texCoordBuffer=null,this._localPositionBuffer=null,this._materialParams=new Float32Array(9),this._materialShininess=0,this._buffersUpdateCallbacks=[],this._buffersUpdateCallbacks[Jo]=this.createPickingColorBuffer,this._buffersUpdateCallbacks[Xo]=this.createNormalsBuffer,this._buffersUpdateCallbacks[$o]=this.createRgbaBuffer,this._buffersUpdateCallbacks[Zo]=this.createIndicesBuffer,this._buffersUpdateCallbacks[Yo]=this.createVertexBuffer,this._buffersUpdateCallbacks[Qo]=this.createSizeBuffer,this._buffersUpdateCallbacks[ta]=this.createVisibleBuffer,this._buffersUpdateCallbacks[ea]=this.createTexCoordBuffer,this._buffersUpdateCallbacks[Ko]=this.createQRotBuffer,this._buffersUpdateCallbacks[ia]=this.createTranslateBuffer,this._buffersUpdateCallbacks[Wo]=this.createRTCPositionBuffer,this._buffersUpdateCallbacks[sa]=this.createLocalPositionBuffer,this._changedBuffers=new Array(this._buffersUpdateCallbacks.length)}setMaterialAmbient(t,n,s){this._materialParams[0]=t,this._materialParams[1]=n,this._materialParams[2]=s}setMaterialDiffuse(t,n,s){this._materialParams[3]=t,this._materialParams[4]=n,this._materialParams[5]=s}setMaterialSpecular(t,n,s){this._materialParams[6]=t,this._materialParams[7]=n,this._materialParams[8]=s}setMaterialShininess(t){this._materialShininess=t}setMaterialParams(t,n,s,o){this.setMaterialAmbient(t[0],t[1],t[2]),this.setMaterialDiffuse(n[0],n[1],n[2]),this.setMaterialSpecular(s[0],s[1],s[2]),this.setMaterialShininess(o)}drawOpaque(t){let n=t.gl,s=t.uniforms,o=t.attributes;n.bindBuffer(n.ARRAY_BUFFER,this._qRotBuffer),n.vertexAttribPointer(o.qRot,this._qRotBuffer.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,this._sizeBuffer),n.vertexAttribPointer(o.aScale,this._sizeBuffer.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,this._translateBuffer),n.vertexAttribPointer(o.aTranslate,this._translateBuffer.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,this._localPositionBuffer),n.vertexAttribPointer(o.aLocalPosition,this._localPositionBuffer.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,this._visibleBuffer),n.vertexAttribPointer(o.aDispose,this._visibleBuffer.itemSize,n.FLOAT,!1,0,0),n.uniform1f(s.uUseTexture,this._colorTexture?1:0),n.bindBuffer(n.ARRAY_BUFFER,this._rgbaBuffer),n.vertexAttribPointer(o.aColor,this._rgbaBuffer.itemSize,n.FLOAT,!1,0,0),n.uniform3fv(s.materialParams,this._materialParams),n.uniform1f(s.materialShininess,this._materialShininess),this._drawElementsInstanced(t)}drawTransparent(t){let n=t.gl,s=t.uniforms,o=t.attributes;n.bindBuffer(n.ARRAY_BUFFER,this._qRotBuffer),n.vertexAttribPointer(o.qRot,this._qRotBuffer.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,this._sizeBuffer),n.vertexAttribPointer(o.aScale,this._sizeBuffer.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,this._translateBuffer),n.vertexAttribPointer(o.aTranslate,this._translateBuffer.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,this._localPositionBuffer),n.vertexAttribPointer(o.aLocalPosition,this._localPositionBuffer.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,this._visibleBuffer),n.vertexAttribPointer(o.aDispose,this._visibleBuffer.itemSize,n.FLOAT,!1,0,0),n.uniform1f(s.uUseTexture,this._colorTexture?1:0),n.uniform3fv(s.materialParams,this._materialParams),n.uniform1f(s.materialShininess,this._materialShininess),n.bindBuffer(n.ARRAY_BUFFER,this._rgbaBuffer),n.vertexAttribPointer(o.aColor,this._rgbaBuffer.itemSize,n.FLOAT,!1,0,0),this._drawElementsInstanced(t)}_drawElementsInstanced(t){let n=t.gl,s=t.uniforms,o=t.attributes,a=this._geoObjectHandler._renderer;n.bindBuffer(n.ARRAY_BUFFER,this._rtcPositionHighBuffer),n.vertexAttribPointer(o.aRTCPositionHigh,this._rtcPositionHighBuffer.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,this._rtcPositionLowBuffer),n.vertexAttribPointer(o.aRTCPositionLow,this._rtcPositionLowBuffer.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,this._normalsBuffer),n.vertexAttribPointer(o.aVertexNormal,this._normalsBuffer.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,this._vertexBuffer),n.vertexAttribPointer(o.aVertexPosition,this._vertexBuffer.itemSize,n.FLOAT,!1,0,0),n.activeTexture(n.TEXTURE0),n.bindTexture(n.TEXTURE_2D,this._colorTexture||a.handler.defaultTexture),n.uniform1i(s.uTexture,0),n.bindBuffer(n.ARRAY_BUFFER,this._texCoordBuffer),n.vertexAttribPointer(o.aTexCoord,this._texCoordBuffer.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,this._indicesBuffer),t.drawElementsInstanced(n.TRIANGLES,this._indicesBuffer.numItems,n.UNSIGNED_INT,0,this.numInstances)}async loadColorTexture(){if(this._geoObjectHandler._renderer){if(!this._colorTextureSrc)return this._colorTextureImage?(await this._colorTextureImage.decode(),void this._createColorTexture(this._colorTextureImage)):void 0;{const t=await Ui(this._colorTextureSrc);this._createColorTexture(t)}}}async loadNormalTexture(){if(this._geoObjectHandler._renderer){if(!this._normalTextureSrc)return this._normalTextureImage?(await this._normalTextureImage.decode(),void this._createNormalTexture(this._normalTextureImage)):void 0;{const t=await Ui(this._normalTextureSrc);this._createNormalTexture(t)}}}async loadMetallicRoughnessTexture(){if(this._geoObjectHandler._renderer){if(!this._metallicRoughnessTextureSrc)return this._metallicRoughnessTextureImage?(await this._metallicRoughnessTextureImage.decode(),void this._createMetallicRoughnessTexture(this._metallicRoughnessTextureImage)):void 0;{const t=await Ui(this._metallicRoughnessTextureSrc);this._createMetallicRoughnessTexture(t)}}}clear(){this.numInstances=0,this.geoObjects=[],this._sizeArr=[],this._translateArr=[],this._vertexArr=[],this._rtcPositionHighArr=[],this._rtcPositionLowArr=[],this._qRotArr=[],this._rgbaArr=[],this._normalsArr=[],this._indicesArr=[],this._pickingColorArr=[],this._visibleArr=[],this._texCoordArr=[],this._localPositionArr=[],this._deleteBuffers(),this.isFree=!1}_deleteBuffers(){if(this._geoObjectHandler&&this._geoObjectHandler._renderer){let t=this._geoObjectHandler._renderer.handler;if(t){t.deleteTexture(this._colorTexture),t.deleteTexture(this._normalTexture),t.deleteTexture(this._metallicRoughnessTexture);let n=t.gl;n&&(n.deleteBuffer(this._sizeBuffer),n.deleteBuffer(this._translateBuffer),n.deleteBuffer(this._vertexBuffer),n.deleteBuffer(this._rtcPositionHighBuffer),n.deleteBuffer(this._rtcPositionLowBuffer),n.deleteBuffer(this._qRotBuffer),n.deleteBuffer(this._rgbaBuffer),n.deleteBuffer(this._normalsBuffer),n.deleteBuffer(this._indicesBuffer),n.deleteBuffer(this._pickingColorBuffer),n.deleteBuffer(this._visibleBuffer),n.deleteBuffer(this._texCoordBuffer),n.deleteBuffer(this._localPositionBuffer))}this._colorTexture=null,this._normalTexture=null,this._metallicRoughnessTexture=null}this._sizeBuffer=null,this._translateBuffer=null,this._vertexBuffer=null,this._rtcPositionHighBuffer=null,this._rtcPositionLowBuffer=null,this._qRotBuffer=null,this._rgbaBuffer=null,this._normalsBuffer=null,this._indicesBuffer=null,this._pickingColorBuffer=null,this._visibleBuffer=null,this._texCoordBuffer=null,this._localPositionBuffer=null}createVertexBuffer(){const t=this._geoObjectHandler._renderer.handler;t.gl.deleteBuffer(this._vertexBuffer),this._vertexArr=st(this._vertexArr),this._vertexBuffer=t.createArrayBuffer(this._vertexArr,3,this._vertexArr.length/3)}createVisibleBuffer(){const t=this._geoObjectHandler._renderer.handler,n=this._visibleArr.length;this._visibleBuffer&&this._visibleBuffer.numItems===n||(t.gl.deleteBuffer(this._visibleBuffer),this._visibleBuffer=t.createStreamArrayBuffer(1,n)),this._visibleArr=st(this._visibleArr),t.setStreamArrayBuffer(this._visibleBuffer,this._visibleArr)}createSizeBuffer(){let t=this._geoObjectHandler._renderer.handler,n=this._sizeArr.length/3;this._sizeBuffer&&this._sizeBuffer.numItems===n||(t.gl.deleteBuffer(this._sizeBuffer),this._sizeBuffer=t.createStreamArrayBuffer(3,n)),this._sizeArr=st(this._sizeArr),t.setStreamArrayBuffer(this._sizeBuffer,this._sizeArr)}createTranslateBuffer(){let t=this._geoObjectHandler._renderer.handler,n=this._translateArr.length/3;this._translateBuffer&&this._translateBuffer.numItems===n||(t.gl.deleteBuffer(this._translateBuffer),this._translateBuffer=t.createStreamArrayBuffer(3,n)),this._translateArr=st(this._translateArr),t.setStreamArrayBuffer(this._translateBuffer,this._translateArr)}createLocalPositionBuffer(){let t=this._geoObjectHandler._renderer.handler,n=this._localPositionArr.length/3;this._localPositionBuffer&&this._localPositionBuffer.numItems===n||(t.gl.deleteBuffer(this._localPositionBuffer),this._localPositionBuffer=t.createStreamArrayBuffer(3,n)),this._localPositionArr=st(this._localPositionArr),t.setStreamArrayBuffer(this._localPositionBuffer,this._localPositionArr)}createTexCoordBuffer(){const t=this._geoObjectHandler._renderer.handler;t.gl.deleteBuffer(this._texCoordBuffer),this._texCoordArr=st(this._texCoordArr),this._texCoordBuffer=t.createArrayBuffer(this._texCoordArr,2,this._texCoordArr.length/2)}createRTCPositionBuffer(){let t=this._geoObjectHandler._renderer.handler,n=this._rtcPositionHighArr.length/3;this._rtcPositionHighBuffer&&this._rtcPositionHighBuffer.numItems===n||(t.gl.deleteBuffer(this._rtcPositionHighBuffer),t.gl.deleteBuffer(this._rtcPositionLowBuffer),this._rtcPositionHighBuffer=t.createStreamArrayBuffer(3,n),this._rtcPositionLowBuffer=t.createStreamArrayBuffer(3,n)),this._rtcPositionHighArr=st(this._rtcPositionHighArr),this._rtcPositionLowArr=st(this._rtcPositionLowArr),t.setStreamArrayBuffer(this._rtcPositionHighBuffer,this._rtcPositionHighArr),t.setStreamArrayBuffer(this._rtcPositionLowBuffer,this._rtcPositionLowArr)}createRgbaBuffer(){let t=this._geoObjectHandler._renderer.handler,n=this._rgbaArr.length/4;this._rgbaBuffer&&this._rgbaBuffer.numItems===n||(t.gl.deleteBuffer(this._rgbaBuffer),this._rgbaBuffer=t.createStreamArrayBuffer(4,n)),this._rgbaArr=st(this._rgbaArr),t.setStreamArrayBuffer(this._rgbaBuffer,this._rgbaArr)}createQRotBuffer(){let t=this._geoObjectHandler._renderer.handler,n=this._qRotArr.length/4;this._qRotBuffer&&this._qRotBuffer.numItems===n||(t.gl.deleteBuffer(this._qRotBuffer),this._qRotBuffer=t.createStreamArrayBuffer(4,n)),this._qRotArr=st(this._qRotArr),t.setStreamArrayBuffer(this._qRotBuffer,this._qRotArr)}createNormalsBuffer(){const t=this._geoObjectHandler._renderer.handler;t.gl.deleteBuffer(this._normalsBuffer),this._normalsArr=st(this._normalsArr),this._normalsBuffer=t.createArrayBuffer(this._normalsArr,3,this._normalsArr.length/3)}createIndicesBuffer(){const t=this._geoObjectHandler._renderer.handler;t.gl.deleteBuffer(this._indicesBuffer),this._indicesArr=st(this._indicesArr,Uint32Array),this._indicesBuffer=t.createElementArrayBuffer(this._indicesArr,1,this._indicesArr.length)}createPickingColorBuffer(){const t=this._geoObjectHandler._renderer.handler;t.gl.deleteBuffer(this._pickingColorBuffer),this._pickingColorArr=st(this._pickingColorArr),this._pickingColorBuffer=t.createArrayBuffer(this._pickingColorArr,3,this._pickingColorArr.length/3)}refresh(){let t=this._changedBuffers.length;for(;t--;)this._changedBuffers[t]=!0}update(){if(this._geoObjectHandler._renderer){let t=this._changedBuffers.length;for(;t--;)this._changedBuffers[t]&&(this._buffersUpdateCallbacks[t].call(this),this._changedBuffers[t]=!1);this.isFree=!0}}_createColorTexture(t){if(this._geoObjectHandler&&this._geoObjectHandler._renderer){let n=this._geoObjectHandler._renderer.handler;this._colorTexture=n.createTextureDefault(t,null,n.gl.REPEAT)}}_createNormalTexture(t){if(this._geoObjectHandler&&this._geoObjectHandler._renderer){let n=this._geoObjectHandler._renderer.handler;this._normalTexture=n.createTextureDefault(t,null,n.gl.REPEAT)}}_createMetallicRoughnessTexture(t){if(this._geoObjectHandler&&this._geoObjectHandler._renderer){let n=this._geoObjectHandler._renderer.handler;this._metallicRoughnessTexture=n.createTextureDefault(t,null,n.gl.REPEAT)}}}const Yo=0,Wo=1,$o=2,Xo=3,Zo=4,Ko=5,Qo=6,Jo=7,ta=8,ea=9,ia=10,sa=11;function Tt(l,t=0,n=0,s=1,...o){const a=t*n;for(let h=a,c=a+n;h<c;h++)l[h]=o[h%s];return l}const ws=class ad{constructor(t){this.__id=ad.__counter__++,this.pickingEnabled=!0,this._entityCollection=t,this._renderNode=null,this._renderer=null,this._geoObjects=[],this._instanceDataMap=new Map,this._instanceDataMapValues=[],this._dataTagUpdateQueue=[],this._relativeCenter=new v,this._rtcEyePositionHigh=new Float32Array([0,0,0]),this._rtcEyePositionLow=new Float32Array([0,0,0])}initProgram(){this._renderer&&(this._renderer.handler.programs.geo_object||this._renderer.handler.addProgram(new X("geo_object",{uniforms:{viewMatrix:"mat4",projectionMatrix:"mat4",uScaleByDistance:"vec3",eyePositionHigh:"vec3",eyePositionLow:"vec3",rtcEyePositionHigh:"vec3",rtcEyePositionLow:"vec3",sunPosition:"vec3",materialParams:"vec3",materialShininess:"float",uTexture:"sampler2d",uUseTexture:"float",useLighting:"float"},attributes:{aVertexPosition:"vec3",aVertexNormal:"vec3",aTexCoord:"vec2",aLocalPosition:{type:"vec3",divisor:1},aRTCPositionHigh:{type:"vec3",divisor:1},aRTCPositionLow:{type:"vec3",divisor:1},aColor:{type:"vec4",divisor:1},aScale:{type:"vec3",divisor:1},aTranslate:{type:"vec3",divisor:1},aDispose:{type:"float",divisor:1},qRot:{type:"vec4",divisor:1}},vertexShader:"precision highp float;vec3 qRotate(vec4 q,vec3 v){return v+2.0*cross(q.xyz,cross(q.xyz,v)+q.w*v);}attribute vec3 aVertexPosition;attribute vec3 aVertexNormal;attribute vec3 aRTCPositionHigh;attribute vec3 aRTCPositionLow;attribute vec4 aColor;attribute vec3 aScale;attribute vec3 aTranslate;attribute float aDispose;attribute float aUseTexture;attribute vec2 aTexCoord;attribute vec4 qRot;attribute vec3 aLocalPosition;uniform vec3 uScaleByDistance;uniform mat4 projectionMatrix;uniform mat4 viewMatrix;uniform vec3 eyePositionHigh;uniform vec3 eyePositionLow;uniform vec3 rtcEyePositionHigh;uniform vec3 rtcEyePositionLow;varying vec3 cameraPosition;varying vec3 vNormal;varying vec3 v_vertex;varying vec4 vColor;varying float vDispose;varying vec2 vTexCoords;void main(void){if(aDispose==0.0){return;}vColor=aColor;vTexCoords=aTexCoord;mat4 viewMatrixRTE=viewMatrix;viewMatrixRTE[3]=vec4(0.0,0.0,0.0,1.0);vec3 highDiff=aRTCPositionHigh-rtcEyePositionHigh;vec3 lowDiff=aRTCPositionLow-rtcEyePositionLow;cameraPosition=eyePositionHigh+eyePositionLow;highDiff=highDiff*step(1.0,length(highDiff));vec4 positionInViewSpace=viewMatrixRTE*vec4(highDiff+lowDiff,1.0);float lookLength=length(positionInViewSpace.xyz);vNormal=normalize(qRotate(qRot,aVertexNormal));float scd=uScaleByDistance[2]*clamp(lookLength,uScaleByDistance[0],uScaleByDistance[1])/uScaleByDistance[0];vec3 vert=qRotate(qRot,scd*(aVertexPosition*aScale+aTranslate))+scd*aLocalPosition;gl_Position=projectionMatrix*viewMatrixRTE*vec4(highDiff+lowDiff+vert,1.0);v_vertex=positionInViewSpace.xyz+vert;}",fragmentShader:"precision highp float;uniform vec3 sunPosition;uniform vec3 materialParams[3];uniform float materialShininess;uniform sampler2D uTexture;uniform float uUseTexture;uniform float useLighting;varying vec3 cameraPosition;varying vec3 v_vertex;varying vec4 vColor;varying vec3 vNormal;varying vec2 vTexCoords;void main(void){vec3 lightWeighting=vec3(1.0);if(useLighting!=0.0){vec3 normal=normalize(vNormal);vec3 light_dir=normalize(sunPosition);vec3 look_dir=normalize(cameraPosition-v_vertex);float diffuse=max(dot(normal,light_dir),0.0);vec3 refl_dir=reflect(-light_dir,normal);float refl=max(dot(refl_dir,look_dir),0.0);float specular=pow(refl,materialShininess)*step(1e-4,diffuse);lightWeighting=vColor.rgb*materialParams[0]+materialParams[1]*diffuse+materialParams[2]*specular;}else{lightWeighting=vColor.rgb;}if(uUseTexture>0.0){vec4 texColor=texture2D(uTexture,vTexCoords);gl_FragColor=vec4(texColor.rgb*lightWeighting,texColor.a);}else{gl_FragColor=vec4(lightWeighting,vColor.a);}}"})),this._renderer.handler.programs.geo_object_picking||this._renderer.handler.addProgram(new X("geo_object_picking",{uniforms:{viewMatrix:"mat4",projectionMatrix:"mat4",uScaleByDistance:"vec3",pickingScale:"vec3",rtcEyePositionHigh:"vec3",rtcEyePositionLow:"vec3"},attributes:{aVertexPosition:"vec3",aRTCPositionHigh:{type:"vec3",divisor:1},aRTCPositionLow:{type:"vec3",divisor:1},aPickingColor:{type:"vec3",divisor:1},aScale:{type:"vec3",divisor:1},aTranslate:{type:"vec3",divisor:1},aLocalPosition:{type:"vec3",divisor:1},aDispose:{type:"float",divisor:1},qRot:{type:"vec4",divisor:1}},vertexShader:"precision highp float;vec3 qRotate(vec4 q,vec3 v){return v+2.0*cross(q.xyz,cross(q.xyz,v)+q.w*v);}attribute vec3 aVertexPosition;attribute vec3 aRTCPositionHigh;attribute vec3 aRTCPositionLow;attribute vec3 aPickingColor;attribute vec3 aScale;attribute vec3 aTranslate;attribute float aDispose;attribute vec4 qRot;attribute vec3 aLocalPosition;uniform vec3 rtcEyePositionHigh;uniform vec3 rtcEyePositionLow;uniform vec3 uScaleByDistance;uniform mat4 projectionMatrix;uniform mat4 viewMatrix;uniform vec3 pickingScale;varying vec3 vColor;void main(void){if(aDispose==0.0){return;}vColor=aPickingColor;mat4 viewMatrixRTE=viewMatrix;viewMatrixRTE[3]=vec4(0.0,0.0,0.0,1.0);vec3 highDiff=aRTCPositionHigh-rtcEyePositionHigh;vec3 lowDiff=aRTCPositionLow-rtcEyePositionLow;highDiff=highDiff*step(1.0,length(highDiff));vec4 positionInViewSpace=viewMatrixRTE*vec4(highDiff+lowDiff,1.0);float lookLength=length(positionInViewSpace.xyz);float scd=uScaleByDistance[2]*clamp(lookLength,uScaleByDistance[0],uScaleByDistance[1])/uScaleByDistance[0];vec3 vert=qRotate(qRot,scd*pickingScale*(aVertexPosition*aScale+aTranslate))+scd*aLocalPosition;gl_Position=projectionMatrix*viewMatrixRTE*vec4(highDiff+lowDiff+vert,1.0);}",fragmentShader:"precision highp float;varying vec3 vColor;void main(){gl_FragColor=vec4(vColor,1.0);}"})),this._renderer.handler.programs.geo_object_depth||this._renderer.handler.addProgram(new X("geo_object_depth",{uniforms:{viewMatrix:"mat4",projectionMatrix:"mat4",uScaleByDistance:"vec3",rtcEyePositionHigh:"vec3",rtcEyePositionLow:"vec3",frustumPickingColor:"float"},attributes:{aVertexPosition:"vec3",aRTCPositionHigh:{type:"vec3",divisor:1},aRTCPositionLow:{type:"vec3",divisor:1},aScale:{type:"vec3",divisor:1},aTranslate:{type:"vec3",divisor:1},aDispose:{type:"float",divisor:1},qRot:{type:"vec4",divisor:1},aLocalPosition:{type:"vec3",divisor:1}},vertexShader:`#version 300 es
precision highp float;vec3 qRotate(vec4 q,vec3 v){return v+2.0*cross(q.xyz,cross(q.xyz,v)+q.w*v);}in vec3 aVertexPosition;in vec3 aRTCPositionHigh;in vec3 aRTCPositionLow;in vec3 aScale;in vec3 aTranslate;in float aDispose;in vec4 qRot;in vec3 aLocalPosition;uniform vec3 rtcEyePositionHigh;uniform vec3 rtcEyePositionLow;uniform vec3 uScaleByDistance;uniform mat4 projectionMatrix;uniform mat4 viewMatrix;void main(void){if(aDispose==0.0){return;}mat4 viewMatrixRTE=viewMatrix;viewMatrixRTE[3]=vec4(0.0,0.0,0.0,1.0);vec3 highDiff=aRTCPositionHigh-rtcEyePositionHigh;vec3 lowDiff=aRTCPositionLow-rtcEyePositionLow;highDiff=highDiff*step(1.0,length(highDiff));vec4 positionInViewSpace=viewMatrixRTE*vec4(highDiff+lowDiff,1.0);float lookLength=length(positionInViewSpace.xyz);float scd=uScaleByDistance[2]*clamp(lookLength,uScaleByDistance[0],uScaleByDistance[1])/uScaleByDistance[0];vec3 vert=qRotate(qRot,scd*(aVertexPosition*aScale+aTranslate))+scd*aLocalPosition;gl_Position=projectionMatrix*viewMatrixRTE*vec4(highDiff+lowDiff+vert,1.0);}`,fragmentShader:`#version 300 es
precision highp float;uniform float frustumPickingColor;layout(location=0)out vec4 frustumColor;layout(location=1)out vec4 depthColor;void main(){frustumColor=vec4(frustumPickingColor,frustumPickingColor,frustumPickingColor,1.0);depthColor=vec4(gl_FragCoord.z,gl_FragCoord.z,gl_FragCoord.z,1.0);}`})))}setRenderNode(t){this._renderNode=t,this._renderer=t.renderer,this.initProgram();for(let n=0;n<this._instanceDataMapValues.length;n++)this._instanceDataMapValues[n].loadColorTexture(),this._instanceDataMapValues[n].loadNormalTexture(),this._instanceDataMapValues[n].loadMetallicRoughnessTexture();for(let n=0;n<this._geoObjects.length;n++)this._geoObjects[n].updateRotation();this.update()}setColorTextureTag(t,n){const s=this._instanceDataMap.get(n);s&&(typeof t=="string"&&(s._colorTextureSrc=t,s._colorTextureImage=null),t instanceof HTMLImageElement&&(s._colorTextureSrc=null,s._colorTextureImage=t),this._instanceDataMap.set(n,s),s.loadColorTexture())}setNormalTextureTag(t,n){const s=this._instanceDataMap.get(n);s&&(typeof t=="string"&&(s._normalTextureSrc=t,s._normalTextureImage=null),t instanceof HTMLImageElement&&(s._normalTextureSrc=null,s._normalTextureImage=t),this._instanceDataMap.set(n,s),s.loadNormalTexture())}setMetallicRoughnessTextureTag(t,n){const s=this._instanceDataMap.get(n);s&&(typeof t=="string"&&(s._metallicRoughnessTextureSrc=t,s._metallicRoughnessTextureImage=null),t instanceof HTMLImageElement&&(s._metallicRoughnessTextureSrc=null,s._metallicRoughnessTextureImage=t),this._instanceDataMap.set(n,s),s.loadMetallicRoughnessTexture())}setObjectSrc(t,n){const s=this._instanceDataMap.get(n);t&&s&&s._objectSrc!==t&&(s._objectSrc=t,$.loadObj(t).then(o=>{this._updateInstanceData(o[0],n)}))}_updateInstanceData(t,n){const s=this._instanceDataMap.get(n);s&&(t.vertices.length!==s._vertexArr.length&&(s._vertexArr=t.vertices,s._changedBuffers[Yo]=!0),t.normals.length!==s._normalsArr.length&&(s._normalsArr=t.normals,s._changedBuffers[Xo]=!0),t.indices.length!==s._indicesArr.length&&(s._indicesArr=t.indices,s._changedBuffers[Zo]=!0),t.texCoords.length!==s._texCoordArr.length&&(s._texCoordArr=t.texCoords,s._changedBuffers[ea]=!0),s._colorTextureSrc=t.colorTextureSrc,s._normalTextureSrc=t.normalTextureSrc,s._metallicRoughnessTexture=t.metallicRoughnessTextureSrc,s._colorTextureImage=t.colorTextureImage,s._normalTextureImage=t.normalTextureImage,s._metallicRoughnessTextureImage=t.metallicRoughnessTextureImage,s.loadColorTexture(),s.loadNormalTexture(),s.loadMetallicRoughnessTexture(),this._updateTag(s),this._instanceDataMapValues=Array.from(this._instanceDataMap.values()))}_addGeoObjectToArray(t){const n=t.tag;let s=this._instanceDataMap.get(n);s||(s=new rl(this),this._instanceDataMap.set(n,s),this._instanceDataMapValues=Array.from(this._instanceDataMap.values()),s._vertexArr=t.vertices,s._normalsArr=t.normals,s._indicesArr=t.indices,s._texCoordArr=t.texCoords,s._colorTextureSrc=t.object3d.colorTextureSrc,s._normalTextureSrc=t.object3d.normalTextureSrc,s._metallicRoughnessTextureSrc=t.object3d.metallicRoughnessTextureSrc,s._colorTextureImage=t.object3d.colorTextureImage,s._normalTextureImage=t.object3d.normalTextureImage,s._metallicRoughnessTextureImage=t.object3d.metallicRoughnessTextureImage,s.setMaterialParams(t.object3d.ambient,t.object3d.diffuse,t.object3d.specular,t.object3d.shininess),s.loadColorTexture(),s.loadNormalTexture(),s.loadMetallicRoughnessTexture()),t._tagDataIndex=s.numInstances++,t._tagData=s,s.geoObjects.push(t);let o=3;s._visibleArr=bt(s._visibleArr,Tt([],0,1,1,t.getVisibility()?1:0)),this.getRTCPosition(t.getPosition(),t._rtcPositionHigh,t._rtcPositionLow);let a,h=t._rtcPositionHigh.x,c=t._rtcPositionHigh.y,u=t._rtcPositionHigh.z;s._rtcPositionHighArr=bt(s._rtcPositionHighArr,Tt([],0,o,o,h,c,u)),h=t._rtcPositionLow.x,c=t._rtcPositionLow.y,u=t._rtcPositionLow.z,s._rtcPositionLowArr=bt(s._rtcPositionLowArr,Tt([],0,o,o,h,c,u)),h=t._entity._pickingColor.x/255,c=t._entity._pickingColor.y/255,u=t._entity._pickingColor.z/255,s._pickingColorArr=bt(s._pickingColorArr,Tt([],0,o,o,h,c,u)),o=4,h=t._qRot.x,c=t._qRot.y,u=t._qRot.z,a=t._qRot.w,s._qRotArr=bt(s._qRotArr,Tt([],0,o,o,h,c,u,a)),h=t._color.x,c=t._color.y,u=t._color.z,a=t._color.w,s._rgbaArr=bt(s._rgbaArr,Tt([],0,o,o,h,c,u,a)),o=3;let d=t.getScale();h=d.x,c=d.y,u=d.z,s._sizeArr=bt(s._sizeArr,Tt([],0,o,o,h,c,u));let f=t.getTranslate();h=f.x,c=f.y,u=f.z,s._translateArr=bt(s._translateArr,Tt([],0,o,o,h,c,u));let g=t.getLocalPosition();h=g.x,c=g.y,u=g.z,s._localPositionArr=bt(s._localPositionArr,Tt([],0,o,o,h,c,u))}_bindCommon(){let t=this._renderer,n=t.handler.programs.geo_object._program.uniforms,s=t.handler.gl,o=this._entityCollection;s.uniform3fv(n.uScaleByDistance,o.scaleByDistance),s.uniform1f(n.useLighting,o._useLighting),s.uniform3fv(n.eyePositionHigh,t.activeCamera.eyeHigh),s.uniform3fv(n.eyePositionLow,t.activeCamera.eyeLow),s.uniform3fv(n.rtcEyePositionHigh,this._rtcEyePositionHigh),s.uniform3fv(n.rtcEyePositionLow,this._rtcEyePositionLow),s.uniformMatrix4fv(n.projectionMatrix,!1,t.activeCamera.getProjectionMatrix()),s.uniformMatrix4fv(n.viewMatrix,!1,t.activeCamera.getViewMatrix()),s.uniform3fv(n.sunPosition,this._renderNode._lightPosition)}_displayOpaquePASS(){let t=this._renderer.handler.programs.geo_object,n=t._program;t.activate(),this._bindCommon();for(let s=0;s<this._instanceDataMapValues.length;s++)this._instanceDataMapValues[s].drawOpaque(n)}_displayTransparentPASS(){let t=this._renderer.handler.programs.geo_object,n=t._program;t.activate(),this._bindCommon();for(let s=0;s<this._instanceDataMapValues.length;s++)this._instanceDataMapValues[s].drawTransparent(n)}_depthPASS(){let t=this._renderer,n=t.handler.programs.geo_object_depth,s=n._program,o=s.uniforms,a=s.attributes,h=t.handler.gl,c=this._entityCollection,u=t.activeCamera;n.activate(),h.uniform3fv(o.uScaleByDistance,c.scaleByDistance),h.uniform3fv(o.rtcEyePositionHigh,this._rtcEyePositionHigh),h.uniform3fv(o.rtcEyePositionLow,this._rtcEyePositionLow),h.uniformMatrix4fv(o.projectionMatrix,!1,t.activeCamera.getProjectionMatrix()),h.uniformMatrix4fv(o.viewMatrix,!1,t.activeCamera.getViewMatrix()),h.uniform1f(o.frustumPickingColor,u.frustumColorIndex);for(let d=0;d<this._instanceDataMapValues.length;d++){let f=this._instanceDataMapValues[d];h.bindBuffer(h.ARRAY_BUFFER,f._qRotBuffer),h.vertexAttribPointer(a.qRot,f._qRotBuffer.itemSize,h.FLOAT,!1,0,0),h.bindBuffer(h.ARRAY_BUFFER,f._sizeBuffer),h.vertexAttribPointer(a.aScale,f._sizeBuffer.itemSize,h.FLOAT,!1,0,0),h.bindBuffer(h.ARRAY_BUFFER,f._translateBuffer),h.vertexAttribPointer(a.aTranslate,f._translateBuffer.itemSize,h.FLOAT,!1,0,0),h.bindBuffer(h.ARRAY_BUFFER,f._localPositionBuffer),h.vertexAttribPointer(a.aLocalPosition,f._localPositionBuffer.itemSize,h.FLOAT,!1,0,0),h.bindBuffer(h.ARRAY_BUFFER,f._rtcPositionHighBuffer),h.vertexAttribPointer(a.aRTCPositionHigh,f._rtcPositionHighBuffer.itemSize,h.FLOAT,!1,0,0),h.bindBuffer(h.ARRAY_BUFFER,f._rtcPositionLowBuffer),h.vertexAttribPointer(a.aRTCPositionLow,f._rtcPositionLowBuffer.itemSize,h.FLOAT,!1,0,0),h.bindBuffer(h.ARRAY_BUFFER,f._visibleBuffer),h.vertexAttribPointer(a.aDispose,f._visibleBuffer.itemSize,h.FLOAT,!1,0,0),h.bindBuffer(h.ARRAY_BUFFER,f._vertexBuffer),h.vertexAttribPointer(a.aVertexPosition,f._vertexBuffer.itemSize,h.FLOAT,!1,0,0),h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,f._indicesBuffer),s.drawElementsInstanced(h.TRIANGLES,f._indicesBuffer.numItems,h.UNSIGNED_INT,0,f.numInstances)}}drawDepth(){this._geoObjects.length&&this._depthPASS()}drawPicking(){this._geoObjects.length&&this.pickingEnabled&&this._pickingPASS()}_pickingPASS(){let t=this._renderer,n=t.handler.programs.geo_object_picking,s=n._program,o=s.uniforms,a=s.attributes,h=t.handler.gl,c=this._entityCollection;n.activate(),h.uniform3fv(o.uScaleByDistance,c.scaleByDistance),h.uniform3fv(o.pickingScale,c.pickingScale),h.uniform3fv(o.rtcEyePositionHigh,this._rtcEyePositionHigh),h.uniform3fv(o.rtcEyePositionLow,this._rtcEyePositionLow),h.uniformMatrix4fv(o.projectionMatrix,!1,t.activeCamera.getProjectionMatrix()),h.uniformMatrix4fv(o.viewMatrix,!1,t.activeCamera.getViewMatrix());for(let u=0;u<this._instanceDataMapValues.length;u++){let d=this._instanceDataMapValues[u];h.bindBuffer(h.ARRAY_BUFFER,d._qRotBuffer),h.vertexAttribPointer(a.qRot,d._qRotBuffer.itemSize,h.FLOAT,!1,0,0),h.bindBuffer(h.ARRAY_BUFFER,d._sizeBuffer),h.vertexAttribPointer(a.aScale,d._sizeBuffer.itemSize,h.FLOAT,!1,0,0),h.bindBuffer(h.ARRAY_BUFFER,d._translateBuffer),h.vertexAttribPointer(a.aTranslate,d._translateBuffer.itemSize,h.FLOAT,!1,0,0),h.bindBuffer(h.ARRAY_BUFFER,d._localPositionBuffer),h.vertexAttribPointer(a.aLocalPosition,d._localPositionBuffer.itemSize,h.FLOAT,!1,0,0),h.bindBuffer(h.ARRAY_BUFFER,d._pickingColorBuffer),h.vertexAttribPointer(a.aPickingColor,d._pickingColorBuffer.itemSize,h.FLOAT,!1,0,0),h.bindBuffer(h.ARRAY_BUFFER,d._rtcPositionHighBuffer),h.vertexAttribPointer(a.aRTCPositionHigh,d._rtcPositionHighBuffer.itemSize,h.FLOAT,!1,0,0),h.bindBuffer(h.ARRAY_BUFFER,d._rtcPositionLowBuffer),h.vertexAttribPointer(a.aRTCPositionLow,d._rtcPositionLowBuffer.itemSize,h.FLOAT,!1,0,0),h.bindBuffer(h.ARRAY_BUFFER,d._visibleBuffer),h.vertexAttribPointer(a.aDispose,d._visibleBuffer.itemSize,h.FLOAT,!1,0,0),h.bindBuffer(h.ARRAY_BUFFER,d._vertexBuffer),h.vertexAttribPointer(a.aVertexPosition,d._vertexBuffer.itemSize,h.FLOAT,!1,0,0),h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,d._indicesBuffer),s.drawElementsInstanced(h.TRIANGLES,d._indicesBuffer.numItems,h.UNSIGNED_INT,0,d.numInstances)}}setQRotArr(t,n,s){Tt(t._qRotArr,n,4,4,s.x,s.y,s.z,s.w),t._changedBuffers[Ko]=!0,this._updateTag(t)}setVisibility(t,n,s){Tt(t._visibleArr,n,1,1,s?1:0),t._changedBuffers[ta]=!0,this._updateTag(t)}setRTCPositionArr(t,n,s,o){Tt(t._rtcPositionHighArr,n,3,3,s.x,s.y,s.z),Tt(t._rtcPositionLowArr,n,3,3,o.x,o.y,o.z),t._changedBuffers[Wo]=!0,this._updateTag(t)}setRgbaArr(t,n,s){Tt(t._rgbaArr,n,4,4,s.x,s.y,s.z,s.w),t._changedBuffers[$o]=!0,this._updateTag(t)}setPickingColorArr(t,n,s){Tt(t._pickingColorArr,n,3,3,s.x/255,s.y/255,s.z/255),t._changedBuffers[Jo]=!0,this._updateTag(t)}setScaleArr(t,n,s){Tt(t._sizeArr,n,3,3,s.x,s.y,s.z),t._changedBuffers[Qo]=!0,this._updateTag(t)}setTranslateArr(t,n,s){Tt(t._translateArr,n,3,3,s.x,s.y,s.z),t._changedBuffers[ia]=!0,this._updateTag(t)}setLocalPositionArr(t,n,s){Tt(t._localPositionArr,n,3,3,s.x,s.y,s.z),t._changedBuffers[sa]=!0,this._updateTag(t)}_updateTag(t){t.isFree&&(t.isFree=!1,this._dataTagUpdateQueue.push(t))}update(){for(let t=0,n=this._dataTagUpdateQueue.length;t<n;t++)this._dataTagUpdateQueue[t].update();this._dataTagUpdateQueue=[]}_removeAll(){let t=this._geoObjects.length;for(;t--;){const n=this._geoObjects[t];n._tagDataIndex=-1,n._tagData=null,n._handlerIndex=-1,n._handler=null}this._geoObjects.length=0,this._geoObjects=[];for(let n=0;n<this._instanceDataMapValues.length;n++)this._instanceDataMapValues[n].clear();this._instanceDataMap.clear(),this._instanceDataMapValues=[]}clear(){this._removeAll()}getRTCPosition(t,n,s){let o=t.sub(this._relativeCenter);v.doubleToTwoFloats(o,n,s)}setRelativeCenter(t){this._relativeCenter.copy(t);for(let n=0;n<this._instanceDataMapValues.length;n++){let s=this._instanceDataMapValues[n].geoObjects;for(let o=0;o<s.length;o++)s[o].updateRTCPosition()}}_updateRTCEyePosition(){let t=this._renderer;if(t.activeCamera.isFirstPass){let n=t.activeCamera.eye.sub(this._relativeCenter);v.doubleToTwoFloat32Array(n,this._rtcEyePositionHigh,this._rtcEyePositionLow)}}draw(){this._geoObjects.length&&(this._updateRTCEyePosition(),this.update(),this._displayOpaquePASS())}drawTransparent(){this._geoObjects.length&&this._displayTransparentPASS()}add(t){t._handlerIndex===-1&&(t._handler=this,t._handlerIndex=this._geoObjects.length,this._geoObjects.push(t),this._addGeoObjectToArray(t),t.updateRotation(),t._tagData.refresh(),this._updateTag(t._tagData),t.setObjectSrc(t._objectSrc))}remove(t){t._handler&&this.__id==t._handler.__id&&this._removeGeoObject(t)}_clearDataTagQueue(){this._dataTagUpdateQueue=[]}_removeGeoObject(t){let n=t._tagData,s=t.tag;n.numInstances--;let o=!1;if(n.numInstances===0){n.clear(),this._instanceDataMap.delete(s);for(let h=0;this._instanceDataMapValues.length;h++)if(this._instanceDataMapValues[h].numInstances===0){this._instanceDataMapValues.splice(h,1);break}this._clearDataTagQueue(),o=!0}this._geoObjects.splice(t._handlerIndex,1);for(let h=t._handlerIndex,c=this._geoObjects.length;h<c;h++){let u=this._geoObjects[h];u._handlerIndex=u._handlerIndex-1}let a=t._tagDataIndex;n.geoObjects.splice(a,1);for(let h=t._tagDataIndex,c=n.geoObjects.length;h<c;h++){let u=n.geoObjects[h];u._tagDataIndex=u._tagDataIndex-1}n._rgbaArr=Et(n._rgbaArr,4*a,4),n._rtcPositionHighArr=Et(n._rtcPositionHighArr,3*a,3),n._rtcPositionLowArr=Et(n._rtcPositionLowArr,3*a,3),n._qRotArr=Et(n._qRotArr,4*a,4),n._pickingColorArr=Et(n._pickingColorArr,3*a,3),n._sizeArr=Et(n._sizeArr,3*a,3),n._translateArr=Et(n._translateArr,3*a,3),n._localPositionArr=Et(n._localPositionArr,3*a,3),n._visibleArr=Et(n._visibleArr,a,1),t._handlerIndex=-1,t._handler=null,t._tagDataIndex=-1,t._tagData=null,o||(n.refresh(),this._updateTag(n))}};ws.__counter__=0;let Ar=ws;class nl extends ns{constructor(t,n=21){super(t),this._billboards=[],this._gliphParamBuffer=null,this._fontIndexBuffer=null,this._outlineBuffer=null,this._outlineColorBuffer=null,this._gliphParamArr=new Float32Array([]),this._fontIndexArr=new Float32Array([]),this._outlineArr=new Float32Array([]),this._outlineColorArr=new Float32Array([]),this._buffersUpdateCallbacks[8]=this.createFontIndexBuffer,this._buffersUpdateCallbacks[9]=this.createOutlineBuffer,this._buffersUpdateCallbacks[10]=this.createOutlineColorBuffer,this._changedBuffers=new Array(this._buffersUpdateCallbacks.length),this._maxLetters=n}initProgram(){this._renderer&&this._renderer.handler&&this._renderer.handler.gl&&(this._renderer.handler.programs.label||(this._renderer.handler.gl.type==="webgl2"?this._renderer.handler.addProgram(new X("label",{uniforms:{viewport:"vec2",fontTextureArr:"sampler2darray",sdfParamsArr:"vec4",projectionMatrix:"mat4",viewMatrix:"mat4",eyePositionHigh:"vec3",eyePositionLow:"vec3",planetRadius:"float",scaleByDistance:"vec3",opacity:"float",isOutlinePass:"int",depthOffset:"float"},attributes:{a_outline:"float",a_gliphParam:"vec4",a_vertices:"vec2",a_texCoord:"vec4",a_positionsHigh:"vec3",a_positionsLow:"vec3",a_size:"float",a_rotation:"float",a_rgba:"vec4",a_offset:"vec3",a_fontIndex:"float"},vertexShader:`#version 300 es
#define EMPTY - 1.0
#define RTL 1.0
vec2 project(vec4 p,vec2 viewport){return(0.5*p.xyz/p.w+0.5).xy*viewport;}mat2 rotate2d(float angle){return mat2(cos(angle),-sin(angle),sin(angle),cos(angle));}in float a_outline;in vec4 a_gliphParam;in vec2 a_vertices;in vec4 a_texCoord;in vec3 a_positionsHigh;in vec3 a_positionsLow;in vec3 a_offset;in float a_size;in float a_rotation;in vec4 a_rgba;in float a_fontIndex;out vec2 v_uv;out vec4 v_rgba;flat out int v_fontIndex;out vec4 v_outlineColor;flat out float v_outline;uniform vec2 viewport;uniform mat4 viewMatrix;uniform mat4 projectionMatrix;uniform vec3 eyePositionHigh;uniform vec3 eyePositionLow;uniform float planetRadius;uniform vec3 scaleByDistance;uniform float opacity;uniform float depthOffset;const vec3 ZERO3=vec3(0.0);void main(){if(a_texCoord.w==EMPTY){gl_Position=vec4(0.0);v_fontIndex=-1;return;}vec3 a_positions=a_positionsHigh+a_positionsLow;vec3 cameraPos=eyePositionHigh+eyePositionLow;v_outline=a_outline;v_fontIndex=int(a_fontIndex);v_uv=a_texCoord.xy;vec3 look=a_positions-cameraPos;float lookDist=length(look);v_rgba=a_rgba;if(opacity*step(lookDist,sqrt(dot(cameraPos,cameraPos)-planetRadius)+sqrt(dot(a_positions,a_positions)-planetRadius))==0.0){return;}float scd=(1.0-smoothstep(scaleByDistance[0],scaleByDistance[1],lookDist))*(1.0-step(scaleByDistance[2],lookDist));v_rgba.a*=opacity;mat4 viewMatrixRTE=viewMatrix;viewMatrixRTE[3]=vec4(0.0,0.0,0.0,1.0);vec3 highDiff=a_positionsHigh-eyePositionHigh;vec3 lowDiff=a_positionsLow-eyePositionLow;vec4 posRTE=viewMatrixRTE*vec4(highDiff+lowDiff,1.0);vec4 projPos=projectionMatrix*posRTE;float camSlope=dot(vec3(viewMatrix[0][2],viewMatrix[1][2],viewMatrix[2][2]),normalize(cameraPos));if(camSlope>0.5){float dist=dot(look,normalize(cameraPos));projPos.z+=dist*0.02;}else{projPos.z+=-(abs(projPos.z))*0.002;}projPos.z+=depthOffset+a_offset.z;vec2 screenPos=project(projPos,viewport);vec2 vert=a_vertices;vec4 gp=a_gliphParam;if(a_texCoord.w==RTL){vert.x=step(vert.x*0.5+1.0,1.0);gp.x=-a_gliphParam.x;gp.z=-(a_gliphParam.z+a_texCoord.z);}else{gp.z=a_gliphParam.z+a_texCoord.z;}vec2 v=screenPos+rotate2d(a_rotation)*((vert*gp.xy+gp.zw)*a_size*scd+a_offset.xy);gl_Position=vec4((2.0*v/viewport-1.0)*projPos.w,projPos.z,projPos.w);}`,fragmentShader:`#version 300 es
uniform int isOutlinePass;precision highp float;const int MAX_SIZE=11;uniform sampler2D fontTextureArr[MAX_SIZE];uniform vec4 sdfParamsArr[MAX_SIZE];flat in int v_fontIndex;in vec2 v_uv;in vec4 v_rgba;flat in float v_outline;in vec3 v_pickingColor;layout(location=0)out vec4 outScreen;float median(float r,float g,float b){return max(min(r,g),min(max(r,g),b));}float getDistance(){vec3 msdf;if(v_fontIndex==0){msdf=texture(fontTextureArr[0],v_uv).rgb;}else if(v_fontIndex==1){msdf=texture(fontTextureArr[1],v_uv).rgb;}else if(v_fontIndex==2){msdf=texture(fontTextureArr[2],v_uv).rgb;}else if(v_fontIndex==3){msdf=texture(fontTextureArr[3],v_uv).rgb;}else if(v_fontIndex==4){msdf=texture(fontTextureArr[4],v_uv).rgb;}else if(v_fontIndex==5){msdf=texture(fontTextureArr[5],v_uv).rgb;}else if(v_fontIndex==6){msdf=texture(fontTextureArr[6],v_uv).rgb;}else if(v_fontIndex==7){msdf=texture(fontTextureArr[7],v_uv).rgb;}else if(v_fontIndex==8){msdf=texture(fontTextureArr[8],v_uv).rgb;}else if(v_fontIndex==9){msdf=texture(fontTextureArr[9],v_uv).rgb;}else if(v_fontIndex==10){msdf=texture(fontTextureArr[10],v_uv).rgb;}return median(msdf.r,msdf.g,msdf.b);}void main(){if(v_fontIndex==-1){return;}vec4 sdfParams=sdfParamsArr[v_fontIndex];float sd=getDistance();vec2 dxdy=fwidth(v_uv)*sdfParams.xy;if(isOutlinePass==0){float dist=sd+min(0.001,0.5-1.0/sdfParams.w)-0.5;float opacity=clamp(dist*sdfParams.w/length(dxdy)+0.5,0.0,1.0);if(opacity<=0.1){discard;}outScreen=vec4(v_rgba.rgb,opacity*v_rgba.a);}else{float dist=sd+min(v_outline,0.5-1.0/sdfParams.w)-0.5;float opacity=clamp(dist*sdfParams.w/length(dxdy)+0.5,0.0,1.0);if(opacity<=0.1){discard;}outScreen=vec4(v_rgba.rgb,opacity*v_rgba.a);}}`})):this._renderer.handler.addProgram(new X("label",{uniforms:{viewport:"vec2",fontTextureArr:"sampler2darray",sdfParamsArr:"vec4",projectionMatrix:"mat4",viewMatrix:"mat4",eyePositionHigh:"vec3",eyePositionLow:"vec3",planetRadius:"float",scaleByDistance:"vec3",opacity:"float",isOutlinePass:"int",depthOffset:"float"},attributes:{a_outline:"float",a_gliphParam:"vec4",a_vertices:"vec2",a_texCoord:"vec4",a_positionsHigh:"vec3",a_positionsLow:"vec3",a_size:"float",a_rotation:"float",a_rgba:"vec4",a_offset:"vec3",a_fontIndex:"float"},vertexShader:`#define EMPTY - 1.0
#define RTL 1.0
vec2 project(vec4 p,vec2 viewport){return(0.5*p.xyz/p.w+0.5).xy*viewport;}mat2 rotate2d(float angle){return mat2(cos(angle),-sin(angle),sin(angle),cos(angle));}attribute float a_outline;attribute vec4 a_gliphParam;attribute vec2 a_vertices;attribute vec4 a_texCoord;attribute vec3 a_positionsHigh;attribute vec3 a_positionsLow;attribute vec3 a_offset;attribute float a_size;attribute float a_rotation;attribute vec4 a_rgba;attribute float a_fontIndex;varying float v_outline;varying vec2 v_uv;varying vec4 v_rgba;varying float v_fontIndex;uniform vec2 viewport;uniform mat4 viewMatrix;uniform mat4 projectionMatrix;uniform vec3 eyePositionHigh;uniform vec3 eyePositionLow;uniform float planetRadius;uniform vec3 scaleByDistance;uniform float opacity;uniform float depthOffset;const vec3 ZERO3=vec3(0.0);void main(){if(a_texCoord.w==EMPTY){gl_Position=vec4(0.0);v_fontIndex=-1.0;return;}vec3 a_positions=a_positionsHigh+a_positionsLow;vec3 cameraPos=eyePositionHigh+eyePositionLow;v_outline=a_outline;v_uv=vec2(a_texCoord.xy);v_rgba=a_rgba;v_fontIndex=a_fontIndex;vec3 look=a_positions-cameraPos;float lookDist=length(look);if(opacity*step(lookDist,sqrt(dot(cameraPos,cameraPos)-planetRadius)+sqrt(dot(a_positions,a_positions)-planetRadius))==0.0){return;}float scd=(1.0-smoothstep(scaleByDistance[0],scaleByDistance[1],lookDist))*(1.0-step(scaleByDistance[2],lookDist));v_rgba.a*=opacity;mat4 viewMatrixRTE=viewMatrix;viewMatrixRTE[3]=vec4(0.0,0.0,0.0,1.0);vec3 highDiff=a_positionsHigh-eyePositionHigh;vec3 lowDiff=a_positionsLow-eyePositionLow;vec4 posRTE=viewMatrixRTE*vec4(highDiff+lowDiff,1.0);vec4 projPos=projectionMatrix*posRTE;float camSlope=dot(vec3(viewMatrix[0][2],viewMatrix[1][2],viewMatrix[2][2]),normalize(cameraPos));if(camSlope>0.5){float dist=dot(look,normalize(cameraPos));projPos.z+=dist*0.02;}else{projPos.z+=-(abs(projPos.z))*0.002;}projPos.z+=depthOffset+a_offset.z;vec2 screenPos=project(projPos,viewport);vec2 vert=a_vertices;vec4 gp=a_gliphParam;if(a_texCoord.w==RTL){vert.x=step(vert.x*0.5+1.0,1.0);gp.x=-a_gliphParam.x;gp.z=-(a_gliphParam.z+a_texCoord.z);}else{gp.z=a_gliphParam.z+a_texCoord.z;}vec2 v=screenPos+rotate2d(a_rotation)*((vert*gp.xy+gp.zw)*a_size*scd+a_offset.xy);gl_Position=vec4((2.0*v/viewport-1.0)*projPos.w,projPos.z,projPos.w);}`,fragmentShader:`#extension GL_OES_standard_derivatives: enable
precision highp float;precision highp int;const int MAX_SIZE=11;uniform sampler2D fontTextureArr[MAX_SIZE];uniform vec4 sdfParamsArr[MAX_SIZE];uniform int isOutlinePass;varying float v_outline;varying vec2 v_uv;varying vec4 v_rgba;varying float v_fontIndex;float fontIndex;float median(float r,float g,float b){return max(min(r,g),min(max(r,g),b));}float getDistance(){vec3 msdf;if(fontIndex>=0.0&&fontIndex<1.0){msdf=texture2D(fontTextureArr[0],v_uv).rgb;}else if(fontIndex>=1.0&&fontIndex<2.0){msdf=texture2D(fontTextureArr[1],v_uv).rgb;}else if(fontIndex>=2.0&&fontIndex<3.0){msdf=texture2D(fontTextureArr[2],v_uv).rgb;}else if(fontIndex>=3.0&&fontIndex<4.0){msdf=texture2D(fontTextureArr[3],v_uv).rgb;}else if(fontIndex>=4.0&&fontIndex<5.0){msdf=texture2D(fontTextureArr[4],v_uv).rgb;}else if(fontIndex>=5.0&&fontIndex<6.0){msdf=texture2D(fontTextureArr[5],v_uv).rgb;}else if(fontIndex>=6.0&&fontIndex<7.0){msdf=texture2D(fontTextureArr[6],v_uv).rgb;}else if(fontIndex>=7.0&&fontIndex<8.0){msdf=texture2D(fontTextureArr[7],v_uv).rgb;}else if(fontIndex>=8.0&&fontIndex<9.0){msdf=texture2D(fontTextureArr[8],v_uv).rgb;}else if(fontIndex>=9.0&&fontIndex<10.0){msdf=texture2D(fontTextureArr[9],v_uv).rgb;}else if(fontIndex>=10.0&&fontIndex<11.0){msdf=texture2D(fontTextureArr[10],v_uv).rgb;}return median(msdf.r,msdf.g,msdf.b);}vec4 getSDFParams(){if(fontIndex>=0.0&&fontIndex<1.0){return sdfParamsArr[0];}else if(fontIndex>=1.0&&fontIndex<2.0){return sdfParamsArr[1];}else if(fontIndex>=2.0&&fontIndex<3.0){return sdfParamsArr[2];}else if(fontIndex>=3.0&&fontIndex<4.0){return sdfParamsArr[3];}else if(fontIndex>=4.0&&fontIndex<5.0){return sdfParamsArr[4];}else if(fontIndex>=5.0&&fontIndex<6.0){return sdfParamsArr[5];}else if(fontIndex>=6.0&&fontIndex<7.0){return sdfParamsArr[6];}else if(fontIndex>=7.0&&fontIndex<8.0){return sdfParamsArr[7];}else if(fontIndex>=8.0&&fontIndex<9.0){return sdfParamsArr[8];}else if(fontIndex>=9.0&&fontIndex<10.0){return sdfParamsArr[9];}else if(fontIndex>=10.0&&fontIndex<11.0){return sdfParamsArr[10];}}void main(){fontIndex=v_fontIndex+0.1;if(v_fontIndex<0.0){return;}vec4 sdfParams=getSDFParams();float sd=getDistance();vec2 dxdy=fwidth(v_uv)*sdfParams.xy;float dist=sd+min(0.001,0.5-1.0/sdfParams.w)-0.5;float opacity=clamp(dist*sdfParams.w/length(dxdy)+0.5,0.0,1.0);if(isOutlinePass==0){}else{float strokeDist=sd+min(v_outline,0.5-1.0/sdfParams.w)-0.5;float strokeAlpha=v_rgba.a*clamp(strokeDist*sdfParams.w/length(dxdy)+0.5,0.0,1.0);if(strokeAlpha<0.1){discard;}}}`}))),this._renderer.handler.programs.labelPicking||this._renderer.handler.addProgram(new X("labelPicking",{uniforms:{viewport:"vec2",projectionMatrix:"mat4",viewMatrix:"mat4",eyePositionHigh:"vec3",eyePositionLow:"vec3",planetRadius:"float",scaleByDistance:"vec3",opacity:"float",depthOffset:"float"},attributes:{a_gliphParam:"vec4",a_vertices:"vec2",a_texCoord:"vec4",a_positionsHigh:"vec3",a_positionsLow:"vec3",a_offset:"vec3",a_size:"float",a_rotation:"float",a_rgba:"vec4"},vertexShader:`#define EMPTY - 1.0
#define RTL 1.0
vec2 project(vec4 p,vec2 viewport){return(0.5*p.xyz/p.w+0.5).xy*viewport;}mat2 rotate2d(float angle){return mat2(cos(angle),-sin(angle),sin(angle),cos(angle));}attribute vec4 a_gliphParam;attribute vec2 a_vertices;attribute vec4 a_texCoord;attribute vec3 a_positionsHigh;attribute vec3 a_positionsLow;attribute vec3 a_offset;attribute float a_size;attribute float a_rotation;attribute vec4 a_rgba;varying vec4 v_rgba;uniform vec2 viewport;uniform mat4 viewMatrix;uniform mat4 projectionMatrix;uniform vec3 eyePositionHigh;uniform vec3 eyePositionLow;uniform float planetRadius;uniform vec3 scaleByDistance;uniform float opacity;uniform float depthOffset;const vec3 ZERO3=vec3(0.0);void main(){vec3 a_positions=a_positionsHigh+a_positionsLow;vec3 cameraPos=eyePositionHigh+eyePositionLow;v_rgba=a_rgba;if(a_texCoord.w==EMPTY){v_rgba.a=0.0;gl_Position=vec4(0.0);return;}vec3 look=a_positions-cameraPos;float lookDist=length(look);if(opacity*step(lookDist,sqrt(dot(cameraPos,cameraPos)-planetRadius)+sqrt(dot(a_positions,a_positions)-planetRadius))==0.0){return;}float scd=(1.0-smoothstep(scaleByDistance[0],scaleByDistance[1],lookDist))*(1.0-step(scaleByDistance[2],lookDist));v_rgba.a*=opacity;mat4 viewMatrixRTE=viewMatrix;viewMatrixRTE[3]=vec4(0.0,0.0,0.0,1.0);vec3 highDiff=a_positionsHigh-eyePositionHigh;vec3 lowDiff=a_positionsLow-eyePositionLow;vec4 posRTE=viewMatrixRTE*vec4(highDiff+lowDiff,1.0);vec4 projPos=projectionMatrix*posRTE;float camSlope=dot(vec3(viewMatrix[0][2],viewMatrix[1][2],viewMatrix[2][2]),normalize(cameraPos));if(camSlope>0.5){float dist=dot(look,normalize(cameraPos));projPos.z+=dist*0.02;}else{projPos.z+=-(abs(projPos.z))*0.002;}projPos.z+=depthOffset+a_offset.z;vec2 screenPos=project(projPos,viewport);vec2 vert=a_vertices;vec4 gp=a_gliphParam;if(a_texCoord.w==RTL){vert.x=step(vert.x*0.5+1.0,1.0);gp.x=-a_gliphParam.x;gp.z=-(a_gliphParam.z+a_texCoord.z);}else{gp.z=a_gliphParam.z+a_texCoord.z;}vec2 v=screenPos+rotate2d(a_rotation)*((vert*gp.xy+gp.zw)*a_size*scd+a_offset.xy);gl_Position=vec4((2.0*v/viewport-1.0)*projPos.w,projPos.z,projPos.w);}`,fragmentShader:"precision highp float;varying vec4 v_rgba;varying vec3 v_pickingColor;void main(){vec4 color=v_rgba;if(color.a<0.05){return;}gl_FragColor=vec4(v_rgba.rgb,v_rgba.a);}"})))}get labels(){return this._billboards}add(t){t._handler||(t._handler=this,this.assignFontAtlas(t),this.refresh())}updateFonts(){let t=[...this._billboards];this._billboards=[];for(let n=0;n<t.length;n++)this.assignFontAtlas(t[n])}_addLabelToArrays(t){this._renderer&&this._renderer.labelWorker.make({handler:this,label:t})}assignFontAtlas(t){this._entityCollection&&this._renderer?(t.assignFontAtlas(this._renderer.fontAtlas),this._addLabelToArrays(t)):this._billboards.push(t)}workerCallback(t,n){n._lockId!==-1&&n._handler&&this.isEqual(n._handler)&&(n._isReady=!0,n._lockId=-1,n._handlerIndex=this._billboards.length,this._billboards.push(n),this._vertexArr=it(this._vertexArr,t.vertexArr),this._texCoordArr=it(this._texCoordArr,t.texCoordArr),this._gliphParamArr=it(this._gliphParamArr,t.gliphParamArr),this._positionHighArr=it(this._positionHighArr,t.positionHighArr),this._positionLowArr=it(this._positionLowArr,t.positionLowArr),this._sizeArr=it(this._sizeArr,t.sizeArr),this._offsetArr=it(this._offsetArr,t.offsetArr),this._rgbaArr=it(this._rgbaArr,t.rgbaArr),this._rotationArr=it(this._rotationArr,t.rotationArr),this._fontIndexArr=it(this._fontIndexArr,t.fontIndexArr),this._outlineArr=it(this._outlineArr,t.outlineArr),this._outlineColorArr=it(this._outlineColorArr,t.outlineColorArr),this._pickingColorArr=it(this._pickingColorArr,t.pickingColorArr),n.update(),this.refresh())}clear(){this._texCoordArr=null,this._gliphParamArr=null,this._vertexArr=null,this._positionHighArr=null,this._positionLowArr=null,this._sizeArr=null,this._offsetArr=null,this._rgbaArr=null,this._rotationArr=null,this._fontIndexArr=null,this._outlineArr=null,this._outlineColorArr=null,this._texCoordArr=new Float32Array([]),this._gliphParamArr=new Float32Array([]),this._vertexArr=new Float32Array([]),this._positionHighArr=new Float32Array([]),this._positionLowArr=new Float32Array([]),this._sizeArr=new Float32Array([]),this._offsetArr=new Float32Array([]),this._rgbaArr=new Float32Array([]),this._rotationArr=new Float32Array([]),this._fontIndexArr=new Float32Array([]),this._outlineArr=new Float32Array([]),this._outlineColorArr=new Float32Array([]),this._removeBillboards(),this._deleteBuffers(),this.refresh()}_deleteBuffers(){if(this._renderer){let t=this._renderer.handler.gl;t.deleteBuffer(this._gliphParamBuffer),t.deleteBuffer(this._sizeBuffer),t.deleteBuffer(this._fontIndexBuffer),t.deleteBuffer(this._texCoordBuffer),t.deleteBuffer(this._outlineBuffer),t.deleteBuffer(this._outlineColorBuffer),t.deleteBuffer(this._positionHighBuffer),t.deleteBuffer(this._positionLowBuffer),t.deleteBuffer(this._sizeBuffer),t.deleteBuffer(this._offsetBuffer),t.deleteBuffer(this._rgbaBuffer),t.deleteBuffer(this._rotationBuffer),t.deleteBuffer(this._vertexBuffer),t.deleteBuffer(this._texCoordBuffer),t.deleteBuffer(this._pickingColorBuffer),this._gliphParamBuffer=null,this._sizeBuffer=null,this._fontIndexBuffer=null,this._texCoordBuffer=null,this._outlineBuffer=null,this._outlineColorBuffer=null,this._positionHighBuffer=null,this._positionLowBuffer=null,this._sizeBuffer=null,this._offsetBuffer=null,this._rgbaBuffer=null,this._rotationBuffer=null,this._vertexBuffer=null,this._texCoordBuffer=null,this._pickingColorBuffer=null}}_displayPASS(){let t=this._renderer,n=t.handler;n.programs.label.activate();let s=n.programs.label._program,o=s.attributes,a=s.uniforms,h=n.gl,c=this._entityCollection;h.disable(h.CULL_FACE),h.uniform1iv(a.fontTextureArr,t.fontAtlas.samplerArr),h.uniform4fv(a.sdfParamsArr,t.fontAtlas.sdfParamsArr),h.uniformMatrix4fv(a.viewMatrix,!1,t.activeCamera.getViewMatrix()),h.uniformMatrix4fv(a.projectionMatrix,!1,t.activeCamera.getProjectionMatrix()),h.uniform3fv(a.eyePositionHigh,t.activeCamera.eyeHigh),h.uniform3fv(a.eyePositionLow,t.activeCamera.eyeLow),h.uniform3fv(a.scaleByDistance,c.scaleByDistance),h.uniform1f(a.opacity,c._fadingOpacity),h.uniform1f(a.planetRadius,c.renderNode._planetRadius2||0),h.uniform2fv(a.viewport,[n.canvas.clientWidth,n.canvas.clientHeight]),h.bindBuffer(h.ARRAY_BUFFER,this._texCoordBuffer),h.vertexAttribPointer(o.a_texCoord,this._texCoordBuffer.itemSize,h.FLOAT,!1,0,0),h.bindBuffer(h.ARRAY_BUFFER,this._gliphParamBuffer),h.vertexAttribPointer(o.a_gliphParam,this._gliphParamBuffer.itemSize,h.FLOAT,!1,0,0),h.bindBuffer(h.ARRAY_BUFFER,this._vertexBuffer),h.vertexAttribPointer(o.a_vertices,this._vertexBuffer.itemSize,h.FLOAT,!1,0,0),h.bindBuffer(h.ARRAY_BUFFER,this._positionHighBuffer),h.vertexAttribPointer(o.a_positionsHigh,this._positionHighBuffer.itemSize,h.FLOAT,!1,0,0),h.bindBuffer(h.ARRAY_BUFFER,this._positionLowBuffer),h.vertexAttribPointer(o.a_positionsLow,this._positionLowBuffer.itemSize,h.FLOAT,!1,0,0),h.bindBuffer(h.ARRAY_BUFFER,this._sizeBuffer),h.vertexAttribPointer(o.a_size,this._sizeBuffer.itemSize,h.FLOAT,!1,0,0),h.bindBuffer(h.ARRAY_BUFFER,this._rotationBuffer),h.vertexAttribPointer(o.a_rotation,this._rotationBuffer.itemSize,h.FLOAT,!1,0,0),h.bindBuffer(h.ARRAY_BUFFER,this._offsetBuffer),h.vertexAttribPointer(o.a_offset,this._offsetBuffer.itemSize,h.FLOAT,!1,0,0),h.bindBuffer(h.ARRAY_BUFFER,this._fontIndexBuffer),h.vertexAttribPointer(o.a_fontIndex,this._fontIndexBuffer.itemSize,h.FLOAT,!1,0,0),h.uniform1i(a.isOutlinePass,1),h.uniform1f(a.depthOffset,c.polygonOffsetUnits),h.bindBuffer(h.ARRAY_BUFFER,this._outlineColorBuffer),h.vertexAttribPointer(o.a_rgba,this._outlineColorBuffer.itemSize,h.FLOAT,!1,0,0),h.bindBuffer(h.ARRAY_BUFFER,this._outlineBuffer),h.vertexAttribPointer(o.a_outline,this._outlineBuffer.itemSize,h.FLOAT,!1,0,0),h.drawArrays(h.TRIANGLES,0,this._vertexBuffer.numItems),h.depthFunc(h.EQUAL),h.uniform1i(a.isOutlinePass,0),h.uniform1f(a.depthOffset,c.polygonOffsetUnits),h.bindBuffer(h.ARRAY_BUFFER,this._rgbaBuffer),h.vertexAttribPointer(o.a_rgba,this._rgbaBuffer.itemSize,h.FLOAT,!1,0,0),h.drawArrays(h.TRIANGLES,0,this._vertexBuffer.numItems),h.depthFunc(h.LESS),h.enable(h.CULL_FACE)}_pickingPASS(){let t=this._renderer,n=t.handler;n.programs.labelPicking.activate();let s=n.programs.labelPicking._program,o=s.attributes,a=s.uniforms,h=n.gl,c=this._entityCollection,u=c.renderNode;h.disable(h.CULL_FACE),h.uniformMatrix4fv(a.viewMatrix,!1,t.activeCamera.getViewMatrix()),h.uniformMatrix4fv(a.projectionMatrix,!1,t.activeCamera.getProjectionMatrix()),h.uniform3fv(a.eyePositionHigh,t.activeCamera.eyeHigh),h.uniform3fv(a.eyePositionLow,t.activeCamera.eyeLow),h.uniform3fv(a.scaleByDistance,c.scaleByDistance),h.uniform1f(a.opacity,c._fadingOpacity),h.uniform1f(a.planetRadius,u._planetRadius2||0),h.uniform2fv(a.viewport,[n.canvas.clientWidth,n.canvas.clientHeight]),h.bindBuffer(h.ARRAY_BUFFER,this._texCoordBuffer),h.vertexAttribPointer(o.a_texCoord,this._texCoordBuffer.itemSize,h.FLOAT,!1,0,0),h.bindBuffer(h.ARRAY_BUFFER,this._gliphParamBuffer),h.vertexAttribPointer(o.a_gliphParam,this._gliphParamBuffer.itemSize,h.FLOAT,!1,0,0),h.bindBuffer(h.ARRAY_BUFFER,this._vertexBuffer),h.vertexAttribPointer(o.a_vertices,this._vertexBuffer.itemSize,h.FLOAT,!1,0,0),h.bindBuffer(h.ARRAY_BUFFER,this._positionHighBuffer),h.vertexAttribPointer(o.a_positionsHigh,this._positionHighBuffer.itemSize,h.FLOAT,!1,0,0),h.bindBuffer(h.ARRAY_BUFFER,this._positionLowBuffer),h.vertexAttribPointer(o.a_positionsLow,this._positionLowBuffer.itemSize,h.FLOAT,!1,0,0),h.bindBuffer(h.ARRAY_BUFFER,this._sizeBuffer),h.vertexAttribPointer(o.a_size,this._sizeBuffer.itemSize,h.FLOAT,!1,0,0),h.bindBuffer(h.ARRAY_BUFFER,this._rotationBuffer),h.vertexAttribPointer(o.a_rotation,this._rotationBuffer.itemSize,h.FLOAT,!1,0,0),h.bindBuffer(h.ARRAY_BUFFER,this._offsetBuffer),h.vertexAttribPointer(o.a_offset,this._offsetBuffer.itemSize,h.FLOAT,!1,0,0),h.bindBuffer(h.ARRAY_BUFFER,this._pickingColorBuffer),h.vertexAttribPointer(o.a_rgba,this._pickingColorBuffer.itemSize,h.FLOAT,!1,0,0),h.uniform1f(a.depthOffset,c.polygonOffsetUnits),h.drawArrays(h.TRIANGLES,0,this._vertexBuffer.numItems),h.enable(h.CULL_FACE)}_removeBillboard(t){let n=t._handlerIndex;this._billboards.splice(n,1);let s=24*this._maxLetters,o=n*s;this._rgbaArr=ot(this._rgbaArr,o,s),this._outlineColorArr=ot(this._outlineColorArr,o,s),this._texCoordArr=ot(this._texCoordArr,o,s),this._gliphParamArr=ot(this._gliphParamArr,o,s),s=18*this._maxLetters,o=n*s,this._positionHighArr=ot(this._positionHighArr,o,s),this._positionLowArr=ot(this._positionLowArr,o,s),this._offsetArr=ot(this._offsetArr,o,s),this._pickingColorArr=ot(this._pickingColorArr,o,s),s=12*this._maxLetters,o=n*s,this._vertexArr=ot(this._vertexArr,o,s),s=6*this._maxLetters,o=n*s,this._sizeArr=ot(this._sizeArr,o,s),this._rotationArr=ot(this._rotationArr,o,s),this._fontIndexArr=ot(this._fontIndexArr,o,s),this._outlineArr=ot(this._outlineArr,o,s),this.reindexBillboardsArray(n),this.refresh(),t._handlerIndex=-1,t._handler=null,t._isReady=!1}setText(t,n,s,o,a=0,h=!1){n=n.normalize("NFKC");let c=this._renderer.fontAtlas.atlasesArr[s];if(!c)return;let u=24*t*this._maxLetters,d=this._texCoordArr,f=this._gliphParamArr,g=0,_=Math.min(this._maxLetters,n.length),m=0;h&&(m=1);let p=0,x=c.kernings;for(g=0;g<_;g++){let y=u+24*g,T=n[g],S=c.get(T.charCodeAt(0))||c.get(32);if(!S)continue;let C=S.texCoords,P=S.metrics;d[y]=C[0],d[y+1]=C[1],d[y+2]=p,d[y+3]=m,d[y+4]=C[2],d[y+5]=C[3],d[y+6]=p,d[y+7]=m,d[y+8]=C[4],d[y+9]=C[5],d[y+10]=p,d[y+11]=m,d[y+12]=C[6],d[y+13]=C[7],d[y+14]=p,d[y+15]=m,d[y+16]=C[8],d[y+17]=C[9],d[y+18]=p,d[y+19]=m,d[y+20]=C[10],d[y+21]=C[11],d[y+22]=p,d[y+23]=m,f[y]=P.nWidth,f[y+1]=P.nHeight,f[y+2]=P.nXOffset,f[y+3]=P.nYOffset,f[y+4]=P.nWidth,f[y+5]=P.nHeight,f[y+6]=P.nXOffset,f[y+7]=P.nYOffset,f[y+8]=P.nWidth,f[y+9]=P.nHeight,f[y+10]=P.nXOffset,f[y+11]=P.nYOffset,f[y+12]=P.nWidth,f[y+13]=P.nHeight,f[y+14]=P.nXOffset,f[y+15]=P.nYOffset,f[y+16]=P.nWidth,f[y+17]=P.nHeight,f[y+18]=P.nXOffset,f[y+19]=P.nYOffset,f[y+20]=P.nWidth,f[y+21]=P.nHeight,f[y+22]=P.nXOffset,f[y+23]=P.nYOffset;let w=x[T.charCodeAt(0)];if(w&&n[g+1]){let I=w[n[g+1].charCodeAt(0)];p+=I?P.nAdvance+I+a:P.nAdvance+a}else p+=P.nAdvance+a}if(o===_i.CENTER)for(p*=-.5,g=0;g<_;g++){let y=u+24*g;d[y+2]+=p,d[y+6]+=p,d[y+10]+=p,d[y+14]+=p,d[y+18]+=p,d[y+22]+=p}for(;g<this._maxLetters;g++){let y=u+24*g;d[y+3]=-1,d[y+7]=-1,d[y+11]=-1,d[y+15]=-1,d[y+19]=-1,d[y+23]=-1}this._changedBuffers[6]=!0}setPositionArr(t,n,s){let o=18*t*this._maxLetters,a=this._positionHighArr,h=n.x,c=n.y,u=n.z,d=this._positionLowArr,f=s.x,g=s.y,_=s.z;for(let m=0;m<this._maxLetters;m++){let p=o+18*m;a[p]=h,a[p+1]=c,a[p+2]=u,a[p+3]=h,a[p+4]=c,a[p+5]=u,a[p+6]=h,a[p+7]=c,a[p+8]=u,a[p+9]=h,a[p+10]=c,a[p+11]=u,a[p+12]=h,a[p+13]=c,a[p+14]=u,a[p+15]=h,a[p+16]=c,a[p+17]=u,d[p]=f,d[p+1]=g,d[p+2]=_,d[p+3]=f,d[p+4]=g,d[p+5]=_,d[p+6]=f,d[p+7]=g,d[p+8]=_,d[p+9]=f,d[p+10]=g,d[p+11]=_,d[p+12]=f,d[p+13]=g,d[p+14]=_,d[p+15]=f,d[p+16]=g,d[p+17]=_}this._changedBuffers[1]=!0}setPickingColorArr(t,n){let s=18*t*this._maxLetters,o=this._pickingColorArr,a=n.x/255,h=n.y/255,c=n.z/255;for(let u=0;u<this._maxLetters;u++){let d=s+18*u;o[d]=a,o[d+1]=h,o[d+2]=c,o[d+3]=a,o[d+4]=h,o[d+5]=c,o[d+6]=a,o[d+7]=h,o[d+8]=c,o[d+9]=a,o[d+10]=h,o[d+11]=c,o[d+12]=a,o[d+13]=h,o[d+14]=c,o[d+15]=a,o[d+16]=h,o[d+17]=c}this._changedBuffers[0]=!0}setSizeArr(t,n){let s=6*t*this._maxLetters,o=this._sizeArr;for(let a=0;a<this._maxLetters;a++){let h=s+6*a;o[h]=n,o[h+1]=n,o[h+2]=n,o[h+3]=n,o[h+4]=n,o[h+5]=n}this._changedBuffers[2]=!0}setOffsetArr(t,n){let s=18*t*this._maxLetters,o=this._offsetArr,a=n.x,h=n.y,c=n.z;for(let u=0;u<this._maxLetters;u++){let d=s+18*u;o[d]=a,o[d+1]=h,o[d+2]=c,o[d+3]=a,o[d+4]=h,o[d+5]=c,o[d+6]=a,o[d+7]=h,o[d+8]=c,o[d+9]=a,o[d+10]=h,o[d+11]=c,o[d+12]=a,o[d+13]=h,o[d+14]=c,o[d+15]=a,o[d+16]=h,o[d+17]=c}this._changedBuffers[3]=!0}setRgbaArr(t,n){let s=24*t*this._maxLetters,o=this._rgbaArr,a=n.x,h=n.y,c=n.z,u=n.w;for(let d=0;d<this._maxLetters;d++){let f=s+24*d;o[f]=a,o[f+1]=h,o[f+2]=c,o[f+3]=u,o[f+4]=a,o[f+5]=h,o[f+6]=c,o[f+7]=u,o[f+8]=a,o[f+9]=h,o[f+10]=c,o[f+11]=u,o[f+12]=a,o[f+13]=h,o[f+14]=c,o[f+15]=u,o[f+16]=a,o[f+17]=h,o[f+18]=c,o[f+19]=u,o[f+20]=a,o[f+21]=h,o[f+22]=c,o[f+23]=u}this._changedBuffers[4]=!0}setOutlineColorArr(t,n){let s=24*t*this._maxLetters,o=this._outlineColorArr,a=n.x,h=n.y,c=n.z,u=n.w;for(let d=0;d<this._maxLetters;d++){let f=s+24*d;o[f]=a,o[f+1]=h,o[f+2]=c,o[f+3]=u,o[f+4]=a,o[f+5]=h,o[f+6]=c,o[f+7]=u,o[f+8]=a,o[f+9]=h,o[f+10]=c,o[f+11]=u,o[f+12]=a,o[f+13]=h,o[f+14]=c,o[f+15]=u,o[f+16]=a,o[f+17]=h,o[f+18]=c,o[f+19]=u,o[f+20]=a,o[f+21]=h,o[f+22]=c,o[f+23]=u}this._changedBuffers[10]=!0}setOutlineArr(t,n){let s=6*t*this._maxLetters,o=this._outlineArr;for(let a=0;a<this._maxLetters;a++){let h=s+6*a;o[h]=n,o[h+1]=n,o[h+2]=n,o[h+3]=n,o[h+4]=n,o[h+5]=n}this._changedBuffers[9]=!0}setRotationArr(t,n){let s=6*t*this._maxLetters,o=this._rotationArr;for(let a=0;a<this._maxLetters;a++){let h=s+6*a;o[h]=n,o[h+1]=n,o[h+2]=n,o[h+3]=n,o[h+4]=n,o[h+5]=n}this._changedBuffers[5]=!0}setVisibility(t,n){let s;s=n?[0,0,0,-1,1,-1,1,-1,1,0,0,0]:[0,0,0,0,0,0,0,0,0,0,0,0],this.setVertexArr(t,s)}setVertexArr(t,n){let s=12*t*this._maxLetters,o=this._vertexArr;for(let a=0;a<this._maxLetters;a++){let h=s+12*a;o[h]=n[0],o[h+1]=n[1],o[h+2]=n[2],o[h+3]=n[3],o[h+4]=n[4],o[h+5]=n[5],o[h+6]=n[6],o[h+7]=n[7],o[h+8]=n[8],o[h+9]=n[9],o[h+10]=n[10],o[h+11]=n[11]}this._changedBuffers[7]=!0}setFontIndexArr(t,n){let s=6*t*this._maxLetters,o=this._fontIndexArr;for(let a=0;a<this._maxLetters;a++){let h=s+6*a;o[h]=n,o[h+1]=n,o[h+2]=n,o[h+3]=n,o[h+4]=n,o[h+5]=n}this._changedBuffers[8]=!0}createSizeBuffer(){let t=this._renderer.handler;t.gl.deleteBuffer(this._sizeBuffer),this._sizeBuffer=t.createArrayBuffer(this._sizeArr,1,this._sizeArr.length)}createFontIndexBuffer(){let t=this._renderer.handler;t.gl.deleteBuffer(this._fontIndexBuffer),this._fontIndexBuffer=t.createArrayBuffer(this._fontIndexArr,1,this._fontIndexArr.length)}createTexCoordBuffer(){let t=this._renderer.handler;t.gl.deleteBuffer(this._texCoordBuffer),this._texCoordBuffer=t.createArrayBuffer(this._texCoordArr,4,this._texCoordArr.length/4),t.gl.deleteBuffer(this._gliphParamBuffer),this._gliphParamBuffer=t.createArrayBuffer(this._gliphParamArr,4,this._gliphParamArr.length/4)}createOutlineBuffer(){let t=this._renderer.handler;t.gl.deleteBuffer(this._outlineBuffer),this._outlineBuffer=t.createArrayBuffer(this._outlineArr,1,this._outlineArr.length)}createOutlineColorBuffer(){let t=this._renderer.handler;t.gl.deleteBuffer(this._outlineColorBuffer),this._outlineColorBuffer=t.createArrayBuffer(this._outlineColorArr,4,this._outlineColorArr.length/4)}setMaxLetters(t){this._maxLetters=t}}const Ts=class ld{constructor(t){this.pickingEnabled=!0,this.__id=ld.__counter__++,this.pickingEnabled=!0,this._entityCollection=t,this._renderer=null,this._pointClouds=[]}_initProgram(){this._renderer&&this._renderer.handler&&(this._renderer.handler.programs.pointCloud||this._renderer.handler.addProgram(new X("pointCloud",{uniforms:{projectionViewMatrix:"mat4",opacity:"float",pointSize:"float"},attributes:{coordinates:"vec3",colors:"vec3"},vertexShader:`attribute vec3 coordinates;
            attribute vec4 colors;
            uniform mat4 projectionViewMatrix;
            uniform float opacity;
            uniform float pointSize;
            varying vec4 color;
            void main() {
                color = colors;
                color.a *= opacity;
                gl_Position = projectionViewMatrix * vec4(coordinates, 1.0);
                gl_PointSize = pointSize;
            }`,fragmentShader:`precision highp float;
            varying vec4 color;
            void main(void) {
                gl_FragColor = color;
            }`})))}setRenderNode(t){this._renderer=t.renderer,this._initProgram();for(let n=0;n<this._pointClouds.length;n++)this._pointClouds[n].setRenderNode(t)}add(t){t._handlerIndex===-1&&(t._handler=this,t._handlerIndex=this._pointClouds.length,this._pointClouds.push(t),this._entityCollection&&this._entityCollection.renderNode&&t.setRenderNode(this._entityCollection.renderNode))}remove(t){let n=t._handlerIndex;n!==-1&&(t._deleteBuffers(),t._handlerIndex=-1,t._handler=null,this._pointClouds.splice(n,1),this._reindexPointCloudArray(n))}_reindexPointCloudArray(t){let n=this._pointClouds;for(let s=t;s<n.length;s++)n[s]._handlerIndex=s}draw(){let t=this._pointClouds.length;for(;t--;)this._pointClouds[t].draw()}drawPicking(){if(this.pickingEnabled){let t=this._pointClouds.length;for(;t--;)this._pointClouds[t].drawPicking()}}clear(){let t=this._pointClouds.length;for(;t--;)this._pointClouds[t]._deleteBuffers(),this._pointClouds[t]._handler=null,this._pointClouds[t]._handlerIndex=-1;this._pointClouds.length=0,this._pointClouds=[]}};Ts.__counter__=0;let Lr=Ts;const Cs=class hd{constructor(t){this.__id=hd.__counter__++,this._entityCollection=t,this._renderer=null,this._polylines=[],this.pickingEnabled=!0,this._relativeCenter=new v,this._rtcEyePositionHigh=new Float32Array([0,0,0]),this._rtcEyePositionLow=new Float32Array([0,0,0])}_initProgram(){this._renderer&&this._renderer.handler&&(this._renderer.handler.programs.polyline_screen||this._renderer.handler.addProgram(new X("polyline_screen",{uniforms:{viewport:"vec2",proj:"mat4",view:"mat4",rtcEyePositionHigh:"vec3",rtcEyePositionLow:"vec3",thickness:"float",opacity:"float",depthOffset:"float",visibleSphere:"vec4",texAtlas:"sampler2d",strokeSize:"float",texOffset:"float"},attributes:{prevHigh:"vec3",currentHigh:"vec3",nextHigh:"vec3",prevLow:"vec3",currentLow:"vec3",nextLow:"vec3",order:"float",color:"vec4",texCoord:"vec4"},vertexShader:`#version 300 es
precision highp float;in vec3 prevHigh;in vec3 currentHigh;in vec3 nextHigh;in vec3 prevLow;in vec3 currentLow;in vec3 nextLow;in vec4 texCoord;in float order;in vec4 color;uniform float thickness;uniform mat4 proj;uniform mat4 view;uniform vec2 viewport;uniform vec3 rtcEyePositionHigh;uniform vec3 rtcEyePositionLow;uniform float opacity;uniform float depthOffset;uniform float strokeSize;uniform float texOffset;out vec4 v_rgba;out vec3 vPos;out vec3 uCamPos;out vec4 vTexCoord;flat out float repeat;flat out float v_texOffset;const float NEAR=-1.0;vec2 getIntersection(vec2 start1,vec2 end1,vec2 start2,vec2 end2){vec2 dir=end2-start2;vec2 perp=vec2(-dir.y,dir.x);float d2=dot(perp,start2);float seg=dot(perp,start1)-d2;float prl=seg-dot(perp,end1)+d2;if(prl>-1.0&&prl<1.0){return start1;}float u=seg/prl;return start1+u*(end1-start1);}vec2 project(vec4 p){return(0.5*p.xyz/p.w+0.5).xy*viewport;}void main(){uCamPos=rtcEyePositionHigh+rtcEyePositionLow;vPos=currentHigh+currentLow;v_rgba=vec4(color.rgb,color.a*opacity);mat4 viewMatrixRTE=view;viewMatrixRTE[3]=vec4(0.0,0.0,0.0,1.0);vec3 highDiff,lowDiff;highDiff=currentHigh-rtcEyePositionHigh;highDiff=highDiff*step(1.0,length(highDiff));lowDiff=currentLow-rtcEyePositionLow;vec4 vCurrent=viewMatrixRTE*vec4(highDiff+lowDiff,1.0);highDiff=prevHigh-rtcEyePositionHigh;highDiff=highDiff*step(1.0,length(highDiff));lowDiff=prevLow-rtcEyePositionLow;vec4 vPrev=viewMatrixRTE*vec4(highDiff+lowDiff,1.0);highDiff=nextHigh-rtcEyePositionHigh;highDiff=highDiff*step(1.0,length(highDiff));lowDiff=nextLow-rtcEyePositionLow;vec4 vNext=viewMatrixRTE*vec4(highDiff+lowDiff,1.0);if(vCurrent.z>NEAR){if(vPrev.z<NEAR&&abs(order)==1.0){vCurrent=vPrev+(vCurrent-vPrev)*(NEAR-vPrev.z)/(vCurrent.z-vPrev.z);}else if(vNext.z<NEAR&&abs(order)==2.0){vCurrent=vNext+(vCurrent-vNext)*(NEAR-vNext.z)/(vCurrent.z-vNext.z);}}vec4 dCurrent=proj*vCurrent;vec2 _next=project(proj*vNext);vec2 _prev=project(proj*vPrev);vec2 _current=project(dCurrent);if(_prev==_current){if(_next==_current){_next=_current+vec2(1.0,0.0);_prev=_current-_next;}else{_prev=_current+normalize(_current-_next);}}if(_next==_current){_next=_current+normalize(_current-_prev);}vec2 sNext=_next,sCurrent=_current,sPrev=_prev;vec2 dirNext=normalize(sNext-sCurrent);vec2 dirPrev=normalize(sPrev-sCurrent);float dotNP=dot(dirNext,dirPrev);vec2 normalNext=normalize(vec2(-dirNext.y,dirNext.x));vec2 normalPrev=normalize(vec2(dirPrev.y,-dirPrev.x));float d=thickness*sign(order);vTexCoord=texCoord;vec2 m;if(dotNP>=0.99991){m=sCurrent-normalPrev*d;}else{m=getIntersection(sCurrent+normalPrev*d,sPrev+normalPrev*d,sCurrent+normalNext*d,sNext+normalNext*d);if(dotNP>0.5&&dot(dirNext+dirPrev,m-sCurrent)<0.0){float occw=order*sign(dirNext.x*dirPrev.y-dirNext.y*dirPrev.x);if(occw==-1.0){m=sCurrent+normalPrev*d;}else if(occw==1.0){m=sCurrent+normalNext*d;}else if(occw==-2.0){m=sCurrent+normalNext*d;}else if(occw==2.0){m=sCurrent+normalPrev*d;}}else if(distance(sCurrent,m)>min(distance(sCurrent,sNext),distance(sCurrent,sPrev))){m=sCurrent+normalNext*d;}}repeat=min(distance(sCurrent,sPrev),viewport.y)/strokeSize;v_texOffset=texOffset;gl_Position=vec4((2.0*m/viewport-1.0)*dCurrent.w,dCurrent.z+depthOffset,dCurrent.w);}`,fragmentShader:`#version 300 es
precision highp float;uniform sampler2D texAtlas;uniform vec4 visibleSphere;in vec3 uCamPos;in vec4 v_rgba;in vec3 vPos;in vec4 vTexCoord;flat in float repeat;flat in float v_texOffset;out vec4 fragColor;void main(){if(visibleSphere.w!=0.0){vec3 cam_dir=normalize(vPos-uCamPos);vec3 sph_dir=normalize(vPos-visibleSphere.xyz);if(dot(cam_dir,sph_dir)>0.11){discard;}}float height=vTexCoord.w;if(height==0.0){fragColor=vec4(v_rgba.rgb,v_rgba.a);}else{vec2 uv=vTexCoord.xy;float min=vTexCoord.z;float EPS=0.5/1024.0;float localY=fract((uv.y+v_texOffset-min)/height*repeat);uv.y=clamp(min+localY*height,min+EPS,min+height-EPS);vec4 color=texture(texAtlas,uv);color.a*=v_rgba.a;fragColor=color;}}`})),this._renderer.handler.programs.polyline_picking||this._renderer.handler.addProgram(new X("polyline_picking",{uniforms:{viewport:"vec2",proj:"mat4",view:"mat4",rtcEyePositionHigh:"vec3",rtcEyePositionLow:"vec3",color:"vec4",thickness:"float",depthOffset:"float",visibleSphere:"vec4"},attributes:{prevHigh:"vec3",currentHigh:"vec3",nextHigh:"vec3",prevLow:"vec3",currentLow:"vec3",nextLow:"vec3",order:"float"},vertexShader:"precision highp float;attribute vec3 prevHigh;attribute vec3 currentHigh;attribute vec3 nextHigh;attribute vec3 prevLow;attribute vec3 currentLow;attribute vec3 nextLow;attribute float order;uniform float thickness;uniform vec4 color;uniform mat4 proj;uniform mat4 view;uniform vec2 viewport;uniform vec3 rtcEyePositionHigh;uniform vec3 rtcEyePositionLow;uniform float depthOffset;varying vec4 vColor;varying vec3 vPos;varying vec3 uCamPos;const float NEAR=-1.0;vec2 getIntersection(vec2 start1,vec2 end1,vec2 start2,vec2 end2){vec2 dir=end2-start2;vec2 perp=vec2(-dir.y,dir.x);float d2=dot(perp,start2);float seg=dot(perp,start1)-d2;float prl=seg-dot(perp,end1)+d2;if(prl>-1.0&&prl<1.0){return start1;}float u=seg/prl;return start1+u*(end1-start1);}vec2 project(vec4 p){return(0.5*p.xyz/p.w+0.5).xy*viewport;}void main(){uCamPos=rtcEyePositionHigh+rtcEyePositionLow;vPos=currentHigh+currentLow;vColor=color;vec3 highDiff,lowDiff;mat4 viewMatrixRTE=view;viewMatrixRTE[3]=vec4(0.0,0.0,0.0,1.0);highDiff=currentHigh-rtcEyePositionHigh;highDiff=highDiff*step(1.0,length(highDiff));lowDiff=currentLow-rtcEyePositionLow;vec4 vCurrent=viewMatrixRTE*vec4(highDiff+lowDiff,1.0);highDiff=prevHigh-rtcEyePositionHigh;highDiff=highDiff*step(1.0,length(highDiff));lowDiff=prevLow-rtcEyePositionLow;vec4 vPrev=viewMatrixRTE*vec4(highDiff+lowDiff,1.0);highDiff=nextHigh-rtcEyePositionHigh;highDiff=highDiff*step(1.0,length(highDiff));lowDiff=nextLow-rtcEyePositionLow;vec4 vNext=viewMatrixRTE*vec4(highDiff+lowDiff,1.0);if(vCurrent.z>NEAR){if(vPrev.z<NEAR&&abs(order)==1.0){vCurrent=vPrev+(vCurrent-vPrev)*(NEAR-vPrev.z)/(vCurrent.z-vPrev.z);}else if(vNext.z<NEAR&&abs(order)==2.0){vCurrent=vNext+(vCurrent-vNext)*(NEAR-vNext.z)/(vCurrent.z-vNext.z);}}vec4 dCurrent=proj*vCurrent;vec2 _next=project(proj*vNext);vec2 _prev=project(proj*vPrev);vec2 _current=project(dCurrent);if(_prev==_current){if(_next==_current){_next=_current+vec2(1.0,0.0);_prev=_current-_next;}else{_prev=_current+normalize(_current-_next);}}if(_next==_current){_next=_current+normalize(_current-_prev);}vec2 sNext=_next,sCurrent=_current,sPrev=_prev;vec2 dirNext=normalize(sNext-sCurrent);vec2 dirPrev=normalize(sPrev-sCurrent);float dotNP=dot(dirNext,dirPrev);vec2 normalNext=normalize(vec2(-dirNext.y,dirNext.x));vec2 normalPrev=normalize(vec2(dirPrev.y,-dirPrev.x));float d=thickness*sign(order);vec2 m;if(dotNP>=0.99991){m=sCurrent-normalPrev*d;}else{m=getIntersection(sCurrent+normalPrev*d,sPrev+normalPrev*d,sCurrent+normalNext*d,sNext+normalNext*d);if(dotNP>0.5&&dot(dirNext+dirPrev,m-sCurrent)<0.0){float occw=order*sign(dirNext.x*dirPrev.y-dirNext.y*dirPrev.x);if(occw==-1.0){m=sCurrent+normalPrev*d;}else if(occw==1.0){m=sCurrent+normalNext*d;}else if(occw==-2.0){m=sCurrent+normalNext*d;}else if(occw==2.0){m=sCurrent+normalPrev*d;}}else if(distance(sCurrent,m)>min(distance(sCurrent,sNext),distance(sCurrent,sPrev))){m=sCurrent+normalNext*d;}}gl_Position=vec4((2.0*m/viewport-1.0)*dCurrent.w,dCurrent.z+depthOffset,dCurrent.w);}",fragmentShader:"precision highp float;uniform vec4 visibleSphere;varying vec3 uCamPos;varying vec4 vColor;varying vec3 vPos;void main(){if(visibleSphere.w!=0.0){vec3 cam_dir=normalize(vPos-uCamPos);vec3 sph_dir=normalize(vPos-visibleSphere.xyz);if(dot(cam_dir,sph_dir)>0.11){discard;}}gl_FragColor=vec4(vColor.rgb,vColor.a);}"})))}setRenderNode(t){this._renderer=t.renderer,this._initProgram();for(let n=0;n<this._polylines.length;n++)this._polylines[n].setRenderNode(t)}add(t){t._handlerIndex===-1&&(t._handler=this,t._handlerIndex=this._polylines.length,t.__doubleToTwoFloats=this.getRTCPosition.bind(this),this._polylines.push(t),this._entityCollection&&this._entityCollection.renderNode&&(t.setRenderNode(this._entityCollection.renderNode),t.updateRTCPosition()))}remove(t){let n=t._handlerIndex;n!==-1&&(t._deleteBuffers(),t._handlerIndex=-1,t._handler=null,this._polylines.splice(n,1),this.reindexPolylineArray(n))}reindexPolylineArray(t){let n=this._polylines;for(let s=t;s<n.length;s++)n[s]._handlerIndex=s}draw(){this._updateRTCEyePosition();let t=this._polylines.length;for(;t--;)this._polylines[t].draw()}drawPicking(){if(this.pickingEnabled){let t=this._polylines.length;for(;t--;)this._polylines[t].drawPicking()}}clear(){let t=this._polylines.length;for(;t--;)this._polylines[t]._deleteBuffers(),this._polylines[t]._handler=null,this._polylines[t]._handlerIndex=-1;this._polylines.length=0,this._polylines=[]}getRTCPosition(t,n,s){let o=t.sub(this._relativeCenter);v.doubleToTwoFloats(o,n,s)}setRelativeCenter(t){this._relativeCenter.copy(t);for(let n=0;n<this._polylines.length;n++)this._polylines[n].updateRTCPosition()}_updateRTCEyePosition(){let t=this._renderer;if(t.activeCamera.isFirstPass){let n=t.activeCamera.eye.sub(this._relativeCenter);v.doubleToTwoFloat32Array(n,this._rtcEyePositionHigh,this._rtcEyePositionLow)}}reloadTextures(){for(let t=0;t<this._polylines.length;t++){let n=this._polylines[t];n.setSrc(n.getSrc())}}get polylines(){return[...this._polylines]}refreshTexCoordsArr(){if(this._entityCollection&&this._renderer){let t=this._renderer.strokeTextureAtlas;for(let n=0;n<this._polylines.length;n++){let s=this._polylines[n],o=s.getImage();if(o){let a=t.get(o.__nodeIndex);a&&s._setTexCoordArr(a.texCoords)}}}}};Cs.__counter__=0;let Pr=Cs;const Es=class cd{constructor(t){this.__id=cd.__counter__++,this.pickingEnabled=!0,this._entityCollection=t,this._renderer=null,this._rays=[],this._vertexBuffer=null,this._startPositionHighBuffer=null,this._startPositionLowBuffer=null,this._endPositionHighBuffer=null,this._endPositionLowBuffer=null,this._thicknessBuffer=null,this._rgbaBuffer=null,this._pickingColorBuffer=null,this._texCoordBuffer=null,this._texOffsetBuffer=null,this._strokeSizeBuffer=null,this._vertexArr=[],this._startPositionHighArr=[],this._startPositionLowArr=[],this._endPositionHighArr=[],this._endPositionLowArr=[],this._thicknessArr=[],this._rgbaArr=[],this._pickingColorArr=[],this._texCoordArr=new Float32Array([]),this._texOffsetArr=new Float32Array([]),this._strokeSizeArr=new Float32Array([]),this._buffersUpdateCallbacks=[],this._buffersUpdateCallbacks[5]=this.createVertexBuffer,this._buffersUpdateCallbacks[1]=this.createStartPositionBuffer,this._buffersUpdateCallbacks[2]=this.createEndPositionBuffer,this._buffersUpdateCallbacks[4]=this.createThicknessBuffer,this._buffersUpdateCallbacks[3]=this.createRgbaBuffer,this._buffersUpdateCallbacks[0]=this.createPickingColorBuffer,this._buffersUpdateCallbacks[6]=this.createTexCoordBuffer,this._buffersUpdateCallbacks[7]=this.createTexOffsetBuffer,this._buffersUpdateCallbacks[8]=this.createStrokeSizeBuffer,this._changedBuffers=new Array(this._buffersUpdateCallbacks.length)}static concArr(t,n){for(let s=0;s<n.length;s++)t.push(n[s])}reloadTextures(){for(let t=0;t<this._rays.length;t++){let n=this._rays[t];n.setSrc(n.getSrc())}}get rays(){return[...this._rays]}initProgram(){this._renderer&&this._renderer.handler&&(this._renderer.handler.programs.rayScreen||this._renderer.handler.addProgram(new X("rayScreen",{uniforms:{projectionMatrix:"mat4",viewMatrix:"mat4",eyePositionHigh:"vec3",eyePositionLow:"vec3",resolution:"float",uOpacity:"float",texAtlas:"sampler2d",viewport:"vec2"},attributes:{a_vertices:"vec2",a_texCoord:"vec4",a_startPosHigh:"vec3",a_startPosLow:"vec3",a_endPosHigh:"vec3",a_endPosLow:"vec3",a_thickness:"float",a_rgba:"vec4",a_texOffset:"float",a_strokeSize:"float"},vertexShader:`#version 300 es
precision highp float;in vec4 a_rgba;in vec3 a_startPosHigh;in vec3 a_startPosLow;in vec3 a_endPosHigh;in vec3 a_endPosLow;in vec2 a_vertices;in float a_thickness;in vec4 a_texCoord;in float a_texOffset;in float a_strokeSize;out vec4 v_rgba;out vec4 v_texCoord;out float v_texOffset;flat out float repeat;uniform mat4 viewMatrix;uniform mat4 projectionMatrix;uniform vec3 eyePositionHigh;uniform vec3 eyePositionLow;uniform float resolution;uniform float uOpacity;uniform vec2 viewport;vec2 project(vec4 p){return(0.5*p.xyz/p.w+0.5).xy*viewport;}void main(){v_texOffset=a_texOffset;v_rgba=vec4(a_rgba.rgb,a_rgba.a*uOpacity);v_texCoord=a_texCoord;vec3 v=(a_endPosHigh-a_startPosHigh)+(a_endPosLow-a_startPosLow);vec3 look=(a_startPosHigh-eyePositionHigh)+(a_startPosLow-eyePositionLow)+v*a_vertices.y;vec3 up=normalize(v);vec3 right=normalize(cross(look,up));float dist=abs(dot(look,vec3(viewMatrix[0][2],viewMatrix[1][2],viewMatrix[2][2])));float focalSize=2.0*dist*resolution;vec3 vert=right*a_thickness*focalSize*a_vertices.x;vec3 highDiff;if(a_vertices.y==0.0){highDiff=a_startPosHigh-eyePositionHigh;vert+=a_startPosLow-eyePositionLow;}else{highDiff=a_endPosHigh-eyePositionHigh;vert+=a_endPosLow-eyePositionLow;}mat4 viewMatrixRTE=viewMatrix;viewMatrixRTE[3]=vec4(0.0,0.0,0.0,1.0);gl_Position=projectionMatrix*viewMatrixRTE*vec4(highDiff*step(1.0,length(highDiff))+vert,1.0);highDiff=a_startPosHigh-eyePositionHigh;highDiff=highDiff*step(1.0,length(highDiff));vec3 lowDiff=a_startPosLow-eyePositionLow;vec4 vStart=viewMatrixRTE*vec4(highDiff+lowDiff,1.0);highDiff=a_endPosHigh-eyePositionHigh;highDiff=highDiff*step(1.0,length(highDiff));lowDiff=a_endPosLow-eyePositionLow;vec4 vEnd=viewMatrixRTE*vec4(highDiff+lowDiff,1.0);vec2 nStart=project(projectionMatrix*vStart);vec2 nEnd=project(projectionMatrix*vEnd);repeat=min(distance(nStart,nEnd),viewport.y)/a_strokeSize;}`,fragmentShader:`#version 300 es
precision highp float;uniform sampler2D texAtlas;in vec4 v_rgba;in vec4 v_texCoord;in float v_texOffset;flat in float repeat;out vec4 fragColor;void main(){float height=v_texCoord.w;if(height==0.0){fragColor=v_rgba;}else{vec2 uv=v_texCoord.xy;float min=v_texCoord.z;float EPS=0.5/1024.0;float localY=fract((uv.y+v_texOffset-min)/height*repeat);uv.y=clamp(min+localY*height,min+EPS,min+height-EPS);vec4 color=texture(texAtlas,uv);fragColor=v_rgba*color;}}`})))}setRenderer(t){this._renderer=t,this.initProgram()}refresh(){let t=this._changedBuffers.length;for(;t--;)this._changedBuffers[t]=!0}_removeRays(){let t=this._rays.length;for(;t--;){let n=this._rays[t];n._handlerIndex=-1,n._handler=null}this._rays.length=0,this._rays=[]}clear(){this._vertexArr=null,this._startPositionHighArr=null,this._startPositionLowArr=null,this._endPositionHighArr=null,this._endPositionLowArr=null,this._thicknessArr=null,this._rgbaArr=null,this._texCoordArr=null,this._texOffsetArr=null,this._strokeSizeArr=null,this._vertexArr=new Float32Array([]),this._texCoordArr=new Float32Array([]),this._startPositionHighArr=new Float32Array([]),this._startPositionLowArr=new Float32Array([]),this._endPositionHighArr=new Float32Array([]),this._endPositionLowArr=new Float32Array([]),this._thicknessArr=new Float32Array([]),this._rgbaArr=new Float32Array([]),this._texOffsetArr=new Float32Array([]),this._strokeSizeArr=new Float32Array([]),this._removeRays(),this._deleteBuffers(),this.refresh()}_deleteBuffers(){if(this._renderer){let t=this._renderer.handler.gl;t&&(t.deleteBuffer(this._startPositionHighBuffer),t.deleteBuffer(this._startPositionLowBuffer),t.deleteBuffer(this._endPositionHighBuffer),t.deleteBuffer(this._endPositionLowBuffer),t.deleteBuffer(this._thicknessBuffer),t.deleteBuffer(this._rgbaBuffer),t.deleteBuffer(this._vertexBuffer),t.deleteBuffer(this._texCoordBuffer),t.deleteBuffer(this._texOffsetBuffer),t.deleteBuffer(this._strokeSizeBuffer)),this._startPositionHighBuffer=null,this._startPositionLowBuffer=null,this._endPositionHighBuffer=null,this._endPositionLowBuffer=null,this._thicknessBuffer=null,this._rgbaBuffer=null,this._vertexBuffer=null,this._texCoordBuffer=null,this._texOffsetBuffer=null,this._strokeSizeBuffer=null}}update(){if(this._renderer){let t=this._changedBuffers.length;for(;t--;)this._changedBuffers[t]&&(this._buffersUpdateCallbacks[t].call(this),this._changedBuffers[t]=!1)}}add(t){t._handlerIndex==-1&&(t._handler=this,t._handlerIndex=this._rays.length,this._rays.push(t),this._addRayToArrays(t),this.refresh())}_addRayToArrays(t){t.getVisibility()?this._vertexArr=bt(this._vertexArr,[-.5,1,-.5,0,.5,0,.5,0,.5,1,-.5,1]):this._vertexArr=bt(this._vertexArr,[0,0,0,0,0,0,0,0,0,0,0,0]);let n=t.texOffset;this._texOffsetArr=it(this._texOffsetArr,[n,n,n,n,n,n]),n=t.strokeSize,this._strokeSizeArr=it(this._strokeSizeArr,[n,n,n,n,n,n]),this._texCoordArr=it(this._texCoordArr,[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),n=t._startPositionHigh.x;let s=t._startPositionHigh.y,o=t._startPositionHigh.z;this._startPositionHighArr=bt(this._startPositionHighArr,[n,s,o,n,s,o,n,s,o,n,s,o,n,s,o,n,s,o]),n=t._startPositionLow.x,s=t._startPositionLow.y,o=t._startPositionLow.z,this._startPositionLowArr=bt(this._startPositionLowArr,[n,s,o,n,s,o,n,s,o,n,s,o,n,s,o,n,s,o]),n=t._endPositionHigh.x,s=t._endPositionHigh.y,o=t._endPositionHigh.z,this._endPositionHighArr=bt(this._endPositionHighArr,[n,s,o,n,s,o,n,s,o,n,s,o,n,s,o,n,s,o]),n=t._endPositionLow.x,s=t._endPositionLow.y,o=t._endPositionLow.z,this._endPositionLowArr=bt(this._endPositionLowArr,[n,s,o,n,s,o,n,s,o,n,s,o,n,s,o,n,s,o]),n=t._thickness,this._thicknessArr=bt(this._thicknessArr,[n,n,n,n,n,n]);let a=t._startColor.x,h=t._startColor.y,c=t._startColor.z,u=t._startColor.w,d=t._endColor.x,f=t._endColor.y,g=t._endColor.z,_=t._endColor.w;this._rgbaArr=bt(this._rgbaArr,[d,f,g,_,a,h,c,u,a,h,c,u,a,h,c,u,d,f,g,_,d,f,g,_]),n=t._entity._pickingColor.x/255,s=t._entity._pickingColor.y/255,o=t._entity._pickingColor.z/255,this._pickingColorArr=bt(this._pickingColorArr,[n,s,o,n,s,o,n,s,o,n,s,o,n,s,o,n,s,o])}_displayPASS(){let t=this._renderer,n=t.handler;n.programs.rayScreen.activate();let s=n.programs.rayScreen._program,o=s.attributes,a=s.uniforms,h=n.gl,c=this._entityCollection;h.disable(h.CULL_FACE),h.uniform1f(a.uOpacity,c._fadingOpacity),h.uniform1i(a.u_texAtlas,0),h.uniformMatrix4fv(a.viewMatrix,!1,t.activeCamera.getViewMatrix()),h.uniformMatrix4fv(a.projectionMatrix,!1,t.activeCamera.getProjectionMatrix()),h.uniform3fv(a.eyePositionHigh,t.activeCamera.eyeHigh),h.uniform3fv(a.eyePositionLow,t.activeCamera.eyeLow),h.uniform1f(a.resolution,t.activeCamera._tanViewAngle_hradOneByHeight),h.uniform2fv(a.viewport,[t.handler.canvas.width,t.handler.canvas.height]),h.bindBuffer(h.ARRAY_BUFFER,this._startPositionHighBuffer),h.vertexAttribPointer(o.a_startPosHigh,this._startPositionHighBuffer.itemSize,h.FLOAT,!1,0,0),h.bindBuffer(h.ARRAY_BUFFER,this._startPositionLowBuffer),h.vertexAttribPointer(o.a_startPosLow,this._startPositionLowBuffer.itemSize,h.FLOAT,!1,0,0),h.bindBuffer(h.ARRAY_BUFFER,this._endPositionHighBuffer),h.vertexAttribPointer(o.a_endPosHigh,this._endPositionHighBuffer.itemSize,h.FLOAT,!1,0,0),h.bindBuffer(h.ARRAY_BUFFER,this._endPositionLowBuffer),h.vertexAttribPointer(o.a_endPosLow,this._endPositionLowBuffer.itemSize,h.FLOAT,!1,0,0),h.bindBuffer(h.ARRAY_BUFFER,this._rgbaBuffer),h.vertexAttribPointer(o.a_rgba,this._rgbaBuffer.itemSize,h.FLOAT,!1,0,0),h.bindBuffer(h.ARRAY_BUFFER,this._thicknessBuffer),h.vertexAttribPointer(o.a_thickness,this._thicknessBuffer.itemSize,h.FLOAT,!1,0,0),h.bindBuffer(h.ARRAY_BUFFER,this._vertexBuffer),h.vertexAttribPointer(o.a_vertices,this._vertexBuffer.itemSize,h.FLOAT,!1,0,0),h.bindBuffer(h.ARRAY_BUFFER,this._texCoordBuffer),h.vertexAttribPointer(o.a_texCoord,this._texCoordBuffer.itemSize,h.FLOAT,!1,0,0),h.bindBuffer(h.ARRAY_BUFFER,this._texOffsetBuffer),h.vertexAttribPointer(o.a_texOffset,this._texOffsetBuffer.itemSize,h.FLOAT,!1,0,0),h.bindBuffer(h.ARRAY_BUFFER,this._strokeSizeBuffer),h.vertexAttribPointer(o.a_strokeSize,this._strokeSizeBuffer.itemSize,h.FLOAT,!1,0,0),h.drawArrays(h.TRIANGLES,0,this._vertexBuffer.numItems),h.enable(h.CULL_FACE)}_pickingPASS(){}draw(){this._rays.length&&(this.update(),this._displayPASS())}drawPicking(){this._rays.length&&this.pickingEnabled&&this._pickingPASS()}reindexRaysArray(t){let n=this._rays;for(let s=t;s<n.length;s++)n[s]._handlerIndex=s}_removeRay(t){let n=t._handlerIndex;this._rays.splice(n,1);let s=24*n;this._rgbaArr=Et(this._rgbaArr,s,24),this._texCoordArr=ot(this._texCoordArr,s,24),s=18*n,this._startPositionHighArr=Et(this._startPositionHighArr,s,18),this._startPositionLowArr=Et(this._startPositionLowArr,s,18),this._endPositionHighArr=Et(this._endPositionHighArr,s,18),this._endPositionLowArr=Et(this._endPositionLowArr,s,18),this._pickingColorArr=Et(this._pickingColorArr,s,18),s=12*n,this._vertexArr=Et(this._vertexArr,s,12),s=6*n,this._thicknessArr=Et(this._thicknessArr,s,6),this._texOffsetArr=ot(this._texOffsetArr,s,6),this._strokeSizeArr=ot(this._strokeSizeArr,s,6),this.reindexRaysArray(n),this.refresh(),t._handlerIndex=-1,t._handler=null}remove(t){t._handler&&this.__id===t._handler.__id&&this._removeRay(t)}setStartPositionArr(t,n,s){let o=18*t,a=this._startPositionHighArr,h=n.x,c=n.y,u=n.z;a[o]=h,a[o+1]=c,a[o+2]=u,a[o+3]=h,a[o+4]=c,a[o+5]=u,a[o+6]=h,a[o+7]=c,a[o+8]=u,a[o+9]=h,a[o+10]=c,a[o+11]=u,a[o+12]=h,a[o+13]=c,a[o+14]=u,a[o+15]=h,a[o+16]=c,a[o+17]=u,a=this._startPositionLowArr,h=s.x,c=s.y,u=s.z,a[o]=h,a[o+1]=c,a[o+2]=u,a[o+3]=h,a[o+4]=c,a[o+5]=u,a[o+6]=h,a[o+7]=c,a[o+8]=u,a[o+9]=h,a[o+10]=c,a[o+11]=u,a[o+12]=h,a[o+13]=c,a[o+14]=u,a[o+15]=h,a[o+16]=c,a[o+17]=u,this._changedBuffers[1]=!0}setEndPositionArr(t,n,s){let o=18*t,a=this._endPositionHighArr,h=n.x,c=n.y,u=n.z;a[o]=h,a[o+1]=c,a[o+2]=u,a[o+3]=h,a[o+4]=c,a[o+5]=u,a[o+6]=h,a[o+7]=c,a[o+8]=u,a[o+9]=h,a[o+10]=c,a[o+11]=u,a[o+12]=h,a[o+13]=c,a[o+14]=u,a[o+15]=h,a[o+16]=c,a[o+17]=u,a=this._endPositionLowArr,h=s.x,c=s.y,u=s.z,a[o]=h,a[o+1]=c,a[o+2]=u,a[o+3]=h,a[o+4]=c,a[o+5]=u,a[o+6]=h,a[o+7]=c,a[o+8]=u,a[o+9]=h,a[o+10]=c,a[o+11]=u,a[o+12]=h,a[o+13]=c,a[o+14]=u,a[o+15]=h,a[o+16]=c,a[o+17]=u,this._changedBuffers[2]=!0}setPickingColorArr(t,n){let s=18*t,o=this._pickingColorArr,a=n.x/255,h=n.y/255,c=n.z/255;o[s]=a,o[s+1]=h,o[s+2]=c,o[s+3]=a,o[s+4]=h,o[s+5]=c,o[s+6]=a,o[s+7]=h,o[s+8]=c,o[s+9]=a,o[s+10]=h,o[s+11]=c,o[s+12]=a,o[s+13]=h,o[s+14]=c,o[s+15]=a,o[s+16]=h,o[s+17]=c,this._changedBuffers[0]=!0}setRgbaArr(t,n,s){let o=24*t,a=this._rgbaArr,h=n.x,c=n.y,u=n.z,d=n.w,f=s.x,g=s.y,_=s.z,m=s.w;a[o]=f,a[o+1]=g,a[o+2]=_,a[o+3]=m,a[o+4]=h,a[o+5]=c,a[o+6]=u,a[o+7]=d,a[o+8]=h,a[o+9]=c,a[o+10]=u,a[o+11]=d,a[o+12]=h,a[o+13]=c,a[o+14]=u,a[o+15]=d,a[o+16]=f,a[o+17]=g,a[o+18]=_,a[o+19]=m,a[o+20]=f,a[o+21]=g,a[o+22]=_,a[o+23]=m,this._changedBuffers[3]=!0}setThicknessArr(t,n){let s=6*t,o=this._thicknessArr;o[s]=n,o[s+1]=n,o[s+2]=n,o[s+3]=n,o[s+4]=n,o[s+5]=n,this._changedBuffers[4]=!0}setVisibility(t,n){let s;s=n?[-.5,1,-.5,0,.5,0,.5,0,.5,1,-.5,1]:[0,0,0,0,0,0,0,0,0,0,0,0],this.setVertexArr(t,s)}setVertexArr(t,n){let s=12*t,o=this._vertexArr;o[s]=n[0],o[s+1]=n[1],o[s+2]=n[2],o[s+3]=n[3],o[s+4]=n[4],o[s+5]=n[5],o[s+6]=n[6],o[s+7]=n[7],o[s+8]=n[8],o[s+9]=n[9],o[s+10]=n[10],o[s+11]=n[11],this._changedBuffers[5]=!0}createStartPositionBuffer(){let t=this._renderer.handler;t.gl.deleteBuffer(this._startPositionHighBuffer),this._startPositionHighArr=st(this._startPositionHighArr),this._startPositionHighBuffer=t.createArrayBuffer(this._startPositionHighArr,3,this._startPositionHighArr.length/3,t.gl.DYNAMIC_DRAW),t.gl.deleteBuffer(this._startPositionLowBuffer),this._startPositionLowArr=st(this._startPositionLowArr),this._startPositionLowBuffer=t.createArrayBuffer(this._startPositionLowArr,3,this._startPositionLowArr.length/3,t.gl.DYNAMIC_DRAW)}createEndPositionBuffer(){let t=this._renderer.handler;t.gl.deleteBuffer(this._endPositionHighBuffer),this._endPositionHighArr=st(this._endPositionHighArr),this._endPositionHighBuffer=t.createArrayBuffer(this._endPositionHighArr,3,this._endPositionHighArr.length/3,t.gl.DYNAMIC_DRAW),t.gl.deleteBuffer(this._endPositionLowBuffer),this._endPositionLowArr=st(this._endPositionLowArr),this._endPositionLowBuffer=t.createArrayBuffer(this._endPositionLowArr,3,this._endPositionLowArr.length/3,t.gl.DYNAMIC_DRAW)}createRgbaBuffer(){let t=this._renderer.handler;t.gl.deleteBuffer(this._rgbaBuffer),this._rgbaArr=st(this._rgbaArr),this._rgbaBuffer=t.createArrayBuffer(this._rgbaArr,4,this._rgbaArr.length/4)}createThicknessBuffer(){let t=this._renderer.handler;t.gl.deleteBuffer(this._thicknessBuffer),this._thicknessArr=st(this._thicknessArr),this._thicknessBuffer=t.createArrayBuffer(this._thicknessArr,1,this._thicknessArr.length,t.gl.DYNAMIC_DRAW)}createVertexBuffer(){let t=this._renderer.handler;t.gl.deleteBuffer(this._vertexBuffer),this._vertexArr=st(this._vertexArr),this._vertexBuffer=t.createArrayBuffer(this._vertexArr,2,this._vertexArr.length/2,t.gl.DYNAMIC_DRAW)}createTexCoordBuffer(){let t=this._renderer.handler;t.gl.deleteBuffer(this._texCoordBuffer),this._texCoordBuffer=t.createArrayBuffer(this._texCoordArr,4,this._texCoordArr.length/4)}createTexOffsetBuffer(){let t=this._renderer.handler;t.gl.deleteBuffer(this._texOffsetBuffer),this._texOffsetBuffer=t.createArrayBuffer(this._texOffsetArr,1,this._texOffsetArr.length)}createStrokeSizeBuffer(){let t=this._renderer.handler;t.gl.deleteBuffer(this._strokeSizeBuffer),this._strokeSizeBuffer=t.createArrayBuffer(this._strokeSizeArr,1,this._strokeSizeArr.length)}createPickingColorBuffer(){let t=this._renderer.handler;t.gl.deleteBuffer(this._pickingColorBuffer),this._pickingColorArr=st(this._pickingColorArr),this._pickingColorBuffer=t.createArrayBuffer(this._pickingColorArr,3,this._pickingColorArr.length/3)}setTexCoordArr(t,n){let s=n[1],o=n[3]-s,a=24*t,h=this._texCoordArr;h[a]=n[0],h[a+1]=n[1],h[a+2]=s,h[a+3]=o,h[a+4]=n[2],h[a+5]=n[3],h[a+6]=s,h[a+7]=o,h[a+8]=n[4],h[a+9]=n[5],h[a+10]=s,h[a+11]=o,h[a+12]=n[6],h[a+13]=n[7],h[a+14]=s,h[a+15]=o,h[a+16]=n[8],h[a+17]=n[9],h[a+18]=s,h[a+19]=o,h[a+20]=n[10],h[a+21]=n[11],h[a+22]=s,h[a+23]=o,this._changedBuffers[6]=!0}setTextureDisabled(t){let n=24*t,s=this._texCoordArr;s[n+3]=0,s[n+7]=0,s[n+11]=0,s[n+15]=0,s[n+19]=0,s[n+23]=0,this._changedBuffers[6]=!0}setTexOffsetArr(t,n){let s=6*t,o=this._texOffsetArr;o[s]=n,o[s+1]=n,o[s+2]=n,o[s+3]=n,o[s+4]=n,o[s+5]=n,this._changedBuffers[7]=!0}setStrokeSizeArr(t,n){let s=6*t,o=this._strokeSizeArr;o[s]=n,o[s+1]=n,o[s+2]=n,o[s+3]=n,o[s+4]=n,o[s+5]=n,this._changedBuffers[8]=!0}refreshTexCoordsArr(){if(this._entityCollection&&this._renderer){let t=this._renderer.strokeTextureAtlas;for(let n=0;n<this._rays.length;n++){let s=this._rays[n],o=s.getImage();if(o){let a=t.get(o.__nodeIndex);a&&this.setTexCoordArr(s._handlerIndex,a.texCoords)}}}}};Es.__counter__=0;let Sr=Es;const As=class ud{constructor(t){this.__id=ud.__counter__++,this.pickingEnabled=!0,this._entityCollection=t,this._renderer=null,this._strips=[]}_initProgram(){this._renderer&&this._renderer.handler&&!this._renderer.handler.programs.strip&&this._renderer.handler.addProgram(new X("strip",{uniforms:{projectionMatrix:{type:"mat4"},viewMatrix:{type:"mat4"},eyePositionHigh:"vec3",eyePositionLow:"vec3",uColor:{type:"vec4"},uOpacity:{type:"float"}},attributes:{aVertexPositionHigh:{type:"vec3"},aVertexPositionLow:{type:"vec3"}},vertexShader:`attribute vec3 aVertexPositionHigh;
                        attribute vec3 aVertexPositionLow;
                        uniform mat4 projectionMatrix;
                        uniform mat4 viewMatrix;
                        uniform vec3 eyePositionHigh;
                        uniform vec3 eyePositionLow;
                        void main(void) {

                            vec3 highDiff = aVertexPositionHigh - eyePositionHigh;
                            vec3 lowDiff = aVertexPositionLow - eyePositionLow;

                            mat4 viewMatrixRTE = viewMatrix;
                            viewMatrixRTE[3] = vec4(0.0, 0.0, 0.0, 1.0);

                            gl_Position = projectionMatrix * viewMatrixRTE * vec4(highDiff * step(1.0, length(highDiff)) + lowDiff, 1.0);
                        }`,fragmentShader:`precision highp float;
                        uniform vec4 uColor;
                        uniform float uOpacity;
                        void main(void) {
                            gl_FragColor = vec4(uColor.rgb, uColor.a * uOpacity);
                        }`}))}setRenderNode(t){this._renderer=t.renderer,this._initProgram();for(let n=0;n<this._strips.length;n++)this._strips[n].setRenderNode(t)}add(t){t._handlerIndex===-1&&(t._handler=this,t._handlerIndex=this._strips.length,this._strips.push(t),this._entityCollection&&this._entityCollection.renderNode&&t.setRenderNode(this._entityCollection.renderNode))}remove(t){let n=t._handlerIndex;n!==-1&&(t._deleteBuffers(),t._handlerIndex=-1,t._handler=null,this._strips.splice(n,1),this.reindexStripArray(n))}reindexStripArray(t){let n=this._strips;for(let s=t;s<n.length;s++)n[s]._handlerIndex=s}draw(){let t=this._strips.length;for(;t--;)this._strips[t].draw()}drawPicking(){if(this.pickingEnabled){let t=this._strips.length;for(;t--;)this._strips[t].drawPicking()}}clear(){let t=this._strips.length;for(;t--;)this._strips[t]._deleteBuffers(),this._strips[t]._handler=null,this._strips[t]._handlerIndex=-1;this._strips.length=0,this._strips=[]}};As.__counter__=0;let Rr=As;const Ls=class dd{constructor(t={}){this._onChangeRelativeCenter=s=>{this.geoObjectHandler.setRelativeCenter(s),this.polylineHandler.setRelativeCenter(s)},this.__id=dd.__counter__++,this.renderNode=null,this._visibility=t.visibility==null||t.visibility,this.polygonOffsetUnits=t.polygonOffsetUnits!=null?t.polygonOffsetUnits:0,this.billboardHandler=new sl(this),this.labelHandler=new nl(this,t.labelMaxLetters),this.polylineHandler=new Pr(this),this.rayHandler=new Sr(this),this.pointCloudHandler=new Lr(this),this.stripHandler=new Rr(this),this.geoObjectHandler=new Ar(this),t.pickingEnabled!=null&&this.setPickingEnabled(t.pickingEnabled),this._entities=[],this.scaleByDistance=t.scaleByDistance||[1,1,1];let n=new Float32Array([1,1,1]);t.pickingScale!==void 0&&(t.pickingScale instanceof Array?(n[0]=t.pickingScale[0]||n[0],n[1]=t.pickingScale[1]||n[1],n[2]=t.pickingScale[2]||n[2]):typeof t.pickingScale=="number"&&(n[0]=t.pickingScale,n[1]=t.pickingScale,n[2]=t.pickingScale)),this._depthOrder=t.depthOrder||0,this.pickingScale=n,this._opacity=t.opacity==null?1:t.opacity,this._fadingOpacity=this._opacity,this.events=this.rendererEvents=lt(ol,this),this._useLighting=t.useLighting!=null?t.useLighting?1:0:1,t.entities&&this.addEntities(t.entities)}get depthOrder(){return this._depthOrder}set depthOrder(t){this._depthOrder=t,this.renderNode&&this.renderNode.updateEntityCollectionsDepthOrder()}isEmpty(){return this._entities.length==0}get id(){return this.__id}get useLighting(){return!!this._useLighting}set useLighting(t){this._useLighting=Number(t)}isEqual(t){return t!==null&&this.__id===t.__id}setVisibility(t){var n;this._visibility=t,this._fadingOpacity=this._opacity*(t?1:0),(n=this.renderNode)==null||n.updateEntityCollectionsDepthOrder(),this.events.dispatch(this.events.visibilitychange,this)}getVisibility(){return this._visibility}setOpacity(t){this._opacity=t}setPickingEnabled(t){this.billboardHandler.pickingEnabled=t,this.labelHandler.pickingEnabled=t,this.polylineHandler.pickingEnabled=t,this.rayHandler.pickingEnabled=t,this.pointCloudHandler.pickingEnabled=t,this.stripHandler.pickingEnabled=t,this.geoObjectHandler.pickingEnabled=t}getOpacity(){return this._opacity}setScaleByDistance(t,n,s){this.scaleByDistance[0]=t,this.scaleByDistance[1]=n,this.scaleByDistance[2]=s||Ae}appendChildEntity(t){this._addRecursively(t)}_addRecursively(t){let n=this.renderNode;n&&n.ellipsoid&&t._cartesian.isZero()&&!t.relativePosition&&t.setCartesian3v(n.ellipsoid.lonLatToCartesian(t._lonLat)),this._setPickingColor(t),t._updateAbsolutePosition(),t.setScale3v(t.getScale()),t.billboard&&this.billboardHandler.add(t.billboard),t.label&&this.labelHandler.add(t.label),t.polyline&&this.polylineHandler.add(t.polyline),t.ray&&this.rayHandler.add(t.ray),t.pointCloud&&this.pointCloudHandler.add(t.pointCloud),t.strip&&this.stripHandler.add(t.strip),t.geoObject&&this.geoObjectHandler.add(t.geoObject),this.events.dispatch(this.events.entityadd,t);for(let s=0;s<t.childEntities.length;s++)t.childEntities[s]._entityCollection=this,this._addRecursively(t.childEntities[s])}add(t){return t._entityCollection||(t._entityCollection=this,t._entityCollectionIndex=this._entities.length,this._entities.push(t),this._addRecursively(t)),this}addEntities(t){for(let n=0,s=t.length;n<s;n++)this.add(t[n]);return this}belongs(t){return this.isEqual(t._entityCollection)}_removeRecursively(t){t._entityCollection=null,t._entityCollectionIndex=-1,t.billboard&&this.billboardHandler.remove(t.billboard),t.label&&this.labelHandler.remove(t.label),t.polyline&&this.polylineHandler.remove(t.polyline),t.ray&&this.rayHandler.remove(t.ray),t.pointCloud&&this.pointCloudHandler.remove(t.pointCloud),t.strip&&this.stripHandler.remove(t.strip),t.geoObject&&this.geoObjectHandler.remove(t.geoObject);for(let n=0;n<t.childEntities.length;n++)this._removeRecursively(t.childEntities[n])}_removeEntity(t){if(t.parent){let n=t.parent.childEntities;for(let s=0,o=n.length;s<o;s++)if(n[s].isEqual(t)){n.splice(s,1);break}t.parent=null}else this._entities.splice(t._entityCollectionIndex,1),this.reindexEntitiesArray(t._entityCollectionIndex);this.renderNode&&this.renderNode.renderer&&(this.renderNode.renderer.clearPickingColor(t),t._pickingColor.clear()),this._removeRecursively(t)}removeEntity(t){this.belongs(t)&&(this._removeEntity(t),this.events.dispatch(this.events.entityremove,t))}_removeEntitySilent(t){this.belongs(t)&&this._removeEntity(t)}createPickingColors(t=this._entities){if(this.renderNode&&this.renderNode.renderer)for(let n=0;n<t.length;n++){let s=t[n];this._setPickingColor(s),this.createPickingColors(s.childEntities)}}_setPickingColor(t){this.renderNode&&this.renderNode.renderer&&(t._independentPicking||!t.parent?this.renderNode.renderer.assignPickingColor(t):t._pickingColor=t.parent._pickingColor,this.renderNode.renderer.assignPickingColor(t),t.setPickingColor())}reindexEntitiesArray(t){let n=this._entities;for(let s=t;s<n.length;s++)n[s]._entityCollectionIndex=s}addTo(t,n=!1){return this.renderNode||t.addEntityCollection(this,n),this}bindRenderNode(t){t.renderer&&t.renderer.isInitialized()&&(this.billboardHandler.setRenderer(t.renderer),this.labelHandler.setRenderer(t.renderer),this.rayHandler.setRenderer(t.renderer),this.geoObjectHandler.setRenderNode(t),this.polylineHandler.setRenderNode(t),this.pointCloudHandler.setRenderNode(t),this.stripHandler.setRenderNode(t),t.renderer.events.on("changerelativecenter",this._onChangeRelativeCenter),this.updateBillboardsTextureAtlas(),this.updateLabelsFontAtlas(),this.updateStrokeTextureAtlas(),this.createPickingColors())}_updateGeodeticCoordinates(t){let n=this._entities,s=n.length;for(;s--;){let o=n[s];o._lonLat&&o.setCartesian3v(t.lonLatToCartesian(o._lonLat))}}updateBillboardsTextureAtlas(){let t=this.billboardHandler.billboards;for(let n=0;n<t.length;n++)t[n].setSrc(t[n].getSrc())}updateLabelsFontAtlas(){this.renderNode&&this.labelHandler.updateFonts()}updateStrokeTextureAtlas(){this.rayHandler.reloadTextures(),this.polylineHandler.reloadTextures()}remove(){var t;this.renderNode&&(this.renderNode.removeEntityCollection(this),(t=this.renderNode.renderer)==null||t.events.off("changerelativecenter",this._onChangeRelativeCenter),this.renderNode=null,this.events.dispatch(this.events.remove,this))}getEntities(){return[].concat(this._entities)}each(t){let n=this._entities.length;for(;n--;){let s=this._entities[n];s&&t(s)}}clear(){this.billboardHandler.clear(),this.labelHandler.clear(),this.polylineHandler.clear(),this.rayHandler.clear(),this.pointCloudHandler.clear(),this.stripHandler.clear(),this.geoObjectHandler.clear();let t=this._entities.length;for(;t--;){let n=this._entities[t];this.renderNode&&this.renderNode.renderer&&(this.renderNode.renderer.clearPickingColor(n),n._pickingColor.clear()),this._clearEntity(n)}this._entities.length=0,this._entities=[]}_clearEntity(t){t._entityCollection=null,t._entityCollectionIndex=-1;for(let n=0;n<t.childEntities.length;n++)this._clearEntity(t.childEntities[n])}};Ls.__counter__=0;let se=Ls;const ol=["draw","drawend","add","remove","entityadd","entityremove","visibilitychange","mousemove","mouseenter","mouseleave","lclick","rclick","mclick","ldblclick","rdblclick","mdblclick","lup","rup","mup","ldown","rdown","mdown","lhold","rhold","mhold","mousewheel","touchmove","touchstart","touchend","doubletouch","touchleave","touchenter"];function ae(l,t){if(l>=0){let n=65536*Math.floor(l/65536);t[0]=Math.fround(n),t[1]=Math.fround(l-n)}else{let n=65536*Math.floor(-l/65536);t[0]=Math.fround(-n),t[1]=Math.fround(l+n)}return t}function An(l,t){if(l>=0){let n=65536*Math.floor(l/65536);t.x=Math.fround(n),t.y=Math.fround(l-n)}else{let n=65536*Math.floor(-l/65536);t.x=Math.fround(-n),t.y=Math.fround(l+n)}return t}function Ln(l,t,n){n=n||2;var s,o,a,h,c,u,d,f=t&&t.length,g=f?t[0]*n:l.length,_=Pn(l,0,g,n,!0),m=[];if(!_)return m;if(f&&(_=function(p,x,y,T){var S,C,P,w=[];for(S=0,C=x.length;S<C;S++)(P=Pn(p,x[S]*T,S<C-1?x[S+1]*T:p.length,T,!1))===P.next&&(P.steiner=!0),w.push(_l(P));for(w.sort(dl),S=0;S<w.length;S++)ul(w[S],y),y=wi(y,y.next);return y}(l,t,_,n)),l.length>80*n){s=a=l[0],o=h=l[1];for(let p=n;p<g;p+=n)(c=l[p])<s&&(s=c),(u=l[p+1])<o&&(o=u),c>a&&(a=c),u>h&&(h=u);d=Math.max(a-s,h-o)}return Ti(_,m,n,s,o,d),m}function Pn(l,t,n,s,o){var a,h;if(o===function(c,u,d,f){var g=0;for(let _=u,m=d-f;_<d;_+=f)g+=(c[m]-c[_])*(c[_+1]+c[m+1]),m=_;return g}(l,t,n,s)>0)for(a=t;a<n;a+=s)h=Sn(a,l[a],l[a+1],h);else for(a=n-s;a>=t;a-=s)h=Sn(a,l[a],l[a+1],h);return h&&Te(h,h.next)&&(Ei(h),h=h.next),h}function wi(l,t){if(!l)return l;t||(t=l);var n,s=l;do if(n=!1,s.steiner||!Te(s,s.next)&&It(s.prev,s,s.next)!==0)s=s.next;else{if(Ei(s),(s=t=s.prev)===s.next)return null;n=!0}while(n||s!==t);return t}function Ti(l,t,n,s,o,a,h){if(l){!h&&a&&function(f,g,_,m){var p=f;do p.z===null&&(p.z=Mr(p.x,p.y,g,_,m)),p.prevZ=p.prev,p.nextZ=p.next,p=p.next;while(p!==f);p.prevZ.nextZ=null,p.prevZ=null,function(x){var y,T,S,C,P,w,I,O,N=1;do{for(T=x,x=null,P=null,w=0;T;){for(w++,S=T,I=0,y=0;y<N&&(I++,S=S.nextZ);y++);for(O=N;I>0||O>0&&S;)I!==0&&(O===0||!S||T.z<=S.z)?(C=T,T=T.nextZ,I--):(C=S,S=S.nextZ,O--),P?P.nextZ=C:x=C,C.prevZ=P,P=C;T=S}P.nextZ=null,N*=2}while(w>1)}(p)}(l,s,o,a);for(var c,u,d=l;l.prev!==l.next;)if(c=l.prev,u=l.next,a?ll(l,s,o,a):al(l))t.push(c.i/n),t.push(l.i/n),t.push(u.i/n),Ei(l),l=u.next,d=u.next;else if((l=u)===d){h?h===1?Ti(l=hl(l,t,n),t,n,s,o,a,2):h===2&&cl(l,t,n,s,o,a):Ti(wi(l),t,n,s,o,a,1);break}}}function al(l){var t=l.prev,n=l,s=l.next;if(It(t,n,s)>=0)return!1;for(var o=l.next.next;o!==l.prev;){if(os(t.x,t.y,n.x,n.y,s.x,s.y,o.x,o.y)&&It(o.prev,o,o.next)>=0)return!1;o=o.next}return!0}function ll(l,t,n,s){var o=l.prev,a=l,h=l.next;if(It(o,a,h)>=0)return!1;for(var c=o.x<a.x?o.x<h.x?o.x:h.x:a.x<h.x?a.x:h.x,u=o.y<a.y?o.y<h.y?o.y:h.y:a.y<h.y?a.y:h.y,d=o.x>a.x?o.x>h.x?o.x:h.x:a.x>h.x?a.x:h.x,f=o.y>a.y?o.y>h.y?o.y:h.y:a.y>h.y?a.y:h.y,g=Mr(c,u,t,n,s),_=Mr(d,f,t,n,s),m=l.nextZ;m&&m.z<=_;){if(m!==l.prev&&m!==l.next&&os(o.x,o.y,a.x,a.y,h.x,h.y,m.x,m.y)&&It(m.prev,m,m.next)>=0)return!1;m=m.nextZ}for(m=l.prevZ;m&&m.z>=g;){if(m!==l.prev&&m!==l.next&&os(o.x,o.y,a.x,a.y,h.x,h.y,m.x,m.y)&&It(m.prev,m,m.next)>=0)return!1;m=m.prevZ}return!0}function hl(l,t,n){var s=l;do{var o=s.prev,a=s.next.next;!Te(o,a)&&ra(o,s,s.next,a)&&Ci(o,a)&&Ci(a,o)&&(t.push(o.i/n),t.push(s.i/n),t.push(a.i/n),Ei(s),Ei(s.next),s=l=a),s=s.next}while(s!==l);return s}function cl(l,t,n,s,o,a){var h=l;do{for(var c=h.next.next;c!==h.prev;){if(h.i!==c.i&&fl(h,c)){var u=na(h,c);return h=wi(h,h.next),u=wi(u,u.next),Ti(h,t,n,s,o,a),void Ti(u,t,n,s,o,a)}c=c.next}h=h.next}while(h!==l)}function dl(l,t){return l.x-t.x}function ul(l,t){if(t=function(s,o){var a,h=o,c=s.x,u=s.y,d=-1/0;do{if(u<=h.y&&u>=h.next.y&&h.next.y!==h.y){var f=h.x+(u-h.y)*(h.next.x-h.x)/(h.next.y-h.y);if(f<=c&&f>d){if(d=f,f===c){if(u===h.y)return h;if(u===h.next.y)return h.next}a=h.x<h.next.x?h:h.next}}h=h.next}while(h!==o);if(!a)return null;if(c===d)return a.prev;var g,_=a,m=a.x,p=a.y,x=1/0;for(h=a.next;h!==_;)c>=h.x&&h.x>=m&&c!==h.x&&os(u<p?c:d,u,m,p,u<p?d:c,u,h.x,h.y)&&((g=Math.abs(u-h.y)/(c-h.x))<x||g===x&&h.x>a.x)&&Ci(h,s)&&(a=h,x=g),h=h.next;return a}(l,t)){var n=na(t,l);wi(n,n.next)}}function Mr(l,t,n,s,o){return(l=1431655765&((l=858993459&((l=252645135&((l=16711935&((l=32767*(l-n)/o)|l<<8))|l<<4))|l<<2))|l<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-s)/o)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function _l(l){var t=l,n=l;do t.x<n.x&&(n=t),t=t.next;while(t!==l);return n}function os(l,t,n,s,o,a,h,c){return(o-h)*(t-c)-(l-h)*(a-c)>=0&&(l-h)*(s-c)-(n-h)*(t-c)>=0&&(n-h)*(a-c)-(o-h)*(s-c)>=0}function fl(l,t){return l.next.i!==t.i&&l.prev.i!==t.i&&!function(n,s){var o=n;do{if(o.i!==n.i&&o.next.i!==n.i&&o.i!==s.i&&o.next.i!==s.i&&ra(o,o.next,n,s))return!0;o=o.next}while(o!==n);return!1}(l,t)&&Ci(l,t)&&Ci(t,l)&&function(n,s){var o=n,a=!1,h=(n.x+s.x)/2,c=(n.y+s.y)/2;do o.y>c!=o.next.y>c&&o.next.y!==o.y&&h<(o.next.x-o.x)*(c-o.y)/(o.next.y-o.y)+o.x&&(a=!a),o=o.next;while(o!==n);return a}(l,t)}function It(l,t,n){return(t.y-l.y)*(n.x-t.x)-(t.x-l.x)*(n.y-t.y)}function Te(l,t){return l.x===t.x&&l.y===t.y}function ra(l,t,n,s){return!!(Te(l,t)&&Te(n,s)||Te(l,s)&&Te(n,t))||It(l,t,n)>0!=It(l,t,s)>0&&It(n,s,l)>0!=It(n,s,t)>0}function Ci(l,t){return It(l.prev,l,l.next)<0?It(l,t,l.next)>=0&&It(l,l.prev,t)>=0:It(l,t,l.prev)<0||It(l,l.next,t)<0}function na(l,t){var n=new Br(l.i,l.x,l.y),s=new Br(t.i,t.x,t.y),o=l.next,a=t.prev;return l.next=t,t.prev=l,n.next=o,o.prev=n,s.next=n,n.prev=s,a.next=s,s.prev=a,s}function Sn(l,t,n,s){var o=new Br(l,t,n);return s?(o.next=s.next,o.prev=s,s.next.prev=o,s.next=o):(o.prev=o,o.next=o),o}function Ei(l){l.next.prev=l.prev,l.prev.next=l.next,l.prevZ&&(l.prevZ.nextZ=l.nextZ),l.nextZ&&(l.nextZ.prevZ=l.prevZ)}function Br(l,t,n){this.i=l,this.x=t,this.y=n,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}function Rn(l){var t=l[0][0].length,n={vertices:[],holes:[],dimensions:t},s=0;for(let o=0;o<l.length;o++){for(let a=0;a<l[o].length;a++)for(let h=0;h<t;h++)n.vertices.push(l[o][a][h]);o>0&&(s+=l[o-1].length,n.holes.push(s))}return n}function qs(l,t,n){let s=l[0],o=l[1];if(s>=0){let a=65536*Math.floor(s/65536);t.x=Math.fround(a),n.x=Math.fround(s-a)}else{let a=65536*Math.floor(-s/65536);t.x=Math.fround(-a),n.x=Math.fround(s+a)}if(o>=0){let a=65536*Math.floor(o/65536);t.y=Math.fround(a),n.y=Math.fround(o-a)}else{let a=65536*Math.floor(-o/65536);t.y=Math.fround(-a),n.y=Math.fround(o+a)}}let q=new H,Y=new H,De=new H;const ge=class au{constructor(t){this.__id=au.__counter__++,this._layer=t,this._handler=null,this._geometries=[],this._updatedGeometryArr=[],this._updatedGeometry={},this._removeGeometryExtentArr=[],this._removeGeometryExtents={},this._polyVerticesHighMerc=[],this._polyVerticesLowMerc=[],this._polyColors=[],this._polyPickingColors=[],this._polyIndexes=[],this._lineVerticesHighMerc=[],this._lineVerticesLowMerc=[],this._lineOrders=[],this._lineIndexes=[],this._lineColors=[],this._linePickingColors=[],this._lineThickness=[],this._lineStrokes=[],this._lineStrokeColors=[],this._polyVerticesHighBufferMerc=null,this._polyVerticesLowBufferMerc=null,this._polyColorsBuffer=null,this._polyPickingColorsBuffer=null,this._polyIndexesBuffer=null,this._lineVerticesHighBufferMerc=null,this._lineVerticesLowBufferMerc=null,this._lineColorsBuffer=null,this._linePickingColorsBuffer=null,this._lineThicknessBuffer=null,this._lineStrokesBuffer=null,this._lineStrokeColorsBuffer=null,this._lineOrdersBuffer=null,this._lineIndexesBuffer=null,this._buffersUpdateCallbacks=[],this._buffersUpdateCallbacks[0]=this.createPolyVerticesBuffer,this._buffersUpdateCallbacks[1]=this.createPolyIndexesBuffer,this._buffersUpdateCallbacks[2]=this.createPolyColorsBuffer,this._buffersUpdateCallbacks[3]=this.createLineVerticesBuffer,this._buffersUpdateCallbacks[4]=this.createLineIndexesBuffer,this._buffersUpdateCallbacks[5]=this.createLineOrdersBuffer,this._buffersUpdateCallbacks[6]=this.createLineColorsBuffer,this._buffersUpdateCallbacks[7]=this.createLineThicknessBuffer,this._buffersUpdateCallbacks[8]=this.createLineStrokesBuffer,this._buffersUpdateCallbacks[9]=this.createLineStrokeColorsBuffer,this._buffersUpdateCallbacks[10]=this.createPolyPickingColorsBuffer,this._buffersUpdateCallbacks[11]=this.createLinePickingColorsBuffer,this._changedBuffers=new Array(this._buffersUpdateCallbacks.length)}static appendLineData(t,n,s,o,a,h,c,u,d,f,g,_,m,p,x,y,T,S){var C=0;g.length>0?(C=g[g.length-5]+9,g.push(C,C)):g.push(0,0);var P=a,w=[s.x,s.y,s.z,s.w],I=c,O=[h.x,h.y,h.z,h.w],N=[o.x,o.y,o.z,1];for(let D=0;D<t.length;D++){var k=t[D];if(k.length===0)continue;let ze,z,Ee=C;if(n)ze=k[k.length-1];else{let B=k[0],rt=k[1];rt||(rt=B),ze=[B[0]+B[0]-rt[0],B[1]+B[1]-rt[1]]}qs(ze,q,Y),u.push(q.x,q.y,q.x,q.y,q.x,q.y,q.x,q.y),d.push(Y.x,Y.y,Y.x,Y.y,Y.x,Y.y,Y.x,Y.y),T.push(q.x,q.y,q.x,q.y,q.x,q.y,q.x,q.y),S.push(Y.x,Y.y,Y.x,Y.y,Y.x,Y.y,Y.x,Y.y),f.push(1,-1,2,-2),p.push(P,P,P,P),y.push(I,I,I,I),_.push(w[0],w[1],w[2],w[3],w[0],w[1],w[2],w[3],w[0],w[1],w[2],w[3],w[0],w[1],w[2],w[3]),x.push(O[0],O[1],O[2],O[3],O[0],O[1],O[2],O[3],O[0],O[1],O[2],O[3],O[0],O[1],O[2],O[3]),m.push(N[0],N[1],N[2],N[3],N[0],N[1],N[2],N[3],N[0],N[1],N[2],N[3],N[0],N[1],N[2],N[3]);for(let B=0;B<k.length;B++)qs(k[B],q,Y),u.push(q.x,q.y,q.x,q.y,q.x,q.y,q.x,q.y),d.push(Y.x,Y.y,Y.x,Y.y,Y.x,Y.y,Y.x,Y.y),T.push(q.x,q.y,q.x,q.y,q.x,q.y,q.x,q.y),S.push(Y.x,Y.y,Y.x,Y.y,Y.x,Y.y,Y.x,Y.y),f.push(1,-1,2,-2),p.push(P,P,P,P),y.push(I,I,I,I),_.push(w[0],w[1],w[2],w[3],w[0],w[1],w[2],w[3],w[0],w[1],w[2],w[3],w[0],w[1],w[2],w[3]),x.push(O[0],O[1],O[2],O[3],O[0],O[1],O[2],O[3],O[0],O[1],O[2],O[3],O[0],O[1],O[2],O[3]),m.push(N[0],N[1],N[2],N[3],N[0],N[1],N[2],N[3],N[0],N[1],N[2],N[3],N[0],N[1],N[2],N[3]),g.push(C++,C++,C++,C++);if(n)z=k[0],g.push(Ee,Ee+1,Ee+1,Ee+1);else{let B=k[k.length-1],rt=k[k.length-2];rt||(rt=B),z=[B[0]+B[0]-rt[0],B[1]+B[1]-rt[1]],g.push(C-1,C-1,C-1,C-1)}qs(z,q,Y),u.push(q.x,q.y,q.x,q.y,q.x,q.y,q.x,q.y),d.push(Y.x,Y.y,Y.x,Y.y,Y.x,Y.y,Y.x,Y.y),T.push(q.x,q.y,q.x,q.y,q.x,q.y,q.x,q.y),S.push(Y.x,Y.y,Y.x,Y.y,Y.x,Y.y,Y.x,Y.y),f.push(1,-1,2,-2),p.push(P,P,P,P),y.push(I,I,I,I),_.push(w[0],w[1],w[2],w[3],w[0],w[1],w[2],w[3],w[0],w[1],w[2],w[3],w[0],w[1],w[2],w[3]),x.push(O[0],O[1],O[2],O[3],O[0],O[1],O[2],O[3],O[0],O[1],O[2],O[3],O[0],O[1],O[2],O[3]),m.push(N[0],N[1],N[2],N[3],N[0],N[1],N[2],N[3],N[0],N[1],N[2],N[3],N[0],N[1],N[2],N[3]),D<t.length-1&&(C+=8,g.push(C,C))}}assignHandler(t){this._handler=t,this.refresh(),t.isInitialized()&&this.update()}add(t){if(t._handlerIndex===-1){t._handler=this,t._handlerIndex=this._geometries.length,this._geometries.push(t);let n=t._entity._pickingColor.scaleTo(1/255);if(t._polyVerticesHighMerc=[],t._polyVerticesLowMerc=[],t._lineVerticesHighMerc=[],t._lineVerticesLowMerc=[],t._coordinates[0].length){if(t.type===ai.POLYGON){let s=t._coordinates,o=[];for(let f=0;f<s.length;f++){o[f]=[];for(let g=0;g<s[f].length;g++)o[f][g]=[ni(s[f][g][0]),oi(s[f][g][1])]}let a=Rn(o),h=Ln(a.vertices,a.holes,2);t._polyVerticesHandlerIndex=this._polyVerticesHighMerc.length,t._polyIndexesHandlerIndex=this._polyIndexes.length;for(let f=0;f<h.length;f++)this._polyIndexes.push(h[f]+.5*t._polyVerticesHandlerIndex);let c=t._style.fillColor,u=[],d=[];for(let f=0;f<.5*a.vertices.length;f++)this._polyColors.push(c.x,c.y,c.z,c.w),this._polyPickingColors.push(n.x,n.y,n.z,1);for(let f=0;f<a.vertices.length;f++)An(a.vertices[f],De),u[f]=De.x,d[f]=De.y;t._polyVerticesHighMerc=u,t._polyVerticesLowMerc=d,this._polyVerticesHighMerc.push.apply(this._polyVerticesHighMerc,u),this._polyVerticesLowMerc.push.apply(this._polyVerticesLowMerc,d),t._polyVerticesLength=a.vertices.length,t._polyIndexesLength=h.length,t._lineVerticesHandlerIndex=this._lineVerticesHighMerc.length,t._lineOrdersHandlerIndex=this._lineOrders.length,t._lineIndexesHandlerIndex=this._lineIndexes.length,t._lineColorsHandlerIndex=this._lineColors.length,t._lineThicknessHandlerIndex=this._lineThickness.length,au.appendLineData(o,!0,t._style.lineColor,n,t._style.lineWidth,t._style.strokeColor,t._style.strokeWidth,this._lineVerticesHighMerc,this._lineVerticesLowMerc,this._lineOrders,this._lineIndexes,this._lineColors,this._linePickingColors,this._lineThickness,this._lineStrokeColors,this._lineStrokes,t._lineVerticesHighMerc,t._lineVerticesLowMerc),t._lineVerticesLength=this._lineVerticesHighMerc.length-t._lineVerticesHandlerIndex,t._lineOrdersLength=this._lineOrders.length-t._lineOrdersHandlerIndex,t._lineIndexesLength=this._lineIndexes.length-t._lineIndexesHandlerIndex,t._lineColorsLength=this._lineColors.length-t._lineColorsHandlerIndex,t._lineThicknessLength=this._lineThickness.length-t._lineThicknessHandlerIndex}else if(t.type===ai.MULTIPOLYGON){let s=t._coordinates,o=[],a=[];t._lineVerticesHandlerIndex=this._lineVerticesHighMerc.length,t._lineOrdersHandlerIndex=this._lineOrders.length,t._lineIndexesHandlerIndex=this._lineIndexes.length,t._lineColorsHandlerIndex=this._lineColors.length,t._lineThicknessHandlerIndex=this._lineThickness.length;for(let d=0;d<s.length;d++){let f=s[d],g=[];for(let p=0;p<f.length;p++){g[p]=[];for(let x=0;x<s[d][p].length;x++)g[p][x]=[ni(f[p][x][0]),oi(f[p][x][1])]}let _=Rn(g),m=Ln(_.vertices,_.holes,2);for(let p=0;p<m.length;p++)a.push(m[p]+.5*o.length);o.push.apply(o,_.vertices),au.appendLineData(g,!0,t._style.lineColor,n,t._style.lineWidth,t._style.strokeColor,t._style.strokeWidth,this._lineVerticesHighMerc,this._lineVerticesLowMerc,this._lineOrders,this._lineIndexes,this._lineColors,this._linePickingColors,this._lineThickness,this._lineStrokeColors,this._lineStrokes,t._lineVerticesHighMerc,t._lineVerticesLowMerc)}t._polyVerticesHandlerIndex=this._polyVerticesHighMerc.length,t._polyIndexesHandlerIndex=this._polyIndexes.length;for(let d=0;d<a.length;d++)this._polyIndexes.push(a[d]+.5*t._polyVerticesHandlerIndex);let h=t._style.fillColor,c=[],u=[];for(let d=0;d<.5*o.length;d++)this._polyColors.push(h.x,h.y,h.z,h.w),this._polyPickingColors.push(n.x,n.y,n.z,1);for(let d=0;d<o.length;d++)An(o[d],De),c[d]=De.x,u[d]=De.y;t._polyVerticesHighMerc=c,t._polyVerticesLowMerc=u,this._polyVerticesHighMerc.push.apply(this._polyVerticesHighMerc,c),this._polyVerticesLowMerc.push.apply(this._polyVerticesLowMerc,u),t._polyVerticesLength=o.length,t._polyIndexesLength=a.length,t._lineVerticesLength=this._lineVerticesHighMerc.length-t._lineVerticesHandlerIndex,t._lineOrdersLength=this._lineOrders.length-t._lineOrdersHandlerIndex,t._lineIndexesLength=this._lineIndexes.length-t._lineIndexesHandlerIndex,t._lineColorsLength=this._lineColors.length-t._lineColorsHandlerIndex,t._lineThicknessLength=this._lineThickness.length-t._lineThicknessHandlerIndex}else if(t.type===ai.LINESTRING){let s=t._coordinates,o=new Array(s.length);for(let a=0;a<s.length;a++)o[a]=[ni(s[a][0]),oi(s[a][1])];t._lineVerticesHandlerIndex=this._lineVerticesHighMerc.length,t._lineOrdersHandlerIndex=this._lineOrders.length,t._lineIndexesHandlerIndex=this._lineIndexes.length,t._lineColorsHandlerIndex=this._lineColors.length,t._lineThicknessHandlerIndex=this._lineThickness.length,au.appendLineData([o],!1,t._style.lineColor,n,t._style.lineWidth,t._style.strokeColor,t._style.strokeWidth,this._lineVerticesHighMerc,this._lineVerticesLowMerc,this._lineOrders,this._lineIndexes,this._lineColors,this._linePickingColors,this._lineThickness,this._lineStrokeColors,this._lineStrokes,t._lineVerticesHighMerc,t._lineVerticesLowMerc),t._lineVerticesLength=this._lineVerticesHighMerc.length-t._lineVerticesHandlerIndex,t._lineOrdersLength=this._lineOrders.length-t._lineOrdersHandlerIndex,t._lineIndexesLength=this._lineIndexes.length-t._lineIndexesHandlerIndex,t._lineColorsLength=this._lineColors.length-t._lineColorsHandlerIndex,t._lineThicknessLength=this._lineThickness.length-t._lineThicknessHandlerIndex}else if(t.type===ai.MULTILINESTRING){let s=t._coordinates,o=[];for(let a=0;a<s.length;a++){o[a]=[];for(let h=0;h<s[a].length;h++)o[a][h]=[ni(s[a][h][0]),oi(s[a][h][1])]}t._lineVerticesHandlerIndex=this._lineVerticesHighMerc.length,t._lineOrdersHandlerIndex=this._lineOrders.length,t._lineIndexesHandlerIndex=this._lineIndexes.length,t._lineColorsHandlerIndex=this._lineColors.length,t._lineThicknessHandlerIndex=this._lineThickness.length,au.appendLineData(o,!1,t._style.lineColor,n,t._style.lineWidth,t._style.strokeColor,t._style.strokeWidth,this._lineVerticesHighMerc,this._lineVerticesLowMerc,this._lineOrders,this._lineIndexes,this._lineColors,this._linePickingColors,this._lineThickness,this._lineStrokeColors,this._lineStrokes,t._lineVerticesHighMerc,t._lineVerticesLowMerc),t._lineVerticesLength=this._lineVerticesHighMerc.length-t._lineVerticesHandlerIndex,t._lineOrdersLength=this._lineOrders.length-t._lineOrdersHandlerIndex,t._lineIndexesLength=this._lineIndexes.length-t._lineIndexesHandlerIndex,t._lineColorsLength=this._lineColors.length-t._lineColorsHandlerIndex,t._lineThicknessLength=this._lineThickness.length-t._lineThicknessHandlerIndex}}this.setGeometryVisibility(t),!this._updatedGeometry[t.__id]&&this._updatedGeometryArr.push(t),this._updatedGeometry[t.__id]=!0,this.refresh()}}remove(t){const n=t._handlerIndex;if(n!==-1){this._geometries.splice(n,1),this._polyVerticesHighMerc.splice(t._polyVerticesHandlerIndex,t._polyVerticesLength),this._polyVerticesLowMerc.splice(t._polyVerticesHandlerIndex,t._polyVerticesLength),this._polyColors.splice(2*t._polyVerticesHandlerIndex,2*t._polyVerticesLength),this._polyPickingColors.splice(2*t._polyVerticesHandlerIndex,2*t._polyVerticesLength),this._polyIndexes.splice(t._polyIndexesHandlerIndex,t._polyIndexesLength);let s=.5*t._polyVerticesLength;for(let a=t._polyIndexesHandlerIndex;a<this._polyIndexes.length;a++)this._polyIndexes[a]-=s;this._lineVerticesHighMerc.splice(t._lineVerticesHandlerIndex,t._lineVerticesLength),this._lineVerticesLowMerc.splice(t._lineVerticesHandlerIndex,t._lineVerticesLength),this._lineOrders.splice(t._lineOrdersHandlerIndex,t._lineOrdersLength),this._lineColors.splice(t._lineColorsHandlerIndex,t._lineColorsLength),this._linePickingColors.splice(t._lineColorsHandlerIndex,t._lineColorsLength),this._lineStrokeColors.splice(t._lineColorsHandlerIndex,t._lineColorsLength),this._lineThickness.splice(t._lineThicknessHandlerIndex,t._lineThicknessLength),this._lineStrokes.splice(t._lineThicknessHandlerIndex,t._lineThicknessLength),this._lineIndexes.splice(t._lineIndexesHandlerIndex,t._lineIndexesLength),s=.5*t._lineVerticesLength;for(let a=t._lineIndexesHandlerIndex;a<this._lineIndexes.length;a++)this._lineIndexes[a]-=s;let o=this._geometries;for(let a=n;a<o.length;a++){let h=o[a];h._handlerIndex=a,h._polyVerticesHandlerIndex-=t._polyVerticesLength,h._polyIndexesHandlerIndex-=t._polyIndexesLength,h._lineVerticesHandlerIndex-=t._lineVerticesLength,h._lineOrdersHandlerIndex-=t._lineOrdersLength,h._lineColorsHandlerIndex-=t._lineColorsLength,h._lineThicknessHandlerIndex-=t._lineThicknessLength,h._lineIndexesHandlerIndex-=t._lineIndexesLength}t._pickingReady=!1,t._handler=null,t._handlerIndex=-1,t._polyVerticesHighMerc=[],t._polyVerticesLowMerc=[],t._polyVerticesLength=-1,t._polyIndexesLength=-1,t._polyVerticesHandlerIndex=-1,t._polyIndexesHandlerIndex=-1,t._lineVerticesHighMerc=[],t._lineVerticesLowMerc=[],t._lineVerticesLength=-1,t._lineOrdersLength=-1,t._lineIndexesLength=-1,t._lineColorsLength=-1,t._lineThicknessLength=-1,t._lineVerticesHandlerIndex=-1,t._lineOrdersHandlerIndex=-1,t._lineIndexesHandlerIndex=-1,t._lineThicknessHandlerIndex=-1,t._lineColorsHandlerIndex=-1,!this._removeGeometryExtents[t.__id]&&this._removeGeometryExtentArr.push(t.getExtent()),this._removeGeometryExtents[t.__id]=!0,this.refresh()}}_refreshRecursevely(t,n){if(n.ready){let s=this._layer._id;for(let o=0;o<n.nodes.length;o++){let a=n.nodes[o];if(t.overlaps(a.segment.getExtentLonLat())){this._refreshRecursevely(t,a);let h=a.segment.materials[s];h&&h.isReady&&(h.segment.node.getState()!==1?h.layer.clearMaterial(h):(h.pickingReady=h.pickingReady&&t._pickingReady,h.isReady=!1,h._updateTexture=h.texture,h._updatePickingMask=h.pickingMask),t._pickingReady=!0)}}}}_refreshRecursevelyExt(t,n){if(n.ready){let s=this._layer.__id;for(let o=0;o<n.nodes.length;o++){let a=n.nodes[o];if(t.overlaps(a.segment.getExtentLonLat())){this._refreshRecursevelyExt(t,a);let h=a.segment.materials[s];h&&h.isReady&&h.layer.clearMaterial(h)}}}}_refreshPlanetNode(t){let n,s=this._removeGeometryExtentArr;for(n=0;n<s.length;n++)this._refreshRecursevelyExt(s[n],t);let o=this._updatedGeometryArr;for(n=0;n<o.length;n++)this._refreshRecursevely(o[n],t)}_updatePlanet(){let t=this._layer._planet;if(t){let n=t.quadTreeStrategy.quadTreeList;for(let s=0;s<n.length;s++)this._refreshPlanetNode(n[s])}this._updatedGeometryArr.length=0,this._updatedGeometryArr=[],this._updatedGeometry={},this._removeGeometryExtentArr.length=0,this._removeGeometryExtentArr=[],this._removeGeometryExtents={}}refresh(){let t=this._changedBuffers.length;for(;t--;)this._changedBuffers[t]=!0}update(){if(this._handler){let t=!1,n=this._changedBuffers.length;for(;n--;)this._changedBuffers[n]&&(t=!0,this._buffersUpdateCallbacks[n].call(this),this._changedBuffers[n]=!1);t&&this._updatePlanet()}}setGeometryVisibility(t){let n=t.getVisibility()?1:0,s=this._polyVerticesHighMerc,o=this._polyVerticesLowMerc,a=t._polyVerticesLength,h=t._polyVerticesHandlerIndex;for(let c=0;c<a;c++)s[h+c]=t._polyVerticesHighMerc[c]*n,o[h+c]=t._polyVerticesLowMerc[c]*n;s=this._lineVerticesHighMerc,o=this._lineVerticesLowMerc,a=t._lineVerticesLength,h=t._lineVerticesHandlerIndex;for(let c=0;c<a;c++)s[h+c]=t._lineVerticesHighMerc[c]*n,o[h+c]=t._lineVerticesLowMerc[c]*n;this._changedBuffers[0]=!0,this._changedBuffers[3]=!0,!this._updatedGeometry[t.__id]&&this._updatedGeometryArr.push(t),this._updatedGeometry[t.__id]=!0}setPolyColorArr(t,n){let s=2*t._polyVerticesHandlerIndex,o=s+2*t._polyVerticesLength,a=this._polyColors;for(let h=s;h<o;h+=4)a[h]=n.x,a[h+1]=n.y,a[h+2]=n.z,a[h+3]=n.w;this._changedBuffers[2]=!0,!this._updatedGeometry[t.__id]&&this._updatedGeometryArr.push(t),this._updatedGeometry[t.__id]=!0}setLineStrokeColorArr(t,n){let s=t._lineColorsHandlerIndex,o=s+t._lineColorsLength,a=this._lineStrokeColors;for(let h=s;h<o;h+=4)a[h]=n.x,a[h+1]=n.y,a[h+2]=n.z,a[h+3]=n.w;this._changedBuffers[9]=!0,!this._updatedGeometry[t.__id]&&this._updatedGeometryArr.push(t),this._updatedGeometry[t.__id]=!0}setLineColorArr(t,n){let s=t._lineColorsHandlerIndex,o=s+t._lineColorsLength,a=this._lineColors;for(let h=s;h<o;h+=4)a[h]=n.x,a[h+1]=n.y,a[h+2]=n.z,a[h+3]=n.w;this._changedBuffers[6]=!0,!this._updatedGeometry[t.__id]&&this._updatedGeometryArr.push(t),this._updatedGeometry[t.__id]=!0}setLineStrokeArr(t,n){}setLineThicknessArr(t,n){let s=t._lineThicknessHandlerIndex,o=s+t._lineThicknessLength,a=this._lineThickness;for(let h=s;h<o;h++)a[h]=n;this._changedBuffers[7]=!0,!this._updatedGeometry[t.__id]&&this._updatedGeometryArr.push(t),this._updatedGeometry[t.__id]=!0}bringToFront(t){let n=this._polyIndexes.splice(t._polyIndexesHandlerIndex,t._polyIndexesLength),s=this._lineIndexes.splice(t._lineIndexesHandlerIndex,t._lineIndexesLength);this._geometries.splice(t._handlerIndex,1);let o=this._geometries;for(let a=t._handlerIndex;a<o.length;a++){let h=o[a];h._handlerIndex=a,h._polyIndexesHandlerIndex-=t._polyIndexesLength,h._lineIndexesHandlerIndex-=t._lineIndexesLength}t._polyIndexesHandlerIndex=this._polyIndexes.length,t._lineIndexesHandlerIndex=this._lineIndexes.length,t._handlerIndex=this._geometries.length,this._geometries.push(t),this._polyIndexes.push.apply(this._polyIndexes,n),this._lineIndexes.push.apply(this._lineIndexes,s),this._changedBuffers[1]=!0,this._changedBuffers[4]=!0,!this._updatedGeometry[t.__id]&&this._updatedGeometryArr.push(t),this._updatedGeometry[t.__id]=!0}createPolyVerticesBuffer(){let t=this._handler;t.gl.deleteBuffer(this._polyVerticesHighBufferMerc),this._polyVerticesHighBufferMerc=t.createArrayBuffer(new Float32Array(this._polyVerticesHighMerc),2,this._polyVerticesHighMerc.length/2),t.gl.deleteBuffer(this._polyVerticesLowBufferMerc),this._polyVerticesLowBufferMerc=t.createArrayBuffer(new Float32Array(this._polyVerticesLowMerc),2,this._polyVerticesLowMerc.length/2)}createPolyIndexesBuffer(){let t=this._handler;t.gl.deleteBuffer(this._polyIndexesBuffer),this._polyIndexesBuffer=t.createElementArrayBuffer(new Uint32Array(this._polyIndexes),1,this._polyIndexes.length)}createPolyColorsBuffer(){let t=this._handler;t.gl.deleteBuffer(this._polyColorsBuffer),this._polyColorsBuffer=t.createArrayBuffer(new Float32Array(this._polyColors),4,this._polyColors.length/4)}createPolyPickingColorsBuffer(){let t=this._handler;t.gl.deleteBuffer(this._polyPickingColorsBuffer),this._polyPickingColorsBuffer=t.createArrayBuffer(new Float32Array(this._polyPickingColors),4,this._polyPickingColors.length/4)}createLineVerticesBuffer(){let t=this._handler;t.gl.deleteBuffer(this._lineVerticesHighBufferMerc),this._lineVerticesHighBufferMerc=t.createArrayBuffer(new Float32Array(this._lineVerticesHighMerc),2,this._lineVerticesHighMerc.length/2),t.gl.deleteBuffer(this._lineVerticesLowBufferMerc),this._lineVerticesLowBufferMerc=t.createArrayBuffer(new Float32Array(this._lineVerticesLowMerc),2,this._lineVerticesLowMerc.length/2)}createLineIndexesBuffer(){let t=this._handler;t.gl.deleteBuffer(this._lineIndexesBuffer),this._lineIndexesBuffer=t.createElementArrayBuffer(new Uint32Array(this._lineIndexes),1,this._lineIndexes.length)}createLineOrdersBuffer(){let t=this._handler;t.gl.deleteBuffer(this._lineOrdersBuffer),this._lineOrdersBuffer=t.createArrayBuffer(new Float32Array(this._lineOrders),1,this._lineOrders.length/2)}createLineColorsBuffer(){let t=this._handler;t.gl.deleteBuffer(this._lineColorsBuffer),this._lineColorsBuffer=t.createArrayBuffer(new Float32Array(this._lineColors),4,this._lineColors.length/4)}createLinePickingColorsBuffer(){let t=this._handler;t.gl.deleteBuffer(this._linePickingColorsBuffer),this._linePickingColorsBuffer=t.createArrayBuffer(new Float32Array(this._linePickingColors),4,this._linePickingColors.length/4)}createLineThicknessBuffer(){let t=this._handler;t.gl.deleteBuffer(this._lineThicknessBuffer),this._lineThicknessBuffer=t.createArrayBuffer(new Float32Array(this._lineThickness),1,this._lineThickness.length)}createLineStrokesBuffer(){let t=this._handler;t.gl.deleteBuffer(this._lineStrokesBuffer),this._lineStrokesBuffer=t.createArrayBuffer(new Float32Array(this._lineStrokes),1,this._lineStrokes.length)}createLineStrokeColorsBuffer(){let t=this._handler;t.gl.deleteBuffer(this._lineStrokeColorsBuffer),this._lineStrokeColorsBuffer=t.createArrayBuffer(new Float32Array(this._lineStrokeColors),4,this._lineStrokeColors.length/4)}clear(){this._geometries=[],this._polyVerticesHighMerc=[],this._polyVerticesLowMerc=[],this._polyIndexes=[],this._polyColors=[],this._polyPickingColors=[],this._lineVerticesHighMerc=[],this._lineVerticesLowMerc=[],this._lineOrders=[],this._lineIndexes=[],this._lineColors=[],this._linePickingColors=[],this._lineThickness=[],this._lineStrokeColors=[],this._lineStrokes=[],this._deleteBuffers(),this._polyVerticesHighBufferMerc=null,this._polyVerticesLowBufferMerc=null,this._polyIndexesBuffer=null,this._polyColorsBuffer=null,this._polyPickingColorsBuffer=null,this._lineVerticesHighBufferMerc=null,this._lineVerticesLowBufferMerc=null,this._lineIndexesBuffer=null,this._lineOrdersBuffer=null,this._lineColorsBuffer=null,this._linePickingColorsBuffer=null,this._lineThicknessBuffer=null,this._lineStrokeColorsBuffer=null,this._lineStrokesBuffer=null,this._updatedGeometryArr=[],this._updatedGeometry={},this._removeGeometryExtentArr=[],this._removeGeometryExtents={},this.refresh()}_deleteBuffers(){if(this._layer._planet&&this._layer._planet.renderer){let t=this._layer._planet.renderer.handler.gl;t&&(t.deleteBuffer(this._polyVerticesHighBufferMerc),t.deleteBuffer(this._polyVerticesLowBufferMerc),t.deleteBuffer(this._polyIndexesBuffer),t.deleteBuffer(this._polyColorsBuffer),t.deleteBuffer(this._polyPickingColorsBuffer),t.deleteBuffer(this._lineVerticesHighBufferMerc),t.deleteBuffer(this._lineVerticesLowBufferMerc),t.deleteBuffer(this._lineIndexesBuffer),t.deleteBuffer(this._lineOrdersBuffer),t.deleteBuffer(this._lineColorsBuffer),t.deleteBuffer(this._linePickingColorsBuffer),t.deleteBuffer(this._lineThicknessBuffer),t.deleteBuffer(this._lineStrokeColorsBuffer),t.deleteBuffer(this._lineStrokesBuffer))}}};ge.__counter__=0;let kr=ge;class _t extends zt{constructor(t,n={}){super(t,n),this.events=this.events.registerNames(gl),this.isVector=!0,this._hasImageryTiles=!1,this.scaleByDistance=n.scaleByDistance||[Ae,Ae,Ae],this._useLighting=n.useLighting===void 0||n.useLighting;let s=new Float32Array([1,1,1]);n.pickingScale!==void 0&&(n.pickingScale instanceof Array?(s[0]=n.pickingScale[0]||s[0],s[1]=n.pickingScale[1]||s[1],s[2]=n.pickingScale[2]||s[2]):typeof n.pickingScale=="number"&&(s[0]=n.pickingScale,s[1]=n.pickingScale,s[2]=n.pickingScale)),this.pickingScale=s,this.async=n.async===void 0||n.async,this.clampToGround=n.clampToGround||!1,this.relativeToGround=n.relativeToGround||!1,this._entities=function(o){let a=[];for(let h=0;h<o.length;h++){let c=o[h];c.instanceName==="Entity"?a.push(c):a.push(new G(c))}return a}(n.entities||[]),this._labelMaxLetters=n.labelMaxLetters||24,this._stripEntityCollection=new se({pickingEnabled:this.pickingEnabled}),this._bindEventsDefault(this._stripEntityCollection),this._polylineEntityCollection=new se({pickingEnabled:this.pickingEnabled}),this._bindEventsDefault(this._polylineEntityCollection),this._geoObjectEntityCollection=new se({pickingEnabled:this.pickingEnabled,useLighting:this._useLighting}),this._bindEventsDefault(this._geoObjectEntityCollection),this._geometryHandler=new kr(this),this._nodeCapacity=n.nodeCapacity||60,this._entityCollectionsTreeStrategy=null,this.setEntities(this._entities),this.polygonOffsetUnits=n.polygonOffsetUnits!=null?n.polygonOffsetUnits:0,this.pickingEnabled=this._pickingEnabled,this._depthOrder=n.depthOrder||0}get depthOrder(){return this._depthOrder}set depthOrder(t){t!==this._depthOrder&&(this._depthOrder=t,this._planet&&this._planet.updateVisibleLayers())}get useLighting(){return this._useLighting}set useLighting(t){t!==this._useLighting&&(this._geoObjectEntityCollection.useLighting=t,this._useLighting=t)}get labelMaxLetters(){return this._labelMaxLetters}get instanceName(){return"Vector"}_bindPicking(){this._pickingColor.clear()}addTo(t){this._planet||(this._assignPlanet(t),this._geometryHandler.assignHandler(t.renderer.handler),this._polylineEntityCollection.addTo(t,!0),this._stripEntityCollection.addTo(t,!0),this._geoObjectEntityCollection.addTo(t,!0),this._polylineEntityCollection._layer=this,this._stripEntityCollection._layer=this,this._geoObjectEntityCollection._layer=this,this.setEntities(this._entities))}remove(){return super.remove(),this._polylineEntityCollection.remove(),this._stripEntityCollection.remove(),this._geoObjectEntityCollection.remove(),this._polylineEntityCollection._layer=void 0,this._stripEntityCollection._layer=void 0,this._geoObjectEntityCollection._layer=void 0,this}getEntities(){return[].concat(this._entities)}add(t){return t._layer||t._entityCollection||(t._layer=this,t._layerIndex=this._entities.length,this._entities.push(t),this._proceedEntity(t)),this}insert(t,n){if(!t._layer&&!t._entityCollection){t._layer=this,t._layerIndex=n,this._entities.splice(n,0,t);for(let s=n+1,o=this._entities.length;s<o;s++)this._entities[s]._layerIndex=s;this._proceedEntity(t)}return this}_proceedEntity(t){var n;let s=this._hasImageryTiles;t.strip&&this._stripEntityCollection.add(t),(t.polyline||t.ray)&&this._polylineEntityCollection.add(t),(t.geoObject||t.isEmpty)&&this._geoObjectEntityCollection.add(t),t.geometry&&(this._hasImageryTiles=!0,this._planet&&(this._planet.renderer.assignPickingColor(t),this._geometryHandler.add(t.geometry))),this._planet&&((t.billboard||t.label||t.geoObject||t.isEmpty)&&(t._cartesian.isZero()&&!t._lonLat.isZero()?t._setCartesian3vSilent(this._planet.ellipsoid.lonLatToCartesian(t._lonLat)):(t._lonLat=this._planet.ellipsoid.cartesianToLonLat(t._cartesian),Math.abs(t._lonLat.lat)<ct?t._lonLatMerc=t._lonLat.forwardMercator():t._lonLatMerc.lon=t._lonLatMerc.lat=t._lonLatMerc.height=0)),(t.billboard||t.label)&&((n=this._entityCollectionsTreeStrategy)==null||n.insertEntity(t))),this._planet&&this._hasImageryTiles!==s&&this._planet.updateVisibleLayers(),this.events.dispatch(this.events.entityadd,t)}addEntities(t){let n=t.length;for(;n--;)this.add(t[n]);return this}removeEntity(t){if(t._layer&&this.isEqual(t._layer)){if(t.parent||(this._entities.splice(t._layerIndex,1),this._reindexEntitiesArray(t._layerIndex)),t._layer=null,t._layerIndex=-1,t._entityCollection){t._entityCollection._removeEntitySilent(t);let n=t._nodePtr;for(;n;)n.count--,n=n.parentNode;t._nodePtr&&t._nodePtr.count===0&&t._nodePtr.deferredEntities.length===0&&(t._nodePtr.entityCollection=null)}else if(t._nodePtr&&t._nodePtr.deferredEntities.length){let n=t._nodePtr.deferredEntities,s=n.length;for(;s--;)if(n[s].id===t.id){n.splice(s,1);let o=t._nodePtr;for(;o;)o.count--,o=o.parentNode;break}}this._planet&&t.geometry&&(this._geometryHandler.remove(t.geometry),this._planet.renderer.clearPickingColor(t)),t._nodePtr=void 0,this.events.dispatch(this.events.entityremove,t)}return this}set pickingEnabled(t){var n;this._pickingEnabled=t,this._stripEntityCollection.setPickingEnabled(t),this._polylineEntityCollection.setPickingEnabled(t),this._geoObjectEntityCollection.setPickingEnabled(t),(n=this._entityCollectionsTreeStrategy)==null||n.setPickingEnabled(t)}_reindexEntitiesArray(t){const n=this._entities;for(let s=t;s<n.length;s++)n[s]._layerIndex=s}removeEntities(t){let n=t.length;for(;n--;)this.removeEntity(t[n]);return this}clear(){var t;super.clear();let n=new Array(this._entities.length);for(let o=0;o<n.length;o++)n[o]=this._entities[o];let s=this._entities.length;for(;s--;)this._entities[s].remove();this._entities.length=0,this._entities=[];for(let o=0;o<n.length;o++)this._entities[o]=n[o];(t=this._entityCollectionsTreeStrategy)==null||t.dispose(),this._entityCollectionsTreeStrategy=null,this._geometryHandler.clear()}each(t){let n=this._entities,s=n.length;for(;s--;)t(n[s],s)}setEntities(t){let n=new Array(t.length);for(let o=0,a=t.length;o<a;o++)n[o]=t[o];this.clear(),this._entities=new Array(n.length);let s=[];for(let o=0;o<n.length;o++){let a=n[o];a._layer=this,a._layerIndex=o;let h=!(a.strip||a.polyline||a.ray||a.geoObject||a.billboard||a.label);a.strip?this._stripEntityCollection.add(a):a.polyline||a.ray?this._polylineEntityCollection.add(a):a.geoObject||h?this._geoObjectEntityCollection.add(a):(a.billboard||a.label)&&s.push(a),a.geometry&&(this._hasImageryTiles=!0,this._planet&&(this._planet.renderer.assignPickingColor(a),this._geometryHandler.add(a.geometry))),this._entities[o]=a}return this._createEntityCollectionsTree(s),this}_createEntityCollectionsTree(t){this._planet&&(this._entityCollectionsTreeStrategy=this._planet.quadTreeStrategy.createEntityCollectionsTreeStrategy(this,this._nodeCapacity),this._entityCollectionsTreeStrategy.insertEntities(t))}_bindEventsDefault(t){let n=this.events;t.events.on("mousemove",s=>{n.dispatch(n.mousemove,s)}),t.events.on("mouseenter",s=>{n.dispatch(n.mouseenter,s)}),t.events.on("mouseleave",s=>{n.dispatch(n.mouseleave,s)}),t.events.on("lclick",s=>{n.dispatch(n.lclick,s)}),t.events.on("rclick",s=>{n.dispatch(n.rclick,s)}),t.events.on("mclick",s=>{n.dispatch(n.mclick,s)}),t.events.on("ldblclick",s=>{n.dispatch(n.ldblclick,s)}),t.events.on("rdblclick",s=>{n.dispatch(n.rdblclick,s)}),t.events.on("mdblclick",s=>{n.dispatch(n.mdblclick,s)}),t.events.on("lup",s=>{n.dispatch(n.lup,s)}),t.events.on("rup",s=>{n.dispatch(n.rup,s)}),t.events.on("mup",s=>{n.dispatch(n.mup,s)}),t.events.on("ldown",s=>{n.dispatch(n.ldown,s)}),t.events.on("rdown",s=>{n.dispatch(n.rdown,s)}),t.events.on("mdown",s=>{n.dispatch(n.mdown,s)}),t.events.on("lhold",s=>{n.dispatch(n.lhold,s)}),t.events.on("rhold",s=>{n.dispatch(n.rhold,s)}),t.events.on("mhold",s=>{n.dispatch(n.mhold,s)}),t.events.on("mousewheel",s=>{n.dispatch(n.mousewheel,s)}),t.events.on("touchmove",s=>{n.dispatch(n.touchmove,s)}),t.events.on("touchstart",s=>{n.dispatch(n.touchstart,s)}),t.events.on("touchend",s=>{n.dispatch(n.touchend,s)}),t.events.on("doubletouch",s=>{n.dispatch(n.doubletouch,s)}),t.events.on("touchleave",s=>{n.dispatch(n.touchleave,s)}),t.events.on("touchenter",s=>{n.dispatch(n.touchenter,s)})}_collectStripCollectionPASS(t){let n=this._stripEntityCollection;n._fadingOpacity=this._fadingOpacity,n.scaleByDistance=this.scaleByDistance,n.pickingScale=this.pickingScale,n.polygonOffsetUnits=this.polygonOffsetUnits,t.push(n)}_collectPolylineCollectionPASS(t){let n=this._polylineEntityCollection;if(n._fadingOpacity=this._fadingOpacity,n.scaleByDistance=this.scaleByDistance,n.pickingScale=this.pickingScale,n.polygonOffsetUnits=this.polygonOffsetUnits,t.push(n),this.clampToGround||this.relativeToGround){let s=Number(this.relativeToGround);const o=this._planet.quadTreeStrategy._renderedNodes,a=this._planet.getViewExtent();let h=n._entities,c=h.length,u=new v;for(;c--;){let d=h[c]._altitude||0,f=h[c].polyline;if(f&&a.overlaps(f._extent)){let g=f._pathLonLatMerc,_=g.length;for(;_--;){let m=g[_].length;for(;m--;){let p=g[_][m],x=o.length;for(;x--;){let y=o[x].segment;if(y._extent.isInside(p)){let T=f._path3v[_][m];y.getTerrainPoint(T,p,u);let S=s&&f.altitude||d;if(S){let C=this._planet.ellipsoid.getSurfaceNormal3v(u);f.setPoint3v(u.addA(C.scale(S)),m,_,!0)}else f.setPoint3v(u,m,_,!0);break}}}}}}}}_collectGeoObjectCollectionPASS(t){let n=this._geoObjectEntityCollection;n._fadingOpacity=this._fadingOpacity,n.scaleByDistance=this.scaleByDistance,n.pickingScale=this.pickingScale,n.polygonOffsetUnits=this.polygonOffsetUnits,t.push(n)}collectVisibleCollections(t){let n=this._planet;(this._fading&&this._fadingOpacity>0||this.minZoom<=n.quadTreeStrategy.maxCurrZoom&&this.maxZoom>=n.quadTreeStrategy.maxCurrZoom)&&(this._collectStripCollectionPASS(t),this._collectPolylineCollectionPASS(t),this._collectGeoObjectCollectionPASS(t),this._entityCollectionsTreeStrategy&&this._entityCollectionsTreeStrategy.collectVisibleEntityCollections(t))}loadMaterial(t){const n=t.segment;this._isBaseLayer?t.texture=n._isNorth?n.planet.solidTextureOne:n.planet.solidTextureTwo:t.texture=n.planet.transparentTexture,this._planet.layerLock.isFree()&&(t.isReady=!1,t.isLoading=!0,this._planet._vectorTileCreator.add(t))}abortMaterialLoading(t){t.isLoading=!1,t.isReady=!1}applyMaterial(t){if(t.isReady)return[0,0,1,1];{!t.isLoading&&this.loadMaterial(t);const n=t.segment;let s=n.node,o=!1,a=this.__id,h=t;for(;s.parentNode;){if(h&&h.isReady){o=!0;break}s=s.parentNode,h=s.segment.materials[a]}if(o){t.appliedNodeId=s.nodeId,t.texture=h.texture,t.pickingMask=h.pickingMask;const c=1/(2<<n.tileZoom-s.segment.tileZoom-1);return[n.tileX*c-s.segment.tileX,n.tileY*c-s.segment.tileY,c,c]}return t.textureExists&&t._updateTexture?(t.texture=t._updateTexture,t.pickingMask=t._updatePickingMask):(t.texture=n.planet.transparentTexture,t.pickingMask=n.planet.transparentTexture),t.pickingReady=!0,[0,0,1,1]}}clearMaterial(t){if(t.isReady){const n=t.segment.handler.gl;t.isReady=!1,t.pickingReady=!1;let s=t.texture;t.texture=null,s&&!s.default&&n.deleteTexture(s),s=t.pickingMask,t.pickingMask=null,s&&!s.default&&n.deleteTexture(s),s=t._updateTexture,t._updateTexture=null,s&&!s.default&&n.deleteTexture(s),s=t._updatePickingMask,t._updatePickingMask=null,s&&!s.default&&n.deleteTexture(s)}this.abortMaterialLoading(t),t.isLoading=!1,t.textureExists=!1}update(){this._geometryHandler.update(),this.events.dispatch(this.events.draw,this)}}const gl=["draw","entityadd","entityremove"],pl=["change","startpoint"],Mn=$.createCylinder(1,1,2,20,1,!0,!1,0,-.5,0),kt=200,gi=.3;class oa extends de{constructor(t){super(t.name),this._cornerDblClick=!1,this._onChange=n=>{if(n.geometryType==="POLYGON"){let s=this.getCoordinates(),o=new G({geometry:{type:n.geometryType,coordinates:[s],style:this._fillStyle}});this._geometryLayer.clear(),this._geometryLayer.add(o)}},this._onCornerMouseEnter=n=>{n.renderer.handler.canvas.style.cursor="pointer",this.hideGhostPointer()},this._onCornerMouseLeave=n=>{n.renderer.handler.canvas.style.cursor="default",this.showGhostPointer()},this._onCenterMouseEnter=n=>{n.renderer.handler.canvas.style.cursor="pointer",this.hideGhostPointer()},this._onCenterMouseLeave=n=>{n.renderer.handler.canvas.style.cursor="default",this._pickedCenter||this._pickedCorner||this.showGhostPointer()},this._onLup=n=>{this._planet.renderer.controls.mouseNavigation.activate(),(this._pickedCorner||this._pickedCenter)&&(this.events.dispatch(this.events.change,this),this.setGhostPointerPosition(this._planet.getCartesianFromPixelTerrain(n)),this.showGhostPointer(),this._pickedCorner=null,this._pickedCenter=null)},this._onCornerLdown=n=>{this._pickedCorner=this._getLdown(n)},this._onCenterLdown=n=>{this._pickedCenter=this._getLdown(n)},this._onMouseMove=n=>{this._pickedCenter?this._moveCenterPoint():this._pickedCorner?this._moveCornerPoint(n.pos):this.setGhostPointerPosition(this._planet.getCartesianFromPixelTerrain(n.pos))},this._onCornerLdblclick=n=>{this._cornerDblClick=!0;let s=this.getCoordinates();s.splice(n.pickingObject.layerIndex,1),this.setCoordinates(s)},this._onMouseDblClick=n=>{if(this._cornerDblClick)return void(this._cornerDblClick=!1);if(!this._showGhostPointer)return;let s=this._planet.getCartesianFromPixelTerrain(n);s&&(this._addNew(s),!this._isStartPoint&&this._cornerLayer.getEntities().length>2&&(this._isStartPoint=!0,this.events.dispatch(this.events.startpoint,this)),this.events.dispatch(this.events.change,this))},this.events=lt(pl),this._planet=null,this._initCoordinates=t.coordinates||[],this._pickedCorner=null,this._pickedCenter=null,this._startPos=null,this._startClick=new H,this._geometryLayer=new _t,this._cornerStyle={scale:.5,tag:"corners",color:"rgb(350, 350, 0)",object3d:Mn,...t.cornerStyle||{}},this._centerStyle={scale:.4,tag:"centers",color:"rgb(0, 350, 50)",object3d:Mn,...t.centerStyle||{}},this._outlineStyle={thickness:3.5,color:"rgb(0, 350, 50)",...t.outlineStyle||{}},this._fillStyle={fillColor:"rgba(0,146,247,0.2)",...t.fillStyle||{}},this._cornerLayer=new _t("corners",{pickingScale:3,pickingEnabled:!0,polygonOffsetUnits:-5,relativeToGround:!0,scaleByDistance:[100,4e6,1]}),this._centerLayer=new _t("centers",{pickingScale:3,pickingEnabled:!0,polygonOffsetUnits:-5,relativeToGround:!0,scaleByDistance:[100,4e6,1]}),this._outlineLayer=new _t("outline",{entities:[new G({polyline:{path3v:[],isClosed:!1,...this._outlineStyle}})],pickingEnabled:!1,polygonOffsetUnits:-5,relativeToGround:!0}),this._outlineLayer.getEntities()[0].polyline.altitude=gi,this._ghostCorner=new G({geoObject:this._cornerStyle}),this._ghostOutlineLayer=new _t("ghost-pointer",{pickingEnabled:!1,polygonOffsetUnits:-5,relativeToGround:!0,scaleByDistance:[100,4e6,1],opacity:.5}),this._showGhostPointer=!1,this._isStartPoint=!1,this._insertCornerIndex=-1}get geometryType(){return"POLYGON"}getCoordinates(){let t=this._cornerLayer.getEntities();return t.length>0?t.map(n=>{let s=n.getLonLat();return[s.lon,s.lat,s.height]}):this._initCoordinates}bindPlanet(t){this._planet=t}init(){this._initEvents(),this._initGhostLayerPointer(),this._initCoordinates.length&&this.setCoordinates(this._initCoordinates),this._planet.addLayer(this._outlineLayer),this._planet.addLayer(this._cornerLayer),this._planet.addLayer(this._centerLayer),this.showGhostPointer(),this.startNewPoint(),this._geometryLayer.addTo(this._planet),this.events.on("change",this._onChange,this)}onremove(){this._clearEvents(),this.hideGhostPointer(),this.stopNewPoint(),this.clear(),this._geometryLayer.remove()}clear(){this._geometryLayer.clear();let t=this._cornerLayer.getEntities(),n=t.length;for(;n--;)t[n].remove();let s=this._centerLayer.getEntities();for(n=s.length;n--;)s[n].remove();let o=this._outlineLayer.getEntities();for(n=o.length;n--;)o[n].polyline.clear(),n>0&&o[n].remove();this._clearGhostPointer()}setCoordinates(t){this.clear();for(let n=0;n<t.length;n++){let s=t[n],o=this._planet.ellipsoid.lonLatToCartesian(new L(s[0],s[1],s[2]));this._appendCart(o)}this.events.dispatch(this.events.change,this)}stopNewPoint(){this.renderer&&this.renderer.events.off("ldblclick",this._onMouseDblClick)}startNewPoint(){this.renderer.events.on("ldblclick",this._onMouseDblClick,this)}showGhostPointer(){this._showGhostPointer=!0,this._planet.addLayer(this._ghostOutlineLayer),this._insertCornerIndex=this._cornerLayer.getEntities().length}hideGhostPointer(){this._showGhostPointer=!1,this._ghostOutlineLayer.remove(),this._insertCornerIndex=-1}setGhostPointerPosition(t){t&&(this._ghostCorner.setCartesian3v(t),this._updateGhostOutlinePointer(t))}_getLdown(t){this._planet.renderer.controls.mouseNavigation.deactivate(),this._startClick.set(t.x,t.y);let n=t.pickingObject.getCartesian();return this._startPos=this._planet.getPixelFromCartesian(n),t.pickingObject}_initEvents(){this._cornerLayer.events.on("ldblclick",this._onCornerLdblclick,this),this._cornerLayer.events.on("ldown",this._onCornerLdown,this),this._centerLayer.events.on("ldown",this._onCenterLdown,this),this.renderer.events.on("lup",this._onLup,this),this.renderer.events.on("mousemove",this._onMouseMove,this),this._cornerLayer.events.on("mouseenter",this._onCornerMouseEnter,this),this._cornerLayer.events.on("mouseleave",this._onCornerMouseLeave,this),this._centerLayer.events.on("mouseenter",this._onCenterMouseEnter,this),this._centerLayer.events.on("mouseleave",this._onCenterMouseLeave,this)}_clearEvents(){this._cornerLayer.events.off("ldblclick",this._onCornerLdblclick),this._cornerLayer.events.off("ldown",this._onCornerLdown),this._centerLayer.events.off("ldown",this._onCenterLdown),this.renderer.events.off("lup",this._onLup),this.renderer.events.off("mousemove",this._onMouseMove),this._cornerLayer.events.off("mouseenter",this._onCornerMouseEnter),this._cornerLayer.events.off("mouseleave",this._onCornerMouseLeave),this._centerLayer.events.off("mouseenter",this._onCenterMouseEnter),this._centerLayer.events.off("mouseleave",this._onCenterMouseLeave)}_drawCorners(){let t=this._cornerLayer.getEntities();for(let n=0;n<t.length;n++){let s=t[n];this._checkTerrainCollision(s)}}_drawCenters(){let t=this._centerLayer.getEntities();for(let n=0;n<t.length;n++){let s=t[n];this._checkTerrainCollision(s)}}_drawGhostCorner(){this._showGhostPointer&&this._checkTerrainCollision(this._ghostCorner)}frame(){this._drawCorners(),this._drawCenters(),this._drawGhostCorner()}_checkTerrainCollision(t){let n=new v,s=this._planet.quadTreeStrategy._renderedNodes;for(let o=0;o<s.length;o++){let a=s[o].segment;if(a&&a._extentLonLat.isInside(t.getLonLat())){a.getEntityTerrainPoint(t,n),t.setCartesian3v(n);break}}}_moveCenterPoint(){let t=this.getCoordinates(),n=this._pickedCenter.layerIndex+1,s=this._pickedCenter.getLonLat(),o=[s.lon,s.lat,s.height];t.splice(n,0,o),this.setCoordinates(t),this._pickedCenter=null,this._pickedCorner=this._cornerLayer.getEntities()[n]}_addNew(t){if(this._insertCornerIndex===-1||this._cornerLayer.getEntities().length<2)this._appendCart(t);else{let n=this.getCoordinates(),s=this._insertCornerIndex,o=this._planet.ellipsoid.cartesianToLonLat(t),a=[o.lon,o.lat,o.height];n.splice(s,0,a),this.clear(),this.setCoordinates(n)}}_appendCart(t){let n=this._cornerLayer.getEntities(),s=n[n.length-1],o=new G({geoObject:this._cornerStyle});if(o.setCartesian3v(t),o.addTo(this._cornerLayer),this._checkTerrainCollision(o),s){let a=n[0].getCartesian(),h=s.getCartesian(),c=o.getCartesian().sub(h),u=o.getCartesian().sub(a),d=c.length(),f=u.length();c.normalize(),u.normalize();let g=[],_=[];for(let C=0;C<=kt;C++){let P=c.scaleTo(C*d/kt).addA(h);g.push(P);let w=u.scaleTo(C*f/kt).addA(a);_.push(w)}this._outlineLayer.getEntities()[0].polyline.setPath3v([_]);let m=new G({polyline:{path3v:[g],isClosed:!1,...this._outlineStyle}});m.polyline.altitude=gi,this._outlineLayer.add(m);let p=this._centerLayer.getEntities(),x=p[p.length-1],y=c.scaleTo(.5*d).addA(h),T=u.scaleTo(.5*f).addA(a),S=new G({geoObject:this._centerStyle});S.setCartesian3v(y),S.addTo(this._centerLayer),this._checkTerrainCollision(S),x.remove(),x.addTo(this._centerLayer),x.setCartesian3v(T)}else new G({geoObject:this._centerStyle}).addTo(this._centerLayer)}_clearGhostPointer(){const t=this._ghostOutlineLayer;t.getEntities()[0].polyline.clear(),t.getEntities()[1].polyline.clear()}_moveCornerPoint(t){let n=new H(t.x,t.y).sub(this._startClick),s=this._startPos.add(n),o=this._planet.getCartesianFromPixelTerrain(s);if(o){this._pickedCorner.setCartesian3v(o);let a=this._cornerLayer.getEntities();if(a.length){let h=this._pickedCorner.layerIndex,c=a.length,u=a[h===0?c-1:h-1].getCartesian(),d=a[(h+1)%c].getCartesian(),f=this._pickedCorner.getCartesian().sub(u),g=this._pickedCorner.getCartesian().sub(d),_=f.length(),m=g.length();f.normalize(),g.normalize();let p=[],x=[];for(let N=0;N<=kt;N++){let k=f.scaleTo(N*_/kt).addA(u);p.push(k);let D=g.scaleTo(N*m/kt).addA(d);x.push(D)}let y=this._outlineLayer.getEntities(),T=y[h].polyline,S=y[(h+1)%c].polyline;T==null||T.setPath3v([p]),S==null||S.setPath3v([x]);let C=this._centerLayer.getEntities(),P=C[h===0?c-1:h-1],w=C[h],I=f.scaleTo(.5*_).addA(u),O=g.scaleTo(.5*m).addA(d);P.setCartesian3v(I),this._checkTerrainCollision(P),w.setCartesian3v(O),this._checkTerrainCollision(w)}}}_updateGhostOutlinePointer(t){let n=this._cornerLayer.getEntities(),s=n.length;if(s>0){let o=0,a=xt;for(let D=0;D<s;D++){let ze=n[D].getCartesian().distance(t);ze<a&&(a=ze,o=D)}let h=n[o].getCartesian(),c=n[(o+1)%s].getCartesian(),u=n[o===0?s-1:o-1].getCartesian().sub(h).normalize(),d=c.sub(h).normalize(),f=t.sub(h).normalize(),g=u.add(d).normalize(),_=f.cross(g),m=u.cross(d);_.dot(m)>0&&(o--,o<0&&(o=s-1));let p=new v;for(let D=0;D<s;D++)if(new Jt(n[D].getCartesian(),n[(D+1)%s].getCartesian()).getNearestDistancePoint(t,p)){let ze=p.distance(t);ze<a&&(a=ze,o=D)}this._insertCornerIndex=(o+1)%s;let x=n[o%s].getCartesian(),y=n[(o+1)%s].getCartesian(),T=this._ghostCorner.getCartesian().sub(x),S=this._ghostCorner.getCartesian().sub(y),C=T.length(),P=S.length();T.normalize(),S.normalize();let w=[],I=[];for(let D=0;D<=kt;D++){let ze=T.scaleTo(D*C/kt).addA(x);w.push(ze);let z=S.scaleTo(D*P/kt).addA(y);I.push(z)}let O=this._ghostOutlineLayer.getEntities(),N=O[0].polyline,k=O[1].polyline;N==null||N.setPath3v([w]),k==null||k.setPath3v([I])}}_initGhostLayerPointer(){this._ghostOutlineLayer.setEntities([new G({polyline:{path3v:[],isClosed:!1,...this._outlineStyle}}),new G({polyline:{path3v:[],isClosed:!1,...this._outlineStyle}}),this._ghostCorner]);const t=this._ghostOutlineLayer;t.getEntities()[0].polyline.altitude=t.getEntities()[1].polyline.altitude=gi}}class Bn extends oa{constructor(t){super(t)}get geometryType(){return"LineString"}_addNew(t){this._appendCart(t)}_appendCart(t){let n=this._cornerLayer.getEntities(),s=n[n.length-1],o=new G({geoObject:this._cornerStyle});if(o.setCartesian3v(t),o.addTo(this._cornerLayer),this._checkTerrainCollision(o),s){let a=s.getCartesian(),h=o.getCartesian().sub(a),c=h.length();h.normalize();let u=[];for(let _=0;_<=kt;_++){let m=h.scaleTo(_*c/kt).addA(a);u.push(m)}let d=new G({polyline:{path3v:[u],isClosed:!1,...this._outlineStyle}});d.polyline.altitude=gi,this._outlineLayer.add(d);let f=h.scaleTo(.5*c).addA(a),g=new G({geoObject:this._centerStyle});g.setCartesian3v(f),g.addTo(this._centerLayer),this._checkTerrainCollision(g)}}_clearGhostPointer(){this._ghostOutlineLayer.getEntities()[0].polyline.clear()}_moveCorner(t,n,s){let o=this._cornerLayer.getEntities();if(o.length==0)return;o.length==1&&(t=n=s=0);let a=o[t].getCartesian(),h=this._pickedCorner.getCartesian().sub(a),c=h.length();h.normalize();let u=[];for(let g=0;g<=kt;g++){let _=h.scaleTo(g*c/kt).addA(a);u.push(_)}let d=this._outlineLayer.getEntities()[n].polyline;d==null||d.setPath3v([u]);let f=this._centerLayer.getEntities()[s];if(f){let g=h.scaleTo(.5*c).addA(a);f.setCartesian3v(g),this._checkTerrainCollision(f)}}_moveCornerPoint(t){let n=new H(t.x,t.y).sub(this._startClick),s=this._startPos.add(n),o=this._planet.getCartesianFromPixelTerrain(s);if(o){this._pickedCorner.setCartesian3v(o);let a=this._cornerLayer.getEntities();if(a.length){let h=this._pickedCorner.layerIndex;h===0?this._moveCorner(h+1,h+1,h):(h===a.length-1||this._moveCorner(h+1,h+1,h),this._moveCorner(h-1,h,h-1))}}}_updateGhostOutlinePointer(t){let n=this._cornerLayer.getEntities(),s=n.length;if(s>0){let o=s-1;this._insertCornerIndex=o;let a=n[o].getCartesian(),h=this._ghostCorner.getCartesian().sub(a),c=h.length();h.normalize();let u=[];for(let d=0;d<=kt;d++){let f=h.scaleTo(d*c/kt).addA(a);u.push(f)}this._ghostOutlineLayer.getEntities()[0].polyline.setPath3v([u])}}_initGhostLayerPointer(){this._ghostOutlineLayer.setEntities([new G({polyline:{path3v:[],isClosed:!1,...this._outlineStyle}}),this._ghostCorner]),this._ghostOutlineLayer.getEntities()[0].polyline.altitude=gi}}class kn extends Q{constructor(t={}){super(t),this._drawingScene=new Bn({name:`drawingScene:${this.__id}`,cornerStyle:t.cornerStyle||{},centerStyle:t.centerStyle||{},outlineStyle:t.outlineStyle||{},fillStyle:t.fillStyle||{}})}activatePolygonDrawing(){this.deactivate(),this._drawingScene=new oa({name:`polygonDrawingScene:${this.__id}`,cornerStyle:this._drawingScene._cornerStyle,centerStyle:this._drawingScene._centerStyle,outlineStyle:this._drawingScene._outlineStyle,fillStyle:this._drawingScene._fillStyle}),this.activate()}activateLineStringDrawing(){this.deactivate(),this._drawingScene=new Bn({name:`linestringDrawingScene:${this.__id}`,cornerStyle:this._drawingScene._cornerStyle,centerStyle:this._drawingScene._centerStyle,outlineStyle:this._drawingScene._outlineStyle,fillStyle:this._drawingScene._fillStyle}),this.activate()}oninit(){}onactivate(){this.planet&&this._drawingScene.bindPlanet(this.planet),this.renderer&&this.renderer.addNode(this._drawingScene)}ondeactivate(){this.renderer&&this.renderer.removeNode(this._drawingScene)}}const li={ell:0,msl:1,gnd:2},sn=.3048,ml=1/sn,vl=1/3.6,aa=.001*sn,yl=1/aa,xl=["m","km","ft","s","h","m/s","km/h","ft/s"],la=[0,2,0,0,0,0,0,0];let pt=[];function ha(l,t,n){return pt[l][t](n)}function Ir(l,t,n,s,o){return l?ha(t,n,s).toFixed(o||la[n]):"--"}function ca(l){return xl[l]}pt[0]=[],pt[0][0]=l=>l,pt[0][1]=l=>.001*l,pt[0][2]=l=>l*ml,pt[2]=[],pt[2][0]=l=>l*sn,pt[2][1]=l=>l*aa,pt[2][2]=l=>l,pt[1]=[],pt[1][0]=l=>1e3*l,pt[1][1]=l=>l,pt[1][2]=l=>l*yl,pt[5]=[],pt[5][5]=l=>l,pt[5][6]=l=>3.6*l,pt[5][7]=l=>3.28084*l,pt[6]=[],pt[6][5]=l=>l*vl,pt[6][6]=l=>l;const In=Object.freeze(Object.defineProperty({__proto__:null,ELL:0,GND:2,MSL:1,_tenth:la,convert:ha,convertExt:Ir,ft:2,fts:7,h:4,heightMode:li,km:1,kmh:6,m:0,ms:5,s:3,toString:ca},Symbol.toStringTag,{value:"Module"})),bl=[`<div class="og-lat-side"></div><div class="og-lat-val"></div>
    <div class="og-lon-side"></div><div class="og-lon-val"></div>
    <div class="og-height"></div>
    <div class="og-units-height"></div>`,`<div class="og-lat-side"></div><div class="og-lat-val"></div>
    <div class="og-lon-side"></div><div class="og-lon-val"></div>
    <div class="og-height"></div>
    <div class="og-units-height"></div>`];class da extends Q{constructor(t={}){super(t),this._type=t.type||0,this._TYPE_FUNC=[this._SHOW_DECIMAL,this._SHOW_DEGREE],this._showFn=null,this._el=null,this._latSideEl=null,this._lonSideEl=null,this._latValEl=null,this._lonValEl=null,this._heightEl=null,this._altUnitVal=t.altitudeUnit||"m",this._heightModeVal=t.heightMode||"ell",this._altUnit=In[this._altUnitVal],this._heightMode=li[this._heightModeVal],this._lonLat=null,this._centerMode=!1}_SHOW_DECIMAL(t){if(t){let n=t.lat,s=t.lon;this._latSideEl.innerHTML=n>=0?"N":"S",this._lonSideEl.innerHTML=s>=0?"E":"W",this._latValEl.innerHTML=Math.abs(n).toFixed(7)+"°",this._lonValEl.innerHTML=Math.abs(s).toFixed(7)+"°"}}_SHOW_DEGREE(t){if(t){let n=t.lat,s=t.lon;this._latSideEl.innerHTML=n>=0?"N":"S",this._lonSideEl.innerHTML=s>=0?"E":"W";let o=0,a=n<0?Math.ceil(n):Math.floor(n),h=Math.floor(o=60*Math.abs(n-a)),c=Math.floor(6e3*(o-h))/100;this._latValEl.innerHTML=Math.abs(a)+"°"+h+"'"+c.toFixed(0)+'"',a=s<0?Math.ceil(s):Math.floor(s),h=Math.floor(o=60*Math.abs(s-a)),c=Math.floor(6e3*(o-h))/100,this._lonValEl.innerHTML=Math.abs(a)+"°"+h+"'"+c.toFixed(0)+'"'}}_createCenterEl(){let t=document.createElement("div");return t.className="og-center-icon",t.innerHTML='<svg width="12" height="12"><g><path stroke-width="1" stroke-opacity="1" d="M6 0L6 12M0 6L12 6" stroke="#337ab7"></path></g></svg>',t}_updateUnits(){this._heightMode=li[this._heightModeVal],this._altUnit=In[this._altUnitVal],this._el.querySelector(".og-units-height").innerHTML=ca(this._altUnit),this._showHeight()}_refreshCoordinates(){this._type>=this._TYPE_FUNC.length&&(this._type=0);let t=this._el;t.innerHTML=bl[this._type],this._latSideEl=t.querySelector(".og-lat-side"),this._lonSideEl=t.querySelector(".og-lon-side"),this._latValEl=t.querySelector(".og-lat-val"),this._lonValEl=t.querySelector(".og-lon-val"),this._heightEl=t.querySelector(".og-height"),this._showFn=this._TYPE_FUNC[this._type],this._showFn(this._lonLat)}oninit(){this._el=document.createElement("div"),this._el.classList.add("og-coordinates"),this.renderer.div.appendChild(this._el),this._el.addEventListener("click",()=>{this._type++,this._refreshCoordinates(),this._updateUnits(),this._showHeight()}),this._centerMode?(this.renderer.div.appendChild(this._createCenterEl()),this.planet.camera.events.on("moveend",this._grabCoordinates,this),this.planet.camera.events.on("moveend",yi(()=>this._showHeight(),400,!0),this)):(this.renderer.events.on("mousemove",this._grabCoordinates,this),this.renderer.events.on("mousestop",yi(()=>this._showHeight(),400,!0),this)),this._refreshCoordinates(),this._updateUnits()}_grabCoordinates(t){let n,s=t.pos,o=this.renderer;n=this._centerMode?o.handler.getCenter():s,this._lonLat=this.planet.getLonLatFromPixelTerrain(n)||null,this._showFn(this._lonLat)}async _showHeight(){if(this._lonLat&&this.planet){let t=0;this._heightEl.style.opacity="0.7",this._heightMode===li.ell?(t=await this.planet.getHeightAboveELL(this._lonLat),t=Number(Ir(!0,0,this._altUnit,t))):this._heightMode===li.msl&&(t=await this.planet.getHeightDefault(this._lonLat),t=Number(Ir(!0,0,this._altUnit,t))),this._heightEl.style.opacity="1.0",this._heightEl.innerHTML=t.toString()}}}const wl=["loadend"];class Ai extends zt{constructor(t,n={}){super(t,n),this.events=this.events.registerNames(wl),this._projType=0,this._frameWidth=256,this._frameHeight=256,this._sourceReady=!1,this._sourceTexture=null,this._materialTexture=null,this._gridBufferLow=null,this._gridBufferHigh=null,this._extentWgs84ParamsHigh=new Float32Array(4),this._extentWgs84ParamsLow=new Float32Array(4),this._extentMercParamsHigh=new Float32Array(4),this._extentMercParamsLow=new Float32Array(4),this._refreshFrame=!0,this._frameCreated=!1,this._sourceCreated=!1,this._animate=!1,this._ready=!1,this._creationProceeding=!1,this._isRendering=!1,this._extentWgs84=new U,this._cornersWgs84=[],this._cornersMerc=[],this._isFullExtent=n.fullExtent?1:0,this.rendering=this._renderingProjType0.bind(this),this._onLoadend_=null,n.corners&&this.setCorners(n.corners)}get isIdle(){return super.isIdle&&this._ready}addTo(t){return this._onLoadend_=this._onLoadend.bind(this),this.events.on("loadend",this._onLoadend_,this),super.addTo(t)}_onLoadend(){this._planet&&this._planet.events.dispatch(this._planet.events.layerloadend,this)}remove(){return this.events.off("loadend",this._onLoadend_),this._onLoadend_=null,super.remove()}get instanceName(){return"BaseGeoImage"}getCornersLonLat(){let t=this._cornersWgs84;return[new L(t[0].lon,t[0].lat),new L(t[1].lon,t[1].lat),new L(t[2].lon,t[2].lat),new L(t[3].lon,t[3].lat)]}getCorners(){let t=this._cornersWgs84;return[[t[0].lon,t[0].lat],[t[1].lon,t[1].lat],[t[2].lon,t[2].lat],[t[3].lon,t[3].lat]]}setCorners(t){this.setCornersLonLat(L.join(t))}setCornersLonLat(t){this._refreshFrame=!0,this._cornersWgs84=[t[0].clone(),t[1].clone(),t[2].clone(),t[3].clone()];for(let s=0;s<this._cornersWgs84.length;s++)this._cornersWgs84[s].lat>=89.9&&(this._cornersWgs84[s].lat=89.9),this._cornersWgs84[s].lat<=-89.9&&(this._cornersWgs84[s].lat=-89.9);this._extent.setByCoordinates(this._cornersWgs84);let n=this._extent;n.southWest.lat>ct||n.northEast.lat<Ot?(this._projType=0,this.rendering=this._renderingProjType0):(this._projType=1,this.rendering=this._renderingProjType1),this._ready&&!this._creationProceeding&&this._planet._geoImageCreator.add(this)}_createFrame(){this._extentWgs84=this._extent.clone(),this._cornersMerc=[this._cornersWgs84[0].forwardMercatorEPS01(),this._cornersWgs84[1].forwardMercatorEPS01(),this._cornersWgs84[2].forwardMercatorEPS01(),this._cornersWgs84[3].forwardMercatorEPS01()],this._extentMerc=new U(this._extentWgs84.southWest.forwardMercatorEPS01(),this._extentWgs84.northEast.forwardMercatorEPS01());let t=new Float32Array(2);if(this._projType===0?(ae(this._extentWgs84.southWest.lon,t),this._extentWgs84ParamsHigh[0]=t[0],this._extentWgs84ParamsLow[0]=t[1],ae(this._extentWgs84.southWest.lat,t),this._extentWgs84ParamsHigh[1]=t[0],this._extentWgs84ParamsLow[1]=t[1],this._extentWgs84ParamsHigh[2]=2/this._extentWgs84.getWidth(),this._extentWgs84ParamsHigh[3]=2/this._extentWgs84.getHeight()):(ae(this._extentMerc.southWest.lon,t),this._extentMercParamsHigh[0]=t[0],this._extentMercParamsLow[0]=t[1],ae(this._extentMerc.southWest.lat,t),this._extentMercParamsHigh[1]=t[0],this._extentMercParamsLow[1]=t[1],this._extentMercParamsHigh[2]=2/this._extentMerc.getWidth(),this._extentMercParamsHigh[3]=2/this._extentMerc.getHeight()),this._planet){let n=this._planet.renderer.handler;n.gl.deleteTexture(this._materialTexture),this._materialTexture=n.createEmptyTexture_l(this._frameWidth,this._frameHeight);let s=this._planet._geoImageCreator.createGridBuffer(this._cornersWgs84,this._projType===1);this._gridBufferHigh=s[0],this._gridBufferLow=s[1],this._refreshFrame=!1}}abortMaterialLoading(t){this._creationProceeding=!1,t.isLoading=!1,t.isReady=!1}clear(){let t=this._planet;if(t){let n=t.renderer.handler.gl;this._creationProceeding&&t._geoImageCreator.remove(this),t._clearLayerMaterial(this),n&&(n.deleteBuffer(this._gridBufferHigh),n.deleteBuffer(this._gridBufferLow),n.deleteTexture(this._sourceTexture),this._materialTexture&&!this._materialTexture.default&&n.deleteTexture(this._materialTexture))}this._sourceTexture=null,this._materialTexture=null,this._gridBufferHigh=null,this._gridBufferLow=null,this._refreshFrame=!0,this._sourceCreated=!1,this._ready=!1,this._creationProceeding=!1}setVisibility(t){t!==this._visibility&&(super.setVisibility(t),this._planet&&this._sourceReady&&(t?this._planet._geoImageCreator.add(this):this._planet._geoImageCreator.remove(this)))}clearMaterial(t){t.texture=null,t.isLoading=!1,t.isReady=!1}applyMaterial(t){let n,s,o=t.segment;this._ready?t.applyTexture(this._materialTexture):(t.texture=this._planet.transparentTexture,!this._creationProceeding&&this.loadMaterial(t)),this._projType===0?(n=this._extentWgs84,s=o._extent):(n=this._extentMerc,s=o.getExtentMerc());let a=n.northEast.lon-n.southWest.lon,h=n.northEast.lat-n.southWest.lat;return[(s.southWest.lon-n.southWest.lon)/a,(n.northEast.lat-s.northEast.lat)/h,(s.northEast.lon-s.southWest.lon)/a,(s.northEast.lat-s.southWest.lat)/h]}get getFrameWidth(){return this._frameWidth}get getFrameHeight(){return this._frameHeight}_createSourceTexture(){}_renderingProjType1(){let t=this._planet,n=t.renderer.handler,s=n.gl,o=t._geoImageCreator;this._refreshFrame&&this._createFrame(),this._createSourceTexture();let a=o._framebuffer;a.setSize(this._frameWidth,this._frameHeight),a.activate(),n.programs.geoImageTransform.activate();let h=n.programs.geoImageTransform._program,c=h.attributes,u=h.uniforms;s.disable(s.CULL_FACE),a.bindOutputTexture(this._materialTexture),s.clearColor(0,0,0,0),s.clear(s.COLOR_BUFFER_BIT),s.uniform1i(u.isFullExtent,this._isFullExtent),s.bindBuffer(s.ARRAY_BUFFER,o._texCoordsBuffer),s.vertexAttribPointer(c.texCoords,2,s.UNSIGNED_SHORT,!0,0,0),s.bindBuffer(s.ARRAY_BUFFER,this._gridBufferHigh),s.vertexAttribPointer(c.cornersHigh,this._gridBufferHigh.itemSize,s.FLOAT,!1,0,0),s.bindBuffer(s.ARRAY_BUFFER,this._gridBufferLow),s.vertexAttribPointer(c.cornersLow,this._gridBufferLow.itemSize,s.FLOAT,!1,0,0),s.uniform4fv(u.extentParamsHigh,this._extentMercParamsHigh),s.uniform4fv(u.extentParamsLow,this._extentMercParamsLow),s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,this._sourceTexture),s.uniform1i(u.sourceTexture,0),s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,o._indexBuffer),s.drawElements(s.TRIANGLE_STRIP,o._indexBuffer.numItems,s.UNSIGNED_INT,0),a.deactivate(),s.enable(s.CULL_FACE),this._ready=!0,this._creationProceeding=!1}_renderingProjType0(){let t=this._planet,n=t.renderer.handler,s=n.gl,o=t._geoImageCreator;this._refreshFrame&&this._createFrame(),this._createSourceTexture();let a=o._framebuffer;a.setSize(this._frameWidth,this._frameHeight),a.activate(),n.programs.geoImageTransform.activate();let h=n.programs.geoImageTransform._program,c=h.attributes,u=h.uniforms;s.disable(s.CULL_FACE),a.bindOutputTexture(this._materialTexture),s.clearColor(0,0,0,0),s.clear(s.COLOR_BUFFER_BIT),s.bindBuffer(s.ARRAY_BUFFER,o._texCoordsBuffer),s.vertexAttribPointer(c.texCoords,2,s.UNSIGNED_SHORT,!0,0,0),s.bindBuffer(s.ARRAY_BUFFER,this._gridBufferHigh),s.vertexAttribPointer(c.cornersHigh,this._gridBufferHigh.itemSize,s.FLOAT,!1,0,0),s.bindBuffer(s.ARRAY_BUFFER,this._gridBufferLow),s.vertexAttribPointer(c.cornersLow,this._gridBufferLow.itemSize,s.FLOAT,!1,0,0),s.uniform4fv(u.extentParamsHigh,this._extentWgs84ParamsHigh),s.uniform4fv(u.extentParamsLow,this._extentWgs84ParamsLow),s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,this._sourceTexture),s.uniform1i(u.sourceTexture,0),s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,o._indexBuffer),s.drawElements(s.TRIANGLE_STRIP,o._indexBuffer.numItems,s.UNSIGNED_INT,0),a.deactivate(),s.enable(s.CULL_FACE),this._ready=!0,this._creationProceeding=!1}}const W={MB_LEFT:0,MB_RIGHT:2,MB_MIDDLE:1,KEY_CTRL:17,KEY_ALT:18,KEY_SHIFT:16,KEY_LEFT:37,KEY_UP:38,KEY_RIGHT:39,KEY_DOWN:40,KEY_PRINTSCREEN:44,KEY_A:65,KEY_D:68,KEY_E:69,KEY_Q:81,KEY_S:83,KEY_W:87,KEY_X:88,KEY_APOSTROPHE:192},Tl=["change","idle","play","pause","stop"];class Cl extends ut{constructor(t){super({template:Dt('<button title={title} class="og-layerSwitcher__layerButton">{icon}<div class="og-layerSwitcher__name">{name}</div></button>',{title:t.model.name,name:t.model.name,icon:t.model.iconSrc?`<img src="${t.model.iconSrc}" />`:""}),...t}),this._onVisibilityChange=n=>{this.el&&(this.model.getVisibility()?this.el.classList.add("og-layerSwitcher__visible"):this.el.classList.remove("og-layerSwitcher__visible"))},this._onClick=()=>{this.model.isBaseLayer()?this.model.setVisibility(!0):this.model.setVisibility(!this.model.getVisibility())},this._onDblClick=()=>{this.model.flyExtent()}}render(t){return super.render(t),this.model.events.on("visibilitychange",this._onVisibilityChange),this._onVisibilityChange(this.model),this.el.addEventListener("click",this._onClick),this.el.addEventListener("dblclick",this._onDblClick),this}remove(){super.remove(),this.model.events.off("visibilitychange",this._onVisibilityChange)}}const El=["change"];let Z$1=class extends ut{constructor(t={}){super({template:Dt(`<div class="og-slider">
      <div class="og-slider-label">{label}</div>
      <div class="og-slider-panel">
        <div class="og-slider-progress"></div>      
        <div class="og-slider-pointer"></div>
      </div>
      <input type="number"/>
    </div>`,{label:t.label||""})}),this._onResize=()=>{this._setOffset((this._value-this._min)*this.$panel.clientWidth/(this._max-this._min))},this._onMouseWheel=n=>{(n=n||window.event).preventDefault(),n.stopPropagation(),this.value=this._value+Math.sign(n.wheelDelta)*(this._max-this._min)/100},this._onMouseWheelFF=n=>{this._onMouseWheel(n)},this._onInput=n=>{(n=n||window.event).preventDefault(),n.stopPropagation(),this.value=parseFloat(n.target.value)},this._onMouseDown=n=>{(n=n||window.event).preventDefault(),this._startPosX=n.clientX,this.value=this._min+(this._max-this._min)*(n.offsetX/this.$panel.clientWidth),document.addEventListener("mousemove",this._onMouseMove),document.addEventListener("mouseup",this._onMouseUp)},this._onMouseMove=n=>{(n=n||window.event).preventDefault(),n.stopPropagation();let s=this.$panel.getBoundingClientRect(),o=Zi(n.clientX,s.left,s.right),a=this._startPosX-o;this._startPosX=o,this.value=this._value-a*(this._max-this._min)/this.$panel.clientWidth},this._onMouseUp=()=>{document.removeEventListener("mouseup",this._onMouseUp),document.removeEventListener("mousemove",this._onMouseMove)},this.events=this.events.registerNames(El),this._value=t.value||0,this._min=t.min||0,this._max=t.max||1,this._resizeObserver=new ResizeObserver(this._onResize),this._startPosX=0,this.$label=null,this.$pointer=null,this.$progress=null,this.$input=null,this.$panel=null}render(t){return super.render(t),this.$label=this.select(".og-slider-label"),this.$label.innerHTML===""&&(this.$label.style.display="none"),this.$pointer=this.select(".og-slider-pointer"),this.$progress=this.select(".og-slider-progress"),this.$panel=this.select(".og-slider-panel"),this.$input=this.select("input"),this._resizeObserver.observe(this.el),this._initEvents(),this}set value(t){t!==this._value&&(this._value=Zi(t,this._min,this._max),this.$input.value=this._value.toString(),this._setOffset((this._value-this._min)*this.$panel.clientWidth/(this._max-this._min)),this.events.dispatch(this.events.change,this._value,this))}get value(){return this._value}_initEvents(){this.$panel.addEventListener("mousedown",this._onMouseDown),this.$panel.addEventListener("mousewheel",this._onMouseWheel),this.$panel.addEventListener("wheel",this._onMouseWheelFF),this.$input.addEventListener("input",this._onInput)}_clearEvents(){this.$panel.removeEventListener("mousedown",this._onMouseDown),this.$panel.removeEventListener("mousewheel",this._onMouseWheel),this.$panel.removeEventListener("wheel",this._onMouseWheelFF),this.$input.removeEventListener("input",this._onInput)}_setOffset(t){t>=0&&t<=this.$panel.clientWidth&&(this.$pointer.style.left=this.$progress.style.width=100*t/this.$panel.clientWidth+"%")}remove(){this._clearEvents(),super.remove()}set max(t){this._max=t,this.events.stopPropagation(),this.value=this._value+Math.sign(e.wheelDelta)*(this._max-this._min)/100}get max(){return this._max}};const Al=["input"];let Ll=0;class zn extends ut{constructor(t={}){super({template:Dt(`<div class="og-color">
      <label for="{id}" class="og-color-label">{label}</label>
      <input type="color" name="{id}" value="{value}"/>
    </div>`,{id:"color-"+Ll++,label:t.label||"",value:t.value||"#000000"})}),this._onInput=n=>{this.value=n.target.value},this.events=this.events.registerNames(Al),this._value=t.value||"blue",this.$label=null,this.$input=null}render(t){return super.render(t),this.$label=this.select(".og-color-label"),this.$label.innerHTML===""&&(this.$label.style.display="none"),this.$input=this.select("input"),this._initEvents(),this}set value(t){t!==this._value&&(this._value=t,this.$input.value=this._value,this.events.dispatch(this.events.input,this._value,this))}get value(){return this._value}_initEvents(){this.$input.addEventListener("input",this._onInput)}_clearEvents(){this.$input.removeEventListener("input",this._onInput)}remove(){this._clearEvents(),super.remove()}}class zr{constructor(){this._lock=0}lock(t){this._lock|=1<<t.id}free(t){this._lock&=~(1<<t.id)}isFree(){return this._lock===0}isLocked(){return this._lock!==0}}const Ps=class fd{constructor(){this.__id=fd.__counter__++}get id(){return this.__id}};Ps.__counter__=0;let Me=Ps;class rn extends Q{constructor(t={}){super(t),this._deactivate=!1,this._shiftBusy=!1,this._name="mouseNavigation",this.grabbedPoint=new v,this._eye0=new v,this.pointOnEarth=new v,this.earthUp=new v,this.inertia=.007,this.grabbedSpheroid=new Ft,this.qRot=new F,this.scaleRot=0,this.distDiff=.3,this.stepsCount=8,this.stepsForward=null,this.stepIndex=0,this._lmbDoubleClickActive=!0,this.minSlope=t.minSlope||.1,this._wheelDirection=1,this._keyLock=new Me}static getMovePointsFromPixelTerrain(t,n,s,o,a,h,c){const u=[];let d=t.eye.clone(),f=t.getBackward(),g=t.getRight(),_=t.getUp(),m=n.getCartesianFromPixelTerrain(a);if(m||(m=n.getCartesianFromPixelTerrain(n.renderer.handler.getCenter())),m){c||(c=v.sub(m,t.eye).normalize());let p=o*t.eye.distance(m)/s;p*=h?-1.25:2;const x=f.scaleTo(p);if(c.dot(t.eye.normal().negate())>=.1){const y=new Ft;y.radius=m.length();let T=[],S=[],C=!1;for(let P=0;P<s;P++){d.addA(x);const w=new V(d,c).hitSphere(y);if(S[P]=d.clone(),!w){C=!0;break}T[P]=new tt().rotateBetweenVectors(m.normal(),w.normal())}if(C){d=t.eye.clone();for(let P=0;P<s;P++)u[P]={eye:d.addA(x).clone(),v:_,u:g,n:f}}else for(let P=0;P<s;P++){let w=T[P];u[P]={eye:w.mulVec3(S[P]),v:w.mulVec3(_),u:w.mulVec3(g),n:w.mulVec3(f)}}}else for(let y=0;y<s;y++)u[y]={eye:d.addA(c.scaleTo(-p)).clone(),v:_,u:g,n:f};return u}}onactivate(){this.renderer&&(this.renderer.events.on("mousewheel",this.onMouseWheel,this),this.renderer.events.on("lhold",this.onMouseLeftButtonDown,this),this.renderer.events.on("rhold",this.onMouseRightButtonDown,this),this.renderer.events.on("ldown",this.onMouseLeftButtonClick,this),this.renderer.events.on("lup",this.onMouseLeftButtonUp,this),this.renderer.events.on("rdown",this.onMouseRightButtonClick,this),this.renderer.events.on("draw",this.onDraw,this,-1e3),this.renderer.events.on("mousemove",this.onMouseMove,this),this.renderer.events.on("mouseleave",this.onMouseLeave,this),this.renderer.events.on("mouseenter",this.onMouseEnter,this),this._lmbDoubleClickActive&&this.renderer.events.on("ldblclick",this.onMouseLeftButtonDoubleClick,this))}ondeactivate(){this.renderer&&(this.renderer.events.off("mousewheel",this.onMouseWheel),this.renderer.events.off("lhold",this.onMouseLeftButtonDown),this.renderer.events.off("rhold",this.onMouseRightButtonDown),this.renderer.events.off("ldown",this.onMouseLeftButtonClick),this.renderer.events.off("lup",this.onMouseLeftButtonUp),this.renderer.events.off("rdown",this.onMouseRightButtonClick),this.renderer.events.off("draw",this.onDraw),this.renderer.events.off("ldblclick",this.onMouseLeftButtonDoubleClick),this.renderer.events.off("mouseleave",this.onMouseLeave),this.renderer.events.off("mouseenter",this.onMouseEnter))}activateDoubleClickZoom(){this._lmbDoubleClickActive||(this._lmbDoubleClickActive=!0,this.renderer&&this.renderer.events.on("ldblclick",this.onMouseLeftButtonDoubleClick,this))}deactivateDoubleClickZoom(){this._lmbDoubleClickActive&&(this._lmbDoubleClickActive=!1,this.renderer&&this.renderer.events.off("ldblclick",this.onMouseLeftButtonDoubleClick))}onMouseEnter(t){const n=this.renderer.events;n.isKeyPressed(W.KEY_ALT)&&n.releaseKeys(),n.updateButtonsStates(t.sys.buttons),n.mouseState.leftButtonDown?this.renderer.handler.canvas.classList.add("ogGrabbingPoiner"):this.renderer.handler.canvas.classList.remove("ogGrabbingPoiner")}onMouseLeave(){this.renderer.events.mouseState.leftButtonDown&&(this.scaleRot=0),this.renderer.handler.canvas.classList.remove("ogGrabbingPoiner")}onMouseWheel(t){this.stepIndex||(this.planet.stopFlying(),this.stopRotation(),this._deactivate=!0,this.lockPlanet(!0),this.stepsForward=rn.getMovePointsFromPixelTerrain(this.planet.camera,this.planet,this.stepsCount,this.distDiff,t.pos,t.wheelDelta>0,t.direction)||null,this._wheelDirection=t.wheelDelta,this.stepsForward&&(this.stepIndex=this.stepsCount))}oninit(){this.activate(),this.renderer&&(this.renderer.events.on("keyfree",W.KEY_ALT,this.onShiftFree,this),this.renderer.events.on("keyfree",W.KEY_PRINTSCREEN,this.onShiftFree,this))}onMouseLeftButtonDoubleClick(t){this.planet.stopFlying(),this.stopRotation();const n=this.planet.getCartesianFromPixelTerrain(t.pos);if(n){const s=this.planet.camera;let o=s.maxAltitude+this.planet.ellipsoid.polarSize,a=s.minAltitude+this.planet.ellipsoid.polarSize;const h=s.eye.length(),c=this.planet.ellipsoid.cartesianToLonLat(n);if(h>o||h<a)return void this.planet.flyLonLat(new L(c.lon,c.lat));this.renderer.events.isKeyPressed(W.KEY_ALT)?this.planet.flyLonLat(new L(c.lon,c.lat,2*s.eye.distance(n))):this.planet.flyLonLat(new L(c.lon,c.lat,.57*s.eye.distance(n)))}}onMouseLeftButtonClick(){this._active&&(this.renderer.handler.canvas.classList.add("ogGrabbingPoiner"),this.grabbedPoint=this.planet.getCartesianFromMouseTerrain(),this.grabbedPoint&&(this._eye0.copy(this.planet.camera.eye),this.grabbedSpheroid.radius=this.grabbedPoint.length(),this.stopRotation()))}stopRotation(){this.qRot.clear(),this.freePlanet()}onMouseLeftButtonUp(t){this.renderer.handler.canvas.classList.remove("ogGrabbingPoiner"),t.x===t.prev_x&&t.y===t.prev_y&&(this.scaleRot=0)}onMouseLeftButtonDown(t){if(this._active){if(!this.grabbedPoint)return;if(this.planet.stopFlying(),t.moving){let n=this.planet.camera;if(n.slope>.2){const s=new V(n.eye,t.direction).hitSphere(this.grabbedSpheroid);if(s){this.scaleRot=1,this.qRot=F.getRotationBetweenVectors(s.normal(),this.grabbedPoint.normal());let o=this.qRot;n.eye=o.mulVec3(n.eye),n.rotate(o)}}else{let s=this.grabbedPoint,o=v.add(s,n.getRight()),a=v.add(s,s.normal()),h=new v;new V(n.eye,t.direction).hitPlaneRes(vt.fromPoints(s,o,a),h)===V.INSIDE&&(n.eye=this._eye0.addA(h.subA(s).negate()))}}}}onMouseRightButtonClick(t){this.stopRotation(),this.planet.stopFlying(),this.pointOnEarth=this.planet.getCartesianFromPixelTerrain(t.pos),this.pointOnEarth&&(this.earthUp=this.pointOnEarth.normal())}onMouseRightButtonDown(t){const n=this.planet.camera;if(this.pointOnEarth&&t.moving){this.renderer.controlsBag.scaleRot=1;let s=.5/n.eye.distance(this.pointOnEarth)*n._lonLat.height*j;s>.007?s=.007:s<.003&&(s=.003),n.rotateHorizontal(s*(t.x-t.prev_x),!1,this.pointOnEarth,this.earthUp),n.rotateVertical(s*(t.y-t.prev_y),this.pointOnEarth,this.minSlope)}}onShiftFree(){this._shiftBusy=!1}onMouseMove(t){this._active&&this.renderer.events.isKeyPressed(W.KEY_ALT)&&(this._shiftBusy||(this._shiftBusy=!0,this.onMouseRightButtonClick(t)),this.onMouseRightButtonDown(t))}onDraw(){if(this._active){const t=this.renderer,n=this.planet.camera;let s=n.eye.clone();if(this.stepIndex){t.controlsBag.scaleRot=1;const o=this.stepsForward[this.stepsCount-this.stepIndex--];n.eye=o.eye,n._u=o.v,n._r=o.u,n._b=o.n,n._f.set(-n._b.x,-n._b.y,-n._b.z)}else this._deactivate&&(this._deactivate=!1,this.freePlanet());if(t.events.mouseState.leftButtonDown||!this.scaleRot)return;if(this.scaleRot-=this.inertia,this.scaleRot<=0)this.scaleRot=0;else{t.controlsBag.scaleRot=this.scaleRot;let o=this.qRot.slerp(F.IDENTITY,1-this.scaleRot*this.scaleRot*this.scaleRot).normalize();o.x||o.y||o.z||(this.scaleRot=0),n.eye=o.mulVec3(n.eye),n.rotate(o)}n.eye.distance(s)/n.getAltitude()>.01?this.lockPlanet():this.freePlanet()}}lockPlanet(t){this.planet.layerLock.lock(this._keyLock),!t&&this.planet.terrainLock.lock(this._keyLock),this.planet._normalMapCreator.lock(this._keyLock)}freePlanet(){this.planet.layerLock.free(this._keyLock),this.planet.terrainLock.free(this._keyLock),this.planet._normalMapCreator.free(this._keyLock)}}const Pl=["drag","zoom","rotate"],zi=.96;class Yi extends Q{constructor(t={}){super({name:"navigation",autoActivate:!0,...t}),this._freeMode=!1,this._shiftBusy=!1,this._hold=!1,this._onShiftFree=()=>{this._shiftBusy=!1},this._onCameraFly=()=>{this.stop()},this._onMouseMove=n=>{this._active&&this.renderer.events.isKeyPressed(W.KEY_ALT)&&(this._shiftBusy||(this._shiftBusy=!0,this._onRHold(n)),this._onRDown(n))},this._onMouseEnter=n=>{const s=this.renderer.events;s.isKeyPressed(W.KEY_ALT)&&s.releaseKeys(),s.updateButtonsStates(n.sys.buttons),s.mouseState.leftButtonDown?this.renderer.handler.canvas.classList.add("ogGrabbingPoiner"):this.renderer.handler.canvas.classList.remove("ogGrabbingPoiner")},this._onMouseLeave=()=>{this.renderer.events.mouseState.leftButtonDown&&this.vel.scale(0),this.renderer.handler.canvas.classList.remove("ogGrabbingPoiner")},this._onRHold=n=>{if((!this.disableRotation||!this.disableTilt)&&this._targetRotationPoint){this._velInertia=.6,this.disableRotation||(this.force_h=.5*(n.x-n.prev_x)),this.disableTilt||(this.force_v=.5*(n.y-n.prev_y));let s=this.planet.camera.getHeading();this._freeMode=!1,!isNaN(s)&&s>45&&s<340&&(this._freeMode=!0)}},this._onRDown=n=>{if((!this.disableRotation||!this.disableTilt)&&this.planet){this.planet.stopFlying();const s=this._getTargetPoint(n.pos);this._targetRotationPoint=s||null,s&&(this._targetZoomPoint=null,this._targetDragPoint=null,this.vel.set(0,0,0),this._tUp=s.getNormal(),this._tRad=this.planet.camera.eye.distance(s))}},this._onMouseWheel=n=>{if(this.planet){this._targetRotationPoint=null,this._targetDragPoint=null;let s=n.x,o=n.y,a=this.planet.camera;if(a.isOrthographic){s=.5*this.renderer.handler.getWidth(),o=.5*this.renderer.handler.getHeight();let d=this._getTargetPoint(new H(s,o));if(!d)return;this._targetZoomPoint=d,this._grabbedSphere.radius=this._targetZoomPoint.length();let f=a.eye.distance(d),g=new v,_=a.unproject(s,o,f,g);const m=g.sub(_.scaleTo(f));if(d=new V(m,_).hitSphere(this._grabbedSphere),!d)return;this._targetZoomPoint=d}else{let d=this._getTargetPoint(new H(s,o));if(!d)return;this._targetZoomPoint=d,this._grabbedSphere.radius=this._targetZoomPoint.length()}if(this._curPitch=a.getPitch(),this._curYaw=a.getYaw(),this._curRoll=a.getRoll(),Math.sign(n.wheelDelta)!==this._wheelDirection)return this.vel.scale(.3),this._currScreenPos.set(s,o),void(this._wheelDirection=Math.sign(n.wheelDelta));this._currScreenPos.set(s,o),this._wheelDirection=Math.sign(n.wheelDelta);let h=20;this._velInertia=.83,this._isTouchPad=n.isTouchPad,n.isTouchPad&&(this._velInertia=.63,h=17);let c=this._targetZoomPoint.sub(a.eye);c.length()>6e3&&this._wheelDirection>0&&a.eye.getNormal().negate().dot(c.normalize())<.3&&(h=4.3);let u=this.planet.camera.eye.distance(this._targetZoomPoint)*h;this.force=n.direction.scale(this._wheelDirection).normalize().scale(this._wheelDirection<0?1.3*u:u).scale(this.zoomSpeed),this.vel.set(0,0,0),this.force_roll=this._curRoll}},this._onLDown=n=>{this.stop(),this._targetRotationPoint=null,this._targetZoomPoint=null,this.planet&&(this.planet.stopFlying(),this._grabbedPoint=this._getTargetPoint(n.pos),this._grabbedPoint&&(this._targetDragPoint=this._grabbedPoint,this.planet.camera.isOrthographic?this._grabbedDist=this.renderer.getDistanceFromPixel(n.pos):this._grabbedDist=this.renderer.activeCamera.eye.distance(this._grabbedPoint),this.renderer.handler.canvas.classList.add("ogGrabbingPoiner"),this._grabbedSphere.radius=this._grabbedPoint.length(),this._eye0=this.planet.camera.eye.clone(),this._grabbedCameraHeight=this._eye0.length(),this._curPitch=this.planet.camera.getPitch(),this._curYaw=this.planet.camera.getYaw(),this._curRoll=this.planet.camera.getRoll(),this._currScreenPos.copy(n.pos)))},this._onLHold=n=>{if(this._grabbedPoint&&this.planet){let s=this.planet.camera;if(s.isOrthographic){const o=this._grabbedDist,a=new v,h=s.unproject(n.x,n.y,o,a),c=a.sub(h.scaleTo(o)),u=new V(c,h).hitSphere(this._grabbedSphere);if(!u)return;this._targetDragPoint=u;let d=F.getRotationBetweenVectors(this._targetDragPoint.getNormal(),this._grabbedPoint.getNormal()).mulVec3(s.eye);this.force=d.sub(s.eye).scale(this.dragInertia)}else if(s.slope>this.minSlope){this._grabbedDist=s.eye.distance(this._grabbedPoint);let o,a=s.unproject(n.x,n.y,this._grabbedDist),h=new V(s.eye,a).hitSphere(this._grabbedSphere);if(!h)return;if(this._targetDragPoint=h,this.freeMode)o=F.getRotationBetweenVectors(this._targetDragPoint.getNormal(),this._grabbedPoint.getNormal());else{let u=v.NORTH,d=Math.acos(h.dot(u)/this._grabbedSphere.radius)-Math.acos(this._grabbedPoint.dot(u)/this._grabbedSphere.radius),f=s.eyeNorm.dot(v.NORTH);(d>0&&f>=this.poleThreshold||d<0&&f<=-this.poleThreshold)&&(d=0);let g=F.axisAngleToQuat(u.cross(s.eyeNorm).normalize(),-d),_=v.proj_b_to_plane(h,u),m=v.proj_b_to_plane(this._grabbedPoint,u);o=F.getRotationBetweenVectors(_.getNormal(),m.getNormal()).mul(g)}let c=o.mulVec3(s.eye);this.force=c.sub(s.eye).scale(this.dragInertia)}else{let o=this._grabbedPoint,a=v.add(o,s.getRight()),h=v.add(o,o.getNormal()),c=new v;new V(s.eye,n.direction).hitPlaneRes(vt.fromPoints(o,a,h),c);let u=s.eye.add(c.subA(o).negate());this.force=u.sub(s.eye).scale(this.dragInertia),this._targetDragPoint=c}this.vel.set(0,0,0),this._currScreenPos.equal(n.pos)||this._currScreenPos.copy(n.pos),this._hold=!0}},this._onLUp=n=>{this._hold=!1,this.renderer.handler.canvas.classList.remove("ogGrabbingPoiner")},this.events=lt(Pl,this),this.force=new v,this.force_h=0,this.force_v=0,this.vel=new v,this.vel_h=0,this.vel_v=0,this.vel_roll=0,this.force_roll=0,this.mass=t.mass!=null?t.mass:1,this.inertia=t.inertia!=null?t.inertia:1,this._velInertia=zi,this.minSlope=t.minSlope!=null?t.minSlope:.35,this.dragInertia=t.dragInertia!=null?t.dragInertia:170,this.zoomSpeed=t.zoomSpeed!=null?t.zoomSpeed:1,this.poleThreshold=t.poleThreshold!=null?t.poleThreshold:.999,this.disableRotation=t.disableRotation!=null&&t.disableRotation,this.disableTilt=t.disableTilt!=null&&t.disableTilt,this._lookPos=void 0,this._grabbedPoint=null,this._grabbedDist=0,this._targetZoomPoint=null,this._targetDragPoint=null,this._targetRotationPoint=null,this._tUp=new v,this._tRad=0,this._rotHDir=0,this._rotVDir=0,this._wheelDirection=1,this._currScreenPos=new H,this._grabbedSphere=new Ft,this._rot=new F,this._curPitch=0,this._curYaw=0,this._curRoll=0,this._eye0=new v,this._newEye=new v,this._grabbedCameraHeight=0,this._isTouchPad=!1,this._freeMode=!1,this.mode=this._modeToNumber(t.mode||"adaptive")}oninit(){this.renderer&&(this.renderer.events.on("keyfree",W.KEY_ALT,this._onShiftFree),this.renderer.events.on("keyfree",W.KEY_PRINTSCREEN,this._onShiftFree))}onadd(){var t;(t=this.planet)!=null&&t.camera&&this.planet.camera.events.on("flystart",this._onCameraFly)}onremove(){var t;(t=this.planet)!=null&&t.camera&&this.planet.camera.events.off("flystart",this._onCameraFly)}onactivate(){super.onactivate();let t=this.renderer;t.events.on("mousewheel",this._onMouseWheel),t.events.on("rhold",this._onRHold),t.events.on("rdown",this._onRDown),t.events.on("lhold",this._onLHold),t.events.on("ldown",this._onLDown),t.events.on("lup",this._onLUp),t.events.on("draw",this.onDraw,this,-1e3),t.events.on("mousemove",this._onMouseMove),t.events.on("mouseleave",this._onMouseLeave),t.events.on("mouseenter",this._onMouseEnter)}ondeactivate(){super.ondeactivate();let t=this.renderer;t.events.off("mousewheel",this._onMouseWheel),t.events.off("rhold",this._onRHold),t.events.off("rdown",this._onRDown),t.events.off("lhold",this._onLHold),t.events.off("ldown",this._onLDown),t.events.off("lup",this._onLUp),t.events.off("draw",this.onDraw),t.events.off("mousemove",this._onMouseMove),t.events.off("mouseleave",this._onMouseLeave),t.events.off("mouseenter",this._onMouseEnter)}onDraw(){this._updateVel(),this._handleZoom(),this._handleDrag(),this._handleRotation()}_handleRotation(){if((!this.disableRotation||!this.disableTilt)&&this.planet&&this._targetRotationPoint){let t=this.planet.camera;if((this.disableRotation||this.vel_h===0)&&(this.disableTilt||this.vel_v===0))return;if(!this.disableRotation){let n=this.vel_h*this.dt;t.rotateHorizontal(n,!1,this._targetRotationPoint,this._tUp)}if(!this.disableTilt){let n=this.vel_v*this.dt;t.rotateVertical(n,this._targetRotationPoint,.1)}this.events.dispatch(this.events.rotate,this),this._curPitch=t.getPitch(),this._curYaw=t.getYaw(),this._curRoll=t.getRoll(),this._velInertia=zi}}_getTargetPoint(t){return this.planet?this.planet.camera.isOrthographic?this.renderer.getCartesianFromPixel(t)||null:this.planet.camera.getAltitude()>8e4?this.planet.getCartesianFromPixelEllipsoid(t)||null:this.planet.getCartesianFromPixelTerrain(t)||null:null}get freeMode(){return this.mode!==1&&(this.mode===0||this._freeMode)}setMode(t){this.mode=this._modeToNumber(t)}_modeToNumber(t){switch(t){case"lockNorth":return 1;case"free":return 0;default:return 2}}_handleDrag(){if(this.planet&&this._targetDragPoint&&this._grabbedPoint&&this.vel.length()>.1){this._velInertia=zi;let t=this.planet.camera;if(t.slope>this.minSlope){let n=this.vel.scaleTo(this.dt),s=v.proj_b_to_plane(n,t.eyeNorm),o=t.eye.add(s).normalize().scale(this._grabbedCameraHeight);if(this.freeMode){let a=F.getRotationBetweenVectors(t.eye.getNormal(),o.getNormal());t.rotate(a),t.eye.copy(o)}else{let a=o.getNormal().dot(v.NORTH),h=t.eyeNorm.dot(v.NORTH);(a>h&&a>=this.poleThreshold||a<h&&a<=-this.poleThreshold)&&this.vel.scale(.8),t.eye.copy(o),this._corrRoll(),t.setPitchYawRoll(this._curPitch,this._curYaw,this._curRoll)}}else{let n=this.vel.scaleTo(this.dt),s=t.eye.add(n);t.eye.copy(s),t.checkTerrainCollision(),this._corrRoll(),t.setPitchYawRoll(this._curPitch,this._curYaw,this._curRoll)}this.events.dispatch(this.events.drag,this)}}_corrRoll(){this.planet.camera.slope<.5&&(this._curRoll-=this.vel_roll*this.dt,this._curRoll<.01*Math.PI/180&&(this._curRoll=.01*Math.PI/180))}_handleZoom(){if(this._targetZoomPoint&&this.vel.length()>.1){let t=this.planet.camera,n=this._targetZoomPoint,s=t.eye.clone(),o=n.sub(t.eye).normalize(),a=this.vel.getNormal(),h=Math.sign(a.dot(t.getForward())),c=this.vel.scaleTo(this.dt);this._grabbedSphere.radius>s.length()&&(h*=-1);let u=t.getForward().scaleTo(h*c.length());s.addA(u),this.events.dispatch(this.events.zoom,this);let d=t.maxAltitude+this.planet.ellipsoid.getEquatorialSize();if(s.length()>d)return void s.copy(s.getNormal().scale(d));let f=new V(s,o).hitSphere(this._grabbedSphere);if(!f)return void this.vel.set(0,0,0);let g=F.getRotationBetweenVectors(f.getNormal(),n.getNormal());if(t.eye=g.mulVec3(s),t.rotate(g),!this.freeMode){this._corrRoll(),t.setPitchYawRoll(this._curPitch,this._curYaw,this._curRoll),t.update();let _=t.unproject2v(this._currScreenPos,t.eye.distance(this._targetZoomPoint)),m=n.sub(t.eye).normalize(),p=new v,x=new v,y=vt.fromPoints(n,n.add(t.getUp()),n.add(t.getRight()));new V(t.eye,_).hitPlaneRes(y,p),new V(t.eye,m).hitPlaneRes(y,x);let T=x.sub(p);t.eye=t.eye.add(T),this._corrRoll(),t.setPitchYawRoll(this._curPitch,this._curYaw,this._curRoll)}if(t.checkTerrainCollision(),t.isOrthographic){let _=t.getAltitude();_&&(t.focusDistance=Math.abs(_))}}}_updateVel(){let t=this.force.scale(1/this.mass);this.vel.addA(t),this.vel.scale(this.velocityInertia),this.vel.length()<.001&&this.vel.set(0,0,0),this.force.set(0,0,0),this._updateVel_h(),this._updateVel_v(),this._updateVel_roll()}_updateVel_h(){let t=this.force_h/this.mass;this.vel_h+=t,this.vel_h*=this.velocityInertia,Math.abs(this.vel_h)<.001&&(this.vel_h=0),this.force_h=0}_updateVel_v(){let t=this.force_v/this.mass;this.vel_v+=t,this.vel_v*=this.velocityInertia,Math.abs(this.vel_v)<.001&&(this.vel_v=0),this.force_v=0}_updateVel_roll(){let t=this.force_roll/this.mass;this.vel_roll+=t,this.vel_roll*=this.velocityInertia,this.force_roll=0}get dt(){return .001*this.renderer.handler.deltaTime}get velocityInertia(){return this._velInertia*this.inertia}stop(){this.vel.set(0,0,0),this.vel_h=0,this.vel_v=0,this._velInertia=zi,this._targetZoomPoint=null,this._grabbedPoint=null,this._targetRotationPoint=null,this._targetDragPoint=null}}const Dn=l=>l>1e3?`${(l/1e3).toFixed(1)} km`:l>9?`${Math.round(l)} m`:`${l.toFixed(1)} m`;let Sl=$.createCylinder(1.1,0,2.7,20,1,!0,!1,0,0,0);const Rl={text:"",size:11,color:"rgba(455,455,455,1.0)",outlineColor:"rgba(0,0,0,0.34)",outline:.23,align:"center",offset:[0,20,0]},Fn={scale:1,instanced:!0,tag:"ruler",color:"rgb(0,305,0)",object3d:Sl};class ua extends de{constructor(t={}){super(t.name),this._onCornerLdown=n=>{var s,o;if(!this._startLonLat){(o=(s=this.renderer)==null?void 0:s.controls.navigation)==null||o.deactivate(),this._startClick.set(n.x,n.y);let a=n.pickingObject.getCartesian();this._startPos=this._planet.getPixelFromCartesian(a),this._pickedCorner=n.pickingObject,n.pickingObject.properties.name=="start"?this._anchorLonLat=this._cornerEntity[1].getLonLat().clone():this._anchorLonLat=this._cornerEntity[0].getLonLat().clone()}},this._onLUp=()=>{var n;this._pickedCorner&&((n=this.renderer.controls.navigation)==null||n.activate(),this._pickedCorner=null,this._anchorLonLat=null)},this._onCornerLup=()=>{this._onLUp()},this._onCornerEnter=n=>{n.renderer.handler.canvas.style.cursor="pointer"},this._onCornerLeave=n=>{n.renderer.handler.canvas.style.cursor="default"},this._onLdblclick=()=>{this._preventClick=!0},this._onLclick=n=>{let s=this._planet.getLonLatFromPixelTerrain(n.pos);s&&(this._timeout=setTimeout(()=>{this._preventClick||(this._startLonLat?this._startLonLat=null:(this.setVisibility(!0),this._stopDrawing=!1,this._startLonLat=s)),this._preventClick=!1,this._stopDrawing=!1,clearTimeout(this._timeout)},200),this._startLonLat&&(this._stopDrawing=!0))},this._onMouseMove=n=>{if(this._startLonLat&&!this._stopDrawing){this._propsLabel.label.setVisibility(!0);let s=this._planet.getLonLatFromPixelTerrain(n.pos);if(!s)return;this._drawLine(this._startLonLat,s)}else if(this._pickedCorner){let s=this._planet.getLonLatFromPixelTerrain(n.pos);s&&(this._pickedCorner.properties.name==="start"?this._drawLine(s,this._anchorLonLat):this._drawLine(this._anchorLonLat,s))}},this.events=lt(Ml),this._ignoreTerrain=t.ignoreTerrain==null||t.ignoreTerrain,this._planet=t.planet||null,this._startLonLat=null,this._preventClick=!1,this._stopDrawing=!1,this._pickedCorner=null,this._startPos=null,this._startClick=new H,this._anchorLonLat=null,this._heading=0,this._trackLayer=new _t("track",{entities:[],pickingEnabled:!1,polygonOffsetUnits:-1,relativeToGround:!0,hideInLayerSwitcher:!0}),this._labelLayer=new _t("ruler-label",{entities:[],pickingEnabled:!1,polygonOffsetUnits:-100,relativeToGround:!0,hideInLayerSwitcher:!0}),this._cornersLayer=new _t("corners",{entities:[],pickingEnabled:!0,hideInLayerSwitcher:!0,scaleByDistance:[100,4e6,1],pickingScale:2}),this._propsLabel=new G({name:"propsLabel",label:Rl}),this._trackEntity=new G({polyline:{path3v:[],thickness:4.8,color:"rgb(255,131,0)",isClosed:!1}}),this._trackEntity.polyline.altitude=.01,this._cornerEntity=[new G({geoObject:Fn,properties:{name:"start"}}),new G({geoObject:Fn,properties:{name:"end"}})]}set ignoreTerrain(t){this._ignoreTerrain=t}bindPlanet(t){this._planet=t}_createCorners(){this._cornersLayer.addEntities(this._cornerEntity)}init(){this._createCorners(),this._trackLayer.addEntities([this._trackEntity]),this._labelLayer.addEntities([this._propsLabel]),this._planet.addLayer(this._labelLayer),this._planet.addLayer(this._trackLayer),this._planet.addLayer(this._cornersLayer),this._activate()}onremove(){this._deactivate()}_activate(){this._propsLabel.label.setVisibility(!1),this.setVisibility(!1),this.renderer.events.on("lclick",this._onLclick,this),this.renderer.events.on("mousemove",this._onMouseMove,this),this.renderer.events.on("ldblclick",this._onLdblclick,this),this.renderer.events.on("lup",this._onLUp,this),this._cornersLayer.events.on("mouseenter",this._onCornerEnter,this),this._cornersLayer.events.on("mouseleave",this._onCornerLeave,this),this._cornersLayer.events.on("ldown",this._onCornerLdown,this),this._cornersLayer.events.on("lup",this._onCornerLup,this)}_deactivate(){this._startLonLat=null,this._preventClick=!1,this._stopDrawing=!1,this._pickedCorner=null,this.renderer.events.off("lclick",this._onLclick),this.renderer.events.off("mousemove",this._onMouseMove),this.renderer.events.off("lup",this._onLUp),this._cornersLayer.events.off("mouseenter",this._onCornerEnter),this._cornersLayer.events.off("mouseleave",this._onCornerLeave),this._cornersLayer.events.off("ldown",this._onCornerLdown),this._cornersLayer.events.off("lup",this._onCornerLup),this.clear()}setVisibility(t){this._cornersLayer.setVisibility(t),this._trackLayer.setVisibility(t),this._labelLayer.setVisibility(t)}_drawLine(t,n,s){s||(s=this._planet.ellipsoid.lonLatToCartesian(t));let o=this._planet.ellipsoid.lonLatToCartesian(n),a=this._planet.ellipsoid.inverse(t,n),h=a.distance;this._heading=a.initialAzimuth;let c=[],u=o.sub(s),d=u.length();u.normalize();for(let f=0;f<120;f++){let g=u.scaleTo(f*d/120).addA(s);c.push(g)}c.push(o),this._trackEntity.polyline.setPath3v([c]),this._ignoreTerrain&&(this._propsLabel.setCartesian3v(c[Math.floor(c.length/2)]),this._propsLabel.label.setText(`${Dn(h)}, ${Math.round(this._heading)} deg`))}clear(){this._trackEntity.remove(),this._cornerEntity[0].remove(),this._cornerEntity[1].remove(),this._propsLabel.remove(),this._planet.removeLayer(this._trackLayer),this._planet.removeLayer(this._cornersLayer)}isCornersPositionChanged(){let t=this._trackEntity.polyline.getPath3v()[0];if(t){const n=t[0].clone(),s=t[t.length-1].clone();return this._cornerEntity[0].getCartesian().equal(n)&&this._cornerEntity[1].getCartesian().equal(s)}return!1}frame(){let t=this._trackEntity.polyline.getPath3v()[0];if(t){const n=t[0].clone(),s=t[t.length-1].clone();if(!this.isCornersPositionChanged()&&(this._cornerEntity[0].setCartesian3v(n),this._cornerEntity[1].setCartesian3v(s),!this._ignoreTerrain)){let o=0;for(let a=0,h=t.length-1;a<h;a++)o+=t[a+1].distance(t[a]);this._propsLabel.setCartesian3v(t[Math.floor(t.length/2)]),this._propsLabel.label.setText(`${Dn(o)}, ${Math.round(this._heading)} deg`)}}}get ellipsoid(){return this._planet?this._planet.ellipsoid:null}}const Ml=["add","remove","mousemove","mouseenter","mouseleave","lclick","rclick","mclick","ldblclick","rdblclick","mdblclick","lup","rup","mup","ldown","rdown","mdown","lhold","rhold","mhold","mousewheel","touchmove","touchstart","touchend","doubletouch","touchleave","touchenter"];class _a extends Q{constructor(t={}){super(t),this._rulerScene=new ua({name:`rulerScene:${this.__id}`,ignoreTerrain:t.ignoreTerrain})}set ignoreTerrain(t){this._rulerScene.ignoreTerrain=t}oninit(){this._rulerScene.bindPlanet(this.planet)}onactivate(){this.renderer&&this.renderer.addNode(this._rulerScene)}ondeactivate(){this.renderer&&this.renderer.removeNode(this._rulerScene)}}let Bl=$.createCylinder(1.1,0,2,6,1,!0,!0,0,0,0);const On={startColor:"rgb(255,131,0)",endColor:"rgb(255,131,0)",thickness:5},Ys={text:"",size:11,color:"rgba(455,455,455,1.0)",outlineColor:"rgba(0,0,0,0.34)",outline:.23,align:"center",offset:[0,18,0]},Nn={scale:1,instanced:!0,tag:"height-ruler",color:"rgb(255,131,0)",object3d:Bl};class kl extends ua{constructor(t={}){super(t),this._geoRulerLayer=new _t("rayHeightRuler",{entities:[],pickingEnabled:!1,polygonOffsetUnits:-2,relativeToGround:!1,hideInLayerSwitcher:!0}),this._rayV=new G({name:"verticalRay",ray:On}),this._rayH=new G({name:"heightRay",ray:On}),this._heightLabels=[new G({name:"startCornerLabel",label:{...Ys}}),new G({name:"endCornerLabel",label:{...Ys}}),new G({name:"deltaLabel",label:{...Ys}})]}setVisibility(t){super.setVisibility(t),this._geoRulerLayer.setVisibility(t)}get deltaLabel(){return this._heightLabels[2]}get startLabel(){return this._heightLabels[0]}get endLabel(){return this._heightLabels[1]}get corners(){return this._cornerEntity}get startCorner(){return this.corners[0]}get endCorner(){return this.corners[1]}get startCornerLonLat(){return this.startCorner.getLonLat()}get startCornerHeight(){return this.startCornerLonLat.height}get endCornerLonLat(){return this.endCorner.getLonLat()}get endCornerHeight(){return this.endCornerLonLat.height}get maxHeightCornerLonLat(){return this.startCornerHeight<=this.endCornerHeight?this.endCornerLonLat:this.startCornerLonLat}get minHeightCornerLonLat(){return this.startCornerHeight>this.endCornerHeight?this.endCornerLonLat:this.startCornerLonLat}get deltaHeight(){return Math.abs(this.startCornerHeight-this.endCornerHeight)}_drawLine(t,n,s){super._drawLine(t,n,s),this._updateHeightRaysAndLabels()}async _updateHeightRaysAndLabels(){const t=this.minHeightCornerLonLat.clone();t.height=this.maxHeightCornerLonLat.height,this._rayH.ray.setStartPosition3v(this._planet.ellipsoid.lonLatToCartesian(this.maxHeightCornerLonLat)),this._rayH.ray.setEndPosition3v(this._planet.ellipsoid.lonLatToCartesian(t)),this._rayV.ray.setStartPosition3v(this._planet.ellipsoid.lonLatToCartesian(this.minHeightCornerLonLat)),this._rayV.ray.setEndPosition3v(this._planet.ellipsoid.lonLatToCartesian(t)),t.height=this.minHeightCornerLonLat.height+this.deltaHeight/2,this.deltaLabel.setLonLat(t),this.startLabel.setLonLat(this.startCornerLonLat),this.endLabel.setLonLat(this.endCornerLonLat);const n=await this._planet.getHeightDefault(this.startCornerLonLat),s=await this._planet.getHeightDefault(this.endCornerLonLat);this.deltaLabel.label.setText(`Δ ${Math.abs(n-s).toFixed(1)} m`),this.startLabel.label.setText(`P1 ${n.toFixed(1)} m`),this.endLabel.label.setText(`P2 ${s.toFixed(1)} m`)}clear(){this._rayH.remove(),this._rayV.remove(),this.startCorner.remove(),this.endCorner.remove(),this.startLabel.remove(),this.endLabel.remove(),this.deltaLabel.remove(),super.clear(),this._planet.removeLayer(this._geoRulerLayer)}_createCorners(){this._cornerEntity=[new G({geoObject:Nn,properties:{name:"start"}}),new G({geoObject:Nn,properties:{name:"end"}})],this._cornersLayer.setEntities(this._cornerEntity)}init(){super.init(),this._createCorners(),this._labelLayer.addEntities(this._heightLabels),this._geoRulerLayer.addEntities([this._rayH,this._rayV]),this._planet.addLayer(this._geoRulerLayer)}frame(){super.frame(),this._updateHeightRaysAndLabels()}}class Hn extends _a{constructor(t={}){super(t),this._rulerScene=new kl({name:`heightRulerScene:${this.__id}`,ignoreTerrain:!1})}}const Ws=[.001,.005,.01,.05,.1,.2,.5,1,2,3,5,10,20,30,50,100,200,300,500,1e3,2e3,3e3,5e3,1e4,2e4,3e4,5e4,1e5,2e5,3e5,5e5,1e6,2e6,3e6,5e6,1e7];class fa extends Q{constructor(t={}){t.name&&t.name!==""||(t.name="scaleControl"),super(t),this._template=`<div class="og-scale-container">
      <div class="og-scale-label"></div>
      <div class="og-scale-ruler"></div>
    </div>`,this._minWidth=100,this._maxWidth=150,this._isCenter=t.isCenter==null||t.isCenter,this._mPx=0,this.currWidth=0,this._metersInMinSize=0,this.el=null,this._scaleLabelEl=null}_renderTemplate(){return Wr(this._template)[0]}oninit(){this.el=this._renderTemplate(),this._scaleLabelEl=this.el.querySelector(".og-scale-label"),this.renderer.div.appendChild(this.el),this._isCenter?(this.planet.camera.events.on("moveend",()=>{this._drawScreen(this.planet.renderer.handler.getCenter())}),!this.planet.terrain.isEmpty&&this.planet.terrain.events.on("loadend",()=>{this._drawScreen(this.planet.renderer.handler.getCenter())})):(this.renderer.events.on("mousemove",t=>{t.leftButtonHold||t.rightButtonHold||this._drawScreen(t.pos)}),this.planet.camera.events.on("moveend",()=>{let t=this.renderer.events.mouseState;t.leftButtonHold||t.rightButtonHold||this._drawScreen(t.pos)}))}_drawScreen(t){let n=this.planet.camera,s=t,o=this.planet.getDistanceFromPixel(s)||0;o===0&&(s=n.project3v(v.ZERO),o=this.planet.getDistanceFromPixel(s)||0);let a=n.getForward().scaleTo(o).addA(n.eye),h=o*Math.tan(n.viewAngle*j),c=a.add(n.getRight().scaleTo(h)),u=n.project3v(c);this._mPx=h/u.distance(s);let d=this._mPx*this._minWidth,f=Re(Ws,d,(m,p)=>m-p);f<0&&(f=~f);let g=Ws[f],_=(g-d)/(Ws[f+1]-g);this.currWidth=this._minWidth+_*(this._maxWidth-this._minWidth),this._scaleLabelEl.innerText=g>=1e3?g/1e3+" km":g>=1?`${g} m`:g>=.01?100*g+" cm":1e3*g+" mm",this._metersInMinSize=d,this.el.style.width=this.currWidth+"px"}}class ga extends Q{constructor(t={}){super({name:"SimpleSkyBackground",...t}),this._colorOne=new Float32Array([128/255,223/255,1]),this._colorTwo=new Float32Array([10/255,15/255,56/255])}get colorOne(){let t=this._colorOne;return cr([Math.round(255*t[0]),Math.round(255*t[1]),Math.round(255*t[2])])}get colorTwo(){let t=this._colorTwo;return cr([Math.round(255*t[0]),Math.round(255*t[1]),Math.round(255*t[2])])}set colorOne(t){let n=ts(t);this._colorOne[0]=n.x,this._colorOne[1]=n.y,this._colorOne[2]=n.z}set colorTwo(t){let n=ts(t);this._colorTwo[0]=n.x,this._colorTwo[1]=n.y,this._colorTwo[2]=n.z}oninit(){this.renderer.handler.addProgram(new X("simpleSkyBackground",{uniforms:{iResolution:"vec2",fov:"float",camPos:"vec3",earthRadius:"float",viewMatrix:"mat4",colorOne:"vec3",colorTwo:"vec3"},attributes:{corners:"vec3"},vertexShader:`attribute vec2 corners;
                        
            varying vec2 tc;
            
            void main(void) {
                gl_Position = vec4(corners, 0.0, 1.0);
                tc = corners * 0.5 + 0.5;
            }`,fragmentShader:`precision highp float;
            
            #define MAX 10e10
            #define PI 3.14159265359
            #define rad(x) x * PI / 180.
            #define ZERO vec3(0.0)          
           
            #define RED vec4(1.0, 0.0, 0.0, 1.0)
            #define GREEN vec4(0.0, 1.0, 0.0, 1.0)         
            
            uniform vec3 camPos;            
            uniform vec2 iResolution;
            uniform float fov;
            uniform float earthRadius;
            uniform mat4 viewMatrix;
            
            uniform vec3 colorOne;
            uniform vec3 colorTwo;
                         
            varying vec2 tc;
                        
            // compute the view ray in the camera coordinate
            vec3 computeView(vec2 uv){
                float w_h_ratio = iResolution.x / iResolution.y;   
                float h = tan(rad(fov/2.));
                return normalize(vec3(-w_h_ratio * h, -h, -1.) + vec3(uv.x * 2. * h * w_h_ratio, uv.y*2.*h, 0.));
            }

            // sphere of size ra centered at point ce
            vec2 sphIntersect( in vec3 ro, in vec3 rd, in vec3 ce, float ra )
            {
                vec3 oc = ro - ce;
                float b = dot( oc, rd );
                float c = dot( oc, oc ) - ra * ra;
                float h = b * b - c;
                if( h < 0.0 ) return vec2(MAX); // no intersection
                h = sqrt( h );
                return vec2( -b-h, -b+h );
            }
            
            mat3 transpose(mat3 matrix) {
                vec3 row0 = matrix[0];
                vec3 row1 = matrix[1];
                vec3 row2 = matrix[2];
                mat3 result = mat3(
                    vec3(row0.x, row1.x, row2.x),
                    vec3(row0.y, row1.y, row2.y),
                    vec3(row0.z, row1.z, row2.z)
                );
                return result;
            }
            
            float det(mat2 matrix) {
                return matrix[0].x * matrix[1].y - matrix[0].y * matrix[1].x;
            }
            
            mat3 inverse(mat3 matrix) {
                vec3 row0 = matrix[0];
                vec3 row1 = matrix[1];
                vec3 row2 = matrix[2];
            
                vec3 minors0 = vec3(
                    det(mat2(row1.y, row1.z, row2.y, row2.z)),
                    det(mat2(row1.z, row1.x, row2.z, row2.x)),
                    det(mat2(row1.x, row1.y, row2.x, row2.y))
                );
                vec3 minors1 = vec3(
                    det(mat2(row2.y, row2.z, row0.y, row0.z)),
                    det(mat2(row2.z, row2.x, row0.z, row0.x)),
                    det(mat2(row2.x, row2.y, row0.x, row0.y))
                );
                vec3 minors2 = vec3(
                    det(mat2(row0.y, row0.z, row1.y, row1.z)),
                    det(mat2(row0.z, row0.x, row1.z, row1.x)),
                    det(mat2(row0.x, row0.y, row1.x, row1.y))
                );
            
                mat3 adj = transpose(mat3(minors0, minors1, minors2));
            
                return (1.0 / dot(row0, minors0)) * adj;
            }
            
            void main(void) {
            
                vec3 dir = computeView(tc);
                dir = inverse(mat3(viewMatrix)) * dir;
                
                vec2 ER = sphIntersect(camPos, dir, vec3(0.0), earthRadius);
                
                float bigRadius = earthRadius * 2.5;
                vec3 bigCenter = normalize(camPos) * bigRadius * 1.3;                
                               
                vec2 BIG = sphIntersect(camPos, dir, bigCenter, bigRadius);
                
                float Ix = distance(camPos + dir * BIG.y, ZERO);               
                
                float maxI = sqrt(bigRadius * bigRadius + bigRadius * bigRadius);
                                   
                gl_FragColor = vec4(mix(colorOne, colorTwo, Ix / maxI), 1.0);
            }`})),this.activate()}onactivate(){super.onactivate(),this.planet.events.on("draw",this._drawBackground,this)}ondeactivate(){super.ondeactivate(),this.planet.events.off("draw",this._drawBackground)}_drawBackground(){let t=this.renderer.handler,n=t.programs.simpleSkyBackground,s=n._program,o=s.uniforms,a=t.gl,h=this.planet.camera;a.disable(a.DEPTH_TEST),n.activate(),a.bindBuffer(a.ARRAY_BUFFER,this.renderer.screenFramePositionBuffer),a.vertexAttribPointer(s.attributes.corners,2,a.FLOAT,!1,0,0),a.uniform3fv(o.camPos,[h.eye.x,h.eye.y,h.eye.z]),a.uniform2fv(o.iResolution,[t.getWidth(),t.getHeight()]),a.uniform1f(o.fov,h.getViewAngle()),a.uniform1f(o.earthRadius,this.planet.ellipsoid.getPolarSize()+1),a.uniform3fv(o.colorOne,this._colorOne),a.uniform3fv(o.colorTwo,this._colorTwo),a.uniformMatrix4fv(o.viewMatrix,!1,h.getViewMatrix()),a.drawArrays(a.TRIANGLE_STRIP,0,4),a.enable(a.DEPTH_TEST)}}const $s=14959787e4;function Xs(l){var t=l-es,n=282.9404+470935e-10*t,s=.016709-1151e-12*t,o=hr(356.047+.9856002585*t),a=23.4392911-3563e-10*t,h=o+J*s*Math.sin(o*j)*(1+s*Math.cos(o*j)),c=Math.cos(h*j)-s,u=Math.sin(h*j)*Math.sqrt(1-s*s),d=Math.sqrt(c*c+u*u),f=hr(Math.atan2(u,c)*J+n),g=c=d*Math.cos(f*j),_=(u=d*Math.sin(f*j))*Math.cos(a*j),m=u*Math.sin(a*j),p=Xi*(24*t/23.9344694-259.853/360);return F.zRotation(-p).mulVec3(new v(-g*$s,-_*$s,m*$s))}class Il{constructor(t){this._renderNode=null,this._position=t.position||new v,this._ambient=t.ambient||new v,this._diffuse=t.diffuse||new v(.8,.8,.8),this._specular=t.specular||new v(.18,.18,.18),this._shininess=t.shininess!=null?t.shininess:3.3,this._active=!0,this._tempAmbient=this._ambient.clone(),this._tempDiffuse=this._diffuse.clone(),this._tempSpecular=this._specular.clone(),this._tempShininess=this._shininess}isActive(){return this._active}setPosition3v(t){this.setPosition(t.x,t.y,t.z)}setPosition(t,n,s){this._position.x=t,this._position.y=n,this._position.z=s,this._renderNode&&(this._renderNode._lightPosition[0]=t,this._renderNode._lightPosition[1]=n,this._renderNode._lightPosition[2]=s)}getPosition(){return this._position.clone()}setAmbient3v(t){this.setAmbient(t.x,t.y,t.z)}setDiffuse3v(t){this.setDiffuse(t.x,t.y,t.z)}setSpecular3v(t){this.setSpecular(t.x,t.y,t.z)}setAmbient(t,n,s){this._ambient.set(t,n,s);const o=this._renderNode;o&&(o._lightParams[0]=t,o._lightParams[1]=n,o._lightParams[2]=s)}setDiffuse(t,n,s){this._diffuse.set(t,n,s);const o=this._renderNode;o&&(o._lightParams[3]=t,o._lightParams[4]=n,o._lightParams[5]=s)}setSpecular(t,n,s){this._specular.set(t,n,s);const o=this._renderNode;o&&(o._lightParams[6]=t,o._lightParams[7]=n,o._lightParams[8]=s)}setShininess(t){this._shininess=t;const n=this._renderNode;n&&(n._lightShininess=t)}addTo(t){this._renderNode=t,this.setShininess(this._shininess),this.setAmbient3v(this._ambient),this.setDiffuse3v(this._diffuse),this.setSpecular3v(this._specular)}}class Dr extends Q{constructor(t={}){super({autoActivate:!0,...t}),this._name="sun",this.activationHeight=t.activationHeight||12079e3,this.offsetVertical=t.offsetVertical||-5e6,this.offsetHorizontal=t.offsetHorizontal||5e6,this.sunlight=new Il({ambient:new v(.15,.15,.25),diffuse:new v(.9,.9,.8),specular:new v(.1,.1,.06),shininess:110}),this._currDate=0,this._prevDate=0,this._clockPtr=null,this._lightOn=!1,this._f=0,this._k=0,this._stopped=t.stopped||!1}oninit(){this.planet.lightEnabled=!0,this.sunlight.addTo(this.planet),this.renderer.events.on("draw",this._draw,this),this._clockPtr||(this._clockPtr=this.renderer.handler.defaultClock)}stop(){this._stopped=!0,this.deactivate()}start(){this._stopped=!1,this.activate()}onactivate(){super.onactivate(),this._stopped=!1}bindClock(t){this._clockPtr=t}_draw(){if(this._clockPtr)if(this._currDate=this._clockPtr.currentDate,this._stopped)this.sunlight.setPosition3v(Xs(this._currDate));else{let t=this.planet.camera;if(t.getHeight()<this.activationHeight||!this._active){this._lightOn=!0,this._f=1;let n=t.eye.normal(),s=t.getForward();s.scale(Math.sign(t.getUp().dot(n))),t.slope>.99&&(s=t.getUp());let o=v.proj_b_to_plane(s,n,s).normalize().scale(this.offsetVertical),a=v.proj_b_to_plane(t.getRight(),n,t.getRight()).normalize().scale(this.offsetHorizontal),h=o.add(a),c=t.eye.add(h);if(this._k>0){this._k-=.001;let u=F.getRotationBetweenVectors(this.sunlight._position.normal(),c.normal()).slerp(F.IDENTITY,this._k).normalize();this.sunlight.setPosition3v(u.mulVec3(this.sunlight._position))}else this.sunlight.setPosition3v(c)}else if(this._k=1,this._f>0){this._f-=.001;let n=F.getRotationBetweenVectors(this.sunlight._position.normal(),Xs(this._currDate).normal()).slerp(F.IDENTITY,this._f).normalize();this.sunlight.setPosition3v(n.mulVec3(this.sunlight._position))}else(Math.abs(this._currDate-this._prevDate)>34e-5&&this._active||this._lightOn)&&(this._lightOn=!1,this._prevDate=this._currDate,this.sunlight.setPosition3v(Xs(this._currDate)),this._f=0)}}}const zl=["inertiamove","drag","doubletapzoom"];class Vn{constructor(){this.x=0,this.y=0,this.prev_x=0,this.prev_y=0,this.grabbedPoint=null,this.grabbedSpheroid=new Ft,this._vec=new H,this._vecPrev=new H}get dY(){return this.y-this.prev_y}get dX(){return this.x-this.prev_x}get vec(){return this._vec.set(this.x,this.y)}get vecPrev(){return this._vecPrev.set(this.prev_x,this.prev_y)}}class pa extends Q{constructor(t={}){super(t),this._onCameraFly=()=>{this.stopRotation()},this._name="touchNavigation",this.events=lt(zl,this),this.grabbedPoint=new v,this.inertia=t.inertia!=null?t.inertia:.007,this.minSlope=t.minSlope!=null?t.minSlope:.1,this.jerkLimit=t.jerkLimit!=null?t.jerkLimit:.3,this.grabbedSpheroid=new Ft,this.planet=null,this.qRot=new F,this.scaleRot=0,this.rot=1,this._eye0=new v,this.pointOnEarth=null,this.earthUp=null,this.touches=[new Vn,new Vn],this._keyLock=new Me,this._touching=!1}oninit(){this.renderer&&(this.renderer.events.on("touchstart",this.onTouchStart,this),this.renderer.events.on("touchend",this.onTouchEnd,this),this.renderer.events.on("doubletouch",this.onDoubleTouch,this),this.renderer.events.on("touchcancel",this.onTouchCancel,this),this.renderer.events.on("touchmove",this.onTouchMove,this),this.renderer.events.on("draw",this.onDraw,this))}onadd(){var t;(t=this.planet)!=null&&t.camera&&this.planet.camera.events.on("flystart",this._onCameraFly)}onremove(){var t;(t=this.planet)!=null&&t.camera&&this.planet.camera.events.off("flystart",this._onCameraFly)}onTouchStart(t){const n=this.renderer.handler;if(this._touching=!0,t.sys.touches.length===2){const s=this.touches[0],o=this.touches[1];s.x=(t.sys.touches.item(0).clientX-t.sys.offsetLeft)*n.pixelRatio,s.y=(t.sys.touches.item(0).clientY-t.sys.offsetTop)*n.pixelRatio,s.prev_x=s.x,s.prev_y=s.y,s.grabbedPoint=this.planet.getCartesianFromPixelTerrain(new H(s.x,s.y))||null,o.x=(t.sys.touches.item(1).clientX-t.sys.offsetLeft)*n.pixelRatio,o.y=(t.sys.touches.item(1).clientY-t.sys.offsetTop)*n.pixelRatio,o.prev_x=o.x,o.prev_y=o.y,o.grabbedPoint=this.planet.getCartesianFromPixelTerrain(new H(o.x,o.y))||null,this.pointOnEarth=this.planet.getCartesianFromPixelTerrain(this.renderer.handler.getCenter())||null,this.pointOnEarth&&(this.earthUp=this.pointOnEarth.normal()),s.grabbedPoint&&o.grabbedPoint&&(s.grabbedSpheroid.radius=s.grabbedPoint.length(),o.grabbedSpheroid.radius=o.grabbedPoint.length(),this.stopRotation())}else t.sys.touches.length===1&&this._startTouchOne(t)}_startTouchOne(t){const n=this.touches[0],s=this.renderer.handler;n.x=(t.sys.touches.item(0).clientX-t.sys.offsetLeft)*s.pixelRatio,n.y=(t.sys.touches.item(0).clientY-t.sys.offsetTop)*s.pixelRatio,n.prev_x=n.x,n.prev_y=n.y,n.grabbedPoint=this.planet.getCartesianFromPixelTerrain(t)||null,this._eye0.copy(this.planet.camera.eye),n.grabbedPoint&&(n.grabbedSpheroid.radius=n.grabbedPoint.length(),this.stopRotation())}stopRotation(){this.qRot.clear(),this.planet.layerLock.free(this._keyLock),this.planet.terrainLock.free(this._keyLock),this.planet._normalMapCreator.free(this._keyLock)}onDoubleTouch(t){this.planet.stopFlying(),this.stopRotation();const n=this.planet.getCartesianFromPixelTerrain(t);if(n){const s=this.planet.ellipsoid.cartesianToLonLat(n);this.planet.flyLonLat(new L(s.lon,s.lat,.57*this.planet.camera.eye.distance(n))),this.events.dispatch(this.events.doubletapzoom,this)}}onTouchEnd(t){t.sys.touches.length===0&&(this._touching=!1),t.sys.touches.length===1&&this._startTouchOne(t),Math.abs(this.touches[0].x-this.touches[0].prev_x)<3&&Math.abs(this.touches[0].y-this.touches[0].prev_y)<3&&(this.scaleRot=0)}onTouchCancel(t){}onTouchMove(t){let n=this.planet.camera;const s=this.renderer.handler;if(t.sys.touches.length===2){this.renderer.controlsBag.scaleRot=1;let a=this.touches[0],h=this.touches[1];if(!a.grabbedPoint||!h.grabbedPoint)return;this.planet.stopFlying(),a.prev_x=a.x,a.prev_y=a.y,a.x=(t.sys.touches.item(0).clientX-t.sys.offsetLeft)*s.pixelRatio,a.y=(t.sys.touches.item(0).clientY-t.sys.offsetTop)*s.pixelRatio,h.prev_x=h.x,h.prev_y=h.y,h.x=(t.sys.touches.item(1).clientX-t.sys.offsetLeft)*s.pixelRatio,h.y=(t.sys.touches.item(1).clientY-t.sys.offsetTop)*s.pixelRatio;const c=a.vec.add(h.vec).scale(.5),u=this.planet.getCartesianFromPixelEllipsoid(c);if(u){this.pointOnEarth=u;const d=Math.atan2(a.prev_y-h.prev_y,a.prev_x-h.prev_x),f=Math.atan2(a.y-h.y,a.x-h.x)-d,g=n.eye.distance(this.pointOnEarth),_=a.vec.sub(h.vec),m=a.vecPrev.sub(h.vecPrev);let p=_.length()/m.length();const x=1+this.jerkLimit,y=1-this.jerkLimit;p=p>x?x:p<y?y:p;let T=g*-(1-p);n.eye.addA(n.getForward().scale(T)),n.rotateAround(-f,!1,this.pointOnEarth,this.earthUp);const S=a.vec.add(h.vec).scale(.5),C=a.vecPrev.add(h.vecPrev).scale(.5),P=S.sub(C).scale(-1);var o=.5/g*n._lonLat.height*j;o>.003&&(o=.003),n.rotateHorizontal(o*-P.x,!1,this.pointOnEarth,this.earthUp),n.rotateVertical(o*-P.y,this.pointOnEarth,this.minSlope),n.checkTerrainCollision(),n.update(),this.events.dispatch(this.events.drag,this)}this.scaleRot=0}else if(t.sys.touches.length===1){let a=this.touches[0];if(a.prev_x=a.x,a.prev_y=a.y,a.x=(t.sys.touches.item(0).clientX-t.sys.offsetLeft)*s.pixelRatio,a.y=(t.sys.touches.item(0).clientY-t.sys.offsetTop)*s.pixelRatio,!a.grabbedPoint)return;this.planet.stopFlying();let h=t.direction,c=new V(n.eye,h).hitSphere(a.grabbedSpheroid);if(c)if(n.slope>.2){this.qRot=F.getRotationBetweenVectors(c.normal(),a.grabbedPoint.normal());let u=this.qRot;n.eye=u.mulVec3(n.eye),n.rotate(u),n.checkTerrainCollision(),n.update(),this.events.dispatch(this.events.drag,this),this.scaleRot=1}else{let u=a.grabbedPoint,d=v.add(u,n.getUp()),f=v.add(u,u.getNormal()),g=n.unproject(a.x,a.y),_=new v;new V(n.eye,g).hitPlaneRes(vt.fromPoints(u,d,f),_)===V.INSIDE&&(n.eye=this._eye0.addA(_.subA(u).negate()),n.checkTerrainCollision(),n.update(),this.events.dispatch(this.events.drag,this),this.scaleRot=0)}}}onDraw(){const t=this.renderer;if(t.controlsBag.scaleRot=this.scaleRot,this._touching)return;let n=this.planet.camera,s=n.eye.clone();if(!t.events.mouseState.leftButtonDown&&this.scaleRot){if(this.scaleRot-=this.inertia,this.scaleRot<=0)this.scaleRot=0;else{t.controlsBag.scaleRot=this.scaleRot;let o=this.qRot.slerp(F.IDENTITY,1-this.scaleRot*this.scaleRot*this.scaleRot).normalize();o.x||o.y||o.z||(this.scaleRot=0),n.eye=o.mulVec3(n.eye),n.rotate(o),n.checkTerrainCollision(),n.update(),this.events.dispatch(this.events.inertiamove,this)}this.setLock(n.eye.distance(s)/n.getAltitude()>.01)}}setLock(t){t?(this.planet.layerLock.lock(this._keyLock),this.planet.terrainLock.lock(this._keyLock),this.planet._normalMapCreator.lock(this._keyLock)):(this.planet.layerLock.free(this._keyLock),this.planet.terrainLock.free(this._keyLock),this.planet._normalMapCreator.free(this._keyLock))}}class ma extends Q{constructor(t={}){super(t),this._keyLock=new Me,this._move=0,this._targetPoint=null}oninit(){let t=new ce({classList:["og-map-button","og-zoomin-button"],icon:'<?xml version="1.0"?><svg width=24 height=24 xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">    <path d="M 11 5 L 11 11 L 5 11 L 5 13 L 11 13 L 11 19 L 13 19 L 13 13 L 19 13 L 19 11 L 13 11 L 13 5 L 11 5 z"/></svg>'});t.appendTo(this.renderer.div);let n=new ce({classList:["og-map-button","og-zoomout-button"],icon:'<?xml version="1.0"?><svg width=24 height=24 xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">    <path d="M 5 11 L 5 13 L 19 13 L 19 11 L 5 11 z"/></svg>'});n.appendTo(this.renderer.div),t.events.on("mousedown",()=>this.zoomIn()),t.events.on("mouseup",()=>this.stopZoom()),n.events.on("mousedown",()=>this.zoomOut()),n.events.on("mouseup",()=>this.stopZoom()),t.events.on("touchstart",()=>this.zoomIn()),t.events.on("touchend",()=>this.stopZoom()),t.events.on("touchcancel",()=>this.stopZoom()),n.events.on("touchstart",()=>this.zoomOut()),n.events.on("touchend",()=>this.stopZoom()),n.events.on("touchcancel",()=>this.stopZoom()),this.renderer.events.on("draw",this._draw,this)}zoomIn(){this.planet.layerLock.lock(this._keyLock),this.planet.terrainLock.lock(this._keyLock),this.planet._normalMapCreator.lock(this._keyLock),this._targetPoint=this.renderer.getCenter(),this._move=1}zoomOut(){this.planet.layerLock.lock(this._keyLock),this.planet.terrainLock.lock(this._keyLock),this.planet._normalMapCreator.lock(this._keyLock),this._targetPoint=this.renderer.getCenter(),this._move=-1}stopZoom(){this._move=0,this.planet.layerLock.free(this._keyLock),this.planet.terrainLock.free(this._keyLock),this.planet._normalMapCreator.free(this._keyLock)}_draw(t){const n=this.planet.camera;if(this._move!==0){const s=this.planet.getCartesianFromPixelTerrain(t.getCenter());if(s){let o=.035*n.eye.distance(s);n.eye.addA(n.getForward().scale(this._move*o)),n.checkTerrainCollision(),n.update()}}}}class Dl extends de{constructor(t={}){var n,s;super(t.name),this._ignoreTerrain=!1,this.events=new bi(Fl),this._ignoreTerrain=t.ignoreTerrain==null||t.ignoreTerrain,this._onSelect=t.onSelect||null,this._autoSelectionHide=t.autoSelectionHide||!1,this._planet=t.planet||null,this._startLonLat=null,this._heading=0,this._propsLabel=new G({name:"propsLabel",label:{text:"",size:11,color:"rgba(455,455,455,1.0)",outlineColor:"rgba(0,0,0,0.34)",outline:.23,align:"center",offset:[0,18]}}),(s=(n=this._propsLabel)==null?void 0:n.label)==null||s.setVisibility(!1),this._trackEntity=new G({polyline:{path3v:[],thickness:3.8,color:"rgb(455,455,455)",isClosed:!1}}),this._trackEntity.polyline.altitude=.01;let o=$.createCylinder(1.1,0,2.7,20,1,!0,!1,0,0,0);this._cornerEntity=[new G({geoObject:{scale:1,instanced:!0,tag:"selection",color:"rgb(0,305,0)",object3d:o},properties:{name:"start"}}),new G({geoObject:{scale:1,instanced:!0,tag:"selection",color:"rgb(455,0,0)",object3d:o},properties:{name:"end"}})],this._trackLayer=new _t("track",{entities:[this._trackEntity,this._propsLabel],pickingEnabled:!1,polygonOffsetUnits:-1,relativeToGround:!0,hideInLayerSwitcher:!1}),this._cornersLayer=new _t("corners",{entities:[this._cornerEntity[0],this._cornerEntity[1]],pickingEnabled:!0,hideInLayerSwitcher:!0,scaleByDistance:[1,4e6,.01],pickingScale:2})}set ignoreTerrain(t){this._ignoreTerrain=t}bindPlanet(t){this._planet=t}init(){this._activate()}onremove(){this._deactivate()}_activate(){var t,n,s,o,a;(n=(t=this._propsLabel)==null?void 0:t.label)==null||n.setVisibility(!1),this._onMouseMove_=this._onMouseMove.bind(this),(s=this.renderer)==null||s.events.on("mousemove",this._onMouseMove_,this),this._onMouseLdown_=this._onMouseLdown.bind(this),(o=this.renderer)==null||o.events.on("ldown",this._onMouseLdown_,this),this._onMouseLup_=this._onMouseLup.bind(this),(a=this.renderer)==null||a.events.on("lup",this._onMouseLup_,this),this._planet.addLayer(this._trackLayer),this._planet.addLayer(this._cornersLayer)}_deactivate(){var t,n,s;this._startLonLat=null,this._trackLayer.remove(),this._cornersLayer.remove(),(t=this.renderer)==null||t.events.off("mousemove",this._onMouseMove_),(n=this.renderer)==null||n.events.off("ldown",this._onMouseLdown_),(s=this.renderer)==null||s.events.off("lup",this._onMouseLup_),this.clear(),this._onMouseMove_=null,this._onMouseLdown_=null,this._onMouseLup_=null}_onMouseLdown(t){var n,s,o,a,h,c;if(t.renderer.handler.canvas.classList.remove("ogGrabbingPoiner"),t.renderer.handler.canvas.style.cursor="pointer",!this._startLonLat){(n=this._propsLabel.label)==null||n.setVisibility(!1),(s=this._trackEntity.polyline)==null||s.setPath3v([]),(o=this._cornerEntity[0].geoObject)==null||o.setVisibility(!0),(a=this._cornerEntity[1].geoObject)==null||a.setVisibility(!0),(c=(h=this.renderer)==null?void 0:h.controls.navigation)==null||c.deactivate(),this._startLonLat=this._planet.getLonLatFromPixelTerrain(t);let u=this._planet.ellipsoid.lonLatToCartesian(this._startLonLat);this._cornerEntity[0].setCartesian3v(u),this._cornerEntity[1].setCartesian3v(u)}}_onMouseLup(t){var n,s,o;if(this._startLonLat){if(this._pickedCorner=null,this._anchorLonLat=null,(n=this._propsLabel.label)==null||n.setVisibility(!0),this._onSelect&&typeof this._onSelect=="function"){let a=this._cornerEntity[0].getLonLat(),h=this._cornerEntity[1].getLonLat(),c=[Math.min(a.lon,h.lon),Math.min(a.lat,h.lat),Math.max(a.lon,h.lon),Math.max(a.lat,h.lat)];this._onSelect(c)}this._autoSelectionHide&&this.clear(),this._startLonLat=null}t.renderer.handler.canvas.style.cursor="default",(o=(s=this.renderer)==null?void 0:s.controls.navigation)==null||o.activate()}_drawLine(t,n,s){var o;s||(s=this._planet.ellipsoid.lonLatToCartesian(t));let a=this._planet.ellipsoid.lonLatToCartesian(n),h=this._planet.ellipsoid.direct(t,n);this._heading=h.initialAzimuth;let c=[];this._cornerEntity[0].setCartesian3v(s),this._cornerEntity[1].setCartesian3v(a);let u=[s,this._planet.ellipsoid.lonLatToCartesian(new L(n.lon,t.lat,t.height)),a,this._planet.ellipsoid.lonLatToCartesian(new L(t.lon,n.lat,t.height)),s];c.push(s);let d=(f,g)=>{let _=g.sub(f),m=_.length();_.normalize();for(let p=0;p<120;p++){let x=_.scaleTo(p*m/120).addA(f);c.push(x)}};for(let f=0;f<u.length-1;f++)d(u[f],u[f+1]);(o=this._trackEntity.polyline)==null||o.setPath3v([c]),this._ignoreTerrain}_onMouseMove(t){var n;if(this._startLonLat){(n=this._propsLabel.label)==null||n.setVisibility(!0);let s=this._planet.getLonLatFromPixelTerrain(t);if(!s)return;this._drawLine(this._startLonLat,s)}}clear(){var t,n,s;(t=this._trackEntity.polyline)==null||t.clear(),(n=this._cornerEntity[0].geoObject)==null||n.setVisibility(!1),(s=this._cornerEntity[1].geoObject)==null||s.setVisibility(!1)}frame(){var t,n;let s=(t=this._trackEntity.polyline)==null?void 0:t.getPath3v()[0];if(s&&!this._ignoreTerrain){let a=0;for(let h=0,c=s.length-1;h<c;h++)a+=s[h+1].distance(s[h]);this._propsLabel.setCartesian3v(s[Math.floor(s.length/2)]),(n=this._propsLabel.label)==null||n.setText(`${o=a,o>1e3?`${(o/1e3).toFixed(1)} km`:o>9?`${Math.round(o)} m`:`${o.toFixed(1)} m`}, ${Math.round(this._heading)} deg`)}var o}get ellipsoid(){return this._planet?this._planet.ellipsoid:null}}const Fl=["add","remove","mousemove","mouseenter","mouseleave","lclick","rclick","mclick","ldblclick","rdblclick","mdblclick","lup","rup","mup","ldown","rdown","mdown","lhold","rhold","mhold","mousewheel","touchmove","touchstart","touchend","doubletouch","touchleave","touchenter"];function te(l,t){return new Date(+l+1e3*t)}function Ol(l,t=!0,n=!1){let s=Hl[l.getMonth()],o=l.getUTCDate(),a=l.getUTCFullYear();if(t){let h=l.getUTCHours().toString().padStart(2,"0"),c=l.getUTCMinutes().toString().padStart(2,"0"),u=l.getUTCSeconds().toString().padStart(2,"0");return n?`${s} ${o} ${a} ${h}:${c}:${u}.${l.getUTCMilliseconds().toString().padStart(3,"0")}`:`${s} ${o} ${a} ${h}:${c}:${u}`}return`${s} ${o} ${a}`}function Un(l,t=0,n=10,s=2,o="white"){l.lineWidth=s,l.strokeStyle=o,l.beginPath(),l.moveTo(t,0),l.lineTo(t,n),l.stroke()}function Nl(l,t,n,s,o="12px Arial",a="black",h="left",c="bottom",u=0){l.save(),l.translate(n,s),l.rotate(u*j),l.fillStyle=a,l.textBaseline=c,l.font=o,l.textAlign=h,l.fillText(t,0,0),l.restore()}const Zs=[[.001,10],[.002,10],[.005,10],[.01,10],[.02,10],[.05,10],[.1,10],[.25,10],[.5,5],[1,10],[2,10],[5,5],[10,10],[15,15],[30,6],[60,12],[120,12],[300,5],[600,10],[900,15],[1800,6],[3600,12],[7200,10],[14400,4],[21600,6],[43200,12],[86400,24],[172800,2],[345600,4],[604800,7],[1296e3,15],[2592e3,5],[5184e3,6],[7776e3,9],[15552e3,18],[31536e3,12],[63072e3,2],[126144e3,4],[15768e4,5],[31536e4,10],[63072e4,2],[126144e4,4],[15768e5,5],[31536e5,10],[63072e5,2],[126144e5,4],[15768e6,5],[31536e6,10]],Hl=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],Vl=["change","current"];class Ul{constructor(t={}){this.events=lt(Vl),this._current=t.current||new Date,this._rangeStart=t.rangeStart||new Date,this._rangeEnd=t.rangeEnd||te(this._rangeStart,3600),this._range=this._rangeEnd.getTime()-this._rangeStart.getTime(),this._minDate=t.minDate||null,this._maxDate=t.maxDate||null,this.multiplier=t.multiplier!=null?t.multiplier:1,this._requestAnimationFrameId=0,this._prevNow=0,this.dt=0}play(){this._requestAnimationFrameId||(this._prevNow=window.performance.now(),this._animationFrameCallback())}stop(){this._requestAnimationFrameId&&(window.cancelAnimationFrame(this._requestAnimationFrameId),this._requestAnimationFrameId=0)}stopped(){return this._requestAnimationFrameId==0}_animationFrameCallback(){this._requestAnimationFrameId=window.requestAnimationFrame(()=>{this._frame(),this._animationFrameCallback()})}_frame(){let t=window.performance.now();this.dt=t-this._prevNow,this._prevNow=t,this.current=new Date(this.currentTime+this.dt*this.multiplier)}get range(){return this._range}set(t,n){t===this._rangeStart&&n===this._rangeEnd||(this._rangeStart=t,this._rangeEnd=n,this._range=this._rangeEnd.getTime()-this._rangeStart.getTime(),this.events.dispatch(this.events.change,t,n))}get current(){return this._current}get rangeStart(){return this._rangeStart}get rangeEnd(){return this._rangeEnd}get rangeStartTime(){return this._rangeStart.getTime()}get rangeEndTime(){return this._rangeEnd.getTime()}get currentTime(){return this._current.getTime()}set current(t){t!==this._current&&(this._maxDate&&t>this._maxDate?this._current=this._maxDate:this._minDate&&t<this._minDate?this._current=this._minDate:this._current=t,this.events.dispatch(this.events.current,this._current))}set rangeStart(t){t!==this._rangeStart&&(this._rangeStart=t,this._range=this._rangeEnd.getTime()-this._rangeStart.getTime(),this.events.dispatch(this.events.change,t))}set rangeEnd(t){t!==this._rangeEnd&&(this._rangeEnd=t,this._range=this._rangeEnd.getTime()-this._rangeStart.getTime(),this.events.dispatch(this.events.change,t))}}const Fe=.001,Gl=["startdrag","stopdrag","startdragcurrent","stopdragcurrent","setcurrent","reset","play","playback","pause","visibility"],Gn="#bfbfbf";class jl extends ut{constructor(t={}){super({template:`<div class="og-timeline">

  <div class="og-timeline-top">
  </div>

  <div class="og-timeline-frame">
    <div class="og-timeline-current">
      <div class="og-timeline-current-spin">
        <div class="og-timeline-current-arrow"></div>
      </div>
    </div>
    <div class="og-timeline-scale"></div>
  </div>

  <div class="og-timeline-bottom">
    <div class="og-timeline-controls">
    </div>
  </div>

</div>`,model:new Ul({rangeStart:t.rangeStart,rangeEnd:t.rangeEnd,current:t.currentDate,minDate:t.minDate,maxDate:t.maxDate})}),this._onMouseWheel=n=>{if(this._isMouseOver){let s=this._canvasEl.getBoundingClientRect(),o=n.clientX-s.left,a=-(o-.5*this.clientWidth),h=this.model.rangeStartTime+this._millisecondsInPixel*o;this._zoom(h,a,Math.sign(n.wheelDelta))}else if(this._isCurrentMouseOver){let s=-((this.model.currentTime-this.model.rangeStartTime)/this._millisecondsInPixel-.5*this.clientWidth);this._zoom(this.model.currentTime,s,Math.sign(n.wheelDelta))}},this._onMouseWheelFF=n=>{this._onMouseWheel(n)},this._onMouseDown=n=>{this._isMouseOver?(this._isDragging=!0,document.body.classList.add("og-timeline-unselectable"),this._clickPosX=n.clientX,this._clickTime=Date.now(),this._clickRangeStart=this.model.rangeStart,this._clickRangeEnd=this.model.rangeEnd,this.events.dispatch(this.events.startdrag,n)):this._isCurrentMouseOver&&(this._isCurrentDragging=!0,document.body.classList.add("og-timeline-unselectable"),this._clickPosX=n.clientX,this._clickCurrentDate=this.model.current,this.events.dispatch(this.events.startdragcurrent,n))},this._onMouseUp=n=>{if(this._isDragging)if(this._isDragging=!1,document.body.classList.remove("og-timeline-unselectable"),this._clickPosX===n.clientX&&Date.now()-this._clickTime<this._clickDelay){let s=this._canvasEl.getBoundingClientRect(),o=new Date(this.model.rangeStartTime+(n.clientX-s.left)*this._millisecondsInPixel);this.model.current=o,this.events.dispatch(this.events.stopdrag,o),this.events.dispatch(this.events.setcurrent,o)}else this.events.dispatch(this.events.stopdrag,this.model.current);else this._isCurrentDragging&&(this._isCurrentDragging=!1,document.body.classList.remove("og-timeline-unselectable"),this.events.dispatch(this.events.stopdragcurrent,this.model.current))},this._onMouseEnter=()=>{this._isMouseOver=!0},this._onMouseOut=()=>{this._isMouseOver=!1},this._onCurrentMouseEnter=()=>{this._isCurrentMouseOver=!0},this._onCurrentMouseOut=()=>{this._isCurrentMouseOver=!1},this._onMouseMove=n=>{if(this._isDragging){let s=(this._clickPosX-n.clientX)*this._millisecondsInPixel*Fe;this.model.set(te(this._clickRangeStart,s),te(this._clickRangeEnd,s))}else if(this._isCurrentDragging){let s=(this._clickPosX-n.clientX)*this._millisecondsInPixel*Fe,o=te(this._clickCurrentDate,-s);o>=this.model.rangeStart&&o<=this.model.rangeEnd&&(this.model.current=te(this._clickCurrentDate,-s))}},this.events=this.events.registerNames(Gl),this.fillStyle=t.fillStyle||"rgba(64, 59, 59, 1.0)",this.$controls=null,this._frameEl=null,this._currentEl=null,this._canvasEl=document.createElement("canvas"),this._ctx=this._canvasEl.getContext("2d"),this._isMouseOver=!1,this._isDragging=!1,this._isCurrentDragging=!1,this._isCurrentMouseOver=!1,this._minWidth=330,this._canvasScale=2,this._millisecondsInPixel=0,this._clickPosX=0,this._clickRangeStart=new Date,this._clickRangeEnd=new Date,this._clickCurrentDate=new Date,this._clickTime=0,this._clickDelay=450,this._onResizeObserver_=this._onResizeObserver.bind(this),this._resizeObserver=new ResizeObserver(this._onResizeObserver_),this._pauseBtn=new dt({classList:["og-timeline-control_button"],icon:`<?xml version="1.0" ?><!DOCTYPE svg  PUBLIC '-//W3C//DTD SVG 1.1//EN'  'http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd'><svg enable-background="new 0 0 512 512" height="512px" version="1.1" viewBox="0 0 512 512" width="512px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><g id="Layer_6"><rect fill="#252525" height="320" width="60" x="153" y="96"/><rect fill="#252525" height="320" width="60" x="299" y="96"/></g></svg>`,name:"pause"}),this._playBtn=new dt({classList:["og-timeline-control_button"],icon:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M8 5v14l11-7z" style="fill: black;"/></svg>',name:"play"}),this._buttons=new jo({buttons:[this._pauseBtn,this._playBtn]}),this._visibility=!1}_onResizeObserver(){this.resize()}get canvasScale(){return this._canvasScale}set canvasScale(t){t!==this._canvasScale&&(this._canvasScale=t,this.resize())}resize(){this._resize(),this.draw()}afterRender(t){this.resize()}render(){return super.render(),this.$controls=this.select(".og-timeline-controls"),this._frameEl=this.select(".og-timeline-frame"),this._currentEl=this.select(".og-timeline-current"),this.select(".og-timeline-frame .og-timeline-scale").appendChild(this._canvasEl),this._resizeObserver.observe(this.el),this.model.events.on("change",()=>{this.draw()}),this.model.events.on("current",t=>{this._drawCurrent(),this.events.dispatch(this.events.setcurrent,t)}),this._canvasEl.addEventListener("mouseenter",this._onMouseEnter),this._canvasEl.addEventListener("mouseout",this._onMouseOut),this._currentEl.addEventListener("mouseenter",this._onCurrentMouseEnter),this._currentEl.addEventListener("mouseout",this._onCurrentMouseOut),document.body.addEventListener("mousemove",this._onMouseMove),document.body.addEventListener("mousedown",this._onMouseDown),document.body.addEventListener("mouseup",this._onMouseUp),document.body.addEventListener("wheel",this._onMouseWheelFF),this._playBtn.appendTo(this.$controls),this._pauseBtn.appendTo(this.$controls),this.model.stopped()?(this._pauseBtn.setActive(!0,!0),this._pauseBtn.preventClick=!0):(this._playBtn.setActive(!0,!0),this._playBtn.preventClick=!0),this._buttons.events.on("change",t=>{switch(t.name){case"play":this.play();break;case"pause":this.pause()}}),this.setVisibility(!0),this}setVisibility(t){t!==this._visibility&&(this._visibility=t,this.el&&(this.el.style.display=t?"block":"none"),this.events.dispatch(this.events.visibility,t))}reset(){this.model.stop(),this.events.dispatch(this.events.reset,this.model)}play(){this.model.multiplier=Math.abs(this.model.multiplier),this.model.play(),this.events.dispatch(this.events.play,this.model)}pause(){this.model.stop(),this.events.dispatch(this.events.pause,this.model)}playBack(){this.model.multiplier=-1*Math.abs(this.model.multiplier),this.model.play(),this.events.dispatch(this.events.playback,this.model)}_zoom(t,n,s){let o=(t-(this.model.rangeStartTime+.5*this.model.range))*Fe,a=te(this.model.rangeStart,o),h=te(this.model.rangeEnd,o),c=(h.getTime()-a.getTime())/20*Fe,u=te(a,c*s),d=te(h,-c*s),f=(d.getTime()-u.getTime())/this.clientWidth;if(f<31536e6&&f>.1){let g=f*n*Fe;this.model.set(te(u,g),te(d,g))}}get clientWidth(){return this._canvasEl?this._canvasEl.width/this._canvasScale:0}get clientHeight(){return this._canvasEl?this._canvasEl.height/this._canvasScale:0}_resize(){this._frameEl&&(this._canvasEl.width=this._frameEl.clientWidth*this._canvasScale,this._canvasEl.height=this._frameEl.clientHeight*this._canvasScale,this._canvasEl.style.width=`${this._frameEl.clientWidth}px`,this._canvasEl.style.height=`${this._frameEl.clientHeight}px`)}getOffsetByTime(t){return(t-this.model.rangeStartTime)/this._millisecondsInPixel}remove(){super.remove(),this.model.stop()}_clearCanvas(){this._ctx.fillStyle=this.fillStyle,this._ctx.fillRect(0,0,this.clientWidth*this._canvasScale,this.clientHeight*this._canvasScale)}_drawCurrent(){let t=(this.model.currentTime-this.model.rangeStartTime)/this._millisecondsInPixel;this.model.current<this.model.rangeStart||this.model.current>this.model.rangeEnd?this._currentEl.style.display="none":(this._currentEl.style.display="block",this._currentEl.style.transform=`translateX(${t}px)`)}draw(){this._millisecondsInPixel=this.model.range/this.clientWidth;let t=function(s){for(let o=0,a=Zs.length;o<a;o++)if(Zs[o][0]>s)return Zs[o-1]}(this._minWidth*this._millisecondsInPixel*Fe);if(t){this._clearCanvas();let s=1e3*t[0],o=s/this._millisecondsInPixel,a=t[1],h=(n=this.model.rangeStartTime)-n%s,c=t[0]<1,u=t[0]<86400;for(let d=h,f=this.model.rangeEndTime+s;d<f;d+=s){let g=this.getOffsetByTime(d);g>=0&&g<=this.clientWidth*this._canvasScale&&Un(this._ctx,g*this._canvasScale,10*this._canvasScale,2*this._canvasScale,Gn);for(let _=1;_<a;_++){let m=g+_*(o/a);m>=0&&m<=this.clientWidth*this._canvasScale&&Un(this._ctx,m*this._canvasScale,5*this._canvasScale,1*this._canvasScale,Gn)}Nl(this._ctx,Ol(new Date(d),u,c),g*this._canvasScale,26*this._canvasScale,"24px monospace","#bfbfbf","center")}this._drawCurrent()}var n}}function jn(l,t){const n=new Date(l);return n.setHours(n.getHours()+t),n}class pi{constructor(){this.resolve=()=>{},this.reject=()=>{},this.promise=new Promise((t,n)=>{this.resolve=t,this.reject=n}),Object.freeze(this)}}const ql=["startcollecting","profilecollected","clear"];class Yl{constructor(t={}){this.events=lt(ql),this.planet=t.planet||null,this._warningHeightLevel=5,this._pointsReady=!1,this._isWarning=!1,this._minX=0,this._planeDistance=this._maxX=1e3,this._minY=0,this._maxY=200,this._drawData=[[],[]],this._promiseArr=[],this._promiseCounter=0,this._pMaxY=0,this._pMinY=0,this._pDist=0,this._pTrackCoords=[],this._pGroundCoords=[],this._pIndex=0}bindPlanet(t){this.planet=t}setWarningHeightLevel(t=0){this._warningHeightLevel=t}setRange(t,n,s,o){this._minX=t,this._maxX=n,s&&(this._minY=s),o&&(this._maxY=o)}_getHeightAsync(t,n,s){let o=new pi;if(this.planet){let a=this.planet.terrain.geoid.getHeightLonLat(t);this.planet.terrain.getHeightAsync(t,h=>{this.planet&&s===this._promiseCounter?(h+=a,this._pGroundCoords[n][1]=h,this._pGroundCoords[n][2]=0,this._pGroundCoords[n][3]=t.height,h>this._pMaxY&&(this._pMaxY=h),h<this._pMinY&&(this._pMinY=h),this._updatePointType(n),o.resolve(h)):o.reject()})}else o.reject();return o.promise}_collectCoordsBetweenTwoTrackPoints(t,n,s,o,a,h){if(this.planet)for(let c=1;c<=n;c++){this._pDist+=1,this._pIndex++;let u=c*s,d=o.add(a.scaleTo(u)),f=this.planet.ellipsoid.cartesianToLonLat(d);this._pGroundCoords[this._pIndex]=[this._pDist,0,0,0,t],((g,_)=>{this._promiseArr.push(this._getHeightAsync(g,_,h))})(f,this._pIndex)}}_collectAllPoints(t,n){if(!this.planet||n!==this._promiseCounter)return;let s=new v,o=new v;for(let a=1,h=t.length;a<h;a++){let c=t[a-1],u=t[a];this.planet.ellipsoid.lonLatToCartesianRes(c,s),this.planet.ellipsoid.lonLatToCartesianRes(u,o);let d=o.sub(s),f=d.length(),g=this.planet.ellipsoid.getSurfaceNormal3v(s),_=v.proj_b_to_plane(d,g),m=_.length(),p=Math.floor(m/1),x=1*f/m;this._getGroundElevation(c,a-1,n),_.normalize(),d.normalize(),this._collectCoordsBetweenTwoTrackPoints(a-1,p,x,s,d,n),this._pDist+=m-1*p,this._pIndex++;let y=u.height;y>this._pMaxY&&(this._pMaxY=y),y<this._pMinY&&(this._pMinY=y),this._pTrackCoords[a]=[this._pDist,y,this._pIndex]}}_getGroundElevation(t,n,s){this._pGroundCoords[this._pIndex]=[this._pDist,0,0,0,n],this._promiseArr.push(this._getHeightAsync(t,this._pIndex,s))}_calcPointsAsync(t,n){return new Promise((s,o)=>{this._pTrackCoords=[[0,t[0].height,0]],this._pMaxY=t[0].height,this._pMinY=this._pMaxY,this._pDist=0,this._pGroundCoords=[],this._pIndex=0,this._promiseArr=[],this._collectAllPoints(t,n),this._getGroundElevation(t[t.length-1],t.length-1,n),Promise.all(this._promiseArr).then(()=>{s({dist:this._pDist,minY:this._pMinY,maxY:this._pMaxY,trackCoords:this._pTrackCoords,groundCoords:this._pGroundCoords})})})}get minX(){return this._minX}get planeDistance(){return this._planeDistance}get maxX(){return this._maxX}get minY(){return this._minY}get maxY(){return this._maxY}get pointsReady(){return this._pointsReady}get isWarningOrCollision(){return this._isWarning}get drawData(){return this._drawData}collectProfile(t){let n=new pi;return this.planet||n.reject(),this._pointsReady=!1,this._isWarning=!1,t&&t.length?(this.events.dispatch(this.events.startcollecting,this),this._promiseCounter++,(s=>{this._calcPointsAsync(t,s).then(o=>{s===this._promiseCounter&&(this._planeDistance=o.dist,this.setRange(0,o.dist,o.minY-.1*Math.abs(o.minY),o.maxY+.2*Math.abs(o.maxY)),this._pointsReady=!0,this._drawData=[o.trackCoords,o.groundCoords],this.events.dispatch(this.events.profilecollected,this._drawData,this),n.resolve(this._drawData))})})(this._promiseCounter),n.promise):(n.reject(),n.promise)}_updatePointType(t){this._pGroundCoords[t][3]>=this._pGroundCoords[t][1]&&this._pGroundCoords[t][3]<this._pGroundCoords[t][1]+this._warningHeightLevel-.1&&(this._pGroundCoords[t][2]=1),this._pGroundCoords[t][3]<=this._pGroundCoords[t][1]+1&&(this._pGroundCoords[t][2]=2),this._pGroundCoords[t][2]!==1&&this._pGroundCoords[t][2]!==2||(this._isWarning=!0)}_setPointsType(){this._isWarning=!1,this._pTrackCoords=this._drawData[0],this._pGroundCoords=this._drawData[1];for(let t=0;t<this._pGroundCoords.length;t++)this._updatePointType(t);this._drawData[1]=this._pGroundCoords,this.events.dispatch(this.events.profilecollected,this._drawData,this)}clear(){this._promiseCounter=0,this._pointsReady=!1,this._isWarning=!1,this._drawData=[[],[]],this._pMaxY=0,this._pMinY=0,this._pDist=0,this._pTrackCoords=[],this._pGroundCoords=[],this._pIndex=0,this.events.dispatch(this.events.clear,this._drawData,this)}}const va="rgb(198, 198, 198)",qn=[va,"rgb(255, 255, 0)","rgb(255, 0, 0)"],Wl=["startdrag","stopdrag","pointer","mouseenter","mouseleave","dblclick","tracklength","groundlength","warninglength","collisionlength"];class $l extends ut{constructor(t={}){super({template:`<div class="og-elevationprofile">
      <div class="og-elevationprofile-loading" style="display: none;">
        <div class="loadingio-spinner-bars-r354qqyl5v">
          <div class="ldio-p0v5a1f6oz">
            <div></div>
            <div></div>
            <div></div>
            <div></div>
          </div>
        </div> 
      </div>     
    </div>`,model:new Yl}),this._onMouseDblClick=n=>{let s,o=this.$canvas.getBoundingClientRect(),a=n.clientX-o.left,h=this._leftDistance+(this._rightDistance-this._leftDistance)*a/this.clientWidth,c=this.model.drawData[1],u=this.model.drawData[0];h<0?(s=1,h=0,a=(0-this._leftDistance)*this.clientWidth/(this._rightDistance-this._leftDistance)):h>this.model.planeDistance?(s=c.length-1,h=this.model.planeDistance,a=(h-this._leftDistance)*this.clientWidth/(this._rightDistance-this._leftDistance)):s=-1-Re(c,h,(T,S)=>T-S[0]);let d=c[s-1],f=c[s],g=(h-d[0])/(f[0]-d[0]),_=d[1]+g*(f[1]-d[1]),m=d[4],p=u[m],x=u[m+1];g=(h-p[0])/(x[0]-p[0]);let y=p[1]+g*(x[1]-p[1]);this.events.dispatch(this.events.dblclick,h,p,x,d,f,m,s-1,y-_)},this._onMouseEnter=n=>{this._isMouseOver=!0,this.events.dispatch(this.events.mouseenter,n)},this._onMouseOut=n=>{this._isMouseOver=!1,this.events.dispatch(this.events.mouseleave,n)},this._onMouseDown=n=>{this._isMouseOver&&(this._isDragging=!0,document.body.classList.add("og-timeline-unselectable"),this._clickPosX=n.clientX,this._customFrame||(this._leftDistance=this.model.minX,this._rightDistance=this.model.maxX),this._clickLeftDistance=this._leftDistance,this._clickRightDistance=this._rightDistance,this.events.dispatch(this.events.startdrag,n))},this._onMouseUp=n=>{this._isDragging&&(this._isDragging=!1,document.body.classList.remove("og-timeline-unselectable"),this.events.dispatch(this.events.stopdrag,n))},this._onCanvasMouseMove=n=>{if(this.model.pointsReady)if(this._isDragging)this.clearPointerCanvas();else{this._customFrame||(this._leftDistance=this.model.minX,this._rightDistance=this.model.maxX);let s=this.$pointerCanvas.getBoundingClientRect(),o=n.clientX-s.left;this.redrawPointerCanvas(o)}},this._onMouseMove=n=>{if(this._isDragging&&this.model.pointsReady){let s=(this._clickPosX-n.clientX)*this._canvasScale/this._pixelsInMeter_x;this.setFrame(this._clickLeftDistance+s,this._clickRightDistance+s)}},this._onMouseWheelFF=n=>{this._onMouseWheel(n)},this._onMouseWheel=n=>{if(this._isMouseOver&&this.model.pointsReady){this._customFrame||(this._leftDistance=this.model.minX,this._rightDistance=this.model.maxX),this._customFrame=!0;let s=Math.sign(n.wheelDelta)*(this._rightDistance-this._leftDistance)/20,o=this.$canvas.getBoundingClientRect(),a=n.clientX-o.left,h=a-.5*this.$canvas.clientWidth,c=h*this._canvasScale/this._pixelsInMeter_x,u=c+this._leftDistance+s,d=c+this._rightDistance-s;c=-h*(d-u)/this.clientWidth,this.setFrame(u+c,d+c),this.redrawPointerCanvas(a)}},this.events=this.events.registerNames(Wl),this.fillStyle=t.fillStyle||"rgb(63, 63, 63)",this._customFrame=!1,this._leftDistance=0,this._rightDistance=0,this._pixelsInMeter_x=0,this._pixelsInMeter_y=0,this._canvasScale=2,this.$canvas=document.createElement("canvas"),this.$canvas.style.position="absolute",this._ctx=this.$canvas.getContext("2d"),this.$pointerCanvas=document.createElement("canvas"),this.$pointerCanvas.style.pointerEvents="none",this.$pointerCanvas.style.position="absolute",this._pointerCtx=this.$pointerCanvas.getContext("2d"),this.$loading=null,this._isMouseOver=!1,this._isDragging=!1,this._clickPosX=0,this._clickLeftDistance=0,this._clickRightDistance=0,this._timeStartHandler=0,this._onResizeObserver_=this._onResizeObserver.bind(this),this._resizeObserver=new ResizeObserver(this._onResizeObserver_)}_onResizeObserver(){this.resize()}get canvasScale(){return this._canvasScale}set canvasScale(t){t!==this._canvasScale&&(this._canvasScale=t,this.resize())}resize(){this._resize(),this.draw()}render(){return super.render(),this._resizeObserver.observe(this.el),this.el.appendChild(this.$canvas),this.el.appendChild(this.$pointerCanvas),this.model.events.on("profilecollected",t=>{this._hideLoading(),this.clearPointerCanvas(),this.draw()}),this.model.events.on("startcollecting",()=>{clearTimeout(this._timeStartHandler),this._timeStartHandler=setTimeout(()=>{this._showLoading()},450)}),this.model.events.on("clear",()=>{this._customFrame=!1,this._leftDistance=0,this.clearCanvas(),this.clearPointerCanvas()}),this.$loading=this.select(".og-elevationprofile-loading"),this.$canvas.addEventListener("mouseenter",this._onMouseEnter),this.$canvas.addEventListener("mouseout",this._onMouseOut),this.$canvas.addEventListener("dblclick",this._onMouseDblClick),this.$canvas.addEventListener("mousemove",this._onCanvasMouseMove),document.body.addEventListener("mousemove",this._onMouseMove),document.body.addEventListener("mousedown",this._onMouseDown),document.body.addEventListener("mouseup",this._onMouseUp),document.body.addEventListener("wheel",this._onMouseWheelFF),this}_hideLoading(){clearTimeout(this._timeStartHandler),this.$loading.style.display="none"}_showLoading(){this.$loading.style.display="flex"}redrawPointerCanvas(t){this.clearPointerCanvas();let n,s=this._leftDistance+(this._rightDistance-this._leftDistance)*t/this.clientWidth,o=this.model.drawData[1],a=this.model.drawData[0];s<0?(n=1,s=0,t=(0-this._leftDistance)*this.clientWidth/(this._rightDistance-this._leftDistance)):s>this.model.planeDistance?(n=o.length-1,s=this.model.planeDistance,t=(s-this._leftDistance)*this.clientWidth/(this._rightDistance-this._leftDistance)):n=-1-Re(o,s,(S,C)=>S-C[0]);let h=o[n-1],c=o[n],u=(s-h[0])/(c[0]-h[0]),d=h[1]+u*(c[1]-h[1]),f=h[4],g=a[f],_=a[f+1];u=(s-g[0])/(_[0]-g[0]);let m=g[1]+u*(_[1]-g[1]),p=(this.model.maxY-m)*this._pixelsInMeter_y,x=(this.model.maxY-d)*this._pixelsInMeter_y;this.events.dispatch(this.events.pointer,s,g,_,h,c,f,n-1,m-d);let y=this._pointerCtx;y.lineWidth=3,y.strokeStyle="rgba(64,64,64,0.6)",y.beginPath(),y.moveTo(t*this._canvasScale,0),y.lineTo(t*this._canvasScale,this.clientHeight*this._canvasScale),y.stroke(),y.beginPath(),y.arc(t*this._canvasScale,x,4,0,2*Math.PI,!1),y.fillStyle="#FFB277",y.fill(),y.lineWidth=4,y.strokeStyle="#FFB277",y.stroke(),y.beginPath(),y.arc(t*this._canvasScale,p,4,0,2*Math.PI,!1),y.fillStyle="#FFB277",y.fill(),y.lineWidth=4,y.strokeStyle="#FFB277",y.stroke(),y.lineWidth=3,y.strokeStyle="#FFB277",y.beginPath(),y.moveTo(t*this._canvasScale,x),y.lineTo(t*this._canvasScale,p),y.stroke(),y.fillStyle="white",y.font=28/devicePixelRatio+"px Arial",y.textBaseline="middle",y.textAlign="left",y.fillText(`${Math.round(m-d).toString()} m`,(t+5)*this._canvasScale,x+.5*(p-x)),y.fillStyle="white",y.font=28/devicePixelRatio+"px Arial",y.textAlign="right";let T=Ge(s);y.fillText(`${T[0]} ${T[1]}`,(t-5)*this._canvasScale,(this.clientHeight-7)*this._canvasScale)}get clientWidth(){return this.$canvas?this.$canvas.width/this._canvasScale:0}get clientHeight(){return this.$canvas?this.$canvas.height/this._canvasScale:0}_resize(){this.el&&(this.$canvas.width=this.el.clientWidth*this._canvasScale,this.$canvas.height=this.el.clientHeight*this._canvasScale,this.$canvas.style.width=`${this.el.clientWidth}px`,this.$canvas.style.height=`${this.el.clientHeight}px`,this.$pointerCanvas.width=this.el.clientWidth*this._canvasScale,this.$pointerCanvas.height=this.el.clientHeight*this._canvasScale,this.$pointerCanvas.style.width=`${this.el.clientWidth}px`,this.$pointerCanvas.style.height=`${this.el.clientHeight}px`,this._customFrame&&(this._pixelsInMeter_x=this._canvasScale*this.clientWidth/(this._rightDistance-this._leftDistance)))}clearPointerCanvas(){this._pointerCtx.fillStyle="rgba(0,0,0,0)",this._pointerCtx.clearRect(0,0,this.clientWidth*this._canvasScale,this.clientHeight*this._canvasScale)}clearCanvas(){const t=this._ctx.createLinearGradient(0,0,0,this.clientHeight*this._canvasScale);t.addColorStop(0,"black"),t.addColorStop(1,this.fillStyle),this._ctx.fillStyle=t,this._ctx.fillRect(0,0,this.clientWidth*this._canvasScale,this.clientHeight*this._canvasScale)}setFrame(t,n){this._leftDistance=t,this._rightDistance=n,this._customFrame=!0,this._pixelsInMeter_x=this._canvasScale*this.clientWidth/(this._rightDistance-this._leftDistance),this.model.setRange(t,n),this.draw()}_updateUnits(){this._customFrame||(this._pixelsInMeter_x=this._canvasScale*this.clientWidth/(this.model.maxX-this.model.minX)),this._pixelsInMeter_y=this._canvasScale*this.clientHeight/(this.model.maxY-this.model.minY)}clear(){this.model.clear(),this.clearCanvas()}draw(){let t=this.model.drawData[0];if(t.length>1){this._updateUnits(),this.clearCanvas();let n=this.model.drawData[1];this._drawTrack(t,n),this._drawTerrain(n),this._drawWarningAndCollision(n),this._drawLabels(t,n)}else this.clearCanvas()}_drawLabels(t,n){let s=this._ctx;if(s){let o=t[0];const a=this.model.maxY;let h=(-this._leftDistance+o[0])*this._pixelsInMeter_x,c=(a-o[1])*this._pixelsInMeter_y;n[o[2]][1],this._pixelsInMeter_y,s.beginPath(),s.fillStyle="#F7F718",s.fillRect(h-4,c-4,8,8),s.stroke(),s.fillStyle="white",s.font=26/devicePixelRatio+"px Arial",s.textBaseline="bottom",s.textAlign="left",s.fillText(`${Math.round(o[1]-n[o[2]][1]).toString()} m`,h+1,c-10),s.stroke();for(let u=1,d=t.length;u<d;u++){let f=t[u];h=(-this._leftDistance+f[0])*this._pixelsInMeter_x,c=(a-f[1])*this._pixelsInMeter_y,n[f[2]][1],this._pixelsInMeter_y,s.beginPath(),s.fillStyle="#F7F718",s.fillRect(h-4,c-4,8,8),s.stroke(),s.fillStyle="white",s.fillText(`${Math.round(f[1]-n[f[2]][1]).toString()} m`,h+1,c-10),s.stroke()}}}_drawTrack(t,n){let s=t[0],o=this._ctx;if(o){const a=this.model.maxY;o.lineWidth=5,o.strokeStyle="rgb(0, 255, 50)",o.beginPath(),o.moveTo((-this._leftDistance+s[0])*this._pixelsInMeter_x,(a-s[1])*this._pixelsInMeter_y);let h=0;for(let f=1,g=t.length;f<g;f++){let _=t[f];o.lineTo((-this._leftDistance+_[0])*this._pixelsInMeter_x,(a-_[1])*this._pixelsInMeter_y);let m=t[f-1],p=_[0]-m[0],x=_[1]-m[1],y=p*p,T=x*x;h+=Math.sqrt(y+T)}o.stroke(),o.lineWidth=2,o.strokeStyle="rgba(255,255,255,0.7)",o.beginPath();let c=(-this._leftDistance+s[0])*this._pixelsInMeter_x,u=(a-s[1])*this._pixelsInMeter_y,d=(a-n[s[2]][1])*this._pixelsInMeter_y;o.moveTo(c,u),o.lineTo(c,d);for(let f=1,g=t.length;f<g;f++){let _=t[f];c=(-this._leftDistance+_[0])*this._pixelsInMeter_x,u=(a-_[1])*this._pixelsInMeter_y,d=(a-n[_[2]][1])*this._pixelsInMeter_y,o.strokeStyle="rgba(255,255,255,0.7)",o.moveTo(c,u),o.lineTo(c,d)}o.stroke(),this.events.dispatch(this.events.tracklength,h)}}_drawTerrain(t){let n=t[0],s=this._ctx;if(s){const o=this.model.maxY;s.lineWidth=5,s.strokeStyle=va,s.beginPath(),s.moveTo((-this._leftDistance+n[0])*this._pixelsInMeter_x,this.$canvas.height),s.lineTo((-this._leftDistance+n[0])*this._pixelsInMeter_x,(o-n[1])*this._pixelsInMeter_y);let a=0;for(let h=1,c=t.length;h<c;h++){let u=t[h];s.lineTo((-this._leftDistance+u[0])*this._pixelsInMeter_x,(o-u[1])*this._pixelsInMeter_y);let d=t[h-1],f=u[0]-d[0],g=u[1]-d[1],_=f*f,m=g*g;a+=Math.sqrt(_+m)}s.lineTo((-this._leftDistance+t[t.length-1][0])*this._pixelsInMeter_x,this.$canvas.height),s.closePath(),s.stroke(),s.save(),s.fillStyle="rgb(64, 68, 82)",s.globalAlpha=.5,s.fill(),s.restore(),s.globalAlpha=1,this.events.dispatch(this.events.groundlength,a)}}_drawWarningAndCollision(t){let n=this._ctx;if(n&&t.length>1){let s=this.model.maxY;n.lineWidth=5,n.beginPath();let o=0,a=0;for(let h=0,c=t.length-1;h<c;h++){let u=t[h],d=t[h+1];if(u[2]!==0&&d[2]!==0){let f=d[0]-u[0],g=d[1]-u[1],_=f*f,m=g*g;u[2]===2?(n.stroke(),n.beginPath(),n.strokeStyle=qn[2],a+=Math.sqrt(_+m)):u[2]===1&&(n.stroke(),n.beginPath(),n.strokeStyle=qn[1],o+=Math.sqrt(_+m)),n.moveTo((-this._leftDistance+u[0])*this._pixelsInMeter_x,(s-u[1])*this._pixelsInMeter_y),n.lineTo((-this._leftDistance+d[0])*this._pixelsInMeter_x,(s-d[1])*this._pixelsInMeter_y)}}n.stroke(),this.events.dispatch(this.events.warninglength,o),this.events.dispatch(this.events.collisionlength,a)}}}let Xl=$.createCylinder(.33,0,1,20,1,!0,!1,0,0,0),Zl=$.createCylinder(.33,.33,1.1,20,1,!0,!0,0,-.55,0);const Kl={startPosition:new v,endPosition:new v,startColor:"rgba(255,131,0,0.2)",endColor:"rgba(255,131,0,1.0)",thickness:2.7},Ql={src:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACACAYAAADDPmHLAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAAYdEVYdFNvZnR3YXJlAHBhaW50Lm5ldCA0LjEuNBNAaMQAAAiLSURBVHhe7Z0r0BxFEMcjIhAIRERERAQCgUAgEBEIBAIRiUAgIiIQiAgEIlUREQgEIgIREYFAIBCIiAgEIiIiAoGIoHimqPAKz5CP/t23/8vcbe89d/dmZ/pf9avLdZK72e6+ee3M7Imjo6Opc8o4b7xn3DIeGEOJz+Y7+C6+k+/2yjQZXOMEOGdcNe4anv4wvjV+m73bT3wGn8VneqIMlIUyeWXNGteYKTj4feNrI9W/xi/HfxxVfCffnYqyUcbJJINrzIjTxjvGV0aqn43fj/+YhSgLZUpFmd81uAbv2rLANWbAC8ZHxp+GxC8ufZ+rKGNaI1FLcC1ck3etB8U1HhCqzk8N6T/jENV7X6LsXIN008iqeXCNB+B54zND+tt4ePzHIsS1cE0SicA1e74YFdc4IgyjrhvqTP3TvJas9Bq59oP2EVzjCJw03jI0TCMBcurUDS1qBCU9PnjbwCeerwbFNQ4MVd9tQ5pyG7+v0mvHJ6N3FF3jgFwy1JPvmlipUfIFvmHY6/luEFzjANDO0fGRfm1eQ0+UzlriqzOG58tecY0985LxnYH+al5D3ZKP8Bm+83zaG66xRy4a6uzU3NZvK/nqkUEH0fNtL7jGHqBH+4EhTWEGL2ddMwYZJbjGPaGgHxuIDA7tJ/mQGdLek8A17sHTxucGiva+P6kGxbf42PP9TrjGHUmDH1V+/xokCVzjDkTwx1HvSeAat4R2SWP8CP7wko9ZmrZ3n8A1bok6fBH88SRf4/u9ksA1bgFr4ZDG+qHxpLuKLFD1YrMRrnFDLhjocfMaGl8aIjLh5sVoLa5xA140+lhxG+pHNAk7TRu7xjXQ+9TK3Jru4ecqxYB7B88YXsw6cY1rUKcv7ujlI907YLbQi1knrnEFavej05ef1ClkpZUXOxfX2AH3p6Pdz1/E6FnDi2EL19iBVu3Gbd18pdgwU+jFsIVrdHjDQHGDJ39pkojm2ovlAq5xCXqWWtETmo7uG2t3L7vGJTTbF73+6UhNARtVvZjOcY0JZ42Y45+uGK2t7BC6xoQbBoqO3/SkGpt5Gy+2M1xjw3MGGZRubgxNS5qv6dxw4hob9OuPsf90pWnizlrANRpM+sSvvwypFqBGb8W6ZWjgHjOKtn/6Ug3OMv1WrFsG4ykjqv3yxGiudbdw4U2DbvjEuL8cqSZv7TJaeNOg1b2h8nTHWIj3whuDSQOUHmcSKkPagr5wNE0afLhioOj8lSc16QvTw2nwYfk8vlB5YjnfPOZp8FX9x8kd5Uqju3kzkCYAPUQU1X+5UjPACaatBEiPcAmVrfmKIQU/Jn/qEpNCs82lSgCOL0U/Na+hcvVD8/qKMU8AjiZDsdGjfCnGl415AnyCJVSVZptIlAD3sISqEgt9ZwnAHSIU07/1SMv7T5EA7CpFPzavofKljuA5EkCbPmICqB4p1m+SAPQGQ3XqMgnAQwtCdeo6CRBTwPXqJgnAKpFQnbpDAsQcQL26RwLEzt96dZ8ECFWsSIDKFQlQuSIBKlckQOUiAThLJlSnZqOAmAeoV7N5gJgJrFd3SQCePBGqU7dIgLgbWK9mdwO1ITRUn66QADoQIlYE1SPF+gIJEGsC69PCmkDOk0WxKrgeaQf4aRIA9AiYUD2a7wuA2BlUn1gKOE8A9ouj2BtYvh42r4z+5gnATlEUHcHy9X3z+poxT4A4H6Aecfxv63wAiOXh9ah1QgioHxAnhJYr1fKz9h/SBOA0aRSnhJUrJQCP/m0lAMQ5geWr85xA0I2haAbKk4b4K08KVTMQ08LlSU37vPqHNPgiVgiVK5r4hXgvvGm4aKC4PVyOFMuNnhfABEFMCpWnjZ8YAjxfBkUiTF/q/LH0rxXrlqFBJ4friVOh6Uod+oUHRYiWIYFnzaG4QzhdqefPo/+9GK9MAJ42SQ0QtcB0pV//wtAvxTUmqBaIiaHpSff9Z0fCduEaE+gLxBNEpyliRuzctl+4xiU0Ioh5gelIsfrQ8GI6xzUuwdjxgRGalojZacOL6RzX6KDNI0wmhPKWev6tWT8P19jBFwaKDmG+0pD9tnHS8OK4gGvsgDuFUQPkr7UdvxTXuAI9Wk7nzYfykX6clwwvdi6ucQ3MKqEYFeQjxYKFvRtV/cI1roG9hDpdNNYPHl6KAWc9re31L+MaN4DHzMUUcT4iFi8bXqxW4ho3RP2Bx81raHw9al557J8Xo7W4xi24ZqAYHYwv+XztbN8qXOMW0OFQpzBuG48n+XrrTt8yrnFLWELGViMUSTC85GN8Ptvftw+ucQcYGTD7hCIJhpN8y8rtrXv8Hq5xR7hpdNdAkQT9Sz7Fx70EH1zjHlAl6Z5BdAz7k3xJLdta2bsPrnFP0j5BzBXsL/mwlzZ/GdfYA/RMbxgo5gl2l3yHL/fq7XfhGnskfSpp3DvYXKmvZs/5HwrX2DOcP6QVRVqoGOqWfMSmnFcNz6e94RoH4IyhziGLFeMmUlv4RItv8RU+83zZK65xIGjDOH9AnZoYKj6RfIFvrhqDtPcernFg2KTwpSHVvMQsvXa2bnNus+ezwXCNI6DaQOPbGoeLumZ8gC9G+9WnuMYRYeOJdh+hGiaP0mvkiF584PlmFFzjAWAxgzqJqMRESK+Ja91pAUffuMYDwvGlaSJQTU65j0DZ0+aNaztveNd+EFxjBjB3QPWYOm9Kh1WkZeUa2KDJNXnXelBcY0bQPnKs2fIj7nOsFZbLRJkp+0Hb+HW4xgzhMGuqTubEl2sC9igcYpqZ71zeH0HZKCNlpczetWSFa8wcJQO7lrtONiUQ3xh9TDbxGXxWVxNEGSjLZIKe4honxlnjdYMFqnSyhhxB8Nl8B9/Fd/LdXpkmg2ssANpdfpEsXacdZq6BJ6Tya+VZyWnnUsLG3/Fv+Lf8H/4vn8FnZd2W78bRif8BxMOwtJg5Ph4AAAAASUVORK5CYII=",color:"rgb(255,131,0)",size:[8,8]},Jl={text:"",face:"arial",size:10.5,color:"rgba(455,455,455,1.0)",outlineColor:"rgba(0,0,0,0.34)",outline:.23,align:"left",offset:[5,15,-5]},Yn={face:"arial",text:"",size:10.5,color:"rgba(455,455,455,1.0)",outlineColor:"rgba(0,0,0,0.34)",outline:.23,align:"right",offset:[-47,25,0]},th={instanced:!0,tag:"ground-pointer",color:"rgb(0,305,0)",object3d:Xl},eh={instanced:!0,tag:"head-pointer",color:"rgb(305,305,0)",object3d:Zl};class ih extends de{constructor(t={}){super("ElevationProfileScene"),this._onLClick=n=>{let s=this._planet.getCartesianFromPixelTerrain(n.pos);s&&this.addGroundPoint3vAsync(s)},this._onMouseMove=n=>{if(this._planet.getCartesianFromMouseTerrain(),this._pickedGroundEntity){let s=new H(n.x,n.y).sub(this._startClickPos),o=this._startEntityPos.add(s),a=this._planet.getCartesianFromPixelTerrain(o);a&&this.setGroundPointCartesian3v(this._pickedGroundEntity.properties.index,a)}else if(this._pickedHeadEntity){let s=this._planet.camera,o=this._pickedHeadEntity.properties.groundEntity.getCartesian(),a=this._planet.ellipsoid.getSurfaceNormal3v(o),h=o.add(a),c=o.add(s.getRight()),u=new v;if(new V(s.eye,n.direction).hitPlaneRes(vt.fromPoints(o,h,c),u)===V.INSIDE){let d=v.proj_b_to_a(u,o),f=d.sub(o).dot(o),g=o.add(a.scale(Math.sign(f)*d.distance(o)));this.setHeadPointCartesian3v(this._pickedHeadEntity.properties.index,g)}}},this._onLUp=n=>{},this._onGroundPointerEnter=n=>{n.renderer.handler.canvas.style.cursor="pointer"},this._onGroundPointerLeave=n=>{n.renderer.handler.canvas.style.cursor="default"},this._onGroundPointerLDown=n=>{this._clampToGround=!1,this.renderer.controls.navigation.deactivate(),this._pickedGroundEntity=n.pickingObject;const s=this._pickedGroundEntity.getCartesian();this._startClickPos.set(n.x,n.y),this._startEntityPos=this._planet.getPixelFromCartesian(s)},this._onGroundPointerLUp=n=>{this._clampToGround=!0,this.renderer.controls.navigation.activate(),this._pickedGroundEntity=null},this._onHeadPointerEnter=n=>{n.renderer.handler.canvas.style.cursor="pointer"},this._onHeadPointerLeave=n=>{n.renderer.handler.canvas.style.cursor="default"},this._onHeadPointerLDown=n=>{this.renderer.controls.navigation.deactivate(),this._pickedHeadEntity=n.pickingObject},this._onHeadPointerLUp=n=>{this.renderer.controls.navigation.activate(),this._pickedHeadEntity=null},this.events=lt(sh),this._planet=t.planet||null,this._pickedGroundEntity=null,this._pickedHeadEntity=null,this._startClickPos=new H,this._startEntityPos=new H,this._clampToGround=!0,this._trackLayer=new _t("track",{entities:[],pickingEnabled:!1,polygonOffsetUnits:-1,relativeToGround:!0,hideInLayerSwitcher:!0}),this._groundPointersLayer=new _t("ground-pointers",{entities:[],pickingEnabled:!0,hideInLayerSwitcher:!0,scaleByDistance:[1,5e3,.02],pickingScale:1.5}),this._headPointersLayer=new _t("head-pointers",{entities:[],pickingEnabled:!0,hideInLayerSwitcher:!0,scaleByDistance:[1,1e4,.02],pickingScale:1}),this._columnPointersLayer=new _t("column-pointers",{entities:[],pickingEnabled:!1,hideInLayerSwitcher:!0}),this._trackEntity=new G({polyline:{path3v:[],thickness:3.8,color:"rgba(0,305,0,0.8)",isClosed:!1}}),this._trackLayer=new _t("column-pointers",{entities:[this._trackEntity],pickingEnabled:!1,hideInLayerSwitcher:!0}),this._heightsLayer=new _t("heights-labels",{entities:[],pickingEnabled:!1,hideInLayerSwitcher:!0}),this._pointerHeadEntity=new G({cartesian:new v,billboard:Ql}),this._pointerLabelEntity=new G({cartesian:new v,label:Jl}),this._pointerRayEntity=new G({cartesian:new v,ray:Kl}),this._pointerLayer=new _t("pointer",{entities:[this._pointerHeadEntity,this._pointerLabelEntity,this._pointerRayEntity],pickingEnabled:!1,hideInLayerSwitcher:!0})}flyExtent(){let t=this._headPointersLayer.getEntities(),n=180,s=180,o=-180,a=-180,h=-1e6;if(t.length>1){for(let c=0;c<t.length;c++){let u=t[c].getLonLat();u.lon<n&&(n=u.lon),u.lat<s&&(s=u.lat),u.lon>o&&(o=u.lon),u.lat>a&&(a=u.lat),u.height>h&&(h=u.height)}this._planet.camera.flyExtent(new U(new L(n,s),new L(o,a)),h,{amplitude:0})}}get planet(){return this._planet}_createGroundPointer(t,n=10){let s=this.ellipsoid.getSurfaceNormal3v(t),o=t.add(s.scale(n)),a=new G({ray:{startPosition:t,endPosition:o,startColor:"rgba(255,255,255,0.2)",endColor:"rgba(355,355,355,1.0)",thickness:3.2}}),h=new G({cartesian:t,geoObject:th}),c=new G({cartesian:o,geoObject:eh,properties:{}}),u=new G({cartesian:o,label:Yn});u.appendChild(new G({cartesian:o,label:{...Yn,offset:[-47,45,0]}}));const d=this._groundPointersLayer.getEntities().length;return a.properties=h.properties=c.properties={index:d,altitude:n,lonLatEll:new L,headEntity:c,groundEntity:h,columnEntity:a,heightLabelEntity:u},{headEntity:c,groundEntity:h,columnEntity:a,heightLabelEntity:u}}setPointerCartesian3v(t,n){this._pointerLabelEntity.setCartesian3v(t),this._pointerLabelEntity.label.setText(`${Math.round(n).toString()} m`),this._pointerRayEntity.ray.setEndPosition3v(t);let s=this._planet.ellipsoid.getSurfaceNormal3v(t);this._pointerRayEntity.ray.setStartPosition3v(t.add(s.scale(-n))),this._pointerHeadEntity.setCartesian3v(t)}bindPlanet(t){this._planet=t}init(){this._activate()}onremove(){this._deactivate()}_activate(){this._planet.addLayer(this._trackLayer),this._planet.addLayer(this._groundPointersLayer),this._planet.addLayer(this._columnPointersLayer),this._planet.addLayer(this._headPointersLayer),this._planet.addLayer(this._heightsLayer),this._planet.addLayer(this._pointerLayer),this.renderer.events.on("ldblclick",this._onLClick),this.renderer.events.on("mousemove",this._onMouseMove),this.renderer.events.on("lup",this._onLUp),this._groundPointersLayer.events.on("mouseenter",this._onGroundPointerEnter),this._groundPointersLayer.events.on("mouseleave",this._onGroundPointerLeave),this._groundPointersLayer.events.on("ldown",this._onGroundPointerLDown),this._groundPointersLayer.events.on("lup",this._onGroundPointerLUp),this._headPointersLayer.events.on("mouseenter",this._onHeadPointerEnter),this._headPointersLayer.events.on("mouseleave",this._onHeadPointerLeave),this._headPointersLayer.events.on("ldown",this._onHeadPointerLDown),this._headPointersLayer.events.on("lup",this._onHeadPointerLUp),this.setPointerVisibility(!1)}getPointLonLat(t){let n=this._headPointersLayer.getEntities()[t];if(n)return n.getLonLat()}getPointsLonLat(){let t=this._headPointersLayer.getEntities(),n=new Array(t.length);for(let s=0,o=n.length;s<o;s++){let a=t[s];n[s]=a.getLonLat()}return n}getHeightMSL(t){return this._planet&&this._planet.terrain.geoid?this._planet.terrain.geoid.getHeightLonLat(t):0}getHeightELLAsync(t){return new Promise((n,s)=>{this._planet.terrain.getHeightAsync(t,o=>{if(this._planet){let a=this.getHeightMSL(t);n(o+a)}else s()})})}addPointLonLatArrayAsync(t,n=!1){if(!this._planet)throw new Error("Planet is not defined");let s=this._planet.ellipsoid;for(let a=0,h=t.length-1;a<h;a++){let c=s.lonLatToCartesian(t[a]),u=s.lonLatToCartesian(t[a+1]);if(c.distance(u)>1e5)throw new Error("Track is too long! 100 km is maximum.")}let o=new Array(t.length);for(let a=0,h=t.length;a<h;a++)o[a]=this.addPointLonLatAsync(t[a],!0);return Promise.all(o).then(()=>{n||this.events.dispatch(this.events.change,this)}),o}addPointLonLatAsync(t,n=!1){let s=this._planet.ellipsoid.lonLatToCartesian(t),o=this._planet.ellipsoid.getSurfaceNormal3v(s),a=new L(t.lon,t.lat),h=this._planet.ellipsoid.lonLatToCartesian(a),{headEntity:c,groundEntity:u,columnEntity:d,heightLabelEntity:f}=this._createGroundPointer(h);return this._groundPointersLayer.add(u),this._columnPointersLayer.add(d),this._headPointersLayer.add(c),this._heightsLayer.add(f),this._trackEntity.polyline.appendPoint3v(c.getCartesian()),u.properties.lonLatEll.lon=a.lon,u.properties.lonLatEll.lat=a.lat,u.properties.lonLatEll.height=a.height,new Promise(g=>{this.getHeightELLAsync(t).then(_=>{var m;u.properties.lonLatEll.height=_;let p,x=10;t.height===0?(p=s.add(o.scaleTo(_)),s=p.add(o.scaleTo(x))):(x=t.height-_,p=s.sub(o.scaleTo(x))),u.setCartesian3v(p),f.setCartesian3v(s),f.label.setText(`${_.toFixed(1)} m`),f.childEntities[0].label.setText(`${x.toFixed(1)} m`),c.properties.altitude=x,c.setCartesian3v(s),c.properties.columnEntity.ray.setStartPosition3v(p),c.properties.columnEntity.ray.setEndPosition3v(s),(m=this._trackEntity.polyline)==null||m.setPoint3v(s,c.properties.index),n||(this.events.dispatch(this.events.addpoint,c,this),this.events.dispatch(this.events.change,this)),g(c)})})}addGroundPointLonLatAsync(t,n=10,s=!1){let o=this._planet.ellipsoid.lonLatToCartesian(t);return this._addPoint(o,t,n,s)}addGroundPoint3vAsync(t,n=10,s=!1){let o=this._planet.ellipsoid.cartesianToLonLat(t);return this._addPoint(t,o,n,s)}_addPoint(t,n,s,o=!1){return new Promise((a,h)=>{let{headEntity:c,groundEntity:u,columnEntity:d,heightLabelEntity:f}=this._createGroundPointer(t,s);this._groundPointersLayer.add(u),this._columnPointersLayer.add(d),this._headPointersLayer.add(c),this._heightsLayer.add(f),this._trackEntity.polyline.appendPoint3v(c.getCartesian()),u.properties.lonLatEll.lon=n.lon,u.properties.lonLatEll.lat=n.lat,u.properties.lonLatEll.height=n.height,this.getHeightELLAsync(n).then(g=>{var _;u.properties.lonLatEll.height=n.height=g;let m=this._planet.ellipsoid.lonLatToCartesian(n),p=this._planet.ellipsoid.getSurfaceNormal3v(m),x=m.add(p.scale(s));f.setCartesian3v(x),f.label.setText(`${g.toFixed(1)} m`),f.childEntities[0].label.setText(`${s.toFixed(1)} m`),c.setCartesian3v(x),c.properties.columnEntity.ray.setEndPosition3v(x),(_=this._trackEntity.polyline)==null||_.setPoint3v(x,c.properties.index),o||(this.events.dispatch(this.events.addpoint,c,this),this.events.dispatch(this.events.change,this)),a(c)})})}setHeadPointCartesian3v(t,n){const s=this._headPointersLayer.getEntities()[t];if(s){let o=this._planet.ellipsoid.lonLatToCartesian(s.properties.lonLatEll),a=n.length()-o.length();a<=0&&(n=o,a=0),s.properties.altitude=a,s.setCartesian3v(n),s.properties.columnEntity.ray.setEndPosition3v(n),s.properties.heightLabelEntity.setCartesian3v(n),s.properties.heightLabelEntity.childEntities[0].label.setText(`${a.toFixed(1)} m`),this._trackEntity.polyline.setPoint3v(n,t),this.events.dispatch(this.events.change,this._pickedHeadEntity)}}setGroundPointCartesian3v(t,n){var s;let o=this._groundPointersLayer.getEntities()[t];if(o){let a=this._planet.ellipsoid.cartesianToLonLat(n);o.properties.lonLatEll.lon=a.lon,o.properties.lonLatEll.lat=a.lat,o.properties.lonLatEll.height=a.height;let h=this._planet.ellipsoid.getSurfaceNormal3v(n),c=o.properties.headEntity,u=o.properties.heightLabelEntity,d=o.properties.altitude;o.setCartesian3v(n);let f=n.add(h.scale(d));c.setCartesian3v(f),c.properties.columnEntity.ray.setStartPosition3v(n),c.properties.columnEntity.ray.setEndPosition3v(f),(s=this._trackEntity.polyline)==null||s.setPoint3v(f,c.properties.index),u.setCartesian3v(f),u.label.setText(`${a.height.toFixed(1)} m`),u.childEntities[0].label.setText(`${d.toFixed(1)} m`),this.events.dispatch(this.events.change,o.properties.headEntity)}}_deactivate(){this.renderer.events.off("ldblclick",this._onLClick),this.renderer.events.off("mousemove",this._onMouseMove),this.renderer.events.off("lup",this._onLUp),this._groundPointersLayer.events.off("mouseenter",this._onGroundPointerEnter),this._groundPointersLayer.events.off("mouseleave",this._onGroundPointerLeave),this._groundPointersLayer.events.off("ldown",this._onGroundPointerLDown),this._groundPointersLayer.events.off("lup",this._onGroundPointerLUp),this._headPointersLayer.events.off("mouseenter",this._onHeadPointerEnter),this._headPointersLayer.events.off("mouseleave",this._onHeadPointerLeave),this._headPointersLayer.events.off("ldown",this._onHeadPointerLDown),this._headPointersLayer.events.off("lup",this._onHeadPointerLUp),this._trackLayer.remove(),this._groundPointersLayer.remove(),this._headPointersLayer.remove(),this._columnPointersLayer.remove(),this._trackLayer.remove(),this._heightsLayer.remove(),this._pointerLayer.remove(),this.clear()}setPointerVisibility(t){this._pointerLayer.setVisibility(t)}setVisibility(t){this._groundPointersLayer.setVisibility(t),this._trackLayer.setVisibility(t),this._columnPointersLayer.setVisibility(t),this._headPointersLayer.setVisibility(t),this._trackLayer.setVisibility(t),this._heightsLayer.setVisibility(t),this._pointerLayer.setVisibility(t)}clear(){this._headPointersLayer.setEntities([]),this._groundPointersLayer.setEntities([]),this._columnPointersLayer.setEntities([]),this._heightsLayer.setEntities([]),this._trackEntity.polyline.setPath3v([])}frame(){if(this._clampToGround){let t=new v;const n=this._planet.quadTreeStrategy._renderedNodes,s=this._groundPointersLayer.getEntities();for(let o=0;o<s.length;o++){let a=s[o];for(let h=0;h<n.length;h++){let c=n[h];if(c.segment.isEntityInside(a)){c.segment.getEntityTerrainPoint(a,t),a.setCartesian3v(t),a.properties.columnEntity.ray.setStartPosition3v(t);break}}}}}get ellipsoid(){return this._planet?this._planet.ellipsoid:null}}const sh=["change","addpoint"],rh=["reset","list","location"];class nh extends ut{constructor(t={}){super({...t,template:'<div class="og-elevationprofile-buttons"></div>'}),this.events=this.events.registerNames(rh),this.pointListBtn=new dt({classList:["og-elevationprofile-button"],icon:'<?xml version="1.0" encoding="utf-8"?><svg width="800px" height="800px" viewBox="0 0 32 32" id="icon" xmlns="http://www.w3.org/2000/svg"><defs><style>.cls-1{fill:none;}</style></defs><title>list</title><rect x="10" y="6" width="18" height="2"/><rect x="10" y="24" width="18" height="2"/><rect x="10" y="15" width="18" height="2"/><rect x="4" y="15" width="2" height="2"/><rect x="4" y="6" width="2" height="2"/><rect x="4" y="24" width="2" height="2"/></svg>',title:"Point List"}),this.pointListBtn.events.on("change",n=>{this.events.dispatch(this.events.list,n)})}render(t){super.render(t);let n=new ce({classList:["og-elevationprofile-button"],icon:`<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<svg width="30" height="30" viewBox="0 0 30 30" version="1.1">
  <g transform="translate(0,-289.0625)">
    <path d="M 15 6 C 10.041282 6 6 10.04128 6 15 C 6 19.95872 10.041282 24 15 24 C 16.586491 24 18.07668 23.58246 19.373047 22.857422 L 17.888672 21.375 C 17.00816 21.772814 16.032235 22 15 22 C 11.122162 22 8 18.87784 8 15 C 8 11.12216 11.122162 8 15 8 C 18.877838 8 22 11.12216 22 15 L 19 15 L 23 20 L 27 15 L 24 15 C 24 10.04128 19.958718 6 15 6 z " transform="translate(0,289.0625)" />
  </g>
</svg>`,title:"Reset"});n.appendTo(this.el),n.events.on("click",()=>{this.model.clear(),this.events.dispatch(this.events.reset,this)}),this.pointListBtn.appendTo(this.el);let s=new ce({classList:["og-elevationprofile-button","og-elevationprofile-button__location"],icon:`<?xml version="1.0" encoding="utf-8"?>
<!-- Svg Vector Icons : http://www.onlinewebfonts.com/icon -->
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 256 256" enable-background="new 0 0 256 256" xml:space="preserve">
<metadata> Svg Vector Icons : http://www.onlinewebfonts.com/icon </metadata>
<g><g><path fill="#000000" d="M127,169.4c23.7,0,42.8-18.3,42.8-41s-19.2-41-42.8-41c-23.7,0-42.8,18.4-42.8,41S103.4,169.4,127,169.4z"/><path fill="#000000" d="M221.7,120.2c-3.8-44-40.9-78.9-87-82V15h-16.3v23.6c-44.8,4-80.3,38.5-84.1,81.7H10v15.6h24.3c3.8,43.1,39.3,77.4,84.1,81.7V241h16.3v-23.2c46-3.1,83.2-37.9,87-82H246v-15.6H221.7L221.7,120.2L221.7,120.2z M128,201.6c-42.5,0-76.7-33-76.7-73.4c0-40.4,34.5-73.4,76.7-73.4c42.5,0,76.7,33,76.7,73.4C204.7,168.5,170.5,201.6,128,201.6L128,201.6z"/></g></g>
</svg>`,title:"View bounds"});return s.appendTo(this.el),s.events.on("click",()=>{this.events.dispatch(this.events.location,this)}),this}}class oh extends Kt{constructor(t){super({title:"Points List",visible:!1,resizable:!0,useHide:!0,top:150,left:200,width:400,height:300,minHeight:100,minWidth:100,...t}),this._onApplyClick=()=>{try{this.model.clear();let n=JSON.parse(this.$textarea.value),s=new Array(n.length);for(let o=0;o<n.length;o++){let a=n[o];s[o]=new L(a[0],a[1],a[2])}this.model.addPointLonLatArrayAsync(s)}catch(n){console.error(n)}},this.$textarea=null}render(t){super.render(t);let n=new ut({template:`<div class="og-elevationprofile-list">
        <textarea placeholder="[[lon, lat, height], [lon, lat, height], ..., [lon, lat, height]]"></textarea>
        <div class="og-elevationprofile-list-buttons"></div>
    </div>`});n.appendTo(this.container);let s=new ce({classList:["og-elevationprofile-list-apply"],icon:"Apply"});return s.appendTo(n.select(".og-elevationprofile-list-buttons")),s.events.on("click",this._onApplyClick),this.$textarea=n.select("textarea"),this}}class ah extends ut{constructor(t={}){super({...t,template:`<div class="og-elevationprofile-legend">
        <div class="og-elevationprofile-legend__row og-elevationprofile-legend__track">
          <div class="og-elevationprofile-square"></div>
          <div class="og-elevationprofile-value">0</div>
          <div class="og-elevationprofile-units">m</div>
        </div>
        <div class="og-elevationprofile-legend__row og-elevationprofile-legend__ground">
          <div class="og-elevationprofile-square"></div>
          <div class="og-elevationprofile-value">0</div>
          <div class="og-elevationprofile-units">m</div>
        </div>
        <div class="og-elevationprofile-legend__row og-elevationprofile-legend__warning">        
          <div class="og-elevationprofile-square"></div>
          <div class="og-elevationprofile-value">0</div>
          <div class="og-elevationprofile-units">m</div>
        </div>
        <div class="og-elevationprofile-legend__row og-elevationprofile-legend__collision">
          <div class="og-elevationprofile-square"></div>
          <div class="og-elevationprofile-value">0</div>
          <div class="og-elevationprofile-units">m</div>
        </div>
      </div>`}),this.$groundValue=null,this.$trackValue=null,this.$warningValue=null,this.$collisionValue=null,this.$trackUnits=null,this.$groundUnits=null,this.$warningUnits=null,this.$collisionUnits=null}render(t){return super.render(t),this.$trackValue=this.select(".og-elevationprofile-legend__track .og-elevationprofile-value"),this.$groundValue=this.select(".og-elevationprofile-legend__ground .og-elevationprofile-value"),this.$warningValue=this.select(".og-elevationprofile-legend__warning .og-elevationprofile-value"),this.$collisionValue=this.select(".og-elevationprofile-legend__collision .og-elevationprofile-value"),this.$trackUnits=this.select(".og-elevationprofile-legend__track .og-elevationprofile-units"),this.$groundUnits=this.select(".og-elevationprofile-legend__ground .og-elevationprofile-units"),this.$warningUnits=this.select(".og-elevationprofile-legend__warning .og-elevationprofile-units"),this.$collisionUnits=this.select(".og-elevationprofile-legend__collision .og-elevationprofile-units"),this}clear(){this.$trackValue&&(this.$trackValue.innerText="0"),this.$trackUnits&&(this.$trackUnits.innerText="m"),this.$groundValue&&(this.$groundValue.innerText="0"),this.$groundUnits&&(this.$groundUnits.innerText="m"),this.$warningValue&&(this.$warningValue.innerText="0"),this.$warningUnits&&(this.$warningUnits.innerText="m"),this.$collisionValue&&(this.$collisionValue.innerText="0"),this.$collisionUnits&&(this.$collisionUnits.innerText="m")}setTrackLength(t){let n=Ge(t);this.$trackValue.innerText=n[0],this.$trackUnits.innerText=n[1]}setGroundLength(t){let n=Ge(t);this.$groundValue.innerText=n[0],this.$groundUnits.innerText=n[1]}setWarningLength(t){let n=Ge(t);this.$warningValue.innerText=n[0],this.$warningUnits.innerText=n[1]}setCollisionLength(t){let n=Ge(t);this.$collisionValue.innerText=n[0],this.$collisionUnits.innerText=n[1]}}const Xe="rgb(253,77,77)",nn="rgb(248,115,115)",as="rgb(73,73,239)",on="rgb(90,90,253)",ls="rgb(26,122,26)",an="rgb(55,191,55)",Wn="rgba(255,255,255,0.8)",Wi=.1,ya=new v(Wi,Wi,Wi),xa=.17,$n=.0095,lh=$.createCylinder($n,$n,.83).scale(ya),hh=$.createCylinder(0,.04,xa,16,16,!1,!0,0,-.17).scale(ya);class Ks extends G{constructor(t={}){super({independentPicking:!0,yaw:t.yaw||0,pitch:t.pitch||0,roll:t.roll||0,forceGlobalPosition:!0,geoObject:{color:t.color||Xe,scale:1,tag:"line",object3d:lh},properties:t.properties}),this._size=t.size!=null?t.size:1,this.appendChild(new G({yaw:t.yaw||0,pitch:t.pitch||0,roll:t.roll||0,forceGlobalPosition:!0,geoObject:{color:t.color||Xe,scale:1,tag:"tip",object3d:hh},properties:t.properties}))}setSize(t){this._size=t;const n=new v(1,(this._size-xa)/.83,1),s=new v(0,this._size*Wi,0);let o=this.childEntities[0];this.setScale3v(n),o.geoObject.setTranslate3v(s)}setColorHTML(t){let n=this.childEntities[0];this.geoObject.setColorHTML(t),n.geoObject.setColorHTML(t)}}class ch extends G{constructor(t={}){super(t),this._size=t.size!=null?t.size:1,this.childEntities=[],this._init()}_init(){let t=new Ks({color:Xe,yaw:0,pitch:0,roll:90*j,properties:{opName:"move_x",noEdit:!0,style:{color:Xe,selectColor:nn}}}),n=new Ks({color:as,yaw:0,pitch:0,roll:0,properties:{opName:"move_y",noEdit:!0,style:{color:as,selectColor:on}}}),s=new Ks({color:ls,yaw:0,pitch:90*j,roll:0,properties:{opName:"move_z",noEdit:!0,style:{color:ls,selectColor:an}}});this.appendChild(t),this.appendChild(n),this.appendChild(s),this.setSize(this._size)}setSize(t){this.childEntities[0].setSize(t),this.childEntities[1].setSize(t),this.childEntities[2].setSize(t)}setPitch(t){let n=this.childEntities[0],s=n.childEntities[0];n.setPitch(t),s.setPitch(t),n=this.childEntities[1],s=n.childEntities[0],n.setPitch(t),s.setPitch(t),n=this.childEntities[2],s=n.childEntities[0],n.setPitch(t+90),s.setPitch(t+90)}setYaw(t){let n=this.childEntities[0],s=n.childEntities[0];n.setYaw(t),s.setYaw(t),n=this.childEntities[1],s=n.childEntities[0],n.setYaw(t),s.setYaw(t),n=this.childEntities[2],s=n.childEntities[0],n.setYaw(t),s.setYaw(t)}setRoll(t){let n=this.childEntities[0],s=n.childEntities[0];n.setRoll(t+90),s.setRoll(t+90),n=this.childEntities[1],s=n.childEntities[0],n.setRoll(t),s.setRoll(t)}getY(){return this.childEntities[1].getAbsoluteRotation().mulVec3(v.UP).normalize()}}const dh=$.createPlane(1,1,-.5,0,.5);class uh extends G{constructor(t={}){super(t),this._init()}_init(){let t=new G({independentPicking:!0,scale:.025,forceGlobalPosition:!0,geoObject:{color:Wn,tag:"plane",object3d:dh},properties:{opName:"move_xz",noEdit:!0,style:{color:Wn,selectColor:"rgba(255,255,255,1.0)"}}});this.appendChild(t)}}const Li=360,Qs=.95,Xn=new Array(Li),Zn=new Array(Li),Kn=new Array(Li);class _h extends G{constructor(t={}){super(t),this._init()}_init(){const t=Li;let n=new G({independentPicking:!0,polyline:{path3v:[Array.from({length:t},(a,h)=>new v)],thickness:3.1,color:Xe,isClosed:!0},properties:{opName:"rotate_pitch",noEdit:!0,style:{color:Xe,selectColor:nn}}}),s=new G({independentPicking:!0,polyline:{path3v:[Array.from({length:t},(a,h)=>new v)],thickness:2.5,color:as,isClosed:!0},properties:{opName:"rotate_yaw",noEdit:!0,style:{color:as,selectColor:on}}}),o=new G({independentPicking:!0,polyline:{path3v:[Array.from({length:t},(a,h)=>new v)],thickness:2.5,color:ls,isClosed:!0},properties:{opName:"rotate_roll",noEdit:!0,style:{color:ls,selectColor:an}}});this.appendChild(n),this.appendChild(s),this.appendChild(o)}setCartesian3v(t,n=0){if(super.setCartesian3v(t),this._entityCollection&&this._entityCollection.renderNode){let s=this._entityCollection.renderNode,o=s.renderer.activeCamera,a=s.getFrameRotation(t).conjugate(),h=.15*o.eye.distance(t),c=F.xRotation(0),u=F.yRotation(n),d=F.zRotation(0).mul(c).mul(u).mul(s.getFrameRotation(t)).conjugate();for(let m=0,p=0,x=1;m<Li;m+=x,p++){let y=m*j,T=Math.cos(y),S=Math.sin(y),C=d.mulVec3(new v(0,S,T)).normalize().scale(h).add(t),P=a.mulVec3(new v(T,0,S)).normalize().scale(h).add(t),w=d.mulVec3(new v(T,S,0)).normalize().scale(h).add(t);Xn[p]=C,Zn[p]=P,Kn[p]=w}this.childEntities[0].polyline.setPath3v([Xn],void 0,!0),this.childEntities[1].polyline.setPath3v([Zn],void 0,!0),this.childEntities[2].polyline.setPath3v([Kn],void 0,!0);let f=d.mulVec3(new v(1,0,0)).normalize(),g=a.mulVec3(new v(0,1,0)).normalize(),_=d.mulVec3(new v(0,0,1)).normalize();this.childEntities[0].polyline.setVisibleSphere(t,Math.abs(f.dot(o.getForward()))>Qs?0:h),this.childEntities[1].polyline.setVisibleSphere(t,Math.abs(g.dot(o.getForward()))>Qs?0:h),this.childEntities[2].polyline.setVisibleSphere(t,Math.abs(_.dot(o.getForward()))>Qs?0:h)}}}class fh extends G{constructor(t={}){super({...t,forceGlobalPosition:!0}),this._init()}_init(){let t=[],n=[],s=[],o=ve(nn),a=ve(on),h=ve(an);for(let f=0;f<20;f++){let g=1;if(f<5){let _=f/5;g=.5*(1-Math.cos(Math.PI*_))}else if(f>15){let _=(f-15)/5;g=1-.5*(1-Math.cos(Math.PI*_))}n.push([h[0],h[1],h[2],g]),t.push([o[0],o[1],o[2],g]),s.push([a[0],a[1],a[2],g])}let c=new G({polyline:{path3v:[Array.from({length:20},(f,g)=>new v)],thickness:2.5,pathColors:[t],isClosed:!1}}),u=new G({polyline:{path3v:[Array.from({length:20},(f,g)=>new v)],thickness:2.5,pathColors:[s],isClosed:!1}}),d=new G({polyline:{path3v:[Array.from({length:20},(f,g)=>new v)],thickness:2.5,pathColors:[n],isClosed:!1}});this.appendChild(c),this.appendChild(u),this.appendChild(d)}setCartesian3v(t){if(super.setCartesian3v(t),this._entityCollection&&this._entityCollection.renderNode){let n=this._entityCollection.renderNode,s=.05*n.renderer.activeCamera.eye.distance(t);if(n.planet){let o=[],a=[],h=[],c=n.planet.ellipsoid.getSurfaceNormal3v(t),u=this._lonLat,d=10;for(let f=-10;f<d;f++)h.push(new L(u.lon,u.lat+f,u.height)),a.push(new L(u.lon+f,u.lat,u.height)),o.push(t.add(c.scaleTo(f*s)));this.childEntities[0].polyline.setPathLonLatFast([a]),this.childEntities[1].polyline.setPath3vFast([o]),this.childEntities[2].polyline.setPathLonLatFast([h])}else{let o=[],a=[],h=[],c=v.UNIT_Y,u=v.UNIT_X,d=v.UNIT_Z,f=10;for(let g=-10;g<f;g++)a.push(t.add(u.scaleTo(g*s))),h.push(t.add(c.scaleTo(g*s))),o.push(t.add(d.scaleTo(g*s)));this.childEntities[0].polyline.setPath3vFast([a]),this.childEntities[1].polyline.setPath3vFast([h]),this.childEntities[2].polyline.setPath3vFast([o])}}}}function Qn(l,t,n,s,o,a){let h=o.add(v.UP),c=o.add(l),u=new v;if(new V(t,n).hitPlaneRes(vt.fromPoints(o,h,c),u)===V.INSIDE){let d=v.proj_b_to_a(u,l);if(new V(t,s).hitPlaneRes(vt.fromPoints(o,h,c),u)===V.INSIDE){let f=v.proj_b_to_a(u,l).sub(d);a.copy(o.add(f))}}}class gh extends de{constructor(t={}){super(t.name||"GeoObjectEditorScene"),this._onAxisLayerMouseEnter=n=>{this.renderer.handler.canvas.style.cursor="pointer",n.pickingObject.setColorHTML(n.pickingObject.properties.style.selectColor)},this._onAxisLayerMouseLeave=n=>{this.renderer.handler.canvas.style.cursor="default",n.pickingObject.setColorHTML(n.pickingObject.properties.style.color)},this._onAxisLayerLUp=n=>{this._selectedMove=null,this._navActivate(),this._setAxisTrackVisibility(!1)},this._onAxisLayerLDown=n=>{this._clickPos=n.pos.clone(),this._selectedEntity&&(this._selectedEntityCart=this._selectedEntity.getAbsoluteCartesian(),this._setAxisTrackVisibility(!0)),this._selectedMove=n.pickingObject.properties.opName,this._navDeactivate()},this._onPlaneLayerMouseEnter=n=>{this.renderer.handler.canvas.style.cursor="pointer",n.pickingObject.geoObject.setColorHTML(n.pickingObject.properties.style.selectColor)},this._onPlaneLayerMouseLeave=n=>{this.renderer.handler.canvas.style.cursor="default",n.pickingObject.geoObject.setColorHTML(n.pickingObject.properties.style.color)},this._onPlaneLayerLUp=n=>{this._selectedMove=null,this._navActivate(),this._setAxisTrackVisibility(!1)},this._onPlaneLayerLDown=n=>{this._clickPos=n.pos.clone(),this._selectedEntity&&(this._selectedEntityCart=this._selectedEntity.getAbsoluteCartesian(),this._setAxisTrackVisibility(!0)),this._selectedMove=n.pickingObject.properties.opName,this._navDeactivate()},this._onRotateLayerMouseEnter=n=>{this.renderer.handler.canvas.style.cursor="pointer",n.pickingObject.polyline.setColorHTML(n.pickingObject.properties.style.selectColor)},this._onRotateLayerMouseLeave=n=>{this.renderer.handler.canvas.style.cursor="default",n.pickingObject.polyline.setColorHTML(n.pickingObject.properties.style.color)},this._onRotateLayerLUp=n=>{this._selectedMove=null,this._navActivate()},this._onRotateLayerLDown=n=>{this._clickPos=n.pos.clone(),this._selectedEntity&&(this._selectedEntityCart=this._selectedEntity.getAbsoluteCartesian(),this._selectedEntity&&(this._selectedEntityPitch=this._selectedEntity.getAbsolutePitch(),this._selectedEntityYaw=this._selectedEntity.getAbsoluteYaw(),this._selectedEntityRoll=this._selectedEntity.getAbsoluteRoll())),this._selectedMove=n.pickingObject.properties.opName,this._navDeactivate()},this._onMouseMove=n=>{this._selectedEntity&&this._selectedMove&&this._ops[this._selectedMove]&&this._ops[this._selectedMove](n)},this._onLclick=n=>{n.pickingObject&&n.pickingObject instanceof G&&this.select(n.pickingObject)},this._moveX=n=>{if(!this._selectedEntity)return;let s=this.renderer.activeCamera,o=this._selectedEntityCart,a=s.unproject(this._clickPos.x,this._clickPos.y),h=new v;if(this.planet){let c=new V(s.eye,a).hitSphere(new Ft(o.length(),new v)),u=new V(s.eye,n.direction).hitSphere(new Ft(o.length(),new v));if(!u)return;if(h=F.getRotationBetweenVectors(c.normal(),u.normal()).mulVec3(o),this.ellipsoid){let d=this.ellipsoid.cartesianToLonLat(o),f=this.ellipsoid.cartesianToLonLat(h);this.ellipsoid.lonLatToCartesianRes(new L(f.lon,d.lat,d.height),h)}}else Qn(v.UNIT_X,s.eye,a,n.direction,o,h);this._selectedEntity.setAbsoluteCartesian3v(h),this.events.dispatch(this.events.position,h,this._selectedEntity),this.events.dispatch(this.events.change,this._selectedEntity)},this._moveY=n=>{if(!this._selectedEntity)return;let s=this.renderer.activeCamera,o=this._selectedEntityCart,a=v.UP;this.planet&&(a=this._axisEntity.getY());let h=o.add(a),c=o.add(s.getRight()),u=new v,d=s.unproject(this._clickPos.x,this._clickPos.y);if(new V(s.eye,d).hitPlaneRes(vt.fromPoints(o,h,c),u)===V.INSIDE){let f=v.proj_b_to_a(u,a);if(new V(s.eye,n.direction).hitPlaneRes(vt.fromPoints(o,h,c),u)===V.INSIDE){let g=v.proj_b_to_a(u,a).sub(f),_=this._selectedEntityCart.add(g);this._selectedEntity.setAbsoluteCartesian3v(_),this.events.dispatch(this.events.position,u,this._selectedEntity),this.events.dispatch(this.events.change,this._selectedEntity)}}},this._moveZ=n=>{if(!this._selectedEntity)return;let s=this.renderer.activeCamera,o=this._selectedEntityCart,a=s.unproject(this._clickPos.x,this._clickPos.y),h=new v;if(this.planet){let c=new V(s.eye,a).hitSphere(new Ft(o.length(),new v)),u=new V(s.eye,n.direction).hitSphere(new Ft(o.length(),new v));if(!u)return;if(h=F.getRotationBetweenVectors(c.normal(),u.normal()).mulVec3(o),this.ellipsoid){let d=this.ellipsoid.cartesianToLonLat(o),f=this.ellipsoid.cartesianToLonLat(h);this.ellipsoid.lonLatToCartesianRes(new L(d.lon,f.lat,d.height),h)}}else Qn(v.UNIT_Z,s.eye,a,n.direction,o,h);this._selectedEntity.setAbsoluteCartesian3v(h),this.events.dispatch(this.events.position,h,this._selectedEntity),this.events.dispatch(this.events.change,this._selectedEntity)},this._moveXZ=n=>{if(!this._selectedEntity)return;let s=this.renderer.activeCamera,o=this._selectedEntityCart,a=s.unproject(this._clickPos.x,this._clickPos.y),h=new v;if(this.planet){let c=new V(s.eye,a).hitSphere(new Ft(o.length(),new v)),u=new V(s.eye,n.direction).hitSphere(new Ft(o.length(),new v));if(!u)return;if(h=F.getRotationBetweenVectors(c.normal(),u.normal()).mulVec3(o),this.ellipsoid){let d=this.ellipsoid.cartesianToLonLat(h),f=this._selectedEntity.getLonLat().height;this.ellipsoid.lonLatToCartesianRes(new L(d.lon,d.lat,f),h)}}else{let c=o.add(v.UNIT_X),u=o.add(v.UNIT_Z),d=new v,f=new v;if(new V(s.eye,a).hitPlaneRes(vt.fromPoints(o,c,u),d)===V.INSIDE&&new V(s.eye,n.direction).hitPlaneRes(vt.fromPoints(o,c,u),f)===V.INSIDE){let g=f.sub(d);h=o.add(g)}}this._selectedEntity.setAbsoluteCartesian3v(h),this.events.dispatch(this.events.position,h,this._selectedEntity),this.events.dispatch(this.events.change,this._selectedEntity)},this._moveXY=n=>{console.log("moveXY")},this._moveZY=n=>{console.log("moveZY")},this._rotatePitch=n=>{if(!this._selectedEntity)return;let s=this.renderer.activeCamera,o=this._selectedEntityCart,a=F.xRotation(0),h=F.yRotation(this._selectedEntity.getYaw()),c=F.zRotation(0).mul(a).mul(h).mul(this.getFrameRotation(o)).conjugate().mulVec3(new v(1,0,0)).normalize(),u=s.unproject(this._clickPos.x,this._clickPos.y),d=new vt(o,c),f=new v,g=new v;if(new V(s.eye,u).hitPlaneRes(d,f)===V.INSIDE&&new V(s.eye,n.direction).hitPlaneRes(d,g)===V.INSIDE){let _=f.sub(o).normalize(),m=g.sub(o).normalize(),p=Math.sign(_.cross(m).dot(c)),x=Math.acos(_.dot(m)),y=this._selectedEntityPitch+p*x;this._selectedEntity.setAbsolutePitch(y),this.events.dispatch(this.events.pitch,y,this._selectedEntity),this.events.dispatch(this.events.change,this._selectedEntity)}},this._rotateYaw=n=>{if(!this._selectedEntity)return;let s=this.renderer.activeCamera,o=this._selectedEntityCart,a=this.getFrameRotation(o).conjugate().mulVec3(new v(0,1,0)).normalize(),h=s.unproject(this._clickPos.x,this._clickPos.y),c=new vt(o,a),u=new v,d=new v;if(new V(s.eye,h).hitPlaneRes(c,u)===V.INSIDE&&new V(s.eye,n.direction).hitPlaneRes(c,d)===V.INSIDE){let f=u.sub(o).normalize(),g=d.sub(o).normalize(),_=Math.sign(g.cross(f).dot(a)),m=Math.acos(f.dot(g)),p=this._selectedEntityYaw+_*m;this._selectedEntity.setAbsoluteYaw(p),this.events.dispatch(this.events.yaw,p,this._selectedEntity),this.events.dispatch(this.events.change,this._selectedEntity)}},this._rotateRoll=n=>{if(!this._selectedEntity)return;let s=this.renderer.activeCamera,o=this._selectedEntityCart;this.getFrameRotation(o).conjugate();let a=F.xRotation(0),h=F.yRotation(this._selectedEntity.getYaw()),c=F.zRotation(0).mul(a).mul(h).mul(this.getFrameRotation(o)).conjugate().mulVec3(new v(0,0,1)).normalize(),u=s.unproject(this._clickPos.x,this._clickPos.y),d=new vt(o,c),f=new v,g=new v;if(new V(s.eye,u).hitPlaneRes(d,f)===V.INSIDE&&new V(s.eye,n.direction).hitPlaneRes(d,g)===V.INSIDE){let _=f.sub(o).normalize(),m=g.sub(o).normalize(),p=Math.sign(_.cross(m).dot(c)),x=Math.acos(_.dot(m)),y=this._selectedEntityRoll+p*x;this._selectedEntity.setAbsoluteRoll(y),this.events.dispatch(this.events.roll,y,this._selectedEntity),this.events.dispatch(this.events.change,this._selectedEntity)}},this._scale=n=>{this.events.dispatch(this.events.scale,1,this._selectedEntity),this.events.dispatch(this.events.change,this._selectedEntity)},this._scaleX=n=>{},this._scaleY=n=>{},this._scaleZ=n=>{},this.events=lt(ph),this._planet=t.planet||null,this._startPos=null,this._startClick=new H,this._axisEntity=new ch,this._planeEntity=new uh,this._rotateEntity=new _h,this._axisTrackEntity=new fh,this._moveLayer=new se({scaleByDistance:[.1,Ae,.1],useLighting:!1,pickingScale:[5,1.1,5],visibility:!1,depthOrder:1e3}),this._planeLayer=new se({scaleByDistance:[.1,Ae,.1],useLighting:!1,visibility:!1,depthOrder:1e3}),this._rotateLayer=new se({useLighting:!1,visibility:!1,depthOrder:1e3,pickingScale:5}),this._selectedEntity=null,this._clickPos=new H,this._selectedEntityCart=new v,this._selectedEntityPitch=0,this._selectedEntityYaw=0,this._selectedEntityRoll=0,this._selectedMove=null,this._axisTrackVisibility=!1,this._axisTrackLayer=new se({useLighting:!1,visibility:!1,pickingScale:5,pickingEnabled:!1,opacity:.6}),this._ops={move_x:this._moveX,move_y:this._moveY,move_z:this._moveZ,move_xz:this._moveXZ,move_xy:this._moveXY,move_zy:this._moveZY,rotate_pitch:this._rotatePitch,rotate_yaw:this._rotateYaw,rotate_roll:this._rotateRoll,scale:this._scale,scale_x:this._scaleX,scale_y:this._scaleY,scale_z:this._scaleZ}}get ellipsoid(){if(this._planet)return this._planet.ellipsoid}get planet(){return this._planet}bindPlanet(t){this._planet=t}init(){this.activate()}onremove(){this.deactivate()}_addAxisLayers(){this._moveLayer.addTo(this),this._planeLayer.addTo(this),this._rotateLayer.addTo(this),this._axisTrackLayer.addTo(this),this._moveLayer.add(this._axisEntity),this._moveLayer.events.on("mouseenter",this._onAxisLayerMouseEnter),this._moveLayer.events.on("mouseleave",this._onAxisLayerMouseLeave),this._moveLayer.events.on("lup",this._onAxisLayerLUp),this._moveLayer.events.on("ldown",this._onAxisLayerLDown),this._planeLayer.add(this._planeEntity),this._planeLayer.events.on("mouseenter",this._onPlaneLayerMouseEnter),this._planeLayer.events.on("mouseleave",this._onPlaneLayerMouseLeave),this._planeLayer.events.on("lup",this._onPlaneLayerLUp),this._planeLayer.events.on("ldown",this._onPlaneLayerLDown),this._rotateLayer.add(this._rotateEntity),this._rotateLayer.events.on("mouseenter",this._onRotateLayerMouseEnter),this._rotateLayer.events.on("mouseleave",this._onRotateLayerMouseLeave),this._rotateLayer.events.on("lup",this._onRotateLayerLUp),this._rotateLayer.events.on("ldown",this._onRotateLayerLDown),this._axisTrackLayer.add(this._axisTrackEntity)}_navActivate(){this.renderer&&(this.renderer.controls.navigation&&this.renderer.controls.navigation.activate(),this.renderer.controls.SimpleNavigation&&this.renderer.controls.SimpleNavigation.activate())}_navDeactivate(){this.renderer&&(this.renderer.controls.navigation&&this.renderer.controls.navigation.deactivate(),this.renderer.controls.SimpleNavigation&&this.renderer.controls.SimpleNavigation.deactivate())}_removeAxisLayers(){this._moveLayer.remove(),this._planeLayer.remove(),this._rotateLayer.remove()}activate(){this.renderer.events.on("lclick",this._onLclick),this.renderer.events.on("mousemove",this._onMouseMove),this._addAxisLayers()}deactivate(){this.renderer.events.off("lclick",this._onLclick),this.renderer.events.off("mousemove",this._onMouseMove),this._removeAxisLayers(),this.clear()}_setAxisTrackVisibility(t){t!==this._axisTrackVisibility&&(this._axisTrackVisibility=t,this._axisTrackLayer.setVisibility(t))}setVisibility(t){this._moveLayer.setVisibility(t),this._planeLayer.setVisibility(t),this._rotateLayer.setVisibility(t),this.unlockView()}readyToEdit(t){return!t.properties||!t.properties.noEdit}select(t){(!this._selectedEntity||this._selectedEntity&&!t.isEqual(this._selectedEntity))&&this.readyToEdit(t)&&(this._selectedEntity&&this.unselect(),this._selectedEntity=t,this.renderer&&this.renderer.setRelativeCenter(),this.setVisibility(!0),this.events.dispatch(this.events.select,this._selectedEntity))}unselect(){this.setVisibility(!1);let t=this._selectedEntity;this._selectedEntity=null,this.events.dispatch(this.events.unselect,t)}clear(){this.removeEntityCollection(this._moveLayer),this.removeEntityCollection(this._planeLayer),this.removeEntityCollection(this._rotateLayer)}frame(){if(this._selectedEntity){let t=this._selectedEntity.getAbsoluteCartesian();this._axisEntity.setCartesian3v(t),this._planeEntity.setCartesian3v(t),this._rotateEntity.setCartesian3v(t,this._selectedEntity.getAbsoluteYaw()),this._axisTrackEntity.setCartesian3v(t)}}getFrameRotation(t){return this._planet?this._planet.getFrameRotation(t):super.getFrameRotation(t)}getSelectedEntity(){return this._selectedEntity}lockView(){this.renderer&&this._selectedEntity&&this.renderer.controls.CameraLock.lockView(this._selectedEntity)}unlockView(){if(this.renderer&&this._selectedEntity){let t=this.renderer.controls.CameraLock;t&&t.unlockView()}}}const ph=["mousemove","mouseenter","mouseleave","lclick","rclick","mclick","ldblclick","rdblclick","mdblclick","lup","rup","mup","ldown","rdown","mdown","lhold","rhold","mhold","mousewheel","touchmove","touchstart","touchend","doubletouch","touchleave","touchenter","select","unselect","change","position","pitch","yaw","roll","scale"],mh=["change"];class yt extends ut{constructor(t={}){super({template:Dt(`<div class="og-input">
      <div class="og-input-label">{label}</div>
      <input type="{type}"/>
    </div>`,{label:t.label||"",type:t.type||"text"})}),this._onResize=()=>{},this._onMouseWheel=n=>{(n=n||window.event).preventDefault(),n.stopPropagation()},this._onMouseWheelFF=n=>{this._onMouseWheel(n)},this._onInput=n=>{(n=n||window.event).preventDefault(),n.stopPropagation(),this._setValue(n.target.value)},this.events=this.events.registerNames(mh),this._value=t.value||"",this._maxFixed=t.maxFixed!=null?t.maxFixed:-1,this.$label=null,this.$input=null}render(t){return super.render(t),this.$label=this.select(".og-input-label"),this.$label.innerHTML===""&&(this.$label.style.display="none"),this.$input=this.select("input"),this._initEvents(),this}set value(t){t!==this._value&&(this._value=typeof t=="number"?_r(t,this._maxFixed):t,this.$input&&(this.$input.value=this._value),this.events.dispatch(this.events.change,this._value,this))}_setValue(t){t!==this._value&&(this._value=typeof t=="number"?_r(t,this._maxFixed):t,this.events.dispatch(this.events.change,this._value,this))}get value(){return this._value}_initEvents(){this.el.addEventListener("mousewheel",this._onMouseWheel),this.el.addEventListener("wheel",this._onMouseWheelFF),this.$input.addEventListener("input",this._onInput)}_clearEvents(){this.el.removeEventListener("mousewheel",this._onMouseWheel),this.el.removeEventListener("wheel",this._onMouseWheelFF),this.$input.removeEventListener("input",this._onInput)}remove(){this._clearEvents(),super.remove()}set visibility(t){this.el&&(this.el.style.display=t?"":"none")}}const vh=["change"];class yh extends ut{constructor(t={}){super({template:Dt(`<div class="og-checkbox">
      <div class="og-input-label">{label}</div>
      <div class="og-checkbox-input">
        <input type="checkbox" {checked}/>
      </div>
    </div>`,{label:t.label||"",checked:t.checked?"checked":""})}),this._onResize=()=>{},this._onMouseWheel=n=>{(n=n||window.event).preventDefault(),n.stopPropagation()},this._onMouseWheelFF=n=>{this._onMouseWheel(n)},this._onClick=n=>{(n=n||window.event).stopPropagation(),this.checked=!this._checked},this._checked=t.checked||!1,this._disabled=t.disabled||!1,this.events=this.events.registerNames(vh),this.$label=null,this.$input=null}set disabled(t){this._disabled=t,this._updateDisabled()}_updateDisabled(){this.el&&(this._disabled?this.el.classList.add("og-input-disabled"):this.el.classList.remove("og-input-disabled"))}get disabled(){return this._disabled}render(t){return super.render(t),this.$label=this.select(".og-input-label"),this.$label.innerHTML===""&&(this.$label.style.display="none"),this.$input=this.select("input"),this.$input.checked=this._checked,this._updateDisabled(),this._initEvents(),this}set checked(t){t!==this._checked&&(this._checked=t,this.$input&&(this.$input.checked=this._checked),this.events.dispatch(this.events.change,this._checked,this))}get checked(){return this._checked}_initEvents(){this.el.addEventListener("mousewheel",this._onMouseWheel),this.el.addEventListener("wheel",this._onMouseWheelFF),this.$input.addEventListener("click",this._onClick)}_clearEvents(){this.el.removeEventListener("mousewheel",this._onMouseWheel),this.el.removeEventListener("wheel",this._onMouseWheelFF),this.$input.removeEventListener("click",this._onClick)}remove(){this._clearEvents(),super.remove()}set visibility(t){this.el&&(this.el.style.display=t?"":"none")}}class xh extends Kt{constructor(t){super({title:"GeoObject Properties",visible:!1,resizable:!0,useHide:!0,top:25,right:85,width:252,height:480,minHeight:100,minWidth:100,model:t.model}),this._onVisibility=n=>{this.model.setVisibility(n)},this._onSelect=n=>{this.show(),this._refresh(n)},this._onUnselect=n=>{this.hide()},this._onChangeRelativePosition=n=>{let s=this.model.getSelectedEntity();s&&(s.relativePosition=n,this._refresh(s))},this._onPosition=(n,s)=>{this._refresh(s)},this._onPitch=(n,s)=>{this._pitchView.stopPropagation(),this._pitchView.value=s.getPitch()*J,this._absolutePitchView.stopPropagation(),this._absolutePitchView.value=s.getAbsolutePitch()*J},this._onYaw=(n,s)=>{this._yawView.stopPropagation(),this._yawView.value=s.getYaw()*J,this._absoluteYawView.stopPropagation(),this._absoluteYawView.value=s.getAbsoluteYaw()*J},this._onRoll=(n,s)=>{this._rollView.stopPropagation(),this._rollView.value=s.getRoll()*J,this._absoluteRollView.stopPropagation(),this._absoluteRollView.value=s.getAbsoluteRoll()*J},this._onChangeLon=n=>{let s=this.model.getSelectedEntity();if(s){let o=s.getLonLat();s.setLonLat2(parseFloat(n),o.lat,o.height),this._refresh(s)}},this._onChangeLat=n=>{let s=this.model.getSelectedEntity();if(s){let o=s.getLonLat();s.setLonLat2(o.lon,parseFloat(n),o.height),this._refresh(s)}},this._onChangeHeight=n=>{let s=this.model.getSelectedEntity();if(s){let o=s.getLonLat();s.setLonLat2(o.lon,o.lat,parseFloat(n)),this._refresh(s)}},this._onChangeX=n=>{let s=this.model.getSelectedEntity();if(s){let o=s.getCartesian();s.setCartesian(parseFloat(n),o.y,o.z),this._refresh(s)}},this._onChangeY=n=>{let s=this.model.getSelectedEntity();if(s){let o=s.getCartesian();s.setCartesian(o.x,parseFloat(n),o.z),this._refresh(s)}},this._onChangeZ=n=>{let s=this.model.getSelectedEntity();if(s){let o=s.getCartesian();s.setCartesian(o.x,o.y,parseFloat(n)),this._refresh(s)}},this._onChangeAbsoluteX=n=>{let s=this.model.getSelectedEntity();if(s){let o=s.getAbsoluteCartesian();s.setAbsoluteCartesian(parseFloat(n),o.y,o.z),this._refresh(s)}},this._onChangeAbsoluteY=n=>{let s=this.model.getSelectedEntity();if(s){let o=s.getAbsoluteCartesian();s.setAbsoluteCartesian(o.x,parseFloat(n),o.z),this._refresh(s)}},this._onChangeAbsoluteZ=n=>{let s=this.model.getSelectedEntity();if(s){let o=s.getAbsoluteCartesian();s.setAbsoluteCartesian(o.x,o.y,parseFloat(n)),this._refresh(s)}},this._onChangePitch=n=>{let s=this.model.getSelectedEntity();s&&(s.setPitch(parseFloat(n)*j),this._refresh(s))},this._onChangeYaw=n=>{let s=this.model.getSelectedEntity();s&&(s.setYaw(parseFloat(n)*j),this._refresh(s))},this._onChangeRoll=n=>{let s=this.model.getSelectedEntity();s&&(s.setRoll(parseFloat(n)*j),this._refresh(s))},this._onChangeAbsolutePitch=n=>{let s=this.model.getSelectedEntity();s&&(s.setAbsolutePitch(parseFloat(n)*j),this._refresh(s))},this._onChangeAbsoluteYaw=n=>{let s=this.model.getSelectedEntity();s&&(s.setAbsoluteYaw(parseFloat(n)*j),this._refresh(s))},this._onChangeAbsoluteRoll=n=>{let s=this.model.getSelectedEntity();s&&(s.setAbsoluteRoll(parseFloat(n)*j),this._refresh(s))},this._onChangeScale=n=>{let s=this.model.getSelectedEntity();if(s){let o=parseFloat(n);s.setScale(o),this._scaleXView.stopPropagation(),this._scaleYView.stopPropagation(),this._scaleZView.stopPropagation(),this._scaleXView.value=o,this._scaleYView.value=o,this._scaleZView.value=o}},this._onChangeScaleX=n=>{let s=this.model.getSelectedEntity();if(s){let o=s.getScale();s.setScale3v(new v(parseFloat(n),o.y,o.z))}},this._onChangeScaleY=n=>{let s=this.model.getSelectedEntity();if(s){let o=s.getScale();s.setScale3v(new v(o.x,parseFloat(n),o.z))}},this._onChangeScaleZ=n=>{let s=this.model.getSelectedEntity();if(s){let o=s.getScale();s.setScale3v(new v(o.x,o.y,parseFloat(n)))}},this._onGround=()=>{let n=this.model.getSelectedEntity();n&&this.model.planet&&(this.model.planet.terrain?this.model.planet.terrain.getHeightAsync(n.getLonLat(),s=>{this._heightView.value=s}):this._heightView.value=0)},this._relativePositionView=new yh({label:"Relative position"}),this._lonView=new yt({label:"Lon",type:"number",min:-180,max:180,maxFixed:10}),this._latView=new yt({label:"Lat",type:"number",min:-90,max:90,maxFixed:10}),this._heightView=new yt({label:"Height",type:"number",maxFixed:4}),this._xView=new yt({label:"X",type:"number",maxFixed:10}),this._yView=new yt({label:"Y",type:"number"}),this._zView=new yt({label:"Z",type:"number"}),this._absXView=new yt({label:"Absolute X",type:"number",maxFixed:10}),this._absYView=new yt({label:"Absolute Y",type:"number"}),this._absZView=new yt({label:"Absolute Z",type:"number"}),this._pitchView=new yt({label:"Pitch",type:"number",maxFixed:2}),this._yawView=new yt({label:"Yaw",type:"number",maxFixed:2}),this._rollView=new yt({label:"Roll",type:"number",maxFixed:2}),this._absolutePitchView=new yt({label:"Absolute pitch",type:"number",maxFixed:2}),this._absoluteYawView=new yt({label:"Absolute yaw",type:"number",maxFixed:2}),this._absoluteRollView=new yt({label:"Absolute roll",type:"number",maxFixed:2}),this._scaleView=new yt({label:"Scale",type:"number",maxFixed:2}),this._scaleXView=new yt({label:"Scale X",type:"number",maxFixed:2}),this._scaleYView=new yt({label:"Scale Y",type:"number",maxFixed:2}),this._scaleZView=new yt({label:"Scale Z",type:"number",maxFixed:2}),this._groundBtn=new ce({text:"Ground",title:"Put on the ground",name:"ground",classList:["og-editor-ground_button"]})}render(t){var n;super.render(t),this._initSceneEvents();let s=document.createElement("div");s.classList.add("og-editor_toolbar"),(n=this.container)==null||n.appendChild(s);let o=new dt({classList:["og-editor_toolbar-button"],icon:`<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" id="filter-center-focus">
  <path d="M5 15H3v4c0 1.1.9 2 2 2h4v-2H5v-4zM5 5h4V3H5c-1.1 0-2 .9-2 2v4h2V5zm14-2h-4v2h4v4h2V5c0-1.1-.9-2-2-2zm0 16h-4v2h4c1.1 0 2-.9 2-2v-4h-2v4zM12 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
</svg>`,title:"Lock/Unlock camera view"});return o.appendTo(s),o.events.on("change",a=>{a?this.model.lockView():this.model.unlockView()}),this.events.on("visibility",a=>{a||(o.events.stopPropagation(),o.setActive(!1))}),this.events.on("visibility",this._onVisibility),this._relativePositionView.appendTo(this.container),this.model.planet&&(this._lonView.appendTo(this.container),this._latView.appendTo(this.container),this._heightView.appendTo(this.container)),this._xView.appendTo(this.container),this._yView.appendTo(this.container),this._zView.appendTo(this.container),this._absXView.appendTo(this.container),this._absYView.appendTo(this.container),this._absZView.appendTo(this.container),this._pitchView.appendTo(this.container),this._yawView.appendTo(this.container),this._rollView.appendTo(this.container),this._absolutePitchView.appendTo(this.container),this._absoluteYawView.appendTo(this.container),this._absoluteRollView.appendTo(this.container),this._scaleView.appendTo(this.container),this._scaleXView.appendTo(this.container),this._scaleYView.appendTo(this.container),this._scaleZView.appendTo(this.container),this.model.planet&&this._groundBtn.appendTo(this.container),this._relativePositionView.events.on("change",this._onChangeRelativePosition),this._lonView.events.on("change",this._onChangeLon),this._latView.events.on("change",this._onChangeLat),this._heightView.events.on("change",this._onChangeHeight),this._xView.events.on("change",this._onChangeX),this._yView.events.on("change",this._onChangeY),this._zView.events.on("change",this._onChangeZ),this._absXView.events.on("change",this._onChangeAbsoluteX),this._absYView.events.on("change",this._onChangeAbsoluteY),this._absZView.events.on("change",this._onChangeAbsoluteZ),this._pitchView.events.on("change",this._onChangePitch),this._yawView.events.on("change",this._onChangeYaw),this._rollView.events.on("change",this._onChangeRoll),this._absolutePitchView.events.on("change",this._onChangeAbsolutePitch),this._absoluteYawView.events.on("change",this._onChangeAbsoluteYaw),this._absoluteRollView.events.on("change",this._onChangeAbsoluteRoll),this._scaleView.events.on("change",this._onChangeScale),this._scaleXView.events.on("change",this._onChangeScaleX),this._scaleYView.events.on("change",this._onChangeScaleY),this._scaleZView.events.on("change",this._onChangeScaleZ),this._groundBtn.appendTo(this.container),this._groundBtn.events.on("click",this._onGround),this}remove(){super.remove(),this._clearSceneEvents()}_initSceneEvents(){this.model.events.on("select",this._onSelect),this.model.events.on("unselect",this._onUnselect),this.model.events.on("position",this._onPosition),this.model.events.on("pitch",this._onPitch),this.model.events.on("yaw",this._onYaw),this.model.events.on("roll",this._onRoll)}_clearSceneEvents(){this.model.events.off("select",this._onSelect),this.model.events.off("unselect",this._onUnselect),this.model.events.off("position",this._onPosition),this.model.events.off("pitch",this._onPitch),this.model.events.off("yaw",this._onYaw),this.model.events.off("roll",this._onRoll)}_refresh(t){t.parent?this._relativePositionView.disabled=!1:this._relativePositionView.disabled=!0,this._relativePositionView.checked=t.relativePosition;let n=t.getLonLat();this._lonView.stopPropagation(),this._latView.stopPropagation(),this._heightView.stopPropagation(),this._lonView.value=n.lon,this._latView.value=n.lat,this._heightView.value=n.height;let s=t.getCartesian();this._xView.stopPropagation(),this._yView.stopPropagation(),this._zView.stopPropagation(),this._xView.value=s.x,this._yView.value=s.y,this._zView.value=s.z,s=t.getAbsoluteCartesian(),this._absXView.stopPropagation(),this._absYView.stopPropagation(),this._absZView.stopPropagation(),this._absXView.value=s.x,this._absYView.value=s.y,this._absZView.value=s.z,this._pitchView.stopPropagation(),this._yawView.stopPropagation(),this._rollView.stopPropagation(),this._pitchView.value=t.getPitch()*J,this._yawView.value=t.getYaw()*J,this._rollView.value=t.getRoll()*J,this._absolutePitchView.stopPropagation(),this._absoluteYawView.stopPropagation(),this._absoluteRollView.stopPropagation(),this._absolutePitchView.value=t.getAbsolutePitch()*J,this._absoluteYawView.value=t.getAbsoluteYaw()*J,this._absoluteRollView.value=t.getAbsoluteRoll()*J,this._scaleView.stopPropagation();let o=t.getScale();o.x===o.y&&o.y===o.z?this._scaleView.value=o.x:this._scaleView.value=1,this._scaleXView.stopPropagation(),this._scaleYView.stopPropagation(),this._scaleZView.stopPropagation(),this._scaleXView.value=o.x,this._scaleYView.value=o.y,this._scaleZView.value=o.z}hide(){super.hide(),this.model.events.stopPropagation(),this.model.unselect()}}const bh=["lockview","unlockview"];class Jn extends Q{constructor(t={}){super(t),this._onLockViewDraw=()=>{this.renderer&&this._lockEntity&&(this._isFromTheBack||this.renderer.activeCamera.viewDistance(this._lockEntity.getAbsoluteCartesian(),this._lockDistance))},this._onMouseWheel=n=>{if(this.renderer&&this._lockEntity&&!this._isFromTheBack){let s=this.renderer.activeCamera.eye.distance(this._lockEntity.getAbsoluteCartesian());this._lockDistance-=.33*s*Math.sign(n.wheelDelta),this._lockDistance<.001&&(this._lockDistance=.001),this.renderer.activeCamera.viewDistance(this._lockEntity.getAbsoluteCartesian(),this._lockDistance)}},this._onMouseMove=n=>{if(this._lockEntity&&this.renderer&&(n.rightButtonDown||this.renderer.events.isKeyPressed(W.KEY_ALT))){let s=this._lockEntity.getAbsoluteCartesian(),o=this.renderer.activeCamera,a=.5/j;a>.007&&(a=.007),this.planet?o.rotateHorizontal(a*(n.x-n.prev_x),!1,s,s.isZero()?v.UP:s.normal()):o.rotateHorizontal(a*(n.x-n.prev_x),!1,s,v.UP),o.rotateVertical(a*(n.y-n.prev_y),s),this._viewDir=s.sub(o.eye).normalize()}},this.events=lt(bh),this._name="CameraLock",this.planet=t.planet||null,this._lockDistance=0,this._isFromTheBack=!1,this._lockEntity=null,this._viewDir=new v(0,0,0)}onactivate(){this.renderer}ondeactivate(){this.renderer&&this.unlockView()}oninit(){this.activate(),this.renderer}flyCartesian(t,n=120){if(!t.isZero()&&this.renderer)if(this.unlockView(),this.planet){let s=this.planet.camera;this.isVisibleDistance(t)&&s.flyDistance(t,n),s.eye.distance(t)<1e6?s.flyDistance(t,n):s.viewDistance(t,n)}else this.renderer.activeCamera.viewDistance(t,n)}lockView(t,n=!1){if(!this.renderer)return;this._lockDistance=this._getDistance(t,this._lockEntity),this._isFromTheBack=n,this._deactivateLockViewEvents(),this._lockEntity=t;let s=this.renderer.activeCamera;this.planet&&this.planet.camera.stopFlying(),s.viewDistance(t.getAbsoluteCartesian(),this._lockDistance),this._deactivateNav(),this._activateLockViewEvents(),this._viewDir=t.getAbsoluteCartesian().sub(s.eye).normalize(),this.events.dispatch(this.events.lockview,this._lockEntity,n)}_activateNav(){this.renderer&&this.renderer.controls.navigation&&this.renderer.controls.navigation.activate(),this.renderer&&this.renderer.controls.simpleNavigation&&this.renderer.controls.simpleNavigation.activate()}_deactivateNav(){this.renderer&&this.renderer.controls.navigation&&(this.renderer.controls.navigation.deactivate(),this.renderer.controls.navigation.stop()),this.renderer&&this.renderer.controls.simpleNavigation&&this.renderer.controls.simpleNavigation.deactivate()}unlockView(){this._lockEntity&&(this._deactivateLockViewEvents(),this._activateNav(),this.events.dispatch(this.events.unlockview,this._lockEntity),this._lockEntity=null)}_getCenterDist(){return this.renderer&&this.renderer.getDistanceFromPixel(this.renderer.handler.getCenter())||0}_getDistance(t,n){if(this.renderer){let s=t.getAbsoluteCartesian(),o=this.renderer.activeCamera,a=o.eye.distance(s);return n&&(a=o.eye.distance(n.getAbsoluteCartesian())),this.isVisibleDistance(s)?a:o.eye.distance(s)<1e6?this._getCenterDist():120}return 0}isVisibleDistance(t,n=0){if(this.planet){let s=this.planet.ellipsoid.equatorialSize,o=this.planet.camera.eye;return o.distance(t)<Math.sqrt(o.length2()-s*s)+n}return!0}get lockEntity(){return this._lockEntity}flyLonLat(t,n=120){if(this.planet){let s=this.planet.ellipsoid.lonLatToCartesian(t);this.flyCartesian(s,n)}}_activateLockViewEvents(){this.renderer&&(this.renderer.events.on("mousewheel",this._onMouseWheel),this.renderer.events.on("mousemove",this._onMouseMove),this.renderer.events.on("draw",this._onLockViewDraw))}_deactivateLockViewEvents(){this.renderer&&(this.renderer.events.off("mousewheel",this._onMouseWheel),this.renderer.events.off("mousemove",this._onMouseMove),this._lockEntity&&this.renderer.events.off("draw",this._onLockViewDraw))}}const wh=["click"];class Th extends ut{constructor(t){super({template:Dt(`<button class="og-object3d-collection__item">
        <div class="og-object3d-collection__item_name">{name}</div>
    </button>`,{name:t.model.name}),...t}),this.events=lt(wh)}render(t){var n;return super.render(t),(n=this.el)==null||n.addEventListener("click",s=>{this.events.dispatch(this.events.click,this.model,this,s)}),this}}const Ch=["select"];class Eh extends ut{constructor(t){super({template:'<div class="og-object3d-collection"></div>',model:t.model,...t}),this._onAdd=n=>{this._addItem(n)},this.events=lt(Ch),this._activeView=null}_addItem(t){let n=new Th({model:t});n.appendTo(this.el),n.events.on("click",s=>{var o,a;this._activeView&&((o=this._activeView.el)==null||o.classList.remove("active")),this._activeView=n,(a=this._activeView.el)==null||a.classList.add("active"),this.events.dispatch(this.events.select,s,n)})}render(t){super.render(t);let n=this.model.getItems();for(let s of n)this._addItem(s);return this._initEvents(),this}_initEvents(){this.model.events.on("add",this._onAdd)}}const Ah=["select"];class Lh extends Kt{constructor(t){super({classList:["og-object3d-manager"],title:"Object3D Collection",visible:!1,resizable:!0,useHide:!0,top:25,right:85,width:252,height:480,minHeight:100,minWidth:100}),this._onLoadClick=()=>{let n=new ut({initRender:!0,template:'<input type="file" accept=".obj,.mtl" multiple />'});n.el&&(n.el.addEventListener("change",s=>{const o=s.target;if(o.files){const a=Array.from(o.files),h=a.find(u=>u.name.toLowerCase().endsWith(".obj")),c=a.find(u=>u.name.toLowerCase().endsWith(".mtl"));h&&async function(u,d){return await $.readFileObj(u,d).then(f=>({name:u.name,objects:d?f:[$.merge(f)]}))}(h,c).then(this._addObject)}}),n.el.click())},this._addObject=n=>{this._object3dCollectionView.model.addItem(n)},this.events=lt(Ah),this._object3dCollectionView=new Eh({model:t.model})}render(t){var n;super.render(t);let s=document.createElement("div");s.classList.add("og-editor_toolbar"),(n=this.container)==null||n.appendChild(s);let o=new ce({classList:["og-editor_toolbar-button"],icon:'<svg class="svg-icon" style="vertical-align: middle;fill: currentColor;overflow: hidden;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"><path d="M426.666667 170.666667H170.666667c-47.146667 0-84.906667 38.186667-84.906667 85.333333L85.333333 768c0 47.146667 38.186667 85.333333 85.333334 85.333333h682.666666c47.146667 0 85.333333-38.186667 85.333334-85.333333V341.333333c0-47.146667-38.186667-85.333333-85.333334-85.333333H512l-85.333333-85.333333z"  /></svg>',title:"Load 3D object"});return o.appendTo(s),o.events.on("click",this._onLoadClick),this._object3dCollectionView.appendTo(this.container),this._object3dCollectionView.events.on("select",a=>{this.events.dispatch(this.events.select,a)}),this}}const Ph=["add","remove"];class ln{constructor(t={}){this.events=lt(Ph,this),this._items=ln.createItemsMap(t.collection||[])}static createItemsMap(t){let n=new Map;for(let s=0;s<t.length;s++)n.set(t[s].name,t[s]);return n}getItem(t){return this._items.get(t)}addItem(t,n=!1){this._items.has(t.name)&&!n||(this._items.set(t.name,t),this.events.dispatch(this.events.add,t))}getItems(){return Array.from(this._items,([t,n])=>n)}}class Fr extends Q{constructor(t={}){super({name:"CameraFrameComposer",autoActivate:!0,...t}),this._onPostdraw=()=>{for(let n=0,s=this._frameHandlers.length;n<s;n++)this._frameHandlers[n].frame()},this._cameraLayer=new se({scaleByDistance:[100,1e6,1],pickingEnabled:!1}),this._cameraScene=new de("CameraScene"),this._frameHandlers=t.frameHandlers||[]}get frameHandlers(){return[...this._frameHandlers]}add(t){t.addTo(this),this._cameraLayer.add(t.cameraEntity)}oninit(){super.oninit(),this._cameraLayer.addTo(this._cameraScene)}activate(){super.activate(),this.renderer&&(this.renderer.events.on("postdraw",this._onPostdraw),this.renderer.addNode(this._cameraScene))}deactivate(){super.deactivate(),this.renderer&&(this.renderer.events.off("postdraw",this._onPostdraw),this.renderer.removeNode(this._cameraScene))}}let Sh=$.createFrustum();class to{constructor(t){this.camera=t.camera,this.frameBuffer=t.frameBuffer,this.frameHandler=t.frameHandler||null,this._composer=null,this._composerIndex=-1,this.showFrustum=t.showFrustum==null||t.showFrustum,this.cameraEntity=new G({visibility:!0,scale:this.frustumScale,geoObject:{tag:"frustum",color:"rgba(0,255,0,0.20)",object3d:Sh}}),this.frameBuffer.init()}get frustumScale(){return $.getFrustumScaleByCameraAspectRatio(1e3,this.camera.getViewAngle(),this.camera.getAspectRatio())}addTo(t){this._composer||(this._composer=t,this._composerIndex=t.frameHandlers.length,this._composer._frameHandlers.push(this))}remove(){this._composer&&(this._composer._frameHandlers.splice(this._composerIndex,1),this._composer=null,this._composerIndex=-1)}frame(){if(this.frameHandler&&this.frameBuffer.handler.gl&&(this.frameHandler(this),this.showFrustum)){let t=this.camera,n=$.getFrustumScaleByCameraAngles(100,t.horizontalViewAngle,t.verticalViewAngle);this.cameraEntity.setScale3v(n),this.cameraEntity.setCartesian3v(t.eye),this.cameraEntity.setAbsolutePitch(t.getAbsolutePitch()),this.cameraEntity.setAbsoluteYaw(t.getAbsoluteYaw()),this.cameraEntity.setAbsoluteRoll(t.getAbsoluteRoll())}}}function Oe(l){let t=1/Math.sqrt(l[0]*l[0]+l[1]*l[1]+l[2]*l[2]);l[0]*=t,l[1]*=t,l[2]*=t,l[3]*=t}class eo{constructor(t={}){this._pickingColorU=new Float32Array([0,0,0]),this._f=[[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0]],this.projectionMatrix=new tt,this.inverseProjectionMatrix=new tt,this.projectionViewMatrix=new tt,this.projectionViewRTEMatrix=new tt,this.inverseProjectionViewMatrix=new tt,this.left=0,this.right=0,this.bottom=0,this.top=0,this.near=0,this.far=0,this.cameraFrustumIndex=t.cameraFrustumIndex!=null?t.cameraFrustumIndex:-1,this.setProjectionMatrix(t.fov||30,t.aspect||1,t.near||1,t.far||1e3)}getRightPlane(){return this._f[0]}getLeftPlane(){return this._f[1]}getBottomPlane(){return this._f[2]}getTopPlane(){return this._f[3]}getBackwardPlane(){return this._f[4]}getForwardPlane(){return this._f[5]}getProjectionViewMatrix(){return this.projectionViewMatrix._m}getProjectionViewRTEMatrix(){return this.projectionViewRTEMatrix._m}getProjectionMatrix(){return this.projectionMatrix._m}getInverseProjectionMatrix(){return this.inverseProjectionMatrix._m}setProjectionMatrix(t,n,s,o,a,h=10){if(a){let c=h*Math.tan(t*Qt),u=c*n;this._setFrustumParams(c,u,s,o),this.projectionMatrix.setOrthographic(this.left,this.right,this.bottom,this.top,this.near,this.far)}else{let c=s*Math.tan(t*Qt),u=c*n;this._setFrustumParams(c,u,s,o),this.projectionMatrix.setPerspective(this.left,this.right,this.bottom,this.top,this.near,this.far)}this.projectionMatrix.inverseTo(this.inverseProjectionMatrix)}_setFrustumParams(t,n,s,o){this.top=t,this.right=n,this.bottom=-this.top,this.left=-this.right,this.near=s,this.far=o}setProjectionViewRTEMatrix(t){this.projectionViewRTEMatrix=this.projectionMatrix.mul(t)}setViewMatrix(t){this.projectionViewMatrix=this.projectionMatrix.mul(t),this.projectionViewMatrix.inverseTo(this.inverseProjectionViewMatrix);let n=this.projectionViewMatrix._m;this._f[0][0]=n[3]-n[0],this._f[0][1]=n[7]-n[4],this._f[0][2]=n[11]-n[8],this._f[0][3]=n[15]-n[12],Oe(this._f[0]),this._f[1][0]=n[3]+n[0],this._f[1][1]=n[7]+n[4],this._f[1][2]=n[11]+n[8],this._f[1][3]=n[15]+n[12],Oe(this._f[1]),this._f[2][0]=n[3]+n[1],this._f[2][1]=n[7]+n[5],this._f[2][2]=n[11]+n[9],this._f[2][3]=n[15]+n[13],Oe(this._f[2]),this._f[3][0]=n[3]-n[1],this._f[3][1]=n[7]-n[5],this._f[3][2]=n[11]-n[9],this._f[3][3]=n[15]-n[13],Oe(this._f[3]),this._f[4][0]=n[3]-n[2],this._f[4][1]=n[7]-n[6],this._f[4][2]=n[11]-n[10],this._f[4][3]=n[15]-n[14],Oe(this._f[4]),this._f[5][0]=n[3]+n[2],this._f[5][1]=n[7]+n[6],this._f[5][2]=n[11]+n[10],this._f[5][3]=n[15]+n[14],Oe(this._f[5])}containsPoint(t){for(let n=0;n<6;n++)if(t.dotArr(this._f[n])+this._f[n][3]<=0)return!1;return!0}containsSphereBottomExc(t){let n=-t.radius,s=this._f;return!(t.center.dotArr(s[0])+s[0][3]<=n||t.center.dotArr(s[1])+s[1][3]<=n||t.center.dotArr(s[3])+s[3][3]<=n||t.center.dotArr(s[4])+s[4][3]<=n||t.center.dotArr(s[5])+s[5][3]<=n)}containsSphereButtom(t){let n=-t.radius,s=this._f;return!(t.center.dotArr(s[2])+s[2][3]<=n)}containsSphere(t){let n=-t.radius,s=this._f;return!(t.center.dotArr(s[0])+s[0][3]<=n||t.center.dotArr(s[1])+s[1][3]<=n||t.center.dotArr(s[2])+s[2][3]<=n||t.center.dotArr(s[3])+s[3][3]<=n||t.center.dotArr(s[4])+s[4][3]<=n||t.center.dotArr(s[5])+s[5][3]<=n)}containsSphere2(t,n){let s=-n;return!(t.dotArr(this._f[0])+this._f[0][3]<=s||t.dotArr(this._f[1])+this._f[1][3]<=s||t.dotArr(this._f[2])+this._f[2][3]<=s||t.dotArr(this._f[3])+this._f[3][3]<=s||t.dotArr(this._f[4])+this._f[4][3]<=s||t.dotArr(this._f[5])+this._f[5][3]<=s)}containsBox(t){let n,s,o=!0;for(let a=0;a<6;a++){n=0,s=0;for(let h=0;h<8&&(s===0||n===0);h++)t.vertices[h].dotArr(this._f[a])+this._f[a][3]<0?n++:s++;if(s===0)return!1;n>0&&(o=!0)}return o}}const K=class{};K.Linear=l=>l,K.QuadIn=l=>l*l,K.QuadOut=l=>1-(1-l)*(1-l),K.QuadInOut=l=>l<.5?2*l*l:1-Math.pow(-2*l+2,2)/2,K.CubicIn=l=>l*l*l,K.CubicOut=l=>1-Math.pow(1-l,3),K.CubicInOut=l=>l<.5?4*l*l*l:1-Math.pow(-2*l+2,3)/2,K.QuartIn=l=>l*l*l*l,K.QuartOut=l=>1-Math.pow(1-l,4),K.QuartInOut=l=>l<.5?8*l*l*l*l:1-Math.pow(-2*l+2,4)/2,K.QuintIn=l=>l*l*l*l*l,K.QuintOut=l=>1-Math.pow(1-l,5),K.QuintInOut=l=>l<.5?16*l*l*l*l*l:1-Math.pow(-2*l+2,5)/2,K.SineIn=l=>1-Math.cos(l*Math.PI/2),K.SineOut=l=>Math.sin(l*Math.PI/2),K.SineInOut=l=>-(Math.cos(Math.PI*l)-1)/2,K.ExpoIn=l=>l===0?0:Math.pow(2,10*l-10),K.ExpoOut=l=>l===1?1:1-Math.pow(2,-10*l),K.ExpoInOut=l=>l===0?0:l===1?1:l<.5?Math.pow(2,20*l-10)/2:(2-Math.pow(2,-20*l+10))/2,K.CircIn=l=>1-Math.sqrt(1-Math.pow(l,2)),K.CircOut=l=>Math.sqrt(1-Math.pow(l-1,2)),K.CircInOut=l=>l<.5?(1-Math.sqrt(1-Math.pow(2*l,2)))/2:(Math.sqrt(1-Math.pow(-2*l+2,2))+1)/2,K.BackIn=l=>2.70158*l*l*l-1.70158*l*l,K.BackOut=l=>1+2.70158*Math.pow(l-1,3)+1.70158*Math.pow(l-1,2),K.BackInOut=l=>{const t=2.5949095;return l<.5?Math.pow(2*l,2)*(7.189819*l-t)/2:(Math.pow(2*l-2,2)*((t+1)*(2*l-2)+t)+2)/2},K.ElasticIn=l=>{const t=2*Math.PI/3;return l===0?0:l===1?1:-Math.pow(2,10*l-10)*Math.sin((10*l-10.75)*t)},K.ElasticOut=l=>{const t=2*Math.PI/3;return l===0?0:l===1?1:Math.pow(2,-10*l)*Math.sin((10*l-.75)*t)+1},K.ElasticInOut=l=>{const t=2*Math.PI/4.5;return l===0?0:l===1?1:l<.5?-Math.pow(2,20*l-10)*Math.sin((20*l-11.125)*t)/2:Math.pow(2,-20*l+10)*Math.sin((20*l-11.125)*t)/2+1},K.BounceOut=l=>l<1/2.75?7.5625*l*l:l<2/2.75?7.5625*(l-=1.5/2.75)*l+.75:l<2.5/2.75?7.5625*(l-=2.25/2.75)*l+.9375:7.5625*(l-=2.625/2.75)*l+.984375,K.BounceIn=l=>1-K.BounceOut(1-l),K.BounceInOut=l=>l<.5?.5*(1-K.BounceOut(1-2*l)):.5*(K.BounceOut(2*l-1)+1);let Or=K;const Rh=["viewchange","moveend","flystart","flyend","flystop"],ba=Or.CubicInOut,Ss=class gd{constructor(t={}){if(this.__id=gd.__counter__++,this.events=lt(Rh,this),this._isOrthographic=t.isOrthographic??!1,this._focusDistance=t.focusDistance!=null?t.focusDistance:10,this._width=t.width||1,this._height=t.height||1,this.eye=t.eye||new v,this.eyeHigh=new Float32Array(3),this.eyeLow=new Float32Array(3),this._viewAngle=t.viewAngle||47,this._horizontalViewAngle=0,this._viewMatrix=new tt,this._viewMatrixRTE=new tt,this._normalMatrix=new Se,this._r=new v(1,0,0),this._u=new v(0,1,0),this._b=new v(0,0,1),this._f=this._b.negateTo(),this._pr=this._r.clone(),this._pu=this._u.clone(),this._pb=this._b.clone(),this._peye=this.eye.clone(),this.isMoving=!1,this._flight=null,this._completeCallback=null,this._frameCallback=null,this._flying=!1,this._tanViewAngle_hrad=0,this._tanViewAngle_hradOneByHeight=0,this.frustums=[],this.frustumColors=[],t.frustums)for(let n=0,s=t.frustums.length;n<s;n++){let o=t.frustums[n],a=new eo({fov:this._viewAngle,aspect:this.getAspectRatio(),near:o[0],far:o[1]});a.cameraFrustumIndex=this.frustums.length,this.frustums.push(a),this.frustumColors.push(a._pickingColorU[0],a._pickingColorU[1],a._pickingColorU[2])}else{let n=1,s=500,o=new eo({fov:this._viewAngle,aspect:this.getAspectRatio(),near:n,far:s});o.cameraFrustumIndex=this.frustums.length,this.frustums.push(o),this.frustumColors.push(o._pickingColorU[0],o._pickingColorU[1],o._pickingColorU[2])}this.FARTHEST_FRUSTUM_INDEX=this.frustums.length-1,this.currentFrustumIndex=0,this.frustumColorIndex=0,this.isFirstPass=!1,this._projSizeConst=0,this.set(t.eye||new v(0,0,1),t.look||new v,t.up||new v(0,1,0))}get isOrthographic(){return this._isOrthographic}set isOrthographic(t){this._isOrthographic!==t&&(this._isOrthographic=t,this.refresh())}get focusDistance(){return this._focusDistance}set focusDistance(t){t!==this._focusDistance&&(this._focusDistance=t,this._isOrthographic&&this.refresh())}get id(){return this.__id}flyCartesian(t,n={}){this.stopFlying(),n.look=n.look||v.ZERO,n.up=n.up||v.UP,n.duration=n.duration||800;const s=n.ease||ba;this._completeCallback=n.completeCallback||(()=>{}),this._frameCallback=n.frameCallback||(()=>{}),n.startCallback&&n.startCallback.call(this);let o=this.eye.clone(),a=this._u,h=this._b,c=n.up,u=t.clone(),d=v.sub(t,n.look),f=c.cross(d);d.normalize(),f.normalize();let g=d.cross(f);this._flight={fly:_=>{let m=1-s(_),p=o.smerp(u,m),x=a.smerp(g,m),y=v.add(p,h.smerp(d,m).negateTo()),T=new v(p.x-y.x,p.y-y.y,p.z-y.z),S=x.cross(T);T.normalize(),S.normalize();let C=T.cross(S);return{eye:p,n:T,u:S,v:C}},duration:n.duration,startedAt:Date.now()},this._flying=!0,this.events.dispatch(this.events.flystart,this)}stopFlying(){this._flying&&(this._flying=!1,this._flight=null,this._frameCallback=null,this.events.dispatch(this.events.flystop,this))}checkFly(){if(this._flying&&this._flight!==null){let t=Math.min((Date.now()-this._flight.startedAt)/this._flight.duration,1);const n=this._flight.fly(t);this.eye=n.eye,this._r=n.u,this._u=n.v,this._b=n.n,this._f.set(-this._b.x,-this._b.y,-this._b.z),this._frameCallback&&this._frameCallback(),this.update(),t>=1&&(this.stopFlying(),this._completeCallback&&(this.events.dispatch(this.events.flyend,this),this._completeCallback(),this._completeCallback=null))}}isFlying(){return this._flying}checkMoveEnd(){let t=this._r,n=this._u,s=this._b,o=this.eye;this._peye.equal(o)&&this._pr.equal(t)&&this._pu.equal(n)&&this._pb.equal(s)?(this.isMoving&&this.events.dispatch(this.events.moveend,this),this.isMoving=!1):this.isMoving=!0,this._pr.copy(t),this._pu.copy(n),this._pb.copy(s),this._peye.copy(o)}bindFrustumsPickingColors(t){for(let n=0;n<this.frustums.length;n++)t.assignPickingColor(this.frustums[n])}_init(t){this._setProj(this._viewAngle,this.getAspectRatio()),this.set(t.eye||new v(0,0,1),t.look||new v,t.up||new v(0,1,0))}getUp(){return this._u.clone()}getDown(){return this._u.negateTo()}getRight(){return this._r.clone()}getLeft(){return this._r.negateTo()}getForward(){return this._f.clone()}getBackward(){return this._b.clone()}update(){let t=this._r,n=this._u,s=this._b,o=this.eye;v.doubleToTwoFloat32Array(o,this.eyeHigh,this.eyeLow),this._viewMatrix.set([t.x,n.x,s.x,0,t.y,n.y,s.y,0,t.z,n.z,s.z,0,-o.dot(t),-o.dot(n),-o.dot(s),1]),this._viewMatrixRTE.set([t.x,n.x,s.x,0,t.y,n.y,s.y,0,t.z,n.z,s.z,0,0,0,0,1]);for(let a=0,h=this.frustums.length;a<h;a++)this.frustums[a].setViewMatrix(this._viewMatrix),this.frustums[a].setProjectionViewRTEMatrix(this._viewMatrixRTE);this.events.dispatch(this.events.viewchange,this)}refresh(){this._setProj(this._viewAngle,this.getAspectRatio()),this.update()}get width(){return this._width}get height(){return this._height}setViewportSize(t,n){this._width=t,this._height=n,this.refresh()}getAspectRatio(){return this._width/this._height}_setProj(t,n){this._viewAngle=t;for(let a=0,h=this.frustums.length;a<h;a++){let c=this.frustums[a];c.setProjectionMatrix(t,n,c.near,c.far,this._isOrthographic,this._focusDistance)}var s,o;this._horizontalViewAngle=(s=t,o=n,Gr*Math.atan(Math.tan(Qt*s)*o)),this._updateViewportParameters()}_updateViewportParameters(){this._tanViewAngle_hrad=Math.tan(this._viewAngle*Qt),this._tanViewAngle_hradOneByHeight=this._tanViewAngle_hrad*(1/this._height),this._projSizeConst=Math.min(this._width<512?512:this._width,this._height<512?512:this._height)/(this._viewAngle*j)}setViewAngle(t){this._viewAngle=t,this.refresh()}getViewAngle(){return this._viewAngle}get viewAngle(){return this._viewAngle}get verticalViewAngle(){return this._viewAngle}get horizontalViewAngle(){return this._horizontalViewAngle}set(t,n,s){return this.eye.x=t.x,this.eye.y=t.y,this.eye.z=t.z,n=n||this._b,s=s||this._u,this._b.x=t.x-n.x,this._b.y=t.y-n.y,this._b.z=t.z-n.z,this._r.copy(s.cross(this._b)),this._b.normalize(),this._r.normalize(),this._u.copy(this._b.cross(this._r)),this._f.set(-this._b.x,-this._b.y,-this._b.z),this}look(t,n){this._b.set(this.eye.x-t.x,this.eye.y-t.y,this.eye.z-t.z),this._r.copy((n||this._u).cross(this._b)),this._b.normalize(),this._f.set(-this._b.x,-this._b.y,-this._b.z),this._r.normalize(),this._u.copy(this._b.cross(this._r))}slide(t,n,s){this.eye.x+=t*this._r.x+n*this._u.x+s*this._b.x,this.eye.y+=t*this._r.y+n*this._u.y+s*this._b.y,this.eye.z+=t*this._r.z+n*this._u.z+s*this._b.z}setRoll(t){let n=Math.cos(t),s=Math.sin(t),o=this._r.clone();this._r.set(n*o.x-s*this._u.x,n*o.y-s*this._u.y,n*o.z-s*this._u.z),this._u.set(s*o.x+n*this._u.x,s*o.y+n*this._u.y,s*o.z+n*this._u.z)}setPitch(t){let n=Math.cos(t),s=Math.sin(t),o=this._b;this._b.set(n*o.x-s*this._u.x,n*o.y-s*this._u.y,n*o.z-s*this._u.z),this._u.set(s*o.x+n*this._u.x,s*o.y+n*this._u.y,s*o.z+n*this._u.z)}setYaw(t){let n=Math.cos(t),s=Math.sin(t),o=this._r;this._r.set(n*o.x-s*this._b.x,n*o.y-s*this._b.y,n*o.z-s*this._b.z),this._b.set(s*o.x+n*this._b.x,s*o.y+n*this._b.y,s*o.z+n*this._b.z)}setPitchYawRoll(t,n,s){let o=new F;o.setPitchYawRoll(t,n,s),this.setRotation(o)}getPitch(){return this.getRotation().getPitch()}getYaw(){return this.getRotation().getYaw()}getRoll(){return this.getRotation().getRoll()}getAbsolutePitch(){return this.getRotation().getPitch()}getAbsoluteYaw(){return this.getRotation().getYaw()}getAbsoluteRoll(){return this.getRotation().getRoll()}getRotation(){return F.getLookRotation(this._f,this._u).conjugate()}setRotation(t,n,s,o){t.mulVec3Res(n||new v(0,1,0),this._u),t.mulVec3Res(s||new v(1,0,0),this._r),t.mulVec3Res(o||new v(0,0,1),this._b),this._f.set(-this._b.x,-this._b.y,-this._b.z)}rotate(t){t.mulVec3Res(this._u,this._u),t.mulVec3Res(this._r,this._r),t.mulVec3Res(this._b,this._b),this._f.set(-this._b.x,-this._b.y,-this._b.z)}unproject2v(t,n,s){return this.unproject(t.x,t.y,n,s)}unproject(t,n,s,o){let a=.5*this._width,h=.5*this._height,c=(t-a)/a,u=-(n-h)/h,d=this.frustums[0];if(this.isOrthographic){if(s){let f=.5*(d.right-d.left)*c,g=.5*(d.top-d.bottom)*u,_=this.getUp().scale(g),m=this.getRight().scale(f),p=_.addA(m),x=this.eye.add(p),y=this.getForward(),T=x.addA(y.scaleTo(s));return o&&o.copy(T),T.sub(this.eye).normalize()}return this.getForward()}{let f=d.inverseProjectionViewMatrix,g=f.mulVec4(new et(c,u,-1,1)).affinity();return f.mulVec4(new et(c,u,0,1)).affinity().subA(g).toVec3().normalize()}}project3v(t){return this.project(t.x,t.y,t.z)}project(t,n,s){let o=this.frustums[0].projectionViewMatrix.mulVec4(new et(t,n,s,1));return new H((1+o.x/o.w)*this._width*.5,(1-o.y/o.w)*this._height*.5)}rotateAround(t,n=!1,s=v.ZERO,o=v.UP){o=n?this._u:o;let a=tt.getRotation(t,o),h=tt.getRotationAroundPoint(t,s,o);this.eye=h.mulVec3(this.eye),this._u=a.mulVec3(this._u).normalize(),this._r=a.mulVec3(this._r).normalize(),this._b=a.mulVec3(this._b).normalize(),this._f.set(-this._b.x,-this._b.y,-this._b.z)}rotateHorizontal(t,n,s,o){this.rotateAround(t,n,s,o)}rotateVertical(t,n){this.rotateAround(t,!1,n,this._r)}projectedSize(t,n){if(this.isOrthographic){const s=this.frustums[0].projectionMatrix._m;return n*(this._height*s[5]*.5)}return Math.atan(n/this.eye.distance(t))*this._projSizeConst}getViewMatrix(){return this._viewMatrix._m}getNormalMatrix(){return this._normalMatrix._m}setCurrentFrustum(t){this.currentFrustumIndex=t,this.frustumColorIndex=10*(t+1)/255,this.isFirstPass=t===this.FARTHEST_FRUSTUM_INDEX}getCurrentFrustum(){return this.currentFrustumIndex}containsSphere(t){for(let n=0;n<this.frustums.length;n++)if(this.frustums[n].containsSphere(t))return!0;return!1}get frustum(){return this.frustums[this.currentFrustumIndex]}getProjectionMatrix(){return this.frustum.projectionMatrix._m}getProjectionViewMatrix(){return this.frustum.projectionViewMatrix._m}getProjectionViewRTEMatrix(){return this.frustum.projectionViewRTEMatrix._m}getInverseProjectionViewMatrix(){return this.frustum.inverseProjectionViewMatrix._m}getInverseProjectionMatrix(){return this.frustum.inverseProjectionMatrix._m}viewDistance(t,n=1e4){let s=t.add(this.getBackward().scaleTo(n));this.set(s,t),this.update()}copy(t){this.eye.copy(t.eye),this._r.copy(t._r),this._u.copy(t._u),this._b.copy(t._b),this._f.copy(t._f),this._width=t.width,this._height=t.height,this.setViewAngle(t.viewAngle),this.update()}getAltitude(){return this.eye.y}};Ss.__counter__=0;let Pi=Ss;class wa extends Pi{constructor(t,n={}){super({...n,frustums:n.frustums||[[1,100.075],[100,1000.075],[1e3,101e4],[1e6,1e9]]}),this.planet=t,this.minAltitude=n.minAltitude||1,this.maxAltitude=n.maxAltitude||2e7,this._lonLat=this.planet.ellipsoid.cartesianToLonLat(this.eye),this._lonLatMerc=this._lonLat.forwardMercator(),this._terrainAltitude=this._lonLat.height,this._terrainPoint=new v,this._insideSegment=null,this.slope=0,this._keyLock=new Me,this._flight=null,this._completeCallback=null,this._frameCallback=null,this._flying=!1,this._checkTerrainCollision=!0,this.eyeNorm=this.eye.getNormal()}setTerrainCollisionActivity(t){this._checkTerrainCollision=t}update(){this.events.stopPropagation();let t=this.maxAltitude+this.planet.ellipsoid.getEquatorialSize();this.eye.length()>t&&this.eye.copy(this.eye.getNormal().scale(t)),super.update(),this.updateGeodeticPosition(),this.eyeNorm=this.eye.getNormal(),this.slope=this._b.dot(this.eyeNorm),this.events.dispatch(this.events.viewchange,this)}updateGeodeticPosition(){this.planet.ellipsoid.cartesianToLonLatRes(this.eye,this._lonLat),Math.abs(this._lonLat.lat)<=ct&&L.forwardMercatorRes(this._lonLat,this._lonLatMerc)}setAltitude(t){let n=this._terrainPoint,s=this.planet.ellipsoid.getSurfaceNormal3v(this.eye);this.eye.x=s.x*t+n.x,this.eye.y=s.y*t+n.y,this.eye.z=s.z*t+n.z,this._terrainAltitude=t}getAltitude(){return this._terrainAltitude}setLonLat(t,n,s){this.stopFlying(),this._lonLat.set(t.lon,t.lat,t.height||this._lonLat.height);let o=this.planet.ellipsoid,a=o.lonLatToCartesian(this._lonLat),h=n?o.lonLatToCartesian(n):v.ZERO;this.set(a,h,s||a.getNormal()),this.update()}getLonLat(){return this._lonLat}getHeight(){return this._lonLat.height}getExtentPosition(t,n){n=n||0;let s=t.getNorth(),o=t.getSouth(),a=t.getEast(),h=t.getWest();h>a&&(a+=360);let c=this.planet.ellipsoid,u=new L(a,s),d=c.lonLatToCartesian(u);u.lat=o;let f=c.lonLatToCartesian(u);u.lon=h;let g=c.lonLatToCartesian(u);u.lat=s;let _=c.lonLatToCartesian(u),m=v.sub(d,g).scale(.5).addA(g),p=m.length();p<1e-6&&(u.lon=.5*(a+h),u.lat=.5*(s+o),m=c.lonLatToCartesian(u)),_.subA(m),f.subA(m),d.subA(m),g.subA(m);let x=m.getNormal(),y=x.cross(v.NORTH).normalize(),T=y.cross(x).normalize(),S=Math.max(Math.abs(T.dot(_)),Math.abs(T.dot(f)),Math.abs(T.dot(d)),Math.abs(T.dot(g))),C=Math.max(Math.abs(y.dot(_)),Math.abs(y.dot(f)),Math.abs(y.dot(d)),Math.abs(y.dot(g))),P=Math.tan(this._viewAngle*j*.5),w=this.getAspectRatio()*P,I=Math.max(C/w,S/P);return m.normalize(),m.scale(p+I+n),m}viewExtent(t,n){this.stopFlying(),this.set(this.getExtentPosition(t,n),v.ZERO,v.NORTH),this.update()}flyExtent(t,n,s={}){s.look=v.ZERO,this.flyCartesian(this.getExtentPosition(t,n),s)}viewDistance(t,n=1e4){let s=this.eye.add(this.getForward().scaleTo(n)),o=F.getRotationBetweenVectors(s.getNormal(),t.getNormal());if(o.isZero()){let a=t.add(this.getBackward().scaleTo(n));this.set(a,t)}else{let a=t.add(o.mulVec3(this.getBackward()).scale(n)),h=o.mulVec3(this.getUp());this.set(a,t,h)}this.update()}flyLonLat(t,n={}){let s=new L(t.lon,t.lat,t.height||this._lonLat.height);this.flyCartesian(this.planet.ellipsoid.lonLatToCartesian(s),n)}flyDistance(t,n=1e4,s={}){let o=this.eye.add(this.getForward().scaleTo(n)),a=F.getRotationBetweenVectors(o.getNormal(),t.getNormal());if(a.isZero()){let h=t.add(this.getBackward().scaleTo(n));this.set(h,t)}else{let h=t.add(a.mulVec3(this.getBackward()).scale(n)),c=a.mulVec3(this.getUp());s.look=t,s.up=c,this.flyCartesian(h,s)}}flyCartesian(t,n={}){this.stopFlying(),n.preventLock||(this.planet.layerLock.lock(this._keyLock),this.planet.terrainLock.lock(this._keyLock),this.planet.normalMapCreator.lock(this._keyLock)),n.amplitude=n.amplitude!=null?n.amplitude:1,n.look=n.look||v.ZERO,n.up=n.up||v.NORTH,n.duration=n.duration||800;const s=n.ease||ba;this._completeCallback=n.completeCallback||(()=>{}),this._frameCallback=n.frameCallback||(()=>{}),n.startCallback&&n.startCallback.call(this),n.look instanceof L&&(n.look=this.planet.ellipsoid.lonLatToCartesian(n.look));let o=this.eye.clone(),a=this._u,h=this._b,c=this.planet.ellipsoid.cartesianToLonLat(t),u=n.up,d=this.planet.ellipsoid.lonLatToCartesian(new L(c.lon,c.lat,0)),f=v.sub(t,n.look),g=u.cross(f);f.normalize(),g.normalize();let _=f.cross(g),m=o.getNormal(),p=d.getNormal(),x=1-m.dot(p),y=n.amplitude*yo*Math.sqrt(x>0?x:0),T=6639613,S=Math.max(this._lonLat.height,c.height);S>T&&(T=S);let C=S+2.5*y*(T-S),P=v.ZERO;this._flight={fly:w=>{let I,O=s(w),N=1-O;if(O>=1)I=t.clone();else{let B=o.smerp(t,N).normalize(),rt=this.planet.getRayIntersectionEllipsoid(new V(P,B)),wt=this._lonLat.height*N*N*N+3*C*N*N*O+3*C*N*O*O+c.height*O*O*O;I=rt.addA(B.scale(wt))}let k=a.smerp(_,N),D=v.add(I,h.smerp(f,N).negateTo()),ze=new v(I.x-D.x,I.y-D.y,I.z-D.z),z=k.cross(ze);ze.normalize(),z.normalize();let Ee=ze.cross(z);return{eye:I,n:ze,u:z,v:Ee}},duration:n.duration,startedAt:Date.now()},this._flying=!0,this.events.dispatch(this.events.flystart,this)}stopFlying(){this._flying&&(this.planet.layerLock.free(this._keyLock),this.planet.terrainLock.free(this._keyLock),this.planet.normalMapCreator.free(this._keyLock),super.stopFlying())}rotateLeft(t,n){this.rotateHorizontal(t,n!==!0,v.ZERO),this.update()}rotateRight(t,n){this.rotateHorizontal(-t,n!==!0,v.ZERO),this.update()}rotateUp(t){this.rotateVertical(t,v.ZERO),this.update()}rotateDown(t){this.rotateVertical(-t,v.ZERO),this.update()}rotateVertical(t,n,s=0){let o=new tt().setRotation(this._r,t),a=new tt().setIdentity().translate(n),h=new tt().setIdentity().translate(n.negateTo()),c=a.mul(o).mul(h).mulVec3(this.eye),u=o.mulVec3(this._u).normalize(),d=o.mulVec3(this._r).normalize(),f=o.mulVec3(this._b).normalize(),g=c.getNormal(),_=f.dot(g);if(!(u.dot(g)<=0))if(s){let m=_-this.slope;if(_<s&&m<0)return;(_>.1&&u.dot(g)>0||this.slope<=.1||this._u.dot(this.eye.getNormal())<=0)&&(this.eye=c,this._u=u,this._r=d,this._b=f,this._f.set(-f.x,-f.y,-f.z))}else this.eye=c,this._u=u,this._r=d,this._b=f,this._f.set(-f.x,-f.y,-f.z)}checkTerrainCollision(){if(this._terrainAltitude=this._lonLat.height,this._insideSegment&&this._insideSegment.planet)return this._terrainAltitude=this._insideSegment.getTerrainPoint(this.eye,this._insideSegment.getInsideLonLat(this),this._terrainPoint),this._terrainAltitude<this.minAltitude&&this._checkTerrainCollision&&this.setAltitude(this.minAltitude),this._terrainPoint}getSurfaceVisibleDistance(t){let n=this.planet.ellipsoid.equatorialSize;return n*Math.acos(n/(n+this._lonLat.height+t))}getHeading(){let t=this.eye.getNormal(),n=v.proj_b_to_plane(this.slope>=.97?this.getUp():this.getForward(),t).normalize(),s=v.proj_b_to_plane(v.NORTH,t).normalize(),o=Math.sign(t.dot(n.cross(s)))*Math.acos(n.dot(s))*J;return o<0?360+o:o}isVisible(t){let n=this.eye.length();return this.eye.distance(t)<Math.sqrt(n*n-this.planet.ellipsoid.equatorialSizeSqr)}getPitch(){return this.planet.getFrameRotation(this.eye).conjugate().inverse().mul(this.getRotation()).getPitch()}getYaw(){return this.planet.getFrameRotation(this.eye).conjugate().inverse().mul(this.getRotation()).getYaw()}getRoll(){return this.planet.getFrameRotation(this.eye).conjugate().inverse().mul(this.getRotation()).getRoll()}setPitch(t){let n=this.planet.getFrameRotation(this.eye),s=new F;s.setPitchYawRoll(t,this.getYaw(),this.getRoll(),n),this.setRotation(s)}setYaw(t){let n=this.planet.getFrameRotation(this.eye),s=new F;s.setPitchYawRoll(this.getPitch(),t,this.getRoll(),n),this.setRotation(s)}setRoll(t){let n=this.planet.getFrameRotation(this.eye),s=new F;s.setPitchYawRoll(this.getPitch(),this.getYaw(),t,n),this.setRotation(s)}setPitchYawRoll(t,n,s){let o=this.planet.getFrameRotation(this.eye),a=new F;a.setPitchYawRoll(t,n,s,o).conjugate(),this.setRotation(a)}}const Rs=class _d{constructor(t,n={}){this.handler=t,this.__id=_d.__counter__++,this._fbo=null,this._width=n.width||t.canvas.width,this._height=n.height||t.canvas.height,this._depthComponent=n.depthComponent!=null?n.depthComponent:"DEPTH_COMPONENT16",this._useDepth=n.useDepth==null||n.useDepth,this._active=!1,this._size=n.size||1,this._depthRenderbuffer=null,this._filter=n.filter||"NEAREST"}get width(){return this._width}get height(){return this._height}setSize(t,n,s=!1){this._width=t,this._height=n,this._active&&this.handler.gl.viewport(0,0,this._width,this._height),(this._useDepth||s)&&(this.destroy(),this.init())}init(){}destroy(){}isComplete(){let t=this.handler.gl;return t.checkFramebufferStatus(t.FRAMEBUFFER)===t.FRAMEBUFFER_COMPLETE}checkStatus(){let t=this.handler.gl;return t.checkFramebufferStatus(t.FRAMEBUFFER)}activate(){let t=this.handler.gl;t.bindFramebuffer(t.FRAMEBUFFER,null),t.bindFramebuffer(t.FRAMEBUFFER,this._fbo),t.viewport(0,0,this._width,this._height),this._active=!0;let n=this.handler.framebufferStack.current().data;return n&&(n._active=!1),this.handler.framebufferStack.push(this),this}deactivate(){let t=this.handler,n=t.gl;n.bindFramebuffer(n.FRAMEBUFFER,null),this._active=!1;let s=this.handler.framebufferStack.popPrev();s?(n.bindFramebuffer(n.FRAMEBUFFER,s._fbo),n.viewport(0,0,s._width,s._height)):n.viewport(0,0,t.canvas.width,t.canvas.height)}isEqual(t){return!!t&&this.__id===t.__id}};Rs.__counter__=0;let hs=Rs;class mi{constructor(t=256,n=256){this._canvas=document.createElement("canvas"),this._canvas.width=t,this._canvas.height=n,this._context=this._canvas.getContext("2d",{willReadFrequently:!0})}getCanvas(){return this._canvas}getContext(){return this._context}fillEmpty(){let t=this._context.getImageData(0,0,this._canvas.width,this._canvas.height),n=t.data;for(let s=0,o=n.length;s<o;s+=4)n[s]=n[s+1]=n[s+2]=n[s+3]=0;this._context.putImageData(t,0,0)}fill(t){this._context.fillStyle=t,this._context.fill()}getData(){return this._context.getImageData(0,0,this._canvas.width,this._canvas.height).data}fillColor(t){this._context.fillStyle=t,this._context.fillRect(0,0,this._canvas.width,this._canvas.height)}setData(t){let n=this._context.createImageData(this._canvas.width,this._canvas.height);n.data.set(t),this._context.putImageData(n,0,0)}resize(t,n){this._canvas.width=t,this._canvas.height=n,this._context=this._canvas.getContext("2d")}drawImage(t,n,s,o,a){this._context.drawImage(t,n||0,s||0,o||t.width,a||t.height)}getImage(){let t=new Image;return t.width=this.getWidth(),t.height=this.getHeight(),t.src=this._canvas.toDataURL("image/png"),t}getTextWidth(t){let n=this._context.measureText(t);return Math.round(n.width)}drawText(t,n=0,s=14,o="normal 14px Verdana",a="black"){this._context.fillStyle=a,this._context.font=o,this._context.fillText(t,n,s)}getWidth(){return this._canvas.width}getHeight(){return this._canvas.height}load(t,n){let s=new Image,o=this;s.onload=function(){o.resize(s.width,s.height),o._context.drawImage(s,0,0,s.width,s.height),n&&n(s)},s.src=t}openImage(){let t=this.getImage(),n="<!DOCTYPE html>";n+="<html>",n+="<head><title>Print</title></head>",n+="<body>",n+='<img src="'+t.src+'">',n+="</body>",n+="</html>";let s=window.open("","","width="+t.width+"px ,height="+t.height+"px");s&&(s.document.open(),s.document.write(n),s.document.close(),s.focus())}destroy(){this._canvas.width=1,this._canvas.height=1,this._canvas=null,this._context=null}}const io={UNSIGNED_BYTE:Uint8Array,FLOAT:Float32Array};class Rt extends hs{constructor(t,n={}){super(t,n),this.readPixelBuffersAsync=s=>{const o=this.handler.gl;if(this._skipFrame)return;this._skipFrame=!0;let a=this.width,h=this.height,c=this.pixelBuffers;this.activate();for(let g=0;g<c.length;g++){let _=c[g];o.bindBuffer(o.PIXEL_PACK_BUFFER,_.buffer),o.bufferData(o.PIXEL_PACK_BUFFER,_.data.byteLength,o.STREAM_READ),o.readBuffer(_.glAttachment),o.readPixels(0,0,a,h,o.RGBA,_.glType,0),o.bindBuffer(o.PIXEL_PACK_BUFFER,null)}this.deactivate();const u=o.fenceSync(o.SYNC_GPU_COMMANDS_COMPLETE,0);var d,f;o.flush(),(d=o,f=u,new Promise((g,_)=>{(function m(){const p=d.clientWaitSync(f,0,0);p==d.WAIT_FAILED?_():p==d.TIMEOUT_EXPIRED?requestAnimationFrame(m):g()})()})).then(()=>{this._skipFrame=!1,o.deleteSync(u);for(let g=0;g<c.length;g++){let _=c[g];_.data&&(o.bindBuffer(o.PIXEL_PACK_BUFFER,_.buffer),o.getBufferSubData(o.PIXEL_PACK_BUFFER,0,_.data))}o.bindBuffer(o.PIXEL_PACK_BUFFER,null),s&&s(this)})},this._targets=Rt.createTargets(n.targets),this._size=this._targets.length,this._renderbufferTarget=n.renderbufferTarget!=null?n.renderbufferTarget:"DEPTH_ATTACHMENT",this.textures=n.textures||new Array(this._size),this.pixelBuffers=[],this._skipFrame=!1}static createTargets(t){let n=0,s=0;return t?t.map(o=>{let a=o.attachment||"COLOR_ATTACHMENT";a==="COLOR_ATTACHMENT"&&(a="COLOR_ATTACHMENT"+n++);let h=o.type||"UNSIGNED_BYTE";return{internalFormat:o.internalFormat||"RGBA",format:o.format||"RGBA",type:h,attachment:a,filter:o.filter||"NEAREST",pixelBufferIndex:o.readAsync?s++:-1,TypeArrayConstructor:io[h]}}):[{internalFormat:"RGBA",format:"RGBA",type:"UNSIGNED_BYTE",attachment:"COLOR_ATTACHMENT0",filter:"NEAREST",pixelBufferIndex:-1,TypeArrayConstructor:io.UNSIGNED_BYTE}]}destroy(){let t=this.handler.gl;if(t){for(let n=0;n<this.textures.length;n++)t.deleteTexture(this.textures[n]);this.textures=new Array(this._size);for(let n=0;n<this.pixelBuffers.length;n++)this.pixelBuffers[n].data=null,t.deleteBuffer(this.pixelBuffers[n].buffer);this.pixelBuffers=[],t.deleteFramebuffer(this._fbo),t.deleteRenderbuffer(this._depthRenderbuffer),this._depthRenderbuffer=null,this._fbo=null,this._active=!1}}init(){let t=this.handler.gl;if(!t)return;this._fbo=t.createFramebuffer(),t.bindFramebuffer(t.FRAMEBUFFER,this._fbo);let n=[];for(let s=0;s<this._targets.length;s++){let o=this._targets[s],a=this.textures[s]||this.handler.createEmptyTexture2DExt(this._width,this._height,o.filter,o.internalFormat,o.format,o.type),h=t[o.attachment];a&&(this.bindOutputTexture(a,h),this.textures[s]=a),o.attachment!=="DEPTH_ATTACHMENT"&&n.push(h),o.pixelBufferIndex!==-1&&this._createPixelBuffer(o)}t.drawBuffers&&t.drawBuffers(n),this._useDepth&&(this._depthRenderbuffer=t.createRenderbuffer(),t.bindRenderbuffer(t.RENDERBUFFER,this._depthRenderbuffer),t.renderbufferStorage(t.RENDERBUFFER,t[this._depthComponent],this._width,this._height),t.framebufferRenderbuffer(t.FRAMEBUFFER,t[this._renderbufferTarget],t.RENDERBUFFER,this._depthRenderbuffer),t.bindRenderbuffer(t.RENDERBUFFER,null)),t.bindFramebuffer(t.FRAMEBUFFER,null)}getPixelBufferData(t=0){let n=this._targets[t].pixelBufferIndex;return n!==-1?this.pixelBuffers[n].data:null}_createPixelBuffer(t){let n=this.handler.gl,s=t.pixelBufferIndex,o=this.pixelBuffers[s];o||(o=this.pixelBuffers[s]={buffer:null,data:null,glType:-1,glAttachment:-1});let a=this.width*this.height*4;o.data=null,o.data=new t.TypeArrayConstructor(a),o.buffer=n.createBuffer(),n.bindBuffer(n.PIXEL_PACK_BUFFER,o.buffer),n.bufferData(n.PIXEL_PACK_BUFFER,a,n.STREAM_READ),n.bindBuffer(n.PIXEL_PACK_BUFFER,null),o.glType=n[t.type],o.glAttachment=n[t.attachment]}bindOutputTexture(t,n){let s=this.handler.gl;s.bindTexture(s.TEXTURE_2D,t),s.framebufferTexture2D(s.FRAMEBUFFER,n||s.COLOR_ATTACHMENT0,s.TEXTURE_2D,t,0),s.bindTexture(s.TEXTURE_2D,null)}readPixels(t,n,s,o=0,a=1,h=1){let c=this.handler.gl;c.bindFramebuffer(c.FRAMEBUFFER,this._fbo),c.readBuffer&&c.readBuffer(c.COLOR_ATTACHMENT0+o||0),c.readPixels(n*this._width,s*this._height,a,h,c.RGBA,c[this._targets[o].type],t),c.bindFramebuffer(c.FRAMEBUFFER,null)}readAllPixels(t,n=0){let s=this.handler.gl;s.bindFramebuffer(s.FRAMEBUFFER,this._fbo),s.readBuffer&&s.readBuffer(s.COLOR_ATTACHMENT0+n),s.readPixels(0,0,this._width,this._height,s.RGBA,s[this._targets[n].type],t),s.bindFramebuffer(s.FRAMEBUFFER,null)}getImage(){let t=new Uint8Array(4*this._width*this._height);this.readAllPixels(t);let n=new mi(this._width,this._height);return n.setData(t),n.getImage()}readData(t,n,s,o=0){const a=this.width,h=this.height,c=Math.floor(t*(a-1)),u=4*(Math.floor(n*(h-1))*a+c),d=this.pixelBuffers[o].data;d&&(s[0]=d[u],s[1]=d[u+1],s[2]=d[u+2],s[3]=d[u+3])}}const Mh=["tick","end","start","stop"],Ms=class pd{constructor(t={}){this.__handler=null,this.active=!0,this.__id=pd.__counter__++,this.events=lt(Mh,this),this.name=t.name||"",this.startDate=t.startDate||0,this.endDate=t.endDate||0;let n=t.currentDate||is(new Date);t.startDate&&n<t.startDate&&(n=t.startDate),t.endDate&&n>t.endDate&&(n=t.endDate),this.currentDate=n,this._multiplier=t.multiplier!==void 0?t.multiplier:1,this._running=1,this.deltaTicks=0,this.active=!0,this._intervalDelay=0,this._intervalStart=0,this._intervalCallback=null}clearInterval(){this._intervalDelay=0,this._intervalStart=0,this._intervalCallback=null}setInterval(t,n){this._intervalStart=this.currentDate,this._intervalDelay=t*tn,this._intervalCallback=n}setDate(t){let n=is(t);this.startDate&&n<this.startDate&&(n=this.startDate),this.endDate&&n>this.endDate&&(n=this.endDate),this.currentDate=n}getDate(){return mr(this.currentDate)}reset(){this.startDate&&(this.currentDate=this.startDate)}tick(t){let n=this._multiplier*this._running;if(this.deltaTicks=t*n,this.active){let s=Fo(this.currentDate,this.deltaTicks);n>0?this.endDate&&s>this.endDate?(this.currentDate=this.startDate,this.events.dispatch(this.events.end,this)):this.currentDate=s:this.startDate&&s<this.startDate?(this.currentDate=this.endDate,this.events.dispatch(this.events.end,this)):this.currentDate=s,this._intervalCallback&&this.currentDate-this._intervalStart>=this._intervalDelay&&(this._intervalStart=this.currentDate,this._intervalCallback(this)),this.events.dispatch(this.events.tick,this)}}isEqual(t){return this.__id===t.__id}start(){this._running===0&&(this._running=1,this.events.dispatch(this.events.start,this))}get multiplier(){return this._multiplier}set multiplier(t){this._multiplier=t}stop(){this._running===1&&(this._running=0,this.events.dispatch(this.events.stop,this))}};Ms.__counter__=0;let Nr=Ms;class Bh{constructor(t,n){n._programController=this,this._program=n,this._handler=t,this._activated=!1}initialize(){this._handler.gl&&this._program.createProgram(this._handler.gl)}getProgram(){return this._program}activate(){if(!this._activated){this._handler.activeProgram.deactivate(),this._handler.activeProgram=this;let t=this._program;this._activated=!0,t.enableAttribArrays(),t.use()}return this}remove(){let t=this._handler.programs;t[this._program.name]&&(this._activated&&this.deactivate(),this._program.delete(),delete t[this._program.name])}deactivate(){this._program.disableAttribArrays(),this._activated=!1}isActive(){return this._activated}set(t){return this.activate(),this._program.set(t),this}drawIndexBuffer(t,n){return this._program.drawIndexBuffer(t,n),this}drawArrays(t,n){return this._program.drawArrays(t,n),this}}let so=class{constructor(){this.next=null,this.prev=null,this.data=null}};class Js{constructor(t=256){this._current=new so,this._head=this._current;for(let n=0;n<t;n++){let s=new so;s.prev=this._current,this._current.next=s,this._current=s}this._current=this._head}current(){return this._current}push(t){this._current=this._current.next,this._current.data=t}pop(){let t=this._current.data;return this._current=this._current.prev,t}popPrev(){return this._current=this._current.prev,this._current.data}}const ro=["","WEBKIT_","MOZ_"],tr=["webgl2","webgl"];class Be{constructor(t,n={}){this.framebufferStack=new Js,this._requestAnimationFrameId=0,this.drawFrame=()=>{let s=window.performance.now(),o=this.deltaTime;this.deltaTime=.5*(s-this._lastAnimationFrameTime+this.prevDeltaTime),this.deltaTime>3?this.deltaTime=3:this.deltaTime<1&&(this.deltaTime=1),this.prevDeltaTime=o,this._lastAnimationFrameTime=s,this.defaultClock.tick(this.deltaTime);for(let h=0;h<this._clocks.length;h++)this._clocks[h].tick(this.deltaTime);let a=this.canvas;Math.floor(a.clientWidth*this._params.pixelRatio)===a.width&&Math.floor(a.clientHeight*this._params.pixelRatio)===a.height||(a.clientWidth===0||a.clientHeight===0?this.stop():document.hidden||(this.start(),this.setSize(a.clientWidth,a.clientHeight))),this._frameCallback()},this.events=lt(["visibilitychange","resize"]),this._throttledDrawFrame=this.drawFrame,this.defaultClock=new Nr,this._clocks=[],this.prevDeltaTime=0,this.deltaTime=0,this.canvas=null,this.gl=null,this.programs={},this.activeProgram=null,this._canvasSize=[0,0],this._params={anisotropy:n.anisotropy||4,width:n.width||256,height:n.height||256,pixelRatio:zo("og_dpi")||n.pixelRatio||1,extensions:n.extensions||[],context:n.context||{}},this.extensions={},this._canvasTarget=t,this._lastAnimationFrameTime=0,this._initialized=!1,this._frameCallback=function(){},this.transparentTexture=null,this.defaultTexture=null,this.framebufferStack=new Js,this.createTexture_n=this.createTexture_n_webgl2.bind(this),this.createTexture_l=this.createTexture_l_webgl2.bind(this),this.createTexture_mm=this.createTexture_mm_webgl2.bind(this),this.createTexture_a=this.createTexture_a_webgl2.bind(this),this.createTexture={NEAREST:this.createTexture_n,LINEAR:this.createTexture_l,MIPMAP:this.createTexture_mm,ANISOTROPIC:this.createTexture_a},this.createTextureDefault=this.createTexture_n,this.ONCANVASRESIZE=null,this._createCanvas(),(n.autoActivate||Gt(n.autoActivate))&&this.initialize()}set frameDelay(t){this._throttledDrawFrame=t===0?this.drawFrame:yi(this.drawFrame,t)}isInitialized(){return this._initialized}_createCanvas(){this._canvasTarget?this._canvasTarget instanceof HTMLElement?this.canvas=this._canvasTarget:this.canvas=document.getElementById(this._canvasTarget)||document.querySelector(this._canvasTarget):(this.canvas=document.createElement("canvas"),this.canvas.width=this._params.width,this.canvas.height=this._params.height)}static getExtension(t,n){if(!t)return;let s,o;for(s in ro)if(o=t.getExtension(ro[s]+n),o)return o}static getContext(t,n){let s=null;try{let o=new URLSearchParams(location.search).get("og_ver");if(o)s=t.getContext(o,n),s&&(s.type=o);else for(let a=0;a<tr.length;a++)if(s=t.getContext(tr[a],n),s){s.type=tr[a];break}}catch{ie.logErr("exception during the GL context initialization")}return s||ie.logErr("could not initialise WebGL"),s}setFrameCallback(t){t&&(this._frameCallback=t)}createEmptyTexture2DExt(t=1,n=1,s="NEAREST",o="RGBA",a="RGBA",h="UNSIGNED_BYTE",c="CLAMP_TO_EDGE",u=0){let d=this.gl,f=d.createTexture();return d.bindTexture(d.TEXTURE_2D,f),d.texImage2D(d.TEXTURE_2D,u,d[o.toUpperCase()],t,n,0,d[a.toUpperCase()],d[h.toUpperCase()],null),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MIN_FILTER,d[s.toUpperCase()]),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MAG_FILTER,d[s.toUpperCase()]),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_S,d[c.toUpperCase()]),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_T,d[c.toUpperCase()]),d.bindTexture(d.TEXTURE_2D,null),f}createEmptyTexture_n(t,n,s,o){let a=this.gl,h=a.createTexture();return a.bindTexture(a.TEXTURE_2D,h),a.texImage2D(a.TEXTURE_2D,0,s||a.RGBA,t,n,0,a.RGBA,a.UNSIGNED_BYTE,null),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.NEAREST),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.NEAREST),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,o||a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,o||a.CLAMP_TO_EDGE),a.bindTexture(a.TEXTURE_2D,null),h}createEmptyTexture_l(t,n,s,o){let a=this.gl,h=a.createTexture();return a.bindTexture(a.TEXTURE_2D,h),a.texImage2D(a.TEXTURE_2D,0,s||a.RGBA,t,n,0,a.RGBA,a.UNSIGNED_BYTE,null),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,o||a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,o||a.CLAMP_TO_EDGE),a.bindTexture(a.TEXTURE_2D,null),h}createTexture_n_webgl1(t,n,s,o=null){let a=this.gl;return o=o||a.createTexture(),a.bindTexture(a.TEXTURE_2D,o),a.texImage2D(a.TEXTURE_2D,0,n||a.RGBA,a.RGBA,a.UNSIGNED_BYTE,t),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.NEAREST),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.NEAREST),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,s||a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,s||a.CLAMP_TO_EDGE),a.bindTexture(a.TEXTURE_2D,null),o}createTexture_l_webgl1(t,n,s,o=null){let a=this.gl;return o=o||a.createTexture(),a.bindTexture(a.TEXTURE_2D,o),a.texImage2D(a.TEXTURE_2D,0,n||a.RGBA,a.RGBA,a.UNSIGNED_BYTE,t),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,s||a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,s||a.CLAMP_TO_EDGE),a.bindTexture(a.TEXTURE_2D,null),o}createTexture_mm_webgl1(t,n,s,o=null){let a=this.gl;return o=o||a.createTexture(),a.bindTexture(a.TEXTURE_2D,o),a.texImage2D(a.TEXTURE_2D,0,n||a.RGBA,a.RGBA,a.UNSIGNED_BYTE,t),a.generateMipmap(a.TEXTURE_2D),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR_MIPMAP_LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,s||a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,s||a.CLAMP_TO_EDGE),a.bindTexture(a.TEXTURE_2D,null),o}createTexture_a_webgl1(t,n,s,o=null){let a=this.gl;return o=o||a.createTexture(),a.bindTexture(a.TEXTURE_2D,o),a.texImage2D(a.TEXTURE_2D,0,n||a.RGBA,a.RGBA,a.UNSIGNED_BYTE,t),a.generateMipmap(a.TEXTURE_2D),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR_MIPMAP_LINEAR),a.texParameterf(a.TEXTURE_2D,this.extensions.EXT_texture_filter_anisotropic.TEXTURE_MAX_ANISOTROPY_EXT,this._params.anisotropy),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,s||a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,s||a.CLAMP_TO_EDGE),a.bindTexture(a.TEXTURE_2D,null),o}createTexture_n_webgl2(t,n,s,o=null){let a=this.gl;return o=o||a.createTexture(),a.bindTexture(a.TEXTURE_2D,o),a.texStorage2D(a.TEXTURE_2D,1,n||a.RGBA8,t.width,t.height),a.texSubImage2D(a.TEXTURE_2D,0,0,0,t.width,t.height,a.RGBA,a.UNSIGNED_BYTE,t),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.NEAREST),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.NEAREST),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,s||a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,s||a.CLAMP_TO_EDGE),a.bindTexture(a.TEXTURE_2D,null),o}createTexture_l_webgl2(t,n,s,o=null){let a=this.gl;return o=o||a.createTexture(),a.bindTexture(a.TEXTURE_2D,o),a.texStorage2D(a.TEXTURE_2D,1,n||a.RGBA8,t.width,t.height),a.texSubImage2D(a.TEXTURE_2D,0,0,0,t.width,t.height,a.RGBA,a.UNSIGNED_BYTE,t),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,s||a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,s||a.CLAMP_TO_EDGE),a.bindTexture(a.TEXTURE_2D,null),o}createTexture_mm_webgl2(t,n,s,o=null){let a=this.gl;return o=o||a.createTexture(),a.bindTexture(a.TEXTURE_2D,o),a.texStorage2D(a.TEXTURE_2D,2,n||a.RGBA8,t.width,t.height),a.texSubImage2D(a.TEXTURE_2D,0,0,0,t.width,t.height,a.RGBA,a.UNSIGNED_BYTE,t),a.generateMipmap(a.TEXTURE_2D),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR_MIPMAP_LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,s||a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,s||a.CLAMP_TO_EDGE),a.bindTexture(a.TEXTURE_2D,null),o}createTexture_a_webgl2(t,n,s,o=null){let a=this.gl;return o=o||a.createTexture(),a.bindTexture(a.TEXTURE_2D,o),a.texStorage2D(a.TEXTURE_2D,2,n||a.RGBA8,t.width,t.height),a.texSubImage2D(a.TEXTURE_2D,0,0,0,t.width,t.height,a.RGBA,a.UNSIGNED_BYTE,t),a.generateMipmap(a.TEXTURE_2D),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR_MIPMAP_LINEAR),a.texParameterf(a.TEXTURE_2D,this.extensions.EXT_texture_filter_anisotropic.TEXTURE_MAX_ANISOTROPY_EXT,this._params.anisotropy),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,s||a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,s||a.CLAMP_TO_EDGE),a.bindTexture(a.TEXTURE_2D,null),o}loadCubeMapTexture(t){let n=this.gl,s=n.createTexture();n.bindTexture(n.TEXTURE_CUBE_MAP,s),n.texParameteri(n.TEXTURE_CUBE_MAP,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_CUBE_MAP,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_CUBE_MAP,n.TEXTURE_MIN_FILTER,n.LINEAR),n.texParameteri(n.TEXTURE_CUBE_MAP,n.TEXTURE_MAG_FILTER,n.LINEAR);let o=[[t.px,n.TEXTURE_CUBE_MAP_POSITIVE_X],[t.nx,n.TEXTURE_CUBE_MAP_NEGATIVE_X],[t.py,n.TEXTURE_CUBE_MAP_POSITIVE_Y],[t.ny,n.TEXTURE_CUBE_MAP_NEGATIVE_Y],[t.pz,n.TEXTURE_CUBE_MAP_POSITIVE_Z],[t.nz,n.TEXTURE_CUBE_MAP_NEGATIVE_Z]],a=new mi;a.fillEmpty();let h=a.getImage();for(let c=0;c<o.length;c++){let u=o[c][1];n.bindTexture(n.TEXTURE_CUBE_MAP,s),n.texImage2D(u,0,n.RGBA,n.RGBA,n.UNSIGNED_BYTE,h)}for(let c=0;c<o.length;c++){let u=o[c][1],d=new Image;d.crossOrigin="",d.onload=function(f,g,_){return function(){n&&f&&(n.bindTexture(n.TEXTURE_CUBE_MAP,f),n.texImage2D(g,0,n.RGBA,n.RGBA,n.UNSIGNED_BYTE,_))}}(s,u,d),d.src=o[c][0]}return s}addProgram(t,n=!1){if(this.programs[t.name])console.warn(`Shader program: "${t.name}" already exists.`);else{let s=new Bh(this,t);this.programs[t.name]=s,this._initProgramController(s),n||(s._activated=!1)}return t}removeProgram(t){this.programs[t]&&this.programs[t].remove()}addPrograms(t){for(let n=0;n<t.length;n++)this.addProgram(t[n])}_initProgramController(t){this._initialized&&(t.initialize(),this.activeProgram?(t.deactivate(),this.activeProgram._program.enableAttribArrays(),this.activeProgram._program.use()):(this.activeProgram=t,t.activate()))}_initPrograms(){for(let t in this.programs)this._initProgramController(this.programs[t])}initializeExtension(t,n=!1){if(!this.extensions||!this.extensions[t]){let s=Be.getExtension(this.gl,t);s?this.extensions[t]=s:n&&console.warn("og.webgl.Handler: extension '"+t+"' doesn't initialize.")}return this.extensions&&this.extensions[t]}initialize(){if(this._initialized||!this.canvas||(this.gl=Be.getContext(this.canvas,this._params.context),!this.gl))return;this._initialized=!0,this._params.extensions.push("EXT_texture_filter_anisotropic"),this.gl.type==="webgl"?(this._params.extensions.push("OES_standard_derivatives"),this._params.extensions.push("OES_element_index_uint"),this._params.extensions.push("WEBGL_depth_texture"),this._params.extensions.push("ANGLE_instanced_arrays")):(this._params.extensions.push("EXT_color_buffer_float"),this._params.extensions.push("OES_texture_float_linear"));let t=this._params.extensions.length;for(;t--;)this.initializeExtension(this._params.extensions[t],!0);this.gl.type==="webgl"?(this.createTexture_n=this.createTexture_n_webgl1.bind(this),this.createTexture_l=this.createTexture_l_webgl1.bind(this),this.createTexture_mm=this.createTexture_mm_webgl1.bind(this),this.createTexture_a=this.createTexture_a_webgl1.bind(this)):(this.createTexture_n=this.createTexture_n_webgl2.bind(this),this.createTexture_l=this.createTexture_l_webgl2.bind(this),this.createTexture_mm=this.createTexture_mm_webgl2.bind(this),this.createTexture_a=this.createTexture_a_webgl2.bind(this)),this.createTexture.NEAREST=this.createTexture_n,this.createTexture.LINEAR=this.createTexture_l,this.createTexture.MIPMAP=this.createTexture_mm,this.createTexture.ANISOTROPIC=this.createTexture_a,this.extensions.EXT_texture_filter_anisotropic?this.createTextureDefault=this.createTexture_a:this.createTextureDefault=this.createTexture_mm,this._initPrograms(),this._setDefaults(),this.intersectionObserver=new IntersectionObserver(n=>{this._toggleVisibilityChange(n[n.length-1].isIntersecting)},{threshold:0}),this.intersectionObserver.observe(this.canvas),this.resizeObserver=new ResizeObserver(n=>{this._toggleVisibilityChange(n[0].contentRect.width!==0&&n[0].contentRect.height!==0)}),this.resizeObserver.observe(this.canvas),document.addEventListener("visibilitychange",()=>{this._toggleVisibilityChange(document.visibilityState==="visible")})}_toggleVisibilityChange(t){t?(this.start(),this.ONCANVASRESIZE&&this.ONCANVASRESIZE(),this.events.dispatch(this.events.visibilitychange,!0)):(this.events.dispatch(this.events.visibilitychange,!1),this.stop())}_setDefaults(){let t=this.gl;t&&this.canvas&&(t.depthFunc(t.LESS),t.enable(t.DEPTH_TEST),this.setSize(this.canvas.clientWidth||this._params.width,this.canvas.clientHeight||this._params.height),t.frontFace(t.CCW),t.cullFace(t.BACK),t.enable(t.CULL_FACE),t.disable(t.BLEND),this.createDefaultTexture({color:"rgba(0,0,0,0.0)"},n=>{this.transparentTexture=n}),this.createDefaultTexture({color:"rgba(255, 255, 255, 1.0)"},n=>{this.defaultTexture=n}))}getCanvasSize(){return this._canvasSize}createStreamArrayBuffer(t,n,s,o=4){let a=this.gl,h=a.createBuffer();return a.bindBuffer(a.ARRAY_BUFFER,h),a.bufferData(a.ARRAY_BUFFER,n*t*o,s||a.STREAM_DRAW),a.bindBuffer(a.ARRAY_BUFFER,null),h.itemSize=t,h.numItems=n,h}setStreamArrayBuffer(t,n,s=0){let o=this.gl;return o.bindBuffer(o.ARRAY_BUFFER,t),o.bufferSubData(o.ARRAY_BUFFER,s,n),o.bindBuffer(o.ARRAY_BUFFER,null),t}createArrayBuffer(t,n,s,o){let a=this.gl,h=a.createBuffer();return a.bindBuffer(a.ARRAY_BUFFER,h),a.bufferData(a.ARRAY_BUFFER,t,o||a.STATIC_DRAW),a.bindBuffer(a.ARRAY_BUFFER,null),h.itemSize=n,h.numItems=s||t.length/n,h}createArrayBufferLength(t,n){let s=this.gl,o=s.createBuffer();return s.bindBuffer(s.ARRAY_BUFFER,o),s.bufferData(s.ARRAY_BUFFER,t,n||s.STATIC_DRAW),s.bindBuffer(s.ARRAY_BUFFER,null),o.itemSize=1,o.numItems=t,o}createElementArrayBuffer(t,n,s,o){let a=this.gl,h=a.createBuffer();return a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,h),a.bufferData(a.ELEMENT_ARRAY_BUFFER,t,o||a.STATIC_DRAW),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,null),h.itemSize=n,h.numItems=s||t.length,h}setSize(t,n){this._params.width=t,this._params.height=n,this.canvas&&(this.canvas.width=t*this._params.pixelRatio,this.canvas.height=n*this._params.pixelRatio,this._canvasSize[0]=this.canvas.width,this._canvasSize[1]=this.canvas.height,this.gl&&this.gl.viewport(0,0,t,n),this.ONCANVASRESIZE&&this.ONCANVASRESIZE(this.canvas),this.events.dispatch(this.events.resize,this))}get pixelRatio(){return this._params.pixelRatio}set pixelRatio(t){this._params.pixelRatio=t,this.setSize(this._params.width,this._params.height)}getWidth(){return this.canvas?this.canvas.width:0}getHeight(){return this.canvas?this.canvas.height:0}getClientAspect(){return this.canvas?this.canvas.clientWidth/this.canvas.clientHeight:0}getCenter(){let t=this.canvas;return t?new H(Math.round(.5*t.width),Math.round(.5*t.height)):new H}clearFrame(){let t=this.gl;t.clearColor(0,0,0,1),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT)}start(){!this._requestAnimationFrameId&&this._initialized&&this._animationFrameCallback()}stop(){this._requestAnimationFrameId&&(window.cancelAnimationFrame(this._requestAnimationFrameId),this._requestAnimationFrameId=0)}isStopped(){return!this._requestAnimationFrameId}isWebGl2(){return!!this.gl&&this.gl.type==="webgl2"}_animationFrameCallback(){this._requestAnimationFrameId=window.requestAnimationFrame(()=>{this._throttledDrawFrame(),this._requestAnimationFrameId&&this._animationFrameCallback()})}createDefaultTexture(t,n){let s,o;if(t&&t.color)s=new mi(2,2),s.fillColor(t.color),o=this.createTexture_n(s.getCanvas()),o.default=!0,n(o);else if(t&&t.url){let a=new Image,h=this;a.onload=function(){o=h.createTextureDefault(a),o.default=!0,n(o)},a.src=t.url}else s=new mi(2,2),s.fillColor("#C5C5C5"),o=this.createTexture_n(s.getCanvas()),o.default=!0,n(o)}deleteTexture(t){t&&!t.default&&this.gl&&this.gl.deleteTexture(t)}destroy(){var t,n;(t=this.resizeObserver)==null||t.disconnect(),(n=this.intersectionObserver)==null||n.disconnect(),this.stop();for(let o in this.programs)this.removeProgram(o);let s=this.gl;if(s){s.deleteTexture(this.transparentTexture),this.transparentTexture=null,s.deleteTexture(this.defaultTexture),this.defaultTexture=null,this.framebufferStack=new Js;let o=s.getParameter(s.MAX_VERTEX_ATTRIBS),a=s.createBuffer();s.bindBuffer(s.ARRAY_BUFFER,a);for(let c=0;c<o;++c)s.disableVertexAttribArray(c),s.vertexAttribPointer(c,4,s.FLOAT,!1,0,0),s.vertexAttrib1f(c,0);s.deleteBuffer(a);let h=s.getParameter(s.MAX_TEXTURE_IMAGE_UNITS);for(let c=0;c<h;++c)s.activeTexture(s.TEXTURE0+c),s.bindTexture(s.TEXTURE_CUBE_MAP,null),s.bindTexture(s.TEXTURE_2D,null);s.activeTexture(s.TEXTURE0),s.useProgram(null),s.bindBuffer(s.ARRAY_BUFFER,null),s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,null),s.bindFramebuffer(s.FRAMEBUFFER,null),s.bindRenderbuffer(s.RENDERBUFFER,null),s.disable(s.BLEND),s.disable(s.CULL_FACE),s.disable(s.DEPTH_TEST),s.disable(s.DITHER),s.disable(s.SCISSOR_TEST),s.blendColor(0,0,0,0),s.blendEquation(s.FUNC_ADD),s.blendFunc(s.ONE,s.ZERO),s.clearColor(0,0,0,0),s.clearDepth(1),s.clearStencil(-1)}this.canvas&&(this.canvas.parentNode&&this.canvas.parentNode.removeChild(this.canvas),this.canvas.width=1,this.canvas.height=1,this.canvas=null),this.gl=null,this._initialized=!1}addClock(t){t.__handler||(t.__handler=this,this._clocks.push(t))}addClocks(t){for(let n=0;n<t.length;n++)this.addClock(t[n])}removeClock(t){if(t.__handler){let n=this._clocks,s=n.length;for(;s--;)if(n[s].isEqual(t)){t.__handler=null,n.splice(s,1);break}}}}class Ta extends hs{constructor(t,n={}){super(t,n),this._internalFormat=n.internalFormat?n.internalFormat.toUpperCase():"RGBA8",this._msaa=n.msaa!=null?n.msaa:4,this._glFilter=0,this.renderbuffers=new Array(this._size)}destroy(){let t=this.handler.gl;if(t){for(let n=0;n<this.renderbuffers.length;n++)t.deleteRenderbuffer(this.renderbuffers[n]);this.renderbuffers=new Array(this._size),t.deleteFramebuffer(this._fbo),t.deleteRenderbuffer(this._depthRenderbuffer),this._depthRenderbuffer=null,this._fbo=null,this._active=!1}}init(){let t=this.handler.gl;if(!t)return;this._glFilter=t[this._filter],this._fbo=t.createFramebuffer(),t.bindFramebuffer(t.FRAMEBUFFER,this._fbo);let n=[];for(let s=0;s<this.renderbuffers.length;s++){let o=t.createRenderbuffer();t.bindRenderbuffer(t.RENDERBUFFER,o),this._msaa>0?t.renderbufferStorageMultisample(t.RENDERBUFFER,this._msaa,t[this._internalFormat],this._width,this._height):t.renderbufferStorage(t.RENDERBUFFER,t[this._internalFormat],this._width,this._height),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0+s,t.RENDERBUFFER,o),n.push(t.COLOR_ATTACHMENT0+s),this.renderbuffers[s]=o,t.bindRenderbuffer(t.RENDERBUFFER,null)}t.drawBuffers(n),this._useDepth&&(this._depthRenderbuffer=t.createRenderbuffer(),t.bindRenderbuffer(t.RENDERBUFFER,this._depthRenderbuffer),t.renderbufferStorageMultisample(t.RENDERBUFFER,this._msaa,t[this._depthComponent],this._width,this._height),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,this._depthRenderbuffer),t.bindRenderbuffer(t.RENDERBUFFER,null)),t.bindFramebuffer(t.FRAMEBUFFER,null)}blitTo(t,n=0){let s=this.handler.gl;s.bindFramebuffer(s.READ_FRAMEBUFFER,this._fbo),s.bindFramebuffer(s.DRAW_FRAMEBUFFER,t._fbo),s.readBuffer(s.COLOR_ATTACHMENT0+n),s.clearBufferfv(s.COLOR,0,[0,0,0,1]),s.blitFramebuffer(0,0,this._width,this._height,0,0,t._width,t._height,s.COLOR_BUFFER_BIT,this._glFilter),s.bindFramebuffer(s.FRAMEBUFFER,null),s.bindFramebuffer(s.READ_FRAMEBUFFER,null),s.bindFramebuffer(s.DRAW_FRAMEBUFFER,null)}}Object.freeze(Object.defineProperty({__proto__:null,Framebuffer:Rt,Handler:Be,Multisample:Ta,Program:X,types:ht},Symbol.toStringTag,{value:"Module"}));class Ca extends Ai{constructor(t,n={}){super(t,n),this._image=n.image||null,this._src=n.src||null,this._onLoad_=null}get instanceName(){return"GeoImage"}abortLoading(){this._image instanceof HTMLImageElement&&(this._image.src="")}setSrc(t){this._planet&&this._planet._geoImageCreator.remove(this),this._src=t,this._sourceReady=!1,this._sourceCreated=!1,this._image=new Image,this._image.crossOrigin="Anonymous",this._onLoad_=this._onLoad.bind(this),this._image.addEventListener("load",this._onLoad_),this._image.src=t}setImage(t){this._planet&&this._planet._geoImageCreator.remove(this),this._sourceCreated=!1,this._sourceReady=!1,this._image=t,this._image.crossOrigin="Anonymous",this._src=t.src,ur(this._image)?this._applyImage(this._image):(this._onLoad_=this._onLoad.bind(this),this._image.addEventListener("load",this._onLoad_))}_createSourceTexture(){!this._sourceCreated&&this._image&&(this._sourceTexture=this._planet.renderer.handler.createTexture_l(this._image),this._sourceCreated=!0)}_onLoad(t){this._applyImage(this._image),this._image instanceof HTMLImageElement&&this._image.removeEventListener("load",this._onLoad_),this._onLoad_=null}_applyImage(t){t&&(this._frameWidth=$e(2*t.width,4096),this._frameHeight=$e(3*t.height,4096),this._sourceReady=!0,this._planet&&this._planet._geoImageCreator.add(this))}loadMaterial(t){t.isLoading=!0,this._creationProceeding=!0,!this._sourceReady&&this._src?this._image?this._image instanceof HTMLImageElement&&(ur(this._image)?this._applyImage(this._image):(this._onLoad_=this._onLoad.bind(this),this._image.addEventListener("load",this._onLoad_))):(this._image=new Image,this._image.crossOrigin="Anonymous",this._onLoad_=this._onLoad.bind(this),this._image.addEventListener("load",this._onLoad_),this._image.src=this._src):this._planet&&this._planet._geoImageCreator.add(this)}abortMaterialLoading(t){this._image&&this._image instanceof HTMLImageElement&&(this._image.src=""),this._creationProceeding=!1,t.isLoading=!1,t.isReady=!1}}Object.freeze(Object.defineProperty({__proto__:null,AtmosphereConfig:class extends Q{constructor(l={}){super(l),this.$maxOpacity=null,this.$minOpacity=null,this.$rayleight=null,this.$mie=null,this.$height=null,this.$bottomRadius=null,this.$mieScatteringCoefficient=null,this.$mieExtinctionCoefficient=null,this.$rayleighScatteringCoefficientA=null,this.$rayleighScatteringCoefficientB=null,this.$rayleighScatteringCoefficientC=null,this.$ozoneAbsorptionCoefficientA=null,this.$ozoneAbsorptionCoefficientB=null,this.$ozoneAbsorptionCoefficientC=null,this.$sunAngularRadius=null,this.$sunIntensity=null,this.$groundAlbedo=null,this.$ozoneDensityHeight=null,this.$ozoneDensityWide=null,this._toggleBtn=new dt({classList:["og-map-button","og-atmosphere_button"],icon:`<?xml version="1.0" encoding="utf-8"?><!-- Uploaded to: SVG Repo, www.svgrepo.com, Generator: SVG Repo Mixer Tools -->
<svg width="800px" height="800px" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><path fill="#000000" d="M135.688 18.5c-6.798 74.842-23.842 85.39-107.907 59.656 84.85 52.022 73.57 64.954-6.843 96.938 87.743-10.27 103.29 4.89 70.75 87.594 17.805-27.56 32.5-44.498 46.282-54.47-11.813 28.26-18.345 59.274-18.345 91.813 0 84.184 43.71 157.96 109.656 200.376-41.624-43.834-67.686-102.7-67.686-167.875 0-134.923 109.45-244.405 244.375-244.405 30.92 0 60.76 5.762 88 16.25-38.584-26.87-85.517-42.625-136.064-42.625-55.257 0-106.14 18.802-146.562 50.375 4.627-18.783 17.39-38.073 41.03-60.906C190.18 90.942 153.53 95.634 135.69 18.5zm10.03 77.188c5.67.002 11.428 1.247 16.876 3.874 14.506 6.998 22.72 21.81 22 36.938-10.26 10.87-19.507 22.696-27.594 35.344-9.035 2.753-19.075 2.27-28.25-2.156-19.37-9.343-27.5-32.6-18.156-51.97 6.715-13.92 20.638-22.036 35.125-22.03z"/></svg>`}),this._dialog=new Kt({title:"Atmosphere Parameters",visible:!1,useHide:!0,top:60,left:60,width:720}),this._dialog.events.on("visibility",t=>{this._toggleBtn.setActive(t)}),this._panel=new ut({template:`<div class="og-atmosphere og-options-container">
         
         <div class="og-option og-atmosphere-maxOpacity"></div> 
         <div class="og-option og-atmosphere-minOpacity"></div>
         
       <div class="og-emptyline-2"></div>
         
         <div class="og-option og-atmosphere-rayleight"></div>
         <div class="og-option og-atmosphere-mie"></div>
         
       <div class="og-emptyline-2"></div>
                  
         <div class="og-option og-atmosphere-height"></div> 
         <div class="og-option og-atmosphere-bottomRadius"></div>
         
       <div class="og-emptyline-2"></div>
         
         <div class="og-option og-atmosphere-mieScatteringCoefficient"></div>  
         <div class="og-option og-atmosphere-mieExtinctionCoefficient"></div>
         
       <div class="og-emptyline-2"></div>
         
         <div class="og-option og-atmosphere-rayleighScatteringCoefficientA"></div>    
         <div class="og-option og-atmosphere-rayleighScatteringCoefficientB"></div>    
         <div class="og-option og-atmosphere-rayleighScatteringCoefficientC"></div>
         
       <div class="og-emptyline-2"></div>
         
         <div class="og-option og-atmosphere-ozoneAbsorptionCoefficientA"></div>    
         <div class="og-option og-atmosphere-ozoneAbsorptionCoefficientB"></div>    
         <div class="og-option og-atmosphere-ozoneAbsorptionCoefficientC"></div>
         
       <div class="og-emptyline-2"></div>
         
         <div class="og-option og-atmosphere-ozoneDensityHeight"></div>    
         <div class="og-option og-atmosphere-ozoneDensityWide"></div>    
         
       <div class="og-emptyline-2"></div>
         
         <div class="og-option og-atmosphere-sunAngularRadius"></div> 
         <div class="og-option og-atmosphere-sunIntensity"></div> 
         <div class="og-option og-atmosphere-groundAlbedo"></div>
       
    </div>`}),this._maxOpacity=new Z$1({label:"Max.opacity",max:5}),this._minOpacity=new Z$1({label:"Min.opacity",max:5}),this._rayleight=new Z$1({label:"Rayleight Scale",min:-10,max:10}),this._mie=new Z$1({label:"Mie Scale",min:-10,max:10}),this._height=new Z$1({label:"Height",max:1e6}),this._bottomRadius=new Z$1({label:"Polar Radius (BOTTOM_RADIUS)",max:31783761571225896e-9}),this._equatorialRadius=new Z$1({label:"Equatorial Radius (EQUATORIAL_RADIUS)",max:31890685}),this._mieScatteringCoefficient=new Z$1({label:"Mie Scattering Coefficient e-6",min:-39.96,max:39.96}),this._mieExtinctionCoefficient=new Z$1({label:"Mie Extinction Coef.e-6",min:4.44*-10,max:10*4.44}),this._rayleighScatteringCoefficientA=new Z$1({label:"Rayleight Scattering Coef A.e-6",min:5.802*-10,max:10*5.802}),this._rayleighScatteringCoefficientB=new Z$1({label:"Rayleight Scattering Coef B.e-6",min:13.558*-10,max:10*13.558}),this._rayleighScatteringCoefficientC=new Z$1({label:"Rayleight Scattering Coef C.e-6",min:-331,max:331}),this._ozoneAbsorptionCoefficientA=new Z$1({label:"Ozone absorbtion Coef A.e-6",min:-6.5,max:6.5}),this._ozoneAbsorptionCoefficientB=new Z$1({label:"Ozone absorbtion Coef B.e-6",min:-6.5,max:18.81}),this._ozoneAbsorptionCoefficientC=new Z$1({label:"Ozone absorbtion Coef C.e-6",min:.085*-10,max:10*.085}),this._ozoneDensityHeight=new Z$1({label:"Ozone Density Height",max:25e5}),this._ozoneDensityWide=new Z$1({label:"Ozone Density Wide",max:25e5}),this._sunAngularRadius=new Z$1({label:"Sun Angular Radius",max:4.685}),this._sunIntensity=new Z$1({label:"Sun Intensity",max:10}),this._groundAlbedo=new Z$1({label:"Ground Albedo (GROUND_ALBEDO)",max:.5}),this._parameters={ATMOS_HEIGHT:0,RAYLEIGH_SCALE:0,MIE_SCALE:0,GROUND_ALBEDO:0,BOTTOM_RADIUS:0,EQUATORIAL_RADIUS:0,rayleighScatteringCoefficient_0:0,rayleighScatteringCoefficient_1:0,rayleighScatteringCoefficient_2:0,mieScatteringCoefficient:0,mieExtinctionCoefficient:0,ozoneAbsorptionCoefficient_0:0,ozoneAbsorptionCoefficient_1:0,ozoneAbsorptionCoefficient_2:0,SUN_ANGULAR_RADIUS:0,SUN_INTENSITY:0,ozoneDensityHeight:0,ozoneDensityWide:0,disableSunDisk:!1}}oninit(){this._toggleBtn.appendTo(this.renderer.div),this._dialog.appendTo(this.renderer.div),this._panel.appendTo(this._dialog.container),this._panel.el&&(this.$height=this._panel.el.querySelector(".og-option.og-atmosphere-height"),this.$maxOpacity=this._panel.el.querySelector(".og-option.og-atmosphere-maxOpacity"),this.$minOpacity=this._panel.el.querySelector(".og-option.og-atmosphere-minOpacity"),this.$rayleight=this._panel.el.querySelector(".og-option.og-atmosphere-rayleight"),this.$mie=this._panel.el.querySelector(".og-option.og-atmosphere-mie"),this.$bottomRadius=this._panel.el.querySelector(".og-option.og-atmosphere-bottomRadius"),this.$mieScatteringCoefficient=this._panel.el.querySelector(".og-option.og-atmosphere-mieScatteringCoefficient"),this.$mieExtinctionCoefficient=this._panel.el.querySelector(".og-option.og-atmosphere-mieExtinctionCoefficient"),this.$rayleighScatteringCoefficientA=this._panel.el.querySelector(".og-option.og-atmosphere-rayleighScatteringCoefficientA"),this.$rayleighScatteringCoefficientB=this._panel.el.querySelector(".og-option.og-atmosphere-rayleighScatteringCoefficientB"),this.$rayleighScatteringCoefficientC=this._panel.el.querySelector(".og-option.og-atmosphere-rayleighScatteringCoefficientC"),this.$ozoneAbsorptionCoefficientA=this._panel.el.querySelector(".og-option.og-atmosphere-ozoneAbsorptionCoefficientA"),this.$ozoneAbsorptionCoefficientB=this._panel.el.querySelector(".og-option.og-atmosphere-ozoneAbsorptionCoefficientB"),this.$ozoneAbsorptionCoefficientC=this._panel.el.querySelector(".og-option.og-atmosphere-ozoneAbsorptionCoefficientC"),this.$sunAngularRadius=this._panel.el.querySelector(".og-option.og-atmosphere-sunAngularRadius"),this.$sunIntensity=this._panel.el.querySelector(".og-option.og-atmosphere-sunIntensity"),this.$groundAlbedo=this._panel.el.querySelector(".og-option.og-atmosphere-groundAlbedo"),this.$ozoneDensityHeight=this._panel.el.querySelector(".og-option.og-atmosphere-ozoneDensityHeight"),this.$ozoneDensityWide=this._panel.el.querySelector(".og-option.og-atmosphere-ozoneDensityWide")),this._toggleBtn.events.on("change",l=>{this._dialog.setVisibility(l)}),this._maxOpacity.appendTo(this.$maxOpacity),this._minOpacity.appendTo(this.$minOpacity),this._height.appendTo(this.$height),this._rayleight.appendTo(this.$rayleight),this._mie.appendTo(this.$mie),this._bottomRadius.appendTo(this.$bottomRadius),this._equatorialRadius.appendTo(this.$bottomRadius),this._mieScatteringCoefficient.appendTo(this.$mieScatteringCoefficient),this._mieExtinctionCoefficient.appendTo(this.$mieExtinctionCoefficient),this._rayleighScatteringCoefficientA.appendTo(this.$rayleighScatteringCoefficientA),this._rayleighScatteringCoefficientB.appendTo(this.$rayleighScatteringCoefficientB),this._rayleighScatteringCoefficientC.appendTo(this.$rayleighScatteringCoefficientC),this._ozoneAbsorptionCoefficientA.appendTo(this.$ozoneAbsorptionCoefficientA),this._ozoneAbsorptionCoefficientB.appendTo(this.$ozoneAbsorptionCoefficientB),this._ozoneAbsorptionCoefficientC.appendTo(this.$ozoneAbsorptionCoefficientC),this._sunAngularRadius.appendTo(this.$sunAngularRadius),this._sunIntensity.appendTo(this.$sunIntensity),this._groundAlbedo.appendTo(this.$groundAlbedo),this._ozoneDensityHeight.appendTo(this.$ozoneDensityHeight),this._ozoneDensityWide.appendTo(this.$ozoneDensityWide),this.planet&&(this._parameters=this.planet.atmosphereControl.parameters,this._bottomRadius.max=5*this.planet.ellipsoid.getPolarSize(),this._equatorialRadius.max=5*this.planet.ellipsoid.getEquatorialSize(),this._height.value=this._parameters.ATMOS_HEIGHT,this._rayleight.value=this._parameters.RAYLEIGH_SCALE,this._mie.value=this._parameters.MIE_SCALE,this._bottomRadius.value=this._parameters.BOTTOM_RADIUS,this._equatorialRadius.value=this._parameters.EQUATORIAL_RADIUS,this._mieScatteringCoefficient.value=this._parameters.mieScatteringCoefficient,this._mieExtinctionCoefficient.value=this._parameters.mieExtinctionCoefficient,this._rayleighScatteringCoefficientA.value=this._parameters.rayleighScatteringCoefficient_0,this._rayleighScatteringCoefficientB.value=this._parameters.rayleighScatteringCoefficient_1,this._rayleighScatteringCoefficientC.value=this._parameters.rayleighScatteringCoefficient_2,this._ozoneAbsorptionCoefficientA.value=this._parameters.ozoneAbsorptionCoefficient_0,this._ozoneAbsorptionCoefficientB.value=this._parameters.ozoneAbsorptionCoefficient_1,this._ozoneAbsorptionCoefficientC.value=this._parameters.ozoneAbsorptionCoefficient_2,this._sunAngularRadius.value=this._parameters.SUN_ANGULAR_RADIUS,this._sunIntensity.value=this._parameters.SUN_INTENSITY,this._groundAlbedo.value=this._parameters.GROUND_ALBEDO,this._ozoneDensityHeight.value=this._parameters.ozoneDensityHeight,this._ozoneDensityWide.value=this._parameters.ozoneDensityWide),this._minOpacity.value=this.planet.atmosphereMinOpacity,this._minOpacity.events.on("change",l=>{this.planet.atmosphereMinOpacity=l}),this._maxOpacity.value=this.planet.atmosphereMaxOpacity,this._maxOpacity.events.on("change",l=>{this.planet.atmosphereMaxOpacity=l}),this._rayleight.events.on("change",l=>{this._parameters.RAYLEIGH_SCALE=l,this._update()}),this._mie.events.on("change",l=>{this._parameters.MIE_SCALE=l,this._update()}),this._height.events.on("change",l=>{this._parameters.ATMOS_HEIGHT=l,this._update()}),this._bottomRadius.events.on("change",l=>{this._parameters.BOTTOM_RADIUS=l,this._update()}),this._equatorialRadius.events.on("change",l=>{this._parameters.EQUATORIAL_RADIUS=l,this._update()}),this._mieScatteringCoefficient.events.on("change",l=>{this._parameters.mieScatteringCoefficient=l,this._update()}),this._mieExtinctionCoefficient.events.on("change",l=>{this._parameters.mieExtinctionCoefficient=l,this._update()}),this._rayleighScatteringCoefficientA.events.on("change",l=>{this._parameters.rayleighScatteringCoefficient_0=l,this._update()}),this._rayleighScatteringCoefficientB.events.on("change",l=>{this._parameters.rayleighScatteringCoefficient_1=l,this._update()}),this._rayleighScatteringCoefficientC.events.on("change",l=>{this._parameters.rayleighScatteringCoefficient_2=l,this._update()}),this._ozoneAbsorptionCoefficientA.events.on("change",l=>{this._parameters.ozoneAbsorptionCoefficient_0=l,this._update()}),this._ozoneAbsorptionCoefficientB.events.on("change",l=>{this._parameters.ozoneAbsorptionCoefficient_1=l,this._update()}),this._ozoneAbsorptionCoefficientC.events.on("change",l=>{this._parameters.ozoneAbsorptionCoefficient_2=l,this._update()}),this._sunAngularRadius.events.on("change",l=>{this._parameters.SUN_ANGULAR_RADIUS=l,this._update()}),this._sunIntensity.events.on("change",l=>{this._parameters.SUN_INTENSITY=l,this._update()}),this._groundAlbedo.events.on("change",l=>{this._parameters.GROUND_ALBEDO=l,this._update()}),this._ozoneDensityHeight.events.on("change",l=>{this._parameters.ozoneDensityHeight=l,this._update()}),this._ozoneDensityWide.events.on("change",l=>{this._parameters.ozoneDensityWide=l,this._update()})}_update(){this.planet&&this.planet.atmosphereControl.setParameters(this._parameters)}},CameraDepthHandler:class extends Q{constructor(l){super(l),this._skipPreRender=!1,this._depthHandlerCallback=t=>{if(!this.planet)return;let n=t.frameBuffer;if(n.handler.gl,n.activate(),this._quadTreeStrategy){let c=t.camera;this._skipPreRender&&this._quadTreeStrategy.collectRenderNodes(c),this._skipPreRender=!0,console.log(this._quadTreeStrategy._renderedNodes)}n.deactivate(),n.readPixelBuffersAsync();let s=this.getLonLatFromPixelTerrain(1,1),o=this.getLonLatFromPixelTerrain(n.width-1,1),a=this.getLonLatFromPixelTerrain(n.width-1,n.height-1),h=this.getLonLatFromPixelTerrain(1,n.height-1);s&&o&&a&&h&&this.cameraGeoImage.setCorners([[s.lon,s.lat],[o.lon,o.lat],[a.lon,a.lat],[h.lon,h.lat]])},this._frameComposer=new Fr,this._frameHandler=null,this.cameraGeoImage=new Ca(`cameraGeoImage:${this.__id}`,{src:"test4.jpg",corners:[[0,1],[1,1],[1,0],[0,0]],visibility:!0,isBaseLayer:!1,opacity:.7}),this._quadTreeStrategy=null}_createCamera(){return this.planet?new wa(this.planet,{frustums:[[100,1e9]],width:640,height:480,viewAngle:45}):new Pi({frustums:[[100,1e9]],width:640,height:480,viewAngle:45})}get camera(){if(this._frameHandler)return this._frameHandler.camera}oninit(){if(super.oninit(),!this.renderer)return;this.renderer.handler.addProgram(new X("camera_depth",{uniforms:{projectionMatrix:"mat4",viewMatrix:"mat4",height:"float",eyePositionHigh:"vec3",eyePositionLow:"vec3"},attributes:{aVertexPositionHigh:"vec3",aVertexPositionLow:"vec3"},vertexShader:`#version 300 es
            
            precision highp float;

            in vec3 aVertexPositionHigh;
            in vec3 aVertexPositionLow;

            uniform mat4 projectionMatrix;
            uniform mat4 viewMatrix;
            uniform vec3 eyePositionHigh;
            uniform vec3 eyePositionLow;
            uniform float height;

            void main(void) {

                mat4 viewMatrixRTE = viewMatrix;
                viewMatrixRTE[3] = vec4(0.0, 0.0, 0.0, 1.0);

                mat4 m = projectionMatrix * viewMatrixRTE;

                vec3 nh = height * normalize(aVertexPositionHigh + aVertexPositionLow);

                vec3 eyePosition = eyePositionHigh + eyePositionLow;
                vec3 vertexPosition = aVertexPositionHigh + aVertexPositionLow;

                vec3 highDiff = aVertexPositionHigh - eyePositionHigh;
                vec3 lowDiff = aVertexPositionLow - eyePositionLow + nh;
                
                gl_Position =  m * vec4(highDiff * step(1.0, length(highDiff)) + lowDiff, 1.0);    
            }`,fragmentShader:`#version 300 es
            
            precision highp float;        

            layout(location = 0) out vec4 depthColor;

            void main(void) {
                depthColor = vec4(gl_FragCoord.z, gl_FragCoord.z, gl_FragCoord.z, 1.0);
            }`})),this.planet&&this.planet.addLayer(this.cameraGeoImage);let l=new Rt(this.renderer.handler,{width:640,height:480,targets:[{internalFormat:"RGBA16F",type:"FLOAT",attachment:"COLOR_ATTACHMENT",readAsync:!0}],useDepth:!0});if(this._frameHandler=new to({camera:this._createCamera(),frameBuffer:l,frameHandler:this._depthHandlerCallback}),this.renderer.controls.CameraFrameComposer?this._frameComposer=this.renderer.controls.CameraFrameComposer:this.renderer.addControl(this._frameComposer),this._frameComposer.add(this._frameHandler),this.planet){const t={planet:this.planet,maxEqualZoomAltitude:this.planet.quadTreeStrategy.maxEqualZoomAltitude,minEqualZoomAltitude:this.planet.quadTreeStrategy.minEqualZoomAltitude,minEqualZoomCameraSlope:this.planet.quadTreeStrategy.minEqualZoomCameraSlope,transitionOpacityEnabled:!1};this._quadTreeStrategy=new this.planet.quadTreeStrategyPrototype(t),this._quadTreeStrategy.init(this.camera),this._quadTreeStrategy.preRender(),this._quadTreeStrategy.clearRenderedNodes(),this._skipPreRender=!1,this._quadTreeStrategy.preLoad()}}get framebuffer(){if(this._frameHandler)return this._frameHandler.frameBuffer}getCartesianFromPixelTerrain(l,t){if(this._frameHandler){let n=this._frameHandler.frameBuffer,s=this._frameHandler.camera,o=function(c,u,d,f){let g=new H(c,u),_=g.x/f.width,m=(f.height-g.y)/f.height,p=new Float32Array(4),x=0;if(f.readData(_,m,p,0),p[0]===0)return 0;let y=p[0],T=d.frustums[0].inverseProjectionMatrix,S=new et(2*_-1,2*m-1,2*y-1,1),C=T.mulVec4(S),P=d.unproject(_*d.width,(1-m)*d.height);return x=-C.z/C.w/P.dot(d.getForward()),x}(l,t,s,n);if(o===0)return;let a=l/n.width,h=(n.height-t)/n.height;return s.unproject(a*s.width,(1-h)*s.height).scaleTo(o).addA(s.eye)}}getLonLatFromPixelTerrain(l,t){if(this.planet){let n=this.getCartesianFromPixelTerrain(l,t);if(n)return this.planet.ellipsoid.cartesianToLonLat(n)}}activate(){super.activate()}deactivate(){super.deactivate()}},CameraFrameComposer:Fr,CameraFrameHandler:to,CameraLock:Jn,CompassButton:Ho,Control:Q,DebugInfo:class extends Q{constructor(l={}){l.name&&l.name!==""||(l.name="DebugInfo"),super(l),this.el=null,this._watch=l.watch||[],this._toggleBtn=new dt({classList:["og-map-button","og-debuginfo_button"],icon:`<?xml version="1.0" encoding="iso-8859-1"?>
<!-- Uploaded to: SVG Repo, www.svgrepo.com, Generator: SVG Repo Mixer Tools -->
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg fill="#000000" version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" 
	 width="800px" height="800px" viewBox="0 0 932.179 932.179"
	 xml:space="preserve">
<g>
	<path d="M61.2,341.538c4.9,16.8,11.7,33,20.3,48.2l-24.5,30.9c-8,10.1-7.1,24.5,1.9,33.6l42.2,42.2c9.1,9.1,23.5,9.899,33.6,1.899
		l30.7-24.3c15.8,9.101,32.6,16.2,50.1,21.2l4.6,39.5c1.5,12.8,12.3,22.4,25.1,22.4h59.7c12.8,0,23.6-9.601,25.1-22.4l4.4-38.1
		c18.8-4.9,36.8-12.2,53.7-21.7l29.7,23.5c10.1,8,24.5,7.1,33.6-1.9l42.2-42.2c9.1-9.1,9.9-23.5,1.9-33.6l-23.1-29.3
		c9.6-16.601,17.1-34.3,22.1-52.8l35.6-4.1c12.801-1.5,22.4-12.3,22.4-25.1v-59.7c0-12.8-9.6-23.6-22.4-25.1l-35.1-4.1
		c-4.801-18.3-12-35.8-21.199-52.2l21.6-27.3c8-10.1,7.1-24.5-1.9-33.6l-42.1-42.1c-9.1-9.1-23.5-9.9-33.6-1.9l-26.5,21
		c-17.2-10.1-35.601-17.8-54.9-23l-4-34.3c-1.5-12.8-12.3-22.4-25.1-22.4h-59.7c-12.8,0-23.6,9.6-25.1,22.4l-4,34.3
		c-19.8,5.3-38.7,13.3-56.3,23.8l-27.5-21.8c-10.1-8-24.5-7.1-33.6,1.9l-42.2,42.2c-9.1,9.1-9.9,23.5-1.9,33.6l23,29.1
		c-9.2,16.6-16.2,34.3-20.8,52.7l-36.8,4.2c-12.8,1.5-22.4,12.3-22.4,25.1v59.7c0,12.8,9.6,23.6,22.4,25.1L61.2,341.538z
		 M277.5,180.038c54.4,0,98.7,44.3,98.7,98.7s-44.3,98.7-98.7,98.7c-54.399,0-98.7-44.3-98.7-98.7S223.1,180.038,277.5,180.038z"/>
	<path d="M867.699,356.238l-31.5-26.6c-9.699-8.2-24-7.8-33.199,0.9l-17.4,16.3c-14.699-7.1-30.299-12.1-46.4-15l-4.898-24
		c-2.5-12.4-14-21-26.602-20l-41.1,3.5c-12.6,1.1-22.5,11.4-22.9,24.1l-0.799,24.4c-15.801,5.7-30.701,13.5-44.301,23.3
		l-20.799-13.8c-10.602-7-24.701-5-32.9,4.7l-26.6,31.7c-8.201,9.7-7.801,24,0.898,33.2l18.201,19.399
		c-6.301,14.2-10.801,29.101-13.4,44.4l-26,5.3c-12.4,2.5-21,14-20,26.601l3.5,41.1c1.1,12.6,11.4,22.5,24.1,22.9l28.1,0.899
		c5.102,13.4,11.801,26.101,19.9,38l-15.699,23.7c-7,10.6-5,24.7,4.699,32.9l31.5,26.6c9.701,8.2,24,7.8,33.201-0.9l20.6-19.3
		c13.5,6.3,27.699,11,42.299,13.8l5.701,28.2c2.5,12.4,14,21,26.6,20l41.1-3.5c12.6-1.1,22.5-11.399,22.9-24.1l0.9-27.601
		c15-5.3,29.199-12.5,42.299-21.399l22.701,15c10.6,7,24.699,5,32.9-4.7l26.6-31.5c8.199-9.7,7.799-24-0.9-33.2l-18.301-19.399
		c6.701-14.2,11.602-29.2,14.4-44.601l25-5.1c12.4-2.5,21-14,20-26.601l-3.5-41.1c-1.1-12.6-11.4-22.5-24.1-22.9l-25.1-0.8
		c-5.201-14.6-12.201-28.399-20.9-41.2l13.699-20.6C879.4,378.638,877.4,364.438,867.699,356.238z M712.801,593.837
		c-44.4,3.801-83.602-29.3-87.301-73.699c-3.801-44.4,29.301-83.601,73.699-87.301c44.4-3.8,83.602,29.301,87.301,73.7
		C790.301,550.938,757.199,590.138,712.801,593.837z"/>
	<path d="M205,704.438c-12.6,1.3-22.3,11.899-22.4,24.6l-0.3,25.3c-0.2,12.7,9.2,23.5,21.8,25.101l18.6,2.399
		c3.1,11.301,7.5,22.101,13.2,32.301l-12,14.8c-8,9.899-7.4,24.1,1.5,33.2l17.7,18.1c8.9,9.1,23.1,10.1,33.2,2.3l14.899-11.5
		c10.5,6.2,21.601,11.101,33.2,14.5l2,19.2c1.3,12.6,11.9,22.3,24.6,22.4l25.301,0.3c12.699,0.2,23.5-9.2,25.1-21.8l2.3-18.2
		c12.601-3.101,24.601-7.8,36-14l14,11.3c9.9,8,24.101,7.4,33.201-1.5l18.1-17.7c9.1-8.899,10.1-23.1,2.301-33.2L496.6,818.438
		c6.6-11,11.701-22.7,15.201-35l16.6-1.7c12.6-1.3,22.299-11.9,22.4-24.6l0.299-25.301c0.201-12.699-9.199-23.5-21.799-25.1
		l-16.201-2.1c-3.1-12.2-7.699-24-13.699-35l10.1-12.4c8-9.9,7.4-24.1-1.5-33.2l-17.699-18.1c-8.9-9.101-23.102-10.101-33.201-2.3
		l-12.101,9.3c-11.399-6.9-23.6-12.2-36.399-15.8l-1.601-15.7c-1.3-12.601-11.899-22.3-24.6-22.4l-25.3-0.3
		c-12.7-0.2-23.5,9.2-25.101,21.8l-2,15.601c-13.199,3.399-25.899,8.6-37.699,15.399l-12.5-10.2c-9.9-8-24.101-7.399-33.201,1.5
		l-18.2,17.801c-9.1,8.899-10.1,23.1-2.3,33.199l10.7,13.801c-6.2,11-11.1,22.699-14.3,35L205,704.438z M368.3,675.837
		c36.3,0.4,65.399,30.301,65,66.601c-0.4,36.3-30.301,65.399-66.601,65c-36.3-0.4-65.399-30.3-65-66.601
		C302.1,704.538,332,675.438,368.3,675.837z"/>
</g>
</svg>`}),this._dialog=new Kt({title:"Debug Info",visible:!1,useHide:!0,top:120,left:60,width:480}),this._dialog.events.on("visibility",t=>{this._toggleBtn.setActive(t)}),this._canvasTiles=new ss("Tile grid",{visibility:!0,isBaseLayer:!1,hideInLayerSwitcher:!0,drawTile:function(t,n){let s,o=document.createElement("canvas"),a=o.getContext("2d");o.width=256,o.height=256,a.clearRect(0,0,o.width,o.height),a.beginPath(),a.rect(0,0,o.width,o.height),a.lineWidth=2,a.strokeStyle="black",a.stroke(),s=t.segment.tileZoom>14?"26":"32",a.fillStyle="black",a.font="normal "+s+"px Verdana",a.textAlign="center",a.fillText(t.segment.tileX+","+t.segment.tileY+","+t.segment.tileZoom,o.width/2,o.height/2),n(o)}})}addWatches(l){for(let t=0;t<l.length;t++)this.addWatch(l[t])}addWatch(l){this._watch.push(l);let t=document.createElement("div");t.classList.add("og-watch-line"),t.innerHTML=`<div class="og-watch-label">${l.label}</div><div class="og-watch-value"></div>`,l.valEl=t.querySelector(".og-watch-value"),this.el.appendChild(t)}oninit(){var l;this._toggleBtn.appendTo(this.renderer.div),this._dialog.appendTo(this.renderer.div),this._toggleBtn.events.on("change",h=>{this._dialog.setVisibility(h)}),this.el=document.createElement("div"),this.el.className="og-debug-info";let t=document.createElement("div");t.classList.add("og-debuginfo_controls"),this.el.appendChild(t);let n=this._watch;this._watch=[];for(let h=0;h<n.length;h++)this.addWatch(n[h]);(l=this._dialog.container)==null||l.appendChild(this.el),this.renderer.events.on("draw",this._frame,this);let s=this.planet;s&&this.addWatches([{label:"Nodes count",frame:()=>s.quadTreeStrategy._renderedNodes.length},{label:"Planet._fadingNodes",frame:()=>s.quadTreeStrategy._fadingNodes.size},{label:"createdNodes",frame:()=>s._createdNodesCount},{label:"indexesCache",frame:()=>s._indexesCacheToRemoveCounter},{label:"distBeforeMemClear",frame:()=>Math.round(s._distBeforeMemClear)},{label:"maxZoom/minZoom",frame:()=>s.quadTreeStrategy.maxCurrZoom+" / "+(s==null?void 0:s.quadTreeStrategy.minCurrZoom)},{label:"viewExtent",frame:()=>s.getViewExtent().toString()},{label:"Mouse distance, m",frame:()=>{let h=s.getCartesianFromMouseTerrain();return h?s.camera.eye.distance(h).toFixed(3):""}},{label:"lodSize",frame:()=>Math.round(s.quadTreeStrategy.lodSize)},{label:"deltaTime/FPS",frame:()=>`<div style="width:70px"><div style="width:20px; float: left;">
                        ${Math.round(s.renderer.handler.deltaTime)}
                        </div> <div style="float: left">
                        ${Math.round(1e3/s.renderer.handler.deltaTime)}
                        </div></div>`},{label:"-------------------------"},{label:"Pitch, deg",frame:()=>(s.camera.getPitch()*J).toFixed(2)},{label:"Yaw, deg",frame:()=>(s.camera.getYaw()*J).toFixed(2)},{label:"Roll, deg",frame:()=>(s.camera.getRoll()*J).toFixed(2)},{label:"Lon, Lat",frame:()=>`<div style="width:190px">${s.camera._lonLat.lon.toFixed(7)}, ${s.camera._lonLat.lon.toFixed(7)}</div>`},{label:"height/alt, m",frame:()=>`<div style="width:190px">${s.camera._lonLat.height.toFixed(2)+" / "+s.camera.getAltitude().toFixed(2)}</div>`},{label:"cam.slope",frame:()=>s.camera.slope.toFixed(3)},{label:"-------------------------"},{label:"_renderCompleted / renderCompletedActivated",frame:()=>`${s.quadTreeStrategy._renderCompleted} / ${s.quadTreeStrategy._renderCompletedActivated}`},{label:"_terrainCompleted / terrainCompletedActivated",frame:()=>`${s.quadTreeStrategy._terrainCompleted} / ${s.quadTreeStrategy._terrainCompletedActivated}`},{label:"PlainWorker",frame:()=>s._plainSegmentWorker.pendingQueue.length},{label:"TileLoader",frame:()=>`${s._tileLoader.loading} ${s._tileLoader.queue.length}`},{label:"TerrainLoader",frame:()=>s.terrain&&!s.terrain.isEmpty?`${s.terrain.loader.loading}  ${s.terrain.loader.queue.length}`:""},{label:"TerrainWorker",frame:()=>s._terrainWorker.pendingQueue.length},{label:"NormalMapCreator",frame:()=>s._normalMapCreator.queueSize},{label:"VectorTileCreator",frame:()=>s._vectorTileCreator.queueSize}]);let o=new dt({classList:["og-debuginfo_controls-button"],icon:`<?xml version="1.0" encoding="utf-8"?>
<!-- Uploaded to: SVG Repo, www.svgrepo.com, Generator: SVG Repo Mixer Tools -->
<svg fill="#000000" width="800px" height="800px" viewBox="-7.5 0 32 32" version="1.1" xmlns="http://www.w3.org/2000/svg">
<title>lock</title>
<path d="M14.625 15.156h2.094c0.281 0 0.5 0.25 0.5 0.531v11c0 0.281-0.219 0.5-0.5 0.5h-16.219c-0.281 0-0.5-0.219-0.5-0.5v-11c0-0.281 0.219-0.531 0.5-0.531h2.031v-5.125c0-2.875 1.844-5.25 4.688-5.25h2.688c2.875 0 4.719 2.375 4.719 5.25v5.125zM5.188 15.156h6.813v-4.875c0-1.594-1.313-2.938-2.938-2.938h-0.969c-1.594 0-2.906 1.344-2.906 2.938v4.875zM7.156 24h2.906l-0.719-3.156c0.5-0.25 0.844-0.781 0.844-1.375 0-0.906-0.719-1.594-1.594-1.594s-1.563 0.688-1.563 1.594c0 0.594 0.344 1.125 0.844 1.375z"></path>
</svg>`,title:"Lock/Unlock quad tree"});o.appendTo(t),o.events.on("change",h=>{h?s.lockQuadTree():s.unlockQuadTree()});let a=new dt({classList:["og-debuginfo_controls-button"],icon:`<?xml version="1.0"?>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
    <path d="M 4 4 L 4 8 L 8 8 L 8 4 L 4 4 z M 10 4 L 10 8 L 14 8 L 14 4 L 10 4 z M 16 4 L 16 8 L 20 8 L 20 4 L 16 4 z M 4 10 L 4 14 L 8 14 L 8 10 L 4 10 z M 10 10 L 10 14 L 14 14 L 14 10 L 10 10 z M 16 10 L 16 14 L 20 14 L 20 10 L 16 10 z M 4 16 L 4 20 L 8 20 L 8 16 L 4 16 z M 10 16 L 10 20 L 14 20 L 14 16 L 10 16 z M 16 16 L 16 20 L 20 20 L 20 16 L 16 16 z"/>
</svg>`,title:"Show/Hide grid"});a.appendTo(t),a.events.on("change",h=>{h?this.planet.addLayer(this._canvasTiles):this._canvasTiles.remove()})}_frame(){this._watch.forEach(l=>{l.valEl&&(l.valEl.innerHTML=l.frame?String(l.frame()):"")})}},DrawingControl:kn,DrawingSwitcher:class extends Q{constructor(l={}){super({name:"DrawingSwitcher",...l}),this.drawingControl=new kn(l)}oninit(){this.planet.addControl(this.drawingControl),this._createMenu()}onactivate(){this.drawingControl.activate()}ondeactivate(){this.drawingControl.deactivate()}_createMenu(){let l=new dt({classList:["og-map-button","og-drawing-default_button"],icon:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M4 0l16 12.279-6.951 1.17 4.325 8.817-3.596 1.734-4.35-8.879-5.428 4.702z"/></svg>',name:"default",isActive:!0}),t=new dt({classList:["og-map-button","og-drawing-polygon_button"],icon:`<?xml version="1.0" encoding="utf-8"?>
<!-- Generator: Adobe Illustrator 24.1.3, SVG Export Plug-In . SVG Version: 6.00 Build 0)  -->
<svg version="1.1" id="Layer_2" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 viewBox="0 0 1024 1024" style="enable-background:new 0 0 1024 1024;" xml:space="preserve">
<g>
	<path d="M926.03,321.16c-16.02,0-31.11,3.94-44.48,10.79l-263.43-191.4c2.69-8.94,4.18-18.4,4.18-28.2
		c0-54.02-43.95-97.97-97.97-97.97c-54.03,0-97.98,43.95-97.98,97.97c0,9.81,1.49,19.27,4.18,28.21L155.75,340.18
		c-16.22-11.91-36.16-19.03-57.78-19.03C43.95,321.16,0,365.11,0,419.13c0,52.58,41.67,95.5,93.71,97.75l102.63,315.86
		c-24.28,17.85-40.13,46.52-40.13,78.9c0,54.02,43.95,97.98,97.98,97.98c37.54,0,70.18-21.25,86.62-52.34h367.26
		c16.44,31.08,49.08,52.34,86.63,52.34c54.03,0,97.98-43.95,97.98-97.98c0-32.46-15.94-61.21-40.33-79.05l104.11-320.4
		c39.15-12.84,67.54-49.68,67.54-93.07C1024,365.11,980.05,321.16,926.03,321.16z M828.05,911.65c0,8.5-3.3,16.19-8.55,22.09
		c-6.11,6.85-14.9,11.26-24.79,11.26c-13.65,0-25.37-8.26-30.52-20.02c-1.79-4.09-2.82-8.58-2.82-13.33
		c0-18.39,14.95-33.35,33.34-33.35c2.93,0,5.72,0.5,8.43,1.21c13.27,3.49,23.21,14.91,24.59,28.9
		C827.83,909.5,828.05,910.54,828.05,911.65z M790.48,813.89c-45.63,1.96-83.27,35.16-91.87,78.77H350.28
		c-8.62-43.69-46.38-76.93-92.11-78.79L155.59,498.19c24.41-17.84,40.36-46.59,40.36-79.06c0-8.9-1.3-17.49-3.53-25.7L468.57,192.8
		c15.84,11.01,35.05,17.52,55.76,17.52c20.71,0,39.92-6.5,55.76-17.52l256.56,186.4c-5.48,12.21-8.59,25.7-8.59,39.93
		c0,41.02,25.36,76.17,61.21,90.75L790.48,813.89z M254.19,945c-10.11,0-19.07-4.62-25.19-11.75c-5.01-5.84-8.15-13.32-8.15-21.6
		c0-0.91,0.2-1.76,0.27-2.66c1.14-14.18,11.08-25.8,24.43-29.41c2.78-0.75,5.64-1.28,8.65-1.28c18.38,0,33.33,14.96,33.33,33.35
		c0,4.74-1.03,9.24-2.82,13.33C279.55,936.74,267.83,945,254.19,945z M64.88,421.49c-0.06-0.79-0.24-1.55-0.24-2.35
		c0-16.41,11.93-30.01,27.55-32.76c1.89-0.33,3.8-0.58,5.78-0.58c11.94,0,22.35,6.36,28.24,15.81c3.18,5.11,5.11,11.09,5.11,17.53
		c0,15.47-10.63,28.39-24.94,32.14c-2.7,0.71-5.48,1.2-8.4,1.2C80.4,452.47,66.11,438.76,64.88,421.49z M549.41,90.62
		c5.07,5.85,8.25,13.39,8.25,21.72c0,7.32-2.44,14.03-6.45,19.54c-6.07,8.33-15.82,13.81-26.88,13.81
		c-11.07,0-20.83-5.48-26.89-13.81c-4.01-5.51-6.45-12.22-6.45-19.54c0-8.33,3.17-15.86,8.24-21.71
		c6.12-7.07,15.04-11.64,25.1-11.64C534.38,79,543.29,83.57,549.41,90.62z M959.36,419.13c0,11.94-6.36,22.35-15.82,28.24
		c-5.1,3.18-11.07,5.1-17.52,5.1c-6.08,0-11.71-1.76-16.62-4.61c-9.71-5.64-16.33-15.94-16.64-27.89c-0.01-0.29-0.09-0.56-0.09-0.85
		c0-11.75,6.14-22.05,15.36-28c5.2-3.35,11.35-5.35,17.99-5.35C944.41,385.78,959.36,400.75,959.36,419.13z"/>
</g>
</svg>`,name:"polygon"}),n=new dt({classList:["og-map-button","og-drawing-linestring_button"],icon:`<?xml version="1.0" encoding="utf-8"?><!-- License: MIT. Made by Esri: https://github.com/Esri/calcite-ui-icons -->
    <svg width="800px" height="800px" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M21 6h.046l-5.25 9h-.944L10 9.455V7H7v2.926L1.862 18H0v3h3v-2.926L8.138 10h1.01L14 15.545V18h3v-3h-.046l5.25-9H24V3h-3zM8 8h1v1H8zM2 20H1v-1h1zm14-3h-1v-1h1zm7-13v1h-1V4z"/></svg>`,name:"linestring"});new jo({buttons:[l,t,n]}).events.on("change",s=>{switch(this.drawingControl.deactivate(),s.name){case"polygon":this.drawingControl.activatePolygonDrawing();break;case"linestring":this.drawingControl.activateLineStringDrawing()}}),l.appendTo(this.renderer.div),t.appendTo(this.renderer.div),n.appendTo(this.renderer.div)}},EarthCoordinates:da,ElevationProfileControl:class extends Q{constructor(l={}){super({name:"ElevationProfileControl",...l}),this._onSceneChange=()=>{this._collectProfileThrottled()},this._onElevationProfilePointer=(t,n,s,o,a,h,c,u)=>{let d=this._elevationProfileScene.getPointLonLat(h),f=this._elevationProfileScene.getPointLonLat(h+1),g=this.planet.ellipsoid.lonLatToCartesian(d),_=this.planet.ellipsoid.lonLatToCartesian(f),m=(t-n[0])/(s[0]-n[0]),p=_.sub(g);this._elevationProfileScene.setPointerCartesian3v(g.add(p.scale(m)),u)},this._onElevationProfileDblClick=(t,n,s,o,a,h,c,u)=>{let d=this._elevationProfileScene.getPointLonLat(h),f=this._elevationProfileScene.getPointLonLat(h+1),g=this.planet.ellipsoid.lonLatToCartesian(d),_=this.planet.ellipsoid.lonLatToCartesian(f),m=(t-n[0])/(s[0]-n[0]),p=_.sub(g),x=g.add(p.scale(m));this.planet.camera.flyDistance(x,this.planet.camera.eye.distance(x))},this._onElevationProfileMouseEnter=()=>{this._elevationProfileView.model.pointsReady&&this._elevationProfileScene.setPointerVisibility(!0)},this._onElevationProfileMouseLeave=()=>{},this._elevationProfileScene=new ih,this._elevationProfileView=new $l,this._elevationProfileLegend=new ah,this._elevationProfileButtonsView=new nh({model:this._elevationProfileView.model}),this._elevationProfileView.events.on("pointer",this._onElevationProfilePointer),this._elevationProfileView.events.on("dblclick",this._onElevationProfileDblClick),this._elevationProfileView.events.on("mouseenter",this._onElevationProfileMouseEnter),this._elevationProfileView.events.on("mouseleave",this._onElevationProfileMouseLeave),this._dialog=new Kt({title:"Elevation Profile",visible:!1,resizable:!0,useHide:!0,top:175,left:65,width:400,height:200,minHeight:100,minWidth:100}),this._graphView=new ut({template:`<div class="og-elevationprofile__container">
      <div class="og-elevationprofile__menu"></div>
      <div class="og-elevationprofile__graph"></div>
    </div>`}),this._poiListDialog=new oh({model:this._elevationProfileScene}),this._toggleBtn=new dt({classList:["og-map-button","og-elevationprofile_button"],icon:'<svg style="width: 2em; height: 2em;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"><path d="M128 896v-158.293333l331.946667-191.573334 160.853333 93.866667L896 480V896H128M896 381.44l-275.2 159.146667-160.853333-92.586667L128 640v-94.293333l331.946667-191.573334 160.853333 93.866667L896 288v93.44z" fill="" /></svg>'}),this._collectProfileThrottled=yi(()=>{let t=this._elevationProfileScene.getPointsLonLat();this._elevationProfileView.model.collectProfile(t)},250)}oninit(){this._dialog.appendTo(this.planet.renderer.div),this._graphView.appendTo(this._dialog.container),this._toggleBtn.appendTo(this.renderer.div),this._dialog.events.on("visibility",l=>{this._toggleBtn.setActive(l),l?(this.activate(),this._elevationProfileView.resize()):this.deactivate()}),this._toggleBtn.events.on("change",l=>{this._dialog.setVisibility(l)}),this._elevationProfileView.appendTo(this._graphView.select(".og-elevationprofile__graph")),this._elevationProfileView.model.bindPlanet(this.planet),this._elevationProfileView.model.events.on("clear",()=>{this._elevationProfileScene.clear(),this._elevationProfileLegend.clear()}),this._elevationProfileView.model.events.on("startcollecting",()=>{this._elevationProfileScene.setPointerVisibility(!1)}),this._elevationProfileView.events.on("tracklength",l=>{this._elevationProfileLegend.setTrackLength(l)}),this._elevationProfileView.events.on("groundlength",l=>{this._elevationProfileLegend.setGroundLength(l)}),this._elevationProfileView.events.on("warninglength",l=>{this._elevationProfileLegend.setWarningLength(l)}),this._elevationProfileView.events.on("collisionlength",l=>{this._elevationProfileLegend.setCollisionLength(l)}),this._poiListDialog.appendTo(this.planet.renderer.div),this._poiListDialog.events.on("visibility",l=>{this._elevationProfileButtonsView.pointListBtn.setActive(l,!0)}),this._elevationProfileLegend.appendTo(this._graphView.select(".og-elevationprofile__menu")),this._elevationProfileButtonsView.appendTo(this._graphView.select(".og-elevationprofile__menu")),this._elevationProfileButtonsView.events.on("list",l=>{this._poiListDialog.setVisibility(l)}),this._elevationProfileButtonsView.events.on("location",l=>{this._elevationProfileScene.flyExtent()}),this._elevationProfileButtonsView.events.on("reset",l=>{this._elevationProfileScene.setPointerVisibility(!1)}),this._elevationProfileScene.events.on("change",this._onSceneChange)}onactivate(){this.planet&&this._elevationProfileScene.bindPlanet(this.planet),this.renderer&&this.renderer.addNode(this._elevationProfileScene)}ondeactivate(){this._poiListDialog.setVisibility(!1),this._elevationProfileView.model.clear(),this.renderer&&this.renderer.removeNode(this._elevationProfileScene),this._dialog.hide()}},FramebufferPreview:class extends Q{constructor(l){super({autoActivate:!0,...l}),this._onDraw=()=>{if(this._framebuffer&&this._screenFramebuffer){let t=this.renderer,n=t.handler.gl;n.disable(n.BLEND),this._screenFramebuffer.activate();let s=this._program._programController,o=s._program;n.bindBuffer(n.ARRAY_BUFFER,t.screenFramePositionBuffer),n.vertexAttribPointer(o.attributes.corners,2,n.FLOAT,!1,0,0),s.activate(),n.activeTexture(n.TEXTURE0),n.bindTexture(n.TEXTURE_2D,this._framebuffer.textures[this.framebufferCurrentTexture]),n.uniform1i(o.uniforms.inputTexture,0),n.drawArrays(n.TRIANGLE_STRIP,0,4),this._screenFramebuffer.deactivate(),n.enable(n.BLEND),this._screenFramebuffer.readPixelBuffersAsync(a=>{let h=a.getPixelBufferData();if(h){let c=a.width,u=a.height,d=this.$canvas.getContext("2d"),f=new Uint8ClampedArray(h.buffer,h.byteOffset,h.byteLength),g=new ImageData(f,c,u);createImageBitmap(g).then(_=>{d.clearRect(0,0,this.$canvas.width,this.$canvas.height),d.drawImage(_,0,0,this.$canvas.width,this.$canvas.height)})}})}},this._dialog=new Kt({title:l.title||"",width:580,height:340,left:100,top:100}),this.$canvas=function(t,n){let s=document.createElement("canvas");return s.width=t,s.height=n,s.style.position="absolute",s.style.width="100%",s.style.height="100%",s}(this._dialog.width,this._dialog.height),this._framebuffer=l.framebuffer||null,this._screenFramebuffer=null,this.framebufferCurrentTexture=0,this._program=function(t=0,n,s,o){return new X(`framebuffer_dialog_screen:${t.toString()}`,{uniforms:{inputTexture:"sampler2D"},attributes:{corners:"vec2"},vertexShader:`#version 300 es
            
            in vec2 corners;
            
            out vec2 tc;

            void main(void) {
                gl_Position = vec4(corners, 0.0, 1.0);
                tc = corners * 0.5 + 0.5;
                ${o?"tc.y = 1.0 - tc.y;":""}               
            }`,fragmentShader:`#version 300 es

            precision highp float;

            uniform sampler2D inputTexture;
           
            in vec2 tc;

            layout(location = 0) out vec4 fragColor;

            ${n||""}
            
            ${s||`void mainImage(out vec4 fragColor, in vec2 fragCoord) { 
                fragColor = texture(inputTexture, fragCoord);
            }`}
            
            void main(void) {                              
               mainImage(fragColor, tc);
            }`})}(this.__id,l.common,l.image,l.flippedUV)}bindFramebuffer(l){l.isEqual(this._framebuffer)||(this._framebuffer=l)}oninit(){var l,t;super.oninit(),this.renderer&&(this.renderer.handler.addProgram(this._program),this._screenFramebuffer=new Rt(this.renderer.handler,{width:(l=this._framebuffer)==null?void 0:l.width,height:(t=this._framebuffer)==null?void 0:t.height,useDepth:!1,targets:[{internalFormat:"RGBA",type:"UNSIGNED_BYTE",attachment:"COLOR_ATTACHMENT",readAsync:!0}]}),this._screenFramebuffer.init())}activate(){var l,t;super.activate(),this._dialog.appendTo(document.body),(l=this._dialog.container)==null||l.appendChild(this.$canvas),(t=this.renderer)==null||t.events.on("draw",this._onDraw)}deactivate(){var l;super.deactivate(),this._dialog.remove(),(l=this.renderer)==null||l.events.off("draw",this._onDraw)}},GeoImageDragControl:class extends Q{constructor(l={}){super(l),this._cornerIndex=-1,this._catchCorner=!1,this._toggleBtn=new dt({classList:["og-map-button","og-geoimagegrag_button"],icon:'<?xml version="1.0" encoding="UTF-8" standalone="no"?> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path d="M16 13l6.964 4.062-2.973.85 2.125 3.681-1.732 1-2.125-3.68-2.223 2.15L16 13zm-2-7h2v2h5a1 1 0 0 1 1 1v4h-2v-3H10v10h4v2H9a1 1 0 0 1-1-1v-5H6v-2h2V9a1 1 0 0 1 1-1h5V6zM4 14v2H2v-2h2zm0-4v2H2v-2h2zm0-4v2H2V6h2zm0-4v2H2V2h2zm4 0v2H6V2h2zm4 0v2h-2V2h2zm4 0v2h-2V2h2z" fill="#000"/></svg>'})}oninit(){this._toggleBtn.appendTo(this.renderer.div),this.planet.events.on("layeradd",l=>{this.isActive()&&this._bindLayer(l)},this),this._toggleBtn.events.on("change",l=>{l?this.activate():this.deactivate()})}onactivate(){super.onactivate();const l=this.planet;for(let t=0;t<l.layers.length;t++)this._bindLayer(l.layers[t])}ondeactivate(){super.ondeactivate();const l=this.planet;for(let t=0;t<l.layers.length;t++)this._unbindLayer(l.layers[t])}_bindLayer(l){l instanceof Ai&&(l.events.on("mousemove",this._onMouseMove,this),l.events.on("mouseleave",this._onMouseLeave,this),l.events.on("ldown",this._onLDown,this),l.events.on("lup",this._onLUp,this))}_unbindLayer(l){l instanceof Ai&&(l.events.off("mousemove",this._onMouseMove),l.events.off("mouseleave",this._onMouseLeave),l.events.off("ldown",this._onLDown),l.events.off("lup",this._onLUp))}_onLUp(l){this._catchCorner=!1,l.renderer.controls.navigation.activate()}_onLDown(l){this._cornerIndex!==-1&&(this._catchCorner=!0,l.renderer.controls.navigation.deactivate())}_onMouseLeave(){document.body.style.cursor="auto"}_onMouseMove(l){let t=l.pickingObject;const n=this.planet;if(this._catchCorner){let s=t.getCornersLonLat();s[this._cornerIndex]=n.getLonLatFromPixelTerrain(l),t.setCornersLonLat(s)}else{this._cornerIndex=-1;for(let s=0;s<t._cornersWgs84.length;s++){let o=n.getLonLatFromPixelTerrain(l);if(o&&n.ellipsoid.getGreatCircleDistance(t._cornersWgs84[s],o)/n.getDistanceFromPixel(l)<=.05){this._cornerIndex=s,document.body.style.cursor="move";break}document.body.style.cursor="auto"}}}},GeoObjectEditor:class extends Q{constructor(l={}){super(l),this._geoObjectEditopScene=new gh({name:`geoObjectEditorScene:${this.__id}`}),this._dialog=new xh({model:this._geoObjectEditopScene})}oninit(){this.renderer&&(this.renderer.addControl(new Jn({planet:this.planet})),this._geoObjectEditopScene.bindPlanet(this.planet),this._dialog.appendTo(this.renderer.div||document.body),this.activate())}onactivate(){this.renderer&&this.renderer.addNode(this._geoObjectEditopScene)}ondeactivate(){this.renderer&&this.renderer.removeNode(this._geoObjectEditopScene),this._dialog.hide()}},HeightRuler:Hn,KeyboardNavigation:class extends Q{constructor(l={}){l=l||{},super({name:"KeyboardNavigation",...l}),this.onCameraPitchUp=()=>{this._camera&&this._camera.setPitch(this._camera.getPitch()+.1*j)},this.onCameraPitchDown=()=>{this._camera&&this._camera.setPitch(this._camera.getPitch()-.1*j)},this.onCameraYawLeft=()=>{this._camera&&this._camera.setYaw(this._camera.getYaw()-.1*j)},this.onCameraYawRight=()=>{this._camera&&this._camera.setYaw(this._camera.getYaw()+.1*j)},this.onCameraMoveForward=()=>{this._camera&&this.force.addA(this._camera.getForward()).normalize()},this.onCameraMoveBackward=()=>{this._camera&&this.force.addA(this._camera.getBackward()).normalize()},this._camera=l.camera||null,this.speed=l.speed||10,this.force=new v,this.vel=new v,this.mass=1}bindCamera(l){this._camera=l}onactivate(){let l=this.renderer;l.events.on("keypress",W.KEY_S,this.onCameraMoveBackward,this),l.events.on("keypress",W.KEY_W,this.onCameraMoveForward,this),l.events.on("keypress",W.KEY_UP,this.onCameraPitchUp,this),l.events.on("keypress",W.KEY_DOWN,this.onCameraPitchDown,this),l.events.on("keypress",W.KEY_LEFT,this.onCameraYawLeft,this),l.events.on("keypress",W.KEY_RIGHT,this.onCameraYawRight,this),l.events.on("draw",this.onDraw,this,-1e3)}ondeactivate(){this.renderer}oninit(){this.activate()}get dt(){return .001*this.renderer.handler.deltaTime}onDraw(){if(this.renderer&&this._camera){let l=this.force.scale(1/this.mass);this.vel.addA(l),this.vel.scale(.96),this.force.set(0,0,0);let t=this._camera;t.eye=t.eye.add(this.vel.scaleTo(this.dt)),t.update()}}},LayerAnimation:class extends Q{constructor(l={}){super(l),this._currVisibleIndex=0,this._onViewchange=()=>{this._timeoutStart=performance.now()},this._onVisibilityChange=t=>{t||this.pause()},this._onLayerLoadend=t=>{let n=this._layersArr[this._currentIndex];if(n&&n.isEqual(t)){let s=this._getFrameIndex(this._currentIndex)*this._frameSize,o=this._currentIndex;for(let h=s;h<o;h++){let c=this._layersArr[h];c.opacity=0,c.setVisibility(!1)}n.opacity=1;let a=this._layersArr[this._currVisibleIndex];if(a){a.opacity=0,a.setVisibility(!1);let h=this._getFrameIndex(this._currVisibleIndex);this._getFrameIndex(this._currentIndex)!==h&&this._removeFrameFromPlanet(h)}this.events.dispatch(this.events.idle,n)}},this.events=lt(Tl),this._name=l.name||`layerAnimation-${this.__id}`,this._layersArr=l.layers?[].concat(l.layers):[],this._currentIndex=-1,this._playInterval=l.playInterval||120,this._playIntervalHandler=-1,this._playIndex=0,this._frameSize=l.frameSize||50,this.repeat=l.repeat==null||l.repeat,this.skipTimeout=l.skipTimeout||5e3,this._timeoutStart=0}_getFramesNum(){return Math.ceil(this._layersArr.length/this._frameSize)}_setFrame(l){for(let t=0,n=this._getFramesNum();t<n;t++)t!==l?this._removeFrameFromPlanet(t):this._appendFrameToPlanet(t)}_getFrameIndex(l){return Math.floor(l/this._frameSize)}_appendFrameToPlanet(l){if(this.planet){let t=l*this._frameSize,n=t+this._frameSize;for(let s=t,o=n>this._layersArr.length?this._layersArr.length:n;s<o;s++)this.planet.addLayer(this._layersArr[s])}}_removeFrameFromPlanet(l){if(this.planet){let t=l*this._frameSize,n=t+this._frameSize;for(let s=t,o=n>this._layersArr.length?this._layersArr.length:n;s<o;s++)this._layersArr[s].abortLoading(),this._layersArr[s].remove(),this._layersArr[s].setVisibility(!1)}}oninit(){super.oninit(),this.onactivate(),this._initLayers(),this.planet.events.on("layerloadend",this._onLayerLoadend),this._setCurrentIndexAsync(0,!1,!0)}onactivate(){super.onactivate(),this.planet.camera.events.on("viewchange",this._onViewchange),this.planet.renderer.handler.events.on("visibilitychange",this._onVisibilityChange)}ondeactivate(){super.ondeactivate(),this.planet.camera.events.off("viewchange",this._onViewchange);for(let l=0;l<this._layersArr.length;l++)this._layersArr[l].setVisibility(!1);this.planet.events.off("layerloadend",this._onLayerLoadend),this.planet.renderer.handler.events.off("visibilitychange",this._onVisibilityChange)}clear(){this.stop(),this._currentIndex=-1,this._currVisibleIndex=-1;let l=this._layersArr;this._layersArr=[];for(let t=0;t<l.length;t++)l[t].remove()}_initLayers(){if(this.planet){for(let l=0,t=this._layersArr.length;l<t;l++){let n=this._layersArr[l];n.setVisibility(!1),n.setBaseLayer(!1),n.opacity=0}this._appendFrameToPlanet(0)}}setLayers(l){this.clear(),this._layersArr=[].concat(l),this._initLayers()}appendLayer(l){var t;this._layersArr.push(l),l.setVisibility(!1),l.setBaseLayer(!1),l.opacity=0,(t=this.planet)==null||t.addLayer(l)}get isIdle(){let l=this._layersArr[this._currentIndex];return l&&l.isIdle||!l}get playInterval(){return this._playInterval}set playInterval(l){l!==this._playInterval&&(this._playInterval=l,this.isPlaying&&(this.pause(),this.play()))}get isPlaying(){return this._playIntervalHandler!==-1}get layers(){return this._layersArr}_checkEnd(){this._playIndex>this._layersArr.length&&(this.repeat?this._playIndex=0:this.pause())}play(){this.isPlaying||(this._currentIndex>=this._layersArr.length-1&&this.stop(),this._timeoutStart=performance.now(),this._playIntervalHandler=setInterval(()=>{this._checkEnd(),this._setCurrentIndexAsync(this._playIndex,!1,!1),requestAnimationFrame(()=>{(this.isIdle||performance.now()-this._timeoutStart>this.skipTimeout)&&(this._playIndex++,this._timeoutStart=performance.now())})},this._playInterval),this.events.dispatch(this.events.play))}stop(){this._playIndex>0&&(this._clearInterval(),this._playIndex=0,this.setCurrentIndex(0),this.events.dispatch(this.events.stop))}pause(){this.isPlaying&&(this._clearInterval(),this.events.dispatch(this.events.pause))}_clearInterval(){clearInterval(this._playIntervalHandler),this._playIntervalHandler=-1}setCurrentIndex(l,t=!1){this._setCurrentIndexAsync(l,!0,t)}_setCurrentIndexAsync(l,t=!1,n=!1){if(l!=this._currentIndex&&l>=0&&l<this._layersArr.length){let s=this._currentIndex;this._currentIndex=l,this._playIndex=l;let o=this._getFrameIndex(s),a=this._getFrameIndex(this._currentIndex),h=this._layersArr[s],c=this._layersArr[l],u=a!=o;u&&this._appendFrameToPlanet(a),h&&(h.isIdle?this._currVisibleIndex=s:(h.opacity=0,h.setVisibility(!1))),c&&(c.opacity=0,c.setVisibility(!0),requestAnimationFrame(()=>{if(c.isIdle||t){c.opacity=1,u&&this._removeFrameFromPlanet(o),h&&(h.opacity=0,h.setVisibility(!1));let d=this._layersArr[this._currVisibleIndex];d&&(d.opacity=0,d.setVisibility(!1))}}),n||this.events.dispatch(this.events.change,this._currentIndex,s))}}},LayerSwitcher:class extends Q{constructor(l={}){super({name:"LayerSwitcher",...l}),this.addLayer=t=>{if(!t.hideInLayerSwitcher){let n=this._createLayerButton(t);this._layerViews.push(n),t.isBaseLayer()?n.appendTo(this.$baseLayers):n.appendTo(this.$overlays)}},this.removeLayer=t=>{for(let n=0;n<this._layerViews.length;n++){let s=this._layerViews[n];if(s.model.isEqual(t)){s.remove(),this._layerViews.splice(n,1);break}}},this._dialog=new Kt({title:"Layer Switcher",top:15,useHide:!0,visible:!1,width:300,maxHeight:500}),this._panel=new ut({template:`<div class="og-layerSwitcher">
      <div class="og-layerSwitcher__title">Base Layers</div>
      <div class="og-layerSwitcher__list og-layerSwitcher__baseLayers"></div>        
        
      <div class="og-layerSwitcher__title">Overlays</div>
      <div class="og-layerSwitcher__list og-layerSwitcher__overlays"></div>
         
    </div>`}),this._toggleBtn=new dt({classList:["og-map-button","og-layerSwitcher_button"],icon:`<?xml version="1.0" encoding="utf-8"?>
<!-- Svg Vector Icons : http://www.onlinewebfonts.com/icon -->
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 1000 1000" enable-background="new 0 0 1000 1000" xml:space="preserve">
<metadata> Svg Vector Icons : http://www.onlinewebfonts.com/icon </metadata>
<g><path d="M500,573.5c-3.2,0-6.5-0.6-9.5-1.9L25,375.6c-9.1-3.8-15-12.7-15-22.6s5.9-18.8,15-22.6l465.5-196c6.1-2.5,12.9-2.5,19,0l465.5,196c9.1,3.8,15,12.7,15,22.6s-5.9,18.8-15,22.6l-465.5,196C506.5,572.9,503.2,573.5,500,573.5L500,573.5z M97.6,353L500,522.4L902.4,353L500,183.6L97.6,353L97.6,353z"/><path d="M500,720.5c-3.2,0-6.5-0.6-9.5-1.9L25,522.6c-12.4-5.2-18.3-19.6-13.1-32.1c5.2-12.5,19.6-18.3,32.1-13.1l456,192l456-192c12.4-5.2,26.9,0.6,32.1,13.1s-0.6,26.9-13.1,32.1l-465.5,196C506.5,719.9,503.2,720.5,500,720.5L500,720.5z"/><path d="M500,867.5c-3.2,0-6.5-0.6-9.5-1.9L25,669.6c-12.4-5.2-18.3-19.6-13.1-32.1c5.2-12.5,19.6-18.3,32.1-13.1l456,192l456-192c12.4-5.2,26.9,0.6,32.1,13.1c5.2,12.5-0.6,26.8-13.1,32.1l-465.5,196C506.5,866.9,503.2,867.5,500,867.5L500,867.5z"/></g>
</svg>`}),this.$baseLayers=null,this.$overlays=null,this._layerViews=[]}oninit(){this._toggleBtn.appendTo(this.renderer.div),this._dialog.appendTo(this.planet.renderer.div),this._panel.appendTo(this._dialog.container),this.$baseLayers=this._panel.el.querySelector(".og-layerSwitcher__baseLayers"),this.$overlays=this._panel.el.querySelector(".og-layerSwitcher__overlays"),this._dialog.setPosition(this.planet.renderer.div.clientWidth-this._dialog.width-67),this._dialog.events.on("visibility",l=>{this._toggleBtn.setActive(l)}),this._toggleBtn.events.on("change",l=>{this._dialog.setVisibility(l)}),this.planet.events.on("layeradd",this.addLayer,this),this.planet.events.on("layerremove",this.removeLayer,this),this._initLayers()}_initLayers(){let l=this.planet.layers;for(let t=0;t<l.length;t++)this.addLayer(l[t])}_createLayerButton(l){return new Cl({model:l})}onactivate(){}ondeactivate(){this._dialog.hide()}},Lighting:class extends Q{constructor(l={}){super(l),this._selectedLayer=null,this._toggleBtn=new dt({classList:["og-map-button","og-lighting_button"],icon:`<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="256" height="256" viewBox="0 0 256 256" xml:space="preserve">

<defs>
</defs>
<g style="stroke: none; stroke-width: 0; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; opacity: 1;" transform="translate(1.4065934065934016 1.4065934065934016) scale(2.81 2.81)" >
	<path d="M 45 68 c -12.682 0 -23 -10.317 -23 -23 c 0 -12.682 10.318 -23 23 -23 c 12.683 0 23 10.318 23 23 C 68 57.683 57.683 68 45 68 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round" />
	<path d="M 45 17.556 c -1.657 0 -3 -1.343 -3 -3 V 3 c 0 -1.657 1.343 -3 3 -3 c 1.657 0 3 1.343 3 3 v 11.556 C 48 16.212 46.657 17.556 45 17.556 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round" />
	<path d="M 45 90 c -1.657 0 -3 -1.343 -3 -3 V 75.444 c 0 -1.657 1.343 -3 3 -3 c 1.657 0 3 1.343 3 3 V 87 C 48 88.657 46.657 90 45 90 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round" />
	<path d="M 14.556 48 H 3 c -1.657 0 -3 -1.343 -3 -3 c 0 -1.657 1.343 -3 3 -3 h 11.556 c 1.657 0 3 1.343 3 3 C 17.556 46.657 16.212 48 14.556 48 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round" />
	<path d="M 87 48 H 75.444 c -1.657 0 -3 -1.343 -3 -3 c 0 -1.657 1.343 -3 3 -3 H 87 c 1.657 0 3 1.343 3 3 C 90 46.657 88.657 48 87 48 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round" />
	<path d="M 66.527 26.473 c -0.768 0 -1.535 -0.293 -2.121 -0.878 c -1.172 -1.172 -1.172 -3.071 0 -4.243 l 8.171 -8.171 c 1.172 -1.172 3.07 -1.171 4.242 0 c 1.172 1.172 1.172 3.071 0 4.243 l -8.171 8.171 C 68.063 26.18 67.295 26.473 66.527 26.473 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round" />
	<path d="M 15.302 77.698 c -0.768 0 -1.536 -0.293 -2.121 -0.879 c -1.172 -1.171 -1.172 -3.071 0 -4.242 l 8.171 -8.171 c 1.171 -1.172 3.071 -1.172 4.242 0 c 1.172 1.171 1.172 3.071 0 4.242 l -8.171 8.171 C 16.837 77.405 16.069 77.698 15.302 77.698 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round" />
	<path d="M 23.473 26.473 c -0.768 0 -1.536 -0.293 -2.121 -0.878 l -8.171 -8.171 c -1.172 -1.172 -1.172 -3.071 0 -4.243 c 1.172 -1.172 3.072 -1.171 4.243 0 l 8.171 8.171 c 1.172 1.172 1.172 3.071 0 4.243 C 25.008 26.18 24.24 26.473 23.473 26.473 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round" />
	<path d="M 74.698 77.698 c -0.768 0 -1.535 -0.293 -2.121 -0.879 l -8.171 -8.171 c -1.172 -1.171 -1.172 -3.071 0 -4.242 c 1.172 -1.172 3.07 -1.172 4.242 0 l 8.171 8.171 c 1.172 1.171 1.172 3.071 0 4.242 C 76.233 77.405 75.466 77.698 74.698 77.698 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round" />
</g>
</svg>`}),this._dialog=new Kt({title:"Lighting Parameters",visible:!1,useHide:!0,top:60,left:60,width:600}),this._dialog.events.on("visibility",t=>{this._toggleBtn.setActive(t)}),this._panel=new ut({template:`<div class="og-lighing og-options-container">

         <div class="og-option">
           <div class="og-suncontrol"></div>
         </div>        
         
         <div class="og-option og-atmosphere-opacity">
         </div>
         
         <div class="og-option og-simpleskybackground">
         </div>
         
        <div class="og-lighting-emptyline"></div>

         <div class="og-option og-gamma"></div>         
         <div class="og-option og-exposure"></div>
       
        <div class="og-lighting-emptyline"></div>

         <div class="og-option">
         <div class="og-layers">
           <div class="og-caption">Select layer:</div>
           <select id="layers"></select>
         </div>
         </div>

         <div class="og-option og-opacity">
         </div>
         
         <div class="og-option og-night">
         </div>
         
         <div class="og-lighting-emptyline"></div>

         <div class="og-option og-diffuse">
         </div>
      
         <div class="og-option og-ambient">
         </div>

         <div class="og-option og-specular">
         </div>        

    </div>`}),this.$gamma=null,this.$exposure=null,this.$night=null,this.$opacity=null,this.$diffuse=null,this.$ambient=null,this.$specular=null,this.$atmosphereOpacity=null,this.$simpleSkyBackground=null,this._atmosphereMaxOpacity=new Z$1({label:"Max.opacity",max:5}),this._atmosphereMinOpacity=new Z$1({label:"Min.opacity",max:5}),this._simpleSkyBackgroundColorOne=new zn({label:"Color One"}),this._simpleSkyBackgroundColorTwo=new zn({label:"Color Two"}),this._gamma=new Z$1({label:"Gamma",max:5}),this._exposure=new Z$1({label:"Exposure",max:5}),this._night=new Z$1({label:"Nightlight",max:5}),this._opacity=new Z$1({label:"Opacity",max:1}),this._diffuse_r=new Z$1({label:"Diffuse R",max:5}),this._diffuse_g=new Z$1({label:"Diffuse G",max:5}),this._diffuse_b=new Z$1({label:"Diffuse B",max:5}),this._ambient_r=new Z$1({label:"Ambient R",max:5}),this._ambient_g=new Z$1({label:"Ambient G",max:5}),this._ambient_b=new Z$1({label:"Ambient B",max:5}),this._specular_r=new Z$1({label:"Specular R",max:.2}),this._specular_g=new Z$1({label:"Specular G",max:.2}),this._specular_b=new Z$1({label:"Specular B",max:.2}),this._shininess=new Z$1({label:"Shininess",max:100})}bindLayer(l){this._selectedLayer=l,this._opacity.value=l.opacity,this._update()}oninit(){this._toggleBtn.appendTo(this.renderer.div),this._dialog.appendTo(this.renderer.div),this._panel.appendTo(this._dialog.container),this._panel.el&&(this.$atmosphereOpacity=this._panel.el.querySelector(".og-atmosphere-opacity"),this.$simpleSkyBackground=this._panel.el.querySelector(".og-simpleskybackground"),this.$gamma=this._panel.el.querySelector(".og-option.og-gamma"),this.$exposure=this._panel.el.querySelector(".og-option.og-exposure"),this.$opacity=this._panel.el.querySelector(".og-option.og-opacity"),this.$diffuse=this._panel.el.querySelector(".og-option.og-diffuse"),this.$ambient=this._panel.el.querySelector(".og-option.og-ambient"),this.$specular=this._panel.el.querySelector(".og-option.og-specular"),this.$night=this._panel.el.querySelector(".og-option.og-night")),this._toggleBtn.events.on("change",h=>{this._dialog.setVisibility(h)});let l=this._dialog.select(".og-suncontrol"),t=new dt({classList:["og-suncontrol-button"],isActive:!0,icon:'<?xml version="1.0" encoding="utf-8"?><svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 122.88 70.41" style="enable-background:new 0 0 122.88 70.41" xml:space="preserve"><g><path d="M60.91,19.12c6.95,0,13.24,2.95,17.8,7.72c4.55,4.77,7.37,11.37,7.37,18.64c0,1.94-0.2,3.83-0.58,5.65h31.61 c2.1,0,2.62,1.16,2.62,2.59c0,1.43-0.52,2.59-2.62,2.59H7.09c-2.1,0-2.62-1.16-2.62-2.59c0-1.43,0.52-2.59,2.62-2.59h29.23 c-0.38-1.82-0.58-3.71-0.58-5.65c0-7.28,2.82-13.87,7.37-18.64C47.67,22.08,53.96,19.12,60.91,19.12L60.91,19.12L60.91,19.12z M63.4,70.41c-2.1,0-2.62-1.16-2.62-2.59s0.52-2.59,2.62-2.59h56.86c2.1,0,2.62,1.16,2.62,2.59s-0.52,2.59-2.62,2.59H63.4 L63.4,70.41z M2.62,70.41c-2.1,0-2.62-1.16-2.62-2.59s0.52-2.59,2.62-2.59h29.51c2.1,0,2.62,1.16,2.62,2.59s-0.52,2.59-2.62,2.59 H2.62L2.62,70.41z M38.39,9.46c-0.78-1.35-0.32-3.07,1.03-3.85c1.35-0.78,3.07-0.32,3.85,1.03l3.62,6.27 c0.78,1.35,0.32,3.07-1.03,3.85c-1.35,0.78-3.07,0.32-3.85-1.03L38.39,9.46L38.39,9.46L38.39,9.46z M58.67,2.83 c0-1.56,1.27-2.83,2.83-2.83c1.56,0,2.83,1.27,2.83,2.83v7.24c0,1.56-1.27,2.83-2.83,2.83c-1.56,0-2.83-1.26-2.83-2.83V2.83 L58.67,2.83L58.67,2.83z M79.56,7.23c0.77-1.35,2.49-1.81,3.84-1.04c1.35,0.77,1.81,2.49,1.04,3.84l-3.62,6.27 c-0.77,1.35-2.49,1.81-3.84,1.04c-1.35-0.77-1.81-2.49-1.04-3.84L79.56,7.23L79.56,7.23L79.56,7.23z M95.45,21.48 c1.35-0.78,3.07-0.32,3.85,1.03c0.78,1.35,0.32,3.07-1.03,3.85L92,29.98c-1.35,0.78-3.07,0.32-3.85-1.03 c-0.78-1.35-0.32-3.07,1.03-3.85L95.45,21.48L95.45,21.48L95.45,21.48z M102.08,41.76c1.56,0,2.83,1.27,2.83,2.83 c0,1.56-1.27,2.83-2.83,2.83h-7.24c-1.56,0-2.83-1.26-2.83-2.83s1.26-2.83,2.83-2.83H102.08L102.08,41.76L102.08,41.76z M19.74,46.25c-1.56,0-2.83-1.27-2.83-2.83c0-1.56,1.27-2.83,2.83-2.83h7.24c1.56,0,2.83,1.26,2.83,2.83s-1.27,2.83-2.83,2.83 H19.74L19.74,46.25L19.74,46.25z M24.14,25.35c-1.35-0.77-1.81-2.49-1.04-3.84c0.77-1.35,2.49-1.81,3.84-1.04l6.27,3.62 c1.35,0.77,1.81,2.49,1.04,3.84c-0.77,1.35-2.49,1.81-3.84,1.04L24.14,25.35L24.14,25.35L24.14,25.35z"/></g></svg>',title:"Star/stop the Sun from following the camera"});t.appendTo(l);let n=new dt({classList:["og-suncontrol-button"],isActive:!0,icon:`<?xml version="1.0"?>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32">
    <path style="text-indent:0;text-align:start;line-height:normal;text-transform:none;block-progression:tb;-inkscape-font-specification:Sans" d="M 16 4 C 9.3844277 4 4 9.3844277 4 16 C 4 22.615572 9.3844277 28 16 28 C 22.615572 28 28 22.615572 28 16 C 28 9.3844277 22.615572 4 16 4 z M 16 6 C 16.389823 6 16.778223 6.0506339 17.15625 6.09375 C 18.631659 7.6568432 21 10.9245 21 16 C 21 21.0755 18.631659 24.343157 17.15625 25.90625 C 16.778223 25.949366 16.389823 26 16 26 C 10.465308 26 6 21.534692 6 16 C 6 10.465308 10.465308 6 16 6 z" overflow="visible" font-family="Sans"/>
</svg>
`,title:"Activate/deactivate the Sun current time positioning"});n.appendTo(l),t.events.on("change",h=>{const c=this.planet.renderer.controls.sun;h?c.start():c.stop()}),n.events.on("change",h=>{const c=this.planet.renderer.controls.sun;h?c.activate():c.deactivate()});let s=new dt({classList:["og-suncontrol-button"],isActive:this.planet.lightEnabled,icon:`<?xml version="1.0" encoding="utf-8"?>
<!-- Generated by IcoMoon.io -->
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="512" height="512" viewBox="0 0 512 512">
<g>
</g>
	<path d="M257.894 156.948c-53.258 0-96.42 43.561-96.42 97.26 0 53.719 43.161 97.249 96.42 97.249 53.197 0 96.379-43.53 96.379-97.25 0-53.698-43.182-97.26-96.379-97.26zM257.894 309.873c-30.464 0-55.163-24.945-55.163-55.665s24.699-55.624 55.163-55.624c30.423 0 55.101 24.904 55.101 55.624s-24.688 55.665-55.101 55.665z" fill="#000000" />
	<path d="M241.808 43.499h32.144v79.575h-32.144v-79.575z" fill="#000000" />
	<path d="M417.209 115.897l-22.723-22.917-55.757 56.279 22.723 22.907z" fill="#000000" />
	<path d="M389.468 238.407h78.899v32.389h-78.899v-32.389z" fill="#000000" />
	<path d="M396.012 416.86l22.723-22.917-55.767-56.259-22.712 22.897z" fill="#000000" />
	<path d="M242.473 388.915h32.144v79.575h-32.144v-79.575z" fill="#000000" />
	<path d="M96.266 396.073l22.722 22.938 55.778-56.289-22.692-22.928z" fill="#000000" />
	<path d="M43.633 240.537h78.879v32.43h-78.879v-32.43z" fill="#000000" />
	<path d="M115.394 93.051l-22.681 22.907 55.757 56.258 22.702-22.917z" fill="#000000" />
</svg>`,title:"Enable/disable planet lighting"});s.appendTo(l),s.events.on("change",h=>{this.planet.lightEnabled=h});let o=new dt({classList:["og-suncontrol-button"],isActive:this.planet.atmosphereEnabled,icon:`<?xml version="1.0" encoding="utf-8"?><!-- Uploaded to: SVG Repo, www.svgrepo.com, Generator: SVG Repo Mixer Tools -->
<svg width="800px" height="800px" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><path fill="#000000" d="M135.688 18.5c-6.798 74.842-23.842 85.39-107.907 59.656 84.85 52.022 73.57 64.954-6.843 96.938 87.743-10.27 103.29 4.89 70.75 87.594 17.805-27.56 32.5-44.498 46.282-54.47-11.813 28.26-18.345 59.274-18.345 91.813 0 84.184 43.71 157.96 109.656 200.376-41.624-43.834-67.686-102.7-67.686-167.875 0-134.923 109.45-244.405 244.375-244.405 30.92 0 60.76 5.762 88 16.25-38.584-26.87-85.517-42.625-136.064-42.625-55.257 0-106.14 18.802-146.562 50.375 4.627-18.783 17.39-38.073 41.03-60.906C190.18 90.942 153.53 95.634 135.69 18.5zm10.03 77.188c5.67.002 11.428 1.247 16.876 3.874 14.506 6.998 22.72 21.81 22 36.938-10.26 10.87-19.507 22.696-27.594 35.344-9.035 2.753-19.075 2.27-28.25-2.156-19.37-9.343-27.5-32.6-18.156-51.97 6.715-13.92 20.638-22.036 35.125-22.03z"/></svg>`,title:"Enable/disable atmosphere scattering"});o.appendTo(l),this.planet.atmosphereEnabled?(this.$atmosphereOpacity.style.display="block",this.$simpleSkyBackground.style.display="none"):(this.$atmosphereOpacity.style.display="none",this.$simpleSkyBackground.style.display="flex"),o.events.on("change",h=>{this.planet.atmosphereEnabled=h,this.planet.atmosphereEnabled?(this.$atmosphereOpacity.style.display="block",this.$simpleSkyBackground.style.display="none"):(this.$atmosphereOpacity.style.display="none",this.$simpleSkyBackground.style.display="flex")}),this._atmosphereMaxOpacity.appendTo(this.$atmosphereOpacity),this._atmosphereMinOpacity.appendTo(this.$atmosphereOpacity),this._simpleSkyBackgroundColorOne.appendTo(this.$simpleSkyBackground),this._simpleSkyBackgroundColorTwo.appendTo(this.$simpleSkyBackground),this._gamma.appendTo(this.$gamma),this._exposure.appendTo(this.$exposure),this._night.appendTo(this.$night),this._opacity.appendTo(this.$opacity),this._diffuse_r.appendTo(this.$diffuse),this._diffuse_g.appendTo(this.$diffuse),this._diffuse_b.appendTo(this.$diffuse),this._ambient_r.appendTo(this.$ambient),this._ambient_g.appendTo(this.$ambient),this._ambient_b.appendTo(this.$ambient),this._specular_r.appendTo(this.$specular),this._specular_g.appendTo(this.$specular),this._specular_b.appendTo(this.$specular),this._shininess.appendTo(this.$specular),this._gamma.value=this.planet.renderer.gamma,this._gamma.events.on("change",h=>{this.planet.renderer.gamma=h}),this._exposure.value=this.planet.renderer.exposure,this._exposure.events.on("change",h=>{this.planet.renderer.exposure=h}),this._atmosphereMinOpacity.value=this.planet.atmosphereMinOpacity,this._atmosphereMinOpacity.events.on("change",h=>{this.planet.atmosphereMinOpacity=h}),this._atmosphereMaxOpacity.value=this.planet.atmosphereMaxOpacity,this._atmosphereMaxOpacity.events.on("change",h=>{this.planet.atmosphereMaxOpacity=h,this.planet.renderer.controls.Atmosphere.opacity=h});let a=this.planet.renderer.controls.SimpleSkyBackground;a&&(this._simpleSkyBackgroundColorOne.value=a.colorOne,this._simpleSkyBackgroundColorTwo.value=a.colorTwo),this._simpleSkyBackgroundColorOne.events.on("input",h=>{let c=this.planet.renderer.controls.SimpleSkyBackground;c&&(c.colorOne=h)}),this._simpleSkyBackgroundColorTwo.events.on("input",h=>{let c=this.planet.renderer.controls.SimpleSkyBackground;c&&(c.colorTwo=h)}),this._panel.el.querySelector("#layers").addEventListener("change",h=>{const c=this.planet.getLayerByName(h.target.value);c&&this.bindLayer(c)}),this._night.events.on("change",h=>{this._selectedLayer&&(this._selectedLayer.nightTextureCoefficient=h)}),this._opacity.events.on("change",h=>{this._selectedLayer&&(this._selectedLayer.opacity=h)}),this._ambient_r.events.on("change",h=>{this._selectedLayer&&this._selectedLayer._ambient&&(this._selectedLayer._ambient[0]=h)}),this._ambient_g.events.on("change",h=>{this._selectedLayer&&this._selectedLayer._ambient&&(this._selectedLayer._ambient[1]=h)}),this._ambient_b.events.on("change",h=>{this._selectedLayer&&this._selectedLayer._ambient&&(this._selectedLayer._ambient[2]=h)}),this._diffuse_r.events.on("change",h=>{this._selectedLayer&&this._selectedLayer._diffuse&&(this._selectedLayer._diffuse[0]=h)}),this._diffuse_g.events.on("change",h=>{this._selectedLayer&&this._selectedLayer._diffuse&&(this._selectedLayer._diffuse[1]=h)}),this._diffuse_b.events.on("change",h=>{this._selectedLayer&&this._selectedLayer._diffuse&&(this._selectedLayer._diffuse[2]=h)}),this._specular_r.events.on("change",h=>{this._selectedLayer&&this._selectedLayer._specular&&(this._selectedLayer._specular[0]=h)}),this._specular_g.events.on("change",h=>{this._selectedLayer&&this._selectedLayer._specular&&(this._selectedLayer._specular[1]=h)}),this._specular_b.events.on("change",h=>{this._selectedLayer&&this._selectedLayer._specular&&(this._selectedLayer._specular[2]=h)}),this._shininess.events.on("change",h=>{this._selectedLayer&&this._selectedLayer._specular&&(this._selectedLayer._specular[3]=h)}),this.planet&&(this.planet.events.on("layeradd",this._onLayerAdd,this),this.planet.events.on("layerremove",this._onLayerRemove,this)),this._fetchLayers()}_update(){let l=this._selectedLayer;this._opacity.value=l&&l.opacity?l.opacity:0,this._night.value=l&&l.nightTextureCoefficient?l.nightTextureCoefficient:this.planet.nightTextureCoefficient;let t=l&&l._ambient?l._ambient:this.planet._ambient;this._ambient_r.value=t[0],this._ambient_g.value=t[1],this._ambient_b.value=t[2];let n=l&&l._diffuse?l._diffuse:this.planet._diffuse;this._diffuse_r.value=n[0],this._diffuse_g.value=n[1],this._diffuse_b.value=n[2];let s=l&&l._specular?l._specular:this.planet._specular;this._specular_r.value=s[0],this._specular_g.value=s[1],this._specular_b.value=s[2],this._shininess.value=s[3]}_fetchLayers(){if(this.planet)for(let l=0;l<this.planet.layers.length;l++)this._onLayerAdd(this.planet.layers[l])}_onLayerAdd(l){this.bindLayer(l);let t=document.createElement("option");t.value=l.name,t.innerText=l.name,this._panel.el.querySelector("#layers").appendChild(t),this._panel.el.querySelector("#layers").value=l.name}_onLayerRemove(l){}},Navigation:Yi,Object3dManager:class extends Q{constructor(l={}){super(l),this._onSelect=t=>{this._currentItem=t},this._onClick=t=>{if(!this.planet||!this._layer||!this._currentItem)return;let n=this.planet.getLonLatFromPixelTerrain(t.pos);if(n&&(this.renderer.setRelativeCenter(this.planet.camera.eye),this.renderer.events.isKeyPressed(W.KEY_CTRL))){let s=this._createEntity(this._currentItem,n);this._layer.add(s)}},this._layer=l.layer||null,this._currentItem=null,this._collection=new ln({collection:l.collection}),this._dialog=new Lh({model:this._collection})}oninit(){this.renderer&&(this._dialog.appendTo(this.renderer.div||document.body),this._dialog.events.on("select",this._onSelect),this.activate())}onactivate(){this._dialog.show(),this._initEvents()}ondeactivate(){this._dialog.hide(),this._clearEvents()}bindLayer(l){this._layer=l}_initEvents(){this.planet&&this.planet.renderer&&this.planet.renderer.events.on("lclick",this._onClick)}_clearEvents(){this.planet&&this.planet.renderer&&this.planet.renderer.events.off("lclick",this._onClick)}_createEntity(l,t){let n=l.name,s=l.scale,o=new G({lonlat:t,pitch:0,yaw:0,roll:0,scale:s});for(let a=0;a<l.objects.length;a++){let h=l.objects[a],c=new G({forceGlobalPosition:!0,forceGlobalRotation:!0,forceGlobalScale:!0,geoObject:{tag:`${n}:${a.toString()}`,object3d:h}});o.appendChild(c)}return o}},OldMouseNavigation:rn,Ruler:_a,RulerSwitcher:class extends Q{constructor(l={}){super({name:"RulerSwitcher",...l}),this.ruler=new Hn({ignoreTerrain:l.ignoreTerrain})}oninit(){this.planet.addControl(this.ruler),this._createMenuBtn()}onactivate(){this.ruler.activate()}ondeactivate(){this.ruler.deactivate()}_createMenuBtn(){let l=new dt({classList:["og-map-button","og-ruler_button"],icon:`<?xml version="1.0" encoding="iso-8859-1"?>
<!-- Uploaded to: SVG Repo, www.svgrepo.com, Generator: SVG Repo Mixer Tools -->
<svg fill="#000000" height="800px" width="800px" version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" 
	 viewBox="0 0 512 512" xml:space="preserve">
<g>
	<g>
		<path d="M369.151,0L0.001,369.15L142.85,512l369.149-369.15L369.151,0z M47.286,369.15l10.908-10.908l47.782,47.782l23.642-23.642
			L81.837,334.6l10.909-10.909l23.711,23.711L140.1,323.76l-23.711-23.711l10.909-10.909l23.711,23.711l23.642-23.642
			l-23.711-23.711l10.909-10.909l47.782,47.782l23.642-23.642l-47.782-47.782l10.908-10.908l23.71,23.71l23.642-23.642l-23.71-23.71
			l10.908-10.908l23.711,23.711l23.642-23.642l-23.711-23.711l10.909-10.909l47.782,47.782l23.642-23.642l-47.782-47.782
			l10.908-10.908l23.71,23.711l23.642-23.642l-23.711-23.71L334.6,81.837l23.711,23.71l23.642-23.642l-23.711-23.712l10.908-10.908
			l95.564,95.564L142.85,464.714L47.286,369.15z"/>
	</g>
</g>
</svg>`});l.appendTo(this.renderer.div),l.events.on("change",t=>{t?this.onactivate():this.ondeactivate()})}},ScaleControl:fa,Selection:class extends Q{constructor(l={}){super(l),this._selectorScene=new Dl({name:`selectionScene:${this.__id}`,ignoreTerrain:l.ignoreTerrain,onSelect:l.onSelect,autoSelectionHide:l.autoSelectionHide}),this._toggleBtn=new dt({classList:["og-map-button","og-selection_button"],icon:`<?xml version="1.0" encoding="utf-8"?><!-- Uploaded to: SVG Repo, www.svgrepo.com, Generator: SVG Repo Mixer Tools -->
<svg width="800px" height="800px" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="iconify iconify--gis" preserveAspectRatio="xMidYMid meet"><path d="M2.1 0v1.914H0v6h3V3h5.1V0h-6zm9 0v3h6V0h-6zm9 0v3h6V0h-6zm9 0v3h6V0h-6zm9 0v3h6V0h-6zm9 0v3h6V0h-6zm9 0v3h6V0h-6zm9 0v3h1.8v1.2h3V0h-4.8zm1.8 7.2v6h3v-6h-3zM0 10.913v6h3v-6H0zM66.9 16.2v6h3v-6h-3zM0 19.914v6h3v-6H0zM66.9 25.2v6h3v-6h-3zM0 28.914v6h3v-6H0zM66.9 34.2v6h3v-6h-3zM0 37.914v6h3v-6H0zM66.9 43.2v6h3v-6h-3zM0 46.914v6h3v-6H0zM66.9 52.2v6h3v-6h-3zM0 55.914v5.191h3.809v-3H3v-2.19H0zm6.809 2.191v3h6v-3h-6zm9 0v3h6v-3h-6zm9 0v3h6v-3h-6zm9 0v3h6v-3h-6zm9 0v3h6v-3h-6zm9 0v3h6v-3h-6zm9 0v3h6v-3h-6zm9.648 1.899a2.076 2.076 0 0 0-2.19 2.324l3.137 33.676c.2 1.635 2.135 2.399 3.397 1.34l6.623-5.371l2.969 5.142c1.707 2.958 4.417 3.684 7.375 1.977c2.957-1.708 3.684-4.417 1.976-7.375l-2.959-5.125l7.848-3.008c1.548-.564 1.855-2.62.539-3.611L71.576 60.416a2.073 2.073 0 0 0-1.119-.412z" fill="#000000"></path></svg>`})}set ignoreTerrain(l){this._selectorScene.ignoreTerrain=l}oninit(){this._toggleBtn.appendTo(this.renderer.div),this._toggleBtn.events.on("change",l=>{l?this.activate():this.deactivate()}),this._selectorScene.bindPlanet(this.planet)}onactivate(){this.renderer.addNode(this._selectorScene)}ondeactivate(){this.renderer.removeNode(this._selectorScene)}},ShowFps:class extends Q{constructor(l){super(l)}oninit(){let l=document.createElement("div");l.className="defaultText ",l.id="ogShowFpsControl",document.body.appendChild(l),this.renderer.events.on("draw",this._draw,this)}_draw(){Ro("ogShowFpsControl",(1e3/this.renderer.handler.deltaTime).toFixed(1),this.renderer.handler.canvas.clientWidth-60,0)}},SimpleNavigation:class extends Q{constructor(l={}){super({name:"SimpleNavigation",autoActivate:!0,...l}),this.focusVel=0,this.focusForce=0,this._nx=0,this._ny=0,this._onMouseLeftButtonDown=t=>{if(this._active&&this.renderer){if(this.stop(),this.renderer.handler.canvas.classList.add("ogGrabbingPoiner"),this._grabbedPoint=this.renderer.getCartesianFromPixel(t),this._grabbedScreenPoint.set(t.nx,t.ny),!this._grabbedPoint){let n=this.renderer.activeCamera,s=new v,o=new v(1,0,0),a=new v(0,0,1),h=new v;new V(n.eye,t.direction).hitPlaneRes(vt.fromPoints(s,o,a),h)===V.INSIDE&&(this._grabbedPoint=h)}this._grabbedPoint&&this._eye0.copy(this.renderer.activeCamera.eye)}},this._onMouseLeftButtonUp=t=>{this.renderer.handler.canvas.classList.remove("ogGrabbingPoiner"),t.x===t.prev_x&&(t.y,t.prev_y)},this._onMouseLeftButtonHold=t=>{if(this.renderer&&this._grabbedPoint&&t.moving){let n=this.renderer.activeCamera;if(n.isOrthographic){let s=t.nx-this._grabbedScreenPoint.x,o=t.ny-this._grabbedScreenPoint.y,a=n.frustum,h=-(a.right-a.left)*s,c=(a.top-a.bottom)*o,u=n.getUp().scale(c),d=n.getRight().scale(h);n.eye=this._eye0.add(d.add(u))}else{let s,o,a=Math.abs(n.getForward().dot(v.UP)),h=this._grabbedPoint;a>.7?(s=v.add(h,v.LEFT),o=v.add(h,n.getRight())):(s=v.add(h,n.getRight()),o=v.add(h,v.UP));let c=new v;new V(n.eye,t.direction).hitPlaneRes(vt.fromPoints(h,s,o),c)===V.INSIDE&&(n.eye=n.eye.add(h.sub(c)))}n.update()}},this._onRHold=t=>{if(this._lookPos&&t.moving&&this.renderer){const n=this.renderer.activeCamera;this.renderer.controlsBag.scaleRot=1;let s=.5/n.eye.distance(this._lookPos)*j;s>.007?s=.007:s<.003&&(s=.003),n.rotateHorizontal(s*(t.x-t.prev_x),!1,this._lookPos,this._up),n.rotateVertical(s*(t.y-t.prev_y),this._lookPos),n.update()}},this._onRDown=t=>{if(this.renderer)if(this.stop(),this._lookPos=this.renderer.getCartesianFromPixel(t.pos),this._lookPos)this._up=v.UP;else{const n=this.renderer.activeCamera;let s=new vt(v.ZERO,v.UP),o=new V(n.eye,t.direction);this._lookPos=new v,o.hitPlaneRes(s,this._lookPos),this._up=v.UP}},this._onMouseWheel=t=>{if(this.renderer){let n=this.renderer.activeCamera;if(n.isOrthographic){let s=n.frustums[0],o=-(s.right-s.left)*(.5-t.nx),a=(s.top-s.bottom)*(.5-t.ny),h=n.getUp().scale(a),c=n.getRight().scale(o),u=n.eye.add(c.add(h));this._wheelPos=u.add(n.getForward()),this._wheelDist=1,this._nx=t.nx,this._ny=t.ny,this.focusForce=.05*t.wheelDelta}else{let s=this.renderer.getCartesianFromPixel(t);if(!s){s=new v;let h=new vt(v.ZERO,v.UP);new V(n.eye,t.direction).hitPlaneRes(h,s)}let o=s.sub(n.eye).normalize(),a=8*n.eye.distance(s);this.force.addA(o.scale(t.wheelDelta)).normalize().scale(a)}}},this.onCameraMoveForward=()=>{this.force.addA(this.renderer.activeCamera.getForward()).normalize()},this.onCameraMoveBackward=()=>{this.force.addA(this.renderer.activeCamera.getBackward()).normalize()},this.onCameraStrifeLeft=()=>{this.force.addA(this.renderer.activeCamera.getLeft()).normalize()},this.onCameraStrifeRight=()=>{this.force.addA(this.renderer.activeCamera.getRight()).normalize()},this.onCameraLookUp=()=>{this.renderer.activeCamera.update()},this.onCameraLookDown=()=>{this.renderer.activeCamera.update()},this.onCameraTurnLeft=()=>{this.renderer.activeCamera.update()},this.onCameraTurnRight=()=>{this.renderer.activeCamera.update()},this.onCameraRollLeft=()=>{this.renderer.activeCamera.update()},this.onCameraRollRight=()=>{this.renderer.activeCamera.update()},this.speed=l.speed||1,this.force=new v,this.vel=new v,this.mass=1,this._lookPos=void 0,this._grabbedPoint=void 0,this._grabbedScreenPoint=new H,this._up=null,this._eye0=new v,this._wheelDist=0,this._wheelPos=new v}oninit(){}onactivate(){super.onactivate();let l=this.renderer;l.activeCamera.isOrthographic&&l.getDepthMinDistanceAsync().then(t=>{l.activeCamera.focusDistance=t}),l.events.on("mousewheel",this._onMouseWheel),l.events.on("keypress",W.KEY_W,this.onCameraMoveForward,this),l.events.on("keypress",W.KEY_S,this.onCameraMoveBackward,this),l.events.on("keypress",W.KEY_A,this.onCameraStrifeLeft,this),l.events.on("keypress",W.KEY_D,this.onCameraStrifeRight,this),l.events.on("keypress",W.KEY_UP,this.onCameraLookUp,this),l.events.on("keypress",W.KEY_DOWN,this.onCameraLookDown,this),l.events.on("keypress",W.KEY_LEFT,this.onCameraTurnLeft,this),l.events.on("keypress",W.KEY_RIGHT,this.onCameraTurnRight,this),l.events.on("keypress",W.KEY_Q,this.onCameraRollLeft,this),l.events.on("keypress",W.KEY_E,this.onCameraRollRight,this),l.events.on("rhold",this._onRHold,this),l.events.on("rdown",this._onRDown,this),l.events.on("lhold",this._onMouseLeftButtonHold),l.events.on("ldown",this._onMouseLeftButtonDown),l.events.on("lup",this._onMouseLeftButtonUp),l.events.on("draw",this.onDraw,this,-1e3)}ondeactivate(){super.ondeactivate();let l=this.renderer;l.events.off("mousewheel",this._onMouseWheel),l.events.off("keypress",W.KEY_W,this.onCameraMoveForward),l.events.off("keypress",W.KEY_S,this.onCameraMoveBackward),l.events.off("keypress",W.KEY_A,this.onCameraStrifeLeft),l.events.off("keypress",W.KEY_D,this.onCameraStrifeRight),l.events.off("keypress",W.KEY_UP,this.onCameraLookUp),l.events.off("keypress",W.KEY_DOWN,this.onCameraLookDown),l.events.off("keypress",W.KEY_LEFT,this.onCameraTurnLeft),l.events.off("keypress",W.KEY_RIGHT,this.onCameraTurnRight),l.events.off("keypress",W.KEY_Q,this.onCameraRollLeft),l.events.off("keypress",W.KEY_E,this.onCameraRollRight),l.events.off("rhold",this._onRHold),l.events.off("rdown",this._onRDown),l.events.off("lhold",this._onMouseLeftButtonHold),l.events.off("ldown",this._onMouseLeftButtonDown),l.events.off("lup",this._onMouseLeftButtonUp),l.events.off("draw",this.onDraw)}_handleMouseWheel(){let l=this.renderer.activeCamera;if(l.isOrthographic&&Math.abs(this.focusVel)>.01){l.eye=this._wheelPos.add(l.getBackward().scale(this._wheelDist)),l.focusDistance-=l.focusDistance*this.focusVel*this.dt;let t=l.frustums[0],n=(t.right-t.left)*(.5-this._nx),s=-(t.top-t.bottom)*(.5-this._ny),o=l.getUp().scale(s),a=l.getRight().scale(n);l.eye.addA(a.add(o)),l.update()}else this.vel.length()>.01&&(l.eye=l.eye.add(this.vel.scaleTo(this.dt)),l.update())}onDraw(){this._updateVel(),this._handleMouseWheel()}get dt(){return .001*this.renderer.handler.deltaTime}_updateVel(){let l=this.force.scale(1/this.mass);this.vel.addA(l),this.vel.scale(.77),this.force.set(0,0,0),this.focusVel+=this.focusForce,this.focusVel*=.77,this.focusForce=0}stop(){this.focusVel=0,this.vel.clear()}},SimpleSkyBackground:ga,Sun:Dr,TimelineControl:class extends Q{constructor(l={}){super({name:"timeline",...l});let t=l.current||new Date,n=l.rangeStart||jn(t,-12),s=l.rangeEnd||jn(t,12);this._timelineView=new jl({rangeStart:n,rangeEnd:s,currentDate:t}),this._toggleBtn=new dt({classList:["og-map-button","og-timeline_button"],icon:`<?xml version="1.0" encoding="utf-8"?>
<!-- Svg Vector Icons : http://www.onlinewebfonts.com/icon -->
    <!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 1000 1000" enable-background="new 0 0 1000 1000" xml:space="preserve">
    <metadata> Svg Vector Icons : http://www.onlinewebfonts.com/icon </metadata>
    <g><path d="M500,10C229.4,10,10,229.4,10,500s219.4,490,490,490s490-219.4,490-490S770.6,10,500,10z M800.3,800.3c-39,39-84.5,69.7-135,91C613,913.5,557.4,924.7,500,924.7s-112.9-11.2-165.3-33.3c-50.5-21.3-95.9-52-135-91c-39-39-69.7-84.5-91-135C86.5,612.9,75.3,557.4,75.3,500s11.2-112.9,33.3-165.3c21.3-50.5,52-95.9,91-135c39-39,84.5-69.7,135-91C387.1,86.5,442.6,75.3,500,75.3s112.9,11.2,165.3,33.3c50.5,21.3,95.9,52,135,91c39,39,69.7,84.5,91,135c22.1,52.3,33.3,107.9,33.3,165.3s-11.2,112.9-33.3,165.3C869.9,715.8,839.3,761.2,800.3,800.3z"/><path d="M761.3,532.7H532.7V304c0-18.1-14.6-32.7-32.7-32.7s-32.7,14.6-32.7,32.7v261.3l0,0c0,18.1,14.6,32.7,32.7,32.7h261.3c18.1,0,32.7-14.6,32.7-32.7l0,0C794,547.3,779.4,532.7,761.3,532.7z"/></g>
</svg>`}),this._dialog=new Kt({title:"Timeline",visible:!1,resizable:!0,useHide:!0,top:10,left:60,width:600,height:115,minHeight:115,maxHeight:110}),this._dialog.events.on("visibility",o=>{this._toggleBtn.setActive(o)})}oninit(){let l=this.renderer.div;this._toggleBtn.appendTo(l),this._dialog.appendTo(l),this._toggleBtn.events.on("change",t=>{this._dialog.setVisibility(t),t&&this._timelineView.resize()}),this._timelineView.appendTo(this._dialog.container),this._timelineView.events.on("setcurrent",t=>{this.renderer&&this.renderer.handler.defaultClock.setDate(t)}),this._timelineView.events.on("startdrag",()=>{var t;(t=this.planet)==null||t.sun.stop(),this.renderer&&this.renderer.controls.navigation.deactivate()}),this._timelineView.events.on("stopdrag",()=>{this.renderer&&this.renderer.controls.navigation.activate()}),this._timelineView.events.on("startdragcurrent",()=>{var t;(t=this.planet)==null||t.sun.stop(),this.renderer&&this.renderer.controls.navigation.deactivate()}),this._timelineView.events.on("stopdragcurrent",()=>{this.renderer&&this.renderer.controls.navigation.activate()})}},ToggleWireframe:class extends Q{constructor(l={}){super(l),this._isActive=!1,this.toogleWireframe=()=>{this.renderer&&this.renderer.handler.gl&&(this.planet.drawMode===this.renderer.handler.gl.LINE_STRIP?this.planet.setDrawMode(this.renderer.handler.gl.TRIANGLE_STRIP):this.planet.setDrawMode(this.renderer.handler.gl.LINE_STRIP))},this._isActive=l.isActive||!1}oninit(){this.renderer.events.on("charkeypress",W.KEY_X,this.toogleWireframe,this),this._isActive&&this.planet.setDrawMode(this.renderer.handler.gl.LINE_STRIP)}},TouchNavigation:pa,ZoomControl:ma},Symbol.toStringTag,{value:"Module"}));function Ke(l){return new Uint32Array(l)}function kh(l){let t=[],n=0,s=0,o=0;for(let a=1;a<l-1-1;a++){for(let h=1;h<l-1;h++)n=a*l+h,o=(a+1)*l,s=o+h,t.push(n,s);t.push(s,o+1)}return t.push(t[t.length-1],l*l-l),Ke(t)}function Ih(l,t){let n=[];const s=(l-1)/t,o=l*l-l;let a=0;for(let h=0;h<l-2;h++){h%s==0&&(a=h);let c=o-l*h-l+1,u=o-l*a;n.push(u,c)}return t===l-1&&(n.push(l),n.push(0)),Ke(n)}function zh(l,t){let n=[];const s=(l-1)/t;let o=0;for(let a=0;a<l-2;a++){a%s==0&&(o=a);let h=l+a+1,c=o;n.push(c,h)}return t===l-1&&(n.push(l-2),n.push(l-1)),Ke(n)}function Dh(l,t){let n=[];const s=(l-1)/t;let o=0;for(let a=0;a<l-2;a++){a%s==0&&(o=a);let h=l*(a+1)+l-2,c=l+l*o-1;n.push(c,h)}return t===l-1&&(n.push(l*(l-1)-1),n.push(l*l-1)),Ke(n)}function Fh(l,t){let n=[];const s=(l-1)/t;let o=0;const a=l*(l-1)-2,h=l*l-1;for(let c=0;c<l-2;c++){c%s==0&&(o=c);let u=a-c,d=h-o;n.push(d,u)}return t===l-1&&n.push(l*l-l+1),n.push(l*l-l),Ke(n)}function no(l){let t=[[],[],[],[]];for(let n=0;n<=l;n++){let s=Math.pow(2,n)+1;t[0][n]=[],t[3][n]=[],t[2][n]=[],t[1][n]=[];for(let o=0;o<=l;o++){let a=Math.pow(2,o);t[3][n][o]=Ih(s,a),t[0][n][o]=zh(s,a),t[1][n][o]=Dh(s,a),t[2][n][o]=Fh(s,a)}}return t}function oo(l){let t=[];for(let n=0;n<=l;n++){const s=Math.pow(2,n);t[n]=kh(s+1)}return t}function Oh(l){let t=new Uint16Array((l+1)*(l+1)*2),n=0;for(let s=0;s<=l;s++)for(let o=0;o<=l;o++)t[n++]=o/l*65535,t[n++]=s/l*65535;return t}let Nh=new class{constructor(l=0){this._maxGridSize=l,this.centerIndexesTable=oo(this._maxGridSize),this.skirtsIndexesTable=no(this._maxGridSize)}get maxGridSize(){return this._maxGridSize}init(){this.centerIndexesTable=oo(this._maxGridSize),this.skirtsIndexesTable=no(this._maxGridSize)}setMaxGridSize(l){this._maxGridSize=l,this.init()}createSegmentIndexes(l,t){if(l){let s=this.centerIndexesTable[l],o=this.skirtsIndexesTable[3][l][t[3]],a=this.skirtsIndexesTable[0][l][t[0]],h=this.skirtsIndexesTable[1][l][t[1]],c=this.skirtsIndexesTable[2][l][t[2]],u=(n=s.length+o.length+a.length+h.length+c.length,new Uint32Array(n));return u.set(s,0),u.set(o,s.length),u.set(a,s.length+o.length),u.set(h,s.length+o.length+a.length),u.set(c,s.length+o.length+a.length+h.length),u}var n;return Ke([0,2,1,3])}initTextureCoordsTable(l){let t=[];for(let n=0;n<=l;n++){const s=Math.pow(2,n);t[n]=Oh(s)}return t}};function $i(){return Nh}function ao(){return new X("drawnode_screen_wl",{uniforms:{projectionMatrix:"mat4",viewMatrix:"mat4",eyePositionHigh:"vec3",eyePositionLow:"vec3",height:"float",uGlobalTextureCoord:"vec4",uNormalMapBias:"vec3",samplerCount:"int",tileOffsetArr:"vec4",layerOpacityArr:"float",samplerArr:"sampler2darray",defaultTexture:"sampler2d",uNormalMap:"sampler2d",nightTexture:"sampler2d",specularTexture:"sampler2d",lightPosition:"vec3",diffuse:"vec3",ambient:"vec3",specular:"vec4",camHeight:"float",nightTextureCoefficient:"float"},attributes:{aVertexPositionHigh:"vec3",aVertexPositionLow:"vec3",aTextureCoord:"vec2"},vertexShader:"attribute vec3 aVertexPositionHigh;attribute vec3 aVertexPositionLow;attribute vec2 aTextureCoord;uniform mat4 projectionMatrix;uniform mat4 viewMatrix;uniform vec4 uGlobalTextureCoord;uniform vec3 uNormalMapBias;uniform vec3 eyePositionHigh;uniform vec3 eyePositionLow;uniform float height;varying vec4 vTextureCoord;varying vec3 v_vertex;varying vec3 cameraPosition;varying vec2 vGlobalTextureCoord;varying float v_height;void main(void){vec3 aVertexPosition=aVertexPositionHigh+aVertexPositionLow;vec3 nh=height*normalize(aVertexPosition);vTextureCoord.xy=aTextureCoord;vGlobalTextureCoord=uGlobalTextureCoord.xy+(uGlobalTextureCoord.zw-uGlobalTextureCoord.xy)*aTextureCoord;vTextureCoord.zw=uNormalMapBias.z*(aTextureCoord+uNormalMapBias.xy);cameraPosition=eyePositionHigh+eyePositionLow;vec3 highDiff=aVertexPositionHigh-eyePositionHigh;vec3 lowDiff=aVertexPositionLow-eyePositionLow+nh;mat4 viewMatrixRTE=viewMatrix;viewMatrixRTE[3]=vec4(0.0,0.0,0.0,1.0);v_height=height;v_vertex=aVertexPosition+nh;gl_Position=projectionMatrix*viewMatrixRTE*vec4(highDiff*step(1.0,length(highDiff))+lowDiff,1.0);}",fragmentShader:`precision highp float;float getLerpValue(in float min,in float max,in float between){return(clamp(between,min,max)-min)/(max-min);}vec3 aces(vec3 color){float a=2.51;float b=0.03;float c=2.43;float d=0.59;float e=0.14;return clamp((color*(a*color+b))/(color*(c*color+d)+e),0.0,1.0);}bool intersectSphere(vec3 rayOrigin,vec3 rayDirection,float radius,inout float t1,inout float t2){float b=dot(rayDirection,rayOrigin);float c=dot(rayOrigin,rayOrigin)-radius*radius;float d=b*b-c;if(d<-1e-6){return false;}d=max(d,0.0);t1=-b-sqrt(d);t2=-b+sqrt(d);if(t2<0.0){return false;}return true;}bool intersectSphere(vec3 rayOrigin,vec3 rayDirection,float radius,inout float t){float b=dot(rayDirection,rayOrigin);float c=dot(rayOrigin,rayOrigin)-radius*radius;float d=b*b-c;if(d<0.0){return false;}t=-b-sqrt(d);return true;}float intersectSphere(vec3 ro,vec3 rd,vec4 sph){vec3 oc=ro-sph.xyz;float b=dot(oc,rd);float c=dot(oc,oc)-sph.w*sph.w;float h=b*b-c;if(h<0.0)return-1.0;h=sqrt(h);return-b-h;}bool intersectEllipsoid(in vec3 ro,in vec3 rd,in vec3 ra,inout float t){vec3 ocn=ro/ra;vec3 rdn=rd/ra;float a=dot(rdn,rdn);float b=dot(ocn,rdn);float c=dot(ocn,ocn);float h=b*b-a*(c-1.0);if(h<0.0){return false;}t=(-b-sqrt(h))/a;return true;}bool intersectEllipsoid(in vec3 ro,in vec3 rd,in vec3 ra,inout float t1,inout float t2){vec3 ocn=ro/ra;vec3 rdn=rd/ra;float a=dot(rdn,rdn);float b=dot(ocn,rdn);float c=dot(ocn,ocn);float h=b*b-a*(c-1.0);if(h<0.0){return false;}h=sqrt(h);t1=(-b-h)/a;t2=(-b+h)/a;return true;}vec3 normalEllipsoid(in vec3 pos,in vec3 ra){return normalize(pos/(ra*ra));}
#ifdef WEBGL2
#define TEXTURE_FUNC texture
#else
#define TEXTURE_FUNC texture2D
#endif
#define SLICE_SIZE 5
#define blend(DEST, SAMPLER, OFFSET, OPACITY) src = TEXTURE_FUNC(SAMPLER, OFFSET.xy + vTextureCoord.xy * OFFSET.zw); DEST = DEST * (1.0 - src.a * OPACITY) + src * OPACITY;
#define blendPicking(DEST, OFFSET, SAMPLER, MASK, COLOR, OPACITY) tc = OFFSET.xy + vTextureCoord.xy * OFFSET.zw; t = TEXTURE_FUNC(SAMPLER, tc); p = TEXTURE_FUNC(MASK, tc); DEST = mix(DEST, vec4(max(COLOR.rgb, p.rgb), OPACITY), (t.a == 0.0 ? 0.0: 1.0) * COLOR.a);
const vec3 nightStep=10.0*vec3(0.58,0.48,0.25);uniform vec4 specular;uniform vec3 diffuse;uniform vec3 ambient;uniform sampler2D uNormalMap;uniform sampler2D nightTexture;uniform sampler2D specularTexture;uniform sampler2D defaultTexture;uniform sampler2D samplerArr[SLICE_SIZE];uniform vec4 tileOffsetArr[SLICE_SIZE];uniform vec3 lightPosition;uniform float layerOpacityArr[SLICE_SIZE];uniform int samplerCount;uniform float nightTextureCoefficient;uniform float camHeight;varying vec4 vTextureCoord;varying vec3 v_vertex;varying vec3 cameraPosition;varying vec2 vGlobalTextureCoord;varying float v_height;vec3 sunPos;void main(void){sunPos=lightPosition;vec3 texNormal=texture2D(uNormalMap,vTextureCoord.zw).rgb;vec3 normal=normalize((texNormal-0.5)*2.0);float minH=1200000.0;float maxH=minH*3.0;float nightCoef=getLerpValue(minH,maxH,camHeight)*nightTextureCoefficient;vec3 lightDir=normalize(sunPos);vec3 viewDir=normalize(cameraPosition-v_vertex);float overGround=1.0-step(0.1,v_height);float shininess=texture2D(specularTexture,vGlobalTextureCoord.st).r*255.0*overGround;vec3 reflectionDirection=reflect(-lightDir,normal);float reflection=max(dot(reflectionDirection,viewDir),0.0);vec3 spec=specular.rgb*pow(reflection,specular.w)*shininess;float diffuseLightWeighting=max(dot(normal,lightDir),0.0);vec4 nightImageColor=texture2D(nightTexture,vGlobalTextureCoord.st);vec3 night=nightStep*(.18-diffuseLightWeighting*3.0)*nightImageColor.rgb*nightCoef;night*=overGround*step(0.0,night);vec4 lightWeighting=vec4(ambient+diffuse*diffuseLightWeighting+night,1.0);gl_FragColor=texture2D(defaultTexture,vTextureCoord.xy);if(samplerCount==0){gl_FragColor=gl_FragColor*lightWeighting+vec4(spec,0.0);return;}vec4 src;blend(gl_FragColor,samplerArr[0],tileOffsetArr[0],layerOpacityArr[0]);if(samplerCount==1){gl_FragColor=gl_FragColor*lightWeighting+vec4(spec,0.0);return;}blend(gl_FragColor,samplerArr[1],tileOffsetArr[1],layerOpacityArr[1]);if(samplerCount==2){gl_FragColor=gl_FragColor*lightWeighting+vec4(spec,0.0);return;}blend(gl_FragColor,samplerArr[2],tileOffsetArr[2],layerOpacityArr[2]);if(samplerCount==3){gl_FragColor=gl_FragColor*lightWeighting+vec4(spec,0.0);return;}blend(gl_FragColor,samplerArr[3],tileOffsetArr[3],layerOpacityArr[3]);if(samplerCount==4){gl_FragColor=gl_FragColor*lightWeighting+vec4(spec,0.0);return;}blend(gl_FragColor,samplerArr[4],tileOffsetArr[4],layerOpacityArr[4]);gl_FragColor=gl_FragColor*lightWeighting+vec4(spec,0.0);}`})}function lo(l){return new X("drawnode_screen_wl",{uniforms:{projectionMatrix:"mat4",viewMatrix:"mat4",eyePositionHigh:"vec3",eyePositionLow:"vec3",height:"float",uGlobalTextureCoord:"vec4",uNormalMapBias:"vec3",samplerCount:"int",tileOffsetArr:"vec4",layerOpacityArr:"float",samplerArr:"sampler2darray",defaultTexture:"sampler2d",uNormalMap:"sampler2d",nightTexture:"sampler2d",specularTexture:"sampler2d",lightPosition:"vec3",diffuse:"vec3",ambient:"vec3",specular:"vec4",transmittanceTexture:"sampler2D",scatteringTexture:"sampler2D",camHeight:"float",nightTextureCoefficient:"float",maxMinOpacity:"vec2",transitionOpacity:"float"},attributes:{aVertexPositionHigh:"vec3",aVertexPositionLow:"vec3",aTextureCoord:"vec2"},vertexShader:`#version 300 es
precision highp float;in vec3 aVertexPositionHigh;in vec3 aVertexPositionLow;in vec2 aTextureCoord;uniform mat4 projectionMatrix;uniform mat4 viewMatrix;uniform vec4 uGlobalTextureCoord;uniform vec3 uNormalMapBias;uniform vec3 eyePositionHigh;uniform vec3 eyePositionLow;uniform float height;out vec4 vTextureCoord;out vec3 v_vertex;out vec3 cameraPosition;out vec2 vGlobalTextureCoord;out float v_height;void main(void){vec3 aVertexPosition=aVertexPositionHigh+aVertexPositionLow;vec3 nh=height*normalize(aVertexPosition);vTextureCoord.xy=aTextureCoord;vGlobalTextureCoord=uGlobalTextureCoord.xy+(uGlobalTextureCoord.zw-uGlobalTextureCoord.xy)*aTextureCoord;vTextureCoord.zw=uNormalMapBias.z*(aTextureCoord+uNormalMapBias.xy);cameraPosition=eyePositionHigh+eyePositionLow;vec3 highDiff=aVertexPositionHigh-eyePositionHigh;vec3 lowDiff=aVertexPositionLow-eyePositionLow+nh;mat4 viewMatrixRTE=viewMatrix;viewMatrixRTE[3]=vec4(0.0,0.0,0.0,1.0);v_height=height;v_vertex=aVertexPosition+nh;gl_Position=projectionMatrix*viewMatrixRTE*vec4(highDiff*step(1.0,length(highDiff))+lowDiff,1.0);}`,fragmentShader:di("#version 300 es\nprecision highp float;\n#ifdef WEBGL2\n#define TEXTURE_FUNC texture\n#else\n#define TEXTURE_FUNC texture2D\n#endif\n#define SLICE_SIZE 5\n#define blend(DEST, SAMPLER, OFFSET, OPACITY) src = TEXTURE_FUNC(SAMPLER, OFFSET.xy + vTextureCoord.xy * OFFSET.zw); DEST = DEST * (1.0 - src.a * OPACITY) + src * OPACITY;\n#define blendPicking(DEST, OFFSET, SAMPLER, MASK, COLOR, OPACITY) tc = OFFSET.xy + vTextureCoord.xy * OFFSET.zw; t = TEXTURE_FUNC(SAMPLER, tc); p = TEXTURE_FUNC(MASK, tc); DEST = mix(DEST, vec4(max(COLOR.rgb, p.rgb), OPACITY), (t.a == 0.0 ? 0.0: 1.0) * COLOR.a);\nconst vec3 nightStep=10.0*vec3(0.58,0.48,0.25);float getLerpValue(in float min,in float max,in float between){return(clamp(between,min,max)-min)/(max-min);}vec3 aces(vec3 color){float a=2.51;float b=0.03;float c=2.43;float d=0.59;float e=0.14;return clamp((color*(a*color+b))/(color*(c*color+d)+e),0.0,1.0);}bool intersectSphere(vec3 rayOrigin,vec3 rayDirection,float radius,inout float t1,inout float t2){float b=dot(rayDirection,rayOrigin);float c=dot(rayOrigin,rayOrigin)-radius*radius;float d=b*b-c;if(d<-1e-6){return false;}d=max(d,0.0);t1=-b-sqrt(d);t2=-b+sqrt(d);if(t2<0.0){return false;}return true;}bool intersectSphere(vec3 rayOrigin,vec3 rayDirection,float radius,inout float t){float b=dot(rayDirection,rayOrigin);float c=dot(rayOrigin,rayOrigin)-radius*radius;float d=b*b-c;if(d<0.0){return false;}t=-b-sqrt(d);return true;}float intersectSphere(vec3 ro,vec3 rd,vec4 sph){vec3 oc=ro-sph.xyz;float b=dot(oc,rd);float c=dot(oc,oc)-sph.w*sph.w;float h=b*b-c;if(h<0.0)return-1.0;h=sqrt(h);return-b-h;}bool intersectEllipsoid(in vec3 ro,in vec3 rd,in vec3 ra,inout float t){vec3 ocn=ro/ra;vec3 rdn=rd/ra;float a=dot(rdn,rdn);float b=dot(ocn,rdn);float c=dot(ocn,ocn);float h=b*b-a*(c-1.0);if(h<0.0){return false;}t=(-b-sqrt(h))/a;return true;}bool intersectEllipsoid(in vec3 ro,in vec3 rd,in vec3 ra,inout float t1,inout float t2){vec3 ocn=ro/ra;vec3 rdn=rd/ra;float a=dot(rdn,rdn);float b=dot(ocn,rdn);float c=dot(ocn,ocn);float h=b*b-a*(c-1.0);if(h<0.0){return false;}h=sqrt(h);t1=(-b-h)/a;t2=(-b+h)/a;return true;}vec3 normalEllipsoid(in vec3 pos,in vec3 ra){return normalize(pos/(ra*ra));}\n#define PI 3.1415926538\n#define ATMOS_HEIGHT float(${ATMOS_HEIGHT})\n#define RAYLEIGH_SCALE float(${RAYLEIGH_SCALE})\n#define MIE_SCALE float(${MIE_SCALE})\n#define SAMPLE_COUNT 16\n#define SQRT_SAMPLE_COUNT 4\nconst float GROUND_ALBEDO=float(${GROUND_ALBEDO})/PI;const float BOTTOM_RADIUS=float(${BOTTOM_RADIUS});const float TOP_RADIUS=BOTTOM_RADIUS+ATMOS_HEIGHT;const float EQUATORIAL_RADIUS=float(${EQUATORIAL_RADIUS});const vec3 bottomRadii=vec3(EQUATORIAL_RADIUS,EQUATORIAL_RADIUS,BOTTOM_RADIUS);const vec3 topRadii=bottomRadii+ATMOS_HEIGHT;const vec3 SPHERE_TO_ELLIPSOID_SCALE=vec3(BOTTOM_RADIUS)/bottomRadii;const vec2 rayleighMieHeights=vec2(RAYLEIGH_SCALE,MIE_SCALE)*ATMOS_HEIGHT;const vec3 rayleighScatteringCoefficient=vec3(float(${rayleighScatteringCoefficient_0}),float(${rayleighScatteringCoefficient_1}),float(${rayleighScatteringCoefficient_2}))*1e-6;const float mieScatteringCoefficient=float(${mieScatteringCoefficient})*1e-6;const float mieExtinctionCoefficient=float(${mieExtinctionCoefficient})*1e-6;const vec3 ozoneAbsorptionCoefficient=vec3(float(${ozoneAbsorptionCoefficient_0}),float(${ozoneAbsorptionCoefficient_1}),float(${ozoneAbsorptionCoefficient_2}))*1e-6;const float SUN_ANGULAR_RADIUS=float(${SUN_ANGULAR_RADIUS});const float SUN_INTENSITY=float(${SUN_INTENSITY});const float ozoneDensityHeight=float(${ozoneDensityHeight});const float ozoneDensityWide=float(${ozoneDensityWide});vec3 sunWithBloom(vec3 rayDir,vec3 sunDir){float minSunCosTheta=cos(SUN_ANGULAR_RADIUS);float cosTheta=dot(rayDir,sunDir);if(cosTheta>=minSunCosTheta)return vec3(1.0);float offset=minSunCosTheta-cosTheta;float gaussianBloom=exp(-offset*15000.0)*0.7;float invBloom=1.0/(0.09+offset*200.0)*0.01;return vec3(gaussianBloom+invBloom);}vec3 sunWithBloomScaled(vec3 rayDir,vec3 sunDir,float angularScale){float minSunCosTheta=cos(SUN_ANGULAR_RADIUS*angularScale);float cosTheta=dot(rayDir,sunDir);if(cosTheta>=minSunCosTheta)return vec3(1.0);float offset=minSunCosTheta-cosTheta;float gaussianBloom=exp(-offset*15000.0)*0.7;float invBloom=1.0/(0.09+offset*200.0)*0.01;return vec3(gaussianBloom+invBloom);}float rayleighPhase(float angle){return 3.0/(16.0*PI)*(1.0+(angle*angle));}float miePhase(float angle){float g=0.8;return 3.0/(8.0*PI)*((1.0-g*g)*(1.0+angle*angle))/((2.0+g*g)*pow(1.0+g*g-2.0*g*angle,1.5));}vec3 opticalDepth(float height,float angle){vec3 rayOrigin=vec3(0.0,BOTTOM_RADIUS+height,0.0);vec3 rayDirection=vec3(sqrt(1.0-angle*angle),angle,0.0);float t1,t2;intersectSphere(rayOrigin,rayDirection,TOP_RADIUS,t1,t2);float segmentLength=t2/float(SAMPLE_COUNT);float t=segmentLength*0.5;vec3 opticalDepth=vec3(0.0);for(int i=0;i<SAMPLE_COUNT;i++){vec3 position=rayOrigin+t*rayDirection;float height=length(position)-BOTTOM_RADIUS;opticalDepth.xy+=exp(-height/rayleighMieHeights)*segmentLength;opticalDepth.z+=(1.0-min(abs(height-ozoneDensityHeight)/ozoneDensityWide,1.0))*segmentLength;t+=segmentLength;}return opticalDepth;}vec3 transmittance(float height,float angle){vec3 opticalDepth=opticalDepth(height,angle);return exp(-(rayleighScatteringCoefficient*opticalDepth.x+mieExtinctionCoefficient*opticalDepth.y+ozoneAbsorptionCoefficient*opticalDepth.z));}uniform vec4 specular;uniform vec3 diffuse;uniform vec3 ambient;uniform vec3 lightPosition;uniform sampler2D uNormalMap;uniform sampler2D nightTexture;uniform sampler2D specularTexture;uniform sampler2D transmittanceTexture;uniform sampler2D scatteringTexture;uniform sampler2D defaultTexture;uniform sampler2D samplerArr[SLICE_SIZE];uniform vec4 tileOffsetArr[SLICE_SIZE];uniform float layerOpacityArr[SLICE_SIZE];uniform int samplerCount;uniform float nightTextureCoefficient;uniform vec2 maxMinOpacity;uniform float camHeight;uniform float transitionOpacity;in vec4 vTextureCoord;in vec3 v_vertex;in vec3 cameraPosition;in vec2 vGlobalTextureCoord;in float v_height;vec3 sunPos;layout(location=0)out vec4 diffuseColor;vec3 transmittanceFromTexture(float height,float angle){float u=(angle+1.0)*0.5;float v=height/ATMOS_HEIGHT;return texture(transmittanceTexture,vec2(u,v)).xyz;}vec3 multipleScatteringContributionFromTexture(float height,float angle){float u=(angle+1.0)*0.5;float v=height/ATMOS_HEIGHT;return texture(scatteringTexture,vec2(u,v)).xyz;}void getSunIlluminance(in vec3 point,in vec3 lightDir,out vec3 sunIlluminance){float mu_s=dot(normalize(point),lightDir);float height=length(point)-BOTTOM_RADIUS;sunIlluminance=SUN_INTENSITY*transmittanceFromTexture(height,mu_s);}void atmosGroundColor(out vec4 fragColor,in vec3 normal){vec3 cameraPosition=cameraPosition;if(length(cameraPosition*SPHERE_TO_ELLIPSOID_SCALE)<BOTTOM_RADIUS+1.0){cameraPosition=normalize(cameraPosition*SPHERE_TO_ELLIPSOID_SCALE)*(BOTTOM_RADIUS+1.0)/SPHERE_TO_ELLIPSOID_SCALE;}vec3 rayDirection=normalize(v_vertex-cameraPosition);vec3 lightDir=normalize(sunPos);rayDirection=normalize(rayDirection*SPHERE_TO_ELLIPSOID_SCALE);vec3 camPos=cameraPosition*SPHERE_TO_ELLIPSOID_SCALE;lightDir=normalize(lightDir*SPHERE_TO_ELLIPSOID_SCALE);vec3 light=vec3(0.0);vec3 transmittanceFromCameraToSpace=vec3(1.0);float offset=0.0;float distanceToSpace=0.0;intersectSphere(camPos,rayDirection,TOP_RADIUS,offset,distanceToSpace);vec3 rayOrigin=camPos;if(offset>0.0){rayOrigin+=rayDirection*offset;}float height=length(rayOrigin)-BOTTOM_RADIUS;float rayAngle=dot(rayOrigin,rayDirection)/length(rayOrigin);bool cameraBelow=rayAngle<0.0;transmittanceFromCameraToSpace=transmittanceFromTexture(height,cameraBelow ?-rayAngle : rayAngle);float phaseAngle=dot(lightDir,rayDirection);float rayleighPhase=rayleighPhase(phaseAngle);float miePhase=miePhase(phaseAngle);float distanceToGround=0.0;bool hitGround=intersectSphere(camPos,rayDirection,BOTTOM_RADIUS,distanceToGround)&&distanceToGround>0.0;if(length(v_vertex*SPHERE_TO_ELLIPSOID_SCALE)>BOTTOM_RADIUS){distanceToGround=distance(camPos,v_vertex*SPHERE_TO_ELLIPSOID_SCALE);}float segmentLength=(distanceToGround-max(offset,0.0))/float(SAMPLE_COUNT);float t=segmentLength*0.5;vec3 transmittanceCamera;vec3 transmittanceLight;for(int i=0;i<SAMPLE_COUNT;i++){vec3 position=rayOrigin+t*rayDirection;float height=length(position)-BOTTOM_RADIUS;vec3 up=position/length(position);float rayAngle=dot(up,rayDirection);float lightAngle=dot(up,lightDir);vec3 transmittanceToSpace=transmittanceFromTexture(height,cameraBelow ?-rayAngle : rayAngle);transmittanceCamera=cameraBelow ?(transmittanceToSpace/transmittanceFromCameraToSpace):(transmittanceFromCameraToSpace/transmittanceToSpace);transmittanceLight=transmittanceFromTexture(height,lightAngle);vec2 opticalDensity=exp(-height/rayleighMieHeights);vec3 scatteredLight=transmittanceLight*(rayleighScatteringCoefficient*opticalDensity.x*rayleighPhase+mieScatteringCoefficient*opticalDensity.y*miePhase);scatteredLight+=multipleScatteringContributionFromTexture(height,lightAngle)*(rayleighScatteringCoefficient*opticalDensity.x+mieScatteringCoefficient*opticalDensity.y);light+=transmittanceCamera*scatteredLight*segmentLength;t+=segmentLength;}light*=SUN_INTENSITY;vec3 hitPoint=camPos+rayDirection*distanceToGround;vec3 up=normalize(hitPoint);float diffuseAngle=max(dot(up,lightDir),0.0);float lightAngle=dot(normal,lightDir);vec3 tA=transmittanceCamera*GROUND_ALBEDO*SUN_INTENSITY;vec3 scatteringLight=multipleScatteringContributionFromTexture(height,lightAngle);vec3 diffuseTransmittanceLight=transmittanceLight*diffuseAngle;light+=tA*(scatteringLight+diffuseTransmittanceLight);fragColor=vec4(pow(light*8.0,vec3(1.0/2.2)),1.0);}void getAtmosFadingOpacity(out float opacity){float c=length(cameraPosition);float maxDist=sqrt(c*c-BOTTOM_RADIUS*BOTTOM_RADIUS);float minDist=c-BOTTOM_RADIUS;float vertDist=distance(cameraPosition,v_vertex);opacity=clamp(maxMinOpacity.y+(maxMinOpacity.x-maxMinOpacity.y)*getLerpValue(minDist,maxDist,vertDist),0.0,1.0);}void main(void){sunPos=lightPosition;vec3 texNormal=texture(uNormalMap,vTextureCoord.zw).rgb;vec3 normal=normalize((texNormal-0.5)*2.0);float minH=1200000.0;float maxH=minH*3.0;float nightCoef=getLerpValue(minH,maxH,camHeight)*nightTextureCoefficient;vec3 lightDir=normalize(sunPos);vec3 viewDir=normalize(cameraPosition-v_vertex);vec4 atmosColor;atmosGroundColor(atmosColor,normal);vec3 sunIlluminance;getSunIlluminance(v_vertex*SPHERE_TO_ELLIPSOID_SCALE,lightDir*SPHERE_TO_ELLIPSOID_SCALE,sunIlluminance);float overGround=1.0-step(0.1,v_height);float shininess=texture(specularTexture,vGlobalTextureCoord.st).r*255.0*overGround;vec3 reflectionDirection=reflect(-lightDir,normal);float reflection=max(dot(reflectionDirection,viewDir),0.0);vec3 spec=sunIlluminance*specular.rgb*pow(reflection,specular.w)*shininess;float diffuseLightWeighting=max(dot(normal,lightDir),0.0);vec4 nightImageColor=texture(nightTexture,vGlobalTextureCoord.st);vec3 night=nightStep*(.18-diffuseLightWeighting*3.0)*nightImageColor.rgb*nightCoef;night*=overGround*step(0.0,night);vec4 lightWeighting=vec4(ambient+sunIlluminance*diffuse*diffuseLightWeighting+night,1.0);float fadingOpacity;getAtmosFadingOpacity(fadingOpacity);getSunIlluminance(cameraPosition,viewDir*SPHERE_TO_ELLIPSOID_SCALE,sunIlluminance);spec*=sunIlluminance;diffuseColor=texture(defaultTexture,vTextureCoord.xy);if(samplerCount==0){diffuseColor=mix(diffuseColor*lightWeighting,atmosColor,fadingOpacity)+vec4(spec,0.0);diffuseColor*=transitionOpacity;return;}vec4 src;blend(diffuseColor,samplerArr[0],tileOffsetArr[0],layerOpacityArr[0]);if(samplerCount==1){diffuseColor=mix(diffuseColor*lightWeighting,atmosColor*diffuseColor.a,fadingOpacity)+vec4(spec,0.0);diffuseColor*=transitionOpacity;return;}blend(diffuseColor,samplerArr[1],tileOffsetArr[1],layerOpacityArr[1]);if(samplerCount==2){diffuseColor=mix(diffuseColor*lightWeighting,atmosColor*diffuseColor.a,fadingOpacity)+vec4(spec,0.0);diffuseColor*=transitionOpacity;return;}blend(diffuseColor,samplerArr[2],tileOffsetArr[2],layerOpacityArr[2]);if(samplerCount==3){diffuseColor=mix(diffuseColor*lightWeighting,atmosColor*diffuseColor.a,fadingOpacity)+vec4(spec,0.0);diffuseColor*=transitionOpacity;return;}blend(diffuseColor,samplerArr[3],tileOffsetArr[3],layerOpacityArr[3]);if(samplerCount==4){diffuseColor=mix(diffuseColor*lightWeighting,atmosColor*diffuseColor.a,fadingOpacity)+vec4(spec,0.0);diffuseColor*=transitionOpacity;return;}blend(diffuseColor,samplerArr[4],tileOffsetArr[4],layerOpacityArr[4]);diffuseColor=mix(diffuseColor*lightWeighting,atmosColor*diffuseColor.a,fadingOpacity)+vec4(spec,0.0);diffuseColor*=transitionOpacity;}",l)})}const er={ATMOS_HEIGHT:1e5,RAYLEIGH_SCALE:.08,MIE_SCALE:.012,GROUND_ALBEDO:.05,BOTTOM_RADIUS:6356752314245179e-9,EQUATORIAL_RADIUS:6378137,rayleighScatteringCoefficient_0:5.802,rayleighScatteringCoefficient_1:13.558,rayleighScatteringCoefficient_2:33.1,mieScatteringCoefficient:3.996,mieExtinctionCoefficient:4.44,ozoneAbsorptionCoefficient_0:.65,ozoneAbsorptionCoefficient_1:1.881,ozoneAbsorptionCoefficient_2:.085,SUN_ANGULAR_RADIUS:.004685,SUN_INTENSITY:1,ozoneDensityHeight:25e3,ozoneDensityWide:15e3,disableSunDisk:!1};var Hh="attribute vec2 corners;void main(void){gl_Position=vec4(corners,0.0,1.0);}",Vh="precision lowp float;float getLerpValue(in float min,in float max,in float between){return(clamp(between,min,max)-min)/(max-min);}vec3 aces(vec3 color){float a=2.51;float b=0.03;float c=2.43;float d=0.59;float e=0.14;return clamp((color*(a*color+b))/(color*(c*color+d)+e),0.0,1.0);}bool intersectSphere(vec3 rayOrigin,vec3 rayDirection,float radius,inout float t1,inout float t2){float b=dot(rayDirection,rayOrigin);float c=dot(rayOrigin,rayOrigin)-radius*radius;float d=b*b-c;if(d<-1e-6){return false;}d=max(d,0.0);t1=-b-sqrt(d);t2=-b+sqrt(d);if(t2<0.0){return false;}return true;}bool intersectSphere(vec3 rayOrigin,vec3 rayDirection,float radius,inout float t){float b=dot(rayDirection,rayOrigin);float c=dot(rayOrigin,rayOrigin)-radius*radius;float d=b*b-c;if(d<0.0){return false;}t=-b-sqrt(d);return true;}float intersectSphere(vec3 ro,vec3 rd,vec4 sph){vec3 oc=ro-sph.xyz;float b=dot(oc,rd);float c=dot(oc,oc)-sph.w*sph.w;float h=b*b-c;if(h<0.0)return-1.0;h=sqrt(h);return-b-h;}bool intersectEllipsoid(in vec3 ro,in vec3 rd,in vec3 ra,inout float t){vec3 ocn=ro/ra;vec3 rdn=rd/ra;float a=dot(rdn,rdn);float b=dot(ocn,rdn);float c=dot(ocn,ocn);float h=b*b-a*(c-1.0);if(h<0.0){return false;}t=(-b-sqrt(h))/a;return true;}bool intersectEllipsoid(in vec3 ro,in vec3 rd,in vec3 ra,inout float t1,inout float t2){vec3 ocn=ro/ra;vec3 rdn=rd/ra;float a=dot(rdn,rdn);float b=dot(ocn,rdn);float c=dot(ocn,ocn);float h=b*b-a*(c-1.0);if(h<0.0){return false;}h=sqrt(h);t1=(-b-h)/a;t2=(-b+h)/a;return true;}vec3 normalEllipsoid(in vec3 pos,in vec3 ra){return normalize(pos/(ra*ra));}\n#define PI 3.1415926538\n#define ATMOS_HEIGHT float(${ATMOS_HEIGHT})\n#define RAYLEIGH_SCALE float(${RAYLEIGH_SCALE})\n#define MIE_SCALE float(${MIE_SCALE})\n#define SAMPLE_COUNT 16\n#define SQRT_SAMPLE_COUNT 4\nconst float GROUND_ALBEDO=float(${GROUND_ALBEDO})/PI;const float BOTTOM_RADIUS=float(${BOTTOM_RADIUS});const float TOP_RADIUS=BOTTOM_RADIUS+ATMOS_HEIGHT;const float EQUATORIAL_RADIUS=float(${EQUATORIAL_RADIUS});const vec3 bottomRadii=vec3(EQUATORIAL_RADIUS,EQUATORIAL_RADIUS,BOTTOM_RADIUS);const vec3 topRadii=bottomRadii+ATMOS_HEIGHT;const vec3 SPHERE_TO_ELLIPSOID_SCALE=vec3(BOTTOM_RADIUS)/bottomRadii;const vec2 rayleighMieHeights=vec2(RAYLEIGH_SCALE,MIE_SCALE)*ATMOS_HEIGHT;const vec3 rayleighScatteringCoefficient=vec3(float(${rayleighScatteringCoefficient_0}),float(${rayleighScatteringCoefficient_1}),float(${rayleighScatteringCoefficient_2}))*1e-6;const float mieScatteringCoefficient=float(${mieScatteringCoefficient})*1e-6;const float mieExtinctionCoefficient=float(${mieExtinctionCoefficient})*1e-6;const vec3 ozoneAbsorptionCoefficient=vec3(float(${ozoneAbsorptionCoefficient_0}),float(${ozoneAbsorptionCoefficient_1}),float(${ozoneAbsorptionCoefficient_2}))*1e-6;const float SUN_ANGULAR_RADIUS=float(${SUN_ANGULAR_RADIUS});const float SUN_INTENSITY=float(${SUN_INTENSITY});const float ozoneDensityHeight=float(${ozoneDensityHeight});const float ozoneDensityWide=float(${ozoneDensityWide});vec3 sunWithBloom(vec3 rayDir,vec3 sunDir){float minSunCosTheta=cos(SUN_ANGULAR_RADIUS);float cosTheta=dot(rayDir,sunDir);if(cosTheta>=minSunCosTheta)return vec3(1.0);float offset=minSunCosTheta-cosTheta;float gaussianBloom=exp(-offset*15000.0)*0.7;float invBloom=1.0/(0.09+offset*200.0)*0.01;return vec3(gaussianBloom+invBloom);}vec3 sunWithBloomScaled(vec3 rayDir,vec3 sunDir,float angularScale){float minSunCosTheta=cos(SUN_ANGULAR_RADIUS*angularScale);float cosTheta=dot(rayDir,sunDir);if(cosTheta>=minSunCosTheta)return vec3(1.0);float offset=minSunCosTheta-cosTheta;float gaussianBloom=exp(-offset*15000.0)*0.7;float invBloom=1.0/(0.09+offset*200.0)*0.01;return vec3(gaussianBloom+invBloom);}float rayleighPhase(float angle){return 3.0/(16.0*PI)*(1.0+(angle*angle));}float miePhase(float angle){float g=0.8;return 3.0/(8.0*PI)*((1.0-g*g)*(1.0+angle*angle))/((2.0+g*g)*pow(1.0+g*g-2.0*g*angle,1.5));}vec3 opticalDepth(float height,float angle){vec3 rayOrigin=vec3(0.0,BOTTOM_RADIUS+height,0.0);vec3 rayDirection=vec3(sqrt(1.0-angle*angle),angle,0.0);float t1,t2;intersectSphere(rayOrigin,rayDirection,TOP_RADIUS,t1,t2);float segmentLength=t2/float(SAMPLE_COUNT);float t=segmentLength*0.5;vec3 opticalDepth=vec3(0.0);for(int i=0;i<SAMPLE_COUNT;i++){vec3 position=rayOrigin+t*rayDirection;float height=length(position)-BOTTOM_RADIUS;opticalDepth.xy+=exp(-height/rayleighMieHeights)*segmentLength;opticalDepth.z+=(1.0-min(abs(height-ozoneDensityHeight)/ozoneDensityWide,1.0))*segmentLength;t+=segmentLength;}return opticalDepth;}vec3 transmittance(float height,float angle){vec3 opticalDepth=opticalDepth(height,angle);return exp(-(rayleighScatteringCoefficient*opticalDepth.x+mieExtinctionCoefficient*opticalDepth.y+ozoneAbsorptionCoefficient*opticalDepth.z));}\n#define DISABLE_SUN_DISK ${ disableSunDisk }\nuniform mat4 viewMatrix;uniform vec3 sunPos;uniform vec3 camPos;uniform vec2 iResolution;uniform float fov;uniform float opacity;uniform float isOrthographic;uniform vec4 frustumParams;uniform sampler2D transmittanceTexture;uniform sampler2D scatteringTexture;float valueHSV(vec3 rgb){return max(max(rgb.r,rgb.g),rgb.b);}vec3 transmittanceFromTexture(float height,float angle){float u=(angle+1.0)*0.5;float v=height/ATMOS_HEIGHT;return texture2D(transmittanceTexture,vec2(u,v)).xyz;}vec3 multipleScatteringContributionFromTexture(float height,float angle){float u=(angle+1.0)*0.5;float v=height/ATMOS_HEIGHT;return texture2D(scatteringTexture,vec2(u,v)).xyz;}bool intersectEllipsoidToSphere(in vec3 ro,in vec3 rd,in vec3 ellRadii,in float sphereRadius,out float t1,out float t2){float offset=0.0,distanceToSpace=0.0;if(intersectEllipsoid(ro,rd,ellRadii,offset,distanceToSpace)){vec3 hitEll=ro+rd*offset;vec3 nEll=normalEllipsoid(hitEll,ellRadii);float t=0.0;bool intersectsSphere=intersectSphere(hitEll,nEll,sphereRadius,t);vec3 hitSphere=hitEll+nEll*t;t1=length(hitSphere-ro);hitEll=ro+rd*distanceToSpace;nEll=normalEllipsoid(hitEll,ellRadii);t=0.0;intersectsSphere=intersectSphere(hitEll,nEll,sphereRadius,t);hitSphere=hitEll+nEll*t;t2=length(hitSphere-ro);return true;}return false;}mat4 transpose(in mat4 m){vec4 i0=m[0];vec4 i1=m[1];vec4 i2=m[2];vec4 i3=m[3];mat4 outMatrix=mat4(vec4(i0.x,i1.x,i2.x,i3.x),vec4(i0.y,i1.y,i2.y,i3.y),vec4(i0.z,i1.z,i2.z,i3.z),vec4(i0.w,i1.w,i2.w,i3.w));return outMatrix;}void mainImage(out vec4 fragColor){vec3 cameraPosition=camPos;vec3 lightDirection=normalize(sunPos);vec2 uv=(2.0*gl_FragCoord.xy-iResolution.xy)/iResolution.y;vec3 rayDirection;if(isOrthographic!=0.0){float px=uv.x*iResolution.y/iResolution.x;float py=uv.y;float dx=0.5*frustumParams.x*px;float dy=0.5*frustumParams.y*py;mat4 viewMatrixT=transpose(viewMatrix);vec3 right=normalize(viewMatrixT[0].xyz);vec3 up=normalize(viewMatrixT[1].xyz);vec3 backward=normalize(viewMatrixT[2].xyz);vec3 forward=-backward;rayDirection=forward;cameraPosition=cameraPosition+right*dx+up*dy;}else{float fieldOfView=fov;float z=1.0/tan(fieldOfView*0.5*PI/180.0);rayDirection=normalize(vec3(uv,-z));vec4 rd=transpose(viewMatrix)*vec4(rayDirection,1.0);rayDirection=rd.xyz;}vec3 light=vec3(0.0);vec3 transmittanceFromCameraToSpace=vec3(1.0);float offset=0.0;float distanceToSpace=0.0;rayDirection=normalize(rayDirection*SPHERE_TO_ELLIPSOID_SCALE);cameraPosition*=SPHERE_TO_ELLIPSOID_SCALE;lightDirection=normalize(lightDirection*SPHERE_TO_ELLIPSOID_SCALE);if(length(cameraPosition)<BOTTOM_RADIUS+100.0){cameraPosition=normalize(cameraPosition)*(BOTTOM_RADIUS+100.0);}if(intersectSphere(cameraPosition,rayDirection,TOP_RADIUS,offset,distanceToSpace)){vec3 rayOrigin=cameraPosition;if(offset>0.0){rayOrigin=cameraPosition+rayDirection*offset;}float height=length(rayOrigin)-BOTTOM_RADIUS;float rayAngle=dot(rayOrigin,rayDirection)/length(rayOrigin);bool cameraBelow=rayAngle<0.0;transmittanceFromCameraToSpace=transmittanceFromTexture(height,cameraBelow ?-rayAngle : rayAngle);float phaseAngle=dot(lightDirection,rayDirection);float rayleighPhase=rayleighPhase(phaseAngle);float miePhase=miePhase(phaseAngle);float distanceToGround=0.0;bool hitGround=intersectSphere(cameraPosition,rayDirection,BOTTOM_RADIUS,distanceToGround)&&distanceToGround>0.0;if(intersectSphere(cameraPosition,rayDirection,BOTTOM_RADIUS-100000.0,distanceToGround)&&hitGround){fragColor=vec4(0.47,0.47,0.5,1.0);return;}float segmentLength=abs(((hitGround ? distanceToGround : distanceToSpace)-max(offset,0.0))/float(SAMPLE_COUNT));float t=segmentLength*0.5;vec3 transmittanceCamera;vec3 transmittanceLight;for(int i=0;i<SAMPLE_COUNT;i++){vec3 position=rayOrigin+t*rayDirection;float height=length(position)-BOTTOM_RADIUS;vec3 up=position/length(position);float rayAngle=dot(up,rayDirection);float lightAngle=dot(up,lightDirection);vec3 transmittanceToSpace=transmittanceFromTexture(height,cameraBelow ?-rayAngle : rayAngle);transmittanceCamera=cameraBelow ?(transmittanceToSpace/transmittanceFromCameraToSpace):(transmittanceFromCameraToSpace/transmittanceToSpace);transmittanceLight=transmittanceFromTexture(height,lightAngle);vec2 opticalDensity=exp(-height/rayleighMieHeights);vec3 scatteredLight=transmittanceLight*(rayleighScatteringCoefficient*opticalDensity.x*rayleighPhase+mieScatteringCoefficient*opticalDensity.y*miePhase);scatteredLight+=multipleScatteringContributionFromTexture(height,lightAngle)*(rayleighScatteringCoefficient*opticalDensity.x+mieScatteringCoefficient*opticalDensity.y);light+=transmittanceCamera*scatteredLight*segmentLength;t+=segmentLength;}light*=SUN_INTENSITY;if(hitGround){vec3 hitPoint=cameraPosition+rayDirection*distanceToGround;vec3 up=hitPoint/length(hitPoint);float diffuseAngle=max(dot(up,lightDirection),0.0);float lightAngle=dot(up,lightDirection);light+=transmittanceCamera*GROUND_ALBEDO*multipleScatteringContributionFromTexture(height,lightAngle)*SUN_INTENSITY;light+=transmittanceCamera*transmittanceLight*GROUND_ALBEDO*diffuseAngle*SUN_INTENSITY;}}\n#if !DISABLE_SUN_DISK\n{float distanceToGround=0.0;bool hitGround=intersectSphere(cameraPosition,rayDirection,BOTTOM_RADIUS,distanceToGround)&&distanceToGround>0.0;if(!hitGround){vec3 sunLum;if(isOrthographic!=0.0){float z=1.0/tan(fov*0.5*PI/180.0);vec3 viewRay=normalize(vec3(uv,-z));vec4 rd=transpose(viewMatrix)*vec4(viewRay,1.0);vec3 pseudoRayDirection=normalize(rd.xyz);const float sunOrthoAngularScale=2.0;sunLum=sunWithBloomScaled(pseudoRayDirection,lightDirection,sunOrthoAngularScale)*vec3(1.0,1.0,0.8);}else{sunLum=sunWithBloom(rayDirection,lightDirection)*vec3(1.0,1.0,0.8);}sunLum=smoothstep(0.002,1.0,sunLum);light+=sunLum*SUN_INTENSITY*transmittanceFromCameraToSpace;}}\n#endif\nvec4 color=vec4(pow(opacity*light*8.0,vec3(1.0/2.2)),valueHSV(light)*clamp(opacity,0.0,1.0));fragColor=color;}void main(void){mainImage(gl_FragColor);}";class Uh extends Q{constructor(t={}){super({name:"Atmosphere",...t}),this._transmittanceBuffer=null,this._scatteringBuffer=null,this.opacity=1;const n=t;this._parameters=JSON.parse(JSON.stringify({...er,...n}))}setParameters(t){this._parameters=JSON.parse(JSON.stringify(t)),this.initLookupTexturesShaders(),this.drawLookupTextures(),this.removeLookupTexturesShaders(),this.initPlanetAtmosphereShader()}get parameters(){return JSON.parse(JSON.stringify(this._parameters))}initPlanetAtmosphereShader(){var t;(t=this.planet)==null||t.initAtmosphereShader(this._parameters)}oninit(){this.renderer&&(this._initLookupTextures(),this.initLookupTexturesShaders(),this.drawLookupTextures(),this.removeLookupTexturesShaders(),this.initBackgroundShader(),this.activate())}initLookupTexturesShaders(){var t,n;this.renderer&&(this.renderer.handler.addProgram((t=this._parameters,new X("transmittance",{uniforms:{iResolution:"vec2"},attributes:{a_position:"vec2"},vertexShader:"attribute vec2 a_position;void main(void){gl_Position=vec4(a_position,0.0,1.0);}",fragmentShader:di("precision highp float;float getLerpValue(in float min,in float max,in float between){return(clamp(between,min,max)-min)/(max-min);}vec3 aces(vec3 color){float a=2.51;float b=0.03;float c=2.43;float d=0.59;float e=0.14;return clamp((color*(a*color+b))/(color*(c*color+d)+e),0.0,1.0);}bool intersectSphere(vec3 rayOrigin,vec3 rayDirection,float radius,inout float t1,inout float t2){float b=dot(rayDirection,rayOrigin);float c=dot(rayOrigin,rayOrigin)-radius*radius;float d=b*b-c;if(d<-1e-6){return false;}d=max(d,0.0);t1=-b-sqrt(d);t2=-b+sqrt(d);if(t2<0.0){return false;}return true;}bool intersectSphere(vec3 rayOrigin,vec3 rayDirection,float radius,inout float t){float b=dot(rayDirection,rayOrigin);float c=dot(rayOrigin,rayOrigin)-radius*radius;float d=b*b-c;if(d<0.0){return false;}t=-b-sqrt(d);return true;}float intersectSphere(vec3 ro,vec3 rd,vec4 sph){vec3 oc=ro-sph.xyz;float b=dot(oc,rd);float c=dot(oc,oc)-sph.w*sph.w;float h=b*b-c;if(h<0.0)return-1.0;h=sqrt(h);return-b-h;}bool intersectEllipsoid(in vec3 ro,in vec3 rd,in vec3 ra,inout float t){vec3 ocn=ro/ra;vec3 rdn=rd/ra;float a=dot(rdn,rdn);float b=dot(ocn,rdn);float c=dot(ocn,ocn);float h=b*b-a*(c-1.0);if(h<0.0){return false;}t=(-b-sqrt(h))/a;return true;}bool intersectEllipsoid(in vec3 ro,in vec3 rd,in vec3 ra,inout float t1,inout float t2){vec3 ocn=ro/ra;vec3 rdn=rd/ra;float a=dot(rdn,rdn);float b=dot(ocn,rdn);float c=dot(ocn,ocn);float h=b*b-a*(c-1.0);if(h<0.0){return false;}h=sqrt(h);t1=(-b-h)/a;t2=(-b+h)/a;return true;}vec3 normalEllipsoid(in vec3 pos,in vec3 ra){return normalize(pos/(ra*ra));}\n#define PI 3.1415926538\n#define ATMOS_HEIGHT float(${ATMOS_HEIGHT})\n#define RAYLEIGH_SCALE float(${RAYLEIGH_SCALE})\n#define MIE_SCALE float(${MIE_SCALE})\n#define SAMPLE_COUNT 16\n#define SQRT_SAMPLE_COUNT 4\nconst float GROUND_ALBEDO=float(${GROUND_ALBEDO})/PI;const float BOTTOM_RADIUS=float(${BOTTOM_RADIUS});const float TOP_RADIUS=BOTTOM_RADIUS+ATMOS_HEIGHT;const float EQUATORIAL_RADIUS=float(${EQUATORIAL_RADIUS});const vec3 bottomRadii=vec3(EQUATORIAL_RADIUS,EQUATORIAL_RADIUS,BOTTOM_RADIUS);const vec3 topRadii=bottomRadii+ATMOS_HEIGHT;const vec3 SPHERE_TO_ELLIPSOID_SCALE=vec3(BOTTOM_RADIUS)/bottomRadii;const vec2 rayleighMieHeights=vec2(RAYLEIGH_SCALE,MIE_SCALE)*ATMOS_HEIGHT;const vec3 rayleighScatteringCoefficient=vec3(float(${rayleighScatteringCoefficient_0}),float(${rayleighScatteringCoefficient_1}),float(${rayleighScatteringCoefficient_2}))*1e-6;const float mieScatteringCoefficient=float(${mieScatteringCoefficient})*1e-6;const float mieExtinctionCoefficient=float(${mieExtinctionCoefficient})*1e-6;const vec3 ozoneAbsorptionCoefficient=vec3(float(${ozoneAbsorptionCoefficient_0}),float(${ozoneAbsorptionCoefficient_1}),float(${ozoneAbsorptionCoefficient_2}))*1e-6;const float SUN_ANGULAR_RADIUS=float(${SUN_ANGULAR_RADIUS});const float SUN_INTENSITY=float(${SUN_INTENSITY});const float ozoneDensityHeight=float(${ozoneDensityHeight});const float ozoneDensityWide=float(${ozoneDensityWide});vec3 sunWithBloom(vec3 rayDir,vec3 sunDir){float minSunCosTheta=cos(SUN_ANGULAR_RADIUS);float cosTheta=dot(rayDir,sunDir);if(cosTheta>=minSunCosTheta)return vec3(1.0);float offset=minSunCosTheta-cosTheta;float gaussianBloom=exp(-offset*15000.0)*0.7;float invBloom=1.0/(0.09+offset*200.0)*0.01;return vec3(gaussianBloom+invBloom);}vec3 sunWithBloomScaled(vec3 rayDir,vec3 sunDir,float angularScale){float minSunCosTheta=cos(SUN_ANGULAR_RADIUS*angularScale);float cosTheta=dot(rayDir,sunDir);if(cosTheta>=minSunCosTheta)return vec3(1.0);float offset=minSunCosTheta-cosTheta;float gaussianBloom=exp(-offset*15000.0)*0.7;float invBloom=1.0/(0.09+offset*200.0)*0.01;return vec3(gaussianBloom+invBloom);}float rayleighPhase(float angle){return 3.0/(16.0*PI)*(1.0+(angle*angle));}float miePhase(float angle){float g=0.8;return 3.0/(8.0*PI)*((1.0-g*g)*(1.0+angle*angle))/((2.0+g*g)*pow(1.0+g*g-2.0*g*angle,1.5));}vec3 opticalDepth(float height,float angle){vec3 rayOrigin=vec3(0.0,BOTTOM_RADIUS+height,0.0);vec3 rayDirection=vec3(sqrt(1.0-angle*angle),angle,0.0);float t1,t2;intersectSphere(rayOrigin,rayDirection,TOP_RADIUS,t1,t2);float segmentLength=t2/float(SAMPLE_COUNT);float t=segmentLength*0.5;vec3 opticalDepth=vec3(0.0);for(int i=0;i<SAMPLE_COUNT;i++){vec3 position=rayOrigin+t*rayDirection;float height=length(position)-BOTTOM_RADIUS;opticalDepth.xy+=exp(-height/rayleighMieHeights)*segmentLength;opticalDepth.z+=(1.0-min(abs(height-ozoneDensityHeight)/ozoneDensityWide,1.0))*segmentLength;t+=segmentLength;}return opticalDepth;}vec3 transmittance(float height,float angle){vec3 opticalDepth=opticalDepth(height,angle);return exp(-(rayleighScatteringCoefficient*opticalDepth.x+mieExtinctionCoefficient*opticalDepth.y+ozoneAbsorptionCoefficient*opticalDepth.z));}uniform vec2 iResolution;void main(void){vec2 uv=gl_FragCoord.xy/iResolution.xy;float height=uv.y*ATMOS_HEIGHT;float angle=uv.x*2.0-1.0;gl_FragColor=vec4(transmittance(height,angle),1.0);}",t||er)}))),this.renderer.handler.addProgram((n=this._parameters,new X("scattering",{uniforms:{iResolution:"vec2",transmittanceTexture:"sampler2d"},attributes:{a_position:"vec2"},vertexShader:"attribute vec2 a_position;void main(void){gl_Position=vec4(a_position,0.0,1.0);}",fragmentShader:di("precision highp float;float getLerpValue(in float min,in float max,in float between){return(clamp(between,min,max)-min)/(max-min);}vec3 aces(vec3 color){float a=2.51;float b=0.03;float c=2.43;float d=0.59;float e=0.14;return clamp((color*(a*color+b))/(color*(c*color+d)+e),0.0,1.0);}bool intersectSphere(vec3 rayOrigin,vec3 rayDirection,float radius,inout float t1,inout float t2){float b=dot(rayDirection,rayOrigin);float c=dot(rayOrigin,rayOrigin)-radius*radius;float d=b*b-c;if(d<-1e-6){return false;}d=max(d,0.0);t1=-b-sqrt(d);t2=-b+sqrt(d);if(t2<0.0){return false;}return true;}bool intersectSphere(vec3 rayOrigin,vec3 rayDirection,float radius,inout float t){float b=dot(rayDirection,rayOrigin);float c=dot(rayOrigin,rayOrigin)-radius*radius;float d=b*b-c;if(d<0.0){return false;}t=-b-sqrt(d);return true;}float intersectSphere(vec3 ro,vec3 rd,vec4 sph){vec3 oc=ro-sph.xyz;float b=dot(oc,rd);float c=dot(oc,oc)-sph.w*sph.w;float h=b*b-c;if(h<0.0)return-1.0;h=sqrt(h);return-b-h;}bool intersectEllipsoid(in vec3 ro,in vec3 rd,in vec3 ra,inout float t){vec3 ocn=ro/ra;vec3 rdn=rd/ra;float a=dot(rdn,rdn);float b=dot(ocn,rdn);float c=dot(ocn,ocn);float h=b*b-a*(c-1.0);if(h<0.0){return false;}t=(-b-sqrt(h))/a;return true;}bool intersectEllipsoid(in vec3 ro,in vec3 rd,in vec3 ra,inout float t1,inout float t2){vec3 ocn=ro/ra;vec3 rdn=rd/ra;float a=dot(rdn,rdn);float b=dot(ocn,rdn);float c=dot(ocn,ocn);float h=b*b-a*(c-1.0);if(h<0.0){return false;}h=sqrt(h);t1=(-b-h)/a;t2=(-b+h)/a;return true;}vec3 normalEllipsoid(in vec3 pos,in vec3 ra){return normalize(pos/(ra*ra));}\n#define PI 3.1415926538\n#define ATMOS_HEIGHT float(${ATMOS_HEIGHT})\n#define RAYLEIGH_SCALE float(${RAYLEIGH_SCALE})\n#define MIE_SCALE float(${MIE_SCALE})\n#define SAMPLE_COUNT 16\n#define SQRT_SAMPLE_COUNT 4\nconst float GROUND_ALBEDO=float(${GROUND_ALBEDO})/PI;const float BOTTOM_RADIUS=float(${BOTTOM_RADIUS});const float TOP_RADIUS=BOTTOM_RADIUS+ATMOS_HEIGHT;const float EQUATORIAL_RADIUS=float(${EQUATORIAL_RADIUS});const vec3 bottomRadii=vec3(EQUATORIAL_RADIUS,EQUATORIAL_RADIUS,BOTTOM_RADIUS);const vec3 topRadii=bottomRadii+ATMOS_HEIGHT;const vec3 SPHERE_TO_ELLIPSOID_SCALE=vec3(BOTTOM_RADIUS)/bottomRadii;const vec2 rayleighMieHeights=vec2(RAYLEIGH_SCALE,MIE_SCALE)*ATMOS_HEIGHT;const vec3 rayleighScatteringCoefficient=vec3(float(${rayleighScatteringCoefficient_0}),float(${rayleighScatteringCoefficient_1}),float(${rayleighScatteringCoefficient_2}))*1e-6;const float mieScatteringCoefficient=float(${mieScatteringCoefficient})*1e-6;const float mieExtinctionCoefficient=float(${mieExtinctionCoefficient})*1e-6;const vec3 ozoneAbsorptionCoefficient=vec3(float(${ozoneAbsorptionCoefficient_0}),float(${ozoneAbsorptionCoefficient_1}),float(${ozoneAbsorptionCoefficient_2}))*1e-6;const float SUN_ANGULAR_RADIUS=float(${SUN_ANGULAR_RADIUS});const float SUN_INTENSITY=float(${SUN_INTENSITY});const float ozoneDensityHeight=float(${ozoneDensityHeight});const float ozoneDensityWide=float(${ozoneDensityWide});vec3 sunWithBloom(vec3 rayDir,vec3 sunDir){float minSunCosTheta=cos(SUN_ANGULAR_RADIUS);float cosTheta=dot(rayDir,sunDir);if(cosTheta>=minSunCosTheta)return vec3(1.0);float offset=minSunCosTheta-cosTheta;float gaussianBloom=exp(-offset*15000.0)*0.7;float invBloom=1.0/(0.09+offset*200.0)*0.01;return vec3(gaussianBloom+invBloom);}vec3 sunWithBloomScaled(vec3 rayDir,vec3 sunDir,float angularScale){float minSunCosTheta=cos(SUN_ANGULAR_RADIUS*angularScale);float cosTheta=dot(rayDir,sunDir);if(cosTheta>=minSunCosTheta)return vec3(1.0);float offset=minSunCosTheta-cosTheta;float gaussianBloom=exp(-offset*15000.0)*0.7;float invBloom=1.0/(0.09+offset*200.0)*0.01;return vec3(gaussianBloom+invBloom);}float rayleighPhase(float angle){return 3.0/(16.0*PI)*(1.0+(angle*angle));}float miePhase(float angle){float g=0.8;return 3.0/(8.0*PI)*((1.0-g*g)*(1.0+angle*angle))/((2.0+g*g)*pow(1.0+g*g-2.0*g*angle,1.5));}vec3 opticalDepth(float height,float angle){vec3 rayOrigin=vec3(0.0,BOTTOM_RADIUS+height,0.0);vec3 rayDirection=vec3(sqrt(1.0-angle*angle),angle,0.0);float t1,t2;intersectSphere(rayOrigin,rayDirection,TOP_RADIUS,t1,t2);float segmentLength=t2/float(SAMPLE_COUNT);float t=segmentLength*0.5;vec3 opticalDepth=vec3(0.0);for(int i=0;i<SAMPLE_COUNT;i++){vec3 position=rayOrigin+t*rayDirection;float height=length(position)-BOTTOM_RADIUS;opticalDepth.xy+=exp(-height/rayleighMieHeights)*segmentLength;opticalDepth.z+=(1.0-min(abs(height-ozoneDensityHeight)/ozoneDensityWide,1.0))*segmentLength;t+=segmentLength;}return opticalDepth;}vec3 transmittance(float height,float angle){vec3 opticalDepth=opticalDepth(height,angle);return exp(-(rayleighScatteringCoefficient*opticalDepth.x+mieExtinctionCoefficient*opticalDepth.y+ozoneAbsorptionCoefficient*opticalDepth.z));}uniform sampler2D transmittanceTexture;uniform vec2 iResolution;vec3 transmittanceFromTexture(float height,float angle){float u=(angle+1.0)*0.5;float v=height/ATMOS_HEIGHT;return texture2D(transmittanceTexture,vec2(u,v)).xyz;}void main(void){vec2 uv=gl_FragCoord.xy/iResolution.xy;float height=uv.y*ATMOS_HEIGHT;float angle=uv.x*2.0-1.0;vec3 rayOrigin=vec3(0.0,BOTTOM_RADIUS+height,0.0);vec3 up=rayOrigin/length(rayOrigin);vec3 lightDirection=vec3(sqrt(1.0-angle*angle),angle,0.0);const float isotropicPhase=1.0/(4.0*PI);vec3 light=vec3(0.0);vec3 lightTransferFactor=vec3(0.0);for(int i=0;i<SQRT_SAMPLE_COUNT;i++){for(int j=0;j<SQRT_SAMPLE_COUNT;j++){float u=((0.5+float(i))/float(SQRT_SAMPLE_COUNT))*2.0-1.0;float v=(0.5+float(j))/float(SQRT_SAMPLE_COUNT);float r=sqrt(1.0-u*u);float theta=2.0*PI*v;vec3 rayDirection=vec3(cos(theta)*r,sin(theta)*r,u);float rayAngle=dot(up,rayDirection);bool cameraBelow=rayAngle<0.0;vec3 transmittanceFromCameraToSpace=transmittanceFromTexture(height,cameraBelow ?-rayAngle : rayAngle);float offset=0.0;float distanceToSpace=0.0;intersectSphere(rayOrigin,rayDirection,TOP_RADIUS,offset,distanceToSpace);float distanceToGround=0.0;bool hitGround=intersectSphere(rayOrigin,rayDirection,BOTTOM_RADIUS,distanceToGround)&&distanceToGround>0.0;float segmentLength=(hitGround ? distanceToGround : distanceToSpace)/float(SAMPLE_COUNT);float t=segmentLength*0.5;vec3 transmittanceCamera;vec3 transmittanceLight;for(int k=0;k<SAMPLE_COUNT;k++){vec3 position=rayOrigin+t*rayDirection;float height=length(position)-BOTTOM_RADIUS;vec3 up=position/length(position);float rayAngle=dot(up,rayDirection);float lightAngle=dot(up,lightDirection);float distanceToGround;float shadow=intersectSphere(position,lightDirection,BOTTOM_RADIUS,distanceToGround)&&distanceToGround>=0.0 ? 0.0 : 1.0;vec3 transmittanceToSpace=transmittanceFromTexture(height,cameraBelow ?-rayAngle : rayAngle);transmittanceCamera=cameraBelow ?(transmittanceToSpace/transmittanceFromCameraToSpace):(transmittanceFromCameraToSpace/transmittanceToSpace);transmittanceLight=transmittanceFromTexture(height,lightAngle);vec2 opticalDensity=exp(-height/rayleighMieHeights);vec3 scatteredLight=transmittanceLight*(rayleighScatteringCoefficient*opticalDensity.x+mieScatteringCoefficient*opticalDensity.y)*isotropicPhase;light+=shadow*transmittanceCamera*scatteredLight*segmentLength;lightTransferFactor+=transmittanceCamera*(rayleighScatteringCoefficient*opticalDensity.x+mieScatteringCoefficient*opticalDensity.y)*segmentLength;t+=segmentLength;}if(hitGround){vec3 hitPoint=rayOrigin+rayDirection*distanceToGround;vec3 normal=normalize(hitPoint);float diffuseAngle=max(dot(normal,lightDirection),0.0);light+=transmittanceCamera*transmittanceLight*GROUND_ALBEDO*diffuseAngle;}}}light/=float(SAMPLE_COUNT);lightTransferFactor/=float(SAMPLE_COUNT);vec3 color=light/(1.0-lightTransferFactor);gl_FragColor=vec4(color,1.0);}",n||er)}))))}initBackgroundShader(){var t;this.renderer&&this.renderer.handler.addProgram((t=this._parameters,new X("atmosphereBackground",{uniforms:{iResolution:"vec2",fov:"float",camPos:"vec3",viewMatrix:"mat4",transmittanceTexture:"sampler2D",scatteringTexture:"sampler2D",sunPos:"vec3",opacity:"float",isOrthographic:"float",frustumParams:"vec4"},attributes:{corners:"vec3"},vertexShader:Hh,fragmentShader:di(Vh,{...t,disableSunDisk:t!=null&&t.disableSunDisk?1:0})})))}removeBackgroundShader(){this.renderer&&this.renderer.handler.removeProgram("atmosphereBackground")}removeLookupTexturesShaders(){var t,n;if(this.renderer){let s=this.renderer.handler;(t=this._scatteringBuffer)!=null&&t.isComplete()&&s.removeProgram("scattering"),(n=this._transmittanceBuffer)!=null&&n.isComplete()&&s.removeProgram("transmittance")}}onactivate(){super.onactivate(),this.planet&&this.planet.events.on("draw",this._drawBackground,this)}ondeactivate(){super.ondeactivate(),this.planet&&this.planet.events.off("draw",this._drawBackground)}_initLookupTextures(){this._transmittanceBuffer=new Rt(this.renderer.handler,{width:1024,height:1024,useDepth:!1,targets:[{filter:"LINEAR",type:"FLOAT",internalFormat:"RGBA16F"}]}),this._transmittanceBuffer.init(),this._scatteringBuffer=new Rt(this.renderer.handler,{width:1024,height:1024,useDepth:!1,targets:[{filter:"LINEAR",type:"FLOAT",internalFormat:"RGBA16F"}]}),this._scatteringBuffer.init()}_renderLookupTextures(){if(!this.renderer)return;let t=this.renderer.screenFramePositionBuffer,n=this.renderer.handler,s=n.gl;if(this._transmittanceBuffer){this._transmittanceBuffer.activate();let o=n.programs.transmittance,a=o._program.attributes,h=o._program.uniforms;o.activate(),s.clearColor(0,0,0,1),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT),s.uniform2fv(h.iResolution,[this._transmittanceBuffer.width,this._transmittanceBuffer.height]),s.bindBuffer(s.ARRAY_BUFFER,t),s.vertexAttribPointer(a.a_position,t.itemSize,s.FLOAT,!1,0,0),s.drawArrays(s.TRIANGLE_STRIP,0,t.numItems),this._transmittanceBuffer.deactivate()}if(this._scatteringBuffer&&this._transmittanceBuffer){this._scatteringBuffer.activate();let o=n.programs.scattering,a=o._program.attributes,h=o._program.uniforms;o.activate(),s.clearColor(0,0,0,1),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT),s.uniform2fv(h.iResolution,[this._scatteringBuffer.width,this._scatteringBuffer.height]),s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,this._transmittanceBuffer.textures[0]),s.uniform1i(h.transmittanceTexture,0),s.bindBuffer(s.ARRAY_BUFFER,t),s.vertexAttribPointer(a.a_position,t.itemSize,s.FLOAT,!1,0,0),s.drawArrays(s.TRIANGLE_STRIP,0,t.numItems),this._scatteringBuffer.deactivate()}}drawLookupTextures(){this._renderLookupTextures()}_drawBackground(){let t=this.renderer.handler,n=t.programs.atmosphereBackground,s=n._program,o=s.uniforms,a=t.gl,h=this.renderer,c=this.planet.camera;a.disable(a.DEPTH_TEST),h.enableBlendOneSrcAlpha(),n.activate(),a.bindBuffer(a.ARRAY_BUFFER,h.screenFramePositionBuffer),a.vertexAttribPointer(s.attributes.corners,2,a.FLOAT,!1,0,0),a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,this._transmittanceBuffer.textures[0]),a.uniform1i(o.transmittanceTexture,0),a.activeTexture(a.TEXTURE1),a.bindTexture(a.TEXTURE_2D,this._scatteringBuffer.textures[0]),a.uniform1i(o.scatteringTexture,1),a.uniformMatrix4fv(o.viewMatrix,!1,c.getViewMatrix());let u=this.planet.sunPos;a.uniform3fv(o.sunPos,[u.x,u.y,u.z]),a.uniform3fv(o.camPos,[c.eye.x,c.eye.y,c.eye.z]),a.uniform2fv(o.iResolution,[h.sceneFramebuffer.width,h.sceneFramebuffer.height]),a.uniform1f(o.fov,c.getViewAngle()),a.uniform1f(o.opacity,this.opacity);let d=c.frustum;a.uniform1f(o.isOrthographic,c.isOrthographic?1:0),a.uniform4fv(o.frustumParams,[d.right-d.left,d.top-d.bottom,d.right,d.top]),a.drawArrays(a.TRIANGLE_STRIP,0,4),a.enable(a.DEPTH_TEST),h.enableBlendDefault()}}const Ea="degrees",Gh="m";let jh=0;class hn{constructor(t){this.id=jh++,this.code=t.code,this.units=t.units}equal(t){return t.id===this.id}}const cn=new hn({code:"epsg:3857",units:Gh});class qh{constructor(t){this.segment=t,this.layers=[],this.tileOffsetArr=new Float32Array(t.planet.SLICE_SIZE_4),this.layerOpacityArr=new Float32Array(t.planet.SLICE_SIZE)}clear(){this.layers=null,this.tileOffsetArr=null,this.layerOpacityArr=null}append(t,n){let s=this.layers.length;this.layers.push(t),this.layerOpacityArr[s]=t.screenOpacity;let o=4*s,a=t.applyMaterial(n);this.tileOffsetArr[o]=a[0],this.tileOffsetArr[o+1]=a[1],this.tileOffsetArr[o+2]=a[2],this.tileOffsetArr[o+3]=a[3]}}function At(l,t,n){return Math.floor(Math.abs(n-l)/t)}function Si(l,t,n,s){let o=1/(1<<n),a=s.getWidth()*o,h=s.getHeight()*o,c=s.southWest.lon+l*a,u=s.northEast.lat-t*h;return new U(new L(c,u-h),new L(c+a,u))}const Le=20,Pe=300;let ye=new v,xe=new v,ir=new v,Qe=new v,Je=new v,sr=new v,ti=new V,Di=new V;const hi=new Array(4);hi[0]=0,hi[1]=1,hi[2]=1,hi[3]=0;const ci=new Array(4);ci[0]=!1,ci[1]=!0,ci[2]=!1,ci[3]=!0;class Aa{constructor(t,n,s,o){this.isPole=!1,this._tileGroup=0,this._projection=cn,this.node=t,this.quadTreeStrategy=n,this.planet=n.planet,this.handler=n.planet.renderer.handler,this.bsphere=new Ft,this._plainRadius=0,this.bbox=new No,this._sw=new v,this._nw=new v,this._se=new v,this._ne=new v,this.centerNormal=new v,this._extent=this._extentMerc=o,this._extentLonLat=new U,this.gridSize=this.planet.terrain.gridSizeByZoom[s],this.fileGridSize=0,this.tileZoom=s,this.powTileZoom=1<<s,this.tileX=0,this.tileXE=0,this.tileXW=0,this.tileYN=0,this.tileYS=0,this.tileY=0,this.tileIndex="",this.elevationData=null,this._assignTileIndexes(),this.materials=[],this.plainReady=!1,this.initialized=!1,this.normalMapReady=!1,this.terrainReady=!1,this.terrainIsLoading=!1,this.terrainExists=!1,this.passReady=!1,this.plainVertices=null,this.plainVerticesHigh=null,this.plainVerticesLow=null,this.plainNormals=null,this.terrainVertices=null,this.terrainVerticesHigh=null,this.terrainVerticesLow=null,this.noDataVertices=null,this.tempVertices=null,this.tempVerticesHigh=null,this.tempVerticesLow=null,this.normalMapTexture=null,this.normalMapTextureBias=new Float32Array(3),this.normalMapVertices=null,this.normalMapVerticesHigh=null,this.normalMapVerticesLow=null,this.normalMapNormals=null,this.vertexNormalBuffer=null,this.vertexPositionBuffer=null,this.vertexPositionBufferHigh=null,this.vertexPositionBufferLow=null,this.vertexTextureCoordBuffer=null,this._globalTextureCoordinates=new Float32Array(4),this._inTheQueue=!1,this._appliedNeighborsZoom=[0,0,0,0],this._slices=[],this._indexBuffer=null,this.readyToEngage=!1,this.plainProcessing=!1,this.normalMapTexturePtr=null,this._transitionOpacity=1,this._transitionTimestamp=0}checkZoom(){return this.tileZoom<this.planet.terrain._maxNodeZoom}getEntityTerrainPoint(t,n){return this.getTerrainPoint(t._cartesian,this.getInsideLonLat(t),n)}getInsideLonLat(t){return t._lonLatMerc}isEntityInside(t){return this._extentLonLat.isInside(t._lonLat)}getTerrainPoint(t,n,s){let o=this.tempVertices;if(o&&o.length){let a=this.planet.ellipsoid.getSurfaceNormal3v(t);ti.set(t,a.negateTo());let h=this._extent.northEast,c=this._extent.southWest,u=Math.sqrt(o.length/3)-1,d=h.lon,f=h.lat,g=c.lon,_=c.lat,m=(d-g)/u,p=(f-_)/u,x=n.lon-g,y=n.lat-_,T=Math.floor(x/m),S=Math.floor(u-y/p),C=3*((u+1)*S+T),P=3*((u+1)*(S+1)+T);ir.set(o[C],o[C+1],o[C+2]),Qe.set(o[C+3],o[C+4],o[C+5]),Je.set(o[P],o[P+1],o[P+2]);let w=ti.hitTriangleRes(ir,Qe,Je,s);return w===V.INSIDE?t.distance(s):w===V.AWAY&&(Di.set(t,a),Di.hitTriangleRes(ir,Qe,Je,s)===V.INSIDE)?-t.distance(s):(sr.set(o[P+3],o[P+4],o[P+5]),w=ti.hitTriangleRes(Qe,sr,Je,s),w===V.INSIDE?t.distance(s):w===V.AWAY&&(Di.set(t,a),Di.hitTriangleRes(Qe,sr,Je,s)===V.INSIDE)||w===V.AWAY?-t.distance(s):t.distance(s))}return t.distance(this.planet.ellipsoid.hitRay(ti.origin,ti.direction))}projectNative(t){return t.forwardMercator()}loadTerrain(t=!1){this.tileZoom<this.planet.terrain.minZoom||this.planet.terrain.isEmpty?(this.terrainIsLoading=!0,this.elevationsNotExists(),this._inTheQueue||this.planet._normalMapCreator.queue(this)):this.tileZoom>this.planet.terrain.maxZoom?this.elevationsNotExists():this.terrainIsLoading||this.terrainReady||this.planet.terrain.loadTerrain(this,t)}elevationsExists(t){if(this.plainReady&&this.terrainIsLoading){let n=new Float32Array(t.length);n.set(t),this.elevationData=new Float32Array(t.length),this.elevationData.set(t),this.planet._terrainWorker.make({segment:this,elevations:n}),this.plainVerticesHigh=null,this.plainVerticesLow=null,this.normalMapVerticesHigh=null,this.normalMapVerticesLow=null,this.planet.terrain.equalizeVertices||(this.tempVerticesHigh=null,this.tempVerticesLow=null)}}elevationsNotExists(){if(this.planet&&this.tileZoom<=this.planet.terrain.maxNativeZoom){if(this.plainReady&&this.terrainIsLoading){this.terrainIsLoading=!1;let t=this.node;t.appliedTerrainNodeId=this.node.nodeId,t.equalizedSideWithNodeId[0]=t.equalizedSideWithNodeId[1]=t.equalizedSideWithNodeId[2]=t.equalizedSideWithNodeId[3]=t.appliedTerrainNodeId,this.planet.lightEnabled&&!this._inTheQueue&&this.planet._normalMapCreator.queue(this),this.readyToEngage=!0}this.terrainVertices=this.plainVertices,this.terrainVerticesHigh=this.plainVerticesHigh,this.terrainVerticesLow=this.plainVerticesLow,this.tempVertices=this.terrainVertices,this.tempVerticesHigh=this.terrainVerticesHigh,this.tempVerticesLow=this.terrainVerticesLow,this.noDataVertices=null,this.fileGridSize=Math.sqrt(this.terrainVertices.length/3)-1,this.gridSize=this.fileGridSize,this.terrainReady=!0,this.terrainExists=!1}else if(this.plainReady&&this.terrainIsLoading){this.terrainIsLoading=!1;let t=this.node;t.appliedTerrainNodeId=this.node.nodeId,t.equalizedSideWithNodeId[0]=t.equalizedSideWithNodeId[1]=t.equalizedSideWithNodeId[2]=t.equalizedSideWithNodeId[3]=t.appliedTerrainNodeId,this.readyToEngage=!0,this.terrainReady=!0,this.passReady=!0,this.terrainExists=!1}}_checkEqualization(t,n){return n&&n.segment&&this.tileZoom>=n.segment.tileZoom&&this.node.equalizedSideWithNodeId[t]!==n.equalizedSideWithNodeId[ui[t]]}equalize(){if(this.tileZoom<2||this.gridSize<2)return;this.readyToEngage=!0;let t=this.node.neighbors,n=this.tempVertices,s=this.tempVerticesHigh,o=this.tempVerticesLow,a=this.gridSize,h=a+1,c=t[0][0];if(this._checkEqualization(0,c)){this.node.equalizedSideWithNodeId[0]=c.equalizedSideWithNodeId[2],this.readyToEngage=!0;let u=this.node.getOffsetOppositeNeighbourSide(c,0),d=c.segment.tempVertices,f=c.segment.tempVerticesHigh,g=c.segment.tempVerticesLow,_=c.segment.gridSize,m=_+1,p=1/(1<<this.tileZoom-c.segment.tileZoom),x=Math.max(a/(_*p),1),y=Math.max(_*p/a,1);for(let T=0,S=u*_;T<h;T+=x,S+=y){const C=3*T,P=3*(m*_+S);n[C]=d[P],n[C+1]=d[P+1],n[C+2]=d[P+2],s[C]=f[P],s[C+1]=f[P+1],s[C+2]=f[P+2],o[C]=g[P],o[C+1]=g[P+1],o[C+2]=g[P+2]}}if(c=t[1][0],this._checkEqualization(1,c)){this.node.equalizedSideWithNodeId[1]=c.equalizedSideWithNodeId[3],this.readyToEngage=!0;let u=this.node.getOffsetOppositeNeighbourSide(c,1),d=c.segment.tempVertices,f=c.segment.tempVerticesHigh,g=c.segment.tempVerticesLow,_=c.segment.gridSize,m=_+1,p=1/(1<<this.tileZoom-c.segment.tileZoom),x=Math.max(a/(_*p),1),y=Math.max(_*p/a,1);for(let T=0,S=u*_;T<h;T+=x,S+=y){const C=3*(h*T+a),P=m*S*3;n[C]=d[P],n[C+1]=d[P+1],n[C+2]=d[P+2],s[C]=f[P],s[C+1]=f[P+1],s[C+2]=f[P+2],o[C]=g[P],o[C+1]=g[P+1],o[C+2]=g[P+2]}}if(c=t[2][0],this._checkEqualization(2,c)){this.node.equalizedSideWithNodeId[2]=c.equalizedSideWithNodeId[0],this.readyToEngage=!0;let u=this.node.getOffsetOppositeNeighbourSide(c,2),d=c.segment.tempVertices,f=c.segment.tempVerticesHigh,g=c.segment.tempVerticesLow,_=c.segment.gridSize,m=1/(1<<this.tileZoom-c.segment.tileZoom),p=Math.max(a/(_*m),1),x=Math.max(_*m/a,1);for(let y=0,T=u*_;y<h;y+=p,T+=x){const S=3*(h*a+y),C=3*T;n[S]=d[C],n[S+1]=d[C+1],n[S+2]=d[C+2],s[S]=f[C],s[S+1]=f[C+1],s[S+2]=f[C+2],o[S]=g[C],o[S+1]=g[C+1],o[S+2]=g[C+2]}}if(c=t[3][0],this._checkEqualization(3,c)){this.node.equalizedSideWithNodeId[3]=c.equalizedSideWithNodeId[1],this.readyToEngage=!0;let u=this.node.getOffsetOppositeNeighbourSide(c,3),d=c.segment.tempVertices,f=c.segment.tempVerticesHigh,g=c.segment.tempVerticesLow,_=c.segment.gridSize,m=_+1,p=1/(1<<this.tileZoom-c.segment.tileZoom),x=Math.max(a/(_*p),1),y=Math.max(_*p/a,1);for(let T=0,S=u*_;T<h;T+=x,S+=y){const C=h*T*3,P=3*(m*S+_);n[C]=d[P],n[C+1]=d[P+1],n[C+2]=d[P+2],s[C]=f[P],s[C+1]=f[P+1],s[C+2]=f[P+2],o[C]=g[P],o[C+1]=g[P+1],o[C+2]=g[P+2]}}}engage(){this.readyToEngage=!1,this.createCoordsBuffers(this.tempVerticesHigh,this.tempVerticesLow,this.gridSize)}_terrainWorkerCallback(t){if(this.plainReady){this.readyToEngage=!0,this.normalMapNormals=null,this.normalMapVertices=null,this.normalMapVerticesHigh=null,this.normalMapVerticesLow=null,this.terrainVertices=null,this.terrainVerticesHigh=null,this.terrainVerticesLow=null,this.noDataVertices=null,this.tempVertices=null,this.tempVerticesHigh=null,this.tempVerticesLow=null,this.normalMapNormals=t.normalMapNormals,this.normalMapVertices=t.normalMapVertices,this.normalMapVerticesHigh=t.normalMapVerticesHigh,this.normalMapVerticesLow=t.normalMapVerticesLow,this.terrainVertices=t.terrainVertices,this.terrainVerticesHigh=t.terrainVerticesHigh,this.terrainVerticesLow=t.terrainVerticesLow,this.noDataVertices=t.noDataVertices,this.tempVertices=this.terrainVertices,this.tempVerticesHigh=this.terrainVerticesHigh,this.tempVerticesLow=this.terrainVerticesLow,this.setBoundingVolumeArr(t.bounds),this.gridSize=Math.sqrt(this.terrainVertices.length/3)-1;let n=this.node;if(n.appliedTerrainNodeId=n.nodeId,n.equalizedSideWithNodeId[0]=n.equalizedSideWithNodeId[1]=n.equalizedSideWithNodeId[2]=n.equalizedSideWithNodeId[3]=n.appliedTerrainNodeId,this.terrainReady=!0,this.terrainIsLoading=!1,this.terrainExists=!0,!this.normalMapTexturePtr){const s=this.planet._normalMapCreator;this.normalMapTexturePtr=this.planet.renderer.handler.createEmptyTexture_l(s.width,s.height)}this.planet.lightEnabled&&this.planet._normalMapCreator.queue(this)}}_normalMapEdgeEqualize(t){let n=this.node.neighbors,s=n[t],o=s&&s[0],a=this.planet.terrain.maxZoom;this.tileZoom===a&&s&&!(n[0].length||n[1].length||n[2].length||n[3].length)&&(o=this.node.getEqualNeighbor(t));let h=o&&o.segment,c=this;if(o&&h&&h.terrainReady&&h.terrainExists&&h.tileZoom<=a&&c._appliedNeighborsZoom[t]!==h.tileZoom){c._appliedNeighborsZoom[t]=h.tileZoom;let u=c.normalMapNormals,d=h.normalMapNormals;if(!u||!d)return;let f=c.normalMapNormals,g=h.normalMapNormals,_=Math.sqrt(u.length/3),m=_-1;const p=m*hi[t];let x,y,T,S;if(c.tileZoom===h.tileZoom){const C=m-p;if(ci[t])for(let P=0;P<_;P++){let w=3*(P*_+p),I=3*(P*_+C);x=f[w]+g[I],y=f[w+1]+g[I+1],T=f[w+2]+g[I+2],S=1/Math.sqrt(x*x+y*y+T*T),d[I]=u[w]=x*S,d[I+1]=u[w+1]=y*S,d[I+2]=u[w+2]=T*S}else for(let P=0;P<_;P++){let w=3*(p*_+P),I=3*(C*_+P);x=f[w]+g[I],y=f[w+1]+g[I+1],T=f[w+2]+g[I+2],S=1/Math.sqrt(x*x+y*y+T*T),d[I]=u[w]=x*S,d[I+1]=u[w+1]=y*S,d[I+2]=u[w+2]=T*S}h._inTheQueue||h._appliedNeighborsZoom[ui[t]]===c.tileZoom||(h._appliedNeighborsZoom[ui[t]]=c.tileZoom,c.planet._normalMapCreator.queue(h))}}}applyTerrain(t){t?this.elevationsExists(t):this.elevationsNotExists()}deleteBuffers(){const t=this.handler.gl;t.deleteBuffer(this.vertexNormalBuffer),t.deleteBuffer(this.vertexPositionBuffer),t.deleteBuffer(this.vertexPositionBufferHigh),t.deleteBuffer(this.vertexPositionBufferLow),this.vertexNormalBuffer=null,this.vertexPositionBuffer=null,this.vertexPositionBufferHigh=null,this.vertexPositionBufferLow=null,this.vertexTextureCoordBuffer=null}deleteMaterials(){let t=this.materials;for(let n=0;n<t.length;n++){let s=t[n];s&&s.clear()}this.materials.length=0}deleteElevations(){this.terrainExists=!1,this.terrainReady=!1,this.terrainIsLoading=!1,this.normalMapVertices=null,this.normalMapVerticesHigh=null,this.normalMapVerticesLow=null,this.normalMapNormals=null,this.tempVertices=null,this.tempVerticesHigh=null,this.tempVerticesLow=null,this.terrainVertices=null,this.terrainVerticesHigh=null,this.terrainVerticesLow=null,this.noDataVertices=null,this.plainVertices=null,this.plainVerticesHigh=null,this.plainVerticesLow=null,this.plainNormals=null,this.normalMapReady&&(this.handler.gl.deleteTexture(this.normalMapTexture),this.normalMapReady=!1),this._appliedNeighborsZoom=[0,0,0,0],this.normalMapTextureBias[0]=0,this.normalMapTextureBias[1]=0,this.normalMapTextureBias[2]=1,this._inTheQueue=!1}clearSegment(){this.plainReady=!1,this.initialized=!1,this.deleteBuffers(),this.deleteMaterials(),this.deleteElevations()}childrenInitialized(){let t=this.node.nodes;return t.length===4&&t[0].segment.initialized&&t[1].segment.initialized&&t[2].segment.initialized&&t[3].segment.initialized}destroySegment(){this.clearSegment();let t=this._slices.length;for(;t--;)this._slices[t].clear();this._slices=null,this.node=null,this.planet=null,this.handler=null,this.bbox=null,this.bsphere=null,this._extent=null,this.materials=null,this.plainVertices=null,this.plainVerticesHigh=null,this.plainVerticesLow=null,this.plainNormals=null,this.terrainVertices=null,this.terrainVerticesHigh=null,this.terrainVerticesLow=null,this.noDataVertices=null,this.tempVertices=null,this.tempVerticesHigh=null,this.tempVerticesLow=null,this.normalMapTextureBias=null,this.normalMapTexture=null,this.normalMapVertices=null,this.normalMapVerticesHigh=null,this.normalMapVerticesLow=null,this.normalMapNormals=null,this.vertexNormalBuffer=null,this.vertexPositionBuffer=null,this.vertexPositionBufferHigh=null,this.vertexPositionBufferLow=null,this.vertexTextureCoordBuffer=null,this._projection=null,this._appliedNeighborsZoom=null,this._globalTextureCoordinates=null}_setExtentLonLat(){this._extentLonLat=this._extent.inverseMercator()}_createExtentNormals(){const t=this.planet.ellipsoid,n=this._extentLonLat,s=t.geodeticToCartesian(n.southWest.lon,n.southWest.lat),o=t.geodeticToCartesian(n.northEast.lon,n.northEast.lat),a=t.geodeticToCartesian(n.southWest.lon,n.northEast.lat),h=t.geodeticToCartesian(n.northEast.lon,n.southWest.lat);this._sw.copy(s),this._nw.copy(a),this._ne.copy(o),this._se.copy(h)}createBoundsByExtent(){this._createExtentNormals(),this.setBoundingVolume3v(this._sw,this._ne)}createBoundsByParent(){let t=this.node;for(;t.parentNode&&!t.segment.terrainReady;)t=t.parentNode;let n=1<<this.tileZoom-t.segment.tileZoom,s=this.tileX-t.segment.tileX*n,o=this.tileY-t.segment.tileY*n;if(t.segment.terrainReady&&t.segment.tileZoom>=this.planet.terrain.minZoom){let a=t.segment.gridSize/n;if(a>=1){this.bsphere.center.x=t.segment.bsphere.center.x,this.bsphere.center.y=t.segment.bsphere.center.y,this.bsphere.center.z=t.segment.bsphere.center.z,this.bsphere.radius=t.segment.bsphere.radius;let h=a*o,c=a*s,u=t.segment.gridSize+1,d=3*((h+a)*u+c),f=3*(h*u+c),g=3*(h*u+c+a),_=3*((h+a)*u+c+a),m=t.segment.tempVertices,p=new v(m[d],m[d+1],m[d+2]),x=new v(m[g],m[g+1],m[g+2]),y=new v(m[f],m[f+1],m[f+2]),T=new v(m[_],m[_+1],m[_+2]);this._sw.copy(p),this._nw.copy(y),this._ne.copy(x),this._se.copy(T)}else{let h,c=t.segment,u=Math.floor(a*o),d=Math.floor(a*s),f=1/a,g=o-f*u,_=s-f*d;h=c.gridSize===1?c.tempVertices:Kr(c.tempVertices,c.gridSize,u,d,1);let m,p,x=new v(h[0],h[1],h[2]),y=new v(h[9],h[10],h[11]),T=new v(h[3]-h[0],h[4]-h[1],h[5]-h[2]),S=new v(h[6]-h[0],h[7]-h[1],h[8]-h[2]),C=new v(h[3]-h[9],h[4]-h[10],h[5]-h[11]),P=new v(h[6]-h[9],h[7]-h[10],h[8]-h[11]),w=g,I=_;m=w+I<f?v.add(T.scaleTo(I/f),S.scaleTo(w/f)).addA(x):v.add(P.scaleTo(1-I/f),C.scaleTo(1-w/f)).addA(y),w=g+1,I=_+1,p=w+I<f?v.add(T.scaleTo(I/f),S.scaleTo(w/f)).addA(x):v.add(P.scaleTo(1-I/f),C.scaleTo(1-w/f)).addA(y),this._createExtentNormals(),this.setBoundingVolume3v(m,p)}}else this.createBoundsByExtent()}setBoundingSphere(t,n,s,o){this.bsphere.center.x=t,this.bsphere.center.y=n,this.bsphere.center.z=s,this.bsphere.radius=this.bsphere.center.distance(o)}setBoundingVolume(t,n,s,o,a,h){this.bbox.setFromBoundsArr([t,n,s,o,a,h]);let c=t+.5*(o-t),u=n+.5*(a-n),d=s+.5*(h-s);this.bsphere.center.set(c,u,d),this.bsphere.radius=this.bsphere.center.distance(new v(t,n,s))}setBoundingVolume3v(t,n){this.bbox.setFromBoundsArr([t.x,t.y,t.z,n.x,n.y,n.z]);let s=t.x+.5*(n.x-t.x),o=t.y+.5*(n.y-t.y),a=t.z+.5*(n.z-t.z);this.bsphere.center.set(s,o,a),this.bsphere.radius=this.bsphere.center.distance(new v(t.x,t.y,t.z))}setBoundingVolumeArr(t){this.bbox.setFromBoundsArr(t);let n=t[0]+.5*(t[3]-t[0]),s=t[1]+.5*(t[4]-t[1]),o=t[2]+.5*(t[5]-t[2]);this.bsphere.center.set(n,s,o),this.bsphere.radius=this.bsphere.center.distance(new v(t[0],t[1],t[2]))}createCoordsBuffers(t,n,s){const o=(s+1)*(s+1),a=this.handler;this.vertexPositionBufferHigh&&this.vertexPositionBufferHigh.numItems===o?(a.setStreamArrayBuffer(this.vertexPositionBufferHigh,t),a.setStreamArrayBuffer(this.vertexPositionBufferLow,n)):(a.gl.deleteBuffer(this.vertexPositionBufferHigh),a.gl.deleteBuffer(this.vertexPositionBufferLow),this.vertexTextureCoordBuffer=this.planet._textureCoordsBufferCache[Math.log2(s)],this.vertexPositionBufferHigh=a.createArrayBuffer(t,3,o),this.vertexPositionBufferLow=a.createArrayBuffer(n,3,o))}_addViewExtent(){const t=this._extentLonLat;let n=this.quadTreeStrategy._viewExtent;t.southWest.lon<n.southWest.lon&&(n.southWest.lon=t.southWest.lon),t.northEast.lon>n.northEast.lon&&(n.northEast.lon=t.northEast.lon),t.southWest.lat<n.southWest.lat&&(n.southWest.lat=t.southWest.lat),t.northEast.lat>n.northEast.lat&&(n.northEast.lat=t.northEast.lat)}_assignTileIndexes(){this._tileGroup=0;const t=this.tileZoom,n=this._extent,s=Lt;this.tileX=At(n.getCenter().lon,n.getWidth(),-2003750834e-2),this.tileY=At(n.getCenter().lat,n.getHeight(),s);const o=this.powTileZoom;this.tileXE=(this.tileX+1)%o,this.tileXW=(o+this.tileX-1)%o,this.tileYN=this.tileY-1,this.tileYS=this.tileY+1,this.tileIndex=zt.getTileIndex(this.tileX,this.tileY,t,this._tileGroup)}initialize(){const t=this.planet,n=this.node;if(this.gridSize=t.terrain.gridSizeByZoom[this.tileZoom]||t.terrain.plainGridSize,n.sideSizeLog2[0]=n.sideSizeLog2[1]=n.sideSizeLog2[2]=n.sideSizeLog2[3]=Math.log2(this.gridSize),this.tileZoom<=t.terrain.maxZoom){const s=this.planet._normalMapCreator;this.normalMapTexturePtr=t.renderer.handler.createEmptyTexture_l(s.width,s.height)}this.normalMapTexture=this.planet.transparentTexture,this._assignGlobalTextureCoordinates(),this.initialized=!0}_assignGlobalTextureCoordinates(){const t=this._extent;this._globalTextureCoordinates[0]=(t.southWest.lon+Lt)*ri,this._globalTextureCoordinates[1]=(Lt-t.northEast.lat)*ri,this._globalTextureCoordinates[2]=(t.northEast.lon+Lt)*ri,this._globalTextureCoordinates[3]=(Lt-t.southWest.lat)*ri}createPlainSegmentAsync(){let t=this.planet,n=t.terrain;n.isReady()&&!this.plainReady&&this.tileZoom<=n.maxZoom&&(this.plainProcessing=!0,t._plainSegmentWorker.make(this))}_plainSegmentWorkerCallback(t){this.plainProcessing=!1,this.initialized&&!this.terrainReady&&(this.plainReady=!0,this.plainVertices=t.plainVertices,this.plainVerticesHigh=t.plainVerticesHigh,this.plainVerticesLow=t.plainVerticesLow,this.plainNormals=t.plainNormals,this._plainRadius=t.plainRadius,this.normalMapNormals=t.normalMapNormals,this.normalMapVertices=t.normalMapVertices,this.normalMapVerticesHigh=t.normalMapVerticesHigh,this.normalMapVerticesLow=t.normalMapVerticesLow,this.fileGridSize=Math.sqrt(t.normalMapVertices.length/3)-1)}createPlainSegment(){this.initialize(),this._createPlainVertices(),this.readyToEngage=!0}_projToDeg(t,n){return L.inverseMercator(t,n)}_createPlainVertices(){const t=this.planet.terrain.gridSizeByZoom[this.tileZoom],n=this.planet.terrain.plainGridSize,s=Math.max(n,t),o=this._extent,a=o.getWidth()/s,h=o.getHeight()/s,c=o.southWest.lon,u=o.northEast.lat,d=Math.max(n/t,1),f=s+1,g=this.planet.ellipsoid._invRadii2,_=f*f,m=(t+1)*(t+1)*3;let p=0,x=0;this.plainNormals=new Float32Array(m),this.plainVertices=new Float64Array(m),this.plainVerticesHigh=new Float32Array(m),this.plainVerticesLow=new Float32Array(m),this.normalMapNormals=new Float32Array(3*_),this.normalMapVertices=new Float64Array(3*_),this.normalMapVerticesHigh=new Float32Array(3*_),this.normalMapVerticesLow=new Float32Array(3*_);let y=this.plainVertices,T=this.plainVerticesHigh,S=this.plainVerticesLow,C=this.plainNormals,P=this.normalMapVertices,w=this.normalMapVerticesHigh,I=this.normalMapVerticesLow,O=this.normalMapNormals;for(let N=0;N<_;N++){let k=N%f,D=~~(N/f),ze=this.planet.ellipsoid.lonLatToCartesian(this._projToDeg(c+k*a,u-D*h)),z=ze.x*g.x,Ee=ze.y*g.y,B=ze.z*g.z,rt=1/Math.sqrt(z*z+Ee*Ee+B*B),wt=z*rt,re=Ee*rt,mt=B*rt;v.doubleToTwoFloats(ze,ye,xe),P[x]=ze.x,w[x]=ye.x,I[x]=xe.x,O[x++]=wt,P[x]=ze.y,w[x]=ye.y,I[x]=xe.y,O[x++]=re,P[x]=ze.z,w[x]=ye.z,I[x]=xe.z,O[x++]=mt,D%d==0&&k%d==0&&(y[p]=ze.x,T[p]=ye.x,S[p]=xe.x,C[p++]=wt,y[p]=ze.y,T[p]=ye.y,S[p]=xe.y,C[p++]=re,y[p]=ze.z,T[p]=ye.z,S[p]=xe.z,C[p++]=mt)}this.terrainVertices=y,this.terrainVerticesHigh=T,this.terrainVerticesLow=S,this.plainReady=!0}getMaterialByLayer(t){return this.materials[t.__id]}_getLayerExtentOffset(t){const n=t._extentMerc,s=this._extent,o=n.northEast.lon-n.southWest.lon,a=n.northEast.lat-n.southWest.lat;return[(s.southWest.lon-n.southWest.lon)/o,(n.northEast.lat-s.northEast.lat)/a,(s.northEast.lon-s.southWest.lon)/o,(s.northEast.lat-s.southWest.lat)/a]}initSlice(t){let n=this._slices[t];return n?n.layers=[]:n=this._slices[t]=new qh(this),n}screenRendering(t,n,s,o,a=!1,h){const c=this.handler.gl,u=t.attributes,d=t.uniforms,f=this.materials,g=this.planet,_=this.quadTreeStrategy;let m,p;n&&n.length?(p=n[0],m=p._height):m=0,c.activeTexture(c.TEXTURE0+g.SLICE_SIZE+2),c.bindTexture(c.TEXTURE_2D,o||this.getDefaultTexture()),c.uniform1i(d.defaultTexture,g.SLICE_SIZE+2);let x=0,y=0,T=!1,S=this.initSlice(s);for(this._indexBuffer=this._getIndexBuffer();p;){if(this.layerOverlap(p)&&(p._fading&&p._fadingOpacity>0||(p.minZoom>=_.minCurrZoom||p.maxZoom>=_.minCurrZoom)&&(p.minZoom<=_.maxCurrZoom||p.maxZoom<=_.maxCurrZoom))){T=!0;let C=f[p.__id];C||(C=f[p.__id]=p.createMaterial(this)),C.isReady||(_._renderCompleted=!1),S.append(p,C),g._samplerArr[x]=x,c.activeTexture(c.TEXTURE0+x),c.bindTexture(c.TEXTURE_2D,C.texture||g.transparentTexture),x++}y++,p=n[y]}!T&&a||(c.uniform1f(d.transitionOpacity,h||this._transitionOpacity>1?1:this._transitionOpacity),c.uniform1i(d.samplerCount,x),c.uniform1f(d.height,m),c.uniform1iv(d.samplerArr,g._samplerArr),c.uniform4fv(d.tileOffsetArr,S.tileOffsetArr),c.uniform1fv(d.layerOpacityArr,S.layerOpacityArr),g.lightEnabled&&(c.activeTexture(c.TEXTURE0+g.SLICE_SIZE+3),c.bindTexture(c.TEXTURE_2D,this.normalMapTexture||g.transparentTexture),c.uniform1i(d.uNormalMap,g.SLICE_SIZE+3),c.uniform3fv(d.uNormalMapBias,this.normalMapTextureBias),c.uniform4fv(d.uGlobalTextureCoord,this._globalTextureCoordinates)),c.bindBuffer(c.ARRAY_BUFFER,this.vertexPositionBufferHigh),c.vertexAttribPointer(u.aVertexPositionHigh,this.vertexPositionBufferHigh.itemSize,c.FLOAT,!1,0,0),c.bindBuffer(c.ARRAY_BUFFER,this.vertexPositionBufferLow),c.vertexAttribPointer(u.aVertexPositionLow,this.vertexPositionBufferLow.itemSize,c.FLOAT,!1,0,0),c.bindBuffer(c.ARRAY_BUFFER,this.vertexTextureCoordBuffer),c.vertexAttribPointer(u.aTextureCoord,2,c.UNSIGNED_SHORT,!0,0,0),c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,this._indexBuffer),c.drawElements(g.drawMode,this._indexBuffer.numItems,c.UNSIGNED_INT,0))}increaseTransitionOpacity(){this._transitionOpacity+=(window.performance.now()-this._transitionTimestamp)/this.planet.transitionTime,this._transitionTimestamp=window.performance.now(),this._transitionOpacity>2&&(this._transitionOpacity=2);let t=this.node._fadingNodes.length;for(;t--;){let n=this.node._fadingNodes[t];if(!n.segment){this._transitionOpacity=1;break}n.segment._transitionOpacity>0&&!this.quadTreeStrategy._fadingNodes.has(n.__id)&&(this.quadTreeStrategy._fadingNodes.set(n.__id,n),n.segment._transitionOpacity=2-this._transitionOpacity,n.segment._transitionOpacity===0&&this.node._fadingNodes.splice(t,1))}}fadingTransitionOpacity(){this._transitionOpacity-=.01,this._transitionTimestamp=window.performance.now(),this._transitionOpacity<0&&(this._transitionOpacity=0)}colorPickingRendering(t,n,s,o,a=!1){const h=this.handler.gl,c=t.attributes,u=t.uniforms;let d,f=this.materials,g=this.planet;d=n&&n.length?n[0]._height:0;let _=!1,m=this._slices[s],p=m.layers.length;for(let x=0;x<p;x++){_=!0;let y=m.layers[x],T=4*x;g._pickingColorArr[T]=y._pickingColor.x/255,g._pickingColorArr[T+1]=y._pickingColor.y/255,g._pickingColorArr[T+2]=y._pickingColor.z/255,g._pickingColorArr[T+3]=Number(y._pickingEnabled),g._samplerArr[x]=x,h.activeTexture(h.TEXTURE0+x),h.bindTexture(h.TEXTURE_2D,f[y.__id].texture||this.planet.transparentTexture),g._pickingMaskArr[x]=x+g.SLICE_SIZE,h.activeTexture(h.TEXTURE0+x+g.SLICE_SIZE),h.bindTexture(h.TEXTURE_2D,f[y.__id].pickingMask||this.planet.transparentTexture)}!_&&a||(h.uniform1i(u.samplerCount,p),h.uniform1f(u.height,d),h.uniform1iv(u.samplerArr,g._samplerArr),h.uniform1iv(u.pickingMaskArr,g._pickingMaskArr),h.uniform4fv(u.pickingColorArr,g._pickingColorArr),h.uniform4fv(u.tileOffsetArr,m.tileOffsetArr),h.uniform1fv(u.layerOpacityArr,m.layerOpacityArr),h.bindBuffer(h.ARRAY_BUFFER,this.vertexPositionBufferHigh),h.vertexAttribPointer(c.aVertexPositionHigh,this.vertexPositionBufferHigh.itemSize,h.FLOAT,!1,0,0),h.bindBuffer(h.ARRAY_BUFFER,this.vertexPositionBufferLow),h.vertexAttribPointer(c.aVertexPositionLow,this.vertexPositionBufferLow.itemSize,h.FLOAT,!1,0,0),h.bindBuffer(h.ARRAY_BUFFER,this.vertexTextureCoordBuffer),h.vertexAttribPointer(c.aTextureCoord,2,h.UNSIGNED_SHORT,!0,0,0),h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,this._indexBuffer),h.drawElements(h.TRIANGLE_STRIP,this._indexBuffer.numItems,h.UNSIGNED_INT,0))}depthRendering(t,n){const s=this.handler.gl,o=t.attributes,a=t.uniforms;var h;h=n&&n.length?n[0]._height:0,s.uniform1f(a.height,h),s.bindBuffer(s.ARRAY_BUFFER,this.vertexPositionBufferHigh),s.vertexAttribPointer(o.aVertexPositionHigh,this.vertexPositionBufferHigh.itemSize,s.FLOAT,!1,0,0),s.bindBuffer(s.ARRAY_BUFFER,this.vertexPositionBufferLow),s.vertexAttribPointer(o.aVertexPositionLow,this.vertexPositionBufferLow.itemSize,s.FLOAT,!1,0,0),s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,this._indexBuffer),s.drawElements(s.TRIANGLE_STRIP,this._indexBuffer.numItems,s.UNSIGNED_INT,0)}_getIndexBuffer(){const t=this.node.sideSizeLog2;let n=this.planet._indexesCache[Math.log2(this.gridSize)][t[0]][t[1]][t[2]][t[3]];if(!n.buffer){let s=$i().createSegmentIndexes(Math.log2(this.gridSize),[t[0],t[1],t[2],t[3]]);n.buffer=this.planet.renderer.handler.createElementArrayBuffer(s,1),this.planet._indexesCacheToRemoveCounter++}return n.buffer}layerOverlap(t){return this._extent.overlaps(t._extentMerc)}getDefaultTexture(){return this.planet.solidTextureOne}getExtentLonLat(){return this._extentLonLat}getExtentMerc(){return this._extentMerc}getExtent(){return this._extent}getNeighborSide(t){if(this.tileY===t.tileY){if(this.tileX===t.tileXE)return 3;if(this.tileX===t.tileXW)return 1}else if(this.tileX===t.tileX){if(this.tileY===t.tileYS)return 0;if(this.tileY===t.tileYN)return 2}return-1}}let Fi=new v,Oi=new v;const be=[new H(0,0),new H(1,0),new H(0,1),new H(1,1)],Yh=Math.sqrt(be.length)-1;let at={xmin:0,ymin:0,zmin:0,xmax:0,ymax:0,zmax:0},Wh=0;class qt{constructor(t,n,s,o,a,h){n.planet._createdNodesCount++,this.__id=Wh++,this.SegmentPrototype=t,this.quadTreeStrategy=n,this.parentNode=o,this.partId=s,this.nodeId=s+(o?4*o.nodeId+1:0),this.state=null,this.prevState=null,this.appliedTerrainNodeId=-1,this.sideSizeLog2=[0,0,0,0],this.ready=!1,this.neighbors=[[],[],[],[]],this.equalizedSideWithNodeId=[this.nodeId,this.nodeId,this.nodeId,this.nodeId],this.nodes=[],this.segment=new t(this,n,a,h),this._cameraInside=!1,this.inFrustum=0,this._fadingNodes=[],this.createBounds()}createChildNodes(){this.ready=!0;const t=this.quadTreeStrategy,n=this.segment,s=n._extent,o=n.tileZoom+1,a=.5*s.getWidth(),h=.5*s.getHeight(),c=s.northEast,u=s.southWest,d=new L(u.lon+a,u.lat+h),f=this.nodes;f[0]=new qt(this.SegmentPrototype,t,0,this,o,new U(new L(u.lon,u.lat+h),new L(u.lon+a,c.lat))),f[1]=new qt(this.SegmentPrototype,t,1,this,o,new U(d,new L(c.lon,c.lat))),f[2]=new qt(this.SegmentPrototype,t,2,this,o,new U(new L(u.lon,u.lat),d)),f[3]=new qt(this.SegmentPrototype,t,3,this,o,new U(new L(u.lon+a,u.lat),new L(c.lon,u.lat+h)))}createBounds(){let t=this.segment;t._setExtentLonLat(),t.tileZoom===0?t.setBoundingSphere(0,0,0,new v(0,0,t.planet.ellipsoid.equatorialSize)):t.tileZoom<t.planet.terrain.minZoom?t.createBoundsByExtent():t.createBoundsByParent();let n=t.bsphere.center.x,s=t.bsphere.center.y,o=t.bsphere.center.z,a=1/Math.sqrt(n*n+s*s+o*o);t.centerNormal.x=n*a,t.centerNormal.y=s*a,t.centerNormal.z=o*a}getState(){if(this.state===-1)return this.state;let t=this.parentNode;for(;t;){if(t.state!==2)return 0;t=t.parentNode}return this.state}getEqualNeighbor(t){let n=this,s=wn[t][n.partId];if(s!==-1)return n.parentNode.nodes[s];{let o=[];for(;n.parentNode;)if(o.push(n.partId),s=wn[t][n.partId],n=n.parentNode,s!==-1){let a=o.length;for(t=ui[t];n&&a--;)s=Ya[t][o[a]],n=n.nodes[s];return n}}}traverseNodes(t,n,s,o,a){this.ready||this.createChildNodes();let h=this.nodes;h[0].renderTree(t,n,s,o,a),h[1].renderTree(t,n,s,o,a),h[2].renderTree(t,n,s,o,a),h[3].renderTree(t,n,s,o,a)}renderTree(t,n,s,o,a){if(this.quadTreeStrategy._renderedNodes.length>=1e3)return;(!n||a&&this.segment.tileZoom>a.segment.tileZoom)&&(this.prevState=this.state),this.state=2,this.clearNeighbors();let h=this.segment,c=this.quadTreeStrategy.planet;if(this._cameraInside=!1,!this.parentNode||this.parentNode._cameraInside){let f;f=h._projection.id===cn.id?h._extent.isInside(t._lonLatMerc):h._extent.isInside(t._lonLat),f&&(t._insideSegment=h,this._cameraInside=!0)}this.inFrustum=0;let u=t.frustums,d=u.length;if(h.tileZoom<6)for(let f=0;f<d;f++)u[f].containsSphere(h.bsphere)&&(this.inFrustum|=1<<f);else for(let f=0;f<d;f++)h.terrainReady?u[f].containsBox(h.bbox)&&(this.inFrustum|=1<<f):u[f].containsSphere(h.bsphere)&&(this.inFrustum|=1<<f);if(this.inFrustum||this._cameraInside||h.tileZoom<3){let f=Math.abs(t._lonLat.height),g=t.eye.length2()-c.ellipsoid.polarSizeSqr,_=10687647287563281e-5*c._heightFactor;g=g<_?_:g;let m=h.tileZoom<2||h.tileZoom>19||h.tileZoom<6&&!h.terrainReady;if(t.isOrthographic){let p=t.getForward();m=m||p.dot(h._sw.getNormal())<-0||p.dot(h._nw.getNormal())<-0||p.dot(h._ne.getNormal())<-0||p.dot(h._se.getNormal())<-0}else m=m||t.eye.distance2(h._sw)<g||t.eye.distance2(h._nw)<g||t.eye.distance2(h._ne)<g||t.eye.distance2(h._se)<g;(this.inFrustum&&(m||f>1e4)||this._cameraInside)&&this.quadTreeStrategy.collectVisibleNode(this),h.tileZoom<2?this.traverseNodes(t,n,s,o,a):h.terrainReady&&(!n&&t.projectedSize(h.bsphere.center,h._plainRadius)<this.quadTreeStrategy.lodSize||n&&(h.tileZoom===n||!m))?m?(h.passReady=!0,this.renderNode(this.inFrustum,!this.inFrustum,s,o)):this.state=0:h.terrainReady&&h.checkZoom()&&(!n||t.projectedSize(h.bsphere.center,h.bsphere.radius)>this.quadTreeStrategy._maxLodSize)?this.traverseNodes(t,n,h,o,a):m?(h.passReady=!!n&&h.terrainReady,this.renderNode(this.inFrustum,!this.inFrustum,s,o)):this.state=0}else this.state=0}renderNode(t,n,s,o){let a=this.segment;a.terrainReady||(a.initialized||a.initialize(),this.whileTerrainLoading(s),a.plainProcessing||a.createPlainSegmentAsync(),a.plainReady&&!o&&a.loadTerrain()),a.planet.lightEnabled&&!a.normalMapReady&&this.whileNormalMapCreating(),n?this.state=-1:(!this._cameraInside&&a.tileZoom>this.quadTreeStrategy.maxCurrZoom&&(this.quadTreeStrategy.maxCurrZoom=a.tileZoom),a.tileZoom<this.quadTreeStrategy.minCurrZoom&&(this.quadTreeStrategy.minCurrZoom=a.tileZoom),a._addViewExtent(),this.addToRender(t))}childrenPrevStateEquals(t){let n=this.nodes;return n.length===4&&n[0].prevState===t&&n[1].prevState===t&&n[2].prevState===t&&n[3].prevState===t}isFading(){let t=this.nodes;return this.state===2&&this.segment._transitionOpacity>0&&t.length===4&&t[0].state===1&&t[1].state===1&&t[2].state===1&&t[3].state===1}_collectFadingNodes(){if(this.segment.tileZoom<3)this.segment._transitionOpacity=1;else if(this.prevState!==1){this.segment._transitionOpacity=0,this._fadingNodes=[];let t=window.performance.now();if(this.segment._transitionTimestamp=t,this.parentNode){if(this.parentNode.prevState===1){let n=this.parentNode.parentNode;for(;n;){if(n.isFading()){for(let s=0;s<n.nodes.length;s++)n.nodes[s].segment._transitionOpacity=1,n.nodes[s]._fadingNodes=[];n.segment._transitionOpacity=0;break}n=n.parentNode}this.parentNode.whileTerrainLoading(),this._fadingNodes.push(this.parentNode),this.parentNode.segment._transitionOpacity=2,this.parentNode.segment._transitionTimestamp=t}else if(this.segment.childrenInitialized()&&this.childrenPrevStateEquals(1))for(let n=0;n<this.nodes.length;n++){let s=this.nodes[n];s.whileTerrainLoading(),this._fadingNodes.push(s),s.segment._transitionOpacity=2,s.segment._transitionTimestamp=t,s.prevState=s.state,s.state=0}}}}clearNeighbors(){this.neighbors&&(this.neighbors[0]=this.neighbors[1]=this.neighbors[2]=this.neighbors[3]=null,this.neighbors[0]=[],this.neighbors[1]=[],this.neighbors[2]=[],this.neighbors[3]=[])}_refreshTransitionOpacity(){if(this._fadingNodes.length===0)this.segment._transitionOpacity=1;else if(this._fadingNodes.length!==4||this.childrenPrevStateEquals(1)){for(let t=0;t<this._fadingNodes.length;t++)this.segment._transitionOpacity<1&&this._fadingNodes[t].segment._transitionOpacity===0&&(this._fadingNodes[t].segment._transitionOpacity=0,this.segment._transitionOpacity=1);this.segment.increaseTransitionOpacity()}else this.segment._transitionOpacity=1,this._fadingNodes=[]}addToRender(t){this.state=1;let n=this.quadTreeStrategy._renderedNodes;this.quadTreeStrategy._transitionOpacityEnabled?Zr(n,this,(a,h)=>a.segment.tileZoom-h.segment.tileZoom):(this.getRenderedNodesNeighbors(n),n.push(this)),this.segment.terrainReady||(this.quadTreeStrategy._renderCompleted=!1,this.quadTreeStrategy._terrainCompleted=!1);let s=0,o=this.quadTreeStrategy._renderedNodesInFrustum;for(;t;)1&t&&o[s].push(this),s++,t>>=1}applyNeighbor(t,n){const s=ui[n];if(this.neighbors[n].length===0||t.neighbors[s].length===0){const o=this.segment,a=t.segment,h=o.gridSize/(a.gridSize*Math.pow(2,a.tileZoom-o.tileZoom));let c=o.gridSize,u=a.gridSize;h>1?(c=Math.ceil(o.gridSize/h),u=a.gridSize):h<1&&(c=o.gridSize,u=Math.ceil(a.gridSize*h)),this.sideSizeLog2[n]=Math.log2(c),t.sideSizeLog2[s]=Math.log2(u)}this.neighbors[n].push(t),t.neighbors[s].push(this)}getRenderedNodesNeighbors(t){for(let n=t.length-1;n>=0;--n){let s=t[n],o=this.getCommonSide(s);o!==-1&&this.applyNeighbor(s,o)}}getCommonSide(t){const n=this.segment,s=t.segment;if(n.tileZoom===s.tileZoom&&n._tileGroup===s._tileGroup)return n.getNeighborSide(s);{const o=n._extentLonLat,a=s._extentLonLat;let h=o.northEast,c=o.southWest,u=a.northEast,d=a.southWest,f=h.lon,g=h.lat,_=c.lon,m=c.lat,p=u.lon,x=u.lat,y=d.lon,T=d.lat;if(n._tileGroup===s._tileGroup){if(f===y&&(g<=x&&m>=T||g>=x&&m<=T))return 1;if(_===p&&(g<=x&&m>=T||g>=x&&m<=T))return 3;if(g===T&&(_>=y&&f<=p||_<=y&&f>=p))return 0;if(m===x&&(_>=y&&f<=p||_<=y&&f>=p))return 2;if(s.tileX===0&&y===-f&&(g<=x&&m>=T||g>=x&&m<=T))return 1;if(n.tileX===0&&_===-p&&(g<=x&&m>=T||g>=x&&m<=T))return 3}if(n._tileGroup===0&&s._tileGroup===20&&n.tileY===0&&s.tileY===s.powTileZoom-1&&(_>=y&&f<=p||_<=y&&f>=p))return 0;if(n._tileGroup===0&&s._tileGroup===Pe&&n.tileY===n.powTileZoom-1&&s.tileY===0&&(_>=y&&f<=p||_<=y&&f>=p))return 2;if(n._tileGroup===Pe&&s._tileGroup===0&&n.tileY===0&&s.tileY===s.powTileZoom-1&&(_>=y&&f<=p||_<=y&&f>=p))return 0;if(n._tileGroup===20&&s._tileGroup===0&&n.tileY===n.powTileZoom-1&&s.tileY===0&&(_>=y&&f<=p||_<=y&&f>=p))return 2}return-1}whileNormalMapCreating(){const t=this.segment;t.terrainIsLoading||!t.terrainExists||t._inTheQueue||t.planet._normalMapCreator.queue(t);let n=this;for(;n.parentNode&&!n.segment.normalMapReady;)n=n.parentNode;const s=2<<t.tileZoom-n.segment.tileZoom-1;t.normalMapTexture=n.segment.normalMapTexture,t.normalMapTextureBias[0]=t.tileX-n.segment.tileX*s,t.normalMapTextureBias[1]=t.tileY-n.segment.tileY*s,t.normalMapTextureBias[2]=1/s}whileTerrainLoading(t){const n=this.segment;let s=this;if(t&&t.terrainReady)s=t.node;else for(;s.parentNode&&!s.segment.terrainReady;)s=s.parentNode;if(s.segment.terrainReady&&this.appliedTerrainNodeId!==s.nodeId){let o=2<<n.tileZoom-s.segment.tileZoom-1,a=n.tileX-s.segment.tileX*o,h=n.tileY-s.segment.tileY*o;const c=s.segment;let u,d,f,g;this.appliedTerrainNodeId=s.nodeId,this.equalizedSideWithNodeId[0]=this.equalizedSideWithNodeId[1]=this.equalizedSideWithNodeId[2]=this.equalizedSideWithNodeId[3]=this.appliedTerrainNodeId;let _=s.segment.gridSize/o,m=s.segment.fileGridSize/o;if(at.xmin=xt,at.xmax=Ct,at.ymin=xt,at.ymax=Ct,at.zmin=xt,at.zmax=Ct,_>=1){n.gridSize=_;let p=(_+1)*(_+1)*3;u=new Float64Array(p),d=new Float32Array(p),f=new Float32Array(p),c.noDataVertices&&(g=new Uint8Array(p/3)),dr(c.terrainVertices,c.terrainVerticesHigh,c.terrainVerticesLow,c.noDataVertices,c.gridSize,_*h,_*a,_,u,d,f,at,g)}else if(m>=1&&s.segment.terrainExists){n.gridSize=m;let p=(m+1)*(m+1)*3;u=new Float64Array(p),d=new Float32Array(p),f=new Float32Array(p),c.noDataVertices&&(g=new Uint8Array(p/3)),dr(c.normalMapVertices,c.normalMapVerticesHigh,c.normalMapVerticesLow,c.noDataVertices,s.segment.fileGridSize,m*h,m*a,m,u,d,f,at,g)}else{n.gridSize=Yh;let p,x=Math.floor(_*h),y=Math.floor(_*a);p=c.gridSize===1?c.terrainVertices:Kr(c.terrainVertices,c.gridSize,x,y,1);let T=1/_,S=h-T*x,C=a-T*y,P=new v(p[0],p[1],p[2]),w=new v(p[9],p[10],p[11]),I=new v(p[3]-p[0],p[4]-p[1],p[5]-p[2]),O=new v(p[6]-p[0],p[7]-p[1],p[8]-p[2]),N=new v(p[3]-p[9],p[4]-p[10],p[5]-p[11]),k=new v(p[6]-p[9],p[7]-p[10],p[8]-p[11]),D=new v;u=new Float64Array(3*be.length),d=new Float32Array(3*be.length),f=new Float32Array(3*be.length);for(let ze=0;ze<be.length;ze++){let z=be[ze].y+S,Ee=be[ze].x+C,B=Ee*_,rt=z*_;D=z+Ee<T?I.scaleTo(B).addA(O.scaleTo(rt)).addA(P):k.scaleTo(1-B).addA(N.scaleTo(1-rt)).addA(w),v.doubleToTwoFloats(D,Fi,Oi);let wt=3*ze;u[wt]=D.x,u[wt+1]=D.y,u[wt+2]=D.z,d[wt]=Fi.x,d[wt+1]=Fi.y,d[wt+2]=Fi.z,f[wt]=Oi.x,f[wt+1]=Oi.y,f[wt+2]=Oi.z,D.x<at.xmin&&(at.xmin=D.x),D.x>at.xmax&&(at.xmax=D.x),D.y<at.ymin&&(at.ymin=D.y),D.y>at.ymax&&(at.ymax=D.y),D.z<at.zmin&&(at.zmin=D.z),D.z>at.zmax&&(at.zmax=D.z)}}if(n.readyToEngage=!0,n.terrainVertices=u,n.terrainVerticesHigh=d,n.terrainVerticesLow=f,n.tempVertices=u,n.tempVerticesHigh=d,n.tempVerticesLow=f,n.noDataVertices=g,n.setBoundingVolume(at.xmin,at.ymin,at.zmin,at.xmax,at.ymax,at.zmax),n.tileZoom>n.planet.terrain.maxZoom&&s.segment.tileZoom>=n.planet.terrain.maxZoom&&(n._plainRadius=s.segment._plainRadius/o,n.terrainReady=!0,n.terrainIsLoading=!1,n.terrainVertices=u,n.terrainVerticesHigh=d,n.terrainVerticesLow=f,n.passReady=!0,this.appliedTerrainNodeId=this.nodeId,this.equalizedSideWithNodeId[0]=this.equalizedSideWithNodeId[1]=this.equalizedSideWithNodeId[2]=this.equalizedSideWithNodeId[3]=this.appliedTerrainNodeId,s.segment.terrainExists)){n.normalMapVertices=u,n.fileGridSize=Math.sqrt(u.length/3)-1;let p=Math.sqrt(c.normalMapNormals.length/3)-1,x=p/o;n.normalMapNormals=p>1?Io(c.normalMapNormals,p,x*h,x*a,x):c.normalMapNormals}}}destroy(){this.prevState=this.state=0,this.segment.destroySegment();let t=this.neighbors;for(let n=0,s=t.length;n<s;n++){let o=t[n];if(o)for(let a=0;a<o.length;a++){let h=o[a];h&&h.neighbors&&h.clearNeighbors()}}this.neighbors=null,this.parentNode=null,this.sideSizeLog2=null,this.segment=null}clearTree(){const t=this.getState();if(t===0||t===1)this.destroyBranches();else for(let n=0;n<this.nodes.length;n++)this.nodes[n]&&this.nodes[n].clearTree()}clearBranches(){for(let t=0;t<this.nodes.length;t++)this.nodes[t].clearBranches(),this.nodes[t].segment.deleteMaterials()}destroyBranches(){if(this.ready){let t,n=[];for(t=0;t<this.nodes.length;t++)n[t]=this.nodes[t];for(this.ready=!1,this.nodes=[],t=0;t<n.length;t++)n[t].destroyBranches(),n[t].destroy(),n[t]=null;n.length=0,n=null}}traverseTree(t){if(t(this),this.ready)for(let n=0;n<this.nodes.length;n++)this.nodes[n].traverseTree(t)}getOffsetOppositeNeighbourSide(t,n){let s=this,o=t.segment.tileZoom,a=0;for(;s.segment.tileZoom>o;)a+=Wa[s.partId][n]/(1<<s.segment.tileZoom-o),s=s.parentNode;return a}}class dn{constructor(t=2048){this._size=t,this._array=new Array(this._size),this._popIndex=Math.floor(.5*this._size),this._shiftIndex=this._popIndex,this.length=0}reset(){this._popIndex=Math.floor(.5*this._size),this._shiftIndex=this._popIndex,this.length=0}clear(){this._array.length=0,this._array=new Array(this._size),this._popIndex=Math.floor(.5*this._size),this._shiftIndex=this._popIndex,this.length=0}push(t){this.length++,this._array[this._popIndex++]=t}pop(){if(this.length){this.length--;let t=this._array[--this._popIndex];return this._array[this._popIndex]=null,this._array[this._popIndex-1]||(this._popIndex=Math.floor(.5*this._size),this._shiftIndex=this._popIndex),t}}unshift(t){this.length++,this._array[--this._shiftIndex]=t}shift(){if(this.length){this.length--;let t=this._array[this._shiftIndex];return this._array[this._shiftIndex++]=null,this._array[this._shiftIndex]||(this._popIndex=Math.floor(.5*this._size),this._shiftIndex=this._popIndex),t}}forEach(t){for(let n=this._shiftIndex;n<this._popIndex;n++)t(this._array[n])}}class un{constructor(t,n,s){this.quadTreeStrategy=t,this._layer=n,this._nodeCapacity=s,this._secondPASS=[],this._counter=0,this._deferredEntitiesPendingQueue=new dn,this._renderingNodes={}}insertEntity(t,n=!1){}setPickingEnabled(t){}dispose(){}insertEntities(t){}collectVisibleEntityCollections(t){}_queueDeferredNode(t){this._layer.getVisibility()&&(t._inTheQueue=!0,this._counter>=1?this._deferredEntitiesPendingQueue.push(t):this._execDeferredNode(t))}_execDeferredNode(t){this._counter++,requestAnimationFrame(()=>{if(t.applyCollection(),this._counter--,this._deferredEntitiesPendingQueue.length&&this._counter<1)for(;this._deferredEntitiesPendingQueue.length;){let n=this._deferredEntitiesPendingQueue.pop();if(n._inTheQueue=!1,n.isVisible())return void this._execDeferredNode(n)}})}}class Is{constructor(t){this._skipPreRender=!1,this.events=lt($h),this.name=t.name||"",this.projection=t.proj||cn,this.planet=t.planet,this._quadTreeList=[],this._visibleNodes={},this._renderedNodes=[],this._renderedNodesInFrustum=[],this._fadingNodes=new Map,this._fadingNodesInFrustum=[],this._fadingOpaqueSegments=[],this.minCurrZoom=xt,this.maxCurrZoom=Ct,this._viewExtent=new U(new L(180,180),new L(-180,-180)),this._lodSize=256,this._curLodSize=256,this._minLodSize=512,this._maxLodSize=256,this.maxEqualZoomAltitude=t.maxEqualZoomAltitude||15e6,this.minEqualZoomAltitude=t.minEqualZoomAltitude||1e4,this.minEqualZoomCameraSlope=t.minEqualZoomCameraSlope||.8,this._renderCompleted=!1,this._renderCompletedActivated=!1,this._terrainCompleted=!1,this._terrainCompletedActivated=!1,this._transitionOpacityEnabled=t.transitionOpacityEnabled==null||t.transitionOpacityEnabled}get lodSize(){return this._lodSize}setLodSize(t,n,s){this._maxLodSize=s||this._maxLodSize,this._minLodSize=n||this._minLodSize,this._curLodSize=t,this._renderCompletedActivated=!1,this._terrainCompletedActivated=!1}createEntityCollectionsTreeStrategy(t,n){return new un(this,t,n)}destroyBranches(){this._renderCompletedActivated=!1,this._terrainCompletedActivated=!1;for(let t=0,n=this._quadTreeList.length;t<n;t++)this._quadTreeList[t].destroyBranches()}clearLayerMaterial(t,n=!1){let s=t.__id;for(let o=0,a=this._quadTreeList.length;o<a;o++)this._quadTreeList[o].traverseTree(h=>{if(n&&this._renderedNodes.includes(h))return;let c=h.segment.materials;c[s]&&(c[s].clear(),c[s]=null)})}get terrainReady(){return this._terrainCompleted&&this._terrainCompletedActivated}_checkRendercompleted(){this._renderCompleted?this._renderCompletedActivated||(this._renderCompletedActivated=!0,this.events.dispatch(this.events.rendercompleted,!0)):this._renderCompletedActivated=!1,this._renderCompleted=!0,this._terrainCompleted?this._terrainCompletedActivated||(this._terrainCompletedActivated=!0,this.events.dispatch(this.events.terraincompleted,!0)):this._terrainCompletedActivated=!1,this._terrainCompleted=!0}_initEvents(){this.planet.renderer.events.on("resize",()=>{this._renderCompletedActivated=!1,this._terrainCompletedActivated=!1}),this.planet.renderer.events.on("postdraw",()=>{this._checkRendercompleted()})}init(t){this._initEvents(),this._renderedNodesInFrustum=new Array(t.frustums.length);for(let n=0,s=this._renderedNodesInFrustum.length;n<s;n++)this._renderedNodesInFrustum[n]=[];this.preRender(),this.clearRenderedNodes(),this.preLoad()}clearRenderedNodes(){this._clearRenderedNodeList(),this._clearRenderNodesInFrustum()}_clearRenderedNodeList(){this._renderedNodes.length=0,this._renderedNodes=[]}_clearRenderNodesInFrustum(){for(let t=0,n=this._renderedNodesInFrustum.length;t<n;t++)this._renderedNodesInFrustum[t].length=0,this._renderedNodesInFrustum[t]=[]}_collectRenderedNodesMaxZoom(t){if(t.isOrthographic||t.slope>this.minEqualZoomCameraSlope&&t._lonLat.height<this.maxEqualZoomAltitude&&t._lonLat.height>this.minEqualZoomAltitude){this.minCurrZoom=this.maxCurrZoom;let n=this._renderedNodes,s=this._renderedNodesInFrustum,o=[];this._clearRenderNodesInFrustum(),this._renderedNodes=[];for(let a=0,h=n.length;a<h;a++){let c=n[a],u=c.segment.centerNormal.dot(t.getBackward());if(c.segment.tileZoom===this.maxCurrZoom||u<.81){this._renderedNodes.push(c);let d=0,f=c.inFrustum;for(;f;)1&f&&s[d].push(c),d++,f>>=1}else o.push(c)}for(let a=0,h=o.length;a<h;a++)o[a].renderTree(t,this.maxCurrZoom,null,!1,o[a])}}set transitionOpacityEnabled(t){this._transitionOpacityEnabled=t}get transitionOpacityEnabled(){return this._transitionOpacityEnabled}collectRenderNodes(t){if(this._skipPreRender&&(this._lodSize=wo(t.slope<0?0:t.slope,this._curLodSize,this._minLodSize),t._insideSegment=null,this._clearRenderedNodeList(),this._clearRenderNodesInFrustum(),this._viewExtent.southWest.set(180,180),this._viewExtent.northEast.set(-180,-180),this.minCurrZoom=xt,this.maxCurrZoom=Ct,this._collectRenderNodes(t),this._collectRenderedNodesMaxZoom(t),this._fadingNodes.clear(),this._transitionOpacityEnabled)){let n=[];for(let s=0;s<this._renderedNodes.length;s++){let o=this._renderedNodes[s];if(o._collectFadingNodes(),o._refreshTransitionOpacity(),o.segment._transitionOpacity>=1)o.clearNeighbors(),o.getRenderedNodesNeighbors(n),n.push(o);else for(let a=0;a<o._fadingNodes.length;a++){let h=o._fadingNodes[a];h.segment&&h.segment._transitionOpacity>=1&&(h.clearNeighbors(),h.getRenderedNodesNeighbors(n),n.push(h))}}}this._skipPreRender=!0}preRender(){this._skipPreRender=!1;for(let t=0;t<this._quadTreeList.length;t++){let n=this._quadTreeList[t];n.createChildNodes(),n.segment.createPlainSegment();for(let s=0;s<n.nodes.length;s++)n.nodes[s].segment.createPlainSegment()}}preLoad(){for(let t=0;t<this._quadTreeList.length;t++){let n=this._quadTreeList[t];n.segment.passReady=!0,n.renderNode(1),this.planet.normalMapCreator.drawSingle(n.segment);for(let s=0;s<n.nodes.length;s++)n.nodes[s].segment.passReady=!0,n.nodes[s].renderNode(1),this.planet._normalMapCreator.drawSingle(n.nodes[s].segment)}}_clearVisibleNodes(){this._visibleNodes={}}_collectRenderNodes(t){this._clearVisibleNodes();for(let n=0;n<this._quadTreeList.length;n++)this._quadTreeList[n].renderTree(t,0,null)}clear(){for(let t=0;t<this._quadTreeList.length;t++)this._quadTreeList[t].clearTree()}get quadTreeList(){return this._quadTreeList}getTileXY(t,n){let s,o,a=n,h=1<<a;return s=At(t.lon,360/h,-180),o=At(t.lat,180/h,90),[s,o,a,0]}getLonLatTileOffset(t,n,s,o,a){let h;h=Si(n,s,o,U.createFromArray([-180,-90,180,90]));let c=h.getWidth()/(a-1),u=h.getHeight()/(a-1);return[a-Math.ceil((t.lat-h.southWest.lat)/u)-1,Math.floor((t.lon-h.southWest.lon)/c)]}collectVisibleNode(t){this._visibleNodes[t.nodeId]=t}}const $h=["rendercompleted","terraincompleted"],zs=new hn({code:"epsg:4326",units:Ea}),ho=(90-ct)/Math.pow(2,7);class Hr extends Aa{constructor(t,n,s,o){super(t,n,s,o),this._projection=zs,this._extentLonLat=this._extent,this._extentMerc=new U(o.southWest.forwardMercatorEPS01(),o.northEast.forwardMercatorEPS01()),this._isNorth=this._extent.northEast.lat>0,this.isPole=!0}_setExtentLonLat(){this._extentLonLat=this._extent}projectNative(t){return t}getInsideLonLat(t){return t._lonLat}_getMaxZoom(){let t;if(this._isNorth){let n=Math.floor((90-this._extent.northEast.lat)/ho);t=Math.floor(n/16)+7}else{let n=Math.floor((Ot-this._extent.northEast.lat)/ho);t=12-Math.floor(n/16)}return t}checkZoom(){return super.checkZoom()&&this.tileZoom<=this._getMaxZoom()}_assignTileIndexes(){this._assignTileXIndexes(this._extent),this._assignTileYIndexes(this._extent),this.tileIndex=zt.getTileIndex(this.tileX,this.tileY,this.tileZoom,this._tileGroup)}_assignTileXIndexes(t){this.tileX=At(t.getCenter().lon,t.getWidth(),-180);let n=1<<this.tileZoom;this.tileXE=(this.tileX+1)%n,this.tileXW=(n+this.tileX-1)%n}_assignTileYIndexes(t){const n=t.getCenter().lat;n>0?(this._tileGroup=20,this.tileY=At(n,t.getHeight(),90)):(this._tileGroup=Pe,this.tileY=At(n,t.getHeight(),Ot)),this.tileYN=this.tileY-1,this.tileYS=this.tileY+1}_projToDeg(t,n){return new L(t,n)}_assignGlobalTextureCoordinates(){const t=this._extent;this._globalTextureCoordinates[0]=(t.southWest.lon+180)/360,this._globalTextureCoordinates[1]=(90-t.northEast.lat)/180,this._globalTextureCoordinates[2]=(t.northEast.lon+180)/360,this._globalTextureCoordinates[3]=(90-t.southWest.lat)/180}_getLayerExtentOffset(t){const n=t._extent,s=this._extent,o=n.northEast.lon-n.southWest.lon,a=n.northEast.lat-n.southWest.lat;return[(s.southWest.lon-n.southWest.lon)/o,(n.northEast.lat-s.northEast.lat)/a,(s.northEast.lon-s.southWest.lon)/o,(s.northEast.lat-s.southWest.lat)/a]}layerOverlap(t){return this._extent.overlaps(t._extent)}getDefaultTexture(){return this._isNorth?this.planet.solidTextureOne:this.planet.solidTextureTwo}getExtentLonLat(){return this._extent}}class pe{constructor(t,n,s,o,a,h){this.strategy=t,this.layer=t._layer,this.parentNode=s,this.childNodes=[],this.partId=n,this.nodeId=n+(s?4*s.nodeId+1:0),this.state=null,this.extent=o,this.count=0,this.deferredEntities=[],this.entityCollection=null,this.zoom=h,this._inTheQueue=!1,this.bsphere=new Ft,a&&this._setExtentBounds()}insertEntity(t,n=!1){this.buildTree([t],n)}_addEntitiesToCollection(t,n=!1){if(t.length){const s=this.layer,o=s._planet;let a=this.entityCollection;a||(a=new se({pickingEnabled:s._pickingEnabled,labelMaxLetters:s.labelMaxLetters}),a._layer=this.layer,a.addTo(o,!0),a._quadNode=this,s._bindEventsDefault(a),this.entityCollection=a),n||!s.async?this.entityCollection.addEntities(t):this.deferredEntities.push.apply(this.deferredEntities,t)}}_setExtentBounds(){this.nodeId?this.bsphere.setFromExtent(this.layer._planet.ellipsoid,this.extent.inverseMercator()):(this.bsphere.radius=this.layer._planet.ellipsoid.equatorialSize,this.bsphere.center=new v)}__setLonLat__(t){return t._lonLat.isZero()&&!t._cartesian.isZero()&&(t._lonLat=this.layer._planet.ellipsoid.cartesianToLonLat(t._cartesian)),Math.abs(t._lonLat.lat)<ct?t._lonLatMerc=t._lonLat.forwardMercator():t._lonLatMerc=new L,t._lonLatMerc}buildTree(t,n=!1){if(this.count+=t.length,t.length>this.layer._nodeCapacity){const s=this.childNodes;s.length||this.createChildNodes();let o=[],a=[],h=[],c=[],u=t.length;for(;u--;){const d=t[u];s[0].isInside(d)?(d._nodePtr=s[0],o.push(d)):s[1].isInside(d)?(d._nodePtr=s[1],a.push(d)):s[2].isInside(d)?(d._nodePtr=s[2],h.push(d)):s[3].isInside(d)&&(d._nodePtr=s[3],c.push(d))}o.length&&s[0].buildTree(o,n),a.length&&s[1].buildTree(a,n),h.length&&s[2].buildTree(h,n),c.length&&s[3].buildTree(c,n)}else this._addEntitiesToCollection(t,n)}isInside(t){return!!t._lonLatMerc&&this.extent.isInside(t._lonLatMerc)}createChildNodes(){const t=this.strategy,n=this.extent,s=.5*n.getWidth(),o=.5*n.getHeight(),a=n.northEast,h=n.southWest,c=new L(h.lon+s,h.lat+o),u=this.childNodes,d=this.layer._planet,f=this.zoom+1;u[0]=new pe(t,0,this,new U(new L(h.lon,h.lat+o),new L(h.lon+s,a.lat)),d,f),u[1]=new pe(t,1,this,new U(c,new L(a.lon,a.lat)),d,f),u[2]=new pe(t,2,this,new U(new L(h.lon,h.lat),c),d,f),u[3]=new pe(t,3,this,new U(new L(h.lon+s,h.lat),new L(a.lon,h.lat+o)),d,f)}collectRenderCollectionsPASS1(t,n){const s=t[this.nodeId];if(s){const o=this.childNodes;this.entityCollection?this.renderCollection(n,t):o.length&&(s.state===1?this.strategy._secondPASS.push(this):(o[0].collectRenderCollectionsPASS1(t,n),o[1].collectRenderCollectionsPASS1(t,n),o[2].collectRenderCollectionsPASS1(t,n),o[3].collectRenderCollectionsPASS1(t,n)))}}collectRenderCollectionsPASS2(t,n,s){const o=this.layer._planet.camera,a=o.eye.distance(this.bsphere.center)-this.bsphere.radius<3570*Math.sqrt(o._lonLat.height)||o._lonLat.height>1e4;if(this.count>0&&a&&o.containsSphere(this.bsphere)){const h=this.childNodes;this.entityCollection?this.renderCollection(n,t,s):h.length&&(h[0].collectRenderCollectionsPASS2(t,n,s),h[1].collectRenderCollectionsPASS2(t,n,s),h[2].collectRenderCollectionsPASS2(t,n,s),h[3].collectRenderCollectionsPASS2(t,n,s))}}applyCollection(){this.entityCollection.addEntities(this.deferredEntities),this.deferredEntities.length=0,this.deferredEntities=[],this._inTheQueue=!1}traverseTree(t){const n=this.childNodes;this.entityCollection?t(this):n.length&&(n[0].traverseTree(t),n[1].traverseTree(t),n[2].traverseTree(t),n[3].traverseTree(t))}renderCollection(t,n,s){const o=this.strategy;o._renderingNodes[this.nodeId]=!0,this.deferredEntities.length&&!this._inTheQueue&&(this.layer.async?o._queueDeferredNode(this):this.applyCollection());let a=this.entityCollection,h=this.layer;if(a._fadingOpacity=h._fadingOpacity,a.scaleByDistance=h.scaleByDistance,a.pickingScale=h.pickingScale,a.polygonOffsetUnits=h.polygonOffsetUnits,t.push(a),h.clampToGround||h.relativeToGround){const c=a._entities;let u=c.length;if(n[this.nodeId]&&n[this.nodeId].state===1)for(;u--;){let d=c[u];this.alignEntityToTheGround(d,n[this.nodeId].segment)}else if(s)for(;u--;){let d=c[u];this.alignEntityToTheGround(d,n[s].segment)}else{const d=this.strategy.quadTreeStrategy._renderedNodes;for(;u--;){let f=c[u],g=d.length;for(;g--;)if(d[g].segment.isEntityInside(f)){this.alignEntityToTheGround(f,d[g].segment);break}}}}}alignEntityToTheGround(t,n){let s=new v;n.getEntityTerrainPoint(t,s);let o=Number(this.layer.relativeToGround)&&t._altitude||0;if(o){let a=this.layer._planet.ellipsoid.getSurfaceNormal3v(s);t._setCartesian3vSilent(s.addA(a.scale(o)))}else t._setCartesian3vSilent(s)}isVisible(){return!!this.strategy._renderingNodes[this.nodeId]}}class Ce extends pe{constructor(t,n,s,o,a,h){super(t,n,s,o,a,h),this.strategy=t,this.isNorth=!1}createChildNodes(){const t=this.strategy,n=this.extent,s=.5*n.getWidth(),o=.5*n.getHeight(),a=n.northEast,h=n.southWest,c=new L(h.lon+s,h.lat+o),u=this.childNodes,d=this.layer._planet,f=this.zoom+1;u[0]=new Ce(t,0,this,new U(new L(h.lon,h.lat+o),new L(h.lon+s,a.lat)),d,f),u[1]=new Ce(t,1,this,new U(c,new L(a.lon,a.lat)),d,f),u[2]=new Ce(t,2,this,new U(new L(h.lon,h.lat),c),d,f),u[3]=new Ce(t,3,this,new U(new L(h.lon+s,h.lat),new L(a.lon,h.lat+o)),d,f)}_setExtentBounds(){this.extent.northEast.lat>0&&(this.isNorth=!0),this.bsphere.setFromExtent(this.layer._planet.ellipsoid,this.extent)}__setLonLat__(t){return t._lonLat.isZero()&&(t._lonLat=this.layer._planet.ellipsoid.cartesianToLonLat(t._cartesian)),t._lonLat}isVisible(){return!(!this.isNorth||!this.strategy._renderingNodesNorth[this.nodeId])||!!this.strategy._renderingNodesSouth[this.nodeId]}isInside(t){return this.extent.isInside(t._lonLat)}renderCollection(t,n,s){this.isNorth?this.strategy._renderingNodesNorth[this.nodeId]=!0:this.strategy._renderingNodesSouth[this.nodeId]=!0,this.deferredEntities.length&&!this._inTheQueue&&(this.layer.async?this.strategy._queueDeferredNode(this):this.applyCollection());const o=this.entityCollection;o._fadingOpacity=this.layer._fadingOpacity,o.scaleByDistance=this.layer.scaleByDistance,o.pickingScale=this.layer.pickingScale,o.isEmpty()||t.push(o)}}class Xh extends un{constructor(t,n,s){super(t,n,s);let o=n._planet;this._entityCollectionsTree=new pe(this,0,null,U.createFromArray([-2003750834e-2,-2003750834e-2,2003750834e-2,2003750834e-2]),o,0),this._entityCollectionsTreeNorth=new Ce(this,0,null,U.createFromArray([-180,ct,180,90]),o,0),this._entityCollectionsTreeSouth=new Ce(this,0,null,U.createFromArray([-180,-90,180,Ot]),o,0),this._renderingNodes={},this._renderingNodesNorth={},this._renderingNodesSouth={}}insertEntity(t,n=!1){t._lonLat.lat>ct?(this._entityCollectionsTreeNorth.__setLonLat__(t),this._entityCollectionsTreeNorth.insertEntity(t,n)):t._lonLat.lat<Ot?(this._entityCollectionsTreeSouth.__setLonLat__(t),this._entityCollectionsTreeSouth.insertEntity(t,n)):(this._entityCollectionsTree.__setLonLat__(t),this._entityCollectionsTree.insertEntity(t,n))}setPickingEnabled(t){this._entityCollectionsTree&&this._entityCollectionsTree.traverseTree(n=>{n.entityCollection.setPickingEnabled(t)}),this._entityCollectionsTreeNorth&&this._entityCollectionsTreeNorth.traverseTree(n=>{n.entityCollection.setPickingEnabled(t)}),this._entityCollectionsTreeSouth&&this._entityCollectionsTreeSouth.traverseTree(n=>{n.entityCollection.setPickingEnabled(t)})}dispose(){this._entityCollectionsTree=null,this._entityCollectionsTreeNorth=null,this._entityCollectionsTreeSouth=null,this._renderingNodes={},this._renderingNodesNorth={},this._renderingNodesSouth={}}insertEntities(t){let n=[],s=[],o=[];for(let a=0,h=t.length;a<h;a++){let c=t[a];c._lonLat.lat>ct?(n.push(c),this._entityCollectionsTreeNorth.__setLonLat__(c)):c._lonLat.lat<Ot?(s.push(c),this._entityCollectionsTreeSouth.__setLonLat__(c)):(o.push(c),this._entityCollectionsTree.__setLonLat__(c))}this._entityCollectionsTree.buildTree(o),this._entityCollectionsTreeNorth.buildTree(n),this._entityCollectionsTreeSouth.buildTree(s)}collectVisibleEntityCollections(t){this._renderingNodes={},this._renderingNodesNorth={},this._renderingNodesSouth={};let n=this._layer._planet.quadTreeStrategy;this._secondPASS=[],this._entityCollectionsTree.collectRenderCollectionsPASS1(n._visibleNodes,t);let s=this._secondPASS.length;for(;s--;)this._secondPASS[s].collectRenderCollectionsPASS2(n._visibleNodes,t,this._secondPASS[s].nodeId);for(this._secondPASS=[],this._entityCollectionsTreeNorth.collectRenderCollectionsPASS1(n._visibleNodesNorth,t),s=this._secondPASS.length;s--;)this._secondPASS[s].collectRenderCollectionsPASS2(n._visibleNodesNorth,t,this._secondPASS[s].nodeId);for(this._secondPASS=[],this._entityCollectionsTreeSouth.collectRenderCollectionsPASS1(n._visibleNodesSouth,t),s=this._secondPASS.length;s--;)this._secondPASS[s].collectRenderCollectionsPASS2(n._visibleNodesSouth,t,this._secondPASS[s].nodeId)}}class La extends Is{constructor(t){super({name:"Earth",...t}),this._visibleNodesNorth={},this._visibleNodesSouth={}}collectVisibleNode(t){let n=t.segment._tileGroup;n===20?this._visibleNodesNorth[t.nodeId]=t:n===Pe?this._visibleNodesSouth[t.nodeId]=t:this._visibleNodes[t.nodeId]=t}_clearVisibleNodes(){super._clearVisibleNodes(),this._visibleNodesNorth={},this._visibleNodesSouth={}}createEntityCollectionsTreeStrategy(t,n){return new Xh(this,t,n)}init(t){this._quadTreeList=[new qt(Aa,this,0,null,0,U.createFromArray([-2003750834e-2,-2003750834e-2,2003750834e-2,2003750834e-2])),new qt(Hr,this,0,null,0,U.createFromArray([-180,ct,180,90])),new qt(Hr,this,0,null,0,U.createFromArray([-180,-90,180,Ot]))],super.init(t)}getTileXY(t,n){let s,o,a=function(u,d=ct){return u>d?20:u<-d?Pe:0}(t.lat,ct),h=n,c=1<<h;if(a===20)s=At(t.lon,360/c,-180),o=At(t.lat,(90-ct)/c,90);else if(a===Pe)s=At(t.lon,360/c,-180),o=At(t.lat,(90-ct)/c,Ot);else{let u=Ji(t);s=At(u.lon,Qi/c,-2003750834e-2),o=At(u.lat,Qi/c,Lt)}return[s,o,h,a]}getLonLatTileOffset(t,n,s,o,a){let h,c=t;t.lat>ct?h=Si(n,s,o,U.createFromArray([-180,ct,180,90])):t.lat<Ot?h=Si(n,s,o,U.createFromArray([-180,-90,180,Ot])):(c=Ji(t),h=Ze(n,s,o));let u=h.getWidth()/(a-1),d=h.getHeight()/(a-1);return[a-Math.ceil((c.lat-h.southWest.lat)/d)-1,Math.floor((c.lon-h.southWest.lon)/u)]}}class Pa{constructor(t={}){this.model=t.model||null,this.src=t.src||null,this._cached_ix=0,this._cached_iy=0,this._v00=0,this._v01=0,this._v10=0,this._v11=0,this._t=0}static loadModel(t){return t?fetch(t,{}).then(n=>{if(!n.ok)throw Error("Geoid model file: HTTP error "+n.status);return n.arrayBuffer()}).then(n=>{if(n)return new Uint8Array(n);throw Error("Geoid model file: no data from "+t)}).then(function(n){if(n[0]!==80||n[1]!==53||(n[2]!==13||n[3]!==10)&&n[2]!==10)throw new Error("Geoid model file: no PGM header");var s,o,a=n[2]===13?4:3,h=null,c=null;function u(){let g=a;for(var _=a;;_++){if(_>=n.length)throw new Error("Geoid model file: missing newline in header");if(n[_]===10){a=_+1;break}}return _>g&&n[_-1]===13&&_--,String.fromCharCode.apply(null,n.slice(g,_))}for(;(o=u())[0]==="#";)if(s=o.match(/^# Offset (.*)$/)){if(h=parseInt(s[1],10),!isFinite(h))throw new Error("Geoid model file: bad offset "+s[1])}else if((s=o.match(/^# Scale (.*)$/))&&(c=parseFloat(s[1]),!isFinite(c)))throw new Error("Geoid model file: bad scale "+s[1]);let d=0,f=0;if((s=o.match(/^\s*(\d+)\s+(\d+)\s*$/))&&(d=parseInt(s[1],10),f=parseInt(s[2],10)),!(s&&d>=0&&f>=0))throw new Error("Geoid model file: bad PGM width&height line");if(parseInt(u())!=65535)throw new Error("Geoid model file: PGM file must have 65535 gray levels");if(h===null)throw new Error("Geoid model file: PGM file does not contain offset");if(c===null)throw new Error("Geoid model file: PGM file does not contain scale");if(d<2||f<2)throw new Error("Geoid model file: Raster size too small");if(n.length-a!=d*f*2)throw new Error("Geoid model file: File has the wrong length");return{scale:c,offset:h,width:d,height:f,rlonres:d/360,rlatres:(f-1)/180,i:a,rawfile:n}}):new Promise(n=>{n(null)})}setModel(t){this.model=t}_rawval(t,n){let s=this.model;n<0?(n=-n,t+=s.width/2):n>=s.height&&(n=2*(s.height-1)-n,t+=s.width/2),t<0?t+=s.width:t>=s.width&&(t-=s.width);let o=2*(n*s.width+t)+s.i;return s.rawfile[o]<<8|s.rawfile[o+1]}getHeightLonLat(t){return this.getHeight(t.lon,t.lat)}getHeight(t,n){if(!this.model)return 0;let s=this.model;t<0&&(t+=360);let o=(90-n)*s.rlatres,a=t*s.rlonres,h=Math.floor(o),c=Math.floor(a);a-=c,o-=h,h===s.height-1&&h--,this._cached_ix===c&&this._cached_iy===h||(this._cached_ix=c,this._cached_iy=h,this._v00=this._rawval(c,h),this._v01=this._rawval(c+1,h),this._v10=this._rawval(c,h+1),this._v11=this._rawval(c+1,h+1));let u=(1-o)*((1-a)*this._v00+a*this._v01)+o*((1-a)*this._v10+a*this._v11);return s.offset+s.scale*u}}class Zh{constructor(t,n=5){this.MAX_FRAMES=n,this._gridSize=64,this._planet=t,this._framebuffer=null,this._framebufferMercProj=null,this._texCoordsBuffer=null,this._indexBuffer=null,this._currentFrame=0,this._queue=[],this._animate=[],this._quadTexCoordsBuffer=null,this._quadVertexBuffer=null}init(){this._initShaders(),this._initBuffers()}createGridBuffer(t,n=!1){let s=this._gridSize,o=new L((t[3].lon-t[0].lon)/s,(t[3].lat-t[0].lat)/s),a=new L((t[2].lon-t[1].lon)/s,(t[2].lat-t[1].lat)/s),h=new L((t[1].lon-t[0].lon)/s,(t[1].lat-t[0].lat)/s),c=new L((t[2].lon-t[3].lon)/s,(t[2].lat-t[3].lat)/s);const u=(s+1)*(s+1)*2,d=u/2;let f=new Float32Array(u),g=new Float32Array(u),_=new Array(d),m=0,p=0,x=0,y=new Float32Array(2);for(let T=0;T<=s;T++){let S=new L(t[0].lon+T*o.lon,t[0].lat+T*o.lat),C=new L(t[1].lon+T*a.lon,t[1].lat+T*a.lat);for(let P=0;P<=s;P++){let w=ko(S,C,new L(t[0].lon+P*h.lon,t[0].lat+P*h.lat),new L(t[3].lon+P*c.lon,t[3].lat+P*c.lat));ae(w.lon,y),f[m++]=y[0],g[p++]=y[1],ae(w.lat,y),f[m++]=y[0],g[p++]=y[1],_[x++]=w}}if(n)for(let T=0;T<d;T++){let S=_[T].forwardMercator();ae(S.lon,y),f[2*T]=y[0],g[2*T]=y[1],ae(S.lat,y),f[2*T+1]=y[0],g[2*T+1]=y[1]}return[this._planet.renderer.handler.createArrayBuffer(f,2,d),this._planet.renderer.handler.createArrayBuffer(g,2,d)]}frame(){let t=this.MAX_FRAMES;for(;t--&&this._queue.length;){const n=this._queue.shift();n._isRendering=!1,n.rendering(),n.events.dispatch(n.events.loadend)}for(t=this._animate.length;t--;)this._animate[t].rendering()}add(t){t._isRendering||(t._isRendering=!0,t._animate?this._animate.push(t):this._queue.push(t))}remove(t){if(t._isRendering){let n;t._creationProceeding=!1,t._isRendering=!1,n=t._animate?this._animate:this._queue;for(let s=0;s<n.length;s++)if(n[s].isEqual(t))return void n.splice(s,1)}}_initBuffers(){let t=this._planet.renderer.handler;this._framebuffer=new Rt(t,{width:2,height:2,useDepth:!1}),this._framebuffer.init(),this._framebufferMercProj=new Rt(t,{width:2,height:2,useDepth:!1}),this._framebufferMercProj.init();let n=Math.log2(this._gridSize);this._texCoordsBuffer=this._planet._textureCoordsBufferCache[n],this._indexBuffer=this._planet._indexesCache[n][n][n][n][n].buffer,this._quadTexCoordsBuffer=t.createArrayBuffer(new Float32Array([0,1,1,1,0,0,1,0]),2,4),this._quadVertexBuffer=t.createArrayBuffer(new Float32Array([-1,1,1,1,-1,-1,1,-1]),2,4)}_initShaders(){this._planet.renderer.handler.addProgram(new X("geoImageTransform",{uniforms:{sourceTexture:"sampler2d",extentParamsHigh:"vec4",extentParamsLow:"vec4",isFullExtent:"bool"},attributes:{cornersHigh:"vec2",cornersLow:"vec2",texCoords:"vec2"},vertexShader:`attribute vec2 cornersHigh; 
                     attribute vec2 cornersLow;
                      attribute vec2 texCoords; 
                      uniform vec4 extentParamsHigh; 
                      uniform vec4 extentParamsLow; 
                      varying vec2 v_texCoords;
                      void main() {                                                             
                          v_texCoords = texCoords; 
                          vec2 highDiff = cornersHigh - extentParamsHigh.xy;
                          vec2 lowDiff = cornersLow - extentParamsLow.xy;                                        
                          gl_Position = vec4((-1.0 + (highDiff * step(1.0, length(highDiff)) + lowDiff) * extentParamsHigh.zw) * vec2(1.0, -1.0), 0.0, 1.0); 
                      }`,fragmentShader:`precision highp float;
                        uniform sampler2D sourceTexture;
                        uniform bool isFullExtent;
                        varying vec2 v_texCoords;
                        void main () {
                            if(!isFullExtent && (v_texCoords.x <= 0.001 || v_texCoords.x >= 0.999 ||
                                v_texCoords.y <= 0.001 || v_texCoords.y >= 0.999)) {
                                discard;
                            }
                            gl_FragColor = texture2D(sourceTexture, v_texCoords);
                        }`}))}}const Kh=["loadend","layerloadend"];class Sa{constructor(t=24){this.MAX_REQUESTS=t,this.events=lt(Kh),this._loading=0,this._queue=[],this._senderRequestCounter=[],this._promises={json:n=>n.json(),blob:n=>n.blob(),arrayBuffer:n=>n.arrayBuffer(),imageBitmap:n=>n.blob().then(s=>createImageBitmap(s,{premultiplyAlpha:"premultiply"})),text:n=>n.text()}}load(t,n){t.sender&&(this._senderRequestCounter[t.sender.__id]||(this._senderRequestCounter[t.sender.__id]={sender:t.sender,counter:0,__requestCounterFrame__:0}),this._senderRequestCounter[t.sender.__id].counter++),this._queue.push({params:t,callback:n}),this._exec()}fetch(t){return fetch(t.src,t.options||{}).then(n=>{if(!n.ok)throw Error(`Unable to load '${t.src}'`);return this._promises[t.type||"blob"](n)}).then(n=>({status:"ready",data:n})).catch(n=>({status:"error",msg:n.toString()}))}getRequestCounter(t){if(t){let n=this._senderRequestCounter[t.__id];if(n)return n.counter}return 0}isIdle(t){return t.isIdle}_checkLoadend(t,n){t.counter===0&&(!n._planet||n.quadTreeStrategy&&n.quadTreeStrategy._terrainCompletedActivated)?(n.events.dispatch(n.events.loadend,n),this.events.dispatch(this.events.layerloadend,n),t.__requestCounterFrame__=0):t.__requestCounterFrame__=requestAnimationFrame(()=>{this._checkLoadend(t,n)})}_handleResponse(t,n){t.callback(n);let s=t.params.sender;if(s&&(s.events.loadend.handlers.length||this.events.layerloadend.handlers.length)){let o=this._senderRequestCounter[s.__id];o&&o.counter>0&&(o.counter--,cancelAnimationFrame(o.__requestCounterFrame__),o.__requestCounterFrame__=requestAnimationFrame(()=>{this._checkLoadend(o,s)}))}this._exec()}_exec(){if(this._queue.length>0&&this._loading<this.MAX_REQUESTS){let t=this._queue.pop();if(!t)return;let n=t.params;if(!n.filter||n.filter(n))return this._loading++,fetch(n.src,n.options||{}).then(s=>{if(!s.ok)throw Error(`Unable to load '${n.src}'`);return this._promises[n.type||"blob"](s)}).then(s=>{this._loading--,this._handleResponse(t,{status:"ready",data:s})}).catch(s=>{this._loading--,this._handleResponse(t,{status:"error",msg:s.toString()})});this._handleResponse(t,{status:"abort"})}else this._loading===0&&this.events.dispatch(this.events.loadend)}abort(t){this._senderRequestCounter[t.__id]&&(this._senderRequestCounter[t.__id].counter=0,cancelAnimationFrame(this._senderRequestCounter[t.__id].__requestCounterFrame__),this._senderRequestCounter[t.__id].__requestCounterFrame__=0);for(let n=0,s=this._queue.length;n<s;n++){let o=this._queue[n];o&&o.params.sender&&t.isEqual(o.params.sender)&&(o.callback({status:"abort"}),this._queue[n]=null)}}abortAll(){for(let t=0,n=this._queue.length;t<n;t++){let s=this._queue[t];if(s){let o=s.params.sender;o&&this._senderRequestCounter[o.__id]&&(this._senderRequestCounter[o.__id].counter=0,cancelAnimationFrame(this._senderRequestCounter[o.__id].__requestCounterFrame__),this._senderRequestCounter[o.__id].__requestCounterFrame__=0),s.callback({status:"abort"}),this._queue[t]=null}}this._queue=[]}get loading(){return this._loading}get queue(){return this._queue}}class Qh{constructor(t,n={}){this._minTabelSize=n.minTableSize||1,this._maxTableSize=n.maxTableSize||8,this._planet=t,this._handler=null,this._verticesBufferArray=[],this._indexBufferArray=[],this._positionBuffer=null,this._framebuffer=null,this._normalMapVerticesTexture=null,this._width=n.width||128,this._height=n.height||128,this._queue=new dn(1024),this._lock=new zr}get width(){return this._width}get height(){return this._height}init(){this._maxTableSize=this._planet.maxGridSize||8,this._handler=this._planet.renderer.handler;const t=new X("normalMapBlur",{attributes:{a_position:"vec2"},uniforms:{s_texture:"sampler2d"},vertexShader:`attribute vec2 a_position;
                       attribute vec2 a_texCoord;

                      varying vec2 blurCoordinates[5];

                      void main() {
                          vec2 vt = a_position * 0.5 + 0.5; 
                           
                          gl_Position = vec4(a_position, 0.0, 1.0);
                          blurCoordinates[0] = vt;
                          blurCoordinates[1] = vt + ${1/this._width*1.407333};
                          blurCoordinates[2] = vt - ${1/this._height*1.407333};
                          blurCoordinates[3] = vt + ${1/this._width*3.294215};
                          blurCoordinates[4] = vt - ${1/this._height*3.294215};
                }`,fragmentShader:`precision lowp float;
                        uniform sampler2D s_texture;                        
                        varying vec2 blurCoordinates[5];                        

                        void main() {
                            lowp vec4 sum = vec4(0.0);
                            //if(blurCoordinates[0].x <= 0.01 || blurCoordinates[0].x >= 0.99 ||
                            //    blurCoordinates[0].y <= 0.01 || blurCoordinates[0].y >= 0.99){
                            //    sum = texture2D(s_texture, blurCoordinates[0]);
                            //} else {
                                sum += texture2D(s_texture, blurCoordinates[0]) * 0.204164;
                                sum += texture2D(s_texture, blurCoordinates[1]) * 0.304005;
                                sum += texture2D(s_texture, blurCoordinates[2]) * 0.304005;
                                sum += texture2D(s_texture, blurCoordinates[3]) * 0.093913;
                                sum += texture2D(s_texture, blurCoordinates[4]) * 0.093913;
                            //}
                            gl_FragColor = sum;
                        }`}),n=new X("normalMap",{attributes:{a_position:"vec2",a_normal:"vec3"},uniforms:{},vertexShader:`attribute vec2 a_position;
                      attribute vec3 a_normal;
                      
                      varying vec3 v_color;
                      
                      void main() {
                          gl_Position = vec4(a_position, 0, 1);
                          v_color = normalize(a_normal) * 0.5 + 0.5;
                      }`,fragmentShader:`precision highp float;
                        
                        varying vec3 v_color;
                        
                        void main () {
                            gl_FragColor = vec4(v_color, 1.0);
                        }`});this._handler.addProgram(t),this._handler.addProgram(n),this._framebuffer=new Rt(this._handler,{width:this._width,height:this._height,useDepth:!1}),this._framebuffer.init(),this._normalMapVerticesTexture=this._handler.createEmptyTexture_l(this._width,this._height);for(let o=this._minTabelSize;o<=this._maxTableSize;o++){const a=1<<o,h=a/2;let c=new Float32Array((a+1)*(a+1)*2);for(let u=0;u<=a;u++)for(let d=0;d<=a;d++){let f=2*(u*(a+1)+d);c[f]=d/h-1,c[f+1]=u/h-1}this._verticesBufferArray[a]=this._handler.createArrayBuffer(c,2,c.length/2),this._indexBufferArray[a]=this._planet._indexesCache[Math.log2(a)][Math.log2(a)][Math.log2(a)][Math.log2(a)][Math.log2(a)].buffer}const s=new Float32Array([-1,-1,1,-1,-1,1,1,1]);this._positionBuffer=this._handler.createArrayBuffer(s,2,s.length/2)}_drawNormalMapBlur(t){let n=t.normalMapNormals;if(t.node&&t.node.getState()!==0&&n&&n.length){const s=n.length/3,o=Math.sqrt(s)-1;let a=this._verticesBufferArray[o];if(a){t.planet.terrain.equalizeNormals&&(t._normalMapEdgeEqualize(0),t._normalMapEdgeEqualize(2),t._normalMapEdgeEqualize(3),t._normalMapEdgeEqualize(1));let h=t.normalMapTexturePtr;const c=this._handler,u=c.gl;let d=c.createArrayBuffer(n,3,s,u.DYNAMIC_DRAW);const f=this._framebuffer;let g=c.programs.normalMap,_=g._program.attributes;return f.bindOutputTexture(this._normalMapVerticesTexture),g.activate(),u.bindBuffer(u.ARRAY_BUFFER,a),u.vertexAttribPointer(_.a_position,a.itemSize,u.FLOAT,!1,0,0),u.bindBuffer(u.ARRAY_BUFFER,d),u.vertexAttribPointer(_.a_normal,d.itemSize,u.FLOAT,!1,0,0),u.bindBuffer(u.ELEMENT_ARRAY_BUFFER,this._indexBufferArray[o]),u.drawElements(u.TRIANGLE_STRIP,this._indexBufferArray[o].numItems,u.UNSIGNED_INT,0),u.deleteBuffer(d),f.bindOutputTexture(h),g=c.programs.normalMapBlur,g.activate(),u.bindBuffer(u.ARRAY_BUFFER,this._positionBuffer),u.vertexAttribPointer(g._program.attributes.a_position,this._positionBuffer.itemSize,u.FLOAT,!1,0,0),u.activeTexture(u.TEXTURE0),u.bindTexture(u.TEXTURE_2D,this._normalMapVerticesTexture),u.uniform1i(g._program.uniforms.s_texture,0),u.drawArrays(u.TRIANGLE_STRIP,0,this._positionBuffer.numItems),!0}return!0}return!1}_drawNormalMapNoBlur(t){let n=t.normalMapNormals;if(t.node&&t.node.getState()!==0&&n&&n.length){const s=n.length/3,o=Math.sqrt(s)-1;let a=this._verticesBufferArray[o];if(a){t.planet.terrain.equalizeNormals&&(t._normalMapEdgeEqualize(0),t._normalMapEdgeEqualize(2),t._normalMapEdgeEqualize(3),t._normalMapEdgeEqualize(1));let h=t.normalMapTexturePtr;const c=this._handler,u=c.gl;let d=c.createArrayBuffer(n,3,s,u.DYNAMIC_DRAW);const f=this._framebuffer,g=c.programs.normalMap,_=g._program.attributes;return f.bindOutputTexture(h),g.activate(),u.bindBuffer(u.ARRAY_BUFFER,a),u.vertexAttribPointer(_.a_position,a.itemSize,u.FLOAT,!1,0,0),u.bindBuffer(u.ARRAY_BUFFER,d),u.vertexAttribPointer(_.a_normal,d.itemSize,u.FLOAT,!1,0,0),u.bindBuffer(u.ELEMENT_ARRAY_BUFFER,this._indexBufferArray[o]),u.drawElements(u.TRIANGLE_STRIP,this._indexBufferArray[o].numItems,u.UNSIGNED_INT,0),u.deleteBuffer(d),!0}return!0}return!1}_drawNormalMap(t){return t.planet.terrain.isBlur(t)?this._drawNormalMapBlur(t):this._drawNormalMapNoBlur(t)}drawSingle(t){const n=this._handler.gl;this._framebuffer.activate(),n.disable(n.CULL_FACE),n.disable(n.DEPTH_TEST),n.disable(n.BLEND),t.terrainReady&&this._drawNormalMap(t)&&(t.normalMapReady=!0,t.normalMapTexture=t.normalMapTexturePtr,t.normalMapTextureBias[0]=0,t.normalMapTextureBias[1]=0,t.normalMapTextureBias[2]=1),t._inTheQueue=!1,n.enable(n.DEPTH_TEST),n.enable(n.CULL_FACE),n.enable(n.BLEND),this._framebuffer.deactivate()}frame(){if(this._queue.length){const t=this._handler.gl;this._framebuffer.activate(),t.disable(t.CULL_FACE),t.disable(t.DEPTH_TEST),t.disable(t.BLEND);let n=0,s=window.performance.now();for(;this._lock.isFree()&&this._queue.length&&n<.25;){const o=this._queue.shift();o.terrainReady&&this._drawNormalMap(o)&&(o.normalMapReady=!0,o.normalMapTexture=o.normalMapTexturePtr,o.normalMapTextureBias[0]=0,o.normalMapTextureBias[1]=0,o.normalMapTextureBias[2]=1),o._inTheQueue=!1,n=window.performance.now()-s}t.enable(t.BLEND),t.enable(t.DEPTH_TEST),t.enable(t.CULL_FACE),this._framebuffer.deactivate()}}get queueSize(){return this._queue.length}queue(t){t._inTheQueue=!0,this._queue.push(t)}unshift(t){t._inTheQueue=!0,this._queue.unshift(t)}remove(t){}clear(){for(;this._queue.length;)this._queue.pop()._inTheQueue=!1}lock(t){this._lock.lock(t)}free(t){this._lock.free(t)}}const _n=new hn({code:"equi",units:Ea}),Ra=`(function(){"use strict";let l=null,K=null,O=null,Q=null,S=null,T=null,U=null;function P(a,t){t<0?(t=-t,a+=l.width/2):t>=l.height&&(t=2*(l.height-1)-t,a+=l.width/2),a<0?a+=l.width:a>=l.width&&(a-=l.width);var n=2*(t*l.width+a)+l.i;return l.rawfile[n]<<8|l.rawfile[n+1]}const sa=.5*Math.PI,W=2003750834e-2,ia=Math.PI/W,ua=180/W,X=180/Math.PI,Ma=X*sa,Y=Math.PI/180,da=2*X;let k=0,Z=0,_=null;const B=function(a,t,n){this.x=a,this.y=t,this.z=n};var $=function(a,t,n,o){let f=function(c,C){if(!l)return 0;c<0&&(c+=360);var w=(90-C)*l.rlatres,M=c*l.rlonres,u=Math.floor(w),d=Math.floor(M);M-=d,w-=u,u===l.height-1&&u--,K===d&&O===u||(K=d,O=u,Q=P(d,u),S=P(d+1,u),T=P(d,u+1),U=P(d+1,u+1));let L=null;return L=(1-w)*((1-M)*Q+M*S)+w*((1-M)*T+M*U),l.offset+l.scale*L}(a,t)*n,h=Y*t,r=Y*a,m=Math.sin(h),x=Z/Math.sqrt(1-k*m*m),H=(x+f)*Math.cos(h);o.x=H*Math.cos(r),o.y=H*Math.sin(r),o.z=(x*(1-k)+f)*m},ma=function(a,t,n,o){$(a*ua,da*Math.atan(Math.exp(t*ia))-Ma,n,o)},e=new B(0,0,0),p=new B(0,0,0),y=new B(0,0,0),pa=function(a,t,n){let o=a.x,f=a.y,h=a.z;var r;o>=0?(r=65536*Math.floor(o/65536),t.x=Math.fround(r),n.x=Math.fround(o-r)):(r=65536*Math.floor(-o/65536),t.x=Math.fround(-r),n.x=Math.fround(o+r)),f>=0?(r=65536*Math.floor(f/65536),t.y=Math.fround(r),n.y=Math.fround(f-r)):(r=65536*Math.floor(-f/65536),t.y=Math.fround(-r),n.y=Math.fround(f+r)),h>=0?(r=65536*Math.floor(h/65536),t.z=Math.fround(r),n.z=Math.fround(h-r)):(r=65536*Math.floor(-h/65536),t.z=Math.fround(-r),n.z=Math.fround(h+r))};self.onmessage=function(a){if(a.data.model)l=a.data.model,l.rawfile=a.data.rawfile;else if(a.data.params){let t=549755748352,n=-549755748352,o=549755748352,f=-549755748352,h=549755748352,r=-549755748352;k=a.data.params[8],Z=a.data.params[9];let m=a.data.params[2],x=a.data.params[3],H=a.data.params[10],c=a.data.params[11],C=a.data.params[12],w=a.data.params[13];_=a.data.params[1]===0?ma:$;let M=Math.max(x,m),u=(a.data.params[6]-a.data.params[4])/M,d=(a.data.params[7]-a.data.params[5])/M,L=a.data.params[4],ya=a.data.params[7],aa=Math.max(x/m,1),N=M+1;const z=N*N,R=(m+1)*(m+1)*3;let b=new Float32Array(R),A=new Float64Array(R),F=new Float32Array(R),g=new Float32Array(R),V=new Float32Array(3*z),q=new Float64Array(3*z),v=new Float32Array(3*z),I=new Float32Array(3*z),s=0,i=0;for(let j=0;j<z;j++){let la=j%N,na=~~(j/N);_(L+la*u,ya-na*d,w,e);let D=e.x*H,E=e.y*c,G=e.z*C,J=1/Math.sqrt(D*D+E*E+G*G),oa=D*J,fa=E*J,ha=G*J;pa(e,p,y),q[i]=e.x,v[i]=p.x,I[i]=y.x,V[i++]=oa,q[i]=e.y,v[i]=p.y,I[i]=y.y,V[i++]=fa,q[i]=e.z,v[i]=p.z,I[i]=y.z,V[i++]=ha,na%aa==0&&la%aa==0&&(A[s]=e.x,F[s]=p.x,g[s]=y.x,b[s++]=oa,A[s]=e.y,F[s]=p.y,g[s]=y.y,b[s++]=fa,A[s]=e.z,F[s]=p.z,g[s]=y.z,b[s++]=ha,e.x<t&&(t=e.x),e.x>n&&(n=e.x),e.y<o&&(o=e.y),e.y>f&&(f=e.y),e.z<h&&(h=e.z),e.z>r&&(r=e.z))}let ta=.5*(n-t),ra=.5*(f-o),ea=.5*(r-h),wa=Math.sqrt(ta*ta+ra*ra+ea*ea);self.postMessage({id:a.data.params[0],plainVertices:A,plainVerticesHigh:F,plainVerticesLow:g,plainNormals:b,normalMapNormals:V,normalMapVertices:q,normalMapVerticesHigh:v,normalMapVerticesLow:I,plainRadius:wa},[A.buffer,F.buffer,g.buffer,b.buffer,V.buffer,q.buffer,v.buffer,I.buffer])}}})();
//# sourceMappingURL=PlainSegmentWorker.worker-CT1cj8jj.js.map
`,co=typeof self<"u"&&self.Blob&&new Blob([Ra],{type:"text/javascript;charset=utf-8"});function Jh(l){let t;try{if(t=co&&(self.URL||self.webkitURL).createObjectURL(co),!t)throw"";const n=new Worker(t,{name:l==null?void 0:l.name});return n.addEventListener("error",()=>{(self.URL||self.webkitURL).revokeObjectURL(t)}),n}catch{return new Worker("data:text/javascript;charset=utf-8,"+encodeURIComponent(Ra),{name:l==null?void 0:l.name})}finally{t&&(self.URL||self.webkitURL).revokeObjectURL(t)}}class tc extends en{constructor(t=2){super(t,Jh)}_onMessage(t){this._source.get(t.data.id)._plainSegmentWorkerCallback(t.data),t.data.plainVertices=null,t.data.plainVerticesHigh=null,t.data.plainVerticesLow=null,t.data.plainNormals=null,t.data.normalMapNormals=null,t.data.normalMapVertices=null,t.data.normalMapVerticesHigh=null,t.data.normalMapVerticesLow=null,this._source.delete(t.data.id)}setGeoid(t){if(t.model){let n=t.model,s={scale:n.scale,offset:n.offset,width:n.width,height:n.height,rlonres:n.rlonres,rlatres:n.rlatres,i:n.i};this._workerQueue.forEach(o=>{let a=new Uint8Array(n.rawfile.length);a.set(n.rawfile),o.postMessage({model:s,rawfile:a},[a.buffer])})}else this._workerQueue.forEach(n=>{n.postMessage({model:null})})}make(t){if(t.initialized)if(this._workerQueue.length){let n=this._workerQueue.pop();this._source.set(this._sourceId,t);let s=t._projection.id===zs.id||t._projection.id===_n.id?1:0,o=new Float64Array([this._sourceId,s,t.planet.terrain.gridSizeByZoom[t.tileZoom],t.planet.terrain.plainGridSize,t._extent.southWest.lon,t._extent.southWest.lat,t._extent.northEast.lon,t._extent.northEast.lat,t.planet.ellipsoid._e2,t.planet.ellipsoid.equatorialSize,t.planet.ellipsoid._invRadii2.x,t.planet.ellipsoid._invRadii2.y,t.planet.ellipsoid._invRadii2.z,t.planet._heightFactor]);this._sourceId++,n.postMessage({params:o},[o.buffer])}else this._pendingQueue.push(t);else this.check()}}const Ma=`(function(){"use strict";function H(r,e){return function(z,b){let v=0,N=z.length-1;for(;v<=N;){let n=Math.floor(.5*(v+N));if(Math.abs(z[n]-b)<.001)return n;z[n]<b?v=n+1:N=n-1}return-1}(r,e)!==-1}var y=function(r,e,z){this.x=r,this.y=e,this.z=z},Y=function(r,e,z){let b=r.x,v=r.y,N=r.z;var n;b>=0?(n=65536*Math.floor(b/65536),e.x=Math.fround(n),z.x=Math.fround(b-n)):(n=65536*Math.floor(-b/65536),e.x=Math.fround(-n),z.x=Math.fround(b+n)),v>=0?(n=65536*Math.floor(v/65536),e.y=Math.fround(n),z.y=Math.fround(v-n)):(n=65536*Math.floor(-v/65536),e.y=Math.fround(-n),z.y=Math.fround(v+n)),N>=0?(n=65536*Math.floor(N/65536),e.z=Math.fround(n),z.z=Math.fround(N-n)):(n=65536*Math.floor(-N/65536),e.z=Math.fround(-n),z.z=Math.fround(N+n))};y.prototype.sub=function(r){return new y(this.x-r.x,this.y-r.y,this.z-r.z)},y.prototype.add=function(r){return new y(this.x+r.x,this.y+r.y,this.z+r.z)},y.prototype.cross=function(r){return new y(this.y*r.z-this.z*r.y,this.z*r.x-this.x*r.z,this.x*r.y-this.y*r.x)},y.prototype.normalize=function(r){var e=this.x,z=this.y,b=this.z,v=1/Math.sqrt(e*e+z*z+b*b);return this.x=e*v,this.y=z*v,this.z=b*v,this},y.prototype.distance=function(r){return this.sub(r).length()},y.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)};var x=new y(0,0,0),i=new y(0,0,0),t=new y(0,0,0);self.onmessage=function(r){var e=r.data.elevations,z=r.data.this_plainVertices,b=r.data.this_plainNormals,v=r.data.this_normalMapVertices,N=r.data.this_normalMapNormals,n=r.data.heightFactor,Dr=r.data.gridSize,D=r.data.noDataValues,Hr=r.data.id,Q=549755748352,W=-549755748352,T=549755748352,$=-549755748352,Z=549755748352,X=-549755748352;const J=Math.sqrt(e.length)-1,K=J+1,R=K*K,C=Dr,vr=J/C,L=C+1,tr=n;var a,d,p,m,yr,sr,S=0,xr=0,U=L*L*3,h=new Float64Array(U),j=new Float32Array(U),k=new Float32Array(U),lr=new Uint8Array(L*L),u=v,g=N;if(J>=C){a=new Float32Array(3*R),d=new Float64Array(3*R),p=new Float32Array(3*R),m=new Float32Array(3*R);for(let f=0;f<R;f++){var Ar=f%K,Fr=~~(f/K),ur=f,o=3*ur,rr=e[ur];H(D,rr)&&(rr=0);var Mr=tr*rr,s=new y(u[o]+Mr*g[o],u[o+1]+Mr*g[o+1],u[o+2]+Mr*g[o+2]);if(Y(s,i,t),d[o]=s.x,d[o+1]=s.y,d[o+2]=s.z,p[o]=i.x,p[o+1]=i.y,p[o+2]=i.z,m[o]=t.x,m[o+1]=t.y,m[o+2]=t.z,Fr%vr==0&&Ar%vr==0){let A=new y(u[o],u[o+1],u[o+2]),V=new y(u[o+3],u[o+4],u[o+5]),F=e[ur+1];H(D,F)&&(F=0);let q=!1;if(D.length===0){let _=A.distance(V);q=Math.abs(rr-F)/_>10||rr<-5e3}q?lr[xr]=1:(lr[xr]=0,s.x<Q&&(Q=s.x),s.x>W&&(W=s.x),s.y<T&&(T=s.y),s.y>$&&($=s.y),s.z<Z&&(Z=s.z),s.z>X&&(X=s.z)),j[S]=i.x,k[S]=t.x,h[S++]=s.x,j[S]=i.y,k[S]=t.y,h[S++]=s.y,j[S]=i.z,k[S]=t.z,h[S++]=s.z,xr++}if(Fr!==J&&Ar!==J){var gr=f+1,M=3*gr,B=e[gr];H(D,B)&&(B=0);var cr=tr*B,ar=new y(u[M]+cr*g[M],u[M+1]+cr*g[M+1],u[M+2]+cr*g[M+2]);Y(ar,i,t),d[M]=ar.x,d[M+1]=ar.y,d[M+2]=ar.z,p[M]=i.x,p[M+1]=i.y,p[M+2]=i.z,m[M]=t.x,m[M+1]=t.y,m[M+2]=t.z;var Vr=f+K,c=3*Vr;H(D,B=e[Vr])&&(B=0);var wr=tr*B,nr=new y(u[c]+wr*g[c],u[c+1]+wr*g[c+1],u[c+2]+wr*g[c+2]);Y(nr,i,t),d[c]=nr.x,d[c+1]=nr.y,d[c+2]=nr.z,p[c]=i.x,p[c+1]=i.y,p[c+2]=i.z,m[c]=t.x,m[c+1]=t.y,m[c+2]=t.z;var qr=f+K+1,w=3*qr;H(D,B=e[qr])&&(B=0);var dr=tr*B,er=new y(u[w]+dr*g[w],u[w+1]+dr*g[w+1],u[w+2]+dr*g[w+2]);Y(er,i,t),d[w]=er.x,d[w+1]=er.y,d[w+2]=er.z,p[w]=i.x,p[w+1]=i.y,p[w+2]=i.z,m[w]=t.x,m[w+1]=t.y,m[w+2]=t.z;var Lr=ar.sub(s),Sr=nr.sub(s),Nr=er.sub(s),hr=Sr.cross(Nr).normalize(),zr=Nr.cross(Lr).normalize(),O=zr.add(hr).normalize();a[o]+=O.x,a[o+1]+=O.y,a[o+2]+=O.z,a[M]+=zr.x,a[M+1]+=zr.y,a[M+2]+=zr.z,a[c]+=hr.x,a[c+1]+=hr.y,a[c+2]+=hr.z,a[w]+=O.x,a[w+1]+=O.y,a[w+2]+=O.z}}}else{a=new Float32Array(U),d=new Float64Array(U),p=new Float32Array(U),m=new Float32Array(U),a=new Float32Array(U);var E=C/J,_r=U/3,pr=J+1;for(let f=0;f<_r;f++){let A=Math.floor(f/L),V=f%L,F=A%E,q=V%E,_=Math.floor(A/E)*pr+Math.floor(V/E);V===C&&(_-=1,q=E),A===C&&(_-=pr,F=E);let mr=_+1,fr=_+pr,br=fr+1,or=e[_],ir=e[mr],P=e[fr],G=e[br];H(D,or)&&(or=0),H(D,ir)&&(ir=0),H(D,P)&&(P=0),H(D,G)&&(G=0);let I=or*(1-(yr=q/E))*(1-(sr=F/E))+ir*yr*(1-sr)+P*(1-yr)*sr+G*yr*sr,l=3*f;x.x=z[l]+I*b[l],x.y=z[l+1]+I*b[l+1],x.z=z[l+2]+I*b[l+2],Y(x,i,t),h[l]=x.x,h[l+1]=x.y,h[l+2]=x.z,j[l]=i.x,j[l+1]=i.y,j[l+2]=i.z,k[l]=t.x,k[l+1]=t.y,k[l+2]=t.z,x.x<Q&&(Q=x.x),x.x>W&&(W=x.x),x.y<T&&(T=x.y),x.y>$&&($=x.y),x.z<Z&&(Z=x.z),x.z>X&&(X=x.z)}d.set(h),p.set(j),m.set(k);for(let f=0;f<_r;f++)if(~~(f/L)!==C&&f%L!==C){let A=3*f,V=A+3,F=A+3*L,q=F+3,_=new y(h[A],h[A+1],h[A+2]),mr=new y(h[V],h[V+1],h[V+2]),fr=new y(h[F],h[F+1],h[F+2]),br=new y(h[q],h[q+1],h[q+2]),or=mr.sub(_).normalize(),ir=fr.sub(_).normalize(),P=br.sub(_).normalize(),G=ir.cross(P).normalize(),I=P.cross(or).normalize(),l=I.add(G).normalize();a[A]+=l.x,a[A+1]+=l.y,a[A+2]+=l.z,a[V]+=I.x,a[V+1]+=I.y,a[V+2]+=I.z,a[F]+=G.x,a[F+1]+=G.y,a[F+2]+=G.z,a[q]+=l.x,a[q+1]+=l.y,a[q+2]+=l.z}}self.postMessage({id:Hr,normalMapNormals:a,normalMapVertices:d,normalMapVerticesHigh:p,normalMapVerticesLow:m,terrainVertices:h,terrainVerticesHigh:j,terrainVerticesLow:k,noDataVertices:lr,bounds:[Q,T,Z,W,$,X]},[a.buffer,d.buffer,p.buffer,m.buffer,h.buffer,j.buffer,k.buffer,lr.buffer])}})();
//# sourceMappingURL=TerrainWorker.worker-DmikdfB2.js.map
`,uo=typeof self<"u"&&self.Blob&&new Blob([Ma],{type:"text/javascript;charset=utf-8"});function ec(l){let t;try{if(t=uo&&(self.URL||self.webkitURL).createObjectURL(uo),!t)throw"";const n=new Worker(t,{name:l==null?void 0:l.name});return n.addEventListener("error",()=>{(self.URL||self.webkitURL).revokeObjectURL(t)}),n}catch{return new Worker("data:text/javascript;charset=utf-8,"+encodeURIComponent(Ma),{name:l==null?void 0:l.name})}finally{t&&(self.URL||self.webkitURL).revokeObjectURL(t)}}class ic extends en{constructor(t=2){super(t,ec)}_onMessage(t){this._source.get(t.data.id).segment._terrainWorkerCallback(t.data),this._source.delete(t.data.id),t.data.normalMapNormals=null,t.data.normalMapVertices=null,t.data.normalMapVerticesHigh=null,t.data.normalMapVerticesLow=null,t.data.terrainVertices=null,t.data.terrainVerticesHigh=null,t.data.terrainVerticesLow=null}make(t){if(t.segment.plainReady&&t.segment.terrainIsLoading)if(this._workerQueue.length){const n=this._workerQueue.pop();this._source.set(this._sourceId,t);let s=t.segment;n.postMessage({elevations:t.elevations,this_plainVertices:s.plainVertices,this_plainNormals:s.plainNormals,this_normalMapVertices:s.normalMapVertices,this_normalMapNormals:s.normalMapNormals,heightFactor:s.planet._heightFactor,gridSize:s.planet.terrain.gridSizeByZoom[s.tileZoom],noDataValues:s.planet.terrain.noDataValues,id:this._sourceId},[t.elevations.buffer,s.plainVertices.buffer,s.plainNormals.buffer,s.normalMapVertices.buffer,s.normalMapNormals.buffer]),this._sourceId++}else this._pendingQueue.push(t);else this.check()}}let Ne=new Float32Array(2);class sc{constructor(t,n=256,s=256){this._width=n,this._height=s,this._planet=t,this._framebuffer=null,this._queue=[],this._handler=null}init(){this._handler=this._planet.renderer.handler,this._handler.programs.vectorTileLineRasterization||this._handler.addProgram(new X("vectorTileLineRasterization",{uniforms:{viewport:"vec2",thicknessOutline:"float",alpha:"float",extentParamsHigh:"vec4",extentParamsLow:"vec4"},attributes:{prevHigh:"vec2",currentHigh:"vec2",nextHigh:"vec2",prevLow:"vec2",currentLow:"vec2",nextLow:"vec2",order:"float",color:"vec4",thickness:"float"},vertexShader:`attribute vec2 prevHigh;
                attribute vec2 currentHigh;
                attribute vec2 nextHigh;

                attribute vec2 prevLow;
                attribute vec2 currentLow;
                attribute vec2 nextLow;

                attribute float order;
                attribute float thickness;
                attribute vec4 color;
                uniform float thicknessOutline;
                uniform vec2 viewport;
                uniform vec4 extentParamsHigh;
                uniform vec4 extentParamsLow;
                varying vec4 vColor;
                
                vec2 proj(vec2 coordHigh, vec2 coordLow) {
                    vec2 highDiff = coordHigh - extentParamsHigh.xy;
                    vec2 lowDiff = coordLow - extentParamsLow.xy;                    
                    return vec2(-1.0 + (highDiff * step(1.0, length(highDiff)) + lowDiff) * extentParamsHigh.zw) * vec2(1.0, -1.0);
                }
                
                void main(){
                    vColor = color;

                    vec2 vNext = proj(nextHigh, nextLow),
                         vCurrent = proj(currentHigh, currentLow),
                         vPrev = proj(prevHigh, prevLow);

                    vec2 _next = vNext;
                    vec2 _prev = vPrev;
                    vec2 _current = vCurrent;

                    if(_prev == _current){
                        if(_next == _current){
                            _next = _current + vec2(1.0, 0.0);
                            _prev = _current - _next;
                        }else{
                            _prev = _current + normalize(_current - _next);
                        }
                    }

                    if(_next == _current){
                        _next = _current + normalize(_current - _prev);
                    }

                    vec2 sNext = _next;
                    vec2 sCurrent = _current;
                    vec2 sPrev = _prev;
                    
                    vec2 dirNext = normalize(sNext - sCurrent);
                    vec2 dirPrev = normalize(sPrev - sCurrent);
                    float dotNP = dot(dirNext, dirPrev);
                    
                    vec2 normalNext = normalize(vec2(-dirNext.y, dirNext.x));
                    vec2 normalPrev = normalize(vec2(dirPrev.y, -dirPrev.x));
                    vec2 d = (thickness + thicknessOutline) * 0.5 * sign(order) / viewport;
                    
                    vec2 m;
                    if(dotNP >= 0.99991){
                        m = sCurrent - normalPrev * d;
                    }else{
                        vec2 dir = normalPrev + normalNext;
                        m = sCurrent + dir * d / (dirNext.x * dir.y - dirNext.y * dir.x);
                        
                        if( dotNP > 0.5 && dot(dirNext + dirPrev, m - sCurrent) < 0.0 ){
                            float occw = order * sign(dirNext.x * dirPrev.y - dirNext.y * dirPrev.x);
                            if(occw == -1.0){
                                m = sCurrent + normalPrev * d;
                            }else if(occw == 1.0){
                                m = sCurrent + normalNext * d;
                            }else if(occw == -2.0){
                                m = sCurrent + normalNext * d;
                            }else if(occw == 2.0){
                                m = sCurrent + normalPrev * d;
                            }
                        }else if(distance(sCurrent, m) > min(distance(sCurrent, sNext), distance(sCurrent, sPrev))){
                            m = sCurrent + normalNext * d;
                        }
                    }
                    gl_Position = vec4(m.x, m.y, 0.0, 1.0);
                }`,fragmentShader:`precision highp float;
                uniform float alpha;
                varying vec4 vColor;
                void main() {
                    gl_FragColor = vec4(vColor.rgb, alpha * vColor.a);
                }`})),this._handler.programs.vectorTilePolygonRasterization||this._handler.addProgram(new X("vectorTilePolygonRasterization",{uniforms:{extentParamsHigh:"vec4",extentParamsLow:"vec4"},attributes:{coordinatesHigh:"vec2",coordinatesLow:"vec2",colors:"vec4"},vertexShader:`attribute vec2 coordinatesHigh;
                attribute vec2 coordinatesLow; 
                attribute vec4 colors; 
                uniform vec4 extentParamsHigh; 
                uniform vec4 extentParamsLow; 
                varying vec4 color;

                vec2 proj(vec2 coordHigh, vec2 coordLow) {
                    vec2 highDiff = coordHigh - extentParamsHigh.xy;
                    vec2 lowDiff = coordLow - extentParamsLow.xy;
                    return vec2(-1.0 + (highDiff * step(1.0, length(highDiff)) + lowDiff) * extentParamsHigh.zw) * vec2(1.0, -1.0);
                }

                void main() { 
                    color = colors;
                    gl_Position = vec4(proj(coordinatesHigh, coordinatesLow), 0.0, 1.0); 
                }`,fragmentShader:`precision highp float;
                varying vec4 color;
                void main () {  
                    gl_FragColor = color; 
                }`})),this._framebuffer=new Rt(this._handler,{width:this._width,height:this._height,useDepth:!1}),this._framebuffer.init()}frame(){if(this._planet.layerLock.isFree()&&this._queue.length){let t=this._handler,n=t.gl;n.disable(n.CULL_FACE),n.disable(n.DEPTH_TEST);let s=t.programs.vectorTileLineRasterization,o=t.programs.vectorTilePolygonRasterization,a=this._width,h=this._height,c=a,u=h,d=c<<1,f=u<<1,g=new Float32Array(4),_=new Float32Array(4),m=this._framebuffer.activate(),p=0,x=window.performance.now();for(;this._queue.length&&p<25;){let y=this._queue.shift();if(y.isLoading&&y.segment.node.getState()===1){let T=y.layer._pickingEnabled;y.segment.tileZoom<4?(c=d,u=f):(c=a,u=h);let S=y._updateTexture||t.createEmptyTexture_l(c,u),C=T?y._updatePickingMask||t.createEmptyTexture_n(c,u):null;y.applyTexture(S,C),m.setSize(c,u),m.bindOutputTexture(S),n.clearColor(0,0,0,0),n.clear(n.COLOR_BUFFER_BIT);let P=y.segment.getExtentMerc();ae(P.southWest.lon,Ne),g[0]=Ne[0],_[0]=Ne[1],ae(P.southWest.lat,Ne),g[1]=Ne[0],_[1]=Ne[1],g[2]=2/P.getWidth(),g[3]=2/P.getHeight(),o.activate();let w=o._program,I=w.attributes,O=w.uniforms,N=y.layer._geometryHandler;n.uniform4fv(O.extentParamsHigh,g),n.uniform4fv(O.extentParamsLow,_),n.bindBuffer(n.ARRAY_BUFFER,N._polyVerticesHighBufferMerc),n.vertexAttribPointer(I.coordinatesHigh,N._polyVerticesHighBufferMerc.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,N._polyVerticesLowBufferMerc),n.vertexAttribPointer(I.coordinatesLow,N._polyVerticesLowBufferMerc.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,N._polyColorsBuffer),n.vertexAttribPointer(I.colors,N._polyColorsBuffer.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,N._polyIndexesBuffer),n.drawElements(n.TRIANGLES,N._polyIndexesBuffer.numItems,n.UNSIGNED_INT,0),T&&(m.bindOutputTexture(C),n.clearColor(0,0,0,0),n.clear(n.COLOR_BUFFER_BIT),n.bindBuffer(n.ARRAY_BUFFER,N._polyPickingColorsBuffer),n.vertexAttribPointer(I.colors,N._polyPickingColorsBuffer.itemSize,n.FLOAT,!1,0,0),n.drawElements(n.TRIANGLES,N._polyIndexesBuffer.numItems,n.UNSIGNED_INT,0)),m.bindOutputTexture(S),s.activate(),w=s._program,I=w.attributes,O=w.uniforms,n.uniform2fv(O.viewport,[c,u]),n.uniform4fv(O.extentParamsHigh,g),n.uniform4fv(O.extentParamsLow,_);let k=N._lineVerticesHighBufferMerc;n.bindBuffer(n.ARRAY_BUFFER,k),n.vertexAttribPointer(I.prevHigh,k.itemSize,n.FLOAT,!1,8,0),n.vertexAttribPointer(I.currentHigh,k.itemSize,n.FLOAT,!1,8,32),n.vertexAttribPointer(I.nextHigh,k.itemSize,n.FLOAT,!1,8,64),k=N._lineVerticesLowBufferMerc,n.bindBuffer(n.ARRAY_BUFFER,k),n.vertexAttribPointer(I.prevLow,k.itemSize,n.FLOAT,!1,8,0),n.vertexAttribPointer(I.currentLow,k.itemSize,n.FLOAT,!1,8,32),n.vertexAttribPointer(I.nextLow,k.itemSize,n.FLOAT,!1,8,64),n.bindBuffer(n.ARRAY_BUFFER,N._lineOrdersBuffer),n.vertexAttribPointer(I.order,N._lineOrdersBuffer.itemSize,n.FLOAT,!1,4,0),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,N._lineIndexesBuffer),n.bindBuffer(n.ARRAY_BUFFER,N._lineStrokesBuffer),n.vertexAttribPointer(I.thickness,N._lineStrokesBuffer.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,N._lineStrokeColorsBuffer),n.vertexAttribPointer(I.color,N._lineStrokeColorsBuffer.itemSize,n.FLOAT,!1,0,0),n.uniform1f(O.thicknessOutline,2),n.uniform1f(O.alpha,.54),n.drawElements(n.TRIANGLE_STRIP,N._lineIndexesBuffer.numItems,n.UNSIGNED_INT,0),n.uniform1f(O.thicknessOutline,1),n.uniform1f(O.alpha,1),n.drawElements(n.TRIANGLE_STRIP,N._lineIndexesBuffer.numItems,n.UNSIGNED_INT,0),n.bindBuffer(n.ARRAY_BUFFER,N._lineThicknessBuffer),n.vertexAttribPointer(I.thickness,N._lineThicknessBuffer.itemSize,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,N._lineColorsBuffer),n.vertexAttribPointer(I.color,N._lineColorsBuffer.itemSize,n.FLOAT,!1,0,0),n.uniform1f(O.thicknessOutline,2),n.uniform1f(O.alpha,.54),n.drawElements(n.TRIANGLE_STRIP,N._lineIndexesBuffer.numItems,n.UNSIGNED_INT,0),n.uniform1f(O.thicknessOutline,1),n.uniform1f(O.alpha,1),n.drawElements(n.TRIANGLE_STRIP,N._lineIndexesBuffer.numItems,n.UNSIGNED_INT,0),T&&(m.bindOutputTexture(C),n.uniform1f(O.thicknessOutline,8),n.bindBuffer(n.ARRAY_BUFFER,N._linePickingColorsBuffer),n.vertexAttribPointer(I.color,N._linePickingColorsBuffer.itemSize,n.FLOAT,!1,0,0),n.drawElements(n.TRIANGLE_STRIP,N._lineIndexesBuffer.numItems,n.UNSIGNED_INT,0))}else y.isLoading=!1;p=window.performance.now()-x}n.enable(n.DEPTH_TEST),n.enable(n.CULL_FACE),m.deactivate()}}add(t){this._queue.push(t)}remove(t){}get queueSize(){return this._queue.length}}class Ri extends de{constructor(t={}){super(t.name),this._minDistanceBeforeMemClear=0,this._renderingFadingNodes=(c,u,d,f,g,_,m,p)=>{let x=_===0,y=this.terrain.equalizeVertices;for(let T=0,S=f._fadingNodes.length;T<S;T++){let C=f._fadingNodes[T].segment;c._fadingNodes.has(f._fadingNodes[0].__id)&&!u.has(C.node.__id)&&(u.set(C.node.__id,!0),C._transitionOpacity<1?m.push(C):x?(y&&C.equalize(),C.readyToEngage&&C.engage(),C.screenRendering(d,g,_),p.push(C)):C.screenRendering(d,g,_,this.transparentTexture,!0))}},this._renderingFadingNodesNoDepth=(c,u,d,f,g,_,m)=>{let p=_===0,x=this.terrain.equalizeVertices,y=d.gl;y.disable(y.DEPTH_TEST);for(let T=0,S=f._fadingNodes.length;T<S;T++){let C=f._fadingNodes[T].segment;c._fadingNodes.has(f._fadingNodes[0].__id)&&!u.has(C.node.__id)&&(u.set(C.node.__id,!0),p?(x&&C.equalize(),C.readyToEngage&&C.engage(),C.screenRendering(d,g,_),m.push(C)):C.screenRendering(d,g,_,this.transparentTexture,!0))}y.enable(y.DEPTH_TEST)},this._createdNodesCount=0,this.transitionTime=580,this.ellipsoid=t.ellipsoid||So,this._atmosphere=new Uh(t.atmosphereParameters),this.lightEnabled=!0,this._planetRadius2=(this.ellipsoid.getPolarSize()-1e4)*(this.ellipsoid.getPolarSize()-1e4),this._layers=[],this._updateLayers=!1,this.visibleTileLayers=[],this.visibleVectorLayers=[],this._visibleVectorLayersByDepthOrder=[],this._visibleTileLayerSlices=[],this._visibleEntityCollections=[[]],this.baseLayer=null,this.terrain=null,this.camera=new wa(this,{frustums:t.frustums,eye:new v(25e6,0,0),look:v.ZERO,up:v.NORTH,minAltitude:t.minAltitude,maxAltitude:t.maxAltitude}),this.mousePositionOnEarth=new v,this.emptyTexture=null,this.transparentTexture=null,this.defaultTexture=null,this._initialViewExtent=null,this.layerLock=new zr,this.terrainLock=new zr,this._heightFactor=1,this._indexesCache=[],this._indexesCacheToRemove=[],this._indexesCacheToRemoveCounter=0,this._textureCoordsBufferCache=[];const n={planet:this,maxEqualZoomAltitude:t.maxEqualZoomAltitude,minEqualZoomAltitude:t.minEqualZoomAltitude,minEqualZoomCameraSlope:t.minEqualZoomCameraSlope,transitionOpacityEnabled:t.transitionOpacityEnabled};this.quadTreeStrategyPrototype=t.quadTreeStrategyPrototype||La,this.quadTreeStrategy=new this.quadTreeStrategyPrototype(n),this._nightTexture=null,this._specularTexture=null;let s=jt(t.ambient,new v(.2,.2,.3)),o=jt(t.diffuse,new v(1,1,1)),a=jt(t.specular,new v(63e-5,55e-5,32e-5)),h=t.shininess||18;this._ambient=new Float32Array([s.x,s.y,s.z]),this._diffuse=new Float32Array([o.x,o.y,o.z]),this._specular=new Float32Array([a.x,a.y,a.z,h]),this._maxGridSize=Math.log2(t.maxGridSize||256),this.SLICE_SIZE=4,this.SLICE_SIZE_4=4*this.SLICE_SIZE,this.SLICE_SIZE_3=3*this.SLICE_SIZE,this._maxNodes=t.maxNodesCount||200,this._pickingColorArr=new Float32Array(this.SLICE_SIZE_4),this._samplerArr=new Int32Array(this.SLICE_SIZE),this._pickingMaskArr=new Int32Array(this.SLICE_SIZE),this._geoImageCreator=new Zh(this),this._vectorTileCreator=new sc(this,t.vectorTileSize,t.vectorTileSize),this._normalMapCreator=new Qh(this),this._terrainWorker=new ic(3),this._plainSegmentWorker=new tc(3),this._tileLoader=new Sa(t.maxLoadingRequests||12),this._memKey=new Me,this.events=lt(rc),this._distBeforeMemClear=0,this._prevCamEye=new v,this._initialized=!1,this._collectRenderNodesIsActive=!0,this.nightTextureCoefficient=2,this._renderScreenNodesPASS=this._renderScreenNodesPASSNoAtmos,this._renderScreenNodesWithHeightPASS=this._renderScreenNodesWithHeightPASSNoAtmos,this._atmosphereEnabled=t.atmosphereEnabled||!1,this._atmosphereMaxMinOpacity=new Float32Array([.95,.28]),this.solidTextureOne=null,this.solidTextureTwo=null,this._nightTextureSrc=t.nightTextureSrc||null,this._specularTextureSrc=t.specularTextureSrc||null,this._transparentBackground=t.transparentBackground||!1}get terrainReady(){return this.quadTreeStrategy.terrainReady}get maxGridSize(){return this._maxGridSize}getNorthFrameRotation(t){return this.getFrameRotation(t)}getFrameRotation(t){return this.ellipsoid.getNorthFrameRotation(t)}set atmosphereMaxOpacity(t){this._atmosphereMaxMinOpacity[0]=t}get atmosphereMaxOpacity(){return this._atmosphereMaxMinOpacity[0]}set atmosphereMinOpacity(t){this._atmosphereMaxMinOpacity[1]=t}get atmosphereMinOpacity(){return this._atmosphereMaxMinOpacity[1]}set atmosphereEnabled(t){t!=this._atmosphereEnabled&&(this._atmosphereEnabled=t,this._initializeAtmosphere())}get atmosphereEnabled(){return this._atmosphereEnabled}set diffuse(t){let n=jt(t);this._diffuse=new Float32Array(n.toArray())}set ambient(t){let n=jt(t);this._ambient=new Float32Array(n.toArray())}set specular(t){let n=jt(t);this._specular=new Float32Array([n.x,n.y,n.y,this._specular[3]])}set shininess(t){this._specular[3]=t}get normalMapCreator(){return this._normalMapCreator}get layers(){return[...this._layers]}get sun(){if(this.renderer&&this.renderer.controls.sun)return this.renderer.controls.sun}get sunPos(){return this.sun.sunlight.getPosition()}addControl(t){t.planet=this,t.addTo(this.renderer)}addControls(t){for(let n=0;n<t.length;n++)this.addControl(t[n])}getLayerByName(t){for(let n=0,s=this._layers.length;n<s;n++)if(t===this._layers[n].name)return this._layers[n]}addLayer(t){t.addTo(this)}_onLayerVisibilityChanged(t){this.events.dispatch(this.events.layervisibilitychange,t)}addLayers(t){for(let n=0,s=t.length;n<s;n++)this.addLayer(t[n])}removeLayer(t){t.remove()}_clearLayerMaterial(t){this.quadTreeStrategy.clearLayerMaterial(t)}setBaseLayer(t){this.baseLayer?this.baseLayer.isEqual(t)||(this.baseLayer.setVisibility(!1),this.baseLayer=t,t.setVisibility(!0),this.events.dispatch(this.events.baselayerchange,t)):(this.baseLayer=t,this.baseLayer.setVisibility(!0),this.events.dispatch(this.events.baselayerchange,t))}setHeightFactor(t){this._heightFactor!==t&&(this._heightFactor=t,this.quadTreeStrategy.destroyBranches(),this.quadTreeStrategy.clearRenderedNodes())}getHeightFactor(){return this._heightFactor}setTerrain(t){this._initialized&&this.memClear(),this.terrain&&(this.terrain.abortLoading(),this.terrain.clearCache(),this.terrain._planet=null),this.terrain=t,this.terrain._planet=this,this.quadTreeStrategy.destroyBranches(),t._geoid.model?(this._plainSegmentWorker.setGeoid(t.getGeoid()),t._isReady=!0):Pa.loadModel(t.geoid.src).then(n=>{t.geoid.setModel(n),this._plainSegmentWorker.setGeoid(t.getGeoid()),t._isReady=!0}).catch(n=>{console.warn(n)})}initAtmosphereShader(t){if(this.renderer&&this.renderer.handler&&this._atmosphereEnabled){let n=this.renderer.handler;n.isWebGl2()?(n.removeProgram("drawnode_screen_wl"),n.addProgram(lo(t))):console.warn("Atmosphere WebGL2 only")}}get atmosphereControl(){return this._atmosphere}_initializeAtmosphere(){if(!this.renderer)return;let t=this.renderer.handler;t.removeProgram("drawnode_screen_wl"),this._atmosphereEnabled?(this._renderScreenNodesPASS=this._renderScreenNodesPASSAtmos,this._renderScreenNodesWithHeightPASS=this._renderScreenNodesWithHeightPASSAtmos,this.renderer.controls.Atmosphere||this.addControl(this._atmosphere),this._atmosphere.activate(),t.isWebGl2()?t.addProgram(lo(this._atmosphere.parameters)):t.addProgram(ao()),this._transparentBackground||this.renderer.controls.SimpleSkyBackground&&this.renderer.controls.SimpleSkyBackground.deactivate()):(this._renderScreenNodesPASS=this._renderScreenNodesPASSNoAtmos,this._renderScreenNodesWithHeightPASS=this._renderScreenNodesWithHeightPASSNoAtmos,this._atmosphere.deactivate(),this._transparentBackground||(this.renderer.controls.SimpleSkyBackground?this.renderer.controls.SimpleSkyBackground.activate():this.addControl(new ga)),t.isWebGl2()?t.addProgram(new X("drawnode_screen_wl",{uniforms:{projectionMatrix:"mat4",viewMatrix:"mat4",eyePositionHigh:"vec3",eyePositionLow:"vec3",height:"float",uGlobalTextureCoord:"vec4",uNormalMapBias:"vec3",samplerCount:"int",tileOffsetArr:"vec4",layerOpacityArr:"float",samplerArr:"sampler2darray",defaultTexture:"sampler2d",uNormalMap:"sampler2d",nightTexture:"sampler2d",specularTexture:"sampler2d",lightPosition:"vec3",diffuse:"vec3",ambient:"vec3",specular:"vec4",camHeight:"float",nightTextureCoefficient:"float",transitionOpacity:"float"},attributes:{aVertexPositionHigh:"vec3",aVertexPositionLow:"vec3",aTextureCoord:"vec2"},vertexShader:`#version 300 es
precision highp float;in vec3 aVertexPositionHigh;in vec3 aVertexPositionLow;in vec2 aTextureCoord;uniform mat4 projectionMatrix;uniform mat4 viewMatrix;uniform vec4 uGlobalTextureCoord;uniform vec3 uNormalMapBias;uniform vec3 eyePositionHigh;uniform vec3 eyePositionLow;uniform float height;out vec4 vTextureCoord;out vec3 v_vertex;out vec3 cameraPosition;out vec2 vGlobalTextureCoord;out float v_height;void main(void){vec3 aVertexPosition=aVertexPositionHigh+aVertexPositionLow;vec3 nh=height*normalize(aVertexPosition);vTextureCoord.xy=aTextureCoord;vGlobalTextureCoord=uGlobalTextureCoord.xy+(uGlobalTextureCoord.zw-uGlobalTextureCoord.xy)*aTextureCoord;vTextureCoord.zw=uNormalMapBias.z*(aTextureCoord+uNormalMapBias.xy);cameraPosition=eyePositionHigh+eyePositionLow;vec3 highDiff=aVertexPositionHigh-eyePositionHigh;vec3 lowDiff=aVertexPositionLow-eyePositionLow+nh;mat4 viewMatrixRTE=viewMatrix;viewMatrixRTE[3]=vec4(0.0,0.0,0.0,1.0);v_height=height;v_vertex=aVertexPosition+nh;gl_Position=projectionMatrix*viewMatrixRTE*vec4(highDiff*step(1.0,length(highDiff))+lowDiff,1.0);}`,fragmentShader:`#version 300 es
precision highp float;float getLerpValue(in float min,in float max,in float between){return(clamp(between,min,max)-min)/(max-min);}vec3 aces(vec3 color){float a=2.51;float b=0.03;float c=2.43;float d=0.59;float e=0.14;return clamp((color*(a*color+b))/(color*(c*color+d)+e),0.0,1.0);}bool intersectSphere(vec3 rayOrigin,vec3 rayDirection,float radius,inout float t1,inout float t2){float b=dot(rayDirection,rayOrigin);float c=dot(rayOrigin,rayOrigin)-radius*radius;float d=b*b-c;if(d<-1e-6){return false;}d=max(d,0.0);t1=-b-sqrt(d);t2=-b+sqrt(d);if(t2<0.0){return false;}return true;}bool intersectSphere(vec3 rayOrigin,vec3 rayDirection,float radius,inout float t){float b=dot(rayDirection,rayOrigin);float c=dot(rayOrigin,rayOrigin)-radius*radius;float d=b*b-c;if(d<0.0){return false;}t=-b-sqrt(d);return true;}float intersectSphere(vec3 ro,vec3 rd,vec4 sph){vec3 oc=ro-sph.xyz;float b=dot(oc,rd);float c=dot(oc,oc)-sph.w*sph.w;float h=b*b-c;if(h<0.0)return-1.0;h=sqrt(h);return-b-h;}bool intersectEllipsoid(in vec3 ro,in vec3 rd,in vec3 ra,inout float t){vec3 ocn=ro/ra;vec3 rdn=rd/ra;float a=dot(rdn,rdn);float b=dot(ocn,rdn);float c=dot(ocn,ocn);float h=b*b-a*(c-1.0);if(h<0.0){return false;}t=(-b-sqrt(h))/a;return true;}bool intersectEllipsoid(in vec3 ro,in vec3 rd,in vec3 ra,inout float t1,inout float t2){vec3 ocn=ro/ra;vec3 rdn=rd/ra;float a=dot(rdn,rdn);float b=dot(ocn,rdn);float c=dot(ocn,ocn);float h=b*b-a*(c-1.0);if(h<0.0){return false;}h=sqrt(h);t1=(-b-h)/a;t2=(-b+h)/a;return true;}vec3 normalEllipsoid(in vec3 pos,in vec3 ra){return normalize(pos/(ra*ra));}
#ifdef WEBGL2
#define TEXTURE_FUNC texture
#else
#define TEXTURE_FUNC texture2D
#endif
#define SLICE_SIZE 5
#define blend(DEST, SAMPLER, OFFSET, OPACITY) src = TEXTURE_FUNC(SAMPLER, OFFSET.xy + vTextureCoord.xy * OFFSET.zw); DEST = DEST * (1.0 - src.a * OPACITY) + src * OPACITY;
#define blendPicking(DEST, OFFSET, SAMPLER, MASK, COLOR, OPACITY) tc = OFFSET.xy + vTextureCoord.xy * OFFSET.zw; t = TEXTURE_FUNC(SAMPLER, tc); p = TEXTURE_FUNC(MASK, tc); DEST = mix(DEST, vec4(max(COLOR.rgb, p.rgb), OPACITY), (t.a == 0.0 ? 0.0: 1.0) * COLOR.a);
const vec3 nightStep=10.0*vec3(0.58,0.48,0.25);uniform vec4 specular;uniform vec3 diffuse;uniform vec3 ambient;uniform sampler2D uNormalMap;uniform sampler2D nightTexture;uniform sampler2D specularTexture;uniform sampler2D defaultTexture;uniform sampler2D samplerArr[SLICE_SIZE];uniform vec4 tileOffsetArr[SLICE_SIZE];uniform vec3 lightPosition;uniform float layerOpacityArr[SLICE_SIZE];uniform int samplerCount;uniform float nightTextureCoefficient;uniform float transitionOpacity;uniform float camHeight;in vec4 vTextureCoord;in vec3 v_vertex;in vec3 cameraPosition;in vec2 vGlobalTextureCoord;in float v_height;vec3 sunPos;layout(location=0)out vec4 diffuseColor;void main(void){sunPos=lightPosition;vec3 texNormal=texture(uNormalMap,vTextureCoord.zw).rgb;vec3 normal=normalize((texNormal-0.5)*2.0);float minH=1200000.0;float maxH=minH*3.0;float nightCoef=getLerpValue(minH,maxH,camHeight)*nightTextureCoefficient;vec3 lightDir=normalize(sunPos);vec3 viewDir=normalize(cameraPosition-v_vertex);float overGround=1.0-step(0.1,v_height);float shininess=texture(specularTexture,vGlobalTextureCoord.st).r*255.0*overGround;vec3 reflectionDirection=reflect(-lightDir,normal);float reflection=max(dot(reflectionDirection,viewDir),0.0);vec3 spec=specular.rgb*pow(reflection,specular.w)*shininess;float diffuseLightWeighting=max(dot(normal,lightDir),0.0);vec4 nightImageColor=texture(nightTexture,vGlobalTextureCoord.st);vec3 night=nightStep*(.18-diffuseLightWeighting*3.0)*nightImageColor.rgb*nightCoef;night*=overGround*step(0.0,night);vec4 lightWeighting=vec4(ambient+diffuse*diffuseLightWeighting+night,1.0);diffuseColor=texture(defaultTexture,vTextureCoord.xy);if(samplerCount==0){diffuseColor=diffuseColor*lightWeighting+vec4(spec,0.0);diffuseColor*=transitionOpacity;return;}vec4 src;blend(diffuseColor,samplerArr[0],tileOffsetArr[0],layerOpacityArr[0]);if(samplerCount==1){diffuseColor=diffuseColor*lightWeighting+vec4(spec,0.0);diffuseColor*=transitionOpacity;return;}blend(diffuseColor,samplerArr[1],tileOffsetArr[1],layerOpacityArr[1]);if(samplerCount==2){diffuseColor=diffuseColor*lightWeighting+vec4(spec,0.0);diffuseColor*=transitionOpacity;return;}blend(diffuseColor,samplerArr[2],tileOffsetArr[2],layerOpacityArr[2]);if(samplerCount==3){diffuseColor=diffuseColor*lightWeighting+vec4(spec,0.0);diffuseColor*=transitionOpacity;return;}blend(diffuseColor,samplerArr[3],tileOffsetArr[3],layerOpacityArr[3]);if(samplerCount==4){diffuseColor=diffuseColor*lightWeighting+vec4(spec,0.0);diffuseColor*=transitionOpacity;return;}blend(diffuseColor,samplerArr[4],tileOffsetArr[4],layerOpacityArr[4]);diffuseColor=diffuseColor*lightWeighting+vec4(spec,0.0);diffuseColor*=transitionOpacity;}`})):t.addProgram(ao()))}_initializeShaders(){if(!this.renderer)throw new Error("Renderer is not initialized");let t=this.renderer,n=t.handler;n.addProgram(new X("drawnode_screen_nl",{uniforms:{projectionMatrix:"mat4",viewMatrix:"mat4",eyePositionHigh:"vec3",eyePositionLow:"vec3",samplerCount:"int",tileOffsetArr:"vec4",layerOpacityArr:"float",samplerArr:"sampler2darray",defaultTexture:"sampler2d",height:"float"},attributes:{aVertexPositionHigh:"vec3",aVertexPositionLow:"vec3",aTextureCoord:"vec2"},vertexShader:"precision highp float;attribute vec3 aVertexPositionHigh;attribute vec3 aVertexPositionLow;attribute vec2 aTextureCoord;uniform mat4 projectionMatrix;uniform mat4 viewMatrix;uniform vec3 eyePositionHigh;uniform vec3 eyePositionLow;uniform float height;varying vec2 vTextureCoord;void main(void){vTextureCoord=aTextureCoord;vec3 nh=height*normalize(aVertexPositionHigh+aVertexPositionLow);mat4 viewMatrixRTE=viewMatrix;viewMatrixRTE[3]=vec4(0.0,0.0,0.0,1.0);mat4 m=projectionMatrix*viewMatrixRTE;vec3 highDiff=aVertexPositionHigh-eyePositionHigh;vec3 lowDiff=aVertexPositionLow-eyePositionLow+nh;gl_Position=m*vec4(highDiff*step(1.0,length(highDiff))+lowDiff,1.0);}",fragmentShader:`precision highp float;
#ifdef WEBGL2
#define TEXTURE_FUNC texture
#else
#define TEXTURE_FUNC texture2D
#endif
#define SLICE_SIZE 5
#define blend(DEST, SAMPLER, OFFSET, OPACITY) src = TEXTURE_FUNC(SAMPLER, OFFSET.xy + vTextureCoord.xy * OFFSET.zw); DEST = DEST * (1.0 - src.a * OPACITY) + src * OPACITY;
#define blendPicking(DEST, OFFSET, SAMPLER, MASK, COLOR, OPACITY) tc = OFFSET.xy + vTextureCoord.xy * OFFSET.zw; t = TEXTURE_FUNC(SAMPLER, tc); p = TEXTURE_FUNC(MASK, tc); DEST = mix(DEST, vec4(max(COLOR.rgb, p.rgb), OPACITY), (t.a == 0.0 ? 0.0: 1.0) * COLOR.a);
const vec3 nightStep=10.0*vec3(0.58,0.48,0.25);uniform vec4 tileOffsetArr[SLICE_SIZE];uniform float layerOpacityArr[SLICE_SIZE];uniform sampler2D defaultTexture;uniform sampler2D samplerArr[SLICE_SIZE];uniform int samplerCount;varying vec2 vTextureCoord;void main(void){gl_FragColor=texture2D(defaultTexture,vTextureCoord);if(samplerCount==0)return;vec4 src;blend(gl_FragColor,samplerArr[0],tileOffsetArr[0],layerOpacityArr[0]);if(samplerCount==1)return;blend(gl_FragColor,samplerArr[1],tileOffsetArr[1],layerOpacityArr[1]);if(samplerCount==2)return;blend(gl_FragColor,samplerArr[2],tileOffsetArr[2],layerOpacityArr[2]);if(samplerCount==3)return;blend(gl_FragColor,samplerArr[3],tileOffsetArr[3],layerOpacityArr[3]);if(samplerCount==4)return;blend(gl_FragColor,samplerArr[4],tileOffsetArr[4],layerOpacityArr[4]);}`})),n.addProgram(new X("drawnode_colorPicking",{uniforms:{projectionMatrix:"mat4",viewMatrix:"mat4",eyePositionHigh:"vec3",eyePositionLow:"vec3",samplerCount:"int",tileOffsetArr:"vec4",samplerArr:"sampler2darray",pickingMaskArr:"sampler2darray",pickingColorArr:"vec4",height:"float"},attributes:{aVertexPositionHigh:"vec3",aVertexPositionLow:"vec3",aTextureCoord:"vec2"},vertexShader:"precision highp float;attribute vec3 aVertexPositionHigh;attribute vec3 aVertexPositionLow;attribute vec2 aTextureCoord;uniform mat4 projectionMatrix;uniform mat4 viewMatrix;uniform vec3 eyePositionHigh;uniform vec3 eyePositionLow;uniform float height;varying vec2 vTextureCoord;void main(void){vTextureCoord=aTextureCoord;mat4 viewMatrixRTE=viewMatrix;viewMatrixRTE[3]=vec4(0.0,0.0,0.0,1.0);mat4 m=projectionMatrix*viewMatrixRTE;vec3 nh=height*normalize(aVertexPositionHigh+aVertexPositionLow);vec3 highDiff=aVertexPositionHigh-eyePositionHigh;vec3 lowDiff=aVertexPositionLow-eyePositionLow+nh;gl_Position=m*vec4(highDiff*step(1.0,length(highDiff))+lowDiff,1.0);}",fragmentShader:`precision highp float;
#ifdef WEBGL2
#define TEXTURE_FUNC texture
#else
#define TEXTURE_FUNC texture2D
#endif
#define SLICE_SIZE 5
#define blend(DEST, SAMPLER, OFFSET, OPACITY) src = TEXTURE_FUNC(SAMPLER, OFFSET.xy + vTextureCoord.xy * OFFSET.zw); DEST = DEST * (1.0 - src.a * OPACITY) + src * OPACITY;
#define blendPicking(DEST, OFFSET, SAMPLER, MASK, COLOR, OPACITY) tc = OFFSET.xy + vTextureCoord.xy * OFFSET.zw; t = TEXTURE_FUNC(SAMPLER, tc); p = TEXTURE_FUNC(MASK, tc); DEST = mix(DEST, vec4(max(COLOR.rgb, p.rgb), OPACITY), (t.a == 0.0 ? 0.0: 1.0) * COLOR.a);
const vec3 nightStep=10.0*vec3(0.58,0.48,0.25);uniform vec4 tileOffsetArr[SLICE_SIZE];uniform vec4 pickingColorArr[SLICE_SIZE];uniform sampler2D samplerArr[SLICE_SIZE];uniform sampler2D pickingMaskArr[SLICE_SIZE];uniform int samplerCount;varying vec2 vTextureCoord;void main(void){gl_FragColor=vec4(0.0);if(samplerCount==0)return;vec2 tc;vec4 t;vec4 p;blendPicking(gl_FragColor,tileOffsetArr[0],samplerArr[0],pickingMaskArr[0],pickingColorArr[0],1.0);if(samplerCount==1)return;blendPicking(gl_FragColor,tileOffsetArr[1],samplerArr[1],pickingMaskArr[1],pickingColorArr[1],1.0);if(samplerCount==2)return;blendPicking(gl_FragColor,tileOffsetArr[2],samplerArr[2],pickingMaskArr[2],pickingColorArr[2],1.0);if(samplerCount==3)return;blendPicking(gl_FragColor,tileOffsetArr[3],samplerArr[3],pickingMaskArr[3],pickingColorArr[3],1.0);if(samplerCount==4)return;blendPicking(gl_FragColor,tileOffsetArr[4],samplerArr[4],pickingMaskArr[4],pickingColorArr[4],1.0);}`})),n.addProgram(new X("drawnode_depth",{uniforms:{projectionMatrix:"mat4",viewMatrix:"mat4",height:"float",eyePositionHigh:"vec3",eyePositionLow:"vec3",frustumPickingColor:"float"},attributes:{aVertexPositionHigh:"vec3",aVertexPositionLow:"vec3"},vertexShader:`#version 300 es
precision highp float;in vec3 aVertexPositionHigh;in vec3 aVertexPositionLow;uniform mat4 projectionMatrix;uniform mat4 viewMatrix;uniform vec3 eyePositionHigh;uniform vec3 eyePositionLow;uniform float height;void main(void){mat4 viewMatrixRTE=viewMatrix;viewMatrixRTE[3]=vec4(0.0,0.0,0.0,1.0);mat4 m=projectionMatrix*viewMatrixRTE;vec3 nh=height*normalize(aVertexPositionHigh+aVertexPositionLow);vec3 eyePosition=eyePositionHigh+eyePositionLow;vec3 vertexPosition=aVertexPositionHigh+aVertexPositionLow;vec3 highDiff=aVertexPositionHigh-eyePositionHigh;vec3 lowDiff=aVertexPositionLow-eyePositionLow+nh;gl_Position=m*vec4(highDiff*step(1.0,length(highDiff))+lowDiff,1.0);}`,fragmentShader:`#version 300 es
precision highp float;uniform float frustumPickingColor;layout(location=0)out vec4 frustumColor;layout(location=1)out vec4 depthColor;void main(void){frustumColor=vec4(frustumPickingColor,frustumPickingColor,frustumPickingColor,1.0);depthColor=vec4(gl_FragCoord.z,gl_FragCoord.z,gl_FragCoord.z,1.0);}`})),t.addPickingCallback(this,this._renderColorPickingFramebufferPASS),t.addDepthCallback(this,()=>{this.renderDepthFramebuffer(this.camera,this.quadTreeStrategy)})}_onLayerLoadend(t){this.events.dispatch(this.events.layerloadend,t)}init(){this._tileLoader.events.on("layerloadend",this._onLayerLoadend,this),$i().setMaxGridSize(this._maxGridSize);const t=this._maxGridSize;let n=0;for(let o=0;o<=t;o++){!this._indexesCache[o]&&(this._indexesCache[o]=new Array(t));for(let a=0;a<=t;a++){!this._indexesCache[o][a]&&(this._indexesCache[o][a]=new Array(t));for(let h=0;h<=t;h++){!this._indexesCache[o][a][h]&&(this._indexesCache[o][a][h]=new Array(t));for(let c=0;c<=t;c++){!this._indexesCache[o][a][h][c]&&(this._indexesCache[o][a][h][c]=new Array(t));for(let u=0;u<=t;u++){let d={buffer:null};if(o>=1&&o===a&&o===h&&o===c&&o===u){let f=$i().createSegmentIndexes(o,[a,h,c,u]);d.buffer=this.renderer.handler.createElementArrayBuffer(f,1)}else this._indexesCacheToRemove[n++]=d;this._indexesCache[o][a][h][c][u]=d}}}}}this.renderer.events.on("drawtransparent",()=>{this._renderScreenNodesWithHeightPASS()}),this._textureCoordsBufferCache=[];let s=$i().initTextureCoordsTable(t+1);for(let o=0;o<=t;o++)this._textureCoordsBufferCache[o]=this.renderer.handler.createArrayBuffer(s[o],2,(1+(1<<o))*(1+(1<<o)));if(this.renderer.handler.createDefaultTexture(null,o=>{this.solidTextureOne=o,this.solidTextureTwo=o}),this.transparentTexture=this.renderer.handler.transparentTexture,this.drawMode=this.renderer.handler.gl.TRIANGLE_STRIP,this._initializeShaders(),this._initializeAtmosphere(),this._updateVisibleLayers(),this._nightTextureSrc){let o=new Image;o.crossOrigin="Anonymous",o.onload=()=>{this._nightTexture=this.renderer.handler.createTextureDefault(o),this._nightTexture.default=!0},o.src=this._nightTextureSrc}if(this._specularTextureSrc){let o=new Image;o.crossOrigin="Anonymous",o.onload=()=>{this._specularTexture=this.renderer.handler.createTextureDefault(o),this._specularTexture.default=!0},o.src=this._specularTextureSrc}this._geoImageCreator.init(),this._vectorTileCreator.init(),this._normalMapCreator.init(),this.renderer.events.on("draw",this._globalPreDraw,this,-100),this.quadTreeStrategy.init(this.camera),this.initLayers(),this._initialized=!0,this._initialViewExtent&&this.viewExtent(this._initialViewExtent),this.renderer.activeCamera=this.camera,this.camera.bindFrustumsPickingColors(this.renderer),this.camera.update()}initLayers(){let t=[...this._layers];for(let n=0;n<t.length;n++)this.removeLayer(t[n]),this.addLayer(t[n])}_clearIndexesCache(){this._indexesCacheToRemoveCounter=0;let t=this._indexesCacheToRemove,n=this.renderer.handler.gl;for(let s=0,o=t.length;s<o;s++){let a=t[s];n.deleteBuffer(a.buffer),a.buffer=null}}createDefaultTextures(t,n){this.renderer.handler.gl.deleteTexture(this.solidTextureOne),this.renderer.handler.gl.deleteTexture(this.solidTextureTwo),this.renderer.handler.createDefaultTexture(t,s=>{this.solidTextureOne=s}),this.renderer.handler.createDefaultTexture(n,s=>{this.solidTextureTwo=s})}_getLayerAttributionHTML(t){return`<div class="og-attribution__layer">${t.getAttribution()}</div>`}updateAttributionsList(){let t="";for(let n=0,s=this._layers.length;n<s;n++){let o=this._layers[n];o.getVisibility()&&o.getAttribution().length&&(t+=this._getLayerAttributionHTML(o))}this._applyAttribution(t)}updateVisibleLayers(){this._updateLayers=!0}_updateVisibleLayers(){this.visibleTileLayers=[],this.visibleTileLayers.length=0,this.visibleVectorLayers=[],this.visibleVectorLayers.length=0;let t="";for(let n=0,s=this._layers.length;n<s;n++){let o=this._layers[n];o.getVisibility()?(o.isBaseLayer()&&(this.createDefaultTextures(o._defaultTextures[0],o._defaultTextures[1]),this.baseLayer=o),o.hasImageryTiles()&&this.visibleTileLayers.push(o),o.isVector&&this.visibleVectorLayers.push(o),o.getAttribution().length&&(t+=this._getLayerAttributionHTML(o))):o._fading&&o._fadingOpacity>0&&(o.hasImageryTiles()&&this.visibleTileLayers.push(o),o.isVector&&this.visibleVectorLayers.push(o))}this._applyAttribution(t),this._sortLayers()}_applyAttribution(t){this.renderer&&this.renderer.div&&(t.length?this.renderer.div.attributions.innerHTML!==t&&(this.renderer.div.attributions.innerHTML=t):this.renderer.div.attributions.innerHTML="")}_sortLayers(){this.visibleVectorLayers.sort((n,s)=>n.getZIndex()-s.getZIndex()||n.getHeight()-s.getHeight());let t={0:[]};for(const n of this.visibleVectorLayers)t[n.depthOrder]||(t[n.depthOrder]=[]),t[n.depthOrder].push(n);if(this._visibleVectorLayersByDepthOrder.length=0,this._visibleVectorLayersByDepthOrder=[],this._visibleVectorLayersByDepthOrder=Object.keys(t).sort((n,s)=>Number(n)-Number(s)).map(n=>t[Number(n)]),this._visibleTileLayerSlices=[],this._visibleTileLayerSlices.length=0,this.visibleTileLayers.length){this.visibleTileLayers.sort((o,a)=>o.getHeight()-a.getHeight()||o.getZIndex()-a.getZIndex());let n=-1,s=this.visibleTileLayers[0].getHeight();for(let o=0,a=this.visibleTileLayers.length;o<a;o++)o%this.SLICE_SIZE!=0&&this.visibleTileLayers[o].getHeight()===s||(n++,this._visibleTileLayerSlices[n]=[],s=this.visibleTileLayers[o].getHeight()),this._visibleTileLayerSlices[n].push(this.visibleTileLayers[o])}}_renderScreenNodesPASSNoAtmos(){let t=this.camera,n=this._setUniformsNoAtmos(t);this._renderingScreenNodes(this.quadTreeStrategy,n,t,this.quadTreeStrategy._renderedNodesInFrustum[t.currentFrustumIndex])}_renderScreenNodesPASSAtmos(){let t=this.camera,n=this._setUniformsAtmos(t);this._renderingScreenNodes(this.quadTreeStrategy,n,t,this.quadTreeStrategy._renderedNodesInFrustum[t.currentFrustumIndex])}_renderScreenNodesWithHeightPASSNoAtmos(){let t=this.camera,n=this._setUniformsNoAtmos(t);this._renderingScreenNodesWithHeight(this.quadTreeStrategy,n,t,this.quadTreeStrategy._renderedNodesInFrustum[t.currentFrustumIndex])}_renderScreenNodesWithHeightPASSAtmos(){let t=this.camera,n=this._setUniformsAtmos(t);this._renderingScreenNodesWithHeight(this.quadTreeStrategy,n,t,this.quadTreeStrategy._renderedNodesInFrustum[t.currentFrustumIndex])}_globalPreDraw(){let t=this.camera;this._distBeforeMemClear+=this._prevCamEye.distance(t.eye),this._prevCamEye.copy(t.eye),this._createdNodesCount>this._maxNodes&&this._distBeforeMemClear>this._minDistanceBeforeMemClear&&(this.terrain.clearCache(),this.memClear()),this._indexesCacheToRemoveCounter>600&&this._clearIndexesCache()}preFrame(){this._updateLayers&&(this._updateLayers=!1,this._updateVisibleLayers()),this.camera.isFirstPass&&(this.camera.update(),this._collectRenderNodesIsActive&&this.quadTreeStrategy.collectRenderNodes(this.camera),this._normalMapCreator.frame(),this._geoImageCreator.frame(),this._vectorTileCreator.frame(),this.camera.checkTerrainCollision(),this.camera.update(),this.events.dispatch(this.events.draw,this),this._collectVectorLayerCollections());for(let t=0;t<this._visibleEntityCollections.length;t++)this.drawEntityCollections(this._visibleEntityCollections[t],t)}frame(){this._renderScreenNodesPASS()}lockQuadTree(){this._collectRenderNodesIsActive=!1,this.camera.setTerrainCollisionActivity(!1)}unlockQuadTree(){this._collectRenderNodesIsActive=!0,this.camera.setTerrainCollisionActivity(!0)}_setUniformsNoAtmos(t){let n,s,o=this.renderer,a=o.handler,h=a.gl;return h.enable(h.CULL_FACE),o.enableBlendOneSrcAlpha(),this.lightEnabled?(a.programs.drawnode_screen_wl.activate(),n=a.programs.drawnode_screen_wl._program,s=n.uniforms,h.uniform3fv(s.lightPosition,this._lightPosition),h.uniformMatrix4fv(s.viewMatrix,!1,t.getViewMatrix()),h.uniformMatrix4fv(s.projectionMatrix,!1,t.getProjectionMatrix()),this.baseLayer?(h.uniform3fv(s.diffuse,this.baseLayer._diffuse||this._diffuse),h.uniform3fv(s.ambient,this.baseLayer._ambient||this._ambient),h.uniform4fv(s.specular,this.baseLayer._specular||this._specular),h.uniform1f(s.nightTextureCoefficient,this.baseLayer.nightTextureCoefficient||this.nightTextureCoefficient)):(h.uniform3fv(s.diffuse,this._diffuse),h.uniform3fv(s.ambient,this._ambient),h.uniform4fv(s.specular,this._specular),h.uniform1f(s.nightTextureCoefficient,this.nightTextureCoefficient)),h.activeTexture(h.TEXTURE0+this.SLICE_SIZE),h.bindTexture(h.TEXTURE_2D,this._nightTexture||this.transparentTexture),h.uniform1i(s.nightTexture,this.SLICE_SIZE),h.activeTexture(h.TEXTURE0+this.SLICE_SIZE+1),h.bindTexture(h.TEXTURE_2D,this._specularTexture||this.transparentTexture),h.uniform1i(s.specularTexture,this.SLICE_SIZE+1),h.uniform1f(s.camHeight,t.getHeight())):(a.programs.drawnode_screen_nl.activate(),n=a.programs.drawnode_screen_nl._program,s=n.uniforms,h.uniformMatrix4fv(s.viewMatrix,!1,t.getViewMatrix()),h.uniformMatrix4fv(s.projectionMatrix,!1,t.getProjectionMatrix())),h.uniform3fv(s.eyePositionHigh,t.eyeHigh),h.uniform3fv(s.eyePositionLow,t.eyeLow),n}_setUniformsAtmos(t){let n,s,o=this.renderer,a=o.handler,h=a.gl;return h.enable(h.CULL_FACE),o.enableBlendOneSrcAlpha(),this.lightEnabled?(a.programs.drawnode_screen_wl.activate(),n=a.programs.drawnode_screen_wl._program,s=n.uniforms,h.uniform3fv(s.lightPosition,this._lightPosition),h.uniformMatrix4fv(s.viewMatrix,!1,t.getViewMatrix()),h.uniformMatrix4fv(s.projectionMatrix,!1,t.getProjectionMatrix()),this.baseLayer?(h.uniform3fv(s.diffuse,this.baseLayer._diffuse||this._diffuse),h.uniform3fv(s.ambient,this.baseLayer._ambient||this._ambient),h.uniform4fv(s.specular,this.baseLayer._specular||this._specular),h.uniform1f(s.nightTextureCoefficient,this.baseLayer.nightTextureCoefficient||this.nightTextureCoefficient)):(h.uniform3fv(s.diffuse,this._diffuse),h.uniform3fv(s.ambient,this._ambient),h.uniform4fv(s.specular,this._specular),h.uniform1f(s.nightTextureCoefficient,this.nightTextureCoefficient)),h.uniform2fv(s.maxMinOpacity,this._atmosphereMaxMinOpacity),h.activeTexture(h.TEXTURE0+this.SLICE_SIZE),h.bindTexture(h.TEXTURE_2D,this._nightTexture||this.transparentTexture),h.uniform1i(s.nightTexture,this.SLICE_SIZE),h.activeTexture(h.TEXTURE0+this.SLICE_SIZE+1),h.bindTexture(h.TEXTURE_2D,this._specularTexture||this.transparentTexture),h.uniform1i(s.specularTexture,this.SLICE_SIZE+1),h.activeTexture(h.TEXTURE0+this.SLICE_SIZE+4),h.bindTexture(h.TEXTURE_2D,o.controls.Atmosphere._transmittanceBuffer.textures[0]),h.uniform1i(s.transmittanceTexture,this.SLICE_SIZE+4),h.activeTexture(h.TEXTURE0+this.SLICE_SIZE+5),h.bindTexture(h.TEXTURE_2D,o.controls.Atmosphere._scatteringBuffer.textures[0]),h.uniform1i(s.scatteringTexture,this.SLICE_SIZE+5),h.uniform1f(s.camHeight,t.getHeight())):(a.programs.drawnode_screen_nl.activate(),n=a.programs.drawnode_screen_nl._program,s=n.uniforms,h.uniformMatrix4fv(s.viewMatrix,!1,t.getViewMatrix()),h.uniformMatrix4fv(s.projectionMatrix,!1,t.getProjectionMatrix())),h.uniform3fv(s.eyePositionHigh,t.eyeHigh),h.uniform3fv(s.eyePositionLow,t.eyeLow),n}static __refreshLayersFadingOpacity__(t,n,s){for(let o=t.length-1;o>=0;--o){let a=t[o];a._fading&&a._refreshFadingOpacity(n,s)&&t.splice(o,1)}}_renderingScreenNodes(t,n,s,o){let a=this._visibleTileLayerSlices;a.length&&s.isFirstPass&&Ri.__refreshLayersFadingOpacity__(a[0],t.minCurrZoom,t.maxCurrZoom);let h=new Map,c=[],u=this.terrain.equalizeVertices,d=o.length;if(t._fadingOpaqueSegments=[],s.slope>.8||!this.terrain||this.terrain.isEmpty)for(;d--;){let f=o[d],g=f.segment;this._renderingFadingNodesNoDepth(t,h,n,f,a[0],0,t._fadingOpaqueSegments),u&&g.equalize(),g.readyToEngage&&g.engage(),g.screenRendering(n,a[0],0)}else{for(;d--;){let f=o[d],g=f.segment;this._renderingFadingNodes(t,h,n,f,a[0],0,c,t._fadingOpaqueSegments),g._transitionOpacity<1?c.push(g):(u&&g.equalize(),g.readyToEngage&&g.engage(),g.screenRendering(n,a[0],0))}for(let f=0;f<c.length;f++){let g=c[f];u&&g.equalize(),g.readyToEngage&&g.engage(),g.screenRendering(n,a[0],0)}}}_renderingScreenNodesWithHeight(t,n,s,o){let a=this.renderer.handler.gl;a.enable(a.POLYGON_OFFSET_FILL),a.disable(a.CULL_FACE);let h=new Map,c=[],u=this._visibleTileLayerSlices;for(let d=1,f=u.length;d<f;d++){s.isFirstPass&&Ri.__refreshLayersFadingOpacity__(u[d],t.minCurrZoom,t.maxCurrZoom),a.polygonOffset(0,-d);let g=o.length;for(;g--;){let _=o[g];this._renderingFadingNodes(t,h,n,_,u[d],d,c),_.segment._transitionOpacity<1?_.segment.initSlice(d):_.segment.screenRendering(n,u[d],d,this.transparentTexture,!0)}}a.disable(a.POLYGON_OFFSET_FILL),a.enable(a.CULL_FACE)}_renderColorPickingFramebufferPASS(){let t,n=this.renderer,s=n.handler,o=s.gl;s.programs.drawnode_colorPicking.activate(),t=s.programs.drawnode_colorPicking._program;let a=t.uniforms,h=n.activeCamera;o.enable(o.CULL_FACE),o.uniformMatrix4fv(a.viewMatrix,!1,h.getViewMatrix()),o.uniformMatrix4fv(a.projectionMatrix,!1,h.getProjectionMatrix()),o.uniform3fv(a.eyePositionHigh,h.eyeHigh),o.uniform3fv(a.eyePositionLow,h.eyeLow);let c=this.quadTreeStrategy._renderedNodesInFrustum[h.getCurrentFrustum()],u=this._visibleTileLayerSlices,d=c.length;for(;d--;)c[d].segment._transitionOpacity>=1&&c[d].segment.colorPickingRendering(t,u[0],0);for(let f=0;f<this.quadTreeStrategy._fadingOpaqueSegments.length;++f)this.quadTreeStrategy._fadingOpaqueSegments[f].colorPickingRendering(t,u[0],0);o.enable(o.POLYGON_OFFSET_FILL);for(let f=1,g=u.length;f<g;f++)for(d=c.length,o.polygonOffset(0,-f);d--;)c[d].segment.colorPickingRendering(t,u[f],f,this.transparentTexture,!0);o.disable(o.POLYGON_OFFSET_FILL)}renderDepthFramebuffer(t,n){let s,o=this.renderer.handler,a=o.gl;o.programs.drawnode_depth.activate(),s=o.programs.drawnode_depth._program;let h=s.uniforms;a.disable(a.BLEND),a.disable(a.POLYGON_OFFSET_FILL),a.uniformMatrix4fv(h.viewMatrix,!1,t.getViewMatrix()),a.uniformMatrix4fv(h.projectionMatrix,!1,t.getProjectionMatrix()),a.uniform3fv(h.eyePositionHigh,t.eyeHigh),a.uniform3fv(h.eyePositionLow,t.eyeLow),a.uniform1f(h.frustumPickingColor,t.frustumColorIndex);let c=n._renderedNodesInFrustum[t.getCurrentFrustum()],u=this._visibleTileLayerSlices,d=c.length;for(;d--;)c[d].segment._transitionOpacity>=1&&c[d].segment.depthRendering(s,u[0]);for(let f=0;f<n._fadingOpaqueSegments.length;++f)n._fadingOpaqueSegments[f].depthRendering(s,u[0]);a.enable(a.BLEND)}_collectVectorLayerCollections(){let t=this._visibleVectorLayersByDepthOrder.length;this._visibleEntityCollections.length=0,this._visibleEntityCollections=new Array(t);for(let n=0;n<this._visibleEntityCollections.length;n++)this._visibleEntityCollections[n]=[];for(;t--;){let n=this._visibleVectorLayersByDepthOrder[t],s=n.length;for(;s--;){let o=n[s];o._fading&&o._refreshFadingOpacity(this.quadTreeStrategy.minCurrZoom,this.quadTreeStrategy.maxCurrZoom)&&(n.splice(s,1),n.length===0&&this._visibleVectorLayersByDepthOrder.splice(t,1)),o.collectVisibleCollections(this._visibleEntityCollections[t]),o.update()}}}memClear(){this._distBeforeMemClear=0,this.camera._insideSegment=null,this.layerLock.lock(this._memKey),this.terrainLock.lock(this._memKey),this._normalMapCreator.lock(this._memKey),this._normalMapCreator.clear(),this.terrain.abortLoading(),this._tileLoader.abortAll(),this.quadTreeStrategy.clear(),this.layerLock.free(this._memKey),this.terrainLock.free(this._memKey),this._normalMapCreator.free(this._memKey),this._createdNodesCount=0}getRayIntersectionEllipsoid(t){return this.ellipsoid.hitRay(t.origin,t.direction)}getCartesianFromPixelEllipsoid(t){let n=this.renderer.activeCamera;return this.ellipsoid.hitRay(n.eye,n.unproject(t.x,t.y))}getLonLatFromPixelEllipsoid(t){let n=this.getCartesianFromPixelEllipsoid(t);if(n)return this.ellipsoid.cartesianToLonLat(n)}getCartesianFromMouseTerrain(){let t=this.renderer.events.mouseState,n=this.getDistanceFromPixel(t);if(n)return t.direction.scaleTo(n).addA(this.renderer.activeCamera.eye)}getCartesianFromPixelTerrain(t){let n=this.getDistanceFromPixel(t);if(n)return(t.direction||this.renderer.activeCamera.unproject(t.x,t.y)).scaleTo(n).addA(this.renderer.activeCamera.eye)}getLonLatFromPixelTerrain(t){let n=this.getCartesianFromPixelTerrain(t);if(n)return this.ellipsoid.cartesianToLonLat(n)}getPixelFromCartesian(t){return this.renderer.activeCamera.project3v(t)}getPixelFromLonLat(t){let n=this.ellipsoid.lonLatToCartesian(t);if(n)return this.renderer.activeCamera.project3v(n)}getDistanceFromPixelEllipsoid(t){let n=this.getCartesianFromPixelEllipsoid(t);if(n)return n.distance(this.renderer.activeCamera.eye)}getDistanceFromPixel(t){return this.renderer.getDistanceFromPixel(t)||this.getDistanceFromPixelEllipsoid(t)||0}viewExtent(t){this.camera?this.camera.viewExtent(t):this._initialViewExtent=t}viewExtentArr(t){this.viewExtent(new U(new L(t[0],t[1]),new L(t[2],t[3])))}getExtent(){if(this.renderer){let t=this.renderer.handler.getWidth(),n=this.renderer.handler.getHeight(),s=[this.getLonLatFromPixelTerrain(new H(0,0)),this.getLonLatFromPixelTerrain(new H(t,0)),this.getLonLatFromPixelTerrain(new H(t,n)),this.getLonLatFromPixelTerrain(new H(0,n))];if(s[0]&&s[1]&&s[2]&&s[3]){let o=s[0].lon,a=s[2].lat,h=s[1].lon,c=s[0].lat;for(let u=0;u<s.length;u++)s[u].lon>h&&(h=s[u].lon),s[u].lat>c&&(c=s[u].lat),s[u].lon<o&&(o=s[u].lon),s[u].lat<a&&(a=s[u].lat);return new U(new L(o,a),new L(h,c))}}return this.quadTreeStrategy._viewExtent}getViewExtent(){return this.quadTreeStrategy._viewExtent}viewLonLat(t,n,s){this.camera.setLonLat(t,n,s)}flyExtent(t,n,s={}){this.camera.flyExtent(t,n,s)}flyCartesian(t,n){this.camera.flyCartesian(t,n)}flyLonLat(t,n={}){this.camera.flyLonLat(t,n)}stopFlying(){this.camera.stopFlying()}updateBillboardsTexCoords(){for(let n=0;n<this.entityCollections.length;n++)this.entityCollections[n].billboardHandler.refreshTexCoordsArr();let t={};for(let n=0;n<this._layers.length;n++){let s=this._layers[n];s instanceof _t&&s.each(function(o){o._entityCollection&&!t[o._entityCollection.id]&&(o._entityCollection.billboardHandler.refreshTexCoordsArr(),t[o._entityCollection.id]=!0)})}}getEntityTerrainPoint(t,n){let s=this.quadTreeStrategy._renderedNodes,o=s.length;for(;o--;)if(s[o].segment.isEntityInside(t))return s[o].segment.getEntityTerrainPoint(t,n)}async getHeightDefault(t){return new Promise(n=>{this.terrain?this.terrain.getHeightAsync(t.clone(),s=>{n(s)}):n(0)})}async getHeightAboveELL(t){return new Promise(n=>{this.terrain?this.terrain.getHeightAsync(t.clone(),s=>{n(s+this.terrain.geoid.getHeightLonLat(t))}):n(0)})}onremove(){this.memClear(),this.quadTreeStrategy.destroyBranches(),this.quadTreeStrategy.clearRenderedNodes()}destroy(){var t;this._terrainWorker.destroy(),this._plainSegmentWorker.destroy(),(t=this.renderer)==null||t.destroy(),this.onremove(),super.destroy()}}const rc=["draw","layeradd","baselayerchange","layerremove","layervisibilitychange","rendercompleted","terraincompleted","layerloadend"];class fn extends de{constructor(t){super("skybox"),this.params=t,this.vertexPositionBuffer=null,this.texture=null}static createDefault(t){return new fn({nx:t+"skybox/gal/_nx.jpg",px:t+"skybox/gal/_px.jpg",py:t+"skybox/gal/_py.jpg",ny:t+"skybox/gal/_ny.jpg",pz:t+"skybox/gal/_pz.jpg",nz:t+"skybox/gal/_nz.jpg"})}init(){this.renderer.handler.addProgram(new X("skybox",{uniforms:{projectionViewMatrix:{type:ht.MAT4},uSampler:{type:ht.SAMPLERCUBE},pos:{type:ht.VEC3}},attributes:{aVertexPosition:{type:ht.VEC3,enableArray:!0}},vertexShader:`attribute vec3 aVertexPosition;
            uniform mat4 projectionViewMatrix;
            uniform vec3 pos;
            varying vec3 vTextureCoord;
            void main(void) {
                vTextureCoord = aVertexPosition;
                gl_Position = projectionViewMatrix * vec4(aVertexPosition + pos, 1.0);
            }`,fragmentShader:`precision lowp float;
            varying vec3 vTextureCoord;
            uniform samplerCube uSampler;
            void main(void) {
                gl_FragColor = textureCube(uSampler, vTextureCoord);
            }`})),this.texture=this.renderer.handler.loadCubeMapTexture(this.params),this._createBuffers(),this.drawMode=this.renderer.handler.gl.TRIANGLES}preFrame(){let t=this.renderer.handler,n=t.gl,s=this.renderer.activeCamera;n.disable(n.DEPTH_TEST),t.programs.skybox.activate();let o=t.programs.skybox._program,a=o.uniforms;if(s.isOrthographic){const c=s.frustum.near,u=s.frustum.far,d=s.getAspectRatio(),f=c*Math.tan(s.viewAngle*Qt),g=f*d,_=new tt().setPerspective(-g,g,-f,f,c,u),m=new tt().set(s.getViewMatrix());n.uniformMatrix4fv(a.projectionViewMatrix,!1,_.mul(m)._m)}else n.uniformMatrix4fv(a.projectionViewMatrix,!1,s.getProjectionViewMatrix());n.uniform3fv(a.pos,s.eye.toArray()),n.activeTexture(n.TEXTURE0),n.bindTexture(n.TEXTURE_CUBE_MAP,this.texture),n.uniform1i(a.uSampler,0);let h=this.vertexPositionBuffer;n.bindBuffer(n.ARRAY_BUFFER,h),n.vertexAttribPointer(o.attributes.aVertexPosition,h.itemSize,n.FLOAT,!1,0,0),n.drawArrays(this.drawMode,0,h.numItems),n.enable(n.DEPTH_TEST)}_createBuffers(){const t=new Float32Array([-1e8,1e8,-1e8,-1e8,-1e8,-1e8,1e8,-1e8,-1e8,1e8,-1e8,-1e8,1e8,1e8,-1e8,-1e8,1e8,-1e8,-1e8,-1e8,1e8,-1e8,-1e8,-1e8,-1e8,1e8,-1e8,-1e8,1e8,-1e8,-1e8,1e8,1e8,-1e8,-1e8,1e8,1e8,-1e8,-1e8,1e8,-1e8,1e8,1e8,1e8,1e8,1e8,1e8,1e8,1e8,1e8,-1e8,1e8,-1e8,-1e8,-1e8,-1e8,1e8,-1e8,1e8,1e8,1e8,1e8,1e8,1e8,1e8,1e8,1e8,-1e8,1e8,-1e8,-1e8,1e8,-1e8,1e8,-1e8,1e8,1e8,-1e8,1e8,1e8,1e8,1e8,1e8,1e8,-1e8,1e8,1e8,-1e8,1e8,-1e8,-1e8,-1e8,-1e8,-1e8,-1e8,1e8,1e8,-1e8,-1e8,1e8,-1e8,-1e8,-1e8,-1e8,1e8,1e8,-1e8,1e8]);this.vertexPositionBuffer=this.renderer.handler.createArrayBuffer(t,3,t.length/3)}}Object.freeze(Object.defineProperty({__proto__:null,Axes:class extends de{constructor(l=100){super("Axes"),this.size=l,this.axesBuffer=null,this.axesColorBuffer=null}init(){this.createAxesBuffer(this.size),this.drawMode=this.renderer.handler.gl.LINES,this.renderer.handler.addProgram(new X("axesShader",{uniforms:{projectionViewMatrix:"mat4"},attributes:{aVertexPosition:"vec3",aVertexColor:"vec4"},vertexShader:`attribute vec3 aVertexPosition;
            attribute vec4 aVertexColor;
            uniform mat4 projectionViewMatrix;
            varying vec4 vColor;
            void main(void) {
                gl_Position = projectionViewMatrix * vec4(aVertexPosition, 1.0);
                vColor = aVertexColor;
            }`,fragmentShader:`precision highp float;
            varying vec4 vColor;
            void main(void) {
                gl_FragColor = vColor;
            }`}))}frame(){this.renderer.handler.programs.axesShader.activate().set({projectionViewMatrix:this.renderer.activeCamera.getProjectionViewMatrix(),aVertexPosition:this.axesBuffer,aVertexColor:this.axesColorBuffer}),this.renderer.handler.programs.axesShader.drawArrays(this.drawMode,this.axesBuffer.numItems)}createAxesBuffer(l){const t=[0,0,0,l-1,0,0,0,0,0,0,l-1,0,0,0,0,0,0,l-1];this.axesBuffer=this.renderer.handler.createArrayBuffer(new Float32Array(t),3,6),this.axesColorBuffer=this.renderer.handler.createArrayBuffer(new Float32Array([1,0,0,1,1,0,0,1,0,0,1,1,0,0,1,1,0,1,0,1,0,1,0,1]),4,6)}},Planet:Ri,RenderNode:de,SkyBox:fn},Symbol.toStringTag,{value:"Module"}));const Bs=class md{constructor(t={}){this.__id=md.__counter__++,this.equalizeVertices=t.equalizeVertices||!1,this.equalizeNormals=!1,this.isEmpty=!0,this.name=t.name||"empty",this.minZoom=t.minZoom||2,this.maxZoom=t.maxZoom||19,this.maxNativeZoom=t.maxNativeZoom||this.maxZoom,this.gridSizeByZoom=t.gridSizeByZoom||[64,32,16,8,4,4,4,4,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2],this._maxNodeZoom=this.gridSizeByZoom.length-1,this.plainGridSize=2,this.noDataValues=[],this._planet=null,this._geoid=t.geoid||new Pa({src:t.geoidSrc||null}),this._isReady=!1}setUrlRewriteCallback(t){}get isIdle(){return!0}isEqual(t){return t.__id===this.__id}static checkNoDataValue(t,n){return Xr(t,n)!==-1}isBlur(t){return!1}set maxNodeZoom(t){t>this.gridSizeByZoom.length-1&&(t=this.gridSizeByZoom.length-1),this._maxNodeZoom=t}get maxNodeZoom(){return this._maxNodeZoom}set geoid(t){this._geoid=t}get geoid(){return this._geoid}getGeoid(){return this._geoid}handleSegmentTerrain(t){t.terrainIsLoading=!1,t.terrainReady=!0,t.terrainExists=!0}isReady(){return this._isReady}abortLoading(){}clearCache(){}getHeightAsync(t,n){return n(0),!0}loadTerrain(t,n=!1){}};Bs.__counter__=0;let Mi=Bs;class gn extends Mi{constructor(t="",n={}){super({geoidSrc:"https://openglobus.org/geoid/egm84-30.pgm",maxNativeZoom:n.maxNativeZoom||14,...n}),this._s=n.subdomains||["a","b","c"],this.events=lt(nc,this),this._requestCount=0,this._requestsPeerSubdomain=4,this.isEmpty=!1,this.equalizeNormals=!0,this.name=t||"openglobus",this.url=n.url||"https://{s}.srtm3.openglobus.org/{z}/{y}/{x}.ddm",this.gridSizeByZoom=n.gridSizeByZoom||[64,32,32,16,16,8,8,8,16,16,16,32,32,32,32,16,8,4,2,2,2,2,2,2],this._heightFactor=n.heightFactor!=null?n.heightFactor:1,this.noDataValues=n.noDataValues||[];for(let s=0;s<this.noDataValues.length;s++)this.noDataValues[s]*=this._heightFactor;this.plainGridSize=n.plainGridSize||32,this._extent=$r(n.extent,new U(new L(-180,-90),new L(180,90))),this._dataType="arrayBuffer",this._maxNodeZoom=this.gridSizeByZoom.length-1,this._elevationCache={},this._fetchCache={},this._cache=n.cache||"default",this._loader=new Sa,this._urlRewriteCallback=n.urlRewrite||null}get loader(){return this._loader}clearCache(){for(let t in this._elevationCache)this._elevationCache[t].heights=null,this._elevationCache[t].extent=null,delete this._elevationCache[t];this._elevationCache=null,this._elevationCache={};for(let t in this._fetchCache)this._fetchCache[t]=null,delete this._fetchCache[t];this._fetchCache=null,this._fetchCache={}}isBlur(t){return t.tileZoom>=6}setElevationCache(t,n){this._elevationCache[t]=n}getElevationCache(t){return this._elevationCache[t]}getHeightAsync(t,n,s,o){if(!t||t.lat>ct||t.lat<Ot)return n(0),!0;o=o==null||o;const[a,h,c,u]=this._planet.quadTreeStrategy.getTileXY(t,s||this.maxZoom);let d=zt.getTileIndex(a,h,c,u),f=this.getElevationCache(d),g=Ji(t);if(f)return f.heights?n(this._getGroundHeightMerc(g,f)):n(0),!0;{let _=this._fetchCache[d];_||(_=this._loader.fetch({src:this._urlRewriteCallback&&this._urlRewriteCallback(a,h,c,u)||this.buildURL(a,h,c,u),type:this._dataType,options:{cache:this._cache}}),this._fetchCache[d]=_),_.then(m=>{let p=Ze(a,h,c);if(m.status==="ready"){let x={heights:this._createHeights(m.data,null,u,a,h,c,p),extent:p};this.setElevationCache(d,x),n(this._getGroundHeightMerc(g,x))}else if(m.status==="error"){if(o&&c>this.maxNativeZoom)return o=!1,void this.getHeightAsync(t,n,this.maxNativeZoom,!1);this.setElevationCache(d,{heights:null,extent:p}),n(0)}else this._fetchCache[d]=null,delete this._fetchCache[d]})}return!1}_getGroundHeightMerc(t,n){if(!n.extent||!n.heights)return 0;let s=n.extent.getWidth(),o=Math.sqrt(n.heights.length),a=s/(o-1),h=o-Math.ceil((t.lat-n.extent.southWest.lat)/a)-1,c=Math.floor((t.lon-n.extent.southWest.lon)/a),u=(h+1)*o+c,d=u+1,f=h*o+c,g=f+1,_=n.heights[u],m=n.heights[d],p=n.heights[f],x=n.heights[g],y=new v(n.extent.southWest.lon+a*c,_,n.extent.northEast.lat-a*h-a),T=new v(y.x+a,m,y.z),S=new v(y.x,p,y.z+a),C=new v(y.x+a,x,y.z+a),P=new v(t.lon,1e5,t.lat),w=new V(P,new v(0,-1,0)),I=new v,O=w.hitTriangleRes(y,T,S,I);return O===V.INSIDE?I.y:(O=w.hitTriangleRes(T,C,S,I),O===V.INSIDE?I.y:0)}abortLoading(){this._loader.abortAll()}setUrl(t){this.url=t}setName(t){this.name=t}isReadyToLoad(t){return t._tileGroup===0&&this._extent.overlaps(t.getExtentLonLat())}loadTerrain(t,n=!1){if(this._planet.terrainLock.isFree())if(t.terrainReady=!1,t.terrainIsLoading=!0,this.isReadyToLoad(t)){let s=this.getElevationCache(t.tileIndex);s?this._applyElevationsData(t,s.heights):this._loader.load({sender:this,src:this._getHTTPRequestString(t),segment:t,type:this._dataType,options:{cache:this._cache},filter:()=>t.plainReady&&t.node.getState()!==0||n},o=>{if(o.status==="ready"){let a=this._createHeights(o.data,t,t._tileGroup,t.tileX,t.tileY,t.tileZoom,t.getExtent(),t.tileZoom===this.maxZoom);this.setElevationCache(t.tileIndex,{heights:a,extent:t.getExtent()}),this._applyElevationsData(t,a)}else o.status==="abort"?t.terrainIsLoading=!1:o.status==="error"?this._applyElevationsData(t,null):t.terrainIsLoading=!1})}else t.elevationsNotExists();else t.terrainIsLoading=!1}_getSubdomain(){return this._requestCount++,this._s[Math.floor(this._requestCount%(this._requestsPeerSubdomain*this._s.length)/this._requestsPeerSubdomain)]}buildURL(t,n,s,o){return Dt(this.url,{s:this._getSubdomain(),x:t.toString(),y:n.toString(),z:s.toString()})}_createUrl(t){return this.buildURL(t.tileX,t.tileY,t.tileZoom,t._tileGroup)}_getHTTPRequestString(t){return this._urlRewriteCallback&&this._urlRewriteCallback(t.tileX,t.tileY,t.tileZoom,t._tileGroup)||this._createUrl(t)}setUrlRewriteCallback(t){this._urlRewriteCallback=t}_createHeights(t,n,s,o,a,h,c,u){if(this._heightFactor!==1){let d=new Float32Array(t);for(let f=0,g=d.length;f<g;f++)d[f]=d[f]*this._heightFactor;return d}return new Float32Array(t)}_applyElevationsData(t,n){if(t){let s=this.events.load;s.handlers.length&&this.events.dispatch(s,{elevations:n,segment:t}),t.applyTerrain(n)}}}const nc=["load","loadend"];class Ds extends zt{constructor(t,n={}){super(t,n),this.events=this.events.registerNames(oc),this.url=n.url||"",this._s=n.subdomains||["a","b","c"],this.minNativeZoom=n.minNativeZoom||0,this.maxNativeZoom=n.maxNativeZoom||19,this._urlRewriteCallback=n.urlRewrite||null,this._requestsPeerSubdomains=4,this._requestCount=0,this._cache=n.cache||"default"}get isIdle(){return super.isIdle&&this._planet._tileLoader.getRequestCounter(this)===0}get instanceName(){return"XYZ"}abortLoading(){this._planet&&this._planet._tileLoader.abort(this)}setVisibility(t){t!==this._visibility&&(super.setVisibility(t),t||this.abortLoading())}remove(){return this.abortLoading(),super.remove(),this}setUrl(t){this.url=t}_checkSegment(t){return t._projection.id===this._planet.quadTreeStrategy.projection.id}loadMaterial(t,n=!1){let s=t.segment;this._isBaseLayer?t.texture=s.getDefaultTexture():t.texture=s.planet.transparentTexture,(this._planet.layerLock.isFree()||t.segment.tileZoom<2)&&(t.isReady=!1,t.isLoading=!0,this._checkSegment(s)?(t.loadingAttempts++,this._planet._tileLoader.load({sender:this,src:this._getHTTPRequestString(t.segment),type:"imageBitmap",filter:()=>s.initialized&&s.node.getState()===1||n,options:{cache:this._cache}},o=>{if(o.status==="ready"){if(t.isLoading){let a=this.events.load;a.handlers.length&&this.events.dispatch(a,t),t.applyImage(o.data),o.data=null}}else o.status==="abort"?t.isLoading=!1:o.status==="error"&&t.isLoading&&t.textureNotExists()})):t.textureNotExists())}_createUrl(t){return Dt(this.url,{s:this._getSubdomain(),x:t.tileX.toString(),y:t.tileY.toString(),z:t.tileZoom.toString()})}_getSubdomain(){return this._requestCount++,this._s[Math.floor(this._requestCount%(this._requestsPeerSubdomains*this._s.length)/this._requestsPeerSubdomains)]}_getHTTPRequestString(t){return this._urlRewriteCallback?this._urlRewriteCallback(t,this.url):this._createUrl(t)}setUrlRewriteCallback(t){this._urlRewriteCallback=t}applyMaterial(t,n=!1){if(t.isReady)return t.texOffset;if(t.segment.tileZoom<this.minNativeZoom)t.textureNotExists();else{let s=t.segment,o=s.node,a=!1,h=this.__id,c=t;for(;o.parentNode;)if(o=o.parentNode,c=o.segment.materials[h],c&&c.textureExists){a=!0;break}if(s.passReady){let u=t.layer.maxNativeZoom;if(o.segment.tileZoom===u)t.textureNotExists();else if(t.segment.tileZoom<=u)!t.isLoading&&!t.isReady&&this.loadMaterial(t,n);else{let d=s.node;for(;d.segment.tileZoom>t.layer.maxNativeZoom;)d=d.parentNode;let f=d.segment.materials[t.layer.__id];f?!f.isLoading&&!f.isReady&&this.loadMaterial(f,!0):(f=d.segment.materials[t.layer.__id]=t.layer.createMaterial(d.segment),this.loadMaterial(f,!0))}}if(a){t.appliedNode=o,t.appliedNodeId=o.nodeId,t.texture=c.texture;let u=1/(2<<s.tileZoom-o.segment.tileZoom-1);t.texOffset[0]=s.tileX*u-o.segment.tileX,t.texOffset[1]=s.tileY*u-o.segment.tileY,t.texOffset[2]=u,t.texOffset[3]=u}else t.texture=s.planet.transparentTexture,t.texOffset[0]=0,t.texOffset[1]=0,t.texOffset[2]=1,t.texOffset[3]=1}return t.texOffset}clearMaterial(t){t.isReady&&t.textureExists&&(!t.texture.default&&t.segment.handler.gl.deleteTexture(t.texture),t.texture=null),t.isReady=!1,t.textureExists=!1,t.isLoading=!1}_correctFullExtent(){let t=this._extent,n=this._extentMerc;t.northEast.lat===90&&(n.northEast.lat=2008750834e-2),t.northEast.lon===180&&(n.northEast.lon=2008750834e-2),t.southWest.lat===-90&&(n.southWest.lat=-2008750834e-2),t.southWest.lon===-180&&(n.southWest.lon=-2008750834e-2)}}const oc=["load","loadend"];class me extends Ds{constructor(t,n){super(t,n),this._extra=new URLSearchParams(n.extra).toString(),n.extent||this.setExtent(new U(new L(-180,-90),new L(180,90))),this.layers=n.layers,this.imageWidth=n.imageWidth||256,this.imageHeight=n.imageHeight||256,this._getBbox=me.get_bbox_v1_1_1,this._version="",this.setVersion(n.version)}static createRequestUrl(t,n,s="image/png",o="1.1.1",a="GetMap",h,c,u=256,d=256,f){return`${t}?LAYERS=${n}&FORMAT=${s}&SERVICE=WMS&VERSION=${o}&REQUEST=${a}&SRS=${h}&BBOX=${c}&WIDTH=${u}&HEIGHT=${d}`+(f?`&${f}`:"")}static get_bbox_v1_1_1(t){return`${t.getWest()},${t.getSouth()},${t.getEast()},${t.getNorth()}`}static get_bbox_v1_3_0(t,n){return n==="epsg:4326"?`${t.getSouth()},${t.getWest()},${t.getNorth()},${t.getEast()}`:`${t.getWest()},${t.getSouth()},${t.getEast()},${t.getNorth()}`}_checkSegment(t){return!0}get instanceName(){return"WMS"}_createUrl(t){return me.createRequestUrl(this.url,this.layers,"image/png",this._version,"GetMap",t._projection.code,this._getBbox(t.getExtent(),t._projection.code),this.imageWidth,this.imageHeight,this._extra)}setVersion(t){this._version=t||"1.1.1",this._version==="1.1.1"?this._getBbox=me.get_bbox_v1_1_1:t==="1.3.0"&&(this._getBbox=me.get_bbox_v1_3_0)}_correctFullExtent(){const t=this._extent,n=this._extentMerc;t.northEast.lat===90&&(n.northEast.lat=2008750834e-2),t.northEast.lon===180&&(n.northEast.lon=2008750834e-2),t.southWest.lat===-90&&(n.southWest.lat=-2008750834e-2),t.southWest.lon===-180&&(n.southWest.lon=-2008750834e-2)}}class je extends gn{constructor(t={}){super("BilTerrain",t),this.equalizeVertices=!0,this.equalizeNormals=!0,this.minZoom=t.minZoom||2,this.maxZoom=t.maxZoom||14,this.noDataValues=t.noDataValues||[-9999,32767],this.url=t.url||"",this._format="application/bil16",this._layers=t.layers||"",this._imageSize=t.imageSize||256,this.plainGridSize=t.plainGridSize!=null?t.plainGridSize:Ki(this._imageSize)?this._imageSize/2:$e(this._imageSize)/2,this._dataType="arrayBuffer"}isBlur(t){return t.tileZoom>=18}_createUrl(t){return me.createRequestUrl(this.url,this._layers,this._format,"1.1.1","GetMap",t._projection.code,me.get_bbox_v1_1_1(t.getExtent()),this._imageSize,this._imageSize)}_createHeights(t,n,s,o,a,h,c,u){let d=new Int16Array(t);if(!Ki(this._imageSize)){let x=new Float32Array(d.length);return function(y,T){for(let S=0,C=T.length;S<C;S++)T[S]=y[S]}(d,x),x}let f=(this.plainGridSize+1)*(this.plainGridSize+1),g=new Array(4);for(let x=0;x<4;x++){g[x]=[];for(let y=0;y<4;y++)g[x][y]=new Float32Array(f)}let _=new Float32Array(f);(function(x,y,T,S){let C=Math.sqrt(T.length)-1,P=C+1,w=Math.sqrt(x.length),I=w/C,O=0,N=0;for(let k=0,D=0,ze=x.length;k<ze;k++){let z=x[k],Ee=je.checkNoDataValue(y,z),B=!1,rt=!1,wt=Math.floor(k/w),re=k%w,mt=Math.floor(re/C),Mt=Math.floor(wt/C),Bt=S[Mt][mt],Ht=wt%C,Nt=re%C,Wt=(Ht+Mt)*P+Nt+mt;if(Bt[Wt]=z,(wt+Mt)%I==0&&(re+mt)%I==0&&(T[D++]=z),(re+1)%C==0&&re!==w-1){O=x[k],B=je.checkNoDataValue(y,O);let $t=z;Ee||B||($t=.5*(z+O)),Wt=(Ht+Mt)*P+Nt+1,Bt[Wt]=$t,(wt+Mt)%I==0&&(T[D++]=$t);let Zt=(Ht+Mt)*P+(Nt+1)%C;S[Mt][mt+1][Zt]=$t}if((wt+1)%C==0&&wt!==w-1){N=x[k+w],rt=je.checkNoDataValue(y,N);let $t=z;Ee||rt||($t=.5*(z+N)),Wt=(Ht+1)*P+Nt+mt,Bt[Wt]=$t,(re+mt)%I==0&&(T[D++]=$t);let Zt=(Ht+1)%C*P+Nt+mt;S[Mt+1][mt][Zt]=$t}if((re+1)%C==0&&re!==w-1&&(wt+1)%C==0&&wt!==w-1){let $t=x[k+w+1],Zt=je.checkNoDataValue(y,$t),ki=z;Ee||B||rt||Zt||(ki=.25*(z+O+N+$t)),Wt=(Ht+1)*P+(Nt+1),Bt[Wt]=ki,T[D++]=ki;let Os=(Ht+1)*P;S[Mt][mt+1][Os]=ki;let Rc=C;S[Mt+1][mt][Rc]=ki;let Sc=0;S[Mt+1][mt+1][Sc]=ki}}})(d,this.noDataValues,_,g);let m=zt.getTileIndex(o,a,h,s);this.setElevationCache(m,{heights:_,extent:c});let p=this._imageSize/this.plainGridSize;for(let x=0;x<p;x++)for(let y=0;y<p;y++){let T=2*o+y,S=2*a+x,C=h+1,P=zt.getTileIndex(T,S,C,s);this.setElevationCache(P,{heights:g[x][y],extent:Ze(T,S,C)})}return _}}class St extends gn{constructor(t,n={}){super(t||"RgbTerrain",{equalizeVertices:n.equalizeVertices==null||n.equalizeVertices,maxZoom:n.maxZoom||17,noDataValues:n.noDataValues||[n.minHeight!=null?n.minHeight:-1e4],plainGridSize:n.plainGridSize||128,url:n.url!=null?n.url:`//api.mapbox.com/v4/mapbox.terrain-rgb/{z}/{x}/{y}.pngraw?access_token=${n.key||"<key>"}`,gridSizeByZoom:n.gridSizeByZoom||[64,32,16,8,8,8,16,16,16,32,32,32,32,32,32,64,64,64,32,32,16,8],...n}),this.equalizeNormals=n.equalizeNormals||!1,this._dataType="imageBitmap",this._imageSize=n.imageSize||256,this._ctx=this._createTemporalCanvas(this._imageSize),this._imageDataCache={},this._minHeight=n.minHeight||-1e4,this._resolution=n.resolution||.1}static checkNoDataValue(t,n){return n>5e4||Xr(t,n)!==-1}rgb2Height(t,n,s){return t===255?this._minHeight:this._minHeight+this._resolution*(256*t*256+256*n+s)}isBlur(t){return t.tileZoom>=16}_createTemporalCanvas(t){let n=document.createElement("canvas");return n.width=t,n.height=t,n.getContext("2d",{willReadFrequently:!0})}_createHeights(t,n,s,o,a,h,c,u){this._ctx.clearRect(0,0,this._imageSize,this._imageSize),this._ctx.drawImage(t,0,0);let d=this._ctx.getImageData(0,0,this._imageSize,this._imageSize).data;const f=t.width;let g=0,_=0,m=0,p=null,x=!1;if(n&&n.tileZoom>this.maxNativeZoom){let w=n.node;for(;w&&!w.segment.terrainExists;)w=w.parentNode;w&&(g=w.segment.tileX,_=w.segment.tileY,m=w.segment.tileZoom,p=w.segment.elevationData,x=m<=8)}if(!Ki(this._imageSize)&&f===this._imageSize){let w=new Float32Array(f*f);return this.extractElevationTilesRgbNonPowerOfTwo(d,w,this._heightFactor),w}if(this._imageSize===this.plainGridSize){let w=(this.plainGridSize+1)*(this.plainGridSize+1),I=new Float32Array(w),[O,N,k]=n?rr(n.tileX,n.tileY,n.tileZoom,g,_,m):[0,0,0];return this.extractElevationSimple(d,this.noDataValues,p,O,N,k,x,I,this._heightFactor,this._imageSize),I}let y=(this.plainGridSize+1)*(this.plainGridSize+1),T=f/this.plainGridSize,S=new Float32Array(y),C=new Array(T);for(let w=0;w<T;w++){C[w]=[];for(let I=0;I<T;I++)C[w][I]=new Float32Array(y)}if(u)this.extractElevationTilesRgbNoChildren(d,this._heightFactor,this.noDataValues,p,g,_,m,n?n.tileX:0,n?n.tileY:0,n?n.tileZoom:0,x,S);else{this.extractElevationTilesRgb(d,this._heightFactor,this.noDataValues,p,g,_,m,n?n.tileX:0,n?n.tileY:0,n?n.tileZoom:0,x,S,C);for(let w=0;w<T;w++)for(let I=0;I<T;I++){let[O,N,k]=[2*o+I,2*a+w,h+1],D=zt.getTileIndex(O,N,k,s);this.setElevationCache(D,{heights:C[w][I],extent:Ze(O,N,k)})}}let P=zt.getTileIndex(o,a,h,s);return this.setElevationCache(P,{heights:S,extent:c}),S}getHeightAsync(t,n,s){if((s=s??this.maxZoom)===0)return n(0),!0;const o=this._planet.quadTreeStrategy,[a,h,c,u]=o.getTileXY(t,s),[d,f]=o.getLonLatTileOffset(t,a,h,c,this._imageSize),g=4*(d*this._imageSize+f),_=zt.getTileIndex(a,h,c,u);if(this._imageDataCache[_]){let p=this._imageDataCache[_],x=this._heightFactor*this.rgb2Height(p[g],p[g+1],p[g+2]);return St.checkNoDataValue(this.noDataValues,x)?this.getHeightAsync(t,n,s-1):(n(this._heightFactor*this.rgb2Height(p[g],p[g+1],p[g+2])),!0)}let m=this._fetchCache[_];return m||(m=this._loader.fetch({src:this._urlRewriteCallback&&this._urlRewriteCallback(a,h,c,u)||this.buildURL(a,h,c,u),type:this._dataType,options:{cache:this._cache}}),this._fetchCache[_]=m),m.then(p=>{if(p.status==="ready"){this._ctx.clearRect(0,0,this._imageSize,this._imageSize),this._ctx.drawImage(p.data,0,0);let x=this._ctx.getImageData(0,0,256,256).data;this._imageDataCache[_]=x;let y=this._heightFactor*this.rgb2Height(x[g],x[g+1],x[g+2]);if(St.checkNoDataValue(this.noDataValues,y))return this.getHeightAsync(t,n,s-1);n(this._heightFactor*this.rgb2Height(x[g],x[g+1],x[g+2]))}else{if(p.status==="error")return this.getHeightAsync(t,n,s-1);this._fetchCache[_]=null,delete this._fetchCache[_]}}),!1}extractElevationSimple(t,n,s=null,o,a,h,c,u,d=1,f){for(let _=0,m=f*f;_<m;_++){let p=_%f,x=Math.floor(_/f),y=4*_,T=d*this.rgb2Height(t[y],t[y+1],t[y+2]);(St.checkNoDataValue(n,T)||T===0)&&s&&(T=Xt(h,o,a,s,x,p,c)),u[x*(f+1)+p]=T}for(let _=0,m=f;_<m;_++){let p=f-1,x=4*(_*f+p),y=d*this.rgb2Height(t[x],t[x+1],t[x+2]);(St.checkNoDataValue(n,y)||y===0)&&s&&(y=Xt(h,o,a,s,_,p,c)),u[_*(f+1)+f]=y}for(let _=0,m=f;_<m;_++){let p=f-1,x=4*(p*f+_),y=d*this.rgb2Height(t[x],t[x+1],t[x+2]);(St.checkNoDataValue(n,y)||y===0)&&s&&(y=Xt(h,o,a,s,p,_,c)),u[f*(f+1)+_]=y}let g=d*this.rgb2Height(t[t.length-4],t[t.length-3],t[t.length-2]);(St.checkNoDataValue(n,g)||g===0)&&s&&(g=Xt(h,o,a,s,f-1,f-1,c)),u[u.length-1]=g}extractElevationTilesRgbNonPowerOfTwo(t,n,s=1){for(let o=0,a=n.length;o<a;o++){let h=4*o;n[o]=s*this.rgb2Height(t[h],t[h+1],t[h+2])}}extractElevationTilesRgb(t,n,s,o=null,a,h,c,u,d,f,g,_,m){let p=Math.sqrt(_.length)-1,x=p+1,y=Math.sqrt(t.length/4),T=y/p,S=0,C=0,P=0,[w,I,O]=rr(u,d,f,a,h,c);for(let N=0,k=0,D=t.length/4;N<D;N++){let ze=4*N,z=n*this.rgb2Height(t[ze],t[ze+1],t[ze+2]),Ee=St.checkNoDataValue(s,z),B=!1,rt=!1,wt=Math.floor(N/y),re=N%y;(Ee||z===0)&&o&&(z=Xt(O,w,I,o,Math.floor(wt/T),Math.floor(re/T),g));let mt=Math.floor(re/p),Mt=Math.floor(wt/p),Bt=m[Mt][mt],Ht=wt%p,Nt=re%p,Wt=(Ht+Mt)*x+Nt+mt;if(Bt[Wt]=z,(wt+Mt)%T==0&&(re+mt)%T==0&&(_[k++]=z),(re+1)%p==0&&re!==y-1){S=n*this.rgb2Height(t[ze+4],t[ze+5],t[ze+6]),B=St.checkNoDataValue(s,S),(B||S===0)&&o&&(S=Xt(O,w,I,o,Math.floor(wt/T),Math.floor((re+1)/T),g));let $t=z;Ee||B||($t=.5*(z+S)),Wt=(Ht+Mt)*x+Nt+1,Bt[Wt]=$t,(wt+Mt)%T==0&&(_[k++]=$t);let Zt=(Ht+Mt)*x+(Nt+1)%p;m[Mt][mt+1][Zt]=$t}if((wt+1)%p==0&&wt!==y-1){P=4*y,C=n*this.rgb2Height(t[ze+P],t[ze+P+1],t[ze+P+2]),rt=St.checkNoDataValue(s,C),(rt||C===0)&&o&&(C=Xt(O,w,I,o,Math.floor((wt+1)/T),Math.floor(re/T),g));let $t=.5*(z+C);Ee||rt||($t=.5*(z+C)),Wt=(Ht+1)*x+Nt+mt,Bt[Wt]=$t,(re+mt)%T==0&&(_[k++]=$t);let Zt=(Ht+1)%p*x+Nt+mt;m[Mt+1][mt][Zt]=$t}if((re+1)%p==0&&re!==y-1&&(wt+1)%p==0&&wt!==y-1){let $t=n*this.rgb2Height(t[ze+P+4],t[ze+P+5],t[ze+P+6]),Zt=St.checkNoDataValue(s,$t);(Zt||$t===0)&&o&&($t=Xt(O,w,I,o,Math.floor((wt+1)/T),Math.floor((re+1)/T),g));let ki=z;Ee||B||rt||Zt||(ki=.25*(z+S+C+$t)),Wt=(Ht+1)*x+(Nt+1),Bt[Wt]=ki,_[k++]=ki;let Os=(Ht+1)*x;m[Mt][mt+1][Os]=ki;let Rc=p;m[Mt+1][mt][Rc]=ki;let Sc=0;m[Mt+1][mt+1][Sc]=ki}}}extractElevationTilesRgbNoChildren(t,n,s,o=null,a,h,c,u,d,f,g,_){let m=Math.sqrt(_.length)-1,p=m+1,x=Math.sqrt(t.length/4),y=x/m,T=0,S=0,C=0,[P,w,I]=rr(u,d,f,a,h,c);for(let O=0,N=0,k=t.length/4;O<k;O++){let D=4*O,ze=n*this.rgb2Height(t[D],t[D+1],t[D+2]),z=St.checkNoDataValue(s,ze),Ee=!1,B=!1,rt=Math.floor(O/x),wt=O%x;(z||ze===0)&&o&&(ze=Xt(I,P,w,o,Math.floor(N/p),N%p,g));let re=Math.floor(wt/m),mt=Math.floor(rt/m);if((rt+mt)%y==0&&(wt+re)%y==0&&(_[N++]=ze),(wt+1)%m==0&&wt!==x-1){T=n*this.rgb2Height(t[D+4],t[D+5],t[D+6]),Ee=St.checkNoDataValue(s,T),(Ee||T===0)&&o&&(T=Xt(I,P,w,o,Math.floor(N/p),N%p,g));let Mt=ze;z||Ee||(Mt=.5*(ze+T)),(rt+mt)%y==0&&(_[N++]=Mt)}if((rt+1)%m==0&&rt!==x-1){C=4*x,S=n*this.rgb2Height(t[D+C],t[D+C+1],t[D+C+2]),B=St.checkNoDataValue(s,S),(B||S===0)&&o&&(S=Xt(I,P,w,o,Math.floor(N/p),N%p,g));let Mt=.5*(ze+S);z||B||(Mt=.5*(ze+S)),(wt+re)%y==0&&(_[N++]=Mt)}if((wt+1)%m==0&&wt!==x-1&&(rt+1)%m==0&&rt!==x-1){let Mt=n*this.rgb2Height(t[D+C+4],t[D+C+5],t[D+C+6]),Bt=St.checkNoDataValue(s,Mt);(Bt||Mt===0)&&o&&(Mt=Xt(I,P,w,o,Math.floor(N/p),N%p,g));let Ht=ze;z||Ee||B||Bt||(Ht=.25*(ze+T+S+Mt)),_[N++]=Ht}}}}function rr(l,t,n,s,o,a){let h=2<<n-a-1;return[l-h*s,t-h*o,1/h]}function Xt(l,t,n,s,o,a,h){let c=Math.sqrt(s.length),u=s[Math.floor(n*l*c+o*l)*c+Math.floor(t*l*c+a*l)];return h&&u>0?0:u}const ac={[Le]:"north",[Pe]:"south"},lc=(l,t,n,s)=>{let o=ac[s];if(o)return`https://terrain.openglobus.org/poles/${o}/${n}/${l}/${t}.png`};class hc extends St{constructor(t,n){super(t||"GlobusEarthRgb",{maxNativeZoom:6,maxZoom:17,url:"https://{s}.terrain.openglobus.org/all/{z}/{x}/{y}.png",urlRewrite:lc,...n})}isReadyToLoad(t){return this._extent.overlaps(t.getExtentLonLat())}}Object.freeze(Object.defineProperty({__proto__:null,BilTerrain:je,EmptyTerrain:Mi,GlobusRgbTerrain:hc,GlobusTerrain:gn,RgbTerrain:St},Symbol.toStringTag,{value:"Module"}));class cc extends Ai{constructor(t,n={}){super(t,n),this._sourceTexture=n.texture||null,n.texture&&(this._sourceReady=!0,this._sourceCreated=!0),this._frameWidth=n.frameWidth!=null?$e(n.frameWidth):256,this._frameHeight=n.frameHeight!=null?$e(n.frameHeight):256,this._animate=!0}get instanceName(){return"GeoTexture2d"}loadMaterial(t){this._planet._geoImageCreator.add(this)}bindTexture(t){this._sourceReady=!0,this._sourceCreated=!0,this._sourceTexture=t}setSize(t,n){this._frameWidth=t,this._frameHeight=n,this._frameCreated=!1}abortMaterialLoading(t){this._creationProceeding=!1,t.isLoading=!1,t.isReady=!1}}class dc extends Ai{constructor(t,n={}){super(t,n),this._animate=!0,this._video=n.videoElement||null,this._src=n.src||null}get instanceName(){return"GeoVideo"}setSrc(t){this._planet&&this._planet._geoImageCreator.remove(this),this._src=t,this._sourceReady=!1}setVideoElement(t){this._planet&&this._planet._geoImageCreator.remove(this),this._video=t,this._src=t.src,this._sourceReady=!1}setVisibility(t){t!=this._visibility&&(super.setVisibility(t),this._planet&&(t?(this._sourceReady&&this._planet._geoImageCreator.add(this),this._video&&this._video.play()):(this._sourceReady&&this._planet._geoImageCreator.remove(this),this._video&&this._video.pause())))}_createSourceTexture(){let t=this._planet.renderer.handler.gl;this._sourceCreated?(t.bindTexture(t.TEXTURE_2D,this._sourceTexture),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,this._video)):(this._sourceTexture=this._planet.renderer.handler.createTexture_n_webgl1(this._video),this._sourceCreated=!0)}_onCanPlay(t){this._frameWidth=t.videoWidth,this._frameHeight=t.videoHeight,t.width=t.videoWidth,t.height=t.videoHeight,t.play(),this._sourceReady=!0,this._planet._geoImageCreator.add(this)}_onError(t){let n="unknown error";switch(t.error.code){case 1:n="video loading aborted";break;case 2:n="network loading error";break;case 3:n="video decoding failed / corrupted data or unsupported codec";break;case 4:n="video not supported"}console.warn(`Error: ${n} error-code=${t.error.code})`)}loadMaterial(t){if(t.isLoading=!0,this._creationProceeding=!0,!this._sourceReady&&this._src){if(this._video){if(this._video.readyState===this._video.HAVE_ENOUGH_DATA)this._onCanPlay(this._video);else if(this._video.src){let n=this;this._video.addEventListener("canplay",function(s){n._onCanPlay(this)})}}else{this._video=document.createElement("video"),this._video.crossOrigin="Anonymous";let n=this;this._video.addEventListener("canplay",function(){n._onCanPlay(this)}),this._video.addEventListener("error",function(){n._onError(this)})}this._video.autoplay=!0,this._video.loop=!0,this._video.src=this._src,this._video.muted=!0,this._video.setAttribute("playsinline","true"),this._video.setAttribute("webkit-playsinline","true")}else this._planet._geoImageCreator.add(this)}abortMaterialLoading(t){this._video&&(this._video.src=""),this._creationProceeding=!1,t.isLoading=!1,t.isReady=!1}}class uc extends _t{constructor(t,n={}){super(t,n),this._billboard=n.billboard||{src:"https://openglobus.org/examples/billboards/carrot.png"},this._color=n.color||"#6689db"}get instanceName(){return"KML"}_extractCoordonatesFromKml(t){return Array.from(t.getElementsByTagName("coordinates")).map(n=>n.textContent.trim()).map(n=>n.replace(/\n/g," ").replace(/\t/g," ").replace(/ +/g," ").split(" ").map(s=>s.split(",").map(parseFloat)))}_AGBRtoRGBA(t){if(!t||t.length!=8)return;const n=parseInt(t.slice(0,2),16)/255,s=parseInt(t.slice(2,4),16),o=parseInt(t.slice(4,6),16);return`rgba(${parseInt(t.slice(6,8),16)},${o},${s},${n})`}_parseKMLcoordinates(t){return t.innerHTML.trim().replace(/\n/g," ").replace(/\t/g," ").replace(/ +/g," ").split(" ").map(n=>n.split(",").map(parseFloat))}_kmlPlacemarkToEntity(t,n){if(!t)return;const s=Array.from(t.getElementsByTagName("name")),o=s&&s.length>0?s[0].innerHTML.trim():"",{iconHeading:a,iconURL:h,iconColor:c,lineWidth:u,lineColor:d}=this._extractStyle(t),f=[];for(const g of t.getElementsByTagName("coordinates")){const _=this._parseKMLcoordinates(g)||[[0,0,0]];for(const m of _){const[p,x,y]=m;f.push(new L(p,x,y)),p<n.southWest.lon&&(n.southWest.lon=p),x<n.southWest.lat&&(n.southWest.lat=x),p>n.northEast.lon&&(n.northEast.lon=p),x>n.northEast.lat&&(n.northEast.lat=x)}}if(f.length===1){const g=.01745329*a;return new G({name:o,lonlat:f[0],billboard:{src:h,size:[24,24],color:c,rotation:g},properties:{color:c,heading:a}})}return new G({name:o,polyline:{pathLonLat:[f],thickness:u,color:d,isClosed:!1},properties:{name:o}})}_extractStyle(t){let n,s,o,a,h;const c=t.getElementsByTagName("Style")[0];if(c){let u=c.getElementsByTagName("IconStyle")[0];if(u){let f=u.getElementsByTagName("color")[0];f&&(n=this._AGBRtoRGBA(f.innerHTML.trim()));let g=u.getElementsByTagName("heading")[0];if(g){const m=parseFloat(g.innerHTML.trim());m>=0&&m<=360&&(s=m%360)}let _=u.getElementsByTagName("Icon")[0];if(_){let m=_.getElementsByTagName("href")[0];m&&(o=m.innerHTML.trim())}}let d=c.getElementsByTagName("LineStyle")[0];if(d){let f=d.getElementsByTagName("color")[0];f&&(a=this._AGBRtoRGBA(f.innerHTML.trim()));let g=d.getElementsByTagName("width")[0];g!==void 0&&(h=parseFloat(g.innerHTML.trim()))}}return n||(n="#FFFFFF"),s||(s=0),o||(o="https://openglobus.org/examples/billboards/carrot.png"),a||(a="#FFFFFF"),h||(h=1),{iconHeading:s,iconURL:o,iconColor:n,lineWidth:h,lineColor:a}}_parseKML(t,n,s){if(s||(s=[]),t.documentElement.nodeName!=="kml")return s;for(const o of t.getElementsByTagName("Placemark")){const a=this._kmlPlacemarkToEntity(o,n);a&&s.push(a)}return s}_convertKMLintoEntities(t){const n=new U(new L(180,90),new L(-180,-90));return{entities:this._parseKML(t,n),extent:n}}_convertCoordonatesIntoEntities(t,n,s){const o=new U(new L(180,90),new L(-180,-90)),a=c=>{const u=c[0],d=c[1];u<o.southWest.lon&&(o.southWest.lon=u),d<o.southWest.lat&&(o.southWest.lat=d),u>o.northEast.lon&&(o.northEast.lon=u),d>o.northEast.lat&&(o.northEast.lat=d)},h=[];return t.forEach(c=>c.forEach(u=>h.push(u))),{entities:h.map(c=>{if(c.length===1){const u=c[0],d=new G({lonlat:u,billboard:s});return a(u),d}if(c.length>1){const u=c.map(d=>(a(d),new L(d[0],d[1],d[2])));return new G({polyline:{pathLonLat:[u],thickness:3,color:n,isClosed:!1}})}}),extent:o}}_getXmlContent(t){return new Promise(n=>{const s=new FileReader;s.onload=async o=>n(new DOMParser().parseFromString(o.target.result,"text/xml")),s.readAsText(t)})}_expandExtents(t,n){return t?(n.southWest.lon<t.southWest.lon&&(t.southWest.lon=n.southWest.lon),n.southWest.lat<t.southWest.lat&&(t.southWest.lat=n.southWest.lat),n.northEast.lon>t.northEast.lon&&(t.northEast.lon=n.northEast.lon),n.northEast.lat>t.northEast.lat&&(t.northEast.lat=n.northEast.lat),t):n}async addKmlFromFiles(t,n,s){if(!Array.isArray(t))return null;const o=(await Promise.all(t.map(this._getXmlContent))).map(this._extractCoordonatesFromKml),{entities:a,extent:h}=this._convertCoordonatesIntoEntities(o,n||this._color,s||this._billboard);return this._extent=this._expandExtents(this._extent,h),a.forEach(this.add.bind(this)),{entities:a,extent:h}}setColor(t){this._color=t,this._billboard.color=t}_getKmlFromUrl(t){return new Promise((n,s)=>{const o=new XMLHttpRequest;o.open("GET",t,!0),o.responseType="document",o.overrideMimeType("text/xml"),o.onload=()=>{o.readyState===o.DONE&&o.status===200?n(o.responseXML):s(new Error("no valid kml file"))},o.send()})}async addKmlFromUrl(t,n,s){const o=await this._getKmlFromUrl(t),{entities:a,extent:h}=this._convertKMLintoEntities(o);return this._extent=this._expandExtents(this._extent,h),a.forEach(this.add.bind(this)),{entities:a,extent:h}}}class _c extends Ds{constructor(t,n={}){super(t||"OpenStreetMap",{iconSrc:"https://tile.openstreetmap.org/8/138/95.png",url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",attribution:"Data @ OpenStreetMap contributors, ODbL",isBaseLayer:!0,maxNativeZoom:19,defaultTextures:[{color:"#AAD3DF"},{color:"#F2EFE9"}],isSRGB:!1,shininess:18,specular:[63e-5,55e-5,32e-5],ambient:[.2,.2,.3],diffuse:[.9,.9,.7],...n})}}function fc(l,t,n){var s="";for(let h=n;h>0;h--){var o=0,a=1<<h-1;l&a&&o++,t&a&&(o+=2),s+=o.toString()}return s}class gc extends Ds{constructor(t,n={}){super(t||"Bing",{iconSrc:"https://ecn.t0.tiles.virtualearth.net/tiles/a120.jpeg?n=z&g=7146",subdomains:["t0","t1","t2","t3"],url:"https://ecn.{s}.tiles.virtualearth.net/tiles/a{quad}.jpeg?n=z&g=7146",isBaseLayer:!0,textureFilter:"LINEAR",maxNativeZoom:17,defaultTextures:[{color:"#001522"},{color:"#E4E6F3"}],attribution:'<div style="transform: scale(0.8); margin-top:-2px;"><a href="https://www.bing.com" target="_blank"><img style="position: relative; top: 2px;" title="Bing Imagery" src="https://sandcastle.cesium.com/CesiumUnminified/Assets/Images/bing_maps_credit.png"></a> © 2021 Microsoft Corporation</div>',urlRewrite:(s,o)=>Dt(o,{s:this._getSubdomain(),quad:fc(s.tileX,s.tileY,s.tileZoom)}),specular:[63e-5,55e-5,32e-5],ambient:[.35,.35,.35],diffuse:[1.5,1.5,1.5],shininess:20,nightTextureCoefficient:2.7,...n})}}Object.freeze(Object.defineProperty({__proto__:null,Bing:gc,CanvasTiles:ss,GeoImage:Ca,GeoTexture2d:cc,GeoVideo:dc,KML:uc,LAYER_EVENTS:Go,Layer:zt,Material:Uo,OpenStreetMap:_c,Vector:_t,WMS:me,XYZ:Ds},Symbol.toStringTag,{value:"Module"}));const nr=function(l,t){return+(l.priority<t.priority)};class pc{constructor(){this._currentlyPressedKeys={},this._pressedKeysCallbacks={},this._unpressedKeysCallbacks={},this._charkeysCallbacks={},this._anykeyCallback=null,this._event=null,this._active=!0,this._stampCache={},document.onkeydown=t=>{this._event=t,this._active&&this.handleKeyDown()},document.onkeyup=t=>{this._event=t,this._active&&this.handleKeyUp()}}getcurrentlyPressedKeys(){return this._currentlyPressedKeys}getPressedKeysCallbacks(){return this._pressedKeysCallbacks}getUnpressedKeysCallbacks(){return this._unpressedKeysCallbacks}getCharkeysCallbacks(){return this._charkeysCallbacks}removeEvent(t,n,s){let o=this._getStamp(t,n,s._openglobus_id);s._openglobus_id&&this._stampCache[o]&&(delete this._stampCache[o],t==="keypress"?this._removeCallback(this._pressedKeysCallbacks[n],s):t==="keyfree"?this._removeCallback(this._unpressedKeysCallbacks[n],s):t==="charkeypress"&&this._removeCallback(this._charkeysCallbacks[n],s))}_removeCallback(t,n){for(let s=0;s<t.length;s++)t[s].callback._openglobus_id===n._openglobus_id&&t.splice(s,1)}_getStamp(t,n,s){return`${t}_${n}_${s}`}_stamp(t,n,s){const o=Yr(s),a=this._getStamp(t,n,o);return!this._stampCache[a]&&(this._stampCache[a]=o,!0)}setActivity(t){this._active=t}releaseKeys(){this._currentlyPressedKeys={}}addEvent(t,n,s,o,a){if(this._stamp(t,n,s))switch(a===void 0&&(a=1600),t){case"keyfree":this._unpressedKeysCallbacks[n]||(this._unpressedKeysCallbacks[n]=[]),this._unpressedKeysCallbacks[n].push({callback:s,sender:o,priority:a}),this._unpressedKeysCallbacks[n].sort(nr);break;case"keypress":n==null?this._anykeyCallback={callback:s,sender:o||this}:(this._pressedKeysCallbacks[n]||(this._pressedKeysCallbacks[n]=[]),this._pressedKeysCallbacks[n].push({callback:s,sender:o,priority:a}),this._pressedKeysCallbacks[n].sort(nr));break;case"charkeypress":this._charkeysCallbacks[n]||(this._charkeysCallbacks[n]=[]),this._charkeysCallbacks[n].push({callback:s,sender:o,priority:a}),this._charkeysCallbacks[n].sort(nr)}}isKeyPressed(t){return this._currentlyPressedKeys[t]}handleKeyDown(){this._anykeyCallback&&this._anykeyCallback.callback.call(this._anykeyCallback.sender,this._event),this._currentlyPressedKeys[this._event.keyCode]=!0;for(let t in this._charkeysCallbacks)if(String.fromCharCode(this._event.keyCode)===String.fromCharCode(Number(t))){let n=this._charkeysCallbacks[t];for(let s=0;s<n.length;s++)n[s].callback.call(n[s].sender,this._event)}this._event.keyCode!=W.KEY_ALT&&this._event.keyCode!=W.KEY_SHIFT||this._event.preventDefault()}handleKeyUp(){if(this._currentlyPressedKeys[this._event.keyCode]||this._event.keyCode===W.KEY_PRINTSCREEN){for(let t in this._unpressedKeysCallbacks)if(this._currentlyPressedKeys[t]||this._event.keyCode===W.KEY_PRINTSCREEN&&Number(t)===W.KEY_PRINTSCREEN){let n=this._unpressedKeysCallbacks[t];for(let s=0;s<n.length;s++)n[s].callback.call(n[s].sender,this._event)}}this._currentlyPressedKeys[this._event.keyCode]=!1}handleEvents(){for(let t in this._pressedKeysCallbacks)if(this._currentlyPressedKeys[t]){let n=this._pressedKeysCallbacks[t];for(let s=0;s<n.length;s++)n[s].callback.call(n[s].sender,this._event)}}}class mc{constructor(t){this._htmlObject=t}setEvent(t,n,s){switch(t){case"mousewheel":this._htmlObject.addEventListener("wheel",o=>{let a=o.deltaY||o.detail||o.wheelDelta||0;var h;o.wheelDelta==null&&(o.wheelDelta=-120*a),o.isTouchPad=(h=o).deltaMode===0&&Math.abs(h.deltaY)<50,s.call(n,o),o.preventDefault()},!1);break;case"mousedown":this._htmlObject.addEventListener("mousedown",function(o){let a=this.getBoundingClientRect();s.call(n,o,{button:o.button,clientX:o.clientX-a.left,clientY:o.clientY-a.top})}),this._htmlObject.addEventListener("contextmenu",function(o){return o.preventDefault(),!1});break;case"mouseup":this._htmlObject.addEventListener("mouseup",function(o){let a=this.getBoundingClientRect();s.call(n,o,{button:o.button,clientX:o.clientX-a.left,clientY:o.clientY-a.top})});break;case"mousemove":this._htmlObject.addEventListener("mousemove",function(o){let a=this.getBoundingClientRect();s.call(n,o,{clientX:o.clientX-a.left,clientY:o.clientY-a.top})});break;case"mouseleave":this._htmlObject.addEventListener("mouseleave",function(o){s.call(n,o)});break;case"mouseout":this._htmlObject.addEventListener("mouseout",function(o){s.call(n,o)});break;case"mouseover":this._htmlObject.addEventListener("mouseover",function(o){s.call(n,o)});break;case"mouseenter":this._htmlObject.addEventListener("mouseenter",function(o){s.call(n,o)})}}}class vc{constructor(t){this._htmlObject=t}setEvent(t,n,s){switch(t){case"touchcancel":this._htmlObject.addEventListener("touchcancel",function(o){o.preventDefault();const a=this.getBoundingClientRect(),h=Object.assign(o,{offsetLeft:a.left,offsetTop:a.top});s.call(n,h)});break;case"touchstart":this._htmlObject.addEventListener("touchstart",function(o){o.preventDefault();const a=this.getBoundingClientRect(),h=Object.assign(o,{offsetLeft:a.left,offsetTop:a.top});s.call(n,h)});break;case"touchend":this._htmlObject.addEventListener("touchend",function(o){o.preventDefault();const a=this.getBoundingClientRect(),h=Object.assign(o,{offsetLeft:a.left,offsetTop:a.top});s.call(n,h)});break;case"touchmove":this._htmlObject.addEventListener("touchmove",function(o){o.preventDefault();const a=this.getBoundingClientRect(),h=Object.assign(o,{offsetLeft:a.left,offsetTop:a.top});s.call(n,h)})}}}let _e=new Uint8Array(4),ei=new Uint8Array(4),ii=new Uint8Array(4);class yc extends bi{constructor(t){super(xc),this.renderer=t,this._touchHandler=new vc(t.handler.canvas),this._mouseHandler=new mc(t.handler.canvas),this._keyboardHandler=new pc,this._active=!0,this.clickRadius=15,this.mouseState={clientX:0,clientY:0,pos:new H,x:0,y:0,nx:0,ny:0,prev_x:0,prev_y:0,direction:new v,leftButtonUp:!1,rightButtonUp:!1,middleButtonUp:!1,leftButtonDown:!1,rightButtonDown:!1,middleButtonDown:!1,leftButtonHold:!1,rightButtonHold:!1,middleButtonHold:!1,leftButtonDoubleClick:!1,rightButtonDoubleClick:!1,middleButtonDoubleClick:!1,leftButtonClick:!1,rightButtonClick:!1,middleButtonClick:!1,moving:!1,justStopped:!1,doubleClickDelay:500,clickDelay:200,wheelDelta:0,sys:null,pickingObject:null,renderer:t,isTouchPad:!1},this.touchState={touching:!1,moving:!1,touchEnd:!1,touchStart:!1,touchCancel:!1,doubleTouch:!1,doubleTouchDelay:550,doubleTouchRadius:10,clientX:0,clientY:0,pos:new H,x:0,y:0,nx:0,ny:0,prev_x:0,prev_y:0,direction:new v,sys:null,pickingObject:null,renderer:t},this._isMouseInside=!0,this._entityPickingEventsActive=!0,this._dblTchCoords=new H,this._oneTouchStart=!1,this._dblTchBegins=0,this._mousestopThread=null,this._ldblClkBegins=0,this._rdblClkBegins=0,this._mdblClkBegins=0,this._lClkBegins=0,this._rClkBegins=0,this._mClkBegins=0,this._lclickX=0,this._lclickY=0,this._rclickX=0,this._rclickY=0,this._mclickX=0,this._mclickY=0}pointerEvent(){let t=this.mouseState;return t.moving||t.justStopped||t.wheelDelta!==0}get active(){return this._active}set active(t){this._active=t,this._keyboardHandler.setActivity(t)}handleEvents(){this._active&&(this.mouseState.direction=this.renderer.activeCamera.unproject(this.mouseState.x,this.mouseState.y),this.touchState.direction=this.renderer.activeCamera.unproject(this.touchState.x,this.touchState.y),this._keyboardHandler.handleEvents(),this.handleMouseEvents(),this.handleTouchEvents(),this.entityPickingEvents())}on(t,n,s,o,a){t==="keypress"||t==="charkeypress"||t==="keyfree"?this._keyboardHandler.addEvent(t,n,s,o,a):super.on(t,n,s,o)}off(t,n,s){t==="keypress"||t==="charkeypress"||t==="keyfree"?this._keyboardHandler.removeEvent(t,n,s):super.off(t,n)}isKeyPressed(t){return this._keyboardHandler.isKeyPressed(t)}releaseKeys(){this._keyboardHandler.releaseKeys()}initialize(){this._mouseHandler.setEvent("mouseup",this,this.onMouseUp),this._mouseHandler.setEvent("mousemove",this,this.onMouseMove),this._mouseHandler.setEvent("mousedown",this,this.onMouseDown),this._mouseHandler.setEvent("mousewheel",this,this.onMouseWheel),this._mouseHandler.setEvent("mouseleave",this,this.onMouseLeave),this._mouseHandler.setEvent("mouseenter",this,this.onMouseEnter),this._touchHandler.setEvent("touchstart",this,this.onTouchStart),this._touchHandler.setEvent("touchend",this,this.onTouchEnd),this._touchHandler.setEvent("touchcancel",this,this.onTouchCancel),this._touchHandler.setEvent("touchmove",this,this.onTouchMove)}onMouseWheel(t){this.mouseState.isTouchPad=t.isTouchPad||!1,this.mouseState.sys=t,this.mouseState.wheelDelta=t.wheelDelta||0}updateButtonsStates(t){let n=this.mouseState;1&t&&n.leftButtonDown?n.leftButtonDown=!0:(n.leftButtonHold=!1,n.leftButtonDown=!1),2&t&&n.rightButtonDown?n.rightButtonDown=!0:(n.rightButtonHold=!1,n.rightButtonDown=!1),4&t&&n.middleButtonDown?n.middleButtonDown=!0:(n.middleButtonHold=!1,n.middleButtonDown=!1)}onMouseMove(t,n){let s=this.mouseState;this.updateButtonsStates(t.buttons),s.sys=t;let o=n.clientX,a=n.clientY,h=this.clickRadius;if(Math.abs(this._lclickX-o)>=h&&Math.abs(this._lclickY-a)>=h&&(this._ldblClkBegins=0,this._lClkBegins=0),Math.abs(this._rclickX-o)>=h&&Math.abs(this._rclickY-a)>=h&&(this._rdblClkBegins=0,this._rClkBegins=0),Math.abs(this._mclickX-o)>=h&&Math.abs(this._mclickY-a)>=h&&(this._mdblClkBegins=0,this._mClkBegins=0),s.clientX===n.clientX&&s.clientY===n.clientY)return;s.clientX=n.clientX,s.clientY=n.clientY;let c=this.renderer.handler;s.pos.x=s.x=n.clientX*c.pixelRatio,s.pos.y=s.y=n.clientY*c.pixelRatio,s.nx=s.x/c.canvas.width,s.ny=s.y/c.canvas.height,s.moving=!0,clearTimeout(this._mousestopThread),this._mousestopThread=setTimeout(function(){s.justStopped=!0},100)}onMouseLeave(t){this._isMouseInside=!1,this.mouseState.sys=t,this.dispatch(this.mouseleave,this.mouseState)}onMouseEnter(t){this._isMouseInside=!0,this.mouseState.sys=t,this.dispatch(this.mouseenter,this.mouseState)}onMouseDown(t,n){n.button===W.MB_LEFT?(this._lClkBegins=window.performance.now(),this._lclickX=n.clientX,this._lclickY=n.clientY,this.mouseState.sys=t,this.mouseState.leftButtonDown=!0):n.button===W.MB_RIGHT?(this._rClkBegins=window.performance.now(),this._rclickX=n.clientX,this._rclickY=n.clientY,this.mouseState.sys=t,this.mouseState.rightButtonDown=!0):n.button===W.MB_MIDDLE&&(this._mClkBegins=window.performance.now(),this._mclickX=n.clientX,this._mclickY=n.clientY,this.mouseState.sys=t,this.mouseState.middleButtonDown=!0)}onMouseUp(t,n){let s=this.mouseState;s.sys=t;let o=window.performance.now();n.button===W.MB_LEFT?(s.leftButtonDown=!1,s.leftButtonUp=!0,Math.abs(this._lclickX-n.clientX)<this.clickRadius&&Math.abs(this._lclickY-n.clientY)<this.clickRadius&&o-this._lClkBegins<=s.clickDelay&&(this._ldblClkBegins?(window.performance.now()-this._ldblClkBegins<=s.doubleClickDelay&&(s.leftButtonDoubleClick=!0),this._ldblClkBegins=0):this._ldblClkBegins=window.performance.now(),s.leftButtonClick=!0,this._lClkBegins=0)):n.button===W.MB_RIGHT?(s.rightButtonDown=!1,s.rightButtonUp=!0,Math.abs(this._rclickX-n.clientX)<this.clickRadius&&Math.abs(this._rclickY-n.clientY)<this.clickRadius&&o-this._rClkBegins<=s.clickDelay&&(this._rdblClkBegins?(window.performance.now()-this._rdblClkBegins<=s.doubleClickDelay&&(s.rightButtonDoubleClick=!0),this._rdblClkBegins=0):this._rdblClkBegins=window.performance.now(),s.rightButtonClick=!0,this._rClkBegins=0)):n.button===W.MB_MIDDLE&&(s.middleButtonDown=!1,s.middleButtonUp=!0,Math.abs(this._mclickX-n.clientX)<this.clickRadius&&Math.abs(this._mclickY-n.clientY)<this.clickRadius&&o-this._mClkBegins<=s.clickDelay)&&(this._mdblClkBegins?(window.performance.now()-this._mdblClkBegins<=s.doubleClickDelay&&(s.middleButtonDoubleClick=!0),this._mdblClkBegins=0):this._mdblClkBegins=window.performance.now(),s.middleButtonClick=!0,this._mClkBegins=0)}onTouchStart(t){let n=this.touchState;n.sys=t,n.clientX=t.touches.item(0).clientX-t.offsetLeft,n.clientY=t.touches.item(0).clientY-t.offsetTop;let s=this.renderer.handler;n.pos.x=n.x=n.clientX*s.pixelRatio,n.pos.y=n.y=n.clientY*s.pixelRatio,n.nx=n.x/s.canvas.width,n.ny=n.y/s.canvas.height,n.prev_x=n.x,n.prev_y=n.y,n.touchStart=!0,n.touching=!0,t.touches.length===1?(this._dblTchCoords.x=n.x,this._dblTchCoords.y=n.y,this._oneTouchStart=!0):this._oneTouchStart=!1}onTouchEnd(t){let n=this.touchState;n.sys=t,n.touchEnd=!0,t.touches.length===0&&(n.prev_x=n.x,n.prev_y=n.y,this._oneTouchStart)&&(this._dblTchBegins&&(window.performance.now()-this._dblTchBegins<=n.doubleTouchDelay&&(n.doubleTouch=!0),this._dblTchBegins=0),this._dblTchBegins=window.performance.now(),this._oneTouchStart=!1)}onTouchCancel(t){let n=this.touchState;n.sys=t,n.touchCancel=!0}onTouchMove(t){let n=this.touchState;n.clientX=t.touches.item(0).clientX-t.offsetLeft,n.clientY=t.touches.item(0).clientY-t.offsetTop;let s=this.renderer.handler;n.x=n.clientX*s.pixelRatio,n.y=n.clientY*s.pixelRatio,n.nx=n.x/s.canvas.width,n.ny=n.y/s.canvas.height,n.sys=t,n.moving=!0;let o=n.x-n.prev_x,a=n.y-n.prev_y;(Math.abs(o)>9||Math.abs(a)>9)&&(this._dblTchBegins=0,this._oneTouchStart=!1)}entityPickingEvents(){let t=this.touchState,n=this.mouseState;if(this._isMouseInside!==this._entityPickingEventsActive&&(this._entityPickingEventsActive=this._isMouseInside,!this._entityPickingEventsActive)){let o=this.renderer,a=_e,h=o.getPickingObjectArr(a);if(h){let c=h.rendererEvents;n.pickingObject=h,c&&c.dispatch(c.mouseleave,n),t.pickingObject=h,c&&c.dispatch(c.touchleave,t)}_e[0]=_e[1]=_e[2]=_e[3]=ii[0]=ii[1]=ii[2]=ii[3]=ei[0]=ei[1]=ei[2]=ei[3]=0}if(this._isMouseInside&&!(n.leftButtonHold||n.rightButtonHold||n.middleButtonHold)){let o=this.renderer,a=_e,h=ii,c=ei;t.x||t.y?o.readPickingColor(t.nx,1-t.ny,c):o.readPickingColor(n.nx,1-n.ny,c),h[0]=a[0],h[1]=a[1],h[2]=a[2],a[0]=c[0],a[1]=c[1],a[2]=c[2],n.pickingObject=null,t.pickingObject=null;let u=o.getPickingObjectArr(a);if(n.pickingObject=u,t.pickingObject=u,a[0]!==h[0]||a[1]!==h[1]||a[2]!==h[2])if((s=a)[0]||s[1]||s[2]){if((d=>!!(d[0]||d[1]||d[2]))(h)){let d=o.getPickingObjectArr(h);if(d){let f=d.rendererEvents;n.pickingObject=d,f&&f.dispatch(f.mouseleave,n),t.pickingObject=d,f&&f.dispatch(f.touchleave,t)}}if(u){let d=u.rendererEvents;n.pickingObject=u,d&&d.dispatch(d.mouseenter,n),t.pickingObject=u,d&&d.dispatch(d.touchenter,t)}}else{let d=o.getPickingObjectArr(h);if(d){let f=d.rendererEvents;n.pickingObject=d,f&&f.dispatch(f.mouseleave,n),t.pickingObject=d,f&&f.dispatch(f.touchleave,t)}}}var s}handleMouseEvents(){let t=this,n=this.mouseState,s=n.pickingObject,o=null;n.leftButtonClick&&(s&&(o=s.rendererEvents,o&&o.dispatch(o.lclick,n)),this.dispatch(t.lclick,n),n.leftButtonClick=!1),n.rightButtonClick&&(s&&(o=s.rendererEvents,o&&o.dispatch(o.rclick,n)),this.dispatch(t.rclick,n),n.rightButtonClick=!1),n.middleButtonClick&&(s&&(o=s.rendererEvents,o&&o.dispatch(o.mclick,n)),this.dispatch(t.mclick,n),n.middleButtonClick=!1),n.leftButtonDown&&(n.leftButtonHold?(s&&(o=s.rendererEvents,o&&o.dispatch(o.lhold,n)),this.dispatch(t.lhold,n)):(n.leftButtonHold=!0,s&&(o=s.rendererEvents,o&&o.dispatch(o.ldown,n)),this.dispatch(t.ldown,n))),n.rightButtonDown&&(n.rightButtonHold?(s&&(o=s.rendererEvents,o&&o.dispatch(o.rhold,n)),this.dispatch(t.rhold,n)):(n.rightButtonHold=!0,s&&(o=s.rendererEvents,o&&o.dispatch(o.rdown,n)),this.dispatch(t.rdown,n))),n.middleButtonDown&&(n.middleButtonHold?(s&&(o=s.rendererEvents,o&&o.dispatch(o.mhold,n)),this.dispatch(t.mhold,n)):(n.middleButtonHold=!0,s&&(o=s.rendererEvents,o&&o.dispatch(o.mdown,n)),this.dispatch(t.mdown,n))),n.leftButtonUp&&(s&&(o=s.rendererEvents,o&&o.dispatch(o.lup,n)),this.dispatch(t.lup,n),n.leftButtonUp=!1,n.leftButtonHold=!1),n.rightButtonUp&&(s&&(o=s.rendererEvents,o&&o.dispatch(o.rup,n)),this.dispatch(t.rup,n),n.rightButtonUp=!1,n.rightButtonHold=!1),n.middleButtonUp&&(s&&(o=s.rendererEvents,o&&o.dispatch(o.mup,n)),this.dispatch(t.mup,n),n.middleButtonUp=!1,n.middleButtonHold=!1),n.leftButtonDoubleClick&&(s&&(o=s.rendererEvents,o&&o.dispatch(o.ldblclick,n)),this.dispatch(t.ldblclick,n),n.leftButtonDoubleClick=!1),n.rightButtonDoubleClick&&(s&&(o=s.rendererEvents,o&&o.dispatch(o.rdblclick,n)),this.dispatch(t.rdblclick,n),n.rightButtonDoubleClick=!1),n.middleButtonDoubleClick&&(s&&(o=s.rendererEvents,o&&o.dispatch(o.mdblclick,n)),this.dispatch(t.mdblclick,n),n.middleButtonDoubleClick=!1),n.wheelDelta&&(s&&(o=s.rendererEvents,o&&o.dispatch(o.mousewheel,n)),this.dispatch(t.mousewheel,n)),n.moving&&(s&&(o=s.rendererEvents,o&&o.dispatch(o.mousemove,n)),this.dispatch(t.mousemove,n),n.prev_x=n.x,n.prev_y=n.y),n.justStopped&&this.dispatch(t.mousestop,n)}handleTouchEvents(){let t=this,n=this.touchState,s=n.pickingObject,o=null;if(n.touchCancel&&(this.dispatch(t.touchcancel,n),n.touchCancel=!1),n.touchStart){let a=this.renderer;a.readPickingColor(n.nx,1-n.ny,_e);let h=a.getPickingObjectArr(_e);s=n.pickingObject=h,s&&(o=s.rendererEvents,o&&o.dispatch(o.touchstart,n)),this.dispatch(t.touchstart,n),n.touchStart=!1}n.doubleTouch&&(s&&(o=s.rendererEvents,o&&o.dispatch(o.doubletouch,n)),this.dispatch(t.doubletouch,n),n.doubleTouch=!1),n.touchEnd&&(s&&(o=s.rendererEvents,o&&o.dispatch(o.touchend,n)),this.dispatch(t.touchend,n),n.x=0,n.y=0,n.touchEnd=!1,n.touching=!1),n.moving&&(s&&(o=s.rendererEvents,o&&o.dispatch(o.touchmove,n)),this.dispatch(t.touchmove,n),n.prev_x=n.x,n.prev_y=n.y)}}const xc=["projchanged","changerelativecenter","draw","drawtransparent","postdraw","resize","resizeend","mouseenter","mouseleave","mousemove","mousestop","lclick","rclick","mclick","ldblclick","rdblclick","mdblclick","lup","rup","mup","ldown","rdown","mdown","lhold","rhold","mhold","mousewheel","touchstart","touchend","touchcancel","touchmove","doubletouch","touchleave","touchenter"];class Ii{constructor(t=0,n=0,s=0,o=0){this.left=t,this.right=s,this.top=n,this.bottom=o}set(t=0,n=0,s=0,o=0){this.left=t,this.right=s,this.top=n,this.bottom=o}clone(){return new Ii(this.left,this.top,this.right,this.bottom)}getWidth(){return Math.abs(this.right-this.left)}getHeight(){return Math.abs(this.bottom-this.top)}getSquare(){return this.getHeight()*this.getWidth()}getDiagonal(){let t=this.getWidth(),n=this.getHeight();return Math.sqrt(n*n+t*t)}fit(t,n){return this.getWidth()===t&&this.getHeight()===n}isInside(t,n){return t>=this.left&&t<=this.right&&n>=this.top&&n<=this.bottom}}class bc{constructor(){this.imagesCache={},this._counter=0,this._pendingsQueue=new dn,this._imageIndexCounter=0}load(t,n){if(this.imagesCache[t])n(this.imagesCache[t]);else{let s={src:t,success:n};this._counter>=1?this._pendingsQueue.unshift(s):this._exec(s)}}_exec(t){this._counter++;const n=this;let s=new Image;s.crossOrigin="",s.onload=function(){n.imagesCache[t.src]=s,s.__nodeIndex=n._imageIndexCounter++,t.success(s),n._dequeueRequest()},s.onerror=function(){n._dequeueRequest()},s.src=t.src}_dequeueRequest(){if(this._counter--,this._pendingsQueue.length&&this._counter<1)for(;this._pendingsQueue.length;){let t=this._pendingsQueue.pop();if(t){if(!this.imagesCache[t.src]){this._exec(t);break}this._counter<=0?this._counter=0:this._counter--,t.success(this.imagesCache[t.src])}}}}class Vr{constructor(t=1024,n=1024){this.nodes=new Map,this.texture=null,this.canvas=new mi(t,n),this.clearCanvas(),this._handler=null,this._images=[],this._btree=null,this._imagesCacheManager=new bc,this.borderSize=4}getImage(){return this.canvas.getImage()}getCanvas(){return this.canvas.getCanvas()}clearCanvas(){this.canvas.fillEmpty()}assignHandler(t){this._handler=t,this.createTexture()}getDiagonal(t){let n=t.atlasWidth||t.width,s=t.atlasHeight||t.height;return Math.sqrt(n*n+s*s)}addImage(t,n=!1){if(t.width&&t.height)return this._images.push(t),this._makeAtlas(n),t.__nodeIndex!=null?this.get(t.__nodeIndex):void 0}_completeNode(t,n){if(n){let s=this.canvas.getWidth(),o=this.canvas.getHeight(),a=n.image,h=n.rect,c=Math.round(.5*this.borderSize);this.canvas.drawImage(a,h.left+c,h.top+c,a.atlasWidth||0,a.atlasHeight||0);let u=n.texCoords;u[0]=(h.left+c)/s,u[1]=(h.top+c)/o,u[2]=(h.left+c)/s,u[3]=(h.bottom-c)/o,u[4]=(h.right-c)/s,u[5]=(h.bottom-c)/o,u[6]=(h.right-c)/s,u[7]=(h.bottom-c)/o,u[8]=(h.right-c)/s,u[9]=(h.top+c)/o,u[10]=(h.left+c)/s,u[11]=(h.top+c)/o,t.set(a.__nodeIndex,n)}}_makeAtlas(t=!1){if(t&&this._btree){let n=this._images[this._images.length-1];this._completeNode(this.nodes,this._btree.insert(n))}else{let n=this._images.slice(0);n.sort(function(o,a){return(a.atlasWidth||a.width)-(o.atlasWidth||o.width)||(a.atlasHeight||a.height)-(o.atlasHeight||o.height)}),this._btree=new Bi(new Ii(0,0,this.canvas.getWidth(),this.canvas.getHeight())),this._btree.atlas=this,this.clearCanvas();let s=new Map;for(let o=0;o<n.length;o++)this._completeNode(s,this._btree.insert(n[o]));this.nodes=null,this.nodes=s}}get(t){return this.nodes.get(t)}set(t,n){this.nodes.set(t,n)}createTexture(t,n){this._handler&&(this._handler.gl.deleteTexture(this.texture),t&&(this.canvas.resize(t.width,t.height),this.canvas.drawImage(t,0,0,t.width,t.height)),this.texture=this._handler.createTexture_l(this.canvas.getCanvas(),n))}loadImage(t,n){this._imagesCacheManager.load(t,n)}getImageTexCoordinates(t){if(t.__nodeIndex!=null){let n=this.get(t.__nodeIndex);if(n)return n.texCoords}}}class Bi{constructor(t,n){this.childNodes=null,this.image=null,this.rect=t||new Ii,this.texCoords=n||[],this.atlas=null}insert(t){if(this.childNodes)return this.childNodes[0].insert(t)||this.childNodes[1].insert(t);{if(this.image!=null)return;let n=this.rect;const s=(t.atlasWidth||t.width)+this.atlas.borderSize,o=(t.atlasHeight||t.height)+this.atlas.borderSize;return s>n.getWidth()||o>n.getHeight()?void 0:n.fit(s,o)?(this.image=t,this):(this.childNodes=new Array(2),this.childNodes[0]=new Bi,this.childNodes[0].atlas=this.atlas,this.childNodes[1]=new Bi,this.childNodes[1].atlas=this.atlas,n.getWidth()-s>n.getHeight()-o?(this.childNodes[0].rect.set(n.left,n.top,n.left+s,n.bottom),this.childNodes[1].rect.set(n.left+s,n.top,n.right,n.bottom)):(this.childNodes[0].rect.set(n.left,n.top,n.right,n.top+o),this.childNodes[1].rect.set(n.left,n.top+o,n.right,n.bottom)),this.childNodes[0].insert(t))}}}class _o extends Vr{constructor(t,n){super(t,n),this.width=0,this.height=0,this.gliphSize=0,this.distanceRange=0,this.nodes=new Map,this.kernings={}}get(t){return this.nodes.get(t)}}class wc extends Bi{constructor(t,n){super(t,n),this.emptySize=1,this.metrics={id:0,char:"",width:0,height:0,x:0,y:0,chnl:0,index:0,page:0,xadvance:0,xoffset:0,yoffset:0,nChar:"",nCode:0,nWidth:0,nHeight:0,nAdvance:0,nXOffset:0,nYOffset:0}}}class Tc{constructor(t){this.atlasesArr=[],this.atlasIndexes={},this.atlasIndexesDeferred={},this.tokenImageSize=64,this.samplerArr=new Uint32Array(11),this.sdfParamsArr=new Float32Array(44),this._handler=null,this.catalogSrc=t||"./"}assignHandler(t){this._handler=t}getFontIndex(t){let n=this.getFullIndex(t);return this.atlasIndexes[n]||this.loadFont(t,this.catalogSrc,`${t}.json`),this.atlasIndexesDeferred[n]||(this.atlasIndexesDeferred[n]=new pi),this.atlasIndexesDeferred[n].promise}getFullIndex(t){return t.trim().toLowerCase()}_applyFontDataToAtlas(t,n,s=0){let o=n.chars;t.height=n.common.scaleH,t.width=n.common.scaleW,t.gliphSize=n.info.size,t.distanceRange=n.distanceField.distanceRange;let a=t.width,h=t.height,c=t.gliphSize;this.sdfParamsArr[4*s]=a,this.sdfParamsArr[4*s+1]=h,this.sdfParamsArr[4*s+2]=c,this.sdfParamsArr[4*s+3]=t.distanceRange;let u={};for(let d=0;d<o.length;d++){let f=o[d],g=f.char;u[f.id]=g;let _=new Ii(f.x,f.y,f.x+f.width,f.y+f.height),m=new Array(12);m[0]=_.left/a,m[1]=_.top/h,m[2]=_.left/a,m[3]=_.bottom/h,m[4]=_.right/a,m[5]=_.bottom/h,m[6]=_.right/a,m[7]=_.bottom/h,m[8]=_.right/a,m[9]=_.top/h,m[10]=_.left/a,m[11]=_.top/h;let p=new wc(_,m),x=f.char.normalize("NFKC"),y=x.charCodeAt(0),T=p.metrics;T.id=f.id,T.char=f.char,T.width=f.width,T.height=f.height,T.x=f.x,T.y=f.y,T.chnl=f.chnl,T.index=f.index,T.page=f.page,T.xadvance=f.xadvance,T.xoffset=f.xoffset,T.yoffset=f.yoffset,T.nChar=x,T.nCode=y,T.nWidth=p.metrics.width/c,T.nHeight=p.metrics.height/c,T.nAdvance=p.metrics.xadvance/c,T.nXOffset=p.metrics.xoffset/c,T.nYOffset=1-p.metrics.yoffset/c,p.emptySize=1,t.nodes.set(x.charCodeAt(0),p)}t.kernings={};for(let d=0;d<n.kernings.length;d++){let f=n.kernings[d],g=f.first,_=f.second;t.kernings[g]||(t.kernings[g]={}),t.kernings[g][_]=f.amount/c}}initFont(t,n,s){let o=this.atlasesArr.length,a=this.getFullIndex(t);this.atlasIndexes[a]=o;let h=this.atlasIndexesDeferred[a];h||(h=this.atlasIndexesDeferred[a]=new pi),this.samplerArr[this.atlasesArr.length]=o;let c=new _o;c.height=0,c.width=0,c.gliphSize=0,c.distanceRange=0,c.kernings={},c.assignHandler(this._handler),this.atlasesArr[o]=c,this._applyFontDataToAtlas(c,n,o);let u=new Image;u.onload=()=>{this._createTexture(c,u),h.resolve(o)},u.src=s}_createTexture(t,n){t.createTexture(n)}loadFont(t,n,s){let o=this.atlasesArr.length,a=this.getFullIndex(t);this.atlasIndexes[a]=o;let h=this.atlasIndexesDeferred[a];h||(h=this.atlasIndexesDeferred[a]=new pi),this.samplerArr[this.atlasesArr.length]=o;let c=new _o;c.height=0,c.width=0,c.gliphSize=0,c.distanceRange=0,c.kernings={},c.assignHandler(this._handler),this.atlasesArr[o]=c,fetch(`${n}/${s}`).then(u=>{if(!u.ok)throw Error(`Unable to load "${n}/${s}"`);return u.json()}).then(u=>{this._applyFontDataToAtlas(c,u,o);let d=new Image;d.onload=()=>{this._createTexture(c,d),h.resolve(o)},d.src=`${n}/${u.pages[0]}`,d.crossOrigin="Anonymous"}).catch(u=>(h.reject(),{status:"error",msg:u.toString()}))}}let Cc=0,Ec=0,He=new Float32Array(2);class Ac{constructor(t,n={}){var s,o;if(this.div=null,this.handler=t instanceof Be?t:new Be(t,{pixelRatio:n.dpi||window.devicePixelRatio+.15,autoActivate:!0}),this.clearColor=new Float32Array(n.clearColor||[0,0,0,1]),this.exposure=n.exposure||3.01,this.gamma=n.gamma||.47,this.whitepoint=1,this.brightThreshold=.9,this._renderNodesArr=[],this.renderNodes={},this.activeCamera=new Pi({width:(s=this.handler.canvas)==null?void 0:s.width,height:(o=this.handler.canvas)==null?void 0:o.height,eye:new v(0,0,0),look:new v(0,0,-1),up:new v(0,1,0)}),this.events=new yc(this),this.controls={},n.controls)for(let c in n.controls)this.controls[n.controls[c].name]=n.controls[c];this.controlsBag={},this.colorObjects=new Map,this._pickingCallbacks=[],this.pickingFramebuffer=null,this._depthCallbacks=[],this.depthFramebuffer=null,this._depthRefreshRequired=!1;let a=new URLSearchParams(location.search),h=a.get("og_msaa");this._msaa=h?Number(a.get("og_msaa")):n.msaa!=null?n.msaa:0,this._internalFormat="RGBA16F",this._format="RGBA",this._type="FLOAT",this.sceneFramebuffer=null,this.blitFramebuffer=null,this.toneMappingFramebuffer=null,this._initialized=!1,this.billboardsTextureAtlas=new Vr,this.fontAtlas=new Tc(n.fontsSrc),this.strokeTextureAtlas=new Vr,this._entityCollections=[[]],this._currentOutput="screen",this._fnScreenFrame=null,this.labelWorker=new Ka(4),this.screenDepthFramebuffer=null,this.screenFramePositionBuffer=null,this.screenTexture={},this.outputTexture=null,this._readPickingBuffer=this._readPickingBuffer_webgl2,(n.autoActivate||Gt(n.autoActivate))&&this.start()}enableBlendOneSrcAlpha(){let t=this.handler.gl;t.enable(t.BLEND),t.blendEquation(t.FUNC_ADD),t.blendFunc(t.ONE,t.ONE_MINUS_SRC_ALPHA)}enableBlendDefault(){let t=this.handler.gl;t.enable(t.BLEND),t.blendEquation(t.FUNC_ADD),t.blendFuncSeparate(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA,t.ONE,t.ONE)}setRelativeCenter(t){this.events.dispatch(this.events.changerelativecenter,t||this.activeCamera.eye)}setEventsActivity(t){this.events.active=t}addDepthCallback(t,n){let s=Ec++;return this._depthCallbacks.push({id:s,callback:n,sender:t}),s}removeDepthCallback(t){for(let n=0;n<this._depthCallbacks.length;n++)if(t===this._depthCallbacks[n].id){this._depthCallbacks.splice(n,1);break}}addPickingCallback(t,n){let s=Cc++;return this._pickingCallbacks.push({id:s,callback:n,sender:t}),s}removePickingCallback(t){for(let n=0;n<this._pickingCallbacks.length;n++)if(t===this._pickingCallbacks[n].id){this._pickingCallbacks.splice(n,1);break}}getPickingObject(t,n,s){return this.colorObjects.get(`${t}_${n}_${s}`)}getPickingObjectArr(t){return this.colorObjects.get(`${t[0]}_${t[1]}_${t[2]}`)}getPickingObject3v(t){return this.colorObjects.get(`${t.x}_${t.y}_${t.z}`)}assignPickingColor(t){if(!t._pickingColor||t._pickingColor.isZero()){let n=0,s=0,o=0,a="0_0_0";for(;!(n||s||o)||this.colorObjects.has(a);)n=Ni(1,255),s=Ni(1,255),o=Ni(1,255),a=`${n}_${s}_${o}`;t._pickingColor?t._pickingColor.set(n,s,o):t._pickingColor=new v(n,s,o),t._pickingColorU=new Float32Array([n/255,s/255,o/255]),this.colorObjects.set(a,t)}}clearPickingColor(t){if(t._pickingColor&&!t._pickingColor.isZero()){let n=t._pickingColor;n.isZero()||(this.colorObjects.delete(`${n.x}_${n.y}_${n.z}`),n.x=n.y=n.z=0)}}getWidth(){return this.handler.canvas.clientWidth}getHeight(){return this.handler.canvas.clientHeight}getCenter(){let t=this.handler.canvas;return new H(Math.round(.5*t.width),Math.round(.5*t.height))}getClientCenter(){let t=this.handler.canvas;return new H(Math.round(.5*t.clientWidth),Math.round(.5*t.clientHeight))}addControl(t){t.addTo(this)}addControls(t){for(let n=0;n<t.length;n++)t[n].addTo(this)}removeControl(t){t.remove()}isInitialized(){return this._initialized}initialize(){if(!this._initialized){if(this._initialized=!0,this.handler.initialize(),this.billboardsTextureAtlas.assignHandler(this.handler),this.fontAtlas.assignHandler(this.handler),this.strokeTextureAtlas.assignHandler(this.handler),this.handler.setFrameCallback(()=>{this.draw()}),this.events.initialize(),this.events.on("charkeypress",W.KEY_APOSTROPHE,function(){ie.setVisibility(!ie.getVisibility())}),this.handler.addProgram(new X("screenFrame",{uniforms:{texture:"sampler2d"},attributes:{corners:"vec3"},vertexShader:`attribute vec2 corners;
            
            varying vec2 tc;
            void main(void) {
                gl_Position = vec4(corners, 0.0, 1.0);
                tc = corners * 0.5 + 0.5;
            }`,fragmentShader:`precision highp float;
            uniform sampler2D texture;
            
            varying vec2 tc;
            
            void main(void) {
                gl_FragColor = texture2D( texture, tc );
            }`})),this.pickingFramebuffer=new Rt(this.handler,{width:640,height:480,targets:[{readAsync:!0}]}),this.pickingFramebuffer.init(),this.depthFramebuffer=new Rt(this.handler,{width:640,height:480,targets:[{internalFormat:"RGBA",type:"UNSIGNED_BYTE",attachment:"COLOR_ATTACHMENT",readAsync:!0},{internalFormat:"RGBA16F",type:"FLOAT",attachment:"COLOR_ATTACHMENT",readAsync:!0}],useDepth:!0}),this.depthFramebuffer.init(),this.screenDepthFramebuffer=new Rt(this.handler,{useDepth:!1}),this.screenDepthFramebuffer.init(),this.handler.gl.type==="webgl")this._readPickingBuffer=this._readPickingBuffer_webgl1,this.sceneFramebuffer=new Rt(this.handler),this.sceneFramebuffer.init(),this._fnScreenFrame=this._screenFrameNoMSAA,this.screenTexture={screen:this.sceneFramebuffer.textures[0],picking:this.pickingFramebuffer.textures[0],depth:this.screenDepthFramebuffer.textures[0]};else{let t=this.getMaxMSAA(this._internalFormat);this._msaa>t&&(this._msaa=t),this.handler.addPrograms([new X("toneMapping",{uniforms:{hdrBuffer:"sampler2d",exposure:"float",gamma:"float",whitepoint:"float"},attributes:{corners:"vec3"},vertexShader:`#version 300 es
in vec2 corners;out vec2 tc;void main(void){gl_Position=vec4(corners,0.0,1.0);tc=corners*0.5+0.5;}`,fragmentShader:`#version 300 es
precision highp float;
#ifndef saturate
#define saturate(a) clamp(a, 0.0, 1.0)
#endif
uniform sampler2D hdrBuffer;uniform float whitepoint;uniform float exposure;uniform float gamma;vec3 LinearToneMapping(vec3 color){return exposure*color;}vec3 ReinhardToneMapping2(vec3 color){return vec3(1.0)-exp(-color*exposure);}vec3 ReinhardToneMapping(vec3 color){color*=exposure;return saturate(color/(vec3(1.0)+color));}
#define Uncharted2Helper(x) max(((x * (0.15 * x + 0.10 * 0.50) + 0.20 * 0.02) / (x * (0.15 * x + 0.50) + 0.20 * 0.30)) - 0.02 / 0.30, vec3(0.0))
vec3 Uncharted2ToneMapping(vec3 color){color*=exposure;return saturate(Uncharted2Helper(color)/Uncharted2Helper(vec3(whitepoint)));}vec3 OptimizedCineonToneMapping(vec3 color){color*=exposure;color=max(vec3(0.0),color-0.004);return pow((color*(6.2*color+0.5))/(color*(6.2*color+1.7)+0.06),vec3(2.2));}vec3 ACESFilmicToneMapping(vec3 color){color*=exposure;return saturate((color*(2.51*color+0.03))/(color*(2.43*color+0.59)+0.14));}in vec2 tc;layout(location=0)out vec4 fragColor;void main(void){vec4 hdrColor=texture(hdrBuffer,tc);float oneByGamma=gamma/gamma;float oneByWhitePoint=whitepoint/whitepoint;vec3 mapped=ReinhardToneMapping2(hdrColor.rgb)*oneByGamma*oneByWhitePoint;mapped=pow(mapped,vec3(1.0/gamma));fragColor=vec4(mapped,hdrColor.a);}`})]),this.handler.addPrograms([new X("depth",{uniforms:{depthTexture:"sampler2D"},attributes:{corners:"vec2"},vertexShader:`#version 300 es
            
            in vec2 corners;
            
            out vec2 tc;

            void main(void) {
                gl_Position = vec4(corners, 0.0, 1.0);
                tc = corners * 0.5 + 0.5;
            }`,fragmentShader:`#version 300 es

            precision highp float;

            uniform sampler2D depthTexture;
           
            in vec2 tc;

            layout(location = 0) out vec4 fragColor;

            float LinearizeDepth(in vec2 uv)
            {
                return texture(depthTexture, tc).r;
            }
            
            void main(void) {
                float c = LinearizeDepth(tc);
                fragColor = vec4(c, c, c, 1.0);
            }`})]),this.sceneFramebuffer=new Ta(this.handler,{size:1,msaa:this._msaa,internalFormat:this._internalFormat,filter:"LINEAR"}),this.sceneFramebuffer.init(),this.blitFramebuffer=new Rt(this.handler,{size:1,useDepth:!1,targets:[{internalFormat:this._internalFormat,format:this._format,type:this._type,filter:"NEAREST"}]}),this.blitFramebuffer.init(),this.toneMappingFramebuffer=new Rt(this.handler,{useDepth:!1}),this.toneMappingFramebuffer.init(),this._fnScreenFrame=this._screenFrameMSAA,this.screenTexture={screen:this.toneMappingFramebuffer.textures[0],picking:this.pickingFramebuffer.textures[0],depth:this.screenDepthFramebuffer.textures[0],frustum:this.depthFramebuffer.textures[0]}}this.handler.ONCANVASRESIZE=()=>{this._resizeStart(),this.events.dispatch(this.events.resize,this.handler.canvas),this._resizeEnd(),this.events.dispatch(this.events.resizeend,this.handler.canvas)},this.screenFramePositionBuffer=this.handler.createArrayBuffer(new Float32Array([1,1,-1,1,1,-1,-1,-1]),2,4),this.outputTexture=this.screenTexture.screen,this._initializeRenderNodes(),this._initializeControls()}}_initializeControls(){let t=this.controls;this.controls={};for(let n in t)this.addControl(t[n])}resize(){this._resizeEnd()}setCurrentScreen(t){this._currentOutput=t,this.screenTexture[t]&&(this.outputTexture=this.screenTexture[t])}_resizeStart(){let t=this.handler.canvas;this.activeCamera.setViewportSize(t.width,t.height),this.sceneFramebuffer.setSize(.5*t.width,.5*t.height),this.blitFramebuffer&&this.blitFramebuffer.setSize(.5*t.width,.5*t.height,!0)}_resizeEnd(){let t=this.handler.canvas;this.activeCamera.setViewportSize(t.width,t.height),this.sceneFramebuffer.setSize(t.width,t.height),this.blitFramebuffer&&this.blitFramebuffer.setSize(t.width,t.height,!0),this.toneMappingFramebuffer&&this.toneMappingFramebuffer.setSize(t.width,t.height,!0),this.screenDepthFramebuffer&&this.screenDepthFramebuffer.setSize(t.clientWidth,t.clientHeight,!0),this.handler.gl.type==="webgl"?(this.screenTexture.screen=this.sceneFramebuffer.textures[0],this.screenTexture.picking=this.pickingFramebuffer.textures[0],this.screenTexture.depth=this.screenDepthFramebuffer.textures[0],this.screenTexture.frustum=this.depthFramebuffer.textures[0]):(this.screenTexture.screen=this.toneMappingFramebuffer.textures[0],this.screenTexture.picking=this.pickingFramebuffer.textures[0],this.screenTexture.depth=this.screenDepthFramebuffer.textures[0],this.screenTexture.frustum=this.depthFramebuffer.textures[0]),this.setCurrentScreen(this._currentOutput)}removeNode(t){t.remove()}addNode(t){this.renderNodes[t.name]?ie.logWrn(`Node name ${t.name} already exists.`):(t.assign(this),this._renderNodesArr.unshift(t),this.renderNodes[t.name]=t)}_initializeRenderNodes(){for(let t=0;t<this._renderNodesArr.length;t++)this._renderNodesArr[t].initialize()}addNodeBefore(t,n){if(this.renderNodes[t.name])ie.logWrn(`Node name ${t.name} already exists.`);else{t.assign(this),this.renderNodes[t.name]=t;for(let s=0;s<this._renderNodesArr.length;s++)if(this._renderNodesArr[s].isEqual(n)){this._renderNodesArr.splice(s,0,t);break}this._renderNodesArr.unshift(t)}}addNodes(t){for(let n=0;n<t.length;n++)this.addNode(t[n])}getMaxMSAA(t){let n=this.handler.gl;return n.getInternalformatParameter(n.RENDERBUFFER,n[t],n.SAMPLES)[0]}getMSAA(){return this._msaa}enqueueEntityCollectionsToDraw(t,n=0){this._entityCollections[n]||(this._entityCollections[n]=[]),this._entityCollections[n].push(...t)}markForDepthRefresh(){this._depthRefreshRequired=!0}_drawEntityCollections(t){let n=this._entityCollections[t];if(n.length){let s=this.handler.gl;this.enableBlendDefault();let o=n.length;for(;o--;)n[o]._fadingOpacity&&n[o].pointCloudHandler.draw();for(o=n.length;o--;){let h=n[o];n[o]._fadingOpacity&&(h.events.dispatch(h.events.draw,h),n[o].geoObjectHandler.draw())}for(s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,this.billboardsTextureAtlas.texture),o=n.length;o--;){let h=n[o];h._fadingOpacity&&h.billboardHandler.draw()}let a=this.fontAtlas.atlasesArr;for(o=0;o<a.length;o++)s.activeTexture(s.TEXTURE0+o),s.bindTexture(s.TEXTURE_2D,a[o].texture);for(o=n.length;o--;)n[o]._fadingOpacity&&n[o].labelHandler.draw();for(s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,this.strokeTextureAtlas.texture),o=n.length;o--;)n[o]._fadingOpacity&&n[o].rayHandler.draw();for(o=n.length;o--;)n[o]._fadingOpacity&&n[o].polylineHandler.draw();for(o=n.length;o--;)n[o]._fadingOpacity&&n[o].stripHandler.draw()}}_drawPickingEntityCollections(t){let n=this._entityCollections[t];if(n.length){let s=n.length;for(;s--;)n[s]._fadingOpacity&&n[s].billboardHandler.drawPicking();for(s=n.length;s--;)n[s]._fadingOpacity&&n[s].geoObjectHandler.drawPicking();for(s=n.length;s--;)n[s]._fadingOpacity&&n[s].labelHandler.drawPicking();for(s=n.length;s--;)n[s]._fadingOpacity&&n[s].rayHandler.drawPicking();for(s=n.length;s--;)n[s]._visibility&&n[s].polylineHandler.drawPicking();for(s=n.length;s--;)n[s]._visibility&&n[s].stripHandler.drawPicking()}}_drawDepthEntityCollections(t){let n=this._entityCollections[t];if(n.length){let s=n.length;for(;s--;)n[s]._fadingOpacity&&n[s].geoObjectHandler.drawDepth()}}_clearEntityCollectionQueue(t){this._entityCollections[t].length=0,this._entityCollections[t]=[]}draw(){this.activeCamera.checkMoveEnd();let t=this.events,n=t.pointerEvent(),s=!t.mouseState.leftButtonDown&&!t.mouseState.rightButtonDown,o=t.touchState.touchStart||t.touchState.touchEnd;const a=n&&s||o||this._depthRefreshRequired;this._depthRefreshRequired=!1,t.handleEvents();let h=this.sceneFramebuffer;h.activate();let c=this.handler.gl;c.clearColor(this.clearColor[0],this.clearColor[1],this.clearColor[2],this.clearColor[3]),c.clear(c.COLOR_BUFFER_BIT|c.DEPTH_BUFFER_BIT),this.enableBlendDefault(),t.dispatch(t.draw,this),this.activeCamera.checkFly();let u=this.activeCamera.frustums,d=this._renderNodesArr,f=u.length;for(;f--;){this.activeCamera.setCurrentFrustum(f),c.clear(c.DEPTH_BUFFER_BIT);let g=d.length;for(;g--;)d[g].preDrawNode();for(g=d.length;g--;)this.enableBlendDefault(),d[g].drawNode();this._drawEntityCollections(0),t.dispatch(t.drawtransparent,this),a&&this._drawPickingBuffer(0),this._drawDepthBuffer(0),this._clearEntityCollectionQueue(0)}for(let g=1;g<this._entityCollections.length;g++){c.clear(c.DEPTH_BUFFER_BIT);let _=u.length;for(;_--;)this.activeCamera.setCurrentFrustum(_),this._drawEntityCollections(g),a&&this._drawPickingBuffer(g),this._drawDepthBuffer(g);this._clearEntityCollectionQueue(g)}h.deactivate(),this.blitFramebuffer&&h.blitTo(this.blitFramebuffer,0),a&&(this._readPickingBuffer(),this._readDepthBuffer()),this._fnScreenFrame(),t.dispatch(t.postdraw,this),t.mouseState.wheelDelta=0,t.mouseState.justStopped=!1,t.mouseState.moving=!1,t.touchState.moving=!1}getImageDataURL(t="image/png",n=1){return this.draw(),this.handler.canvas?this.handler.canvas.toDataURL(t,n):""}_screenFrameMSAA(){let t=this.handler,n=t.programs.toneMapping,s=n._program,o=t.gl;o.disable(o.DEPTH_TEST),o.bindBuffer(o.ARRAY_BUFFER,this.screenFramePositionBuffer),o.vertexAttribPointer(s.attributes.corners,2,o.FLOAT,!1,0,0),this.toneMappingFramebuffer.activate(),o.clearColor(0,0,0,0),o.clear(o.COLOR_BUFFER_BIT),n.activate(),o.activeTexture(o.TEXTURE0),o.bindTexture(o.TEXTURE_2D,this.blitFramebuffer.textures[0]),o.uniform1i(s.uniforms.hdrBuffer,0),o.uniform1f(s.uniforms.gamma,this.gamma),o.uniform1f(s.uniforms.exposure,this.exposure),o.uniform1f(s.uniforms.whitepoint,this.whitepoint),o.drawArrays(o.TRIANGLE_STRIP,0,4),this.toneMappingFramebuffer.deactivate(),n=t.programs.screenFrame,s=n._program,n.activate(),o.activeTexture(o.TEXTURE0),o.bindTexture(o.TEXTURE_2D,this.outputTexture),o.uniform1i(s.uniforms.texture,0),o.drawArrays(o.TRIANGLE_STRIP,0,4),o.enable(o.DEPTH_TEST)}_screenFrameNoMSAA(){let t=this.handler,n=t.programs.screenFrame,s=n._program,o=t.gl;o.disable(o.DEPTH_TEST),n.activate(),o.activeTexture(o.TEXTURE0),o.bindTexture(o.TEXTURE_2D,this.outputTexture),o.uniform1i(s.uniforms.texture,0),o.bindBuffer(o.ARRAY_BUFFER,this.screenFramePositionBuffer),o.vertexAttribPointer(s.attributes.corners,2,o.FLOAT,!1,0,0),o.drawArrays(o.TRIANGLE_STRIP,0,4),o.enable(o.DEPTH_TEST)}_drawPickingBuffer(t){this.pickingFramebuffer.activate();let n=this.handler.gl;if(this.activeCamera.isFirstPass&&t===0?(n.clearColor(0,0,0,1),n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT)):n.clear(n.DEPTH_BUFFER_BIT),n.disable(n.BLEND),t===0){let s=this._pickingCallbacks;for(let o=0,a=s.length;o<a;o++)s[o].callback.call(s[o].sender)}this._drawPickingEntityCollections(t),n.enable(n.BLEND),this.pickingFramebuffer.deactivate()}_drawDepthBuffer(t){this.depthFramebuffer.activate();let n=this.handler,s=n.gl;if(s.disable(s.BLEND),this.activeCamera.isFirstPass&&t===0?(s.clearColor(0,0,0,1),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT)):s.clear(s.DEPTH_BUFFER_BIT),t===0){let o=this._depthCallbacks,a=o.length;for(;a--;)o[a].callback.call(o[a].sender)}if(this._drawDepthEntityCollections(t),this.depthFramebuffer.deactivate(),this._currentOutput==="depth"||this._currentOutput==="frustum"){this.screenDepthFramebuffer.activate();let o=n.programs.depth,a=o._program;s.bindBuffer(s.ARRAY_BUFFER,this.screenFramePositionBuffer),s.vertexAttribPointer(a.attributes.corners,2,s.FLOAT,!1,0,0),o.activate(),s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,this.depthFramebuffer.textures[1]),s.uniform1i(a.uniforms.depthTexture,0),s.drawArrays(s.TRIANGLE_STRIP,0,4),this.screenDepthFramebuffer.deactivate()}s.enable(s.BLEND)}_readDepthBuffer(t){this.depthFramebuffer.readPixelBuffersAsync(t)}_readPickingBuffer_webgl1(){this.pickingFramebuffer.readPixelBuffersAsync()}_readPickingBuffer_webgl2(){this.pickingFramebuffer.readPixelBuffersAsync()}readPickingColor(t,n,s){var o;let a=this.pickingFramebuffer.width,h=this.pickingFramebuffer.height;t=Math.round(t*a);let c=4*((n=Math.round(n*h))*a+t),u=(o=this.pickingFramebuffer)==null?void 0:o.pixelBuffers[0].data;u&&(s[0]=u[c],s[1]=u[c+1],s[2]=u[c+2])}readDepth(t,n,s){let o=new Float32Array(4),a=new Uint8Array(4);this.depthFramebuffer.readData(t,n,a,0),this.depthFramebuffer.readData(t,n,o,1),s[0]=o[0],s[1]=Math.round(a[0]/10)-1}getDistanceFromPixel(t){let n=this.activeCamera,s=this.handler.canvas,o=t.x/s.width,a=(s.height-t.y)/s.height;if(He[0]=He[1]=0,this.readDepth(o,a,He),He[1]===-1)return;let h=He[0],c=n.frustums[He[1]];if(!c)return;let u=new et(2*o-1,2*a-1,2*h-1,1),d=c.inverseProjectionMatrix.mulVec4(u),f=-d.z/d.w;if(n.isOrthographic)return f;let g=t.direction||n.unproject(t.x,t.y);return f/Math.max(1e-6,g.dot(n.getForward()))}getCartesianFromPixel(t){let n=this.getDistanceFromPixel(t);if(n){if(this.activeCamera.isOrthographic){let s=new v;return this.activeCamera.unproject(t.x,t.y,n,s),s}return(t.direction||this.activeCamera.unproject(t.x,t.y)).scaleTo(n).addA(this.activeCamera.eye)}}getCartesianFromPixelAsync(t){return new Promise((n,s)=>{this._readDepthBuffer(()=>{n(this.getCartesianFromPixel(t))})})}getDepthMinDistance(){let t=this.handler.canvas,n=t.width,s=t.height,o=or,a=s*n,h=new H;for(let c=0;c<a;c++){h.x=c%n,h.y=Math.floor(c/n);let u=this.getDistanceFromPixel(h);u&&u<o&&(o=u)}return o<or?o:0}getDepthMinDistanceAsync(){return new Promise((t,n)=>{this._readDepthBuffer(()=>{t(this.getDepthMinDistance())})})}async setOrthographicProjection(t){if(t!==this.activeCamera.isOrthographic){let n=await this.getDepthMinDistanceAsync();n&&t&&(this.activeCamera.focusDistance=n),this.activeCamera.isOrthographic=t,this.events.dispatch(this.events.projchanged,this.activeCamera)}}start(){this._initialized||this.initialize(),this.handler.start()}destroy(){this.labelWorker.destroy();for(let t in this.controls)this.controls[t].remove();for(let t=0;t<this._renderNodesArr.length;t++)this._renderNodesArr[t].remove();this.div=null,this._renderNodesArr=[],this.renderNodes={},this.controls={},this.controlsBag={},this.colorObjects.clear(),this._pickingCallbacks=[],this.pickingFramebuffer=null,this._tempPickingPix_=null,this._depthCallbacks=[],this.depthFramebuffer=null,this.sceneFramebuffer=null,this.blitFramebuffer=null,this.toneMappingFramebuffer=null,this._entityCollections=[[]],this.handler.ONCANVASRESIZE=null,this.handler.destroy(),this._initialized=!1}}const fo="/res",Ye=class Au{constructor(t){this.$target=null,this._instanceID=`__globus${Au.__counter__++?Au.__counter__:""}__`,window[this._instanceID]=this,this._canvas=document.createElement("canvas"),this._canvas.id=`canvas${this._instanceID}`,this._canvas.style.width="100%",this._canvas.style.height="100%",this._canvas.style.display="block",this._canvas.style.opacity="0.0",this._canvas.style.transition="opacity 150ms",this.$inner=document.createElement("div"),this.$inner.classList.add("og-inner"),this.$inner.appendChild(this._canvas),this.$inner.attributions=document.createElement("div"),t.attributionContainer?t.attributionContainer.appendChild(this.$inner.attributions):(this.$inner.attributions.classList.add("og-attribution"),this.$inner.appendChild(this.$inner.attributions)),t.target&&this.attachTo(t.target);const n=c=>{c.preventDefault()};this._canvas.onmouseenter=function(){document.addEventListener("mousewheel",n,{capture:!1,passive:!1})},this._canvas.onmouseleave=function(){document.removeEventListener("mousewheel",n)},this.renderer=new Ac(new Be(this._canvas,{autoActivate:!1,pixelRatio:t.dpi||window.devicePixelRatio+.15,context:{alpha:t.transparentBackground,antialias:!1,premultipliedAlpha:!0,preserveDrawingBuffer:!1}}),{autoActivate:!1,msaa:t.msaa,fontsSrc:t.fontsSrc,gamma:t.gamma,exposure:t.exposure,...t.transparentBackground&&{clearColor:[0,0,0,0]}}),this.renderer.div=this.$inner,t.skybox&&this.renderer.addNode(t.skybox),this._planetName=t.name?t.name:"globus_planet_"+Au.__counter__,this.planet=new Ri({name:this._planetName,frustums:t.frustums,ellipsoid:t.ellipsoid,maxGridSize:t.maxGridSize,nightTextureSrc:t.nightTextureSrc===null?null:t.nightTextureSrc||`${t.resourcesSrc||fo}/night.png`,specularTextureSrc:t.specularTextureSrc===null?null:t.specularTextureSrc||`${t.resourcesSrc||fo}/spec.png`,minAltitude:t.minAltitude,maxAltitude:t.maxAltitude||15e6,maxEqualZoomAltitude:t.maxEqualZoomAltitude,minEqualZoomAltitude:t.minEqualZoomAltitude,minEqualZoomCameraSlope:t.minEqualZoomCameraSlope,quadTreeStrategyPrototype:t.quadTreeStrategyPrototype,maxLoadingRequests:t.maxLoadingRequests,atmosphereEnabled:t.atmosphereEnabled,transitionOpacityEnabled:t.transitionOpacityEnabled,atmosphereParameters:t.atmosphereParameters,minDistanceBeforeMemClear:t.minDistanceBeforeMemClear,vectorTileSize:t.vectorTileSize,maxNodesCount:t.maxNodesCount,transparentBackground:t.transparentBackground}),t.terrain?Array.isArray(t.terrain)?this.planet.setTerrain(t.terrain[0]):this.planet.setTerrain(t.terrain):this.planet.setTerrain(new Mi),this.renderer.addNode(this.planet),t.controls?this.planet.addControls(t.controls):this.planet.addControls([new ma,new Yi,new pa,new da,new fa,new Ho,new Fr]);const s=this.renderer.controls;let o,a;for(let c in s)s[c]instanceof Dr&&(o=s[c]),s[c]instanceof Yi&&(a=s[c]);o?this.sun=o:(this.sun=new Dr,this.planet.addControl(this.sun)),t.sun&&(t.sun.active===void 0||t.sun.active||this.sun.deactivate(),t.sun.stopped===!0&&this.sun.stop()),a?this.navigation=a:(this.navigation=new Yi,this.planet.addControl(this.navigation)),t.navigation&&(t.navigation.active===void 0||t.navigation.active||this.navigation.deactivate(),t.navigation.inertia!==void 0&&(this.navigation.inertia=t.navigation.inertia),t.navigation.dragInertia!==void 0&&(this.navigation.dragInertia=t.navigation.dragInertia),t.navigation.minSlope!==void 0&&(this.navigation.minSlope=t.navigation.minSlope),t.navigation.mass!==void 0&&(this.navigation.mass=t.navigation.mass),t.navigation.zoomSpeed!==void 0&&(this.navigation.zoomSpeed=t.navigation.zoomSpeed),t.navigation.mode!==void 0&&this.navigation.setMode(t.navigation.mode),t.navigation.poleThreshold!==void 0&&(this.navigation.poleThreshold=t.navigation.poleThreshold),t.navigation.disableRotation!==void 0&&(this.navigation.disableRotation=t.navigation.disableRotation),t.navigation.disableTilt!==void 0&&(this.navigation.disableTilt=t.navigation.disableTilt)),t.layers&&this.planet.addLayers(t.layers);let h=t.viewExtent;h&&(h instanceof Array?this.planet.viewExtentArr(h):this.planet.viewExtent(h)),(t.autoActivate||Gt(t.autoActivate))&&this.start()}start(){this.renderer.start(),this.fadeIn()}fadeIn(){this._canvas.style.opacity="1.0"}fadeOut(){this._canvas.style.opacity="0"}attachTo(t,n){let s;this.detach(),s=t instanceof HTMLElement?t:document.getElementById(t)||document.querySelector(t),s?(this.$target=s,n&&this.$target.firstChild?this.$target.insertBefore(this.$inner,this.$target.firstChild):s.appendChild(this.$inner)):console.warn(`Target container not found. Provided target: ${t}`)}detach(){this.$target&&(this.$target.removeChild(this.$inner),this.$target=null)}destroy(){this.detach(),this.planet.layers.forEach(t=>t.remove()),this.planet.destroy(),this.renderer.destroy(),window[this._instanceID]=null}};Ye.__counter__=0;let go=Ye;new qr(3396200,3389508);new qr(1737400,1737400);var we=(l=>(l[l.byte=5120]="byte",l[l.ubyte=5121]="ubyte",l[l.short=5122]="short",l[l.ushort=5123]="ushort",l[l.uint=5125]="uint",l[l.float=5126]="float",l))(we||{}),fe=(l=>(l.scalar="SCALAR",l.vec2="VEC2",l.vec3="VEC3",l.vec4="VEC4",l.mat2="MAT2",l.mat3="MAT3",l.mat4="MAT4",l))(fe||{}),Ur=(l=>(l[l.points=0]="points",l[l.lines=1]="lines",l[l.lineLoop=2]="lineLoop",l[l.lineStrip=3]="lineStrip",l[l.triangles=4]="triangles",l[l.triangleStrip=5]="triangleStrip",l[l.triangleFan=6]="triangleFan",l))(Ur||{});(globalThis.og??(globalThis.og={})).version="0.28.4";const createMapPool=(l,t,n)=>{const o=getFlatLayersArray(t.map.getLayers().getArray()).filter(a=>a.get("type")!=="Group").map(a=>a.get("_jsonDefinition")).filter(Boolean);return Array.from({length:l},()=>{const a=document.createElement("eox-map");return Object.assign(a.style,{width:"256px",height:"256px",position:"absolute",top:"-9999px",left:"-9999px"}),Object.assign(a,{projection:"EPSG:3857",layers:o}),n.appendChild(a),{tileMap:a,tileQueue:[],loadNextTile(){const h=this.tileQueue[0];requestTileFromMap(a,h.layerId,h,this)}}})};async function requestTileFromMap(l,t,n,s){const o=l.map;if(!o){l.addEventListener("mapmounted",()=>requestTileFromMap(l,t,n,s),{once:!0});return}o.getLayers().forEach(c=>{c.setVisible(c.get("id")===t)});const h=createXYZ().getTileCoordExtent([n.tile.z,n.tile.x,n.tile.y]);o.getView().fit(h,{callback:()=>{o.once("rendercomplete",function(){const c=document.createElement("canvas"),u=o.getSize();c.width=u[0],c.height=u[1];const d=c.getContext("2d");Array.prototype.forEach.call(o.getViewport().querySelectorAll(".ol-layer canvas, canvas.ol-layer"),function(f){if(f.width>0){const g=f.parentNode.style.opacity||f.style.opacity;d.globalAlpha=g===""?1:Number(g);let _;const m=f.style.transform;m?_=m.match(/^matrix\(([^(]*)\)$/)[1].split(",").map(Number):_=[parseFloat(f.style.width)/f.width,0,0,parseFloat(f.style.height)/f.height,0,0],CanvasRenderingContext2D.prototype.setTransform.apply(d,_);const p=f.parentNode.style.backgroundColor;p&&(d.fillStyle=p,d.fillRect(0,0,f.width,f.height)),d.drawImage(f,0,0)}}),d.globalAlpha=1,d.setTransform(1,0,0,1,0,0),n.callback(c),s.tileQueue.shift(),s.tileQueue.length&&s.loadNextTile()}),o.renderSync()}})}function distributeTileToIdealMap(l,t,n,s){const{x:o,y:a,z:h}=n,c={layerId:t,tile:n,callback:s};let u=0,d=null;for(let f=0;f<l.length;f++){const g=l[f];if(!g.tileQueue.length){d=g;break}const _=g.tileQueue[g.tileQueue.length-1],m=Math.abs(_.tile.x-o)+Math.abs(_.tile.y-a)+Math.abs(_.tile.z-h);(u===0||m<u)&&(u=m,d=g)}return d.tileQueue.push(c),d}let globus;const createGlobe=({EOxMap:l,target:t,mapPool:n})=>{globus=new go({target:t,layers:l.getFlatLayersArray(l.map.getLayers().getArray()).filter(c=>c.get("type")!=="Group").map(c=>createGlobusLayer(c,n)).filter(c=>c!==void 0),sun:{active:!1},atmosphereEnabled:!1,transparentBackground:!0,resourcesSrc:"https://cdn.jsdelivr.net/npm/@openglobus/og@0.27.21/lib/res",fontsSrc:"https://cdn.jsdelivr.net/npm/@openglobus/og@0.27.21/lib/res/fonts"});const s=2105e4/Math.pow(2,l.map.getView().getZoom()-1),o=l.map.getView().getCenter(),a=transform(o,l.map.getView().getProjection().getCode(),"EPSG:4326");globus.planet.camera.setLonLat(new L(a[0],a[1],s),new L(a[0],a[1],0),v.NORTH);const h=document.createElement("style");return h.textContent=`
    .og-inner {
      height: 100%;
    }
    .og-inner *:not(canvas) {
      display: none !important;
    }
  `,t.appendChild(h),globus},refreshGlobe=()=>{globus&&globus.planet.layers.forEach(l=>{l instanceof ss&&(l.abortLoading(),l.animated=!0,setTimeout(()=>l.animated=!1,200))})},createGlobusLayer=(l,t)=>{const n=l.getSource&&l.getSource(),s=l.get("id");if(n instanceof OSM)return new _c(s,{isBaseLayer:l.get("base"),visibility:l.getVisible(),opacity:l.getOpacity()});if(n instanceof XYZ)return new Ds(s,{isBaseLayer:l.get("base"),url:n.getUrls()[0],visibility:l.getVisible(),opacity:l.getOpacity()});if(n instanceof TileWMS){const o=n.getParams(),h=n.getUrls()[0],c=o.LAYERS||o.layers||"default";return new me(s,{isBaseLayer:l.get("base"),layers:c,url:h,visibility:l.getVisible(),opacity:l.getOpacity(),version:o.VERSION||o.Version||"1.1.1",extra:{...o}})}if(n instanceof VectorSource&&n.getUrl()){let o;if(fetch(n.getUrl().toString()).then(a=>a.json()).then(a=>{const h=a.crs;if(h&&(h.type=="name"?o=get$1(h.properties.name):h.type==="EPSG"&&(o=get$1("EPSG:"+h.properties.code))),o&&equivalent$1(o,get$1("EPSG:4326"))||!h){const d=globus.planet.getLayerByName(s);d&&globus.planet.removeLayer(d);const f=new _t(s,{visibility:l.getVisible(),opacity:l.getOpacity(),isBaseLayer:l.get("base")});f.addTo(globus.planet);var c=a.features;for(let g=0;g<c.length;g++){var u=c[g];f.add(new G({geometry:{type:u.geometry.type,coordinates:u.geometry.coordinates}}))}return f}else return}),o&&equivalent$1(o,get$1("EPSG:4326")))return}return new ss(s,{opacity:l.getOpacity(),visibility:l.getVisible(),async drawTile(o,a){if(!o.segment)return;const h={x:o.segment.tileX,y:o.segment.tileY,z:o.segment.tileZoom},c=distributeTileToIdealMap(t,l.get("id"),h,u=>{var d;(d=o.segment)!=null&&d.initialized&&a(u)});c.tileQueue.length===1&&c.loadNextTile()}})},enableGlobe=l=>{var t;if(l.shadowRoot){let n=l.shadowRoot.querySelector("#globe");n||(n=document.createElement("div"),n.id="globe",n.style.width="100%",n.style.height="100%",n.style.display="block",(t=l.renderRoot)==null||t.appendChild(n)),l.registerProjectionFromCode("EPSG:3857"),l.globe=window.eoxMapGlobe.create({EOxMap:l,target:n}),l.shadowRoot.querySelector("#map").style.display="none",l.globeEnabled=!0}},disableGlobe=l=>{if(l.globe){const t=l.globe,n=t.planet;let s=n.getCartesianFromPixelTerrain(t.renderer.handler.getCenter());const o=s?s.normal().scaleTo(s.length()+s.distance(n.camera.eye)):n.camera.eye;n.flyCartesian(o,{amplitude:0,completeCallback:()=>{s&&n.camera.look(s);const a=t.planet.camera.getLonLat(),h=Math.log2(2105e4/a.height)+1,c=[a.lon,a.lat],u=transform(c,"EPSG:4326",l.OLprojection);l.map.getView().setCenter(u),l.map.getView().setZoom(h),l.globe=null;const d=l.shadowRoot.querySelector("#globe");d&&(d.style.display="none",d.remove());const f=l.shadowRoot.querySelector("#map");f&&(f.style.display=""),l.globeEnabled=!1}})}};function debounce(l,t){let n;return function(...o){const a=()=>{clearTimeout(n),l(...o)};clearTimeout(n),n=setTimeout(a,t)}}const setupLayerListeners=(l,t,n)=>{const s=debounce(()=>{refreshGlobe()},200);l.on("change",()=>{if(l.styleVariables_){const o=l.get("id"),a=l.styleVariables_;if(!o||!a)return;n.forEach(h=>{h.tileQueue.length=0;const c=getLayerById(h.tileMap,o);c&&c.updateStyleVariables&&c.updateStyleVariables(a)}),s()}}),l.on("propertychange",({key:o})=>{const a=t.planet.getLayerByName(l.get("id"));if(a)switch(o){case"visible":a.setVisibility(l.getVisible());break;case"opacity":a.opacity=l.getOpacity();break}})},processLayers=(l,t,n)=>{l.forEach(s=>{s.get("id")&&setupLayerListeners(s,t,n),s.getLayers&&processLayers(s.getLayers().getArray(),t,n)})};addCommonStylesheet();var _u,lu,Jc,pu,mu,yu,vu,xu,Eu,eu,zc;class EOxMap extends i{constructor(){super();mo(this,_u);mo(this,lu);mo(this,Jc);mo(this,pu);mo(this,mu);mo(this,yu);mo(this,vu);mo(this,xu,[0,0]);mo(this,Eu,0);mo(this,eu,!1);mo(this,zc,"EPSG:3857");this.map=new Map$1({controls:[],interactions:defaults({altShiftDragRotate:!1,pinchRotate:!1}),layers:[],view:new View({center:[0,0],zoom:0,projection:qi(this,zc)})}),this.interactions={},this.selectInteractions={},this.mapControls={},this.globe=null}static get properties(){return{map:{attribute:!1,state:!0},config:{attribute:!1,type:Object},center:{attribute:!1,type:Array},layers:{attribute:!1,type:Array},zoom:{attribute:!1,type:Number},animationOptions:{attribute:!1,type:Object},controls:{attribute:!1,type:Object},interactions:{attribute:!1,type:Object},lonLatCenter:{attribute:!1,type:Array},lonLatExtent:{attribute:!1,type:Array},mapControls:{attribute:!1,state:!0,type:Object},preventScroll:{attribute:"prevent-scroll",type:Boolean},projection:{attribute:"projection",type:String},selectInteractions:{attribute:!1,state:!0,type:Object},sync:{attribute:"sync",type:String},zoomExtent:{attribute:!1,type:Array}}}set center(n){const s=setCenterMethod(n,this);s!==void 0&&(Pc(this,xu,s),animateToStateMethod(this))}get center(){return qi(this,xu)}set config(n){Pc(this,mu,setConfigMethod(n,this))}get config(){return qi(this,mu)}get lonLatCenter(){return getLonLatCenterMethod(this)}get lonLatExtent(){return getLonLatExtentMethod(this)}set zoom(n){n!==void 0&&(Pc(this,Eu,n),animateToStateMethod(this))}get zoom(){return qi(this,Eu)}set zoomExtent(n){Pc(this,_u,setZoomExtentMethod(n,this))}get zoomExtent(){return getZoomExtentMethod(this)}set controls(n){Pc(this,lu,setControlsMethod(n,qi(this,lu),this))}get controls(){return qi(this,lu)}set layers(n){Pc(this,Jc,setLayersMethod(n,qi(this,Jc),this)),this.dispatchEvent(new CustomEvent("layerschanged",{detail:{layers:qi(this,Jc)}}))}get layers(){return qi(this,Jc)}set preventScroll(n){Pc(this,pu,setPreventScrollMethod(n,this))}get preventScroll(){return qi(this,pu)}set animationOptions(n){Pc(this,yu,n)}get animationOptions(){return qi(this,yu)}set projection(n){n==="globe"?(qi(this,zc)!=="EPSG:3857"&&Pc(this,zc,setProjectionMethod("EPSG:3857",qi(this,zc),this)),setTimeout(()=>{enableGlobe(this)})):(qi(this,eu)&&setTimeout(()=>{disableGlobe(this)}),Pc(this,zc,setProjectionMethod(n,qi(this,zc),this)))}get projection(){return qi(this,eu)?"globe":qi(this,zc)}get OLprojection(){return qi(this,zc)}get globeEnabled(){return qi(this,eu)}set globeEnabled(n){Pc(this,eu,n)}set sync(n){Pc(this,vu,setSyncMethod(n,this))}get sync(){return qi(this,vu)}addOrUpdateLayer(n){return addOrUpdateLayerMethod(n,this)}removeInteraction(n){removeInteractionMethod(n,this)}removeSelect(n){removeSelectMethod(n,this)}removeControl(n){removeControlMethod(n,this)}getLayerById(n){return getLayerById(this,n)}firstUpdated(){firstUpdatedMethod(qi(this,_u),this)}parseFeature(n){return parseFeature(n)}parseTextToFeature(n,s,o,a,h){parseTextToFeature(n,s,o,a,h)}registerProjectionFromCode(n){return registerProjectionFromCode(n)}registerProjection(n,s,o=void 0){registerProjection(n,s,o)}getFlatLayersArray(n){return getFlatLayersArray(n)}render(){return b`
      <style>
        :host {
          display: block;
          height: 100%;
        }
        .eox-map-tooltip {
          pointer-events: none !important;
        }
        ${olCss}
        ${eoxStyle}
        ${controlCss}
      </style>
      <div id="map" style="width: 100%; height: 100%"></div>
      <slot></slot>
    `}}_u=new WeakMap,lu=new WeakMap,Jc=new WeakMap,pu=new WeakMap,mu=new WeakMap,yu=new WeakMap,vu=new WeakMap,xu=new WeakMap,Eu=new WeakMap,eu=new WeakMap,zc=new WeakMap;customElements.define("eox-map",EOxMap);const GEOMETRY_READERS={Point:readPointGeometry,LineString:readLineStringGeometry,Polygon:readPolygonGeometry,MultiPoint:readMultiPointGeometry,MultiLineString:readMultiLineStringGeometry,MultiPolygon:readMultiPolygonGeometry},GEOMETRY_WRITERS={Point:writePointGeometry,LineString:writeLineStringGeometry,Polygon:writePolygonGeometry,MultiPoint:writeMultiPointGeometry,MultiLineString:writeMultiLineStringGeometry,MultiPolygon:writeMultiPolygonGeometry};class EsriJSON extends JSONFeature{constructor(t){t=t||{},super(),this.geometryName_=t.geometryName}readFeatureFromObject(t,n,s){const o=t,a=readGeometry(o.geometry,n),h=new Feature;if(this.geometryName_&&h.setGeometryName(this.geometryName_),h.setGeometry(a),o.attributes){h.setProperties(o.attributes,!0);const c=o.attributes[s];c!==void 0&&h.setId(c)}return h}readFeaturesFromObject(t,n){if(n=n||{},t.features){const s=t,o=[],a=s.features;for(let h=0,c=a.length;h<c;++h)o.push(this.readFeatureFromObject(a[h],n,t.objectIdFieldName));return o}return[this.readFeatureFromObject(t,n)]}readGeometryFromObject(t,n){return readGeometry(t,n)}readProjectionFromObject(t){if(t.spatialReference&&t.spatialReference.wkid!==void 0){const s=t.spatialReference.wkid;return get$1("EPSG:"+s)}return null}writeGeometryObject(t,n){return writeGeometry(t,this.adaptOptions(n))}writeFeatureObject(t,n){n=this.adaptOptions(n);const s={};if(!t.hasProperties())return s.attributes={},s;const o=t.getProperties(),a=t.getGeometry();if(a){s.geometry=writeGeometry(a,n);const h=n&&(n.dataProjection||n.featureProjection);h&&(s.geometry.spatialReference={wkid:Number(get$1(h).getCode().split(":").pop())}),delete o[t.getGeometryName()]}return isEmpty$1(o)?s.attributes={}:s.attributes=o,s}writeFeaturesObject(t,n){n=this.adaptOptions(n);const s=[];for(let o=0,a=t.length;o<a;++o)s.push(this.writeFeatureObject(t[o],n));return{features:s}}}function readGeometry(l,t){if(!l)return null;let n;if(typeof l.x=="number"&&typeof l.y=="number")n="Point";else if(l.points)n="MultiPoint";else if(l.paths)l.paths.length===1?n="LineString":n="MultiLineString";else if(l.rings){const o=l,a=getGeometryLayout(o),h=convertRings(o.rings,a);h.length===1?(n="Polygon",l=Object.assign({},l,{rings:h[0]})):(n="MultiPolygon",l=Object.assign({},l,{rings:h}))}const s=GEOMETRY_READERS[n];return transformGeometryWithOptions(s(l),!1,t)}function convertRings(l,t){const n=[],s=[],o=[];let a,h;for(a=0,h=l.length;a<h;++a)n.length=0,deflateCoordinates(n,0,l[a],t.length),linearRingIsClockwise(n,0,n.length,t.length)?s.push([l[a]]):o.push(l[a]);for(;o.length;){const c=o.shift();let u=!1;for(a=s.length-1;a>=0;a--){const d=s[a][0];if(containsExtent(new LinearRing(d).getExtent(),new LinearRing(c).getExtent())){s[a].push(c),u=!0;break}}u||s.push([c.reverse()])}return s}function readPointGeometry(l){let t;return l.m!==void 0&&l.z!==void 0?t=new Point([l.x,l.y,l.z,l.m],"XYZM"):l.z!==void 0?t=new Point([l.x,l.y,l.z],"XYZ"):l.m!==void 0?t=new Point([l.x,l.y,l.m],"XYM"):t=new Point([l.x,l.y]),t}function readLineStringGeometry(l){const t=getGeometryLayout(l);return new LineString(l.paths[0],t)}function readMultiLineStringGeometry(l){const t=getGeometryLayout(l);return new MultiLineString(l.paths,t)}function getGeometryLayout(l){let t="XY";return l.hasZ===!0&&l.hasM===!0?t="XYZM":l.hasZ===!0?t="XYZ":l.hasM===!0&&(t="XYM"),t}function readMultiPointGeometry(l){const t=getGeometryLayout(l);return new MultiPoint(l.points,t)}function readMultiPolygonGeometry(l){const t=getGeometryLayout(l);return new MultiPolygon(l.rings,t)}function readPolygonGeometry(l){const t=getGeometryLayout(l);return new Polygon(l.rings,t)}function writePointGeometry(l,t){const n=l.getCoordinates();let s;const o=l.getLayout();if(o==="XYZ")s={x:n[0],y:n[1],z:n[2]};else if(o==="XYM")s={x:n[0],y:n[1],m:n[2]};else if(o==="XYZM")s={x:n[0],y:n[1],z:n[2],m:n[3]};else if(o==="XY")s={x:n[0],y:n[1]};else throw new Error("Invalid geometry layout");return s}function getHasZM(l){const t=l.getLayout();return{hasZ:t==="XYZ"||t==="XYZM",hasM:t==="XYM"||t==="XYZM"}}function writeLineStringGeometry(l,t){const n=getHasZM(l);return{hasZ:n.hasZ,hasM:n.hasM,paths:[l.getCoordinates()]}}function writePolygonGeometry(l,t){const n=getHasZM(l);return{hasZ:n.hasZ,hasM:n.hasM,rings:l.getCoordinates(!1)}}function writeMultiLineStringGeometry(l,t){const n=getHasZM(l);return{hasZ:n.hasZ,hasM:n.hasM,paths:l.getCoordinates()}}function writeMultiPointGeometry(l,t){const n=getHasZM(l);return{hasZ:n.hasZ,hasM:n.hasM,points:l.getCoordinates()}}function writeMultiPolygonGeometry(l,t){const n=getHasZM(l),s=l.getCoordinates(!1),o=[];for(let a=0;a<s.length;a++)for(let h=s[a].length-1;h>=0;h--)o.push(s[a][h]);return{hasZ:n.hasZ,hasM:n.hasM,rings:o}}function writeGeometry(l,t){const n=GEOMETRY_WRITERS[l.getType()];return n(transformGeometryWithOptions(l,!0,t),t)}const GMLNS="http://www.opengis.net/gml",ONLY_WHITESPACE_RE=/^\s*$/;class GMLBase extends XMLFeature{constructor(t){super(),t=t||{},this.featureType=t.featureType,this.featureNS=t.featureNS,this.srsName=t.srsName,this.schemaLocation="",this.FEATURE_COLLECTION_PARSERS={},this.FEATURE_COLLECTION_PARSERS[this.namespace]={featureMember:makeArrayPusher(this.readFeaturesInternal),featureMembers:makeReplacer(this.readFeaturesInternal)},this.supportedMediaTypes=["application/gml+xml"]}readFeaturesInternal(t,n){const s=t.localName;let o=null;if(s=="FeatureCollection")o=pushParseAndPop([],this.FEATURE_COLLECTION_PARSERS,t,n,this);else if(s=="featureMembers"||s=="featureMember"||s=="member"){const a=n[0];let h=a.featureType,c=a.featureNS;const u="p",d="p0";if(!h&&t.childNodes){h=[],c={};for(let _=0,m=t.childNodes.length;_<m;++_){const p=t.childNodes[_];if(p.nodeType===1){const x=p.nodeName.split(":").pop();if(!h.includes(x)){let y="",T=0;const S=p.namespaceURI;for(const C in c){if(c[C]===S){y=C;break}++T}y||(y=u+T,c[y]=S),h.push(y+":"+x)}}}s!="featureMember"&&(a.featureType=h,a.featureNS=c)}if(typeof c=="string"){const _=c;c={},c[d]=_}const f={},g=Array.isArray(h)?h:[h];for(const _ in c){const m={};for(let p=0,x=g.length;p<x;++p)(g[p].includes(":")?g[p].split(":")[0]:d)===_&&(m[g[p].split(":").pop()]=s=="featureMembers"?makeArrayPusher(this.readFeatureElement,this):makeReplacer(this.readFeatureElement,this));f[c[_]]=m}s=="featureMember"||s=="member"?o=pushParseAndPop(void 0,f,t,n):o=pushParseAndPop([],f,t,n)}return o===null&&(o=[]),o}readGeometryOrExtent(t,n){const s=n[0];return s.srsName=t.firstElementChild.getAttribute("srsName"),s.srsDimension=t.firstElementChild.getAttribute("srsDimension"),pushParseAndPop(null,this.GEOMETRY_PARSERS,t,n,this)}readExtentElement(t,n){const s=n[0],o=this.readGeometryOrExtent(t,n);return o?transformExtentWithOptions(o,s):void 0}readGeometryElement(t,n){const s=n[0],o=this.readGeometryOrExtent(t,n);return o?transformGeometryWithOptions(o,!1,s):void 0}readFeatureElementInternal(t,n,s){let o;const a={};for(let u=t.firstElementChild;u;u=u.nextElementSibling){let d;const f=u.localName;u.childNodes.length===0||u.childNodes.length===1&&(u.firstChild.nodeType===3||u.firstChild.nodeType===4)?(d=getAllTextContent(u,!1),ONLY_WHITESPACE_RE.test(d)&&(d=void 0)):(s&&(d=f==="boundedBy"?this.readExtentElement(u,n):this.readGeometryElement(u,n)),d?f!=="boundedBy"&&(o=f):d=this.readFeatureElementInternal(u,n,!1));const g=u.attributes.length;if(g>0&&!(d instanceof Geometry)){d={_content_:d};for(let _=0;_<g;_++){const m=u.attributes[_].name;d[m]=u.attributes[_].value}}a[f]?(a[f]instanceof Array||(a[f]=[a[f]]),a[f].push(d)):a[f]=d}if(!s)return a;const h=new Feature(a);o&&h.setGeometryName(o);const c=t.getAttribute("fid")||getAttributeNS(t,this.namespace,"id");return c&&h.setId(c),h}readFeatureElement(t,n){return this.readFeatureElementInternal(t,n,!0)}readPoint(t,n){const s=this.readFlatCoordinatesFromNode(t,n);if(s)return new Point(s,"XYZ")}readMultiPoint(t,n){const s=pushParseAndPop([],this.MULTIPOINT_PARSERS,t,n,this);if(s)return new MultiPoint(s)}readMultiLineString(t,n){const s=pushParseAndPop([],this.MULTILINESTRING_PARSERS,t,n,this);if(s)return new MultiLineString(s)}readMultiPolygon(t,n){const s=pushParseAndPop([],this.MULTIPOLYGON_PARSERS,t,n,this);if(s)return new MultiPolygon(s)}pointMemberParser(t,n){parseNode(this.POINTMEMBER_PARSERS,t,n,this)}lineStringMemberParser(t,n){parseNode(this.LINESTRINGMEMBER_PARSERS,t,n,this)}polygonMemberParser(t,n){parseNode(this.POLYGONMEMBER_PARSERS,t,n,this)}readLineString(t,n){const s=this.readFlatCoordinatesFromNode(t,n);if(s)return new LineString(s,"XYZ")}readFlatLinearRing(t,n){const s=pushParseAndPop(null,this.GEOMETRY_FLAT_COORDINATES_PARSERS,t,n,this);if(s)return s}readLinearRing(t,n){const s=this.readFlatCoordinatesFromNode(t,n);if(s)return new LinearRing(s,"XYZ")}readPolygon(t,n){const s=pushParseAndPop([null],this.FLAT_LINEAR_RINGS_PARSERS,t,n,this);if(s&&s[0]){const o=s[0],a=[o.length];let h,c;for(h=1,c=s.length;h<c;++h)extend$2(o,s[h]),a.push(o.length);return new Polygon(o,"XYZ",a)}}readFlatCoordinatesFromNode(t,n){return pushParseAndPop(null,this.GEOMETRY_FLAT_COORDINATES_PARSERS,t,n,this)}readGeometryFromNode(t,n){const s=this.readGeometryElement(t,[this.getReadOptions(t,n||{})]);return s||null}readFeaturesFromNode(t,n){const s={featureType:this.featureType,featureNS:this.featureNS};return s&&Object.assign(s,this.getReadOptions(t,n)),this.readFeaturesInternal(t,[s])||[]}readProjectionFromNode(t){return get$1(this.srsName?this.srsName:t.firstElementChild.getAttribute("srsName"))}}GMLBase.prototype.namespace=GMLNS;GMLBase.prototype.FLAT_LINEAR_RINGS_PARSERS={"http://www.opengis.net/gml":{}};GMLBase.prototype.GEOMETRY_FLAT_COORDINATES_PARSERS={"http://www.opengis.net/gml":{}};GMLBase.prototype.GEOMETRY_PARSERS={"http://www.opengis.net/gml":{}};GMLBase.prototype.MULTIPOINT_PARSERS={"http://www.opengis.net/gml":{pointMember:makeArrayPusher(GMLBase.prototype.pointMemberParser),pointMembers:makeArrayPusher(GMLBase.prototype.pointMemberParser)}};GMLBase.prototype.MULTILINESTRING_PARSERS={"http://www.opengis.net/gml":{lineStringMember:makeArrayPusher(GMLBase.prototype.lineStringMemberParser),lineStringMembers:makeArrayPusher(GMLBase.prototype.lineStringMemberParser)}};GMLBase.prototype.MULTIPOLYGON_PARSERS={"http://www.opengis.net/gml":{polygonMember:makeArrayPusher(GMLBase.prototype.polygonMemberParser),polygonMembers:makeArrayPusher(GMLBase.prototype.polygonMemberParser)}};GMLBase.prototype.POINTMEMBER_PARSERS={"http://www.opengis.net/gml":{Point:makeArrayPusher(GMLBase.prototype.readFlatCoordinatesFromNode)}};GMLBase.prototype.LINESTRINGMEMBER_PARSERS={"http://www.opengis.net/gml":{LineString:makeArrayPusher(GMLBase.prototype.readLineString)}};GMLBase.prototype.POLYGONMEMBER_PARSERS={"http://www.opengis.net/gml":{Polygon:makeArrayPusher(GMLBase.prototype.readPolygon)}};GMLBase.prototype.RING_PARSERS={"http://www.opengis.net/gml":{LinearRing:makeReplacer(GMLBase.prototype.readFlatLinearRing)}};const schemaLocation$1=GMLNS+" http://schemas.opengis.net/gml/2.1.2/feature.xsd",MULTIGEOMETRY_TO_MEMBER_NODENAME$1={MultiLineString:"lineStringMember",MultiCurve:"curveMember",MultiPolygon:"polygonMember",MultiSurface:"surfaceMember"};class GML2 extends GMLBase{constructor(t){t=t||{},super(t),this.FEATURE_COLLECTION_PARSERS[GMLNS].featureMember=makeArrayPusher(this.readFeaturesInternal),this.schemaLocation=t.schemaLocation?t.schemaLocation:schemaLocation$1}readFlatCoordinates(t,n){const s=getAllTextContent(t,!1).replace(/^\s*|\s*$/g,""),a=n[0].srsName;let h="enu";if(a){const d=get$1(a);d&&(h=d.getAxisOrientation())}const c=s.trim().split(/\s+/),u=[];for(let d=0,f=c.length;d<f;d++){const g=c[d].split(/,+/),_=parseFloat(g[0]),m=parseFloat(g[1]),p=g.length===3?parseFloat(g[2]):0;h.startsWith("en")?u.push(_,m,p):u.push(m,_,p)}return u}readBox(t,n){const s=pushParseAndPop([null],this.BOX_PARSERS_,t,n,this);return createOrUpdate$2(s[1][0],s[1][1],s[1][3],s[1][4])}innerBoundaryIsParser(t,n){const s=pushParseAndPop(void 0,this.RING_PARSERS,t,n,this);s&&n[n.length-1].push(s)}outerBoundaryIsParser(t,n){const s=pushParseAndPop(void 0,this.RING_PARSERS,t,n,this);if(s){const o=n[n.length-1];o[0]=s}}GEOMETRY_NODE_FACTORY_(t,n,s){const o=n[n.length-1],a=o.multiSurface,h=o.surface,c=o.multiCurve;return Array.isArray(t)?s="Envelope":(s=t.getType(),s==="MultiPolygon"&&a===!0?s="MultiSurface":s==="Polygon"&&h===!0?s="Surface":s==="MultiLineString"&&c===!0&&(s="MultiCurve")),createElementNS("http://www.opengis.net/gml",s)}writeFeatureElement(t,n,s){const o=n.getId();o&&t.setAttribute("fid",o);const a=s[s.length-1],h=a.featureNS,c=n.getGeometryName();a.serializers||(a.serializers={},a.serializers[h]={});const u=[],d=[];if(n.hasProperties()){const g=n.getProperties();for(const _ in g){const m=g[_];m!=null&&(u.push(_),d.push(m),_==c||typeof m.getSimplifiedGeometry=="function"?_ in a.serializers[h]||(a.serializers[h][_]=makeChildAppender(this.writeGeometryElement,this)):_ in a.serializers[h]||(a.serializers[h][_]=makeChildAppender(writeStringTextNode)))}}const f=Object.assign({},a);f.node=t,pushSerializeAndPop(f,a.serializers,makeSimpleNodeFactory(void 0,h),d,s,u)}writeCurveOrLineString(t,n,s){const a=s[s.length-1].srsName;if(t.nodeName!=="LineStringSegment"&&a&&t.setAttribute("srsName",a),t.nodeName==="LineString"||t.nodeName==="LineStringSegment"){const h=this.createCoordinatesNode_(t.namespaceURI);t.appendChild(h),this.writeCoordinates_(h,n,s)}else if(t.nodeName==="Curve"){const h=createElementNS(t.namespaceURI,"segments");t.appendChild(h),this.writeCurveSegments_(h,n,s)}}writeLineStringOrCurveMember(t,n,s){const o=this.GEOMETRY_NODE_FACTORY_(n,s);o&&(t.appendChild(o),this.writeCurveOrLineString(o,n,s))}writeMultiCurveOrLineString(t,n,s){const o=s[s.length-1],a=o.hasZ,h=o.srsName,c=o.curve;h&&t.setAttribute("srsName",h);const u=n.getLineStrings();pushSerializeAndPop({node:t,hasZ:a,srsName:h,curve:c},this.LINESTRINGORCURVEMEMBER_SERIALIZERS,this.MULTIGEOMETRY_MEMBER_NODE_FACTORY_,u,s,void 0,this)}writeGeometryElement(t,n,s){const o=s[s.length-1],a=Object.assign({},o);a.node=t;let h;Array.isArray(n)?h=transformExtentWithOptions(n,o):h=transformGeometryWithOptions(n,!0,o),pushSerializeAndPop(a,this.GEOMETRY_SERIALIZERS,this.GEOMETRY_NODE_FACTORY_,[h],s,void 0,this)}createCoordinatesNode_(t){const n=createElementNS(t,"coordinates");return n.setAttribute("decimal","."),n.setAttribute("cs",","),n.setAttribute("ts"," "),n}writeCoordinates_(t,n,s){const o=s[s.length-1],a=o.hasZ,h=o.srsName,c=n.getCoordinates(),u=c.length,d=new Array(u);for(let f=0;f<u;++f){const g=c[f];d[f]=this.getCoords_(g,h,a)}writeStringTextNode(t,d.join(" "))}writeCurveSegments_(t,n,s){const o=createElementNS(t.namespaceURI,"LineStringSegment");t.appendChild(o),this.writeCurveOrLineString(o,n,s)}writeSurfaceOrPolygon(t,n,s){const o=s[s.length-1],a=o.hasZ,h=o.srsName;if(t.nodeName!=="PolygonPatch"&&h&&t.setAttribute("srsName",h),t.nodeName==="Polygon"||t.nodeName==="PolygonPatch"){const c=n.getLinearRings();pushSerializeAndPop({node:t,hasZ:a,srsName:h},this.RING_SERIALIZERS,this.RING_NODE_FACTORY_,c,s,void 0,this)}else if(t.nodeName==="Surface"){const c=createElementNS(t.namespaceURI,"patches");t.appendChild(c),this.writeSurfacePatches_(c,n,s)}}RING_NODE_FACTORY_(t,n,s){const o=n[n.length-1],a=o.node,h=o.exteriorWritten;return h===void 0&&(o.exteriorWritten=!0),createElementNS(a.namespaceURI,h!==void 0?"innerBoundaryIs":"outerBoundaryIs")}writeSurfacePatches_(t,n,s){const o=createElementNS(t.namespaceURI,"PolygonPatch");t.appendChild(o),this.writeSurfaceOrPolygon(o,n,s)}writeRing(t,n,s){const o=createElementNS(t.namespaceURI,"LinearRing");t.appendChild(o),this.writeLinearRing(o,n,s)}getCoords_(t,n,s){let a=(n?get$1(n).getAxisOrientation():"enu").startsWith("en")?t[0]+","+t[1]:t[1]+","+t[0];if(s){const h=t[2]||0;a+=","+h}return a}writePoint(t,n,s){const o=s[s.length-1],a=o.hasZ,h=o.srsName;h&&t.setAttribute("srsName",h);const c=this.createCoordinatesNode_(t.namespaceURI);t.appendChild(c);const u=n.getCoordinates(),d=this.getCoords_(u,h,a);writeStringTextNode(c,d)}writeMultiPoint(t,n,s){const o=s[s.length-1],a=o.hasZ,h=o.srsName;h&&t.setAttribute("srsName",h);const c=n.getPoints();pushSerializeAndPop({node:t,hasZ:a,srsName:h},this.POINTMEMBER_SERIALIZERS,makeSimpleNodeFactory("pointMember"),c,s,void 0,this)}writePointMember(t,n,s){const o=createElementNS(t.namespaceURI,"Point");t.appendChild(o),this.writePoint(o,n,s)}writeLinearRing(t,n,s){const a=s[s.length-1].srsName;a&&t.setAttribute("srsName",a);const h=this.createCoordinatesNode_(t.namespaceURI);t.appendChild(h),this.writeCoordinates_(h,n,s)}writeMultiSurfaceOrPolygon(t,n,s){const o=s[s.length-1],a=o.hasZ,h=o.srsName,c=o.surface;h&&t.setAttribute("srsName",h);const u=n.getPolygons();pushSerializeAndPop({node:t,hasZ:a,srsName:h,surface:c},this.SURFACEORPOLYGONMEMBER_SERIALIZERS,this.MULTIGEOMETRY_MEMBER_NODE_FACTORY_,u,s,void 0,this)}writeSurfaceOrPolygonMember(t,n,s){const o=this.GEOMETRY_NODE_FACTORY_(n,s);o&&(t.appendChild(o),this.writeSurfaceOrPolygon(o,n,s))}writeEnvelope(t,n,s){const a=s[s.length-1].srsName;a&&t.setAttribute("srsName",a);const h=["lowerCorner","upperCorner"],c=[n[0]+" "+n[1],n[2]+" "+n[3]];pushSerializeAndPop({node:t},this.ENVELOPE_SERIALIZERS,OBJECT_PROPERTY_NODE_FACTORY,c,s,h,this)}MULTIGEOMETRY_MEMBER_NODE_FACTORY_(t,n,s){const o=n[n.length-1].node;return createElementNS("http://www.opengis.net/gml",MULTIGEOMETRY_TO_MEMBER_NODENAME$1[o.nodeName])}}GML2.prototype.GEOMETRY_FLAT_COORDINATES_PARSERS={"http://www.opengis.net/gml":{coordinates:makeReplacer(GML2.prototype.readFlatCoordinates)}};GML2.prototype.FLAT_LINEAR_RINGS_PARSERS={"http://www.opengis.net/gml":{innerBoundaryIs:GML2.prototype.innerBoundaryIsParser,outerBoundaryIs:GML2.prototype.outerBoundaryIsParser}};GML2.prototype.BOX_PARSERS_={"http://www.opengis.net/gml":{coordinates:makeArrayPusher(GML2.prototype.readFlatCoordinates)}};GML2.prototype.GEOMETRY_PARSERS={"http://www.opengis.net/gml":{Point:makeReplacer(GMLBase.prototype.readPoint),MultiPoint:makeReplacer(GMLBase.prototype.readMultiPoint),LineString:makeReplacer(GMLBase.prototype.readLineString),MultiLineString:makeReplacer(GMLBase.prototype.readMultiLineString),LinearRing:makeReplacer(GMLBase.prototype.readLinearRing),Polygon:makeReplacer(GMLBase.prototype.readPolygon),MultiPolygon:makeReplacer(GMLBase.prototype.readMultiPolygon),Box:makeReplacer(GML2.prototype.readBox)}};GML2.prototype.GEOMETRY_SERIALIZERS={"http://www.opengis.net/gml":{Curve:makeChildAppender(GML2.prototype.writeCurveOrLineString),MultiCurve:makeChildAppender(GML2.prototype.writeMultiCurveOrLineString),Point:makeChildAppender(GML2.prototype.writePoint),MultiPoint:makeChildAppender(GML2.prototype.writeMultiPoint),LineString:makeChildAppender(GML2.prototype.writeCurveOrLineString),MultiLineString:makeChildAppender(GML2.prototype.writeMultiCurveOrLineString),LinearRing:makeChildAppender(GML2.prototype.writeLinearRing),Polygon:makeChildAppender(GML2.prototype.writeSurfaceOrPolygon),MultiPolygon:makeChildAppender(GML2.prototype.writeMultiSurfaceOrPolygon),Surface:makeChildAppender(GML2.prototype.writeSurfaceOrPolygon),MultiSurface:makeChildAppender(GML2.prototype.writeMultiSurfaceOrPolygon),Envelope:makeChildAppender(GML2.prototype.writeEnvelope)}};GML2.prototype.LINESTRINGORCURVEMEMBER_SERIALIZERS={"http://www.opengis.net/gml":{lineStringMember:makeChildAppender(GML2.prototype.writeLineStringOrCurveMember),curveMember:makeChildAppender(GML2.prototype.writeLineStringOrCurveMember)}};GML2.prototype.RING_SERIALIZERS={"http://www.opengis.net/gml":{outerBoundaryIs:makeChildAppender(GML2.prototype.writeRing),innerBoundaryIs:makeChildAppender(GML2.prototype.writeRing)}};GML2.prototype.POINTMEMBER_SERIALIZERS={"http://www.opengis.net/gml":{pointMember:makeChildAppender(GML2.prototype.writePointMember)}};GML2.prototype.SURFACEORPOLYGONMEMBER_SERIALIZERS={"http://www.opengis.net/gml":{surfaceMember:makeChildAppender(GML2.prototype.writeSurfaceOrPolygonMember),polygonMember:makeChildAppender(GML2.prototype.writeSurfaceOrPolygonMember)}};GML2.prototype.ENVELOPE_SERIALIZERS={"http://www.opengis.net/gml":{lowerCorner:makeChildAppender(writeStringTextNode),upperCorner:makeChildAppender(writeStringTextNode)}};const schemaLocation=GMLNS+" http://schemas.opengis.net/gml/3.1.1/profiles/gmlsfProfile/1.0.0/gmlsf.xsd",MULTIGEOMETRY_TO_MEMBER_NODENAME={MultiLineString:"lineStringMember",MultiCurve:"curveMember",MultiPolygon:"polygonMember",MultiSurface:"surfaceMember"};class GML3 extends GMLBase{constructor(t){t=t||{},super(t),this.surface_=t.surface!==void 0?t.surface:!1,this.curve_=t.curve!==void 0?t.curve:!1,this.multiCurve_=t.multiCurve!==void 0?t.multiCurve:!0,this.multiSurface_=t.multiSurface!==void 0?t.multiSurface:!0,this.schemaLocation=t.schemaLocation?t.schemaLocation:schemaLocation,this.hasZ=t.hasZ!==void 0?t.hasZ:!1}readMultiCurve(t,n){const s=pushParseAndPop([],this.MULTICURVE_PARSERS,t,n,this);if(s)return new MultiLineString(s)}readFlatCurveRing(t,n){const s=pushParseAndPop([],this.MULTICURVE_PARSERS,t,n,this),o=[];for(let a=0,h=s.length;a<h;++a)extend$2(o,s[a].getFlatCoordinates());return o}readMultiSurface(t,n){const s=pushParseAndPop([],this.MULTISURFACE_PARSERS,t,n,this);if(s)return new MultiPolygon(s)}curveMemberParser(t,n){parseNode(this.CURVEMEMBER_PARSERS,t,n,this)}surfaceMemberParser(t,n){parseNode(this.SURFACEMEMBER_PARSERS,t,n,this)}readPatch(t,n){return pushParseAndPop([null],this.PATCHES_PARSERS,t,n,this)}readSegment(t,n){return pushParseAndPop([],this.SEGMENTS_PARSERS,t,n,this)}readPolygonPatch(t,n){return pushParseAndPop([null],this.FLAT_LINEAR_RINGS_PARSERS,t,n,this)}readLineStringSegment(t,n){return pushParseAndPop([null],this.GEOMETRY_FLAT_COORDINATES_PARSERS,t,n,this)}interiorParser(t,n){const s=pushParseAndPop(void 0,this.RING_PARSERS,t,n,this);s&&n[n.length-1].push(s)}exteriorParser(t,n){const s=pushParseAndPop(void 0,this.RING_PARSERS,t,n,this);if(s){const o=n[n.length-1];o[0]=s}}readSurface(t,n){const s=pushParseAndPop([null],this.SURFACE_PARSERS,t,n,this);if(s&&s[0]){const o=s[0],a=[o.length];let h,c;for(h=1,c=s.length;h<c;++h)extend$2(o,s[h]),a.push(o.length);return new Polygon(o,"XYZ",a)}}readCurve(t,n){const s=pushParseAndPop([null],this.CURVE_PARSERS,t,n,this);if(s)return new LineString(s,"XYZ")}readEnvelope(t,n){const s=pushParseAndPop([null],this.ENVELOPE_PARSERS,t,n,this);return createOrUpdate$2(s[1][0],s[1][1],s[2][0],s[2][1])}readFlatPos(t,n){let s=getAllTextContent(t,!1);const o=/^\s*([+\-]?\d*\.?\d+(?:[eE][+\-]?\d+)?)\s*/,a=[];let h;for(;h=o.exec(s);)a.push(parseFloat(h[1])),s=s.substr(h[0].length);if(s!=="")return;const u=n[0].srsName;if((u?get$1(u).getAxisOrientation():"enu")==="neu")for(let g=0,_=a.length;g<_;g+=3){const m=a[g],p=a[g+1];a[g]=p,a[g+1]=m}const f=a.length;if(f==2&&a.push(0),f!==0)return a}readFlatPosList(t,n){const s=getAllTextContent(t,!1).replace(/^\s*|\s*$/g,""),o=n[0],a=o.srsName,h=o.srsDimension,c=a?get$1(a).getAxisOrientation():"enu",u=s.split(/\s+/);let d=2;t.getAttribute("srsDimension")?d=readNonNegativeIntegerString(t.getAttribute("srsDimension")):t.getAttribute("dimension")?d=readNonNegativeIntegerString(t.getAttribute("dimension")):t.parentNode.getAttribute("srsDimension")?d=readNonNegativeIntegerString(t.parentNode.getAttribute("srsDimension")):h&&(d=readNonNegativeIntegerString(h));const f=c.startsWith("en");let g,_,m;const p=[];for(let x=0,y=u.length;x<y;x+=d)g=parseFloat(u[x]),_=parseFloat(u[x+1]),m=d===3?parseFloat(u[x+2]):0,f?p.push(g,_,m):p.push(_,g,m);return p}writePos_(t,n,s){const o=s[s.length-1],a=o.hasZ,h=a?"3":"2";t.setAttribute("srsDimension",h);const c=o.srsName,u=c?get$1(c).getAxisOrientation():"enu",d=n.getCoordinates();let f=u.startsWith("en")?d[0]+" "+d[1]:d[1]+" "+d[0];if(a){const g=d[2]||0;f+=" "+g}writeStringTextNode(t,f)}getCoords_(t,n,s){let a=(n?get$1(n).getAxisOrientation():"enu").startsWith("en")?t[0]+" "+t[1]:t[1]+" "+t[0];if(s){const h=t[2]||0;a+=" "+h}return a}writePosList_(t,n,s){const o=s[s.length-1],a=o.hasZ,h=a?"3":"2";t.setAttribute("srsDimension",h);const c=o.srsName,u=n.getCoordinates(),d=u.length,f=new Array(d);let g;for(let _=0;_<d;++_)g=u[_],f[_]=this.getCoords_(g,c,a);writeStringTextNode(t,f.join(" "))}writePoint(t,n,s){const a=s[s.length-1].srsName;a&&t.setAttribute("srsName",a);const h=createElementNS(t.namespaceURI,"pos");t.appendChild(h),this.writePos_(h,n,s)}writeEnvelope(t,n,s){const a=s[s.length-1].srsName;a&&t.setAttribute("srsName",a);const h=["lowerCorner","upperCorner"],c=[n[0]+" "+n[1],n[2]+" "+n[3]];pushSerializeAndPop({node:t},this.ENVELOPE_SERIALIZERS,OBJECT_PROPERTY_NODE_FACTORY,c,s,h,this)}writeLinearRing(t,n,s){const a=s[s.length-1].srsName;a&&t.setAttribute("srsName",a);const h=createElementNS(t.namespaceURI,"posList");t.appendChild(h),this.writePosList_(h,n,s)}RING_NODE_FACTORY_(t,n,s){const o=n[n.length-1],a=o.node,h=o.exteriorWritten;return h===void 0&&(o.exteriorWritten=!0),createElementNS(a.namespaceURI,h!==void 0?"interior":"exterior")}writeSurfaceOrPolygon(t,n,s){const o=s[s.length-1],a=o.hasZ,h=o.srsName;if(t.nodeName!=="PolygonPatch"&&h&&t.setAttribute("srsName",h),t.nodeName==="Polygon"||t.nodeName==="PolygonPatch"){const c=n.getLinearRings();pushSerializeAndPop({node:t,hasZ:a,srsName:h},this.RING_SERIALIZERS,this.RING_NODE_FACTORY_,c,s,void 0,this)}else if(t.nodeName==="Surface"){const c=createElementNS(t.namespaceURI,"patches");t.appendChild(c),this.writeSurfacePatches_(c,n,s)}}writeCurveOrLineString(t,n,s){const a=s[s.length-1].srsName;if(t.nodeName!=="LineStringSegment"&&a&&t.setAttribute("srsName",a),t.nodeName==="LineString"||t.nodeName==="LineStringSegment"){const h=createElementNS(t.namespaceURI,"posList");t.appendChild(h),this.writePosList_(h,n,s)}else if(t.nodeName==="Curve"){const h=createElementNS(t.namespaceURI,"segments");t.appendChild(h),this.writeCurveSegments_(h,n,s)}}writeMultiSurfaceOrPolygon(t,n,s){const o=s[s.length-1],a=o.hasZ,h=o.srsName,c=o.surface;h&&t.setAttribute("srsName",h);const u=n.getPolygons();pushSerializeAndPop({node:t,hasZ:a,srsName:h,surface:c},this.SURFACEORPOLYGONMEMBER_SERIALIZERS,this.MULTIGEOMETRY_MEMBER_NODE_FACTORY_,u,s,void 0,this)}writeMultiPoint(t,n,s){const o=s[s.length-1],a=o.srsName,h=o.hasZ;a&&t.setAttribute("srsName",a);const c=n.getPoints();pushSerializeAndPop({node:t,hasZ:h,srsName:a},this.POINTMEMBER_SERIALIZERS,makeSimpleNodeFactory("pointMember"),c,s,void 0,this)}writeMultiCurveOrLineString(t,n,s){const o=s[s.length-1],a=o.hasZ,h=o.srsName,c=o.curve;h&&t.setAttribute("srsName",h);const u=n.getLineStrings();pushSerializeAndPop({node:t,hasZ:a,srsName:h,curve:c},this.LINESTRINGORCURVEMEMBER_SERIALIZERS,this.MULTIGEOMETRY_MEMBER_NODE_FACTORY_,u,s,void 0,this)}writeRing(t,n,s){const o=createElementNS(t.namespaceURI,"LinearRing");t.appendChild(o),this.writeLinearRing(o,n,s)}writeSurfaceOrPolygonMember(t,n,s){const o=this.GEOMETRY_NODE_FACTORY_(n,s);o&&(t.appendChild(o),this.writeSurfaceOrPolygon(o,n,s))}writePointMember(t,n,s){const o=createElementNS(t.namespaceURI,"Point");t.appendChild(o),this.writePoint(o,n,s)}writeLineStringOrCurveMember(t,n,s){const o=this.GEOMETRY_NODE_FACTORY_(n,s);o&&(t.appendChild(o),this.writeCurveOrLineString(o,n,s))}writeSurfacePatches_(t,n,s){const o=createElementNS(t.namespaceURI,"PolygonPatch");t.appendChild(o),this.writeSurfaceOrPolygon(o,n,s)}writeCurveSegments_(t,n,s){const o=createElementNS(t.namespaceURI,"LineStringSegment");t.appendChild(o),this.writeCurveOrLineString(o,n,s)}writeGeometryElement(t,n,s){const o=s[s.length-1],a=Object.assign({},o);a.node=t;let h;Array.isArray(n)?h=transformExtentWithOptions(n,o):h=transformGeometryWithOptions(n,!0,o),pushSerializeAndPop(a,this.GEOMETRY_SERIALIZERS,this.GEOMETRY_NODE_FACTORY_,[h],s,void 0,this)}writeFeatureElement(t,n,s){const o=n.getId();o&&t.setAttribute("fid",o);const a=s[s.length-1],h=a.featureNS,c=n.getGeometryName();a.serializers||(a.serializers={},a.serializers[h]={});const u=[],d=[];if(n.hasProperties()){const g=n.getProperties();for(const _ in g){const m=g[_];m!=null&&(u.push(_),d.push(m),_==c||typeof m.getSimplifiedGeometry=="function"?_ in a.serializers[h]||(a.serializers[h][_]=makeChildAppender(this.writeGeometryElement,this)):_ in a.serializers[h]||(a.serializers[h][_]=makeChildAppender(writeStringTextNode)))}}const f=Object.assign({},a);f.node=t,pushSerializeAndPop(f,a.serializers,makeSimpleNodeFactory(void 0,h),d,s,u)}writeFeatureMembers_(t,n,s){const o=s[s.length-1],a=o.featureType,h=o.featureNS,c={};c[h]={},c[h][a]=makeChildAppender(this.writeFeatureElement,this);const u=Object.assign({},o);u.node=t,pushSerializeAndPop(u,c,makeSimpleNodeFactory(a,h),n,s)}MULTIGEOMETRY_MEMBER_NODE_FACTORY_(t,n,s){const o=n[n.length-1].node;return createElementNS(this.namespace,MULTIGEOMETRY_TO_MEMBER_NODENAME[o.nodeName])}GEOMETRY_NODE_FACTORY_(t,n,s){const o=n[n.length-1],a=o.multiSurface,h=o.surface,c=o.curve,u=o.multiCurve;return Array.isArray(t)?s="Envelope":(s=t.getType(),s==="MultiPolygon"&&a===!0?s="MultiSurface":s==="Polygon"&&h===!0?s="Surface":s==="LineString"&&c===!0?s="Curve":s==="MultiLineString"&&u===!0&&(s="MultiCurve")),createElementNS(this.namespace,s)}writeGeometryNode(t,n){n=this.adaptOptions(n);const s=createElementNS(this.namespace,"geom"),o={node:s,hasZ:this.hasZ,srsName:this.srsName,curve:this.curve_,surface:this.surface_,multiSurface:this.multiSurface_,multiCurve:this.multiCurve_};return n&&Object.assign(o,n),this.writeGeometryElement(s,t,[o]),s}writeFeaturesNode(t,n){n=this.adaptOptions(n);const s=createElementNS(this.namespace,"featureMembers");s.setAttributeNS(XML_SCHEMA_INSTANCE_URI,"xsi:schemaLocation",this.schemaLocation);const o={srsName:this.srsName,hasZ:this.hasZ,curve:this.curve_,surface:this.surface_,multiSurface:this.multiSurface_,multiCurve:this.multiCurve_,featureNS:this.featureNS,featureType:this.featureType};return n&&Object.assign(o,n),this.writeFeatureMembers_(s,t,[o]),s}}GML3.prototype.GEOMETRY_FLAT_COORDINATES_PARSERS={"http://www.opengis.net/gml":{pos:makeReplacer(GML3.prototype.readFlatPos),posList:makeReplacer(GML3.prototype.readFlatPosList),coordinates:makeReplacer(GML2.prototype.readFlatCoordinates)}};GML3.prototype.FLAT_LINEAR_RINGS_PARSERS={"http://www.opengis.net/gml":{interior:GML3.prototype.interiorParser,exterior:GML3.prototype.exteriorParser}};GML3.prototype.GEOMETRY_PARSERS={"http://www.opengis.net/gml":{Point:makeReplacer(GMLBase.prototype.readPoint),MultiPoint:makeReplacer(GMLBase.prototype.readMultiPoint),LineString:makeReplacer(GMLBase.prototype.readLineString),MultiLineString:makeReplacer(GMLBase.prototype.readMultiLineString),LinearRing:makeReplacer(GMLBase.prototype.readLinearRing),Polygon:makeReplacer(GMLBase.prototype.readPolygon),MultiPolygon:makeReplacer(GMLBase.prototype.readMultiPolygon),Surface:makeReplacer(GML3.prototype.readSurface),MultiSurface:makeReplacer(GML3.prototype.readMultiSurface),Curve:makeReplacer(GML3.prototype.readCurve),MultiCurve:makeReplacer(GML3.prototype.readMultiCurve),Envelope:makeReplacer(GML3.prototype.readEnvelope)}};GML3.prototype.MULTICURVE_PARSERS={"http://www.opengis.net/gml":{curveMember:makeArrayPusher(GML3.prototype.curveMemberParser),curveMembers:makeArrayPusher(GML3.prototype.curveMemberParser)}};GML3.prototype.MULTISURFACE_PARSERS={"http://www.opengis.net/gml":{surfaceMember:makeArrayPusher(GML3.prototype.surfaceMemberParser),surfaceMembers:makeArrayPusher(GML3.prototype.surfaceMemberParser)}};GML3.prototype.CURVEMEMBER_PARSERS={"http://www.opengis.net/gml":{LineString:makeArrayPusher(GMLBase.prototype.readLineString),Curve:makeArrayPusher(GML3.prototype.readCurve)}};GML3.prototype.SURFACEMEMBER_PARSERS={"http://www.opengis.net/gml":{Polygon:makeArrayPusher(GMLBase.prototype.readPolygon),Surface:makeArrayPusher(GML3.prototype.readSurface)}};GML3.prototype.SURFACE_PARSERS={"http://www.opengis.net/gml":{patches:makeReplacer(GML3.prototype.readPatch)}};GML3.prototype.CURVE_PARSERS={"http://www.opengis.net/gml":{segments:makeReplacer(GML3.prototype.readSegment)}};GML3.prototype.ENVELOPE_PARSERS={"http://www.opengis.net/gml":{lowerCorner:makeArrayPusher(GML3.prototype.readFlatPosList),upperCorner:makeArrayPusher(GML3.prototype.readFlatPosList)}};GML3.prototype.PATCHES_PARSERS={"http://www.opengis.net/gml":{PolygonPatch:makeReplacer(GML3.prototype.readPolygonPatch)}};GML3.prototype.SEGMENTS_PARSERS={"http://www.opengis.net/gml":{LineStringSegment:makeArrayExtender(GML3.prototype.readLineStringSegment)}};GMLBase.prototype.RING_PARSERS={"http://www.opengis.net/gml":{LinearRing:makeReplacer(GMLBase.prototype.readFlatLinearRing),Ring:makeReplacer(GML3.prototype.readFlatCurveRing)}};GML3.prototype.writeFeatures;GML3.prototype.RING_SERIALIZERS={"http://www.opengis.net/gml":{exterior:makeChildAppender(GML3.prototype.writeRing),interior:makeChildAppender(GML3.prototype.writeRing)}};GML3.prototype.ENVELOPE_SERIALIZERS={"http://www.opengis.net/gml":{lowerCorner:makeChildAppender(writeStringTextNode),upperCorner:makeChildAppender(writeStringTextNode)}};GML3.prototype.SURFACEORPOLYGONMEMBER_SERIALIZERS={"http://www.opengis.net/gml":{surfaceMember:makeChildAppender(GML3.prototype.writeSurfaceOrPolygonMember),polygonMember:makeChildAppender(GML3.prototype.writeSurfaceOrPolygonMember)}};GML3.prototype.POINTMEMBER_SERIALIZERS={"http://www.opengis.net/gml":{pointMember:makeChildAppender(GML3.prototype.writePointMember)}};GML3.prototype.LINESTRINGORCURVEMEMBER_SERIALIZERS={"http://www.opengis.net/gml":{lineStringMember:makeChildAppender(GML3.prototype.writeLineStringOrCurveMember),curveMember:makeChildAppender(GML3.prototype.writeLineStringOrCurveMember)}};GML3.prototype.GEOMETRY_SERIALIZERS={"http://www.opengis.net/gml":{Curve:makeChildAppender(GML3.prototype.writeCurveOrLineString),MultiCurve:makeChildAppender(GML3.prototype.writeMultiCurveOrLineString),Point:makeChildAppender(GML3.prototype.writePoint),MultiPoint:makeChildAppender(GML3.prototype.writeMultiPoint),LineString:makeChildAppender(GML3.prototype.writeCurveOrLineString),MultiLineString:makeChildAppender(GML3.prototype.writeMultiCurveOrLineString),LinearRing:makeChildAppender(GML3.prototype.writeLinearRing),Polygon:makeChildAppender(GML3.prototype.writeSurfaceOrPolygon),MultiPolygon:makeChildAppender(GML3.prototype.writeMultiSurfaceOrPolygon),Surface:makeChildAppender(GML3.prototype.writeSurfaceOrPolygon),MultiSurface:makeChildAppender(GML3.prototype.writeMultiSurfaceOrPolygon),Envelope:makeChildAppender(GML3.prototype.writeEnvelope)}};const GML=GML3;GML.prototype.writeFeatures;GML.prototype.writeFeaturesNode;const NAMESPACE_URIS$3=[null,"http://www.topografix.com/GPX/1/0","http://www.topografix.com/GPX/1/1"],SCHEMA_LOCATION="http://www.topografix.com/GPX/1/1 http://www.topografix.com/GPX/1/1/gpx.xsd",FEATURE_READER={rte:readRte,trk:readTrk,wpt:readWpt},GPX_PARSERS=makeStructureNS(NAMESPACE_URIS$3,{rte:makeArrayPusher(readRte),trk:makeArrayPusher(readTrk),wpt:makeArrayPusher(readWpt)}),LINK_PARSERS=makeStructureNS(NAMESPACE_URIS$3,{text:makeObjectPropertySetter(readString,"linkText"),type:makeObjectPropertySetter(readString,"linkType")}),AUTHOR_PARSERS=makeStructureNS(NAMESPACE_URIS$3,{name:makeObjectPropertySetter(readString),email:parseEmail,link:parseLink}),METADATA_PARSERS=makeStructureNS(NAMESPACE_URIS$3,{name:makeObjectPropertySetter(readString),desc:makeObjectPropertySetter(readString),author:makeObjectPropertySetter(readAuthor),copyright:makeObjectPropertySetter(readCopyright),link:parseLink,time:makeObjectPropertySetter(readDateTime),keywords:makeObjectPropertySetter(readString),bounds:parseBounds,extensions:parseExtensions}),COPYRIGHT_PARSERS=makeStructureNS(NAMESPACE_URIS$3,{year:makeObjectPropertySetter(readPositiveInteger),license:makeObjectPropertySetter(readString)}),GPX_SERIALIZERS=makeStructureNS(NAMESPACE_URIS$3,{rte:makeChildAppender(writeRte),trk:makeChildAppender(writeTrk),wpt:makeChildAppender(writeWpt)});class GPX extends XMLFeature{constructor(t){super(),t=t||{},this.dataProjection=get$1("EPSG:4326"),this.readExtensions_=t.readExtensions}handleReadExtensions_(t){t||(t=[]);for(let n=0,s=t.length;n<s;++n){const o=t[n];if(this.readExtensions_){const a=o.get("extensionsNode_")||null;this.readExtensions_(o,a)}o.set("extensionsNode_",void 0)}}readMetadata(t){return t?typeof t=="string"?this.readMetadataFromDocument(parse(t)):isDocument(t)?this.readMetadataFromDocument(t):this.readMetadataFromNode(t):null}readMetadataFromDocument(t){for(let n=t.firstChild;n;n=n.nextSibling)if(n.nodeType===Node.ELEMENT_NODE){const s=this.readMetadataFromNode(n);if(s)return s}return null}readMetadataFromNode(t){if(!NAMESPACE_URIS$3.includes(t.namespaceURI))return null;for(let n=t.firstElementChild;n;n=n.nextElementSibling)if(NAMESPACE_URIS$3.includes(n.namespaceURI)&&n.localName==="metadata")return pushParseAndPop({},METADATA_PARSERS,n,[]);return null}readFeatureFromNode(t,n){if(!NAMESPACE_URIS$3.includes(t.namespaceURI))return null;const s=FEATURE_READER[t.localName];if(!s)return null;const o=s(t,[this.getReadOptions(t,n)]);return o?(this.handleReadExtensions_([o]),o):null}readFeaturesFromNode(t,n){if(!NAMESPACE_URIS$3.includes(t.namespaceURI))return[];if(t.localName=="gpx"){const s=pushParseAndPop([],GPX_PARSERS,t,[this.getReadOptions(t,n)]);return s?(this.handleReadExtensions_(s),s):[]}return[]}writeFeaturesNode(t,n){n=this.adaptOptions(n);const s=createElementNS("http://www.topografix.com/GPX/1/1","gpx");return s.setAttributeNS("http://www.w3.org/2000/xmlns/","xmlns:xsi",XML_SCHEMA_INSTANCE_URI),s.setAttributeNS(XML_SCHEMA_INSTANCE_URI,"xsi:schemaLocation",SCHEMA_LOCATION),s.setAttribute("version","1.1"),s.setAttribute("creator","OpenLayers"),pushSerializeAndPop({node:s},GPX_SERIALIZERS,GPX_NODE_FACTORY,t,[n]),s}}const RTE_PARSERS=makeStructureNS(NAMESPACE_URIS$3,{name:makeObjectPropertySetter(readString),cmt:makeObjectPropertySetter(readString),desc:makeObjectPropertySetter(readString),src:makeObjectPropertySetter(readString),link:parseLink,number:makeObjectPropertySetter(readPositiveInteger),extensions:parseExtensions,type:makeObjectPropertySetter(readString),rtept:parseRtePt}),RTEPT_PARSERS=makeStructureNS(NAMESPACE_URIS$3,{ele:makeObjectPropertySetter(readDecimal),time:makeObjectPropertySetter(readDateTime)}),TRK_PARSERS=makeStructureNS(NAMESPACE_URIS$3,{name:makeObjectPropertySetter(readString),cmt:makeObjectPropertySetter(readString),desc:makeObjectPropertySetter(readString),src:makeObjectPropertySetter(readString),link:parseLink,number:makeObjectPropertySetter(readPositiveInteger),type:makeObjectPropertySetter(readString),extensions:parseExtensions,trkseg:parseTrkSeg}),TRKSEG_PARSERS=makeStructureNS(NAMESPACE_URIS$3,{trkpt:parseTrkPt}),TRKPT_PARSERS=makeStructureNS(NAMESPACE_URIS$3,{ele:makeObjectPropertySetter(readDecimal),time:makeObjectPropertySetter(readDateTime)}),WPT_PARSERS=makeStructureNS(NAMESPACE_URIS$3,{ele:makeObjectPropertySetter(readDecimal),time:makeObjectPropertySetter(readDateTime),magvar:makeObjectPropertySetter(readDecimal),geoidheight:makeObjectPropertySetter(readDecimal),name:makeObjectPropertySetter(readString),cmt:makeObjectPropertySetter(readString),desc:makeObjectPropertySetter(readString),src:makeObjectPropertySetter(readString),link:parseLink,sym:makeObjectPropertySetter(readString),type:makeObjectPropertySetter(readString),fix:makeObjectPropertySetter(readString),sat:makeObjectPropertySetter(readPositiveInteger),hdop:makeObjectPropertySetter(readDecimal),vdop:makeObjectPropertySetter(readDecimal),pdop:makeObjectPropertySetter(readDecimal),ageofdgpsdata:makeObjectPropertySetter(readDecimal),dgpsid:makeObjectPropertySetter(readPositiveInteger),extensions:parseExtensions}),LINK_SEQUENCE=["text","type"],LINK_SERIALIZERS=makeStructureNS(NAMESPACE_URIS$3,{text:makeChildAppender(writeStringTextNode),type:makeChildAppender(writeStringTextNode)}),RTE_SEQUENCE=makeStructureNS(NAMESPACE_URIS$3,["name","cmt","desc","src","link","number","type","rtept"]),RTE_SERIALIZERS=makeStructureNS(NAMESPACE_URIS$3,{name:makeChildAppender(writeStringTextNode),cmt:makeChildAppender(writeStringTextNode),desc:makeChildAppender(writeStringTextNode),src:makeChildAppender(writeStringTextNode),link:makeChildAppender(writeLink),number:makeChildAppender(writeNonNegativeIntegerTextNode),type:makeChildAppender(writeStringTextNode),rtept:makeArraySerializer(makeChildAppender(writeWptType))}),RTEPT_TYPE_SEQUENCE=makeStructureNS(NAMESPACE_URIS$3,["ele","time"]),TRK_SEQUENCE=makeStructureNS(NAMESPACE_URIS$3,["name","cmt","desc","src","link","number","type","trkseg"]),TRK_SERIALIZERS=makeStructureNS(NAMESPACE_URIS$3,{name:makeChildAppender(writeStringTextNode),cmt:makeChildAppender(writeStringTextNode),desc:makeChildAppender(writeStringTextNode),src:makeChildAppender(writeStringTextNode),link:makeChildAppender(writeLink),number:makeChildAppender(writeNonNegativeIntegerTextNode),type:makeChildAppender(writeStringTextNode),trkseg:makeArraySerializer(makeChildAppender(writeTrkSeg))}),TRKSEG_NODE_FACTORY=makeSimpleNodeFactory("trkpt"),TRKSEG_SERIALIZERS=makeStructureNS(NAMESPACE_URIS$3,{trkpt:makeChildAppender(writeWptType)}),WPT_TYPE_SEQUENCE=makeStructureNS(NAMESPACE_URIS$3,["ele","time","magvar","geoidheight","name","cmt","desc","src","link","sym","type","fix","sat","hdop","vdop","pdop","ageofdgpsdata","dgpsid"]),WPT_TYPE_SERIALIZERS=makeStructureNS(NAMESPACE_URIS$3,{ele:makeChildAppender(writeDecimalTextNode),time:makeChildAppender(writeDateTimeTextNode),magvar:makeChildAppender(writeDecimalTextNode),geoidheight:makeChildAppender(writeDecimalTextNode),name:makeChildAppender(writeStringTextNode),cmt:makeChildAppender(writeStringTextNode),desc:makeChildAppender(writeStringTextNode),src:makeChildAppender(writeStringTextNode),link:makeChildAppender(writeLink),sym:makeChildAppender(writeStringTextNode),type:makeChildAppender(writeStringTextNode),fix:makeChildAppender(writeStringTextNode),sat:makeChildAppender(writeNonNegativeIntegerTextNode),hdop:makeChildAppender(writeDecimalTextNode),vdop:makeChildAppender(writeDecimalTextNode),pdop:makeChildAppender(writeDecimalTextNode),ageofdgpsdata:makeChildAppender(writeDecimalTextNode),dgpsid:makeChildAppender(writeNonNegativeIntegerTextNode)}),GEOMETRY_TYPE_TO_NODENAME={Point:"wpt",LineString:"rte",MultiLineString:"trk"};function GPX_NODE_FACTORY(l,t,n){const s=l.getGeometry();if(s){const o=GEOMETRY_TYPE_TO_NODENAME[s.getType()];if(o){const a=t[t.length-1].node;return createElementNS(a.namespaceURI,o)}}}function appendCoordinate(l,t,n,s){return l.push(parseFloat(n.getAttribute("lon")),parseFloat(n.getAttribute("lat"))),"ele"in s?(l.push(s.ele),delete s.ele,t.hasZ=!0):l.push(0),"time"in s?(l.push(s.time),delete s.time,t.hasM=!0):l.push(0),l}function applyLayoutOptions(l,t,n){let s="XY",o=2;if(l.hasZ&&l.hasM?(s="XYZM",o=4):l.hasZ?(s="XYZ",o=3):l.hasM&&(s="XYM",o=3),o!==4){for(let a=0,h=t.length/4;a<h;a++)t[a*o]=t[a*4],t[a*o+1]=t[a*4+1],l.hasZ&&(t[a*o+2]=t[a*4+2]),l.hasM&&(t[a*o+2]=t[a*4+3]);if(t.length=t.length/4*o,n)for(let a=0,h=n.length;a<h;a++)n[a]=n[a]/4*o}return s}function readAuthor(l,t){const n=pushParseAndPop({},AUTHOR_PARSERS,l,t);if(n)return n}function readCopyright(l,t){const n=pushParseAndPop({},COPYRIGHT_PARSERS,l,t);if(n){const s=l.getAttribute("author");return s!==null&&(n.author=s),n}}function parseBounds(l,t){const n=t[t.length-1],s=l.getAttribute("minlat"),o=l.getAttribute("minlon"),a=l.getAttribute("maxlat"),h=l.getAttribute("maxlon");o!==null&&s!==null&&h!==null&&a!==null&&(n.bounds=[[parseFloat(o),parseFloat(s)],[parseFloat(h),parseFloat(a)]])}function parseEmail(l,t){const n=t[t.length-1],s=l.getAttribute("id"),o=l.getAttribute("domain");s!==null&&o!==null&&(n.email=`${s}@${o}`)}function parseLink(l,t){const n=t[t.length-1],s=l.getAttribute("href");s!==null&&(n.link=s),parseNode(LINK_PARSERS,l,t)}function parseExtensions(l,t){const n=t[t.length-1];n.extensionsNode_=l}function parseRtePt(l,t){const n=pushParseAndPop({},RTEPT_PARSERS,l,t);if(n){const s=t[t.length-1],o=s.flatCoordinates,a=s.layoutOptions;appendCoordinate(o,a,l,n)}}function parseTrkPt(l,t){const n=pushParseAndPop({},TRKPT_PARSERS,l,t);if(n){const s=t[t.length-1],o=s.flatCoordinates,a=s.layoutOptions;appendCoordinate(o,a,l,n)}}function parseTrkSeg(l,t){const n=t[t.length-1];parseNode(TRKSEG_PARSERS,l,t);const s=n.flatCoordinates;n.ends.push(s.length)}function readRte(l,t){const n=t[0],s=pushParseAndPop({flatCoordinates:[],layoutOptions:{}},RTE_PARSERS,l,t);if(!s)return;const o=s.flatCoordinates;delete s.flatCoordinates;const a=s.layoutOptions;delete s.layoutOptions;const h=applyLayoutOptions(a,o),c=new LineString(o,h);transformGeometryWithOptions(c,!1,n);const u=new Feature(c);return u.setProperties(s,!0),u}function readTrk(l,t){const n=t[0],s=pushParseAndPop({flatCoordinates:[],ends:[],layoutOptions:{}},TRK_PARSERS,l,t);if(!s)return;const o=s.flatCoordinates;delete s.flatCoordinates;const a=s.ends;delete s.ends;const h=s.layoutOptions;delete s.layoutOptions;const c=applyLayoutOptions(h,o,a),u=new MultiLineString(o,c,a);transformGeometryWithOptions(u,!1,n);const d=new Feature(u);return d.setProperties(s,!0),d}function readWpt(l,t){const n=t[0],s=pushParseAndPop({},WPT_PARSERS,l,t);if(!s)return;const o={},a=appendCoordinate([],o,l,s),h=applyLayoutOptions(o,a),c=new Point(a,h);transformGeometryWithOptions(c,!1,n);const u=new Feature(c);return u.setProperties(s,!0),u}function writeLink(l,t,n){l.setAttribute("href",t);const o=n[n.length-1].properties,a=[o.linkText,o.linkType];pushSerializeAndPop({node:l},LINK_SERIALIZERS,OBJECT_PROPERTY_NODE_FACTORY,a,n,LINK_SEQUENCE)}function writeWptType(l,t,n){const s=n[n.length-1],a=s.node.namespaceURI,h=s.properties;switch(l.setAttributeNS(null,"lat",String(t[1])),l.setAttributeNS(null,"lon",String(t[0])),s.geometryLayout){case"XYZM":t[3]!==0&&(h.time=t[3]);case"XYZ":t[2]!==0&&(h.ele=t[2]);break;case"XYM":t[2]!==0&&(h.time=t[2]);break}const u=l.nodeName=="rtept"?RTEPT_TYPE_SEQUENCE[a]:WPT_TYPE_SEQUENCE[a],d=makeSequence(h,u);pushSerializeAndPop({node:l,properties:h},WPT_TYPE_SERIALIZERS,OBJECT_PROPERTY_NODE_FACTORY,d,n,u)}function writeRte(l,t,n){const s=n[0],o=t.getProperties(),a={node:l};a.properties=o;const h=t.getGeometry();if(h.getType()=="LineString"){const f=transformGeometryWithOptions(h,!0,s);a.geometryLayout=f.getLayout(),o.rtept=f.getCoordinates()}const c=n[n.length-1].node,u=RTE_SEQUENCE[c.namespaceURI],d=makeSequence(o,u);pushSerializeAndPop(a,RTE_SERIALIZERS,OBJECT_PROPERTY_NODE_FACTORY,d,n,u)}function writeTrk(l,t,n){const s=n[0],o=t.getProperties(),a={node:l};a.properties=o;const h=t.getGeometry();if(h.getType()=="MultiLineString"){const f=transformGeometryWithOptions(h,!0,s);o.trkseg=f.getLineStrings()}const c=n[n.length-1].node,u=TRK_SEQUENCE[c.namespaceURI],d=makeSequence(o,u);pushSerializeAndPop(a,TRK_SERIALIZERS,OBJECT_PROPERTY_NODE_FACTORY,d,n,u)}function writeTrkSeg(l,t,n){const s={node:l};s.geometryLayout=t.getLayout(),s.properties={},pushSerializeAndPop(s,TRKSEG_SERIALIZERS,TRKSEG_NODE_FACTORY,t.getCoordinates(),n)}function writeWpt(l,t,n){const s=n[0],o=n[n.length-1];o.properties=t.getProperties();const a=t.getGeometry();if(a.getType()=="Point"){const h=transformGeometryWithOptions(a,!0,s);o.geometryLayout=h.getLayout(),writeWptType(l,h.getCoordinates(),n)}}class TextFeature extends FeatureFormat{constructor(){super()}getType(){return"text"}readFeature(t,n){return this.readFeatureFromText(getText(t),this.adaptOptions(n))}readFeatureFromText(t,n){return abstract()}readFeatures(t,n){return this.readFeaturesFromText(getText(t),this.adaptOptions(n))}readFeaturesFromText(t,n){return abstract()}readGeometry(t,n){return this.readGeometryFromText(getText(t),this.adaptOptions(n))}readGeometryFromText(t,n){return abstract()}readProjection(t){return this.readProjectionFromText(getText(t))}readProjectionFromText(t){return this.dataProjection}writeFeature(t,n){return this.writeFeatureText(t,this.adaptOptions(n))}writeFeatureText(t,n){return abstract()}writeFeatures(t,n){return this.writeFeaturesText(t,this.adaptOptions(n))}writeFeaturesText(t,n){return abstract()}writeGeometry(t,n){return this.writeGeometryText(t,this.adaptOptions(n))}writeGeometryText(t,n){return abstract()}}function getText(l){return typeof l=="string"?l:""}const B_RECORD_RE=/^B(\d{2})(\d{2})(\d{2})(\d{2})(\d{5})([NS])(\d{3})(\d{5})([EW])([AV])(\d{5})(\d{5})/,H_RECORD_RE=/^H.([A-Z]{3}).*?:(.*)/,HFDTE_RECORD_RE=/^HFDTE(\d{2})(\d{2})(\d{2})/,HFDTEDATE_RECORD_RE=/^HFDTEDATE:(\d{2})(\d{2})(\d{2}),(\d{2})/,NEWLINE_RE=/\r\n|\r|\n/;class IGC extends TextFeature{constructor(t){super(),t=t||{},this.dataProjection=get$1("EPSG:4326"),this.altitudeMode_=t.altitudeMode?t.altitudeMode:"none",this.lad_=!1,this.lod_=!1,this.ladStart_=0,this.ladStop_=0,this.lodStart_=0,this.lodStop_=0}readFeatureFromText(t,n){const s=this.altitudeMode_,o=t.split(NEWLINE_RE),a={},h=[];let c=2e3,u=0,d=1,f=-1,g,_;for(g=0,_=o.length;g<_;++g){const y=o[g];let T;if(y.charAt(0)=="B"){if(T=B_RECORD_RE.exec(y),T){const S=parseInt(T[1],10),C=parseInt(T[2],10),P=parseInt(T[3],10);let w=parseInt(T[4],10)+parseInt(T[5],10)/6e4;this.lad_&&(w+=parseInt(y.slice(this.ladStart_,this.ladStop_),10)/6e4/10**(this.ladStop_-this.ladStart_)),T[6]=="S"&&(w=-w);let I=parseInt(T[7],10)+parseInt(T[8],10)/6e4;if(this.lod_&&(I+=parseInt(y.slice(this.lodStart_,this.lodStop_),10)/6e4/10**(this.lodStop_-this.lodStart_)),T[9]=="W"&&(I=-I),h.push(I,w),s!="none"){let N;s=="gps"?N=parseInt(T[11],10):s=="barometric"?N=parseInt(T[12],10):N=0,h.push(N)}let O=Date.UTC(c,u,d,S,C,P);O<f&&(O=Date.UTC(c,u,d+1,S,C,P)),h.push(O/1e3),f=O}}else if(y.charAt(0)=="H")T=HFDTEDATE_RECORD_RE.exec(y),T?(d=parseInt(T[1],10),u=parseInt(T[2],10)-1,c=2e3+parseInt(T[3],10)):(T=HFDTE_RECORD_RE.exec(y),T?(d=parseInt(T[1],10),u=parseInt(T[2],10)-1,c=2e3+parseInt(T[3],10)):(T=H_RECORD_RE.exec(y),T&&(a[T[1]]=T[2].trim())));else if(y.charAt(0)=="I"){const S=parseInt(y.slice(1,3),10);for(let C=0;C<S;C++){const P=y.slice(7+C*7,10+C*7);if(P==="LAD"||P==="LOD"){const w=parseInt(y.slice(3+C*7,5+C*7),10)-1,I=parseInt(y.slice(5+C*7,7+C*7),10);P==="LAD"?(this.lad_=!0,this.ladStart_=w,this.ladStop_=I):P==="LOD"&&(this.lod_=!0,this.lodStart_=w,this.lodStop_=I)}}}}if(h.length===0)return null;const m=s=="none"?"XYM":"XYZM",p=new LineString(h,m),x=new Feature(transformGeometryWithOptions(p,!1,n));return x.setProperties(a,!0),x}readFeaturesFromText(t,n){const s=this.readFeatureFromText(t,n);return s?[s]:[]}}const Versions={VERSION1:"version1",VERSION2:"version2",VERSION3:"version3"},IIIF_PROFILE_VALUES={};IIIF_PROFILE_VALUES[Versions.VERSION1]={level0:{supports:[],formats:[],qualities:["native"]},level1:{supports:["regionByPx","sizeByW","sizeByH","sizeByPct"],formats:["jpg"],qualities:["native"]},level2:{supports:["regionByPx","regionByPct","sizeByW","sizeByH","sizeByPct","sizeByConfinedWh","sizeByWh"],formats:["jpg","png"],qualities:["native","color","grey","bitonal"]}};IIIF_PROFILE_VALUES[Versions.VERSION2]={level0:{supports:[],formats:["jpg"],qualities:["default"]},level1:{supports:["regionByPx","sizeByW","sizeByH","sizeByPct"],formats:["jpg"],qualities:["default"]},level2:{supports:["regionByPx","regionByPct","sizeByW","sizeByH","sizeByPct","sizeByConfinedWh","sizeByDistortedWh","sizeByWh"],formats:["jpg","png"],qualities:["default","bitonal"]}};IIIF_PROFILE_VALUES[Versions.VERSION3]={level0:{supports:[],formats:["jpg"],qualities:["default"]},level1:{supports:["regionByPx","regionSquare","sizeByW","sizeByH","sizeByWh"],formats:["jpg"],qualities:["default"]},level2:{supports:["regionByPx","regionSquare","regionByPct","sizeByW","sizeByH","sizeByPct","sizeByConfinedWh","sizeByWh"],formats:["jpg","png"],qualities:["default"]}};IIIF_PROFILE_VALUES.none={none:{supports:[],formats:[],qualities:[]}};const COMPLIANCE_VERSION1=/^https?:\/\/library\.stanford\.edu\/iiif\/image-api\/(?:1\.1\/)?compliance\.html#level[0-2]$/,COMPLIANCE_VERSION2=/^https?:\/\/iiif\.io\/api\/image\/2\/level[0-2](?:\.json)?$/,COMPLIANCE_VERSION3=/(^https?:\/\/iiif\.io\/api\/image\/3\/level[0-2](?:\.json)?$)|(^level[0-2]$)/;function generateVersion1Options(l){let t=l.getComplianceLevelSupportedFeatures();return t===void 0&&(t=IIIF_PROFILE_VALUES[Versions.VERSION1].level0),{url:l.imageInfo["@id"]===void 0?void 0:l.imageInfo["@id"].replace(/\/?(?:info\.json)?$/g,""),supports:t.supports,formats:[...t.formats,l.imageInfo.formats===void 0?[]:l.imageInfo.formats],qualities:[...t.qualities,l.imageInfo.qualities===void 0?[]:l.imageInfo.qualities],resolutions:l.imageInfo.scale_factors,tileSize:l.imageInfo.tile_width!==void 0?l.imageInfo.tile_height!==void 0?[l.imageInfo.tile_width,l.imageInfo.tile_height]:[l.imageInfo.tile_width,l.imageInfo.tile_width]:l.imageInfo.tile_height!=null?[l.imageInfo.tile_height,l.imageInfo.tile_height]:void 0}}function generateVersion2Options(l){const t=l.getComplianceLevelSupportedFeatures(),n=Array.isArray(l.imageInfo.profile)&&l.imageInfo.profile.length>1,s=n&&l.imageInfo.profile[1].supports?l.imageInfo.profile[1].supports:[],o=n&&l.imageInfo.profile[1].formats?l.imageInfo.profile[1].formats:[],a=n&&l.imageInfo.profile[1].qualities?l.imageInfo.profile[1].qualities:[];return{url:l.imageInfo["@id"].replace(/\/?(?:info\.json)?$/g,""),sizes:l.imageInfo.sizes===void 0?void 0:l.imageInfo.sizes.map(function(h){return[h.width,h.height]}),tileSize:l.imageInfo.tiles===void 0?void 0:[l.imageInfo.tiles.map(function(h){return h.width})[0],l.imageInfo.tiles.map(function(h){return h.height===void 0?h.width:h.height})[0]],resolutions:l.imageInfo.tiles===void 0?void 0:l.imageInfo.tiles.map(function(h){return h.scaleFactors})[0],supports:[...t.supports,...s],formats:[...t.formats,...o],qualities:[...t.qualities,...a]}}function generateVersion3Options(l){const t=l.getComplianceLevelSupportedFeatures(),n=l.imageInfo.extraFormats===void 0?t.formats:[...t.formats,...l.imageInfo.extraFormats],s=l.imageInfo.preferredFormats!==void 0&&Array.isArray(l.imageInfo.preferredFormats)&&l.imageInfo.preferredFormats.length>0?l.imageInfo.preferredFormats.filter(function(o){return["jpg","png","gif"].includes(o)}).reduce(function(o,a){return o===void 0&&n.includes(a)?a:o},void 0):void 0;return{url:l.imageInfo.id,sizes:l.imageInfo.sizes===void 0?void 0:l.imageInfo.sizes.map(function(o){return[o.width,o.height]}),tileSize:l.imageInfo.tiles===void 0?void 0:[l.imageInfo.tiles.map(function(o){return o.width})[0],l.imageInfo.tiles.map(function(o){return o.height})[0]],resolutions:l.imageInfo.tiles===void 0?void 0:l.imageInfo.tiles.map(function(o){return o.scaleFactors})[0],supports:l.imageInfo.extraFeatures===void 0?t.supports:[...t.supports,...l.imageInfo.extraFeatures],formats:n,qualities:l.imageInfo.extraQualities===void 0?t.qualities:[...t.qualities,...l.imageInfo.extraQualities],preferredFormat:s}}const versionFunctions={};versionFunctions[Versions.VERSION1]=generateVersion1Options;versionFunctions[Versions.VERSION2]=generateVersion2Options;versionFunctions[Versions.VERSION3]=generateVersion3Options;class IIIFInfo{constructor(t){this.setImageInfo(t)}setImageInfo(t){typeof t=="string"?this.imageInfo=JSON.parse(t):this.imageInfo=t}getImageApiVersion(){if(this.imageInfo===void 0)return;let t=this.imageInfo["@context"]||"ol-no-context";typeof t=="string"&&(t=[t]);for(let n=0;n<t.length;n++)switch(t[n]){case"http://library.stanford.edu/iiif/image-api/1.1/context.json":case"http://iiif.io/api/image/1/context.json":return Versions.VERSION1;case"http://iiif.io/api/image/2/context.json":return Versions.VERSION2;case"http://iiif.io/api/image/3/context.json":return Versions.VERSION3;case"ol-no-context":if(this.getComplianceLevelEntryFromProfile(Versions.VERSION1)&&this.imageInfo.identifier)return Versions.VERSION1;break}assert(!1,"Cannot determine IIIF Image API version from provided image information JSON")}getComplianceLevelEntryFromProfile(t){if(!(this.imageInfo===void 0||this.imageInfo.profile===void 0))switch(t===void 0&&(t=this.getImageApiVersion()),t){case Versions.VERSION1:if(COMPLIANCE_VERSION1.test(this.imageInfo.profile))return this.imageInfo.profile;break;case Versions.VERSION3:if(COMPLIANCE_VERSION3.test(this.imageInfo.profile))return this.imageInfo.profile;break;case Versions.VERSION2:if(typeof this.imageInfo.profile=="string"&&COMPLIANCE_VERSION2.test(this.imageInfo.profile))return this.imageInfo.profile;if(Array.isArray(this.imageInfo.profile)&&this.imageInfo.profile.length>0&&typeof this.imageInfo.profile[0]=="string"&&COMPLIANCE_VERSION2.test(this.imageInfo.profile[0]))return this.imageInfo.profile[0];break}}getComplianceLevelFromProfile(t){const n=this.getComplianceLevelEntryFromProfile(t);if(n===void 0)return;const s=n.match(/level[0-2](?:\.json)?$/g);return Array.isArray(s)?s[0].replace(".json",""):void 0}getComplianceLevelSupportedFeatures(){if(this.imageInfo===void 0)return;const t=this.getImageApiVersion(),n=this.getComplianceLevelFromProfile(t);return n===void 0?IIIF_PROFILE_VALUES.none.none:IIIF_PROFILE_VALUES[t][n]}getTileSourceOptions(t){const n=t||{},s=this.getImageApiVersion();if(s===void 0)return;const o=s===void 0?void 0:versionFunctions[s](this);if(o!==void 0)return{url:o.url,version:s,size:[this.imageInfo.width,this.imageInfo.height],sizes:o.sizes,format:n.format!==void 0&&o.formats.includes(n.format)?n.format:o.preferredFormat!==void 0?o.preferredFormat:"jpg",supports:o.supports,quality:n.quality&&o.qualities.includes(n.quality)?n.quality:o.qualities.includes("native")?"native":"default",resolutions:Array.isArray(o.resolutions)?o.resolutions.sort(function(a,h){return h-a}):void 0,tileSize:o.tileSize}}}class XML{read(t){if(!t)return null;if(typeof t=="string"){const n=parse(t);return this.readFromDocument(n)}return isDocument(t)?this.readFromDocument(t):this.readFromNode(t)}readFromDocument(t){for(let n=t.firstChild;n;n=n.nextSibling)if(n.nodeType==Node.ELEMENT_NODE)return this.readFromNode(n);return null}readFromNode(t){abstract()}}const NAMESPACE_URI="http://www.w3.org/1999/xlink";function readHref(l){return l.getAttributeNS(NAMESPACE_URI,"href")}const NAMESPACE_URIS$2=[null,"http://www.opengis.net/ows/1.1"],PARSERS$2=makeStructureNS(NAMESPACE_URIS$2,{ServiceIdentification:makeObjectPropertySetter(readServiceIdentification),ServiceProvider:makeObjectPropertySetter(readServiceProvider),OperationsMetadata:makeObjectPropertySetter(readOperationsMetadata)});class OWS extends XML{constructor(){super()}readFromNode(t){const n=pushParseAndPop({},PARSERS$2,t,[]);return n||null}}const ADDRESS_PARSERS=makeStructureNS(NAMESPACE_URIS$2,{DeliveryPoint:makeObjectPropertySetter(readString),City:makeObjectPropertySetter(readString),AdministrativeArea:makeObjectPropertySetter(readString),PostalCode:makeObjectPropertySetter(readString),Country:makeObjectPropertySetter(readString),ElectronicMailAddress:makeObjectPropertySetter(readString)}),ALLOWED_VALUES_PARSERS=makeStructureNS(NAMESPACE_URIS$2,{Value:makeObjectPropertyPusher(readValue)}),CONSTRAINT_PARSERS=makeStructureNS(NAMESPACE_URIS$2,{AllowedValues:makeObjectPropertySetter(readAllowedValues)}),CONTACT_INFO_PARSERS=makeStructureNS(NAMESPACE_URIS$2,{Phone:makeObjectPropertySetter(readPhone),Address:makeObjectPropertySetter(readAddress)}),DCP_PARSERS=makeStructureNS(NAMESPACE_URIS$2,{HTTP:makeObjectPropertySetter(readHttp)}),HTTP_PARSERS$1=makeStructureNS(NAMESPACE_URIS$2,{Get:makeObjectPropertyPusher(readGet),Post:void 0}),OPERATION_PARSERS=makeStructureNS(NAMESPACE_URIS$2,{DCP:makeObjectPropertySetter(readDcp)}),OPERATIONS_METADATA_PARSERS=makeStructureNS(NAMESPACE_URIS$2,{Operation:readOperation}),PHONE_PARSERS=makeStructureNS(NAMESPACE_URIS$2,{Voice:makeObjectPropertySetter(readString),Facsimile:makeObjectPropertySetter(readString)}),REQUEST_METHOD_PARSERS=makeStructureNS(NAMESPACE_URIS$2,{Constraint:makeObjectPropertyPusher(readConstraint)}),SERVICE_CONTACT_PARSERS=makeStructureNS(NAMESPACE_URIS$2,{IndividualName:makeObjectPropertySetter(readString),PositionName:makeObjectPropertySetter(readString),ContactInfo:makeObjectPropertySetter(readContactInfo)}),SERVICE_IDENTIFICATION_PARSERS=makeStructureNS(NAMESPACE_URIS$2,{Abstract:makeObjectPropertySetter(readString),AccessConstraints:makeObjectPropertySetter(readString),Fees:makeObjectPropertySetter(readString),Title:makeObjectPropertySetter(readString),ServiceTypeVersion:makeObjectPropertySetter(readString),ServiceType:makeObjectPropertySetter(readString)}),SERVICE_PROVIDER_PARSERS=makeStructureNS(NAMESPACE_URIS$2,{ProviderName:makeObjectPropertySetter(readString),ProviderSite:makeObjectPropertySetter(readHref),ServiceContact:makeObjectPropertySetter(readServiceContact)});function readAddress(l,t){return pushParseAndPop({},ADDRESS_PARSERS,l,t)}function readAllowedValues(l,t){return pushParseAndPop({},ALLOWED_VALUES_PARSERS,l,t)}function readConstraint(l,t){const n=l.getAttribute("name");if(n)return pushParseAndPop({name:n},CONSTRAINT_PARSERS,l,t)}function readContactInfo(l,t){return pushParseAndPop({},CONTACT_INFO_PARSERS,l,t)}function readDcp(l,t){return pushParseAndPop({},DCP_PARSERS,l,t)}function readGet(l,t){const n=readHref(l);if(n)return pushParseAndPop({href:n},REQUEST_METHOD_PARSERS,l,t)}function readHttp(l,t){return pushParseAndPop({},HTTP_PARSERS$1,l,t)}function readOperation(l,t){const n=l.getAttribute("name"),s=pushParseAndPop({},OPERATION_PARSERS,l,t);if(!s)return;const o=t[t.length-1];o[n]=s}function readOperationsMetadata(l,t){return pushParseAndPop({},OPERATIONS_METADATA_PARSERS,l,t)}function readPhone(l,t){return pushParseAndPop({},PHONE_PARSERS,l,t)}function readServiceIdentification(l,t){return pushParseAndPop({},SERVICE_IDENTIFICATION_PARSERS,l,t)}function readServiceContact(l,t){return pushParseAndPop({},SERVICE_CONTACT_PARSERS,l,t)}function readServiceProvider(l,t){return pushParseAndPop({},SERVICE_PROVIDER_PARSERS,l,t)}function readValue(l,t){return readString(l)}function flipXY(l,t,n,s,o,a){o!==void 0?(o=o,a=a!==void 0?a:0):(o=[],a=0);let h=t;for(;h<n;){const c=l[h++];o[a++]=l[h++],o[a++]=c;for(let u=2;u<s;++u)o[a++]=l[h++]}return o.length=a,o}class Polyline extends TextFeature{constructor(t){super(),t=t||{},this.dataProjection=get$1("EPSG:4326"),this.factor_=t.factor?t.factor:1e5,this.geometryLayout_=t.geometryLayout?t.geometryLayout:"XY"}readFeatureFromText(t,n){const s=this.readGeometryFromText(t,n);return new Feature(s)}readFeaturesFromText(t,n){return[this.readFeatureFromText(t,n)]}readGeometryFromText(t,n){const s=getStrideForLayout(this.geometryLayout_),o=decodeDeltas(t,s,this.factor_);flipXY(o,0,o.length,s,o);const a=new LineString(o,this.geometryLayout_);return transformGeometryWithOptions(a,!1,this.adaptOptions(n))}writeFeatureText(t,n){const s=t.getGeometry();if(s)return this.writeGeometryText(s,n);throw new Error("Expected `feature` to have a geometry")}writeFeaturesText(t,n){return this.writeFeatureText(t[0],n)}writeGeometryText(t,n){t=transformGeometryWithOptions(t,!0,this.adaptOptions(n));const s=t.getFlatCoordinates(),o=t.getStride();return flipXY(s,0,s.length,o,s),encodeDeltas(s,o,this.factor_)}}function encodeDeltas(l,t,n){n=n||1e5;const s=new Array(t).fill(0);for(let o=0,a=l.length;o<a;)for(let h=0;h<t;++h,++o){const c=l[o]*n,u=c<0?Math.ceil(c-.5):Math.round(c),d=u-s[h];s[h]=u,l[o]=d}return encodeSignedIntegers(l)}function decodeDeltas(l,t,n){n=n||1e5;const s=new Array(t).fill(0),o=decodeSignedIntegers(l);for(let a=0,h=o.length;a<h;)for(let c=0;c<t;++c,++a)s[c]+=o[a],o[a]=s[c]/n;return o}function encodeSignedIntegers(l){for(let t=0,n=l.length;t<n;++t){const s=l[t];l[t]=s<0?~(s<<1):s<<1}return encodeUnsignedIntegers(l)}function decodeSignedIntegers(l){const t=decodeUnsignedIntegers(l);for(let n=0,s=t.length;n<s;++n){const o=t[n];t[n]=o&1?~(o>>1):o>>1}return t}function encodeUnsignedIntegers(l){let t="";for(let n=0,s=l.length;n<s;++n)t+=encodeUnsignedInteger(l[n]);return t}function decodeUnsignedIntegers(l){const t=[];let n=0,s=0;for(let o=0,a=l.length;o<a;++o){const h=l.charCodeAt(o)-63;n|=(h&31)<<s,h<32?(t.push(n),n=0,s=0):s+=5}return t}function encodeUnsignedInteger(l){let t,n="";for(;l>=32;)t=(32|l&31)+63,n+=String.fromCharCode(t),l>>=5;return t=l+63,n+=String.fromCharCode(t),n}class GML32 extends GML3{constructor(t){t=t||{},super(t),this.schemaLocation=t.schemaLocation?t.schemaLocation:this.namespace+" http://schemas.opengis.net/gml/3.2.1/gml.xsd"}writeGeometryElement(t,n,s){const o=s[s.length-1];s[s.length-1]=Object.assign({multiCurve:!0,multiSurface:!0},o),super.writeGeometryElement(t,n,s)}}GML32.prototype.namespace="http://www.opengis.net/gml/3.2";GML32.prototype.GEOMETRY_FLAT_COORDINATES_PARSERS={"http://www.opengis.net/gml/3.2":{pos:makeReplacer(GML3.prototype.readFlatPos),posList:makeReplacer(GML3.prototype.readFlatPosList),coordinates:makeReplacer(GML2.prototype.readFlatCoordinates)}};GML32.prototype.FLAT_LINEAR_RINGS_PARSERS={"http://www.opengis.net/gml/3.2":{interior:GML3.prototype.interiorParser,exterior:GML3.prototype.exteriorParser}};GML32.prototype.GEOMETRY_PARSERS={"http://www.opengis.net/gml/3.2":{Point:makeReplacer(GMLBase.prototype.readPoint),MultiPoint:makeReplacer(GMLBase.prototype.readMultiPoint),LineString:makeReplacer(GMLBase.prototype.readLineString),MultiLineString:makeReplacer(GMLBase.prototype.readMultiLineString),LinearRing:makeReplacer(GMLBase.prototype.readLinearRing),Polygon:makeReplacer(GMLBase.prototype.readPolygon),MultiPolygon:makeReplacer(GMLBase.prototype.readMultiPolygon),Surface:makeReplacer(GML32.prototype.readSurface),MultiSurface:makeReplacer(GML3.prototype.readMultiSurface),Curve:makeReplacer(GML32.prototype.readCurve),MultiCurve:makeReplacer(GML3.prototype.readMultiCurve),Envelope:makeReplacer(GML32.prototype.readEnvelope)}};GML32.prototype.MULTICURVE_PARSERS={"http://www.opengis.net/gml/3.2":{curveMember:makeArrayPusher(GML3.prototype.curveMemberParser),curveMembers:makeArrayPusher(GML3.prototype.curveMemberParser)}};GML32.prototype.MULTISURFACE_PARSERS={"http://www.opengis.net/gml/3.2":{surfaceMember:makeArrayPusher(GML3.prototype.surfaceMemberParser),surfaceMembers:makeArrayPusher(GML3.prototype.surfaceMemberParser)}};GML32.prototype.CURVEMEMBER_PARSERS={"http://www.opengis.net/gml/3.2":{LineString:makeArrayPusher(GMLBase.prototype.readLineString),Curve:makeArrayPusher(GML3.prototype.readCurve)}};GML32.prototype.SURFACEMEMBER_PARSERS={"http://www.opengis.net/gml/3.2":{Polygon:makeArrayPusher(GMLBase.prototype.readPolygon),Surface:makeArrayPusher(GML3.prototype.readSurface)}};GML32.prototype.SURFACE_PARSERS={"http://www.opengis.net/gml/3.2":{patches:makeReplacer(GML3.prototype.readPatch)}};GML32.prototype.CURVE_PARSERS={"http://www.opengis.net/gml/3.2":{segments:makeReplacer(GML3.prototype.readSegment)}};GML32.prototype.ENVELOPE_PARSERS={"http://www.opengis.net/gml/3.2":{lowerCorner:makeArrayPusher(GML3.prototype.readFlatPosList),upperCorner:makeArrayPusher(GML3.prototype.readFlatPosList)}};GML32.prototype.PATCHES_PARSERS={"http://www.opengis.net/gml/3.2":{PolygonPatch:makeReplacer(GML3.prototype.readPolygonPatch)}};GML32.prototype.SEGMENTS_PARSERS={"http://www.opengis.net/gml/3.2":{LineStringSegment:makeArrayExtender(GML3.prototype.readLineStringSegment)}};GML32.prototype.MULTIPOINT_PARSERS={"http://www.opengis.net/gml/3.2":{pointMember:makeArrayPusher(GMLBase.prototype.pointMemberParser),pointMembers:makeArrayPusher(GMLBase.prototype.pointMemberParser)}};GML32.prototype.MULTILINESTRING_PARSERS={"http://www.opengis.net/gml/3.2":{lineStringMember:makeArrayPusher(GMLBase.prototype.lineStringMemberParser),lineStringMembers:makeArrayPusher(GMLBase.prototype.lineStringMemberParser)}};GML32.prototype.MULTIPOLYGON_PARSERS={"http://www.opengis.net/gml/3.2":{polygonMember:makeArrayPusher(GMLBase.prototype.polygonMemberParser),polygonMembers:makeArrayPusher(GMLBase.prototype.polygonMemberParser)}};GML32.prototype.POINTMEMBER_PARSERS={"http://www.opengis.net/gml/3.2":{Point:makeArrayPusher(GMLBase.prototype.readFlatCoordinatesFromNode)}};GML32.prototype.LINESTRINGMEMBER_PARSERS={"http://www.opengis.net/gml/3.2":{LineString:makeArrayPusher(GMLBase.prototype.readLineString)}};GML32.prototype.POLYGONMEMBER_PARSERS={"http://www.opengis.net/gml/3.2":{Polygon:makeArrayPusher(GMLBase.prototype.readPolygon)}};GML32.prototype.RING_PARSERS={"http://www.opengis.net/gml/3.2":{LinearRing:makeReplacer(GMLBase.prototype.readFlatLinearRing),Ring:makeReplacer(GML32.prototype.readFlatCurveRing)}};GML32.prototype.RING_SERIALIZERS={"http://www.opengis.net/gml/3.2":{exterior:makeChildAppender(GML3.prototype.writeRing),interior:makeChildAppender(GML3.prototype.writeRing)}};GML32.prototype.ENVELOPE_SERIALIZERS={"http://www.opengis.net/gml/3.2":{lowerCorner:makeChildAppender(writeStringTextNode),upperCorner:makeChildAppender(writeStringTextNode)}};GML32.prototype.SURFACEORPOLYGONMEMBER_SERIALIZERS={"http://www.opengis.net/gml/3.2":{surfaceMember:makeChildAppender(GML3.prototype.writeSurfaceOrPolygonMember),polygonMember:makeChildAppender(GML3.prototype.writeSurfaceOrPolygonMember)}};GML32.prototype.POINTMEMBER_SERIALIZERS={"http://www.opengis.net/gml/3.2":{pointMember:makeChildAppender(GML3.prototype.writePointMember)}};GML32.prototype.LINESTRINGORCURVEMEMBER_SERIALIZERS={"http://www.opengis.net/gml/3.2":{lineStringMember:makeChildAppender(GML3.prototype.writeLineStringOrCurveMember),curveMember:makeChildAppender(GML3.prototype.writeLineStringOrCurveMember)}};GML32.prototype.GEOMETRY_SERIALIZERS={"http://www.opengis.net/gml/3.2":{Curve:makeChildAppender(GML3.prototype.writeCurveOrLineString),MultiCurve:makeChildAppender(GML3.prototype.writeMultiCurveOrLineString),Point:makeChildAppender(GML32.prototype.writePoint),MultiPoint:makeChildAppender(GML3.prototype.writeMultiPoint),LineString:makeChildAppender(GML3.prototype.writeCurveOrLineString),MultiLineString:makeChildAppender(GML3.prototype.writeMultiCurveOrLineString),LinearRing:makeChildAppender(GML3.prototype.writeLinearRing),Polygon:makeChildAppender(GML3.prototype.writeSurfaceOrPolygon),MultiPolygon:makeChildAppender(GML3.prototype.writeMultiSurfaceOrPolygon),Surface:makeChildAppender(GML3.prototype.writeSurfaceOrPolygon),MultiSurface:makeChildAppender(GML3.prototype.writeMultiSurfaceOrPolygon),Envelope:makeChildAppender(GML3.prototype.writeEnvelope)}};class Filter{constructor(t){this.tagName_=t}getTagName(){return this.tagName_}}class LogicalNary extends Filter{constructor(t,n){super(t),this.conditions=n,assert(this.conditions.length>=2,"At least 2 conditions are required")}}class And extends LogicalNary{constructor(t){super("And",Array.prototype.slice.call(arguments))}}class Bbox extends Filter{constructor(t,n,s){if(super("BBOX"),this.geometryName=t,this.extent=n,n.length!==4)throw new Error("Expected an extent with four values ([minX, minY, maxX, maxY])");this.srsName=s}}function and(l){const t=[null].concat(Array.prototype.slice.call(arguments));return new(Function.prototype.bind.apply(And,t))}function bbox(l,t,n){return new Bbox(l,t,n)}const FEATURE_COLLECTION_PARSERS={"http://www.opengis.net/gml":{boundedBy:makeObjectPropertySetter(GMLBase.prototype.readExtentElement,"bounds")},"http://www.opengis.net/wfs/2.0":{member:makeArrayPusher(GMLBase.prototype.readFeaturesInternal)}},TRANSACTION_SUMMARY_PARSERS={"http://www.opengis.net/wfs":{totalInserted:makeObjectPropertySetter(readPositiveInteger),totalUpdated:makeObjectPropertySetter(readPositiveInteger),totalDeleted:makeObjectPropertySetter(readPositiveInteger)},"http://www.opengis.net/wfs/2.0":{totalInserted:makeObjectPropertySetter(readPositiveInteger),totalUpdated:makeObjectPropertySetter(readPositiveInteger),totalDeleted:makeObjectPropertySetter(readPositiveInteger)}},TRANSACTION_RESPONSE_PARSERS={"http://www.opengis.net/wfs":{TransactionSummary:makeObjectPropertySetter(readTransactionSummary,"transactionSummary"),InsertResults:makeObjectPropertySetter(readInsertResults,"insertIds")},"http://www.opengis.net/wfs/2.0":{TransactionSummary:makeObjectPropertySetter(readTransactionSummary,"transactionSummary"),InsertResults:makeObjectPropertySetter(readInsertResults,"insertIds")}},QUERY_SERIALIZERS={"http://www.opengis.net/wfs":{PropertyName:makeChildAppender(writeStringTextNode)},"http://www.opengis.net/wfs/2.0":{PropertyName:makeChildAppender(writeStringTextNode)}},TRANSACTION_SERIALIZERS={"http://www.opengis.net/wfs":{Insert:makeChildAppender(writeFeature),Update:makeChildAppender(writeUpdate),Delete:makeChildAppender(writeDelete),Property:makeChildAppender(writeProperty),Native:makeChildAppender(writeNative)},"http://www.opengis.net/wfs/2.0":{Insert:makeChildAppender(writeFeature),Update:makeChildAppender(writeUpdate),Delete:makeChildAppender(writeDelete),Property:makeChildAppender(writeProperty),Native:makeChildAppender(writeNative)}},FEATURE_PREFIX="feature",XMLNS="http://www.w3.org/2000/xmlns/",OGCNS={"2.0.0":"http://www.opengis.net/ogc/1.1","1.1.0":"http://www.opengis.net/ogc","1.0.0":"http://www.opengis.net/ogc"},WFSNS={"2.0.0":"http://www.opengis.net/wfs/2.0","1.1.0":"http://www.opengis.net/wfs","1.0.0":"http://www.opengis.net/wfs"},FESNS={"2.0.0":"http://www.opengis.net/fes/2.0","1.1.0":"http://www.opengis.net/fes","1.0.0":"http://www.opengis.net/fes"},SCHEMA_LOCATIONS={"2.0.0":"http://www.opengis.net/wfs/2.0 http://schemas.opengis.net/wfs/2.0/wfs.xsd","1.1.0":"http://www.opengis.net/wfs http://schemas.opengis.net/wfs/1.1.0/wfs.xsd","1.0.0":"http://www.opengis.net/wfs http://schemas.opengis.net/wfs/1.0.0/wfs.xsd"},GML_FORMATS={"2.0.0":GML32,"1.1.0":GML3,"1.0.0":GML2},DEFAULT_VERSION="1.1.0";class WFS extends XMLFeature{constructor(t){super(),t=t||{},this.version_=t.version?t.version:DEFAULT_VERSION,this.featureType_=t.featureType,this.featureNS_=t.featureNS,this.gmlFormat_=t.gmlFormat?t.gmlFormat:new GML_FORMATS[this.version_],this.schemaLocation_=t.schemaLocation?t.schemaLocation:SCHEMA_LOCATIONS[this.version_]}getFeatureType(){return this.featureType_}setFeatureType(t){this.featureType_=t}readFeaturesFromNode(t,n){const s={node:t};Object.assign(s,{featureType:this.featureType_,featureNS:this.featureNS_}),Object.assign(s,this.getReadOptions(t,n||{}));const o=[s];let a;this.version_==="2.0.0"?a=FEATURE_COLLECTION_PARSERS:a=this.gmlFormat_.FEATURE_COLLECTION_PARSERS;let h=pushParseAndPop([],a,t,o,this.gmlFormat_);return h||(h=[]),h}readTransactionResponse(t){if(t){if(typeof t=="string"){const n=parse(t);return this.readTransactionResponseFromDocument(n)}return isDocument(t)?this.readTransactionResponseFromDocument(t):this.readTransactionResponseFromNode(t)}}readFeatureCollectionMetadata(t){if(t){if(typeof t=="string"){const n=parse(t);return this.readFeatureCollectionMetadataFromDocument(n)}return isDocument(t)?this.readFeatureCollectionMetadataFromDocument(t):this.readFeatureCollectionMetadataFromNode(t)}}readFeatureCollectionMetadataFromDocument(t){for(let n=t.firstChild;n;n=n.nextSibling)if(n.nodeType==Node.ELEMENT_NODE)return this.readFeatureCollectionMetadataFromNode(n)}readFeatureCollectionMetadataFromNode(t){const n={},s=readNonNegativeIntegerString(t.getAttribute("numberOfFeatures"));return n.numberOfFeatures=s,pushParseAndPop(n,FEATURE_COLLECTION_PARSERS,t,[],this.gmlFormat_)}readTransactionResponseFromDocument(t){for(let n=t.firstChild;n;n=n.nextSibling)if(n.nodeType==Node.ELEMENT_NODE)return this.readTransactionResponseFromNode(n)}readTransactionResponseFromNode(t){return pushParseAndPop({},TRANSACTION_RESPONSE_PARSERS,t,[])}writeGetFeature(t){const n=createElementNS(WFSNS[this.version_],"GetFeature");n.setAttribute("service","WFS"),n.setAttribute("version",this.version_),t.handle&&n.setAttribute("handle",t.handle),t.outputFormat&&n.setAttribute("outputFormat",t.outputFormat),t.maxFeatures!==void 0&&n.setAttribute("maxFeatures",String(t.maxFeatures)),t.resultType&&n.setAttribute("resultType",t.resultType),t.startIndex!==void 0&&n.setAttribute("startIndex",String(t.startIndex)),t.count!==void 0&&n.setAttribute("count",String(t.count)),t.viewParams!==void 0&&n.setAttribute("viewParams",t.viewParams),n.setAttributeNS(XML_SCHEMA_INSTANCE_URI,"xsi:schemaLocation",this.schemaLocation_);const s={node:n};if(Object.assign(s,{version:this.version_,srsName:t.srsName,featureNS:t.featureNS?t.featureNS:this.featureNS_,featurePrefix:t.featurePrefix,propertyNames:t.propertyNames?t.propertyNames:[]}),assert(Array.isArray(t.featureTypes),"`options.featureTypes` must be an Array"),typeof t.featureTypes[0]=="string"){let o=t.filter;t.bbox&&(assert(t.geometryName,"`options.geometryName` must also be provided when `options.bbox` is set"),o=this.combineBboxAndFilter(t.geometryName,t.bbox,t.srsName,o)),Object.assign(s,{geometryName:t.geometryName,filter:o}),writeGetFeature(n,t.featureTypes,[s])}else t.featureTypes.forEach(o=>{const a=this.combineBboxAndFilter(o.geometryName,o.bbox,t.srsName,t.filter);Object.assign(s,{geometryName:o.geometryName,filter:a}),writeGetFeature(n,[o.name],[s])});return n}combineBboxAndFilter(t,n,s,o){const a=bbox(t,n,s);return o?and(o,a):a}writeTransaction(t,n,s,o){const a=[],h=o.version?o.version:this.version_,c=createElementNS(WFSNS[h],"Transaction");c.setAttribute("service","WFS"),c.setAttribute("version",h);let u;o&&(u=o.gmlOptions?o.gmlOptions:{},o.handle&&c.setAttribute("handle",o.handle)),c.setAttributeNS(XML_SCHEMA_INSTANCE_URI,"xsi:schemaLocation",SCHEMA_LOCATIONS[h]);const d=createTransactionRequest(c,u,h,o);return t&&serializeTransactionRequest("Insert",t,a,d),n&&serializeTransactionRequest("Update",n,a,d),s&&serializeTransactionRequest("Delete",s,a,d),o.nativeElements&&serializeTransactionRequest("Native",o.nativeElements,a,d),c}readProjectionFromDocument(t){for(let n=t.firstChild;n;n=n.nextSibling)if(n.nodeType==Node.ELEMENT_NODE)return this.readProjectionFromNode(n);return null}readProjectionFromNode(t){if(t.firstElementChild&&t.firstElementChild.firstElementChild){t=t.firstElementChild.firstElementChild;for(let n=t.firstElementChild;n;n=n.nextElementSibling)if(!(n.childNodes.length===0||n.childNodes.length===1&&n.firstChild.nodeType===3)){const s=[{}];return this.gmlFormat_.readGeometryElement(n,s),get$1(s.pop().srsName)}}return null}}function createTransactionRequest(l,t,n,s){const o=s.featurePrefix?s.featurePrefix:FEATURE_PREFIX;let a;return n==="1.0.0"?a=2:n==="1.1.0"?a=3:n==="2.0.0"&&(a=3.2),Object.assign({node:l},{version:n,featureNS:s.featureNS,featureType:s.featureType,featurePrefix:o,gmlVersion:a,hasZ:s.hasZ,srsName:s.srsName},t)}function serializeTransactionRequest(l,t,n,s){pushSerializeAndPop(s,TRANSACTION_SERIALIZERS,makeSimpleNodeFactory(l),t,n)}function readTransactionSummary(l,t){return pushParseAndPop({},TRANSACTION_SUMMARY_PARSERS,l,t)}const OGC_FID_PARSERS={"http://www.opengis.net/ogc":{FeatureId:makeArrayPusher(function(l,t){return l.getAttribute("fid")})},"http://www.opengis.net/ogc/1.1":{FeatureId:makeArrayPusher(function(l,t){return l.getAttribute("fid")})}};function fidParser(l,t){parseNode(OGC_FID_PARSERS,l,t)}const INSERT_RESULTS_PARSERS={"http://www.opengis.net/wfs":{Feature:fidParser},"http://www.opengis.net/wfs/2.0":{Feature:fidParser}};function readInsertResults(l,t){return pushParseAndPop([],INSERT_RESULTS_PARSERS,l,t)}function writeFeature(l,t,n){const s=n[n.length-1],o=s.featureType,a=s.featureNS,h=s.gmlVersion,c=createElementNS(a,o);l.appendChild(c),h===2?GML2.prototype.writeFeatureElement(c,t,n):h===3?GML3.prototype.writeFeatureElement(c,t,n):GML32.prototype.writeFeatureElement(c,t,n)}function writeOgcFidFilter(l,t,n){const o=n[n.length-1].version,a=OGCNS[o],h=createElementNS(a,"Filter"),c=createElementNS(a,"FeatureId");h.appendChild(c),c.setAttribute("fid",t),l.appendChild(h)}function getTypeName(l,t){l=l||FEATURE_PREFIX;const n=l+":";return t.startsWith(n)?t:n+t}function writeDelete(l,t,n){const s=n[n.length-1];assert(t.getId()!==void 0,"Features must have an id set");const o=s.featureType,a=s.featurePrefix,h=s.featureNS,c=getTypeName(a,o);l.setAttribute("typeName",c),l.setAttributeNS(XMLNS,"xmlns:"+a,h);const u=t.getId();u!==void 0&&writeOgcFidFilter(l,u,n)}function writeUpdate(l,t,n){const s=n[n.length-1];assert(t.getId()!==void 0,"Features must have an id set");const o=s.version,a=s.featureType,h=s.featurePrefix,c=s.featureNS,u=getTypeName(h,a),d=t.getGeometryName();l.setAttribute("typeName",u),l.setAttributeNS(XMLNS,"xmlns:"+h,c);const f=t.getId();if(f!==void 0){const g=t.getKeys(),_=[];for(let m=0,p=g.length;m<p;m++){const x=t.get(g[m]);if(x!==void 0){let y=g[m];x&&typeof x.getSimplifiedGeometry=="function"&&(y=d),_.push({name:y,value:x})}}pushSerializeAndPop({version:o,gmlVersion:s.gmlVersion,node:l,hasZ:s.hasZ,srsName:s.srsName},TRANSACTION_SERIALIZERS,makeSimpleNodeFactory("Property"),_,n),writeOgcFidFilter(l,f,n)}}function writeProperty(l,t,n){const s=n[n.length-1],o=s.version,a=WFSNS[o],c=createElementNS(a,o==="2.0.0"?"ValueReference":"Name"),u=s.gmlVersion;if(l.appendChild(c),writeStringTextNode(c,t.name),t.value!==void 0&&t.value!==null){const d=createElementNS(a,"Value");l.appendChild(d),t.value&&typeof t.value.getSimplifiedGeometry=="function"?u===2?GML2.prototype.writeGeometryElement(d,t.value,n):u===3?GML3.prototype.writeGeometryElement(d,t.value,n):GML32.prototype.writeGeometryElement(d,t.value,n):writeStringTextNode(d,t.value)}}function writeNative(l,t,n){t.vendorId&&l.setAttribute("vendorId",t.vendorId),t.safeToIgnore!==void 0&&l.setAttribute("safeToIgnore",String(t.safeToIgnore)),t.value!==void 0&&writeStringTextNode(l,t.value)}const GETFEATURE_SERIALIZERS={"http://www.opengis.net/wfs":{Query:makeChildAppender(writeQuery)},"http://www.opengis.net/wfs/2.0":{Query:makeChildAppender(writeQuery)},"http://www.opengis.net/ogc":{During:makeChildAppender(writeDuringFilter),And:makeChildAppender(writeLogicalFilter),Or:makeChildAppender(writeLogicalFilter),Not:makeChildAppender(writeNotFilter),BBOX:makeChildAppender(writeBboxFilter),Contains:makeChildAppender(writeSpatialFilter),Intersects:makeChildAppender(writeSpatialFilter),Within:makeChildAppender(writeSpatialFilter),DWithin:makeChildAppender(writeDWithinFilter),PropertyIsEqualTo:makeChildAppender(writeComparisonFilter),PropertyIsNotEqualTo:makeChildAppender(writeComparisonFilter),PropertyIsLessThan:makeChildAppender(writeComparisonFilter),PropertyIsLessThanOrEqualTo:makeChildAppender(writeComparisonFilter),PropertyIsGreaterThan:makeChildAppender(writeComparisonFilter),PropertyIsGreaterThanOrEqualTo:makeChildAppender(writeComparisonFilter),PropertyIsNull:makeChildAppender(writeIsNullFilter),PropertyIsBetween:makeChildAppender(writeIsBetweenFilter),PropertyIsLike:makeChildAppender(writeIsLikeFilter)},"http://www.opengis.net/fes/2.0":{During:makeChildAppender(writeDuringFilter),And:makeChildAppender(writeLogicalFilter),Or:makeChildAppender(writeLogicalFilter),Not:makeChildAppender(writeNotFilter),BBOX:makeChildAppender(writeBboxFilter),Contains:makeChildAppender(writeSpatialFilter),Disjoint:makeChildAppender(writeSpatialFilter),Intersects:makeChildAppender(writeSpatialFilter),ResourceId:makeChildAppender(writeResourceIdFilter),Within:makeChildAppender(writeSpatialFilter),DWithin:makeChildAppender(writeDWithinFilter),PropertyIsEqualTo:makeChildAppender(writeComparisonFilter),PropertyIsNotEqualTo:makeChildAppender(writeComparisonFilter),PropertyIsLessThan:makeChildAppender(writeComparisonFilter),PropertyIsLessThanOrEqualTo:makeChildAppender(writeComparisonFilter),PropertyIsGreaterThan:makeChildAppender(writeComparisonFilter),PropertyIsGreaterThanOrEqualTo:makeChildAppender(writeComparisonFilter),PropertyIsNull:makeChildAppender(writeIsNullFilter),PropertyIsBetween:makeChildAppender(writeIsBetweenFilter),PropertyIsLike:makeChildAppender(writeIsLikeFilter)}};function writeQuery(l,t,n){const s=n[n.length-1],o=s.version,a=s.featurePrefix,h=s.featureNS,c=s.propertyNames,u=s.srsName;let d;a?d=getTypeName(a,t):d=t;let f;o==="2.0.0"?f="typeNames":f="typeName",l.setAttribute(f,d),u&&l.setAttribute("srsName",u),h&&l.setAttributeNS(XMLNS,"xmlns:"+a,h);const g=Object.assign({},s);g.node=l,pushSerializeAndPop(g,QUERY_SERIALIZERS,makeSimpleNodeFactory("PropertyName"),c,n);const _=s.filter;if(_){const m=createElementNS(getFilterNS(o),"Filter");l.appendChild(m),writeFilterCondition(m,_,n)}}function writeFilterCondition(l,t,n){const s=n[n.length-1],o={node:l};Object.assign(o,{context:s}),pushSerializeAndPop(o,GETFEATURE_SERIALIZERS,makeSimpleNodeFactory(t.getTagName()),[t],n)}function writeBboxFilter(l,t,n){const s=n[n.length-1],a=s.context.version;s.srsName=t.srsName;const h=GML_FORMATS[a];writePropertyName(a,l,t.geometryName),h.prototype.writeGeometryElement(l,t.extent,n)}function writeResourceIdFilter(l,t,n){l.setAttribute("rid",t.rid)}function writeSpatialFilter(l,t,n){const s=n[n.length-1],a=s.context.version;s.srsName=t.srsName;const h=GML_FORMATS[a];writePropertyName(a,l,t.geometryName),h.prototype.writeGeometryElement(l,t.geometry,n)}function writeDWithinFilter(l,t,n){const a=n[n.length-1].context.version;writeSpatialFilter(l,t,n);const h=createElementNS(getFilterNS(a),"Distance");writeStringTextNode(h,t.distance.toString()),a==="2.0.0"?h.setAttribute("uom",t.unit):h.setAttribute("units",t.unit),l.appendChild(h)}function writeDuringFilter(l,t,n){const a=n[n.length-1].context.version;writeExpression(FESNS[a],"ValueReference",l,t.propertyName);const h=createElementNS(GMLNS,"TimePeriod");l.appendChild(h);const c=createElementNS(GMLNS,"begin");h.appendChild(c),writeTimeInstant(c,t.begin);const u=createElementNS(GMLNS,"end");h.appendChild(u),writeTimeInstant(u,t.end)}function writeLogicalFilter(l,t,n){const o=n[n.length-1].context,a={node:l};Object.assign(a,{context:o});const h=t.conditions;for(let c=0,u=h.length;c<u;++c){const d=h[c];pushSerializeAndPop(a,GETFEATURE_SERIALIZERS,makeSimpleNodeFactory(d.getTagName()),[d],n)}}function writeNotFilter(l,t,n){const o=n[n.length-1].context,a={node:l};Object.assign(a,{context:o});const h=t.condition;pushSerializeAndPop(a,GETFEATURE_SERIALIZERS,makeSimpleNodeFactory(h.getTagName()),[h],n)}function writeComparisonFilter(l,t,n){const a=n[n.length-1].context.version;t.matchCase!==void 0&&l.setAttribute("matchCase",t.matchCase.toString()),writePropertyName(a,l,t.propertyName),writeLiteral(a,l,""+t.expression)}function writeIsNullFilter(l,t,n){const a=n[n.length-1].context.version;writePropertyName(a,l,t.propertyName)}function writeIsBetweenFilter(l,t,n){const a=n[n.length-1].context.version,h=getFilterNS(a);writePropertyName(a,l,t.propertyName);const c=createElementNS(h,"LowerBoundary");l.appendChild(c),writeLiteral(a,c,""+t.lowerBoundary);const u=createElementNS(h,"UpperBoundary");l.appendChild(u),writeLiteral(a,u,""+t.upperBoundary)}function writeIsLikeFilter(l,t,n){const a=n[n.length-1].context.version;l.setAttribute("wildCard",t.wildCard),l.setAttribute("singleChar",t.singleChar),l.setAttribute("escapeChar",t.escapeChar),t.matchCase!==void 0&&l.setAttribute("matchCase",t.matchCase.toString()),writePropertyName(a,l,t.propertyName),writeLiteral(a,l,""+t.pattern)}function writeExpression(l,t,n,s){const o=createElementNS(l,t);writeStringTextNode(o,s),n.appendChild(o)}function writeLiteral(l,t,n){writeExpression(getFilterNS(l),"Literal",t,n)}function writePropertyName(l,t,n){l==="2.0.0"?writeExpression(FESNS[l],"ValueReference",t,n):writeExpression(OGCNS[l],"PropertyName",t,n)}function writeTimeInstant(l,t){const n=createElementNS(GMLNS,"TimeInstant");l.appendChild(n);const s=createElementNS(GMLNS,"timePosition");n.appendChild(s),writeStringTextNode(s,t)}function writeGetFeature(l,t,n){const s=n[n.length-1],o=Object.assign({},s);o.node=l,pushSerializeAndPop(o,GETFEATURE_SERIALIZERS,makeSimpleNodeFactory("Query"),t,n)}function getFilterNS(l){let t;return l==="2.0.0"?t=FESNS[l]:t=OGCNS[l],t}const WKBGeometryType={POINT:1,LINE_STRING:2,POLYGON:3,MULTI_POINT:4,MULTI_LINE_STRING:5,MULTI_POLYGON:6,GEOMETRY_COLLECTION:7,POLYHEDRAL_SURFACE:15,TIN:16,TRIANGLE:17};class WkbReader{constructor(t){this.view_=t,this.pos_=0,this.initialized_=!1,this.isLittleEndian_=!1,this.hasZ_=!1,this.hasM_=!1,this.srid_=null,this.layout_="XY"}readUint8(){return this.view_.getUint8(this.pos_++)}readUint32(t){return this.view_.getUint32((this.pos_+=4)-4,t!==void 0?t:this.isLittleEndian_)}readDouble(t){return this.view_.getFloat64((this.pos_+=8)-8,t!==void 0?t:this.isLittleEndian_)}readPoint(){const t=[];return t.push(this.readDouble()),t.push(this.readDouble()),this.hasZ_&&t.push(this.readDouble()),this.hasM_&&t.push(this.readDouble()),t}readLineString(){const t=this.readUint32(),n=[];for(let s=0;s<t;s++)n.push(this.readPoint());return n}readPolygon(){const t=this.readUint32(),n=[];for(let s=0;s<t;s++)n.push(this.readLineString());return n}readWkbHeader(t){const s=this.readUint8()>0,o=this.readUint32(s),a=Math.floor((o&268435455)/1e3),h=!!(o&2147483648)||a===1||a===3,c=!!(o&1073741824)||a===2||a===3,u=!!(o&536870912),d=(o&268435455)%1e3,f=["XY",h?"Z":"",c?"M":""].join(""),g=u?this.readUint32(s):null;if(t!==void 0&&t!==d)throw new Error("Unexpected WKB geometry type "+d);if(this.initialized_){if(this.isLittleEndian_!==s)throw new Error("Inconsistent endian");if(this.layout_!==f)throw new Error("Inconsistent geometry layout");if(g&&this.srid_!==g)throw new Error("Inconsistent coordinate system (SRID)")}else this.isLittleEndian_=s,this.hasZ_=h,this.hasM_=c,this.layout_=f,this.srid_=g,this.initialized_=!0;return d}readWkbPayload(t){switch(t){case WKBGeometryType.POINT:return this.readPoint();case WKBGeometryType.LINE_STRING:return this.readLineString();case WKBGeometryType.POLYGON:case WKBGeometryType.TRIANGLE:return this.readPolygon();case WKBGeometryType.MULTI_POINT:return this.readMultiPoint();case WKBGeometryType.MULTI_LINE_STRING:return this.readMultiLineString();case WKBGeometryType.MULTI_POLYGON:case WKBGeometryType.POLYHEDRAL_SURFACE:case WKBGeometryType.TIN:return this.readMultiPolygon();case WKBGeometryType.GEOMETRY_COLLECTION:return this.readGeometryCollection();default:throw new Error("Unsupported WKB geometry type "+t+" is found")}}readWkbBlock(t){return this.readWkbPayload(this.readWkbHeader(t))}readWkbCollection(t,n){const s=this.readUint32(),o=[];for(let a=0;a<s;a++){const h=t.call(this,n);h&&o.push(h)}return o}readMultiPoint(){return this.readWkbCollection(this.readWkbBlock,WKBGeometryType.POINT)}readMultiLineString(){return this.readWkbCollection(this.readWkbBlock,WKBGeometryType.LINE_STRING)}readMultiPolygon(){return this.readWkbCollection(this.readWkbBlock,WKBGeometryType.POLYGON)}readGeometryCollection(){return this.readWkbCollection(this.readGeometry)}readGeometry(){const t=this.readWkbHeader(),n=this.readWkbPayload(t);switch(t){case WKBGeometryType.POINT:return new Point(n,this.layout_);case WKBGeometryType.LINE_STRING:return new LineString(n,this.layout_);case WKBGeometryType.POLYGON:case WKBGeometryType.TRIANGLE:return new Polygon(n,this.layout_);case WKBGeometryType.MULTI_POINT:return new MultiPoint(n,this.layout_);case WKBGeometryType.MULTI_LINE_STRING:return new MultiLineString(n,this.layout_);case WKBGeometryType.MULTI_POLYGON:case WKBGeometryType.POLYHEDRAL_SURFACE:case WKBGeometryType.TIN:return new MultiPolygon(n,this.layout_);case WKBGeometryType.GEOMETRY_COLLECTION:return new GeometryCollection(n);default:return null}}getSrid(){return this.srid_}}class WkbWriter{constructor(t){t=t||{},this.layout_=t.layout,this.isLittleEndian_=t.littleEndian!==!1,this.isEWKB_=t.ewkb!==!1,this.writeQueue_=[],this.nodata_=Object.assign({X:0,Y:0,Z:0,M:0},t.nodata)}writeUint8(t){this.writeQueue_.push([1,t])}writeUint32(t){this.writeQueue_.push([4,t])}writeDouble(t){this.writeQueue_.push([8,t])}writePoint(t,n){const s=Object.assign.apply(null,n.split("").map((o,a)=>({[o]:t[a]})));for(const o of this.layout_)this.writeDouble(o in s?s[o]:this.nodata_[o])}writeLineString(t,n){this.writeUint32(t.length);for(let s=0;s<t.length;s++)this.writePoint(t[s],n)}writePolygon(t,n){this.writeUint32(t.length);for(let s=0;s<t.length;s++)this.writeLineString(t[s],n)}writeWkbHeader(t,n){t%=1e3,this.layout_.includes("Z")&&(t+=this.isEWKB_?2147483648:1e3),this.layout_.includes("M")&&(t+=this.isEWKB_?1073741824:2e3),this.isEWKB_&&Number.isInteger(n)&&(t|=536870912),this.writeUint8(this.isLittleEndian_?1:0),this.writeUint32(t),this.isEWKB_&&Number.isInteger(n)&&this.writeUint32(n)}writeMultiPoint(t,n){this.writeUint32(t.length);for(let s=0;s<t.length;s++)this.writeWkbHeader(1),this.writePoint(t[s],n)}writeMultiLineString(t,n){this.writeUint32(t.length);for(let s=0;s<t.length;s++)this.writeWkbHeader(2),this.writeLineString(t[s],n)}writeMultiPolygon(t,n){this.writeUint32(t.length);for(let s=0;s<t.length;s++)this.writeWkbHeader(3),this.writePolygon(t[s],n)}writeGeometryCollection(t){this.writeUint32(t.length);for(let n=0;n<t.length;n++)this.writeGeometry(t[n])}findMinimumLayout(t,n="XYZM"){const s=(o,a)=>o===a?o:o==="XYZM"?a:a==="XYZM"?o:"XY";if(t instanceof SimpleGeometry)return s(t.getLayout(),n);if(t instanceof GeometryCollection){const o=t.getGeometriesArray();for(let a=0;a<o.length&&n!=="XY";a++)n=this.findMinimumLayout(o[a],n)}return n}writeGeometry(t,n){const s={Point:WKBGeometryType.POINT,LineString:WKBGeometryType.LINE_STRING,Polygon:WKBGeometryType.POLYGON,MultiPoint:WKBGeometryType.MULTI_POINT,MultiLineString:WKBGeometryType.MULTI_LINE_STRING,MultiPolygon:WKBGeometryType.MULTI_POLYGON,GeometryCollection:WKBGeometryType.GEOMETRY_COLLECTION},o=t.getType(),a=s[o];if(!a)throw new Error("GeometryType "+o+" is not supported");this.layout_||(this.layout_=this.findMinimumLayout(t)),this.writeWkbHeader(a,n),t instanceof SimpleGeometry?{Point:this.writePoint,LineString:this.writeLineString,Polygon:this.writePolygon,MultiPoint:this.writeMultiPoint,MultiLineString:this.writeMultiLineString,MultiPolygon:this.writeMultiPolygon}[o].call(this,t.getCoordinates(),t.getLayout()):t instanceof GeometryCollection&&this.writeGeometryCollection(t.getGeometriesArray())}getBuffer(){const t=this.writeQueue_.reduce((a,h)=>a+h[0],0),n=new ArrayBuffer(t),s=new DataView(n);let o=0;return this.writeQueue_.forEach(a=>{switch(a[0]){case 1:s.setUint8(o,a[1]);break;case 4:s.setUint32(o,a[1],this.isLittleEndian_);break;case 8:s.setFloat64(o,a[1],this.isLittleEndian_);break}o+=a[0]}),n}}class WKB extends FeatureFormat{constructor(t){super(),t=t||{},this.splitCollection=!!t.splitCollection,this.viewCache_=null,this.hex_=t.hex!==!1,this.littleEndian_=t.littleEndian!==!1,this.ewkb_=t.ewkb!==!1,this.layout_=t.geometryLayout,this.nodataZ_=t.nodataZ||0,this.nodataM_=t.nodataM||0,this.srid_=t.srid}getType(){return this.hex_?"text":"arraybuffer"}readFeature(t,n){return new Feature({geometry:this.readGeometry(t,n)})}readFeatures(t,n){let s=[];const o=this.readGeometry(t,n);return this.splitCollection&&o instanceof GeometryCollection?s=o.getGeometriesArray():s=[o],s.map(a=>new Feature({geometry:a}))}readGeometry(t,n){const s=getDataView(t);if(!s)return null;const a=new WkbReader(s).readGeometry();return this.viewCache_=s,n=this.getReadOptions(t,n),this.viewCache_=null,transformGeometryWithOptions(a,!1,n)}readProjection(t){const n=this.viewCache_||getDataView(t);if(!n)return;const s=new WkbReader(n);return s.readWkbHeader(),s.getSrid()&&get$1("EPSG:"+s.getSrid())||void 0}writeFeature(t,n){return this.writeGeometry(t.getGeometry(),n)}writeFeatures(t,n){return this.writeGeometry(new GeometryCollection(t.map(s=>s.getGeometry())),n)}writeGeometry(t,n){n=this.adaptOptions(n);const s=new WkbWriter({layout:this.layout_,littleEndian:this.littleEndian_,ewkb:this.ewkb_,nodata:{Z:this.nodataZ_,M:this.nodataM_}});let o=Number.isInteger(this.srid_)?Number(this.srid_):null;if(this.srid_!==!1&&!Number.isInteger(this.srid_)){const h=n.dataProjection&&get$1(n.dataProjection);if(h){const c=h.getCode();c.startsWith("EPSG:")&&(o=Number(c.substring(5)))}}s.writeGeometry(transformGeometryWithOptions(t,!0,n),o);const a=s.getBuffer();return this.hex_?encodeHexString(a):a}}function encodeHexString(l){const t=new Uint8Array(l);return Array.from(t.values()).map(n=>(n<16?"0":"")+Number(n).toString(16).toUpperCase()).join("")}function decodeHexString(l){const t=new Uint8Array(l.length/2);for(let n=0;n<l.length/2;n++)t[n]=parseInt(l.substr(n*2,2),16);return new DataView(t.buffer)}function getDataView(l){return typeof l=="string"?decodeHexString(l):ArrayBuffer.isView(l)?l instanceof DataView?l:new DataView(l.buffer,l.byteOffset,l.byteLength):l instanceof ArrayBuffer?new DataView(l):null}const GeometryConstructor={POINT:Point,LINESTRING:LineString,POLYGON:Polygon,MULTIPOINT:MultiPoint,MULTILINESTRING:MultiLineString,MULTIPOLYGON:MultiPolygon},EMPTY="EMPTY",Z="Z",M="M",ZM="ZM",TokenType={START:0,TEXT:1,LEFT_PAREN:2,RIGHT_PAREN:3,NUMBER:4,COMMA:5,EOF:6},wktTypeLookup={Point:"POINT",LineString:"LINESTRING",Polygon:"POLYGON",MultiPoint:"MULTIPOINT",MultiLineString:"MULTILINESTRING",MultiPolygon:"MULTIPOLYGON",GeometryCollection:"GEOMETRYCOLLECTION",Circle:"CIRCLE"};class Lexer{constructor(t){this.wkt=t,this.index_=-1}isAlpha_(t){return t>="a"&&t<="z"||t>="A"&&t<="Z"}isNumeric_(t,n){return n=n!==void 0?n:!1,t>="0"&&t<="9"||t=="."&&!n}isWhiteSpace_(t){return t==" "||t=="	"||t=="\r"||t==`
`}nextChar_(){return this.wkt.charAt(++this.index_)}nextToken(){const t=this.nextChar_(),n=this.index_;let s=t,o;if(t=="(")o=TokenType.LEFT_PAREN;else if(t==",")o=TokenType.COMMA;else if(t==")")o=TokenType.RIGHT_PAREN;else if(this.isNumeric_(t)||t=="-")o=TokenType.NUMBER,s=this.readNumber_();else if(this.isAlpha_(t))o=TokenType.TEXT,s=this.readText_();else{if(this.isWhiteSpace_(t))return this.nextToken();if(t==="")o=TokenType.EOF;else throw new Error("Unexpected character: "+t)}return{position:n,value:s,type:o}}readNumber_(){let t;const n=this.index_;let s=!1,o=!1;do t=="."?s=!0:(t=="e"||t=="E")&&(o=!0),t=this.nextChar_();while(this.isNumeric_(t,s)||!o&&(t=="e"||t=="E")||o&&(t=="-"||t=="+"));return parseFloat(this.wkt.substring(n,this.index_--))}readText_(){let t;const n=this.index_;do t=this.nextChar_();while(this.isAlpha_(t));return this.wkt.substring(n,this.index_--).toUpperCase()}}class Parser{constructor(t){this.lexer_=t,this.token_={position:0,type:TokenType.START},this.layout_="XY"}consume_(){this.token_=this.lexer_.nextToken()}isTokenType(t){return this.token_.type==t}match(t){const n=this.isTokenType(t);return n&&this.consume_(),n}parse(){return this.consume_(),this.parseGeometry_()}parseGeometryLayout_(){let t="XY";const n=this.token_;if(this.isTokenType(TokenType.TEXT)){const s=n.value;s===Z?t="XYZ":s===M?t="XYM":s===ZM&&(t="XYZM"),t!=="XY"&&this.consume_()}return t}parseGeometryCollectionText_(){if(this.match(TokenType.LEFT_PAREN)){const t=[];do t.push(this.parseGeometry_());while(this.match(TokenType.COMMA));if(this.match(TokenType.RIGHT_PAREN))return t}throw new Error(this.formatErrorMessage_())}parsePointText_(){if(this.match(TokenType.LEFT_PAREN)){const t=this.parsePoint_();if(this.match(TokenType.RIGHT_PAREN))return t}throw new Error(this.formatErrorMessage_())}parseLineStringText_(){if(this.match(TokenType.LEFT_PAREN)){const t=this.parsePointList_();if(this.match(TokenType.RIGHT_PAREN))return t}throw new Error(this.formatErrorMessage_())}parsePolygonText_(){if(this.match(TokenType.LEFT_PAREN)){const t=this.parseLineStringTextList_();if(this.match(TokenType.RIGHT_PAREN))return t}throw new Error(this.formatErrorMessage_())}parseMultiPointText_(){if(this.match(TokenType.LEFT_PAREN)){let t;if(this.token_.type==TokenType.LEFT_PAREN?t=this.parsePointTextList_():t=this.parsePointList_(),this.match(TokenType.RIGHT_PAREN))return t}throw new Error(this.formatErrorMessage_())}parseMultiLineStringText_(){if(this.match(TokenType.LEFT_PAREN)){const t=this.parseLineStringTextList_();if(this.match(TokenType.RIGHT_PAREN))return t}throw new Error(this.formatErrorMessage_())}parseMultiPolygonText_(){if(this.match(TokenType.LEFT_PAREN)){const t=this.parsePolygonTextList_();if(this.match(TokenType.RIGHT_PAREN))return t}throw new Error(this.formatErrorMessage_())}parsePoint_(){const t=[],n=this.layout_.length;for(let s=0;s<n;++s){const o=this.token_;if(this.match(TokenType.NUMBER))t.push(o.value);else break}if(t.length==n)return t;throw new Error(this.formatErrorMessage_())}parsePointList_(){const t=[this.parsePoint_()];for(;this.match(TokenType.COMMA);)t.push(this.parsePoint_());return t}parsePointTextList_(){const t=[this.parsePointText_()];for(;this.match(TokenType.COMMA);)t.push(this.parsePointText_());return t}parseLineStringTextList_(){const t=[this.parseLineStringText_()];for(;this.match(TokenType.COMMA);)t.push(this.parseLineStringText_());return t}parsePolygonTextList_(){const t=[this.parsePolygonText_()];for(;this.match(TokenType.COMMA);)t.push(this.parsePolygonText_());return t}isEmptyGeometry_(){const t=this.isTokenType(TokenType.TEXT)&&this.token_.value==EMPTY;return t&&this.consume_(),t}formatErrorMessage_(){return"Unexpected `"+this.token_.value+"` at position "+this.token_.position+" in `"+this.lexer_.wkt+"`"}parseGeometry_(){const t=this.token_;if(this.match(TokenType.TEXT)){const n=t.value;this.layout_=this.parseGeometryLayout_();const s=this.isEmptyGeometry_();if(n=="GEOMETRYCOLLECTION"){if(s)return new GeometryCollection([]);const h=this.parseGeometryCollectionText_();return new GeometryCollection(h)}const o=GeometryConstructor[n];if(!o)throw new Error("Invalid geometry type: "+n);let a;if(s)n=="POINT"?a=[NaN,NaN]:a=[];else switch(n){case"POINT":{a=this.parsePointText_();break}case"LINESTRING":{a=this.parseLineStringText_();break}case"POLYGON":{a=this.parsePolygonText_();break}case"MULTIPOINT":{a=this.parseMultiPointText_();break}case"MULTILINESTRING":{a=this.parseMultiLineStringText_();break}case"MULTIPOLYGON":{a=this.parseMultiPolygonText_();break}}return new o(a,this.layout_)}throw new Error(this.formatErrorMessage_())}}class WKT extends TextFeature{constructor(t){super(),t=t||{},this.splitCollection_=t.splitCollection!==void 0?t.splitCollection:!1}parse_(t){const n=new Lexer(t);return new Parser(n).parse()}readFeatureFromText(t,n){const s=this.readGeometryFromText(t,n),o=new Feature;return o.setGeometry(s),o}readFeaturesFromText(t,n){let s=[];const o=this.readGeometryFromText(t,n);this.splitCollection_&&o.getType()=="GeometryCollection"?s=o.getGeometriesArray():s=[o];const a=[];for(let h=0,c=s.length;h<c;++h){const u=new Feature;u.setGeometry(s[h]),a.push(u)}return a}readGeometryFromText(t,n){const s=this.parse_(t);return transformGeometryWithOptions(s,!1,n)}writeFeatureText(t,n){const s=t.getGeometry();return s?this.writeGeometryText(s,n):""}writeFeaturesText(t,n){if(t.length==1)return this.writeFeatureText(t[0],n);const s=[];for(let a=0,h=t.length;a<h;++a)s.push(t[a].getGeometry());const o=new GeometryCollection(s);return this.writeGeometryText(o,n)}writeGeometryText(t,n){return encode(transformGeometryWithOptions(t,!0,n))}}function encodePointGeometry(l){const t=l.getCoordinates();return t.length===0?"":t.join(" ")}function encodeMultiPointGeometry(l){const t=[],n=l.getPoints();for(let s=0,o=n.length;s<o;++s)t.push("("+encodePointGeometry(n[s])+")");return t.join(",")}function encodeGeometryCollectionGeometry(l){const t=[],n=l.getGeometries();for(let s=0,o=n.length;s<o;++s)t.push(encode(n[s]));return t.join(",")}function encodeLineStringGeometry(l){const t=l.getCoordinates(),n=[];for(let s=0,o=t.length;s<o;++s)n.push(t[s].join(" "));return n.join(",")}function encodeMultiLineStringGeometry(l){const t=[],n=l.getLineStrings();for(let s=0,o=n.length;s<o;++s)t.push("("+encodeLineStringGeometry(n[s])+")");return t.join(",")}function encodePolygonGeometry(l){const t=[],n=l.getLinearRings();for(let s=0,o=n.length;s<o;++s)t.push("("+encodeLineStringGeometry(n[s])+")");return t.join(",")}function encodeMultiPolygonGeometry(l){const t=[],n=l.getPolygons();for(let s=0,o=n.length;s<o;++s)t.push("("+encodePolygonGeometry(n[s])+")");return t.join(",")}function encodeGeometryLayout(l){const t=l.getLayout();let n="";return(t==="XYZ"||t==="XYZM")&&(n+=Z),(t==="XYM"||t==="XYZM")&&(n+=M),n}const GeometryEncoder={Point:encodePointGeometry,LineString:encodeLineStringGeometry,Polygon:encodePolygonGeometry,MultiPoint:encodeMultiPointGeometry,MultiLineString:encodeMultiLineStringGeometry,MultiPolygon:encodeMultiPolygonGeometry,GeometryCollection:encodeGeometryCollectionGeometry};function encode(l){const t=l.getType(),n=GeometryEncoder[t],s=n(l);let o=wktTypeLookup[t];if(typeof l.getFlatCoordinates=="function"){const a=encodeGeometryLayout(l);a.length>0&&(o+=" "+a)}return s.length===0?o+" "+EMPTY:o+"("+s+")"}const NAMESPACE_URIS$1=[null,"http://www.opengis.net/wms","http://www.opengis.net/sld"];function isV13(l){return compareVersions(l[0].version,"1.3")>=0}const PARSERS$1=makeStructureNS(NAMESPACE_URIS$1,{Service:makeObjectPropertySetter(readService),Capability:makeObjectPropertySetter(readCapability)}),CAPABILITY_PARSERS=makeStructureNS(NAMESPACE_URIS$1,{Request:makeObjectPropertySetter(readRequest),Exception:makeObjectPropertySetter(readException),Layer:makeObjectPropertySetter(readCapabilityLayer),UserDefinedSymbolization:makeObjectPropertySetter(readUserDefinedSymbolization)});class WMSCapabilities extends XML{constructor(){super(),this.version=void 0}readFromNode(t){this.version=t.getAttribute("version").trim();const n=pushParseAndPop({version:this.version},PARSERS$1,t,[]);return n||null}}const COMMON_SERVICE_PARSERS={Name:makeObjectPropertySetter(readString),Title:makeObjectPropertySetter(readString),Abstract:makeObjectPropertySetter(readString),KeywordList:makeObjectPropertySetter(readKeywordList),OnlineResource:makeObjectPropertySetter(readHref),ContactInformation:makeObjectPropertySetter(readContactInformation),Fees:makeObjectPropertySetter(readString),AccessConstraints:makeObjectPropertySetter(readString)},SERVICE_PARSERS=makeStructureNS(NAMESPACE_URIS$1,COMMON_SERVICE_PARSERS),SERVICE_PARSERS_V13=makeStructureNS(NAMESPACE_URIS$1,{...COMMON_SERVICE_PARSERS,LayerLimit:makeObjectPropertySetter(readPositiveInteger),MaxWidth:makeObjectPropertySetter(readPositiveInteger),MaxHeight:makeObjectPropertySetter(readPositiveInteger)}),CONTACT_INFORMATION_PARSERS=makeStructureNS(NAMESPACE_URIS$1,{ContactPersonPrimary:makeObjectPropertySetter(readContactPersonPrimary),ContactPosition:makeObjectPropertySetter(readString),ContactAddress:makeObjectPropertySetter(readContactAddress),ContactVoiceTelephone:makeObjectPropertySetter(readString),ContactFacsimileTelephone:makeObjectPropertySetter(readString),ContactElectronicMailAddress:makeObjectPropertySetter(readString)}),CONTACT_PERSON_PARSERS=makeStructureNS(NAMESPACE_URIS$1,{ContactPerson:makeObjectPropertySetter(readString),ContactOrganization:makeObjectPropertySetter(readString)}),CONTACT_ADDRESS_PARSERS=makeStructureNS(NAMESPACE_URIS$1,{AddressType:makeObjectPropertySetter(readString),Address:makeObjectPropertySetter(readString),City:makeObjectPropertySetter(readString),StateOrProvince:makeObjectPropertySetter(readString),PostCode:makeObjectPropertySetter(readString),Country:makeObjectPropertySetter(readString)}),EXCEPTION_PARSERS=makeStructureNS(NAMESPACE_URIS$1,{Format:makeArrayPusher(readString)}),COMMON_LAYER_PARSERS={Name:makeObjectPropertySetter(readString),Title:makeObjectPropertySetter(readString),Abstract:makeObjectPropertySetter(readString),KeywordList:makeObjectPropertySetter(readKeywordList),BoundingBox:makeObjectPropertyPusher(readBoundingBox$1),Dimension:makeObjectPropertyPusher(readDimension),Attribution:makeObjectPropertySetter(readAttribution),AuthorityURL:makeObjectPropertyPusher(readAuthorityURL),Identifier:makeObjectPropertyPusher(readString),MetadataURL:makeObjectPropertyPusher(readMetadataURL),DataURL:makeObjectPropertyPusher(readFormatOnlineresource),FeatureListURL:makeObjectPropertyPusher(readFormatOnlineresource),Style:makeObjectPropertyPusher(readStyle$1),Layer:makeObjectPropertyPusher(readLayer$1)},LAYER_PARSERS$1=makeStructureNS(NAMESPACE_URIS$1,{...COMMON_LAYER_PARSERS,SRS:makeObjectPropertyPusher(readString),Extent:makeObjectPropertySetter(readExtent),ScaleHint:makeObjectPropertyPusher(readScaleHint),LatLonBoundingBox:makeObjectPropertySetter((l,t)=>readBoundingBox$1(l,t,!1)),Layer:makeObjectPropertyPusher(readLayer$1)}),LAYER_PARSERS_V13=makeStructureNS(NAMESPACE_URIS$1,{...COMMON_LAYER_PARSERS,CRS:makeObjectPropertyPusher(readString),EX_GeographicBoundingBox:makeObjectPropertySetter(readEXGeographicBoundingBox),MinScaleDenominator:makeObjectPropertySetter(readDecimal),MaxScaleDenominator:makeObjectPropertySetter(readDecimal),Layer:makeObjectPropertyPusher(readLayer$1)}),ATTRIBUTION_PARSERS=makeStructureNS(NAMESPACE_URIS$1,{Title:makeObjectPropertySetter(readString),OnlineResource:makeObjectPropertySetter(readHref),LogoURL:makeObjectPropertySetter(readSizedFormatOnlineresource)}),EX_GEOGRAPHIC_BOUNDING_BOX_PARSERS=makeStructureNS(NAMESPACE_URIS$1,{westBoundLongitude:makeObjectPropertySetter(readDecimal),eastBoundLongitude:makeObjectPropertySetter(readDecimal),southBoundLatitude:makeObjectPropertySetter(readDecimal),northBoundLatitude:makeObjectPropertySetter(readDecimal)}),REQUEST_PARSERS=makeStructureNS(NAMESPACE_URIS$1,{GetCapabilities:makeObjectPropertySetter(readOperationType),GetMap:makeObjectPropertySetter(readOperationType),GetFeatureInfo:makeObjectPropertySetter(readOperationType),DescribeLayer:makeObjectPropertySetter(readOperationType),GetLegendGraphic:makeObjectPropertySetter(readOperationType)}),OPERATIONTYPE_PARSERS=makeStructureNS(NAMESPACE_URIS$1,{Format:makeObjectPropertyPusher(readString),DCPType:makeObjectPropertyPusher(readDCPType)}),DCPTYPE_PARSERS=makeStructureNS(NAMESPACE_URIS$1,{HTTP:makeObjectPropertySetter(readHTTP)}),HTTP_PARSERS=makeStructureNS(NAMESPACE_URIS$1,{Get:makeObjectPropertySetter(readFormatOnlineresource),Post:makeObjectPropertySetter(readFormatOnlineresource)}),STYLE_PARSERS$1=makeStructureNS(NAMESPACE_URIS$1,{Name:makeObjectPropertySetter(readString),Title:makeObjectPropertySetter(readString),Abstract:makeObjectPropertySetter(readString),LegendURL:makeObjectPropertyPusher(readSizedFormatOnlineresource),StyleSheetURL:makeObjectPropertySetter(readFormatOnlineresource),StyleURL:makeObjectPropertySetter(readFormatOnlineresource)}),FORMAT_ONLINERESOURCE_PARSERS=makeStructureNS(NAMESPACE_URIS$1,{Format:makeObjectPropertySetter(readString),OnlineResource:makeObjectPropertySetter(readHref)}),KEYWORDLIST_PARSERS=makeStructureNS(NAMESPACE_URIS$1,{Keyword:makeArrayPusher(readString)});function readAttribution(l,t){return pushParseAndPop({},ATTRIBUTION_PARSERS,l,t)}function readUserDefinedSymbolization(l,t){return{SupportSLD:!!readBooleanString(l.getAttribute("SupportSLD")),UserLayer:!!readBooleanString(l.getAttribute("UserLayer")),UserStyle:!!readBooleanString(l.getAttribute("UserStyle")),RemoteWFS:!!readBooleanString(l.getAttribute("RemoteWFS")),InlineFeatureData:!!readBooleanString(l.getAttribute("InlineFeatureData")),RemoteWCS:!!readBooleanString(l.getAttribute("RemoteWCS"))}}function readBoundingBox$1(l,t,n=!0){const s=[readDecimalString(l.getAttribute("minx")),readDecimalString(l.getAttribute("miny")),readDecimalString(l.getAttribute("maxx")),readDecimalString(l.getAttribute("maxy"))],o=[readDecimalString(l.getAttribute("resx")),readDecimalString(l.getAttribute("resy"))],a={extent:s,res:o};return n&&(isV13(t)?a.crs=l.getAttribute("CRS"):a.srs=l.getAttribute("SRS")),a}function readEXGeographicBoundingBox(l,t){const n=pushParseAndPop({},EX_GEOGRAPHIC_BOUNDING_BOX_PARSERS,l,t);if(!n)return;const s=n.westBoundLongitude,o=n.southBoundLatitude,a=n.eastBoundLongitude,h=n.northBoundLatitude;if(!(s===void 0||o===void 0||a===void 0||h===void 0))return[s,o,a,h]}function readCapability(l,t){return pushParseAndPop({},CAPABILITY_PARSERS,l,t)}function readService(l,t){return pushParseAndPop({},isV13(t)?SERVICE_PARSERS_V13:SERVICE_PARSERS,l,t)}function readContactInformation(l,t){return pushParseAndPop({},CONTACT_INFORMATION_PARSERS,l,t)}function readContactPersonPrimary(l,t){return pushParseAndPop({},CONTACT_PERSON_PARSERS,l,t)}function readContactAddress(l,t){return pushParseAndPop({},CONTACT_ADDRESS_PARSERS,l,t)}function readException(l,t){return pushParseAndPop([],EXCEPTION_PARSERS,l,t)}function readCapabilityLayer(l,t){const n=pushParseAndPop({},isV13(t)?LAYER_PARSERS_V13:LAYER_PARSERS$1,l,t);return n.Layer===void 0?Object.assign(n,readLayer$1(l,t)):n}function readLayer$1(l,t){const n=isV13(t),s=t[t.length-1],o=pushParseAndPop({},n?LAYER_PARSERS_V13:LAYER_PARSERS$1,l,t);if(!o)return;let a=readBooleanString(l.getAttribute("queryable"));a===void 0&&(a=s.queryable),o.queryable=a!==void 0?a:!1;let h=readNonNegativeIntegerString(l.getAttribute("cascaded"));h===void 0&&(h=s.cascaded),o.cascaded=h;let c=readBooleanString(l.getAttribute("opaque"));c===void 0&&(c=s.opaque),o.opaque=c!==void 0?c:!1;let u=readBooleanString(l.getAttribute("noSubsets"));u===void 0&&(u=s.noSubsets),o.noSubsets=u!==void 0?u:!1;let d=readDecimalString(l.getAttribute("fixedWidth"));d||(d=s.fixedWidth),o.fixedWidth=d;let f=readDecimalString(l.getAttribute("fixedHeight"));f||(f=s.fixedHeight),o.fixedHeight=f;const g=["Style","AuthorityURL"];n?g.push("CRS"):g.push("SRS","Dimension"),g.forEach(function(m){if(m in s){const p=o[m]||[];o[m]=p.concat(s[m])}});const _=["BoundingBox","Attribution"];return n?_.push("Dimension","EX_GeographicBoundingBox","MinScaleDenominator","MaxScaleDenominator"):_.push("LatLonBoundingBox","ScaleHint","Extent"),_.forEach(function(m){if(!(m in o)){const p=s[m];o[m]=p}}),o}function readDimension(l,t){const n={name:l.getAttribute("name"),units:l.getAttribute("units"),unitSymbol:l.getAttribute("unitSymbol")};return isV13(t)&&Object.assign(n,{default:l.getAttribute("default"),multipleValues:readBooleanString(l.getAttribute("multipleValues")),nearestValue:readBooleanString(l.getAttribute("nearestValue")),current:readBooleanString(l.getAttribute("current")),values:readString(l)}),n}function readExtent(l,t){return{name:l.getAttribute("name"),default:l.getAttribute("default"),nearestValue:readBooleanString(l.getAttribute("nearestValue"))}}function readScaleHint(l,t){return{min:readDecimalString(l.getAttribute("min")),max:readDecimalString(l.getAttribute("max"))}}function readFormatOnlineresource(l,t){return pushParseAndPop({},FORMAT_ONLINERESOURCE_PARSERS,l,t)}function readRequest(l,t){return pushParseAndPop({},REQUEST_PARSERS,l,t)}function readDCPType(l,t){return pushParseAndPop({},DCPTYPE_PARSERS,l,t)}function readHTTP(l,t){return pushParseAndPop({},HTTP_PARSERS,l,t)}function readOperationType(l,t){return pushParseAndPop({},OPERATIONTYPE_PARSERS,l,t)}function readSizedFormatOnlineresource(l,t){const n=readFormatOnlineresource(l,t);if(n){const s=[readNonNegativeIntegerString(l.getAttribute("width")),readNonNegativeIntegerString(l.getAttribute("height"))];return n.size=s,n}}function readAuthorityURL(l,t){const n=readFormatOnlineresource(l,t);if(n)return n.name=l.getAttribute("name"),n}function readMetadataURL(l,t){const n=readFormatOnlineresource(l,t);if(n)return n.type=l.getAttribute("type"),n}function readStyle$1(l,t){return pushParseAndPop({},STYLE_PARSERS$1,l,t)}function readKeywordList(l,t){return pushParseAndPop([],KEYWORDLIST_PARSERS,l,t)}const featureIdentifier="_feature",layerIdentifier="_layer";class WMSGetFeatureInfo extends XMLFeature{constructor(t){super(),t=t||{},this.featureNS_="http://mapserver.gis.umn.edu/mapserver",this.gmlFormat_=new GML2,this.layers_=t.layers?t.layers:null}getLayers(){return this.layers_}setLayers(t){this.layers_=t}readFeatures_(t,n){t.setAttribute("namespaceURI",this.featureNS_);const s=t.localName;let o=[];if(t.childNodes.length===0)return o;if(s=="msGMLOutput")for(let a=0,h=t.childNodes.length;a<h;a++){const c=t.childNodes[a];if(c.nodeType!==Node.ELEMENT_NODE)continue;const u=c,d=n[0],f=layerIdentifier,g=u.localName.replace(f,"");if(this.layers_&&!this.layers_.includes(g))continue;const _=g+featureIdentifier;d.featureType=_,d.featureNS=this.featureNS_;const m={};m[_]=makeArrayPusher(this.gmlFormat_.readFeatureElement,this.gmlFormat_);const p=makeStructureNS([d.featureNS,null],m);u.setAttribute("namespaceURI",this.featureNS_);const x=pushParseAndPop([],p,u,n,this.gmlFormat_);x&&extend$2(o,x)}if(s=="FeatureCollection"){const a=pushParseAndPop([],this.gmlFormat_.FEATURE_COLLECTION_PARSERS,t,[{}],this.gmlFormat_);a&&(o=a)}return o}readFeaturesFromNode(t,n){const s={};return n&&Object.assign(s,this.getReadOptions(t,n)),this.readFeatures_(t,[s])}}const NAMESPACE_URIS=[null,"http://www.opengis.net/wmts/1.0"],OWS_NAMESPACE_URIS=[null,"http://www.opengis.net/ows/1.1"],PARSERS=makeStructureNS(NAMESPACE_URIS,{Contents:makeObjectPropertySetter(readContents)});let WMTSCapabilities$1=class extends XML{constructor(){super(),this.owsParser_=new OWS}readFromNode(t){let n=t.getAttribute("version");n&&(n=n.trim());let s=this.owsParser_.readFromNode(t);return s?(s.version=n,s=pushParseAndPop(s,PARSERS,t,[]),s||null):null}};const CONTENTS_PARSERS=makeStructureNS(NAMESPACE_URIS,{Layer:makeObjectPropertyPusher(readLayer),TileMatrixSet:makeObjectPropertyPusher(readTileMatrixSet)}),LAYER_PARSERS=makeStructureNS(NAMESPACE_URIS,{Style:makeObjectPropertyPusher(readStyle),Format:makeObjectPropertyPusher(readString),TileMatrixSetLink:makeObjectPropertyPusher(readTileMatrixSetLink),Dimension:makeObjectPropertyPusher(readDimensions),ResourceURL:makeObjectPropertyPusher(readResourceUrl)},makeStructureNS(OWS_NAMESPACE_URIS,{Title:makeObjectPropertySetter(readString),Abstract:makeObjectPropertySetter(readString),WGS84BoundingBox:makeObjectPropertySetter(readBoundingBox),BoundingBox:makeObjectPropertyPusher(readBoundingBoxWithCrs),Identifier:makeObjectPropertySetter(readString)})),STYLE_PARSERS=makeStructureNS(NAMESPACE_URIS,{LegendURL:makeObjectPropertyPusher(readLegendUrl)},makeStructureNS(OWS_NAMESPACE_URIS,{Title:makeObjectPropertySetter(readString),Identifier:makeObjectPropertySetter(readString)})),TMS_LINKS_PARSERS=makeStructureNS(NAMESPACE_URIS,{TileMatrixSet:makeObjectPropertySetter(readString),TileMatrixSetLimits:makeObjectPropertySetter(readTileMatrixLimitsList)}),TMS_LIMITS_LIST_PARSERS=makeStructureNS(NAMESPACE_URIS,{TileMatrixLimits:makeArrayPusher(readTileMatrixLimits)}),TMS_LIMITS_PARSERS=makeStructureNS(NAMESPACE_URIS,{TileMatrix:makeObjectPropertySetter(readString),MinTileRow:makeObjectPropertySetter(readPositiveInteger),MaxTileRow:makeObjectPropertySetter(readPositiveInteger),MinTileCol:makeObjectPropertySetter(readPositiveInteger),MaxTileCol:makeObjectPropertySetter(readPositiveInteger)}),DIMENSION_PARSERS=makeStructureNS(NAMESPACE_URIS,{Default:makeObjectPropertySetter(readString),Value:makeObjectPropertyPusher(readString)},makeStructureNS(OWS_NAMESPACE_URIS,{Identifier:makeObjectPropertySetter(readString)})),WGS84_BBOX_READERS=makeStructureNS(OWS_NAMESPACE_URIS,{LowerCorner:makeArrayPusher(readCoordinates),UpperCorner:makeArrayPusher(readCoordinates)}),TMS_PARSERS=makeStructureNS(NAMESPACE_URIS,{WellKnownScaleSet:makeObjectPropertySetter(readString),TileMatrix:makeObjectPropertyPusher(readTileMatrix)},makeStructureNS(OWS_NAMESPACE_URIS,{SupportedCRS:makeObjectPropertySetter(readString),Identifier:makeObjectPropertySetter(readString),BoundingBox:makeObjectPropertySetter(readBoundingBox)})),TM_PARSERS=makeStructureNS(NAMESPACE_URIS,{TopLeftCorner:makeObjectPropertySetter(readCoordinates),ScaleDenominator:makeObjectPropertySetter(readDecimal),TileWidth:makeObjectPropertySetter(readPositiveInteger),TileHeight:makeObjectPropertySetter(readPositiveInteger),MatrixWidth:makeObjectPropertySetter(readPositiveInteger),MatrixHeight:makeObjectPropertySetter(readPositiveInteger)},makeStructureNS(OWS_NAMESPACE_URIS,{Identifier:makeObjectPropertySetter(readString)}));function readContents(l,t){return pushParseAndPop({},CONTENTS_PARSERS,l,t)}function readLayer(l,t){return pushParseAndPop({},LAYER_PARSERS,l,t)}function readTileMatrixSet(l,t){return pushParseAndPop({},TMS_PARSERS,l,t)}function readStyle(l,t){const n=pushParseAndPop({},STYLE_PARSERS,l,t);if(!n)return;const s=l.getAttribute("isDefault")==="true";return n.isDefault=s,n}function readTileMatrixSetLink(l,t){return pushParseAndPop({},TMS_LINKS_PARSERS,l,t)}function readDimensions(l,t){return pushParseAndPop({},DIMENSION_PARSERS,l,t)}function readResourceUrl(l,t){const n=l.getAttribute("format"),s=l.getAttribute("template"),o=l.getAttribute("resourceType"),a={};return n&&(a.format=n),s&&(a.template=s),o&&(a.resourceType=o),a}function readBoundingBox(l,t){const n=pushParseAndPop([],WGS84_BBOX_READERS,l,t);if(n.length==2)return boundingExtent(n)}function readBoundingBoxWithCrs(l,t){const n=l.getAttribute("crs"),s=pushParseAndPop([],WGS84_BBOX_READERS,l,t);if(s.length==2)return{extent:boundingExtent(s),crs:n}}function readLegendUrl(l,t){const n={};return n.format=l.getAttribute("format"),n.href=readHref(l),n}function readCoordinates(l,t){const n=readString(l).split(/\s+/);if(!n||n.length!=2)return;const s=+n[0],o=+n[1];if(!(isNaN(s)||isNaN(o)))return[s,o]}function readTileMatrix(l,t){return pushParseAndPop({},TM_PARSERS,l,t)}function readTileMatrixLimitsList(l,t){return pushParseAndPop([],TMS_LIMITS_LIST_PARSERS,l,t)}function readTileMatrixLimits(l,t){return pushParseAndPop({},TMS_LIMITS_PARSERS,l,t)}window.eoxMapAdvancedOlFormats={EsriJSON,GML,GPX,IGC,IIIFInfo,KML,OWS,Polyline,TopoJSON,WFS,WKB,WKT,WMSCapabilities,WMSGetFeatureInfo,WMTSCapabilities:WMTSCapabilities$1};function line(l,t,n){const s=[];let o=l(0),a=l(1),h=t(o),c=t(a);const u=[a,o],d=[c,h],f=[1,0],g={};let _=1e5,m,p,x,y,T,S;for(;--_>0&&f.length>0;)x=f.pop(),o=u.pop(),h=d.pop(),S=x.toString(),S in g||(s.push(h[0],h[1]),g[S]=!0),y=f.pop(),a=u.pop(),c=d.pop(),T=(x+y)/2,m=l(T),p=t(m),squaredSegmentDistance(p[0],p[1],h[0],h[1],c[0],c[1])<n?(s.push(c[0],c[1]),S=y.toString(),g[S]=!0):(f.push(y,T,T,x),d.push(c,p,p,h),u.push(a,m,m,o));return s}function meridian(l,t,n,s,o){const a=get$1("EPSG:4326");return line(function(h){return[l,t+(n-t)*h]},getTransform(a,s),o)}function parallel(l,t,n,s,o){const a=get$1("EPSG:4326");return line(function(h){return[t+(n-t)*h,l]},getTransform(a,s),o)}function getVectorContext(l){if(!(l.context instanceof CanvasRenderingContext2D))throw new Error("Only works for render events from Canvas 2D layers");const t=l.inversePixelTransform[0],n=l.inversePixelTransform[1],s=Math.sqrt(t*t+n*n),o=l.frameState,a=multiply(l.inversePixelTransform.slice(),o.coordinateToPixelTransform),h=getSquaredTolerance(o.viewState.resolution,s);let c;return new CanvasImmediateRenderer(l.context,s,o.extent,a,o.viewState.rotation,h,c)}const DEFAULT_STROKE_STYLE=new Stroke({color:"rgba(0,0,0,0.2)"}),INTERVALS=[90,45,30,20,10,5,2,1,30/60,20/60,10/60,5/60,2/60,1/60,30/3600,20/3600,10/3600,5/3600,2/3600,1/3600];class Graticule extends VectorLayer{constructor(t){t=t||{};const n=Object.assign({updateWhileAnimating:!0,updateWhileInteracting:!0,renderBuffer:0},t);delete n.maxLines,delete n.strokeStyle,delete n.targetSize,delete n.showLabels,delete n.lonLabelFormatter,delete n.latLabelFormatter,delete n.lonLabelPosition,delete n.latLabelPosition,delete n.lonLabelStyle,delete n.latLabelStyle,delete n.intervals,super(n),this.projection_=null,this.maxLat_=1/0,this.maxLon_=1/0,this.minLat_=-1/0,this.minLon_=-1/0,this.maxX_=1/0,this.maxY_=1/0,this.minX_=-1/0,this.minY_=-1/0,this.targetSize_=t.targetSize!==void 0?t.targetSize:100,this.maxLines_=t.maxLines!==void 0?t.maxLines:100,this.meridians_=[],this.parallels_=[],this.strokeStyle_=t.strokeStyle!==void 0?t.strokeStyle:DEFAULT_STROKE_STYLE,this.fromLonLatTransform_=void 0,this.toLonLatTransform_=void 0,this.projectionCenterLonLat_=null,this.bottomLeft_=null,this.bottomRight_=null,this.topLeft_=null,this.topRight_=null,this.meridiansLabels_=null,this.parallelsLabels_=null,t.showLabels&&(this.lonLabelFormatter_=t.lonLabelFormatter==null?degreesToStringHDMS.bind(this,"EW"):t.lonLabelFormatter,this.latLabelFormatter_=t.latLabelFormatter==null?degreesToStringHDMS.bind(this,"NS"):t.latLabelFormatter,this.lonLabelPosition_=t.lonLabelPosition==null?0:t.lonLabelPosition,this.latLabelPosition_=t.latLabelPosition==null?1:t.latLabelPosition,this.lonLabelStyleBase_=new Style({text:t.lonLabelStyle!==void 0?t.lonLabelStyle.clone():new Text({font:"12px Calibri,sans-serif",textBaseline:"bottom",fill:new Fill({color:"rgba(0,0,0,1)"}),stroke:new Stroke({color:"rgba(255,255,255,1)",width:3})})}),this.lonLabelStyle_=s=>{const o=s.get("graticule_label");return this.lonLabelStyleBase_.getText().setText(o),this.lonLabelStyleBase_},this.latLabelStyleBase_=new Style({text:t.latLabelStyle!==void 0?t.latLabelStyle.clone():new Text({font:"12px Calibri,sans-serif",textAlign:"right",fill:new Fill({color:"rgba(0,0,0,1)"}),stroke:new Stroke({color:"rgba(255,255,255,1)",width:3})})}),this.latLabelStyle_=s=>{const o=s.get("graticule_label");return this.latLabelStyleBase_.getText().setText(o),this.latLabelStyleBase_},this.meridiansLabels_=[],this.parallelsLabels_=[],this.addEventListener(RenderEventType.POSTRENDER,this.drawLabels_.bind(this))),this.intervals_=t.intervals!==void 0?t.intervals:INTERVALS,this.setSource(new VectorSource({loader:this.loaderFunction.bind(this),strategy:this.strategyFunction.bind(this),features:new Collection,overlaps:!1,useSpatialIndex:!1,wrapX:t.wrapX})),this.featurePool_=[],this.lineStyle_=new Style({stroke:this.strokeStyle_}),this.loadedExtent_=null,this.renderedExtent_=null,this.renderedResolution_=null,this.setRenderOrder(null)}strategyFunction(t,n){let s=t.slice();return this.projection_&&this.getSource().getWrapX()&&wrapX$2(s,this.projection_),this.loadedExtent_&&(approximatelyEquals(this.loadedExtent_,s,n)?s=this.loadedExtent_.slice():this.getSource().removeLoadedExtent(this.loadedExtent_)),[s]}loaderFunction(t,n,s){this.loadedExtent_=t;const o=this.getSource(),a=this.getExtent()||[-1/0,-1/0,1/0,1/0],h=getIntersection(a,t);if(this.renderedExtent_&&equals$1(this.renderedExtent_,h)&&this.renderedResolution_===n||(this.renderedExtent_=h,this.renderedResolution_=n,isEmpty(h)))return;const c=getCenter(h),u=n*n/4;(!this.projection_||!equivalent$1(this.projection_,s))&&this.updateProjectionInfo_(s),this.createGraticule_(h,c,n,u);let f=this.meridians_.length+this.parallels_.length;this.meridiansLabels_&&(f+=this.meridians_.length),this.parallelsLabels_&&(f+=this.parallels_.length);let g;for(;f>this.featurePool_.length;)g=new Feature,this.featurePool_.push(g);const _=o.getFeaturesCollection();_.clear();let m=0,p,x;for(p=0,x=this.meridians_.length;p<x;++p)g=this.featurePool_[m++],g.setGeometry(this.meridians_[p]),g.setStyle(this.lineStyle_),_.push(g);for(p=0,x=this.parallels_.length;p<x;++p)g=this.featurePool_[m++],g.setGeometry(this.parallels_[p]),g.setStyle(this.lineStyle_),_.push(g)}addMeridian_(t,n,s,o,a,h){const c=this.getMeridian_(t,n,s,o,h);if(intersects$1(c.getExtent(),a)){if(this.meridiansLabels_){const u=this.lonLabelFormatter_(t);h in this.meridiansLabels_?this.meridiansLabels_[h].text=u:this.meridiansLabels_[h]={geom:new Point([]),text:u}}this.meridians_[h++]=c}return h}addParallel_(t,n,s,o,a,h){const c=this.getParallel_(t,n,s,o,h);if(intersects$1(c.getExtent(),a)){if(this.parallelsLabels_){const u=this.latLabelFormatter_(t);h in this.parallelsLabels_?this.parallelsLabels_[h].text=u:this.parallelsLabels_[h]={geom:new Point([]),text:u}}this.parallels_[h++]=c}return h}drawLabels_(t){const n=t.frameState.viewState.rotation,s=t.frameState.viewState.resolution,o=t.frameState.size,a=t.frameState.extent,h=getCenter(a);let c=a;if(n){const p=o[0]*s,x=o[1]*s;c=[h[0]-p/2,h[1]-x/2,h[0]+p/2,h[1]+x/2]}let u=0,d=0,f=this.latLabelPosition_<.5;const g=this.projection_.getExtent(),_=getWidth(g);if(this.getSource().getWrapX()&&this.projection_.canWrapX()&&!containsExtent(g,a)){u=Math.floor((a[0]-g[0])/_),d=Math.ceil((a[2]-g[2])/_);const p=Math.abs(n)>Math.PI/2;f=f!==p}const m=getVectorContext(t);for(let p=u;p<=d;++p){let x=this.meridians_.length+this.parallels_.length,y,T,S,C;if(this.meridiansLabels_)for(T=0,S=this.meridiansLabels_.length;T<S;++T){const P=this.meridians_[T];if(!n&&p===0)C=this.getMeridianPoint_(P,a,T);else{const w=P.clone();w.translate(p*_,0),w.rotate(-n,h),C=this.getMeridianPoint_(w,c,T),C.rotate(n,h)}y=this.featurePool_[x++],y.setGeometry(C),y.set("graticule_label",this.meridiansLabels_[T].text),m.drawFeature(y,this.lonLabelStyle_(y))}if(this.parallelsLabels_&&(p===u&&f||p===d&&!f))for(T=0,S=this.parallels_.length;T<S;++T){const P=this.parallels_[T];if(!n&&p===0)C=this.getParallelPoint_(P,a,T);else{const w=P.clone();w.translate(p*_,0),w.rotate(-n,h),C=this.getParallelPoint_(w,c,T),C.rotate(n,h)}y=this.featurePool_[x++],y.setGeometry(C),y.set("graticule_label",this.parallelsLabels_[T].text),m.drawFeature(y,this.latLabelStyle_(y))}}}createGraticule_(t,n,s,o){const a=this.getInterval_(s);if(a==-1){this.meridians_.length=0,this.parallels_.length=0,this.meridiansLabels_&&(this.meridiansLabels_.length=0),this.parallelsLabels_&&(this.parallelsLabels_.length=0);return}let h=!1;const c=this.projection_.getExtent(),u=getWidth(c);this.getSource().getWrapX()&&this.projection_.canWrapX()&&!containsExtent(c,t)&&(getWidth(t)>=u?(t[0]=c[0],t[2]=c[2]):h=!0);const d=[clamp(n[0],this.minX_,this.maxX_),clamp(n[1],this.minY_,this.maxY_)],f=this.toLonLatTransform_(d);isNaN(f[1])&&(f[1]=Math.abs(this.maxLat_)>=Math.abs(this.minLat_)?this.maxLat_:this.minLat_);let g=clamp(f[0],this.minLon_,this.maxLon_),_=clamp(f[1],this.minLat_,this.maxLat_);const m=this.maxLines_;let p,x,y,T,S=t;h||(S=[clamp(t[0],this.minX_,this.maxX_),clamp(t[1],this.minY_,this.maxY_),clamp(t[2],this.minX_,this.maxX_),clamp(t[3],this.minY_,this.maxY_)]);const C=applyTransform(S,this.toLonLatTransform_,void 0,8);let P=C[3],w=C[2],I=C[1],O=C[0];if(h||(containsCoordinate(S,this.bottomLeft_)&&(O=this.minLon_,I=this.minLat_),containsCoordinate(S,this.bottomRight_)&&(w=this.maxLon_,I=this.minLat_),containsCoordinate(S,this.topLeft_)&&(O=this.minLon_,P=this.maxLat_),containsCoordinate(S,this.topRight_)&&(w=this.maxLon_,P=this.maxLat_),P=clamp(P,_,this.maxLat_),w=clamp(w,g,this.maxLon_),I=clamp(I,this.minLat_,_),O=clamp(O,this.minLon_,g)),g=Math.floor(g/a)*a,T=clamp(g,this.minLon_,this.maxLon_),x=this.addMeridian_(T,I,P,o,t,0),p=0,h)for(;(T-=a)>=O&&p++<m;)x=this.addMeridian_(T,I,P,o,t,x);else for(;T!=this.minLon_&&p++<m;)T=Math.max(T-a,this.minLon_),x=this.addMeridian_(T,I,P,o,t,x);if(T=clamp(g,this.minLon_,this.maxLon_),p=0,h)for(;(T+=a)<=w&&p++<m;)x=this.addMeridian_(T,I,P,o,t,x);else for(;T!=this.maxLon_&&p++<m;)T=Math.min(T+a,this.maxLon_),x=this.addMeridian_(T,I,P,o,t,x);for(this.meridians_.length=x,this.meridiansLabels_&&(this.meridiansLabels_.length=x),_=Math.floor(_/a)*a,y=clamp(_,this.minLat_,this.maxLat_),x=this.addParallel_(y,O,w,o,t,0),p=0;y!=this.minLat_&&p++<m;)y=Math.max(y-a,this.minLat_),x=this.addParallel_(y,O,w,o,t,x);for(y=clamp(_,this.minLat_,this.maxLat_),p=0;y!=this.maxLat_&&p++<m;)y=Math.min(y+a,this.maxLat_),x=this.addParallel_(y,O,w,o,t,x);this.parallels_.length=x,this.parallelsLabels_&&(this.parallelsLabels_.length=x)}getInterval_(t){const n=this.projectionCenterLonLat_[0],s=this.projectionCenterLonLat_[1];let o=-1;const a=Math.pow(this.targetSize_*t,2),h=[],c=[];for(let u=0,d=this.intervals_.length;u<d;++u){const f=clamp(this.intervals_[u]/2,0,90),g=clamp(s,-90+f,90-f);if(h[0]=n-f,h[1]=g-f,c[0]=n+f,c[1]=g+f,this.fromLonLatTransform_(h,h),this.fromLonLatTransform_(c,c),Math.pow(c[0]-h[0],2)+Math.pow(c[1]-h[1],2)<=a)break;o=this.intervals_[u]}return o}getMeridian_(t,n,s,o,a){const h=meridian(t,n,s,this.projection_,o);let c=this.meridians_[a];return c?(c.setFlatCoordinates("XY",h),c.changed()):(c=new LineString(h,"XY"),this.meridians_[a]=c),c}getMeridianPoint_(t,n,s){const o=t.getFlatCoordinates();let a=1,h=o.length-1;o[a]>o[h]&&(a=h,h=1);const c=Math.max(n[1],o[a]),u=Math.min(n[3],o[h]),d=clamp(n[1]+Math.abs(n[1]-n[3])*this.lonLabelPosition_,c,u),g=[o[a-1]+(o[h-1]-o[a-1])*(d-o[a])/(o[h]-o[a]),d],_=this.meridiansLabels_[s].geom;return _.setCoordinates(g),_}getMeridians(){return this.meridians_}getParallel_(t,n,s,o,a){const h=parallel(t,n,s,this.projection_,o);let c=this.parallels_[a];return c?(c.setFlatCoordinates("XY",h),c.changed()):c=new LineString(h,"XY"),c}getParallelPoint_(t,n,s){const o=t.getFlatCoordinates();let a=0,h=o.length-2;o[a]>o[h]&&(a=h,h=0);const c=Math.max(n[0],o[a]),u=Math.min(n[2],o[h]),d=clamp(n[0]+Math.abs(n[0]-n[2])*this.latLabelPosition_,c,u),f=o[a+1]+(o[h+1]-o[a+1])*(d-o[a])/(o[h]-o[a]),g=[d,f],_=this.parallelsLabels_[s].geom;return _.setCoordinates(g),_}getParallels(){return this.parallels_}updateProjectionInfo_(t){const n=get$1("EPSG:4326"),s=t.getWorldExtent();this.maxLat_=s[3],this.maxLon_=s[2],this.minLat_=s[1],this.minLon_=s[0];const o=getTransform(t,n);if(this.minLon_<this.maxLon_)this.toLonLatTransform_=o;else{const h=this.minLon_+this.maxLon_/2;this.maxLon_+=360,this.toLonLatTransform_=function(c,u,d){d=d||2;const f=o(c,u,d);for(let g=0,_=f.length;g<_;g+=d)f[g]<h&&(f[g]+=360);return f}}this.fromLonLatTransform_=getTransform(n,t);const a=applyTransform([this.minLon_,this.minLat_,this.maxLon_,this.maxLat_],this.fromLonLatTransform_,void 0,8);this.minX_=a[0],this.maxX_=a[2],this.minY_=a[1],this.maxY_=a[3],this.bottomLeft_=this.fromLonLatTransform_([this.minLon_,this.minLat_]),this.bottomRight_=this.fromLonLatTransform_([this.maxLon_,this.minLat_]),this.topLeft_=this.fromLonLatTransform_([this.minLon_,this.maxLat_]),this.topRight_=this.fromLonLatTransform_([this.maxLon_,this.maxLat_]),this.projectionCenterLonLat_=this.toLonLatTransform_(getCenter(t.getExtent())),isNaN(this.projectionCenterLonLat_[1])&&(this.projectionCenterLonLat_[1]=Math.abs(this.maxLat_)>=Math.abs(this.minLat_)?this.maxLat_:this.minLat_),this.projection_=t}}function create$1(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}function fromTransform(l,t){return l[0]=t[0],l[1]=t[1],l[4]=t[2],l[5]=t[3],l[12]=t[4],l[13]=t[5],l}function orthographic(l,t,n,s,o,a,h){h=h??create$1();const c=1/(l-t),u=1/(n-s),d=1/(o-a);return h[0]=-2*c,h[1]=0,h[2]=0,h[3]=0,h[4]=0,h[5]=-2*u,h[6]=0,h[7]=0,h[8]=0,h[9]=0,h[10]=2*d,h[11]=0,h[12]=(l+t)*c,h[13]=(s+n)*u,h[14]=(a+o)*d,h[15]=1,h}function scale(l,t,n,s,o){return o=o??create$1(),o[0]=l[0]*t,o[1]=l[1]*t,o[2]=l[2]*t,o[3]=l[3]*t,o[4]=l[4]*n,o[5]=l[5]*n,o[6]=l[6]*n,o[7]=l[7]*n,o[8]=l[8]*s,o[9]=l[9]*s,o[10]=l[10]*s,o[11]=l[11]*s,o[12]=l[12],o[13]=l[13],o[14]=l[14],o[15]=l[15],o}function translate(l,t,n,s,o){o=o??create$1();let a,h,c,u,d,f,g,_,m,p,x,y;return l===o?(o[12]=l[0]*t+l[4]*n+l[8]*s+l[12],o[13]=l[1]*t+l[5]*n+l[9]*s+l[13],o[14]=l[2]*t+l[6]*n+l[10]*s+l[14],o[15]=l[3]*t+l[7]*n+l[11]*s+l[15]):(a=l[0],h=l[1],c=l[2],u=l[3],d=l[4],f=l[5],g=l[6],_=l[7],m=l[8],p=l[9],x=l[10],y=l[11],o[0]=a,o[1]=h,o[2]=c,o[3]=u,o[4]=d,o[5]=f,o[6]=g,o[7]=_,o[8]=m,o[9]=p,o[10]=x,o[11]=y,o[12]=a*t+d*n+m*s+l[12],o[13]=h*t+f*n+p*s+l[13],o[14]=c*t+g*n+x*s+l[14],o[15]=u*t+_*n+y*s+l[15]),o}function translation(l,t,n,s){return s=s??create$1(),s[0]=1,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=1,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=1,s[11]=0,s[12]=l,s[13]=t,s[14]=n,s[15]=1,s}const ARRAY_BUFFER=34962,ELEMENT_ARRAY_BUFFER=34963,STATIC_DRAW=35044,DYNAMIC_DRAW=35048,UNSIGNED_BYTE=5121,UNSIGNED_SHORT=5123,UNSIGNED_INT=5125,FLOAT=5126,CONTEXT_IDS=["experimental-webgl","webgl","webkit-3d","moz-webgl"];function getContext(l,t){t=Object.assign({preserveDrawingBuffer:!0,antialias:!SAFARI_BUG_237906},t);const n=CONTEXT_IDS.length;for(let s=0;s<n;++s)try{const o=l.getContext(CONTEXT_IDS[s],t);if(o)return o}catch{}return null}const BufferUsage={STATIC_DRAW};class WebGLArrayBuffer{constructor(t,n){this.array_=null,this.type_=t,assert(t===ARRAY_BUFFER||t===ELEMENT_ARRAY_BUFFER,"A `WebGLArrayBuffer` must either be of type `ELEMENT_ARRAY_BUFFER` or `ARRAY_BUFFER`"),this.usage_=n!==void 0?n:BufferUsage.STATIC_DRAW}ofSize(t){return this.array_=new(getArrayClassForType(this.type_))(t),this}fromArray(t){return this.array_=getArrayClassForType(this.type_).from(t),this}fromArrayBuffer(t){return this.array_=new(getArrayClassForType(this.type_))(t),this}getType(){return this.type_}getArray(){return this.array_}setArray(t){const n=getArrayClassForType(this.type_);if(!(t instanceof n))throw new Error(`Expected ${n}`);this.array_=t}getUsage(){return this.usage_}getSize(){return this.array_?this.array_.length:0}}function getArrayClassForType(l){switch(l){case ARRAY_BUFFER:return Float32Array;case ELEMENT_ARRAY_BUFFER:return Uint32Array;default:return Float32Array}}const ContextEventType={LOST:"webglcontextlost",RESTORED:"webglcontextrestored"},DEFAULT_VERTEX_SHADER=`
  precision mediump float;

  attribute vec2 a_position;
  varying vec2 v_texCoord;
  varying vec2 v_screenCoord;

  uniform vec2 u_screenSize;

  void main() {
    v_texCoord = a_position * 0.5 + 0.5;
    v_screenCoord = v_texCoord * u_screenSize;
    gl_Position = vec4(a_position, 0.0, 1.0);
  }
`,DEFAULT_FRAGMENT_SHADER=`
  precision mediump float;

  uniform sampler2D u_image;
  uniform float u_opacity;

  varying vec2 v_texCoord;

  void main() {
    gl_FragColor = texture2D(u_image, v_texCoord) * u_opacity;
  }
`;class WebGLPostProcessingPass{constructor(t){this.gl_=t.webGlContext;const n=this.gl_;this.scaleRatio_=t.scaleRatio||1,this.renderTargetTexture_=n.createTexture(),this.renderTargetTextureSize_=null,this.frameBuffer_=n.createFramebuffer(),this.depthBuffer_=n.createRenderbuffer();const s=n.createShader(n.VERTEX_SHADER);n.shaderSource(s,t.vertexShader||DEFAULT_VERTEX_SHADER),n.compileShader(s);const o=n.createShader(n.FRAGMENT_SHADER);n.shaderSource(o,t.fragmentShader||DEFAULT_FRAGMENT_SHADER),n.compileShader(o),this.renderTargetProgram_=n.createProgram(),n.attachShader(this.renderTargetProgram_,s),n.attachShader(this.renderTargetProgram_,o),n.linkProgram(this.renderTargetProgram_),this.renderTargetVerticesBuffer_=n.createBuffer();const a=[-1,-1,1,-1,-1,1,1,-1,1,1,-1,1];n.bindBuffer(n.ARRAY_BUFFER,this.renderTargetVerticesBuffer_),n.bufferData(n.ARRAY_BUFFER,new Float32Array(a),n.STATIC_DRAW),this.renderTargetAttribLocation_=n.getAttribLocation(this.renderTargetProgram_,"a_position"),this.renderTargetUniformLocation_=n.getUniformLocation(this.renderTargetProgram_,"u_screenSize"),this.renderTargetOpacityLocation_=n.getUniformLocation(this.renderTargetProgram_,"u_opacity"),this.renderTargetTextureLocation_=n.getUniformLocation(this.renderTargetProgram_,"u_image"),this.uniforms_=[],t.uniforms&&Object.keys(t.uniforms).forEach(h=>{this.uniforms_.push({value:t.uniforms[h],location:n.getUniformLocation(this.renderTargetProgram_,h)})})}getRenderTargetTexture(){return this.renderTargetTexture_}getGL(){return this.gl_}init(t){const n=this.getGL(),s=[n.drawingBufferWidth*this.scaleRatio_,n.drawingBufferHeight*this.scaleRatio_];if(n.bindFramebuffer(n.FRAMEBUFFER,this.getFrameBuffer()),n.bindRenderbuffer(n.RENDERBUFFER,this.getDepthBuffer()),n.viewport(0,0,s[0],s[1]),!this.renderTargetTextureSize_||this.renderTargetTextureSize_[0]!==s[0]||this.renderTargetTextureSize_[1]!==s[1]){this.renderTargetTextureSize_=s;const o=0,a=n.RGBA,h=0,c=n.RGBA,u=n.UNSIGNED_BYTE,d=null;n.bindTexture(n.TEXTURE_2D,this.renderTargetTexture_),n.texImage2D(n.TEXTURE_2D,o,a,s[0],s[1],h,c,u,d),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.LINEAR),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,this.renderTargetTexture_,0),n.renderbufferStorage(n.RENDERBUFFER,n.DEPTH_COMPONENT16,s[0],s[1]),n.framebufferRenderbuffer(n.FRAMEBUFFER,n.DEPTH_ATTACHMENT,n.RENDERBUFFER,this.depthBuffer_)}}apply(t,n,s,o){const a=this.getGL(),h=t.size;if(a.bindFramebuffer(a.FRAMEBUFFER,n?n.getFrameBuffer():null),a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,this.renderTargetTexture_),!n){const u=getUid(a.canvas);if(!t.renderTargets[u]){const d=a.getContextAttributes();d&&d.preserveDrawingBuffer&&(a.clearColor(0,0,0,0),a.clearDepth(1),a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT)),t.renderTargets[u]=!0}}a.disable(a.DEPTH_TEST),a.enable(a.BLEND),a.blendFunc(a.ONE,a.ONE_MINUS_SRC_ALPHA),a.viewport(0,0,a.drawingBufferWidth,a.drawingBufferHeight),a.bindBuffer(a.ARRAY_BUFFER,this.renderTargetVerticesBuffer_),a.useProgram(this.renderTargetProgram_),a.enableVertexAttribArray(this.renderTargetAttribLocation_),a.vertexAttribPointer(this.renderTargetAttribLocation_,2,a.FLOAT,!1,0,0),a.uniform2f(this.renderTargetUniformLocation_,h[0],h[1]),a.uniform1i(this.renderTargetTextureLocation_,0);const c=t.layerStatesArray[t.layerIndex].opacity;a.uniform1f(this.renderTargetOpacityLocation_,c),this.applyUniforms(t),s&&s(a,t),a.drawArrays(a.TRIANGLES,0,6),o&&o(a,t)}getFrameBuffer(){return this.frameBuffer_}getDepthBuffer(){return this.depthBuffer_}applyUniforms(t){const n=this.getGL();let s,o=1;this.uniforms_.forEach(function(a){if(s=typeof a.value=="function"?a.value(t):a.value,s instanceof HTMLCanvasElement||s instanceof ImageData)a.texture||(a.texture=n.createTexture()),n.activeTexture(n[`TEXTURE${o}`]),n.bindTexture(n.TEXTURE_2D,a.texture),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.LINEAR),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),s instanceof ImageData?n.texImage2D(n.TEXTURE_2D,0,n.RGBA,n.RGBA,s.width,s.height,0,n.UNSIGNED_BYTE,new Uint8Array(s.data)):n.texImage2D(n.TEXTURE_2D,0,n.RGBA,n.RGBA,n.UNSIGNED_BYTE,s),n.uniform1i(a.location,o++);else if(Array.isArray(s))switch(s.length){case 2:n.uniform2f(a.location,s[0],s[1]);return;case 3:n.uniform3f(a.location,s[0],s[1],s[2]);return;case 4:n.uniform4f(a.location,s[0],s[1],s[2],s[3]);return;default:return}else typeof s=="number"&&n.uniform1f(a.location,s)})}}const DefaultUniform={PROJECTION_MATRIX:"u_projectionMatrix",SCREEN_TO_WORLD_MATRIX:"u_screenToWorldMatrix",TIME:"u_time",ZOOM:"u_zoom",RESOLUTION:"u_resolution",ROTATION:"u_rotation",VIEWPORT_SIZE_PX:"u_viewportSizePx",PIXEL_RATIO:"u_pixelRatio",HIT_DETECTION:"u_hitDetection"},AttributeType={UNSIGNED_BYTE,UNSIGNED_SHORT,UNSIGNED_INT,FLOAT},canvasCache={};function getSharedCanvasCacheKey(l){return"shared/"+l}let uniqueCanvasCacheKeyCount=0;function getUniqueCanvasCacheKey(){const l="unique/"+uniqueCanvasCacheKeyCount;return uniqueCanvasCacheKeyCount+=1,l}function getOrCreateContext(l){let t=canvasCache[l];if(!t){const n=document.createElement("canvas");n.width=1,n.height=1,n.style.position="absolute",n.style.left="0",t={users:0,context:getContext(n)},canvasCache[l]=t}return t.users+=1,t.context}function releaseCanvas(l){const t=canvasCache[l];if(!t||(t.users-=1,t.users>0))return;const n=t.context,s=n.getExtension("WEBGL_lose_context");s&&s.loseContext();const o=n.canvas;o.width=1,o.height=1,delete canvasCache[l]}class WebGLHelper extends Disposable{constructor(t){super(),t=t||{},this.boundHandleWebGLContextLost_=this.handleWebGLContextLost.bind(this),this.boundHandleWebGLContextRestored_=this.handleWebGLContextRestored.bind(this),this.canvasCacheKey_=t.canvasCacheKey?getSharedCanvasCacheKey(t.canvasCacheKey):getUniqueCanvasCacheKey(),this.gl_=getOrCreateContext(this.canvasCacheKey_),this.bufferCache_={},this.extensionCache_={},this.currentProgram_=null,this.needsToBeRecreated_=!1;const n=this.gl_.canvas;n.addEventListener(ContextEventType.LOST,this.boundHandleWebGLContextLost_),n.addEventListener(ContextEventType.RESTORED,this.boundHandleWebGLContextRestored_),this.offsetRotateMatrix_=create$2(),this.offsetScaleMatrix_=create$2(),this.tmpMat4_=create$1(),this.uniformLocationsByProgram_={},this.attribLocationsByProgram_={},this.uniforms_=[],t.uniforms&&this.setUniforms(t.uniforms),this.postProcessPasses_=t.postProcesses?t.postProcesses.map(s=>new WebGLPostProcessingPass({webGlContext:this.gl_,scaleRatio:s.scaleRatio,vertexShader:s.vertexShader,fragmentShader:s.fragmentShader,uniforms:s.uniforms})):[new WebGLPostProcessingPass({webGlContext:this.gl_})],this.shaderCompileErrors_=null,this.startTime_=Date.now(),this.maxAttributeCount_=this.gl_.getParameter(this.gl_.MAX_VERTEX_ATTRIBS)}setUniforms(t){this.uniforms_=[],this.addUniforms(t)}addUniforms(t){for(const n in t)this.uniforms_.push({name:n,value:t[n]})}canvasCacheKeyMatches(t){return this.canvasCacheKey_===getSharedCanvasCacheKey(t)}getExtension(t){if(t in this.extensionCache_)return this.extensionCache_[t];const n=this.gl_.getExtension(t);return this.extensionCache_[t]=n,n}getInstancedRenderingExtension_(){const t=this.getExtension("ANGLE_instanced_arrays");return assert(!!t,"WebGL extension 'ANGLE_instanced_arrays' is required for vector rendering"),t}bindBuffer(t){const n=this.gl_,s=getUid(t);let o=this.bufferCache_[s];if(!o){const a=n.createBuffer();o={buffer:t,webGlBuffer:a},this.bufferCache_[s]=o}n.bindBuffer(t.getType(),o.webGlBuffer)}flushBufferData(t){const n=this.gl_;this.bindBuffer(t),n.bufferData(t.getType(),t.getArray(),t.getUsage())}deleteBuffer(t){const n=getUid(t);delete this.bufferCache_[n]}disposeInternal(){const t=this.gl_.canvas;t.removeEventListener(ContextEventType.LOST,this.boundHandleWebGLContextLost_),t.removeEventListener(ContextEventType.RESTORED,this.boundHandleWebGLContextRestored_),releaseCanvas(this.canvasCacheKey_),delete this.gl_}prepareDraw(t,n,s){const o=this.gl_,a=this.getCanvas(),h=t.size,c=t.pixelRatio;(a.width!==h[0]*c||a.height!==h[1]*c)&&(a.width=h[0]*c,a.height=h[1]*c,a.style.width=h[0]+"px",a.style.height=h[1]+"px");for(let u=this.postProcessPasses_.length-1;u>=0;u--)this.postProcessPasses_[u].init(t);o.bindTexture(o.TEXTURE_2D,null),o.clearColor(0,0,0,0),o.depthRange(0,1),o.clearDepth(1),o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT),o.enable(o.BLEND),o.blendFunc(o.ONE,n?o.ZERO:o.ONE_MINUS_SRC_ALPHA),s?(o.enable(o.DEPTH_TEST),o.depthFunc(o.LEQUAL)):o.disable(o.DEPTH_TEST)}bindFrameBuffer(t,n){const s=this.getGL();s.bindFramebuffer(s.FRAMEBUFFER,t),n&&s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.TEXTURE_2D,n,0)}bindInitialFrameBuffer(){const t=this.getGL(),n=this.postProcessPasses_[0].getFrameBuffer();t.bindFramebuffer(t.FRAMEBUFFER,n);const s=this.postProcessPasses_[0].getRenderTargetTexture();t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,s,0)}bindTexture(t,n,s){const o=this.gl_;o.activeTexture(o.TEXTURE0+n),o.bindTexture(o.TEXTURE_2D,t),o.uniform1i(this.getUniformLocation(s),n)}bindAttribute(t,n,s){const o=this.getGL();this.bindBuffer(t);const a=this.getAttributeLocation(n);o.enableVertexAttribArray(a),o.vertexAttribPointer(a,s,o.FLOAT,!1,0,0)}prepareDrawToRenderTarget(t,n,s,o){const a=this.gl_,h=n.getSize();a.bindFramebuffer(a.FRAMEBUFFER,n.getFramebuffer()),a.bindRenderbuffer(a.RENDERBUFFER,n.getDepthbuffer()),a.viewport(0,0,h[0],h[1]),a.bindTexture(a.TEXTURE_2D,n.getTexture()),a.clearColor(0,0,0,0),a.depthRange(0,1),a.clearDepth(1),a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT),a.enable(a.BLEND),a.blendFunc(a.ONE,s?a.ZERO:a.ONE_MINUS_SRC_ALPHA),o?(a.enable(a.DEPTH_TEST),a.depthFunc(a.LEQUAL)):a.disable(a.DEPTH_TEST)}drawElements(t,n){const s=this.gl_;this.getExtension("OES_element_index_uint");const o=s.UNSIGNED_INT,a=4,h=n-t,c=t*a;s.drawElements(s.TRIANGLES,h,o,c)}drawElementsInstanced(t,n,s){const o=this.gl_;this.getExtension("OES_element_index_uint");const a=this.getInstancedRenderingExtension_(),h=o.UNSIGNED_INT,c=4,u=n-t,d=t*c;a.drawElementsInstancedANGLE(o.TRIANGLES,u,h,d,s);for(let f=0;f<this.maxAttributeCount_;f++)a.vertexAttribDivisorANGLE(f,0)}finalizeDraw(t,n,s){for(let o=0,a=this.postProcessPasses_.length;o<a;o++)o===a-1?this.postProcessPasses_[o].apply(t,null,n,s):this.postProcessPasses_[o].apply(t,this.postProcessPasses_[o+1])}getCanvas(){return this.gl_.canvas}getGL(){return this.gl_}applyFrameState(t){const n=t.size,s=t.viewState.rotation,o=t.pixelRatio;this.setUniformFloatValue(DefaultUniform.TIME,(Date.now()-this.startTime_)*.001),this.setUniformFloatValue(DefaultUniform.ZOOM,t.viewState.zoom),this.setUniformFloatValue(DefaultUniform.RESOLUTION,t.viewState.resolution),this.setUniformFloatValue(DefaultUniform.PIXEL_RATIO,o),this.setUniformFloatVec2(DefaultUniform.VIEWPORT_SIZE_PX,[n[0],n[1]]),this.setUniformFloatValue(DefaultUniform.ROTATION,s)}applyHitDetectionUniform(t){const n=this.getUniformLocation(DefaultUniform.HIT_DETECTION);this.getGL().uniform1i(n,t?1:0),t&&this.setUniformFloatValue(DefaultUniform.PIXEL_RATIO,.5)}applyUniforms(t){const n=this.gl_;let s,o=0;this.uniforms_.forEach(a=>{if(s=typeof a.value=="function"?a.value(t):a.value,s instanceof HTMLCanvasElement||s instanceof HTMLImageElement||s instanceof ImageData||s instanceof WebGLTexture){s instanceof WebGLTexture&&!a.texture?(a.prevValue=void 0,a.texture=s):a.texture||(a.prevValue=void 0,a.texture=n.createTexture()),this.bindTexture(a.texture,o,a.name),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.LINEAR),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE);const h=!(s instanceof HTMLImageElement)||s.complete;!(s instanceof WebGLTexture)&&h&&a.prevValue!==s&&(a.prevValue=s,n.texImage2D(n.TEXTURE_2D,0,n.RGBA,n.RGBA,n.UNSIGNED_BYTE,s)),o++}else if(Array.isArray(s)&&s.length===6)this.setUniformMatrixValue(a.name,fromTransform(this.tmpMat4_,s));else if(Array.isArray(s)&&s.length<=4)switch(s.length){case 2:n.uniform2f(this.getUniformLocation(a.name),s[0],s[1]);return;case 3:n.uniform3f(this.getUniformLocation(a.name),s[0],s[1],s[2]);return;case 4:n.uniform4f(this.getUniformLocation(a.name),s[0],s[1],s[2],s[3]);return;default:return}else typeof s=="number"&&n.uniform1f(this.getUniformLocation(a.name),s)})}useProgram(t,n){this.disableAllAttributes_(),this.gl_.useProgram(t),this.currentProgram_=t,n&&(this.applyFrameState(n),this.applyUniforms(n))}compileShader(t,n){const s=this.gl_,o=s.createShader(n);return s.shaderSource(o,t),s.compileShader(o),o}getProgram(t,n){const s=this.gl_,o=this.compileShader(t,s.FRAGMENT_SHADER),a=this.compileShader(n,s.VERTEX_SHADER),h=s.createProgram();if(s.attachShader(h,o),s.attachShader(h,a),s.linkProgram(h),!s.getShaderParameter(o,s.COMPILE_STATUS)){const c=`Fragment shader compilation failed: ${s.getShaderInfoLog(o)}`;throw new Error(c)}if(s.deleteShader(o),!s.getShaderParameter(a,s.COMPILE_STATUS)){const c=`Vertex shader compilation failed: ${s.getShaderInfoLog(a)}`;throw new Error(c)}if(s.deleteShader(a),!s.getProgramParameter(h,s.LINK_STATUS)){const c=`GL program linking failed: ${s.getProgramInfoLog(h)}`;throw new Error(c)}return h}getUniformLocation(t){const n=getUid(this.currentProgram_);return this.uniformLocationsByProgram_[n]===void 0&&(this.uniformLocationsByProgram_[n]={}),this.uniformLocationsByProgram_[n][t]===void 0&&(this.uniformLocationsByProgram_[n][t]=this.gl_.getUniformLocation(this.currentProgram_,t)),this.uniformLocationsByProgram_[n][t]}getAttributeLocation(t){const n=getUid(this.currentProgram_);return this.attribLocationsByProgram_[n]===void 0&&(this.attribLocationsByProgram_[n]={}),this.attribLocationsByProgram_[n][t]===void 0&&(this.attribLocationsByProgram_[n][t]=this.gl_.getAttribLocation(this.currentProgram_,t)),this.attribLocationsByProgram_[n][t]}makeProjectionTransform(t,n){const s=t.size,o=t.viewState.rotation,a=t.viewState.resolution,h=t.viewState.center;return compose(n,0,0,2/(a*s[0]),2/(a*s[1]),-o,-h[0],-h[1]),n}setUniformFloatValue(t,n){this.gl_.uniform1f(this.getUniformLocation(t),n)}setUniformFloatVec2(t,n){this.gl_.uniform2fv(this.getUniformLocation(t),n)}setUniformFloatVec4(t,n){this.gl_.uniform4fv(this.getUniformLocation(t),n)}setUniformMatrixValue(t,n){this.gl_.uniformMatrix4fv(this.getUniformLocation(t),!1,n)}disableAllAttributes_(){for(let t=0;t<this.maxAttributeCount_;t++)this.gl_.disableVertexAttribArray(t)}enableAttributeArray_(t,n,s,o,a,h){const c=this.getAttributeLocation(t);c<0||(this.gl_.enableVertexAttribArray(c),this.gl_.vertexAttribPointer(c,n,s,!1,o,a),h&&this.getInstancedRenderingExtension_().vertexAttribDivisorANGLE(c,1))}enableAttributes_(t,n){const s=computeAttributesStride(t);let o=0;for(let a=0;a<t.length;a++){const h=t[a];h.name&&this.enableAttributeArray_(h.name,h.size,h.type||FLOAT,s,o,n),o+=h.size*getByteSizeFromType(h.type)}}enableAttributes(t){this.enableAttributes_(t,!1)}enableAttributesInstanced(t){this.enableAttributes_(t,!0)}handleWebGLContextLost(t){clear(this.bufferCache_),this.currentProgram_=null,t.preventDefault()}handleWebGLContextRestored(){this.needsToBeRecreated_=!0}needsToBeRecreated(){return this.needsToBeRecreated_}createTexture(t,n,s,o){const a=this.gl_;s=s||a.createTexture();const h=o?a.NEAREST:a.LINEAR;a.bindTexture(a.TEXTURE_2D,s),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,h),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,h),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE);const c=0,u=a.RGBA,d=0,f=a.RGBA,g=a.UNSIGNED_BYTE;return n instanceof Uint8Array?a.texImage2D(a.TEXTURE_2D,c,u,t[0],t[1],d,f,g,n):n?a.texImage2D(a.TEXTURE_2D,c,u,f,g,n):a.texImage2D(a.TEXTURE_2D,c,u,t[0],t[1],d,f,g,null),s}}function computeAttributesStride(l){let t=0;for(let n=0;n<l.length;n++){const s=l[n];t+=s.size*getByteSizeFromType(s.type)}return t}function getByteSizeFromType(l){switch(l){case AttributeType.UNSIGNED_BYTE:return Uint8Array.BYTES_PER_ELEMENT;case AttributeType.UNSIGNED_SHORT:return Uint16Array.BYTES_PER_ELEMENT;case AttributeType.UNSIGNED_INT:return Uint32Array.BYTES_PER_ELEMENT;case AttributeType.FLOAT:default:return Float32Array.BYTES_PER_ELEMENT}}class BaseTileRepresentation extends Target{constructor(t){super(),this.tile,this.handleTileChange_=this.handleTileChange_.bind(this),this.gutter=t.gutter||0,this.helper=t.helper,this.loaded=!1,this.ready=!1}setTile(t){if(t!==this.tile)if(this.tile&&this.tile.removeEventListener(EventType$1.CHANGE,this.handleTileChange_),this.tile=t,this.loaded=t.getState()===TileState.LOADED,this.loaded)this.uploadTile();else{if(t instanceof ImageTile){const n=t.getImage();n instanceof Image&&!n.crossOrigin&&(n.crossOrigin="anonymous")}t.addEventListener(EventType$1.CHANGE,this.handleTileChange_)}}uploadTile(){abstract()}setReady(){this.ready=!0,this.dispatchEvent(EventType$1.CHANGE)}handleTileChange_(){this.tile.getState()===TileState.LOADED&&(this.loaded=!0,this.uploadTile())}setHelper(t){this.helper=t,this.helper&&this.loaded&&this.uploadTile()}disposeInternal(){this.setHelper(null),this.tile.removeEventListener(EventType$1.CHANGE,this.handleTileChange_)}}function bindAndConfigure(l,t,n){const s=n?l.LINEAR:l.NEAREST;l.bindTexture(l.TEXTURE_2D,t),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_WRAP_S,l.CLAMP_TO_EDGE),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_WRAP_T,l.CLAMP_TO_EDGE),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_MIN_FILTER,s),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_MAG_FILTER,s)}function uploadImageTexture(l,t,n,s){bindAndConfigure(l,t,s),l.texImage2D(l.TEXTURE_2D,0,l.RGBA,l.RGBA,l.UNSIGNED_BYTE,n)}function uploadDataTexture(l,t,n,s,o,a){const h=l.getGL();let c,u;n instanceof Float32Array?(c=h.FLOAT,l.getExtension("OES_texture_float"),u=l.getExtension("OES_texture_float_linear")!==null):(c=h.UNSIGNED_BYTE,u=!0),bindAndConfigure(h,t,a&&u);const d=n.byteLength/s[1];let f=1;d%8===0?f=8:d%4===0?f=4:d%2===0&&(f=2);let g;switch(o){case 1:{g=h.LUMINANCE;break}case 2:{g=h.LUMINANCE_ALPHA;break}case 3:{g=h.RGB;break}case 4:{g=h.RGBA;break}default:throw new Error(`Unsupported number of bands: ${o}`)}const _=h.getParameter(h.UNPACK_ALIGNMENT);h.pixelStorei(h.UNPACK_ALIGNMENT,f),h.texImage2D(h.TEXTURE_2D,0,g,s[0],s[1],0,g,c,n),h.pixelStorei(h.UNPACK_ALIGNMENT,_)}let pixelContext=null;function createPixelContext(){pixelContext=createCanvasContext2D(1,1,void 0,{willReadFrequently:!0})}class TileTexture extends BaseTileRepresentation{constructor(t){super(t),this.textures=[],this.renderSize_=toSize(t.grid.getTileSize(t.tile.tileCoord[0])),this.bandCount=NaN;const n=new WebGLArrayBuffer(ARRAY_BUFFER,STATIC_DRAW);n.fromArray([0,1,1,1,1,0,0,0]),this.helper.flushBufferData(n),this.coords=n,this.setTile(t.tile)}setHelper(t){var s;const n=(s=this.helper)==null?void 0:s.getGL();if(n){this.helper.deleteBuffer(this.coords);for(let o=0;o<this.textures.length;++o)n.deleteTexture(this.textures[o])}super.setHelper(t),t&&t.flushBufferData(this.coords)}uploadTile(){const t=this.helper,n=t.getGL(),s=this.tile;this.textures.length=0;let o;s instanceof ImageTile||s instanceof ReprojTile?o=s.getImage():o=s.getData();const a=asImageLike(o);if(a){const S=n.createTexture();this.textures.push(S),this.bandCount=4,uploadImageTexture(n,S,a,s.interpolate),this.setReady();return}o=asArrayLike(o);const h=s.getSize(),c=[h[0]+2*this.gutter,h[1]+2*this.gutter],u=o instanceof Float32Array,d=c[0]*c[1],f=u?Float32Array:Uint8Array,g=f.BYTES_PER_ELEMENT,_=o.byteLength/c[1];this.bandCount=Math.floor(_/g/c[0]);const m=Math.ceil(this.bandCount/4);if(m===1){const S=n.createTexture();this.textures.push(S),uploadDataTexture(t,S,o,c,this.bandCount,s.interpolate),this.setReady();return}const p=new Array(m);for(let S=0;S<m;++S){const C=n.createTexture();this.textures.push(C);const P=S<m-1?4:(this.bandCount-1)%4+1;p[S]=new f(d*P)}let x=0,y=0;const T=c[0]*this.bandCount;for(let S=0;S<c[1];++S){for(let C=0;C<T;++C){const P=o[y+C],w=Math.floor(x/this.bandCount),I=C%this.bandCount,O=Math.floor(I/4),N=p[O],k=N.length/d,D=I%4;N[w*k+D]=P,++x}y+=_/g}for(let S=0;S<m;++S){const C=this.textures[S],P=p[S],w=P.length/d;uploadDataTexture(t,C,P,c,w,s.interpolate)}this.setReady()}getImagePixelData_(t,n,s){const o=this.gutter,a=this.renderSize_[0],h=this.renderSize_[1];pixelContext||createPixelContext(),pixelContext.clearRect(0,0,1,1);const c=t.width,u=t.height,d=c-2*o,f=u-2*o,g=o+Math.floor(d*(n/a)),_=o+Math.floor(f*(s/h));let m;try{pixelContext.drawImage(t,g,_,1,1,0,0,1,1),m=pixelContext.getImageData(0,0,1,1).data}catch{return pixelContext=null,null}return m}getArrayPixelData_(t,n,s,o){const a=this.gutter,h=this.renderSize_[0],c=this.renderSize_[1],u=n[0],d=n[1],f=u+2*a,g=d+2*a,_=a+Math.floor(u*(s/h)),m=a+Math.floor(d*(o/c));if(t instanceof DataView){const x=t.byteLength/(f*g),y=x*(m*f+_),T=t.buffer.slice(y,y+x);return new DataView(T)}const p=this.bandCount*(m*f+_);return t.slice(p,p+this.bandCount)}getPixelData(t,n){if(!this.loaded)return null;if(this.tile instanceof DataTile){const s=this.tile.getData(),o=asArrayLike(s);if(o){const a=this.tile.getSize();return this.getArrayPixelData_(o,a,t,n)}return this.getImagePixelData_(asImageLike(s),t,n)}return this.getImagePixelData_(this.tile.getImage(),t,n)}}class WebGLLayerRenderer extends LayerRenderer{constructor(t,n){super(t),n=n||{},this.inversePixelTransform_=create$2(),this.postProcesses_=n.postProcesses,this.uniforms_=n.uniforms,this.helper,this.onMapChanged_=()=>{this.clearCache(),this.removeHelper()},t.addChangeListener(LayerProperty.MAP,this.onMapChanged_),this.dispatchPreComposeEvent=this.dispatchPreComposeEvent.bind(this),this.dispatchPostComposeEvent=this.dispatchPostComposeEvent.bind(this)}dispatchPreComposeEvent(t,n){const s=this.getLayer();if(s.hasListener(RenderEventType.PRECOMPOSE)){const o=new RenderEvent(RenderEventType.PRECOMPOSE,void 0,n,t);s.dispatchEvent(o)}}dispatchPostComposeEvent(t,n){const s=this.getLayer();if(s.hasListener(RenderEventType.POSTCOMPOSE)){const o=new RenderEvent(RenderEventType.POSTCOMPOSE,void 0,n,t);s.dispatchEvent(o)}}reset(t){this.uniforms_=t.uniforms,this.helper&&this.helper.setUniforms(this.uniforms_)}removeHelper(){this.helper&&(this.helper.dispose(),delete this.helper)}prepareFrame(t){if(this.getLayer().getRenderSource()){let n=!0,s=-1,o;for(let h=0,c=t.layerStatesArray.length;h<c;h++){const u=t.layerStatesArray[h].layer,d=u.getRenderer();if(!(d instanceof WebGLLayerRenderer)){n=!0;continue}const f=u.getClassName();if((n||f!==o)&&(s+=1,n=!1),o=f,d===this)break}const a="map/"+t.mapId+"/group/"+s;(!this.helper||!this.helper.canvasCacheKeyMatches(a)||this.helper.needsToBeRecreated())&&(this.removeHelper(),this.helper=new WebGLHelper({postProcesses:this.postProcesses_,uniforms:this.uniforms_,canvasCacheKey:a}),o&&(this.helper.getCanvas().className=o),this.afterHelperCreated())}return this.prepareFrameInternal(t)}afterHelperCreated(){}prepareFrameInternal(t){return!0}clearCache(){}disposeInternal(){var t;this.clearCache(),this.removeHelper(),(t=this.getLayer())==null||t.removeChangeListener(LayerProperty.MAP,this.onMapChanged_),super.disposeInternal()}dispatchRenderEvent_(t,n,s){const o=this.getLayer();if(o.hasListener(t)){compose(this.inversePixelTransform_,0,0,s.pixelRatio,-s.pixelRatio,0,0,-s.size[1]);const a=new RenderEvent(t,this.inversePixelTransform_,s,n);o.dispatchEvent(a)}}preRender(t,n){this.dispatchRenderEvent_(RenderEventType.PRERENDER,t,n)}postRender(t,n){this.dispatchRenderEvent_(RenderEventType.POSTRENDER,t,n)}}const Uniforms$2={TILE_TRANSFORM:"u_tileTransform",TRANSITION_ALPHA:"u_transitionAlpha",DEPTH:"u_depth",RENDER_EXTENT:"u_renderExtent",PATTERN_ORIGIN:"u_patternOrigin",RESOLUTION:"u_resolution",ZOOM:"u_zoom",GLOBAL_ALPHA:"u_globalAlpha",PROJECTION_MATRIX:"u_projectionMatrix",SCREEN_TO_WORLD_MATRIX:"u_screenToWorldMatrix"};function depthForZ(l){return 1/(l+2)}function newTileRepresentationLookup(){return{tileIds:new Set,representationsByZ:{}}}function lookupHasTile(l,t){return l.tileIds.has(getUid(t))}function addTileRepresentationToLookup(l,t,n){const s=l.representationsByZ;n in s||(s[n]=new Set),s[n].add(t),l.tileIds.add(getUid(t.tile))}function getRenderExtent(l,t){const n=l.layerStatesArray[l.layerIndex];n.extent&&(t=getIntersection(t,fromUserExtent(n.extent,l.viewState.projection)));const s=n.layer.getRenderSource();if(!s.getWrapX()){const o=s.getTileGridForProjection(l.viewState.projection).getExtent();o&&(t=getIntersection(t,o))}return t}function getCacheKey(l,t){return`${getUid(l)},${l.getKey()},${l.getRevision()},${getKey(t)}`}class WebGLBaseTileLayerRenderer extends WebGLLayerRenderer{constructor(t,n){super(t,{uniforms:n.uniforms,postProcesses:n.postProcesses}),this.renderComplete=!1,this.tileTransform_=create$2(),this.tempMat4=create$1(),this.tempTileRange_=new TileRange(0,0,0,0),this.tempTileCoord_=createOrUpdate(0,0,0),this.tempSize_=[0,0];const s=n.cacheSize!==void 0?n.cacheSize:512;this.tileRepresentationCache=new LRUCache(s),this.frameState=null,this.renderedProjection_=void 0}reset(t){super.reset({uniforms:t.uniforms})}prepareFrameInternal(t){this.renderedProjection_?t.viewState.projection!==this.renderedProjection_&&(this.clearCache(),this.renderedProjection_=t.viewState.projection):this.renderedProjection_=t.viewState.projection;const s=this.getLayer().getRenderSource();return!s||isEmpty(getRenderExtent(t,t.extent))?!1:s.getState()==="ready"}createTileRepresentation(t){return abstract()}enqueueTiles(t,n,s,o,a){const h=t.viewState,c=this.getLayer(),u=c.getRenderSource(),d=u.getTileGridForProjection(h.projection),f=u.getGutterForProjection(h.projection),g=getUid(u);g in t.wantedTiles||(t.wantedTiles[g]={});const _=t.wantedTiles[g],m=this.tileRepresentationCache,p=c.getMapInternal(),x=Math.max(s-a,d.getMinZoom(),d.getZForResolution(Math.min(c.getMaxResolution(),p?p.getView().getResolutionForZoom(Math.max(c.getMinZoom(),0)):d.getResolution(0)),u.zDirection)),y=h.rotation,T=y?getRotatedViewport(h.center,h.resolution,y,t.size):void 0;for(let S=s;S>=x;--S){const C=d.getTileRangeForExtentAndZ(n,S,this.tempTileRange_),P=d.getResolution(S);for(let w=C.minX;w<=C.maxX;++w)for(let I=C.minY;I<=C.maxY;++I){if(y&&!d.tileCoordIntersectsViewport([S,w,I],T))continue;const O=createOrUpdate(S,w,I,this.tempTileCoord_),N=getCacheKey(u,O);let k,D;if(m.containsKey(N)&&(k=m.get(N),D=k.tile),(!k||k.tile.key!==u.getKey())&&(D=u.getTile(S,w,I,t.pixelRatio,h.projection),!D)||lookupHasTile(o,D))continue;k?k.setTile(D):(k=this.createTileRepresentation({tile:D,grid:d,helper:this.helper,gutter:f}),m.set(N,k)),addTileRepresentationToLookup(o,k,S);const ze=D.getKey();_[ze]=!0,D.getState()===TileState.IDLE&&(t.tileQueue.isKeyQueued(ze)||t.tileQueue.enqueue([D,g,d.getTileCoordCenter(O),P]))}}}beforeTilesRender(t,n){this.helper.prepareDraw(this.frameState,!n,!0)}beforeTilesMaskRender(t){return!1}renderTile(t,n,s,o,a,h,c,u,d,f,g){}renderTileMask(t,n,s,o){}drawTile_(t,n,s,o,a,h,c){if(!n.ready)return;const d=n.tile.tileCoord,f=getKey(d),g=f in h?h[f]:1,_=c.getResolution(s),m=toSize(c.getTileSize(s),this.tempSize_),p=c.getOrigin(s),x=c.getTileCoordExtent(d),y=g<1?-1:depthForZ(s);g<1&&(t.animate=!0);const T=t.viewState,S=T.center[0],C=T.center[1],P=m[0]+2*o,w=m[1]+2*o,I=P/w,O=(S-p[0])/(m[0]*_),N=(p[1]-C)/(m[1]*_),k=T.resolution/_,D=d[1],ze=d[2];reset(this.tileTransform_),scale$3(this.tileTransform_,2/(t.size[0]*k/P),-2/(t.size[1]*k/P)),rotate$1(this.tileTransform_,T.rotation),scale$3(this.tileTransform_,1,1/I),translate$2(this.tileTransform_,(m[0]*(D-O)-o)/P,(m[1]*(ze-N)-o)/w),this.renderTile(n,this.tileTransform_,t,a,_,m,p,x,y,o,g)}renderFrame(t){this.frameState=t,this.renderComplete=!0;const n=this.helper.getGL();this.preRender(n,t);const s=t.viewState,o=this.getLayer(),a=o.getRenderSource(),h=a.getTileGridForProjection(s.projection),c=a.getGutterForProjection(s.projection),u=getRenderExtent(t,t.extent),d=h.getZForResolution(s.resolution,a.zDirection),f=newTileRepresentationLookup(),g=o.getPreload();if(t.nextExtent){const C=h.getZForResolution(s.nextResolution,a.zDirection),P=getRenderExtent(t,t.nextExtent);this.enqueueTiles(t,P,C,f,g)}this.enqueueTiles(t,u,d,f,0),g>0&&setTimeout(()=>{this.enqueueTiles(t,u,d-1,f,g-1)},0);const _={};let m=!1;const p=f.representationsByZ;if(d in p){const C=getUid(this),P=t.time;for(const w of p[d]){const I=w.tile;if(I.getState()===TileState.EMPTY)continue;const O=I.tileCoord;if(w.ready){const D=I.getAlpha(C,P);if(D===1){I.endTransition(C);continue}m=!0;const ze=getKey(O);_[ze]=D}if(this.renderComplete=!1,this.findAltTiles_(h,O,d+1,f))continue;const k=h.getMinZoom();for(let D=d-1;D>=k&&!this.findAltTiles_(h,O,D,f);--D);}}const x=Object.keys(p).map(Number).sort(descending);if(this.beforeTilesMaskRender(t))for(let C=0,P=x.length;C<P;++C){const w=x[C];for(const I of p[w]){const O=I.tile.tileCoord;if(getKey(O)in _)continue;const k=h.getTileCoordExtent(O);this.renderTileMask(I,w,k,depthForZ(w))}}this.beforeTilesRender(t,m);for(let C=0,P=x.length;C<P;++C){const w=x[C];for(const I of p[w]){const O=I.tile.tileCoord;getKey(O)in _||this.drawTile_(t,I,w,c,u,_,h)}}if(d in p)for(const C of p[d]){const P=C.tile.tileCoord;getKey(P)in _&&this.drawTile_(t,C,d,c,u,_,h)}this.beforeFinalize(t),this.helper.finalizeDraw(t,this.dispatchPreComposeEvent,this.dispatchPostComposeEvent);const T=this.helper.getCanvas();return this.tileRepresentationCache.expireCache(),this.postRender(n,t),T}beforeFinalize(t){}findAltTiles_(t,n,s,o){const a=t.getTileRangeForTileCoordAndZ(n,s,this.tempTileRange_);if(!a)return!1;let h=!0;const c=this.tileRepresentationCache,u=this.getLayer().getRenderSource();for(let d=a.minX;d<=a.maxX;++d)for(let f=a.minY;f<=a.maxY;++f){const g=getCacheKey(u,[s,d,f]);let _=!1;if(c.containsKey(g)){const m=c.get(g);m.ready&&!lookupHasTile(o,m.tile)&&(addTileRepresentationToLookup(o,m,s),_=!0)}_||(h=!1)}return h}clearCache(){super.clearCache();const t=this.tileRepresentationCache;t.forEach(n=>n.dispose()),t.clear()}afterHelperCreated(){super.afterHelperCreated(),this.tileRepresentationCache.forEach(t=>t.setHelper(this.helper))}disposeInternal(){super.disposeInternal(),delete this.frameState}}const Uniforms$1={...Uniforms$2,TILE_TEXTURE_ARRAY:"u_tileTextures",TEXTURE_PIXEL_WIDTH:"u_texturePixelWidth",TEXTURE_PIXEL_HEIGHT:"u_texturePixelHeight",TEXTURE_RESOLUTION:"u_textureResolution",TEXTURE_ORIGIN_X:"u_textureOriginX",TEXTURE_ORIGIN_Y:"u_textureOriginY"},Attributes$1={TEXTURE_COORD:"a_textureCoord"},attributeDescriptions=[{name:Attributes$1.TEXTURE_COORD,size:2,type:AttributeType.FLOAT}];class WebGLTileLayerRenderer extends WebGLBaseTileLayerRenderer{constructor(t,n){super(t,n),this.program_,this.vertexShader_=n.vertexShader,this.fragmentShader_=n.fragmentShader,this.indices_=new WebGLArrayBuffer(ELEMENT_ARRAY_BUFFER,STATIC_DRAW),this.indices_.fromArray([0,1,3,1,2,3]),this.paletteTextures_=n.paletteTextures||[]}reset(t){if(super.reset(t),this.helper){const n=this.helper.getGL();for(const s of this.paletteTextures_)s.delete(n)}if(this.vertexShader_=t.vertexShader,this.fragmentShader_=t.fragmentShader,this.paletteTextures_=t.paletteTextures||[],this.helper){this.program_=this.helper.getProgram(this.fragmentShader_,this.vertexShader_);const n=this.helper.getGL();for(const s of this.paletteTextures_)s.getTexture(n)}}afterHelperCreated(){super.afterHelperCreated();const t=this.helper.getGL();for(const n of this.paletteTextures_)n.getTexture(t);this.program_=this.helper.getProgram(this.fragmentShader_,this.vertexShader_),this.helper.flushBufferData(this.indices_)}removeHelper(){if(this.helper){const t=this.helper.getGL();for(const n of this.paletteTextures_)n.delete(t)}super.removeHelper()}createTileRepresentation(t){return new TileTexture(t)}beforeTilesRender(t,n){super.beforeTilesRender(t,n),this.helper.useProgram(this.program_,t)}renderTile(t,n,s,o,a,h,c,u,d,f,g){const _=this.helper.getGL();this.helper.bindBuffer(t.coords),this.helper.bindBuffer(this.indices_),this.helper.enableAttributes(attributeDescriptions);let m=0;for(;m<t.textures.length;){const I=`${Uniforms$1.TILE_TEXTURE_ARRAY}[${m}]`;this.helper.bindTexture(t.textures[m],m,I),++m}for(let I=0;I<this.paletteTextures_.length;++I){const O=this.paletteTextures_[I],N=O.getTexture(_);this.helper.bindTexture(N,m,O.name),++m}const p=s.viewState,x=h[0]+2*f,y=h[1]+2*f,S=t.tile.tileCoord,C=S[1],P=S[2];this.helper.setUniformMatrixValue(Uniforms$1.TILE_TRANSFORM,fromTransform(this.tempMat4,n)),this.helper.setUniformFloatValue(Uniforms$1.TRANSITION_ALPHA,g),this.helper.setUniformFloatValue(Uniforms$1.DEPTH,d);let w=o;f>0&&(w=u,getIntersection(w,o,w)),this.helper.setUniformFloatVec4(Uniforms$1.RENDER_EXTENT,w),this.helper.setUniformFloatValue(Uniforms$1.RESOLUTION,p.resolution),this.helper.setUniformFloatValue(Uniforms$1.ZOOM,p.zoom),this.helper.setUniformFloatValue(Uniforms$1.TEXTURE_PIXEL_WIDTH,x),this.helper.setUniformFloatValue(Uniforms$1.TEXTURE_PIXEL_HEIGHT,y),this.helper.setUniformFloatValue(Uniforms$1.TEXTURE_RESOLUTION,a),this.helper.setUniformFloatValue(Uniforms$1.TEXTURE_ORIGIN_X,c[0]+C*h[0]*a-f*a),this.helper.setUniformFloatValue(Uniforms$1.TEXTURE_ORIGIN_Y,c[1]-P*h[1]*a+f*a),this.helper.drawElements(0,this.indices_.getSize())}getData(t){if(!this.helper.getGL())return null;const s=this.frameState;if(!s)return null;const o=this.getLayer(),a=apply(s.pixelToCoordinateTransform,t.slice()),h=s.viewState,c=o.getExtent();if(c&&!containsCoordinate(fromUserExtent(c,h.projection),a))return null;const u=o.getSources(boundingExtent([a]),h.resolution);let d,f,g;for(d=u.length-1;d>=0;--d)if(f=u[d],f.getState()==="ready"){if(g=f.getTileGridForProjection(h.projection),f.getWrapX())break;const m=g.getExtent();if(!m||containsCoordinate(m,a))break}if(d<0)return null;const _=this.tileRepresentationCache;for(let m=g.getZForResolution(h.resolution);m>=g.getMinZoom();--m){const p=g.getTileCoordForCoordAndZ(a,m),x=getCacheKey(f,p);if(!_.containsKey(x))continue;const y=_.get(x);if(y.tile.getState()===TileState.EMPTY)return null;if(!y.loaded)continue;const S=g.getOrigin(m),C=toSize(g.getTileSize(m)),P=g.getResolution(m),w=(a[0]-S[0])/P-p[1]*C[0],I=(S[1]-a[1])/P-p[2]*C[1];return y.getPixelData(w,I)}return null}disposeInternal(){const t=this.helper;if(t){const n=t.getGL();for(const s of this.paletteTextures_)s.delete(n);this.paletteTextures_.length=0,n.deleteProgram(this.program_),delete this.program_,t.deleteBuffer(this.indices_)}super.disposeInternal(),delete this.indices_}}class PaletteTexture{constructor(t,n){this.name=t,this.data=n,this.texture_=null}getTexture(t){if(!this.texture_){const n=t.createTexture();t.bindTexture(t.TEXTURE_2D,n),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,this.data.length/4,1,0,t.RGBA,t.UNSIGNED_BYTE,this.data),this.texture_=n}return this.texture_}delete(t){this.texture_&&t.deleteTexture(this.texture_),this.texture_=null}}function computeOperatorFunctionName(l,t){return`operator_${l}_${Object.keys(t.functions).length}`}function numberToGlsl(l){const t=l.toString();return t.includes(".")?t:t+".0"}function arrayToGlsl(l){if(l.length<2||l.length>4)throw new Error("`formatArray` can only output `vec2`, `vec3` or `vec4` arrays.");return`vec${l.length}(${l.map(numberToGlsl).join(", ")})`}function colorToGlsl(l){const t=asArray(l),n=t.length>3?t[3]:1;return arrayToGlsl([t[0]/255,t[1]/255,t[2]/255,n])}function sizeToGlsl(l){const t=toSize(l);return arrayToGlsl(t)}const stringToFloatMap={};let stringToFloatCounter=0;function getStringNumberEquivalent(l){return l in stringToFloatMap||(stringToFloatMap[l]=stringToFloatCounter++),stringToFloatMap[l]}function stringToGlsl(l){return numberToGlsl(getStringNumberEquivalent(l))}function uniformNameForVariable(l){return"u_var_"+l}function newCompilationContext(){return{variables:{},properties:{},functions:{},bandCount:0,featureId:!1,geometryType:!1}}const GET_BAND_VALUE_FUNC="getBandValue",PALETTE_TEXTURE_ARRAY="u_paletteTextures",FEATURE_ID_PROPERTY_NAME="featureId",GEOMETRY_TYPE_PROPERTY_NAME="geometryType",UNDEFINED_PROP_VALUE=-9999999;function buildExpression(l,t,n,s){const o=parse$1(l,t,n);return compile(o,t,s)}function createCompiler(l){return(t,n,s)=>{const o=n.args.length,a=new Array(o);for(let h=0;h<o;++h)a[h]=compile(n.args[h],s,t);return l(a,t)}}const compilers={[Ops.Get]:(l,t)=>{const s=t.args[0].value;s in l.properties||(l.properties[s]={name:s,type:t.type});let a="a_prop_"+s;return isType(t.type,BooleanType)&&(a=`(${a} > 0.0)`),a},[Ops.Id]:l=>(l.featureId=!0,"a_"+FEATURE_ID_PROPERTY_NAME),[Ops.GeometryType]:l=>(l.geometryType=!0,"a_"+GEOMETRY_TYPE_PROPERTY_NAME),[Ops.LineMetric]:()=>"currentLineMetric",[Ops.Var]:(l,t)=>{const s=t.args[0].value;s in l.variables||(l.variables[s]={name:s,type:t.type});let a=uniformNameForVariable(s);return isType(t.type,BooleanType)&&(a=`(${a} > 0.0)`),a},[Ops.Has]:(l,t)=>{const s=t.args[0].value;return s in l.properties||(l.properties[s]={name:s,type:t.type}),`(a_prop_${s} != ${numberToGlsl(UNDEFINED_PROP_VALUE)})`},[Ops.Resolution]:()=>"u_resolution",[Ops.Zoom]:()=>"u_zoom",[Ops.Time]:()=>"u_time",[Ops.Any]:createCompiler(l=>`(${l.join(" || ")})`),[Ops.All]:createCompiler(l=>`(${l.join(" && ")})`),[Ops.Not]:createCompiler(([l])=>`(!${l})`),[Ops.Equal]:createCompiler(([l,t])=>`(${l} == ${t})`),[Ops.NotEqual]:createCompiler(([l,t])=>`(${l} != ${t})`),[Ops.GreaterThan]:createCompiler(([l,t])=>`(${l} > ${t})`),[Ops.GreaterThanOrEqualTo]:createCompiler(([l,t])=>`(${l} >= ${t})`),[Ops.LessThan]:createCompiler(([l,t])=>`(${l} < ${t})`),[Ops.LessThanOrEqualTo]:createCompiler(([l,t])=>`(${l} <= ${t})`),[Ops.Multiply]:createCompiler(l=>`(${l.join(" * ")})`),[Ops.Divide]:createCompiler(([l,t])=>`(${l} / ${t})`),[Ops.Add]:createCompiler(l=>`(${l.join(" + ")})`),[Ops.Subtract]:createCompiler(([l,t])=>`(${l} - ${t})`),[Ops.Clamp]:createCompiler(([l,t,n])=>`clamp(${l}, ${t}, ${n})`),[Ops.Mod]:createCompiler(([l,t])=>`mod(${l}, ${t})`),[Ops.Pow]:createCompiler(([l,t])=>`pow(${l}, ${t})`),[Ops.Abs]:createCompiler(([l])=>`abs(${l})`),[Ops.Floor]:createCompiler(([l])=>`floor(${l})`),[Ops.Ceil]:createCompiler(([l])=>`ceil(${l})`),[Ops.Round]:createCompiler(([l])=>`floor(${l} + 0.5)`),[Ops.Sin]:createCompiler(([l])=>`sin(${l})`),[Ops.Cos]:createCompiler(([l])=>`cos(${l})`),[Ops.Atan]:createCompiler(([l,t])=>t!==void 0?`atan(${l}, ${t})`:`atan(${l})`),[Ops.Sqrt]:createCompiler(([l])=>`sqrt(${l})`),[Ops.Match]:createCompiler(l=>{const t=l[0],n=l[l.length-1];let s=null;for(let o=l.length-3;o>=1;o-=2){const a=l[o],h=l[o+1];s=`(${t} == ${a} ? ${h} : ${s||n})`}return s}),[Ops.Between]:createCompiler(([l,t,n])=>`(${l} >= ${t} && ${l} <= ${n})`),[Ops.Interpolate]:createCompiler(([l,t,...n])=>{let s="";for(let o=0;o<n.length-2;o+=2){const a=n[o],h=s||n[o+1],c=n[o+2],u=n[o+3];let d;l===numberToGlsl(1)?d=`(${t} - ${a}) / (${c} - ${a})`:d=`(pow(${l}, (${t} - ${a})) - 1.0) / (pow(${l}, (${c} - ${a})) - 1.0)`,s=`mix(${h}, ${u}, clamp(${d}, 0.0, 1.0))`}return s}),[Ops.Case]:createCompiler(l=>{const t=l[l.length-1];let n=null;for(let s=l.length-3;s>=0;s-=2){const o=l[s],a=l[s+1];n=`(${o} ? ${a} : ${n||t})`}return n}),[Ops.In]:createCompiler(([l,...t],n)=>{const s=computeOperatorFunctionName("in",n),o=[];for(let a=0;a<t.length;a+=1)o.push(`  if (inputValue == ${t[a]}) { return true; }`);return n.functions[s]=`bool ${s}(float inputValue) {
${o.join(`
`)}
  return false;
}`,`${s}(${l})`}),[Ops.Array]:createCompiler(l=>`vec${l.length}(${l.join(", ")})`),[Ops.Color]:createCompiler(l=>{if(l.length===1)return`vec4(vec3(${l[0]} / 255.0), 1.0)`;if(l.length===2)return`vec4(vec3(${l[0]} / 255.0), ${l[1]})`;const t=l.slice(0,3).map(s=>`${s} / 255.0`);if(l.length===3)return`vec4(${t.join(", ")}, 1.0)`;const n=l[3];return`vec4(${t.join(", ")}, ${n})`}),[Ops.Band]:createCompiler(([l,t,n],s)=>{if(!(GET_BAND_VALUE_FUNC in s.functions)){let o="";const a=s.bandCount||1;for(let h=0;h<a;h++){const c=Math.floor(h/4);let u=h%4;h===a-1&&u===1&&(u=3);const d=`${Uniforms$1.TILE_TEXTURE_ARRAY}[${c}]`;o+=`  if (band == ${h+1}.0) {
    return texture2D(${d}, v_textureCoord + vec2(dx, dy))[${u}];
  }
`}s.functions[GET_BAND_VALUE_FUNC]=`float getBandValue(float band, float xOffset, float yOffset) {
  float dx = xOffset / ${Uniforms$1.TEXTURE_PIXEL_WIDTH};
  float dy = yOffset / ${Uniforms$1.TEXTURE_PIXEL_HEIGHT};
${o}
}`}return`${GET_BAND_VALUE_FUNC}(${l}, ${t??"0.0"}, ${n??"0.0"})`}),[Ops.Palette]:(l,t)=>{const[n,...s]=t.args,o=s.length,a=new Uint8Array(o*4);for(let d=0;d<s.length;d++){const f=s[d].value,g=asArray(f),_=d*4;a[_]=g[0],a[_+1]=g[1],a[_+2]=g[2],a[_+3]=g[3]*255}l.paletteTextures||(l.paletteTextures=[]);const h=`${PALETTE_TEXTURE_ARRAY}[${l.paletteTextures.length}]`,c=new PaletteTexture(h,a);l.paletteTextures.push(c);const u=compile(n,NumberType,l);return`texture2D(${h}, vec2((${u} + 0.5) / ${o}.0, 0.5))`}};function compile(l,t,n){if(l instanceof CallExpression){const s=compilers[l.operator];if(s===void 0)throw new Error(`No compiler defined for this operator: ${JSON.stringify(l.operator)}`);return s(n,l,t)}if((l.type&NumberType)>0)return numberToGlsl(l.value);if((l.type&BooleanType)>0)return l.value.toString();if((l.type&StringType)>0)return stringToGlsl(l.value.toString());if((l.type&ColorType)>0)return colorToGlsl(l.value);if((l.type&NumberArrayType)>0)return arrayToGlsl(l.value);if((l.type&SizeType)>0)return sizeToGlsl(l.value);throw new Error(`Unexpected expression ${l.value} (expected type ${typeName(t)})`)}function createDefaultStyle(){return{"fill-color":"rgba(255,255,255,0.4)","stroke-color":"#3399CC","stroke-width":1.25,"circle-radius":5,"circle-fill-color":"rgba(255,255,255,0.4)","circle-stroke-width":1.25,"circle-stroke-color":"#3399CC"}}const LINESTRING_ANGLE_COSINE_CUTOFF=.985;function expressionToGlsl(l,t,n){const s=newParsingContext();return buildExpression(t,n,s,l)}function packColor(l){const t=asArray(l),n=t[0]*256,s=t[1],o=t[2]*256,a=Math.round(t[3]*255);return[n+s,o+a]}const UNPACK_COLOR_FN=`vec4 unpackColor(vec2 packedColor) {
  return vec4(
    min(floor(packedColor[0] / 256.0) / 255.0, 1.0),
    min(mod(packedColor[0], 256.0) / 255.0, 1.0),
    min(floor(packedColor[1] / 256.0) / 255.0, 1.0),
    min(mod(packedColor[1], 256.0) / 255.0, 1.0)
  );
}`;function getGlslSizeFromType(l){return l===ColorType||l===SizeType?2:l===NumberArrayType?4:1}function getGlslTypeFromType(l){const t=getGlslSizeFromType(l);return t>1?`vec${t}`:"float"}function applyContextToBuilder(l,t){for(const n in t.variables){const s=t.variables[n],o=uniformNameForVariable(s.name);let a=getGlslTypeFromType(s.type);s.type===ColorType&&(a="vec4"),l.addUniform(o,a)}for(const n in t.properties){const s=t.properties[n],o=getGlslTypeFromType(s.type),a=`a_prop_${s.name}`;s.type===ColorType?l.addAttribute(a,o,`unpackColor(${a})`,"vec4"):l.addAttribute(a,o)}for(const n in t.functions)l.addVertexShaderFunction(t.functions[n]),l.addFragmentShaderFunction(t.functions[n])}function generateUniformsFromContext(l,t){const n={};for(const s in l.variables){const o=l.variables[s],a=uniformNameForVariable(o.name);n[a]=()=>{const h=t[o.name];if(typeof h=="number")return h;if(typeof h=="boolean")return h?1:0;if(o.type===ColorType){const c=[...asArray(h||"#eee")];return c[0]/=255,c[1]/=255,c[2]/=255,c[3]??(c[3]=1),c}return typeof h=="string"?getStringNumberEquivalent(h):h}}return n}function generateAttributesFromContext(l){const t={};for(const n in l.properties){const s=l.properties[n],o=a=>{const h=a.get(s.name);return s.type===ColorType?packColor([...asArray(h||"#eee")]):typeof h=="string"?getStringNumberEquivalent(h):typeof h=="boolean"?h?1:0:h};t[`prop_${s.name}`]={size:getGlslSizeFromType(s.type),callback:o}}return t}const COMMON_HEADER=`#ifdef GL_FRAGMENT_PRECISION_HIGH
precision highp float;
#else
precision mediump float;
#endif
uniform mat4 u_projectionMatrix;
uniform mat4 u_screenToWorldMatrix;
uniform vec2 u_viewportSizePx;
uniform float u_pixelRatio;
uniform float u_globalAlpha;
uniform float u_time;
uniform float u_zoom;
uniform float u_resolution;
uniform float u_rotation;
uniform vec4 u_renderExtent;
uniform vec2 u_patternOrigin;
uniform float u_depth;
uniform mediump int u_hitDetection;

const float PI = 3.141592653589793238;
const float TWO_PI = 2.0 * PI;
float currentLineMetric = 0.; // an actual value will be used in the stroke shaders

${UNPACK_COLOR_FN}
`,DEFAULT_STYLE=createDefaultStyle();class ShaderBuilder{constructor(){this.uniforms_=[],this.attributes_=[],this.hasSymbol_=!1,this.symbolSizeExpression_=`vec2(${numberToGlsl(DEFAULT_STYLE["circle-radius"])} + ${numberToGlsl(DEFAULT_STYLE["circle-stroke-width"]*.5)})`,this.symbolRotationExpression_="0.0",this.symbolOffsetExpression_="vec2(0.0)",this.symbolColorExpression_=colorToGlsl(DEFAULT_STYLE["circle-fill-color"]),this.texCoordExpression_="vec4(0.0, 0.0, 1.0, 1.0)",this.discardExpression_="false",this.symbolRotateWithView_=!1,this.hasStroke_=!1,this.strokeWidthExpression_=numberToGlsl(DEFAULT_STYLE["stroke-width"]),this.strokeColorExpression_=colorToGlsl(DEFAULT_STYLE["stroke-color"]),this.strokeOffsetExpression_="0.",this.strokeCapExpression_=stringToGlsl("round"),this.strokeJoinExpression_=stringToGlsl("round"),this.strokeMiterLimitExpression_="10.",this.strokeDistanceFieldExpression_="-1000.",this.strokePatternLengthExpression_=null,this.hasFill_=!1,this.fillColorExpression_=colorToGlsl(DEFAULT_STYLE["fill-color"]),this.vertexShaderFunctions_=[],this.fragmentShaderFunctions_=[]}addUniform(t,n){return this.uniforms_.push({name:t,type:n}),this}addAttribute(t,n,s,o){return this.attributes_.push({name:t,type:n,varyingName:t.replace(/^a_/,"v_"),varyingType:o??n,varyingExpression:s??t}),this}setSymbolSizeExpression(t){return this.hasSymbol_=!0,this.symbolSizeExpression_=t,this}getSymbolSizeExpression(){return this.symbolSizeExpression_}setSymbolRotationExpression(t){return this.symbolRotationExpression_=t,this}setSymbolOffsetExpression(t){return this.symbolOffsetExpression_=t,this}getSymbolOffsetExpression(){return this.symbolOffsetExpression_}setSymbolColorExpression(t){return this.hasSymbol_=!0,this.symbolColorExpression_=t,this}getSymbolColorExpression(){return this.symbolColorExpression_}setTextureCoordinateExpression(t){return this.texCoordExpression_=t,this}setFragmentDiscardExpression(t){return this.discardExpression_=t,this}getFragmentDiscardExpression(){return this.discardExpression_}setSymbolRotateWithView(t){return this.symbolRotateWithView_=t,this}setStrokeWidthExpression(t){return this.hasStroke_=!0,this.strokeWidthExpression_=t,this}setStrokeColorExpression(t){return this.hasStroke_=!0,this.strokeColorExpression_=t,this}getStrokeColorExpression(){return this.strokeColorExpression_}setStrokeOffsetExpression(t){return this.strokeOffsetExpression_=t,this}setStrokeCapExpression(t){return this.strokeCapExpression_=t,this}setStrokeJoinExpression(t){return this.strokeJoinExpression_=t,this}setStrokeMiterLimitExpression(t){return this.strokeMiterLimitExpression_=t,this}setStrokeDistanceFieldExpression(t){return this.strokeDistanceFieldExpression_=t,this}setStrokePatternLengthExpression(t){return this.strokePatternLengthExpression_=t,this}getStrokePatternLengthExpression(){return this.strokePatternLengthExpression_}setFillColorExpression(t){return this.hasFill_=!0,this.fillColorExpression_=t,this}getFillColorExpression(){return this.fillColorExpression_}addVertexShaderFunction(t){return this.vertexShaderFunctions_.includes(t)?this:(this.vertexShaderFunctions_.push(t),this)}addFragmentShaderFunction(t){return this.fragmentShaderFunctions_.includes(t)?this:(this.fragmentShaderFunctions_.push(t),this)}getSymbolVertexShader(){return this.hasSymbol_?`${COMMON_HEADER}
${this.uniforms_.map(t=>`uniform ${t.type} ${t.name};`).join(`
`)}
attribute vec2 a_position;
attribute vec2 a_localPosition;
attribute vec2 a_hitColor;

varying vec2 v_texCoord;
varying vec2 v_quadCoord;
varying vec4 v_hitColor;
varying vec2 v_centerPx;
varying float v_angle;
varying vec2 v_quadSizePx;

${this.attributes_.map(t=>`attribute ${t.type} ${t.name};
varying ${t.varyingType} ${t.varyingName};`).join(`
`)}
${this.vertexShaderFunctions_.join(`
`)}
vec2 pxToScreen(vec2 coordPx) {
  vec2 scaled = coordPx / u_viewportSizePx / 0.5;
  return scaled;
}

vec2 screenToPx(vec2 coordScreen) {
  return (coordScreen * 0.5 + 0.5) * u_viewportSizePx;
}

void main(void) {
  v_quadSizePx = ${this.symbolSizeExpression_};
  vec2 halfSizePx = v_quadSizePx * 0.5;
  vec2 centerOffsetPx = ${this.symbolOffsetExpression_};
  vec2 offsetPx = centerOffsetPx + a_localPosition * halfSizePx * vec2(1., -1.);
  float angle = ${this.symbolRotationExpression_}${this.symbolRotateWithView_?" + u_rotation":""};
  float c = cos(-angle);
  float s = sin(-angle);
  offsetPx = vec2(c * offsetPx.x - s * offsetPx.y, s * offsetPx.x + c * offsetPx.y);
  vec4 center = u_projectionMatrix * vec4(a_position, 0.0, 1.0);
  gl_Position = center + vec4(pxToScreen(offsetPx), u_depth, 0.);
  vec4 texCoord = ${this.texCoordExpression_};
  float u = mix(texCoord.s, texCoord.p, a_localPosition.x * 0.5 + 0.5);
  float v = mix(texCoord.t, texCoord.q, a_localPosition.y * 0.5 + 0.5);
  v_texCoord = vec2(u, v);
  v_hitColor = unpackColor(a_hitColor);
  v_angle = angle;
  c = cos(-v_angle);
  s = sin(-v_angle);
  centerOffsetPx = vec2(c * centerOffsetPx.x - s * centerOffsetPx.y, s * centerOffsetPx.x + c * centerOffsetPx.y);
  v_centerPx = screenToPx(center.xy) + centerOffsetPx;
${this.attributes_.map(t=>`  ${t.varyingName} = ${t.varyingExpression};`).join(`
`)}
}`:null}getSymbolFragmentShader(){return this.hasSymbol_?`${COMMON_HEADER}
${this.uniforms_.map(t=>`uniform ${t.type} ${t.name};`).join(`
`)}
varying vec2 v_texCoord;
varying vec4 v_hitColor;
varying vec2 v_centerPx;
varying float v_angle;
varying vec2 v_quadSizePx;
${this.attributes_.map(t=>`varying ${t.varyingType} ${t.varyingName};`).join(`
`)}
${this.fragmentShaderFunctions_.join(`
`)}

void main(void) {
${this.attributes_.map(t=>`  ${t.varyingType} ${t.name} = ${t.varyingName}; // assign to original attribute name`).join(`
`)}
  if (${this.discardExpression_}) { discard; }
  vec2 coordsPx = gl_FragCoord.xy / u_pixelRatio - v_centerPx; // relative to center
  float c = cos(v_angle);
  float s = sin(v_angle);
  coordsPx = vec2(c * coordsPx.x - s * coordsPx.y, s * coordsPx.x + c * coordsPx.y);
  gl_FragColor = ${this.symbolColorExpression_};
  gl_FragColor.rgb *= gl_FragColor.a;
  if (u_hitDetection > 0) {
    if (gl_FragColor.a < 0.05) { discard; };
    gl_FragColor = v_hitColor;
  }
}`:null}getStrokeVertexShader(){return this.hasStroke_?`${COMMON_HEADER}
${this.uniforms_.map(t=>`uniform ${t.type} ${t.name};`).join(`
`)}
attribute vec2 a_segmentStart;
attribute vec2 a_segmentEnd;
attribute vec2 a_localPosition;
attribute float a_measureStart;
attribute float a_measureEnd;
attribute float a_angleTangentSum;
attribute float a_distanceLow;
attribute float a_distanceHigh;
attribute vec2 a_joinAngles;
attribute vec2 a_hitColor;

varying vec2 v_segmentStartPx;
varying vec2 v_segmentEndPx;
varying float v_angleStart;
varying float v_angleEnd;
varying float v_width;
varying vec4 v_hitColor;
varying float v_distancePx;
varying float v_measureStart;
varying float v_measureEnd;

${this.attributes_.map(t=>`attribute ${t.type} ${t.name};
varying ${t.varyingType} ${t.varyingName};`).join(`
`)}
${this.vertexShaderFunctions_.join(`
`)}
vec2 worldToPx(vec2 worldPos) {
  vec4 screenPos = u_projectionMatrix * vec4(worldPos, 0.0, 1.0);
  return (0.5 * screenPos.xy + 0.5) * u_viewportSizePx;
}

vec4 pxToScreen(vec2 pxPos) {
  vec2 screenPos = 2.0 * pxPos / u_viewportSizePx - 1.0;
  return vec4(screenPos, u_depth, 1.0);
}

bool isCap(float joinAngle) {
  return joinAngle < -0.1;
}

vec2 getJoinOffsetDirection(vec2 normalPx, float joinAngle) {
  float halfAngle = joinAngle / 2.0;
  float c = cos(halfAngle);
  float s = sin(halfAngle);
  vec2 angleBisectorNormal = vec2(s * normalPx.x + c * normalPx.y, -c * normalPx.x + s * normalPx.y);
  float length = 1.0 / s;
  return angleBisectorNormal * length;
}

vec2 getOffsetPoint(vec2 point, vec2 normal, float joinAngle, float offsetPx) {
  // if on a cap or the join angle is too high, offset the line along the segment normal
  if (cos(joinAngle) > 0.998 || isCap(joinAngle)) {
    return point - normal * offsetPx;
  }
  // offset is applied along the inverted normal (positive offset goes "right" relative to line direction)
  return point - getJoinOffsetDirection(normal, joinAngle) * offsetPx;
}

void main(void) {
  v_angleStart = a_joinAngles.x;
  v_angleEnd = a_joinAngles.y;
  float startEndRatio = a_localPosition.x * 0.5 + 0.5;
  currentLineMetric = mix(a_measureStart, a_measureEnd, startEndRatio);
  // we're reading the fractional part while keeping the sign (so -4.12 gives -0.12, 3.45 gives 0.45)

  float lineWidth = ${this.strokeWidthExpression_};
  float lineOffsetPx = ${this.strokeOffsetExpression_};

  // compute segment start/end in px with offset
  vec2 segmentStartPx = worldToPx(a_segmentStart);
  vec2 segmentEndPx = worldToPx(a_segmentEnd);
  vec2 tangentPx = normalize(segmentEndPx - segmentStartPx);
  vec2 normalPx = vec2(-tangentPx.y, tangentPx.x);
  segmentStartPx = getOffsetPoint(segmentStartPx, normalPx, v_angleStart, lineOffsetPx),
  segmentEndPx = getOffsetPoint(segmentEndPx, normalPx, v_angleEnd, lineOffsetPx);

  // compute current vertex position
  float normalDir = -1. * a_localPosition.y;
  float tangentDir = -1. * a_localPosition.x;
  float angle = mix(v_angleStart, v_angleEnd, startEndRatio);
  vec2 joinDirection;
  vec2 positionPx = mix(segmentStartPx, segmentEndPx, startEndRatio);
  // if angle is too high, do not make a proper join
  if (cos(angle) > ${LINESTRING_ANGLE_COSINE_CUTOFF} || isCap(angle)) {
    joinDirection = normalPx * normalDir - tangentPx * tangentDir;
  } else {
    joinDirection = getJoinOffsetDirection(normalPx * normalDir, angle);
  }
  positionPx = positionPx + joinDirection * (lineWidth * 0.5 + 1.); // adding 1 pixel for antialiasing
  gl_Position = pxToScreen(positionPx);

  v_segmentStartPx = segmentStartPx;
  v_segmentEndPx = segmentEndPx;
  v_width = lineWidth;
  v_hitColor = unpackColor(a_hitColor);

  v_distancePx = a_distanceLow / u_resolution - (lineOffsetPx * a_angleTangentSum);
  float distanceHighPx = a_distanceHigh / u_resolution;
  ${this.strokePatternLengthExpression_!==null?`v_distancePx = mod(v_distancePx, ${this.strokePatternLengthExpression_});
  distanceHighPx = mod(distanceHighPx, ${this.strokePatternLengthExpression_});
  `:""}v_distancePx += distanceHighPx;

  v_measureStart = a_measureStart;
  v_measureEnd = a_measureEnd;
${this.attributes_.map(t=>`  ${t.varyingName} = ${t.varyingExpression};`).join(`
`)}
}`:null}getStrokeFragmentShader(){return this.hasStroke_?`${COMMON_HEADER}
${this.uniforms_.map(t=>`uniform ${t.type} ${t.name};`).join(`
`)}
varying vec2 v_segmentStartPx;
varying vec2 v_segmentEndPx;
varying float v_angleStart;
varying float v_angleEnd;
varying float v_width;
varying vec4 v_hitColor;
varying float v_distancePx;
varying float v_measureStart;
varying float v_measureEnd;
${this.attributes_.map(t=>`varying ${t.varyingType} ${t.varyingName};`).join(`
`)}
${this.fragmentShaderFunctions_.join(`
`)}

vec2 pxToWorld(vec2 pxPos) {
  vec2 screenPos = 2.0 * pxPos / u_viewportSizePx - 1.0;
  return (u_screenToWorldMatrix * vec4(screenPos, 0.0, 1.0)).xy;
}

bool isCap(float joinAngle) {
  return joinAngle < -0.1;
}

float segmentDistanceField(vec2 point, vec2 start, vec2 end, float width) {
  vec2 tangent = normalize(end - start);
  vec2 normal = vec2(-tangent.y, tangent.x);
  vec2 startToPoint = point - start;
  return abs(dot(startToPoint, normal)) - width * 0.5;
}

float buttCapDistanceField(vec2 point, vec2 start, vec2 end) {
  vec2 startToPoint = point - start;
  vec2 tangent = normalize(end - start);
  return dot(startToPoint, -tangent);
}

float squareCapDistanceField(vec2 point, vec2 start, vec2 end, float width) {
  return buttCapDistanceField(point, start, end) - width * 0.5;
}

float roundCapDistanceField(vec2 point, vec2 start, vec2 end, float width) {
  float onSegment = max(0., 1000. * dot(point - start, end - start)); // this is very high when inside the segment
  return length(point - start) - width * 0.5 - onSegment;
}

float roundJoinDistanceField(vec2 point, vec2 start, vec2 end, float width) {
  return roundCapDistanceField(point, start, end, width);
}

float bevelJoinField(vec2 point, vec2 start, vec2 end, float width, float joinAngle) {
  vec2 startToPoint = point - start;
  vec2 tangent = normalize(end - start);
  float c = cos(joinAngle * 0.5);
  float s = sin(joinAngle * 0.5);
  float direction = -sign(sin(joinAngle));
  vec2 bisector = vec2(c * tangent.x - s * tangent.y, s * tangent.x + c * tangent.y);
  float radius = width * 0.5 * s;
  return dot(startToPoint, bisector * direction) - radius;
}

float miterJoinDistanceField(vec2 point, vec2 start, vec2 end, float width, float joinAngle) {
  if (cos(joinAngle) > ${LINESTRING_ANGLE_COSINE_CUTOFF}) { // avoid risking a division by zero
    return bevelJoinField(point, start, end, width, joinAngle);
  }
  float miterLength = 1. / sin(joinAngle * 0.5);
  float miterLimit = ${this.strokeMiterLimitExpression_};
  if (miterLength > miterLimit) {
    return bevelJoinField(point, start, end, width, joinAngle);
  }
  return -1000.;
}

float capDistanceField(vec2 point, vec2 start, vec2 end, float width, float capType) {
   if (capType == ${stringToGlsl("butt")}) {
    return buttCapDistanceField(point, start, end);
  } else if (capType == ${stringToGlsl("square")}) {
    return squareCapDistanceField(point, start, end, width);
  }
  return roundCapDistanceField(point, start, end, width);
}

float joinDistanceField(vec2 point, vec2 start, vec2 end, float width, float joinAngle, float joinType) {
  if (joinType == ${stringToGlsl("bevel")}) {
    return bevelJoinField(point, start, end, width, joinAngle);
  } else if (joinType == ${stringToGlsl("miter")}) {
    return miterJoinDistanceField(point, start, end, width, joinAngle);
  }
  return roundJoinDistanceField(point, start, end, width);
}

float computeSegmentPointDistance(vec2 point, vec2 start, vec2 end, float width, float joinAngle, float capType, float joinType) {
  if (isCap(joinAngle)) {
    return capDistanceField(point, start, end, width, capType);
  }
  return joinDistanceField(point, start, end, width, joinAngle, joinType);
}

float distanceFromSegment(vec2 point, vec2 start, vec2 end) {
  vec2 tangent = end - start;
  vec2 startToPoint = point - start;
  // inspire by capsule fn in https://iquilezles.org/articles/distfunctions/
  float h = clamp(dot(startToPoint, tangent) / dot(tangent, tangent), 0.0, 1.0);
  return length(startToPoint - tangent * h);
}

void main(void) {
${this.attributes_.map(t=>`  ${t.varyingType} ${t.name} = ${t.varyingName}; // assign to original attribute name`).join(`
`)}

  vec2 currentPointPx = gl_FragCoord.xy / u_pixelRatio;
  #ifdef GL_FRAGMENT_PRECISION_HIGH
  vec2 worldPos = pxToWorld(currentPointPx);
  if (
    abs(u_renderExtent[0] - u_renderExtent[2]) > 0.0 && (
      worldPos[0] < u_renderExtent[0] ||
      worldPos[1] < u_renderExtent[1] ||
      worldPos[0] > u_renderExtent[2] ||
      worldPos[1] > u_renderExtent[3]
    )
  ) {
    discard;
  }
  #endif

  float segmentLengthPx = length(v_segmentEndPx - v_segmentStartPx);
  segmentLengthPx = max(segmentLengthPx, 1.17549429e-38); // avoid divide by zero
  vec2 segmentTangent = (v_segmentEndPx - v_segmentStartPx) / segmentLengthPx;
  vec2 segmentNormal = vec2(-segmentTangent.y, segmentTangent.x);
  vec2 startToPointPx = currentPointPx - v_segmentStartPx;
  float lengthToPointPx = max(0., min(dot(segmentTangent, startToPointPx), segmentLengthPx));
  float currentLengthPx = lengthToPointPx + v_distancePx;
  float currentRadiusPx = distanceFromSegment(currentPointPx, v_segmentStartPx, v_segmentEndPx);
  float currentRadiusRatio = dot(segmentNormal, startToPointPx) * 2. / v_width;
  currentLineMetric = mix(v_measureStart, v_measureEnd, lengthToPointPx / segmentLengthPx);

  if (${this.discardExpression_}) { discard; }

  float capType = ${this.strokeCapExpression_};
  float joinType = ${this.strokeJoinExpression_};
  float segmentStartDistance = computeSegmentPointDistance(currentPointPx, v_segmentStartPx, v_segmentEndPx, v_width, v_angleStart, capType, joinType);
  float segmentEndDistance = computeSegmentPointDistance(currentPointPx, v_segmentEndPx, v_segmentStartPx, v_width, v_angleEnd, capType, joinType);
  float distanceField = max(
    segmentDistanceField(currentPointPx, v_segmentStartPx, v_segmentEndPx, v_width),
    max(segmentStartDistance, segmentEndDistance)
  );
  distanceField = max(distanceField, ${this.strokeDistanceFieldExpression_});

  vec4 color = ${this.strokeColorExpression_};
  color.a *= smoothstep(0.5, -0.5, distanceField);
  gl_FragColor = color;
  gl_FragColor.a *= u_globalAlpha;
  gl_FragColor.rgb *= gl_FragColor.a;
  if (u_hitDetection > 0) {
    if (gl_FragColor.a < 0.1) { discard; };
    gl_FragColor = v_hitColor;
  }
}`:null}getFillVertexShader(){return this.hasFill_?`${COMMON_HEADER}
${this.uniforms_.map(t=>`uniform ${t.type} ${t.name};`).join(`
`)}
attribute vec2 a_position;
attribute vec2 a_hitColor;

varying vec4 v_hitColor;

${this.attributes_.map(t=>`attribute ${t.type} ${t.name};
varying ${t.varyingType} ${t.varyingName};`).join(`
`)}
${this.vertexShaderFunctions_.join(`
`)}
void main(void) {
  gl_Position = u_projectionMatrix * vec4(a_position, u_depth, 1.0);
  v_hitColor = unpackColor(a_hitColor);
${this.attributes_.map(t=>`  ${t.varyingName} = ${t.varyingExpression};`).join(`
`)}
}`:null}getFillFragmentShader(){return this.hasFill_?`${COMMON_HEADER}
${this.uniforms_.map(t=>`uniform ${t.type} ${t.name};`).join(`
`)}
varying vec4 v_hitColor;
${this.attributes_.map(t=>`varying ${t.varyingType} ${t.varyingName};`).join(`
`)}
${this.fragmentShaderFunctions_.join(`
`)}
vec2 pxToWorld(vec2 pxPos) {
  vec2 screenPos = 2.0 * pxPos / u_viewportSizePx - 1.0;
  return (u_screenToWorldMatrix * vec4(screenPos, 0.0, 1.0)).xy;
}

vec2 worldToPx(vec2 worldPos) {
  vec4 screenPos = u_projectionMatrix * vec4(worldPos, 0.0, 1.0);
  return (0.5 * screenPos.xy + 0.5) * u_viewportSizePx;
}

void main(void) {
${this.attributes_.map(t=>`  ${t.varyingType} ${t.name} = ${t.varyingName}; // assign to original attribute name`).join(`
`)}
  vec2 pxPos = gl_FragCoord.xy / u_pixelRatio;
  vec2 pxOrigin = worldToPx(u_patternOrigin);
  #ifdef GL_FRAGMENT_PRECISION_HIGH
  vec2 worldPos = pxToWorld(pxPos);
  if (
    abs(u_renderExtent[0] - u_renderExtent[2]) > 0.0 && (
      worldPos[0] < u_renderExtent[0] ||
      worldPos[1] < u_renderExtent[1] ||
      worldPos[0] > u_renderExtent[2] ||
      worldPos[1] > u_renderExtent[3]
    )
  ) {
    discard;
  }
  #endif
  if (${this.discardExpression_}) { discard; }
  gl_FragColor = ${this.fillColorExpression_};
  gl_FragColor.a *= u_globalAlpha;
  gl_FragColor.rgb *= gl_FragColor.a;
  if (u_hitDetection > 0) {
    if (gl_FragColor.a < 0.1) { discard; };
    gl_FragColor = v_hitColor;
  }
}`:null}}class MixedGeometryBatch{constructor(){this.globalCounter_=0,this.refToFeature_=new Map,this.uidToRef_=new Map,this.freeGlobalRef_=[],this.polygonBatch={entries:{},geometriesCount:0,verticesCount:0,ringsCount:0},this.pointBatch={entries:{},geometriesCount:0},this.lineStringBatch={entries:{},geometriesCount:0,verticesCount:0}}addFeatures(t,n){for(let s=0;s<t.length;s++)this.addFeature(t[s],n)}addFeature(t,n){let s=t.getGeometry();s&&(n&&(s=s.clone(),s.applyTransform(n)),this.addGeometry_(s,t))}clearFeatureEntryInPointBatch_(t){const n=getUid(t),s=this.pointBatch.entries[n];if(s)return this.pointBatch.geometriesCount-=s.flatCoordss.length,delete this.pointBatch.entries[n],s}clearFeatureEntryInLineStringBatch_(t){const n=getUid(t),s=this.lineStringBatch.entries[n];if(s)return this.lineStringBatch.verticesCount-=s.verticesCount,this.lineStringBatch.geometriesCount-=s.flatCoordss.length,delete this.lineStringBatch.entries[n],s}clearFeatureEntryInPolygonBatch_(t){const n=getUid(t),s=this.polygonBatch.entries[n];if(s)return this.polygonBatch.verticesCount-=s.verticesCount,this.polygonBatch.ringsCount-=s.ringsCount,this.polygonBatch.geometriesCount-=s.flatCoordss.length,delete this.polygonBatch.entries[n],s}addGeometry_(t,n){var o;const s=t.getType();switch(s){case"GeometryCollection":{const a=t.getGeometriesArray();for(const h of a)this.addGeometry_(h,n);break}case"MultiPolygon":{const a=t;this.addCoordinates_(s,a.getFlatCoordinates(),a.getEndss(),n,getUid(n),a.getStride());break}case"MultiLineString":{const a=t;this.addCoordinates_(s,a.getFlatCoordinates(),a.getEnds(),n,getUid(n),a.getStride());break}case"MultiPoint":{const a=t;this.addCoordinates_(s,a.getFlatCoordinates(),null,n,getUid(n),a.getStride());break}case"Polygon":{const a=t;this.addCoordinates_(s,a.getFlatCoordinates(),a.getEnds(),n,getUid(n),a.getStride());break}case"Point":{const a=t;this.addCoordinates_(s,a.getFlatCoordinates(),null,n,getUid(n),a.getStride());break}case"LineString":case"LinearRing":{const a=t,h=a.getStride();this.addCoordinates_(s,a.getFlatCoordinates(),null,n,getUid(n),h,(o=a.getLayout)==null?void 0:o.call(a));break}}}addCoordinates_(t,n,s,o,a,h,c){let u;switch(t){case"MultiPolygon":{const d=s;for(let f=0,g=d.length;f<g;f++){let _=d[f];const m=f>0?d[f-1]:null,p=m?m[m.length-1]:0,x=_[_.length-1];_=p>0?_.map(y=>y-p):_,this.addCoordinates_("Polygon",n.slice(p,x),_,o,a,h,c)}break}case"MultiLineString":{const d=s;for(let f=0,g=d.length;f<g;f++){const _=f>0?d[f-1]:0;this.addCoordinates_("LineString",n.slice(_,d[f]),null,o,a,h,c)}break}case"MultiPoint":for(let d=0,f=n.length;d<f;d+=h)this.addCoordinates_("Point",n.slice(d,d+2),null,o,a,null,null);break;case"Polygon":{const d=s;if(o instanceof RenderFeature){const _=inflateEnds(n,d);if(_.length>1){this.addCoordinates_("MultiPolygon",n,_,o,a,h,c);return}}this.polygonBatch.entries[a]||(this.polygonBatch.entries[a]=this.addRefToEntry_(a,{feature:o,flatCoordss:[],verticesCount:0,ringsCount:0,ringsVerticesCounts:[]})),u=n.length/h;const f=s.length,g=s.map((_,m,p)=>m>0?(_-p[m-1])/h:_/h);this.polygonBatch.verticesCount+=u,this.polygonBatch.ringsCount+=f,this.polygonBatch.geometriesCount++,this.polygonBatch.entries[a].flatCoordss.push(getFlatCoordinatesXY(n,h)),this.polygonBatch.entries[a].ringsVerticesCounts.push(g),this.polygonBatch.entries[a].verticesCount+=u,this.polygonBatch.entries[a].ringsCount+=f;for(let _=0,m=d.length;_<m;_++){const p=_>0?d[_-1]:0;this.addCoordinates_("LinearRing",n.slice(p,d[_]),null,o,a,h,c)}break}case"Point":this.pointBatch.entries[a]||(this.pointBatch.entries[a]=this.addRefToEntry_(a,{feature:o,flatCoordss:[]})),this.pointBatch.geometriesCount++,this.pointBatch.entries[a].flatCoordss.push(n);break;case"LineString":case"LinearRing":this.lineStringBatch.entries[a]||(this.lineStringBatch.entries[a]=this.addRefToEntry_(a,{feature:o,flatCoordss:[],verticesCount:0})),u=n.length/h,this.lineStringBatch.verticesCount+=u,this.lineStringBatch.geometriesCount++,this.lineStringBatch.entries[a].flatCoordss.push(getFlatCoordinatesXYM(n,h,c)),this.lineStringBatch.entries[a].verticesCount+=u;break}}addRefToEntry_(t,n){const s=this.uidToRef_.get(t),o=s||this.freeGlobalRef_.pop()||++this.globalCounter_;return n.ref=o,s||(this.refToFeature_.set(o,n.feature),this.uidToRef_.set(t,o)),n}removeRef_(t,n){if(!t)throw new Error("This feature has no ref: "+n);this.refToFeature_.delete(t),this.uidToRef_.delete(n),this.freeGlobalRef_.push(t)}changeFeature(t,n){if(!this.uidToRef_.get(getUid(t)))return;this.removeFeature(t);let s=t.getGeometry();s&&(n&&(s=s.clone(),s.applyTransform(n)),this.addGeometry_(s,t))}removeFeature(t){let n=this.clearFeatureEntryInPointBatch_(t);n=this.clearFeatureEntryInPolygonBatch_(t)||n,n=this.clearFeatureEntryInLineStringBatch_(t)||n,n&&this.removeRef_(n.ref,getUid(n.feature))}clear(){this.polygonBatch.entries={},this.polygonBatch.geometriesCount=0,this.polygonBatch.verticesCount=0,this.polygonBatch.ringsCount=0,this.lineStringBatch.entries={},this.lineStringBatch.geometriesCount=0,this.lineStringBatch.verticesCount=0,this.pointBatch.entries={},this.pointBatch.geometriesCount=0,this.globalCounter_=0,this.freeGlobalRef_=[],this.refToFeature_.clear(),this.uidToRef_.clear()}getFeatureFromRef(t){return this.refToFeature_.get(t)}isEmpty(){return this.globalCounter_===0}filter(t){const n=new MixedGeometryBatch;n.globalCounter_=this.globalCounter_,n.uidToRef_=this.uidToRef_,n.refToFeature_=this.refToFeature_;let s=!0;for(const o of this.refToFeature_.values())t(o)&&(n.addFeature(o),s=!1);return s?new MixedGeometryBatch:n}}function getFlatCoordinatesXY(l,t){return t===2?l:l.filter((n,s)=>s%t<2)}function getFlatCoordinatesXYM(l,t,n){return t===3&&n==="XYM"?l:t===4?l.filter((s,o)=>o%t!==2):t===3?l.map((s,o)=>o%t!==2?s:0):new Array(l.length*1.5).fill(0).map((s,o)=>o%3===2?0:l[Math.round(o/1.5)])}function create(){const l='function t(t,n,x=2){const o=n&&n.length,i=o?n[0]*x:t.length;let f=e(t,0,i,x,!0);const l=[];if(!f||f.next===f.prev)return l;let c,y,h;if(o&&(f=function(t,n,r,x){const o=[];for(let r=0,i=n.length;r<i;r++){const f=e(t,n[r]*x,r<i-1?n[r+1]*x:t.length,x,!1);f===f.next&&(f.steiner=!0),o.push(a(f))}o.sort(u);for(let t=0;t<o.length;t++)r=s(o[t],r);return r}(t,n,f,x)),t.length>80*x){c=t[0],y=t[1];let e=c,n=y;for(let r=x;r<i;r+=x){const x=t[r],o=t[r+1];x<c&&(c=x),o<y&&(y=o),x>e&&(e=x),o>n&&(n=o)}h=Math.max(e-c,n-y),h=0!==h?32767/h:0}return r(f,l,x,c,y,h,0),l}function e(t,e,n,r,x){let o;if(x===function(t,e,n,r){let x=0;for(let o=e,i=n-r;o<n;o+=r)x+=(t[i]-t[o])*(t[o+1]+t[i+1]),i=o;return x}(t,e,n,r)>0)for(let x=e;x<n;x+=r)o=d(x/r|0,t[x],t[x+1],o);else for(let x=n-r;x>=e;x-=r)o=d(x/r|0,t[x],t[x+1],o);return o&&b(o,o.next)&&(w(o),o=o.next),o}function n(t,e){if(!t)return t;e||(e=t);let n,r=t;do{if(n=!1,r.steiner||!b(r,r.next)&&0!==v(r.prev,r,r.next))r=r.next;else{if(w(r),r=e=r.prev,r===r.next)break;n=!0}}while(n||r!==e);return e}function r(t,e,u,s,l,a,y){if(!t)return;!y&&a&&function(t,e,n,r){let x=t;do{0===x.z&&(x.z=c(x.x,x.y,e,n,r)),x.prevZ=x.prev,x.nextZ=x.next,x=x.next}while(x!==t);x.prevZ.nextZ=null,x.prevZ=null,function(t){let e,n=1;do{let r,x=t;t=null;let o=null;for(e=0;x;){e++;let i=x,f=0;for(let t=0;t<n&&(f++,i=i.nextZ,i);t++);let u=n;for(;f>0||u>0&&i;)0!==f&&(0===u||!i||x.z<=i.z)?(r=x,x=x.nextZ,f--):(r=i,i=i.nextZ,u--),o?o.nextZ=r:t=r,r.prevZ=o,o=r;x=i}o.nextZ=null,n*=2}while(e>1)}(x)}(t,s,l,a);let h=t;for(;t.prev!==t.next;){const c=t.prev,p=t.next;if(a?o(t,s,l,a):x(t))e.push(c.i,t.i,p.i),w(t),t=p.next,h=p.next;else if((t=p)===h){y?1===y?r(t=i(n(t),e),e,u,s,l,a,2):2===y&&f(t,e,u,s,l,a):r(n(t),e,u,s,l,a,1);break}}}function x(t){const e=t.prev,n=t,r=t.next;if(v(e,n,r)>=0)return!1;const x=e.x,o=n.x,i=r.x,f=e.y,u=n.y,s=r.y,l=Math.min(x,o,i),c=Math.min(f,u,s),a=Math.max(x,o,i),y=Math.max(f,u,s);let p=r.next;for(;p!==e;){if(p.x>=l&&p.x<=a&&p.y>=c&&p.y<=y&&h(x,f,o,u,i,s,p.x,p.y)&&v(p.prev,p,p.next)>=0)return!1;p=p.next}return!0}function o(t,e,n,r){const x=t.prev,o=t,i=t.next;if(v(x,o,i)>=0)return!1;const f=x.x,u=o.x,s=i.x,l=x.y,a=o.y,y=i.y,p=Math.min(f,u,s),b=Math.min(l,a,y),M=Math.max(f,u,s),m=Math.max(l,a,y),A=c(p,b,e,n,r),g=c(M,m,e,n,r);let Z=t.prevZ,d=t.nextZ;for(;Z&&Z.z>=A&&d&&d.z<=g;){if(Z.x>=p&&Z.x<=M&&Z.y>=b&&Z.y<=m&&Z!==x&&Z!==i&&h(f,l,u,a,s,y,Z.x,Z.y)&&v(Z.prev,Z,Z.next)>=0)return!1;if(Z=Z.prevZ,d.x>=p&&d.x<=M&&d.y>=b&&d.y<=m&&d!==x&&d!==i&&h(f,l,u,a,s,y,d.x,d.y)&&v(d.prev,d,d.next)>=0)return!1;d=d.nextZ}for(;Z&&Z.z>=A;){if(Z.x>=p&&Z.x<=M&&Z.y>=b&&Z.y<=m&&Z!==x&&Z!==i&&h(f,l,u,a,s,y,Z.x,Z.y)&&v(Z.prev,Z,Z.next)>=0)return!1;Z=Z.prevZ}for(;d&&d.z<=g;){if(d.x>=p&&d.x<=M&&d.y>=b&&d.y<=m&&d!==x&&d!==i&&h(f,l,u,a,s,y,d.x,d.y)&&v(d.prev,d,d.next)>=0)return!1;d=d.nextZ}return!0}function i(t,e){let r=t;do{const n=r.prev,x=r.next.next;!b(n,x)&&M(n,r,r.next,x)&&g(n,x)&&g(x,n)&&(e.push(n.i,r.i,x.i),w(r),w(r.next),r=t=x),r=r.next}while(r!==t);return n(r)}function f(t,e,x,o,i,f){let u=t;do{let t=u.next.next;for(;t!==u.prev;){if(u.i!==t.i&&p(u,t)){let s=Z(u,t);return u=n(u,u.next),s=n(s,s.next),r(u,e,x,o,i,f,0),void r(s,e,x,o,i,f,0)}t=t.next}u=u.next}while(u!==t)}function u(t,e){let n=t.x-e.x;if(0===n&&(n=t.y-e.y,0===n)){n=(t.next.y-t.y)/(t.next.x-t.x)-(e.next.y-e.y)/(e.next.x-e.x)}return n}function s(t,e){const r=function(t,e){let n=e;const r=t.x,x=t.y;let o,i=-1/0;if(b(t,n))return n;do{if(b(t,n.next))return n.next;if(x<=n.y&&x>=n.next.y&&n.next.y!==n.y){const t=n.x+(x-n.y)*(n.next.x-n.x)/(n.next.y-n.y);if(t<=r&&t>i&&(i=t,o=n.x<n.next.x?n:n.next,t===r))return o}n=n.next}while(n!==e);if(!o)return null;const f=o,u=o.x,s=o.y;let c=1/0;n=o;do{if(r>=n.x&&n.x>=u&&r!==n.x&&y(x<s?r:i,x,u,s,x<s?i:r,x,n.x,n.y)){const e=Math.abs(x-n.y)/(r-n.x);g(n,t)&&(e<c||e===c&&(n.x>o.x||n.x===o.x&&l(o,n)))&&(o=n,c=e)}n=n.next}while(n!==f);return o}(t,e);if(!r)return e;const x=Z(r,t);return n(x,x.next),n(r,r.next)}function l(t,e){return v(t.prev,t,e.prev)<0&&v(e.next,t,t.next)<0}function c(t,e,n,r,x){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-n)*x|0)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-r)*x|0)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function a(t){let e=t,n=t;do{(e.x<n.x||e.x===n.x&&e.y<n.y)&&(n=e),e=e.next}while(e!==t);return n}function y(t,e,n,r,x,o,i,f){return(x-i)*(e-f)>=(t-i)*(o-f)&&(t-i)*(r-f)>=(n-i)*(e-f)&&(n-i)*(o-f)>=(x-i)*(r-f)}function h(t,e,n,r,x,o,i,f){return!(t===i&&e===f)&&y(t,e,n,r,x,o,i,f)}function p(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!function(t,e){let n=t;do{if(n.i!==t.i&&n.next.i!==t.i&&n.i!==e.i&&n.next.i!==e.i&&M(n,n.next,t,e))return!0;n=n.next}while(n!==t);return!1}(t,e)&&(g(t,e)&&g(e,t)&&function(t,e){let n=t,r=!1;const x=(t.x+e.x)/2,o=(t.y+e.y)/2;do{n.y>o!=n.next.y>o&&n.next.y!==n.y&&x<(n.next.x-n.x)*(o-n.y)/(n.next.y-n.y)+n.x&&(r=!r),n=n.next}while(n!==t);return r}(t,e)&&(v(t.prev,t,e.prev)||v(t,e.prev,e))||b(t,e)&&v(t.prev,t,t.next)>0&&v(e.prev,e,e.next)>0)}function v(t,e,n){return(e.y-t.y)*(n.x-e.x)-(e.x-t.x)*(n.y-e.y)}function b(t,e){return t.x===e.x&&t.y===e.y}function M(t,e,n,r){const x=A(v(t,e,n)),o=A(v(t,e,r)),i=A(v(n,r,t)),f=A(v(n,r,e));return x!==o&&i!==f||(!(0!==x||!m(t,n,e))||(!(0!==o||!m(t,r,e))||(!(0!==i||!m(n,t,r))||!(0!==f||!m(n,e,r)))))}function m(t,e,n){return e.x<=Math.max(t.x,n.x)&&e.x>=Math.min(t.x,n.x)&&e.y<=Math.max(t.y,n.y)&&e.y>=Math.min(t.y,n.y)}function A(t){return t>0?1:t<0?-1:0}function g(t,e){return v(t.prev,t,t.next)<0?v(t,e,t.next)>=0&&v(t,t.prev,e)>=0:v(t,e,t.prev)<0||v(t,t.next,e)<0}function Z(t,e){const n=F(t.i,t.x,t.y),r=F(e.i,e.x,e.y),x=t.next,o=e.prev;return t.next=e,e.prev=t,n.next=x,x.prev=n,r.next=n,n.prev=r,o.next=r,r.prev=o,r}function d(t,e,n,r){const x=F(t,e,n);return r?(x.next=r.next,x.prev=r,r.next.prev=x,r.next=x):(x.prev=x,x.next=x),x}function w(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function F(t,e,n){return{i:t,x:e,y:n,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}function E(t,e){const n=e[0],r=e[1];return e[0]=t[0]*n+t[2]*r+t[4],e[1]=t[1]*n+t[3]*r+t[5],e}function I(t,e){const n=(r=e)[0]*r[3]-r[1]*r[2];var r;!function(t,e){if(!t)throw new Error(e)}(0!==n,"Transformation matrix cannot be inverted");const x=e[0],o=e[1],i=e[2],f=e[3],u=e[4],s=e[5];return t[0]=f/n,t[1]=-o/n,t[2]=-i/n,t[3]=x/n,t[4]=(i*s-f*u)/n,t[5]=-(x*s-o*u)/n,t}new Array(6);const z=[],B={vertexAttributesPosition:0,instanceAttributesPosition:0,indicesPosition:0};function P(t,e,n,r,x){const o=t[e++],i=t[e++],f=z;f.length=r;for(let n=0;n<f.length;n++)f[n]=t[e+n];let u=x?x.instanceAttributesPosition:0;return n[u++]=o,n[u++]=i,f.length&&(n.set(f,u),u+=f.length),B.instanceAttributesPosition=u,B}function N(t,e,n,r,x,o,i,f,u,s){const l=[t[e],t[e+1]],c=[t[n],t[n+1]],a=t[e+2],y=t[n+2],h=E(f,[...l]),p=E(f,[...c]);function v(t,e,n){const r=Math.sqrt((e[0]-t[0])*(e[0]-t[0])+(e[1]-t[1])*(e[1]-t[1])),x=[(e[0]-t[0])/r,(e[1]-t[1])/r],o=[-x[1],x[0]],i=Math.sqrt((n[0]-t[0])*(n[0]-t[0])+(n[1]-t[1])*(n[1]-t[1])),f=[(n[0]-t[0])/i,(n[1]-t[1])/i];let u=0===r||0===i?0:Math.acos((s=f[0]*x[0]+f[1]*x[1],l=-1,c=1,Math.min(Math.max(s,l),c)));var s,l,c;u=Math.max(u,1e-5);return f[0]*o[0]+f[1]*o[1]>0?u:2*Math.PI-u}let b=-1,M=-1,m=s;const A=null!==x;if(null!==r){b=v(h,p,E(f,[...[t[r],t[r+1]]])),Math.cos(b)<=.985&&(m+=Math.tan((b-Math.PI)/2))}if(A){M=v(p,h,E(f,[...[t[x],t[x+1]]])),Math.cos(M)<=.985&&(m+=Math.tan((Math.PI-M)/2))}const g=Math.pow(2,24),Z=u%g,d=Math.floor(u/g)*g;return o.push(l[0],l[1],a,c[0],c[1],y,b,M,Z,d,s),o.push(...i),{length:u+Math.sqrt((p[0]-h[0])*(p[0]-h[0])+(p[1]-h[1])*(p[1]-h[1])),angle:m}}function R(e,n,r,x,o){const i=2+o;let f=n;const u=e.slice(f,f+o);f+=o;const s=e[f++];let l=0;const c=new Array(s-1);for(let t=0;t<s;t++)l+=e[f++],t<s-1&&(c[t]=l);const a=e.slice(f,f+2*l),y=t(a,c,2);for(let t=0;t<y.length;t++)x.push(y[t]+r.length/i);for(let t=0;t<a.length;t+=2)r.push(a[t],a[t+1],...u);return f+2*l}const S="GENERATE_POLYGON_BUFFERS",T="GENERATE_POINT_BUFFERS",_="GENERATE_LINE_STRING_BUFFERS",O=self;O.onmessage=t=>{const e=t.data;switch(e.type){case T:{const t=2,n=2,r=e.customAttributesSize,x=n+r,o=new Float32Array(e.renderInstructions),i=o.length/x*(t+r),f=Uint32Array.from([0,1,3,1,2,3]),u=Float32Array.from([-1,-1,1,-1,1,1,-1,1]),s=new Float32Array(i);let l;for(let t=0;t<o.length;t+=x)l=P(o,t,s,r,l);const c=Object.assign({indicesBuffer:f.buffer,vertexAttributesBuffer:u.buffer,instanceAttributesBuffer:s.buffer,renderInstructions:o.buffer},e);O.postMessage(c,[u.buffer,s.buffer,f.buffer,o.buffer]);break}case _:{const t=[],n=e.customAttributesSize,r=3,x=new Float32Array(e.renderInstructions);let o=0;const i=[1,0,0,1,0,0];let f,u;for(I(i,e.renderInstructionsTransform);o<x.length;){u=Array.from(x.slice(o,o+n)),o+=n,f=x[o++];const e=o,s=o+(f-1)*r,l=x[e]===x[s]&&x[e+1]===x[s+1];let c=0,a=0;for(let n=0;n<f-1;n++){let y=null;n>0?y=o+(n-1)*r:l&&(y=s-r);let h=null;n<f-2?h=o+(n+2)*r:l&&(h=e+r);const p=N(x,o+n*r,o+(n+1)*r,y,h,t,u,i,c,a);c=p.length,a=p.angle}o+=f*r}const s=Uint32Array.from([0,1,3,1,2,3]),l=Float32Array.from([-1,-1,1,-1,1,1,-1,1]),c=Float32Array.from(t),a=Object.assign({indicesBuffer:s.buffer,vertexAttributesBuffer:l.buffer,instanceAttributesBuffer:c.buffer,renderInstructions:x.buffer},e);O.postMessage(a,[l.buffer,c.buffer,s.buffer,x.buffer]);break}case S:{const t=[],n=[],r=e.customAttributesSize,x=new Float32Array(e.renderInstructions);let o=0;for(;o<x.length;)o=R(x,o,t,n,r);const i=Uint32Array.from(n),f=Float32Array.from(t),u=Float32Array.from([]),s=Object.assign({indicesBuffer:i.buffer,vertexAttributesBuffer:f.buffer,instanceAttributesBuffer:u.buffer,renderInstructions:x.buffer},e);O.postMessage(s,[f.buffer,u.buffer,i.buffer,x.buffer]);break}}};';return new Worker(typeof Blob>"u"?"data:application/javascript;base64,"+Buffer.from(l,"binary").toString("base64"):URL.createObjectURL(new Blob([l],{type:"application/javascript"})))}const WebGLWorkerMessageType={GENERATE_POLYGON_BUFFERS:"GENERATE_POLYGON_BUFFERS",GENERATE_POINT_BUFFERS:"GENERATE_POINT_BUFFERS",GENERATE_LINE_STRING_BUFFERS:"GENERATE_LINE_STRING_BUFFERS"};function colorEncodeIdAndPack(l,t){t=t||[];const n=256,s=n-1,o=Math.floor(l/n/n/n)/s,a=Math.floor(l/n/n)%n/s,h=Math.floor(l/n)%n/s,c=l%n/s;return t[0]=o*256*255+a*255,t[1]=h*256*255+c*255,t}function colorDecodeId(l){let t=0;const n=256,s=n-1;return t+=Math.round(l[0]*n*n*n*s),t+=Math.round(l[1]*n*n*s),t+=Math.round(l[2]*n*s),t+=Math.round(l[3]*s),t}function pushCustomAttributesInRenderInstructions(l,t,n,s){let o=0;for(const a in t){const h=t[a],c=h.callback.call(n,n.feature);let u=(c==null?void 0:c[0])??c;u===UNDEFINED_PROP_VALUE&&console.warn('The "has" operator might return false positives.'),u===void 0?u=UNDEFINED_PROP_VALUE:u===null&&(u=0),l[s+o++]=u,!(!h.size||h.size===1)&&(l[s+o++]=c[1],!(h.size<3)&&(l[s+o++]=c[2],!(h.size<4)&&(l[s+o++]=c[3])))}return o}function getCustomAttributesSize(l){return Object.keys(l).reduce((t,n)=>t+(l[n].size||1),0)}function generatePointRenderInstructions(l,t,n,s){const o=(2+getCustomAttributesSize(n))*l.geometriesCount;(!t||t.length!==o)&&(t=new Float32Array(o));const a=[];let h=0;for(const c in l.entries){const u=l.entries[c];for(let d=0,f=u.flatCoordss.length;d<f;d++)a[0]=u.flatCoordss[d][0],a[1]=u.flatCoordss[d][1],apply(s,a),t[h++]=a[0],t[h++]=a[1],h+=pushCustomAttributesInRenderInstructions(t,n,u,h)}return t}function generateLineStringRenderInstructions(l,t,n,s){const o=3*l.verticesCount+(1+getCustomAttributesSize(n))*l.geometriesCount;(!t||t.length!==o)&&(t=new Float32Array(o));const a=[];let h=0;for(const c in l.entries){const u=l.entries[c];for(let d=0,f=u.flatCoordss.length;d<f;d++){a.length=u.flatCoordss[d].length,transform2D(u.flatCoordss[d],0,a.length,3,s,a,3),h+=pushCustomAttributesInRenderInstructions(t,n,u,h),t[h++]=a.length/3;for(let g=0,_=a.length;g<_;g+=3)t[h++]=a[g],t[h++]=a[g+1],t[h++]=a[g+2]}}return t}function generatePolygonRenderInstructions(l,t,n,s){const o=2*l.verticesCount+(1+getCustomAttributesSize(n))*l.geometriesCount+l.ringsCount;(!t||t.length!==o)&&(t=new Float32Array(o));const a=[];let h=0;for(const c in l.entries){const u=l.entries[c];for(let d=0,f=u.flatCoordss.length;d<f;d++){a.length=u.flatCoordss[d].length,transform2D(u.flatCoordss[d],0,a.length,2,s,a),h+=pushCustomAttributesInRenderInstructions(t,n,u,h),t[h++]=u.ringsVerticesCounts[d].length;for(let g=0,_=u.ringsVerticesCounts[d].length;g<_;g++)t[h++]=u.ringsVerticesCounts[d][g];for(let g=0,_=a.length;g<_;g+=2)t[h++]=a[g],t[h++]=a[g+1]}}return t}function computeHash(l){return(JSON.stringify(l).split("").reduce((n,s)=>(n<<5)-n+s.charCodeAt(0),0)>>>0).toString()}function parseCommonSymbolProperties(l,t,n,s){if(`${s}radius`in l&&s!=="icon-"){let o=expressionToGlsl(n,l[`${s}radius`],NumberType);if(`${s}radius2`in l){const a=expressionToGlsl(n,l[`${s}radius2`],NumberType);o=`max(${o}, ${a})`}`${s}stroke-width`in l&&(o=`(${o} + ${expressionToGlsl(n,l[`${s}stroke-width`],NumberType)} * 0.5)`),t.setSymbolSizeExpression(`vec2(${o} * 2. + 0.5)`)}if(`${s}scale`in l){const o=expressionToGlsl(n,l[`${s}scale`],SizeType);t.setSymbolSizeExpression(`${t.getSymbolSizeExpression()} * ${o}`)}`${s}displacement`in l&&t.setSymbolOffsetExpression(expressionToGlsl(n,l[`${s}displacement`],NumberArrayType)),`${s}rotation`in l&&t.setSymbolRotationExpression(expressionToGlsl(n,l[`${s}rotation`],NumberType)),`${s}rotate-with-view`in l&&t.setSymbolRotateWithView(!!l[`${s}rotate-with-view`])}function getColorFromDistanceField(l,t,n,s,o){let a="vec4(0.)";if(t!==null&&(a=t),n!==null&&s!==null){const u=`smoothstep(-${s} + 0.63, -${s} - 0.58, ${l})`;a=`mix(${n}, ${a}, ${u})`}const h=`(1.0 - smoothstep(-0.63, 0.58, ${l}))`;let c=`${a} * vec4(1.0, 1.0, 1.0, ${h})`;return o!==null&&(c=`${c} * vec4(1.0, 1.0, 1.0, ${o})`),c}function parseImageProperties(l,t,n,s,o){const a=new Image;a.crossOrigin=l[`${s}cross-origin`]===void 0?"anonymous":l[`${s}cross-origin`],assert(typeof l[`${s}src`]=="string",`WebGL layers do not support expressions for the ${s}src style property`),a.src=l[`${s}src`],n[`u_texture${o}_size`]=()=>a.complete?[a.width,a.height]:[0,0],t.addUniform(`u_texture${o}_size`,"vec2");const h=`u_texture${o}_size`;return n[`u_texture${o}`]=a,t.addUniform(`u_texture${o}`,"sampler2D"),h}function parseImageOffsetProperties(l,t,n,s,o){let a=expressionToGlsl(n,l[`${t}offset`],SizeType);if(`${t}offset-origin`in l)switch(l[`${t}offset-origin`]){case"top-right":a=`vec2(${s}.x, 0.) + ${o} * vec2(-1., 0.) + ${a} * vec2(-1., 1.)`;break;case"bottom-left":a=`vec2(0., ${s}.y) + ${o} * vec2(0., -1.) + ${a} * vec2(1., -1.)`;break;case"bottom-right":a=`${s} - ${o} - ${a}`;break}return a}function parseCircleProperties(l,t,n,s){s.functions.circleDistanceField=`float circleDistanceField(vec2 point, float radius) {
  return length(point) - radius;
}`,parseCommonSymbolProperties(l,t,s,"circle-");let o=null;"circle-opacity"in l&&(o=expressionToGlsl(s,l["circle-opacity"],NumberType));let a="coordsPx";"circle-scale"in l&&(a=`coordsPx / ${expressionToGlsl(s,l["circle-scale"],SizeType)}`);let h=null;"circle-fill-color"in l&&(h=expressionToGlsl(s,l["circle-fill-color"],ColorType));let c=null;"circle-stroke-color"in l&&(c=expressionToGlsl(s,l["circle-stroke-color"],ColorType));let u=expressionToGlsl(s,l["circle-radius"],NumberType),d=null;"circle-stroke-width"in l&&(d=expressionToGlsl(s,l["circle-stroke-width"],NumberType),u=`(${u} + ${d} * 0.5)`);const f=`circleDistanceField(${a}, ${u})`,g=getColorFromDistanceField(f,h,c,d,o);t.setSymbolColorExpression(g)}function parseShapeProperties(l,t,n,s){s.functions.round=`float round(float v) {
  return sign(v) * floor(abs(v) + 0.5);
}`,s.functions.starDistanceField=`float starDistanceField(vec2 point, float numPoints, float radius, float radius2, float angle) {
  float startAngle = -PI * 0.5 + angle; // tip starts upwards and rotates clockwise with angle
  float c = cos(startAngle);
  float s = sin(startAngle);
  vec2 pointRotated = vec2(c * point.x - s * point.y, s * point.x + c * point.y);
  float alpha = TWO_PI / numPoints; // the angle of one sector
  float beta = atan(pointRotated.y, pointRotated.x);
  float gamma = round(beta / alpha) * alpha; // angle in sector
  c = cos(-gamma);
  s = sin(-gamma);
  vec2 inSector = vec2(c * pointRotated.x - s * pointRotated.y, abs(s * pointRotated.x + c * pointRotated.y));
  vec2 tipToPoint = inSector + vec2(-radius, 0.);
  vec2 edgeNormal = vec2(radius2 * sin(alpha * 0.5), -radius2 * cos(alpha * 0.5) + radius);
  return dot(normalize(edgeNormal), tipToPoint);
}`,s.functions.regularDistanceField=`float regularDistanceField(vec2 point, float numPoints, float radius, float angle) {
  float startAngle = -PI * 0.5 + angle; // tip starts upwards and rotates clockwise with angle
  float c = cos(startAngle);
  float s = sin(startAngle);
  vec2 pointRotated = vec2(c * point.x - s * point.y, s * point.x + c * point.y);
  float alpha = TWO_PI / numPoints; // the angle of one sector
  float radiusIn = radius * cos(PI / numPoints);
  float beta = atan(pointRotated.y, pointRotated.x);
  float gamma = round((beta - alpha * 0.5) / alpha) * alpha + alpha * 0.5; // angle in sector from mid
  c = cos(-gamma);
  s = sin(-gamma);
  vec2 inSector = vec2(c * pointRotated.x - s * pointRotated.y, abs(s * pointRotated.x + c * pointRotated.y));
  return inSector.x - radiusIn;
}`,parseCommonSymbolProperties(l,t,s,"shape-");let o=null;"shape-opacity"in l&&(o=expressionToGlsl(s,l["shape-opacity"],NumberType));let a="coordsPx";"shape-scale"in l&&(a=`coordsPx / ${expressionToGlsl(s,l["shape-scale"],SizeType)}`);let h=null;"shape-fill-color"in l&&(h=expressionToGlsl(s,l["shape-fill-color"],ColorType));let c=null;"shape-stroke-color"in l&&(c=expressionToGlsl(s,l["shape-stroke-color"],ColorType));let u=null;"shape-stroke-width"in l&&(u=expressionToGlsl(s,l["shape-stroke-width"],NumberType));const d=expressionToGlsl(s,l["shape-points"],NumberType);let f="0.";"shape-angle"in l&&(f=expressionToGlsl(s,l["shape-angle"],NumberType));let g,_=expressionToGlsl(s,l["shape-radius"],NumberType);if(u!==null&&(_=`${_} + ${u} * 0.5`),"shape-radius2"in l){let p=expressionToGlsl(s,l["shape-radius2"],NumberType);u!==null&&(p=`${p} + ${u} * 0.5`),g=`starDistanceField(${a}, ${d}, ${_}, ${p}, ${f})`}else g=`regularDistanceField(${a}, ${d}, ${_}, ${f})`;const m=getColorFromDistanceField(g,h,c,u,o);t.setSymbolColorExpression(m)}function parseIconProperties(l,t,n,s){let o="vec4(1.0)";"icon-color"in l&&(o=expressionToGlsl(s,l["icon-color"],ColorType)),"icon-opacity"in l&&(o=`${o} * vec4(1.0, 1.0, 1.0, ${expressionToGlsl(s,l["icon-opacity"],NumberType)})`);const a=computeHash(l["icon-src"]),h=parseImageProperties(l,t,n,"icon-",a);if(t.setSymbolColorExpression(`${o} * texture2D(u_texture${a}, v_texCoord)`).setSymbolSizeExpression(h),"icon-width"in l&&"icon-height"in l&&t.setSymbolSizeExpression(`vec2(${expressionToGlsl(s,l["icon-width"],NumberType)}, ${expressionToGlsl(s,l["icon-height"],NumberType)})`),"icon-offset"in l&&"icon-size"in l){const c=expressionToGlsl(s,l["icon-size"],NumberArrayType),u=t.getSymbolSizeExpression();t.setSymbolSizeExpression(c);const d=parseImageOffsetProperties(l,"icon-",s,"v_quadSizePx",c);t.setTextureCoordinateExpression(`(vec4((${d}).xyxy) + vec4(0., 0., ${c})) / (${u}).xyxy`)}if(parseCommonSymbolProperties(l,t,s,"icon-"),"icon-anchor"in l){const c=expressionToGlsl(s,l["icon-anchor"],NumberArrayType);let u="1.0";"icon-scale"in l&&(u=expressionToGlsl(s,l["icon-scale"],SizeType));let d;l["icon-anchor-x-units"]==="pixels"&&l["icon-anchor-y-units"]==="pixels"?d=`${c} * ${u}`:l["icon-anchor-x-units"]==="pixels"?d=`${c} * vec2(vec2(${u}).x, v_quadSizePx.y)`:l["icon-anchor-y-units"]==="pixels"?d=`${c} * vec2(v_quadSizePx.x, vec2(${u}).x)`:d=`${c} * v_quadSizePx`;let f=`v_quadSizePx * vec2(0.5, -0.5) + ${d} * vec2(-1., 1.)`;if("icon-anchor-origin"in l)switch(l["icon-anchor-origin"]){case"top-right":f=`v_quadSizePx * -0.5 + ${d}`;break;case"bottom-left":f=`v_quadSizePx * 0.5 - ${d}`;break;case"bottom-right":f=`v_quadSizePx * vec2(-0.5, 0.5) + ${d} * vec2(1., -1.)`;break}t.setSymbolOffsetExpression(`${t.getSymbolOffsetExpression()} + ${f}`)}}function parseStrokeProperties(l,t,n,s){if("stroke-color"in l&&t.setStrokeColorExpression(expressionToGlsl(s,l["stroke-color"],ColorType)),"stroke-pattern-src"in l){const o=computeHash(l["stroke-pattern-src"]),a=parseImageProperties(l,t,n,"stroke-pattern-",o);let h=a,c="vec2(0.)";"stroke-pattern-offset"in l&&"stroke-pattern-size"in l&&(h=expressionToGlsl(s,l["stroke-pattern-size"],NumberArrayType),c=parseImageOffsetProperties(l,"stroke-pattern-",s,a,h));let u="0.";"stroke-pattern-spacing"in l&&(u=expressionToGlsl(s,l["stroke-pattern-spacing"],NumberType));let d="0.";"stroke-pattern-start-offset"in l&&(d=expressionToGlsl(s,l["stroke-pattern-start-offset"],NumberType)),s.functions.sampleStrokePattern=`vec4 sampleStrokePattern(sampler2D texture, vec2 textureSize, vec2 textureOffset, vec2 sampleSize, float spacingPx, float startOffsetPx, float currentLengthPx, float currentRadiusRatio, float lineWidth) {
  float currentLengthScaled = (currentLengthPx - startOffsetPx) * sampleSize.y / lineWidth;
  float spacingScaled = spacingPx * sampleSize.y / lineWidth;
  float uCoordPx = mod(currentLengthScaled, (sampleSize.x + spacingScaled));
  float isInsideOfPattern = step(uCoordPx, sampleSize.x);
  float vCoordPx = (-currentRadiusRatio * 0.5 + 0.5) * sampleSize.y;
  // make sure that we're not sampling too close to the borders to avoid interpolation with outside pixels
  uCoordPx = clamp(uCoordPx, 0.5, sampleSize.x - 0.5);
  vCoordPx = clamp(vCoordPx, 0.5, sampleSize.y - 0.5);
  vec2 texCoord = (vec2(uCoordPx, vCoordPx) + textureOffset) / textureSize;
  return texture2D(texture, texCoord) * vec4(1.0, 1.0, 1.0, isInsideOfPattern);
}`;const f=`u_texture${o}`;let g="1.";"stroke-color"in l&&(g=t.getStrokeColorExpression()),t.setStrokeColorExpression(`${g} * sampleStrokePattern(${f}, ${a}, ${c}, ${h}, ${u}, ${d}, currentLengthPx, currentRadiusRatio, v_width)`),s.functions.computeStrokePatternLength=`float computeStrokePatternLength(vec2 sampleSize, float spacingPx, float lineWidth) {
  float patternLengthPx = sampleSize.x / sampleSize.y * lineWidth;
  return patternLengthPx + spacingPx;
}`,t.setStrokePatternLengthExpression(`computeStrokePatternLength(${h}, ${u}, v_width)`)}if("stroke-width"in l&&t.setStrokeWidthExpression(expressionToGlsl(s,l["stroke-width"],NumberType)),"stroke-offset"in l&&t.setStrokeOffsetExpression(expressionToGlsl(s,l["stroke-offset"],NumberType)),"stroke-line-cap"in l&&t.setStrokeCapExpression(expressionToGlsl(s,l["stroke-line-cap"],StringType)),"stroke-line-join"in l&&t.setStrokeJoinExpression(expressionToGlsl(s,l["stroke-line-join"],StringType)),"stroke-miter-limit"in l&&t.setStrokeMiterLimitExpression(expressionToGlsl(s,l["stroke-miter-limit"],NumberType)),"stroke-line-dash"in l){s.functions.getSingleDashDistance=`float getSingleDashDistance(float distance, float radius, float dashOffset, float dashLength, float dashLengthTotal, float capType, float lineWidth) {
  float localDistance = mod(distance, dashLengthTotal);
  float distanceSegment = abs(localDistance - dashOffset - dashLength * 0.5) - dashLength * 0.5;
  distanceSegment = min(distanceSegment, dashLengthTotal - localDistance);
  if (capType == ${stringToGlsl("square")}) {
    distanceSegment -= lineWidth * 0.5;
  } else if (capType == ${stringToGlsl("round")}) {
    distanceSegment = min(distanceSegment, sqrt(distanceSegment * distanceSegment + radius * radius) - lineWidth * 0.5);
  }
  return distanceSegment;
}`;let o=l["stroke-line-dash"].map(p=>expressionToGlsl(s,p,NumberType));o.length%2===1&&(o=[...o,...o]);let a="0.";"stroke-line-dash-offset"in l&&(a=expressionToGlsl(s,l["stroke-line-dash-offset"],NumberType));const c=`dashDistanceField_${computeHash(l["stroke-line-dash"])}`,u=o.map((p,x)=>`float dashLength${x}`).join(", "),d=o.map((p,x)=>`dashLength${x}`).join(" + ");let f="0.",g=`getSingleDashDistance(distance, radius, ${f}, dashLength0, totalDashLength, capType, lineWidth)`;for(let p=2;p<o.length;p+=2)f=`${f} + dashLength${p-2} + dashLength${p-1}`,g=`min(${g}, getSingleDashDistance(distance, radius, ${f}, dashLength${p}, totalDashLength, capType, lineWidth))`;s.functions[c]=`float ${c}(float distance, float radius, float capType, float lineWidth, ${u}) {
  float totalDashLength = ${d};
  return ${g};
}`;const _=o.map((p,x)=>`${p}`).join(", ");t.setStrokeDistanceFieldExpression(`${c}(currentLengthPx + ${a}, currentRadiusPx, capType, v_width, ${_})`);let m=o.join(" + ");t.getStrokePatternLengthExpression()&&(s.functions.combinePatternLengths=`float combinePatternLengths(float patternLength1, float patternLength2) {
  return patternLength1 * patternLength2;
}`,m=`combinePatternLengths(${t.getStrokePatternLengthExpression()}, ${m})`),t.setStrokePatternLengthExpression(m)}}function parseFillProperties(l,t,n,s){if("fill-color"in l&&t.setFillColorExpression(expressionToGlsl(s,l["fill-color"],ColorType)),"fill-pattern-src"in l){const o=computeHash(l["fill-pattern-src"]),a=parseImageProperties(l,t,n,"fill-pattern-",o);let h=a,c="vec2(0.)";"fill-pattern-offset"in l&&"fill-pattern-size"in l&&(h=expressionToGlsl(s,l["fill-pattern-size"],NumberArrayType),c=parseImageOffsetProperties(l,"fill-pattern-",s,a,h)),s.functions.sampleFillPattern=`vec4 sampleFillPattern(sampler2D texture, vec2 textureSize, vec2 textureOffset, vec2 sampleSize, vec2 pxOrigin, vec2 pxPosition) {
  float scaleRatio = pow(2., mod(u_zoom + 0.5, 1.) - 0.5);
  vec2 pxRelativePos = pxPosition - pxOrigin;
  // rotate the relative position from origin by the current view rotation
  pxRelativePos = vec2(pxRelativePos.x * cos(u_rotation) - pxRelativePos.y * sin(u_rotation), pxRelativePos.x * sin(u_rotation) + pxRelativePos.y * cos(u_rotation));
  // sample position is computed according to the sample offset & size
  vec2 samplePos = mod(pxRelativePos / scaleRatio, sampleSize);
  // also make sure that we're not sampling too close to the borders to avoid interpolation with outside pixels
  samplePos = clamp(samplePos, vec2(0.5), sampleSize - vec2(0.5));
  samplePos.y = sampleSize.y - samplePos.y; // invert y axis so that images appear upright
  return texture2D(texture, (samplePos + textureOffset) / textureSize);
}`;const u=`u_texture${o}`;let d="1.";"fill-color"in l&&(d=t.getFillColorExpression()),t.setFillColorExpression(`${d} * sampleFillPattern(${u}, ${a}, ${c}, ${h}, pxOrigin, pxPos)`)}}function parseLiteralStyle(l,t,n){const s=newCompilationContext(),o=new ShaderBuilder,a={};if("icon-src"in l?parseIconProperties(l,o,a,s):"shape-points"in l?parseShapeProperties(l,o,a,s):"circle-radius"in l&&parseCircleProperties(l,o,a,s),parseStrokeProperties(l,o,a,s),parseFillProperties(l,o,a,s),n){const u=expressionToGlsl(s,n,BooleanType);o.setFragmentDiscardExpression(`!${u}`)}const h={};function c(u,d,f,g){if(!s[u])return;const _=getGlslTypeFromType(f),m=getGlslSizeFromType(f);o.addAttribute(`a_${d}`,_),h[d]={size:m,callback:g}}return c("geometryType",GEOMETRY_TYPE_PROPERTY_NAME,StringType,u=>getStringNumberEquivalent(computeGeometryType(u.getGeometry()))),c("featureId",FEATURE_ID_PROPERTY_NAME,StringType|NumberType,u=>{const d=u.getId()??null;return typeof d=="string"?getStringNumberEquivalent(d):d}),applyContextToBuilder(o,s),{builder:o,attributes:{...h,...generateAttributesFromContext(s)},uniforms:{...a,...generateUniformsFromContext(s,t)}}}const tmpColor=[];let WEBGL_WORKER;function getWebGLWorker(){return WEBGL_WORKER||(WEBGL_WORKER=create()),WEBGL_WORKER}let workerMessageCounter=0;const Attributes={POSITION:"a_position",LOCAL_POSITION:"a_localPosition",SEGMENT_START:"a_segmentStart",SEGMENT_END:"a_segmentEnd",MEASURE_START:"a_measureStart",MEASURE_END:"a_measureEnd",ANGLE_TANGENT_SUM:"a_angleTangentSum",JOIN_ANGLES:"a_joinAngles",DISTANCE_LOW:"a_distanceLow",DISTANCE_HIGH:"a_distanceHigh"};class VectorStyleRenderer{constructor(t,n,s,o){this.helper_,this.hitDetectionEnabled_=!!o,this.styleShaders=convertStyleToShaders(t,n),this.customAttributes_={},this.uniforms_={},this.hitDetectionEnabled_&&(this.customAttributes_.hitColor={callback(){return colorEncodeIdAndPack(this.ref,tmpColor)},size:2});for(const a of this.styleShaders){for(const h in a.attributes)h in this.customAttributes_||(this.customAttributes_[h]=a.attributes[h]);for(const h in a.uniforms)h in this.uniforms_||(this.uniforms_[h]=a.uniforms[h])}this.renderPasses_=this.styleShaders.map(a=>{const h={},c=Object.entries(this.customAttributes_).map(([u,d])=>({name:u in a.attributes||u==="hitColor"?`a_${u}`:null,size:d.size||1,type:AttributeType.FLOAT}));return a.builder.getFillVertexShader()&&(h.fillRenderPass={vertexShader:a.builder.getFillVertexShader(),fragmentShader:a.builder.getFillFragmentShader(),attributesDesc:[{name:Attributes.POSITION,size:2,type:AttributeType.FLOAT},...c],instancedAttributesDesc:[],instancePrimitiveVertexCount:3}),a.builder.getStrokeVertexShader()&&(h.strokeRenderPass={vertexShader:a.builder.getStrokeVertexShader(),fragmentShader:a.builder.getStrokeFragmentShader(),attributesDesc:[{name:Attributes.LOCAL_POSITION,size:2,type:AttributeType.FLOAT}],instancedAttributesDesc:[{name:Attributes.SEGMENT_START,size:2,type:AttributeType.FLOAT},{name:Attributes.MEASURE_START,size:1,type:AttributeType.FLOAT},{name:Attributes.SEGMENT_END,size:2,type:AttributeType.FLOAT},{name:Attributes.MEASURE_END,size:1,type:AttributeType.FLOAT},{name:Attributes.JOIN_ANGLES,size:2,type:AttributeType.FLOAT},{name:Attributes.DISTANCE_LOW,size:1,type:AttributeType.FLOAT},{name:Attributes.DISTANCE_HIGH,size:1,type:AttributeType.FLOAT},{name:Attributes.ANGLE_TANGENT_SUM,size:1,type:AttributeType.FLOAT},...c],instancePrimitiveVertexCount:6}),a.builder.getSymbolVertexShader()&&(h.symbolRenderPass={vertexShader:a.builder.getSymbolVertexShader(),fragmentShader:a.builder.getSymbolFragmentShader(),attributesDesc:[{name:Attributes.LOCAL_POSITION,size:2,type:AttributeType.FLOAT}],instancedAttributesDesc:[{name:Attributes.POSITION,size:2,type:AttributeType.FLOAT},...c],instancePrimitiveVertexCount:6}),h}),this.hasFill_=this.renderPasses_.some(a=>a.fillRenderPass),this.hasStroke_=this.renderPasses_.some(a=>a.strokeRenderPass),this.hasSymbol_=this.renderPasses_.some(a=>a.symbolRenderPass),this.setHelper(s)}async generateBuffers(t,n){if(t.isEmpty())return null;const s=this.generateRenderInstructions_(t,n),[o,a,h]=await Promise.all([this.generateBuffersForType_(s.polygonInstructions,"Polygon",n),this.generateBuffersForType_(s.lineStringInstructions,"LineString",n),this.generateBuffersForType_(s.pointInstructions,"Point",n)]),c=makeInverse(create$2(),n);return{polygonBuffers:o,lineStringBuffers:a,pointBuffers:h,invertVerticesTransform:c}}generateRenderInstructions_(t,n){const s=this.hasFill_?generatePolygonRenderInstructions(t.polygonBatch,new Float32Array(0),this.customAttributes_,n):null,o=this.hasStroke_?generateLineStringRenderInstructions(t.lineStringBatch,new Float32Array(0),this.customAttributes_,n):null,a=this.hasSymbol_?generatePointRenderInstructions(t.pointBatch,new Float32Array(0),this.customAttributes_,n):null;return{polygonInstructions:s,lineStringInstructions:o,pointInstructions:a}}generateBuffersForType_(t,n,s){if(t===null)return null;const o=workerMessageCounter++;let a;switch(n){case"Polygon":a=WebGLWorkerMessageType.GENERATE_POLYGON_BUFFERS;break;case"LineString":a=WebGLWorkerMessageType.GENERATE_LINE_STRING_BUFFERS;break;case"Point":a=WebGLWorkerMessageType.GENERATE_POINT_BUFFERS;break}const h={id:o,type:a,renderInstructions:t.buffer,renderInstructionsTransform:s,customAttributesSize:getCustomAttributesSize(this.customAttributes_)},c=getWebGLWorker();return c.postMessage(h,[t.buffer]),t=null,new Promise(u=>{const d=f=>{const g=f.data;if(g.id!==o||(c.removeEventListener("message",d),!this.helper_.getGL()))return;const _=new WebGLArrayBuffer(ELEMENT_ARRAY_BUFFER,DYNAMIC_DRAW).fromArrayBuffer(g.indicesBuffer),m=new WebGLArrayBuffer(ARRAY_BUFFER,DYNAMIC_DRAW).fromArrayBuffer(g.vertexAttributesBuffer),p=new WebGLArrayBuffer(ARRAY_BUFFER,DYNAMIC_DRAW).fromArrayBuffer(g.instanceAttributesBuffer);this.helper_.flushBufferData(_),this.helper_.flushBufferData(m),this.helper_.flushBufferData(p),u([_,m,p])};c.addEventListener("message",d)})}render(t,n,s){for(const o of this.renderPasses_)o.fillRenderPass&&this.renderInternal_(t.polygonBuffers[0],t.polygonBuffers[1],t.polygonBuffers[2],o.fillRenderPass,n,s),o.strokeRenderPass&&this.renderInternal_(t.lineStringBuffers[0],t.lineStringBuffers[1],t.lineStringBuffers[2],o.strokeRenderPass,n,s),o.symbolRenderPass&&this.renderInternal_(t.pointBuffers[0],t.pointBuffers[1],t.pointBuffers[2],o.symbolRenderPass,n,s)}renderInternal_(t,n,s,o,a,h){const c=t.getSize();if(c===0)return;const u=o.instancedAttributesDesc.length;if(this.helper_.useProgram(o.program,a),this.helper_.bindBuffer(n),this.helper_.bindBuffer(t),this.helper_.enableAttributes(o.attributesDesc),this.helper_.bindBuffer(s),this.helper_.enableAttributesInstanced(o.instancedAttributesDesc),h(),u){const d=o.instancedAttributesDesc.reduce((g,_)=>g+(_.size||1),0),f=s.getSize()/d;this.helper_.drawElementsInstanced(0,c,f)}else this.helper_.drawElements(0,c)}setHelper(t,n=null){this.helper_=t;for(const s of this.renderPasses_)s.fillRenderPass&&(s.fillRenderPass.program=this.helper_.getProgram(s.fillRenderPass.fragmentShader,s.fillRenderPass.vertexShader)),s.strokeRenderPass&&(s.strokeRenderPass.program=this.helper_.getProgram(s.strokeRenderPass.fragmentShader,s.strokeRenderPass.vertexShader)),s.symbolRenderPass&&(s.symbolRenderPass.program=this.helper_.getProgram(s.symbolRenderPass.fragmentShader,s.symbolRenderPass.vertexShader));this.helper_.addUniforms(this.uniforms_),n&&(n.polygonBuffers&&(this.helper_.flushBufferData(n.polygonBuffers[0]),this.helper_.flushBufferData(n.polygonBuffers[1]),this.helper_.flushBufferData(n.polygonBuffers[2])),n.lineStringBuffers&&(this.helper_.flushBufferData(n.lineStringBuffers[0]),this.helper_.flushBufferData(n.lineStringBuffers[1]),this.helper_.flushBufferData(n.lineStringBuffers[2])),n.pointBuffers&&(this.helper_.flushBufferData(n.pointBuffers[0]),this.helper_.flushBufferData(n.pointBuffers[1]),this.helper_.flushBufferData(n.pointBuffers[2])))}}function convertStyleToShaders(l,t){const n=Array.isArray(l)?l:[l];if("style"in n[0]){const s=[],o=n,a=[];for(const h of o){const c=Array.isArray(h.style)?h.style:[h.style];let u=h.filter;h.else&&a.length&&(u=["all",...a.map(f=>["!",f])],h.filter&&u.push(h.filter),u.length<3&&(u=u[1])),h.filter&&a.push(h.filter);const d=c.map(f=>parseLiteralStyle(f,t,u));s.push(...d)}return s}return"builder"in n[0]?n:n.map(s=>parseLiteralStyle(s,t,null))}const tmpArray4=new Uint8Array(4);class WebGLRenderTarget{constructor(t,n){this.helper_=t;const s=t.getGL();this.texture_=s.createTexture(),this.framebuffer_=s.createFramebuffer(),this.depthbuffer_=s.createRenderbuffer(),this.size_=n||[1,1],this.data_=new Uint8Array(0),this.dataCacheDirty_=!0,this.updateSize_()}setSize(t){equals$2(t,this.size_)||(this.size_[0]=t[0],this.size_[1]=t[1],this.updateSize_())}getSize(){return this.size_}clearCachedData(){this.dataCacheDirty_=!0}readAll(){if(this.dataCacheDirty_){const t=this.size_,n=this.helper_.getGL();n.bindFramebuffer(n.FRAMEBUFFER,this.framebuffer_),n.readPixels(0,0,t[0],t[1],n.RGBA,n.UNSIGNED_BYTE,this.data_),this.dataCacheDirty_=!1}return this.data_}readPixel(t,n){if(t<0||n<0||t>this.size_[0]||n>=this.size_[1])return tmpArray4[0]=0,tmpArray4[1]=0,tmpArray4[2]=0,tmpArray4[3]=0,tmpArray4;this.readAll();const s=Math.floor(t)+(this.size_[1]-Math.floor(n)-1)*this.size_[0];return tmpArray4[0]=this.data_[s*4],tmpArray4[1]=this.data_[s*4+1],tmpArray4[2]=this.data_[s*4+2],tmpArray4[3]=this.data_[s*4+3],tmpArray4}getTexture(){return this.texture_}getFramebuffer(){return this.framebuffer_}getDepthbuffer(){return this.depthbuffer_}updateSize_(){const t=this.size_,n=this.helper_.getGL();this.texture_=this.helper_.createTexture(t,null,this.texture_),n.bindFramebuffer(n.FRAMEBUFFER,this.framebuffer_),n.viewport(0,0,t[0],t[1]),n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,this.texture_,0),n.bindRenderbuffer(n.RENDERBUFFER,this.depthbuffer_),n.renderbufferStorage(n.RENDERBUFFER,n.DEPTH_COMPONENT16,t[0],t[1]),n.framebufferRenderbuffer(n.FRAMEBUFFER,n.DEPTH_ATTACHMENT,n.RENDERBUFFER,this.depthbuffer_),this.data_=new Uint8Array(t[0]*t[1]*4)}}function getWorldParameters(l,t){const n=l.viewState.projection,o=t.getSource().getWrapX()&&n.canWrapX(),a=n.getExtent(),h=l.extent,c=o?getWidth(a):null,u=o?Math.ceil((h[2]-a[2])/c)+1:1;return[o?Math.floor((h[0]-a[0])/c):0,u,c]}const Uniforms={...DefaultUniform,RENDER_EXTENT:"u_renderExtent",PATTERN_ORIGIN:"u_patternOrigin",GLOBAL_ALPHA:"u_globalAlpha"};class WebGLVectorLayerRenderer extends WebGLLayerRenderer{constructor(t,n){const s={[Uniforms.RENDER_EXTENT]:[0,0,0,0],[Uniforms.PATTERN_ORIGIN]:[0,0],[Uniforms.GLOBAL_ALPHA]:1};super(t,{uniforms:s,postProcesses:n.postProcesses}),this.hitDetectionEnabled_=!n.disableHitDetection,this.hitRenderTarget_,this.sourceRevision_=-1,this.previousExtent_=createEmpty(),this.currentTransform_=create$2(),this.tmpCoords_=[0,0],this.tmpTransform_=create$2(),this.tmpMat4_=create$1(),this.currentFrameStateTransform_=create$2(),this.styleVariables_={},this.style_=[],this.styleRenderer_=null,this.buffers_=null,this.applyOptions_(n),this.batch_=new MixedGeometryBatch,this.initialFeaturesAdded_=!1,this.sourceListenKeys_=null}addInitialFeatures_(t){const n=this.getLayer().getSource();let s;this.batch_.addFeatures(n.getFeatures(),s),this.sourceListenKeys_=[listen(n,VectorEventType.ADDFEATURE,this.handleSourceFeatureAdded_.bind(this,s)),listen(n,VectorEventType.CHANGEFEATURE,this.handleSourceFeatureChanged_.bind(this,s),this),listen(n,VectorEventType.REMOVEFEATURE,this.handleSourceFeatureDelete_,this),listen(n,VectorEventType.CLEAR,this.handleSourceFeatureClear_,this)]}applyOptions_(t){this.styleVariables_=t.variables,this.style_=t.style}createRenderers_(){this.buffers_=null,this.styleRenderer_=new VectorStyleRenderer(this.style_,this.styleVariables_,this.helper,this.hitDetectionEnabled_)}reset(t){this.applyOptions_(t),this.helper&&this.createRenderers_(),super.reset(t)}afterHelperCreated(){this.styleRenderer_?this.styleRenderer_.setHelper(this.helper,this.buffers_):this.createRenderers_(),this.hitDetectionEnabled_&&(this.hitRenderTarget_=new WebGLRenderTarget(this.helper))}handleSourceFeatureAdded_(t,n){const s=n.feature;this.batch_.addFeature(s,t)}handleSourceFeatureChanged_(t,n){const s=n.feature;this.batch_.changeFeature(s,t)}handleSourceFeatureDelete_(t){const n=t.feature;this.batch_.removeFeature(n)}handleSourceFeatureClear_(){this.batch_.clear()}applyUniforms_(t){setFromArray(this.tmpTransform_,this.currentFrameStateTransform_),multiply(this.tmpTransform_,t),this.helper.setUniformMatrixValue(Uniforms.PROJECTION_MATRIX,fromTransform(this.tmpMat4_,this.tmpTransform_)),makeInverse(this.tmpTransform_,this.tmpTransform_),this.helper.setUniformMatrixValue(Uniforms.SCREEN_TO_WORLD_MATRIX,fromTransform(this.tmpMat4_,this.tmpTransform_)),this.tmpCoords_[0]=0,this.tmpCoords_[1]=0,makeInverse(this.tmpTransform_,t),apply(this.tmpTransform_,this.tmpCoords_),this.helper.setUniformFloatVec2(Uniforms.PATTERN_ORIGIN,this.tmpCoords_)}renderFrame(t){const n=this.helper.getGL();this.preRender(n,t);const[s,o,a]=getWorldParameters(t,this.getLayer());this.helper.prepareDraw(t),this.renderWorlds(t,!1,s,o,a),this.helper.finalizeDraw(t,this.dispatchPreComposeEvent,this.dispatchPostComposeEvent);const h=this.helper.getCanvas();return this.hitDetectionEnabled_&&(this.renderWorlds(t,!0,s,o,a),this.hitRenderTarget_.clearCachedData()),this.postRender(n,t),h}prepareFrameInternal(t){this.initialFeaturesAdded_||(this.addInitialFeatures_(t),this.initialFeaturesAdded_=!0);const n=this.getLayer(),s=n.getSource(),o=t.viewState,a=!t.viewHints[ViewHint.ANIMATING]&&!t.viewHints[ViewHint.INTERACTING],h=!equals$1(this.previousExtent_,t.extent),c=this.sourceRevision_<s.getRevision();if(c&&(this.sourceRevision_=s.getRevision()),a&&(h||c)){const u=o.projection,d=o.resolution,f=n instanceof BaseVectorLayer?n.getRenderBuffer():0,g=buffer(t.extent,f*d);s.loadFeatures(g,d,u),this.ready=!1;const _=this.helper.makeProjectionTransform(t,create$2());this.styleRenderer_.generateBuffers(this.batch_,_).then(m=>{this.buffers_&&this.disposeBuffers(this.buffers_),this.buffers_=m,this.ready=!0,this.getLayer().changed()}),this.previousExtent_=t.extent.slice()}return!0}renderWorlds(t,n,s,o,a){let h=s;n&&(this.hitRenderTarget_.setSize([Math.floor(t.size[0]/2),Math.floor(t.size[1]/2)]),this.helper.prepareDrawToRenderTarget(t,this.hitRenderTarget_,!0));do this.helper.makeProjectionTransform(t,this.currentFrameStateTransform_),translate$2(this.currentFrameStateTransform_,h*a,0),this.buffers_&&this.styleRenderer_.render(this.buffers_,t,()=>{this.applyUniforms_(this.buffers_.invertVerticesTransform),this.helper.applyHitDetectionUniform(n)});while(++h<o)}forEachFeatureAtCoordinate(t,n,s,o,a){if(assert(this.hitDetectionEnabled_,"`forEachFeatureAtCoordinate` cannot be used on a WebGL layer if the hit detection logic has been disabled using the `disableHitDetection: true` option."),!this.styleRenderer_||!this.hitDetectionEnabled_)return;const h=apply(n.coordinateToPixelTransform,t.slice()),c=this.hitRenderTarget_.readPixel(h[0]/2,h[1]/2),u=[c[0]/255,c[1]/255,c[2]/255,c[3]/255],d=colorDecodeId(u),f=this.batch_.getFeatureFromRef(d);if(f)return o(f,this.getLayer(),null)}disposeBuffers(t){const n=s=>{for(const o of s)o&&this.helper.deleteBuffer(o)};t.pointBuffers&&n(t.pointBuffers),t.lineStringBuffers&&n(t.lineStringBuffers),t.polygonBuffers&&n(t.polygonBuffers)}disposeInternal(){this.buffers_&&this.disposeBuffers(this.buffers_),this.sourceListenKeys_&&(this.sourceListenKeys_.forEach(function(t){unlistenByKey(t)}),this.sourceListenKeys_=null),super.disposeInternal()}renderDeclutter(){}}const Property={BLUR:"blur",GRADIENT:"gradient",RADIUS:"radius"},DEFAULT_GRADIENT=["#00f","#0ff","#0f0","#ff0","#f00"];class Heatmap extends BaseVectorLayer{constructor(t){t=t||{};const n=Object.assign({},t);delete n.gradient,delete n.radius,delete n.blur,delete n.weight,super(n),this.filter_=t.filter??!0,this.styleVariables_=t.variables||{},this.gradient_=null,this.addChangeListener(Property.GRADIENT,this.handleGradientChanged_),this.setGradient(t.gradient?t.gradient:DEFAULT_GRADIENT),this.setBlur(t.blur!==void 0?t.blur:15),this.setRadius(t.radius!==void 0?t.radius:8);const s=t.weight?t.weight:"weight";this.weight_=s,this.setRenderOrder(null)}getBlur(){return this.get(Property.BLUR)}getGradient(){return this.get(Property.GRADIENT)}getRadius(){return this.get(Property.RADIUS)}handleGradientChanged_(){this.gradient_=createGradient(this.getGradient())}setBlur(t){const n=this.get(Property.BLUR);if(this.set(Property.BLUR,t),typeof t=="number"&&typeof n=="number"){this.changed();return}this.clearRenderer()}setGradient(t){this.set(Property.GRADIENT,t)}setRadius(t){const n=this.get(Property.RADIUS);if(this.set(Property.RADIUS,t),typeof t=="number"&&typeof n=="number"){this.changed();return}this.clearRenderer()}setFilter(t){this.filter_=t,this.changed(),this.clearRenderer()}setWeight(t){this.weight_=t,this.changed(),this.clearRenderer()}createRenderer(){const t=new ShaderBuilder,n=newCompilationContext(),s=expressionToGlsl(n,this.filter_,BooleanType);let o=expressionToGlsl(n,this.getRadius(),NumberType),a=expressionToGlsl(n,this.getBlur(),NumberType);const h={};typeof this.getBlur()=="number"&&(a="a_blur",h.a_blur=()=>this.getBlur(),t.addUniform("a_blur","float")),typeof this.getRadius()=="number"&&(o="a_radius",h.a_radius=()=>this.getRadius(),t.addUniform("a_radius","float"));const c={};let u=null;if(typeof this.weight_=="string"||typeof this.weight_=="function"){const g=typeof this.weight_=="string"?_=>_.get(this.weight_):this.weight_;c.prop_weight={size:1,callback:_=>{const m=g(_);return m!==void 0?clamp(m,0,1):1}},u="a_prop_weight",t.addAttribute("a_prop_weight","float")}else{const g=["clamp",this.weight_,0,1];u=expressionToGlsl(n,g,NumberType)}t.addFragmentShaderFunction(`float getBlurSlope() {
  float blur = max(1., ${a});
  float radius = ${o};
  return radius / blur;
}`).setSymbolSizeExpression(`vec2(${o} + ${a}) * 2.`).setSymbolColorExpression(`vec4(smoothstep(0., 1., (1. - length(coordsPx * 2. / v_quadSizePx)) * getBlurSlope()) * ${u})`).setStrokeColorExpression(`vec4(smoothstep(0., 1., (1. - length(currentRadiusPx * 2. / v_width)) * getBlurSlope()) * ${u})`).setStrokeWidthExpression(`(${o} + ${a}) * 2.`).setFillColorExpression(`vec4(${u})`).setFragmentDiscardExpression(`!${s}`),applyContextToBuilder(t,n);const d=generateAttributesFromContext(n),f=generateUniformsFromContext(n,this.styleVariables_);return new WebGLVectorLayerRenderer(this,{className:this.getClassName(),variables:this.styleVariables_,style:{builder:t,attributes:{...d,...c},uniforms:{...f,...h}},disableHitDetection:!1,postProcesses:[{fragmentShader:`
            precision mediump float;

            uniform sampler2D u_image;
            uniform sampler2D u_gradientTexture;
            uniform float u_opacity;

            varying vec2 v_texCoord;

            void main() {
              vec4 color = texture2D(u_image, v_texCoord);
              gl_FragColor.a = color.a * u_opacity;
              gl_FragColor.rgb = texture2D(u_gradientTexture, vec2(0.5, color.a)).rgb;
              gl_FragColor.rgb *= gl_FragColor.a;
            }`,uniforms:{u_gradientTexture:()=>this.gradient_,u_opacity:()=>this.getOpacity()}}]})}updateStyleVariables(t){Object.assign(this.styleVariables_,t),this.changed()}renderDeclutter(){}}function createGradient(l){const s=createCanvasContext2D(1,256),o=s.createLinearGradient(0,0,1,256),a=1/(l.length-1);for(let h=0,c=l.length;h<c;++h)o.addColorStop(h*a,l[h]);return s.fillStyle=o,s.fillRect(0,0,1,256),s.canvas}class ImageCanvas extends ImageWrapper{constructor(t,n,s,o,a){const h=a!==void 0?ImageState.IDLE:ImageState.LOADED;super(t,n,s,h),this.loader_=a!==void 0?a:null,this.canvas_=o,this.error_=null}getError(){return this.error_}handleLoad_(t){t?(this.error_=t,this.state=ImageState.ERROR):this.state=ImageState.LOADED,this.changed()}load(){this.state==ImageState.IDLE&&(this.state=ImageState.LOADING,this.changed(),this.loader_(this.handleLoad_.bind(this)))}getImage(){return this.canvas_}}class CanvasVectorImageLayerRenderer extends CanvasImageLayerRenderer{constructor(t){super(t),this.vectorRenderer_=new CanvasVectorLayerRenderer(t),this.layerImageRatio_=t.getImageRatio(),this.coordinateToVectorPixelTransform_=create$2(),this.renderedPixelToCoordinateTransform_=null}disposeInternal(){this.vectorRenderer_.dispose(),super.disposeInternal()}getFeatures(t){if(!this.vectorRenderer_)return Promise.resolve([]);const n=apply(this.coordinateToVectorPixelTransform_,apply(this.renderedPixelToCoordinateTransform_,t.slice()));return this.vectorRenderer_.getFeatures(n)}handleFontsChanged(){this.vectorRenderer_.handleFontsChanged()}prepareFrame(t){var f;const n=t.pixelRatio,s=t.viewState,o=s.resolution,a=t.viewHints,h=this.vectorRenderer_;let c=t.extent;this.layerImageRatio_!==1&&(c=c.slice(0),scaleFromCenter(c,this.layerImageRatio_));const u=getWidth(c)/o,d=getHeight(c)/o;if(!a[ViewHint.ANIMATING]&&!a[ViewHint.INTERACTING]&&!isEmpty(c)){h.useContainer(null,null);const g=h.context,_=t.layerStatesArray[t.layerIndex],m=Object.assign({},_,{opacity:1}),p=Object.assign({},t,{extent:c,size:[u,d],viewState:Object.assign({},t.viewState,{rotation:0}),layerStatesArray:[m],layerIndex:0,declutter:null}),x=this.getLayer().getDeclutter();x&&(p.declutter={[x]:new RBush$1(9)});const y=new ImageCanvas(c,o,n,g.canvas,function(T){h.prepareFrame(p)&&h.replayGroupChanged&&(h.clipping=!1,h.renderFrame(p,null),h.renderDeclutter(p),h.renderDeferred(p),T())});y.addEventListener(EventType$1.CHANGE,()=>{if(y.getState()!==ImageState.LOADED)return;this.image=y;const T=y.getPixelRatio(),S=fromResolutionLike(y.getResolution())*n/T;this.renderedResolution=S,this.coordinateToVectorPixelTransform_=compose(this.coordinateToVectorPixelTransform_,u/2,d/2,1/S,-1/S,0,-s.center[0],-s.center[1])}),y.load()}return this.image&&(this.renderedPixelToCoordinateTransform_=t.pixelToCoordinateTransform.slice()),!((f=this.getLayer().getSource())!=null&&f.loading)&&!!this.image}preRender(){}postRender(){}renderDeclutter(){}forEachFeatureAtCoordinate(t,n,s,o,a){return this.vectorRenderer_?this.vectorRenderer_.forEachFeatureAtCoordinate(t,n,s,o,a):super.forEachFeatureAtCoordinate(t,n,s,o,a)}}class VectorImageLayer extends BaseVectorLayer{constructor(t){t=t||{};const n=Object.assign({},t);delete n.imageRatio,super(n),this.imageRatio_=t.imageRatio!==void 0?t.imageRatio:1}getImageRatio(){return this.imageRatio_}createRenderer(){return new CanvasVectorImageLayerRenderer(this)}}class WebGLPointsLayerRenderer extends WebGLLayerRenderer{constructor(t,n){const s=n.uniforms||{},o=create$2();s[DefaultUniform.PROJECTION_MATRIX]=o,super(t,{uniforms:s,postProcesses:n.postProcesses}),this.sourceRevision_=-1,this.verticesBuffer_=new WebGLArrayBuffer(ARRAY_BUFFER,DYNAMIC_DRAW),this.instanceAttributesBuffer_=new WebGLArrayBuffer(ARRAY_BUFFER,DYNAMIC_DRAW),this.indicesBuffer_=new WebGLArrayBuffer(ELEMENT_ARRAY_BUFFER,DYNAMIC_DRAW),this.vertexShader_=n.vertexShader,this.fragmentShader_=n.fragmentShader,this.program_,this.hitDetectionEnabled_=n.hitDetectionEnabled??!0;const a=n.attributes?n.attributes.map(function(c){return{name:"a_"+c.name,size:1,type:AttributeType.FLOAT}}):[];this.attributes=[{name:"a_localPosition",size:2,type:AttributeType.FLOAT}],this.instanceAttributes=[{name:"a_position",size:2,type:AttributeType.FLOAT}],this.hitDetectionEnabled_&&(this.instanceAttributes.push({name:"a_hitColor",size:2,type:AttributeType.FLOAT}),this.instanceAttributes.push({name:"a_featureUid",size:1,type:AttributeType.FLOAT})),this.instanceAttributes.push(...a),this.customAttributes=n.attributes?n.attributes:[],this.previousExtent_=createEmpty(),this.currentTransform_=o,this.renderTransform_=create$2(),this.invertRenderTransform_=create$2(),this.renderInstructions_=new Float32Array(0),this.hitRenderTarget_,this.lastSentId=0,this.worker_=create(),this.worker_.addEventListener("message",c=>{const u=c.data;if(u.type===WebGLWorkerMessageType.GENERATE_POINT_BUFFERS){const d=u.projectionTransform;this.verticesBuffer_.fromArrayBuffer(u.vertexAttributesBuffer),this.instanceAttributesBuffer_.fromArrayBuffer(u.instanceAttributesBuffer),this.helper.flushBufferData(this.verticesBuffer_),this.helper.flushBufferData(this.instanceAttributesBuffer_),this.indicesBuffer_.fromArrayBuffer(u.indicesBuffer),this.helper.flushBufferData(this.indicesBuffer_),this.renderTransform_=d,makeInverse(this.invertRenderTransform_,this.renderTransform_),this.renderInstructions_=new Float32Array(c.data.renderInstructions),u.id===this.lastSentId&&(this.ready=!0),this.getLayer().changed()}}),this.featureCache_={},this.featureCount_=0;const h=this.getLayer().getSource();this.sourceListenKeys_=[listen(h,VectorEventType.ADDFEATURE,this.handleSourceFeatureAdded_,this),listen(h,VectorEventType.CHANGEFEATURE,this.handleSourceFeatureChanged_,this),listen(h,VectorEventType.REMOVEFEATURE,this.handleSourceFeatureDelete_,this),listen(h,VectorEventType.CLEAR,this.handleSourceFeatureClear_,this)],h.forEachFeature(c=>{const u=c.getGeometry();u&&u.getType()==="Point"&&(this.featureCache_[getUid(c)]={feature:c,properties:c.getProperties(),flatCoordinates:u.getFlatCoordinates()},this.featureCount_++)})}afterHelperCreated(){this.program_=this.helper.getProgram(this.fragmentShader_,this.vertexShader_),this.hitDetectionEnabled_&&(this.hitRenderTarget_=new WebGLRenderTarget(this.helper)),this.verticesBuffer_.getArray()&&this.helper.flushBufferData(this.verticesBuffer_),this.indicesBuffer_.getArray()&&this.helper.flushBufferData(this.indicesBuffer_)}handleSourceFeatureAdded_(t){const n=t.feature,s=n.getGeometry();s&&s.getType()==="Point"&&(this.featureCache_[getUid(n)]={feature:n,properties:n.getProperties(),flatCoordinates:s.getFlatCoordinates()},this.featureCount_++)}handleSourceFeatureChanged_(t){const n=t.feature,s=getUid(n),o=this.featureCache_[s],a=n.getGeometry();o?a&&a.getType()==="Point"?(o.properties=n.getProperties(),o.flatCoordinates=a.getFlatCoordinates()):(delete this.featureCache_[s],this.featureCount_--):a&&a.getType()==="Point"&&(this.featureCache_[s]={feature:n,properties:n.getProperties(),flatCoordinates:a.getFlatCoordinates()},this.featureCount_++)}handleSourceFeatureDelete_(t){const n=t.feature,s=getUid(n);s in this.featureCache_&&(delete this.featureCache_[s],this.featureCount_--)}handleSourceFeatureClear_(){this.featureCache_={},this.featureCount_=0}renderFrame(t){const n=this.helper.getGL();this.preRender(n,t);const[s,o,a]=getWorldParameters(t,this.getLayer());return this.renderWorlds(t,!1,s,o,a),this.helper.finalizeDraw(t,this.dispatchPreComposeEvent,this.dispatchPostComposeEvent),this.hitDetectionEnabled_&&(this.renderWorlds(t,!0,s,o,a),this.hitRenderTarget_.clearCachedData()),this.postRender(n,t),this.helper.getCanvas()}prepareFrameInternal(t){const n=this.getLayer(),s=n.getSource(),o=t.viewState,a=!t.viewHints[ViewHint.ANIMATING]&&!t.viewHints[ViewHint.INTERACTING],h=!equals$1(this.previousExtent_,t.extent),c=this.sourceRevision_<s.getRevision();if(c&&(this.sourceRevision_=s.getRevision()),a&&(h||c)){const u=o.projection,d=o.resolution,f=n instanceof BaseVectorLayer?n.getRenderBuffer():0,g=buffer(t.extent,f*d);s.loadFeatures(g,d,u),this.rebuildBuffers_(t),this.previousExtent_=t.extent.slice()}return this.helper.useProgram(this.program_,t),this.helper.prepareDraw(t),!0}rebuildBuffers_(t){const n=create$2();this.helper.makeProjectionTransform(t,n);const o=(this.hitDetectionEnabled_?5:2)+this.customAttributes.length,a=o*this.featureCount_,h=this.renderInstructions_&&this.renderInstructions_.length===a?this.renderInstructions_:new Float32Array(a);this.renderInstructions_=null;let c=[];const u=[];let d=-1;t.viewState.projection;for(const g in this.featureCache_){const _=this.featureCache_[g];if(c[0]=_.flatCoordinates[0],c[1]=_.flatCoordinates[1],apply(n,c),h[++d]=c[0],h[++d]=c[1],this.hitDetectionEnabled_){const m=colorEncodeIdAndPack(d+3,u);h[++d]=m[0],h[++d]=m[1],h[++d]=Number(g)}for(let m=0;m<this.customAttributes.length;m++){const p=this.customAttributes[m].callback(_.feature,_.properties);h[++d]=p}}const f={id:++this.lastSentId,type:WebGLWorkerMessageType.GENERATE_POINT_BUFFERS,renderInstructions:h.buffer,customAttributesSize:o-2};f.projectionTransform=n,this.ready=!1,this.worker_.postMessage(f,[h.buffer])}forEachFeatureAtCoordinate(t,n,s,o,a){if(assert(this.hitDetectionEnabled_,"`forEachFeatureAtCoordinate` cannot be used on a WebGL layer if the hit detection logic has been disabled using the `disableHitDetection: true` option."),!this.renderInstructions_||!this.hitDetectionEnabled_)return;const h=apply(n.coordinateToPixelTransform,t.slice()),c=this.hitRenderTarget_.readPixel(h[0]/2,h[1]/2),u=[c[0]/255,c[1]/255,c[2]/255,c[3]/255],d=colorDecodeId(u),f=this.renderInstructions_[d],g=Math.floor(f).toString(),m=this.getLayer().getSource().getFeatureByUid(g);if(m)return o(m,this.getLayer(),null)}renderWorlds(t,n,s,o,a){let h=s;this.helper.useProgram(this.program_,t),n&&(this.hitRenderTarget_.setSize([Math.floor(t.size[0]/2),Math.floor(t.size[1]/2)]),this.helper.prepareDrawToRenderTarget(t,this.hitRenderTarget_,!0));const c=this.instanceAttributes.reduce((d,f)=>d+(f.size||1),0),u=this.instanceAttributesBuffer_.getSize()/c;do{this.helper.bindBuffer(this.indicesBuffer_),this.helper.bindBuffer(this.verticesBuffer_),this.helper.enableAttributes(this.attributes),this.helper.bindBuffer(this.instanceAttributesBuffer_),this.helper.enableAttributesInstanced(this.instanceAttributes),this.helper.makeProjectionTransform(t,this.currentTransform_),translate$2(this.currentTransform_,h*a,0),multiply(this.currentTransform_,this.invertRenderTransform_),this.helper.applyUniforms(t),this.helper.applyHitDetectionUniform(n);const d=this.indicesBuffer_.getSize();this.helper.drawElementsInstanced(0,d,u)}while(++h<o)}disposeInternal(){this.worker_.terminate(),this.sourceListenKeys_.forEach(function(t){unlistenByKey(t)}),this.sourceListenKeys_=null,super.disposeInternal()}renderDeclutter(){}}class WebGLPointsLayer extends Layer{constructor(t){const n=Object.assign({},t);super(n),this.styleVariables_=t.variables||{},this.parseResult_=parseLiteralStyle(t.style,this.styleVariables_,t.filter),this.hitDetectionDisabled_=!!t.disableHitDetection}createRenderer(){const t=Object.keys(this.parseResult_.attributes).map(n=>({name:n,...this.parseResult_.attributes[n]}));return new WebGLPointsLayerRenderer(this,{vertexShader:this.parseResult_.builder.getSymbolVertexShader(),fragmentShader:this.parseResult_.builder.getSymbolFragmentShader(),hitDetectionEnabled:!this.hitDetectionDisabled_,uniforms:this.parseResult_.uniforms,attributes:t})}updateStyleVariables(t){Object.assign(this.styleVariables_,t),this.changed()}}function parseStyle(l,t){const n=`
    attribute vec2 ${Attributes$1.TEXTURE_COORD};
    uniform mat4 ${Uniforms$1.TILE_TRANSFORM};
    uniform float ${Uniforms$1.TEXTURE_PIXEL_WIDTH};
    uniform float ${Uniforms$1.TEXTURE_PIXEL_HEIGHT};
    uniform float ${Uniforms$1.TEXTURE_RESOLUTION};
    uniform float ${Uniforms$1.TEXTURE_ORIGIN_X};
    uniform float ${Uniforms$1.TEXTURE_ORIGIN_Y};
    uniform float ${Uniforms$1.DEPTH};

    varying vec2 v_textureCoord;
    varying vec2 v_mapCoord;

    void main() {
      v_textureCoord = ${Attributes$1.TEXTURE_COORD};
      v_mapCoord = vec2(
        ${Uniforms$1.TEXTURE_ORIGIN_X} + ${Uniforms$1.TEXTURE_RESOLUTION} * ${Uniforms$1.TEXTURE_PIXEL_WIDTH} * v_textureCoord[0],
        ${Uniforms$1.TEXTURE_ORIGIN_Y} - ${Uniforms$1.TEXTURE_RESOLUTION} * ${Uniforms$1.TEXTURE_PIXEL_HEIGHT} * v_textureCoord[1]
      );
      gl_Position = ${Uniforms$1.TILE_TRANSFORM} * vec4(${Attributes$1.TEXTURE_COORD}, ${Uniforms$1.DEPTH}, 1.0);
    }
  `,s={...newCompilationContext(),bandCount:t},o=[];if(l.color!==void 0){const g=expressionToGlsl(s,l.color,ColorType);o.push(`color = ${g};`)}if(l.contrast!==void 0){const g=expressionToGlsl(s,l.contrast,NumberType);o.push(`color.rgb = clamp((${g} + 1.0) * color.rgb - (${g} / 2.0), vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0));`)}if(l.exposure!==void 0){const g=expressionToGlsl(s,l.exposure,NumberType);o.push(`color.rgb = clamp((${g} + 1.0) * color.rgb, vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0));`)}if(l.saturation!==void 0){const g=expressionToGlsl(s,l.saturation,NumberType);o.push(`
      float saturation = ${g} + 1.0;
      float sr = (1.0 - saturation) * 0.2126;
      float sg = (1.0 - saturation) * 0.7152;
      float sb = (1.0 - saturation) * 0.0722;
      mat3 saturationMatrix = mat3(
        sr + saturation, sr, sr,
        sg, sg + saturation, sg,
        sb, sb, sb + saturation
      );
      color.rgb = clamp(saturationMatrix * color.rgb, vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0));
    `)}if(l.gamma!==void 0){const g=expressionToGlsl(s,l.gamma,NumberType);o.push(`color.rgb = pow(color.rgb, vec3(1.0 / ${g}));`)}if(l.brightness!==void 0){const g=expressionToGlsl(s,l.brightness,NumberType);o.push(`color.rgb = clamp(color.rgb + ${g}, vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0));`)}const a={},h=Object.keys(s.variables).length;if(h>1&&!l.variables)throw new Error(`Missing variables in style (expected ${s.variables})`);for(let g=0;g<h;++g){const _=s.variables[Object.keys(s.variables)[g]];if(!(_.name in l.variables))throw new Error(`Missing '${_.name}' in style variables`);const m=uniformNameForVariable(_.name);a[m]=function(){let p=l.variables[_.name];return typeof p=="string"&&(p=getStringNumberEquivalent(p)),p!==void 0?p:-9999999}}const c=Object.keys(a).map(function(g){return`uniform float ${g};`}),u=Math.ceil(t/4);c.push(`uniform sampler2D ${Uniforms$1.TILE_TEXTURE_ARRAY}[${u}];`),s.paletteTextures&&c.push(`uniform sampler2D ${PALETTE_TEXTURE_ARRAY}[${s.paletteTextures.length}];`);const d=Object.keys(s.functions).map(function(g){return s.functions[g]}),f=`
    #ifdef GL_FRAGMENT_PRECISION_HIGH
    precision highp float;
    #else
    precision mediump float;
    #endif

    varying vec2 v_textureCoord;
    varying vec2 v_mapCoord;
    uniform vec4 ${Uniforms$1.RENDER_EXTENT};
    uniform float ${Uniforms$1.TRANSITION_ALPHA};
    uniform float ${Uniforms$1.TEXTURE_PIXEL_WIDTH};
    uniform float ${Uniforms$1.TEXTURE_PIXEL_HEIGHT};
    uniform float ${Uniforms$1.RESOLUTION};
    uniform float ${Uniforms$1.ZOOM};

    ${c.join(`
`)}

    ${d.join(`
`)}

    void main() {
      if (
        v_mapCoord[0] < ${Uniforms$1.RENDER_EXTENT}[0] ||
        v_mapCoord[1] < ${Uniforms$1.RENDER_EXTENT}[1] ||
        v_mapCoord[0] > ${Uniforms$1.RENDER_EXTENT}[2] ||
        v_mapCoord[1] > ${Uniforms$1.RENDER_EXTENT}[3]
      ) {
        discard;
      }

      vec4 color = texture2D(${Uniforms$1.TILE_TEXTURE_ARRAY}[0],  v_textureCoord);

      ${o.join(`
`)}

      gl_FragColor = color;
      gl_FragColor.rgb *= gl_FragColor.a;
      gl_FragColor *= ${Uniforms$1.TRANSITION_ALPHA};
    }`;return{vertexShader:n,fragmentShader:f,uniforms:a,paletteTextures:s.paletteTextures}}class WebGLTileLayer extends BaseTileLayer{constructor(t){t=t?Object.assign({},t):{};const n=t.style||{};delete t.style,super(t),this.sources_=t.sources,this.renderedSource_=null,this.renderedResolution_=NaN,this.style_=n,this.styleVariables_=this.style_.variables||{},this.handleSourceUpdate_(),this.addChangeListener(LayerProperty.SOURCE,this.handleSourceUpdate_)}getSources(t,n){const s=this.getSource();return this.sources_?typeof this.sources_=="function"?this.sources_(t,n):this.sources_:s?[s]:[]}getRenderSource(){return this.renderedSource_||this.getSource()}getSourceState(){const t=this.getRenderSource();return t?t.getState():"undefined"}handleSourceUpdate_(){this.hasRenderer()&&this.getRenderer().clearCache();const t=this.getSource();if(t)if(t.getState()==="loading"){const n=()=>{t.getState()==="ready"&&(t.removeEventListener("change",n),this.setStyle(this.style_))};t.addEventListener("change",n)}else this.setStyle(this.style_)}getSourceBandCount_(){const t=Number.MAX_SAFE_INTEGER,n=this.getSources([-t,-t,t,t],t);return n&&n.length&&"bandCount"in n[0]?n[0].bandCount:4}createRenderer(){const t=parseStyle(this.style_,this.getSourceBandCount_());return new WebGLTileLayerRenderer(this,{vertexShader:t.vertexShader,fragmentShader:t.fragmentShader,uniforms:t.uniforms,cacheSize:this.getCacheSize(),paletteTextures:t.paletteTextures})}renderSources(t,n){const s=this.getRenderer();let o;for(let a=0,h=n.length;a<h;++a)this.renderedSource_=n[a],s.prepareFrame(t)&&(o=s.renderFrame(t));return o}render(t,n){this.rendered=!0;const s=t.viewState,o=this.getSources(t.extent,s.resolution);let a=!0;for(let c=0,u=o.length;c<u;++c){const d=o[c],f=d.getState();if(f=="loading"){const g=()=>{d.getState()=="ready"&&(d.removeEventListener("change",g),this.changed())};d.addEventListener("change",g)}a=a&&f=="ready"}const h=this.renderSources(t,o);if(this.getRenderer().renderComplete&&a)return this.renderedResolution_=s.resolution,h;if(this.renderedResolution_>.5*s.resolution){const c=this.getSources(t.extent,this.renderedResolution_).filter(u=>!o.includes(u));if(c.length>0)return this.renderSources(t,c)}return h}setStyle(t){if(this.styleVariables_=t.variables||{},this.style_=t,this.hasRenderer()){const n=parseStyle(this.style_,this.getSourceBandCount_());this.getRenderer().reset({vertexShader:n.vertexShader,fragmentShader:n.fragmentShader,uniforms:n.uniforms,paletteTextures:n.paletteTextures}),this.changed()}}updateStyleVariables(t){Object.assign(this.styleVariables_,t),this.changed()}}WebGLTileLayer.prototype.dispose;class WebGLVectorLayer extends Layer{constructor(t){const n=Object.assign({},t);super(n),this.styleVariables_=t.variables||{},this.style_=t.style,this.hitDetectionDisabled_=!!t.disableHitDetection}createRenderer(){return new WebGLVectorLayerRenderer(this,{style:this.style_,variables:this.styleVariables_,disableHitDetection:this.hitDetectionDisabled_})}updateStyleVariables(t){Object.assign(this.styleVariables_,t),this.changed()}setStyle(t){this.style_=t,this.clearRenderer(),this.changed()}}class MapboxStyle extends LayerGroup{constructor(t={}){const{mapboxStyle:n,applyOptions:s,...o}=t;super(o),n&&this.applyMapboxStyle(n,s)}applyMapboxStyle(t,n){return apply$1(this,t,n)}}register(proj4);window.eoxMapAdvancedOlLayers={Graticule,Heatmap,Layer,VectorImage:VectorImageLayer,WebGLPoints:WebGLPointsLayer,WebGLTile:WebGLTileLayer,WebGLVector:WebGLVectorLayer,STAC:STACLayer,MapboxStyle};function quadKey(l){const t=l[0],n=new Array(t);let s=1<<t-1,o,a;for(o=0;o<t;++o)a=48,l[1]&s&&(a+=1),l[2]&s&&(a+=2),n[o]=String.fromCharCode(a),s>>=1;return n.join("")}const TOS_ATTRIBUTION='<a class="ol-attribution-bing-tos" href="https://www.microsoft.com/maps/product/terms.html" target="_blank">Terms of Use</a>';class BingMaps extends TileImage{constructor(t){const n=t.hidpi!==void 0?t.hidpi:!1;super({cacheSize:t.cacheSize,crossOrigin:"anonymous",interpolate:t.interpolate,projection:get$1("EPSG:3857"),reprojectionErrorThreshold:t.reprojectionErrorThreshold,state:"loading",tileLoadFunction:t.tileLoadFunction,tilePixelRatio:n?2:1,wrapX:t.wrapX!==void 0?t.wrapX:!0,transition:t.transition,zDirection:t.zDirection}),this.hidpi_=n,this.culture_=t.culture!==void 0?t.culture:"en-us",this.maxZoom_=t.maxZoom!==void 0?t.maxZoom:-1,this.apiKey_=t.key,this.imagerySet_=t.imagerySet,this.placeholderTiles_=t.placeholderTiles;const s=(t.url||"https://dev.virtualearth.net/REST/v1/Imagery/Metadata/")+this.imagerySet_+"?uriScheme=https&include=ImageryProviders&key="+this.apiKey_+"&c="+this.culture_;fetch(s).then(o=>o.json()).then(o=>this.handleImageryMetadataResponse(o))}getApiKey(){return this.apiKey_}getImagerySet(){return this.imagerySet_}handleImageryMetadataResponse(t){if(t.statusCode!=200||t.statusDescription!="OK"||t.authenticationResultCode!="ValidCredentials"||t.resourceSets.length!=1||t.resourceSets[0].resources.length!=1){this.setState("error");return}const n=t.resourceSets[0].resources[0],s=this.maxZoom_==-1?n.zoomMax:this.maxZoom_,o=this.getProjection(),a=extentFromProjection(o),h=this.hidpi_?2:1,c=n.imageWidth==n.imageHeight?n.imageWidth/h:[n.imageWidth/h,n.imageHeight/h],u=createXYZ({extent:a,minZoom:n.zoomMin,maxZoom:s,tileSize:c});this.tileGrid=u;const d=this.culture_,f=this.hidpi_,g=this.placeholderTiles_;if(this.tileUrlFunction=createFromTileUrlFunctions(n.imageUrlSubdomains.map(function(_){const m=[0,0,0],p=n.imageUrl.replace("{subdomain}",_).replace("{culture}",d);return function(x,y,T){if(!x)return;createOrUpdate(x[0],x[1],x[2],m);const S=new URL(p.replace("{quadkey}",quadKey(m))),C=S.searchParams;return f&&(C.set("dpi","d1"),C.set("device","mobile")),g===!0?C.delete("n"):g===!1&&C.set("n","z"),S.toString()}})),n.imageryProviders){const _=getTransformFromProjections(get$1("EPSG:4326"),this.getProjection());this.setAttributions(m=>{const p=[],x=m.viewState,y=this.getTileGrid(),T=y.getZForResolution(x.resolution,this.zDirection),C=y.getTileCoordForCoordAndZ(x.center,T)[0];return n.imageryProviders.map(function(P){let w=!1;const I=P.coverageAreas;for(let O=0,N=I.length;O<N;++O){const k=I[O];if(C>=k.zoomMin&&C<=k.zoomMax){const D=k.bbox,ze=[D[1],D[0],D[3],D[2]],z=applyTransform(ze,_);if(intersects$1(z,m.extent)){w=!0;break}}}w&&p.push(P.attribution)}),p.push(TOS_ATTRIBUTION),p})}this.setState("ready")}}class CartoDB extends XYZ{constructor(t){super({attributions:t.attributions,cacheSize:t.cacheSize,crossOrigin:t.crossOrigin,maxZoom:t.maxZoom!==void 0?t.maxZoom:18,minZoom:t.minZoom,projection:t.projection,transition:t.transition,wrapX:t.wrapX,zDirection:t.zDirection}),this.account_=t.account,this.mapId_=t.map||"",this.config_=t.config||{},this.templateCache_={},this.initializeMap_()}getConfig(){return this.config_}updateConfig(t){Object.assign(this.config_,t),this.initializeMap_()}setConfig(t){this.config_=t||{},this.initializeMap_()}initializeMap_(){const t=JSON.stringify(this.config_);if(this.templateCache_[t]){this.applyTemplate_(this.templateCache_[t]);return}let n="https://"+this.account_+".carto.com/api/v1/map";this.mapId_&&(n+="/named/"+this.mapId_);const s=new XMLHttpRequest;s.addEventListener("load",this.handleInitResponse_.bind(this,t)),s.addEventListener("error",this.handleInitError_.bind(this)),s.open("POST",n),s.setRequestHeader("Content-type","application/json"),s.send(JSON.stringify(this.config_))}handleInitResponse_(t,n){const s=n.target;if(!s.status||s.status>=200&&s.status<300){let o;try{o=JSON.parse(s.responseText)}catch{this.setState("error");return}this.applyTemplate_(o),this.templateCache_[t]=o,this.setState("ready")}else this.setState("error")}handleInitError_(t){this.setState("error")}applyTemplate_(t){const n="https://"+t.cdn_url.https+"/"+this.account_+"/api/v1/map/"+t.layergroupid+"/{z}/{x}/{y}.png";this.setUrl(n)}}const VERTEX_SHADER=`
  attribute vec4 a_position;
  attribute vec4 a_texcoord;

  uniform mat4 u_matrix;
  uniform mat4 u_textureMatrix;

  varying vec2 v_texcoord;

  void main() {
    gl_Position = u_matrix * a_position;
    vec2 texcoord = (u_textureMatrix * a_texcoord).xy;
    v_texcoord = texcoord;
  }
`,FRAGMENT_SHADER=`
  precision mediump float;

  varying vec2 v_texcoord;

  uniform sampler2D u_texture;

  void main() {
    if (
      v_texcoord.x < 0.0 ||
      v_texcoord.y < 0.0 ||
      v_texcoord.x > 1.0 ||
      v_texcoord.y > 1.0
    ) {
      discard;
    }
    gl_FragColor = texture2D(u_texture, v_texcoord);
  }
`;class Canvas{constructor(t){this.gl_=t,this.program_=createProgram(t,FRAGMENT_SHADER,VERTEX_SHADER),this.positionLocation=t.getAttribLocation(this.program_,"a_position"),this.texcoordLocation=t.getAttribLocation(this.program_,"a_texcoord"),this.matrixLocation=t.getUniformLocation(this.program_,"u_matrix"),this.textureMatrixLocation=t.getUniformLocation(this.program_,"u_textureMatrix"),this.textureLocation=t.getUniformLocation(this.program_,"u_texture"),this.positionBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.positionBuffer),this.positions=[0,0,0,1,1,0,1,0,0,1,1,1],t.bufferData(t.ARRAY_BUFFER,new Float32Array(this.positions),t.STATIC_DRAW),this.texcoordBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.texcoordBuffer),this.texcoords=[0,0,0,1,1,0,1,0,0,1,1,1],t.bufferData(t.ARRAY_BUFFER,new Float32Array(this.texcoords),t.STATIC_DRAW)}drawImage(t,n,s,o,a,h,c,u,d,f,g,_,m){const p=this.gl_;u===void 0&&(u=o),d===void 0&&(d=a),h===void 0&&(h=n),c===void 0&&(c=s),f===void 0&&(f=h),g===void 0&&(g=c),_===void 0&&(_=p.canvas.width),m===void 0&&(m=p.canvas.height),p.bindTexture(p.TEXTURE_2D,t),p.useProgram(this.program_),p.bindBuffer(p.ARRAY_BUFFER,this.positionBuffer),p.enableVertexAttribArray(this.positionLocation),p.vertexAttribPointer(this.positionLocation,2,p.FLOAT,!1,0,0),p.bindBuffer(p.ARRAY_BUFFER,this.texcoordBuffer),p.enableVertexAttribArray(this.texcoordLocation),p.vertexAttribPointer(this.texcoordLocation,2,p.FLOAT,!1,0,0);let x=orthographic(0,_,0,m,-1,1);x=translate(x,u,d,0),x=scale(x,f,g,1),p.uniformMatrix4fv(this.matrixLocation,!1,x);let y=translation(o/n,a/s,0);y=scale(y,h/n,c/s,1),p.uniformMatrix4fv(this.textureMatrixLocation,!1,y),p.uniform1i(this.textureLocation,0),p.drawArrays(p.TRIANGLES,0,this.positions.length/2)}}function createShader(l,t,n){const s=l.createShader(t);if(s===null)throw new Error("Shader compilation failed");if(l.shaderSource(s,n),l.compileShader(s),!l.getShaderParameter(s,l.COMPILE_STATUS)){const o=l.getShaderInfoLog(s);throw o===null?new Error("Shader info log creation failed"):new Error(o)}return s}function createProgram(l,t,n){const s=l.createProgram(),o=createShader(l,l.VERTEX_SHADER,n),a=createShader(l,l.FRAGMENT_SHADER,t);if(s===null)throw new Error("Program creation failed");if(l.attachShader(s,o),l.attachShader(s,a),l.linkProgram(s),!l.getProgramParameter(s,l.LINK_STATUS))throw l.getProgramInfoLog(s)===null?new Error("Program info log creation failed"):new Error;return s}const EDGE_VERTEX_SHADER=`
  attribute vec4 a_position;

  uniform mat4 u_matrix;

  void main() {
     gl_Position = u_matrix * a_position;
  }
`,EDGE_FRAGMENT_SHADER=`
  precision mediump float;

  uniform vec4 u_val;
  void main() {
     gl_FragColor = u_val;
  }
`,TRIANGLE_VERTEX_SHADER=`
  attribute vec4 a_position;
  attribute vec2 a_texcoord;

  varying vec2 v_texcoord;

  uniform mat4 u_matrix;

  void main() {
     gl_Position = u_matrix * a_position;
     v_texcoord = a_texcoord;
  }
`,TRIANGLE_FRAGMENT_SHADER=`
  precision mediump float;

  varying vec2 v_texcoord;

  uniform sampler2D u_texture;

  void main() {
    if (v_texcoord.x < 0.0 || v_texcoord.x > 1.0 || v_texcoord.y < 0.0 || v_texcoord.y > 1.0) {
      discard;
    }
    gl_FragColor = texture2D(u_texture, v_texcoord);
  }
`;function createCanvasContextWebGL(l,t,n,s){let o;return n&&n.length?o=n.shift():WORKER_OFFSCREEN_CANVAS?o=new OffscreenCanvas(l||300,t||300):o=document.createElement("canvas"),l&&(o.width=l),t&&(o.height=t),o.getContext("webgl",s)}function releaseGLCanvas(l){const t=l.canvas;t.width=1,t.height=1,l.clear(l.COLOR_BUFFER_BIT|l.DEPTH_BUFFER_BIT|l.STENCIL_BUFFER_BIT)}const canvasGLPool=[];function render(l,t,n,s,o,a,h,c,u,d,f,g,_,m){const p=Math.round(s*t),x=Math.round(s*n);l.canvas.width=p,l.canvas.height=x;let y,T;if(T=l.createTexture(),l.bindTexture(l.TEXTURE_2D,T),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_WRAP_S,l.CLAMP_TO_EDGE),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_WRAP_T,l.CLAMP_TO_EDGE),_?(l.texParameteri(l.TEXTURE_2D,l.TEXTURE_MIN_FILTER,l.LINEAR),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_MAG_FILTER,l.LINEAR)):(l.texParameteri(l.TEXTURE_2D,l.TEXTURE_MIN_FILTER,l.NEAREST),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_MAG_FILTER,l.NEAREST)),l.texImage2D(l.TEXTURE_2D,0,l.RGBA,p,x,0,l.RGBA,f,null),y=l.createFramebuffer(),l.bindFramebuffer(l.FRAMEBUFFER,y),l.framebufferTexture2D(l.FRAMEBUFFER,l.COLOR_ATTACHMENT0,l.TEXTURE_2D,T,0),y===null)throw new Error("Could not create framebuffer");if(T===null)throw new Error("Could not create texture");if(u.length===0)return{width:p,height:x,framebuffer:y,texture:T};const S=createEmpty();u.forEach(function(D,ze,z){extend$1(S,D.extent)});let C,P,w;const I=1/o;{if(C=l.createTexture(),T===null)throw new Error("Could not create texture");P=Math.round(getWidth(S)*I),w=Math.round(getHeight(S)*I);const D=l.getParameter(l.MAX_TEXTURE_SIZE),ze=Math.max(P,w),z=ze>D?D/ze:1,Ee=Math.round(P*z),B=Math.round(w*z);l.bindTexture(l.TEXTURE_2D,C),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_WRAP_S,l.CLAMP_TO_EDGE),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_WRAP_T,l.CLAMP_TO_EDGE),_?(l.texParameteri(l.TEXTURE_2D,l.TEXTURE_MIN_FILTER,l.LINEAR),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_MAG_FILTER,l.LINEAR)):(l.texParameteri(l.TEXTURE_2D,l.TEXTURE_MIN_FILTER,l.NEAREST),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_MAG_FILTER,l.NEAREST)),l.texImage2D(l.TEXTURE_2D,0,l.RGBA,Ee,B,0,l.RGBA,f,null);const rt=l.createFramebuffer();l.bindFramebuffer(l.FRAMEBUFFER,rt),l.framebufferTexture2D(l.FRAMEBUFFER,l.COLOR_ATTACHMENT0,l.TEXTURE_2D,C,0);const wt=new Canvas(l);u.forEach(function(re,mt,Mt){const Bt=(re.extent[0]-S[0])*I*z,Ht=-(re.extent[3]-S[3])*I*z,Nt=getWidth(re.extent)*I*z,Wt=getHeight(re.extent)*I*z;if(l.bindFramebuffer(l.FRAMEBUFFER,rt),l.viewport(0,0,Ee,B),re.clipExtent){const $t=(re.clipExtent[0]-S[0])*I*z,Zt=-(re.clipExtent[3]-S[3])*I*z,ki=getWidth(re.clipExtent)*I*z,Os=getHeight(re.clipExtent)*I*z;l.enable(l.SCISSOR_TEST),l.scissor(_?$t:Math.round($t),_?Zt:Math.round(Zt),_?ki:Math.round($t+ki)-Math.round($t),_?Os:Math.round(Zt+Os)-Math.round(Zt))}wt.drawImage(re.texture,re.width,re.height,d,d,re.width-2*d,re.height-2*d,_?Bt:Math.round(Bt),_?Ht:Math.round(Ht),_?Nt:Math.round(Bt+Nt)-Math.round(Bt),_?Wt:Math.round(Ht+Wt)-Math.round(Ht),Ee,B),l.disable(l.SCISSOR_TEST)}),l.deleteFramebuffer(rt)}const O=getTopLeft(h),N=getTopLeft(S),k=D=>{const ze=(D[0][0]-O[0])/a*s,z=-(D[0][1]-O[1])/a*s,Ee=(D[1][0]-O[0])/a*s,B=-(D[1][1]-O[1])/a*s,rt=(D[2][0]-O[0])/a*s,wt=-(D[2][1]-O[1])/a*s;return{u1:Ee,v1:B,u0:ze,v0:z,u2:rt,v2:wt}};l.bindFramebuffer(l.FRAMEBUFFER,y),l.viewport(0,0,p,x);{const D=[],ze=[],z=createProgram(l,TRIANGLE_FRAGMENT_SHADER,TRIANGLE_VERTEX_SHADER);l.useProgram(z);const Ee=l.getUniformLocation(z,"u_texture");l.bindTexture(l.TEXTURE_2D,C),l.uniform1i(Ee,0),c.getTriangles().forEach(function(Bt,Ht,Nt){const Wt=Bt.source,$t=Bt.target,{u1:Zt,v1:ki,u0:Os,v0:Rc,u2:Sc,v2:Lc}=k($t),tu=(Wt[0][0]-N[0])/o/P,hu=-(Wt[0][1]-N[1])/o/w,qc=(Wt[1][0]-N[0])/o/P,jc=-(Wt[1][1]-N[1])/o/w,Oc=(Wt[2][0]-N[0])/o/P,Fc=-(Wt[2][1]-N[1])/o/w;D.push(Zt,ki,Os,Rc,Sc,Lc),ze.push(qc,jc,tu,hu,Oc,Fc)});const B=orthographic(0,p,x,0,-1,1),rt=l.getUniformLocation(z,"u_matrix");l.uniformMatrix4fv(rt,!1,B);const wt=l.getAttribLocation(z,"a_position"),re=l.createBuffer();l.bindBuffer(l.ARRAY_BUFFER,re),l.bufferData(l.ARRAY_BUFFER,new Float32Array(D),l.STATIC_DRAW),l.vertexAttribPointer(wt,2,l.FLOAT,!1,0,0),l.enableVertexAttribArray(wt);const mt=l.getAttribLocation(z,"a_texcoord"),Mt=l.createBuffer();l.bindBuffer(l.ARRAY_BUFFER,Mt),l.bufferData(l.ARRAY_BUFFER,new Float32Array(ze),l.STATIC_DRAW),l.vertexAttribPointer(mt,2,l.FLOAT,!1,0,0),l.enableVertexAttribArray(mt),l.drawArrays(l.TRIANGLES,0,D.length/2)}if(g){const D=createProgram(l,EDGE_FRAGMENT_SHADER,EDGE_VERTEX_SHADER);l.useProgram(D);const ze=orthographic(0,p,x,0,-1,1),z=l.getUniformLocation(D,"u_matrix");l.uniformMatrix4fv(z,!1,ze);const Ee=Array.isArray(g)?g:[0,0,0,255],B=l.getUniformLocation(D,"u_val");l.uniform4fv(B,Ee);const rt=l.getAttribLocation(D,"a_position"),wt=l.createBuffer();l.bindBuffer(l.ARRAY_BUFFER,wt),l.vertexAttribPointer(rt,2,l.FLOAT,!1,0,0),l.enableVertexAttribArray(rt);const re=c.getTriangles().reduce(function(mt,Mt){const Bt=Mt.target,{u1:Ht,v1:Nt,u0:Wt,v0:$t,u2:Zt,v2:ki}=k(Bt);return mt.concat([Ht,Nt,Wt,$t,Wt,$t,Zt,ki,Zt,ki,Ht,Nt])},[]);l.bufferData(l.ARRAY_BUFFER,new Float32Array(re),l.STATIC_DRAW),l.drawArrays(l.LINES,0,re.length/2)}return{width:p,height:x,framebuffer:y,texture:T}}class ReprojDataTile extends DataTile{constructor(t){super({tileCoord:t.tileCoord,loader:()=>Promise.resolve(new Uint8ClampedArray(4)),interpolate:t.interpolate,transition:t.transition}),this.renderEdges_=t.renderEdges!==void 0?t.renderEdges:!1,this.pixelRatio_=t.pixelRatio,this.gutter_=t.gutter,this.reprojData_=null,this.reprojError_=null,this.reprojSize_=void 0,this.sourceTileGrid_=t.sourceTileGrid,this.targetTileGrid_=t.targetTileGrid,this.wrappedTileCoord_=t.wrappedTileCoord||t.tileCoord,this.sourceTiles_=[],this.sourcesListenerKeys_=null,this.sourceZ_=0;const n=t.sourceProj,s=n.getExtent(),o=t.sourceTileGrid.getExtent();this.clipExtent_=n.canWrapX()?o?getIntersection(s,o):s:o;const a=this.targetTileGrid_.getTileCoordExtent(this.wrappedTileCoord_),h=this.targetTileGrid_.getExtent();let c=this.sourceTileGrid_.getExtent();const u=h?getIntersection(a,h):a;if(getArea$1(u)===0){this.state=TileState.EMPTY;return}s&&(c?c=getIntersection(c,s):c=s);const d=this.targetTileGrid_.getResolution(this.wrappedTileCoord_[0]),f=t.targetProj,g=calculateSourceExtentResolution(n,f,u,d);if(!isFinite(g)||g<=0){this.state=TileState.EMPTY;return}const _=t.errorThreshold!==void 0?t.errorThreshold:ERROR_THRESHOLD;if(this.triangulation_=new Triangulation(n,f,u,c,g*_,d,t.transformMatrix),this.triangulation_.getTriangles().length===0){this.state=TileState.EMPTY;return}this.sourceZ_=this.sourceTileGrid_.getZForResolution(g);let m=this.triangulation_.calculateSourceExtent();if(c&&(n.canWrapX()?(m[1]=clamp(m[1],c[1],c[3]),m[3]=clamp(m[3],c[1],c[3])):m=getIntersection(m,c)),!getArea$1(m))this.state=TileState.EMPTY;else{let p=0,x=0;n.canWrapX()&&(p=getWidth(s),x=Math.floor((m[0]-s[0])/p)),wrapAndSliceX(m.slice(),n,!0).forEach(T=>{const S=this.sourceTileGrid_.getTileRangeForExtentAndZ(T,this.sourceZ_),C=t.getTileFunction;for(let P=S.minX;P<=S.maxX;P++)for(let w=S.minY;w<=S.maxY;w++){const I=C(this.sourceZ_,P,w,this.pixelRatio_);if(I){const O=x*p;this.sourceTiles_.push({tile:I,offset:O})}}++x}),this.sourceTiles_.length===0&&(this.state=TileState.EMPTY)}}getSize(){return this.reprojSize_}getData(){return this.reprojData_}getError(){return this.reprojError_}reproject_(){const t=[];let n=!1;if(this.sourceTiles_.forEach(P=>{var Ht;const w=P.tile;if(!w||w.getState()!==TileState.LOADED)return;const I=w.getSize(),O=this.gutter_;let N;const k=asArrayLike(w.getData());k?N=k:(n=!0,N=toArray(asImageLike(w.getData())));const D=[I[0]+2*O,I[1]+2*O],ze=N instanceof Float32Array,z=D[0]*D[1],Ee=ze?Float32Array:Uint8ClampedArray,B=new Ee(N.buffer),rt=Ee.BYTES_PER_ELEMENT,wt=rt*B.length/z,re=B.byteLength/D[1],mt=Math.floor(re/rt/D[0]),Mt=this.sourceTileGrid_.getTileCoordExtent(w.tileCoord);Mt[0]+=P.offset,Mt[2]+=P.offset;const Bt=(Ht=this.clipExtent_)==null?void 0:Ht.slice();Bt&&(Bt[0]+=P.offset,Bt[2]+=P.offset),t.push({extent:Mt,clipExtent:Bt,data:B,dataType:Ee,bytesPerPixel:wt,pixelSize:D,bandCount:mt})}),this.sourceTiles_.length=0,t.length===0){this.state=TileState.ERROR,this.changed();return}const s=this.wrappedTileCoord_[0],o=this.targetTileGrid_.getTileSize(s),a=typeof o=="number"?o:o[0],h=typeof o=="number"?o:o[1],c=Math.round(a*this.pixelRatio_),u=Math.round(h*this.pixelRatio_),d=this.targetTileGrid_.getResolution(s),f=this.sourceTileGrid_.getResolution(this.sourceZ_),g=this.targetTileGrid_.getTileCoordExtent(this.wrappedTileCoord_),_=t[0].bandCount,m=new t[0].dataType(_*c*u),p=createCanvasContextWebGL(c,u,canvasGLPool,{premultipliedAlpha:!1,antialias:!1});let x;const y=p.RGBA;let T;t[0].dataType==Float32Array?(T=p.FLOAT,p.getExtension("WEBGL_color_buffer_float"),p.getExtension("OES_texture_float"),p.getExtension("EXT_float_blend"),x=p.getExtension("OES_texture_float_linear")!==null&&this.interpolate):(T=p.UNSIGNED_BYTE,x=this.interpolate);const S=4,C=Math.ceil(_/S);for(let P=C-1;P>=0;--P){const w=[];for(let Ee=0,B=t.length;Ee<B;++Ee){const rt=t[Ee],wt=rt.pixelSize,re=wt[0],mt=wt[1],Mt=new rt.dataType(S*re*mt),Bt=rt.data;let Ht=P*S;for(let Wt=0,$t=Mt.length;Wt<$t;Wt+=S)Mt[Wt]=Bt[Ht],Mt[Wt+1]=Bt[Ht+1],Mt[Wt+2]=Bt[Ht+2],Mt[Wt+3]=Bt[Ht+3],Ht+=_;const Nt=p.createTexture();p.bindTexture(p.TEXTURE_2D,Nt),x?(p.texParameteri(p.TEXTURE_2D,p.TEXTURE_MIN_FILTER,p.LINEAR),p.texParameteri(p.TEXTURE_2D,p.TEXTURE_MAG_FILTER,p.LINEAR)):(p.texParameteri(p.TEXTURE_2D,p.TEXTURE_MIN_FILTER,p.NEAREST),p.texParameteri(p.TEXTURE_2D,p.TEXTURE_MAG_FILTER,p.NEAREST)),p.texParameteri(p.TEXTURE_2D,p.TEXTURE_WRAP_S,p.CLAMP_TO_EDGE),p.texParameteri(p.TEXTURE_2D,p.TEXTURE_WRAP_T,p.CLAMP_TO_EDGE),p.texImage2D(p.TEXTURE_2D,0,y,re,mt,0,y,T,Mt),w.push({extent:rt.extent,clipExtent:rt.clipExtent,texture:Nt,width:re,height:mt})}const{framebuffer:I,width:O,height:N}=render(p,a,h,this.pixelRatio_,f,d,g,this.triangulation_,w,this.gutter_,T,this.renderEdges_,x),k=O,D=N*S,ze=new t[0].dataType(k*D);p.bindFramebuffer(p.FRAMEBUFFER,I),p.readPixels(0,0,O,N,p.RGBA,T,ze);let z=P*S;for(let Ee=0,B=ze.length;Ee<B;Ee+=S){const rt=(k-1-(Ee/D|0))*D+Ee%D;m[z]=ze[rt],m[z+1]=ze[rt+1],m[z+2]=ze[rt+2],m[z+3]=ze[rt+3],z+=_}}if(releaseGLCanvas(p),canvasGLPool.push(p.canvas),n){const P=createCanvasContext2D(a,h),w=new ImageData(m,a);P.putImageData(w,0,0),this.reprojData_=P.canvas}else this.reprojData_=m;this.reprojSize_=[c,u],this.state=TileState.LOADED,this.changed()}load(){if(this.state!==TileState.IDLE&&this.state!==TileState.ERROR)return;this.state=TileState.LOADING,this.changed();let t=0;this.sourcesListenerKeys_=[],this.sourceTiles_.forEach(({tile:n})=>{const s=n.getState();if(s!==TileState.IDLE&&s!==TileState.LOADING)return;t++;const o=listen(n,EventType$1.CHANGE,()=>{const a=n.getState();(a==TileState.LOADED||a==TileState.ERROR||a==TileState.EMPTY)&&(unlistenByKey(o),t--,t===0&&(this.unlistenSources_(),this.reproject_()))});this.sourcesListenerKeys_.push(o)}),t===0?setTimeout(this.reproject_.bind(this),0):this.sourceTiles_.forEach(function({tile:n}){n.getState()==TileState.IDLE&&n.load()})}unlistenSources_(){this.sourcesListenerKeys_.forEach(unlistenByKey),this.sourcesListenerKeys_=null}}class DataTileSource extends TileSource{constructor(t){const n=t.projection===void 0?"EPSG:3857":t.projection;let s=t.tileGrid;s===void 0&&n&&(s=createXYZ({extent:extentFromProjection(n),maxResolution:t.maxResolution,maxZoom:t.maxZoom,minZoom:t.minZoom,tileSize:t.tileSize})),super({cacheSize:.1,attributions:t.attributions,attributionsCollapsible:t.attributionsCollapsible,projection:n,tileGrid:s,state:t.state,wrapX:t.wrapX,transition:t.transition,interpolate:t.interpolate,key:t.key,zDirection:t.zDirection}),this.gutter_=t.gutter!==void 0?t.gutter:0,this.tileSize_=t.tileSize?toSize(t.tileSize):null,this.tileSizes_=null,this.tileLoadingKeys_={},this.loader_=t.loader,this.handleTileChange_=this.handleTileChange_.bind(this),this.bandCount=t.bandCount===void 0?4:t.bandCount,this.tileGridForProjection_={},this.crossOrigin_=t.crossOrigin||"anonymous",this.transformMatrix=null}setTileSizes(t){this.tileSizes_=t}getTileSize(t){if(this.tileSizes_)return this.tileSizes_[t];if(this.tileSize_)return this.tileSize_;const n=this.getTileGrid();return n?toSize(n.getTileSize(t)):[256,256]}getGutterForProjection(t){const n=this.getProjection();return(!n||equivalent$1(n,t))&&!this.transformMatrix?this.gutter_:0}setLoader(t){this.loader_=t}getReprojTile_(t,n,s,o,a,h){const c=this.tileGrid||this.getTileGridForProjection(a||o),u=Math.max.apply(null,c.getResolutions().map((p,x)=>{const y=toSize(c.getTileSize(x)),T=this.getTileSize(x);return Math.max(T[0]/y[0],T[1]/y[1])})),d=this.getTileGridForProjection(o),f=[t,n,s],g=this.getTileCoordForTileUrlFunction(f,o),_=Object.assign({sourceProj:a||o,sourceTileGrid:c,targetProj:o,targetTileGrid:d,tileCoord:f,wrappedTileCoord:g,pixelRatio:u,gutter:this.gutter_,getTileFunction:(p,x,y,T)=>this.getTile(p,x,y,T,void 0,h),transformMatrix:this.transformMatrix},this.tileOptions),m=new ReprojDataTile(_);return m.key=this.getKey(),m}getTile(t,n,s,o,a,h){var I;const c=this.getProjection();if(a&&(c&&!equivalent$1(c,a)||this.transformMatrix))return this.getReprojTile_(t,n,s,a,c,h);const u=this.getTileSize(t),d=this.loader_,f=new AbortController,g={signal:f.signal,crossOrigin:this.crossOrigin_},_=this.getTileCoordForTileUrlFunction([t,n,s]);if(!_)return null;const m=this.getKey(),p=getCacheKey$1(this,m,t,n,s);if(h&&h.containsKey(p))return h.get(p);const x=_[0],y=_[1],T=_[2],S=(I=this.getTileGrid())==null?void 0:I.getFullTileRange(x);S&&(g.maxY=S.getHeight()-1);function C(){return toPromise(function(){return d(x,y,T,g)})}const P=Object.assign({tileCoord:[t,n,s],loader:C,size:u,controller:f},this.tileOptions),w=new DataTile(P);return w.key=this.getKey(),w.addEventListener(EventType$1.CHANGE,this.handleTileChange_),h==null||h.set(p,w),w}handleTileChange_(t){const n=t.target,s=getUid(n),o=n.getState();let a;o==TileState.LOADING?(this.tileLoadingKeys_[s]=!0,a=TileEventType.TILELOADSTART):s in this.tileLoadingKeys_&&(delete this.tileLoadingKeys_[s],a=o==TileState.ERROR?TileEventType.TILELOADERROR:o==TileState.LOADED?TileEventType.TILELOADEND:void 0),a&&this.dispatchEvent(new TileSourceEvent(a,n))}getTileGridForProjection(t){const n=this.getProjection();if(this.tileGrid&&(!n||equivalent$1(n,t))&&!this.transformMatrix)return this.tileGrid;const s=getUid(t);return s in this.tileGridForProjection_||(this.tileGridForProjection_[s]=getForProjection(t)),this.tileGridForProjection_[s]}setTileGridForProjection(t,n){const s=get$1(t);if(s){const o=getUid(s);o in this.tileGridForProjection_||(this.tileGridForProjection_[o]=n)}}}function isMask(l){return((l.fileDirectory.NewSubfileType||0)&4)===4}function readRGB(l,t){if(!l)return!1;if(l===!0)return!0;if(t.getSamplesPerPixel()!==3)return!1;const n=t.fileDirectory.PhotometricInterpretation,s=photometricInterpretations;return n===s.CMYK||n===s.YCbCr||n===s.CIELab||n===s.ICCLab}const STATISTICS_MAXIMUM="STATISTICS_MAXIMUM",STATISTICS_MINIMUM="STATISTICS_MINIMUM",defaultTileSize=256;let workerPool;function getWorkerPool(){return workerPool||(workerPool=new Pool),workerPool}function getBoundingBox(l){try{return l.getBoundingBox(!0)}catch{return[0,0,l.getWidth(),l.getHeight()]}}function getOrigin(l){try{return l.getOrigin().slice(0,2)}catch{return[0,l.getHeight()]}}function getResolutions(l,t){try{return l.getResolution(t)}catch{return[t.getWidth()/l.getWidth(),t.getHeight()/l.getHeight()]}}function getProjection(l){const t=l.geoKeys;if(!t)return null;if(t.ProjectedCSTypeGeoKey&&t.ProjectedCSTypeGeoKey!==32767){const n="EPSG:"+t.ProjectedCSTypeGeoKey;let s=get$1(n);if(!s){const o=fromCode(t.ProjLinearUnitsGeoKey);o&&(s=new Projection({code:n,units:o}))}return s}if(t.GeographicTypeGeoKey&&t.GeographicTypeGeoKey!==32767){const n="EPSG:"+t.GeographicTypeGeoKey;let s=get$1(n);if(!s){const o=fromCode(t.GeogAngularUnitsGeoKey);o&&(s=new Projection({code:n,units:o}))}return s}return null}function getImagesForTIFF(l){return l.getImageCount().then(function(t){const n=new Array(t);for(let s=0;s<t;++s)n[s]=l.getImage(s);return Promise.all(n)})}function getImagesForSource(l,t){let n;return l.blob?n=fromBlob(l.blob):l.overviews?n=fromUrls(l.url,l.overviews,t):n=fromUrl(l.url,t),n.then(getImagesForTIFF)}function assertEqual(l,t,n,s,o){if(Array.isArray(l)){const a=l.length;if(!Array.isArray(t)||a!=t.length){const h=new Error(s);throw o(h),h}for(let h=0;h<a;++h)assertEqual(l[h],t[h],n,s,o);return}if(t=t,Math.abs(l-t)>n*l)throw new Error(s)}function getMinForDataType(l){return l instanceof Int8Array?-128:l instanceof Int16Array?-32768:l instanceof Int32Array?-2147483648:l instanceof Float32Array?12e-39:0}function getMaxForDataType(l){return l instanceof Int8Array?127:l instanceof Uint8Array||l instanceof Uint8ClampedArray?255:l instanceof Int16Array?32767:l instanceof Uint16Array?65535:l instanceof Int32Array?2147483647:l instanceof Uint32Array?4294967295:l instanceof Float32Array?34e37:255}class GeoTIFFSource extends DataTileSource{constructor(t){super({state:"loading",tileGrid:null,projection:t.projection||null,transition:t.transition,interpolate:t.interpolate!==!1,wrapX:t.wrapX}),this.sourceInfo_=t.sources;const n=this.sourceInfo_.length;this.sourceOptions_=t.sourceOptions,this.sourceImagery_=new Array(n),this.sourceMasks_=new Array(n),this.resolutionFactors_=new Array(n),this.samplesPerPixel_,this.nodataValues_,this.metadata_,this.normalize_=t.normalize!==!1,this.addAlpha_=!1,this.error_=null,this.convertToRGB_=t.convertToRGB||!1,this.setKey(this.sourceInfo_.map(a=>a.url).join(","));const s=this,o=new Array(n);for(let a=0;a<n;++a)o[a]=getImagesForSource(this.sourceInfo_[a],this.sourceOptions_);Promise.all(o).then(function(a){s.configure_(a)}).catch(function(a){error(a),s.error_=a,s.setState("error")})}getError(){return this.error_}determineProjection(t){const n=t[0];for(let s=n.length-1;s>=0;--s){const o=n[s],a=getProjection(o);if(a){this.projection=a;break}}}determineTransformMatrix(t){const n=t[0];for(let s=n.length-1;s>=0;--s){const a=n[s].fileDirectory.ModelTransformation;if(a){const[h,c,u,d,f,g,_,m]=a,p=multiply(multiply([1/Math.sqrt(h*h+f*f),0,0,-1/Math.sqrt(c*c+g*g),d,m],[h,f,c,g,0,0]),[1,0,0,1,-d,-m]);this.transformMatrix=p,this.addAlpha_=!0;break}}}configure_(t){let n,s,o,a,h;const c=new Array(t.length),u=new Array(t.length),d=new Array(t.length);let f=0;const g=t.length;for(let y=0;y<g;++y){const T=[],S=[];t[y].forEach(k=>{isMask(k)?S.push(k):T.push(k)});const C=T.length;if(S.length>0&&S.length!==C)throw new Error(`Expected one mask per image found ${S.length} masks and ${C} images`);let P,w;const I=new Array(C),O=new Array(C),N=new Array(C);u[y]=new Array(C),d[y]=new Array(C);for(let k=0;k<C;++k){const D=T[k],ze=D.getGDALNoData();d[y][k]=D.getGDALMetadata(0),u[y][k]=ze;const z=this.sourceInfo_[y].bands;c[y]=z?z.length:D.getSamplesPerPixel();const Ee=C-(k+1);P||(P=getBoundingBox(D)),w||(w=getOrigin(D));const B=getResolutions(D,T[0]);N[Ee]=B[0];const rt=[D.getTileWidth(),D.getTileHeight()];rt[0]!==rt[1]&&rt[1]<defaultTileSize&&(rt[0]=defaultTileSize,rt[1]=defaultTileSize),I[Ee]=rt;const wt=B[0]/Math.abs(B[1]);O[Ee]=[rt[0],rt[1]/wt]}if(n?getIntersection(n,P,n):n=P,!s)s=w;else{const k=`Origin mismatch for source ${y}, got [${w}] but expected [${s}]`;assertEqual(s,w,0,k,this.viewRejector)}if(!h)h=N,this.resolutionFactors_[y]=1;else{h.length-f>N.length&&(f=h.length-N.length);const k=h[h.length-1]/N[N.length-1];this.resolutionFactors_[y]=k;const D=N.map(z=>z*=k),ze=`Resolution mismatch for source ${y}, got [${D}] but expected [${h}]`;assertEqual(h.slice(f,h.length),D,.02,ze,this.viewRejector)}o?assertEqual(o.slice(f,o.length),O,.01,`Tile size mismatch for source ${y}`,this.viewRejector):o=O,a?assertEqual(a.slice(f,a.length),I,0,`Tile size mismatch for source ${y}`,this.viewRejector):a=I,this.sourceImagery_[y]=T.reverse(),this.sourceMasks_[y]=S.reverse()}for(let y=0,T=this.sourceImagery_.length;y<T;++y){const S=this.sourceImagery_[y];for(;S.length<h.length;)S.unshift(void 0)}this.getProjection()||this.determineProjection(t),this.determineTransformMatrix(t),this.samplesPerPixel_=c,this.nodataValues_=u,this.metadata_=d;e:for(let y=0;y<g;++y){if(this.sourceInfo_[y].nodata!==void 0){this.addAlpha_=!0;break}if(this.sourceMasks_[y].length){this.addAlpha_=!0;break}const T=u[y],S=this.sourceInfo_[y].bands;if(S){for(let C=0;C<S.length;++C)if(T[S[C]-1]!==null){this.addAlpha_=!0;break e}continue}for(let C=0;C<T.length;++C)if(T[C]!==null){this.addAlpha_=!0;break e}}let _=this.addAlpha_?1:0;for(let y=0;y<g;++y)_+=c[y];this.bandCount=_;const m=new TileGrid({extent:n,minZoom:f,origin:s,resolutions:h,tileSizes:o});this.tileGrid=m,this.setTileSizes(a),this.setLoader(this.loadTile_.bind(this)),this.setState("ready");const p=1;h.length===2?h=[h[0],h[1],h[1]/2]:h.length===1&&(h=[h[0]*2,h[0],h[0]/2]);let x=n;if(this.transformMatrix){const y=makeInverse(create$2(),this.transformMatrix.slice()),T=createTransformFromCoordinateTransform(S=>apply(y,S));x=applyTransform(n,T)}this.viewResolver({showFullExtent:!0,projection:this.projection,resolutions:h,center:toUserCoordinate(getCenter(x),this.projection),extent:toUserExtent(x,this.projection),zoom:p})}loadTile_(t,n,s,o){const a=this.getTileSize(t),h=this.sourceImagery_.length,c=new Array(h*2),u=this.nodataValues_,d=this.sourceInfo_,f=getWorkerPool();for(let g=0;g<h;++g){const _=d[g],m=this.resolutionFactors_[g],p=[Math.round(n*(a[0]*m)),Math.round(s*(a[1]*m)),Math.round((n+1)*(a[0]*m)),Math.round((s+1)*(a[1]*m))],x=this.sourceImagery_[g][t];let y;_.bands&&(y=_.bands.map(function(w){return w-1}));let T;"nodata"in _&&_.nodata!==null?T=_.nodata:y?T=y.map(function(w){return u[g][w]}):T=u[g];const S={window:p,width:a[0],height:a[1],samples:y,fillValue:T,pool:f,interleave:!1,signal:o.signal};readRGB(this.convertToRGB_,x)?c[g]=x.readRGB(S):c[g]=x.readRasters(S);const C=h+g,P=this.sourceMasks_[g][t];if(!P){c[C]=Promise.resolve(null);continue}c[C]=P.readRasters({window:p,width:a[0],height:a[1],samples:[0],pool:f,interleave:!1})}return Promise.all(c).then(this.composeTile_.bind(this,a)).catch(function(g){throw error(g),g})}composeTile_(t,n){const s=this.metadata_,o=this.sourceInfo_,a=this.sourceImagery_.length,h=this.bandCount,c=this.samplesPerPixel_,u=this.nodataValues_,d=this.normalize_,f=this.addAlpha_,g=t[0]*t[1],_=g*h;let m;d?m=new Uint8Array(_):m=new Float32Array(_);let p=0;for(let x=0;x<g;++x){let y=f;for(let T=0;T<a;++T){const S=o[T];let C=S.min,P=S.max,w,I;if(d){const O=s[T][0];C===void 0&&(O&&STATISTICS_MINIMUM in O?C=parseFloat(O[STATISTICS_MINIMUM]):C=getMinForDataType(n[T][0])),P===void 0&&(O&&STATISTICS_MAXIMUM in O?P=parseFloat(O[STATISTICS_MAXIMUM]):P=getMaxForDataType(n[T][0])),w=255/(P-C),I=-C*w}for(let O=0;O<c[T];++O){const N=n[T][O][x];let k;if(d?k=clamp(w*N+I,0,255):k=N,!f)m[p]=k;else{let D=S.nodata;if(D===void 0){let z;S.bands?z=S.bands[O]-1:z=O,D=u[T][z]}const ze=isNaN(D);(!ze&&N!==D||ze&&!isNaN(N))&&(y=!1,m[p]=k)}p++}if(!y){const O=a+T,N=n[O];N&&!N[0][x]&&(y=!0)}}f&&(y||(m[p]=255),p++)}return m}}GeoTIFFSource.prototype.getView;const maxZoom=22;class Google extends TileImage{constructor(t){const n=!!t.highDpi;super({attributionsCollapsible:t.attributionsCollapsible,cacheSize:t.cacheSize,crossOrigin:"anonymous",interpolate:t.interpolate,projection:"EPSG:3857",reprojectionErrorThreshold:t.reprojectionErrorThreshold,state:"loading",tileLoadFunction:t.tileLoadFunction,tilePixelRatio:n?2:1,wrapX:t.wrapX!==void 0?t.wrapX:!0,transition:t.transition,zDirection:t.zDirection}),this.apiKey_=t.key,this.error_=null;const s={mapType:t.mapType||"roadmap",language:t.language||"en-US",region:t.region||"US"};t.imageFormat&&(s.imageFormat=t.imageFormat),t.scale&&(s.scale=t.scale),n&&(s.highDpi=!0),t.layerTypes&&(s.layerTypes=t.layerTypes),t.styles&&(s.styles=t.styles),t.overlay===!0&&(s.overlay=!0),t.apiOptions&&(s.apiOptions=t.apiOptions),this.sessionTokenRequest_=s,this.sessionTokenValue_,this.sessionRefreshId_,this.previousViewportAttribution_,this.previousViewportExtent_;const o=t.url||"https://tile.googleapis.com/";this.createSessionUrl_=o+"v1/createSession",this.tileUrl_=o+"v1/2dtiles",this.attributionUrl_=o+"tile/v1/viewport",this.createSession_()}getError(){return this.error_}fetchSessionToken(t,n){return fetch(t,n)}async createSession_(){const t=this.createSessionUrl_+"?key="+this.apiKey_,n={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(this.sessionTokenRequest_)},s=await this.fetchSessionToken(t,n);if(!s.ok){try{const _=await s.json();this.error_=new Error(_.error.message)}catch{this.error_=new Error("Error fetching session token")}this.setState("error");return}const o=await s.json(),a=this.getTilePixelRatio(1),h=[o.tileWidth/a,o.tileHeight/a];this.tileGrid=createXYZ({extent:extentFromProjection(this.getProjection()),maxZoom,tileSize:h});const c=o.session;this.sessionTokenValue_=c;const u=this.apiKey_,d=this.tileUrl_;this.tileUrlFunction=function(_,m,p){const x=_[0],y=_[1],T=_[2];return`${d}/${x}/${y}/${T}?session=${c}&key=${u}`};const f=parseInt(o.expiry,10)*1e3,g=Math.max(f-Date.now()-60*1e3,1);this.sessionRefreshId_=setTimeout(()=>this.createSession_(),g),this.setAttributions(this.fetchAttributions_.bind(this)),this.setState("ready")}async fetchAttributions_(t){if(t.viewHints[ViewHint.ANIMATING]||t.viewHints[ViewHint.INTERACTING]||t.animate)return this.previousViewportAttribution_;const[n,s]=toLonLat(getBottomLeft(t.extent),t.viewState.projection),[o,a]=toLonLat(getTopRight(t.extent),t.viewState.projection),u=`zoom=${this.getTileGrid().getZForResolution(t.viewState.resolution,this.zDirection)}&north=${a}&south=${s}&east=${o}&west=${n}`;if(this.previousViewportExtent_==u)return this.previousViewportAttribution_;this.previousViewportExtent_=u;const d=this.sessionTokenValue_,f=this.apiKey_,_=`${this.attributionUrl_}?session=${d}&key=${f}&${u}`;return this.previousViewportAttribution_=await fetch(_).then(m=>m.json()).then(m=>m.copyright),this.previousViewportAttribution_}disposeInternal(){clearTimeout(this.sessionRefreshId_),super.disposeInternal()}}let CustomTile$1=class extends ImageTile{constructor(t,n,s,o,a,h,c){super(n,s,o,a,h,c),this.zoomifyImage_=null,this.tileSize_=t}getImage(){if(this.zoomifyImage_)return this.zoomifyImage_;const t=super.getImage();if(this.state==TileState.LOADED){const n=this.tileSize_;if(t.width==n[0]&&t.height==n[1])return this.zoomifyImage_=t,t;const s=createCanvasContext2D(n[0],n[1]);return s.drawImage(t,0,0),this.zoomifyImage_=s.canvas,s.canvas}return t}};class Zoomify extends TileImage{constructor(t){const n=t.size,s=t.tierSizeCalculation!==void 0?t.tierSizeCalculation:"default",o=t.tilePixelRatio||1,a=n[0],h=n[1],c=[],u=t.tileSize||DEFAULT_TILE_SIZE;let d=u*o;switch(s){case"default":for(;a>d||h>d;)c.push([Math.ceil(a/d),Math.ceil(h/d)]),d+=d;break;case"truncated":let I=a,O=h;for(;I>d||O>d;)c.push([Math.ceil(I/d),Math.ceil(O/d)]),I>>=1,O>>=1;break;default:throw new Error("Unknown `tierSizeCalculation` configured")}c.push([1,1]),c.reverse();const f=[o],g=[0];for(let I=1,O=c.length;I<O;I++)f.push(o<<I),g.push(c[I-1][0]*c[I-1][1]+g[I-1]);f.reverse();const _=new TileGrid({tileSize:u,extent:t.extent||[0,-h,a,0],resolutions:f});let m=t.url;m&&!m.includes("{TileGroup}")&&!m.includes("{tileIndex}")&&(m+="{TileGroup}/{z}-{x}-{y}.jpg");const p=expandUrl(m);let x=u*o;function y(I){return function(O,N,k){if(!O)return;const D=O[0],ze=O[1],z=O[2],Ee=ze+z*c[D][0],B=(Ee+g[D])/x|0,rt={z:D,x:ze,y:z,tileIndex:Ee,TileGroup:"TileGroup"+B};return I.replace(/\{(\w+?)\}/g,function(wt,re){return rt[re]})}}const T=createFromTileUrlFunctions(p.map(y)),S=CustomTile$1.bind(null,toSize(u*o));super({attributions:t.attributions,cacheSize:t.cacheSize,crossOrigin:t.crossOrigin,interpolate:t.interpolate,projection:t.projection,tilePixelRatio:o,reprojectionErrorThreshold:t.reprojectionErrorThreshold,tileClass:S,tileGrid:_,tileUrlFunction:T,transition:t.transition}),this.zDirection=t.zDirection;const C=_.getTileCoordForCoordAndResolution(getCenter(_.getExtent()),f[f.length-1]),P=T(C,1,null),w=new Image;w.addEventListener("error",()=>{x=u,this.changed()}),w.src=P}}function formatPercentage(l){return l.toLocaleString("en",{maximumFractionDigits:10})}class IIIF extends TileImage{constructor(t){const n=t||{};let s=n.url||"";s=s+(s.lastIndexOf("/")===s.length-1||s===""?"":"/");const o=n.version||Versions.VERSION2,a=n.sizes||[],h=n.size;assert(h!=null&&Array.isArray(h)&&h.length==2&&!isNaN(h[0])&&h[0]>0&&!isNaN(h[1])&&h[1]>0,"Missing or invalid `size`");const c=h[0],u=h[1],d=n.tileSize,f=n.tilePixelRatio||1,g=n.format||"jpg",_=n.quality||(n.version==Versions.VERSION1?"native":"default");let m=n.resolutions||[];const p=n.supports||[],x=n.extent||[0,-u,c,0],y=a!=null&&Array.isArray(a)&&a.length>0,T=d!==void 0&&(typeof d=="number"&&Number.isInteger(d)&&d>0||Array.isArray(d)&&d.length>0),S=p!=null&&Array.isArray(p)&&(p.includes("regionByPx")||p.includes("regionByPct"))&&(p.includes("sizeByWh")||p.includes("sizeByH")||p.includes("sizeByW")||p.includes("sizeByPct"));let C,P,w;if(m.sort(function(k,D){return D-k}),T||S)if(d!=null&&(typeof d=="number"&&Number.isInteger(d)&&d>0?(C=d,P=d):Array.isArray(d)&&d.length>0&&((d.length==1||d[1]==null&&Number.isInteger(d[0]))&&(C=d[0],P=d[0]),d.length==2&&(Number.isInteger(d[0])&&Number.isInteger(d[1])?(C=d[0],P=d[1]):d[0]==null&&Number.isInteger(d[1])&&(C=d[1],P=d[1])))),(C===void 0||P===void 0)&&(C=DEFAULT_TILE_SIZE,P=DEFAULT_TILE_SIZE),m.length==0){w=Math.max(Math.ceil(Math.log(c/C)/Math.LN2),Math.ceil(Math.log(u/P)/Math.LN2));for(let k=w;k>=0;k--)m.push(Math.pow(2,k))}else{const k=Math.max(...m);w=Math.round(Math.log(k)/Math.LN2)}else if(C=c,P=u,m=[],y){a.sort(function(D,ze){return D[0]-ze[0]}),w=-1;const k=[];for(let D=0;D<a.length;D++){const ze=c/a[D][0];if(m.length>0&&m[m.length-1]==ze){k.push(D);continue}m.push(ze),w++}if(k.length>0)for(let D=0;D<k.length;D++)a.splice(k[D]-D,1)}else m.push(1),a.push([c,u]),w=0;const I=new TileGrid({tileSize:[C,P],extent:x,origin:getTopLeft(x),resolutions:m}),O=function(k,D,ze){let z,Ee;const B=k[0];if(B>w)return;const rt=k[1],wt=k[2],re=m[B];if(!(rt===void 0||wt===void 0||re===void 0||rt<0||Math.ceil(c/re/C)<=rt||wt<0||Math.ceil(u/re/P)<=wt)){if(S||T){const mt=rt*C*re,Mt=wt*P*re;let Bt=C*re,Ht=P*re,Nt=C,Wt=P;if(mt+Bt>c&&(Bt=c-mt),Mt+Ht>u&&(Ht=u-Mt),mt+C*re>c&&(Nt=Math.floor((c-mt+re-1)/re)),Mt+P*re>u&&(Wt=Math.floor((u-Mt+re-1)/re)),mt==0&&Bt==c&&Mt==0&&Ht==u)z="full";else if(!S||p.includes("regionByPx"))z=mt+","+Mt+","+Bt+","+Ht;else if(p.includes("regionByPct")){const $t=formatPercentage(mt/c*100),Zt=formatPercentage(Mt/u*100),ki=formatPercentage(Bt/c*100),Os=formatPercentage(Ht/u*100);z="pct:"+$t+","+Zt+","+ki+","+Os}o==Versions.VERSION3&&(!S||p.includes("sizeByWh"))?Ee=Nt+","+Wt:!S||p.includes("sizeByW")?Ee=Nt+",":p.includes("sizeByH")?Ee=","+Wt:p.includes("sizeByWh")?Ee=Nt+","+Wt:p.includes("sizeByPct")&&(Ee="pct:"+formatPercentage(100/re))}else if(z="full",y){const mt=a[B][0],Mt=a[B][1];o==Versions.VERSION3?mt==c&&Mt==u?Ee="max":Ee=mt+","+Mt:mt==c?Ee="full":Ee=mt+","}else Ee=o==Versions.VERSION3?"max":"full";return s+z+"/"+Ee+"/0/"+_+"."+g}},N=CustomTile$1.bind(null,toSize(d||256).map(function(k){return k*f}));super({attributions:n.attributions,attributionsCollapsible:n.attributionsCollapsible,cacheSize:n.cacheSize,crossOrigin:n.crossOrigin,interpolate:n.interpolate,projection:n.projection,reprojectionErrorThreshold:n.reprojectionErrorThreshold,state:n.state,tileClass:N,tileGrid:I,tilePixelRatio:n.tilePixelRatio,tileUrlFunction:O,transition:n.transition}),this.zDirection=n.zDirection}}function getRequestUrl(l,t,n,s,o,a){const h=o.getCode().split(/:(?=\d+$)/).pop(),c=n/s,u=[round(getWidth(t)/c,DECIMALS$1),round(getHeight(t)/c,DECIMALS$1)];a.SIZE=u[0]+","+u[1],a.BBOX=t.join(","),a.BBOXSR=h,a.IMAGESR=h,a.DPI=Math.round(a.DPI?a.DPI*s:90*s);const d=l.replace(/MapServer\/?$/,"MapServer/export").replace(/ImageServer\/?$/,"ImageServer/exportImage");return appendParams(d,a)}function createLoader$2(l){const t=l.load?l.load:decode,n=get$1(l.projection||"EPSG:3857"),s=l.ratio??1.5,o=l.crossOrigin??null;return function(a,h,c){c=l.hidpi?c:1;const u={F:"image",FORMAT:"PNG32",TRANSPARENT:!0};Object.assign(u,l.params),a=getRequestExtent(a,h,c,s);const d=getRequestUrl(l.url,a,h,c,n,u),f=new Image;return f.crossOrigin=o,t(f,d).then(g=>{const _=getWidth(a)/g.width*c;return{image:g,extent:a,resolution:_,pixelRatio:c}})}}class ImageArcGISRest extends ImageSource{constructor(t){t=t||{},super({attributions:t.attributions,interpolate:t.interpolate,projection:t.projection,resolutions:t.resolutions}),this.crossOrigin_=t.crossOrigin!==void 0?t.crossOrigin:null,this.hidpi_=t.hidpi!==void 0?t.hidpi:!0,this.url_=t.url,this.imageLoadFunction_=t.imageLoadFunction!==void 0?t.imageLoadFunction:defaultImageLoadFunction,this.params_=Object.assign({},t.params),this.imageSize_=[0,0],this.renderedRevision_=0,this.ratio_=t.ratio!==void 0?t.ratio:1.5,this.loaderProjection_=null}getParams(){return this.params_}getImageInternal(t,n,s,o){return this.url_===void 0?null:((!this.loader||this.loaderProjection_!==o)&&(this.loaderProjection_=o,this.loader=createLoader$2({crossOrigin:this.crossOrigin_,params:this.params_,projection:o,hidpi:this.hidpi_,url:this.url_,ratio:this.ratio_,load:(a,h)=>(this.image.setImage(a),this.imageLoadFunction_(this.image,h),decode(a))})),super.getImageInternal(t,n,s,o))}getImageLoadFunction(){return this.imageLoadFunction_}getUrl(){return this.url_}setImageLoadFunction(t){this.imageLoadFunction_=t,this.changed()}setUrl(t){t!=this.url_&&(this.url_=t,this.loader=null,this.changed())}setParams(t){this.params_=Object.assign({},t),this.changed()}updateParams(t){Object.assign(this.params_,t),this.changed()}changed(){this.image=null,super.changed()}}class ImageCanvasSource extends ImageSource{constructor(t){t=t||{},super({attributions:t.attributions,interpolate:t.interpolate,projection:t.projection,resolutions:t.resolutions,state:t.state}),this.canvasFunction_=t.canvasFunction,this.canvas_=null,this.renderedRevision_=0,this.ratio_=t.ratio!==void 0?t.ratio:1.5}getImageInternal(t,n,s,o){n=this.findNearestResolution(n);let a=this.canvas_;if(a&&this.renderedRevision_==this.getRevision()&&a.getResolution()==n&&a.getPixelRatio()==s&&containsExtent(a.getExtent(),t))return a;t=t.slice(),scaleFromCenter(t,this.ratio_);const h=getWidth(t)/n,c=getHeight(t)/n,u=[h*s,c*s],d=this.canvasFunction_.call(this,t,n,s,u,o);return d&&(a=new ImageCanvas(t,n,s,d)),this.canvas_=a,this.renderedRevision_=this.getRevision(),a}}function getScale(l,t,n,s){const o=getWidth(l),a=getHeight(l),h=t[0],c=t[1],u=.0254/s;return c*o>h*a?o*n/(h*u):a*n/(c*u)}function getUrl(l,t,n,s,o,a,h){const c=getScale(n,s,a,h),u=getCenter(n),d={OPERATION:o?"GETDYNAMICMAPOVERLAYIMAGE":"GETMAPIMAGE",VERSION:"2.0.0",LOCALE:"en",CLIENTAGENT:"ol/source/ImageMapGuide source",CLIP:"1",SETDISPLAYDPI:h,SETDISPLAYWIDTH:Math.round(s[0]),SETDISPLAYHEIGHT:Math.round(s[1]),SETVIEWSCALE:c,SETVIEWCENTERX:u[0],SETVIEWCENTERY:u[1]};return Object.assign(d,t),appendParams(l,d)}function createLoader$1(l){const t=l.load||decode,n=l.useOverlay??!1,s=l.metersPerUnit||1,o=l.displayDpi||96,a=l.ratio??1,h=l.crossOrigin??null;return function(c,u,d){const f=new Image;f.crossOrigin=h,c=getRequestExtent(c,u,d,a);const g=getWidth(c)/u,_=getHeight(c)/u,m=[g*d,_*d],p=getUrl(l.url,l.params,c,m,n,s,o);return t(f,p).then(x=>({image:x,extent:c,pixelRatio:d}))}}class ImageMapGuide extends ImageSource{constructor(t){super({interpolate:t.interpolate,projection:t.projection,resolutions:t.resolutions}),this.crossOrigin_=t.crossOrigin!==void 0?t.crossOrigin:null,this.displayDpi_=t.displayDpi!==void 0?t.displayDpi:96,this.params_=Object.assign({},t.params),this.url_=t.url,this.imageLoadFunction_=t.imageLoadFunction!==void 0?t.imageLoadFunction:defaultImageLoadFunction,this.hidpi_=t.hidpi!==void 0?t.hidpi:!0,this.metersPerUnit_=t.metersPerUnit!==void 0?t.metersPerUnit:1,this.ratio_=t.ratio!==void 0?t.ratio:1,this.useOverlay_=t.useOverlay!==void 0?t.useOverlay:!1,this.renderedRevision_=0,this.loaderProjection_=null}getParams(){return this.params_}getImageInternal(t,n,s,o){return this.url_===void 0?null:((!this.loader||this.loaderProjection_!==o)&&(this.loaderProjection_=o,this.loader=createLoader$1({crossOrigin:this.crossOrigin_,params:this.params_,hidpi:this.hidpi_,metersPerUnit:this.metersPerUnit_,url:this.url_,useOverlay:this.useOverlay_,ratio:this.ratio_,load:(a,h)=>(this.image.setImage(a),this.imageLoadFunction_(this.image,h),decode(a))})),super.getImageInternal(t,n,s,o))}getImageLoadFunction(){return this.imageLoadFunction_}setParams(t){this.params_=Object.assign({},t),this.changed()}updateParams(t){Object.assign(this.params_,t),this.changed()}setImageLoadFunction(t){this.imageLoadFunction_=t,this.changed()}changed(){this.image=null,super.changed()}}function createLoader(l){const t=l.load||decode,n=l.imageExtent,s=l.crossOrigin??null;return()=>{const o=new Image;return o.crossOrigin=s,t(o,l.url).then(a=>{const h=getWidth(n)/a.width,c=getHeight(n)/a.height;return{image:a,extent:n,resolution:h!==c?[h,c]:c,pixelRatio:1}})}}class Static extends ImageSource{constructor(t){const n=t.crossOrigin!==void 0?t.crossOrigin:null,s=t.imageLoadFunction!==void 0?t.imageLoadFunction:defaultImageLoadFunction;super({attributions:t.attributions,interpolate:t.interpolate,projection:get$1(t.projection)}),this.url_=t.url,this.imageExtent_=t.imageExtent,this.image=null,this.image=new ImageWrapper(this.imageExtent_,void 0,1,createLoader({url:t.url,imageExtent:t.imageExtent,crossOrigin:n,load:(o,a)=>(this.image.setImage(o),s(this.image,a),decode(o))})),this.image.addEventListener(EventType$1.CHANGE,this.handleImageChange.bind(this))}getImageExtent(){return this.imageExtent_}getImageInternal(t,n,s,o){return intersects$1(t,this.image.getExtent())?this.image:null}getUrl(){return this.url_}}const loadError=new Error("Image failed to load");function loadImage(l,t,n,s,o){return new Promise((a,h)=>{const c=new Image;c.crossOrigin=o.crossOrigin??null,c.addEventListener("load",()=>a(c)),c.addEventListener("error",()=>h(loadError)),c.src=renderXYZTemplate(l,t,n,s,o.maxY)})}function makeLoaderFromTemplates(l){return function(t,n,s,o){const a=pickUrl(l,t,n,s);return loadImage(a,t,n,s,o)}}function makeLoaderFromGetter(l){return function(t,n,s,o){const a=l(t,n,s,o);return loadImage(a,t,n,s,o)}}function makeLoaderFromUrlLike(l){let t;if(Array.isArray(l))t=makeLoaderFromTemplates(l);else if(typeof l=="string"){const n=expandUrl(l);t=makeLoaderFromTemplates(n)}else if(typeof l=="function")t=makeLoaderFromGetter(l);else throw new Error("The url option must be a single template, an array of templates, or a function for getting a URL");return t}let keyCount=0;function keyFromUrlLike(l){return Array.isArray(l)?l.join(`
`):typeof l=="string"?l:(++keyCount,"url-function-key-"+keyCount)}class ImageTileSource extends DataTileSource{constructor(t){t=t||{};let n=t.loader,s;t.url&&(n=makeLoaderFromUrlLike(t.url),s=keyFromUrlLike(t.url));const o=n?t.state:"loading",a=t.wrapX===void 0?!0:t.wrapX;super({loader:n,key:s,attributions:t.attributions,attributionsCollapsible:t.attributionsCollapsible,maxZoom:t.maxZoom,minZoom:t.minZoom,tileSize:t.tileSize,gutter:t.gutter,maxResolution:t.maxResolution,projection:t.projection,tileGrid:t.tileGrid,state:o,wrapX:a,transition:t.transition,interpolate:t.interpolate!==!1,crossOrigin:t.crossOrigin,zDirection:t.zDirection})}setUrl(t){const n=makeLoaderFromUrlLike(t);this.setLoader(n),this.setKey(keyFromUrlLike(t)),this.getState()!=="ready"&&this.setState("ready")}}function jsonp(l,t,n,s){const o=document.createElement("script"),a="olc_"+getUid(t);function h(){delete window[a],o.parentNode.removeChild(o)}o.async=!0,o.src=l+(l.includes("?")?"&":"?")+"callback="+a;const c=setTimeout(function(){h(),n&&n()},1e4);window[a]=function(u){clearTimeout(c),h(),t(u)},document.head.appendChild(o)}class ResponseError extends Error{constructor(t){const n="Unexpected response status: "+t.status;super(n),this.name="ResponseError",this.response=t}}class ClientError extends Error{constructor(t){super("Failed to issue request"),this.name="ClientError",this.client=t}}function getJSON(l){return new Promise(function(t,n){function s(h){const c=h.target;if(!c.status||c.status>=200&&c.status<300){let u;try{u=JSON.parse(c.responseText)}catch(d){const f="Error parsing response text as JSON: "+d.message;n(new Error(f));return}t(u);return}n(new ResponseError(c))}function o(h){n(new ClientError(h.target))}const a=new XMLHttpRequest;a.addEventListener("load",s),a.addEventListener("error",o),a.open("GET",l),a.setRequestHeader("Accept","application/json"),a.send()})}function resolveUrl(l,t){return t.includes("://")?t:new URL(t,l).href}const knownMapMediaTypes={"image/png":!0,"image/jpeg":!0,"image/gif":!0,"image/webp":!0},knownVectorMediaTypes={"application/vnd.mapbox-vector-tile":!0,"application/geo+json":!0};function appendCollectionsQueryParam(l,t){if(!t.length)return l;const n=new URL(l,"file:/");if(n.pathname.split("/").includes("collections"))return error('The "collections" query parameter cannot be added to collection endpoints'),l;const s=t.map(h=>encodeURIComponent(h)).join(",");n.searchParams.append("collections",s);const o=l.split("?")[0],a=decodeURIComponent(n.searchParams.toString());return`${o}?${a}`}function getMapTileUrlTemplate(l,t,n){let s,o;for(let a=0;a<l.length;++a){const h=l[a];if(h.rel==="item"){if(h.type===t){s=h.href;break}(knownMapMediaTypes[h.type]||!o&&h.type.startsWith("image/"))&&(o=h.href)}}if(!s)if(o)s=o;else throw new Error('Could not find "item" link');return n&&(s=appendCollectionsQueryParam(s,n)),s}function getVectorTileUrlTemplate(l,t,n,s){let o,a;const h={};for(let c=0;c<l.length;++c){const u=l[c];if(h[u.type]=u.href,u.rel==="item"){if(u.type===t){o=u.href;break}knownVectorMediaTypes[u.type]&&(a=u.href)}}if(!o&&n)for(let c=0;c<n.length;++c){const u=n[c];if(h[u]){o=h[u];break}}if(!o)if(a)o=a;else throw new Error('Could not find "item" link');return s&&(o=appendCollectionsQueryParam(o,s)),o}function parseTileMatrixSet(l,t,n,s){let o=l.projection;if(!o&&(typeof t.crs=="string"?o=get$1(t.crs):"uri"in t.crs&&(o=get$1(t.crs.uri)),!o))throw new Error(`Unsupported CRS: ${JSON.stringify(t.crs)}`);const a=t.orderedAxes,c=!(a?a.slice(0,2).map(I=>I.replace(/E|X|Lon/i,"e").replace(/N|Y|Lat/i,"n")).join(""):o.getAxisOrientation()).startsWith("en"),u=t.tileMatrices,d={};for(let I=0;I<u.length;++I){const O=u[I];d[O.id]=O}const f={},g=[];if(s)for(let I=0;I<s.length;++I){const O=s[I],N=O.tileMatrix;g.push(N),f[N]=O}else for(let I=0;I<u.length;++I){const O=u[I].id;g.push(O)}const _=g.length,m=new Array(_),p=new Array(_),x=new Array(_),y=new Array(_),T=[-1/0,-1/0,1/0,1/0];for(let I=0;I<_;++I){const O=g[I],N=d[O],k=N.pointOfOrigin;c?m[I]=[k[1],k[0]]:m[I]=k,p[I]=N.cellSize,x[I]=[N.matrixWidth,N.matrixHeight],y[I]=[N.tileWidth,N.tileHeight];const D=f[O];if(D){const ze=N.cellSize*N.tileWidth,z=m[I][0]+D.minTileCol*ze,Ee=m[I][0]+(D.maxTileCol+1)*ze,B=N.cellSize*N.tileHeight,rt=N.cornerOfOrigin==="bottomLeft";let wt,re;rt?(wt=m[I][1]+D.minTileRow*B,re=m[I][1]+(D.maxTileRow+1)*B):(wt=m[I][1]-(D.maxTileRow+1)*B,re=m[I][1]-D.minTileRow*B),getIntersection(T,[z,wt,Ee,re],T)}}const S=new TileGrid({origins:m,resolutions:p,sizes:x,tileSizes:y,extent:s?T:void 0}),C=l.context,P=l.url;function w(I,O,N){if(!I)return;const k=g[I[0]],D=d[k],ze=D.cornerOfOrigin==="bottomLeft",z={tileMatrix:k,tileCol:I[1],tileRow:ze?-I[2]-1:I[2]};if(s){const B=f[D.id];if(z.tileCol<B.minTileCol||z.tileCol>B.maxTileCol||z.tileRow<B.minTileRow||z.tileRow>B.maxTileRow)return}Object.assign(z,{z:z.tileMatrix,x:z.tileCol,y:z.tileRow},C);const Ee=n.replace(/\{(\w+?)\}/g,function(B,rt){return z[rt]});return resolveUrl(P,Ee)}return{grid:S,projection:o,urlTemplate:n,urlFunction:w}}function parseTileSetMetadata(l,t){const n=t.tileMatrixSetLimits;let s;if(t.dataType==="map")s=getMapTileUrlTemplate(t.links,l.mediaType,l.collections);else if(t.dataType==="vector")s=getVectorTileUrlTemplate(t.links,l.mediaType,l.supportedMediaTypes,l.collections);else throw new Error('Expected tileset data type to be "map" or "vector"');if(t.tileMatrixSet)return parseTileMatrixSet(l,t.tileMatrixSet,s,n);const o=t.links.find(c=>c.rel==="http://www.opengis.net/def/rel/ogc/1.0/tiling-scheme");if(!o)throw new Error("Expected http://www.opengis.net/def/rel/ogc/1.0/tiling-scheme link or tileMatrixSet");const a=o.href,h=resolveUrl(l.url,a);return getJSON(h).then(function(c){return parseTileMatrixSet(l,c,s,n)})}function getTileSetInfo(l){return getJSON(l.url).then(function(t){return parseTileSetMetadata(l,t)})}class OGCMapTile extends TileImage{constructor(t){super({attributions:t.attributions,cacheSize:t.cacheSize,crossOrigin:t.crossOrigin,interpolate:t.interpolate,projection:t.projection,reprojectionErrorThreshold:t.reprojectionErrorThreshold,state:"loading",tileLoadFunction:t.tileLoadFunction,wrapX:t.wrapX!==void 0?t.wrapX:!0,transition:t.transition});const n={url:t.url,projection:this.getProjection(),mediaType:t.mediaType,context:t.context||null,collections:t.collections};getTileSetInfo(n).then(this.handleTileSetInfo_.bind(this)).catch(this.handleError_.bind(this))}handleTileSetInfo_(t){this.tileGrid=t.grid,this.projection=t.projection,this.setTileUrlFunction(t.urlFunction,t.urlTemplate),this.setState("ready")}handleError_(t){error(t),this.setState("error")}}class OGCVectorTile extends VectorTile{constructor(t){super({attributions:t.attributions,attributionsCollapsible:t.attributionsCollapsible,cacheSize:t.cacheSize,format:t.format,overlaps:t.overlaps,projection:t.projection,tileClass:t.tileClass,transition:t.transition,wrapX:t.wrapX,zDirection:t.zDirection,state:"loading"});const n={url:t.url,projection:this.getProjection(),mediaType:t.mediaType,supportedMediaTypes:t.format.supportedMediaTypes,context:t.context||null,collections:t.collections};getTileSetInfo(n).then(this.handleTileSetInfo_.bind(this)).catch(this.handleError_.bind(this))}handleTileSetInfo_(t){this.tileGrid=t.grid,this.projection=t.projection,this.setTileUrlFunction(t.urlFunction,t.urlTemplate),this.setState("ready")}handleError_(t){error(t),this.setState("error")}}function createMinion(l){return function(t){const n=t.buffers,s=t.meta,o=t.imageOps,a=t.width,h=t.height,c=n.length,u=n[0].byteLength;if(o){const _=new Array(c);for(let p=0;p<c;++p)_[p]=new ImageData(new Uint8ClampedArray(n[p]),a,h);return l(_,s).data.buffer}const d=new Uint8ClampedArray(u),f=new Array(c),g=new Array(c);for(let _=0;_<c;++_)f[_]=new Uint8ClampedArray(n[_]),g[_]=[0,0,0,0];for(let _=0;_<u;_+=4){for(let p=0;p<c;++p){const x=f[p];g[p][0]=x[_],g[p][1]=x[_+1],g[p][2]=x[_+2],g[p][3]=x[_+3]}const m=l(g,s);d[_]=m[0],d[_+1]=m[1],d[_+2]=m[2],d[_+3]=m[3]}return d.buffer}}function createWorker(l,t){const s=Object.keys(l.lib||{}).map(function(a){return"const "+a+" = "+l.lib[a].toString()+";"}).concat(["const __minion__ = ("+createMinion.toString()+")(",l.operation.toString(),");",'self.addEventListener("message", function(event) {',"  const buffer = __minion__(event.data);","  self.postMessage({buffer: buffer, meta: event.data.meta}, [buffer]);","});"]),o=new Worker(typeof Blob>"u"?"data:text/javascript;base64,"+Buffer.from(s.join(`
`),"binary").toString("base64"):URL.createObjectURL(new Blob(s,{type:"text/javascript"})));return o.addEventListener("message",t),o}function createFauxWorker(l,t){const n=createMinion(l.operation);let s=!1;return{postMessage:function(o){setTimeout(function(){s||t({data:{buffer:n(o),meta:o.meta}})},0)},terminate:function(){s=!0}}}class Processor extends Disposable{constructor(t){super(),this.imageOps_=!!t.imageOps;let n;t.threads===0?n=0:this.imageOps_?n=1:n=t.threads||1;const s=new Array(n);if(n)for(let o=0;o<n;++o)s[o]=createWorker(t,this.onWorkerMessage_.bind(this,o));else s[0]=createFauxWorker(t,this.onWorkerMessage_.bind(this,0));this.workers_=s,this.queue_=[],this.maxQueueLength_=t.queue||1/0,this.running_=0,this.dataLookup_={},this.job_=null}process(t,n,s){this.enqueue_({inputs:t,meta:n,callback:s}),this.dispatch_()}enqueue_(t){for(this.queue_.push(t);this.queue_.length>this.maxQueueLength_;)this.queue_.shift().callback(null,null)}dispatch_(){if(this.running_||this.queue_.length===0)return;const t=this.queue_.shift();this.job_=t;const n=t.inputs[0].width,s=t.inputs[0].height,o=t.inputs.map(function(u){return u.data.buffer}),a=this.workers_.length;if(this.running_=a,a===1){this.workers_[0].postMessage({buffers:o,meta:t.meta,imageOps:this.imageOps_,width:n,height:s},o);return}const h=t.inputs[0].data.length,c=4*Math.ceil(h/4/a);for(let u=0;u<a;++u){const d=u*c,f=[];for(let g=0,_=o.length;g<_;++g)f.push(o[g].slice(d,d+c));this.workers_[u].postMessage({buffers:f,meta:t.meta,imageOps:this.imageOps_,width:n,height:s},f)}}onWorkerMessage_(t,n){this.disposed||(this.dataLookup_[t]=n.data,--this.running_,this.running_===0&&this.resolveJob_())}resolveJob_(){const t=this.job_,n=this.workers_.length;let s,o;if(n===1)s=new Uint8ClampedArray(this.dataLookup_[0].buffer),o=this.dataLookup_[0].meta;else{const a=t.inputs[0].data.length;s=new Uint8ClampedArray(a),o=new Array(n);const h=4*Math.ceil(a/4/n);for(let c=0;c<n;++c){const u=this.dataLookup_[c].buffer,d=c*h;s.set(new Uint8ClampedArray(u),d),o[c]=this.dataLookup_[c].meta}}this.job_=null,this.dataLookup_={},t.callback(null,new ImageData(s,t.inputs[0].width,t.inputs[0].height),o),this.dispatch_()}disposeInternal(){for(let t=0;t<this.workers_.length;++t)this.workers_[t].terminate();this.workers_.length=0}}const RasterEventType={BEFOREOPERATIONS:"beforeoperations",AFTEROPERATIONS:"afteroperations"};class RasterSourceEvent extends BaseEvent{constructor(t,n,s){super(t),this.extent=n.extent,this.resolution=n.viewState.resolution/n.pixelRatio,this.data=s}}class RasterSource extends ImageSource{constructor(t){super({projection:null}),this.on,this.once,this.un,this.processor_=null,this.operationType_=t.operationType!==void 0?t.operationType:"pixel",this.threads_=t.threads!==void 0?t.threads:1,this.layers_=createLayers(t.sources);const n=this.changed.bind(this);for(let s=0,o=this.layers_.length;s<o;++s)this.layers_[s].addEventListener(EventType$1.CHANGE,n);this.useResolutions_=t.resolutions!==null,this.tileQueue_=new TileQueue(function(){return 1},this.processSources_.bind(this)),this.requestedFrameState_,this.renderedImageCanvas_=null,this.renderedRevision_,this.frameState_={animate:!1,coordinateToPixelTransform:create$2(),declutter:null,extent:null,index:0,layerIndex:0,layerStatesArray:getLayerStatesArray(this.layers_),pixelRatio:1,pixelToCoordinateTransform:create$2(),postRenderFunctions:[],size:[0,0],tileQueue:this.tileQueue_,time:Date.now(),usedTiles:{},viewState:{rotation:0},viewHints:[],wantedTiles:{},mapId:getUid(this),renderTargets:{}},this.setAttributions(function(s){var a;const o=[];for(let h=0,c=t.sources.length;h<c;++h){const u=t.sources[h],d=u instanceof Source?u:u.getSource();if(!d)continue;const f=(a=d.getAttributions())==null?void 0:a(s);typeof f=="string"?o.push(f):f!==void 0&&o.push(...f)}return o}),t.operation!==void 0&&this.setOperation(t.operation,t.lib)}setOperation(t,n){this.processor_&&this.processor_.dispose(),this.processor_=new Processor({operation:t,imageOps:this.operationType_==="image",queue:1,lib:n,threads:this.threads_}),this.changed()}updateFrameState_(t,n,s){const o=Object.assign({},this.frameState_);o.viewState=Object.assign({},o.viewState);const a=getCenter(t);o.size[0]=Math.ceil(getWidth(t)/n),o.size[1]=Math.ceil(getHeight(t)/n),o.extent=[a[0]-o.size[0]*n/2,a[1]-o.size[1]*n/2,a[0]+o.size[0]*n/2,a[1]+o.size[1]*n/2],o.time=Date.now();const h=o.viewState;return h.center=a,h.projection=s,h.resolution=n,o}allSourcesReady_(){let t=!0,n;for(let s=0,o=this.layers_.length;s<o;++s)if(n=this.layers_[s].getSource(),!n||n.getState()!=="ready"){t=!1;break}return t}getImage(t,n,s,o){if(!this.allSourcesReady_())return null;this.tileQueue_.loadMoreTiles(16,16),n=this.findNearestResolution(n);const a=this.updateFrameState_(t,n,o);if(this.requestedFrameState_=a,this.renderedImageCanvas_){const h=this.renderedImageCanvas_.getResolution(),c=this.renderedImageCanvas_.getExtent();(n!==h||!equals$1(a.extent,c))&&(this.renderedImageCanvas_=null)}return(!this.renderedImageCanvas_||this.getRevision()!==this.renderedRevision_)&&this.processSources_(),a.animate&&requestAnimationFrame(this.changed.bind(this)),this.renderedImageCanvas_}processSources_(){const t=this.requestedFrameState_,n=this.layers_.length,s=new Array(n);for(let a=0;a<n;++a){t.layerIndex=a,t.renderTargets={};const h=getImageData(this.layers_[a],t);if(h)s[a]=h;else return}const o={};this.dispatchEvent(new RasterSourceEvent(RasterEventType.BEFOREOPERATIONS,t,o)),this.processor_.process(s,o,this.onWorkerComplete_.bind(this,t))}onWorkerComplete_(t,n,s,o){if(n||!s)return;const a=t.extent,h=t.viewState.resolution;if(h!==this.requestedFrameState_.viewState.resolution||!equals$1(a,this.requestedFrameState_.extent))return;let c;if(this.renderedImageCanvas_)c=this.renderedImageCanvas_.getImage().getContext("2d");else{const u=Math.round(getWidth(a)/h),d=Math.round(getHeight(a)/h);c=createCanvasContext2D(u,d),this.renderedImageCanvas_=new ImageCanvas(a,h,1,c.canvas)}c.putImageData(s,0,0),t.animate?requestAnimationFrame(this.changed.bind(this)):this.changed(),this.renderedRevision_=this.getRevision(),this.dispatchEvent(new RasterSourceEvent(RasterEventType.AFTEROPERATIONS,t,o))}getResolutions(t){if(!this.useResolutions_)return null;let n=super.getResolutions();if(!n)for(let s=0,o=this.layers_.length;s<o&&(n=this.layers_[s].getSource().getResolutions(t),!n);++s);return n}disposeInternal(){this.processor_&&this.processor_.dispose(),super.disposeInternal()}}RasterSource.prototype.dispose;let sharedContext=null;function getImageData(l,t){const n=l.getRenderer();if(!n)throw new Error("Unsupported layer type: "+l);if(!n.prepareFrame(t))return null;const s=t.size[0],o=t.size[1];if(s===0||o===0)return null;const a=n.renderFrame(t,null);let h;if(a instanceof HTMLCanvasElement)h=a;else{if(a&&(h=a.firstElementChild),!(h instanceof HTMLCanvasElement))throw new Error("Unsupported rendered element: "+h);if(h.width===s&&h.height===o)return h.getContext("2d").getImageData(0,0,s,o)}if(!sharedContext)sharedContext=createCanvasContext2D(s,o,void 0,{willReadFrequently:!0});else{const c=sharedContext.canvas;c.width!==s||c.height!==o?sharedContext=createCanvasContext2D(s,o,void 0,{willReadFrequently:!0}):sharedContext.clearRect(0,0,s,o)}return sharedContext.drawImage(h,0,0,s,o),sharedContext.getImageData(0,0,s,o)}function getLayerStatesArray(l){return l.map(function(t){return t.getLayerState()})}function createLayers(l){const t=l.length,n=new Array(t);for(let s=0;s<t;++s)n[s]=createLayer(l[s]);return n}function createLayer(l){let t;return l instanceof Source?l instanceof TileSource?t=new TileLayer({source:l}):l instanceof ImageSource&&(t=new ImageLayer({source:l})):t=l,t}const STADIA_ATTRIBUTION='&copy; <a href="https://www.stadiamaps.com/" target="_blank">Stadia Maps</a>',OMT_ATTRIBUTION='&copy; <a href="https://openmaptiles.org/" target="_blank">OpenMapTiles</a>',STAMEN_ATTRIBUTION='&copy; <a href="https://stamen.com/" target="_blank">Stamen Design</a>',LayerConfig={stamen_terrain:{extension:"png"},stamen_terrain_background:{extension:"png"},stamen_terrain_labels:{extension:"png"},stamen_terrain_lines:{extension:"png"},stamen_toner_background:{extension:"png"},stamen_toner:{extension:"png"},stamen_toner_labels:{extension:"png"},stamen_toner_lines:{extension:"png"},stamen_toner_lite:{extension:"png"},stamen_toner_dark:{extension:"png"},stamen_toner_blacklite:{extension:"png"},stamen_watercolor:{extension:"jpg"},alidade_smooth:{extension:"png"},alidade_smooth_dark:{extension:"png"},alidade_satellite:{extension:"png"},outdoors:{extension:"png"},osm_bright:{extension:"png"}},ProviderConfig={stamen_terrain:{minZoom:0,maxZoom:18,retina:!0},stamen_toner:{minZoom:0,maxZoom:20,retina:!0},stamen_toner_dark:{minZoom:0,maxZoom:20,retina:!0},stamen_toner_blacklite:{minZoom:0,maxZoom:20,retina:!0},stamen_watercolor:{minZoom:1,maxZoom:18,retina:!1}};class StadiaMaps extends XYZ{constructor(t){const n=t.layer.indexOf("-"),s=n==-1?t.layer:t.layer.slice(0,n),o=ProviderConfig[s]||{minZoom:0,maxZoom:20,retina:!0},a=LayerConfig[t.layer],h=t.apiKey?"?api_key="+t.apiKey:"",c=o.retina&&t.retina?"@2x":"",u=t.url!==void 0?t.url:"https://tiles.stadiamaps.com/tiles/"+t.layer+"/{z}/{x}/{y}"+c+"."+a.extension+h,d=[STADIA_ATTRIBUTION,OMT_ATTRIBUTION,ATTRIBUTION];t.layer.startsWith("stamen_")&&d.splice(1,0,STAMEN_ATTRIBUTION),super({attributions:d,cacheSize:t.cacheSize,crossOrigin:"anonymous",interpolate:t.interpolate,maxZoom:t.maxZoom!==void 0?t.maxZoom:o.maxZoom,minZoom:t.minZoom!==void 0?t.minZoom:o.minZoom,reprojectionErrorThreshold:t.reprojectionErrorThreshold,tileLoadFunction:t.tileLoadFunction,transition:t.transition,url:u,tilePixelRatio:c?2:1,wrapX:t.wrapX,zDirection:t.zDirection})}}class TileArcGISRest extends TileImage{constructor(t){t=t||{},super({attributions:t.attributions,cacheSize:t.cacheSize,crossOrigin:t.crossOrigin,interpolate:t.interpolate,projection:t.projection,reprojectionErrorThreshold:t.reprojectionErrorThreshold,tileGrid:t.tileGrid,tileLoadFunction:t.tileLoadFunction,url:t.url,urls:t.urls,wrapX:t.wrapX!==void 0?t.wrapX:!0,transition:t.transition,zDirection:t.zDirection}),this.params_=Object.assign({},t.params),this.hidpi_=t.hidpi!==void 0?t.hidpi:!0,this.tmpExtent_=createEmpty(),this.setKey(this.getKeyForParams_())}getKeyForParams_(){let t=0;const n=[];for(const s in this.params_)n[t++]=s+"-"+this.params_[s];return n.join("/")}getParams(){return this.params_}getRequestUrl_(t,n,s,o,a,h){const c=this.urls;if(!c)return;let u;if(c.length==1)u=c[0];else{const d=modulo(hash(t),c.length);u=c[d]}return getRequestUrl(u,s,(this.tileGrid||this.getTileGridForProjection(a)).getResolution(t[0]),o,a,h)}getTilePixelRatio(t){return this.hidpi_?t:1}setParams(t){this.params_=Object.assign({},t),this.setKey(this.getKeyForParams_())}updateParams(t){Object.assign(this.params_,t),this.setKey(this.getKeyForParams_())}tileUrlFunction(t,n,s){let o=this.getTileGrid();if(o||(o=this.getTileGridForProjection(s)),o.getResolutions().length<=t[0])return;n!=1&&!this.hidpi_&&(n=1);const a=o.getTileCoordExtent(t,this.tmpExtent_);let h=toSize(o.getTileSize(t[0]),this.tmpSize);n!=1&&(h=scale$1(h,n,this.tmpSize));const c={F:"image",FORMAT:"PNG32",TRANSPARENT:!0};return Object.assign(c,this.params_),this.getRequestUrl_(t,h,a,n,s,c)}}class TileDebug extends ImageTileSource{constructor(t){t=t||{};const n=t.template||"z:{z} x:{x} y:{y}",s=t.source,o=t.color||"grey";super({transition:0,wrapX:t.wrapX!==void 0?t.wrapX:s!==void 0?s.getWrapX():void 0});const a=()=>{var c;this.projection=t.projection!==void 0?get$1(t.projection):s!==void 0?s.getProjection():this.projection,this.tileGrid=t.tileGrid!==void 0?t.tileGrid:s!==void 0?s.getTileGrid():this.tileGrid,this.zDirection=t.zDirection!==void 0?t.zDirection:s!==void 0?s.zDirection:this.zDirection,s instanceof DataTileSource&&(this.transformMatrix=((c=s.transformMatrix)==null?void 0:c.slice())||null);const h=this.tileGrid;h&&this.setTileSizes(h.getResolutions().map((u,d)=>toSize(h.getTileSize(d)).map(f=>Math.max(Math.floor(f),1)))),this.setLoader((u,d,f,g)=>{const _=renderXYZTemplate(n,u,d,f,g.maxY),[m,p]=this.getTileSize(u),x=createCanvasContext2D(m,p);return x.strokeStyle=o,x.strokeRect(.5,.5,m+.5,p+.5),x.fillStyle=o,x.strokeStyle="white",x.textAlign="center",x.textBaseline="middle",x.font="24px sans-serif",x.lineWidth=4,x.strokeText(_,m/2,p/2,m),x.fillText(_,m/2,p/2,m),Promise.resolve(x.canvas)}),this.setState("ready")};if(s===void 0||s.getState()==="ready")a();else{const h=()=>{s.getState()==="ready"&&(s.removeEventListener(EventType$1.CHANGE,h),a())};s.addEventListener(EventType$1.CHANGE,h)}}}class TileJSON extends TileImage{constructor(t){if(super({attributions:t.attributions,cacheSize:t.cacheSize,crossOrigin:t.crossOrigin,interpolate:t.interpolate,projection:get$1("EPSG:3857"),reprojectionErrorThreshold:t.reprojectionErrorThreshold,state:"loading",tileLoadFunction:t.tileLoadFunction,wrapX:t.wrapX!==void 0?t.wrapX:!0,transition:t.transition,zDirection:t.zDirection}),this.tileJSON_=null,this.tileSize_=t.tileSize,t.url)if(t.jsonp)jsonp(t.url,this.handleTileJSONResponse.bind(this),this.handleTileJSONError.bind(this));else{const n=new XMLHttpRequest;n.addEventListener("load",this.onXHRLoad_.bind(this)),n.addEventListener("error",this.onXHRError_.bind(this)),n.open("GET",t.url),n.send()}else if(t.tileJSON)this.handleTileJSONResponse(t.tileJSON);else throw new Error("Either `url` or `tileJSON` options must be provided")}onXHRLoad_(t){const n=t.target;if(!n.status||n.status>=200&&n.status<300){let s;try{s=JSON.parse(n.responseText)}catch{this.handleTileJSONError();return}this.handleTileJSONResponse(s)}else this.handleTileJSONError()}onXHRError_(t){this.handleTileJSONError()}getTileJSON(){return this.tileJSON_}handleTileJSONResponse(t){const n=get$1("EPSG:4326"),s=this.getProjection();let o;if(t.bounds!==void 0){const d=getTransformFromProjections(n,s);o=applyTransform(t.bounds,d)}const a=extentFromProjection(s),h=t.minzoom||0,c=t.maxzoom||22,u=createXYZ({extent:a,maxZoom:c,minZoom:h,tileSize:this.tileSize_});if(this.tileGrid=u,this.tileUrlFunction=createFromTemplates(t.tiles,u),t.attribution&&!this.getAttributions()){const d=o!==void 0?o:a;this.setAttributions(function(f){return intersects$1(d,f.extent)?[t.attribution]:null})}this.tileJSON_=t,this.setState("ready")}handleTileJSONError(){this.setState("error")}}class CustomTile extends Tile{constructor(t,n,s,o,a,h){super(t,n),this.src_=s,this.extent_=o,this.preemptive_=a,this.grid_=null,this.keys_=null,this.data_=null,this.jsonp_=h}getImage(){return null}getData(t){if(!this.grid_||!this.keys_)return null;const n=(t[0]-this.extent_[0])/(this.extent_[2]-this.extent_[0]),s=(t[1]-this.extent_[1])/(this.extent_[3]-this.extent_[1]),o=this.grid_[Math.floor((1-s)*this.grid_.length)];if(typeof o!="string")return null;let a=o.charCodeAt(Math.floor(n*o.length));a>=93&&a--,a>=35&&a--,a-=32;let h=null;if(a in this.keys_){const c=this.keys_[a];this.data_&&c in this.data_?h=this.data_[c]:h=c}return h}forDataAtCoordinate(t,n,s){this.state==TileState.EMPTY&&s===!0?(this.state=TileState.IDLE,listenOnce(this,EventType$1.CHANGE,o=>{n(this.getData(t))}),this.loadInternal_()):s===!0?setTimeout(()=>{n(this.getData(t))},0):n(this.getData(t))}getKey(){return this.src_}handleError_(){this.state=TileState.ERROR,this.changed()}handleLoad_(t){this.grid_=t.grid,this.keys_=t.keys,this.data_=t.data,this.state=TileState.LOADED,this.changed()}loadInternal_(){if(this.state==TileState.IDLE)if(this.state=TileState.LOADING,this.jsonp_)jsonp(this.src_,this.handleLoad_.bind(this),this.handleError_.bind(this));else{const t=new XMLHttpRequest;t.addEventListener("load",this.onXHRLoad_.bind(this)),t.addEventListener("error",this.onXHRError_.bind(this)),t.open("GET",this.src_),t.send()}}onXHRLoad_(t){const n=t.target;if(!n.status||n.status>=200&&n.status<300){let s;try{s=JSON.parse(n.responseText)}catch{this.handleError_();return}this.handleLoad_(s)}else this.handleError_()}onXHRError_(t){this.handleError_()}load(){this.preemptive_?this.loadInternal_():this.setState(TileState.EMPTY)}}class UTFGrid extends TileSource{constructor(t){if(super({projection:get$1("EPSG:3857"),state:"loading",wrapX:t.wrapX!==void 0?t.wrapX:!0,zDirection:t.zDirection}),this.preemptive_=t.preemptive!==void 0?t.preemptive:!0,this.tileUrlFunction_=nullTileUrlFunction,this.template_=void 0,this.jsonp_=t.jsonp||!1,this.tileCache_=new LRUCache(512),t.url)if(this.jsonp_)jsonp(t.url,this.handleTileJSONResponse.bind(this),this.handleTileJSONError.bind(this));else{const n=new XMLHttpRequest;n.addEventListener("load",this.onXHRLoad_.bind(this)),n.addEventListener("error",this.onXHRError_.bind(this)),n.open("GET",t.url),n.send()}else if(t.tileJSON)this.handleTileJSONResponse(t.tileJSON);else throw new Error("Either `url` or `tileJSON` options must be provided")}onXHRLoad_(t){const n=t.target;if(!n.status||n.status>=200&&n.status<300){let s;try{s=JSON.parse(n.responseText)}catch{this.handleTileJSONError();return}this.handleTileJSONResponse(s)}else this.handleTileJSONError()}onXHRError_(t){this.handleTileJSONError()}getTemplate(){return this.template_}forDataAtCoordinateAndResolution(t,n,s,o){if(this.tileGrid){const a=this.tileGrid.getZForResolution(n,this.zDirection),h=this.tileGrid.getTileCoordForCoordAndZ(t,a),c=this.getTile(h[0],h[1],h[2],1,this.getProjection());c.getState()==TileState.IDLE&&c.load(),c.forDataAtCoordinate(t,s,o)}else o===!0?setTimeout(function(){s(null)},0):s(null)}handleTileJSONError(){this.setState("error")}handleTileJSONResponse(t){const n=get$1("EPSG:4326"),s=this.getProjection();let o;if(t.bounds!==void 0){const f=getTransformFromProjections(n,s);o=applyTransform(t.bounds,f)}const a=extentFromProjection(s),h=t.minzoom||0,c=t.maxzoom||22,u=createXYZ({extent:a,maxZoom:c,minZoom:h});this.tileGrid=u,this.template_=t.template;const d=t.grids;if(!d){this.setState("error");return}if(this.tileUrlFunction_=createFromTemplates(d,u),t.attribution){const f=o!==void 0?o:a;this.setAttributions(function(g){return intersects$1(f,g.extent)?[t.attribution]:null})}this.setState("ready")}getTile(t,n,s,o,a){const h=[t,n,s],c=this.getTileCoordForTileUrlFunction(h,a),u=this.tileUrlFunction_(c,o,a),d=`${this.getKey()},${getKeyZXY(t,n,s)}`;if(this.tileCache_.containsKey(d))return this.tileCache_.get(d);this.tileCache_.expireCache();const f=new CustomTile(h,u!==void 0?TileState.IDLE:TileState.EMPTY,u!==void 0?u:"",this.tileGrid.getTileCoordExtent(h),this.preemptive_,this.jsonp_);return this.tileCache_.set(d,f),f}}class Cluster extends VectorSource{constructor(t){t=t||{},super({attributions:t.attributions,wrapX:t.wrapX}),this.resolution=void 0,this.distance=t.distance!==void 0?t.distance:20,this.minDistance=t.minDistance||0,this.interpolationRatio=0,this.features=[],this.geometryFunction=t.geometryFunction||function(n){const s=n.getGeometry();return assert(!s||s.getType()==="Point","The default `geometryFunction` can only handle `Point` or null geometries"),s},this.createCustomCluster_=t.createCluster,this.source=null,this.boundRefresh_=this.refresh.bind(this),this.updateDistance(this.distance,this.minDistance),this.setSource(t.source||null)}clear(t){this.features.length=0,super.clear(t)}getDistance(){return this.distance}getSource(){return this.source}loadFeatures(t,n,s){var o;(o=this.source)==null||o.loadFeatures(t,n,s),n!==this.resolution&&(this.resolution=n,this.refresh())}setDistance(t){this.updateDistance(t,this.minDistance)}setMinDistance(t){this.updateDistance(this.distance,t)}getMinDistance(){return this.minDistance}setSource(t){this.source&&this.source.removeEventListener(EventType$1.CHANGE,this.boundRefresh_),this.source=t,t&&t.addEventListener(EventType$1.CHANGE,this.boundRefresh_),this.refresh()}refresh(){this.clear(),this.cluster(),this.addFeatures(this.features)}updateDistance(t,n){const s=t===0?0:Math.min(n,t)/t,o=t!==this.distance||this.interpolationRatio!==s;this.distance=t,this.minDistance=n,this.interpolationRatio=s,o&&this.refresh()}cluster(){if(this.resolution===void 0||!this.source)return;const t=createEmpty(),n=this.distance*this.resolution,s=this.source.getFeatures(),o={};for(let a=0,h=s.length;a<h;a++){const c=s[a];if(!(getUid(c)in o)){const u=this.geometryFunction(c);if(u){const d=u.getCoordinates();createOrUpdateFromCoordinate(d,t),buffer(t,n,t);const f=this.source.getFeaturesInExtent(t).filter(function(g){const _=getUid(g);return _ in o?!1:(o[_]=!0,!0)});this.features.push(this.createCluster(f,t))}}}}createCluster(t,n){const s=[0,0];for(let c=t.length-1;c>=0;--c){const u=this.geometryFunction(t[c]);u?add$2(s,u.getCoordinates()):t.splice(c,1)}scale$4(s,1/t.length);const o=getCenter(n),a=this.interpolationRatio,h=new Point([s[0]*(1-a)+o[0]*a,s[1]*(1-a)+o[1]*a]);return this.createCustomCluster_?this.createCustomCluster_(h,t):new Feature({geometry:h,features:t})}}class EOxCluster extends Cluster{constructor(t={}){super({...t,createCluster:EOxCluster.defaultCreateCluster,geometryFunction:EOxCluster.defaultGeometryFunction})}static defaultCreateCluster(t,n){const s=n.length===1&&n[0].getGeometry()instanceof Polygon?n[0].getGeometry():t,o=new Feature({geometry:s,features:n});if(n.length===1){const a=n[0];for(const h in a.getProperties())h!=="geometry"&&o.set(h,a.get(h))}return o}static defaultGeometryFunction(t){const n=t&&t.getGeometry();return n instanceof Point?n:n instanceof Polygon?n.getInteriorPoint():null}}class WMTSCapabilities extends TileImage{constructor(t){super({attributions:t.attributions,cacheSize:t.cacheSize,tilePixelRatio:t.tilePixelRatio,transition:t.transition,interpolate:t.interpolate!==void 0?t.interpolate:!0,key:t.key,attributionsCollapsible:t.attributionsCollapsible,zDirection:t.zDirection,wrapX:t.wrapX}),this.version_=t.version!==void 0?t.version:"1.0.0",this.dimensions_=t.dimensions!==void 0?t.dimensions:{},this.layer_=t.layer,fetch(t.url).then(n=>n.text()).then(n=>new window.DOMParser().parseFromString(n,"application/xml")).then(n=>{this.handleCapabilitiesResponse(n,t)})}handleCapabilitiesResponse(t,n){const o=new WMTSCapabilities$1().read(t),a=optionsFromCapabilities(o,n);this.crossOrigin=a.crossOrigin,this.projection=a.projection,this.tileGrid=a.tileGrid,this.requestEncoding_=a.requestEncoding,this.matrixSet_=a.matrixSet,this.style_=a.style,this.format_=a.format,this.dimensions_=a.dimensions,this.setUrls(a.urls),this.urls&&this.urls.length>0&&(this.tileUrlFunction=createFromTileUrlFunctions(this.urls.map(this.createFromWMTSTemplate.bind(this)))),this.getState()!=="ready"&&this.setState("ready")}createFromWMTSTemplate(t){const n=this.requestEncoding_,s={layer:this.layer_,style:this.style_,tilematrixset:this.matrixSet_};n==="KVP"&&Object.assign(s,{Service:"WMTS",Request:"GetTile",Version:this.version_,Format:this.format_}),t=n==="KVP"?appendParams(t,s):t.replace(/\{(\w+?)\}/g,(h,c)=>c.toLowerCase()in s?s[c.toLowerCase()]:h);const o=this.tileGrid,a=this.dimensions_;return function(h){if(!h)return;const c={TileMatrix:o.getMatrixId(h[0]),TileCol:h[1],TileRow:h[2]};Object.assign(c,a);let u=t;return n==="KVP"?u=appendParams(u,c):u=u.replace(/\{(\w+?)\}/g,(d,f)=>c[f]),u}}}class FlatGeoBuf extends VectorSource{constructor(t){super({attributions:t.attributions,wrapX:t.wrapX,strategy:bbox$1}),this.dataProjection=t.projection||READ_FEATURES_OPTIONS.dataProjection,this.resourceURL=t.url,super.setLoader(this.loader)}fgbBoundingBox(t,n){const s=transformExtent$1(t,n.getCode(),this.dataProjection);return{minX:s[0],minY:s[1],maxX:s[2],maxY:s[3]}}async loader(t,n,s,o,a){const h=this.fgbBoundingBox(t,s);try{if(h.minX!==-1/0){const c=[],u=deserialize(this.resourceURL,h),d=new GeoJSON({featureProjection:s,dataProjection:this.dataProjection});for await(const f of u){const g=d.readFeature(f);c.push(g)}super.clear(),super.addFeatures(c),o(c)}}catch{a()}}}window.eoxMapAdvancedOlSources={BingMaps,CartoDB,Cluster:EOxCluster,DataTile:DataTileSource,GeoTIFF:GeoTIFFSource,Google,IIIF,Image:ImageSource,ImageArcGISRest,ImageCanvas:ImageCanvasSource,ImageMapGuide,ImageStatic:Static,ImageTile:ImageTileSource,OGCMapTile,OGCVectorTile,Raster:RasterSource,Source,StadiaMaps,TileArcGISRest,TileDebug,TileImage,TileJSON,UrlTile,UTFGrid,Zoomify,WMTSCapabilities,FlatGeoBuf};let viewHolder=null;const useHandleMapMoveEnd=(l,t)=>{const n=s=>{var c;const o=s.map,a=(c=l.value)==null?void 0:c.lonLatCenter,h=o==null?void 0:o.getView().getZoom();a&&!Number.isNaN(a[0])&&!Number.isNaN(a[1])&&!Number.isNaN(h)&&(t.value=[a[0],a[1],h])};onMounted(()=>{var s,o;(o=(s=l.value)==null?void 0:s.map)==null||o.on("moveend",n)}),onUnmounted(()=>{var s,o;(o=(s=l.value)==null?void 0:s.map)==null||o.un("moveend",n)})},useInitMap=(l,t,n,s,o,a,h,c)=>{log.debug("InitMap",l.value,t.value,n.values,s.value);const d=watch(c?[t,s,c]:[t,s],async(f,g)=>{var S,C,P,w,I,O,N,k,D,ze,z,Ee,B,rt,wt;const[_,m,p]=c?f:[f[0],f[1],null],[x,y,T]=c?g:[g[0],g[1],null];if(_){log.debug("Selected Indicator watch triggered",_,m),((S=l==null?void 0:l.value)==null?void 0:S.id)==="main"&&viewHolder!==null&&((C=l==null?void 0:l.value)==null||C.map.setView(viewHolder),viewHolder=null);let re=[];const mt=(_==null?void 0:_.id)===(x==null?void 0:x.id)&&(m!==y||p&&(p==null?void 0:p.id)!==(T==null?void 0:T.id)),{selectedCompareStac:Mt}=storeToRefs(useSTAcStore());if(((P=l==null?void 0:l.value)==null?void 0:P.id)==="main"?await setMapProjFromCol(_):Mt.value!==null&&(viewHolder=((w=l==null?void 0:l.value)==null?void 0:w.map.getView())??null,l.value.sync=a.value),mt){re=await createLayersConfig(_,n,p??m),log.debug("Assigned layers after changing time only",JSON.parse(JSON.stringify(re))),o.value=re,useEmitLayersUpdate(((I=l.value)==null?void 0:I.id)==="compare"?"compareTime:updated":"time:updated",l.value,re);return}let Bt=null;const Ht=(N=(O=_==null?void 0:_.extent)==null?void 0:O.temporal)==null?void 0:N.interval;if(Ht&&Ht.length>0&&Ht[0].length>1&&(Bt=new Date(Ht[0][1]),Bt.getTime()>Date.now()&&(Bt=new Date),log.debug("Indicator load: found stac extent, setting time to latest value",Bt)),(!p&&Bt!==null&&Bt.toISOString()!==s.value&&!isFirstLoad.value||isFirstLoad.value&&!s.value&&Bt)&&(s.value=Bt.toISOString()),re=await createLayersConfig(_,n,p??m),h&&!p&&((k=l==null?void 0:l.value)==null?void 0:k.id)==="main"&&(D=_.extent)!=null&&D.spatial.bbox&&!(isFirstLoad.value&&((ze=mapPosition.value)!=null&&ze[0])&&((z=mapPosition.value)!=null&&z[1]))){const Nt=(Ee=_.extent)==null?void 0:Ee.spatial.bbox[0],Wt=sanitizeBbox([...Nt]),$t=transformExtent(Wt,"EPSG:4326",(rt=(B=l.value)==null?void 0:B.map)==null?void 0:rt.getView().getProjection());l.value.zoomExtent=$t}log.debug("Assigned layers",JSON.parse(JSON.stringify(re))),o.value=re,await useEmitLayersUpdate(((wt=l.value)==null?void 0:wt.id)==="compare"?"compareLayers:updated":"layers:updated",l.value,o.value)}},{immediate:!0});onUnmounted(()=>{d()})},useUpdateTooltipProperties=(l,t)=>{useOnLayersUpdate(async(n,s)=>{if(n.includes("compare"))return;const o=[];for(const a of l)o.push(...await a.getToolTipProperties());t.value=o,log.debug("Updated tooltip properties",t.value)})},_style_0="#cursor-coordinates[data-v-4c83cf66]{position:fixed;left:24px;bottom:54px;color:#000000e6;font-size:10px;font-family:var(--eox-body-font-family);background:#fffe;border-radius:4px;border:none;padding:0 3px;max-height:24px}@media(max-width:959px){#cursor-coordinates[data-v-4c83cf66]{display:none}}#scale-line[data-v-4c83cf66]{position:fixed;left:24px;bottom:28px;color:#fff}@media(max-width:959px){#scale-line[data-v-4c83cf66]{bottom:102px}}[data-v-4c83cf66] .ol-scale-line{background:#fffe!important;border-radius:4px!important;border:none!important;padding:0 3px 3px!important;font-size:10px!important;font-family:var(--eox-body-font-family);max-height:20px}[data-v-4c83cf66] .ol-scale-line-inner{display:flex;justify-content:center;border:1px solid rgba(0,0,0,.5)!important;border-top:none!important;color:#333!important;font-weight:500!important;transform:translateY(1px)}.map-buttons-container[data-v-4c83cf66]{position:fixed;left:0;width:100%;height:100%;display:grid;grid-template-columns:repeat(12,1fr);grid-template-rows:repeat(12,1fr);pointer-events:none;z-index:1}.map-buttons-container[data-v-4c83cf66]>*{pointer-events:auto}",_hoisted_1=[".enabled"],_hoisted_2=[".center",".zoom",".layers",".controls"],_hoisted_3=[".propertyTransform"],_hoisted_4=[".layers"],_hoisted_5=[".propertyTransform"],_hoisted_6={key:0,id:"cursor-coordinates",ref:"cursor-coords"},_hoisted_7={key:1,id:"scale-line",ref:"scale-line"};var Yu;const _sfc_main={__name:"index",props:{initialLayers:{type:Array,default:()=>[{type:"Tile",source:{type:"OSM"},properties:{id:"osm",title:"Background"}}]},enableCompare:{type:Boolean,default:!1},center:{type:Array,default:()=>{var l,t;return[((l=mapPosition.value)==null?void 0:l[0])??15,((t=mapPosition.value)==null?void 0:t[1])??48]}},zoom:{type:Number,default:((Yu=mapPosition.value)==null?void 0:Yu[2])??4},zoomToExtent:{type:Boolean,default:!0},enableCursorCoordinates:{type:Boolean,default:!0},enableScaleLine:{type:Boolean,default:!0},btnsPosition:{type:Object,default:()=>({x:"12/9/10",y:1,gap:16})},btns:{type:Object,default:()=>({enableExportMap:!0,enableChangeProjection:!0,enableCompareIndicators:!0,enableBackToPOIs:!0,enableSearch:!0,enableZoom:!0,enableGlobe:!0,enableMosaic:!0,searchParams:{}})}},async setup(l){var z;let t,n;const s=l,{width:o}=useDisplay(),a=Ee=>{if(typeof Ee=="number")return Ee;if(typeof Ee=="string"){const B=Ee.split("/"),rt=o.value;return rt<960?parseInt(B[0])||1:rt<1920?parseInt(B[1]||B[0])||1:parseInt(B[2]||B[1]||B[0])||1}return 1},h=computed(()=>a(s.btnsPosition.x)),c=computed(()=>a(s.btnsPosition.y)),u=computed(()=>({exportMap:s.btns.enableExportMap??!0,changeProjection:s.btns.enableChangeProjection??!0,compareIndicators:s.btns.enableCompareIndicators??!0,backToPOIs:s.btns.enableBackToPOIs??!0,enableSearch:s.btns.enableSearch??!0,enableZoom:s.btns.enableZoom??!0,enableGlobe:s.btns.enableGlobe??!0,enableMosaic:s.btns.enableMosaic??!0,searchParams:s.btns.searchParams}));u.value.enableGlobe&&([t,n]=withAsyncContext(()=>__vitePreload(()=>import("./index.BWVV-4Km.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34]))),await t,n());const d=useTemplateRef("scale-line"),f=useTemplateRef("cursor-coords"),g=ref([]),_=ref([]),m=computed(()=>{const Ee={Attribution:{collapsible:!0}};return s.enableScaleLine&&d.value&&(Ee.ScaleLine={target:d.value}),s.enableCursorCoordinates&&f.value&&(Ee.MousePosition={projection:"EPSG:4326",coordinateFormat:B=>`${B[1].toFixed(3)} °N, ${B[0].toFixed(3)} °E`,target:f.value}),Ee}),p=toRaw(s.center),x=toRaw(((z=mapPosition.value)==null?void 0:z[2])??s.zoom),y=ref(s.initialLayers),T=ref([{type:"Tile",source:{type:"OSM"},properties:{id:"osm",title:"Background"}}]),S={duration:1200,easing:inAndOut$1},C=ref(null),P=ref(null),{selectedCompareStac:w}=storeToRefs(useSTAcStore()),I=computed(()=>s.enableCompare&&w.value?"":"first");useHandleMapMoveEnd(C,mapPosition),onMounted(()=>{const{selectedCompareStac:Ee,selectedStac:B,selectedItem:rt,selectedCompareItem:wt}=storeToRefs(useSTAcStore());mapEl.value=C.value,timesliderUpdateRef.value+=1,s.enableCompare&&(mapCompareEl.value=P.value),s.enableCompare&&(useInitMap(P,Ee,eodashCompareCollections,datetime,T,C,!1,wt),useUpdateTooltipProperties(eodashCollections,_)),useInitMap(C,B,eodashCollections,datetime,y,P,s.zoomToExtent,rt)}),useUpdateTooltipProperties(eodashCollections,g);const O=computed(()=>({visibility:g.value.length?"visible":"hidden"})),N=computed(()=>({visibility:_.value.length?"visible":"hidden"})),k=Ee=>{const B=Ee==="main"?g:_,rt=Ee=="main"?layerControlFormValue:layerControlFormValueCompare;return wt=>{const re=JSON.parse(mustache.render(JSON.stringify(B.value),{...rt.value??{}})),mt=re==null?void 0:re.find(Mt=>Mt.id===wt.key);if(mt){if(typeof wt.value=="object"&&(wt.value=JSON.stringify(wt.value)),!isNaN(Number(wt.value))){const Mt=isNaN(Number(mt.decimals))?4:Number(mt.decimals);wt.value=Number(wt.value).toFixed(Mt).toString()}return{key:mt.title||mt.id,value:wt.value+" "+(mt.appendix||"")}}}},{mainRect:D}=useLayout(),ze=ref(0);return onMounted(()=>{const Ee=document.querySelector("eo-dash");ze.value=(D.value.top||(Ee==null?void 0:Ee.getBoundingClientRect().top))??0}),(Ee,B)=>(openBlock(),createElementBlock("span",null,[createBaseVNode("eox-map-compare",{class:"fill-height fill-width overflow-none",".enabled":I.value},[createBaseVNode("eox-map",{class:"fill-height fill-width overflow-none",slot:"first",ref_key:"eoxMap",ref:C,id:"main",".animationOptions":S,".center":unref(p),".zoom":unref(x),".layers":y.value,".controls":m.value},[createBaseVNode("eox-map-tooltip",{style:normalizeStyle(O.value),".propertyTransform":k("main")},null,44,_hoisted_3)],40,_hoisted_2),createBaseVNode("eox-map",{class:"fill-height fill-width overflow-none",id:"compare",slot:"second",ref_key:"compareMap",ref:P,".layers":T.value},[createBaseVNode("eox-map-tooltip",{style:normalizeStyle(N.value),".propertyTransform":k("compare")},null,44,_hoisted_5)],40,_hoisted_4)],40,_hoisted_1),l.enableCursorCoordinates?(openBlock(),createElementBlock("div",_hoisted_6,null,512)):createCommentVNode("v-if",!0),l.enableScaleLine?(openBlock(),createElementBlock("span",_hoisted_7,null,512)):createCommentVNode("v-if",!0),createBaseVNode("div",{class:"map-buttons-container",style:normalizeStyle(`margin: ${l.btnsPosition.gap}px 0 ${l.btnsPosition.gap}px 0; top: ${ze.value}px;`)},[createCommentVNode(" prettier-ignore "),createVNode(EodashMapBtns,{style:normalizeStyle({gridColumn:(unref(indicator)||unref(compareIndicator)||unref(poi))&&!unref(isGlobe)?h.value:"12",gridRow:c.value}),exportMap:unref(indicator)||unref(compareIndicator)||unref(poi)?u.value.exportMap:!1,changeProjection:unref(indicator)||unref(compareIndicator)||unref(poi)?u.value.changeProjection:!1,compareIndicators:unref(indicator)||unref(compareIndicator)||unref(poi)?u.value.compareIndicators:!1,backToPOIs:unref(indicator)||unref(compareIndicator)||unref(poi)?u.value.backToPOIs:!1,enableSearch:unref(indicator)||unref(compareIndicator)||unref(poi)?u.value.enableSearch:!1,enableZoom:unref(indicator)||unref(compareIndicator)||unref(poi)?u.value.enableZoom:!1,enableGlobe:unref(indicator)||unref(compareIndicator)||unref(poi)?u.value.enableGlobe:!1,searchParams:u.value.searchParams},null,8,["style","exportMap","changeProjection","compareIndicators","backToPOIs","enableSearch","enableZoom","enableGlobe","searchParams"])],4)]))}},index=_export_sfc(_sfc_main,[["styles",[_style_0]],["__scopeId","data-v-4c83cf66"]]),indexCFkjkhhA=Object.freeze(Object.defineProperty({__proto__:null,default:index},Symbol.toStringTag,{value:"Module"}));export{createGlobe as a,createMapPool as c,indexCFkjkhhA as i,processLayers as p,refreshGlobe as r};

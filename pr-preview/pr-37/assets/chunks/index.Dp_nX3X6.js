import{J as bo,F as Re,g as Q,i as Ao,t as me,d as Co,l as Io,c as ur,L as Vr,M as Zt,a as bt,b as Lr,P as ut,e as Be,f as Ie,X as vr,m as G,h as O,p as A,j as ui,k as hr,G as Fo,n as No,o as Qe,q as dr,r as is,s as k,u as E,v as ie,w as H,x as ve,O as At,y as Ke,z as Bt,A as ns,B as fr,C as gr,D as I,E as p,H as b,I as br,K as fe,N as ye,Q as hi,R as ss,S as pr,T as ot,U as Mo,V as os,W as ke,Y as be,Z as te,_ as Oo,$ as it,a0 as qi,a1 as Le,a2 as Ge,a3 as Do,a4 as di,a5 as Go,a6 as Uo,a7 as mr,a8 as Bo,a9 as zt,aa as zo,ab as $o,ac as Xo,ad as Yr,ae as Ki,af as Br,ag as Ji,ah as Qi,ai as lt,aj as fi,ak as ko,al as jo,am as Wo,an as Ue,ao as $t,ap as gi,aq as et,ar,as as wt,at as Ee,au as ue,av as Lt,aw as St,ax as Zo,ay as J,az as as,aA as _e,aB as pi,aC as Ho,aD as Vo,aE as xe,aF as V,aG as mi,aH as Ne,aI as Yo,aJ as _i,aK as qr,aL as Kr,aM as nt,aN as qo,aO as Jr,aP as zr,aQ as Ko,aR as Qr,aS as ls,aT as Jo,aU as xt,aV as Qo,aW as en,aX as ea,aY as Ei,aZ as ta,a_ as cs,a$ as He,b0 as Ht,b1 as ra,b2 as ia,b3 as Y,b4 as Xt,b5 as kt,b6 as Se,b7 as ht,b8 as gt,b9 as na,ba as j,bb as tn,bc as sa,bd as oa,be as aa,bf as us,bg as la,bh as jt,bi as ca,bj as Vt,bk as We,bl as Je,bm as ua,bn as st,bo as Ar,bp as yi,bq as _r,br as hs,bs as ct,bt as ha,bu as da,bv as ds,bw as Me,bx as fa,by as ga,bz as Ti,bA as pa,bB as ma,bC as _a,bD as Ye,bE as Yt,bF as qt,bG as xi,bH as Ri,bI as fs,bJ as Ea,bK as ya,bL as ei,bM as rn,bN as Ta,bO as xa,bP as Ra,bQ as Sa,bR as Pa,bS as Si,bT as wa,bU as La,bV as va,bW as ba,bX as $r,bY as Wt,bZ as Cr,b_ as Aa,b$ as Ca,c0 as Ia,c1 as nn,c2 as sn,c3 as on,c4 as Fa,c5 as Na,c6 as ti,c7 as gs,c8 as an,c9 as Er,ca as ps,cb as Ct,cc as ln,cd as pt,ce as Pi,cf as Ma,cg as ms,ch as Oa,ci as Da,cj as wi,ck as Ga,cl as Ua,cm as Ba,cn as za,co as $a,cp as Xa,cq as ka,cr as _s,cs as ja,ct as Wa,cu as Za,cv as Ha,cw as Va,cx as Ya,cy as qa,cz as Ka,cA as Ja,cB as Qa,cC as el,cD as tl,cE as rl}from"./map.TJyp_S4f.js";import{a as il,S as nl,f as sl,b as ol,c as al,P as ll,p as cl,d as ul}from"./geojson.DUVa_cpy.js";import{p as hl}from"./index.Du0sVlOV.js";import"./index.OUYS7i6-.js";import"./Group.BnugPW7_.js";import"./Tile.gsF6xMKC.js";import"./XYZ.DtVLERao.js";import"./Layer.CNvgX2e5.js";import"./Vector.DMJmXynL.js";import"./DataTile.BP2Evev7.js";import"./item.Bx-rtsOD.js";import"./commonjsHelpers.BosuxZz1.js";import"./framework.Du2fbVQQ.js";import"./index.BYzJOi-i.js";const dl={Point:ml,LineString:_l,Polygon:xl,MultiPoint:yl,MultiLineString:El,MultiPolygon:Tl},fl={Point:Rl,LineString:Sl,Polygon:Pl,MultiPoint:Ll,MultiLineString:wl,MultiPolygon:vl};class gl extends bo{constructor(e){e=e||{},super(),this.geometryName_=e.geometryName}readFeatureFromObject(e,t,r){const n=e,s=cn(n.geometry,t),o=new Re;if(this.geometryName_&&o.setGeometryName(this.geometryName_),o.setGeometry(s),n.attributes){o.setProperties(n.attributes,!0);const a=n.attributes[r];a!==void 0&&o.setId(a)}return o}readFeaturesFromObject(e,t){if(t=t||{},e.features){const r=e,n=[],s=r.features;for(let o=0,a=s.length;o<a;++o)n.push(this.readFeatureFromObject(s[o],t,e.objectIdFieldName));return n}return[this.readFeatureFromObject(e,t)]}readGeometryFromObject(e,t){return cn(e,t)}readProjectionFromObject(e){if(e.spatialReference&&e.spatialReference.wkid!==void 0){const r=e.spatialReference.wkid;return Q("EPSG:"+r)}return null}writeGeometryObject(e,t){return un(e,this.adaptOptions(t))}writeFeatureObject(e,t){t=this.adaptOptions(t);const r={};if(!e.hasProperties())return r.attributes={},r;const n=e.getProperties(),s=e.getGeometry();if(s){r.geometry=un(s,t);const o=t&&(t.dataProjection||t.featureProjection);o&&(r.geometry.spatialReference={wkid:Number(Q(o).getCode().split(":").pop())}),delete n[e.getGeometryName()]}return Ao(n)?r.attributes={}:r.attributes=n,r}writeFeaturesObject(e,t){t=this.adaptOptions(t);const r=[];for(let n=0,s=e.length;n<s;++n)r.push(this.writeFeatureObject(e[n],t));return{features:r}}}function cn(i,e){if(!i)return null;let t;if(typeof i.x=="number"&&typeof i.y=="number")t="Point";else if(i.points)t="MultiPoint";else if(i.paths)i.paths.length===1?t="LineString":t="MultiLineString";else if(i.rings){const n=i,s=It(n),o=pl(n.rings,s);o.length===1?(t="Polygon",i=Object.assign({},i,{rings:o[0]})):(t="MultiPolygon",i=Object.assign({},i,{rings:o}))}const r=dl[t];return me(r(i),!1,e)}function pl(i,e){const t=[],r=[],n=[];let s,o;for(s=0,o=i.length;s<o;++s)t.length=0,Co(t,0,i[s],e.length),Io(t,0,t.length,e.length)?r.push([i[s]]):n.push(i[s]);for(;n.length;){const a=n.shift();let l=!1;for(s=r.length-1;s>=0;s--){const c=r[s][0];if(ur(new Vr(c).getExtent(),new Vr(a).getExtent())){r[s].push(a),l=!0;break}}l||r.push([a.reverse()])}return r}function ml(i){let e;return i.m!==void 0&&i.z!==void 0?e=new Ie([i.x,i.y,i.z,i.m],"XYZM"):i.z!==void 0?e=new Ie([i.x,i.y,i.z],"XYZ"):i.m!==void 0?e=new Ie([i.x,i.y,i.m],"XYM"):e=new Ie([i.x,i.y]),e}function _l(i){const e=It(i);return new Be(i.paths[0],e)}function El(i){const e=It(i);return new bt(i.paths,e)}function It(i){let e="XY";return i.hasZ===!0&&i.hasM===!0?e="XYZM":i.hasZ===!0?e="XYZ":i.hasM===!0&&(e="XYM"),e}function yl(i){const e=It(i);return new Lr(i.points,e)}function Tl(i){const e=It(i);return new Zt(i.rings,e)}function xl(i){const e=It(i);return new ut(i.rings,e)}function Rl(i,e){const t=i.getCoordinates();let r;const n=i.getLayout();if(n==="XYZ")r={x:t[0],y:t[1],z:t[2]};else if(n==="XYM")r={x:t[0],y:t[1],m:t[2]};else if(n==="XYZM")r={x:t[0],y:t[1],z:t[2],m:t[3]};else if(n==="XY")r={x:t[0],y:t[1]};else throw new Error("Invalid geometry layout");return r}function Kt(i){const e=i.getLayout();return{hasZ:e==="XYZ"||e==="XYZM",hasM:e==="XYM"||e==="XYZM"}}function Sl(i,e){const t=Kt(i);return{hasZ:t.hasZ,hasM:t.hasM,paths:[i.getCoordinates()]}}function Pl(i,e){const t=Kt(i);return{hasZ:t.hasZ,hasM:t.hasM,rings:i.getCoordinates(!1)}}function wl(i,e){const t=Kt(i);return{hasZ:t.hasZ,hasM:t.hasM,paths:i.getCoordinates()}}function Ll(i,e){const t=Kt(i);return{hasZ:t.hasZ,hasM:t.hasM,points:i.getCoordinates()}}function vl(i,e){const t=Kt(i),r=i.getCoordinates(!1),n=[];for(let s=0;s<r.length;s++)for(let o=r[s].length-1;o>=0;o--)n.push(r[s][o]);return{hasZ:t.hasZ,hasM:t.hasM,rings:n}}function un(i,e){const t=fl[i.getType()];return t(me(i,!0,e),e)}const Ze="http://www.opengis.net/gml",bl=/^\s*$/;class N extends vr{constructor(e){super(),e=e||{},this.featureType=e.featureType,this.featureNS=e.featureNS,this.srsName=e.srsName,this.schemaLocation="",this.FEATURE_COLLECTION_PARSERS={},this.FEATURE_COLLECTION_PARSERS[this.namespace]={featureMember:O(this.readFeaturesInternal),featureMembers:G(this.readFeaturesInternal)},this.supportedMediaTypes=["application/gml+xml"]}readFeaturesInternal(e,t){const r=e.localName;let n=null;if(r=="FeatureCollection")n=A([],this.FEATURE_COLLECTION_PARSERS,e,t,this);else if(r=="featureMembers"||r=="featureMember"||r=="member"){const s=t[0];let o=s.featureType,a=s.featureNS;const l="p",c="p0";if(!o&&e.childNodes){o=[],a={};for(let f=0,g=e.childNodes.length;f<g;++f){const d=e.childNodes[f];if(d.nodeType===1){const m=d.nodeName.split(":").pop();if(!o.includes(m)){let _="",y=0;const T=d.namespaceURI;for(const x in a){if(a[x]===T){_=x;break}++y}_||(_=l+y,a[_]=T),o.push(_+":"+m)}}}r!="featureMember"&&(s.featureType=o,s.featureNS=a)}if(typeof a=="string"){const f=a;a={},a[c]=f}const u={},h=Array.isArray(o)?o:[o];for(const f in a){const g={};for(let d=0,m=h.length;d<m;++d)(h[d].includes(":")?h[d].split(":")[0]:c)===f&&(g[h[d].split(":").pop()]=r=="featureMembers"?O(this.readFeatureElement,this):G(this.readFeatureElement,this));u[a[f]]=g}r=="featureMember"||r=="member"?n=A(void 0,u,e,t):n=A([],u,e,t)}return n===null&&(n=[]),n}readGeometryOrExtent(e,t){const r=t[0];return r.srsName=e.firstElementChild.getAttribute("srsName"),r.srsDimension=e.firstElementChild.getAttribute("srsDimension"),A(null,this.GEOMETRY_PARSERS,e,t,this)}readExtentElement(e,t){const r=t[0],n=this.readGeometryOrExtent(e,t);return n?ui(n,r):void 0}readGeometryElement(e,t){const r=t[0],n=this.readGeometryOrExtent(e,t);return n?me(n,!1,r):void 0}readFeatureElementInternal(e,t,r){let n;const s={};for(let l=e.firstElementChild;l;l=l.nextElementSibling){let c;const u=l.localName;l.childNodes.length===0||l.childNodes.length===1&&(l.firstChild.nodeType===3||l.firstChild.nodeType===4)?(c=hr(l,!1),bl.test(c)&&(c=void 0)):(r&&(c=u==="boundedBy"?this.readExtentElement(l,t):this.readGeometryElement(l,t)),c?u!=="boundedBy"&&(n=u):c=this.readFeatureElementInternal(l,t,!1));const h=l.attributes.length;if(h>0&&!(c instanceof Fo)){c={_content_:c};for(let f=0;f<h;f++){const g=l.attributes[f].name;c[g]=l.attributes[f].value}}s[u]?(s[u]instanceof Array||(s[u]=[s[u]]),s[u].push(c)):s[u]=c}if(!r)return s;const o=new Re(s);n&&o.setGeometryName(n);const a=e.getAttribute("fid")||No(e,this.namespace,"id");return a&&o.setId(a),o}readFeatureElement(e,t){return this.readFeatureElementInternal(e,t,!0)}readPoint(e,t){const r=this.readFlatCoordinatesFromNode(e,t);if(r)return new Ie(r,"XYZ")}readMultiPoint(e,t){const r=A([],this.MULTIPOINT_PARSERS,e,t,this);if(r)return new Lr(r)}readMultiLineString(e,t){const r=A([],this.MULTILINESTRING_PARSERS,e,t,this);if(r)return new bt(r)}readMultiPolygon(e,t){const r=A([],this.MULTIPOLYGON_PARSERS,e,t,this);if(r)return new Zt(r)}pointMemberParser(e,t){Qe(this.POINTMEMBER_PARSERS,e,t,this)}lineStringMemberParser(e,t){Qe(this.LINESTRINGMEMBER_PARSERS,e,t,this)}polygonMemberParser(e,t){Qe(this.POLYGONMEMBER_PARSERS,e,t,this)}readLineString(e,t){const r=this.readFlatCoordinatesFromNode(e,t);if(r)return new Be(r,"XYZ")}readFlatLinearRing(e,t){const r=A(null,this.GEOMETRY_FLAT_COORDINATES_PARSERS,e,t,this);if(r)return r}readLinearRing(e,t){const r=this.readFlatCoordinatesFromNode(e,t);if(r)return new Vr(r,"XYZ")}readPolygon(e,t){const r=A([null],this.FLAT_LINEAR_RINGS_PARSERS,e,t,this);if(r&&r[0]){const n=r[0],s=[n.length];let o,a;for(o=1,a=r.length;o<a;++o)dr(n,r[o]),s.push(n.length);return new ut(n,"XYZ",s)}}readFlatCoordinatesFromNode(e,t){return A(null,this.GEOMETRY_FLAT_COORDINATES_PARSERS,e,t,this)}readGeometryFromNode(e,t){const r=this.readGeometryElement(e,[this.getReadOptions(e,t||{})]);return r||null}readFeaturesFromNode(e,t){const r={featureType:this.featureType,featureNS:this.featureNS};return r&&Object.assign(r,this.getReadOptions(e,t)),this.readFeaturesInternal(e,[r])||[]}readProjectionFromNode(e){return Q(this.srsName?this.srsName:e.firstElementChild.getAttribute("srsName"))}}N.prototype.namespace=Ze;N.prototype.FLAT_LINEAR_RINGS_PARSERS={"http://www.opengis.net/gml":{}};N.prototype.GEOMETRY_FLAT_COORDINATES_PARSERS={"http://www.opengis.net/gml":{}};N.prototype.GEOMETRY_PARSERS={"http://www.opengis.net/gml":{}};N.prototype.MULTIPOINT_PARSERS={"http://www.opengis.net/gml":{pointMember:O(N.prototype.pointMemberParser),pointMembers:O(N.prototype.pointMemberParser)}};N.prototype.MULTILINESTRING_PARSERS={"http://www.opengis.net/gml":{lineStringMember:O(N.prototype.lineStringMemberParser),lineStringMembers:O(N.prototype.lineStringMemberParser)}};N.prototype.MULTIPOLYGON_PARSERS={"http://www.opengis.net/gml":{polygonMember:O(N.prototype.polygonMemberParser),polygonMembers:O(N.prototype.polygonMemberParser)}};N.prototype.POINTMEMBER_PARSERS={"http://www.opengis.net/gml":{Point:O(N.prototype.readFlatCoordinatesFromNode)}};N.prototype.LINESTRINGMEMBER_PARSERS={"http://www.opengis.net/gml":{LineString:O(N.prototype.readLineString)}};N.prototype.POLYGONMEMBER_PARSERS={"http://www.opengis.net/gml":{Polygon:O(N.prototype.readPolygon)}};N.prototype.RING_PARSERS={"http://www.opengis.net/gml":{LinearRing:G(N.prototype.readFlatLinearRing)}};const Al=Ze+" http://schemas.opengis.net/gml/2.1.2/feature.xsd",Cl={MultiLineString:"lineStringMember",MultiCurve:"curveMember",MultiPolygon:"polygonMember",MultiSurface:"surfaceMember"};class W extends N{constructor(e){e=e||{},super(e),this.FEATURE_COLLECTION_PARSERS[Ze].featureMember=O(this.readFeaturesInternal),this.schemaLocation=e.schemaLocation?e.schemaLocation:Al}readFlatCoordinates(e,t){const r=hr(e,!1).replace(/^\s*|\s*$/g,""),s=t[0].srsName;let o="enu";if(s){const c=Q(s);c&&(o=c.getAxisOrientation())}const a=r.trim().split(/\s+/),l=[];for(let c=0,u=a.length;c<u;c++){const h=a[c].split(/,+/),f=parseFloat(h[0]),g=parseFloat(h[1]),d=h.length===3?parseFloat(h[2]):0;o.startsWith("en")?l.push(f,g,d):l.push(g,f,d)}return l}readBox(e,t){const r=A([null],this.BOX_PARSERS_,e,t,this);return is(r[1][0],r[1][1],r[1][3],r[1][4])}innerBoundaryIsParser(e,t){const r=A(void 0,this.RING_PARSERS,e,t,this);r&&t[t.length-1].push(r)}outerBoundaryIsParser(e,t){const r=A(void 0,this.RING_PARSERS,e,t,this);if(r){const n=t[t.length-1];n[0]=r}}GEOMETRY_NODE_FACTORY_(e,t,r){const n=t[t.length-1],s=n.multiSurface,o=n.surface,a=n.multiCurve;return Array.isArray(e)?r="Envelope":(r=e.getType(),r==="MultiPolygon"&&s===!0?r="MultiSurface":r==="Polygon"&&o===!0?r="Surface":r==="MultiLineString"&&a===!0&&(r="MultiCurve")),k("http://www.opengis.net/gml",r)}writeFeatureElement(e,t,r){const n=t.getId();n&&e.setAttribute("fid",n);const s=r[r.length-1],o=s.featureNS,a=t.getGeometryName();s.serializers||(s.serializers={},s.serializers[o]={});const l=[],c=[];if(t.hasProperties()){const h=t.getProperties();for(const f in h){const g=h[f];g!=null&&(l.push(f),c.push(g),f==a||typeof g.getSimplifiedGeometry=="function"?f in s.serializers[o]||(s.serializers[o][f]=E(this.writeGeometryElement,this)):f in s.serializers[o]||(s.serializers[o][f]=E(H)))}}const u=Object.assign({},s);u.node=e,ie(u,s.serializers,ve(void 0,o),c,r,l)}writeCurveOrLineString(e,t,r){const s=r[r.length-1].srsName;if(e.nodeName!=="LineStringSegment"&&s&&e.setAttribute("srsName",s),e.nodeName==="LineString"||e.nodeName==="LineStringSegment"){const o=this.createCoordinatesNode_(e.namespaceURI);e.appendChild(o),this.writeCoordinates_(o,t,r)}else if(e.nodeName==="Curve"){const o=k(e.namespaceURI,"segments");e.appendChild(o),this.writeCurveSegments_(o,t,r)}}writeLineStringOrCurveMember(e,t,r){const n=this.GEOMETRY_NODE_FACTORY_(t,r);n&&(e.appendChild(n),this.writeCurveOrLineString(n,t,r))}writeMultiCurveOrLineString(e,t,r){const n=r[r.length-1],s=n.hasZ,o=n.srsName,a=n.curve;o&&e.setAttribute("srsName",o);const l=t.getLineStrings();ie({node:e,hasZ:s,srsName:o,curve:a},this.LINESTRINGORCURVEMEMBER_SERIALIZERS,this.MULTIGEOMETRY_MEMBER_NODE_FACTORY_,l,r,void 0,this)}writeGeometryElement(e,t,r){const n=r[r.length-1],s=Object.assign({},n);s.node=e;let o;Array.isArray(t)?o=ui(t,n):o=me(t,!0,n),ie(s,this.GEOMETRY_SERIALIZERS,this.GEOMETRY_NODE_FACTORY_,[o],r,void 0,this)}createCoordinatesNode_(e){const t=k(e,"coordinates");return t.setAttribute("decimal","."),t.setAttribute("cs",","),t.setAttribute("ts"," "),t}writeCoordinates_(e,t,r){const n=r[r.length-1],s=n.hasZ,o=n.srsName,a=t.getCoordinates(),l=a.length,c=new Array(l);for(let u=0;u<l;++u){const h=a[u];c[u]=this.getCoords_(h,o,s)}H(e,c.join(" "))}writeCurveSegments_(e,t,r){const n=k(e.namespaceURI,"LineStringSegment");e.appendChild(n),this.writeCurveOrLineString(n,t,r)}writeSurfaceOrPolygon(e,t,r){const n=r[r.length-1],s=n.hasZ,o=n.srsName;if(e.nodeName!=="PolygonPatch"&&o&&e.setAttribute("srsName",o),e.nodeName==="Polygon"||e.nodeName==="PolygonPatch"){const a=t.getLinearRings();ie({node:e,hasZ:s,srsName:o},this.RING_SERIALIZERS,this.RING_NODE_FACTORY_,a,r,void 0,this)}else if(e.nodeName==="Surface"){const a=k(e.namespaceURI,"patches");e.appendChild(a),this.writeSurfacePatches_(a,t,r)}}RING_NODE_FACTORY_(e,t,r){const n=t[t.length-1],s=n.node,o=n.exteriorWritten;return o===void 0&&(n.exteriorWritten=!0),k(s.namespaceURI,o!==void 0?"innerBoundaryIs":"outerBoundaryIs")}writeSurfacePatches_(e,t,r){const n=k(e.namespaceURI,"PolygonPatch");e.appendChild(n),this.writeSurfaceOrPolygon(n,t,r)}writeRing(e,t,r){const n=k(e.namespaceURI,"LinearRing");e.appendChild(n),this.writeLinearRing(n,t,r)}getCoords_(e,t,r){let s=(t?Q(t).getAxisOrientation():"enu").startsWith("en")?e[0]+","+e[1]:e[1]+","+e[0];if(r){const o=e[2]||0;s+=","+o}return s}writePoint(e,t,r){const n=r[r.length-1],s=n.hasZ,o=n.srsName;o&&e.setAttribute("srsName",o);const a=this.createCoordinatesNode_(e.namespaceURI);e.appendChild(a);const l=t.getCoordinates(),c=this.getCoords_(l,o,s);H(a,c)}writeMultiPoint(e,t,r){const n=r[r.length-1],s=n.hasZ,o=n.srsName;o&&e.setAttribute("srsName",o);const a=t.getPoints();ie({node:e,hasZ:s,srsName:o},this.POINTMEMBER_SERIALIZERS,ve("pointMember"),a,r,void 0,this)}writePointMember(e,t,r){const n=k(e.namespaceURI,"Point");e.appendChild(n),this.writePoint(n,t,r)}writeLinearRing(e,t,r){const s=r[r.length-1].srsName;s&&e.setAttribute("srsName",s);const o=this.createCoordinatesNode_(e.namespaceURI);e.appendChild(o),this.writeCoordinates_(o,t,r)}writeMultiSurfaceOrPolygon(e,t,r){const n=r[r.length-1],s=n.hasZ,o=n.srsName,a=n.surface;o&&e.setAttribute("srsName",o);const l=t.getPolygons();ie({node:e,hasZ:s,srsName:o,surface:a},this.SURFACEORPOLYGONMEMBER_SERIALIZERS,this.MULTIGEOMETRY_MEMBER_NODE_FACTORY_,l,r,void 0,this)}writeSurfaceOrPolygonMember(e,t,r){const n=this.GEOMETRY_NODE_FACTORY_(t,r);n&&(e.appendChild(n),this.writeSurfaceOrPolygon(n,t,r))}writeEnvelope(e,t,r){const s=r[r.length-1].srsName;s&&e.setAttribute("srsName",s);const o=["lowerCorner","upperCorner"],a=[t[0]+" "+t[1],t[2]+" "+t[3]];ie({node:e},this.ENVELOPE_SERIALIZERS,At,a,r,o,this)}MULTIGEOMETRY_MEMBER_NODE_FACTORY_(e,t,r){const n=t[t.length-1].node;return k("http://www.opengis.net/gml",Cl[n.nodeName])}}W.prototype.GEOMETRY_FLAT_COORDINATES_PARSERS={"http://www.opengis.net/gml":{coordinates:G(W.prototype.readFlatCoordinates)}};W.prototype.FLAT_LINEAR_RINGS_PARSERS={"http://www.opengis.net/gml":{innerBoundaryIs:W.prototype.innerBoundaryIsParser,outerBoundaryIs:W.prototype.outerBoundaryIsParser}};W.prototype.BOX_PARSERS_={"http://www.opengis.net/gml":{coordinates:O(W.prototype.readFlatCoordinates)}};W.prototype.GEOMETRY_PARSERS={"http://www.opengis.net/gml":{Point:G(N.prototype.readPoint),MultiPoint:G(N.prototype.readMultiPoint),LineString:G(N.prototype.readLineString),MultiLineString:G(N.prototype.readMultiLineString),LinearRing:G(N.prototype.readLinearRing),Polygon:G(N.prototype.readPolygon),MultiPolygon:G(N.prototype.readMultiPolygon),Box:G(W.prototype.readBox)}};W.prototype.GEOMETRY_SERIALIZERS={"http://www.opengis.net/gml":{Curve:E(W.prototype.writeCurveOrLineString),MultiCurve:E(W.prototype.writeMultiCurveOrLineString),Point:E(W.prototype.writePoint),MultiPoint:E(W.prototype.writeMultiPoint),LineString:E(W.prototype.writeCurveOrLineString),MultiLineString:E(W.prototype.writeMultiCurveOrLineString),LinearRing:E(W.prototype.writeLinearRing),Polygon:E(W.prototype.writeSurfaceOrPolygon),MultiPolygon:E(W.prototype.writeMultiSurfaceOrPolygon),Surface:E(W.prototype.writeSurfaceOrPolygon),MultiSurface:E(W.prototype.writeMultiSurfaceOrPolygon),Envelope:E(W.prototype.writeEnvelope)}};W.prototype.LINESTRINGORCURVEMEMBER_SERIALIZERS={"http://www.opengis.net/gml":{lineStringMember:E(W.prototype.writeLineStringOrCurveMember),curveMember:E(W.prototype.writeLineStringOrCurveMember)}};W.prototype.RING_SERIALIZERS={"http://www.opengis.net/gml":{outerBoundaryIs:E(W.prototype.writeRing),innerBoundaryIs:E(W.prototype.writeRing)}};W.prototype.POINTMEMBER_SERIALIZERS={"http://www.opengis.net/gml":{pointMember:E(W.prototype.writePointMember)}};W.prototype.SURFACEORPOLYGONMEMBER_SERIALIZERS={"http://www.opengis.net/gml":{surfaceMember:E(W.prototype.writeSurfaceOrPolygonMember),polygonMember:E(W.prototype.writeSurfaceOrPolygonMember)}};W.prototype.ENVELOPE_SERIALIZERS={"http://www.opengis.net/gml":{lowerCorner:E(H),upperCorner:E(H)}};const Il=Ze+" http://schemas.opengis.net/gml/3.1.1/profiles/gmlsfProfile/1.0.0/gmlsf.xsd",Fl={MultiLineString:"lineStringMember",MultiCurve:"curveMember",MultiPolygon:"polygonMember",MultiSurface:"surfaceMember"};class L extends N{constructor(e){e=e||{},super(e),this.surface_=e.surface!==void 0?e.surface:!1,this.curve_=e.curve!==void 0?e.curve:!1,this.multiCurve_=e.multiCurve!==void 0?e.multiCurve:!0,this.multiSurface_=e.multiSurface!==void 0?e.multiSurface:!0,this.schemaLocation=e.schemaLocation?e.schemaLocation:Il,this.hasZ=e.hasZ!==void 0?e.hasZ:!1}readMultiCurve(e,t){const r=A([],this.MULTICURVE_PARSERS,e,t,this);if(r)return new bt(r)}readFlatCurveRing(e,t){const r=A([],this.MULTICURVE_PARSERS,e,t,this),n=[];for(let s=0,o=r.length;s<o;++s)dr(n,r[s].getFlatCoordinates());return n}readMultiSurface(e,t){const r=A([],this.MULTISURFACE_PARSERS,e,t,this);if(r)return new Zt(r)}curveMemberParser(e,t){Qe(this.CURVEMEMBER_PARSERS,e,t,this)}surfaceMemberParser(e,t){Qe(this.SURFACEMEMBER_PARSERS,e,t,this)}readPatch(e,t){return A([null],this.PATCHES_PARSERS,e,t,this)}readSegment(e,t){return A([],this.SEGMENTS_PARSERS,e,t,this)}readPolygonPatch(e,t){return A([null],this.FLAT_LINEAR_RINGS_PARSERS,e,t,this)}readLineStringSegment(e,t){return A([null],this.GEOMETRY_FLAT_COORDINATES_PARSERS,e,t,this)}interiorParser(e,t){const r=A(void 0,this.RING_PARSERS,e,t,this);r&&t[t.length-1].push(r)}exteriorParser(e,t){const r=A(void 0,this.RING_PARSERS,e,t,this);if(r){const n=t[t.length-1];n[0]=r}}readSurface(e,t){const r=A([null],this.SURFACE_PARSERS,e,t,this);if(r&&r[0]){const n=r[0],s=[n.length];let o,a;for(o=1,a=r.length;o<a;++o)dr(n,r[o]),s.push(n.length);return new ut(n,"XYZ",s)}}readCurve(e,t){const r=A([null],this.CURVE_PARSERS,e,t,this);if(r)return new Be(r,"XYZ")}readEnvelope(e,t){const r=A([null],this.ENVELOPE_PARSERS,e,t,this);return is(r[1][0],r[1][1],r[2][0],r[2][1])}readFlatPos(e,t){let r=hr(e,!1);const n=/^\s*([+\-]?\d*\.?\d+(?:[eE][+\-]?\d+)?)\s*/,s=[];let o;for(;o=n.exec(r);)s.push(parseFloat(o[1])),r=r.substr(o[0].length);if(r!=="")return;const l=t[0].srsName;if((l?Q(l).getAxisOrientation():"enu")==="neu")for(let h=0,f=s.length;h<f;h+=3){const g=s[h],d=s[h+1];s[h]=d,s[h+1]=g}const u=s.length;if(u==2&&s.push(0),u!==0)return s}readFlatPosList(e,t){const r=hr(e,!1).replace(/^\s*|\s*$/g,""),n=t[0],s=n.srsName,o=n.srsDimension,a=s?Q(s).getAxisOrientation():"enu",l=r.split(/\s+/);let c=2;e.getAttribute("srsDimension")?c=Ke(e.getAttribute("srsDimension")):e.getAttribute("dimension")?c=Ke(e.getAttribute("dimension")):e.parentNode.getAttribute("srsDimension")?c=Ke(e.parentNode.getAttribute("srsDimension")):o&&(c=Ke(o));const u=a.startsWith("en");let h,f,g;const d=[];for(let m=0,_=l.length;m<_;m+=c)h=parseFloat(l[m]),f=parseFloat(l[m+1]),g=c===3?parseFloat(l[m+2]):0,u?d.push(h,f,g):d.push(f,h,g);return d}writePos_(e,t,r){const n=r[r.length-1],s=n.hasZ,o=s?"3":"2";e.setAttribute("srsDimension",o);const a=n.srsName,l=a?Q(a).getAxisOrientation():"enu",c=t.getCoordinates();let u=l.startsWith("en")?c[0]+" "+c[1]:c[1]+" "+c[0];if(s){const h=c[2]||0;u+=" "+h}H(e,u)}getCoords_(e,t,r){let s=(t?Q(t).getAxisOrientation():"enu").startsWith("en")?e[0]+" "+e[1]:e[1]+" "+e[0];if(r){const o=e[2]||0;s+=" "+o}return s}writePosList_(e,t,r){const n=r[r.length-1],s=n.hasZ,o=s?"3":"2";e.setAttribute("srsDimension",o);const a=n.srsName,l=t.getCoordinates(),c=l.length,u=new Array(c);let h;for(let f=0;f<c;++f)h=l[f],u[f]=this.getCoords_(h,a,s);H(e,u.join(" "))}writePoint(e,t,r){const s=r[r.length-1].srsName;s&&e.setAttribute("srsName",s);const o=k(e.namespaceURI,"pos");e.appendChild(o),this.writePos_(o,t,r)}writeEnvelope(e,t,r){const s=r[r.length-1].srsName;s&&e.setAttribute("srsName",s);const o=["lowerCorner","upperCorner"],a=[t[0]+" "+t[1],t[2]+" "+t[3]];ie({node:e},this.ENVELOPE_SERIALIZERS,At,a,r,o,this)}writeLinearRing(e,t,r){const s=r[r.length-1].srsName;s&&e.setAttribute("srsName",s);const o=k(e.namespaceURI,"posList");e.appendChild(o),this.writePosList_(o,t,r)}RING_NODE_FACTORY_(e,t,r){const n=t[t.length-1],s=n.node,o=n.exteriorWritten;return o===void 0&&(n.exteriorWritten=!0),k(s.namespaceURI,o!==void 0?"interior":"exterior")}writeSurfaceOrPolygon(e,t,r){const n=r[r.length-1],s=n.hasZ,o=n.srsName;if(e.nodeName!=="PolygonPatch"&&o&&e.setAttribute("srsName",o),e.nodeName==="Polygon"||e.nodeName==="PolygonPatch"){const a=t.getLinearRings();ie({node:e,hasZ:s,srsName:o},this.RING_SERIALIZERS,this.RING_NODE_FACTORY_,a,r,void 0,this)}else if(e.nodeName==="Surface"){const a=k(e.namespaceURI,"patches");e.appendChild(a),this.writeSurfacePatches_(a,t,r)}}writeCurveOrLineString(e,t,r){const s=r[r.length-1].srsName;if(e.nodeName!=="LineStringSegment"&&s&&e.setAttribute("srsName",s),e.nodeName==="LineString"||e.nodeName==="LineStringSegment"){const o=k(e.namespaceURI,"posList");e.appendChild(o),this.writePosList_(o,t,r)}else if(e.nodeName==="Curve"){const o=k(e.namespaceURI,"segments");e.appendChild(o),this.writeCurveSegments_(o,t,r)}}writeMultiSurfaceOrPolygon(e,t,r){const n=r[r.length-1],s=n.hasZ,o=n.srsName,a=n.surface;o&&e.setAttribute("srsName",o);const l=t.getPolygons();ie({node:e,hasZ:s,srsName:o,surface:a},this.SURFACEORPOLYGONMEMBER_SERIALIZERS,this.MULTIGEOMETRY_MEMBER_NODE_FACTORY_,l,r,void 0,this)}writeMultiPoint(e,t,r){const n=r[r.length-1],s=n.srsName,o=n.hasZ;s&&e.setAttribute("srsName",s);const a=t.getPoints();ie({node:e,hasZ:o,srsName:s},this.POINTMEMBER_SERIALIZERS,ve("pointMember"),a,r,void 0,this)}writeMultiCurveOrLineString(e,t,r){const n=r[r.length-1],s=n.hasZ,o=n.srsName,a=n.curve;o&&e.setAttribute("srsName",o);const l=t.getLineStrings();ie({node:e,hasZ:s,srsName:o,curve:a},this.LINESTRINGORCURVEMEMBER_SERIALIZERS,this.MULTIGEOMETRY_MEMBER_NODE_FACTORY_,l,r,void 0,this)}writeRing(e,t,r){const n=k(e.namespaceURI,"LinearRing");e.appendChild(n),this.writeLinearRing(n,t,r)}writeSurfaceOrPolygonMember(e,t,r){const n=this.GEOMETRY_NODE_FACTORY_(t,r);n&&(e.appendChild(n),this.writeSurfaceOrPolygon(n,t,r))}writePointMember(e,t,r){const n=k(e.namespaceURI,"Point");e.appendChild(n),this.writePoint(n,t,r)}writeLineStringOrCurveMember(e,t,r){const n=this.GEOMETRY_NODE_FACTORY_(t,r);n&&(e.appendChild(n),this.writeCurveOrLineString(n,t,r))}writeSurfacePatches_(e,t,r){const n=k(e.namespaceURI,"PolygonPatch");e.appendChild(n),this.writeSurfaceOrPolygon(n,t,r)}writeCurveSegments_(e,t,r){const n=k(e.namespaceURI,"LineStringSegment");e.appendChild(n),this.writeCurveOrLineString(n,t,r)}writeGeometryElement(e,t,r){const n=r[r.length-1],s=Object.assign({},n);s.node=e;let o;Array.isArray(t)?o=ui(t,n):o=me(t,!0,n),ie(s,this.GEOMETRY_SERIALIZERS,this.GEOMETRY_NODE_FACTORY_,[o],r,void 0,this)}writeFeatureElement(e,t,r){const n=t.getId();n&&e.setAttribute("fid",n);const s=r[r.length-1],o=s.featureNS,a=t.getGeometryName();s.serializers||(s.serializers={},s.serializers[o]={});const l=[],c=[];if(t.hasProperties()){const h=t.getProperties();for(const f in h){const g=h[f];g!=null&&(l.push(f),c.push(g),f==a||typeof g.getSimplifiedGeometry=="function"?f in s.serializers[o]||(s.serializers[o][f]=E(this.writeGeometryElement,this)):f in s.serializers[o]||(s.serializers[o][f]=E(H)))}}const u=Object.assign({},s);u.node=e,ie(u,s.serializers,ve(void 0,o),c,r,l)}writeFeatureMembers_(e,t,r){const n=r[r.length-1],s=n.featureType,o=n.featureNS,a={};a[o]={},a[o][s]=E(this.writeFeatureElement,this);const l=Object.assign({},n);l.node=e,ie(l,a,ve(s,o),t,r)}MULTIGEOMETRY_MEMBER_NODE_FACTORY_(e,t,r){const n=t[t.length-1].node;return k(this.namespace,Fl[n.nodeName])}GEOMETRY_NODE_FACTORY_(e,t,r){const n=t[t.length-1],s=n.multiSurface,o=n.surface,a=n.curve,l=n.multiCurve;return Array.isArray(e)?r="Envelope":(r=e.getType(),r==="MultiPolygon"&&s===!0?r="MultiSurface":r==="Polygon"&&o===!0?r="Surface":r==="LineString"&&a===!0?r="Curve":r==="MultiLineString"&&l===!0&&(r="MultiCurve")),k(this.namespace,r)}writeGeometryNode(e,t){t=this.adaptOptions(t);const r=k(this.namespace,"geom"),n={node:r,hasZ:this.hasZ,srsName:this.srsName,curve:this.curve_,surface:this.surface_,multiSurface:this.multiSurface_,multiCurve:this.multiCurve_};return t&&Object.assign(n,t),this.writeGeometryElement(r,e,[n]),r}writeFeaturesNode(e,t){t=this.adaptOptions(t);const r=k(this.namespace,"featureMembers");r.setAttributeNS(Bt,"xsi:schemaLocation",this.schemaLocation);const n={srsName:this.srsName,hasZ:this.hasZ,curve:this.curve_,surface:this.surface_,multiSurface:this.multiSurface_,multiCurve:this.multiCurve_,featureNS:this.featureNS,featureType:this.featureType};return t&&Object.assign(n,t),this.writeFeatureMembers_(r,e,[n]),r}}L.prototype.GEOMETRY_FLAT_COORDINATES_PARSERS={"http://www.opengis.net/gml":{pos:G(L.prototype.readFlatPos),posList:G(L.prototype.readFlatPosList),coordinates:G(W.prototype.readFlatCoordinates)}};L.prototype.FLAT_LINEAR_RINGS_PARSERS={"http://www.opengis.net/gml":{interior:L.prototype.interiorParser,exterior:L.prototype.exteriorParser}};L.prototype.GEOMETRY_PARSERS={"http://www.opengis.net/gml":{Point:G(N.prototype.readPoint),MultiPoint:G(N.prototype.readMultiPoint),LineString:G(N.prototype.readLineString),MultiLineString:G(N.prototype.readMultiLineString),LinearRing:G(N.prototype.readLinearRing),Polygon:G(N.prototype.readPolygon),MultiPolygon:G(N.prototype.readMultiPolygon),Surface:G(L.prototype.readSurface),MultiSurface:G(L.prototype.readMultiSurface),Curve:G(L.prototype.readCurve),MultiCurve:G(L.prototype.readMultiCurve),Envelope:G(L.prototype.readEnvelope)}};L.prototype.MULTICURVE_PARSERS={"http://www.opengis.net/gml":{curveMember:O(L.prototype.curveMemberParser),curveMembers:O(L.prototype.curveMemberParser)}};L.prototype.MULTISURFACE_PARSERS={"http://www.opengis.net/gml":{surfaceMember:O(L.prototype.surfaceMemberParser),surfaceMembers:O(L.prototype.surfaceMemberParser)}};L.prototype.CURVEMEMBER_PARSERS={"http://www.opengis.net/gml":{LineString:O(N.prototype.readLineString),Curve:O(L.prototype.readCurve)}};L.prototype.SURFACEMEMBER_PARSERS={"http://www.opengis.net/gml":{Polygon:O(N.prototype.readPolygon),Surface:O(L.prototype.readSurface)}};L.prototype.SURFACE_PARSERS={"http://www.opengis.net/gml":{patches:G(L.prototype.readPatch)}};L.prototype.CURVE_PARSERS={"http://www.opengis.net/gml":{segments:G(L.prototype.readSegment)}};L.prototype.ENVELOPE_PARSERS={"http://www.opengis.net/gml":{lowerCorner:O(L.prototype.readFlatPosList),upperCorner:O(L.prototype.readFlatPosList)}};L.prototype.PATCHES_PARSERS={"http://www.opengis.net/gml":{PolygonPatch:G(L.prototype.readPolygonPatch)}};L.prototype.SEGMENTS_PARSERS={"http://www.opengis.net/gml":{LineStringSegment:ns(L.prototype.readLineStringSegment)}};N.prototype.RING_PARSERS={"http://www.opengis.net/gml":{LinearRing:G(N.prototype.readFlatLinearRing),Ring:G(L.prototype.readFlatCurveRing)}};L.prototype.writeFeatures;L.prototype.RING_SERIALIZERS={"http://www.opengis.net/gml":{exterior:E(L.prototype.writeRing),interior:E(L.prototype.writeRing)}};L.prototype.ENVELOPE_SERIALIZERS={"http://www.opengis.net/gml":{lowerCorner:E(H),upperCorner:E(H)}};L.prototype.SURFACEORPOLYGONMEMBER_SERIALIZERS={"http://www.opengis.net/gml":{surfaceMember:E(L.prototype.writeSurfaceOrPolygonMember),polygonMember:E(L.prototype.writeSurfaceOrPolygonMember)}};L.prototype.POINTMEMBER_SERIALIZERS={"http://www.opengis.net/gml":{pointMember:E(L.prototype.writePointMember)}};L.prototype.LINESTRINGORCURVEMEMBER_SERIALIZERS={"http://www.opengis.net/gml":{lineStringMember:E(L.prototype.writeLineStringOrCurveMember),curveMember:E(L.prototype.writeLineStringOrCurveMember)}};L.prototype.GEOMETRY_SERIALIZERS={"http://www.opengis.net/gml":{Curve:E(L.prototype.writeCurveOrLineString),MultiCurve:E(L.prototype.writeMultiCurveOrLineString),Point:E(L.prototype.writePoint),MultiPoint:E(L.prototype.writeMultiPoint),LineString:E(L.prototype.writeCurveOrLineString),MultiLineString:E(L.prototype.writeMultiCurveOrLineString),LinearRing:E(L.prototype.writeLinearRing),Polygon:E(L.prototype.writeSurfaceOrPolygon),MultiPolygon:E(L.prototype.writeMultiSurfaceOrPolygon),Surface:E(L.prototype.writeSurfaceOrPolygon),MultiSurface:E(L.prototype.writeMultiSurfaceOrPolygon),Envelope:E(L.prototype.writeEnvelope)}};const Li=L;Li.prototype.writeFeatures;Li.prototype.writeFeaturesNode;const ae=[null,"http://www.topografix.com/GPX/1/0","http://www.topografix.com/GPX/1/1"],Nl="http://www.topografix.com/GPX/1/1 http://www.topografix.com/GPX/1/1/gpx.xsd",Ml={rte:Es,trk:ys,wpt:Ts},Ol=I(ae,{rte:O(Es),trk:O(ys),wpt:O(Ts)}),Dl=I(ae,{text:p(b,"linkText"),type:p(b,"linkType")}),Gl=I(ae,{name:p(b),email:uc,link:Jt}),Ul=I(ae,{name:p(b),desc:p(b),author:p(ac),copyright:p(lc),link:Jt,time:p(br),keywords:p(b),bounds:cc,extensions:Ir}),Bl=I(ae,{year:p(fe),license:p(b)}),zl=I(ae,{rte:E(gc),trk:E(pc),wpt:E(_c)});class $l extends vr{constructor(e){super(),e=e||{},this.dataProjection=Q("EPSG:4326"),this.readExtensions_=e.readExtensions}handleReadExtensions_(e){e||(e=[]);for(let t=0,r=e.length;t<r;++t){const n=e[t];if(this.readExtensions_){const s=n.get("extensionsNode_")||null;this.readExtensions_(n,s)}n.set("extensionsNode_",void 0)}}readMetadata(e){return e?typeof e=="string"?this.readMetadataFromDocument(fr(e)):gr(e)?this.readMetadataFromDocument(e):this.readMetadataFromNode(e):null}readMetadataFromDocument(e){for(let t=e.firstChild;t;t=t.nextSibling)if(t.nodeType===Node.ELEMENT_NODE){const r=this.readMetadataFromNode(t);if(r)return r}return null}readMetadataFromNode(e){if(!ae.includes(e.namespaceURI))return null;for(let t=e.firstElementChild;t;t=t.nextElementSibling)if(ae.includes(t.namespaceURI)&&t.localName==="metadata")return A({},Ul,t,[]);return null}readFeatureFromNode(e,t){if(!ae.includes(e.namespaceURI))return null;const r=Ml[e.localName];if(!r)return null;const n=r(e,[this.getReadOptions(e,t)]);return n?(this.handleReadExtensions_([n]),n):null}readFeaturesFromNode(e,t){if(!ae.includes(e.namespaceURI))return[];if(e.localName=="gpx"){const r=A([],Ol,e,[this.getReadOptions(e,t)]);return r?(this.handleReadExtensions_(r),r):[]}return[]}writeFeaturesNode(e,t){t=this.adaptOptions(t);const r=k("http://www.topografix.com/GPX/1/1","gpx");return r.setAttributeNS("http://www.w3.org/2000/xmlns/","xmlns:xsi",Bt),r.setAttributeNS(Bt,"xsi:schemaLocation",Nl),r.setAttribute("version","1.1"),r.setAttribute("creator","OpenLayers"),ie({node:r},zl,oc,e,[t]),r}}const Xl=I(ae,{name:p(b),cmt:p(b),desc:p(b),src:p(b),link:Jt,number:p(fe),extensions:Ir,type:p(b),rtept:hc}),kl=I(ae,{ele:p(ye),time:p(br)}),jl=I(ae,{name:p(b),cmt:p(b),desc:p(b),src:p(b),link:Jt,number:p(fe),type:p(b),extensions:Ir,trkseg:fc}),Wl=I(ae,{trkpt:dc}),Zl=I(ae,{ele:p(ye),time:p(br)}),Hl=I(ae,{ele:p(ye),time:p(br),magvar:p(ye),geoidheight:p(ye),name:p(b),cmt:p(b),desc:p(b),src:p(b),link:Jt,sym:p(b),type:p(b),fix:p(b),sat:p(fe),hdop:p(ye),vdop:p(ye),pdop:p(ye),ageofdgpsdata:p(ye),dgpsid:p(fe),extensions:Ir}),Vl=["text","type"],Yl=I(ae,{text:E(H),type:E(H)}),ql=I(ae,["name","cmt","desc","src","link","number","type","rtept"]),Kl=I(ae,{name:E(H),cmt:E(H),desc:E(H),src:E(H),link:E(Ai),number:E(pr),type:E(H),rtept:ss(E(Ci))}),Jl=I(ae,["ele","time"]),Ql=I(ae,["name","cmt","desc","src","link","number","type","trkseg"]),ec=I(ae,{name:E(H),cmt:E(H),desc:E(H),src:E(H),link:E(Ai),number:E(pr),type:E(H),trkseg:ss(E(mc))}),tc=ve("trkpt"),rc=I(ae,{trkpt:E(Ci)}),ic=I(ae,["ele","time","magvar","geoidheight","name","cmt","desc","src","link","sym","type","fix","sat","hdop","vdop","pdop","ageofdgpsdata","dgpsid"]),nc=I(ae,{ele:E(ot),time:E(Mo),magvar:E(ot),geoidheight:E(ot),name:E(H),cmt:E(H),desc:E(H),src:E(H),link:E(Ai),sym:E(H),type:E(H),fix:E(H),sat:E(pr),hdop:E(ot),vdop:E(ot),pdop:E(ot),ageofdgpsdata:E(ot),dgpsid:E(pr)}),sc={Point:"wpt",LineString:"rte",MultiLineString:"trk"};function oc(i,e,t){const r=i.getGeometry();if(r){const n=sc[r.getType()];if(n){const s=e[e.length-1].node;return k(s.namespaceURI,n)}}}function vi(i,e,t,r){return i.push(parseFloat(t.getAttribute("lon")),parseFloat(t.getAttribute("lat"))),"ele"in r?(i.push(r.ele),delete r.ele,e.hasZ=!0):i.push(0),"time"in r?(i.push(r.time),delete r.time,e.hasM=!0):i.push(0),i}function bi(i,e,t){let r="XY",n=2;if(i.hasZ&&i.hasM?(r="XYZM",n=4):i.hasZ?(r="XYZ",n=3):i.hasM&&(r="XYM",n=3),n!==4){for(let s=0,o=e.length/4;s<o;s++)e[s*n]=e[s*4],e[s*n+1]=e[s*4+1],i.hasZ&&(e[s*n+2]=e[s*4+2]),i.hasM&&(e[s*n+2]=e[s*4+3]);if(e.length=e.length/4*n,t)for(let s=0,o=t.length;s<o;s++)t[s]=t[s]/4*n}return r}function ac(i,e){const t=A({},Gl,i,e);if(t)return t}function lc(i,e){const t=A({},Bl,i,e);if(t){const r=i.getAttribute("author");return r!==null&&(t.author=r),t}}function cc(i,e){const t=e[e.length-1],r=i.getAttribute("minlat"),n=i.getAttribute("minlon"),s=i.getAttribute("maxlat"),o=i.getAttribute("maxlon");n!==null&&r!==null&&o!==null&&s!==null&&(t.bounds=[[parseFloat(n),parseFloat(r)],[parseFloat(o),parseFloat(s)]])}function uc(i,e){const t=e[e.length-1],r=i.getAttribute("id"),n=i.getAttribute("domain");r!==null&&n!==null&&(t.email=`${r}@${n}`)}function Jt(i,e){const t=e[e.length-1],r=i.getAttribute("href");r!==null&&(t.link=r),Qe(Dl,i,e)}function Ir(i,e){const t=e[e.length-1];t.extensionsNode_=i}function hc(i,e){const t=A({},kl,i,e);if(t){const r=e[e.length-1],n=r.flatCoordinates,s=r.layoutOptions;vi(n,s,i,t)}}function dc(i,e){const t=A({},Zl,i,e);if(t){const r=e[e.length-1],n=r.flatCoordinates,s=r.layoutOptions;vi(n,s,i,t)}}function fc(i,e){const t=e[e.length-1];Qe(Wl,i,e);const r=t.flatCoordinates;t.ends.push(r.length)}function Es(i,e){const t=e[0],r=A({flatCoordinates:[],layoutOptions:{}},Xl,i,e);if(!r)return;const n=r.flatCoordinates;delete r.flatCoordinates;const s=r.layoutOptions;delete r.layoutOptions;const o=bi(s,n),a=new Be(n,o);me(a,!1,t);const l=new Re(a);return l.setProperties(r,!0),l}function ys(i,e){const t=e[0],r=A({flatCoordinates:[],ends:[],layoutOptions:{}},jl,i,e);if(!r)return;const n=r.flatCoordinates;delete r.flatCoordinates;const s=r.ends;delete r.ends;const o=r.layoutOptions;delete r.layoutOptions;const a=bi(o,n,s),l=new bt(n,a,s);me(l,!1,t);const c=new Re(l);return c.setProperties(r,!0),c}function Ts(i,e){const t=e[0],r=A({},Hl,i,e);if(!r)return;const n={},s=vi([],n,i,r),o=bi(n,s),a=new Ie(s,o);me(a,!1,t);const l=new Re(a);return l.setProperties(r,!0),l}function Ai(i,e,t){i.setAttribute("href",e);const n=t[t.length-1].properties,s=[n.linkText,n.linkType];ie({node:i},Yl,At,s,t,Vl)}function Ci(i,e,t){const r=t[t.length-1],s=r.node.namespaceURI,o=r.properties;switch(i.setAttributeNS(null,"lat",String(e[1])),i.setAttributeNS(null,"lon",String(e[0])),r.geometryLayout){case"XYZM":e[3]!==0&&(o.time=e[3]);case"XYZ":e[2]!==0&&(o.ele=e[2]);break;case"XYM":e[2]!==0&&(o.time=e[2]);break}const l=i.nodeName=="rtept"?Jl[s]:ic[s],c=hi(o,l);ie({node:i,properties:o},nc,At,c,t,l)}function gc(i,e,t){const r=t[0],n=e.getProperties(),s={node:i};s.properties=n;const o=e.getGeometry();if(o.getType()=="LineString"){const u=me(o,!0,r);s.geometryLayout=u.getLayout(),n.rtept=u.getCoordinates()}const a=t[t.length-1].node,l=ql[a.namespaceURI],c=hi(n,l);ie(s,Kl,At,c,t,l)}function pc(i,e,t){const r=t[0],n=e.getProperties(),s={node:i};s.properties=n;const o=e.getGeometry();if(o.getType()=="MultiLineString"){const u=me(o,!0,r);n.trkseg=u.getLineStrings()}const a=t[t.length-1].node,l=Ql[a.namespaceURI],c=hi(n,l);ie(s,ec,At,c,t,l)}function mc(i,e,t){const r={node:i};r.geometryLayout=e.getLayout(),r.properties={},ie(r,rc,tc,e.getCoordinates(),t)}function _c(i,e,t){const r=t[0],n=t[t.length-1];n.properties=e.getProperties();const s=e.getGeometry();if(s.getType()=="Point"){const o=me(s,!0,r);n.geometryLayout=o.getLayout(),Ci(i,o.getCoordinates(),t)}}class Ii extends os{constructor(){super()}getType(){return"text"}readFeature(e,t){return this.readFeatureFromText(rr(e),this.adaptOptions(t))}readFeatureFromText(e,t){return ke()}readFeatures(e,t){return this.readFeaturesFromText(rr(e),this.adaptOptions(t))}readFeaturesFromText(e,t){return ke()}readGeometry(e,t){return this.readGeometryFromText(rr(e),this.adaptOptions(t))}readGeometryFromText(e,t){return ke()}readProjection(e){return this.readProjectionFromText(rr(e))}readProjectionFromText(e){return this.dataProjection}writeFeature(e,t){return this.writeFeatureText(e,this.adaptOptions(t))}writeFeatureText(e,t){return ke()}writeFeatures(e,t){return this.writeFeaturesText(e,this.adaptOptions(t))}writeFeaturesText(e,t){return ke()}writeGeometry(e,t){return this.writeGeometryText(e,this.adaptOptions(t))}writeGeometryText(e,t){return ke()}}function rr(i){return typeof i=="string"?i:""}const Ec=/^B(\d{2})(\d{2})(\d{2})(\d{2})(\d{5})([NS])(\d{3})(\d{5})([EW])([AV])(\d{5})(\d{5})/,yc=/^H.([A-Z]{3}).*?:(.*)/,Tc=/^HFDTE(\d{2})(\d{2})(\d{2})/,xc=/^HFDTEDATE:(\d{2})(\d{2})(\d{2}),(\d{2})/,Rc=/\r\n|\r|\n/;class Sc extends Ii{constructor(e){super(),e=e||{},this.dataProjection=Q("EPSG:4326"),this.altitudeMode_=e.altitudeMode?e.altitudeMode:"none",this.lad_=!1,this.lod_=!1,this.ladStart_=0,this.ladStop_=0,this.lodStart_=0,this.lodStop_=0}readFeatureFromText(e,t){const r=this.altitudeMode_,n=e.split(Rc),s={},o=[];let a=2e3,l=0,c=1,u=-1,h,f;for(h=0,f=n.length;h<f;++h){const _=n[h];let y;if(_.charAt(0)=="B"){if(y=Ec.exec(_),y){const T=parseInt(y[1],10),x=parseInt(y[2],10),S=parseInt(y[3],10);let P=parseInt(y[4],10)+parseInt(y[5],10)/6e4;this.lad_&&(P+=parseInt(_.slice(this.ladStart_,this.ladStop_),10)/6e4/10**(this.ladStop_-this.ladStart_)),y[6]=="S"&&(P=-P);let R=parseInt(y[7],10)+parseInt(y[8],10)/6e4;if(this.lod_&&(R+=parseInt(_.slice(this.lodStart_,this.lodStop_),10)/6e4/10**(this.lodStop_-this.lodStart_)),y[9]=="W"&&(R=-R),o.push(R,P),r!="none"){let F;r=="gps"?F=parseInt(y[11],10):r=="barometric"?F=parseInt(y[12],10):F=0,o.push(F)}let v=Date.UTC(a,l,c,T,x,S);v<u&&(v=Date.UTC(a,l,c+1,T,x,S)),o.push(v/1e3),u=v}}else if(_.charAt(0)=="H")y=xc.exec(_),y?(c=parseInt(y[1],10),l=parseInt(y[2],10)-1,a=2e3+parseInt(y[3],10)):(y=Tc.exec(_),y?(c=parseInt(y[1],10),l=parseInt(y[2],10)-1,a=2e3+parseInt(y[3],10)):(y=yc.exec(_),y&&(s[y[1]]=y[2].trim())));else if(_.charAt(0)=="I"){const T=parseInt(_.slice(1,3),10);for(let x=0;x<T;x++){const S=_.slice(7+x*7,10+x*7);if(S==="LAD"||S==="LOD"){const P=parseInt(_.slice(3+x*7,5+x*7),10)-1,R=parseInt(_.slice(5+x*7,7+x*7),10);S==="LAD"?(this.lad_=!0,this.ladStart_=P,this.ladStop_=R):S==="LOD"&&(this.lod_=!0,this.lodStart_=P,this.lodStop_=R)}}}}if(o.length===0)return null;const g=r=="none"?"XYM":"XYZM",d=new Be(o,g),m=new Re(me(d,!1,t));return m.setProperties(s,!0),m}readFeaturesFromText(e,t){const r=this.readFeatureFromText(e,t);return r?[r]:[]}}const ge={VERSION1:"version1",VERSION2:"version2",VERSION3:"version3"},dt={};dt[ge.VERSION1]={level0:{supports:[],formats:[],qualities:["native"]},level1:{supports:["regionByPx","sizeByW","sizeByH","sizeByPct"],formats:["jpg"],qualities:["native"]},level2:{supports:["regionByPx","regionByPct","sizeByW","sizeByH","sizeByPct","sizeByConfinedWh","sizeByWh"],formats:["jpg","png"],qualities:["native","color","grey","bitonal"]}};dt[ge.VERSION2]={level0:{supports:[],formats:["jpg"],qualities:["default"]},level1:{supports:["regionByPx","sizeByW","sizeByH","sizeByPct"],formats:["jpg"],qualities:["default"]},level2:{supports:["regionByPx","regionByPct","sizeByW","sizeByH","sizeByPct","sizeByConfinedWh","sizeByDistortedWh","sizeByWh"],formats:["jpg","png"],qualities:["default","bitonal"]}};dt[ge.VERSION3]={level0:{supports:[],formats:["jpg"],qualities:["default"]},level1:{supports:["regionByPx","regionSquare","sizeByW","sizeByH","sizeByWh"],formats:["jpg"],qualities:["default"]},level2:{supports:["regionByPx","regionSquare","regionByPct","sizeByW","sizeByH","sizeByPct","sizeByConfinedWh","sizeByWh"],formats:["jpg","png"],qualities:["default"]}};dt.none={none:{supports:[],formats:[],qualities:[]}};const Pc=/^https?:\/\/library\.stanford\.edu\/iiif\/image-api\/(?:1\.1\/)?compliance\.html#level[0-2]$/,hn=/^https?:\/\/iiif\.io\/api\/image\/2\/level[0-2](?:\.json)?$/,wc=/(^https?:\/\/iiif\.io\/api\/image\/3\/level[0-2](?:\.json)?$)|(^level[0-2]$)/;function Lc(i){let e=i.getComplianceLevelSupportedFeatures();return e===void 0&&(e=dt[ge.VERSION1].level0),{url:i.imageInfo["@id"]===void 0?void 0:i.imageInfo["@id"].replace(/\/?(?:info\.json)?$/g,""),supports:e.supports,formats:[...e.formats,i.imageInfo.formats===void 0?[]:i.imageInfo.formats],qualities:[...e.qualities,i.imageInfo.qualities===void 0?[]:i.imageInfo.qualities],resolutions:i.imageInfo.scale_factors,tileSize:i.imageInfo.tile_width!==void 0?i.imageInfo.tile_height!==void 0?[i.imageInfo.tile_width,i.imageInfo.tile_height]:[i.imageInfo.tile_width,i.imageInfo.tile_width]:i.imageInfo.tile_height!=null?[i.imageInfo.tile_height,i.imageInfo.tile_height]:void 0}}function vc(i){const e=i.getComplianceLevelSupportedFeatures(),t=Array.isArray(i.imageInfo.profile)&&i.imageInfo.profile.length>1,r=t&&i.imageInfo.profile[1].supports?i.imageInfo.profile[1].supports:[],n=t&&i.imageInfo.profile[1].formats?i.imageInfo.profile[1].formats:[],s=t&&i.imageInfo.profile[1].qualities?i.imageInfo.profile[1].qualities:[];return{url:i.imageInfo["@id"].replace(/\/?(?:info\.json)?$/g,""),sizes:i.imageInfo.sizes===void 0?void 0:i.imageInfo.sizes.map(function(o){return[o.width,o.height]}),tileSize:i.imageInfo.tiles===void 0?void 0:[i.imageInfo.tiles.map(function(o){return o.width})[0],i.imageInfo.tiles.map(function(o){return o.height===void 0?o.width:o.height})[0]],resolutions:i.imageInfo.tiles===void 0?void 0:i.imageInfo.tiles.map(function(o){return o.scaleFactors})[0],supports:[...e.supports,...r],formats:[...e.formats,...n],qualities:[...e.qualities,...s]}}function bc(i){const e=i.getComplianceLevelSupportedFeatures(),t=i.imageInfo.extraFormats===void 0?e.formats:[...e.formats,...i.imageInfo.extraFormats],r=i.imageInfo.preferredFormats!==void 0&&Array.isArray(i.imageInfo.preferredFormats)&&i.imageInfo.preferredFormats.length>0?i.imageInfo.preferredFormats.filter(function(n){return["jpg","png","gif"].includes(n)}).reduce(function(n,s){return n===void 0&&t.includes(s)?s:n},void 0):void 0;return{url:i.imageInfo.id,sizes:i.imageInfo.sizes===void 0?void 0:i.imageInfo.sizes.map(function(n){return[n.width,n.height]}),tileSize:i.imageInfo.tiles===void 0?void 0:[i.imageInfo.tiles.map(function(n){return n.width})[0],i.imageInfo.tiles.map(function(n){return n.height})[0]],resolutions:i.imageInfo.tiles===void 0?void 0:i.imageInfo.tiles.map(function(n){return n.scaleFactors})[0],supports:i.imageInfo.extraFeatures===void 0?e.supports:[...e.supports,...i.imageInfo.extraFeatures],formats:t,qualities:i.imageInfo.extraQualities===void 0?e.qualities:[...e.qualities,...i.imageInfo.extraQualities],preferredFormat:r}}const Fr={};Fr[ge.VERSION1]=Lc;Fr[ge.VERSION2]=vc;Fr[ge.VERSION3]=bc;class Ac{constructor(e){this.setImageInfo(e)}setImageInfo(e){typeof e=="string"?this.imageInfo=JSON.parse(e):this.imageInfo=e}getImageApiVersion(){if(this.imageInfo===void 0)return;let e=this.imageInfo["@context"]||"ol-no-context";typeof e=="string"&&(e=[e]);for(let t=0;t<e.length;t++)switch(e[t]){case"http://library.stanford.edu/iiif/image-api/1.1/context.json":case"http://iiif.io/api/image/1/context.json":return ge.VERSION1;case"http://iiif.io/api/image/2/context.json":return ge.VERSION2;case"http://iiif.io/api/image/3/context.json":return ge.VERSION3;case"ol-no-context":if(this.getComplianceLevelEntryFromProfile(ge.VERSION1)&&this.imageInfo.identifier)return ge.VERSION1;break}be(!1,"Cannot determine IIIF Image API version from provided image information JSON")}getComplianceLevelEntryFromProfile(e){if(!(this.imageInfo===void 0||this.imageInfo.profile===void 0))switch(e===void 0&&(e=this.getImageApiVersion()),e){case ge.VERSION1:if(Pc.test(this.imageInfo.profile))return this.imageInfo.profile;break;case ge.VERSION3:if(wc.test(this.imageInfo.profile))return this.imageInfo.profile;break;case ge.VERSION2:if(typeof this.imageInfo.profile=="string"&&hn.test(this.imageInfo.profile))return this.imageInfo.profile;if(Array.isArray(this.imageInfo.profile)&&this.imageInfo.profile.length>0&&typeof this.imageInfo.profile[0]=="string"&&hn.test(this.imageInfo.profile[0]))return this.imageInfo.profile[0];break}}getComplianceLevelFromProfile(e){const t=this.getComplianceLevelEntryFromProfile(e);if(t===void 0)return;const r=t.match(/level[0-2](?:\.json)?$/g);return Array.isArray(r)?r[0].replace(".json",""):void 0}getComplianceLevelSupportedFeatures(){if(this.imageInfo===void 0)return;const e=this.getImageApiVersion(),t=this.getComplianceLevelFromProfile(e);return t===void 0?dt.none.none:dt[e][t]}getTileSourceOptions(e){const t=e||{},r=this.getImageApiVersion();if(r===void 0)return;const n=r===void 0?void 0:Fr[r](this);if(n!==void 0)return{url:n.url,version:r,size:[this.imageInfo.width,this.imageInfo.height],sizes:n.sizes,format:t.format!==void 0&&n.formats.includes(t.format)?t.format:n.preferredFormat!==void 0?n.preferredFormat:"jpg",supports:n.supports,quality:t.quality&&n.qualities.includes(t.quality)?t.quality:n.qualities.includes("native")?"native":"default",resolutions:Array.isArray(n.resolutions)?n.resolutions.sort(function(s,o){return o-s}):void 0,tileSize:n.tileSize}}}class Fi{read(e){if(!e)return null;if(typeof e=="string"){const t=fr(e);return this.readFromDocument(t)}return gr(e)?this.readFromDocument(e):this.readFromNode(e)}readFromDocument(e){for(let t=e.firstChild;t;t=t.nextSibling)if(t.nodeType==Node.ELEMENT_NODE)return this.readFromNode(t);return null}readFromNode(e){ke()}}const Cc="http://www.w3.org/1999/xlink";function Ft(i){return i.getAttributeNS(Cc,"href")}const Pe=[null,"http://www.opengis.net/ows/1.1"],Ic=I(Pe,{ServiceIdentification:p(tu),ServiceProvider:p(iu),OperationsMetadata:p(Qc)});class xs extends Fi{constructor(){super()}readFromNode(e){const t=A({},Ic,e,[]);return t||null}}const Fc=I(Pe,{DeliveryPoint:p(b),City:p(b),AdministrativeArea:p(b),PostalCode:p(b),Country:p(b),ElectronicMailAddress:p(b)}),Nc=I(Pe,{Value:te(nu)}),Mc=I(Pe,{AllowedValues:p(Zc)}),Oc=I(Pe,{Phone:p(eu),Address:p(Wc)}),Dc=I(Pe,{HTTP:p(Kc)}),Gc=I(Pe,{Get:te(qc),Post:void 0}),Uc=I(Pe,{DCP:p(Yc)}),Bc=I(Pe,{Operation:Jc}),zc=I(Pe,{Voice:p(b),Facsimile:p(b)}),$c=I(Pe,{Constraint:te(Hc)}),Xc=I(Pe,{IndividualName:p(b),PositionName:p(b),ContactInfo:p(Vc)}),kc=I(Pe,{Abstract:p(b),AccessConstraints:p(b),Fees:p(b),Title:p(b),ServiceTypeVersion:p(b),ServiceType:p(b)}),jc=I(Pe,{ProviderName:p(b),ProviderSite:p(Ft),ServiceContact:p(ru)});function Wc(i,e){return A({},Fc,i,e)}function Zc(i,e){return A({},Nc,i,e)}function Hc(i,e){const t=i.getAttribute("name");if(t)return A({name:t},Mc,i,e)}function Vc(i,e){return A({},Oc,i,e)}function Yc(i,e){return A({},Dc,i,e)}function qc(i,e){const t=Ft(i);if(t)return A({href:t},$c,i,e)}function Kc(i,e){return A({},Gc,i,e)}function Jc(i,e){const t=i.getAttribute("name"),r=A({},Uc,i,e);if(!r)return;const n=e[e.length-1];n[t]=r}function Qc(i,e){return A({},Bc,i,e)}function eu(i,e){return A({},zc,i,e)}function tu(i,e){return A({},kc,i,e)}function ru(i,e){return A({},Xc,i,e)}function iu(i,e){return A({},jc,i,e)}function nu(i,e){return b(i)}function dn(i,e,t,r,n,s){n!==void 0?(n=n,s=s!==void 0?s:0):(n=[],s=0);let o=e;for(;o<t;){const a=i[o++];n[s++]=i[o++],n[s++]=a;for(let l=2;l<r;++l)n[s++]=i[o++]}return n.length=s,n}class su extends Ii{constructor(e){super(),e=e||{},this.dataProjection=Q("EPSG:4326"),this.factor_=e.factor?e.factor:1e5,this.geometryLayout_=e.geometryLayout?e.geometryLayout:"XY"}readFeatureFromText(e,t){const r=this.readGeometryFromText(e,t);return new Re(r)}readFeaturesFromText(e,t){return[this.readFeatureFromText(e,t)]}readGeometryFromText(e,t){const r=Oo(this.geometryLayout_),n=au(e,r,this.factor_);dn(n,0,n.length,r,n);const s=new Be(n,this.geometryLayout_);return me(s,!1,this.adaptOptions(t))}writeFeatureText(e,t){const r=e.getGeometry();if(r)return this.writeGeometryText(r,t);throw new Error("Expected `feature` to have a geometry")}writeFeaturesText(e,t){return this.writeFeatureText(e[0],t)}writeGeometryText(e,t){e=me(e,!0,this.adaptOptions(t));const r=e.getFlatCoordinates(),n=e.getStride();return dn(r,0,r.length,n,r),ou(r,n,this.factor_)}}function ou(i,e,t){t=t||1e5;const r=new Array(e).fill(0);for(let n=0,s=i.length;n<s;)for(let o=0;o<e;++o,++n){const a=i[n]*t,l=a<0?Math.ceil(a-.5):Math.round(a),c=l-r[o];r[o]=l,i[n]=c}return lu(i)}function au(i,e,t){t=t||1e5;const r=new Array(e).fill(0),n=cu(i);for(let s=0,o=n.length;s<o;)for(let a=0;a<e;++a,++s)r[a]+=n[s],n[s]=r[a]/t;return n}function lu(i){for(let e=0,t=i.length;e<t;++e){const r=i[e];i[e]=r<0?~(r<<1):r<<1}return uu(i)}function cu(i){const e=hu(i);for(let t=0,r=e.length;t<r;++t){const n=e[t];e[t]=n&1?~(n>>1):n>>1}return e}function uu(i){let e="";for(let t=0,r=i.length;t<r;++t)e+=du(i[t]);return e}function hu(i){const e=[];let t=0,r=0;for(let n=0,s=i.length;n<s;++n){const o=i.charCodeAt(n)-63;t|=(o&31)<<r,o<32?(e.push(t),t=0,r=0):r+=5}return e}function du(i){let e,t="";for(;i>=32;)e=(32|i&31)+63,t+=String.fromCharCode(e),i>>=5;return e=i+63,t+=String.fromCharCode(e),t}class q extends L{constructor(e){e=e||{},super(e),this.schemaLocation=e.schemaLocation?e.schemaLocation:this.namespace+" http://schemas.opengis.net/gml/3.2.1/gml.xsd"}writeGeometryElement(e,t,r){const n=r[r.length-1];r[r.length-1]=Object.assign({multiCurve:!0,multiSurface:!0},n),super.writeGeometryElement(e,t,r)}}q.prototype.namespace="http://www.opengis.net/gml/3.2";q.prototype.GEOMETRY_FLAT_COORDINATES_PARSERS={"http://www.opengis.net/gml/3.2":{pos:G(L.prototype.readFlatPos),posList:G(L.prototype.readFlatPosList),coordinates:G(W.prototype.readFlatCoordinates)}};q.prototype.FLAT_LINEAR_RINGS_PARSERS={"http://www.opengis.net/gml/3.2":{interior:L.prototype.interiorParser,exterior:L.prototype.exteriorParser}};q.prototype.GEOMETRY_PARSERS={"http://www.opengis.net/gml/3.2":{Point:G(N.prototype.readPoint),MultiPoint:G(N.prototype.readMultiPoint),LineString:G(N.prototype.readLineString),MultiLineString:G(N.prototype.readMultiLineString),LinearRing:G(N.prototype.readLinearRing),Polygon:G(N.prototype.readPolygon),MultiPolygon:G(N.prototype.readMultiPolygon),Surface:G(q.prototype.readSurface),MultiSurface:G(L.prototype.readMultiSurface),Curve:G(q.prototype.readCurve),MultiCurve:G(L.prototype.readMultiCurve),Envelope:G(q.prototype.readEnvelope)}};q.prototype.MULTICURVE_PARSERS={"http://www.opengis.net/gml/3.2":{curveMember:O(L.prototype.curveMemberParser),curveMembers:O(L.prototype.curveMemberParser)}};q.prototype.MULTISURFACE_PARSERS={"http://www.opengis.net/gml/3.2":{surfaceMember:O(L.prototype.surfaceMemberParser),surfaceMembers:O(L.prototype.surfaceMemberParser)}};q.prototype.CURVEMEMBER_PARSERS={"http://www.opengis.net/gml/3.2":{LineString:O(N.prototype.readLineString),Curve:O(L.prototype.readCurve)}};q.prototype.SURFACEMEMBER_PARSERS={"http://www.opengis.net/gml/3.2":{Polygon:O(N.prototype.readPolygon),Surface:O(L.prototype.readSurface)}};q.prototype.SURFACE_PARSERS={"http://www.opengis.net/gml/3.2":{patches:G(L.prototype.readPatch)}};q.prototype.CURVE_PARSERS={"http://www.opengis.net/gml/3.2":{segments:G(L.prototype.readSegment)}};q.prototype.ENVELOPE_PARSERS={"http://www.opengis.net/gml/3.2":{lowerCorner:O(L.prototype.readFlatPosList),upperCorner:O(L.prototype.readFlatPosList)}};q.prototype.PATCHES_PARSERS={"http://www.opengis.net/gml/3.2":{PolygonPatch:G(L.prototype.readPolygonPatch)}};q.prototype.SEGMENTS_PARSERS={"http://www.opengis.net/gml/3.2":{LineStringSegment:ns(L.prototype.readLineStringSegment)}};q.prototype.MULTIPOINT_PARSERS={"http://www.opengis.net/gml/3.2":{pointMember:O(N.prototype.pointMemberParser),pointMembers:O(N.prototype.pointMemberParser)}};q.prototype.MULTILINESTRING_PARSERS={"http://www.opengis.net/gml/3.2":{lineStringMember:O(N.prototype.lineStringMemberParser),lineStringMembers:O(N.prototype.lineStringMemberParser)}};q.prototype.MULTIPOLYGON_PARSERS={"http://www.opengis.net/gml/3.2":{polygonMember:O(N.prototype.polygonMemberParser),polygonMembers:O(N.prototype.polygonMemberParser)}};q.prototype.POINTMEMBER_PARSERS={"http://www.opengis.net/gml/3.2":{Point:O(N.prototype.readFlatCoordinatesFromNode)}};q.prototype.LINESTRINGMEMBER_PARSERS={"http://www.opengis.net/gml/3.2":{LineString:O(N.prototype.readLineString)}};q.prototype.POLYGONMEMBER_PARSERS={"http://www.opengis.net/gml/3.2":{Polygon:O(N.prototype.readPolygon)}};q.prototype.RING_PARSERS={"http://www.opengis.net/gml/3.2":{LinearRing:G(N.prototype.readFlatLinearRing),Ring:G(q.prototype.readFlatCurveRing)}};q.prototype.RING_SERIALIZERS={"http://www.opengis.net/gml/3.2":{exterior:E(L.prototype.writeRing),interior:E(L.prototype.writeRing)}};q.prototype.ENVELOPE_SERIALIZERS={"http://www.opengis.net/gml/3.2":{lowerCorner:E(H),upperCorner:E(H)}};q.prototype.SURFACEORPOLYGONMEMBER_SERIALIZERS={"http://www.opengis.net/gml/3.2":{surfaceMember:E(L.prototype.writeSurfaceOrPolygonMember),polygonMember:E(L.prototype.writeSurfaceOrPolygonMember)}};q.prototype.POINTMEMBER_SERIALIZERS={"http://www.opengis.net/gml/3.2":{pointMember:E(L.prototype.writePointMember)}};q.prototype.LINESTRINGORCURVEMEMBER_SERIALIZERS={"http://www.opengis.net/gml/3.2":{lineStringMember:E(L.prototype.writeLineStringOrCurveMember),curveMember:E(L.prototype.writeLineStringOrCurveMember)}};q.prototype.GEOMETRY_SERIALIZERS={"http://www.opengis.net/gml/3.2":{Curve:E(L.prototype.writeCurveOrLineString),MultiCurve:E(L.prototype.writeMultiCurveOrLineString),Point:E(q.prototype.writePoint),MultiPoint:E(L.prototype.writeMultiPoint),LineString:E(L.prototype.writeCurveOrLineString),MultiLineString:E(L.prototype.writeMultiCurveOrLineString),LinearRing:E(L.prototype.writeLinearRing),Polygon:E(L.prototype.writeSurfaceOrPolygon),MultiPolygon:E(L.prototype.writeMultiSurfaceOrPolygon),Surface:E(L.prototype.writeSurfaceOrPolygon),MultiSurface:E(L.prototype.writeMultiSurfaceOrPolygon),Envelope:E(L.prototype.writeEnvelope)}};class Rs{constructor(e){this.tagName_=e}getTagName(){return this.tagName_}}class fu extends Rs{constructor(e,t){super(e),this.conditions=t,be(this.conditions.length>=2,"At least 2 conditions are required")}}class gu extends fu{constructor(e){super("And",Array.prototype.slice.call(arguments))}}class pu extends Rs{constructor(e,t,r){if(super("BBOX"),this.geometryName=e,this.extent=t,t.length!==4)throw new Error("Expected an extent with four values ([minX, minY, maxX, maxY])");this.srsName=r}}function mu(i){const e=[null].concat(Array.prototype.slice.call(arguments));return new(Function.prototype.bind.apply(gu,e))}function _u(i,e,t){return new pu(i,e,t)}const fn={"http://www.opengis.net/gml":{boundedBy:p(N.prototype.readExtentElement,"bounds")},"http://www.opengis.net/wfs/2.0":{member:O(N.prototype.readFeaturesInternal)}},Eu={"http://www.opengis.net/wfs":{totalInserted:p(fe),totalUpdated:p(fe),totalDeleted:p(fe)},"http://www.opengis.net/wfs/2.0":{totalInserted:p(fe),totalUpdated:p(fe),totalDeleted:p(fe)}},yu={"http://www.opengis.net/wfs":{TransactionSummary:p(pn,"transactionSummary"),InsertResults:p(_n,"insertIds")},"http://www.opengis.net/wfs/2.0":{TransactionSummary:p(pn,"transactionSummary"),InsertResults:p(_n,"insertIds")}},Tu={"http://www.opengis.net/wfs":{PropertyName:E(H)},"http://www.opengis.net/wfs/2.0":{PropertyName:E(H)}},Ss={"http://www.opengis.net/wfs":{Insert:E(En),Update:E(Tn),Delete:E(yn),Property:E(xn),Native:E(Rn)},"http://www.opengis.net/wfs/2.0":{Insert:E(En),Update:E(Tn),Delete:E(yn),Property:E(xn),Native:E(Rn)}},Ps="feature",Ni="http://www.w3.org/2000/xmlns/",Mi={"2.0.0":"http://www.opengis.net/ogc/1.1","1.1.0":"http://www.opengis.net/ogc","1.0.0":"http://www.opengis.net/ogc"},ri={"2.0.0":"http://www.opengis.net/wfs/2.0","1.1.0":"http://www.opengis.net/wfs","1.0.0":"http://www.opengis.net/wfs"},Oi={"2.0.0":"http://www.opengis.net/fes/2.0","1.1.0":"http://www.opengis.net/fes","1.0.0":"http://www.opengis.net/fes"},gn={"2.0.0":"http://www.opengis.net/wfs/2.0 http://schemas.opengis.net/wfs/2.0/wfs.xsd","1.1.0":"http://www.opengis.net/wfs http://schemas.opengis.net/wfs/1.1.0/wfs.xsd","1.0.0":"http://www.opengis.net/wfs http://schemas.opengis.net/wfs/1.0.0/wfs.xsd"},Di={"2.0.0":q,"1.1.0":L,"1.0.0":W},xu="1.1.0";class Ru extends vr{constructor(e){super(),e=e||{},this.version_=e.version?e.version:xu,this.featureType_=e.featureType,this.featureNS_=e.featureNS,this.gmlFormat_=e.gmlFormat?e.gmlFormat:new Di[this.version_],this.schemaLocation_=e.schemaLocation?e.schemaLocation:gn[this.version_]}getFeatureType(){return this.featureType_}setFeatureType(e){this.featureType_=e}readFeaturesFromNode(e,t){const r={node:e};Object.assign(r,{featureType:this.featureType_,featureNS:this.featureNS_}),Object.assign(r,this.getReadOptions(e,t||{}));const n=[r];let s;this.version_==="2.0.0"?s=fn:s=this.gmlFormat_.FEATURE_COLLECTION_PARSERS;let o=A([],s,e,n,this.gmlFormat_);return o||(o=[]),o}readTransactionResponse(e){if(e){if(typeof e=="string"){const t=fr(e);return this.readTransactionResponseFromDocument(t)}return gr(e)?this.readTransactionResponseFromDocument(e):this.readTransactionResponseFromNode(e)}}readFeatureCollectionMetadata(e){if(e){if(typeof e=="string"){const t=fr(e);return this.readFeatureCollectionMetadataFromDocument(t)}return gr(e)?this.readFeatureCollectionMetadataFromDocument(e):this.readFeatureCollectionMetadataFromNode(e)}}readFeatureCollectionMetadataFromDocument(e){for(let t=e.firstChild;t;t=t.nextSibling)if(t.nodeType==Node.ELEMENT_NODE)return this.readFeatureCollectionMetadataFromNode(t)}readFeatureCollectionMetadataFromNode(e){const t={},r=Ke(e.getAttribute("numberOfFeatures"));return t.numberOfFeatures=r,A(t,fn,e,[],this.gmlFormat_)}readTransactionResponseFromDocument(e){for(let t=e.firstChild;t;t=t.nextSibling)if(t.nodeType==Node.ELEMENT_NODE)return this.readTransactionResponseFromNode(t)}readTransactionResponseFromNode(e){return A({},yu,e,[])}writeGetFeature(e){const t=k(ri[this.version_],"GetFeature");t.setAttribute("service","WFS"),t.setAttribute("version",this.version_),e.handle&&t.setAttribute("handle",e.handle),e.outputFormat&&t.setAttribute("outputFormat",e.outputFormat),e.maxFeatures!==void 0&&t.setAttribute("maxFeatures",String(e.maxFeatures)),e.resultType&&t.setAttribute("resultType",e.resultType),e.startIndex!==void 0&&t.setAttribute("startIndex",String(e.startIndex)),e.count!==void 0&&t.setAttribute("count",String(e.count)),e.viewParams!==void 0&&t.setAttribute("viewParams",e.viewParams),t.setAttributeNS(Bt,"xsi:schemaLocation",this.schemaLocation_);const r={node:t};if(Object.assign(r,{version:this.version_,srsName:e.srsName,featureNS:e.featureNS?e.featureNS:this.featureNS_,featurePrefix:e.featurePrefix,propertyNames:e.propertyNames?e.propertyNames:[]}),be(Array.isArray(e.featureTypes),"`options.featureTypes` must be an Array"),typeof e.featureTypes[0]=="string"){let n=e.filter;e.bbox&&(be(e.geometryName,"`options.geometryName` must also be provided when `options.bbox` is set"),n=this.combineBboxAndFilter(e.geometryName,e.bbox,e.srsName,n)),Object.assign(r,{geometryName:e.geometryName,filter:n}),Fn(t,e.featureTypes,[r])}else e.featureTypes.forEach(n=>{const s=this.combineBboxAndFilter(n.geometryName,n.bbox,e.srsName,e.filter);Object.assign(r,{geometryName:n.geometryName,filter:s}),Fn(t,[n.name],[r])});return t}combineBboxAndFilter(e,t,r,n){const s=_u(e,t,r);return n?mu(n,s):s}writeTransaction(e,t,r,n){const s=[],o=n.version?n.version:this.version_,a=k(ri[o],"Transaction");a.setAttribute("service","WFS"),a.setAttribute("version",o);let l;n&&(l=n.gmlOptions?n.gmlOptions:{},n.handle&&a.setAttribute("handle",n.handle)),a.setAttributeNS(Bt,"xsi:schemaLocation",gn[o]);const c=Su(a,l,o,n);return e&&ir("Insert",e,s,c),t&&ir("Update",t,s,c),r&&ir("Delete",r,s,c),n.nativeElements&&ir("Native",n.nativeElements,s,c),a}readProjectionFromDocument(e){for(let t=e.firstChild;t;t=t.nextSibling)if(t.nodeType==Node.ELEMENT_NODE)return this.readProjectionFromNode(t);return null}readProjectionFromNode(e){if(e.firstElementChild&&e.firstElementChild.firstElementChild){e=e.firstElementChild.firstElementChild;for(let t=e.firstElementChild;t;t=t.nextElementSibling)if(!(t.childNodes.length===0||t.childNodes.length===1&&t.firstChild.nodeType===3)){const r=[{}];return this.gmlFormat_.readGeometryElement(t,r),Q(r.pop().srsName)}}return null}}function Su(i,e,t,r){const n=r.featurePrefix?r.featurePrefix:Ps;let s;return t==="1.0.0"?s=2:t==="1.1.0"?s=3:t==="2.0.0"&&(s=3.2),Object.assign({node:i},{version:t,featureNS:r.featureNS,featureType:r.featureType,featurePrefix:n,gmlVersion:s,hasZ:r.hasZ,srsName:r.srsName},e)}function ir(i,e,t,r){ie(r,Ss,ve(i),e,t)}function pn(i,e){return A({},Eu,i,e)}const Pu={"http://www.opengis.net/ogc":{FeatureId:O(function(i,e){return i.getAttribute("fid")})},"http://www.opengis.net/ogc/1.1":{FeatureId:O(function(i,e){return i.getAttribute("fid")})}};function mn(i,e){Qe(Pu,i,e)}const wu={"http://www.opengis.net/wfs":{Feature:mn},"http://www.opengis.net/wfs/2.0":{Feature:mn}};function _n(i,e){return A([],wu,i,e)}function En(i,e,t){const r=t[t.length-1],n=r.featureType,s=r.featureNS,o=r.gmlVersion,a=k(s,n);i.appendChild(a),o===2?W.prototype.writeFeatureElement(a,e,t):o===3?L.prototype.writeFeatureElement(a,e,t):q.prototype.writeFeatureElement(a,e,t)}function ws(i,e,t){const n=t[t.length-1].version,s=Mi[n],o=k(s,"Filter"),a=k(s,"FeatureId");o.appendChild(a),a.setAttribute("fid",e),i.appendChild(o)}function Gi(i,e){i=i||Ps;const t=i+":";return e.startsWith(t)?e:t+e}function yn(i,e,t){const r=t[t.length-1];be(e.getId()!==void 0,"Features must have an id set");const n=r.featureType,s=r.featurePrefix,o=r.featureNS,a=Gi(s,n);i.setAttribute("typeName",a),i.setAttributeNS(Ni,"xmlns:"+s,o);const l=e.getId();l!==void 0&&ws(i,l,t)}function Tn(i,e,t){const r=t[t.length-1];be(e.getId()!==void 0,"Features must have an id set");const n=r.version,s=r.featureType,o=r.featurePrefix,a=r.featureNS,l=Gi(o,s),c=e.getGeometryName();i.setAttribute("typeName",l),i.setAttributeNS(Ni,"xmlns:"+o,a);const u=e.getId();if(u!==void 0){const h=e.getKeys(),f=[];for(let g=0,d=h.length;g<d;g++){const m=e.get(h[g]);if(m!==void 0){let _=h[g];m&&typeof m.getSimplifiedGeometry=="function"&&(_=c),f.push({name:_,value:m})}}ie({version:n,gmlVersion:r.gmlVersion,node:i,hasZ:r.hasZ,srsName:r.srsName},Ss,ve("Property"),f,t),ws(i,u,t)}}function xn(i,e,t){const r=t[t.length-1],n=r.version,s=ri[n],a=k(s,n==="2.0.0"?"ValueReference":"Name"),l=r.gmlVersion;if(i.appendChild(a),H(a,e.name),e.value!==void 0&&e.value!==null){const c=k(s,"Value");i.appendChild(c),e.value&&typeof e.value.getSimplifiedGeometry=="function"?l===2?W.prototype.writeGeometryElement(c,e.value,t):l===3?L.prototype.writeGeometryElement(c,e.value,t):q.prototype.writeGeometryElement(c,e.value,t):H(c,e.value)}}function Rn(i,e,t){e.vendorId&&i.setAttribute("vendorId",e.vendorId),e.safeToIgnore!==void 0&&i.setAttribute("safeToIgnore",String(e.safeToIgnore)),e.value!==void 0&&H(i,e.value)}const Nr={"http://www.opengis.net/wfs":{Query:E(Sn)},"http://www.opengis.net/wfs/2.0":{Query:E(Sn)},"http://www.opengis.net/ogc":{During:E(Ln),And:E(nr),Or:E(nr),Not:E(vn),BBOX:E(Pn),Contains:E(qe),Intersects:E(qe),Within:E(qe),DWithin:E(wn),PropertyIsEqualTo:E(Ae),PropertyIsNotEqualTo:E(Ae),PropertyIsLessThan:E(Ae),PropertyIsLessThanOrEqualTo:E(Ae),PropertyIsGreaterThan:E(Ae),PropertyIsGreaterThanOrEqualTo:E(Ae),PropertyIsNull:E(bn),PropertyIsBetween:E(An),PropertyIsLike:E(Cn)},"http://www.opengis.net/fes/2.0":{During:E(Ln),And:E(nr),Or:E(nr),Not:E(vn),BBOX:E(Pn),Contains:E(qe),Disjoint:E(qe),Intersects:E(qe),ResourceId:E(vu),Within:E(qe),DWithin:E(wn),PropertyIsEqualTo:E(Ae),PropertyIsNotEqualTo:E(Ae),PropertyIsLessThan:E(Ae),PropertyIsLessThanOrEqualTo:E(Ae),PropertyIsGreaterThan:E(Ae),PropertyIsGreaterThanOrEqualTo:E(Ae),PropertyIsNull:E(bn),PropertyIsBetween:E(An),PropertyIsLike:E(Cn)}};function Sn(i,e,t){const r=t[t.length-1],n=r.version,s=r.featurePrefix,o=r.featureNS,a=r.propertyNames,l=r.srsName;let c;s?c=Gi(s,e):c=e;let u;n==="2.0.0"?u="typeNames":u="typeName",i.setAttribute(u,c),l&&i.setAttribute("srsName",l),o&&i.setAttributeNS(Ni,"xmlns:"+s,o);const h=Object.assign({},r);h.node=i,ie(h,Tu,ve("PropertyName"),a,t);const f=r.filter;if(f){const g=k(Mr(n),"Filter");i.appendChild(g),Lu(g,f,t)}}function Lu(i,e,t){const r=t[t.length-1],n={node:i};Object.assign(n,{context:r}),ie(n,Nr,ve(e.getTagName()),[e],t)}function Pn(i,e,t){const r=t[t.length-1],s=r.context.version;r.srsName=e.srsName;const o=Di[s];Nt(s,i,e.geometryName),o.prototype.writeGeometryElement(i,e.extent,t)}function vu(i,e,t){i.setAttribute("rid",e.rid)}function qe(i,e,t){const r=t[t.length-1],s=r.context.version;r.srsName=e.srsName;const o=Di[s];Nt(s,i,e.geometryName),o.prototype.writeGeometryElement(i,e.geometry,t)}function wn(i,e,t){const s=t[t.length-1].context.version;qe(i,e,t);const o=k(Mr(s),"Distance");H(o,e.distance.toString()),s==="2.0.0"?o.setAttribute("uom",e.unit):o.setAttribute("units",e.unit),i.appendChild(o)}function Ln(i,e,t){const s=t[t.length-1].context.version;yr(Oi[s],"ValueReference",i,e.propertyName);const o=k(Ze,"TimePeriod");i.appendChild(o);const a=k(Ze,"begin");o.appendChild(a),In(a,e.begin);const l=k(Ze,"end");o.appendChild(l),In(l,e.end)}function nr(i,e,t){const n=t[t.length-1].context,s={node:i};Object.assign(s,{context:n});const o=e.conditions;for(let a=0,l=o.length;a<l;++a){const c=o[a];ie(s,Nr,ve(c.getTagName()),[c],t)}}function vn(i,e,t){const n=t[t.length-1].context,s={node:i};Object.assign(s,{context:n});const o=e.condition;ie(s,Nr,ve(o.getTagName()),[o],t)}function Ae(i,e,t){const s=t[t.length-1].context.version;e.matchCase!==void 0&&i.setAttribute("matchCase",e.matchCase.toString()),Nt(s,i,e.propertyName),Tr(s,i,""+e.expression)}function bn(i,e,t){const s=t[t.length-1].context.version;Nt(s,i,e.propertyName)}function An(i,e,t){const s=t[t.length-1].context.version,o=Mr(s);Nt(s,i,e.propertyName);const a=k(o,"LowerBoundary");i.appendChild(a),Tr(s,a,""+e.lowerBoundary);const l=k(o,"UpperBoundary");i.appendChild(l),Tr(s,l,""+e.upperBoundary)}function Cn(i,e,t){const s=t[t.length-1].context.version;i.setAttribute("wildCard",e.wildCard),i.setAttribute("singleChar",e.singleChar),i.setAttribute("escapeChar",e.escapeChar),e.matchCase!==void 0&&i.setAttribute("matchCase",e.matchCase.toString()),Nt(s,i,e.propertyName),Tr(s,i,""+e.pattern)}function yr(i,e,t,r){const n=k(i,e);H(n,r),t.appendChild(n)}function Tr(i,e,t){yr(Mr(i),"Literal",e,t)}function Nt(i,e,t){i==="2.0.0"?yr(Oi[i],"ValueReference",e,t):yr(Mi[i],"PropertyName",e,t)}function In(i,e){const t=k(Ze,"TimeInstant");i.appendChild(t);const r=k(Ze,"timePosition");t.appendChild(r),H(r,e)}function Fn(i,e,t){const r=t[t.length-1],n=Object.assign({},r);n.node=i,ie(n,Nr,ve("Query"),e,t)}function Mr(i){let e;return i==="2.0.0"?e=Oi[i]:e=Mi[i],e}const re={POINT:1,LINE_STRING:2,POLYGON:3,MULTI_POINT:4,MULTI_LINE_STRING:5,MULTI_POLYGON:6,GEOMETRY_COLLECTION:7,POLYHEDRAL_SURFACE:15,TIN:16,TRIANGLE:17};class Nn{constructor(e){this.view_=e,this.pos_=0,this.initialized_=!1,this.isLittleEndian_=!1,this.hasZ_=!1,this.hasM_=!1,this.srid_=null,this.layout_="XY"}readUint8(){return this.view_.getUint8(this.pos_++)}readUint32(e){return this.view_.getUint32((this.pos_+=4)-4,e!==void 0?e:this.isLittleEndian_)}readDouble(e){return this.view_.getFloat64((this.pos_+=8)-8,e!==void 0?e:this.isLittleEndian_)}readPoint(){const e=[];return e.push(this.readDouble()),e.push(this.readDouble()),this.hasZ_&&e.push(this.readDouble()),this.hasM_&&e.push(this.readDouble()),e}readLineString(){const e=this.readUint32(),t=[];for(let r=0;r<e;r++)t.push(this.readPoint());return t}readPolygon(){const e=this.readUint32(),t=[];for(let r=0;r<e;r++)t.push(this.readLineString());return t}readWkbHeader(e){const r=this.readUint8()>0,n=this.readUint32(r),s=Math.floor((n&268435455)/1e3),o=!!(n&2147483648)||s===1||s===3,a=!!(n&1073741824)||s===2||s===3,l=!!(n&536870912),c=(n&268435455)%1e3,u=["XY",o?"Z":"",a?"M":""].join(""),h=l?this.readUint32(r):null;if(e!==void 0&&e!==c)throw new Error("Unexpected WKB geometry type "+c);if(this.initialized_){if(this.isLittleEndian_!==r)throw new Error("Inconsistent endian");if(this.layout_!==u)throw new Error("Inconsistent geometry layout");if(h&&this.srid_!==h)throw new Error("Inconsistent coordinate system (SRID)")}else this.isLittleEndian_=r,this.hasZ_=o,this.hasM_=a,this.layout_=u,this.srid_=h,this.initialized_=!0;return c}readWkbPayload(e){switch(e){case re.POINT:return this.readPoint();case re.LINE_STRING:return this.readLineString();case re.POLYGON:case re.TRIANGLE:return this.readPolygon();case re.MULTI_POINT:return this.readMultiPoint();case re.MULTI_LINE_STRING:return this.readMultiLineString();case re.MULTI_POLYGON:case re.POLYHEDRAL_SURFACE:case re.TIN:return this.readMultiPolygon();case re.GEOMETRY_COLLECTION:return this.readGeometryCollection();default:throw new Error("Unsupported WKB geometry type "+e+" is found")}}readWkbBlock(e){return this.readWkbPayload(this.readWkbHeader(e))}readWkbCollection(e,t){const r=this.readUint32(),n=[];for(let s=0;s<r;s++){const o=e.call(this,t);o&&n.push(o)}return n}readMultiPoint(){return this.readWkbCollection(this.readWkbBlock,re.POINT)}readMultiLineString(){return this.readWkbCollection(this.readWkbBlock,re.LINE_STRING)}readMultiPolygon(){return this.readWkbCollection(this.readWkbBlock,re.POLYGON)}readGeometryCollection(){return this.readWkbCollection(this.readGeometry)}readGeometry(){const e=this.readWkbHeader(),t=this.readWkbPayload(e);switch(e){case re.POINT:return new Ie(t,this.layout_);case re.LINE_STRING:return new Be(t,this.layout_);case re.POLYGON:case re.TRIANGLE:return new ut(t,this.layout_);case re.MULTI_POINT:return new Lr(t,this.layout_);case re.MULTI_LINE_STRING:return new bt(t,this.layout_);case re.MULTI_POLYGON:case re.POLYHEDRAL_SURFACE:case re.TIN:return new Zt(t,this.layout_);case re.GEOMETRY_COLLECTION:return new it(t);default:return null}}getSrid(){return this.srid_}}class bu{constructor(e){e=e||{},this.layout_=e.layout,this.isLittleEndian_=e.littleEndian!==!1,this.isEWKB_=e.ewkb!==!1,this.writeQueue_=[],this.nodata_=Object.assign({X:0,Y:0,Z:0,M:0},e.nodata)}writeUint8(e){this.writeQueue_.push([1,e])}writeUint32(e){this.writeQueue_.push([4,e])}writeDouble(e){this.writeQueue_.push([8,e])}writePoint(e,t){const r=Object.assign.apply(null,t.split("").map((n,s)=>({[n]:e[s]})));for(const n of this.layout_)this.writeDouble(n in r?r[n]:this.nodata_[n])}writeLineString(e,t){this.writeUint32(e.length);for(let r=0;r<e.length;r++)this.writePoint(e[r],t)}writePolygon(e,t){this.writeUint32(e.length);for(let r=0;r<e.length;r++)this.writeLineString(e[r],t)}writeWkbHeader(e,t){e%=1e3,this.layout_.includes("Z")&&(e+=this.isEWKB_?2147483648:1e3),this.layout_.includes("M")&&(e+=this.isEWKB_?1073741824:2e3),this.isEWKB_&&Number.isInteger(t)&&(e|=536870912),this.writeUint8(this.isLittleEndian_?1:0),this.writeUint32(e),this.isEWKB_&&Number.isInteger(t)&&this.writeUint32(t)}writeMultiPoint(e,t){this.writeUint32(e.length);for(let r=0;r<e.length;r++)this.writeWkbHeader(1),this.writePoint(e[r],t)}writeMultiLineString(e,t){this.writeUint32(e.length);for(let r=0;r<e.length;r++)this.writeWkbHeader(2),this.writeLineString(e[r],t)}writeMultiPolygon(e,t){this.writeUint32(e.length);for(let r=0;r<e.length;r++)this.writeWkbHeader(3),this.writePolygon(e[r],t)}writeGeometryCollection(e){this.writeUint32(e.length);for(let t=0;t<e.length;t++)this.writeGeometry(e[t])}findMinimumLayout(e,t="XYZM"){const r=(n,s)=>n===s?n:n==="XYZM"?s:s==="XYZM"?n:"XY";if(e instanceof qi)return r(e.getLayout(),t);if(e instanceof it){const n=e.getGeometriesArray();for(let s=0;s<n.length&&t!=="XY";s++)t=this.findMinimumLayout(n[s],t)}return t}writeGeometry(e,t){const r={Point:re.POINT,LineString:re.LINE_STRING,Polygon:re.POLYGON,MultiPoint:re.MULTI_POINT,MultiLineString:re.MULTI_LINE_STRING,MultiPolygon:re.MULTI_POLYGON,GeometryCollection:re.GEOMETRY_COLLECTION},n=e.getType(),s=r[n];if(!s)throw new Error("GeometryType "+n+" is not supported");this.layout_||(this.layout_=this.findMinimumLayout(e)),this.writeWkbHeader(s,t),e instanceof qi?{Point:this.writePoint,LineString:this.writeLineString,Polygon:this.writePolygon,MultiPoint:this.writeMultiPoint,MultiLineString:this.writeMultiLineString,MultiPolygon:this.writeMultiPolygon}[n].call(this,e.getCoordinates(),e.getLayout()):e instanceof it&&this.writeGeometryCollection(e.getGeometriesArray())}getBuffer(){const e=this.writeQueue_.reduce((s,o)=>s+o[0],0),t=new ArrayBuffer(e),r=new DataView(t);let n=0;return this.writeQueue_.forEach(s=>{switch(s[0]){case 1:r.setUint8(n,s[1]);break;case 4:r.setUint32(n,s[1],this.isLittleEndian_);break;case 8:r.setFloat64(n,s[1],this.isLittleEndian_);break}n+=s[0]}),t}}class Au extends os{constructor(e){super(),e=e||{},this.splitCollection=!!e.splitCollection,this.viewCache_=null,this.hex_=e.hex!==!1,this.littleEndian_=e.littleEndian!==!1,this.ewkb_=e.ewkb!==!1,this.layout_=e.geometryLayout,this.nodataZ_=e.nodataZ||0,this.nodataM_=e.nodataM||0,this.srid_=e.srid}getType(){return this.hex_?"text":"arraybuffer"}readFeature(e,t){return new Re({geometry:this.readGeometry(e,t)})}readFeatures(e,t){let r=[];const n=this.readGeometry(e,t);return this.splitCollection&&n instanceof it?r=n.getGeometriesArray():r=[n],r.map(s=>new Re({geometry:s}))}readGeometry(e,t){const r=Mn(e);if(!r)return null;const s=new Nn(r).readGeometry();return this.viewCache_=r,t=this.getReadOptions(e,t),this.viewCache_=null,me(s,!1,t)}readProjection(e){const t=this.viewCache_||Mn(e);if(!t)return;const r=new Nn(t);return r.readWkbHeader(),r.getSrid()&&Q("EPSG:"+r.getSrid())||void 0}writeFeature(e,t){return this.writeGeometry(e.getGeometry(),t)}writeFeatures(e,t){return this.writeGeometry(new it(e.map(r=>r.getGeometry())),t)}writeGeometry(e,t){t=this.adaptOptions(t);const r=new bu({layout:this.layout_,littleEndian:this.littleEndian_,ewkb:this.ewkb_,nodata:{Z:this.nodataZ_,M:this.nodataM_}});let n=Number.isInteger(this.srid_)?Number(this.srid_):null;if(this.srid_!==!1&&!Number.isInteger(this.srid_)){const o=t.dataProjection&&Q(t.dataProjection);if(o){const a=o.getCode();a.startsWith("EPSG:")&&(n=Number(a.substring(5)))}}r.writeGeometry(me(e,!0,t),n);const s=r.getBuffer();return this.hex_?Cu(s):s}}function Cu(i){const e=new Uint8Array(i);return Array.from(e.values()).map(t=>(t<16?"0":"")+Number(t).toString(16).toUpperCase()).join("")}function Iu(i){const e=new Uint8Array(i.length/2);for(let t=0;t<i.length/2;t++)e[t]=parseInt(i.substr(t*2,2),16);return new DataView(e.buffer)}function Mn(i){return typeof i=="string"?Iu(i):ArrayBuffer.isView(i)?i instanceof DataView?i:new DataView(i.buffer,i.byteOffset,i.byteLength):i instanceof ArrayBuffer?new DataView(i):null}const Fu={POINT:Ie,LINESTRING:Be,POLYGON:ut,MULTIPOINT:Lr,MULTILINESTRING:bt,MULTIPOLYGON:Zt},Ls="EMPTY",vs="Z",bs="M",Nu="ZM",ee={START:0,TEXT:1,LEFT_PAREN:2,RIGHT_PAREN:3,NUMBER:4,COMMA:5,EOF:6},Mu={Point:"POINT",LineString:"LINESTRING",Polygon:"POLYGON",MultiPoint:"MULTIPOINT",MultiLineString:"MULTILINESTRING",MultiPolygon:"MULTIPOLYGON",GeometryCollection:"GEOMETRYCOLLECTION",Circle:"CIRCLE"};class Ou{constructor(e){this.wkt=e,this.index_=-1}isAlpha_(e){return e>="a"&&e<="z"||e>="A"&&e<="Z"}isNumeric_(e,t){return t=t!==void 0?t:!1,e>="0"&&e<="9"||e=="."&&!t}isWhiteSpace_(e){return e==" "||e=="	"||e=="\r"||e==`
`}nextChar_(){return this.wkt.charAt(++this.index_)}nextToken(){const e=this.nextChar_(),t=this.index_;let r=e,n;if(e=="(")n=ee.LEFT_PAREN;else if(e==",")n=ee.COMMA;else if(e==")")n=ee.RIGHT_PAREN;else if(this.isNumeric_(e)||e=="-")n=ee.NUMBER,r=this.readNumber_();else if(this.isAlpha_(e))n=ee.TEXT,r=this.readText_();else{if(this.isWhiteSpace_(e))return this.nextToken();if(e==="")n=ee.EOF;else throw new Error("Unexpected character: "+e)}return{position:t,value:r,type:n}}readNumber_(){let e;const t=this.index_;let r=!1,n=!1;do e=="."?r=!0:(e=="e"||e=="E")&&(n=!0),e=this.nextChar_();while(this.isNumeric_(e,r)||!n&&(e=="e"||e=="E")||n&&(e=="-"||e=="+"));return parseFloat(this.wkt.substring(t,this.index_--))}readText_(){let e;const t=this.index_;do e=this.nextChar_();while(this.isAlpha_(e));return this.wkt.substring(t,this.index_--).toUpperCase()}}class Du{constructor(e){this.lexer_=e,this.token_={position:0,type:ee.START},this.layout_="XY"}consume_(){this.token_=this.lexer_.nextToken()}isTokenType(e){return this.token_.type==e}match(e){const t=this.isTokenType(e);return t&&this.consume_(),t}parse(){return this.consume_(),this.parseGeometry_()}parseGeometryLayout_(){let e="XY";const t=this.token_;if(this.isTokenType(ee.TEXT)){const r=t.value;r===vs?e="XYZ":r===bs?e="XYM":r===Nu&&(e="XYZM"),e!=="XY"&&this.consume_()}return e}parseGeometryCollectionText_(){if(this.match(ee.LEFT_PAREN)){const e=[];do e.push(this.parseGeometry_());while(this.match(ee.COMMA));if(this.match(ee.RIGHT_PAREN))return e}throw new Error(this.formatErrorMessage_())}parsePointText_(){if(this.match(ee.LEFT_PAREN)){const e=this.parsePoint_();if(this.match(ee.RIGHT_PAREN))return e}throw new Error(this.formatErrorMessage_())}parseLineStringText_(){if(this.match(ee.LEFT_PAREN)){const e=this.parsePointList_();if(this.match(ee.RIGHT_PAREN))return e}throw new Error(this.formatErrorMessage_())}parsePolygonText_(){if(this.match(ee.LEFT_PAREN)){const e=this.parseLineStringTextList_();if(this.match(ee.RIGHT_PAREN))return e}throw new Error(this.formatErrorMessage_())}parseMultiPointText_(){if(this.match(ee.LEFT_PAREN)){let e;if(this.token_.type==ee.LEFT_PAREN?e=this.parsePointTextList_():e=this.parsePointList_(),this.match(ee.RIGHT_PAREN))return e}throw new Error(this.formatErrorMessage_())}parseMultiLineStringText_(){if(this.match(ee.LEFT_PAREN)){const e=this.parseLineStringTextList_();if(this.match(ee.RIGHT_PAREN))return e}throw new Error(this.formatErrorMessage_())}parseMultiPolygonText_(){if(this.match(ee.LEFT_PAREN)){const e=this.parsePolygonTextList_();if(this.match(ee.RIGHT_PAREN))return e}throw new Error(this.formatErrorMessage_())}parsePoint_(){const e=[],t=this.layout_.length;for(let r=0;r<t;++r){const n=this.token_;if(this.match(ee.NUMBER))e.push(n.value);else break}if(e.length==t)return e;throw new Error(this.formatErrorMessage_())}parsePointList_(){const e=[this.parsePoint_()];for(;this.match(ee.COMMA);)e.push(this.parsePoint_());return e}parsePointTextList_(){const e=[this.parsePointText_()];for(;this.match(ee.COMMA);)e.push(this.parsePointText_());return e}parseLineStringTextList_(){const e=[this.parseLineStringText_()];for(;this.match(ee.COMMA);)e.push(this.parseLineStringText_());return e}parsePolygonTextList_(){const e=[this.parsePolygonText_()];for(;this.match(ee.COMMA);)e.push(this.parsePolygonText_());return e}isEmptyGeometry_(){const e=this.isTokenType(ee.TEXT)&&this.token_.value==Ls;return e&&this.consume_(),e}formatErrorMessage_(){return"Unexpected `"+this.token_.value+"` at position "+this.token_.position+" in `"+this.lexer_.wkt+"`"}parseGeometry_(){const e=this.token_;if(this.match(ee.TEXT)){const t=e.value;this.layout_=this.parseGeometryLayout_();const r=this.isEmptyGeometry_();if(t=="GEOMETRYCOLLECTION"){if(r)return new it([]);const o=this.parseGeometryCollectionText_();return new it(o)}const n=Fu[t];if(!n)throw new Error("Invalid geometry type: "+t);let s;if(r)t=="POINT"?s=[NaN,NaN]:s=[];else switch(t){case"POINT":{s=this.parsePointText_();break}case"LINESTRING":{s=this.parseLineStringText_();break}case"POLYGON":{s=this.parsePolygonText_();break}case"MULTIPOINT":{s=this.parseMultiPointText_();break}case"MULTILINESTRING":{s=this.parseMultiLineStringText_();break}case"MULTIPOLYGON":{s=this.parseMultiPolygonText_();break}}return new n(s,this.layout_)}throw new Error(this.formatErrorMessage_())}}class Gu extends Ii{constructor(e){super(),e=e||{},this.splitCollection_=e.splitCollection!==void 0?e.splitCollection:!1}parse_(e){const t=new Ou(e);return new Du(t).parse()}readFeatureFromText(e,t){const r=this.readGeometryFromText(e,t),n=new Re;return n.setGeometry(r),n}readFeaturesFromText(e,t){let r=[];const n=this.readGeometryFromText(e,t);this.splitCollection_&&n.getType()=="GeometryCollection"?r=n.getGeometriesArray():r=[n];const s=[];for(let o=0,a=r.length;o<a;++o){const l=new Re;l.setGeometry(r[o]),s.push(l)}return s}readGeometryFromText(e,t){const r=this.parse_(e);return me(r,!1,t)}writeFeatureText(e,t){const r=e.getGeometry();return r?this.writeGeometryText(r,t):""}writeFeaturesText(e,t){if(e.length==1)return this.writeFeatureText(e[0],t);const r=[];for(let s=0,o=e.length;s<o;++s)r.push(e[s].getGeometry());const n=new it(r);return this.writeGeometryText(n,t)}writeGeometryText(e,t){return Is(me(e,!0,t))}}function As(i){const e=i.getCoordinates();return e.length===0?"":e.join(" ")}function Uu(i){const e=[],t=i.getPoints();for(let r=0,n=t.length;r<n;++r)e.push("("+As(t[r])+")");return e.join(",")}function Bu(i){const e=[],t=i.getGeometries();for(let r=0,n=t.length;r<n;++r)e.push(Is(t[r]));return e.join(",")}function Ui(i){const e=i.getCoordinates(),t=[];for(let r=0,n=e.length;r<n;++r)t.push(e[r].join(" "));return t.join(",")}function zu(i){const e=[],t=i.getLineStrings();for(let r=0,n=t.length;r<n;++r)e.push("("+Ui(t[r])+")");return e.join(",")}function Cs(i){const e=[],t=i.getLinearRings();for(let r=0,n=t.length;r<n;++r)e.push("("+Ui(t[r])+")");return e.join(",")}function $u(i){const e=[],t=i.getPolygons();for(let r=0,n=t.length;r<n;++r)e.push("("+Cs(t[r])+")");return e.join(",")}function Xu(i){const e=i.getLayout();let t="";return(e==="XYZ"||e==="XYZM")&&(t+=vs),(e==="XYM"||e==="XYZM")&&(t+=bs),t}const ku={Point:As,LineString:Ui,Polygon:Cs,MultiPoint:Uu,MultiLineString:zu,MultiPolygon:$u,GeometryCollection:Bu};function Is(i){const e=i.getType(),t=ku[e],r=t(i);let n=Mu[e];if(typeof i.getFlatCoordinates=="function"){const s=Xu(i);s.length>0&&(n+=" "+s)}return r.length===0?n+" "+Ls:n+"("+r+")"}const pe=[null,"http://www.opengis.net/wms","http://www.opengis.net/sld"];function Qt(i){return Do(i[0].version,"1.3")>=0}const ju=I(pe,{Service:p(dh),Capability:p(hh)}),Wu=I(pe,{Request:p(xh),Exception:p(mh),Layer:p(_h),UserDefinedSymbolization:p(ch)});class Zu extends Fi{constructor(){super(),this.version=void 0}readFromNode(e){this.version=e.getAttribute("version").trim();const t=A({version:this.version},ju,e,[]);return t||null}}const Fs={Name:p(b),Title:p(b),Abstract:p(b),KeywordList:p(Us),OnlineResource:p(Ft),ContactInformation:p(fh),Fees:p(b),AccessConstraints:p(b)},Hu=I(pe,Fs),Vu=I(pe,{...Fs,LayerLimit:p(fe),MaxWidth:p(fe),MaxHeight:p(fe)}),Yu=I(pe,{ContactPersonPrimary:p(gh),ContactPosition:p(b),ContactAddress:p(ph),ContactVoiceTelephone:p(b),ContactFacsimileTelephone:p(b),ContactElectronicMailAddress:p(b)}),qu=I(pe,{ContactPerson:p(b),ContactOrganization:p(b)}),Ku=I(pe,{AddressType:p(b),Address:p(b),City:p(b),StateOrProvince:p(b),PostCode:p(b),Country:p(b)}),Ju=I(pe,{Format:O(b)}),Ns={Name:p(b),Title:p(b),Abstract:p(b),KeywordList:p(Us),BoundingBox:te(Ds),Dimension:te(Eh),Attribution:p(lh),AuthorityURL:te(Ph),Identifier:te(b),MetadataURL:te(wh),DataURL:te(Ve),FeatureListURL:te(Ve),Style:te(Lh),Layer:te(Or)},Ms=I(pe,{...Ns,SRS:te(b),Extent:p(yh),ScaleHint:te(Th),LatLonBoundingBox:p((i,e)=>Ds(i,e,!1)),Layer:te(Or)}),Os=I(pe,{...Ns,CRS:te(b),EX_GeographicBoundingBox:p(uh),MinScaleDenominator:p(ye),MaxScaleDenominator:p(ye),Layer:te(Or)}),Qu=I(pe,{Title:p(b),OnlineResource:p(Ft),LogoURL:p(Gs)}),eh=I(pe,{westBoundLongitude:p(ye),eastBoundLongitude:p(ye),southBoundLatitude:p(ye),northBoundLatitude:p(ye)}),th=I(pe,{GetCapabilities:p(Ot),GetMap:p(Ot),GetFeatureInfo:p(Ot),DescribeLayer:p(Ot),GetLegendGraphic:p(Ot)}),rh=I(pe,{Format:te(b),DCPType:te(Rh)}),ih=I(pe,{HTTP:p(Sh)}),nh=I(pe,{Get:p(Ve),Post:p(Ve)}),sh=I(pe,{Name:p(b),Title:p(b),Abstract:p(b),LegendURL:te(Gs),StyleSheetURL:p(Ve),StyleURL:p(Ve)}),oh=I(pe,{Format:p(b),OnlineResource:p(Ft)}),ah=I(pe,{Keyword:O(b)});function lh(i,e){return A({},Qu,i,e)}function ch(i,e){return{SupportSLD:!!Le(i.getAttribute("SupportSLD")),UserLayer:!!Le(i.getAttribute("UserLayer")),UserStyle:!!Le(i.getAttribute("UserStyle")),RemoteWFS:!!Le(i.getAttribute("RemoteWFS")),InlineFeatureData:!!Le(i.getAttribute("InlineFeatureData")),RemoteWCS:!!Le(i.getAttribute("RemoteWCS"))}}function Ds(i,e,t=!0){const r=[Ge(i.getAttribute("minx")),Ge(i.getAttribute("miny")),Ge(i.getAttribute("maxx")),Ge(i.getAttribute("maxy"))],n=[Ge(i.getAttribute("resx")),Ge(i.getAttribute("resy"))],s={extent:r,res:n};return t&&(Qt(e)?s.crs=i.getAttribute("CRS"):s.srs=i.getAttribute("SRS")),s}function uh(i,e){const t=A({},eh,i,e);if(!t)return;const r=t.westBoundLongitude,n=t.southBoundLatitude,s=t.eastBoundLongitude,o=t.northBoundLatitude;if(!(r===void 0||n===void 0||s===void 0||o===void 0))return[r,n,s,o]}function hh(i,e){return A({},Wu,i,e)}function dh(i,e){return A({},Qt(e)?Vu:Hu,i,e)}function fh(i,e){return A({},Yu,i,e)}function gh(i,e){return A({},qu,i,e)}function ph(i,e){return A({},Ku,i,e)}function mh(i,e){return A([],Ju,i,e)}function _h(i,e){const t=A({},Qt(e)?Os:Ms,i,e);return t.Layer===void 0?Object.assign(t,Or(i,e)):t}function Or(i,e){const t=Qt(e),r=e[e.length-1],n=A({},t?Os:Ms,i,e);if(!n)return;let s=Le(i.getAttribute("queryable"));s===void 0&&(s=r.queryable),n.queryable=s!==void 0?s:!1;let o=Ke(i.getAttribute("cascaded"));o===void 0&&(o=r.cascaded),n.cascaded=o;let a=Le(i.getAttribute("opaque"));a===void 0&&(a=r.opaque),n.opaque=a!==void 0?a:!1;let l=Le(i.getAttribute("noSubsets"));l===void 0&&(l=r.noSubsets),n.noSubsets=l!==void 0?l:!1;let c=Ge(i.getAttribute("fixedWidth"));c||(c=r.fixedWidth),n.fixedWidth=c;let u=Ge(i.getAttribute("fixedHeight"));u||(u=r.fixedHeight),n.fixedHeight=u;const h=["Style","AuthorityURL"];t?h.push("CRS"):h.push("SRS","Dimension"),h.forEach(function(g){if(g in r){const d=n[g]||[];n[g]=d.concat(r[g])}});const f=["BoundingBox","Attribution"];return t?f.push("Dimension","EX_GeographicBoundingBox","MinScaleDenominator","MaxScaleDenominator"):f.push("LatLonBoundingBox","ScaleHint","Extent"),f.forEach(function(g){if(!(g in n)){const d=r[g];n[g]=d}}),n}function Eh(i,e){const t={name:i.getAttribute("name"),units:i.getAttribute("units"),unitSymbol:i.getAttribute("unitSymbol")};return Qt(e)&&Object.assign(t,{default:i.getAttribute("default"),multipleValues:Le(i.getAttribute("multipleValues")),nearestValue:Le(i.getAttribute("nearestValue")),current:Le(i.getAttribute("current")),values:b(i)}),t}function yh(i,e){return{name:i.getAttribute("name"),default:i.getAttribute("default"),nearestValue:Le(i.getAttribute("nearestValue"))}}function Th(i,e){return{min:Ge(i.getAttribute("min")),max:Ge(i.getAttribute("max"))}}function Ve(i,e){return A({},oh,i,e)}function xh(i,e){return A({},th,i,e)}function Rh(i,e){return A({},ih,i,e)}function Sh(i,e){return A({},nh,i,e)}function Ot(i,e){return A({},rh,i,e)}function Gs(i,e){const t=Ve(i,e);if(t){const r=[Ke(i.getAttribute("width")),Ke(i.getAttribute("height"))];return t.size=r,t}}function Ph(i,e){const t=Ve(i,e);if(t)return t.name=i.getAttribute("name"),t}function wh(i,e){const t=Ve(i,e);if(t)return t.type=i.getAttribute("type"),t}function Lh(i,e){return A({},sh,i,e)}function Us(i,e){return A([],ah,i,e)}const vh="_feature",bh="_layer";class Ah extends vr{constructor(e){super(),e=e||{},this.featureNS_="http://mapserver.gis.umn.edu/mapserver",this.gmlFormat_=new W,this.layers_=e.layers?e.layers:null}getLayers(){return this.layers_}setLayers(e){this.layers_=e}readFeatures_(e,t){e.setAttribute("namespaceURI",this.featureNS_);const r=e.localName;let n=[];if(e.childNodes.length===0)return n;if(r=="msGMLOutput")for(let s=0,o=e.childNodes.length;s<o;s++){const a=e.childNodes[s];if(a.nodeType!==Node.ELEMENT_NODE)continue;const l=a,c=t[0],u=bh,h=l.localName.replace(u,"");if(this.layers_&&!this.layers_.includes(h))continue;const f=h+vh;c.featureType=f,c.featureNS=this.featureNS_;const g={};g[f]=O(this.gmlFormat_.readFeatureElement,this.gmlFormat_);const d=I([c.featureNS,null],g);l.setAttribute("namespaceURI",this.featureNS_);const m=A([],d,l,t,this.gmlFormat_);m&&dr(n,m)}if(r=="FeatureCollection"){const s=A([],this.gmlFormat_.FEATURE_COLLECTION_PARSERS,e,[{}],this.gmlFormat_);s&&(n=s)}return n}readFeaturesFromNode(e,t){const r={};return t&&Object.assign(r,this.getReadOptions(e,t)),this.readFeatures_(e,[r])}}const ze=[null,"http://www.opengis.net/wmts/1.0"],Mt=[null,"http://www.opengis.net/ows/1.1"],Ch=I(ze,{Contents:p(zh)});let Bs=class extends Fi{constructor(){super(),this.owsParser_=new xs}readFromNode(e){let t=e.getAttribute("version");t&&(t=t.trim());let r=this.owsParser_.readFromNode(e);return r?(r.version=t,r=A(r,Ch,e,[]),r||null):null}};const Ih=I(ze,{Layer:te($h),TileMatrixSet:te(Xh)}),Fh=I(ze,{Style:te(kh),Format:te(b),TileMatrixSetLink:te(jh),Dimension:te(Wh),ResourceURL:te(Zh)},I(Mt,{Title:p(b),Abstract:p(b),WGS84BoundingBox:p($s),BoundingBox:te(Hh),Identifier:p(b)})),Nh=I(ze,{LegendURL:te(Vh)},I(Mt,{Title:p(b),Identifier:p(b)})),Mh=I(ze,{TileMatrixSet:p(b),TileMatrixSetLimits:p(qh)}),Oh=I(ze,{TileMatrixLimits:O(Kh)}),Dh=I(ze,{TileMatrix:p(b),MinTileRow:p(fe),MaxTileRow:p(fe),MinTileCol:p(fe),MaxTileCol:p(fe)}),Gh=I(ze,{Default:p(b),Value:te(b)},I(Mt,{Identifier:p(b)})),zs=I(Mt,{LowerCorner:O(ii),UpperCorner:O(ii)}),Uh=I(ze,{WellKnownScaleSet:p(b),TileMatrix:te(Yh)},I(Mt,{SupportedCRS:p(b),Identifier:p(b),BoundingBox:p($s)})),Bh=I(ze,{TopLeftCorner:p(ii),ScaleDenominator:p(ye),TileWidth:p(fe),TileHeight:p(fe),MatrixWidth:p(fe),MatrixHeight:p(fe)},I(Mt,{Identifier:p(b)}));function zh(i,e){return A({},Ih,i,e)}function $h(i,e){return A({},Fh,i,e)}function Xh(i,e){return A({},Uh,i,e)}function kh(i,e){const t=A({},Nh,i,e);if(!t)return;const r=i.getAttribute("isDefault")==="true";return t.isDefault=r,t}function jh(i,e){return A({},Mh,i,e)}function Wh(i,e){return A({},Gh,i,e)}function Zh(i,e){const t=i.getAttribute("format"),r=i.getAttribute("template"),n=i.getAttribute("resourceType"),s={};return t&&(s.format=t),r&&(s.template=r),n&&(s.resourceType=n),s}function $s(i,e){const t=A([],zs,i,e);if(t.length==2)return di(t)}function Hh(i,e){const t=i.getAttribute("crs"),r=A([],zs,i,e);if(r.length==2)return{extent:di(r),crs:t}}function Vh(i,e){const t={};return t.format=i.getAttribute("format"),t.href=Ft(i),t}function ii(i,e){const t=b(i).split(/\s+/);if(!t||t.length!=2)return;const r=+t[0],n=+t[1];if(!(isNaN(r)||isNaN(n)))return[r,n]}function Yh(i,e){return A({},Bh,i,e)}function qh(i,e){return A([],Oh,i,e)}function Kh(i,e){return A({},Dh,i,e)}window.eoxMapAdvancedOlFormats={EsriJSON:gl,GML:Li,GPX:$l,IGC:Sc,IIIFInfo:Ac,KML:Uo,OWS:xs,Polyline:su,TopoJSON:Go,WFS:Ru,WKB:Au,WKT:Gu,WMSCapabilities:Zu,WMSGetFeatureInfo:Ah,WMTSCapabilities:Bs};function Xs(i,e,t){const r=[];let n=i(0),s=i(1),o=e(n),a=e(s);const l=[s,n],c=[a,o],u=[1,0],h={};let f=1e5,g,d,m,_,y,T;for(;--f>0&&u.length>0;)m=u.pop(),n=l.pop(),o=c.pop(),T=m.toString(),T in h||(r.push(o[0],o[1]),h[T]=!0),_=u.pop(),s=l.pop(),a=c.pop(),y=(m+_)/2,g=i(y),d=e(g),Bo(d[0],d[1],o[0],o[1],a[0],a[1])<t?(r.push(a[0],a[1]),T=_.toString(),h[T]=!0):(u.push(_,y,y,m),c.push(a,d,d,o),l.push(s,g,g,n));return r}function Jh(i,e,t,r,n){const s=Q("EPSG:4326");return Xs(function(o){return[i,e+(t-e)*o]},mr(s,r),n)}function Qh(i,e,t,r,n){const s=Q("EPSG:4326");return Xs(function(o){return[e+(t-e)*o,i]},mr(s,r),n)}function ed(i){if(!(i.context instanceof CanvasRenderingContext2D))throw new Error("Only works for render events from Canvas 2D layers");const e=i.inversePixelTransform[0],t=i.inversePixelTransform[1],r=Math.sqrt(e*e+t*t),n=i.frameState,s=zt(i.inversePixelTransform.slice(),n.coordinateToPixelTransform),o=zo(n.viewState.resolution,r);let a;return new $o(i.context,r,n.extent,s,n.viewState.rotation,o,a)}const td=new Yr({color:"rgba(0,0,0,0.2)"}),rd=[90,45,30,20,10,5,2,1,30/60,20/60,10/60,5/60,2/60,1/60,30/3600,20/3600,10/3600,5/3600,2/3600,1/3600];class id extends Xo{constructor(e){e=e||{};const t=Object.assign({updateWhileAnimating:!0,updateWhileInteracting:!0,renderBuffer:0},e);delete t.maxLines,delete t.strokeStyle,delete t.targetSize,delete t.showLabels,delete t.lonLabelFormatter,delete t.latLabelFormatter,delete t.lonLabelPosition,delete t.latLabelPosition,delete t.lonLabelStyle,delete t.latLabelStyle,delete t.intervals,super(t),this.projection_=null,this.maxLat_=1/0,this.maxLon_=1/0,this.minLat_=-1/0,this.minLon_=-1/0,this.maxX_=1/0,this.maxY_=1/0,this.minX_=-1/0,this.minY_=-1/0,this.targetSize_=e.targetSize!==void 0?e.targetSize:100,this.maxLines_=e.maxLines!==void 0?e.maxLines:100,this.meridians_=[],this.parallels_=[],this.strokeStyle_=e.strokeStyle!==void 0?e.strokeStyle:td,this.fromLonLatTransform_=void 0,this.toLonLatTransform_=void 0,this.projectionCenterLonLat_=null,this.bottomLeft_=null,this.bottomRight_=null,this.topLeft_=null,this.topRight_=null,this.meridiansLabels_=null,this.parallelsLabels_=null,e.showLabels&&(this.lonLabelFormatter_=e.lonLabelFormatter==null?Ki.bind(this,"EW"):e.lonLabelFormatter,this.latLabelFormatter_=e.latLabelFormatter==null?Ki.bind(this,"NS"):e.latLabelFormatter,this.lonLabelPosition_=e.lonLabelPosition==null?0:e.lonLabelPosition,this.latLabelPosition_=e.latLabelPosition==null?1:e.latLabelPosition,this.lonLabelStyleBase_=new Br({text:e.lonLabelStyle!==void 0?e.lonLabelStyle.clone():new Ji({font:"12px Calibri,sans-serif",textBaseline:"bottom",fill:new Qi({color:"rgba(0,0,0,1)"}),stroke:new Yr({color:"rgba(255,255,255,1)",width:3})})}),this.lonLabelStyle_=r=>{const n=r.get("graticule_label");return this.lonLabelStyleBase_.getText().setText(n),this.lonLabelStyleBase_},this.latLabelStyleBase_=new Br({text:e.latLabelStyle!==void 0?e.latLabelStyle.clone():new Ji({font:"12px Calibri,sans-serif",textAlign:"right",fill:new Qi({color:"rgba(0,0,0,1)"}),stroke:new Yr({color:"rgba(255,255,255,1)",width:3})})}),this.latLabelStyle_=r=>{const n=r.get("graticule_label");return this.latLabelStyleBase_.getText().setText(n),this.latLabelStyleBase_},this.meridiansLabels_=[],this.parallelsLabels_=[],this.addEventListener(lt.POSTRENDER,this.drawLabels_.bind(this))),this.intervals_=e.intervals!==void 0?e.intervals:rd,this.setSource(new fi({loader:this.loaderFunction.bind(this),strategy:this.strategyFunction.bind(this),features:new ko,overlaps:!1,useSpatialIndex:!1,wrapX:e.wrapX})),this.featurePool_=[],this.lineStyle_=new Br({stroke:this.strokeStyle_}),this.loadedExtent_=null,this.renderedExtent_=null,this.renderedResolution_=null,this.setRenderOrder(null)}strategyFunction(e,t){let r=e.slice();return this.projection_&&this.getSource().getWrapX()&&jo(r,this.projection_),this.loadedExtent_&&(Wo(this.loadedExtent_,r,t)?r=this.loadedExtent_.slice():this.getSource().removeLoadedExtent(this.loadedExtent_)),[r]}loaderFunction(e,t,r){this.loadedExtent_=e;const n=this.getSource(),s=this.getExtent()||[-1/0,-1/0,1/0,1/0],o=Ue(s,e);if(this.renderedExtent_&&$t(this.renderedExtent_,o)&&this.renderedResolution_===t||(this.renderedExtent_=o,this.renderedResolution_=t,gi(o)))return;const a=et(o),l=t*t/4;(!this.projection_||!ar(this.projection_,r))&&this.updateProjectionInfo_(r),this.createGraticule_(o,a,t,l);let u=this.meridians_.length+this.parallels_.length;this.meridiansLabels_&&(u+=this.meridians_.length),this.parallelsLabels_&&(u+=this.parallels_.length);let h;for(;u>this.featurePool_.length;)h=new Re,this.featurePool_.push(h);const f=n.getFeaturesCollection();f.clear();let g=0,d,m;for(d=0,m=this.meridians_.length;d<m;++d)h=this.featurePool_[g++],h.setGeometry(this.meridians_[d]),h.setStyle(this.lineStyle_),f.push(h);for(d=0,m=this.parallels_.length;d<m;++d)h=this.featurePool_[g++],h.setGeometry(this.parallels_[d]),h.setStyle(this.lineStyle_),f.push(h)}addMeridian_(e,t,r,n,s,o){const a=this.getMeridian_(e,t,r,n,o);if(wt(a.getExtent(),s)){if(this.meridiansLabels_){const l=this.lonLabelFormatter_(e);o in this.meridiansLabels_?this.meridiansLabels_[o].text=l:this.meridiansLabels_[o]={geom:new Ie([]),text:l}}this.meridians_[o++]=a}return o}addParallel_(e,t,r,n,s,o){const a=this.getParallel_(e,t,r,n,o);if(wt(a.getExtent(),s)){if(this.parallelsLabels_){const l=this.latLabelFormatter_(e);o in this.parallelsLabels_?this.parallelsLabels_[o].text=l:this.parallelsLabels_[o]={geom:new Ie([]),text:l}}this.parallels_[o++]=a}return o}drawLabels_(e){const t=e.frameState.viewState.rotation,r=e.frameState.viewState.resolution,n=e.frameState.size,s=e.frameState.extent,o=et(s);let a=s;if(t){const d=n[0]*r,m=n[1]*r;a=[o[0]-d/2,o[1]-m/2,o[0]+d/2,o[1]+m/2]}let l=0,c=0,u=this.latLabelPosition_<.5;const h=this.projection_.getExtent(),f=Ee(h);if(this.getSource().getWrapX()&&this.projection_.canWrapX()&&!ur(h,s)){l=Math.floor((s[0]-h[0])/f),c=Math.ceil((s[2]-h[2])/f);const d=Math.abs(t)>Math.PI/2;u=u!==d}const g=ed(e);for(let d=l;d<=c;++d){let m=this.meridians_.length+this.parallels_.length,_,y,T,x;if(this.meridiansLabels_)for(y=0,T=this.meridiansLabels_.length;y<T;++y){const S=this.meridians_[y];if(!t&&d===0)x=this.getMeridianPoint_(S,s,y);else{const P=S.clone();P.translate(d*f,0),P.rotate(-t,o),x=this.getMeridianPoint_(P,a,y),x.rotate(t,o)}_=this.featurePool_[m++],_.setGeometry(x),_.set("graticule_label",this.meridiansLabels_[y].text),g.drawFeature(_,this.lonLabelStyle_(_))}if(this.parallelsLabels_&&(d===l&&u||d===c&&!u))for(y=0,T=this.parallels_.length;y<T;++y){const S=this.parallels_[y];if(!t&&d===0)x=this.getParallelPoint_(S,s,y);else{const P=S.clone();P.translate(d*f,0),P.rotate(-t,o),x=this.getParallelPoint_(P,a,y),x.rotate(t,o)}_=this.featurePool_[m++],_.setGeometry(x),_.set("graticule_label",this.parallelsLabels_[y].text),g.drawFeature(_,this.latLabelStyle_(_))}}}createGraticule_(e,t,r,n){const s=this.getInterval_(r);if(s==-1){this.meridians_.length=0,this.parallels_.length=0,this.meridiansLabels_&&(this.meridiansLabels_.length=0),this.parallelsLabels_&&(this.parallelsLabels_.length=0);return}let o=!1;const a=this.projection_.getExtent(),l=Ee(a);this.getSource().getWrapX()&&this.projection_.canWrapX()&&!ur(a,e)&&(Ee(e)>=l?(e[0]=a[0],e[2]=a[2]):o=!0);const c=[ue(t[0],this.minX_,this.maxX_),ue(t[1],this.minY_,this.maxY_)],u=this.toLonLatTransform_(c);isNaN(u[1])&&(u[1]=Math.abs(this.maxLat_)>=Math.abs(this.minLat_)?this.maxLat_:this.minLat_);let h=ue(u[0],this.minLon_,this.maxLon_),f=ue(u[1],this.minLat_,this.maxLat_);const g=this.maxLines_;let d,m,_,y,T=e;o||(T=[ue(e[0],this.minX_,this.maxX_),ue(e[1],this.minY_,this.maxY_),ue(e[2],this.minX_,this.maxX_),ue(e[3],this.minY_,this.maxY_)]);const x=Lt(T,this.toLonLatTransform_,void 0,8);let S=x[3],P=x[2],R=x[1],v=x[0];if(o||(St(T,this.bottomLeft_)&&(v=this.minLon_,R=this.minLat_),St(T,this.bottomRight_)&&(P=this.maxLon_,R=this.minLat_),St(T,this.topLeft_)&&(v=this.minLon_,S=this.maxLat_),St(T,this.topRight_)&&(P=this.maxLon_,S=this.maxLat_),S=ue(S,f,this.maxLat_),P=ue(P,h,this.maxLon_),R=ue(R,this.minLat_,f),v=ue(v,this.minLon_,h)),h=Math.floor(h/s)*s,y=ue(h,this.minLon_,this.maxLon_),m=this.addMeridian_(y,R,S,n,e,0),d=0,o)for(;(y-=s)>=v&&d++<g;)m=this.addMeridian_(y,R,S,n,e,m);else for(;y!=this.minLon_&&d++<g;)y=Math.max(y-s,this.minLon_),m=this.addMeridian_(y,R,S,n,e,m);if(y=ue(h,this.minLon_,this.maxLon_),d=0,o)for(;(y+=s)<=P&&d++<g;)m=this.addMeridian_(y,R,S,n,e,m);else for(;y!=this.maxLon_&&d++<g;)y=Math.min(y+s,this.maxLon_),m=this.addMeridian_(y,R,S,n,e,m);for(this.meridians_.length=m,this.meridiansLabels_&&(this.meridiansLabels_.length=m),f=Math.floor(f/s)*s,_=ue(f,this.minLat_,this.maxLat_),m=this.addParallel_(_,v,P,n,e,0),d=0;_!=this.minLat_&&d++<g;)_=Math.max(_-s,this.minLat_),m=this.addParallel_(_,v,P,n,e,m);for(_=ue(f,this.minLat_,this.maxLat_),d=0;_!=this.maxLat_&&d++<g;)_=Math.min(_+s,this.maxLat_),m=this.addParallel_(_,v,P,n,e,m);this.parallels_.length=m,this.parallelsLabels_&&(this.parallelsLabels_.length=m)}getInterval_(e){const t=this.projectionCenterLonLat_[0],r=this.projectionCenterLonLat_[1];let n=-1;const s=Math.pow(this.targetSize_*e,2),o=[],a=[];for(let l=0,c=this.intervals_.length;l<c;++l){const u=ue(this.intervals_[l]/2,0,90),h=ue(r,-90+u,90-u);if(o[0]=t-u,o[1]=h-u,a[0]=t+u,a[1]=h+u,this.fromLonLatTransform_(o,o),this.fromLonLatTransform_(a,a),Math.pow(a[0]-o[0],2)+Math.pow(a[1]-o[1],2)<=s)break;n=this.intervals_[l]}return n}getMeridian_(e,t,r,n,s){const o=Jh(e,t,r,this.projection_,n);let a=this.meridians_[s];return a?(a.setFlatCoordinates("XY",o),a.changed()):(a=new Be(o,"XY"),this.meridians_[s]=a),a}getMeridianPoint_(e,t,r){const n=e.getFlatCoordinates();let s=1,o=n.length-1;n[s]>n[o]&&(s=o,o=1);const a=Math.max(t[1],n[s]),l=Math.min(t[3],n[o]),c=ue(t[1]+Math.abs(t[1]-t[3])*this.lonLabelPosition_,a,l),h=[n[s-1]+(n[o-1]-n[s-1])*(c-n[s])/(n[o]-n[s]),c],f=this.meridiansLabels_[r].geom;return f.setCoordinates(h),f}getMeridians(){return this.meridians_}getParallel_(e,t,r,n,s){const o=Qh(e,t,r,this.projection_,n);let a=this.parallels_[s];return a?(a.setFlatCoordinates("XY",o),a.changed()):a=new Be(o,"XY"),a}getParallelPoint_(e,t,r){const n=e.getFlatCoordinates();let s=0,o=n.length-2;n[s]>n[o]&&(s=o,o=0);const a=Math.max(t[0],n[s]),l=Math.min(t[2],n[o]),c=ue(t[0]+Math.abs(t[0]-t[2])*this.latLabelPosition_,a,l),u=n[s+1]+(n[o+1]-n[s+1])*(c-n[s])/(n[o]-n[s]),h=[c,u],f=this.parallelsLabels_[r].geom;return f.setCoordinates(h),f}getParallels(){return this.parallels_}updateProjectionInfo_(e){const t=Q("EPSG:4326"),r=e.getWorldExtent();this.maxLat_=r[3],this.maxLon_=r[2],this.minLat_=r[1],this.minLon_=r[0];const n=mr(e,t);if(this.minLon_<this.maxLon_)this.toLonLatTransform_=n;else{const o=this.minLon_+this.maxLon_/2;this.maxLon_+=360,this.toLonLatTransform_=function(a,l,c){c=c||2;const u=n(a,l,c);for(let h=0,f=u.length;h<f;h+=c)u[h]<o&&(u[h]+=360);return u}}this.fromLonLatTransform_=mr(t,e);const s=Lt([this.minLon_,this.minLat_,this.maxLon_,this.maxLat_],this.fromLonLatTransform_,void 0,8);this.minX_=s[0],this.maxX_=s[2],this.minY_=s[1],this.maxY_=s[3],this.bottomLeft_=this.fromLonLatTransform_([this.minLon_,this.minLat_]),this.bottomRight_=this.fromLonLatTransform_([this.maxLon_,this.minLat_]),this.topLeft_=this.fromLonLatTransform_([this.minLon_,this.maxLat_]),this.topRight_=this.fromLonLatTransform_([this.maxLon_,this.maxLat_]),this.projectionCenterLonLat_=this.toLonLatTransform_(et(e.getExtent())),isNaN(this.projectionCenterLonLat_[1])&&(this.projectionCenterLonLat_[1]=Math.abs(this.maxLat_)>=Math.abs(this.minLat_)?this.maxLat_:this.minLat_),this.projection_=e}}function mt(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}function xr(i,e){return i[0]=e[0],i[1]=e[1],i[4]=e[2],i[5]=e[3],i[12]=e[4],i[13]=e[5],i}function ni(i,e,t,r,n,s,o){o=o??mt();const a=1/(i-e),l=1/(t-r),c=1/(n-s);return o[0]=-2*a,o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[5]=-2*l,o[6]=0,o[7]=0,o[8]=0,o[9]=0,o[10]=2*c,o[11]=0,o[12]=(i+e)*a,o[13]=(r+t)*l,o[14]=(s+n)*c,o[15]=1,o}function On(i,e,t,r,n){return n=n??mt(),n[0]=i[0]*e,n[1]=i[1]*e,n[2]=i[2]*e,n[3]=i[3]*e,n[4]=i[4]*t,n[5]=i[5]*t,n[6]=i[6]*t,n[7]=i[7]*t,n[8]=i[8]*r,n[9]=i[9]*r,n[10]=i[10]*r,n[11]=i[11]*r,n[12]=i[12],n[13]=i[13],n[14]=i[14],n[15]=i[15],n}function nd(i,e,t,r,n){n=n??mt();let s,o,a,l,c,u,h,f,g,d,m,_;return i===n?(n[12]=i[0]*e+i[4]*t+i[8]*r+i[12],n[13]=i[1]*e+i[5]*t+i[9]*r+i[13],n[14]=i[2]*e+i[6]*t+i[10]*r+i[14],n[15]=i[3]*e+i[7]*t+i[11]*r+i[15]):(s=i[0],o=i[1],a=i[2],l=i[3],c=i[4],u=i[5],h=i[6],f=i[7],g=i[8],d=i[9],m=i[10],_=i[11],n[0]=s,n[1]=o,n[2]=a,n[3]=l,n[4]=c,n[5]=u,n[6]=h,n[7]=f,n[8]=g,n[9]=d,n[10]=m,n[11]=_,n[12]=s*e+c*t+g*r+i[12],n[13]=o*e+u*t+d*r+i[13],n[14]=a*e+h*t+m*r+i[14],n[15]=l*e+f*t+_*r+i[15]),n}function sd(i,e,t,r){return r=r??mt(),r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=1,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=1,r[11]=0,r[12]=i,r[13]=e,r[14]=t,r[15]=1,r}const ft=34962,er=34963,Bi=35044,Pt=35048,od=5121,ad=5123,ld=5125,ks=5126,Dn=["experimental-webgl","webgl","webkit-3d","moz-webgl"];function cd(i,e){e=Object.assign({preserveDrawingBuffer:!0,antialias:!Zo},e);const t=Dn.length;for(let r=0;r<t;++r)try{const n=i.getContext(Dn[r],e);if(n)return n}catch{}return null}const ud={STATIC_DRAW:Bi};class tt{constructor(e,t){this.array_=null,this.type_=e,be(e===ft||e===er,"A `WebGLArrayBuffer` must either be of type `ELEMENT_ARRAY_BUFFER` or `ARRAY_BUFFER`"),this.usage_=t!==void 0?t:ud.STATIC_DRAW}ofSize(e){return this.array_=new(sr(this.type_))(e),this}fromArray(e){return this.array_=sr(this.type_).from(e),this}fromArrayBuffer(e){return this.array_=new(sr(this.type_))(e),this}getType(){return this.type_}getArray(){return this.array_}setArray(e){const t=sr(this.type_);if(!(e instanceof t))throw new Error(`Expected ${t}`);this.array_=e}getUsage(){return this.usage_}getSize(){return this.array_?this.array_.length:0}}function sr(i){switch(i){case ft:return Float32Array;case er:return Uint32Array;default:return Float32Array}}const or={LOST:"webglcontextlost",RESTORED:"webglcontextrestored"},hd=`
  precision mediump float;

  attribute vec2 a_position;
  varying vec2 v_texCoord;
  varying vec2 v_screenCoord;

  uniform vec2 u_screenSize;

  void main() {
    v_texCoord = a_position * 0.5 + 0.5;
    v_screenCoord = v_texCoord * u_screenSize;
    gl_Position = vec4(a_position, 0.0, 1.0);
  }
`,dd=`
  precision mediump float;

  uniform sampler2D u_image;
  uniform float u_opacity;

  varying vec2 v_texCoord;

  void main() {
    gl_FragColor = texture2D(u_image, v_texCoord) * u_opacity;
  }
`;class Gn{constructor(e){this.gl_=e.webGlContext;const t=this.gl_;this.scaleRatio_=e.scaleRatio||1,this.renderTargetTexture_=t.createTexture(),this.renderTargetTextureSize_=null,this.frameBuffer_=t.createFramebuffer(),this.depthBuffer_=t.createRenderbuffer();const r=t.createShader(t.VERTEX_SHADER);t.shaderSource(r,e.vertexShader||hd),t.compileShader(r);const n=t.createShader(t.FRAGMENT_SHADER);t.shaderSource(n,e.fragmentShader||dd),t.compileShader(n),this.renderTargetProgram_=t.createProgram(),t.attachShader(this.renderTargetProgram_,r),t.attachShader(this.renderTargetProgram_,n),t.linkProgram(this.renderTargetProgram_),this.renderTargetVerticesBuffer_=t.createBuffer();const s=[-1,-1,1,-1,-1,1,1,-1,1,1,-1,1];t.bindBuffer(t.ARRAY_BUFFER,this.renderTargetVerticesBuffer_),t.bufferData(t.ARRAY_BUFFER,new Float32Array(s),t.STATIC_DRAW),this.renderTargetAttribLocation_=t.getAttribLocation(this.renderTargetProgram_,"a_position"),this.renderTargetUniformLocation_=t.getUniformLocation(this.renderTargetProgram_,"u_screenSize"),this.renderTargetOpacityLocation_=t.getUniformLocation(this.renderTargetProgram_,"u_opacity"),this.renderTargetTextureLocation_=t.getUniformLocation(this.renderTargetProgram_,"u_image"),this.uniforms_=[],e.uniforms&&Object.keys(e.uniforms).forEach(o=>{this.uniforms_.push({value:e.uniforms[o],location:t.getUniformLocation(this.renderTargetProgram_,o)})})}getRenderTargetTexture(){return this.renderTargetTexture_}getGL(){return this.gl_}init(e){const t=this.getGL(),r=[t.drawingBufferWidth*this.scaleRatio_,t.drawingBufferHeight*this.scaleRatio_];if(t.bindFramebuffer(t.FRAMEBUFFER,this.getFrameBuffer()),t.bindRenderbuffer(t.RENDERBUFFER,this.getDepthBuffer()),t.viewport(0,0,r[0],r[1]),!this.renderTargetTextureSize_||this.renderTargetTextureSize_[0]!==r[0]||this.renderTargetTextureSize_[1]!==r[1]){this.renderTargetTextureSize_=r;const n=0,s=t.RGBA,o=0,a=t.RGBA,l=t.UNSIGNED_BYTE,c=null;t.bindTexture(t.TEXTURE_2D,this.renderTargetTexture_),t.texImage2D(t.TEXTURE_2D,n,s,r[0],r[1],o,a,l,c),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.renderTargetTexture_,0),t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT16,r[0],r[1]),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,this.depthBuffer_)}}apply(e,t,r,n){const s=this.getGL(),o=e.size;if(s.bindFramebuffer(s.FRAMEBUFFER,t?t.getFrameBuffer():null),s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,this.renderTargetTexture_),!t){const l=J(s.canvas);if(!e.renderTargets[l]){const c=s.getContextAttributes();c&&c.preserveDrawingBuffer&&(s.clearColor(0,0,0,0),s.clearDepth(1),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT)),e.renderTargets[l]=!0}}s.disable(s.DEPTH_TEST),s.enable(s.BLEND),s.blendFunc(s.ONE,s.ONE_MINUS_SRC_ALPHA),s.viewport(0,0,s.drawingBufferWidth,s.drawingBufferHeight),s.bindBuffer(s.ARRAY_BUFFER,this.renderTargetVerticesBuffer_),s.useProgram(this.renderTargetProgram_),s.enableVertexAttribArray(this.renderTargetAttribLocation_),s.vertexAttribPointer(this.renderTargetAttribLocation_,2,s.FLOAT,!1,0,0),s.uniform2f(this.renderTargetUniformLocation_,o[0],o[1]),s.uniform1i(this.renderTargetTextureLocation_,0);const a=e.layerStatesArray[e.layerIndex].opacity;s.uniform1f(this.renderTargetOpacityLocation_,a),this.applyUniforms(e),r&&r(s,e),s.drawArrays(s.TRIANGLES,0,6),n&&n(s,e)}getFrameBuffer(){return this.frameBuffer_}getDepthBuffer(){return this.depthBuffer_}applyUniforms(e){const t=this.getGL();let r,n=1;this.uniforms_.forEach(function(s){if(r=typeof s.value=="function"?s.value(e):s.value,r instanceof HTMLCanvasElement||r instanceof ImageData)s.texture||(s.texture=t.createTexture()),t.activeTexture(t[`TEXTURE${n}`]),t.bindTexture(t.TEXTURE_2D,s.texture),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),r instanceof ImageData?t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,r.width,r.height,0,t.UNSIGNED_BYTE,new Uint8Array(r.data)):t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,r),t.uniform1i(s.location,n++);else if(Array.isArray(r))switch(r.length){case 2:t.uniform2f(s.location,r[0],r[1]);return;case 3:t.uniform3f(s.location,r[0],r[1],r[2]);return;case 4:t.uniform4f(s.location,r[0],r[1],r[2],r[3]);return;default:return}else typeof r=="number"&&t.uniform1f(s.location,r)})}}const De={PROJECTION_MATRIX:"u_projectionMatrix",SCREEN_TO_WORLD_MATRIX:"u_screenToWorldMatrix",TIME:"u_time",ZOOM:"u_zoom",RESOLUTION:"u_resolution",ROTATION:"u_rotation",VIEWPORT_SIZE_PX:"u_viewportSizePx",PIXEL_RATIO:"u_pixelRatio",HIT_DETECTION:"u_hitDetection"},de={UNSIGNED_BYTE:od,UNSIGNED_SHORT:ad,UNSIGNED_INT:ld,FLOAT:ks},Rr={};function Un(i){return"shared/"+i}let Bn=0;function fd(){const i="unique/"+Bn;return Bn+=1,i}function gd(i){let e=Rr[i];if(!e){const t=document.createElement("canvas");t.width=1,t.height=1,t.style.position="absolute",t.style.left="0",e={users:0,context:cd(t)},Rr[i]=e}return e.users+=1,e.context}function pd(i){const e=Rr[i];if(!e||(e.users-=1,e.users>0))return;const t=e.context,r=t.getExtension("WEBGL_lose_context");r&&r.loseContext();const n=t.canvas;n.width=1,n.height=1,delete Rr[i]}class md extends as{constructor(e){super(),e=e||{},this.boundHandleWebGLContextLost_=this.handleWebGLContextLost.bind(this),this.boundHandleWebGLContextRestored_=this.handleWebGLContextRestored.bind(this),this.canvasCacheKey_=e.canvasCacheKey?Un(e.canvasCacheKey):fd(),this.gl_=gd(this.canvasCacheKey_),this.bufferCache_={},this.extensionCache_={},this.currentProgram_=null,this.needsToBeRecreated_=!1;const t=this.gl_.canvas;t.addEventListener(or.LOST,this.boundHandleWebGLContextLost_),t.addEventListener(or.RESTORED,this.boundHandleWebGLContextRestored_),this.offsetRotateMatrix_=_e(),this.offsetScaleMatrix_=_e(),this.tmpMat4_=mt(),this.uniformLocationsByProgram_={},this.attribLocationsByProgram_={},this.uniforms_=[],e.uniforms&&this.setUniforms(e.uniforms),this.postProcessPasses_=e.postProcesses?e.postProcesses.map(r=>new Gn({webGlContext:this.gl_,scaleRatio:r.scaleRatio,vertexShader:r.vertexShader,fragmentShader:r.fragmentShader,uniforms:r.uniforms})):[new Gn({webGlContext:this.gl_})],this.shaderCompileErrors_=null,this.startTime_=Date.now(),this.maxAttributeCount_=this.gl_.getParameter(this.gl_.MAX_VERTEX_ATTRIBS)}setUniforms(e){this.uniforms_=[],this.addUniforms(e)}addUniforms(e){for(const t in e)this.uniforms_.push({name:t,value:e[t]})}canvasCacheKeyMatches(e){return this.canvasCacheKey_===Un(e)}getExtension(e){if(e in this.extensionCache_)return this.extensionCache_[e];const t=this.gl_.getExtension(e);return this.extensionCache_[e]=t,t}getInstancedRenderingExtension_(){const e=this.getExtension("ANGLE_instanced_arrays");return be(!!e,"WebGL extension 'ANGLE_instanced_arrays' is required for vector rendering"),e}bindBuffer(e){const t=this.gl_,r=J(e);let n=this.bufferCache_[r];if(!n){const s=t.createBuffer();n={buffer:e,webGlBuffer:s},this.bufferCache_[r]=n}t.bindBuffer(e.getType(),n.webGlBuffer)}flushBufferData(e){const t=this.gl_;this.bindBuffer(e),t.bufferData(e.getType(),e.getArray(),e.getUsage())}deleteBuffer(e){const t=J(e);delete this.bufferCache_[t]}disposeInternal(){const e=this.gl_.canvas;e.removeEventListener(or.LOST,this.boundHandleWebGLContextLost_),e.removeEventListener(or.RESTORED,this.boundHandleWebGLContextRestored_),pd(this.canvasCacheKey_),delete this.gl_}prepareDraw(e,t,r){const n=this.gl_,s=this.getCanvas(),o=e.size,a=e.pixelRatio;(s.width!==o[0]*a||s.height!==o[1]*a)&&(s.width=o[0]*a,s.height=o[1]*a,s.style.width=o[0]+"px",s.style.height=o[1]+"px");for(let l=this.postProcessPasses_.length-1;l>=0;l--)this.postProcessPasses_[l].init(e);n.bindTexture(n.TEXTURE_2D,null),n.clearColor(0,0,0,0),n.depthRange(0,1),n.clearDepth(1),n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT),n.enable(n.BLEND),n.blendFunc(n.ONE,t?n.ZERO:n.ONE_MINUS_SRC_ALPHA),r?(n.enable(n.DEPTH_TEST),n.depthFunc(n.LEQUAL)):n.disable(n.DEPTH_TEST)}bindFrameBuffer(e,t){const r=this.getGL();r.bindFramebuffer(r.FRAMEBUFFER,e),t&&r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,t,0)}bindInitialFrameBuffer(){const e=this.getGL(),t=this.postProcessPasses_[0].getFrameBuffer();e.bindFramebuffer(e.FRAMEBUFFER,t);const r=this.postProcessPasses_[0].getRenderTargetTexture();e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,r,0)}bindTexture(e,t,r){const n=this.gl_;n.activeTexture(n.TEXTURE0+t),n.bindTexture(n.TEXTURE_2D,e),n.uniform1i(this.getUniformLocation(r),t)}bindAttribute(e,t,r){const n=this.getGL();this.bindBuffer(e);const s=this.getAttributeLocation(t);n.enableVertexAttribArray(s),n.vertexAttribPointer(s,r,n.FLOAT,!1,0,0)}prepareDrawToRenderTarget(e,t,r,n){const s=this.gl_,o=t.getSize();s.bindFramebuffer(s.FRAMEBUFFER,t.getFramebuffer()),s.bindRenderbuffer(s.RENDERBUFFER,t.getDepthbuffer()),s.viewport(0,0,o[0],o[1]),s.bindTexture(s.TEXTURE_2D,t.getTexture()),s.clearColor(0,0,0,0),s.depthRange(0,1),s.clearDepth(1),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT),s.enable(s.BLEND),s.blendFunc(s.ONE,r?s.ZERO:s.ONE_MINUS_SRC_ALPHA),n?(s.enable(s.DEPTH_TEST),s.depthFunc(s.LEQUAL)):s.disable(s.DEPTH_TEST)}drawElements(e,t){const r=this.gl_;this.getExtension("OES_element_index_uint");const n=r.UNSIGNED_INT,s=4,o=t-e,a=e*s;r.drawElements(r.TRIANGLES,o,n,a)}drawElementsInstanced(e,t,r){const n=this.gl_;this.getExtension("OES_element_index_uint");const s=this.getInstancedRenderingExtension_(),o=n.UNSIGNED_INT,a=4,l=t-e,c=e*a;s.drawElementsInstancedANGLE(n.TRIANGLES,l,o,c,r);for(let u=0;u<this.maxAttributeCount_;u++)s.vertexAttribDivisorANGLE(u,0)}finalizeDraw(e,t,r){for(let n=0,s=this.postProcessPasses_.length;n<s;n++)n===s-1?this.postProcessPasses_[n].apply(e,null,t,r):this.postProcessPasses_[n].apply(e,this.postProcessPasses_[n+1])}getCanvas(){return this.gl_.canvas}getGL(){return this.gl_}applyFrameState(e){const t=e.size,r=e.viewState.rotation,n=e.pixelRatio;this.setUniformFloatValue(De.TIME,(Date.now()-this.startTime_)*.001),this.setUniformFloatValue(De.ZOOM,e.viewState.zoom),this.setUniformFloatValue(De.RESOLUTION,e.viewState.resolution),this.setUniformFloatValue(De.PIXEL_RATIO,n),this.setUniformFloatVec2(De.VIEWPORT_SIZE_PX,[t[0],t[1]]),this.setUniformFloatValue(De.ROTATION,r)}applyHitDetectionUniform(e){const t=this.getUniformLocation(De.HIT_DETECTION);this.getGL().uniform1i(t,e?1:0),e&&this.setUniformFloatValue(De.PIXEL_RATIO,.5)}applyUniforms(e){const t=this.gl_;let r,n=0;this.uniforms_.forEach(s=>{if(r=typeof s.value=="function"?s.value(e):s.value,r instanceof HTMLCanvasElement||r instanceof HTMLImageElement||r instanceof ImageData||r instanceof WebGLTexture){r instanceof WebGLTexture&&!s.texture?(s.prevValue=void 0,s.texture=r):s.texture||(s.prevValue=void 0,s.texture=t.createTexture()),this.bindTexture(s.texture,n,s.name),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE);const o=!(r instanceof HTMLImageElement)||r.complete;!(r instanceof WebGLTexture)&&o&&s.prevValue!==r&&(s.prevValue=r,t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,r)),n++}else if(Array.isArray(r)&&r.length===6)this.setUniformMatrixValue(s.name,xr(this.tmpMat4_,r));else if(Array.isArray(r)&&r.length<=4)switch(r.length){case 2:t.uniform2f(this.getUniformLocation(s.name),r[0],r[1]);return;case 3:t.uniform3f(this.getUniformLocation(s.name),r[0],r[1],r[2]);return;case 4:t.uniform4f(this.getUniformLocation(s.name),r[0],r[1],r[2],r[3]);return;default:return}else typeof r=="number"&&t.uniform1f(this.getUniformLocation(s.name),r)})}useProgram(e,t){this.disableAllAttributes_(),this.gl_.useProgram(e),this.currentProgram_=e,t&&(this.applyFrameState(t),this.applyUniforms(t))}compileShader(e,t){const r=this.gl_,n=r.createShader(t);return r.shaderSource(n,e),r.compileShader(n),n}getProgram(e,t){const r=this.gl_,n=this.compileShader(e,r.FRAGMENT_SHADER),s=this.compileShader(t,r.VERTEX_SHADER),o=r.createProgram();if(r.attachShader(o,n),r.attachShader(o,s),r.linkProgram(o),!r.getShaderParameter(n,r.COMPILE_STATUS)){const a=`Fragment shader compilation failed: ${r.getShaderInfoLog(n)}`;throw new Error(a)}if(r.deleteShader(n),!r.getShaderParameter(s,r.COMPILE_STATUS)){const a=`Vertex shader compilation failed: ${r.getShaderInfoLog(s)}`;throw new Error(a)}if(r.deleteShader(s),!r.getProgramParameter(o,r.LINK_STATUS)){const a=`GL program linking failed: ${r.getProgramInfoLog(o)}`;throw new Error(a)}return o}getUniformLocation(e){const t=J(this.currentProgram_);return this.uniformLocationsByProgram_[t]===void 0&&(this.uniformLocationsByProgram_[t]={}),this.uniformLocationsByProgram_[t][e]===void 0&&(this.uniformLocationsByProgram_[t][e]=this.gl_.getUniformLocation(this.currentProgram_,e)),this.uniformLocationsByProgram_[t][e]}getAttributeLocation(e){const t=J(this.currentProgram_);return this.attribLocationsByProgram_[t]===void 0&&(this.attribLocationsByProgram_[t]={}),this.attribLocationsByProgram_[t][e]===void 0&&(this.attribLocationsByProgram_[t][e]=this.gl_.getAttribLocation(this.currentProgram_,e)),this.attribLocationsByProgram_[t][e]}makeProjectionTransform(e,t){const r=e.size,n=e.viewState.rotation,s=e.viewState.resolution,o=e.viewState.center;return pi(t,0,0,2/(s*r[0]),2/(s*r[1]),-n,-o[0],-o[1]),t}setUniformFloatValue(e,t){this.gl_.uniform1f(this.getUniformLocation(e),t)}setUniformFloatVec2(e,t){this.gl_.uniform2fv(this.getUniformLocation(e),t)}setUniformFloatVec4(e,t){this.gl_.uniform4fv(this.getUniformLocation(e),t)}setUniformMatrixValue(e,t){this.gl_.uniformMatrix4fv(this.getUniformLocation(e),!1,t)}disableAllAttributes_(){for(let e=0;e<this.maxAttributeCount_;e++)this.gl_.disableVertexAttribArray(e)}enableAttributeArray_(e,t,r,n,s,o){const a=this.getAttributeLocation(e);a<0||(this.gl_.enableVertexAttribArray(a),this.gl_.vertexAttribPointer(a,t,r,!1,n,s),o&&this.getInstancedRenderingExtension_().vertexAttribDivisorANGLE(a,1))}enableAttributes_(e,t){const r=_d(e);let n=0;for(let s=0;s<e.length;s++){const o=e[s];o.name&&this.enableAttributeArray_(o.name,o.size,o.type||ks,r,n,t),n+=o.size*js(o.type)}}enableAttributes(e){this.enableAttributes_(e,!1)}enableAttributesInstanced(e){this.enableAttributes_(e,!0)}handleWebGLContextLost(e){Ho(this.bufferCache_),this.currentProgram_=null,e.preventDefault()}handleWebGLContextRestored(){this.needsToBeRecreated_=!0}needsToBeRecreated(){return this.needsToBeRecreated_}createTexture(e,t,r,n){const s=this.gl_;r=r||s.createTexture();const o=n?s.NEAREST:s.LINEAR;s.bindTexture(s.TEXTURE_2D,r),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,o),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,o),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE);const a=0,l=s.RGBA,c=0,u=s.RGBA,h=s.UNSIGNED_BYTE;return t instanceof Uint8Array?s.texImage2D(s.TEXTURE_2D,a,l,e[0],e[1],c,u,h,t):t?s.texImage2D(s.TEXTURE_2D,a,l,u,h,t):s.texImage2D(s.TEXTURE_2D,a,l,e[0],e[1],c,u,h,null),r}}function _d(i){let e=0;for(let t=0;t<i.length;t++){const r=i[t];e+=r.size*js(r.type)}return e}function js(i){switch(i){case de.UNSIGNED_BYTE:return Uint8Array.BYTES_PER_ELEMENT;case de.UNSIGNED_SHORT:return Uint16Array.BYTES_PER_ELEMENT;case de.UNSIGNED_INT:return Uint32Array.BYTES_PER_ELEMENT;case de.FLOAT:default:return Float32Array.BYTES_PER_ELEMENT}}class Ed extends Vo{constructor(e){super(),this.tile,this.handleTileChange_=this.handleTileChange_.bind(this),this.gutter=e.gutter||0,this.helper=e.helper,this.loaded=!1,this.ready=!1}setTile(e){if(e!==this.tile)if(this.tile&&this.tile.removeEventListener(xe.CHANGE,this.handleTileChange_),this.tile=e,this.loaded=e.getState()===V.LOADED,this.loaded)this.uploadTile();else{if(e instanceof mi){const t=e.getImage();t instanceof Image&&!t.crossOrigin&&(t.crossOrigin="anonymous")}e.addEventListener(xe.CHANGE,this.handleTileChange_)}}uploadTile(){ke()}setReady(){this.ready=!0,this.dispatchEvent(xe.CHANGE)}handleTileChange_(){this.tile.getState()===V.LOADED&&(this.loaded=!0,this.uploadTile())}setHelper(e){this.helper=e,this.helper&&this.loaded&&this.uploadTile()}disposeInternal(){this.setHelper(null),this.tile.removeEventListener(xe.CHANGE,this.handleTileChange_)}}function Ws(i,e,t){const r=t?i.LINEAR:i.NEAREST;i.bindTexture(i.TEXTURE_2D,e),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,r),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,r)}function yd(i,e,t,r){Ws(i,e,r),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,t)}function zn(i,e,t,r,n,s){const o=i.getGL();let a,l;t instanceof Float32Array?(a=o.FLOAT,i.getExtension("OES_texture_float"),l=i.getExtension("OES_texture_float_linear")!==null):(a=o.UNSIGNED_BYTE,l=!0),Ws(o,e,s&&l);const c=t.byteLength/r[1];let u=1;c%8===0?u=8:c%4===0?u=4:c%2===0&&(u=2);let h;switch(n){case 1:{h=o.LUMINANCE;break}case 2:{h=o.LUMINANCE_ALPHA;break}case 3:{h=o.RGB;break}case 4:{h=o.RGBA;break}default:throw new Error(`Unsupported number of bands: ${n}`)}const f=o.getParameter(o.UNPACK_ALIGNMENT);o.pixelStorei(o.UNPACK_ALIGNMENT,u),o.texImage2D(o.TEXTURE_2D,0,h,r[0],r[1],0,h,a,t),o.pixelStorei(o.UNPACK_ALIGNMENT,f)}let Rt=null;function Td(){Rt=nt(1,1,void 0,{willReadFrequently:!0})}class xd extends Ed{constructor(e){super(e),this.textures=[],this.renderSize_=Ne(e.grid.getTileSize(e.tile.tileCoord[0])),this.bandCount=NaN;const t=new tt(ft,Bi);t.fromArray([0,1,1,1,1,0,0,0]),this.helper.flushBufferData(t),this.coords=t,this.setTile(e.tile)}setHelper(e){var r;const t=(r=this.helper)==null?void 0:r.getGL();if(t){this.helper.deleteBuffer(this.coords);for(let n=0;n<this.textures.length;++n)t.deleteTexture(this.textures[n])}super.setHelper(e),e&&e.flushBufferData(this.coords)}uploadTile(){const e=this.helper,t=e.getGL(),r=this.tile;this.textures.length=0;let n;r instanceof mi||r instanceof Yo?n=r.getImage():n=r.getData();const s=Kr(n);if(s){const T=t.createTexture();this.textures.push(T),this.bandCount=4,yd(t,T,s,r.interpolate),this.setReady();return}n=qr(n);const o=r.getSize(),a=[o[0]+2*this.gutter,o[1]+2*this.gutter],l=n instanceof Float32Array,c=a[0]*a[1],u=l?Float32Array:Uint8Array,h=u.BYTES_PER_ELEMENT,f=n.byteLength/a[1];this.bandCount=Math.floor(f/h/a[0]);const g=Math.ceil(this.bandCount/4);if(g===1){const T=t.createTexture();this.textures.push(T),zn(e,T,n,a,this.bandCount,r.interpolate),this.setReady();return}const d=new Array(g);for(let T=0;T<g;++T){const x=t.createTexture();this.textures.push(x);const S=T<g-1?4:(this.bandCount-1)%4+1;d[T]=new u(c*S)}let m=0,_=0;const y=a[0]*this.bandCount;for(let T=0;T<a[1];++T){for(let x=0;x<y;++x){const S=n[_+x],P=Math.floor(m/this.bandCount),R=x%this.bandCount,v=Math.floor(R/4),F=d[v],C=F.length/c,w=R%4;F[P*C+w]=S,++m}_+=f/h}for(let T=0;T<g;++T){const x=this.textures[T],S=d[T],P=S.length/c;zn(e,x,S,a,P,r.interpolate)}this.setReady()}getImagePixelData_(e,t,r){const n=this.gutter,s=this.renderSize_[0],o=this.renderSize_[1];Rt||Td(),Rt.clearRect(0,0,1,1);const a=e.width,l=e.height,c=a-2*n,u=l-2*n,h=n+Math.floor(c*(t/s)),f=n+Math.floor(u*(r/o));let g;try{Rt.drawImage(e,h,f,1,1,0,0,1,1),g=Rt.getImageData(0,0,1,1).data}catch{return Rt=null,null}return g}getArrayPixelData_(e,t,r,n){const s=this.gutter,o=this.renderSize_[0],a=this.renderSize_[1],l=t[0],c=t[1],u=l+2*s,h=c+2*s,f=s+Math.floor(l*(r/o)),g=s+Math.floor(c*(n/a));if(e instanceof DataView){const m=e.byteLength/(u*h),_=m*(g*u+f),y=e.buffer.slice(_,_+m);return new DataView(y)}const d=this.bandCount*(g*u+f);return e.slice(d,d+this.bandCount)}getPixelData(e,t){if(!this.loaded)return null;if(this.tile instanceof _i){const r=this.tile.getData(),n=qr(r);if(n){const s=this.tile.getSize();return this.getArrayPixelData_(n,s,e,t)}return this.getImagePixelData_(Kr(r),e,t)}return this.getImagePixelData_(this.tile.getImage(),e,t)}}class tr extends qo{constructor(e,t){super(e),t=t||{},this.inversePixelTransform_=_e(),this.postProcesses_=t.postProcesses,this.uniforms_=t.uniforms,this.helper,this.onMapChanged_=()=>{this.clearCache(),this.removeHelper()},e.addChangeListener(Jr.MAP,this.onMapChanged_),this.dispatchPreComposeEvent=this.dispatchPreComposeEvent.bind(this),this.dispatchPostComposeEvent=this.dispatchPostComposeEvent.bind(this)}dispatchPreComposeEvent(e,t){const r=this.getLayer();if(r.hasListener(lt.PRECOMPOSE)){const n=new zr(lt.PRECOMPOSE,void 0,t,e);r.dispatchEvent(n)}}dispatchPostComposeEvent(e,t){const r=this.getLayer();if(r.hasListener(lt.POSTCOMPOSE)){const n=new zr(lt.POSTCOMPOSE,void 0,t,e);r.dispatchEvent(n)}}reset(e){this.uniforms_=e.uniforms,this.helper&&this.helper.setUniforms(this.uniforms_)}removeHelper(){this.helper&&(this.helper.dispose(),delete this.helper)}prepareFrame(e){if(this.getLayer().getRenderSource()){let t=!0,r=-1,n;for(let o=0,a=e.layerStatesArray.length;o<a;o++){const l=e.layerStatesArray[o].layer,c=l.getRenderer();if(!(c instanceof tr)){t=!0;continue}const u=l.getClassName();if((t||u!==n)&&(r+=1,t=!1),n=u,c===this)break}const s="map/"+e.mapId+"/group/"+r;(!this.helper||!this.helper.canvasCacheKeyMatches(s)||this.helper.needsToBeRecreated())&&(this.removeHelper(),this.helper=new md({postProcesses:this.postProcesses_,uniforms:this.uniforms_,canvasCacheKey:s}),n&&(this.helper.getCanvas().className=n),this.afterHelperCreated())}return this.prepareFrameInternal(e)}afterHelperCreated(){}prepareFrameInternal(e){return!0}clearCache(){}disposeInternal(){var e;this.clearCache(),this.removeHelper(),(e=this.getLayer())==null||e.removeChangeListener(Jr.MAP,this.onMapChanged_),super.disposeInternal()}dispatchRenderEvent_(e,t,r){const n=this.getLayer();if(n.hasListener(e)){pi(this.inversePixelTransform_,0,0,r.pixelRatio,-r.pixelRatio,0,0,-r.size[1]);const s=new zr(e,this.inversePixelTransform_,r,t);n.dispatchEvent(s)}}preRender(e,t){this.dispatchRenderEvent_(lt.PRERENDER,e,t)}postRender(e,t){this.dispatchRenderEvent_(lt.POSTRENDER,e,t)}}const Rd={TILE_TRANSFORM:"u_tileTransform",TRANSITION_ALPHA:"u_transitionAlpha",DEPTH:"u_depth",RENDER_EXTENT:"u_renderExtent",PATTERN_ORIGIN:"u_patternOrigin",RESOLUTION:"u_resolution",ZOOM:"u_zoom",GLOBAL_ALPHA:"u_globalAlpha",PROJECTION_MATRIX:"u_projectionMatrix",SCREEN_TO_WORLD_MATRIX:"u_screenToWorldMatrix"};function $n(i){return 1/(i+2)}function Sd(){return{tileIds:new Set,representationsByZ:{}}}function Xn(i,e){return i.tileIds.has(J(e))}function kn(i,e,t){const r=i.representationsByZ;t in r||(r[t]=new Set),r[t].add(e),i.tileIds.add(J(e.tile))}function Xr(i,e){const t=i.layerStatesArray[i.layerIndex];t.extent&&(e=Ue(e,cs(t.extent,i.viewState.projection)));const r=t.layer.getRenderSource();if(!r.getWrapX()){const n=r.getTileGridForProjection(i.viewState.projection).getExtent();n&&(e=Ue(e,n))}return e}function si(i,e){return`${J(i)},${i.getKey()},${i.getRevision()},${xt(e)}`}class Pd extends tr{constructor(e,t){super(e,{uniforms:t.uniforms,postProcesses:t.postProcesses}),this.renderComplete=!1,this.tileTransform_=_e(),this.tempMat4=mt(),this.tempTileRange_=new Ko(0,0,0,0),this.tempTileCoord_=Qr(0,0,0),this.tempSize_=[0,0];const r=t.cacheSize!==void 0?t.cacheSize:512;this.tileRepresentationCache=new ls(r),this.frameState=null,this.renderedProjection_=void 0}reset(e){super.reset({uniforms:e.uniforms})}prepareFrameInternal(e){this.renderedProjection_?e.viewState.projection!==this.renderedProjection_&&(this.clearCache(),this.renderedProjection_=e.viewState.projection):this.renderedProjection_=e.viewState.projection;const r=this.getLayer().getRenderSource();return!r||gi(Xr(e,e.extent))?!1:r.getState()==="ready"}createTileRepresentation(e){return ke()}enqueueTiles(e,t,r,n,s){const o=e.viewState,a=this.getLayer(),l=a.getRenderSource(),c=l.getTileGridForProjection(o.projection),u=l.getGutterForProjection(o.projection),h=J(l);h in e.wantedTiles||(e.wantedTiles[h]={});const f=e.wantedTiles[h],g=this.tileRepresentationCache,d=a.getMapInternal(),m=Math.max(r-s,c.getMinZoom(),c.getZForResolution(Math.min(a.getMaxResolution(),d?d.getView().getResolutionForZoom(Math.max(a.getMinZoom(),0)):c.getResolution(0)),l.zDirection)),_=o.rotation,y=_?Jo(o.center,o.resolution,_,e.size):void 0;for(let T=r;T>=m;--T){const x=c.getTileRangeForExtentAndZ(t,T,this.tempTileRange_),S=c.getResolution(T);for(let P=x.minX;P<=x.maxX;++P)for(let R=x.minY;R<=x.maxY;++R){if(_&&!c.tileCoordIntersectsViewport([T,P,R],y))continue;const v=Qr(T,P,R,this.tempTileCoord_),F=si(l,v);let C,w;if(g.containsKey(F)&&(C=g.get(F),w=C.tile),(!C||C.tile.key!==l.getKey())&&(w=l.getTile(T,P,R,e.pixelRatio,o.projection),!w)||Xn(n,w))continue;C?C.setTile(w):(C=this.createTileRepresentation({tile:w,grid:c,helper:this.helper,gutter:u}),g.set(F,C)),kn(n,C,T);const U=w.getKey();f[U]=!0,w.getState()===V.IDLE&&(e.tileQueue.isKeyQueued(U)||e.tileQueue.enqueue([w,h,c.getTileCoordCenter(v),S]))}}}beforeTilesRender(e,t){this.helper.prepareDraw(this.frameState,!t,!0)}beforeTilesMaskRender(e){return!1}renderTile(e,t,r,n,s,o,a,l,c,u,h){}renderTileMask(e,t,r,n){}drawTile_(e,t,r,n,s,o,a){if(!t.ready)return;const c=t.tile.tileCoord,u=xt(c),h=u in o?o[u]:1,f=a.getResolution(r),g=Ne(a.getTileSize(r),this.tempSize_),d=a.getOrigin(r),m=a.getTileCoordExtent(c),_=h<1?-1:$n(r);h<1&&(e.animate=!0);const y=e.viewState,T=y.center[0],x=y.center[1],S=g[0]+2*n,P=g[1]+2*n,R=S/P,v=(T-d[0])/(g[0]*f),F=(d[1]-x)/(g[1]*f),C=y.resolution/f,w=c[1],U=c[2];Qo(this.tileTransform_),en(this.tileTransform_,2/(e.size[0]*C/S),-2/(e.size[1]*C/S)),ea(this.tileTransform_,y.rotation),en(this.tileTransform_,1,1/R),Ei(this.tileTransform_,(g[0]*(w-v)-n)/S,(g[1]*(U-F)-n)/P),this.renderTile(t,this.tileTransform_,e,s,f,g,d,m,_,n,h)}renderFrame(e){this.frameState=e,this.renderComplete=!0;const t=this.helper.getGL();this.preRender(t,e);const r=e.viewState,n=this.getLayer(),s=n.getRenderSource(),o=s.getTileGridForProjection(r.projection),a=s.getGutterForProjection(r.projection),l=Xr(e,e.extent),c=o.getZForResolution(r.resolution,s.zDirection),u=Sd(),h=n.getPreload();if(e.nextExtent){const x=o.getZForResolution(r.nextResolution,s.zDirection),S=Xr(e,e.nextExtent);this.enqueueTiles(e,S,x,u,h)}this.enqueueTiles(e,l,c,u,0),h>0&&setTimeout(()=>{this.enqueueTiles(e,l,c-1,u,h-1)},0);const f={};let g=!1;const d=u.representationsByZ;if(c in d){const x=J(this),S=e.time;for(const P of d[c]){const R=P.tile;if(R.getState()===V.EMPTY)continue;const v=R.tileCoord;if(P.ready){const w=R.getAlpha(x,S);if(w===1){R.endTransition(x);continue}g=!0;const U=xt(v);f[U]=w}if(this.renderComplete=!1,this.findAltTiles_(o,v,c+1,u))continue;const C=o.getMinZoom();for(let w=c-1;w>=C&&!this.findAltTiles_(o,v,w,u);--w);}}const m=Object.keys(d).map(Number).sort(ta);if(this.beforeTilesMaskRender(e))for(let x=0,S=m.length;x<S;++x){const P=m[x];for(const R of d[P]){const v=R.tile.tileCoord;if(xt(v)in f)continue;const C=o.getTileCoordExtent(v);this.renderTileMask(R,P,C,$n(P))}}this.beforeTilesRender(e,g);for(let x=0,S=m.length;x<S;++x){const P=m[x];for(const R of d[P]){const v=R.tile.tileCoord;xt(v)in f||this.drawTile_(e,R,P,a,l,f,o)}}if(c in d)for(const x of d[c]){const S=x.tile.tileCoord;xt(S)in f&&this.drawTile_(e,x,c,a,l,f,o)}this.beforeFinalize(e),this.helper.finalizeDraw(e,this.dispatchPreComposeEvent,this.dispatchPostComposeEvent);const y=this.helper.getCanvas();return this.tileRepresentationCache.expireCache(),this.postRender(t,e),y}beforeFinalize(e){}findAltTiles_(e,t,r,n){const s=e.getTileRangeForTileCoordAndZ(t,r,this.tempTileRange_);if(!s)return!1;let o=!0;const a=this.tileRepresentationCache,l=this.getLayer().getRenderSource();for(let c=s.minX;c<=s.maxX;++c)for(let u=s.minY;u<=s.maxY;++u){const h=si(l,[r,c,u]);let f=!1;if(a.containsKey(h)){const g=a.get(h);g.ready&&!Xn(n,g.tile)&&(kn(n,g,r),f=!0)}f||(o=!1)}return o}clearCache(){super.clearCache();const e=this.tileRepresentationCache;e.forEach(t=>t.dispose()),e.clear()}afterHelperCreated(){super.afterHelperCreated(),this.tileRepresentationCache.forEach(e=>e.setHelper(this.helper))}disposeInternal(){super.disposeInternal(),delete this.frameState}}const X={...Rd,TILE_TEXTURE_ARRAY:"u_tileTextures",TEXTURE_PIXEL_WIDTH:"u_texturePixelWidth",TEXTURE_PIXEL_HEIGHT:"u_texturePixelHeight",TEXTURE_RESOLUTION:"u_textureResolution",TEXTURE_ORIGIN_X:"u_textureOriginX",TEXTURE_ORIGIN_Y:"u_textureOriginY"},lr={TEXTURE_COORD:"a_textureCoord"},wd=[{name:lr.TEXTURE_COORD,size:2,type:de.FLOAT}];class Ld extends Pd{constructor(e,t){super(e,t),this.program_,this.vertexShader_=t.vertexShader,this.fragmentShader_=t.fragmentShader,this.indices_=new tt(er,Bi),this.indices_.fromArray([0,1,3,1,2,3]),this.paletteTextures_=t.paletteTextures||[]}reset(e){if(super.reset(e),this.helper){const t=this.helper.getGL();for(const r of this.paletteTextures_)r.delete(t)}if(this.vertexShader_=e.vertexShader,this.fragmentShader_=e.fragmentShader,this.paletteTextures_=e.paletteTextures||[],this.helper){this.program_=this.helper.getProgram(this.fragmentShader_,this.vertexShader_);const t=this.helper.getGL();for(const r of this.paletteTextures_)r.getTexture(t)}}afterHelperCreated(){super.afterHelperCreated();const e=this.helper.getGL();for(const t of this.paletteTextures_)t.getTexture(e);this.program_=this.helper.getProgram(this.fragmentShader_,this.vertexShader_),this.helper.flushBufferData(this.indices_)}removeHelper(){if(this.helper){const e=this.helper.getGL();for(const t of this.paletteTextures_)t.delete(e)}super.removeHelper()}createTileRepresentation(e){return new xd(e)}beforeTilesRender(e,t){super.beforeTilesRender(e,t),this.helper.useProgram(this.program_,e)}renderTile(e,t,r,n,s,o,a,l,c,u,h){const f=this.helper.getGL();this.helper.bindBuffer(e.coords),this.helper.bindBuffer(this.indices_),this.helper.enableAttributes(wd);let g=0;for(;g<e.textures.length;){const R=`${X.TILE_TEXTURE_ARRAY}[${g}]`;this.helper.bindTexture(e.textures[g],g,R),++g}for(let R=0;R<this.paletteTextures_.length;++R){const v=this.paletteTextures_[R],F=v.getTexture(f);this.helper.bindTexture(F,g,v.name),++g}const d=r.viewState,m=o[0]+2*u,_=o[1]+2*u,T=e.tile.tileCoord,x=T[1],S=T[2];this.helper.setUniformMatrixValue(X.TILE_TRANSFORM,xr(this.tempMat4,t)),this.helper.setUniformFloatValue(X.TRANSITION_ALPHA,h),this.helper.setUniformFloatValue(X.DEPTH,c);let P=n;u>0&&(P=l,Ue(P,n,P)),this.helper.setUniformFloatVec4(X.RENDER_EXTENT,P),this.helper.setUniformFloatValue(X.RESOLUTION,d.resolution),this.helper.setUniformFloatValue(X.ZOOM,d.zoom),this.helper.setUniformFloatValue(X.TEXTURE_PIXEL_WIDTH,m),this.helper.setUniformFloatValue(X.TEXTURE_PIXEL_HEIGHT,_),this.helper.setUniformFloatValue(X.TEXTURE_RESOLUTION,s),this.helper.setUniformFloatValue(X.TEXTURE_ORIGIN_X,a[0]+x*o[0]*s-u*s),this.helper.setUniformFloatValue(X.TEXTURE_ORIGIN_Y,a[1]-S*o[1]*s+u*s),this.helper.drawElements(0,this.indices_.getSize())}getData(e){if(!this.helper.getGL())return null;const r=this.frameState;if(!r)return null;const n=this.getLayer(),s=He(r.pixelToCoordinateTransform,e.slice()),o=r.viewState,a=n.getExtent();if(a&&!St(cs(a,o.projection),s))return null;const l=n.getSources(di([s]),o.resolution);let c,u,h;for(c=l.length-1;c>=0;--c)if(u=l[c],u.getState()==="ready"){if(h=u.getTileGridForProjection(o.projection),u.getWrapX())break;const g=h.getExtent();if(!g||St(g,s))break}if(c<0)return null;const f=this.tileRepresentationCache;for(let g=h.getZForResolution(o.resolution);g>=h.getMinZoom();--g){const d=h.getTileCoordForCoordAndZ(s,g),m=si(u,d);if(!f.containsKey(m))continue;const _=f.get(m);if(_.tile.getState()===V.EMPTY)return null;if(!_.loaded)continue;const T=h.getOrigin(g),x=Ne(h.getTileSize(g)),S=h.getResolution(g),P=(s[0]-T[0])/S-d[1]*x[0],R=(T[1]-s[1])/S-d[2]*x[1];return _.getPixelData(P,R)}return null}disposeInternal(){const e=this.helper;if(e){const t=e.getGL();for(const r of this.paletteTextures_)r.delete(t);this.paletteTextures_.length=0,t.deleteProgram(this.program_),delete this.program_,e.deleteBuffer(this.indices_)}super.disposeInternal(),delete this.indices_}}class vd{constructor(e,t){this.name=e,this.data=t,this.texture_=null}getTexture(e){if(!this.texture_){const t=e.createTexture();e.bindTexture(e.TEXTURE_2D,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,this.data.length/4,1,0,e.RGBA,e.UNSIGNED_BYTE,this.data),this.texture_=t}return this.texture_}delete(e){this.texture_&&e.deleteTexture(this.texture_),this.texture_=null}}function bd(i,e){return`operator_${i}_${Object.keys(e.functions).length}`}function rt(i){const e=i.toString();return e.includes(".")?e:e+".0"}function zi(i){if(i.length<2||i.length>4)throw new Error("`formatArray` can only output `vec2`, `vec3` or `vec4` arrays.");return`vec${i.length}(${i.map(rt).join(", ")})`}function cr(i){const e=Ht(i),t=e.length>3?e[3]:1;return zi([e[0]/255,e[1]/255,e[2]/255,t])}function Ad(i){const e=Ne(i);return zi(e)}const kr={};let Cd=0;function vt(i){return i in kr||(kr[i]=Cd++),kr[i]}function je(i){return rt(vt(i))}function Dr(i){return"u_var_"+i}function $i(){return{variables:{},properties:{},functions:{},bandCount:0,featureId:!1,geometryType:!1}}const jr="getBandValue",Zs="u_paletteTextures",Hs="featureId",Vs="geometryType",oi=-9999999;function Id(i,e,t,r){const n=ra(i,e,t);return Xi(n,e,r)}function K(i){return(e,t,r)=>{const n=t.args.length,s=new Array(n);for(let o=0;o<n;++o)s[o]=Xi(t.args[o],r,e);return i(s,e)}}const Fd={[j.Get]:(i,e)=>{const r=e.args[0].value;r in i.properties||(i.properties[r]={name:r,type:e.type});let s="a_prop_"+r;return tn(e.type,Xt)&&(s=`(${s} > 0.0)`),s},[j.Id]:i=>(i.featureId=!0,"a_"+Hs),[j.GeometryType]:i=>(i.geometryType=!0,"a_"+Vs),[j.LineMetric]:()=>"currentLineMetric",[j.Var]:(i,e)=>{const r=e.args[0].value;r in i.variables||(i.variables[r]={name:r,type:e.type});let s=Dr(r);return tn(e.type,Xt)&&(s=`(${s} > 0.0)`),s},[j.Has]:(i,e)=>{const r=e.args[0].value;return r in i.properties||(i.properties[r]={name:r,type:e.type}),`(a_prop_${r} != ${rt(oi)})`},[j.Resolution]:()=>"u_resolution",[j.Zoom]:()=>"u_zoom",[j.Time]:()=>"u_time",[j.Any]:K(i=>`(${i.join(" || ")})`),[j.All]:K(i=>`(${i.join(" && ")})`),[j.Not]:K(([i])=>`(!${i})`),[j.Equal]:K(([i,e])=>`(${i} == ${e})`),[j.NotEqual]:K(([i,e])=>`(${i} != ${e})`),[j.GreaterThan]:K(([i,e])=>`(${i} > ${e})`),[j.GreaterThanOrEqualTo]:K(([i,e])=>`(${i} >= ${e})`),[j.LessThan]:K(([i,e])=>`(${i} < ${e})`),[j.LessThanOrEqualTo]:K(([i,e])=>`(${i} <= ${e})`),[j.Multiply]:K(i=>`(${i.join(" * ")})`),[j.Divide]:K(([i,e])=>`(${i} / ${e})`),[j.Add]:K(i=>`(${i.join(" + ")})`),[j.Subtract]:K(([i,e])=>`(${i} - ${e})`),[j.Clamp]:K(([i,e,t])=>`clamp(${i}, ${e}, ${t})`),[j.Mod]:K(([i,e])=>`mod(${i}, ${e})`),[j.Pow]:K(([i,e])=>`pow(${i}, ${e})`),[j.Abs]:K(([i])=>`abs(${i})`),[j.Floor]:K(([i])=>`floor(${i})`),[j.Ceil]:K(([i])=>`ceil(${i})`),[j.Round]:K(([i])=>`floor(${i} + 0.5)`),[j.Sin]:K(([i])=>`sin(${i})`),[j.Cos]:K(([i])=>`cos(${i})`),[j.Atan]:K(([i,e])=>e!==void 0?`atan(${i}, ${e})`:`atan(${i})`),[j.Sqrt]:K(([i])=>`sqrt(${i})`),[j.Match]:K(i=>{const e=i[0],t=i[i.length-1];let r=null;for(let n=i.length-3;n>=1;n-=2){const s=i[n],o=i[n+1];r=`(${e} == ${s} ? ${o} : ${r||t})`}return r}),[j.Between]:K(([i,e,t])=>`(${i} >= ${e} && ${i} <= ${t})`),[j.Interpolate]:K(([i,e,...t])=>{let r="";for(let n=0;n<t.length-2;n+=2){const s=t[n],o=r||t[n+1],a=t[n+2],l=t[n+3];let c;i===rt(1)?c=`(${e} - ${s}) / (${a} - ${s})`:c=`(pow(${i}, (${e} - ${s})) - 1.0) / (pow(${i}, (${a} - ${s})) - 1.0)`,r=`mix(${o}, ${l}, clamp(${c}, 0.0, 1.0))`}return r}),[j.Case]:K(i=>{const e=i[i.length-1];let t=null;for(let r=i.length-3;r>=0;r-=2){const n=i[r],s=i[r+1];t=`(${n} ? ${s} : ${t||e})`}return t}),[j.In]:K(([i,...e],t)=>{const r=bd("in",t),n=[];for(let s=0;s<e.length;s+=1)n.push(`  if (inputValue == ${e[s]}) { return true; }`);return t.functions[r]=`bool ${r}(float inputValue) {
${n.join(`
`)}
  return false;
}`,`${r}(${i})`}),[j.Array]:K(i=>`vec${i.length}(${i.join(", ")})`),[j.Color]:K(i=>{if(i.length===1)return`vec4(vec3(${i[0]} / 255.0), 1.0)`;if(i.length===2)return`vec4(vec3(${i[0]} / 255.0), ${i[1]})`;const e=i.slice(0,3).map(r=>`${r} / 255.0`);if(i.length===3)return`vec4(${e.join(", ")}, 1.0)`;const t=i[3];return`vec4(${e.join(", ")}, ${t})`}),[j.Band]:K(([i,e,t],r)=>{if(!(jr in r.functions)){let n="";const s=r.bandCount||1;for(let o=0;o<s;o++){const a=Math.floor(o/4);let l=o%4;o===s-1&&l===1&&(l=3);const c=`${X.TILE_TEXTURE_ARRAY}[${a}]`;n+=`  if (band == ${o+1}.0) {
    return texture2D(${c}, v_textureCoord + vec2(dx, dy))[${l}];
  }
`}r.functions[jr]=`float getBandValue(float band, float xOffset, float yOffset) {
  float dx = xOffset / ${X.TEXTURE_PIXEL_WIDTH};
  float dy = yOffset / ${X.TEXTURE_PIXEL_HEIGHT};
${n}
}`}return`${jr}(${i}, ${e??"0.0"}, ${t??"0.0"})`}),[j.Palette]:(i,e)=>{const[t,...r]=e.args,n=r.length,s=new Uint8Array(n*4);for(let c=0;c<r.length;c++){const u=r[c].value,h=Ht(u),f=c*4;s[f]=h[0],s[f+1]=h[1],s[f+2]=h[2],s[f+3]=h[3]*255}i.paletteTextures||(i.paletteTextures=[]);const o=`${Zs}[${i.paletteTextures.length}]`,a=new vd(o,s);i.paletteTextures.push(a);const l=Xi(t,Y,i);return`texture2D(${o}, vec2((${l} + 0.5) / ${n}.0, 0.5))`}};function Xi(i,e,t){if(i instanceof ia){const r=Fd[i.operator];if(r===void 0)throw new Error(`No compiler defined for this operator: ${JSON.stringify(i.operator)}`);return r(t,i,e)}if((i.type&Y)>0)return rt(i.value);if((i.type&Xt)>0)return i.value.toString();if((i.type&kt)>0)return je(i.value.toString());if((i.type&Se)>0)return cr(i.value);if((i.type&ht)>0)return zi(i.value);if((i.type&gt)>0)return Ad(i.value);throw new Error(`Unexpected expression ${i.value} (expected type ${na(e)})`)}function Nd(){return{"fill-color":"rgba(255,255,255,0.4)","stroke-color":"#3399CC","stroke-width":1.25,"circle-radius":5,"circle-fill-color":"rgba(255,255,255,0.4)","circle-stroke-width":1.25,"circle-stroke-color":"#3399CC"}}const jn=.985;function D(i,e,t){const r=sa();return Id(e,t,r,i)}function Md(i){const e=Ht(i),t=e[0]*256,r=e[1],n=e[2]*256,s=Math.round(e[3]*255);return[t+r,n+s]}const Od=`vec4 unpackColor(vec2 packedColor) {
  return vec4(
    min(floor(packedColor[0] / 256.0) / 255.0, 1.0),
    min(mod(packedColor[0], 256.0) / 255.0, 1.0),
    min(floor(packedColor[1] / 256.0) / 255.0, 1.0),
    min(mod(packedColor[1], 256.0) / 255.0, 1.0)
  );
}`;function ki(i){return i===Se||i===gt?2:i===ht?4:1}function ai(i){const e=ki(i);return e>1?`vec${e}`:"float"}function Ys(i,e){for(const t in e.variables){const r=e.variables[t],n=Dr(r.name);let s=ai(r.type);r.type===Se&&(s="vec4"),i.addUniform(n,s)}for(const t in e.properties){const r=e.properties[t],n=ai(r.type),s=`a_prop_${r.name}`;r.type===Se?i.addAttribute(s,n,`unpackColor(${s})`,"vec4"):i.addAttribute(s,n)}for(const t in e.functions)i.addVertexShaderFunction(e.functions[t]),i.addFragmentShaderFunction(e.functions[t])}function qs(i,e){const t={};for(const r in i.variables){const n=i.variables[r],s=Dr(n.name);t[s]=()=>{const o=e[n.name];if(typeof o=="number")return o;if(typeof o=="boolean")return o?1:0;if(n.type===Se){const a=[...Ht(o||"#eee")];return a[0]/=255,a[1]/=255,a[2]/=255,a[3]??(a[3]=1),a}return typeof o=="string"?vt(o):o}}return t}function Ks(i){const e={};for(const t in i.properties){const r=i.properties[t],n=s=>{const o=s.get(r.name);return r.type===Se?Md([...Ht(o||"#eee")]):typeof o=="string"?vt(o):typeof o=="boolean"?o?1:0:o};e[`prop_${r.name}`]={size:ki(r.type),callback:n}}return e}const Et=`#ifdef GL_FRAGMENT_PRECISION_HIGH
precision highp float;
#else
precision mediump float;
#endif
uniform mat4 u_projectionMatrix;
uniform mat4 u_screenToWorldMatrix;
uniform vec2 u_viewportSizePx;
uniform float u_pixelRatio;
uniform float u_globalAlpha;
uniform float u_time;
uniform float u_zoom;
uniform float u_resolution;
uniform float u_rotation;
uniform vec4 u_renderExtent;
uniform vec2 u_patternOrigin;
uniform float u_depth;
uniform mediump int u_hitDetection;

const float PI = 3.141592653589793238;
const float TWO_PI = 2.0 * PI;
float currentLineMetric = 0.; // an actual value will be used in the stroke shaders

${Od}
`,yt=Nd();class Js{constructor(){this.uniforms_=[],this.attributes_=[],this.hasSymbol_=!1,this.symbolSizeExpression_=`vec2(${rt(yt["circle-radius"])} + ${rt(yt["circle-stroke-width"]*.5)})`,this.symbolRotationExpression_="0.0",this.symbolOffsetExpression_="vec2(0.0)",this.symbolColorExpression_=cr(yt["circle-fill-color"]),this.texCoordExpression_="vec4(0.0, 0.0, 1.0, 1.0)",this.discardExpression_="false",this.symbolRotateWithView_=!1,this.hasStroke_=!1,this.strokeWidthExpression_=rt(yt["stroke-width"]),this.strokeColorExpression_=cr(yt["stroke-color"]),this.strokeOffsetExpression_="0.",this.strokeCapExpression_=je("round"),this.strokeJoinExpression_=je("round"),this.strokeMiterLimitExpression_="10.",this.strokeDistanceFieldExpression_="-1000.",this.strokePatternLengthExpression_=null,this.hasFill_=!1,this.fillColorExpression_=cr(yt["fill-color"]),this.vertexShaderFunctions_=[],this.fragmentShaderFunctions_=[]}addUniform(e,t){return this.uniforms_.push({name:e,type:t}),this}addAttribute(e,t,r,n){return this.attributes_.push({name:e,type:t,varyingName:e.replace(/^a_/,"v_"),varyingType:n??t,varyingExpression:r??e}),this}setSymbolSizeExpression(e){return this.hasSymbol_=!0,this.symbolSizeExpression_=e,this}getSymbolSizeExpression(){return this.symbolSizeExpression_}setSymbolRotationExpression(e){return this.symbolRotationExpression_=e,this}setSymbolOffsetExpression(e){return this.symbolOffsetExpression_=e,this}getSymbolOffsetExpression(){return this.symbolOffsetExpression_}setSymbolColorExpression(e){return this.hasSymbol_=!0,this.symbolColorExpression_=e,this}getSymbolColorExpression(){return this.symbolColorExpression_}setTextureCoordinateExpression(e){return this.texCoordExpression_=e,this}setFragmentDiscardExpression(e){return this.discardExpression_=e,this}getFragmentDiscardExpression(){return this.discardExpression_}setSymbolRotateWithView(e){return this.symbolRotateWithView_=e,this}setStrokeWidthExpression(e){return this.hasStroke_=!0,this.strokeWidthExpression_=e,this}setStrokeColorExpression(e){return this.hasStroke_=!0,this.strokeColorExpression_=e,this}getStrokeColorExpression(){return this.strokeColorExpression_}setStrokeOffsetExpression(e){return this.strokeOffsetExpression_=e,this}setStrokeCapExpression(e){return this.strokeCapExpression_=e,this}setStrokeJoinExpression(e){return this.strokeJoinExpression_=e,this}setStrokeMiterLimitExpression(e){return this.strokeMiterLimitExpression_=e,this}setStrokeDistanceFieldExpression(e){return this.strokeDistanceFieldExpression_=e,this}setStrokePatternLengthExpression(e){return this.strokePatternLengthExpression_=e,this}getStrokePatternLengthExpression(){return this.strokePatternLengthExpression_}setFillColorExpression(e){return this.hasFill_=!0,this.fillColorExpression_=e,this}getFillColorExpression(){return this.fillColorExpression_}addVertexShaderFunction(e){return this.vertexShaderFunctions_.includes(e)?this:(this.vertexShaderFunctions_.push(e),this)}addFragmentShaderFunction(e){return this.fragmentShaderFunctions_.includes(e)?this:(this.fragmentShaderFunctions_.push(e),this)}getSymbolVertexShader(){return this.hasSymbol_?`${Et}
${this.uniforms_.map(e=>`uniform ${e.type} ${e.name};`).join(`
`)}
attribute vec2 a_position;
attribute vec2 a_localPosition;
attribute vec2 a_hitColor;

varying vec2 v_texCoord;
varying vec2 v_quadCoord;
varying vec4 v_hitColor;
varying vec2 v_centerPx;
varying float v_angle;
varying vec2 v_quadSizePx;

${this.attributes_.map(e=>`attribute ${e.type} ${e.name};
varying ${e.varyingType} ${e.varyingName};`).join(`
`)}
${this.vertexShaderFunctions_.join(`
`)}
vec2 pxToScreen(vec2 coordPx) {
  vec2 scaled = coordPx / u_viewportSizePx / 0.5;
  return scaled;
}

vec2 screenToPx(vec2 coordScreen) {
  return (coordScreen * 0.5 + 0.5) * u_viewportSizePx;
}

void main(void) {
  v_quadSizePx = ${this.symbolSizeExpression_};
  vec2 halfSizePx = v_quadSizePx * 0.5;
  vec2 centerOffsetPx = ${this.symbolOffsetExpression_};
  vec2 offsetPx = centerOffsetPx + a_localPosition * halfSizePx * vec2(1., -1.);
  float angle = ${this.symbolRotationExpression_}${this.symbolRotateWithView_?" + u_rotation":""};
  float c = cos(-angle);
  float s = sin(-angle);
  offsetPx = vec2(c * offsetPx.x - s * offsetPx.y, s * offsetPx.x + c * offsetPx.y);
  vec4 center = u_projectionMatrix * vec4(a_position, 0.0, 1.0);
  gl_Position = center + vec4(pxToScreen(offsetPx), u_depth, 0.);
  vec4 texCoord = ${this.texCoordExpression_};
  float u = mix(texCoord.s, texCoord.p, a_localPosition.x * 0.5 + 0.5);
  float v = mix(texCoord.t, texCoord.q, a_localPosition.y * 0.5 + 0.5);
  v_texCoord = vec2(u, v);
  v_hitColor = unpackColor(a_hitColor);
  v_angle = angle;
  c = cos(-v_angle);
  s = sin(-v_angle);
  centerOffsetPx = vec2(c * centerOffsetPx.x - s * centerOffsetPx.y, s * centerOffsetPx.x + c * centerOffsetPx.y);
  v_centerPx = screenToPx(center.xy) + centerOffsetPx;
${this.attributes_.map(e=>`  ${e.varyingName} = ${e.varyingExpression};`).join(`
`)}
}`:null}getSymbolFragmentShader(){return this.hasSymbol_?`${Et}
${this.uniforms_.map(e=>`uniform ${e.type} ${e.name};`).join(`
`)}
varying vec2 v_texCoord;
varying vec4 v_hitColor;
varying vec2 v_centerPx;
varying float v_angle;
varying vec2 v_quadSizePx;
${this.attributes_.map(e=>`varying ${e.varyingType} ${e.varyingName};`).join(`
`)}
${this.fragmentShaderFunctions_.join(`
`)}

void main(void) {
${this.attributes_.map(e=>`  ${e.varyingType} ${e.name} = ${e.varyingName}; // assign to original attribute name`).join(`
`)}
  if (${this.discardExpression_}) { discard; }
  vec2 coordsPx = gl_FragCoord.xy / u_pixelRatio - v_centerPx; // relative to center
  float c = cos(v_angle);
  float s = sin(v_angle);
  coordsPx = vec2(c * coordsPx.x - s * coordsPx.y, s * coordsPx.x + c * coordsPx.y);
  gl_FragColor = ${this.symbolColorExpression_};
  gl_FragColor.rgb *= gl_FragColor.a;
  if (u_hitDetection > 0) {
    if (gl_FragColor.a < 0.05) { discard; };
    gl_FragColor = v_hitColor;
  }
}`:null}getStrokeVertexShader(){return this.hasStroke_?`${Et}
${this.uniforms_.map(e=>`uniform ${e.type} ${e.name};`).join(`
`)}
attribute vec2 a_segmentStart;
attribute vec2 a_segmentEnd;
attribute vec2 a_localPosition;
attribute float a_measureStart;
attribute float a_measureEnd;
attribute float a_angleTangentSum;
attribute float a_distanceLow;
attribute float a_distanceHigh;
attribute vec2 a_joinAngles;
attribute vec2 a_hitColor;

varying vec2 v_segmentStartPx;
varying vec2 v_segmentEndPx;
varying float v_angleStart;
varying float v_angleEnd;
varying float v_width;
varying vec4 v_hitColor;
varying float v_distancePx;
varying float v_measureStart;
varying float v_measureEnd;

${this.attributes_.map(e=>`attribute ${e.type} ${e.name};
varying ${e.varyingType} ${e.varyingName};`).join(`
`)}
${this.vertexShaderFunctions_.join(`
`)}
vec2 worldToPx(vec2 worldPos) {
  vec4 screenPos = u_projectionMatrix * vec4(worldPos, 0.0, 1.0);
  return (0.5 * screenPos.xy + 0.5) * u_viewportSizePx;
}

vec4 pxToScreen(vec2 pxPos) {
  vec2 screenPos = 2.0 * pxPos / u_viewportSizePx - 1.0;
  return vec4(screenPos, u_depth, 1.0);
}

bool isCap(float joinAngle) {
  return joinAngle < -0.1;
}

vec2 getJoinOffsetDirection(vec2 normalPx, float joinAngle) {
  float halfAngle = joinAngle / 2.0;
  float c = cos(halfAngle);
  float s = sin(halfAngle);
  vec2 angleBisectorNormal = vec2(s * normalPx.x + c * normalPx.y, -c * normalPx.x + s * normalPx.y);
  float length = 1.0 / s;
  return angleBisectorNormal * length;
}

vec2 getOffsetPoint(vec2 point, vec2 normal, float joinAngle, float offsetPx) {
  // if on a cap or the join angle is too high, offset the line along the segment normal
  if (cos(joinAngle) > 0.998 || isCap(joinAngle)) {
    return point - normal * offsetPx;
  }
  // offset is applied along the inverted normal (positive offset goes "right" relative to line direction)
  return point - getJoinOffsetDirection(normal, joinAngle) * offsetPx;
}

void main(void) {
  v_angleStart = a_joinAngles.x;
  v_angleEnd = a_joinAngles.y;
  float startEndRatio = a_localPosition.x * 0.5 + 0.5;
  currentLineMetric = mix(a_measureStart, a_measureEnd, startEndRatio);
  // we're reading the fractional part while keeping the sign (so -4.12 gives -0.12, 3.45 gives 0.45)

  float lineWidth = ${this.strokeWidthExpression_};
  float lineOffsetPx = ${this.strokeOffsetExpression_};

  // compute segment start/end in px with offset
  vec2 segmentStartPx = worldToPx(a_segmentStart);
  vec2 segmentEndPx = worldToPx(a_segmentEnd);
  vec2 tangentPx = normalize(segmentEndPx - segmentStartPx);
  vec2 normalPx = vec2(-tangentPx.y, tangentPx.x);
  segmentStartPx = getOffsetPoint(segmentStartPx, normalPx, v_angleStart, lineOffsetPx),
  segmentEndPx = getOffsetPoint(segmentEndPx, normalPx, v_angleEnd, lineOffsetPx);

  // compute current vertex position
  float normalDir = -1. * a_localPosition.y;
  float tangentDir = -1. * a_localPosition.x;
  float angle = mix(v_angleStart, v_angleEnd, startEndRatio);
  vec2 joinDirection;
  vec2 positionPx = mix(segmentStartPx, segmentEndPx, startEndRatio);
  // if angle is too high, do not make a proper join
  if (cos(angle) > ${jn} || isCap(angle)) {
    joinDirection = normalPx * normalDir - tangentPx * tangentDir;
  } else {
    joinDirection = getJoinOffsetDirection(normalPx * normalDir, angle);
  }
  positionPx = positionPx + joinDirection * (lineWidth * 0.5 + 1.); // adding 1 pixel for antialiasing
  gl_Position = pxToScreen(positionPx);

  v_segmentStartPx = segmentStartPx;
  v_segmentEndPx = segmentEndPx;
  v_width = lineWidth;
  v_hitColor = unpackColor(a_hitColor);

  v_distancePx = a_distanceLow / u_resolution - (lineOffsetPx * a_angleTangentSum);
  float distanceHighPx = a_distanceHigh / u_resolution;
  ${this.strokePatternLengthExpression_!==null?`v_distancePx = mod(v_distancePx, ${this.strokePatternLengthExpression_});
  distanceHighPx = mod(distanceHighPx, ${this.strokePatternLengthExpression_});
  `:""}v_distancePx += distanceHighPx;

  v_measureStart = a_measureStart;
  v_measureEnd = a_measureEnd;
${this.attributes_.map(e=>`  ${e.varyingName} = ${e.varyingExpression};`).join(`
`)}
}`:null}getStrokeFragmentShader(){return this.hasStroke_?`${Et}
${this.uniforms_.map(e=>`uniform ${e.type} ${e.name};`).join(`
`)}
varying vec2 v_segmentStartPx;
varying vec2 v_segmentEndPx;
varying float v_angleStart;
varying float v_angleEnd;
varying float v_width;
varying vec4 v_hitColor;
varying float v_distancePx;
varying float v_measureStart;
varying float v_measureEnd;
${this.attributes_.map(e=>`varying ${e.varyingType} ${e.varyingName};`).join(`
`)}
${this.fragmentShaderFunctions_.join(`
`)}

vec2 pxToWorld(vec2 pxPos) {
  vec2 screenPos = 2.0 * pxPos / u_viewportSizePx - 1.0;
  return (u_screenToWorldMatrix * vec4(screenPos, 0.0, 1.0)).xy;
}

bool isCap(float joinAngle) {
  return joinAngle < -0.1;
}

float segmentDistanceField(vec2 point, vec2 start, vec2 end, float width) {
  vec2 tangent = normalize(end - start);
  vec2 normal = vec2(-tangent.y, tangent.x);
  vec2 startToPoint = point - start;
  return abs(dot(startToPoint, normal)) - width * 0.5;
}

float buttCapDistanceField(vec2 point, vec2 start, vec2 end) {
  vec2 startToPoint = point - start;
  vec2 tangent = normalize(end - start);
  return dot(startToPoint, -tangent);
}

float squareCapDistanceField(vec2 point, vec2 start, vec2 end, float width) {
  return buttCapDistanceField(point, start, end) - width * 0.5;
}

float roundCapDistanceField(vec2 point, vec2 start, vec2 end, float width) {
  float onSegment = max(0., 1000. * dot(point - start, end - start)); // this is very high when inside the segment
  return length(point - start) - width * 0.5 - onSegment;
}

float roundJoinDistanceField(vec2 point, vec2 start, vec2 end, float width) {
  return roundCapDistanceField(point, start, end, width);
}

float bevelJoinField(vec2 point, vec2 start, vec2 end, float width, float joinAngle) {
  vec2 startToPoint = point - start;
  vec2 tangent = normalize(end - start);
  float c = cos(joinAngle * 0.5);
  float s = sin(joinAngle * 0.5);
  float direction = -sign(sin(joinAngle));
  vec2 bisector = vec2(c * tangent.x - s * tangent.y, s * tangent.x + c * tangent.y);
  float radius = width * 0.5 * s;
  return dot(startToPoint, bisector * direction) - radius;
}

float miterJoinDistanceField(vec2 point, vec2 start, vec2 end, float width, float joinAngle) {
  if (cos(joinAngle) > ${jn}) { // avoid risking a division by zero
    return bevelJoinField(point, start, end, width, joinAngle);
  }
  float miterLength = 1. / sin(joinAngle * 0.5);
  float miterLimit = ${this.strokeMiterLimitExpression_};
  if (miterLength > miterLimit) {
    return bevelJoinField(point, start, end, width, joinAngle);
  }
  return -1000.;
}

float capDistanceField(vec2 point, vec2 start, vec2 end, float width, float capType) {
   if (capType == ${je("butt")}) {
    return buttCapDistanceField(point, start, end);
  } else if (capType == ${je("square")}) {
    return squareCapDistanceField(point, start, end, width);
  }
  return roundCapDistanceField(point, start, end, width);
}

float joinDistanceField(vec2 point, vec2 start, vec2 end, float width, float joinAngle, float joinType) {
  if (joinType == ${je("bevel")}) {
    return bevelJoinField(point, start, end, width, joinAngle);
  } else if (joinType == ${je("miter")}) {
    return miterJoinDistanceField(point, start, end, width, joinAngle);
  }
  return roundJoinDistanceField(point, start, end, width);
}

float computeSegmentPointDistance(vec2 point, vec2 start, vec2 end, float width, float joinAngle, float capType, float joinType) {
  if (isCap(joinAngle)) {
    return capDistanceField(point, start, end, width, capType);
  }
  return joinDistanceField(point, start, end, width, joinAngle, joinType);
}

float distanceFromSegment(vec2 point, vec2 start, vec2 end) {
  vec2 tangent = end - start;
  vec2 startToPoint = point - start;
  // inspire by capsule fn in https://iquilezles.org/articles/distfunctions/
  float h = clamp(dot(startToPoint, tangent) / dot(tangent, tangent), 0.0, 1.0);
  return length(startToPoint - tangent * h);
}

void main(void) {
${this.attributes_.map(e=>`  ${e.varyingType} ${e.name} = ${e.varyingName}; // assign to original attribute name`).join(`
`)}

  vec2 currentPointPx = gl_FragCoord.xy / u_pixelRatio;
  #ifdef GL_FRAGMENT_PRECISION_HIGH
  vec2 worldPos = pxToWorld(currentPointPx);
  if (
    abs(u_renderExtent[0] - u_renderExtent[2]) > 0.0 && (
      worldPos[0] < u_renderExtent[0] ||
      worldPos[1] < u_renderExtent[1] ||
      worldPos[0] > u_renderExtent[2] ||
      worldPos[1] > u_renderExtent[3]
    )
  ) {
    discard;
  }
  #endif

  float segmentLengthPx = length(v_segmentEndPx - v_segmentStartPx);
  segmentLengthPx = max(segmentLengthPx, 1.17549429e-38); // avoid divide by zero
  vec2 segmentTangent = (v_segmentEndPx - v_segmentStartPx) / segmentLengthPx;
  vec2 segmentNormal = vec2(-segmentTangent.y, segmentTangent.x);
  vec2 startToPointPx = currentPointPx - v_segmentStartPx;
  float lengthToPointPx = max(0., min(dot(segmentTangent, startToPointPx), segmentLengthPx));
  float currentLengthPx = lengthToPointPx + v_distancePx;
  float currentRadiusPx = distanceFromSegment(currentPointPx, v_segmentStartPx, v_segmentEndPx);
  float currentRadiusRatio = dot(segmentNormal, startToPointPx) * 2. / v_width;
  currentLineMetric = mix(v_measureStart, v_measureEnd, lengthToPointPx / segmentLengthPx);

  if (${this.discardExpression_}) { discard; }

  float capType = ${this.strokeCapExpression_};
  float joinType = ${this.strokeJoinExpression_};
  float segmentStartDistance = computeSegmentPointDistance(currentPointPx, v_segmentStartPx, v_segmentEndPx, v_width, v_angleStart, capType, joinType);
  float segmentEndDistance = computeSegmentPointDistance(currentPointPx, v_segmentEndPx, v_segmentStartPx, v_width, v_angleEnd, capType, joinType);
  float distanceField = max(
    segmentDistanceField(currentPointPx, v_segmentStartPx, v_segmentEndPx, v_width),
    max(segmentStartDistance, segmentEndDistance)
  );
  distanceField = max(distanceField, ${this.strokeDistanceFieldExpression_});

  vec4 color = ${this.strokeColorExpression_};
  color.a *= smoothstep(0.5, -0.5, distanceField);
  gl_FragColor = color;
  gl_FragColor.a *= u_globalAlpha;
  gl_FragColor.rgb *= gl_FragColor.a;
  if (u_hitDetection > 0) {
    if (gl_FragColor.a < 0.1) { discard; };
    gl_FragColor = v_hitColor;
  }
}`:null}getFillVertexShader(){return this.hasFill_?`${Et}
${this.uniforms_.map(e=>`uniform ${e.type} ${e.name};`).join(`
`)}
attribute vec2 a_position;
attribute vec2 a_hitColor;

varying vec4 v_hitColor;

${this.attributes_.map(e=>`attribute ${e.type} ${e.name};
varying ${e.varyingType} ${e.varyingName};`).join(`
`)}
${this.vertexShaderFunctions_.join(`
`)}
void main(void) {
  gl_Position = u_projectionMatrix * vec4(a_position, u_depth, 1.0);
  v_hitColor = unpackColor(a_hitColor);
${this.attributes_.map(e=>`  ${e.varyingName} = ${e.varyingExpression};`).join(`
`)}
}`:null}getFillFragmentShader(){return this.hasFill_?`${Et}
${this.uniforms_.map(e=>`uniform ${e.type} ${e.name};`).join(`
`)}
varying vec4 v_hitColor;
${this.attributes_.map(e=>`varying ${e.varyingType} ${e.varyingName};`).join(`
`)}
${this.fragmentShaderFunctions_.join(`
`)}
vec2 pxToWorld(vec2 pxPos) {
  vec2 screenPos = 2.0 * pxPos / u_viewportSizePx - 1.0;
  return (u_screenToWorldMatrix * vec4(screenPos, 0.0, 1.0)).xy;
}

vec2 worldToPx(vec2 worldPos) {
  vec4 screenPos = u_projectionMatrix * vec4(worldPos, 0.0, 1.0);
  return (0.5 * screenPos.xy + 0.5) * u_viewportSizePx;
}

void main(void) {
${this.attributes_.map(e=>`  ${e.varyingType} ${e.name} = ${e.varyingName}; // assign to original attribute name`).join(`
`)}
  vec2 pxPos = gl_FragCoord.xy / u_pixelRatio;
  vec2 pxOrigin = worldToPx(u_patternOrigin);
  #ifdef GL_FRAGMENT_PRECISION_HIGH
  vec2 worldPos = pxToWorld(pxPos);
  if (
    abs(u_renderExtent[0] - u_renderExtent[2]) > 0.0 && (
      worldPos[0] < u_renderExtent[0] ||
      worldPos[1] < u_renderExtent[1] ||
      worldPos[0] > u_renderExtent[2] ||
      worldPos[1] > u_renderExtent[3]
    )
  ) {
    discard;
  }
  #endif
  if (${this.discardExpression_}) { discard; }
  gl_FragColor = ${this.fillColorExpression_};
  gl_FragColor.a *= u_globalAlpha;
  gl_FragColor.rgb *= gl_FragColor.a;
  if (u_hitDetection > 0) {
    if (gl_FragColor.a < 0.1) { discard; };
    gl_FragColor = v_hitColor;
  }
}`:null}}class Sr{constructor(){this.globalCounter_=0,this.refToFeature_=new Map,this.uidToRef_=new Map,this.freeGlobalRef_=[],this.polygonBatch={entries:{},geometriesCount:0,verticesCount:0,ringsCount:0},this.pointBatch={entries:{},geometriesCount:0},this.lineStringBatch={entries:{},geometriesCount:0,verticesCount:0}}addFeatures(e,t){for(let r=0;r<e.length;r++)this.addFeature(e[r],t)}addFeature(e,t){let r=e.getGeometry();r&&(t&&(r=r.clone(),r.applyTransform(t)),this.addGeometry_(r,e))}clearFeatureEntryInPointBatch_(e){const t=J(e),r=this.pointBatch.entries[t];if(r)return this.pointBatch.geometriesCount-=r.flatCoordss.length,delete this.pointBatch.entries[t],r}clearFeatureEntryInLineStringBatch_(e){const t=J(e),r=this.lineStringBatch.entries[t];if(r)return this.lineStringBatch.verticesCount-=r.verticesCount,this.lineStringBatch.geometriesCount-=r.flatCoordss.length,delete this.lineStringBatch.entries[t],r}clearFeatureEntryInPolygonBatch_(e){const t=J(e),r=this.polygonBatch.entries[t];if(r)return this.polygonBatch.verticesCount-=r.verticesCount,this.polygonBatch.ringsCount-=r.ringsCount,this.polygonBatch.geometriesCount-=r.flatCoordss.length,delete this.polygonBatch.entries[t],r}addGeometry_(e,t){var n;const r=e.getType();switch(r){case"GeometryCollection":{const s=e.getGeometriesArray();for(const o of s)this.addGeometry_(o,t);break}case"MultiPolygon":{const s=e;this.addCoordinates_(r,s.getFlatCoordinates(),s.getEndss(),t,J(t),s.getStride());break}case"MultiLineString":{const s=e;this.addCoordinates_(r,s.getFlatCoordinates(),s.getEnds(),t,J(t),s.getStride());break}case"MultiPoint":{const s=e;this.addCoordinates_(r,s.getFlatCoordinates(),null,t,J(t),s.getStride());break}case"Polygon":{const s=e;this.addCoordinates_(r,s.getFlatCoordinates(),s.getEnds(),t,J(t),s.getStride());break}case"Point":{const s=e;this.addCoordinates_(r,s.getFlatCoordinates(),null,t,J(t),s.getStride());break}case"LineString":case"LinearRing":{const s=e,o=s.getStride();this.addCoordinates_(r,s.getFlatCoordinates(),null,t,J(t),o,(n=s.getLayout)==null?void 0:n.call(s));break}}}addCoordinates_(e,t,r,n,s,o,a){let l;switch(e){case"MultiPolygon":{const c=r;for(let u=0,h=c.length;u<h;u++){let f=c[u];const g=u>0?c[u-1]:null,d=g?g[g.length-1]:0,m=f[f.length-1];f=d>0?f.map(_=>_-d):f,this.addCoordinates_("Polygon",t.slice(d,m),f,n,s,o,a)}break}case"MultiLineString":{const c=r;for(let u=0,h=c.length;u<h;u++){const f=u>0?c[u-1]:0;this.addCoordinates_("LineString",t.slice(f,c[u]),null,n,s,o,a)}break}case"MultiPoint":for(let c=0,u=t.length;c<u;c+=o)this.addCoordinates_("Point",t.slice(c,c+2),null,n,s,null,null);break;case"Polygon":{const c=r;if(n instanceof oa){const f=aa(t,c);if(f.length>1){this.addCoordinates_("MultiPolygon",t,f,n,s,o,a);return}}this.polygonBatch.entries[s]||(this.polygonBatch.entries[s]=this.addRefToEntry_(s,{feature:n,flatCoordss:[],verticesCount:0,ringsCount:0,ringsVerticesCounts:[]})),l=t.length/o;const u=r.length,h=r.map((f,g,d)=>g>0?(f-d[g-1])/o:f/o);this.polygonBatch.verticesCount+=l,this.polygonBatch.ringsCount+=u,this.polygonBatch.geometriesCount++,this.polygonBatch.entries[s].flatCoordss.push(Dd(t,o)),this.polygonBatch.entries[s].ringsVerticesCounts.push(h),this.polygonBatch.entries[s].verticesCount+=l,this.polygonBatch.entries[s].ringsCount+=u;for(let f=0,g=c.length;f<g;f++){const d=f>0?c[f-1]:0;this.addCoordinates_("LinearRing",t.slice(d,c[f]),null,n,s,o,a)}break}case"Point":this.pointBatch.entries[s]||(this.pointBatch.entries[s]=this.addRefToEntry_(s,{feature:n,flatCoordss:[]})),this.pointBatch.geometriesCount++,this.pointBatch.entries[s].flatCoordss.push(t);break;case"LineString":case"LinearRing":this.lineStringBatch.entries[s]||(this.lineStringBatch.entries[s]=this.addRefToEntry_(s,{feature:n,flatCoordss:[],verticesCount:0})),l=t.length/o,this.lineStringBatch.verticesCount+=l,this.lineStringBatch.geometriesCount++,this.lineStringBatch.entries[s].flatCoordss.push(Gd(t,o,a)),this.lineStringBatch.entries[s].verticesCount+=l;break}}addRefToEntry_(e,t){const r=this.uidToRef_.get(e),n=r||this.freeGlobalRef_.pop()||++this.globalCounter_;return t.ref=n,r||(this.refToFeature_.set(n,t.feature),this.uidToRef_.set(e,n)),t}removeRef_(e,t){if(!e)throw new Error("This feature has no ref: "+t);this.refToFeature_.delete(e),this.uidToRef_.delete(t),this.freeGlobalRef_.push(e)}changeFeature(e,t){if(!this.uidToRef_.get(J(e)))return;this.removeFeature(e);let r=e.getGeometry();r&&(t&&(r=r.clone(),r.applyTransform(t)),this.addGeometry_(r,e))}removeFeature(e){let t=this.clearFeatureEntryInPointBatch_(e);t=this.clearFeatureEntryInPolygonBatch_(e)||t,t=this.clearFeatureEntryInLineStringBatch_(e)||t,t&&this.removeRef_(t.ref,J(t.feature))}clear(){this.polygonBatch.entries={},this.polygonBatch.geometriesCount=0,this.polygonBatch.verticesCount=0,this.polygonBatch.ringsCount=0,this.lineStringBatch.entries={},this.lineStringBatch.geometriesCount=0,this.lineStringBatch.verticesCount=0,this.pointBatch.entries={},this.pointBatch.geometriesCount=0,this.globalCounter_=0,this.freeGlobalRef_=[],this.refToFeature_.clear(),this.uidToRef_.clear()}getFeatureFromRef(e){return this.refToFeature_.get(e)}isEmpty(){return this.globalCounter_===0}filter(e){const t=new Sr;t.globalCounter_=this.globalCounter_,t.uidToRef_=this.uidToRef_,t.refToFeature_=this.refToFeature_;let r=!0;for(const n of this.refToFeature_.values())e(n)&&(t.addFeature(n),r=!1);return r?new Sr:t}}function Dd(i,e){return e===2?i:i.filter((t,r)=>r%e<2)}function Gd(i,e,t){return e===3&&t==="XYM"?i:e===4?i.filter((r,n)=>n%e!==2):e===3?i.map((r,n)=>n%e!==2?r:0):new Array(i.length*1.5).fill(0).map((r,n)=>n%3===2?0:i[Math.round(n/1.5)])}function Qs(){const i='function t(t,n,x=2){const o=n&&n.length,i=o?n[0]*x:t.length;let f=e(t,0,i,x,!0);const l=[];if(!f||f.next===f.prev)return l;let c,y,h;if(o&&(f=function(t,n,r,x){const o=[];for(let r=0,i=n.length;r<i;r++){const f=e(t,n[r]*x,r<i-1?n[r+1]*x:t.length,x,!1);f===f.next&&(f.steiner=!0),o.push(a(f))}o.sort(u);for(let t=0;t<o.length;t++)r=s(o[t],r);return r}(t,n,f,x)),t.length>80*x){c=t[0],y=t[1];let e=c,n=y;for(let r=x;r<i;r+=x){const x=t[r],o=t[r+1];x<c&&(c=x),o<y&&(y=o),x>e&&(e=x),o>n&&(n=o)}h=Math.max(e-c,n-y),h=0!==h?32767/h:0}return r(f,l,x,c,y,h,0),l}function e(t,e,n,r,x){let o;if(x===function(t,e,n,r){let x=0;for(let o=e,i=n-r;o<n;o+=r)x+=(t[i]-t[o])*(t[o+1]+t[i+1]),i=o;return x}(t,e,n,r)>0)for(let x=e;x<n;x+=r)o=d(x/r|0,t[x],t[x+1],o);else for(let x=n-r;x>=e;x-=r)o=d(x/r|0,t[x],t[x+1],o);return o&&b(o,o.next)&&(w(o),o=o.next),o}function n(t,e){if(!t)return t;e||(e=t);let n,r=t;do{if(n=!1,r.steiner||!b(r,r.next)&&0!==v(r.prev,r,r.next))r=r.next;else{if(w(r),r=e=r.prev,r===r.next)break;n=!0}}while(n||r!==e);return e}function r(t,e,u,s,l,a,y){if(!t)return;!y&&a&&function(t,e,n,r){let x=t;do{0===x.z&&(x.z=c(x.x,x.y,e,n,r)),x.prevZ=x.prev,x.nextZ=x.next,x=x.next}while(x!==t);x.prevZ.nextZ=null,x.prevZ=null,function(t){let e,n=1;do{let r,x=t;t=null;let o=null;for(e=0;x;){e++;let i=x,f=0;for(let t=0;t<n&&(f++,i=i.nextZ,i);t++);let u=n;for(;f>0||u>0&&i;)0!==f&&(0===u||!i||x.z<=i.z)?(r=x,x=x.nextZ,f--):(r=i,i=i.nextZ,u--),o?o.nextZ=r:t=r,r.prevZ=o,o=r;x=i}o.nextZ=null,n*=2}while(e>1)}(x)}(t,s,l,a);let h=t;for(;t.prev!==t.next;){const c=t.prev,p=t.next;if(a?o(t,s,l,a):x(t))e.push(c.i,t.i,p.i),w(t),t=p.next,h=p.next;else if((t=p)===h){y?1===y?r(t=i(n(t),e),e,u,s,l,a,2):2===y&&f(t,e,u,s,l,a):r(n(t),e,u,s,l,a,1);break}}}function x(t){const e=t.prev,n=t,r=t.next;if(v(e,n,r)>=0)return!1;const x=e.x,o=n.x,i=r.x,f=e.y,u=n.y,s=r.y,l=Math.min(x,o,i),c=Math.min(f,u,s),a=Math.max(x,o,i),y=Math.max(f,u,s);let p=r.next;for(;p!==e;){if(p.x>=l&&p.x<=a&&p.y>=c&&p.y<=y&&h(x,f,o,u,i,s,p.x,p.y)&&v(p.prev,p,p.next)>=0)return!1;p=p.next}return!0}function o(t,e,n,r){const x=t.prev,o=t,i=t.next;if(v(x,o,i)>=0)return!1;const f=x.x,u=o.x,s=i.x,l=x.y,a=o.y,y=i.y,p=Math.min(f,u,s),b=Math.min(l,a,y),M=Math.max(f,u,s),m=Math.max(l,a,y),A=c(p,b,e,n,r),g=c(M,m,e,n,r);let Z=t.prevZ,d=t.nextZ;for(;Z&&Z.z>=A&&d&&d.z<=g;){if(Z.x>=p&&Z.x<=M&&Z.y>=b&&Z.y<=m&&Z!==x&&Z!==i&&h(f,l,u,a,s,y,Z.x,Z.y)&&v(Z.prev,Z,Z.next)>=0)return!1;if(Z=Z.prevZ,d.x>=p&&d.x<=M&&d.y>=b&&d.y<=m&&d!==x&&d!==i&&h(f,l,u,a,s,y,d.x,d.y)&&v(d.prev,d,d.next)>=0)return!1;d=d.nextZ}for(;Z&&Z.z>=A;){if(Z.x>=p&&Z.x<=M&&Z.y>=b&&Z.y<=m&&Z!==x&&Z!==i&&h(f,l,u,a,s,y,Z.x,Z.y)&&v(Z.prev,Z,Z.next)>=0)return!1;Z=Z.prevZ}for(;d&&d.z<=g;){if(d.x>=p&&d.x<=M&&d.y>=b&&d.y<=m&&d!==x&&d!==i&&h(f,l,u,a,s,y,d.x,d.y)&&v(d.prev,d,d.next)>=0)return!1;d=d.nextZ}return!0}function i(t,e){let r=t;do{const n=r.prev,x=r.next.next;!b(n,x)&&M(n,r,r.next,x)&&g(n,x)&&g(x,n)&&(e.push(n.i,r.i,x.i),w(r),w(r.next),r=t=x),r=r.next}while(r!==t);return n(r)}function f(t,e,x,o,i,f){let u=t;do{let t=u.next.next;for(;t!==u.prev;){if(u.i!==t.i&&p(u,t)){let s=Z(u,t);return u=n(u,u.next),s=n(s,s.next),r(u,e,x,o,i,f,0),void r(s,e,x,o,i,f,0)}t=t.next}u=u.next}while(u!==t)}function u(t,e){let n=t.x-e.x;if(0===n&&(n=t.y-e.y,0===n)){n=(t.next.y-t.y)/(t.next.x-t.x)-(e.next.y-e.y)/(e.next.x-e.x)}return n}function s(t,e){const r=function(t,e){let n=e;const r=t.x,x=t.y;let o,i=-1/0;if(b(t,n))return n;do{if(b(t,n.next))return n.next;if(x<=n.y&&x>=n.next.y&&n.next.y!==n.y){const t=n.x+(x-n.y)*(n.next.x-n.x)/(n.next.y-n.y);if(t<=r&&t>i&&(i=t,o=n.x<n.next.x?n:n.next,t===r))return o}n=n.next}while(n!==e);if(!o)return null;const f=o,u=o.x,s=o.y;let c=1/0;n=o;do{if(r>=n.x&&n.x>=u&&r!==n.x&&y(x<s?r:i,x,u,s,x<s?i:r,x,n.x,n.y)){const e=Math.abs(x-n.y)/(r-n.x);g(n,t)&&(e<c||e===c&&(n.x>o.x||n.x===o.x&&l(o,n)))&&(o=n,c=e)}n=n.next}while(n!==f);return o}(t,e);if(!r)return e;const x=Z(r,t);return n(x,x.next),n(r,r.next)}function l(t,e){return v(t.prev,t,e.prev)<0&&v(e.next,t,t.next)<0}function c(t,e,n,r,x){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-n)*x|0)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-r)*x|0)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function a(t){let e=t,n=t;do{(e.x<n.x||e.x===n.x&&e.y<n.y)&&(n=e),e=e.next}while(e!==t);return n}function y(t,e,n,r,x,o,i,f){return(x-i)*(e-f)>=(t-i)*(o-f)&&(t-i)*(r-f)>=(n-i)*(e-f)&&(n-i)*(o-f)>=(x-i)*(r-f)}function h(t,e,n,r,x,o,i,f){return!(t===i&&e===f)&&y(t,e,n,r,x,o,i,f)}function p(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!function(t,e){let n=t;do{if(n.i!==t.i&&n.next.i!==t.i&&n.i!==e.i&&n.next.i!==e.i&&M(n,n.next,t,e))return!0;n=n.next}while(n!==t);return!1}(t,e)&&(g(t,e)&&g(e,t)&&function(t,e){let n=t,r=!1;const x=(t.x+e.x)/2,o=(t.y+e.y)/2;do{n.y>o!=n.next.y>o&&n.next.y!==n.y&&x<(n.next.x-n.x)*(o-n.y)/(n.next.y-n.y)+n.x&&(r=!r),n=n.next}while(n!==t);return r}(t,e)&&(v(t.prev,t,e.prev)||v(t,e.prev,e))||b(t,e)&&v(t.prev,t,t.next)>0&&v(e.prev,e,e.next)>0)}function v(t,e,n){return(e.y-t.y)*(n.x-e.x)-(e.x-t.x)*(n.y-e.y)}function b(t,e){return t.x===e.x&&t.y===e.y}function M(t,e,n,r){const x=A(v(t,e,n)),o=A(v(t,e,r)),i=A(v(n,r,t)),f=A(v(n,r,e));return x!==o&&i!==f||(!(0!==x||!m(t,n,e))||(!(0!==o||!m(t,r,e))||(!(0!==i||!m(n,t,r))||!(0!==f||!m(n,e,r)))))}function m(t,e,n){return e.x<=Math.max(t.x,n.x)&&e.x>=Math.min(t.x,n.x)&&e.y<=Math.max(t.y,n.y)&&e.y>=Math.min(t.y,n.y)}function A(t){return t>0?1:t<0?-1:0}function g(t,e){return v(t.prev,t,t.next)<0?v(t,e,t.next)>=0&&v(t,t.prev,e)>=0:v(t,e,t.prev)<0||v(t,t.next,e)<0}function Z(t,e){const n=F(t.i,t.x,t.y),r=F(e.i,e.x,e.y),x=t.next,o=e.prev;return t.next=e,e.prev=t,n.next=x,x.prev=n,r.next=n,n.prev=r,o.next=r,r.prev=o,r}function d(t,e,n,r){const x=F(t,e,n);return r?(x.next=r.next,x.prev=r,r.next.prev=x,r.next=x):(x.prev=x,x.next=x),x}function w(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function F(t,e,n){return{i:t,x:e,y:n,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}function E(t,e){const n=e[0],r=e[1];return e[0]=t[0]*n+t[2]*r+t[4],e[1]=t[1]*n+t[3]*r+t[5],e}function I(t,e){const n=(r=e)[0]*r[3]-r[1]*r[2];var r;!function(t,e){if(!t)throw new Error(e)}(0!==n,"Transformation matrix cannot be inverted");const x=e[0],o=e[1],i=e[2],f=e[3],u=e[4],s=e[5];return t[0]=f/n,t[1]=-o/n,t[2]=-i/n,t[3]=x/n,t[4]=(i*s-f*u)/n,t[5]=-(x*s-o*u)/n,t}new Array(6);const z=[],B={vertexAttributesPosition:0,instanceAttributesPosition:0,indicesPosition:0};function P(t,e,n,r,x){const o=t[e++],i=t[e++],f=z;f.length=r;for(let n=0;n<f.length;n++)f[n]=t[e+n];let u=x?x.instanceAttributesPosition:0;return n[u++]=o,n[u++]=i,f.length&&(n.set(f,u),u+=f.length),B.instanceAttributesPosition=u,B}function N(t,e,n,r,x,o,i,f,u,s){const l=[t[e],t[e+1]],c=[t[n],t[n+1]],a=t[e+2],y=t[n+2],h=E(f,[...l]),p=E(f,[...c]);function v(t,e,n){const r=Math.sqrt((e[0]-t[0])*(e[0]-t[0])+(e[1]-t[1])*(e[1]-t[1])),x=[(e[0]-t[0])/r,(e[1]-t[1])/r],o=[-x[1],x[0]],i=Math.sqrt((n[0]-t[0])*(n[0]-t[0])+(n[1]-t[1])*(n[1]-t[1])),f=[(n[0]-t[0])/i,(n[1]-t[1])/i];let u=0===r||0===i?0:Math.acos((s=f[0]*x[0]+f[1]*x[1],l=-1,c=1,Math.min(Math.max(s,l),c)));var s,l,c;u=Math.max(u,1e-5);return f[0]*o[0]+f[1]*o[1]>0?u:2*Math.PI-u}let b=-1,M=-1,m=s;const A=null!==x;if(null!==r){b=v(h,p,E(f,[...[t[r],t[r+1]]])),Math.cos(b)<=.985&&(m+=Math.tan((b-Math.PI)/2))}if(A){M=v(p,h,E(f,[...[t[x],t[x+1]]])),Math.cos(M)<=.985&&(m+=Math.tan((Math.PI-M)/2))}const g=Math.pow(2,24),Z=u%g,d=Math.floor(u/g)*g;return o.push(l[0],l[1],a,c[0],c[1],y,b,M,Z,d,s),o.push(...i),{length:u+Math.sqrt((p[0]-h[0])*(p[0]-h[0])+(p[1]-h[1])*(p[1]-h[1])),angle:m}}function R(e,n,r,x,o){const i=2+o;let f=n;const u=e.slice(f,f+o);f+=o;const s=e[f++];let l=0;const c=new Array(s-1);for(let t=0;t<s;t++)l+=e[f++],t<s-1&&(c[t]=l);const a=e.slice(f,f+2*l),y=t(a,c,2);for(let t=0;t<y.length;t++)x.push(y[t]+r.length/i);for(let t=0;t<a.length;t+=2)r.push(a[t],a[t+1],...u);return f+2*l}const S="GENERATE_POLYGON_BUFFERS",T="GENERATE_POINT_BUFFERS",_="GENERATE_LINE_STRING_BUFFERS",O=self;O.onmessage=t=>{const e=t.data;switch(e.type){case T:{const t=2,n=2,r=e.customAttributesSize,x=n+r,o=new Float32Array(e.renderInstructions),i=o.length/x*(t+r),f=Uint32Array.from([0,1,3,1,2,3]),u=Float32Array.from([-1,-1,1,-1,1,1,-1,1]),s=new Float32Array(i);let l;for(let t=0;t<o.length;t+=x)l=P(o,t,s,r,l);const c=Object.assign({indicesBuffer:f.buffer,vertexAttributesBuffer:u.buffer,instanceAttributesBuffer:s.buffer,renderInstructions:o.buffer},e);O.postMessage(c,[u.buffer,s.buffer,f.buffer,o.buffer]);break}case _:{const t=[],n=e.customAttributesSize,r=3,x=new Float32Array(e.renderInstructions);let o=0;const i=[1,0,0,1,0,0];let f,u;for(I(i,e.renderInstructionsTransform);o<x.length;){u=Array.from(x.slice(o,o+n)),o+=n,f=x[o++];const e=o,s=o+(f-1)*r,l=x[e]===x[s]&&x[e+1]===x[s+1];let c=0,a=0;for(let n=0;n<f-1;n++){let y=null;n>0?y=o+(n-1)*r:l&&(y=s-r);let h=null;n<f-2?h=o+(n+2)*r:l&&(h=e+r);const p=N(x,o+n*r,o+(n+1)*r,y,h,t,u,i,c,a);c=p.length,a=p.angle}o+=f*r}const s=Uint32Array.from([0,1,3,1,2,3]),l=Float32Array.from([-1,-1,1,-1,1,1,-1,1]),c=Float32Array.from(t),a=Object.assign({indicesBuffer:s.buffer,vertexAttributesBuffer:l.buffer,instanceAttributesBuffer:c.buffer,renderInstructions:x.buffer},e);O.postMessage(a,[l.buffer,c.buffer,s.buffer,x.buffer]);break}case S:{const t=[],n=[],r=e.customAttributesSize,x=new Float32Array(e.renderInstructions);let o=0;for(;o<x.length;)o=R(x,o,t,n,r);const i=Uint32Array.from(n),f=Float32Array.from(t),u=Float32Array.from([]),s=Object.assign({indicesBuffer:i.buffer,vertexAttributesBuffer:f.buffer,instanceAttributesBuffer:u.buffer,renderInstructions:x.buffer},e);O.postMessage(s,[f.buffer,u.buffer,i.buffer,x.buffer]);break}}};';return new Worker(typeof Blob>"u"?"data:application/javascript;base64,"+Buffer.from(i,"binary").toString("base64"):URL.createObjectURL(new Blob([i],{type:"application/javascript"})))}const Ut={GENERATE_POLYGON_BUFFERS:"GENERATE_POLYGON_BUFFERS",GENERATE_POINT_BUFFERS:"GENERATE_POINT_BUFFERS",GENERATE_LINE_STRING_BUFFERS:"GENERATE_LINE_STRING_BUFFERS"};function eo(i,e){e=e||[];const t=256,r=t-1,n=Math.floor(i/t/t/t)/r,s=Math.floor(i/t/t)%t/r,o=Math.floor(i/t)%t/r,a=i%t/r;return e[0]=n*256*255+s*255,e[1]=o*256*255+a*255,e}function to(i){let e=0;const t=256,r=t-1;return e+=Math.round(i[0]*t*t*t*r),e+=Math.round(i[1]*t*t*r),e+=Math.round(i[2]*t*r),e+=Math.round(i[3]*r),e}function ji(i,e,t,r){let n=0;for(const s in e){const o=e[s],a=o.callback.call(t,t.feature);let l=(a==null?void 0:a[0])??a;l===oi&&console.warn('The "has" operator might return false positives.'),l===void 0?l=oi:l===null&&(l=0),i[r+n++]=l,!(!o.size||o.size===1)&&(i[r+n++]=a[1],!(o.size<3)&&(i[r+n++]=a[2],!(o.size<4)&&(i[r+n++]=a[3])))}return n}function Gr(i){return Object.keys(i).reduce((e,t)=>e+(i[t].size||1),0)}function Ud(i,e,t,r){const n=(2+Gr(t))*i.geometriesCount;(!e||e.length!==n)&&(e=new Float32Array(n));const s=[];let o=0;for(const a in i.entries){const l=i.entries[a];for(let c=0,u=l.flatCoordss.length;c<u;c++)s[0]=l.flatCoordss[c][0],s[1]=l.flatCoordss[c][1],He(r,s),e[o++]=s[0],e[o++]=s[1],o+=ji(e,t,l,o)}return e}function Bd(i,e,t,r){const n=3*i.verticesCount+(1+Gr(t))*i.geometriesCount;(!e||e.length!==n)&&(e=new Float32Array(n));const s=[];let o=0;for(const a in i.entries){const l=i.entries[a];for(let c=0,u=l.flatCoordss.length;c<u;c++){s.length=l.flatCoordss[c].length,us(l.flatCoordss[c],0,s.length,3,r,s,3),o+=ji(e,t,l,o),e[o++]=s.length/3;for(let h=0,f=s.length;h<f;h+=3)e[o++]=s[h],e[o++]=s[h+1],e[o++]=s[h+2]}}return e}function zd(i,e,t,r){const n=2*i.verticesCount+(1+Gr(t))*i.geometriesCount+i.ringsCount;(!e||e.length!==n)&&(e=new Float32Array(n));const s=[];let o=0;for(const a in i.entries){const l=i.entries[a];for(let c=0,u=l.flatCoordss.length;c<u;c++){s.length=l.flatCoordss[c].length,us(l.flatCoordss[c],0,s.length,2,r,s),o+=ji(e,t,l,o),e[o++]=l.ringsVerticesCounts[c].length;for(let h=0,f=l.ringsVerticesCounts[c].length;h<f;h++)e[o++]=l.ringsVerticesCounts[c][h];for(let h=0,f=s.length;h<f;h+=2)e[o++]=s[h],e[o++]=s[h+1]}}return e}function Pr(i){return(JSON.stringify(i).split("").reduce((t,r)=>(t<<5)-t+r.charCodeAt(0),0)>>>0).toString()}function Wi(i,e,t,r){if(`${r}radius`in i&&r!=="icon-"){let n=D(t,i[`${r}radius`],Y);if(`${r}radius2`in i){const s=D(t,i[`${r}radius2`],Y);n=`max(${n}, ${s})`}`${r}stroke-width`in i&&(n=`(${n} + ${D(t,i[`${r}stroke-width`],Y)} * 0.5)`),e.setSymbolSizeExpression(`vec2(${n} * 2. + 0.5)`)}if(`${r}scale`in i){const n=D(t,i[`${r}scale`],gt);e.setSymbolSizeExpression(`${e.getSymbolSizeExpression()} * ${n}`)}`${r}displacement`in i&&e.setSymbolOffsetExpression(D(t,i[`${r}displacement`],ht)),`${r}rotation`in i&&e.setSymbolRotationExpression(D(t,i[`${r}rotation`],Y)),`${r}rotate-with-view`in i&&e.setSymbolRotateWithView(!!i[`${r}rotate-with-view`])}function ro(i,e,t,r,n){let s="vec4(0.)";if(e!==null&&(s=e),t!==null&&r!==null){const l=`smoothstep(-${r} + 0.63, -${r} - 0.58, ${i})`;s=`mix(${t}, ${s}, ${l})`}const o=`(1.0 - smoothstep(-0.63, 0.58, ${i}))`;let a=`${s} * vec4(1.0, 1.0, 1.0, ${o})`;return n!==null&&(a=`${a} * vec4(1.0, 1.0, 1.0, ${n})`),a}function Zi(i,e,t,r,n){const s=new Image;s.crossOrigin=i[`${r}cross-origin`]===void 0?"anonymous":i[`${r}cross-origin`],be(typeof i[`${r}src`]=="string",`WebGL layers do not support expressions for the ${r}src style property`),s.src=i[`${r}src`],t[`u_texture${n}_size`]=()=>s.complete?[s.width,s.height]:[0,0],e.addUniform(`u_texture${n}_size`,"vec2");const o=`u_texture${n}_size`;return t[`u_texture${n}`]=s,e.addUniform(`u_texture${n}`,"sampler2D"),o}function Hi(i,e,t,r,n){let s=D(t,i[`${e}offset`],gt);if(`${e}offset-origin`in i)switch(i[`${e}offset-origin`]){case"top-right":s=`vec2(${r}.x, 0.) + ${n} * vec2(-1., 0.) + ${s} * vec2(-1., 1.)`;break;case"bottom-left":s=`vec2(0., ${r}.y) + ${n} * vec2(0., -1.) + ${s} * vec2(1., -1.)`;break;case"bottom-right":s=`${r} - ${n} - ${s}`;break}return s}function $d(i,e,t,r){r.functions.circleDistanceField=`float circleDistanceField(vec2 point, float radius) {
  return length(point) - radius;
}`,Wi(i,e,r,"circle-");let n=null;"circle-opacity"in i&&(n=D(r,i["circle-opacity"],Y));let s="coordsPx";"circle-scale"in i&&(s=`coordsPx / ${D(r,i["circle-scale"],gt)}`);let o=null;"circle-fill-color"in i&&(o=D(r,i["circle-fill-color"],Se));let a=null;"circle-stroke-color"in i&&(a=D(r,i["circle-stroke-color"],Se));let l=D(r,i["circle-radius"],Y),c=null;"circle-stroke-width"in i&&(c=D(r,i["circle-stroke-width"],Y),l=`(${l} + ${c} * 0.5)`);const u=`circleDistanceField(${s}, ${l})`,h=ro(u,o,a,c,n);e.setSymbolColorExpression(h)}function Xd(i,e,t,r){r.functions.round=`float round(float v) {
  return sign(v) * floor(abs(v) + 0.5);
}`,r.functions.starDistanceField=`float starDistanceField(vec2 point, float numPoints, float radius, float radius2, float angle) {
  float startAngle = -PI * 0.5 + angle; // tip starts upwards and rotates clockwise with angle
  float c = cos(startAngle);
  float s = sin(startAngle);
  vec2 pointRotated = vec2(c * point.x - s * point.y, s * point.x + c * point.y);
  float alpha = TWO_PI / numPoints; // the angle of one sector
  float beta = atan(pointRotated.y, pointRotated.x);
  float gamma = round(beta / alpha) * alpha; // angle in sector
  c = cos(-gamma);
  s = sin(-gamma);
  vec2 inSector = vec2(c * pointRotated.x - s * pointRotated.y, abs(s * pointRotated.x + c * pointRotated.y));
  vec2 tipToPoint = inSector + vec2(-radius, 0.);
  vec2 edgeNormal = vec2(radius2 * sin(alpha * 0.5), -radius2 * cos(alpha * 0.5) + radius);
  return dot(normalize(edgeNormal), tipToPoint);
}`,r.functions.regularDistanceField=`float regularDistanceField(vec2 point, float numPoints, float radius, float angle) {
  float startAngle = -PI * 0.5 + angle; // tip starts upwards and rotates clockwise with angle
  float c = cos(startAngle);
  float s = sin(startAngle);
  vec2 pointRotated = vec2(c * point.x - s * point.y, s * point.x + c * point.y);
  float alpha = TWO_PI / numPoints; // the angle of one sector
  float radiusIn = radius * cos(PI / numPoints);
  float beta = atan(pointRotated.y, pointRotated.x);
  float gamma = round((beta - alpha * 0.5) / alpha) * alpha + alpha * 0.5; // angle in sector from mid
  c = cos(-gamma);
  s = sin(-gamma);
  vec2 inSector = vec2(c * pointRotated.x - s * pointRotated.y, abs(s * pointRotated.x + c * pointRotated.y));
  return inSector.x - radiusIn;
}`,Wi(i,e,r,"shape-");let n=null;"shape-opacity"in i&&(n=D(r,i["shape-opacity"],Y));let s="coordsPx";"shape-scale"in i&&(s=`coordsPx / ${D(r,i["shape-scale"],gt)}`);let o=null;"shape-fill-color"in i&&(o=D(r,i["shape-fill-color"],Se));let a=null;"shape-stroke-color"in i&&(a=D(r,i["shape-stroke-color"],Se));let l=null;"shape-stroke-width"in i&&(l=D(r,i["shape-stroke-width"],Y));const c=D(r,i["shape-points"],Y);let u="0.";"shape-angle"in i&&(u=D(r,i["shape-angle"],Y));let h,f=D(r,i["shape-radius"],Y);if(l!==null&&(f=`${f} + ${l} * 0.5`),"shape-radius2"in i){let d=D(r,i["shape-radius2"],Y);l!==null&&(d=`${d} + ${l} * 0.5`),h=`starDistanceField(${s}, ${c}, ${f}, ${d}, ${u})`}else h=`regularDistanceField(${s}, ${c}, ${f}, ${u})`;const g=ro(h,o,a,l,n);e.setSymbolColorExpression(g)}function kd(i,e,t,r){let n="vec4(1.0)";"icon-color"in i&&(n=D(r,i["icon-color"],Se)),"icon-opacity"in i&&(n=`${n} * vec4(1.0, 1.0, 1.0, ${D(r,i["icon-opacity"],Y)})`);const s=Pr(i["icon-src"]),o=Zi(i,e,t,"icon-",s);if(e.setSymbolColorExpression(`${n} * texture2D(u_texture${s}, v_texCoord)`).setSymbolSizeExpression(o),"icon-width"in i&&"icon-height"in i&&e.setSymbolSizeExpression(`vec2(${D(r,i["icon-width"],Y)}, ${D(r,i["icon-height"],Y)})`),"icon-offset"in i&&"icon-size"in i){const a=D(r,i["icon-size"],ht),l=e.getSymbolSizeExpression();e.setSymbolSizeExpression(a);const c=Hi(i,"icon-",r,"v_quadSizePx",a);e.setTextureCoordinateExpression(`(vec4((${c}).xyxy) + vec4(0., 0., ${a})) / (${l}).xyxy`)}if(Wi(i,e,r,"icon-"),"icon-anchor"in i){const a=D(r,i["icon-anchor"],ht);let l="1.0";"icon-scale"in i&&(l=D(r,i["icon-scale"],gt));let c;i["icon-anchor-x-units"]==="pixels"&&i["icon-anchor-y-units"]==="pixels"?c=`${a} * ${l}`:i["icon-anchor-x-units"]==="pixels"?c=`${a} * vec2(vec2(${l}).x, v_quadSizePx.y)`:i["icon-anchor-y-units"]==="pixels"?c=`${a} * vec2(v_quadSizePx.x, vec2(${l}).x)`:c=`${a} * v_quadSizePx`;let u=`v_quadSizePx * vec2(0.5, -0.5) + ${c} * vec2(-1., 1.)`;if("icon-anchor-origin"in i)switch(i["icon-anchor-origin"]){case"top-right":u=`v_quadSizePx * -0.5 + ${c}`;break;case"bottom-left":u=`v_quadSizePx * 0.5 - ${c}`;break;case"bottom-right":u=`v_quadSizePx * vec2(-0.5, 0.5) + ${c} * vec2(1., -1.)`;break}e.setSymbolOffsetExpression(`${e.getSymbolOffsetExpression()} + ${u}`)}}function jd(i,e,t,r){if("stroke-color"in i&&e.setStrokeColorExpression(D(r,i["stroke-color"],Se)),"stroke-pattern-src"in i){const n=Pr(i["stroke-pattern-src"]),s=Zi(i,e,t,"stroke-pattern-",n);let o=s,a="vec2(0.)";"stroke-pattern-offset"in i&&"stroke-pattern-size"in i&&(o=D(r,i["stroke-pattern-size"],ht),a=Hi(i,"stroke-pattern-",r,s,o));let l="0.";"stroke-pattern-spacing"in i&&(l=D(r,i["stroke-pattern-spacing"],Y));let c="0.";"stroke-pattern-start-offset"in i&&(c=D(r,i["stroke-pattern-start-offset"],Y)),r.functions.sampleStrokePattern=`vec4 sampleStrokePattern(sampler2D texture, vec2 textureSize, vec2 textureOffset, vec2 sampleSize, float spacingPx, float startOffsetPx, float currentLengthPx, float currentRadiusRatio, float lineWidth) {
  float currentLengthScaled = (currentLengthPx - startOffsetPx) * sampleSize.y / lineWidth;
  float spacingScaled = spacingPx * sampleSize.y / lineWidth;
  float uCoordPx = mod(currentLengthScaled, (sampleSize.x + spacingScaled));
  float isInsideOfPattern = step(uCoordPx, sampleSize.x);
  float vCoordPx = (-currentRadiusRatio * 0.5 + 0.5) * sampleSize.y;
  // make sure that we're not sampling too close to the borders to avoid interpolation with outside pixels
  uCoordPx = clamp(uCoordPx, 0.5, sampleSize.x - 0.5);
  vCoordPx = clamp(vCoordPx, 0.5, sampleSize.y - 0.5);
  vec2 texCoord = (vec2(uCoordPx, vCoordPx) + textureOffset) / textureSize;
  return texture2D(texture, texCoord) * vec4(1.0, 1.0, 1.0, isInsideOfPattern);
}`;const u=`u_texture${n}`;let h="1.";"stroke-color"in i&&(h=e.getStrokeColorExpression()),e.setStrokeColorExpression(`${h} * sampleStrokePattern(${u}, ${s}, ${a}, ${o}, ${l}, ${c}, currentLengthPx, currentRadiusRatio, v_width)`),r.functions.computeStrokePatternLength=`float computeStrokePatternLength(vec2 sampleSize, float spacingPx, float lineWidth) {
  float patternLengthPx = sampleSize.x / sampleSize.y * lineWidth;
  return patternLengthPx + spacingPx;
}`,e.setStrokePatternLengthExpression(`computeStrokePatternLength(${o}, ${l}, v_width)`)}if("stroke-width"in i&&e.setStrokeWidthExpression(D(r,i["stroke-width"],Y)),"stroke-offset"in i&&e.setStrokeOffsetExpression(D(r,i["stroke-offset"],Y)),"stroke-line-cap"in i&&e.setStrokeCapExpression(D(r,i["stroke-line-cap"],kt)),"stroke-line-join"in i&&e.setStrokeJoinExpression(D(r,i["stroke-line-join"],kt)),"stroke-miter-limit"in i&&e.setStrokeMiterLimitExpression(D(r,i["stroke-miter-limit"],Y)),"stroke-line-dash"in i){r.functions.getSingleDashDistance=`float getSingleDashDistance(float distance, float radius, float dashOffset, float dashLength, float dashLengthTotal, float capType, float lineWidth) {
  float localDistance = mod(distance, dashLengthTotal);
  float distanceSegment = abs(localDistance - dashOffset - dashLength * 0.5) - dashLength * 0.5;
  distanceSegment = min(distanceSegment, dashLengthTotal - localDistance);
  if (capType == ${je("square")}) {
    distanceSegment -= lineWidth * 0.5;
  } else if (capType == ${je("round")}) {
    distanceSegment = min(distanceSegment, sqrt(distanceSegment * distanceSegment + radius * radius) - lineWidth * 0.5);
  }
  return distanceSegment;
}`;let n=i["stroke-line-dash"].map(d=>D(r,d,Y));n.length%2===1&&(n=[...n,...n]);let s="0.";"stroke-line-dash-offset"in i&&(s=D(r,i["stroke-line-dash-offset"],Y));const a=`dashDistanceField_${Pr(i["stroke-line-dash"])}`,l=n.map((d,m)=>`float dashLength${m}`).join(", "),c=n.map((d,m)=>`dashLength${m}`).join(" + ");let u="0.",h=`getSingleDashDistance(distance, radius, ${u}, dashLength0, totalDashLength, capType, lineWidth)`;for(let d=2;d<n.length;d+=2)u=`${u} + dashLength${d-2} + dashLength${d-1}`,h=`min(${h}, getSingleDashDistance(distance, radius, ${u}, dashLength${d}, totalDashLength, capType, lineWidth))`;r.functions[a]=`float ${a}(float distance, float radius, float capType, float lineWidth, ${l}) {
  float totalDashLength = ${c};
  return ${h};
}`;const f=n.map((d,m)=>`${d}`).join(", ");e.setStrokeDistanceFieldExpression(`${a}(currentLengthPx + ${s}, currentRadiusPx, capType, v_width, ${f})`);let g=n.join(" + ");e.getStrokePatternLengthExpression()&&(r.functions.combinePatternLengths=`float combinePatternLengths(float patternLength1, float patternLength2) {
  return patternLength1 * patternLength2;
}`,g=`combinePatternLengths(${e.getStrokePatternLengthExpression()}, ${g})`),e.setStrokePatternLengthExpression(g)}}function Wd(i,e,t,r){if("fill-color"in i&&e.setFillColorExpression(D(r,i["fill-color"],Se)),"fill-pattern-src"in i){const n=Pr(i["fill-pattern-src"]),s=Zi(i,e,t,"fill-pattern-",n);let o=s,a="vec2(0.)";"fill-pattern-offset"in i&&"fill-pattern-size"in i&&(o=D(r,i["fill-pattern-size"],ht),a=Hi(i,"fill-pattern-",r,s,o)),r.functions.sampleFillPattern=`vec4 sampleFillPattern(sampler2D texture, vec2 textureSize, vec2 textureOffset, vec2 sampleSize, vec2 pxOrigin, vec2 pxPosition) {
  float scaleRatio = pow(2., mod(u_zoom + 0.5, 1.) - 0.5);
  vec2 pxRelativePos = pxPosition - pxOrigin;
  // rotate the relative position from origin by the current view rotation
  pxRelativePos = vec2(pxRelativePos.x * cos(u_rotation) - pxRelativePos.y * sin(u_rotation), pxRelativePos.x * sin(u_rotation) + pxRelativePos.y * cos(u_rotation));
  // sample position is computed according to the sample offset & size
  vec2 samplePos = mod(pxRelativePos / scaleRatio, sampleSize);
  // also make sure that we're not sampling too close to the borders to avoid interpolation with outside pixels
  samplePos = clamp(samplePos, vec2(0.5), sampleSize - vec2(0.5));
  samplePos.y = sampleSize.y - samplePos.y; // invert y axis so that images appear upright
  return texture2D(texture, (samplePos + textureOffset) / textureSize);
}`;const l=`u_texture${n}`;let c="1.";"fill-color"in i&&(c=e.getFillColorExpression()),e.setFillColorExpression(`${c} * sampleFillPattern(${l}, ${s}, ${a}, ${o}, pxOrigin, pxPos)`)}}function li(i,e,t){const r=$i(),n=new Js,s={};if("icon-src"in i?kd(i,n,s,r):"shape-points"in i?Xd(i,n,s,r):"circle-radius"in i&&$d(i,n,s,r),jd(i,n,s,r),Wd(i,n,s,r),t){const l=D(r,t,Xt);n.setFragmentDiscardExpression(`!${l}`)}const o={};function a(l,c,u,h){if(!r[l])return;const f=ai(u),g=ki(u);n.addAttribute(`a_${c}`,f),o[c]={size:g,callback:h}}return a("geometryType",Vs,kt,l=>vt(la(l.getGeometry()))),a("featureId",Hs,kt|Y,l=>{const c=l.getId()??null;return typeof c=="string"?vt(c):c}),Ys(n,r),{builder:n,attributes:{...o,...Ks(r)},uniforms:{...s,...qs(r,e)}}}const Zd=[];let Wr;function Hd(){return Wr||(Wr=Qs()),Wr}let Vd=0;const Ce={POSITION:"a_position",LOCAL_POSITION:"a_localPosition",SEGMENT_START:"a_segmentStart",SEGMENT_END:"a_segmentEnd",MEASURE_START:"a_measureStart",MEASURE_END:"a_measureEnd",ANGLE_TANGENT_SUM:"a_angleTangentSum",JOIN_ANGLES:"a_joinAngles",DISTANCE_LOW:"a_distanceLow",DISTANCE_HIGH:"a_distanceHigh"};class Yd{constructor(e,t,r,n){this.helper_,this.hitDetectionEnabled_=!!n,this.styleShaders=qd(e,t),this.customAttributes_={},this.uniforms_={},this.hitDetectionEnabled_&&(this.customAttributes_.hitColor={callback(){return eo(this.ref,Zd)},size:2});for(const s of this.styleShaders){for(const o in s.attributes)o in this.customAttributes_||(this.customAttributes_[o]=s.attributes[o]);for(const o in s.uniforms)o in this.uniforms_||(this.uniforms_[o]=s.uniforms[o])}this.renderPasses_=this.styleShaders.map(s=>{const o={},a=Object.entries(this.customAttributes_).map(([l,c])=>({name:l in s.attributes||l==="hitColor"?`a_${l}`:null,size:c.size||1,type:de.FLOAT}));return s.builder.getFillVertexShader()&&(o.fillRenderPass={vertexShader:s.builder.getFillVertexShader(),fragmentShader:s.builder.getFillFragmentShader(),attributesDesc:[{name:Ce.POSITION,size:2,type:de.FLOAT},...a],instancedAttributesDesc:[],instancePrimitiveVertexCount:3}),s.builder.getStrokeVertexShader()&&(o.strokeRenderPass={vertexShader:s.builder.getStrokeVertexShader(),fragmentShader:s.builder.getStrokeFragmentShader(),attributesDesc:[{name:Ce.LOCAL_POSITION,size:2,type:de.FLOAT}],instancedAttributesDesc:[{name:Ce.SEGMENT_START,size:2,type:de.FLOAT},{name:Ce.MEASURE_START,size:1,type:de.FLOAT},{name:Ce.SEGMENT_END,size:2,type:de.FLOAT},{name:Ce.MEASURE_END,size:1,type:de.FLOAT},{name:Ce.JOIN_ANGLES,size:2,type:de.FLOAT},{name:Ce.DISTANCE_LOW,size:1,type:de.FLOAT},{name:Ce.DISTANCE_HIGH,size:1,type:de.FLOAT},{name:Ce.ANGLE_TANGENT_SUM,size:1,type:de.FLOAT},...a],instancePrimitiveVertexCount:6}),s.builder.getSymbolVertexShader()&&(o.symbolRenderPass={vertexShader:s.builder.getSymbolVertexShader(),fragmentShader:s.builder.getSymbolFragmentShader(),attributesDesc:[{name:Ce.LOCAL_POSITION,size:2,type:de.FLOAT}],instancedAttributesDesc:[{name:Ce.POSITION,size:2,type:de.FLOAT},...a],instancePrimitiveVertexCount:6}),o}),this.hasFill_=this.renderPasses_.some(s=>s.fillRenderPass),this.hasStroke_=this.renderPasses_.some(s=>s.strokeRenderPass),this.hasSymbol_=this.renderPasses_.some(s=>s.symbolRenderPass),this.setHelper(r)}async generateBuffers(e,t){if(e.isEmpty())return null;const r=this.generateRenderInstructions_(e,t),[n,s,o]=await Promise.all([this.generateBuffersForType_(r.polygonInstructions,"Polygon",t),this.generateBuffersForType_(r.lineStringInstructions,"LineString",t),this.generateBuffersForType_(r.pointInstructions,"Point",t)]),a=jt(_e(),t);return{polygonBuffers:n,lineStringBuffers:s,pointBuffers:o,invertVerticesTransform:a}}generateRenderInstructions_(e,t){const r=this.hasFill_?zd(e.polygonBatch,new Float32Array(0),this.customAttributes_,t):null,n=this.hasStroke_?Bd(e.lineStringBatch,new Float32Array(0),this.customAttributes_,t):null,s=this.hasSymbol_?Ud(e.pointBatch,new Float32Array(0),this.customAttributes_,t):null;return{polygonInstructions:r,lineStringInstructions:n,pointInstructions:s}}generateBuffersForType_(e,t,r){if(e===null)return null;const n=Vd++;let s;switch(t){case"Polygon":s=Ut.GENERATE_POLYGON_BUFFERS;break;case"LineString":s=Ut.GENERATE_LINE_STRING_BUFFERS;break;case"Point":s=Ut.GENERATE_POINT_BUFFERS;break}const o={id:n,type:s,renderInstructions:e.buffer,renderInstructionsTransform:r,customAttributesSize:Gr(this.customAttributes_)},a=Hd();return a.postMessage(o,[e.buffer]),e=null,new Promise(l=>{const c=u=>{const h=u.data;if(h.id!==n||(a.removeEventListener("message",c),!this.helper_.getGL()))return;const f=new tt(er,Pt).fromArrayBuffer(h.indicesBuffer),g=new tt(ft,Pt).fromArrayBuffer(h.vertexAttributesBuffer),d=new tt(ft,Pt).fromArrayBuffer(h.instanceAttributesBuffer);this.helper_.flushBufferData(f),this.helper_.flushBufferData(g),this.helper_.flushBufferData(d),l([f,g,d])};a.addEventListener("message",c)})}render(e,t,r){for(const n of this.renderPasses_)n.fillRenderPass&&this.renderInternal_(e.polygonBuffers[0],e.polygonBuffers[1],e.polygonBuffers[2],n.fillRenderPass,t,r),n.strokeRenderPass&&this.renderInternal_(e.lineStringBuffers[0],e.lineStringBuffers[1],e.lineStringBuffers[2],n.strokeRenderPass,t,r),n.symbolRenderPass&&this.renderInternal_(e.pointBuffers[0],e.pointBuffers[1],e.pointBuffers[2],n.symbolRenderPass,t,r)}renderInternal_(e,t,r,n,s,o){const a=e.getSize();if(a===0)return;const l=n.instancedAttributesDesc.length;if(this.helper_.useProgram(n.program,s),this.helper_.bindBuffer(t),this.helper_.bindBuffer(e),this.helper_.enableAttributes(n.attributesDesc),this.helper_.bindBuffer(r),this.helper_.enableAttributesInstanced(n.instancedAttributesDesc),o(),l){const c=n.instancedAttributesDesc.reduce((h,f)=>h+(f.size||1),0),u=r.getSize()/c;this.helper_.drawElementsInstanced(0,a,u)}else this.helper_.drawElements(0,a)}setHelper(e,t=null){this.helper_=e;for(const r of this.renderPasses_)r.fillRenderPass&&(r.fillRenderPass.program=this.helper_.getProgram(r.fillRenderPass.fragmentShader,r.fillRenderPass.vertexShader)),r.strokeRenderPass&&(r.strokeRenderPass.program=this.helper_.getProgram(r.strokeRenderPass.fragmentShader,r.strokeRenderPass.vertexShader)),r.symbolRenderPass&&(r.symbolRenderPass.program=this.helper_.getProgram(r.symbolRenderPass.fragmentShader,r.symbolRenderPass.vertexShader));this.helper_.addUniforms(this.uniforms_),t&&(t.polygonBuffers&&(this.helper_.flushBufferData(t.polygonBuffers[0]),this.helper_.flushBufferData(t.polygonBuffers[1]),this.helper_.flushBufferData(t.polygonBuffers[2])),t.lineStringBuffers&&(this.helper_.flushBufferData(t.lineStringBuffers[0]),this.helper_.flushBufferData(t.lineStringBuffers[1]),this.helper_.flushBufferData(t.lineStringBuffers[2])),t.pointBuffers&&(this.helper_.flushBufferData(t.pointBuffers[0]),this.helper_.flushBufferData(t.pointBuffers[1]),this.helper_.flushBufferData(t.pointBuffers[2])))}}function qd(i,e){const t=Array.isArray(i)?i:[i];if("style"in t[0]){const r=[],n=t,s=[];for(const o of n){const a=Array.isArray(o.style)?o.style:[o.style];let l=o.filter;o.else&&s.length&&(l=["all",...s.map(u=>["!",u])],o.filter&&l.push(o.filter),l.length<3&&(l=l[1])),o.filter&&s.push(o.filter);const c=a.map(u=>li(u,e,l));r.push(...c)}return r}return"builder"in t[0]?t:t.map(r=>li(r,e,null))}const Oe=new Uint8Array(4);class io{constructor(e,t){this.helper_=e;const r=e.getGL();this.texture_=r.createTexture(),this.framebuffer_=r.createFramebuffer(),this.depthbuffer_=r.createRenderbuffer(),this.size_=t||[1,1],this.data_=new Uint8Array(0),this.dataCacheDirty_=!0,this.updateSize_()}setSize(e){ca(e,this.size_)||(this.size_[0]=e[0],this.size_[1]=e[1],this.updateSize_())}getSize(){return this.size_}clearCachedData(){this.dataCacheDirty_=!0}readAll(){if(this.dataCacheDirty_){const e=this.size_,t=this.helper_.getGL();t.bindFramebuffer(t.FRAMEBUFFER,this.framebuffer_),t.readPixels(0,0,e[0],e[1],t.RGBA,t.UNSIGNED_BYTE,this.data_),this.dataCacheDirty_=!1}return this.data_}readPixel(e,t){if(e<0||t<0||e>this.size_[0]||t>=this.size_[1])return Oe[0]=0,Oe[1]=0,Oe[2]=0,Oe[3]=0,Oe;this.readAll();const r=Math.floor(e)+(this.size_[1]-Math.floor(t)-1)*this.size_[0];return Oe[0]=this.data_[r*4],Oe[1]=this.data_[r*4+1],Oe[2]=this.data_[r*4+2],Oe[3]=this.data_[r*4+3],Oe}getTexture(){return this.texture_}getFramebuffer(){return this.framebuffer_}getDepthbuffer(){return this.depthbuffer_}updateSize_(){const e=this.size_,t=this.helper_.getGL();this.texture_=this.helper_.createTexture(e,null,this.texture_),t.bindFramebuffer(t.FRAMEBUFFER,this.framebuffer_),t.viewport(0,0,e[0],e[1]),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.texture_,0),t.bindRenderbuffer(t.RENDERBUFFER,this.depthbuffer_),t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT16,e[0],e[1]),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,this.depthbuffer_),this.data_=new Uint8Array(e[0]*e[1]*4)}}function no(i,e){const t=i.viewState.projection,n=e.getSource().getWrapX()&&t.canWrapX(),s=t.getExtent(),o=i.extent,a=n?Ee(s):null,l=n?Math.ceil((o[2]-s[2])/a)+1:1;return[n?Math.floor((o[0]-s[0])/a):0,l,a]}const Tt={...De,RENDER_EXTENT:"u_renderExtent",PATTERN_ORIGIN:"u_patternOrigin",GLOBAL_ALPHA:"u_globalAlpha"};class so extends tr{constructor(e,t){const r={[Tt.RENDER_EXTENT]:[0,0,0,0],[Tt.PATTERN_ORIGIN]:[0,0],[Tt.GLOBAL_ALPHA]:1};super(e,{uniforms:r,postProcesses:t.postProcesses}),this.hitDetectionEnabled_=!t.disableHitDetection,this.hitRenderTarget_,this.sourceRevision_=-1,this.previousExtent_=Vt(),this.currentTransform_=_e(),this.tmpCoords_=[0,0],this.tmpTransform_=_e(),this.tmpMat4_=mt(),this.currentFrameStateTransform_=_e(),this.styleVariables_={},this.style_=[],this.styleRenderer_=null,this.buffers_=null,this.applyOptions_(t),this.batch_=new Sr,this.initialFeaturesAdded_=!1,this.sourceListenKeys_=null}addInitialFeatures_(e){const t=this.getLayer().getSource();let r;this.batch_.addFeatures(t.getFeatures(),r),this.sourceListenKeys_=[We(t,Je.ADDFEATURE,this.handleSourceFeatureAdded_.bind(this,r)),We(t,Je.CHANGEFEATURE,this.handleSourceFeatureChanged_.bind(this,r),this),We(t,Je.REMOVEFEATURE,this.handleSourceFeatureDelete_,this),We(t,Je.CLEAR,this.handleSourceFeatureClear_,this)]}applyOptions_(e){this.styleVariables_=e.variables,this.style_=e.style}createRenderers_(){this.buffers_=null,this.styleRenderer_=new Yd(this.style_,this.styleVariables_,this.helper,this.hitDetectionEnabled_)}reset(e){this.applyOptions_(e),this.helper&&this.createRenderers_(),super.reset(e)}afterHelperCreated(){this.styleRenderer_?this.styleRenderer_.setHelper(this.helper,this.buffers_):this.createRenderers_(),this.hitDetectionEnabled_&&(this.hitRenderTarget_=new io(this.helper))}handleSourceFeatureAdded_(e,t){const r=t.feature;this.batch_.addFeature(r,e)}handleSourceFeatureChanged_(e,t){const r=t.feature;this.batch_.changeFeature(r,e)}handleSourceFeatureDelete_(e){const t=e.feature;this.batch_.removeFeature(t)}handleSourceFeatureClear_(){this.batch_.clear()}applyUniforms_(e){ua(this.tmpTransform_,this.currentFrameStateTransform_),zt(this.tmpTransform_,e),this.helper.setUniformMatrixValue(Tt.PROJECTION_MATRIX,xr(this.tmpMat4_,this.tmpTransform_)),jt(this.tmpTransform_,this.tmpTransform_),this.helper.setUniformMatrixValue(Tt.SCREEN_TO_WORLD_MATRIX,xr(this.tmpMat4_,this.tmpTransform_)),this.tmpCoords_[0]=0,this.tmpCoords_[1]=0,jt(this.tmpTransform_,e),He(this.tmpTransform_,this.tmpCoords_),this.helper.setUniformFloatVec2(Tt.PATTERN_ORIGIN,this.tmpCoords_)}renderFrame(e){const t=this.helper.getGL();this.preRender(t,e);const[r,n,s]=no(e,this.getLayer());this.helper.prepareDraw(e),this.renderWorlds(e,!1,r,n,s),this.helper.finalizeDraw(e,this.dispatchPreComposeEvent,this.dispatchPostComposeEvent);const o=this.helper.getCanvas();return this.hitDetectionEnabled_&&(this.renderWorlds(e,!0,r,n,s),this.hitRenderTarget_.clearCachedData()),this.postRender(t,e),o}prepareFrameInternal(e){this.initialFeaturesAdded_||(this.addInitialFeatures_(e),this.initialFeaturesAdded_=!0);const t=this.getLayer(),r=t.getSource(),n=e.viewState,s=!e.viewHints[st.ANIMATING]&&!e.viewHints[st.INTERACTING],o=!$t(this.previousExtent_,e.extent),a=this.sourceRevision_<r.getRevision();if(a&&(this.sourceRevision_=r.getRevision()),s&&(o||a)){const l=n.projection,c=n.resolution,u=t instanceof Ar?t.getRenderBuffer():0,h=yi(e.extent,u*c);r.loadFeatures(h,c,l),this.ready=!1;const f=this.helper.makeProjectionTransform(e,_e());this.styleRenderer_.generateBuffers(this.batch_,f).then(g=>{this.buffers_&&this.disposeBuffers(this.buffers_),this.buffers_=g,this.ready=!0,this.getLayer().changed()}),this.previousExtent_=e.extent.slice()}return!0}renderWorlds(e,t,r,n,s){let o=r;t&&(this.hitRenderTarget_.setSize([Math.floor(e.size[0]/2),Math.floor(e.size[1]/2)]),this.helper.prepareDrawToRenderTarget(e,this.hitRenderTarget_,!0));do this.helper.makeProjectionTransform(e,this.currentFrameStateTransform_),Ei(this.currentFrameStateTransform_,o*s,0),this.buffers_&&this.styleRenderer_.render(this.buffers_,e,()=>{this.applyUniforms_(this.buffers_.invertVerticesTransform),this.helper.applyHitDetectionUniform(t)});while(++o<n)}forEachFeatureAtCoordinate(e,t,r,n,s){if(be(this.hitDetectionEnabled_,"`forEachFeatureAtCoordinate` cannot be used on a WebGL layer if the hit detection logic has been disabled using the `disableHitDetection: true` option."),!this.styleRenderer_||!this.hitDetectionEnabled_)return;const o=He(t.coordinateToPixelTransform,e.slice()),a=this.hitRenderTarget_.readPixel(o[0]/2,o[1]/2),l=[a[0]/255,a[1]/255,a[2]/255,a[3]/255],c=to(l),u=this.batch_.getFeatureFromRef(c);if(u)return n(u,this.getLayer(),null)}disposeBuffers(e){const t=r=>{for(const n of r)n&&this.helper.deleteBuffer(n)};e.pointBuffers&&t(e.pointBuffers),e.lineStringBuffers&&t(e.lineStringBuffers),e.polygonBuffers&&t(e.polygonBuffers)}disposeInternal(){this.buffers_&&this.disposeBuffers(this.buffers_),this.sourceListenKeys_&&(this.sourceListenKeys_.forEach(function(e){_r(e)}),this.sourceListenKeys_=null),super.disposeInternal()}renderDeclutter(){}}const Xe={BLUR:"blur",GRADIENT:"gradient",RADIUS:"radius"},Kd=["#00f","#0ff","#0f0","#ff0","#f00"];class Jd extends Ar{constructor(e){e=e||{};const t=Object.assign({},e);delete t.gradient,delete t.radius,delete t.blur,delete t.weight,super(t),this.filter_=e.filter??!0,this.styleVariables_=e.variables||{},this.gradient_=null,this.addChangeListener(Xe.GRADIENT,this.handleGradientChanged_),this.setGradient(e.gradient?e.gradient:Kd),this.setBlur(e.blur!==void 0?e.blur:15),this.setRadius(e.radius!==void 0?e.radius:8);const r=e.weight?e.weight:"weight";this.weight_=r,this.setRenderOrder(null)}getBlur(){return this.get(Xe.BLUR)}getGradient(){return this.get(Xe.GRADIENT)}getRadius(){return this.get(Xe.RADIUS)}handleGradientChanged_(){this.gradient_=Qd(this.getGradient())}setBlur(e){const t=this.get(Xe.BLUR);if(this.set(Xe.BLUR,e),typeof e=="number"&&typeof t=="number"){this.changed();return}this.clearRenderer()}setGradient(e){this.set(Xe.GRADIENT,e)}setRadius(e){const t=this.get(Xe.RADIUS);if(this.set(Xe.RADIUS,e),typeof e=="number"&&typeof t=="number"){this.changed();return}this.clearRenderer()}setFilter(e){this.filter_=e,this.changed(),this.clearRenderer()}setWeight(e){this.weight_=e,this.changed(),this.clearRenderer()}createRenderer(){const e=new Js,t=$i(),r=D(t,this.filter_,Xt);let n=D(t,this.getRadius(),Y),s=D(t,this.getBlur(),Y);const o={};typeof this.getBlur()=="number"&&(s="a_blur",o.a_blur=()=>this.getBlur(),e.addUniform("a_blur","float")),typeof this.getRadius()=="number"&&(n="a_radius",o.a_radius=()=>this.getRadius(),e.addUniform("a_radius","float"));const a={};let l=null;if(typeof this.weight_=="string"||typeof this.weight_=="function"){const h=typeof this.weight_=="string"?f=>f.get(this.weight_):this.weight_;a.prop_weight={size:1,callback:f=>{const g=h(f);return g!==void 0?ue(g,0,1):1}},l="a_prop_weight",e.addAttribute("a_prop_weight","float")}else{const h=["clamp",this.weight_,0,1];l=D(t,h,Y)}e.addFragmentShaderFunction(`float getBlurSlope() {
  float blur = max(1., ${s});
  float radius = ${n};
  return radius / blur;
}`).setSymbolSizeExpression(`vec2(${n} + ${s}) * 2.`).setSymbolColorExpression(`vec4(smoothstep(0., 1., (1. - length(coordsPx * 2. / v_quadSizePx)) * getBlurSlope()) * ${l})`).setStrokeColorExpression(`vec4(smoothstep(0., 1., (1. - length(currentRadiusPx * 2. / v_width)) * getBlurSlope()) * ${l})`).setStrokeWidthExpression(`(${n} + ${s}) * 2.`).setFillColorExpression(`vec4(${l})`).setFragmentDiscardExpression(`!${r}`),Ys(e,t);const c=Ks(t),u=qs(t,this.styleVariables_);return new so(this,{className:this.getClassName(),variables:this.styleVariables_,style:{builder:e,attributes:{...c,...a},uniforms:{...u,...o}},disableHitDetection:!1,postProcesses:[{fragmentShader:`
            precision mediump float;

            uniform sampler2D u_image;
            uniform sampler2D u_gradientTexture;
            uniform float u_opacity;

            varying vec2 v_texCoord;

            void main() {
              vec4 color = texture2D(u_image, v_texCoord);
              gl_FragColor.a = color.a * u_opacity;
              gl_FragColor.rgb = texture2D(u_gradientTexture, vec2(0.5, color.a)).rgb;
              gl_FragColor.rgb *= gl_FragColor.a;
            }`,uniforms:{u_gradientTexture:()=>this.gradient_,u_opacity:()=>this.getOpacity()}}]})}updateStyleVariables(e){Object.assign(this.styleVariables_,e),this.changed()}renderDeclutter(){}}function Qd(i){const r=nt(1,256),n=r.createLinearGradient(0,0,1,256),s=1/(i.length-1);for(let o=0,a=i.length;o<a;++o)n.addColorStop(o*s,i[o]);return r.fillStyle=n,r.fillRect(0,0,1,256),r.canvas}class Vi extends hs{constructor(e,t,r,n,s){const o=s!==void 0?ct.IDLE:ct.LOADED;super(e,t,r,o),this.loader_=s!==void 0?s:null,this.canvas_=n,this.error_=null}getError(){return this.error_}handleLoad_(e){e?(this.error_=e,this.state=ct.ERROR):this.state=ct.LOADED,this.changed()}load(){this.state==ct.IDLE&&(this.state=ct.LOADING,this.changed(),this.loader_(this.handleLoad_.bind(this)))}getImage(){return this.canvas_}}class ef extends ha{constructor(e){super(e),this.vectorRenderer_=new da(e),this.layerImageRatio_=e.getImageRatio(),this.coordinateToVectorPixelTransform_=_e(),this.renderedPixelToCoordinateTransform_=null}disposeInternal(){this.vectorRenderer_.dispose(),super.disposeInternal()}getFeatures(e){if(!this.vectorRenderer_)return Promise.resolve([]);const t=He(this.coordinateToVectorPixelTransform_,He(this.renderedPixelToCoordinateTransform_,e.slice()));return this.vectorRenderer_.getFeatures(t)}handleFontsChanged(){this.vectorRenderer_.handleFontsChanged()}prepareFrame(e){var u;const t=e.pixelRatio,r=e.viewState,n=r.resolution,s=e.viewHints,o=this.vectorRenderer_;let a=e.extent;this.layerImageRatio_!==1&&(a=a.slice(0),ds(a,this.layerImageRatio_));const l=Ee(a)/n,c=Me(a)/n;if(!s[st.ANIMATING]&&!s[st.INTERACTING]&&!gi(a)){o.useContainer(null,null);const h=o.context,f=e.layerStatesArray[e.layerIndex],g=Object.assign({},f,{opacity:1}),d=Object.assign({},e,{extent:a,size:[l,c],viewState:Object.assign({},e.viewState,{rotation:0}),layerStatesArray:[g],layerIndex:0,declutter:null}),m=this.getLayer().getDeclutter();m&&(d.declutter={[m]:new fa(9)});const _=new Vi(a,n,t,h.canvas,function(y){o.prepareFrame(d)&&o.replayGroupChanged&&(o.clipping=!1,o.renderFrame(d,null),o.renderDeclutter(d),o.renderDeferred(d),y())});_.addEventListener(xe.CHANGE,()=>{if(_.getState()!==ct.LOADED)return;this.image=_;const y=_.getPixelRatio(),T=ga(_.getResolution())*t/y;this.renderedResolution=T,this.coordinateToVectorPixelTransform_=pi(this.coordinateToVectorPixelTransform_,l/2,c/2,1/T,-1/T,0,-r.center[0],-r.center[1])}),_.load()}return this.image&&(this.renderedPixelToCoordinateTransform_=e.pixelToCoordinateTransform.slice()),!((u=this.getLayer().getSource())!=null&&u.loading)&&!!this.image}preRender(){}postRender(){}renderDeclutter(){}forEachFeatureAtCoordinate(e,t,r,n,s){return this.vectorRenderer_?this.vectorRenderer_.forEachFeatureAtCoordinate(e,t,r,n,s):super.forEachFeatureAtCoordinate(e,t,r,n,s)}}class tf extends Ar{constructor(e){e=e||{};const t=Object.assign({},e);delete t.imageRatio,super(t),this.imageRatio_=e.imageRatio!==void 0?e.imageRatio:1}getImageRatio(){return this.imageRatio_}createRenderer(){return new ef(this)}}class rf extends tr{constructor(e,t){const r=t.uniforms||{},n=_e();r[De.PROJECTION_MATRIX]=n,super(e,{uniforms:r,postProcesses:t.postProcesses}),this.sourceRevision_=-1,this.verticesBuffer_=new tt(ft,Pt),this.instanceAttributesBuffer_=new tt(ft,Pt),this.indicesBuffer_=new tt(er,Pt),this.vertexShader_=t.vertexShader,this.fragmentShader_=t.fragmentShader,this.program_,this.hitDetectionEnabled_=t.hitDetectionEnabled??!0;const s=t.attributes?t.attributes.map(function(a){return{name:"a_"+a.name,size:1,type:de.FLOAT}}):[];this.attributes=[{name:"a_localPosition",size:2,type:de.FLOAT}],this.instanceAttributes=[{name:"a_position",size:2,type:de.FLOAT}],this.hitDetectionEnabled_&&(this.instanceAttributes.push({name:"a_hitColor",size:2,type:de.FLOAT}),this.instanceAttributes.push({name:"a_featureUid",size:1,type:de.FLOAT})),this.instanceAttributes.push(...s),this.customAttributes=t.attributes?t.attributes:[],this.previousExtent_=Vt(),this.currentTransform_=n,this.renderTransform_=_e(),this.invertRenderTransform_=_e(),this.renderInstructions_=new Float32Array(0),this.hitRenderTarget_,this.lastSentId=0,this.worker_=Qs(),this.worker_.addEventListener("message",a=>{const l=a.data;if(l.type===Ut.GENERATE_POINT_BUFFERS){const c=l.projectionTransform;this.verticesBuffer_.fromArrayBuffer(l.vertexAttributesBuffer),this.instanceAttributesBuffer_.fromArrayBuffer(l.instanceAttributesBuffer),this.helper.flushBufferData(this.verticesBuffer_),this.helper.flushBufferData(this.instanceAttributesBuffer_),this.indicesBuffer_.fromArrayBuffer(l.indicesBuffer),this.helper.flushBufferData(this.indicesBuffer_),this.renderTransform_=c,jt(this.invertRenderTransform_,this.renderTransform_),this.renderInstructions_=new Float32Array(a.data.renderInstructions),l.id===this.lastSentId&&(this.ready=!0),this.getLayer().changed()}}),this.featureCache_={},this.featureCount_=0;const o=this.getLayer().getSource();this.sourceListenKeys_=[We(o,Je.ADDFEATURE,this.handleSourceFeatureAdded_,this),We(o,Je.CHANGEFEATURE,this.handleSourceFeatureChanged_,this),We(o,Je.REMOVEFEATURE,this.handleSourceFeatureDelete_,this),We(o,Je.CLEAR,this.handleSourceFeatureClear_,this)],o.forEachFeature(a=>{const l=a.getGeometry();l&&l.getType()==="Point"&&(this.featureCache_[J(a)]={feature:a,properties:a.getProperties(),flatCoordinates:l.getFlatCoordinates()},this.featureCount_++)})}afterHelperCreated(){this.program_=this.helper.getProgram(this.fragmentShader_,this.vertexShader_),this.hitDetectionEnabled_&&(this.hitRenderTarget_=new io(this.helper)),this.verticesBuffer_.getArray()&&this.helper.flushBufferData(this.verticesBuffer_),this.indicesBuffer_.getArray()&&this.helper.flushBufferData(this.indicesBuffer_)}handleSourceFeatureAdded_(e){const t=e.feature,r=t.getGeometry();r&&r.getType()==="Point"&&(this.featureCache_[J(t)]={feature:t,properties:t.getProperties(),flatCoordinates:r.getFlatCoordinates()},this.featureCount_++)}handleSourceFeatureChanged_(e){const t=e.feature,r=J(t),n=this.featureCache_[r],s=t.getGeometry();n?s&&s.getType()==="Point"?(n.properties=t.getProperties(),n.flatCoordinates=s.getFlatCoordinates()):(delete this.featureCache_[r],this.featureCount_--):s&&s.getType()==="Point"&&(this.featureCache_[r]={feature:t,properties:t.getProperties(),flatCoordinates:s.getFlatCoordinates()},this.featureCount_++)}handleSourceFeatureDelete_(e){const t=e.feature,r=J(t);r in this.featureCache_&&(delete this.featureCache_[r],this.featureCount_--)}handleSourceFeatureClear_(){this.featureCache_={},this.featureCount_=0}renderFrame(e){const t=this.helper.getGL();this.preRender(t,e);const[r,n,s]=no(e,this.getLayer());return this.renderWorlds(e,!1,r,n,s),this.helper.finalizeDraw(e,this.dispatchPreComposeEvent,this.dispatchPostComposeEvent),this.hitDetectionEnabled_&&(this.renderWorlds(e,!0,r,n,s),this.hitRenderTarget_.clearCachedData()),this.postRender(t,e),this.helper.getCanvas()}prepareFrameInternal(e){const t=this.getLayer(),r=t.getSource(),n=e.viewState,s=!e.viewHints[st.ANIMATING]&&!e.viewHints[st.INTERACTING],o=!$t(this.previousExtent_,e.extent),a=this.sourceRevision_<r.getRevision();if(a&&(this.sourceRevision_=r.getRevision()),s&&(o||a)){const l=n.projection,c=n.resolution,u=t instanceof Ar?t.getRenderBuffer():0,h=yi(e.extent,u*c);r.loadFeatures(h,c,l),this.rebuildBuffers_(e),this.previousExtent_=e.extent.slice()}return this.helper.useProgram(this.program_,e),this.helper.prepareDraw(e),!0}rebuildBuffers_(e){const t=_e();this.helper.makeProjectionTransform(e,t);const n=(this.hitDetectionEnabled_?5:2)+this.customAttributes.length,s=n*this.featureCount_,o=this.renderInstructions_&&this.renderInstructions_.length===s?this.renderInstructions_:new Float32Array(s);this.renderInstructions_=null;let a=[];const l=[];let c=-1;e.viewState.projection;for(const h in this.featureCache_){const f=this.featureCache_[h];if(a[0]=f.flatCoordinates[0],a[1]=f.flatCoordinates[1],He(t,a),o[++c]=a[0],o[++c]=a[1],this.hitDetectionEnabled_){const g=eo(c+3,l);o[++c]=g[0],o[++c]=g[1],o[++c]=Number(h)}for(let g=0;g<this.customAttributes.length;g++){const d=this.customAttributes[g].callback(f.feature,f.properties);o[++c]=d}}const u={id:++this.lastSentId,type:Ut.GENERATE_POINT_BUFFERS,renderInstructions:o.buffer,customAttributesSize:n-2};u.projectionTransform=t,this.ready=!1,this.worker_.postMessage(u,[o.buffer])}forEachFeatureAtCoordinate(e,t,r,n,s){if(be(this.hitDetectionEnabled_,"`forEachFeatureAtCoordinate` cannot be used on a WebGL layer if the hit detection logic has been disabled using the `disableHitDetection: true` option."),!this.renderInstructions_||!this.hitDetectionEnabled_)return;const o=He(t.coordinateToPixelTransform,e.slice()),a=this.hitRenderTarget_.readPixel(o[0]/2,o[1]/2),l=[a[0]/255,a[1]/255,a[2]/255,a[3]/255],c=to(l),u=this.renderInstructions_[c],h=Math.floor(u).toString(),g=this.getLayer().getSource().getFeatureByUid(h);if(g)return n(g,this.getLayer(),null)}renderWorlds(e,t,r,n,s){let o=r;this.helper.useProgram(this.program_,e),t&&(this.hitRenderTarget_.setSize([Math.floor(e.size[0]/2),Math.floor(e.size[1]/2)]),this.helper.prepareDrawToRenderTarget(e,this.hitRenderTarget_,!0));const a=this.instanceAttributes.reduce((c,u)=>c+(u.size||1),0),l=this.instanceAttributesBuffer_.getSize()/a;do{this.helper.bindBuffer(this.indicesBuffer_),this.helper.bindBuffer(this.verticesBuffer_),this.helper.enableAttributes(this.attributes),this.helper.bindBuffer(this.instanceAttributesBuffer_),this.helper.enableAttributesInstanced(this.instanceAttributes),this.helper.makeProjectionTransform(e,this.currentTransform_),Ei(this.currentTransform_,o*s,0),zt(this.currentTransform_,this.invertRenderTransform_),this.helper.applyUniforms(e),this.helper.applyHitDetectionUniform(t);const c=this.indicesBuffer_.getSize();this.helper.drawElementsInstanced(0,c,l)}while(++o<n)}disposeInternal(){this.worker_.terminate(),this.sourceListenKeys_.forEach(function(e){_r(e)}),this.sourceListenKeys_=null,super.disposeInternal()}renderDeclutter(){}}class nf extends Ti{constructor(e){const t=Object.assign({},e);super(t),this.styleVariables_=e.variables||{},this.parseResult_=li(e.style,this.styleVariables_,e.filter),this.hitDetectionDisabled_=!!e.disableHitDetection}createRenderer(){const e=Object.keys(this.parseResult_.attributes).map(t=>({name:t,...this.parseResult_.attributes[t]}));return new rf(this,{vertexShader:this.parseResult_.builder.getSymbolVertexShader(),fragmentShader:this.parseResult_.builder.getSymbolFragmentShader(),hitDetectionEnabled:!this.hitDetectionDisabled_,uniforms:this.parseResult_.uniforms,attributes:e})}updateStyleVariables(e){Object.assign(this.styleVariables_,e),this.changed()}}function Wn(i,e){const t=`
    attribute vec2 ${lr.TEXTURE_COORD};
    uniform mat4 ${X.TILE_TRANSFORM};
    uniform float ${X.TEXTURE_PIXEL_WIDTH};
    uniform float ${X.TEXTURE_PIXEL_HEIGHT};
    uniform float ${X.TEXTURE_RESOLUTION};
    uniform float ${X.TEXTURE_ORIGIN_X};
    uniform float ${X.TEXTURE_ORIGIN_Y};
    uniform float ${X.DEPTH};

    varying vec2 v_textureCoord;
    varying vec2 v_mapCoord;

    void main() {
      v_textureCoord = ${lr.TEXTURE_COORD};
      v_mapCoord = vec2(
        ${X.TEXTURE_ORIGIN_X} + ${X.TEXTURE_RESOLUTION} * ${X.TEXTURE_PIXEL_WIDTH} * v_textureCoord[0],
        ${X.TEXTURE_ORIGIN_Y} - ${X.TEXTURE_RESOLUTION} * ${X.TEXTURE_PIXEL_HEIGHT} * v_textureCoord[1]
      );
      gl_Position = ${X.TILE_TRANSFORM} * vec4(${lr.TEXTURE_COORD}, ${X.DEPTH}, 1.0);
    }
  `,r={...$i(),bandCount:e},n=[];if(i.color!==void 0){const h=D(r,i.color,Se);n.push(`color = ${h};`)}if(i.contrast!==void 0){const h=D(r,i.contrast,Y);n.push(`color.rgb = clamp((${h} + 1.0) * color.rgb - (${h} / 2.0), vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0));`)}if(i.exposure!==void 0){const h=D(r,i.exposure,Y);n.push(`color.rgb = clamp((${h} + 1.0) * color.rgb, vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0));`)}if(i.saturation!==void 0){const h=D(r,i.saturation,Y);n.push(`
      float saturation = ${h} + 1.0;
      float sr = (1.0 - saturation) * 0.2126;
      float sg = (1.0 - saturation) * 0.7152;
      float sb = (1.0 - saturation) * 0.0722;
      mat3 saturationMatrix = mat3(
        sr + saturation, sr, sr,
        sg, sg + saturation, sg,
        sb, sb, sb + saturation
      );
      color.rgb = clamp(saturationMatrix * color.rgb, vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0));
    `)}if(i.gamma!==void 0){const h=D(r,i.gamma,Y);n.push(`color.rgb = pow(color.rgb, vec3(1.0 / ${h}));`)}if(i.brightness!==void 0){const h=D(r,i.brightness,Y);n.push(`color.rgb = clamp(color.rgb + ${h}, vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0));`)}const s={},o=Object.keys(r.variables).length;if(o>1&&!i.variables)throw new Error(`Missing variables in style (expected ${r.variables})`);for(let h=0;h<o;++h){const f=r.variables[Object.keys(r.variables)[h]];if(!(f.name in i.variables))throw new Error(`Missing '${f.name}' in style variables`);const g=Dr(f.name);s[g]=function(){let d=i.variables[f.name];return typeof d=="string"&&(d=vt(d)),d!==void 0?d:-9999999}}const a=Object.keys(s).map(function(h){return`uniform float ${h};`}),l=Math.ceil(e/4);a.push(`uniform sampler2D ${X.TILE_TEXTURE_ARRAY}[${l}];`),r.paletteTextures&&a.push(`uniform sampler2D ${Zs}[${r.paletteTextures.length}];`);const c=Object.keys(r.functions).map(function(h){return r.functions[h]}),u=`
    #ifdef GL_FRAGMENT_PRECISION_HIGH
    precision highp float;
    #else
    precision mediump float;
    #endif

    varying vec2 v_textureCoord;
    varying vec2 v_mapCoord;
    uniform vec4 ${X.RENDER_EXTENT};
    uniform float ${X.TRANSITION_ALPHA};
    uniform float ${X.TEXTURE_PIXEL_WIDTH};
    uniform float ${X.TEXTURE_PIXEL_HEIGHT};
    uniform float ${X.RESOLUTION};
    uniform float ${X.ZOOM};

    ${a.join(`
`)}

    ${c.join(`
`)}

    void main() {
      if (
        v_mapCoord[0] < ${X.RENDER_EXTENT}[0] ||
        v_mapCoord[1] < ${X.RENDER_EXTENT}[1] ||
        v_mapCoord[0] > ${X.RENDER_EXTENT}[2] ||
        v_mapCoord[1] > ${X.RENDER_EXTENT}[3]
      ) {
        discard;
      }

      vec4 color = texture2D(${X.TILE_TEXTURE_ARRAY}[0],  v_textureCoord);

      ${n.join(`
`)}

      gl_FragColor = color;
      gl_FragColor.rgb *= gl_FragColor.a;
      gl_FragColor *= ${X.TRANSITION_ALPHA};
    }`;return{vertexShader:t,fragmentShader:u,uniforms:s,paletteTextures:r.paletteTextures}}class oo extends pa{constructor(e){e=e?Object.assign({},e):{};const t=e.style||{};delete e.style,super(e),this.sources_=e.sources,this.renderedSource_=null,this.renderedResolution_=NaN,this.style_=t,this.styleVariables_=this.style_.variables||{},this.handleSourceUpdate_(),this.addChangeListener(Jr.SOURCE,this.handleSourceUpdate_)}getSources(e,t){const r=this.getSource();return this.sources_?typeof this.sources_=="function"?this.sources_(e,t):this.sources_:r?[r]:[]}getRenderSource(){return this.renderedSource_||this.getSource()}getSourceState(){const e=this.getRenderSource();return e?e.getState():"undefined"}handleSourceUpdate_(){this.hasRenderer()&&this.getRenderer().clearCache();const e=this.getSource();if(e)if(e.getState()==="loading"){const t=()=>{e.getState()==="ready"&&(e.removeEventListener("change",t),this.setStyle(this.style_))};e.addEventListener("change",t)}else this.setStyle(this.style_)}getSourceBandCount_(){const e=Number.MAX_SAFE_INTEGER,t=this.getSources([-e,-e,e,e],e);return t&&t.length&&"bandCount"in t[0]?t[0].bandCount:4}createRenderer(){const e=Wn(this.style_,this.getSourceBandCount_());return new Ld(this,{vertexShader:e.vertexShader,fragmentShader:e.fragmentShader,uniforms:e.uniforms,cacheSize:this.getCacheSize(),paletteTextures:e.paletteTextures})}renderSources(e,t){const r=this.getRenderer();let n;for(let s=0,o=t.length;s<o;++s)this.renderedSource_=t[s],r.prepareFrame(e)&&(n=r.renderFrame(e));return n}render(e,t){this.rendered=!0;const r=e.viewState,n=this.getSources(e.extent,r.resolution);let s=!0;for(let a=0,l=n.length;a<l;++a){const c=n[a],u=c.getState();if(u=="loading"){const h=()=>{c.getState()=="ready"&&(c.removeEventListener("change",h),this.changed())};c.addEventListener("change",h)}s=s&&u=="ready"}const o=this.renderSources(e,n);if(this.getRenderer().renderComplete&&s)return this.renderedResolution_=r.resolution,o;if(this.renderedResolution_>.5*r.resolution){const a=this.getSources(e.extent,this.renderedResolution_).filter(l=>!n.includes(l));if(a.length>0)return this.renderSources(e,a)}return o}setStyle(e){if(this.styleVariables_=e.variables||{},this.style_=e,this.hasRenderer()){const t=Wn(this.style_,this.getSourceBandCount_());this.getRenderer().reset({vertexShader:t.vertexShader,fragmentShader:t.fragmentShader,uniforms:t.uniforms,paletteTextures:t.paletteTextures}),this.changed()}}updateStyleVariables(e){Object.assign(this.styleVariables_,e),this.changed()}}oo.prototype.dispose;class sf extends Ti{constructor(e){const t=Object.assign({},e);super(t),this.styleVariables_=e.variables||{},this.style_=e.style,this.hitDetectionDisabled_=!!e.disableHitDetection}createRenderer(){return new so(this,{style:this.style_,variables:this.styleVariables_,disableHitDetection:this.hitDetectionDisabled_})}updateStyleVariables(e){Object.assign(this.styleVariables_,e),this.changed()}setStyle(e){this.style_=e,this.clearRenderer(),this.changed()}}class of extends ma{constructor(e={}){const{mapboxStyle:t,applyOptions:r,...n}=e;super(n),t&&this.applyMapboxStyle(t,r)}applyMapboxStyle(e,t){return il(this,e,t)}}_a(hl);window.eoxMapAdvancedOlLayers={Graticule:id,Heatmap:Jd,Layer:Ti,VectorImage:tf,WebGLPoints:nf,WebGLTile:oo,WebGLVector:sf,STAC:nl,MapboxStyle:of};function af(i){const e=i[0],t=new Array(e);let r=1<<e-1,n,s;for(n=0;n<e;++n)s=48,i[1]&r&&(s+=1),i[2]&r&&(s+=2),t[n]=String.fromCharCode(s),r>>=1;return t.join("")}const lf='<a class="ol-attribution-bing-tos" href="https://www.microsoft.com/maps/product/terms.html" target="_blank">Terms of Use</a>';class cf extends Ye{constructor(e){const t=e.hidpi!==void 0?e.hidpi:!1;super({cacheSize:e.cacheSize,crossOrigin:"anonymous",interpolate:e.interpolate,projection:Q("EPSG:3857"),reprojectionErrorThreshold:e.reprojectionErrorThreshold,state:"loading",tileLoadFunction:e.tileLoadFunction,tilePixelRatio:t?2:1,wrapX:e.wrapX!==void 0?e.wrapX:!0,transition:e.transition,zDirection:e.zDirection}),this.hidpi_=t,this.culture_=e.culture!==void 0?e.culture:"en-us",this.maxZoom_=e.maxZoom!==void 0?e.maxZoom:-1,this.apiKey_=e.key,this.imagerySet_=e.imagerySet,this.placeholderTiles_=e.placeholderTiles;const r=(e.url||"https://dev.virtualearth.net/REST/v1/Imagery/Metadata/")+this.imagerySet_+"?uriScheme=https&include=ImageryProviders&key="+this.apiKey_+"&c="+this.culture_;fetch(r).then(n=>n.json()).then(n=>this.handleImageryMetadataResponse(n))}getApiKey(){return this.apiKey_}getImagerySet(){return this.imagerySet_}handleImageryMetadataResponse(e){if(e.statusCode!=200||e.statusDescription!="OK"||e.authenticationResultCode!="ValidCredentials"||e.resourceSets.length!=1||e.resourceSets[0].resources.length!=1){this.setState("error");return}const t=e.resourceSets[0].resources[0],r=this.maxZoom_==-1?t.zoomMax:this.maxZoom_,n=this.getProjection(),s=Yt(n),o=this.hidpi_?2:1,a=t.imageWidth==t.imageHeight?t.imageWidth/o:[t.imageWidth/o,t.imageHeight/o],l=qt({extent:s,minZoom:t.zoomMin,maxZoom:r,tileSize:a});this.tileGrid=l;const c=this.culture_,u=this.hidpi_,h=this.placeholderTiles_;if(this.tileUrlFunction=xi(t.imageUrlSubdomains.map(function(f){const g=[0,0,0],d=t.imageUrl.replace("{subdomain}",f).replace("{culture}",c);return function(m,_,y){if(!m)return;Qr(m[0],m[1],m[2],g);const T=new URL(d.replace("{quadkey}",af(g))),x=T.searchParams;return u&&(x.set("dpi","d1"),x.set("device","mobile")),h===!0?x.delete("n"):h===!1&&x.set("n","z"),T.toString()}})),t.imageryProviders){const f=Ri(Q("EPSG:4326"),this.getProjection());this.setAttributions(g=>{const d=[],m=g.viewState,_=this.getTileGrid(),y=_.getZForResolution(m.resolution,this.zDirection),x=_.getTileCoordForCoordAndZ(m.center,y)[0];return t.imageryProviders.map(function(S){let P=!1;const R=S.coverageAreas;for(let v=0,F=R.length;v<F;++v){const C=R[v];if(x>=C.zoomMin&&x<=C.zoomMax){const w=C.bbox,U=[w[1],w[0],w[3],w[2]],M=Lt(U,f);if(wt(M,g.extent)){P=!0;break}}}P&&d.push(S.attribution)}),d.push(lf),d})}this.setState("ready")}}class uf extends fs{constructor(e){super({attributions:e.attributions,cacheSize:e.cacheSize,crossOrigin:e.crossOrigin,maxZoom:e.maxZoom!==void 0?e.maxZoom:18,minZoom:e.minZoom,projection:e.projection,transition:e.transition,wrapX:e.wrapX,zDirection:e.zDirection}),this.account_=e.account,this.mapId_=e.map||"",this.config_=e.config||{},this.templateCache_={},this.initializeMap_()}getConfig(){return this.config_}updateConfig(e){Object.assign(this.config_,e),this.initializeMap_()}setConfig(e){this.config_=e||{},this.initializeMap_()}initializeMap_(){const e=JSON.stringify(this.config_);if(this.templateCache_[e]){this.applyTemplate_(this.templateCache_[e]);return}let t="https://"+this.account_+".carto.com/api/v1/map";this.mapId_&&(t+="/named/"+this.mapId_);const r=new XMLHttpRequest;r.addEventListener("load",this.handleInitResponse_.bind(this,e)),r.addEventListener("error",this.handleInitError_.bind(this)),r.open("POST",t),r.setRequestHeader("Content-type","application/json"),r.send(JSON.stringify(this.config_))}handleInitResponse_(e,t){const r=t.target;if(!r.status||r.status>=200&&r.status<300){let n;try{n=JSON.parse(r.responseText)}catch{this.setState("error");return}this.applyTemplate_(n),this.templateCache_[e]=n,this.setState("ready")}else this.setState("error")}handleInitError_(e){this.setState("error")}applyTemplate_(e){const t="https://"+e.cdn_url.https+"/"+this.account_+"/api/v1/map/"+e.layergroupid+"/{z}/{x}/{y}.png";this.setUrl(t)}}const hf=`
  attribute vec4 a_position;
  attribute vec4 a_texcoord;

  uniform mat4 u_matrix;
  uniform mat4 u_textureMatrix;

  varying vec2 v_texcoord;

  void main() {
    gl_Position = u_matrix * a_position;
    vec2 texcoord = (u_textureMatrix * a_texcoord).xy;
    v_texcoord = texcoord;
  }
`,df=`
  precision mediump float;

  varying vec2 v_texcoord;

  uniform sampler2D u_texture;

  void main() {
    if (
      v_texcoord.x < 0.0 ||
      v_texcoord.y < 0.0 ||
      v_texcoord.x > 1.0 ||
      v_texcoord.y > 1.0
    ) {
      discard;
    }
    gl_FragColor = texture2D(u_texture, v_texcoord);
  }
`;class ff{constructor(e){this.gl_=e,this.program_=ci(e,df,hf),this.positionLocation=e.getAttribLocation(this.program_,"a_position"),this.texcoordLocation=e.getAttribLocation(this.program_,"a_texcoord"),this.matrixLocation=e.getUniformLocation(this.program_,"u_matrix"),this.textureMatrixLocation=e.getUniformLocation(this.program_,"u_textureMatrix"),this.textureLocation=e.getUniformLocation(this.program_,"u_texture"),this.positionBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.positionBuffer),this.positions=[0,0,0,1,1,0,1,0,0,1,1,1],e.bufferData(e.ARRAY_BUFFER,new Float32Array(this.positions),e.STATIC_DRAW),this.texcoordBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.texcoordBuffer),this.texcoords=[0,0,0,1,1,0,1,0,0,1,1,1],e.bufferData(e.ARRAY_BUFFER,new Float32Array(this.texcoords),e.STATIC_DRAW)}drawImage(e,t,r,n,s,o,a,l,c,u,h,f,g){const d=this.gl_;l===void 0&&(l=n),c===void 0&&(c=s),o===void 0&&(o=t),a===void 0&&(a=r),u===void 0&&(u=o),h===void 0&&(h=a),f===void 0&&(f=d.canvas.width),g===void 0&&(g=d.canvas.height),d.bindTexture(d.TEXTURE_2D,e),d.useProgram(this.program_),d.bindBuffer(d.ARRAY_BUFFER,this.positionBuffer),d.enableVertexAttribArray(this.positionLocation),d.vertexAttribPointer(this.positionLocation,2,d.FLOAT,!1,0,0),d.bindBuffer(d.ARRAY_BUFFER,this.texcoordBuffer),d.enableVertexAttribArray(this.texcoordLocation),d.vertexAttribPointer(this.texcoordLocation,2,d.FLOAT,!1,0,0);let m=ni(0,f,0,g,-1,1);m=nd(m,l,c,0),m=On(m,u,h,1),d.uniformMatrix4fv(this.matrixLocation,!1,m);let _=sd(n/t,s/r,0);_=On(_,o/t,a/r,1),d.uniformMatrix4fv(this.textureMatrixLocation,!1,_),d.uniform1i(this.textureLocation,0),d.drawArrays(d.TRIANGLES,0,this.positions.length/2)}}function Zn(i,e,t){const r=i.createShader(e);if(r===null)throw new Error("Shader compilation failed");if(i.shaderSource(r,t),i.compileShader(r),!i.getShaderParameter(r,i.COMPILE_STATUS)){const n=i.getShaderInfoLog(r);throw n===null?new Error("Shader info log creation failed"):new Error(n)}return r}function ci(i,e,t){const r=i.createProgram(),n=Zn(i,i.VERTEX_SHADER,t),s=Zn(i,i.FRAGMENT_SHADER,e);if(r===null)throw new Error("Program creation failed");if(i.attachShader(r,n),i.attachShader(r,s),i.linkProgram(r),!i.getProgramParameter(r,i.LINK_STATUS))throw i.getProgramInfoLog(r)===null?new Error("Program info log creation failed"):new Error;return r}const gf=`
  attribute vec4 a_position;

  uniform mat4 u_matrix;

  void main() {
     gl_Position = u_matrix * a_position;
  }
`,pf=`
  precision mediump float;

  uniform vec4 u_val;
  void main() {
     gl_FragColor = u_val;
  }
`,mf=`
  attribute vec4 a_position;
  attribute vec2 a_texcoord;

  varying vec2 v_texcoord;

  uniform mat4 u_matrix;

  void main() {
     gl_Position = u_matrix * a_position;
     v_texcoord = a_texcoord;
  }
`,_f=`
  precision mediump float;

  varying vec2 v_texcoord;

  uniform sampler2D u_texture;

  void main() {
    if (v_texcoord.x < 0.0 || v_texcoord.x > 1.0 || v_texcoord.y < 0.0 || v_texcoord.y > 1.0) {
      discard;
    }
    gl_FragColor = texture2D(u_texture, v_texcoord);
  }
`;function Ef(i,e,t,r){let n;return t&&t.length?n=t.shift():Ea?n=new OffscreenCanvas(i||300,e||300):n=document.createElement("canvas"),i&&(n.width=i),e&&(n.height=e),n.getContext("webgl",r)}function yf(i){const e=i.canvas;e.width=1,e.height=1,i.clear(i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT|i.STENCIL_BUFFER_BIT)}const Hn=[];function Tf(i,e,t,r,n,s,o,a,l,c,u,h,f,g){const d=Math.round(r*e),m=Math.round(r*t);i.canvas.width=d,i.canvas.height=m;let _,y;if(y=i.createTexture(),i.bindTexture(i.TEXTURE_2D,y),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),f?(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.LINEAR)):(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.NEAREST)),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,d,m,0,i.RGBA,u,null),_=i.createFramebuffer(),i.bindFramebuffer(i.FRAMEBUFFER,_),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,y,0),_===null)throw new Error("Could not create framebuffer");if(y===null)throw new Error("Could not create texture");if(l.length===0)return{width:d,height:m,framebuffer:_,texture:y};const T=Vt();l.forEach(function(w,U,M){ya(T,w.extent)});let x,S,P;const R=1/n;{if(x=i.createTexture(),y===null)throw new Error("Could not create texture");S=Math.round(Ee(T)*R),P=Math.round(Me(T)*R);const w=i.getParameter(i.MAX_TEXTURE_SIZE),U=Math.max(S,P),M=U>w?w/U:1,z=Math.round(S*M),Z=Math.round(P*M);i.bindTexture(i.TEXTURE_2D,x),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),f?(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.LINEAR)):(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.NEAREST)),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,z,Z,0,i.RGBA,u,null);const $=i.createFramebuffer();i.bindFramebuffer(i.FRAMEBUFFER,$),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,x,0);const se=new ff(i);l.forEach(function(B,le,ne){const oe=(B.extent[0]-T[0])*R*M,he=-(B.extent[3]-T[3])*R*M,Te=Ee(B.extent)*R*M,ce=Me(B.extent)*R*M;if(i.bindFramebuffer(i.FRAMEBUFFER,$),i.viewport(0,0,z,Z),B.clipExtent){const we=(B.clipExtent[0]-T[0])*R*M,Fe=-(B.clipExtent[3]-T[3])*R*M,$e=Ee(B.clipExtent)*R*M,_t=Me(B.clipExtent)*R*M;i.enable(i.SCISSOR_TEST),i.scissor(f?we:Math.round(we),f?Fe:Math.round(Fe),f?$e:Math.round(we+$e)-Math.round(we),f?_t:Math.round(Fe+_t)-Math.round(Fe))}se.drawImage(B.texture,B.width,B.height,c,c,B.width-2*c,B.height-2*c,f?oe:Math.round(oe),f?he:Math.round(he),f?Te:Math.round(oe+Te)-Math.round(oe),f?ce:Math.round(he+ce)-Math.round(he),z,Z),i.disable(i.SCISSOR_TEST)}),i.deleteFramebuffer($)}const v=ei(o),F=ei(T),C=w=>{const U=(w[0][0]-v[0])/s*r,M=-(w[0][1]-v[1])/s*r,z=(w[1][0]-v[0])/s*r,Z=-(w[1][1]-v[1])/s*r,$=(w[2][0]-v[0])/s*r,se=-(w[2][1]-v[1])/s*r;return{u1:z,v1:Z,u0:U,v0:M,u2:$,v2:se}};i.bindFramebuffer(i.FRAMEBUFFER,_),i.viewport(0,0,d,m);{const w=[],U=[],M=ci(i,_f,mf);i.useProgram(M);const z=i.getUniformLocation(M,"u_texture");i.bindTexture(i.TEXTURE_2D,x),i.uniform1i(z,0),a.getTriangles().forEach(function(oe,he,Te){const ce=oe.source,we=oe.target,{u1:Fe,v1:$e,u0:_t,v0:yo,u2:To,v2:xo}=C(we),Ro=(ce[0][0]-F[0])/n/S,So=-(ce[0][1]-F[1])/n/P,Po=(ce[1][0]-F[0])/n/S,wo=-(ce[1][1]-F[1])/n/P,Lo=(ce[2][0]-F[0])/n/S,vo=-(ce[2][1]-F[1])/n/P;w.push(Fe,$e,_t,yo,To,xo),U.push(Po,wo,Ro,So,Lo,vo)});const Z=ni(0,d,m,0,-1,1),$=i.getUniformLocation(M,"u_matrix");i.uniformMatrix4fv($,!1,Z);const se=i.getAttribLocation(M,"a_position"),B=i.createBuffer();i.bindBuffer(i.ARRAY_BUFFER,B),i.bufferData(i.ARRAY_BUFFER,new Float32Array(w),i.STATIC_DRAW),i.vertexAttribPointer(se,2,i.FLOAT,!1,0,0),i.enableVertexAttribArray(se);const le=i.getAttribLocation(M,"a_texcoord"),ne=i.createBuffer();i.bindBuffer(i.ARRAY_BUFFER,ne),i.bufferData(i.ARRAY_BUFFER,new Float32Array(U),i.STATIC_DRAW),i.vertexAttribPointer(le,2,i.FLOAT,!1,0,0),i.enableVertexAttribArray(le),i.drawArrays(i.TRIANGLES,0,w.length/2)}if(h){const w=ci(i,pf,gf);i.useProgram(w);const U=ni(0,d,m,0,-1,1),M=i.getUniformLocation(w,"u_matrix");i.uniformMatrix4fv(M,!1,U);const z=Array.isArray(h)?h:[0,0,0,255],Z=i.getUniformLocation(w,"u_val");i.uniform4fv(Z,z);const $=i.getAttribLocation(w,"a_position"),se=i.createBuffer();i.bindBuffer(i.ARRAY_BUFFER,se),i.vertexAttribPointer($,2,i.FLOAT,!1,0,0),i.enableVertexAttribArray($);const B=a.getTriangles().reduce(function(le,ne){const oe=ne.target,{u1:he,v1:Te,u0:ce,v0:we,u2:Fe,v2:$e}=C(oe);return le.concat([he,Te,ce,we,ce,we,Fe,$e,Fe,$e,he,Te])},[]);i.bufferData(i.ARRAY_BUFFER,new Float32Array(B),i.STATIC_DRAW),i.drawArrays(i.LINES,0,B.length/2)}return{width:d,height:m,framebuffer:_,texture:y}}class xf extends _i{constructor(e){super({tileCoord:e.tileCoord,loader:()=>Promise.resolve(new Uint8ClampedArray(4)),interpolate:e.interpolate,transition:e.transition}),this.renderEdges_=e.renderEdges!==void 0?e.renderEdges:!1,this.pixelRatio_=e.pixelRatio,this.gutter_=e.gutter,this.reprojData_=null,this.reprojError_=null,this.reprojSize_=void 0,this.sourceTileGrid_=e.sourceTileGrid,this.targetTileGrid_=e.targetTileGrid,this.wrappedTileCoord_=e.wrappedTileCoord||e.tileCoord,this.sourceTiles_=[],this.sourcesListenerKeys_=null,this.sourceZ_=0;const t=e.sourceProj,r=t.getExtent(),n=e.sourceTileGrid.getExtent();this.clipExtent_=t.canWrapX()?n?Ue(r,n):r:n;const s=this.targetTileGrid_.getTileCoordExtent(this.wrappedTileCoord_),o=this.targetTileGrid_.getExtent();let a=this.sourceTileGrid_.getExtent();const l=o?Ue(s,o):s;if(rn(l)===0){this.state=V.EMPTY;return}r&&(a?a=Ue(a,r):a=r);const c=this.targetTileGrid_.getResolution(this.wrappedTileCoord_[0]),u=e.targetProj,h=Ta(t,u,l,c);if(!isFinite(h)||h<=0){this.state=V.EMPTY;return}const f=e.errorThreshold!==void 0?e.errorThreshold:xa;if(this.triangulation_=new Ra(t,u,l,a,h*f,c,e.transformMatrix),this.triangulation_.getTriangles().length===0){this.state=V.EMPTY;return}this.sourceZ_=this.sourceTileGrid_.getZForResolution(h);let g=this.triangulation_.calculateSourceExtent();if(a&&(t.canWrapX()?(g[1]=ue(g[1],a[1],a[3]),g[3]=ue(g[3],a[1],a[3])):g=Ue(g,a)),!rn(g))this.state=V.EMPTY;else{let d=0,m=0;t.canWrapX()&&(d=Ee(r),m=Math.floor((g[0]-r[0])/d)),Sa(g.slice(),t,!0).forEach(y=>{const T=this.sourceTileGrid_.getTileRangeForExtentAndZ(y,this.sourceZ_),x=e.getTileFunction;for(let S=T.minX;S<=T.maxX;S++)for(let P=T.minY;P<=T.maxY;P++){const R=x(this.sourceZ_,S,P,this.pixelRatio_);if(R){const v=m*d;this.sourceTiles_.push({tile:R,offset:v})}}++m}),this.sourceTiles_.length===0&&(this.state=V.EMPTY)}}getSize(){return this.reprojSize_}getData(){return this.reprojData_}getError(){return this.reprojError_}reproject_(){const e=[];let t=!1;if(this.sourceTiles_.forEach(S=>{var he;const P=S.tile;if(!P||P.getState()!==V.LOADED)return;const R=P.getSize(),v=this.gutter_;let F;const C=qr(P.getData());C?F=C:(t=!0,F=Pa(Kr(P.getData())));const w=[R[0]+2*v,R[1]+2*v],U=F instanceof Float32Array,M=w[0]*w[1],z=U?Float32Array:Uint8ClampedArray,Z=new z(F.buffer),$=z.BYTES_PER_ELEMENT,se=$*Z.length/M,B=Z.byteLength/w[1],le=Math.floor(B/$/w[0]),ne=this.sourceTileGrid_.getTileCoordExtent(P.tileCoord);ne[0]+=S.offset,ne[2]+=S.offset;const oe=(he=this.clipExtent_)==null?void 0:he.slice();oe&&(oe[0]+=S.offset,oe[2]+=S.offset),e.push({extent:ne,clipExtent:oe,data:Z,dataType:z,bytesPerPixel:se,pixelSize:w,bandCount:le})}),this.sourceTiles_.length=0,e.length===0){this.state=V.ERROR,this.changed();return}const r=this.wrappedTileCoord_[0],n=this.targetTileGrid_.getTileSize(r),s=typeof n=="number"?n:n[0],o=typeof n=="number"?n:n[1],a=Math.round(s*this.pixelRatio_),l=Math.round(o*this.pixelRatio_),c=this.targetTileGrid_.getResolution(r),u=this.sourceTileGrid_.getResolution(this.sourceZ_),h=this.targetTileGrid_.getTileCoordExtent(this.wrappedTileCoord_),f=e[0].bandCount,g=new e[0].dataType(f*a*l),d=Ef(a,l,Hn,{premultipliedAlpha:!1,antialias:!1});let m;const _=d.RGBA;let y;e[0].dataType==Float32Array?(y=d.FLOAT,d.getExtension("WEBGL_color_buffer_float"),d.getExtension("OES_texture_float"),d.getExtension("EXT_float_blend"),m=d.getExtension("OES_texture_float_linear")!==null&&this.interpolate):(y=d.UNSIGNED_BYTE,m=this.interpolate);const T=4,x=Math.ceil(f/T);for(let S=x-1;S>=0;--S){const P=[];for(let z=0,Z=e.length;z<Z;++z){const $=e[z],se=$.pixelSize,B=se[0],le=se[1],ne=new $.dataType(T*B*le),oe=$.data;let he=S*T;for(let ce=0,we=ne.length;ce<we;ce+=T)ne[ce]=oe[he],ne[ce+1]=oe[he+1],ne[ce+2]=oe[he+2],ne[ce+3]=oe[he+3],he+=f;const Te=d.createTexture();d.bindTexture(d.TEXTURE_2D,Te),m?(d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MIN_FILTER,d.LINEAR),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MAG_FILTER,d.LINEAR)):(d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MIN_FILTER,d.NEAREST),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MAG_FILTER,d.NEAREST)),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_S,d.CLAMP_TO_EDGE),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_T,d.CLAMP_TO_EDGE),d.texImage2D(d.TEXTURE_2D,0,_,B,le,0,_,y,ne),P.push({extent:$.extent,clipExtent:$.clipExtent,texture:Te,width:B,height:le})}const{framebuffer:R,width:v,height:F}=Tf(d,s,o,this.pixelRatio_,u,c,h,this.triangulation_,P,this.gutter_,y,this.renderEdges_,m),C=v,w=F*T,U=new e[0].dataType(C*w);d.bindFramebuffer(d.FRAMEBUFFER,R),d.readPixels(0,0,v,F,d.RGBA,y,U);let M=S*T;for(let z=0,Z=U.length;z<Z;z+=T){const $=(C-1-(z/w|0))*w+z%w;g[M]=U[$],g[M+1]=U[$+1],g[M+2]=U[$+2],g[M+3]=U[$+3],M+=f}}if(yf(d),Hn.push(d.canvas),t){const S=nt(s,o),P=new ImageData(g,s);S.putImageData(P,0,0),this.reprojData_=S.canvas}else this.reprojData_=g;this.reprojSize_=[a,l],this.state=V.LOADED,this.changed()}load(){if(this.state!==V.IDLE&&this.state!==V.ERROR)return;this.state=V.LOADING,this.changed();let e=0;this.sourcesListenerKeys_=[],this.sourceTiles_.forEach(({tile:t})=>{const r=t.getState();if(r!==V.IDLE&&r!==V.LOADING)return;e++;const n=We(t,xe.CHANGE,()=>{const s=t.getState();(s==V.LOADED||s==V.ERROR||s==V.EMPTY)&&(_r(n),e--,e===0&&(this.unlistenSources_(),this.reproject_()))});this.sourcesListenerKeys_.push(n)}),e===0?setTimeout(this.reproject_.bind(this),0):this.sourceTiles_.forEach(function({tile:t}){t.getState()==V.IDLE&&t.load()})}unlistenSources_(){this.sourcesListenerKeys_.forEach(_r),this.sourcesListenerKeys_=null}}class Ur extends Si{constructor(e){const t=e.projection===void 0?"EPSG:3857":e.projection;let r=e.tileGrid;r===void 0&&t&&(r=qt({extent:Yt(t),maxResolution:e.maxResolution,maxZoom:e.maxZoom,minZoom:e.minZoom,tileSize:e.tileSize})),super({cacheSize:.1,attributions:e.attributions,attributionsCollapsible:e.attributionsCollapsible,projection:t,tileGrid:r,state:e.state,wrapX:e.wrapX,transition:e.transition,interpolate:e.interpolate,key:e.key,zDirection:e.zDirection}),this.gutter_=e.gutter!==void 0?e.gutter:0,this.tileSize_=e.tileSize?Ne(e.tileSize):null,this.tileSizes_=null,this.tileLoadingKeys_={},this.loader_=e.loader,this.handleTileChange_=this.handleTileChange_.bind(this),this.bandCount=e.bandCount===void 0?4:e.bandCount,this.tileGridForProjection_={},this.crossOrigin_=e.crossOrigin||"anonymous",this.transformMatrix=null}setTileSizes(e){this.tileSizes_=e}getTileSize(e){if(this.tileSizes_)return this.tileSizes_[e];if(this.tileSize_)return this.tileSize_;const t=this.getTileGrid();return t?Ne(t.getTileSize(e)):[256,256]}getGutterForProjection(e){const t=this.getProjection();return(!t||ar(t,e))&&!this.transformMatrix?this.gutter_:0}setLoader(e){this.loader_=e}getReprojTile_(e,t,r,n,s,o){const a=this.tileGrid||this.getTileGridForProjection(s||n),l=Math.max.apply(null,a.getResolutions().map((d,m)=>{const _=Ne(a.getTileSize(m)),y=this.getTileSize(m);return Math.max(y[0]/_[0],y[1]/_[1])})),c=this.getTileGridForProjection(n),u=[e,t,r],h=this.getTileCoordForTileUrlFunction(u,n),f=Object.assign({sourceProj:s||n,sourceTileGrid:a,targetProj:n,targetTileGrid:c,tileCoord:u,wrappedTileCoord:h,pixelRatio:l,gutter:this.gutter_,getTileFunction:(d,m,_,y)=>this.getTile(d,m,_,y,void 0,o),transformMatrix:this.transformMatrix},this.tileOptions),g=new xf(f);return g.key=this.getKey(),g}getTile(e,t,r,n,s,o){var R;const a=this.getProjection();if(s&&(a&&!ar(a,s)||this.transformMatrix))return this.getReprojTile_(e,t,r,s,a,o);const l=this.getTileSize(e),c=this.loader_,u=new AbortController,h={signal:u.signal,crossOrigin:this.crossOrigin_},f=this.getTileCoordForTileUrlFunction([e,t,r]);if(!f)return null;const g=this.getKey(),d=wa(this,g,e,t,r);if(o&&o.containsKey(d))return o.get(d);const m=f[0],_=f[1],y=f[2],T=(R=this.getTileGrid())==null?void 0:R.getFullTileRange(m);T&&(h.maxY=T.getHeight()-1);function x(){return ba(function(){return c(m,_,y,h)})}const S=Object.assign({tileCoord:[e,t,r],loader:x,size:l,controller:u},this.tileOptions),P=new _i(S);return P.key=this.getKey(),P.addEventListener(xe.CHANGE,this.handleTileChange_),o==null||o.set(d,P),P}handleTileChange_(e){const t=e.target,r=J(t),n=t.getState();let s;n==V.LOADING?(this.tileLoadingKeys_[r]=!0,s=$r.TILELOADSTART):r in this.tileLoadingKeys_&&(delete this.tileLoadingKeys_[r],s=n==V.ERROR?$r.TILELOADERROR:n==V.LOADED?$r.TILELOADEND:void 0),s&&this.dispatchEvent(new La(s,t))}getTileGridForProjection(e){const t=this.getProjection();if(this.tileGrid&&(!t||ar(t,e))&&!this.transformMatrix)return this.tileGrid;const r=J(e);return r in this.tileGridForProjection_||(this.tileGridForProjection_[r]=va(e)),this.tileGridForProjection_[r]}setTileGridForProjection(e,t){const r=Q(e);if(r){const n=J(r);n in this.tileGridForProjection_||(this.tileGridForProjection_[n]=t)}}}function Rf(i){return((i.fileDirectory.NewSubfileType||0)&4)===4}function Sf(i,e){if(!i)return!1;if(i===!0)return!0;if(e.getSamplesPerPixel()!==3)return!1;const t=e.fileDirectory.PhotometricInterpretation,r=cl;return t===r.CMYK||t===r.YCbCr||t===r.CIELab||t===r.ICCLab}const Vn="STATISTICS_MAXIMUM",Yn="STATISTICS_MINIMUM",Zr=256;let Hr;function Pf(){return Hr||(Hr=new ll),Hr}function wf(i){try{return i.getBoundingBox(!0)}catch{return[0,0,i.getWidth(),i.getHeight()]}}function Lf(i){try{return i.getOrigin().slice(0,2)}catch{return[0,i.getHeight()]}}function vf(i,e){try{return i.getResolution(e)}catch{return[e.getWidth()/i.getWidth(),e.getHeight()/i.getHeight()]}}function bf(i){const e=i.geoKeys;if(!e)return null;if(e.ProjectedCSTypeGeoKey&&e.ProjectedCSTypeGeoKey!==32767){const t="EPSG:"+e.ProjectedCSTypeGeoKey;let r=Q(t);if(!r){const n=nn(e.ProjLinearUnitsGeoKey);n&&(r=new sn({code:t,units:n}))}return r}if(e.GeographicTypeGeoKey&&e.GeographicTypeGeoKey!==32767){const t="EPSG:"+e.GeographicTypeGeoKey;let r=Q(t);if(!r){const n=nn(e.GeogAngularUnitsGeoKey);n&&(r=new sn({code:t,units:n}))}return r}return null}function Af(i){return i.getImageCount().then(function(e){const t=new Array(e);for(let r=0;r<e;++r)t[r]=i.getImage(r);return Promise.all(t)})}function Cf(i,e){let t;return i.blob?t=sl(i.blob):i.overviews?t=ol(i.url,i.overviews,e):t=al(i.url,e),t.then(Af)}function Gt(i,e,t,r,n){if(Array.isArray(i)){const s=i.length;if(!Array.isArray(e)||s!=e.length){const o=new Error(r);throw n(o),o}for(let o=0;o<s;++o)Gt(i[o],e[o],t,r,n);return}if(e=e,Math.abs(i-e)>t*i)throw new Error(r)}function If(i){return i instanceof Int8Array?-128:i instanceof Int16Array?-32768:i instanceof Int32Array?-2147483648:i instanceof Float32Array?12e-39:0}function Ff(i){return i instanceof Int8Array?127:i instanceof Uint8Array||i instanceof Uint8ClampedArray?255:i instanceof Int16Array?32767:i instanceof Uint16Array?65535:i instanceof Int32Array?2147483647:i instanceof Uint32Array?4294967295:i instanceof Float32Array?34e37:255}class ao extends Ur{constructor(e){super({state:"loading",tileGrid:null,projection:e.projection||null,transition:e.transition,interpolate:e.interpolate!==!1,wrapX:e.wrapX}),this.sourceInfo_=e.sources;const t=this.sourceInfo_.length;this.sourceOptions_=e.sourceOptions,this.sourceImagery_=new Array(t),this.sourceMasks_=new Array(t),this.resolutionFactors_=new Array(t),this.samplesPerPixel_,this.nodataValues_,this.metadata_,this.normalize_=e.normalize!==!1,this.addAlpha_=!1,this.error_=null,this.convertToRGB_=e.convertToRGB||!1,this.setKey(this.sourceInfo_.map(s=>s.url).join(","));const r=this,n=new Array(t);for(let s=0;s<t;++s)n[s]=Cf(this.sourceInfo_[s],this.sourceOptions_);Promise.all(n).then(function(s){r.configure_(s)}).catch(function(s){Wt(s),r.error_=s,r.setState("error")})}getError(){return this.error_}determineProjection(e){const t=e[0];for(let r=t.length-1;r>=0;--r){const n=t[r],s=bf(n);if(s){this.projection=s;break}}}determineTransformMatrix(e){const t=e[0];for(let r=t.length-1;r>=0;--r){const s=t[r].fileDirectory.ModelTransformation;if(s){const[o,a,l,c,u,h,f,g]=s,d=zt(zt([1/Math.sqrt(o*o+u*u),0,0,-1/Math.sqrt(a*a+h*h),c,g],[o,u,a,h,0,0]),[1,0,0,1,-c,-g]);this.transformMatrix=d,this.addAlpha_=!0;break}}}configure_(e){let t,r,n,s,o;const a=new Array(e.length),l=new Array(e.length),c=new Array(e.length);let u=0;const h=e.length;for(let _=0;_<h;++_){const y=[],T=[];e[_].forEach(C=>{Rf(C)?T.push(C):y.push(C)});const x=y.length;if(T.length>0&&T.length!==x)throw new Error(`Expected one mask per image found ${T.length} masks and ${x} images`);let S,P;const R=new Array(x),v=new Array(x),F=new Array(x);l[_]=new Array(x),c[_]=new Array(x);for(let C=0;C<x;++C){const w=y[C],U=w.getGDALNoData();c[_][C]=w.getGDALMetadata(0),l[_][C]=U;const M=this.sourceInfo_[_].bands;a[_]=M?M.length:w.getSamplesPerPixel();const z=x-(C+1);S||(S=wf(w)),P||(P=Lf(w));const Z=vf(w,y[0]);F[z]=Z[0];const $=[w.getTileWidth(),w.getTileHeight()];$[0]!==$[1]&&$[1]<Zr&&($[0]=Zr,$[1]=Zr),R[z]=$;const se=Z[0]/Math.abs(Z[1]);v[z]=[$[0],$[1]/se]}if(t?Ue(t,S,t):t=S,!r)r=P;else{const C=`Origin mismatch for source ${_}, got [${P}] but expected [${r}]`;Gt(r,P,0,C,this.viewRejector)}if(!o)o=F,this.resolutionFactors_[_]=1;else{o.length-u>F.length&&(u=o.length-F.length);const C=o[o.length-1]/F[F.length-1];this.resolutionFactors_[_]=C;const w=F.map(M=>M*=C),U=`Resolution mismatch for source ${_}, got [${w}] but expected [${o}]`;Gt(o.slice(u,o.length),w,.02,U,this.viewRejector)}n?Gt(n.slice(u,n.length),v,.01,`Tile size mismatch for source ${_}`,this.viewRejector):n=v,s?Gt(s.slice(u,s.length),R,0,`Tile size mismatch for source ${_}`,this.viewRejector):s=R,this.sourceImagery_[_]=y.reverse(),this.sourceMasks_[_]=T.reverse()}for(let _=0,y=this.sourceImagery_.length;_<y;++_){const T=this.sourceImagery_[_];for(;T.length<o.length;)T.unshift(void 0)}this.getProjection()||this.determineProjection(e),this.determineTransformMatrix(e),this.samplesPerPixel_=a,this.nodataValues_=l,this.metadata_=c;e:for(let _=0;_<h;++_){if(this.sourceInfo_[_].nodata!==void 0){this.addAlpha_=!0;break}if(this.sourceMasks_[_].length){this.addAlpha_=!0;break}const y=l[_],T=this.sourceInfo_[_].bands;if(T){for(let x=0;x<T.length;++x)if(y[T[x]-1]!==null){this.addAlpha_=!0;break e}continue}for(let x=0;x<y.length;++x)if(y[x]!==null){this.addAlpha_=!0;break e}}let f=this.addAlpha_?1:0;for(let _=0;_<h;++_)f+=a[_];this.bandCount=f;const g=new Cr({extent:t,minZoom:u,origin:r,resolutions:o,tileSizes:n});this.tileGrid=g,this.setTileSizes(s),this.setLoader(this.loadTile_.bind(this)),this.setState("ready");const d=1;o.length===2?o=[o[0],o[1],o[1]/2]:o.length===1&&(o=[o[0]*2,o[0],o[0]/2]);let m=t;if(this.transformMatrix){const _=jt(_e(),this.transformMatrix.slice()),y=Aa(T=>He(_,T));m=Lt(t,y)}this.viewResolver({showFullExtent:!0,projection:this.projection,resolutions:o,center:Ia(et(m),this.projection),extent:Ca(m,this.projection),zoom:d})}loadTile_(e,t,r,n){const s=this.getTileSize(e),o=this.sourceImagery_.length,a=new Array(o*2),l=this.nodataValues_,c=this.sourceInfo_,u=Pf();for(let h=0;h<o;++h){const f=c[h],g=this.resolutionFactors_[h],d=[Math.round(t*(s[0]*g)),Math.round(r*(s[1]*g)),Math.round((t+1)*(s[0]*g)),Math.round((r+1)*(s[1]*g))],m=this.sourceImagery_[h][e];let _;f.bands&&(_=f.bands.map(function(P){return P-1}));let y;"nodata"in f&&f.nodata!==null?y=f.nodata:_?y=_.map(function(P){return l[h][P]}):y=l[h];const T={window:d,width:s[0],height:s[1],samples:_,fillValue:y,pool:u,interleave:!1,signal:n.signal};Sf(this.convertToRGB_,m)?a[h]=m.readRGB(T):a[h]=m.readRasters(T);const x=o+h,S=this.sourceMasks_[h][e];if(!S){a[x]=Promise.resolve(null);continue}a[x]=S.readRasters({window:d,width:s[0],height:s[1],samples:[0],pool:u,interleave:!1})}return Promise.all(a).then(this.composeTile_.bind(this,s)).catch(function(h){throw Wt(h),h})}composeTile_(e,t){const r=this.metadata_,n=this.sourceInfo_,s=this.sourceImagery_.length,o=this.bandCount,a=this.samplesPerPixel_,l=this.nodataValues_,c=this.normalize_,u=this.addAlpha_,h=e[0]*e[1],f=h*o;let g;c?g=new Uint8Array(f):g=new Float32Array(f);let d=0;for(let m=0;m<h;++m){let _=u;for(let y=0;y<s;++y){const T=n[y];let x=T.min,S=T.max,P,R;if(c){const v=r[y][0];x===void 0&&(v&&Yn in v?x=parseFloat(v[Yn]):x=If(t[y][0])),S===void 0&&(v&&Vn in v?S=parseFloat(v[Vn]):S=Ff(t[y][0])),P=255/(S-x),R=-x*P}for(let v=0;v<a[y];++v){const F=t[y][v][m];let C;if(c?C=ue(P*F+R,0,255):C=F,!u)g[d]=C;else{let w=T.nodata;if(w===void 0){let M;T.bands?M=T.bands[v]-1:M=v,w=l[y][M]}const U=isNaN(w);(!U&&F!==w||U&&!isNaN(F))&&(_=!1,g[d]=C)}d++}if(!_){const v=s+y,F=t[v];F&&!F[0][m]&&(_=!0)}}u&&(_||(g[d]=255),d++)}return g}}ao.prototype.getView;const Nf=22;class Mf extends Ye{constructor(e){const t=!!e.highDpi;super({attributionsCollapsible:e.attributionsCollapsible,cacheSize:e.cacheSize,crossOrigin:"anonymous",interpolate:e.interpolate,projection:"EPSG:3857",reprojectionErrorThreshold:e.reprojectionErrorThreshold,state:"loading",tileLoadFunction:e.tileLoadFunction,tilePixelRatio:t?2:1,wrapX:e.wrapX!==void 0?e.wrapX:!0,transition:e.transition,zDirection:e.zDirection}),this.apiKey_=e.key,this.error_=null;const r={mapType:e.mapType||"roadmap",language:e.language||"en-US",region:e.region||"US"};e.imageFormat&&(r.imageFormat=e.imageFormat),e.scale&&(r.scale=e.scale),t&&(r.highDpi=!0),e.layerTypes&&(r.layerTypes=e.layerTypes),e.styles&&(r.styles=e.styles),e.overlay===!0&&(r.overlay=!0),e.apiOptions&&(r.apiOptions=e.apiOptions),this.sessionTokenRequest_=r,this.sessionTokenValue_,this.sessionRefreshId_,this.previousViewportAttribution_,this.previousViewportExtent_;const n=e.url||"https://tile.googleapis.com/";this.createSessionUrl_=n+"v1/createSession",this.tileUrl_=n+"v1/2dtiles",this.attributionUrl_=n+"tile/v1/viewport",this.createSession_()}getError(){return this.error_}fetchSessionToken(e,t){return fetch(e,t)}async createSession_(){const e=this.createSessionUrl_+"?key="+this.apiKey_,t={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(this.sessionTokenRequest_)},r=await this.fetchSessionToken(e,t);if(!r.ok){try{const f=await r.json();this.error_=new Error(f.error.message)}catch{this.error_=new Error("Error fetching session token")}this.setState("error");return}const n=await r.json(),s=this.getTilePixelRatio(1),o=[n.tileWidth/s,n.tileHeight/s];this.tileGrid=qt({extent:Yt(this.getProjection()),maxZoom:Nf,tileSize:o});const a=n.session;this.sessionTokenValue_=a;const l=this.apiKey_,c=this.tileUrl_;this.tileUrlFunction=function(f,g,d){const m=f[0],_=f[1],y=f[2];return`${c}/${m}/${_}/${y}?session=${a}&key=${l}`};const u=parseInt(n.expiry,10)*1e3,h=Math.max(u-Date.now()-60*1e3,1);this.sessionRefreshId_=setTimeout(()=>this.createSession_(),h),this.setAttributions(this.fetchAttributions_.bind(this)),this.setState("ready")}async fetchAttributions_(e){if(e.viewHints[st.ANIMATING]||e.viewHints[st.INTERACTING]||e.animate)return this.previousViewportAttribution_;const[t,r]=on(Fa(e.extent),e.viewState.projection),[n,s]=on(Na(e.extent),e.viewState.projection),l=`zoom=${this.getTileGrid().getZForResolution(e.viewState.resolution,this.zDirection)}&north=${s}&south=${r}&east=${n}&west=${t}`;if(this.previousViewportExtent_==l)return this.previousViewportAttribution_;this.previousViewportExtent_=l;const c=this.sessionTokenValue_,u=this.apiKey_,f=`${this.attributionUrl_}?session=${c}&key=${u}&${l}`;return this.previousViewportAttribution_=await fetch(f).then(g=>g.json()).then(g=>g.copyright),this.previousViewportAttribution_}disposeInternal(){clearTimeout(this.sessionRefreshId_),super.disposeInternal()}}let lo=class extends mi{constructor(e,t,r,n,s,o,a){super(t,r,n,s,o,a),this.zoomifyImage_=null,this.tileSize_=e}getImage(){if(this.zoomifyImage_)return this.zoomifyImage_;const e=super.getImage();if(this.state==V.LOADED){const t=this.tileSize_;if(e.width==t[0]&&e.height==t[1])return this.zoomifyImage_=e,e;const r=nt(t[0],t[1]);return r.drawImage(e,0,0),this.zoomifyImage_=r.canvas,r.canvas}return e}};class Of extends Ye{constructor(e){const t=e.size,r=e.tierSizeCalculation!==void 0?e.tierSizeCalculation:"default",n=e.tilePixelRatio||1,s=t[0],o=t[1],a=[],l=e.tileSize||ti;let c=l*n;switch(r){case"default":for(;s>c||o>c;)a.push([Math.ceil(s/c),Math.ceil(o/c)]),c+=c;break;case"truncated":let R=s,v=o;for(;R>c||v>c;)a.push([Math.ceil(R/c),Math.ceil(v/c)]),R>>=1,v>>=1;break;default:throw new Error("Unknown `tierSizeCalculation` configured")}a.push([1,1]),a.reverse();const u=[n],h=[0];for(let R=1,v=a.length;R<v;R++)u.push(n<<R),h.push(a[R-1][0]*a[R-1][1]+h[R-1]);u.reverse();const f=new Cr({tileSize:l,extent:e.extent||[0,-o,s,0],resolutions:u});let g=e.url;g&&!g.includes("{TileGroup}")&&!g.includes("{tileIndex}")&&(g+="{TileGroup}/{z}-{x}-{y}.jpg");const d=gs(g);let m=l*n;function _(R){return function(v,F,C){if(!v)return;const w=v[0],U=v[1],M=v[2],z=U+M*a[w][0],Z=(z+h[w])/m|0,$={z:w,x:U,y:M,tileIndex:z,TileGroup:"TileGroup"+Z};return R.replace(/\{(\w+?)\}/g,function(se,B){return $[B]})}}const y=xi(d.map(_)),T=lo.bind(null,Ne(l*n));super({attributions:e.attributions,cacheSize:e.cacheSize,crossOrigin:e.crossOrigin,interpolate:e.interpolate,projection:e.projection,tilePixelRatio:n,reprojectionErrorThreshold:e.reprojectionErrorThreshold,tileClass:T,tileGrid:f,tileUrlFunction:y,transition:e.transition}),this.zDirection=e.zDirection;const x=f.getTileCoordForCoordAndResolution(et(f.getExtent()),u[u.length-1]),S=y(x,1,null),P=new Image;P.addEventListener("error",()=>{m=l,this.changed()}),P.src=S}}function Dt(i){return i.toLocaleString("en",{maximumFractionDigits:10})}class Df extends Ye{constructor(e){const t=e||{};let r=t.url||"";r=r+(r.lastIndexOf("/")===r.length-1||r===""?"":"/");const n=t.version||ge.VERSION2,s=t.sizes||[],o=t.size;be(o!=null&&Array.isArray(o)&&o.length==2&&!isNaN(o[0])&&o[0]>0&&!isNaN(o[1])&&o[1]>0,"Missing or invalid `size`");const a=o[0],l=o[1],c=t.tileSize,u=t.tilePixelRatio||1,h=t.format||"jpg",f=t.quality||(t.version==ge.VERSION1?"native":"default");let g=t.resolutions||[];const d=t.supports||[],m=t.extent||[0,-l,a,0],_=s!=null&&Array.isArray(s)&&s.length>0,y=c!==void 0&&(typeof c=="number"&&Number.isInteger(c)&&c>0||Array.isArray(c)&&c.length>0),T=d!=null&&Array.isArray(d)&&(d.includes("regionByPx")||d.includes("regionByPct"))&&(d.includes("sizeByWh")||d.includes("sizeByH")||d.includes("sizeByW")||d.includes("sizeByPct"));let x,S,P;if(g.sort(function(C,w){return w-C}),y||T)if(c!=null&&(typeof c=="number"&&Number.isInteger(c)&&c>0?(x=c,S=c):Array.isArray(c)&&c.length>0&&((c.length==1||c[1]==null&&Number.isInteger(c[0]))&&(x=c[0],S=c[0]),c.length==2&&(Number.isInteger(c[0])&&Number.isInteger(c[1])?(x=c[0],S=c[1]):c[0]==null&&Number.isInteger(c[1])&&(x=c[1],S=c[1])))),(x===void 0||S===void 0)&&(x=ti,S=ti),g.length==0){P=Math.max(Math.ceil(Math.log(a/x)/Math.LN2),Math.ceil(Math.log(l/S)/Math.LN2));for(let C=P;C>=0;C--)g.push(Math.pow(2,C))}else{const C=Math.max(...g);P=Math.round(Math.log(C)/Math.LN2)}else if(x=a,S=l,g=[],_){s.sort(function(w,U){return w[0]-U[0]}),P=-1;const C=[];for(let w=0;w<s.length;w++){const U=a/s[w][0];if(g.length>0&&g[g.length-1]==U){C.push(w);continue}g.push(U),P++}if(C.length>0)for(let w=0;w<C.length;w++)s.splice(C[w]-w,1)}else g.push(1),s.push([a,l]),P=0;const R=new Cr({tileSize:[x,S],extent:m,origin:ei(m),resolutions:g}),v=function(C,w,U){let M,z;const Z=C[0];if(Z>P)return;const $=C[1],se=C[2],B=g[Z];if(!($===void 0||se===void 0||B===void 0||$<0||Math.ceil(a/B/x)<=$||se<0||Math.ceil(l/B/S)<=se)){if(T||y){const le=$*x*B,ne=se*S*B;let oe=x*B,he=S*B,Te=x,ce=S;if(le+oe>a&&(oe=a-le),ne+he>l&&(he=l-ne),le+x*B>a&&(Te=Math.floor((a-le+B-1)/B)),ne+S*B>l&&(ce=Math.floor((l-ne+B-1)/B)),le==0&&oe==a&&ne==0&&he==l)M="full";else if(!T||d.includes("regionByPx"))M=le+","+ne+","+oe+","+he;else if(d.includes("regionByPct")){const we=Dt(le/a*100),Fe=Dt(ne/l*100),$e=Dt(oe/a*100),_t=Dt(he/l*100);M="pct:"+we+","+Fe+","+$e+","+_t}n==ge.VERSION3&&(!T||d.includes("sizeByWh"))?z=Te+","+ce:!T||d.includes("sizeByW")?z=Te+",":d.includes("sizeByH")?z=","+ce:d.includes("sizeByWh")?z=Te+","+ce:d.includes("sizeByPct")&&(z="pct:"+Dt(100/B))}else if(M="full",_){const le=s[Z][0],ne=s[Z][1];n==ge.VERSION3?le==a&&ne==l?z="max":z=le+","+ne:le==a?z="full":z=le+","}else z=n==ge.VERSION3?"max":"full";return r+M+"/"+z+"/0/"+f+"."+h}},F=lo.bind(null,Ne(c||256).map(function(C){return C*u}));super({attributions:t.attributions,attributionsCollapsible:t.attributionsCollapsible,cacheSize:t.cacheSize,crossOrigin:t.crossOrigin,interpolate:t.interpolate,projection:t.projection,reprojectionErrorThreshold:t.reprojectionErrorThreshold,state:t.state,tileClass:F,tileGrid:R,tilePixelRatio:t.tilePixelRatio,tileUrlFunction:v,transition:t.transition}),this.zDirection=t.zDirection}}function co(i,e,t,r,n,s){const o=n.getCode().split(/:(?=\d+$)/).pop(),a=t/r,l=[an(Ee(e)/a,ln),an(Me(e)/a,ln)];s.SIZE=l[0]+","+l[1],s.BBOX=e.join(","),s.BBOXSR=o,s.IMAGESR=o,s.DPI=Math.round(s.DPI?s.DPI*r:90*r);const c=i.replace(/MapServer\/?$/,"MapServer/export").replace(/ImageServer\/?$/,"ImageServer/exportImage");return Er(c,s)}function Gf(i){const e=i.load?i.load:Ct,t=Q(i.projection||"EPSG:3857"),r=i.ratio??1.5,n=i.crossOrigin??null;return function(s,o,a){a=i.hidpi?a:1;const l={F:"image",FORMAT:"PNG32",TRANSPARENT:!0};Object.assign(l,i.params),s=ps(s,o,a,r);const c=co(i.url,s,o,a,t,l),u=new Image;return u.crossOrigin=n,e(u,c).then(h=>{const f=Ee(s)/h.width*a;return{image:h,extent:s,resolution:f,pixelRatio:a}})}}class Uf extends pt{constructor(e){e=e||{},super({attributions:e.attributions,interpolate:e.interpolate,projection:e.projection,resolutions:e.resolutions}),this.crossOrigin_=e.crossOrigin!==void 0?e.crossOrigin:null,this.hidpi_=e.hidpi!==void 0?e.hidpi:!0,this.url_=e.url,this.imageLoadFunction_=e.imageLoadFunction!==void 0?e.imageLoadFunction:Pi,this.params_=Object.assign({},e.params),this.imageSize_=[0,0],this.renderedRevision_=0,this.ratio_=e.ratio!==void 0?e.ratio:1.5,this.loaderProjection_=null}getParams(){return this.params_}getImageInternal(e,t,r,n){return this.url_===void 0?null:((!this.loader||this.loaderProjection_!==n)&&(this.loaderProjection_=n,this.loader=Gf({crossOrigin:this.crossOrigin_,params:this.params_,projection:n,hidpi:this.hidpi_,url:this.url_,ratio:this.ratio_,load:(s,o)=>(this.image.setImage(s),this.imageLoadFunction_(this.image,o),Ct(s))})),super.getImageInternal(e,t,r,n))}getImageLoadFunction(){return this.imageLoadFunction_}getUrl(){return this.url_}setImageLoadFunction(e){this.imageLoadFunction_=e,this.changed()}setUrl(e){e!=this.url_&&(this.url_=e,this.loader=null,this.changed())}setParams(e){this.params_=Object.assign({},e),this.changed()}updateParams(e){Object.assign(this.params_,e),this.changed()}changed(){this.image=null,super.changed()}}class Bf extends pt{constructor(e){e=e||{},super({attributions:e.attributions,interpolate:e.interpolate,projection:e.projection,resolutions:e.resolutions,state:e.state}),this.canvasFunction_=e.canvasFunction,this.canvas_=null,this.renderedRevision_=0,this.ratio_=e.ratio!==void 0?e.ratio:1.5}getImageInternal(e,t,r,n){t=this.findNearestResolution(t);let s=this.canvas_;if(s&&this.renderedRevision_==this.getRevision()&&s.getResolution()==t&&s.getPixelRatio()==r&&ur(s.getExtent(),e))return s;e=e.slice(),ds(e,this.ratio_);const o=Ee(e)/t,a=Me(e)/t,l=[o*r,a*r],c=this.canvasFunction_.call(this,e,t,r,l,n);return c&&(s=new Vi(e,t,r,c)),this.canvas_=s,this.renderedRevision_=this.getRevision(),s}}function zf(i,e,t,r){const n=Ee(i),s=Me(i),o=e[0],a=e[1],l=.0254/r;return a*n>o*s?n*t/(o*l):s*t/(a*l)}function $f(i,e,t,r,n,s,o){const a=zf(t,r,s,o),l=et(t),c={OPERATION:n?"GETDYNAMICMAPOVERLAYIMAGE":"GETMAPIMAGE",VERSION:"2.0.0",LOCALE:"en",CLIENTAGENT:"ol/source/ImageMapGuide source",CLIP:"1",SETDISPLAYDPI:o,SETDISPLAYWIDTH:Math.round(r[0]),SETDISPLAYHEIGHT:Math.round(r[1]),SETVIEWSCALE:a,SETVIEWCENTERX:l[0],SETVIEWCENTERY:l[1]};return Object.assign(c,e),Er(i,c)}function Xf(i){const e=i.load||Ct,t=i.useOverlay??!1,r=i.metersPerUnit||1,n=i.displayDpi||96,s=i.ratio??1,o=i.crossOrigin??null;return function(a,l,c){const u=new Image;u.crossOrigin=o,a=ps(a,l,c,s);const h=Ee(a)/l,f=Me(a)/l,g=[h*c,f*c],d=$f(i.url,i.params,a,g,t,r,n);return e(u,d).then(m=>({image:m,extent:a,pixelRatio:c}))}}class kf extends pt{constructor(e){super({interpolate:e.interpolate,projection:e.projection,resolutions:e.resolutions}),this.crossOrigin_=e.crossOrigin!==void 0?e.crossOrigin:null,this.displayDpi_=e.displayDpi!==void 0?e.displayDpi:96,this.params_=Object.assign({},e.params),this.url_=e.url,this.imageLoadFunction_=e.imageLoadFunction!==void 0?e.imageLoadFunction:Pi,this.hidpi_=e.hidpi!==void 0?e.hidpi:!0,this.metersPerUnit_=e.metersPerUnit!==void 0?e.metersPerUnit:1,this.ratio_=e.ratio!==void 0?e.ratio:1,this.useOverlay_=e.useOverlay!==void 0?e.useOverlay:!1,this.renderedRevision_=0,this.loaderProjection_=null}getParams(){return this.params_}getImageInternal(e,t,r,n){return this.url_===void 0?null:((!this.loader||this.loaderProjection_!==n)&&(this.loaderProjection_=n,this.loader=Xf({crossOrigin:this.crossOrigin_,params:this.params_,hidpi:this.hidpi_,metersPerUnit:this.metersPerUnit_,url:this.url_,useOverlay:this.useOverlay_,ratio:this.ratio_,load:(s,o)=>(this.image.setImage(s),this.imageLoadFunction_(this.image,o),Ct(s))})),super.getImageInternal(e,t,r,n))}getImageLoadFunction(){return this.imageLoadFunction_}setParams(e){this.params_=Object.assign({},e),this.changed()}updateParams(e){Object.assign(this.params_,e),this.changed()}setImageLoadFunction(e){this.imageLoadFunction_=e,this.changed()}changed(){this.image=null,super.changed()}}function jf(i){const e=i.load||Ct,t=i.imageExtent,r=i.crossOrigin??null;return()=>{const n=new Image;return n.crossOrigin=r,e(n,i.url).then(s=>{const o=Ee(t)/s.width,a=Me(t)/s.height;return{image:s,extent:t,resolution:o!==a?[o,a]:a,pixelRatio:1}})}}class Wf extends pt{constructor(e){const t=e.crossOrigin!==void 0?e.crossOrigin:null,r=e.imageLoadFunction!==void 0?e.imageLoadFunction:Pi;super({attributions:e.attributions,interpolate:e.interpolate,projection:Q(e.projection)}),this.url_=e.url,this.imageExtent_=e.imageExtent,this.image=null,this.image=new hs(this.imageExtent_,void 0,1,jf({url:e.url,imageExtent:e.imageExtent,crossOrigin:t,load:(n,s)=>(this.image.setImage(n),r(this.image,s),Ct(n))})),this.image.addEventListener(xe.CHANGE,this.handleImageChange.bind(this))}getImageExtent(){return this.imageExtent_}getImageInternal(e,t,r,n){return wt(e,this.image.getExtent())?this.image:null}getUrl(){return this.url_}}const Zf=new Error("Image failed to load");function uo(i,e,t,r,n){return new Promise((s,o)=>{const a=new Image;a.crossOrigin=n.crossOrigin??null,a.addEventListener("load",()=>s(a)),a.addEventListener("error",()=>o(Zf)),a.src=ms(i,e,t,r,n.maxY)})}function qn(i){return function(e,t,r,n){const s=Ma(i,e,t,r);return uo(s,e,t,r,n)}}function Hf(i){return function(e,t,r,n){const s=i(e,t,r,n);return uo(s,e,t,r,n)}}function Kn(i){let e;if(Array.isArray(i))e=qn(i);else if(typeof i=="string"){const t=gs(i);e=qn(t)}else if(typeof i=="function")e=Hf(i);else throw new Error("The url option must be a single template, an array of templates, or a function for getting a URL");return e}let Jn=0;function Qn(i){return Array.isArray(i)?i.join(`
`):typeof i=="string"?i:(++Jn,"url-function-key-"+Jn)}class ho extends Ur{constructor(e){e=e||{};let t=e.loader,r;e.url&&(t=Kn(e.url),r=Qn(e.url));const n=t?e.state:"loading",s=e.wrapX===void 0?!0:e.wrapX;super({loader:t,key:r,attributions:e.attributions,attributionsCollapsible:e.attributionsCollapsible,maxZoom:e.maxZoom,minZoom:e.minZoom,tileSize:e.tileSize,gutter:e.gutter,maxResolution:e.maxResolution,projection:e.projection,tileGrid:e.tileGrid,state:n,wrapX:s,transition:e.transition,interpolate:e.interpolate!==!1,crossOrigin:e.crossOrigin,zDirection:e.zDirection})}setUrl(e){const t=Kn(e);this.setLoader(t),this.setKey(Qn(e)),this.getState()!=="ready"&&this.setState("ready")}}function Yi(i,e,t,r){const n=document.createElement("script"),s="olc_"+J(e);function o(){delete window[s],n.parentNode.removeChild(n)}n.async=!0,n.src=i+(i.includes("?")?"&":"?")+"callback="+s;const a=setTimeout(function(){o(),t&&t()},1e4);window[s]=function(l){clearTimeout(a),o(),e(l)},document.head.appendChild(n)}class Vf extends Error{constructor(e){const t="Unexpected response status: "+e.status;super(t),this.name="ResponseError",this.response=e}}class Yf extends Error{constructor(e){super("Failed to issue request"),this.name="ClientError",this.client=e}}function fo(i){return new Promise(function(e,t){function r(o){const a=o.target;if(!a.status||a.status>=200&&a.status<300){let l;try{l=JSON.parse(a.responseText)}catch(c){const u="Error parsing response text as JSON: "+c.message;t(new Error(u));return}e(l);return}t(new Vf(a))}function n(o){t(new Yf(o.target))}const s=new XMLHttpRequest;s.addEventListener("load",r),s.addEventListener("error",n),s.open("GET",i),s.setRequestHeader("Accept","application/json"),s.send()})}function go(i,e){return e.includes("://")?e:new URL(e,i).href}const qf={"image/png":!0,"image/jpeg":!0,"image/gif":!0,"image/webp":!0},Kf={"application/vnd.mapbox-vector-tile":!0,"application/geo+json":!0};function po(i,e){if(!e.length)return i;const t=new URL(i,"file:/");if(t.pathname.split("/").includes("collections"))return Wt('The "collections" query parameter cannot be added to collection endpoints'),i;const r=e.map(o=>encodeURIComponent(o)).join(",");t.searchParams.append("collections",r);const n=i.split("?")[0],s=decodeURIComponent(t.searchParams.toString());return`${n}?${s}`}function Jf(i,e,t){let r,n;for(let s=0;s<i.length;++s){const o=i[s];if(o.rel==="item"){if(o.type===e){r=o.href;break}(qf[o.type]||!n&&o.type.startsWith("image/"))&&(n=o.href)}}if(!r)if(n)r=n;else throw new Error('Could not find "item" link');return t&&(r=po(r,t)),r}function Qf(i,e,t,r){let n,s;const o={};for(let a=0;a<i.length;++a){const l=i[a];if(o[l.type]=l.href,l.rel==="item"){if(l.type===e){n=l.href;break}Kf[l.type]&&(s=l.href)}}if(!n&&t)for(let a=0;a<t.length;++a){const l=t[a];if(o[l]){n=o[l];break}}if(!n)if(s)n=s;else throw new Error('Could not find "item" link');return r&&(n=po(n,r)),n}function es(i,e,t,r){let n=i.projection;if(!n&&(typeof e.crs=="string"?n=Q(e.crs):"uri"in e.crs&&(n=Q(e.crs.uri)),!n))throw new Error(`Unsupported CRS: ${JSON.stringify(e.crs)}`);const s=e.orderedAxes,a=!(s?s.slice(0,2).map(R=>R.replace(/E|X|Lon/i,"e").replace(/N|Y|Lat/i,"n")).join(""):n.getAxisOrientation()).startsWith("en"),l=e.tileMatrices,c={};for(let R=0;R<l.length;++R){const v=l[R];c[v.id]=v}const u={},h=[];if(r)for(let R=0;R<r.length;++R){const v=r[R],F=v.tileMatrix;h.push(F),u[F]=v}else for(let R=0;R<l.length;++R){const v=l[R].id;h.push(v)}const f=h.length,g=new Array(f),d=new Array(f),m=new Array(f),_=new Array(f),y=[-1/0,-1/0,1/0,1/0];for(let R=0;R<f;++R){const v=h[R],F=c[v],C=F.pointOfOrigin;a?g[R]=[C[1],C[0]]:g[R]=C,d[R]=F.cellSize,m[R]=[F.matrixWidth,F.matrixHeight],_[R]=[F.tileWidth,F.tileHeight];const w=u[v];if(w){const U=F.cellSize*F.tileWidth,M=g[R][0]+w.minTileCol*U,z=g[R][0]+(w.maxTileCol+1)*U,Z=F.cellSize*F.tileHeight,$=F.cornerOfOrigin==="bottomLeft";let se,B;$?(se=g[R][1]+w.minTileRow*Z,B=g[R][1]+(w.maxTileRow+1)*Z):(se=g[R][1]-(w.maxTileRow+1)*Z,B=g[R][1]-w.minTileRow*Z),Ue(y,[M,se,z,B],y)}}const T=new Cr({origins:g,resolutions:d,sizes:m,tileSizes:_,extent:r?y:void 0}),x=i.context,S=i.url;function P(R,v,F){if(!R)return;const C=h[R[0]],w=c[C],U=w.cornerOfOrigin==="bottomLeft",M={tileMatrix:C,tileCol:R[1],tileRow:U?-R[2]-1:R[2]};if(r){const Z=u[w.id];if(M.tileCol<Z.minTileCol||M.tileCol>Z.maxTileCol||M.tileRow<Z.minTileRow||M.tileRow>Z.maxTileRow)return}Object.assign(M,{z:M.tileMatrix,x:M.tileCol,y:M.tileRow},x);const z=t.replace(/\{(\w+?)\}/g,function(Z,$){return M[$]});return go(S,z)}return{grid:T,projection:n,urlTemplate:t,urlFunction:P}}function eg(i,e){const t=e.tileMatrixSetLimits;let r;if(e.dataType==="map")r=Jf(e.links,i.mediaType,i.collections);else if(e.dataType==="vector")r=Qf(e.links,i.mediaType,i.supportedMediaTypes,i.collections);else throw new Error('Expected tileset data type to be "map" or "vector"');if(e.tileMatrixSet)return es(i,e.tileMatrixSet,r,t);const n=e.links.find(a=>a.rel==="http://www.opengis.net/def/rel/ogc/1.0/tiling-scheme");if(!n)throw new Error("Expected http://www.opengis.net/def/rel/ogc/1.0/tiling-scheme link or tileMatrixSet");const s=n.href,o=go(i.url,s);return fo(o).then(function(a){return es(i,a,r,t)})}function mo(i){return fo(i.url).then(function(e){return eg(i,e)})}class tg extends Ye{constructor(e){super({attributions:e.attributions,cacheSize:e.cacheSize,crossOrigin:e.crossOrigin,interpolate:e.interpolate,projection:e.projection,reprojectionErrorThreshold:e.reprojectionErrorThreshold,state:"loading",tileLoadFunction:e.tileLoadFunction,wrapX:e.wrapX!==void 0?e.wrapX:!0,transition:e.transition});const t={url:e.url,projection:this.getProjection(),mediaType:e.mediaType,context:e.context||null,collections:e.collections};mo(t).then(this.handleTileSetInfo_.bind(this)).catch(this.handleError_.bind(this))}handleTileSetInfo_(e){this.tileGrid=e.grid,this.projection=e.projection,this.setTileUrlFunction(e.urlFunction,e.urlTemplate),this.setState("ready")}handleError_(e){Wt(e),this.setState("error")}}class rg extends Oa{constructor(e){super({attributions:e.attributions,attributionsCollapsible:e.attributionsCollapsible,cacheSize:e.cacheSize,format:e.format,overlaps:e.overlaps,projection:e.projection,tileClass:e.tileClass,transition:e.transition,wrapX:e.wrapX,zDirection:e.zDirection,state:"loading"});const t={url:e.url,projection:this.getProjection(),mediaType:e.mediaType,supportedMediaTypes:e.format.supportedMediaTypes,context:e.context||null,collections:e.collections};mo(t).then(this.handleTileSetInfo_.bind(this)).catch(this.handleError_.bind(this))}handleTileSetInfo_(e){this.tileGrid=e.grid,this.projection=e.projection,this.setTileUrlFunction(e.urlFunction,e.urlTemplate),this.setState("ready")}handleError_(e){Wt(e),this.setState("error")}}function _o(i){return function(e){const t=e.buffers,r=e.meta,n=e.imageOps,s=e.width,o=e.height,a=t.length,l=t[0].byteLength;if(n){const f=new Array(a);for(let d=0;d<a;++d)f[d]=new ImageData(new Uint8ClampedArray(t[d]),s,o);return i(f,r).data.buffer}const c=new Uint8ClampedArray(l),u=new Array(a),h=new Array(a);for(let f=0;f<a;++f)u[f]=new Uint8ClampedArray(t[f]),h[f]=[0,0,0,0];for(let f=0;f<l;f+=4){for(let d=0;d<a;++d){const m=u[d];h[d][0]=m[f],h[d][1]=m[f+1],h[d][2]=m[f+2],h[d][3]=m[f+3]}const g=i(h,r);c[f]=g[0],c[f+1]=g[1],c[f+2]=g[2],c[f+3]=g[3]}return c.buffer}}function ig(i,e){const r=Object.keys(i.lib||{}).map(function(s){return"const "+s+" = "+i.lib[s].toString()+";"}).concat(["const __minion__ = ("+_o.toString()+")(",i.operation.toString(),");",'self.addEventListener("message", function(event) {',"  const buffer = __minion__(event.data);","  self.postMessage({buffer: buffer, meta: event.data.meta}, [buffer]);","});"]),n=new Worker(typeof Blob>"u"?"data:text/javascript;base64,"+Buffer.from(r.join(`
`),"binary").toString("base64"):URL.createObjectURL(new Blob(r,{type:"text/javascript"})));return n.addEventListener("message",e),n}function ng(i,e){const t=_o(i.operation);let r=!1;return{postMessage:function(n){setTimeout(function(){r||e({data:{buffer:t(n),meta:n.meta}})},0)},terminate:function(){r=!0}}}class sg extends as{constructor(e){super(),this.imageOps_=!!e.imageOps;let t;e.threads===0?t=0:this.imageOps_?t=1:t=e.threads||1;const r=new Array(t);if(t)for(let n=0;n<t;++n)r[n]=ig(e,this.onWorkerMessage_.bind(this,n));else r[0]=ng(e,this.onWorkerMessage_.bind(this,0));this.workers_=r,this.queue_=[],this.maxQueueLength_=e.queue||1/0,this.running_=0,this.dataLookup_={},this.job_=null}process(e,t,r){this.enqueue_({inputs:e,meta:t,callback:r}),this.dispatch_()}enqueue_(e){for(this.queue_.push(e);this.queue_.length>this.maxQueueLength_;)this.queue_.shift().callback(null,null)}dispatch_(){if(this.running_||this.queue_.length===0)return;const e=this.queue_.shift();this.job_=e;const t=e.inputs[0].width,r=e.inputs[0].height,n=e.inputs.map(function(l){return l.data.buffer}),s=this.workers_.length;if(this.running_=s,s===1){this.workers_[0].postMessage({buffers:n,meta:e.meta,imageOps:this.imageOps_,width:t,height:r},n);return}const o=e.inputs[0].data.length,a=4*Math.ceil(o/4/s);for(let l=0;l<s;++l){const c=l*a,u=[];for(let h=0,f=n.length;h<f;++h)u.push(n[h].slice(c,c+a));this.workers_[l].postMessage({buffers:u,meta:e.meta,imageOps:this.imageOps_,width:t,height:r},u)}}onWorkerMessage_(e,t){this.disposed||(this.dataLookup_[e]=t.data,--this.running_,this.running_===0&&this.resolveJob_())}resolveJob_(){const e=this.job_,t=this.workers_.length;let r,n;if(t===1)r=new Uint8ClampedArray(this.dataLookup_[0].buffer),n=this.dataLookup_[0].meta;else{const s=e.inputs[0].data.length;r=new Uint8ClampedArray(s),n=new Array(t);const o=4*Math.ceil(s/4/t);for(let a=0;a<t;++a){const l=this.dataLookup_[a].buffer,c=a*o;r.set(new Uint8ClampedArray(l),c),n[a]=this.dataLookup_[a].meta}}this.job_=null,this.dataLookup_={},e.callback(null,new ImageData(r,e.inputs[0].width,e.inputs[0].height),n),this.dispatch_()}disposeInternal(){for(let e=0;e<this.workers_.length;++e)this.workers_[e].terminate();this.workers_.length=0}}const ts={BEFOREOPERATIONS:"beforeoperations",AFTEROPERATIONS:"afteroperations"};class rs extends Ga{constructor(e,t,r){super(e),this.extent=t.extent,this.resolution=t.viewState.resolution/t.pixelRatio,this.data=r}}class Eo extends pt{constructor(e){super({projection:null}),this.on,this.once,this.un,this.processor_=null,this.operationType_=e.operationType!==void 0?e.operationType:"pixel",this.threads_=e.threads!==void 0?e.threads:1,this.layers_=lg(e.sources);const t=this.changed.bind(this);for(let r=0,n=this.layers_.length;r<n;++r)this.layers_[r].addEventListener(xe.CHANGE,t);this.useResolutions_=e.resolutions!==null,this.tileQueue_=new Da(function(){return 1},this.processSources_.bind(this)),this.requestedFrameState_,this.renderedImageCanvas_=null,this.renderedRevision_,this.frameState_={animate:!1,coordinateToPixelTransform:_e(),declutter:null,extent:null,index:0,layerIndex:0,layerStatesArray:ag(this.layers_),pixelRatio:1,pixelToCoordinateTransform:_e(),postRenderFunctions:[],size:[0,0],tileQueue:this.tileQueue_,time:Date.now(),usedTiles:{},viewState:{rotation:0},viewHints:[],wantedTiles:{},mapId:J(this),renderTargets:{}},this.setAttributions(function(r){var s;const n=[];for(let o=0,a=e.sources.length;o<a;++o){const l=e.sources[o],c=l instanceof wi?l:l.getSource();if(!c)continue;const u=(s=c.getAttributions())==null?void 0:s(r);typeof u=="string"?n.push(u):u!==void 0&&n.push(...u)}return n}),e.operation!==void 0&&this.setOperation(e.operation,e.lib)}setOperation(e,t){this.processor_&&this.processor_.dispose(),this.processor_=new sg({operation:e,imageOps:this.operationType_==="image",queue:1,lib:t,threads:this.threads_}),this.changed()}updateFrameState_(e,t,r){const n=Object.assign({},this.frameState_);n.viewState=Object.assign({},n.viewState);const s=et(e);n.size[0]=Math.ceil(Ee(e)/t),n.size[1]=Math.ceil(Me(e)/t),n.extent=[s[0]-n.size[0]*t/2,s[1]-n.size[1]*t/2,s[0]+n.size[0]*t/2,s[1]+n.size[1]*t/2],n.time=Date.now();const o=n.viewState;return o.center=s,o.projection=r,o.resolution=t,n}allSourcesReady_(){let e=!0,t;for(let r=0,n=this.layers_.length;r<n;++r)if(t=this.layers_[r].getSource(),!t||t.getState()!=="ready"){e=!1;break}return e}getImage(e,t,r,n){if(!this.allSourcesReady_())return null;this.tileQueue_.loadMoreTiles(16,16),t=this.findNearestResolution(t);const s=this.updateFrameState_(e,t,n);if(this.requestedFrameState_=s,this.renderedImageCanvas_){const o=this.renderedImageCanvas_.getResolution(),a=this.renderedImageCanvas_.getExtent();(t!==o||!$t(s.extent,a))&&(this.renderedImageCanvas_=null)}return(!this.renderedImageCanvas_||this.getRevision()!==this.renderedRevision_)&&this.processSources_(),s.animate&&requestAnimationFrame(this.changed.bind(this)),this.renderedImageCanvas_}processSources_(){const e=this.requestedFrameState_,t=this.layers_.length,r=new Array(t);for(let s=0;s<t;++s){e.layerIndex=s,e.renderTargets={};const o=og(this.layers_[s],e);if(o)r[s]=o;else return}const n={};this.dispatchEvent(new rs(ts.BEFOREOPERATIONS,e,n)),this.processor_.process(r,n,this.onWorkerComplete_.bind(this,e))}onWorkerComplete_(e,t,r,n){if(t||!r)return;const s=e.extent,o=e.viewState.resolution;if(o!==this.requestedFrameState_.viewState.resolution||!$t(s,this.requestedFrameState_.extent))return;let a;if(this.renderedImageCanvas_)a=this.renderedImageCanvas_.getImage().getContext("2d");else{const l=Math.round(Ee(s)/o),c=Math.round(Me(s)/o);a=nt(l,c),this.renderedImageCanvas_=new Vi(s,o,1,a.canvas)}a.putImageData(r,0,0),e.animate?requestAnimationFrame(this.changed.bind(this)):this.changed(),this.renderedRevision_=this.getRevision(),this.dispatchEvent(new rs(ts.AFTEROPERATIONS,e,n))}getResolutions(e){if(!this.useResolutions_)return null;let t=super.getResolutions();if(!t)for(let r=0,n=this.layers_.length;r<n&&(t=this.layers_[r].getSource().getResolutions(e),!t);++r);return t}disposeInternal(){this.processor_&&this.processor_.dispose(),super.disposeInternal()}}Eo.prototype.dispose;let at=null;function og(i,e){const t=i.getRenderer();if(!t)throw new Error("Unsupported layer type: "+i);if(!t.prepareFrame(e))return null;const r=e.size[0],n=e.size[1];if(r===0||n===0)return null;const s=t.renderFrame(e,null);let o;if(s instanceof HTMLCanvasElement)o=s;else{if(s&&(o=s.firstElementChild),!(o instanceof HTMLCanvasElement))throw new Error("Unsupported rendered element: "+o);if(o.width===r&&o.height===n)return o.getContext("2d").getImageData(0,0,r,n)}if(!at)at=nt(r,n,void 0,{willReadFrequently:!0});else{const a=at.canvas;a.width!==r||a.height!==n?at=nt(r,n,void 0,{willReadFrequently:!0}):at.clearRect(0,0,r,n)}return at.drawImage(o,0,0,r,n),at.getImageData(0,0,r,n)}function ag(i){return i.map(function(e){return e.getLayerState()})}function lg(i){const e=i.length,t=new Array(e);for(let r=0;r<e;++r)t[r]=cg(i[r]);return t}function cg(i){let e;return i instanceof wi?i instanceof Si?e=new Ua({source:i}):i instanceof pt&&(e=new Ba({source:i})):e=i,e}const ug='&copy; <a href="https://www.stadiamaps.com/" target="_blank">Stadia Maps</a>',hg='&copy; <a href="https://openmaptiles.org/" target="_blank">OpenMapTiles</a>',dg='&copy; <a href="https://stamen.com/" target="_blank">Stamen Design</a>',fg={stamen_terrain:{extension:"png"},stamen_terrain_background:{extension:"png"},stamen_terrain_labels:{extension:"png"},stamen_terrain_lines:{extension:"png"},stamen_toner_background:{extension:"png"},stamen_toner:{extension:"png"},stamen_toner_labels:{extension:"png"},stamen_toner_lines:{extension:"png"},stamen_toner_lite:{extension:"png"},stamen_toner_dark:{extension:"png"},stamen_toner_blacklite:{extension:"png"},stamen_watercolor:{extension:"jpg"},alidade_smooth:{extension:"png"},alidade_smooth_dark:{extension:"png"},alidade_satellite:{extension:"png"},outdoors:{extension:"png"},osm_bright:{extension:"png"}},gg={stamen_terrain:{minZoom:0,maxZoom:18,retina:!0},stamen_toner:{minZoom:0,maxZoom:20,retina:!0},stamen_toner_dark:{minZoom:0,maxZoom:20,retina:!0},stamen_toner_blacklite:{minZoom:0,maxZoom:20,retina:!0},stamen_watercolor:{minZoom:1,maxZoom:18,retina:!1}};class pg extends fs{constructor(e){const t=e.layer.indexOf("-"),r=t==-1?e.layer:e.layer.slice(0,t),n=gg[r]||{minZoom:0,maxZoom:20,retina:!0},s=fg[e.layer],o=e.apiKey?"?api_key="+e.apiKey:"",a=n.retina&&e.retina?"@2x":"",l=e.url!==void 0?e.url:"https://tiles.stadiamaps.com/tiles/"+e.layer+"/{z}/{x}/{y}"+a+"."+s.extension+o,c=[ug,hg,za];e.layer.startsWith("stamen_")&&c.splice(1,0,dg),super({attributions:c,cacheSize:e.cacheSize,crossOrigin:"anonymous",interpolate:e.interpolate,maxZoom:e.maxZoom!==void 0?e.maxZoom:n.maxZoom,minZoom:e.minZoom!==void 0?e.minZoom:n.minZoom,reprojectionErrorThreshold:e.reprojectionErrorThreshold,tileLoadFunction:e.tileLoadFunction,transition:e.transition,url:l,tilePixelRatio:a?2:1,wrapX:e.wrapX,zDirection:e.zDirection})}}class mg extends Ye{constructor(e){e=e||{},super({attributions:e.attributions,cacheSize:e.cacheSize,crossOrigin:e.crossOrigin,interpolate:e.interpolate,projection:e.projection,reprojectionErrorThreshold:e.reprojectionErrorThreshold,tileGrid:e.tileGrid,tileLoadFunction:e.tileLoadFunction,url:e.url,urls:e.urls,wrapX:e.wrapX!==void 0?e.wrapX:!0,transition:e.transition,zDirection:e.zDirection}),this.params_=Object.assign({},e.params),this.hidpi_=e.hidpi!==void 0?e.hidpi:!0,this.tmpExtent_=Vt(),this.setKey(this.getKeyForParams_())}getKeyForParams_(){let e=0;const t=[];for(const r in this.params_)t[e++]=r+"-"+this.params_[r];return t.join("/")}getParams(){return this.params_}getRequestUrl_(e,t,r,n,s,o){const a=this.urls;if(!a)return;let l;if(a.length==1)l=a[0];else{const c=$a(Xa(e),a.length);l=a[c]}return co(l,r,(this.tileGrid||this.getTileGridForProjection(s)).getResolution(e[0]),n,s,o)}getTilePixelRatio(e){return this.hidpi_?e:1}setParams(e){this.params_=Object.assign({},e),this.setKey(this.getKeyForParams_())}updateParams(e){Object.assign(this.params_,e),this.setKey(this.getKeyForParams_())}tileUrlFunction(e,t,r){let n=this.getTileGrid();if(n||(n=this.getTileGridForProjection(r)),n.getResolutions().length<=e[0])return;t!=1&&!this.hidpi_&&(t=1);const s=n.getTileCoordExtent(e,this.tmpExtent_);let o=Ne(n.getTileSize(e[0]),this.tmpSize);t!=1&&(o=ka(o,t,this.tmpSize));const a={F:"image",FORMAT:"PNG32",TRANSPARENT:!0};return Object.assign(a,this.params_),this.getRequestUrl_(e,o,s,t,r,a)}}class _g extends ho{constructor(e){e=e||{};const t=e.template||"z:{z} x:{x} y:{y}",r=e.source,n=e.color||"grey";super({transition:0,wrapX:e.wrapX!==void 0?e.wrapX:r!==void 0?r.getWrapX():void 0});const s=()=>{var a;this.projection=e.projection!==void 0?Q(e.projection):r!==void 0?r.getProjection():this.projection,this.tileGrid=e.tileGrid!==void 0?e.tileGrid:r!==void 0?r.getTileGrid():this.tileGrid,this.zDirection=e.zDirection!==void 0?e.zDirection:r!==void 0?r.zDirection:this.zDirection,r instanceof Ur&&(this.transformMatrix=((a=r.transformMatrix)==null?void 0:a.slice())||null);const o=this.tileGrid;o&&this.setTileSizes(o.getResolutions().map((l,c)=>Ne(o.getTileSize(c)).map(u=>Math.max(Math.floor(u),1)))),this.setLoader((l,c,u,h)=>{const f=ms(t,l,c,u,h.maxY),[g,d]=this.getTileSize(l),m=nt(g,d);return m.strokeStyle=n,m.strokeRect(.5,.5,g+.5,d+.5),m.fillStyle=n,m.strokeStyle="white",m.textAlign="center",m.textBaseline="middle",m.font="24px sans-serif",m.lineWidth=4,m.strokeText(f,g/2,d/2,g),m.fillText(f,g/2,d/2,g),Promise.resolve(m.canvas)}),this.setState("ready")};if(r===void 0||r.getState()==="ready")s();else{const o=()=>{r.getState()==="ready"&&(r.removeEventListener(xe.CHANGE,o),s())};r.addEventListener(xe.CHANGE,o)}}}class Eg extends Ye{constructor(e){if(super({attributions:e.attributions,cacheSize:e.cacheSize,crossOrigin:e.crossOrigin,interpolate:e.interpolate,projection:Q("EPSG:3857"),reprojectionErrorThreshold:e.reprojectionErrorThreshold,state:"loading",tileLoadFunction:e.tileLoadFunction,wrapX:e.wrapX!==void 0?e.wrapX:!0,transition:e.transition,zDirection:e.zDirection}),this.tileJSON_=null,this.tileSize_=e.tileSize,e.url)if(e.jsonp)Yi(e.url,this.handleTileJSONResponse.bind(this),this.handleTileJSONError.bind(this));else{const t=new XMLHttpRequest;t.addEventListener("load",this.onXHRLoad_.bind(this)),t.addEventListener("error",this.onXHRError_.bind(this)),t.open("GET",e.url),t.send()}else if(e.tileJSON)this.handleTileJSONResponse(e.tileJSON);else throw new Error("Either `url` or `tileJSON` options must be provided")}onXHRLoad_(e){const t=e.target;if(!t.status||t.status>=200&&t.status<300){let r;try{r=JSON.parse(t.responseText)}catch{this.handleTileJSONError();return}this.handleTileJSONResponse(r)}else this.handleTileJSONError()}onXHRError_(e){this.handleTileJSONError()}getTileJSON(){return this.tileJSON_}handleTileJSONResponse(e){const t=Q("EPSG:4326"),r=this.getProjection();let n;if(e.bounds!==void 0){const c=Ri(t,r);n=Lt(e.bounds,c)}const s=Yt(r),o=e.minzoom||0,a=e.maxzoom||22,l=qt({extent:s,maxZoom:a,minZoom:o,tileSize:this.tileSize_});if(this.tileGrid=l,this.tileUrlFunction=_s(e.tiles,l),e.attribution&&!this.getAttributions()){const c=n!==void 0?n:s;this.setAttributions(function(u){return wt(c,u.extent)?[e.attribution]:null})}this.tileJSON_=e,this.setState("ready")}handleTileJSONError(){this.setState("error")}}class yg extends Za{constructor(e,t,r,n,s,o){super(e,t),this.src_=r,this.extent_=n,this.preemptive_=s,this.grid_=null,this.keys_=null,this.data_=null,this.jsonp_=o}getImage(){return null}getData(e){if(!this.grid_||!this.keys_)return null;const t=(e[0]-this.extent_[0])/(this.extent_[2]-this.extent_[0]),r=(e[1]-this.extent_[1])/(this.extent_[3]-this.extent_[1]),n=this.grid_[Math.floor((1-r)*this.grid_.length)];if(typeof n!="string")return null;let s=n.charCodeAt(Math.floor(t*n.length));s>=93&&s--,s>=35&&s--,s-=32;let o=null;if(s in this.keys_){const a=this.keys_[s];this.data_&&a in this.data_?o=this.data_[a]:o=a}return o}forDataAtCoordinate(e,t,r){this.state==V.EMPTY&&r===!0?(this.state=V.IDLE,Ha(this,xe.CHANGE,n=>{t(this.getData(e))}),this.loadInternal_()):r===!0?setTimeout(()=>{t(this.getData(e))},0):t(this.getData(e))}getKey(){return this.src_}handleError_(){this.state=V.ERROR,this.changed()}handleLoad_(e){this.grid_=e.grid,this.keys_=e.keys,this.data_=e.data,this.state=V.LOADED,this.changed()}loadInternal_(){if(this.state==V.IDLE)if(this.state=V.LOADING,this.jsonp_)Yi(this.src_,this.handleLoad_.bind(this),this.handleError_.bind(this));else{const e=new XMLHttpRequest;e.addEventListener("load",this.onXHRLoad_.bind(this)),e.addEventListener("error",this.onXHRError_.bind(this)),e.open("GET",this.src_),e.send()}}onXHRLoad_(e){const t=e.target;if(!t.status||t.status>=200&&t.status<300){let r;try{r=JSON.parse(t.responseText)}catch{this.handleError_();return}this.handleLoad_(r)}else this.handleError_()}onXHRError_(e){this.handleError_()}load(){this.preemptive_?this.loadInternal_():this.setState(V.EMPTY)}}class Tg extends Si{constructor(e){if(super({projection:Q("EPSG:3857"),state:"loading",wrapX:e.wrapX!==void 0?e.wrapX:!0,zDirection:e.zDirection}),this.preemptive_=e.preemptive!==void 0?e.preemptive:!0,this.tileUrlFunction_=ja,this.template_=void 0,this.jsonp_=e.jsonp||!1,this.tileCache_=new ls(512),e.url)if(this.jsonp_)Yi(e.url,this.handleTileJSONResponse.bind(this),this.handleTileJSONError.bind(this));else{const t=new XMLHttpRequest;t.addEventListener("load",this.onXHRLoad_.bind(this)),t.addEventListener("error",this.onXHRError_.bind(this)),t.open("GET",e.url),t.send()}else if(e.tileJSON)this.handleTileJSONResponse(e.tileJSON);else throw new Error("Either `url` or `tileJSON` options must be provided")}onXHRLoad_(e){const t=e.target;if(!t.status||t.status>=200&&t.status<300){let r;try{r=JSON.parse(t.responseText)}catch{this.handleTileJSONError();return}this.handleTileJSONResponse(r)}else this.handleTileJSONError()}onXHRError_(e){this.handleTileJSONError()}getTemplate(){return this.template_}forDataAtCoordinateAndResolution(e,t,r,n){if(this.tileGrid){const s=this.tileGrid.getZForResolution(t,this.zDirection),o=this.tileGrid.getTileCoordForCoordAndZ(e,s),a=this.getTile(o[0],o[1],o[2],1,this.getProjection());a.getState()==V.IDLE&&a.load(),a.forDataAtCoordinate(e,r,n)}else n===!0?setTimeout(function(){r(null)},0):r(null)}handleTileJSONError(){this.setState("error")}handleTileJSONResponse(e){const t=Q("EPSG:4326"),r=this.getProjection();let n;if(e.bounds!==void 0){const u=Ri(t,r);n=Lt(e.bounds,u)}const s=Yt(r),o=e.minzoom||0,a=e.maxzoom||22,l=qt({extent:s,maxZoom:a,minZoom:o});this.tileGrid=l,this.template_=e.template;const c=e.grids;if(!c){this.setState("error");return}if(this.tileUrlFunction_=_s(c,l),e.attribution){const u=n!==void 0?n:s;this.setAttributions(function(h){return wt(u,h.extent)?[e.attribution]:null})}this.setState("ready")}getTile(e,t,r,n,s){const o=[e,t,r],a=this.getTileCoordForTileUrlFunction(o,s),l=this.tileUrlFunction_(a,n,s),c=`${this.getKey()},${Wa(e,t,r)}`;if(this.tileCache_.containsKey(c))return this.tileCache_.get(c);this.tileCache_.expireCache();const u=new yg(o,l!==void 0?V.IDLE:V.EMPTY,l!==void 0?l:"",this.tileGrid.getTileCoordExtent(o),this.preemptive_,this.jsonp_);return this.tileCache_.set(c,u),u}}class xg extends fi{constructor(e){e=e||{},super({attributions:e.attributions,wrapX:e.wrapX}),this.resolution=void 0,this.distance=e.distance!==void 0?e.distance:20,this.minDistance=e.minDistance||0,this.interpolationRatio=0,this.features=[],this.geometryFunction=e.geometryFunction||function(t){const r=t.getGeometry();return be(!r||r.getType()==="Point","The default `geometryFunction` can only handle `Point` or null geometries"),r},this.createCustomCluster_=e.createCluster,this.source=null,this.boundRefresh_=this.refresh.bind(this),this.updateDistance(this.distance,this.minDistance),this.setSource(e.source||null)}clear(e){this.features.length=0,super.clear(e)}getDistance(){return this.distance}getSource(){return this.source}loadFeatures(e,t,r){var n;(n=this.source)==null||n.loadFeatures(e,t,r),t!==this.resolution&&(this.resolution=t,this.refresh())}setDistance(e){this.updateDistance(e,this.minDistance)}setMinDistance(e){this.updateDistance(this.distance,e)}getMinDistance(){return this.minDistance}setSource(e){this.source&&this.source.removeEventListener(xe.CHANGE,this.boundRefresh_),this.source=e,e&&e.addEventListener(xe.CHANGE,this.boundRefresh_),this.refresh()}refresh(){this.clear(),this.cluster(),this.addFeatures(this.features)}updateDistance(e,t){const r=e===0?0:Math.min(t,e)/e,n=e!==this.distance||this.interpolationRatio!==r;this.distance=e,this.minDistance=t,this.interpolationRatio=r,n&&this.refresh()}cluster(){if(this.resolution===void 0||!this.source)return;const e=Vt(),t=this.distance*this.resolution,r=this.source.getFeatures(),n={};for(let s=0,o=r.length;s<o;s++){const a=r[s];if(!(J(a)in n)){const l=this.geometryFunction(a);if(l){const c=l.getCoordinates();Va(c,e),yi(e,t,e);const u=this.source.getFeaturesInExtent(e).filter(function(h){const f=J(h);return f in n?!1:(n[f]=!0,!0)});this.features.push(this.createCluster(u,e))}}}}createCluster(e,t){const r=[0,0];for(let a=e.length-1;a>=0;--a){const l=this.geometryFunction(e[a]);l?Ya(r,l.getCoordinates()):e.splice(a,1)}qa(r,1/e.length);const n=et(t),s=this.interpolationRatio,o=new Ie([r[0]*(1-s)+n[0]*s,r[1]*(1-s)+n[1]*s]);return this.createCustomCluster_?this.createCustomCluster_(o,e):new Re({geometry:o,features:e})}}class wr extends xg{constructor(e={}){super({...e,createCluster:wr.defaultCreateCluster,geometryFunction:wr.defaultGeometryFunction})}static defaultCreateCluster(e,t){const r=t.length===1&&t[0].getGeometry()instanceof ut?t[0].getGeometry():e,n=new Re({geometry:r,features:t});if(t.length===1){const s=t[0];for(const o in s.getProperties())o!=="geometry"&&n.set(o,s.get(o))}return n}static defaultGeometryFunction(e){const t=e&&e.getGeometry();return t instanceof Ie?t:t instanceof ut?t.getInteriorPoint():null}}class Rg extends Ye{constructor(e){super({attributions:e.attributions,cacheSize:e.cacheSize,tilePixelRatio:e.tilePixelRatio,transition:e.transition,interpolate:e.interpolate!==void 0?e.interpolate:!0,key:e.key,attributionsCollapsible:e.attributionsCollapsible,zDirection:e.zDirection,wrapX:e.wrapX}),this.version_=e.version!==void 0?e.version:"1.0.0",this.dimensions_=e.dimensions!==void 0?e.dimensions:{},this.layer_=e.layer,fetch(e.url).then(t=>t.text()).then(t=>new window.DOMParser().parseFromString(t,"application/xml")).then(t=>{this.handleCapabilitiesResponse(t,e)})}handleCapabilitiesResponse(e,t){const n=new Bs().read(e),s=Ka(n,t);this.crossOrigin=s.crossOrigin,this.projection=s.projection,this.tileGrid=s.tileGrid,this.requestEncoding_=s.requestEncoding,this.matrixSet_=s.matrixSet,this.style_=s.style,this.format_=s.format,this.dimensions_=s.dimensions,this.setUrls(s.urls),this.urls&&this.urls.length>0&&(this.tileUrlFunction=xi(this.urls.map(this.createFromWMTSTemplate.bind(this)))),this.getState()!=="ready"&&this.setState("ready")}createFromWMTSTemplate(e){const t=this.requestEncoding_,r={layer:this.layer_,style:this.style_,tilematrixset:this.matrixSet_};t==="KVP"&&Object.assign(r,{Service:"WMTS",Request:"GetTile",Version:this.version_,Format:this.format_}),e=t==="KVP"?Er(e,r):e.replace(/\{(\w+?)\}/g,(o,a)=>a.toLowerCase()in r?r[a.toLowerCase()]:o);const n=this.tileGrid,s=this.dimensions_;return function(o){if(!o)return;const a={TileMatrix:n.getMatrixId(o[0]),TileCol:o[1],TileRow:o[2]};Object.assign(a,s);let l=e;return t==="KVP"?l=Er(l,a):l=l.replace(/\{(\w+?)\}/g,(c,u)=>a[u]),l}}}class Sg extends fi{constructor(e){super({attributions:e.attributions,wrapX:e.wrapX,strategy:Ja}),this.dataProjection=e.projection||Qa.dataProjection,this.resourceURL=e.url,super.setLoader(this.loader)}fgbBoundingBox(e,t){const r=el(e,t.getCode(),this.dataProjection);return{minX:r[0],minY:r[1],maxX:r[2],maxY:r[3]}}async loader(e,t,r,n,s){const o=this.fgbBoundingBox(e,r);try{if(o.minX!==-1/0){const a=[],l=ul(this.resourceURL,o),c=new tl({featureProjection:r,dataProjection:this.dataProjection});for await(const u of l){const h=c.readFeature(u);a.push(h)}super.clear(),super.addFeatures(a),n(a)}}catch{s()}}}window.eoxMapAdvancedOlSources={BingMaps:cf,CartoDB:uf,Cluster:wr,DataTile:Ur,GeoTIFF:ao,Google:Mf,IIIF:Df,Image:pt,ImageArcGISRest:Uf,ImageCanvas:Bf,ImageMapGuide:kf,ImageStatic:Wf,ImageTile:ho,OGCMapTile:tg,OGCVectorTile:rg,Raster:Eo,Source:wi,StadiaMaps:pg,TileArcGISRest:mg,TileDebug:_g,TileImage:Ye,TileJSON:Eg,UrlTile:rl,UTFGrid:Tg,Zoomify:Of,WMTSCapabilities:Rg,FlatGeoBuf:Sg};

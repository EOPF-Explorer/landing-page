import{E as yt,G as he,H as et,T as F,J as tt,i as q,R as Ct,K as Ce,L as xe,N as me,O as rt,Q as vt,U as J,Y as de,Z as Pt,_ as Ne,$ as Ut,a0 as ee,a1 as It,a2 as Ge,a3 as Dt,a4 as Ft,a5 as it,a6 as Nt,a7 as Gt,a8 as Ot,a9 as Z,aa as Ae,ab as Mt,ac as nt,ad as Bt,ae as wt,af as Xt,ag as L,ah as st,ai as Oe,aj as $t,ak as Ht,e as ot,al as jt,W as zt,am as Wt,an as Yt,ao as Vt,ap as Kt,aq as Zt,ar as kt,as as qt,at as Te,au as Jt,av as Qt,aw as er,ax as _e}from"./XYZ.DtVLERao.js";import{o as at,a2 as H,_ as tr,n as rr,l as ir,E as re,C as ct,a0 as be,S as nr,al as sr,am as or,g as k,aa as Me,d as ar,ab as cr,p as le,H as Ee,z as lr,k as Be,ad as we,m as ur,u as Xe,b as $e,af as hr,X as fr}from"./Group.BnugPW7_.js";function ie(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}function lt(r,e){return r[0]=e[0],r[1]=e[1],r[4]=e[2],r[5]=e[3],r[12]=e[4],r[13]=e[5],r}function Le(r,e,t,i,n,s,o){o=o??ie();const a=1/(r-e),h=1/(t-i),l=1/(n-s);return o[0]=-2*a,o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[5]=-2*h,o[6]=0,o[7]=0,o[8]=0,o[9]=0,o[10]=2*l,o[11]=0,o[12]=(r+e)*a,o[13]=(i+t)*h,o[14]=(s+n)*l,o[15]=1,o}function He(r,e,t,i,n){return n=n??ie(),n[0]=r[0]*e,n[1]=r[1]*e,n[2]=r[2]*e,n[3]=r[3]*e,n[4]=r[4]*t,n[5]=r[5]*t,n[6]=r[6]*t,n[7]=r[7]*t,n[8]=r[8]*i,n[9]=r[9]*i,n[10]=r[10]*i,n[11]=r[11]*i,n[12]=r[12],n[13]=r[13],n[14]=r[14],n[15]=r[15],n}function dr(r,e,t,i,n){n=n??ie();let s,o,a,h,l,f,u,T,d,c,p,A;return r===n?(n[12]=r[0]*e+r[4]*t+r[8]*i+r[12],n[13]=r[1]*e+r[5]*t+r[9]*i+r[13],n[14]=r[2]*e+r[6]*t+r[10]*i+r[14],n[15]=r[3]*e+r[7]*t+r[11]*i+r[15]):(s=r[0],o=r[1],a=r[2],h=r[3],l=r[4],f=r[5],u=r[6],T=r[7],d=r[8],c=r[9],p=r[10],A=r[11],n[0]=s,n[1]=o,n[2]=a,n[3]=h,n[4]=l,n[5]=f,n[6]=u,n[7]=T,n[8]=d,n[9]=c,n[10]=p,n[11]=A,n[12]=s*e+l*t+d*i+r[12],n[13]=o*e+f*t+c*i+r[13],n[14]=a*e+u*t+p*i+r[14],n[15]=h*e+T*t+A*i+r[15]),n}function Tr(r,e,t,i){return i=i??ie(),i[0]=1,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=1,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=r,i[13]=e,i[14]=t,i[15]=1,i}const ve=34962,Pe=34963,Ue=35044,_r=5121,Er=5123,Rr=5125,ut=5126,je=["experimental-webgl","webgl","webkit-3d","moz-webgl"];function gr(r,e){e=Object.assign({preserveDrawingBuffer:!0,antialias:!yt},e);const t=je.length;for(let i=0;i<t;++i)try{const n=r.getContext(je[i],e);if(n)return n}catch{}return null}const pr={STATIC_DRAW:Ue};class ht{constructor(e,t){this.array_=null,this.type_=e,at(e===ve||e===Pe,"A `WebGLArrayBuffer` must either be of type `ELEMENT_ARRAY_BUFFER` or `ARRAY_BUFFER`"),this.usage_=t!==void 0?t:pr.STATIC_DRAW}ofSize(e){return this.array_=new(ae(this.type_))(e),this}fromArray(e){return this.array_=ae(this.type_).from(e),this}fromArrayBuffer(e){return this.array_=new(ae(this.type_))(e),this}getType(){return this.type_}getArray(){return this.array_}setArray(e){const t=ae(this.type_);if(!(e instanceof t))throw new Error(`Expected ${t}`);this.array_=e}getUsage(){return this.usage_}getSize(){return this.array_?this.array_.length:0}}function ae(r){switch(r){case ve:return Float32Array;case Pe:return Uint32Array;default:return Float32Array}}const ce={LOST:"webglcontextlost",RESTORED:"webglcontextrestored"},xr=`
  precision mediump float;

  attribute vec2 a_position;
  varying vec2 v_texCoord;
  varying vec2 v_screenCoord;

  uniform vec2 u_screenSize;

  void main() {
    v_texCoord = a_position * 0.5 + 0.5;
    v_screenCoord = v_texCoord * u_screenSize;
    gl_Position = vec4(a_position, 0.0, 1.0);
  }
`,mr=`
  precision mediump float;

  uniform sampler2D u_image;
  uniform float u_opacity;

  varying vec2 v_texCoord;

  void main() {
    gl_FragColor = texture2D(u_image, v_texCoord) * u_opacity;
  }
`;class ze{constructor(e){this.gl_=e.webGlContext;const t=this.gl_;this.scaleRatio_=e.scaleRatio||1,this.renderTargetTexture_=t.createTexture(),this.renderTargetTextureSize_=null,this.frameBuffer_=t.createFramebuffer(),this.depthBuffer_=t.createRenderbuffer();const i=t.createShader(t.VERTEX_SHADER);t.shaderSource(i,e.vertexShader||xr),t.compileShader(i);const n=t.createShader(t.FRAGMENT_SHADER);t.shaderSource(n,e.fragmentShader||mr),t.compileShader(n),this.renderTargetProgram_=t.createProgram(),t.attachShader(this.renderTargetProgram_,i),t.attachShader(this.renderTargetProgram_,n),t.linkProgram(this.renderTargetProgram_),this.renderTargetVerticesBuffer_=t.createBuffer();const s=[-1,-1,1,-1,-1,1,1,-1,1,1,-1,1];t.bindBuffer(t.ARRAY_BUFFER,this.renderTargetVerticesBuffer_),t.bufferData(t.ARRAY_BUFFER,new Float32Array(s),t.STATIC_DRAW),this.renderTargetAttribLocation_=t.getAttribLocation(this.renderTargetProgram_,"a_position"),this.renderTargetUniformLocation_=t.getUniformLocation(this.renderTargetProgram_,"u_screenSize"),this.renderTargetOpacityLocation_=t.getUniformLocation(this.renderTargetProgram_,"u_opacity"),this.renderTargetTextureLocation_=t.getUniformLocation(this.renderTargetProgram_,"u_image"),this.uniforms_=[],e.uniforms&&Object.keys(e.uniforms).forEach(o=>{this.uniforms_.push({value:e.uniforms[o],location:t.getUniformLocation(this.renderTargetProgram_,o)})})}getRenderTargetTexture(){return this.renderTargetTexture_}getGL(){return this.gl_}init(e){const t=this.getGL(),i=[t.drawingBufferWidth*this.scaleRatio_,t.drawingBufferHeight*this.scaleRatio_];if(t.bindFramebuffer(t.FRAMEBUFFER,this.getFrameBuffer()),t.bindRenderbuffer(t.RENDERBUFFER,this.getDepthBuffer()),t.viewport(0,0,i[0],i[1]),!this.renderTargetTextureSize_||this.renderTargetTextureSize_[0]!==i[0]||this.renderTargetTextureSize_[1]!==i[1]){this.renderTargetTextureSize_=i;const n=0,s=t.RGBA,o=0,a=t.RGBA,h=t.UNSIGNED_BYTE,l=null;t.bindTexture(t.TEXTURE_2D,this.renderTargetTexture_),t.texImage2D(t.TEXTURE_2D,n,s,i[0],i[1],o,a,h,l),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.renderTargetTexture_,0),t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT16,i[0],i[1]),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,this.depthBuffer_)}}apply(e,t,i,n){const s=this.getGL(),o=e.size;if(s.bindFramebuffer(s.FRAMEBUFFER,t?t.getFrameBuffer():null),s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,this.renderTargetTexture_),!t){const h=H(s.canvas);if(!e.renderTargets[h]){const l=s.getContextAttributes();l&&l.preserveDrawingBuffer&&(s.clearColor(0,0,0,0),s.clearDepth(1),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT)),e.renderTargets[h]=!0}}s.disable(s.DEPTH_TEST),s.enable(s.BLEND),s.blendFunc(s.ONE,s.ONE_MINUS_SRC_ALPHA),s.viewport(0,0,s.drawingBufferWidth,s.drawingBufferHeight),s.bindBuffer(s.ARRAY_BUFFER,this.renderTargetVerticesBuffer_),s.useProgram(this.renderTargetProgram_),s.enableVertexAttribArray(this.renderTargetAttribLocation_),s.vertexAttribPointer(this.renderTargetAttribLocation_,2,s.FLOAT,!1,0,0),s.uniform2f(this.renderTargetUniformLocation_,o[0],o[1]),s.uniform1i(this.renderTargetTextureLocation_,0);const a=e.layerStatesArray[e.layerIndex].opacity;s.uniform1f(this.renderTargetOpacityLocation_,a),this.applyUniforms(e),i&&i(s,e),s.drawArrays(s.TRIANGLES,0,6),n&&n(s,e)}getFrameBuffer(){return this.frameBuffer_}getDepthBuffer(){return this.depthBuffer_}applyUniforms(e){const t=this.getGL();let i,n=1;this.uniforms_.forEach(function(s){if(i=typeof s.value=="function"?s.value(e):s.value,i instanceof HTMLCanvasElement||i instanceof ImageData)s.texture||(s.texture=t.createTexture()),t.activeTexture(t[`TEXTURE${n}`]),t.bindTexture(t.TEXTURE_2D,s.texture),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),i instanceof ImageData?t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,i.width,i.height,0,t.UNSIGNED_BYTE,new Uint8Array(i.data)):t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,i),t.uniform1i(s.location,n++);else if(Array.isArray(i))switch(i.length){case 2:t.uniform2f(s.location,i[0],i[1]);return;case 3:t.uniform3f(s.location,i[0],i[1],i[2]);return;case 4:t.uniform4f(s.location,i[0],i[1],i[2],i[3]);return;default:return}else typeof i=="number"&&t.uniform1f(s.location,i)})}}const V={TIME:"u_time",ZOOM:"u_zoom",RESOLUTION:"u_resolution",ROTATION:"u_rotation",VIEWPORT_SIZE_PX:"u_viewportSizePx",PIXEL_RATIO:"u_pixelRatio",HIT_DETECTION:"u_hitDetection"},ne={UNSIGNED_BYTE:_r,UNSIGNED_SHORT:Er,UNSIGNED_INT:Rr,FLOAT:ut},fe={};function We(r){return"shared/"+r}let Ye=0;function Ar(){const r="unique/"+Ye;return Ye+=1,r}function br(r){let e=fe[r];if(!e){const t=document.createElement("canvas");t.width=1,t.height=1,t.style.position="absolute",t.style.left="0",e={users:0,context:gr(t)},fe[r]=e}return e.users+=1,e.context}function Lr(r){const e=fe[r];if(!e||(e.users-=1,e.users>0))return;const t=e.context,i=t.getExtension("WEBGL_lose_context");i&&i.loseContext();const n=t.canvas;n.width=1,n.height=1,delete fe[r]}class Sr extends tr{constructor(e){super(),e=e||{},this.boundHandleWebGLContextLost_=this.handleWebGLContextLost.bind(this),this.boundHandleWebGLContextRestored_=this.handleWebGLContextRestored.bind(this),this.canvasCacheKey_=e.canvasCacheKey?We(e.canvasCacheKey):Ar(),this.gl_=br(this.canvasCacheKey_),this.bufferCache_={},this.extensionCache_={},this.currentProgram_=null,this.needsToBeRecreated_=!1;const t=this.gl_.canvas;t.addEventListener(ce.LOST,this.boundHandleWebGLContextLost_),t.addEventListener(ce.RESTORED,this.boundHandleWebGLContextRestored_),this.offsetRotateMatrix_=he(),this.offsetScaleMatrix_=he(),this.tmpMat4_=ie(),this.uniformLocationsByProgram_={},this.attribLocationsByProgram_={},this.uniforms_=[],e.uniforms&&this.setUniforms(e.uniforms),this.postProcessPasses_=e.postProcesses?e.postProcesses.map(i=>new ze({webGlContext:this.gl_,scaleRatio:i.scaleRatio,vertexShader:i.vertexShader,fragmentShader:i.fragmentShader,uniforms:i.uniforms})):[new ze({webGlContext:this.gl_})],this.shaderCompileErrors_=null,this.startTime_=Date.now(),this.maxAttributeCount_=this.gl_.getParameter(this.gl_.MAX_VERTEX_ATTRIBS)}setUniforms(e){this.uniforms_=[],this.addUniforms(e)}addUniforms(e){for(const t in e)this.uniforms_.push({name:t,value:e[t]})}canvasCacheKeyMatches(e){return this.canvasCacheKey_===We(e)}getExtension(e){if(e in this.extensionCache_)return this.extensionCache_[e];const t=this.gl_.getExtension(e);return this.extensionCache_[e]=t,t}getInstancedRenderingExtension_(){const e=this.getExtension("ANGLE_instanced_arrays");return at(!!e,"WebGL extension 'ANGLE_instanced_arrays' is required for vector rendering"),e}bindBuffer(e){const t=this.gl_,i=H(e);let n=this.bufferCache_[i];if(!n){const s=t.createBuffer();n={buffer:e,webGlBuffer:s},this.bufferCache_[i]=n}t.bindBuffer(e.getType(),n.webGlBuffer)}flushBufferData(e){const t=this.gl_;this.bindBuffer(e),t.bufferData(e.getType(),e.getArray(),e.getUsage())}deleteBuffer(e){const t=H(e);delete this.bufferCache_[t]}disposeInternal(){const e=this.gl_.canvas;e.removeEventListener(ce.LOST,this.boundHandleWebGLContextLost_),e.removeEventListener(ce.RESTORED,this.boundHandleWebGLContextRestored_),Lr(this.canvasCacheKey_),delete this.gl_}prepareDraw(e,t,i){const n=this.gl_,s=this.getCanvas(),o=e.size,a=e.pixelRatio;(s.width!==o[0]*a||s.height!==o[1]*a)&&(s.width=o[0]*a,s.height=o[1]*a,s.style.width=o[0]+"px",s.style.height=o[1]+"px");for(let h=this.postProcessPasses_.length-1;h>=0;h--)this.postProcessPasses_[h].init(e);n.bindTexture(n.TEXTURE_2D,null),n.clearColor(0,0,0,0),n.depthRange(0,1),n.clearDepth(1),n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT),n.enable(n.BLEND),n.blendFunc(n.ONE,t?n.ZERO:n.ONE_MINUS_SRC_ALPHA),i?(n.enable(n.DEPTH_TEST),n.depthFunc(n.LEQUAL)):n.disable(n.DEPTH_TEST)}bindFrameBuffer(e,t){const i=this.getGL();i.bindFramebuffer(i.FRAMEBUFFER,e),t&&i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,t,0)}bindInitialFrameBuffer(){const e=this.getGL(),t=this.postProcessPasses_[0].getFrameBuffer();e.bindFramebuffer(e.FRAMEBUFFER,t);const i=this.postProcessPasses_[0].getRenderTargetTexture();e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,i,0)}bindTexture(e,t,i){const n=this.gl_;n.activeTexture(n.TEXTURE0+t),n.bindTexture(n.TEXTURE_2D,e),n.uniform1i(this.getUniformLocation(i),t)}bindAttribute(e,t,i){const n=this.getGL();this.bindBuffer(e);const s=this.getAttributeLocation(t);n.enableVertexAttribArray(s),n.vertexAttribPointer(s,i,n.FLOAT,!1,0,0)}prepareDrawToRenderTarget(e,t,i,n){const s=this.gl_,o=t.getSize();s.bindFramebuffer(s.FRAMEBUFFER,t.getFramebuffer()),s.bindRenderbuffer(s.RENDERBUFFER,t.getDepthbuffer()),s.viewport(0,0,o[0],o[1]),s.bindTexture(s.TEXTURE_2D,t.getTexture()),s.clearColor(0,0,0,0),s.depthRange(0,1),s.clearDepth(1),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT),s.enable(s.BLEND),s.blendFunc(s.ONE,i?s.ZERO:s.ONE_MINUS_SRC_ALPHA),n?(s.enable(s.DEPTH_TEST),s.depthFunc(s.LEQUAL)):s.disable(s.DEPTH_TEST)}drawElements(e,t){const i=this.gl_;this.getExtension("OES_element_index_uint");const n=i.UNSIGNED_INT,s=4,o=t-e,a=e*s;i.drawElements(i.TRIANGLES,o,n,a)}drawElementsInstanced(e,t,i){const n=this.gl_;this.getExtension("OES_element_index_uint");const s=this.getInstancedRenderingExtension_(),o=n.UNSIGNED_INT,a=4,h=t-e,l=e*a;s.drawElementsInstancedANGLE(n.TRIANGLES,h,o,l,i);for(let f=0;f<this.maxAttributeCount_;f++)s.vertexAttribDivisorANGLE(f,0)}finalizeDraw(e,t,i){for(let n=0,s=this.postProcessPasses_.length;n<s;n++)n===s-1?this.postProcessPasses_[n].apply(e,null,t,i):this.postProcessPasses_[n].apply(e,this.postProcessPasses_[n+1])}getCanvas(){return this.gl_.canvas}getGL(){return this.gl_}applyFrameState(e){const t=e.size,i=e.viewState.rotation,n=e.pixelRatio;this.setUniformFloatValue(V.TIME,(Date.now()-this.startTime_)*.001),this.setUniformFloatValue(V.ZOOM,e.viewState.zoom),this.setUniformFloatValue(V.RESOLUTION,e.viewState.resolution),this.setUniformFloatValue(V.PIXEL_RATIO,n),this.setUniformFloatVec2(V.VIEWPORT_SIZE_PX,[t[0],t[1]]),this.setUniformFloatValue(V.ROTATION,i)}applyHitDetectionUniform(e){const t=this.getUniformLocation(V.HIT_DETECTION);this.getGL().uniform1i(t,e?1:0),e&&this.setUniformFloatValue(V.PIXEL_RATIO,.5)}applyUniforms(e){const t=this.gl_;let i,n=0;this.uniforms_.forEach(s=>{if(i=typeof s.value=="function"?s.value(e):s.value,i instanceof HTMLCanvasElement||i instanceof HTMLImageElement||i instanceof ImageData||i instanceof WebGLTexture){i instanceof WebGLTexture&&!s.texture?(s.prevValue=void 0,s.texture=i):s.texture||(s.prevValue=void 0,s.texture=t.createTexture()),this.bindTexture(s.texture,n,s.name),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE);const o=!(i instanceof HTMLImageElement)||i.complete;!(i instanceof WebGLTexture)&&o&&s.prevValue!==i&&(s.prevValue=i,t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,i)),n++}else if(Array.isArray(i)&&i.length===6)this.setUniformMatrixValue(s.name,lt(this.tmpMat4_,i));else if(Array.isArray(i)&&i.length<=4)switch(i.length){case 2:t.uniform2f(this.getUniformLocation(s.name),i[0],i[1]);return;case 3:t.uniform3f(this.getUniformLocation(s.name),i[0],i[1],i[2]);return;case 4:t.uniform4f(this.getUniformLocation(s.name),i[0],i[1],i[2],i[3]);return;default:return}else typeof i=="number"&&t.uniform1f(this.getUniformLocation(s.name),i)})}useProgram(e,t){this.disableAllAttributes_(),this.gl_.useProgram(e),this.currentProgram_=e,t&&(this.applyFrameState(t),this.applyUniforms(t))}compileShader(e,t){const i=this.gl_,n=i.createShader(t);return i.shaderSource(n,e),i.compileShader(n),n}getProgram(e,t){const i=this.gl_,n=this.compileShader(e,i.FRAGMENT_SHADER),s=this.compileShader(t,i.VERTEX_SHADER),o=i.createProgram();if(i.attachShader(o,n),i.attachShader(o,s),i.linkProgram(o),!i.getShaderParameter(n,i.COMPILE_STATUS)){const a=`Fragment shader compilation failed: ${i.getShaderInfoLog(n)}`;throw new Error(a)}if(i.deleteShader(n),!i.getShaderParameter(s,i.COMPILE_STATUS)){const a=`Vertex shader compilation failed: ${i.getShaderInfoLog(s)}`;throw new Error(a)}if(i.deleteShader(s),!i.getProgramParameter(o,i.LINK_STATUS)){const a=`GL program linking failed: ${i.getProgramInfoLog(o)}`;throw new Error(a)}return o}getUniformLocation(e){const t=H(this.currentProgram_);return this.uniformLocationsByProgram_[t]===void 0&&(this.uniformLocationsByProgram_[t]={}),this.uniformLocationsByProgram_[t][e]===void 0&&(this.uniformLocationsByProgram_[t][e]=this.gl_.getUniformLocation(this.currentProgram_,e)),this.uniformLocationsByProgram_[t][e]}getAttributeLocation(e){const t=H(this.currentProgram_);return this.attribLocationsByProgram_[t]===void 0&&(this.attribLocationsByProgram_[t]={}),this.attribLocationsByProgram_[t][e]===void 0&&(this.attribLocationsByProgram_[t][e]=this.gl_.getAttribLocation(this.currentProgram_,e)),this.attribLocationsByProgram_[t][e]}makeProjectionTransform(e,t){const i=e.size,n=e.viewState.rotation,s=e.viewState.resolution,o=e.viewState.center;return et(t,0,0,2/(s*i[0]),2/(s*i[1]),-n,-o[0],-o[1]),t}setUniformFloatValue(e,t){this.gl_.uniform1f(this.getUniformLocation(e),t)}setUniformFloatVec2(e,t){this.gl_.uniform2fv(this.getUniformLocation(e),t)}setUniformFloatVec4(e,t){this.gl_.uniform4fv(this.getUniformLocation(e),t)}setUniformMatrixValue(e,t){this.gl_.uniformMatrix4fv(this.getUniformLocation(e),!1,t)}disableAllAttributes_(){for(let e=0;e<this.maxAttributeCount_;e++)this.gl_.disableVertexAttribArray(e)}enableAttributeArray_(e,t,i,n,s,o){const a=this.getAttributeLocation(e);a<0||(this.gl_.enableVertexAttribArray(a),this.gl_.vertexAttribPointer(a,t,i,!1,n,s),o&&this.getInstancedRenderingExtension_().vertexAttribDivisorANGLE(a,1))}enableAttributes_(e,t){const i=yr(e);let n=0;for(let s=0;s<e.length;s++){const o=e[s];o.name&&this.enableAttributeArray_(o.name,o.size,o.type||ut,i,n,t),n+=o.size*ft(o.type)}}enableAttributes(e){this.enableAttributes_(e,!1)}enableAttributesInstanced(e){this.enableAttributes_(e,!0)}handleWebGLContextLost(e){rr(this.bufferCache_),this.currentProgram_=null,e.preventDefault()}handleWebGLContextRestored(){this.needsToBeRecreated_=!0}needsToBeRecreated(){return this.needsToBeRecreated_}createTexture(e,t,i,n){const s=this.gl_;i=i||s.createTexture();const o=n?s.NEAREST:s.LINEAR;s.bindTexture(s.TEXTURE_2D,i),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,o),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,o),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE);const a=0,h=s.RGBA,l=0,f=s.RGBA,u=s.UNSIGNED_BYTE;return t instanceof Uint8Array?s.texImage2D(s.TEXTURE_2D,a,h,e[0],e[1],l,f,u,t):t?s.texImage2D(s.TEXTURE_2D,a,h,f,u,t):s.texImage2D(s.TEXTURE_2D,a,h,e[0],e[1],l,f,u,null),i}}function yr(r){let e=0;for(let t=0;t<r.length;t++){const i=r[t];e+=i.size*ft(i.type)}return e}function ft(r){switch(r){case ne.UNSIGNED_BYTE:return Uint8Array.BYTES_PER_ELEMENT;case ne.UNSIGNED_SHORT:return Uint16Array.BYTES_PER_ELEMENT;case ne.UNSIGNED_INT:return Uint32Array.BYTES_PER_ELEMENT;case ne.FLOAT:default:return Float32Array.BYTES_PER_ELEMENT}}class Cr extends ir{constructor(e){super(),this.tile,this.handleTileChange_=this.handleTileChange_.bind(this),this.gutter=e.gutter||0,this.helper=e.helper,this.loaded=!1,this.ready=!1}setTile(e){if(e!==this.tile)if(this.tile&&this.tile.removeEventListener(re.CHANGE,this.handleTileChange_),this.tile=e,this.loaded=e.getState()===F.LOADED,this.loaded)this.uploadTile();else{if(e instanceof tt){const t=e.getImage();t instanceof Image&&!t.crossOrigin&&(t.crossOrigin="anonymous")}e.addEventListener(re.CHANGE,this.handleTileChange_)}}uploadTile(){ct()}setReady(){this.ready=!0,this.dispatchEvent(re.CHANGE)}handleTileChange_(){this.tile.getState()===F.LOADED&&(this.loaded=!0,this.uploadTile())}setHelper(e){this.helper=e,this.helper&&this.loaded&&this.uploadTile()}disposeInternal(){this.setHelper(null),this.tile.removeEventListener(re.CHANGE,this.handleTileChange_)}}function dt(r,e,t){const i=t?r.LINEAR:r.NEAREST;r.bindTexture(r.TEXTURE_2D,e),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,i),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,i)}function vr(r,e,t,i){dt(r,e,i),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,r.RGBA,r.UNSIGNED_BYTE,t)}function Ve(r,e,t,i,n,s){const o=r.getGL();let a,h;t instanceof Float32Array?(a=o.FLOAT,r.getExtension("OES_texture_float"),h=r.getExtension("OES_texture_float_linear")!==null):(a=o.UNSIGNED_BYTE,h=!0),dt(o,e,s&&h);const l=t.byteLength/i[1];let f=1;l%8===0?f=8:l%4===0?f=4:l%2===0&&(f=2);let u;switch(n){case 1:{u=o.LUMINANCE;break}case 2:{u=o.LUMINANCE_ALPHA;break}case 3:{u=o.RGB;break}case 4:{u=o.RGBA;break}default:throw new Error(`Unsupported number of bands: ${n}`)}const T=o.getParameter(o.UNPACK_ALIGNMENT);o.pixelStorei(o.UNPACK_ALIGNMENT,f),o.texImage2D(o.TEXTURE_2D,0,u,i[0],i[1],0,u,a,t),o.pixelStorei(o.UNPACK_ALIGNMENT,T)}let te=null;function Pr(){te=rt(1,1,void 0,{willReadFrequently:!0})}class Ur extends Cr{constructor(e){super(e),this.textures=[],this.renderSize_=q(e.grid.getTileSize(e.tile.tileCoord[0])),this.bandCount=NaN;const t=new ht(ve,Ue);t.fromArray([0,1,1,1,1,0,0,0]),this.helper.flushBufferData(t),this.coords=t,this.setTile(e.tile)}setHelper(e){var i;const t=(i=this.helper)==null?void 0:i.getGL();if(t){this.helper.deleteBuffer(this.coords);for(let n=0;n<this.textures.length;++n)t.deleteTexture(this.textures[n])}super.setHelper(e),e&&e.flushBufferData(this.coords)}uploadTile(){const e=this.helper,t=e.getGL(),i=this.tile;this.textures.length=0;let n;i instanceof tt||i instanceof Ct?n=i.getImage():n=i.getData();const s=me(n);if(s){const E=t.createTexture();this.textures.push(E),this.bandCount=4,vr(t,E,s,i.interpolate),this.setReady();return}n=xe(n);const o=i.getSize(),a=[o[0]+2*this.gutter,o[1]+2*this.gutter],h=n instanceof Float32Array,l=a[0]*a[1],f=h?Float32Array:Uint8Array,u=f.BYTES_PER_ELEMENT,T=n.byteLength/a[1];this.bandCount=Math.floor(T/u/a[0]);const d=Math.ceil(this.bandCount/4);if(d===1){const E=t.createTexture();this.textures.push(E),Ve(e,E,n,a,this.bandCount,i.interpolate),this.setReady();return}const c=new Array(d);for(let E=0;E<d;++E){const R=t.createTexture();this.textures.push(R);const g=E<d-1?4:(this.bandCount-1)%4+1;c[E]=new f(l*g)}let p=0,A=0;const S=a[0]*this.bandCount;for(let E=0;E<a[1];++E){for(let R=0;R<S;++R){const g=n[A+R],_=Math.floor(p/this.bandCount),x=R%this.bandCount,y=Math.floor(x/4),P=c[y],U=P.length/l,m=x%4;P[_*U+m]=g,++p}A+=T/u}for(let E=0;E<d;++E){const R=this.textures[E],g=c[E],_=g.length/l;Ve(e,R,g,a,_,i.interpolate)}this.setReady()}getImagePixelData_(e,t,i){const n=this.gutter,s=this.renderSize_[0],o=this.renderSize_[1];te||Pr(),te.clearRect(0,0,1,1);const a=e.width,h=e.height,l=a-2*n,f=h-2*n,u=n+Math.floor(l*(t/s)),T=n+Math.floor(f*(i/o));let d;try{te.drawImage(e,u,T,1,1,0,0,1,1),d=te.getImageData(0,0,1,1).data}catch{return te=null,null}return d}getArrayPixelData_(e,t,i,n){const s=this.gutter,o=this.renderSize_[0],a=this.renderSize_[1],h=t[0],l=t[1],f=h+2*s,u=l+2*s,T=s+Math.floor(h*(i/o)),d=s+Math.floor(l*(n/a));if(e instanceof DataView){const p=e.byteLength/(f*u),A=p*(d*f+T),S=e.buffer.slice(A,A+p);return new DataView(S)}const c=this.bandCount*(d*f+T);return e.slice(c,c+this.bandCount)}getPixelData(e,t){if(!this.loaded)return null;if(this.tile instanceof Ce){const i=this.tile.getData(),n=xe(i);if(n){const s=this.tile.getSize();return this.getArrayPixelData_(n,s,e,t)}return this.getImagePixelData_(me(i),e,t)}return this.getImagePixelData_(this.tile.getImage(),e,t)}}class Ie extends vt{constructor(e,t){super(e),t=t||{},this.inversePixelTransform_=he(),this.postProcesses_=t.postProcesses,this.uniforms_=t.uniforms,this.helper,this.onMapChanged_=()=>{this.clearCache(),this.removeHelper()},e.addChangeListener(be.MAP,this.onMapChanged_),this.dispatchPreComposeEvent=this.dispatchPreComposeEvent.bind(this),this.dispatchPostComposeEvent=this.dispatchPostComposeEvent.bind(this)}dispatchPreComposeEvent(e,t){const i=this.getLayer();if(i.hasListener(J.PRECOMPOSE)){const n=new de(J.PRECOMPOSE,void 0,t,e);i.dispatchEvent(n)}}dispatchPostComposeEvent(e,t){const i=this.getLayer();if(i.hasListener(J.POSTCOMPOSE)){const n=new de(J.POSTCOMPOSE,void 0,t,e);i.dispatchEvent(n)}}reset(e){this.uniforms_=e.uniforms,this.helper&&this.helper.setUniforms(this.uniforms_)}removeHelper(){this.helper&&(this.helper.dispose(),delete this.helper)}prepareFrame(e){if(this.getLayer().getRenderSource()){let t=!0,i=-1,n;for(let o=0,a=e.layerStatesArray.length;o<a;o++){const h=e.layerStatesArray[o].layer,l=h.getRenderer();if(!(l instanceof Ie)){t=!0;continue}const f=h.getClassName();if((t||f!==n)&&(i+=1,t=!1),n=f,l===this)break}const s="map/"+e.mapId+"/group/"+i;(!this.helper||!this.helper.canvasCacheKeyMatches(s)||this.helper.needsToBeRecreated())&&(this.removeHelper(),this.helper=new Sr({postProcesses:this.postProcesses_,uniforms:this.uniforms_,canvasCacheKey:s}),n&&(this.helper.getCanvas().className=n),this.afterHelperCreated())}return this.prepareFrameInternal(e)}afterHelperCreated(){}prepareFrameInternal(e){return!0}clearCache(){}disposeInternal(){var e;this.clearCache(),this.removeHelper(),(e=this.getLayer())==null||e.removeChangeListener(be.MAP,this.onMapChanged_),super.disposeInternal()}dispatchRenderEvent_(e,t,i){const n=this.getLayer();if(n.hasListener(e)){et(this.inversePixelTransform_,0,0,i.pixelRatio,-i.pixelRatio,0,0,-i.size[1]);const s=new de(e,this.inversePixelTransform_,i,t);n.dispatchEvent(s)}}preRender(e,t){this.dispatchRenderEvent_(J.PRERENDER,e,t)}postRender(e,t){this.dispatchRenderEvent_(J.POSTRENDER,e,t)}}const Ir={TILE_TRANSFORM:"u_tileTransform",TRANSITION_ALPHA:"u_transitionAlpha",DEPTH:"u_depth",RENDER_EXTENT:"u_renderExtent",PATTERN_ORIGIN:"u_patternOrigin",RESOLUTION:"u_resolution",ZOOM:"u_zoom",GLOBAL_ALPHA:"u_globalAlpha",PROJECTION_MATRIX:"u_projectionMatrix",SCREEN_TO_WORLD_MATRIX:"u_screenToWorldMatrix"};function Ke(r){return 1/(r+2)}function Dr(){return{tileIds:new Set,representationsByZ:{}}}function Ze(r,e){return r.tileIds.has(H(e))}function ke(r,e,t){const i=r.representationsByZ;t in i||(i[t]=new Set),i[t].add(e),r.tileIds.add(H(e.tile))}function Re(r,e){const t=r.layerStatesArray[r.layerIndex];t.extent&&(e=k(e,it(t.extent,r.viewState.projection)));const i=t.layer.getRenderSource();if(!i.getWrapX()){const n=i.getTileGridForProjection(r.viewState.projection).getExtent();n&&(e=k(e,n))}return e}function Se(r,e){return`${H(r)},${r.getKey()},${r.getRevision()},${ee(e)}`}class Fr extends Ie{constructor(e,t){super(e,{uniforms:t.uniforms,postProcesses:t.postProcesses}),this.renderComplete=!1,this.tileTransform_=he(),this.tempMat4=ie(),this.tempTileRange_=new Pt(0,0,0,0),this.tempTileCoord_=Ne(0,0,0),this.tempSize_=[0,0];const i=t.cacheSize!==void 0?t.cacheSize:512;this.tileRepresentationCache=new Ut(i),this.frameState=null,this.renderedProjection_=void 0}reset(e){super.reset({uniforms:e.uniforms})}prepareFrameInternal(e){this.renderedProjection_?e.viewState.projection!==this.renderedProjection_&&(this.clearCache(),this.renderedProjection_=e.viewState.projection):this.renderedProjection_=e.viewState.projection;const i=this.getLayer().getRenderSource();return!i||nr(Re(e,e.extent))?!1:i.getState()==="ready"}createTileRepresentation(e){return ct()}enqueueTiles(e,t,i,n,s){const o=e.viewState,a=this.getLayer(),h=a.getRenderSource(),l=h.getTileGridForProjection(o.projection),f=h.getGutterForProjection(o.projection),u=H(h);u in e.wantedTiles||(e.wantedTiles[u]={});const T=e.wantedTiles[u],d=this.tileRepresentationCache,c=a.getMapInternal(),p=Math.max(i-s,l.getMinZoom(),l.getZForResolution(Math.min(a.getMaxResolution(),c?c.getView().getResolutionForZoom(Math.max(a.getMinZoom(),0)):l.getResolution(0)),h.zDirection)),A=o.rotation,S=A?sr(o.center,o.resolution,A,e.size):void 0;for(let E=i;E>=p;--E){const R=l.getTileRangeForExtentAndZ(t,E,this.tempTileRange_),g=l.getResolution(E);for(let _=R.minX;_<=R.maxX;++_)for(let x=R.minY;x<=R.maxY;++x){if(A&&!l.tileCoordIntersectsViewport([E,_,x],S))continue;const y=Ne(E,_,x,this.tempTileCoord_),P=Se(h,y);let U,m;if(d.containsKey(P)&&(U=d.get(P),m=U.tile),(!U||U.tile.key!==h.getKey())&&(m=h.getTile(E,_,x,e.pixelRatio,o.projection),!m)||Ze(n,m))continue;U?U.setTile(m):(U=this.createTileRepresentation({tile:m,grid:l,helper:this.helper,gutter:f}),d.set(P,U)),ke(n,U,E);const I=m.getKey();T[I]=!0,m.getState()===F.IDLE&&(e.tileQueue.isKeyQueued(I)||e.tileQueue.enqueue([m,u,l.getTileCoordCenter(y),g]))}}}beforeTilesRender(e,t){this.helper.prepareDraw(this.frameState,!t,!0)}beforeTilesMaskRender(e){return!1}renderTile(e,t,i,n,s,o,a,h,l,f,u){}renderTileMask(e,t,i,n){}drawTile_(e,t,i,n,s,o,a){if(!t.ready)return;const l=t.tile.tileCoord,f=ee(l),u=f in o?o[f]:1,T=a.getResolution(i),d=q(a.getTileSize(i),this.tempSize_),c=a.getOrigin(i),p=a.getTileCoordExtent(l),A=u<1?-1:Ke(i);u<1&&(e.animate=!0);const S=e.viewState,E=S.center[0],R=S.center[1],g=d[0]+2*n,_=d[1]+2*n,x=g/_,y=(E-c[0])/(d[0]*T),P=(c[1]-R)/(d[1]*T),U=S.resolution/T,m=l[1],I=l[2];It(this.tileTransform_),Ge(this.tileTransform_,2/(e.size[0]*U/g),-2/(e.size[1]*U/g)),Dt(this.tileTransform_,S.rotation),Ge(this.tileTransform_,1,1/x),Ft(this.tileTransform_,(d[0]*(m-y)-n)/g,(d[1]*(I-P)-n)/_),this.renderTile(t,this.tileTransform_,e,s,T,d,c,p,A,n,u)}renderFrame(e){this.frameState=e,this.renderComplete=!0;const t=this.helper.getGL();this.preRender(t,e);const i=e.viewState,n=this.getLayer(),s=n.getRenderSource(),o=s.getTileGridForProjection(i.projection),a=s.getGutterForProjection(i.projection),h=Re(e,e.extent),l=o.getZForResolution(i.resolution,s.zDirection),f=Dr(),u=n.getPreload();if(e.nextExtent){const R=o.getZForResolution(i.nextResolution,s.zDirection),g=Re(e,e.nextExtent);this.enqueueTiles(e,g,R,f,u)}this.enqueueTiles(e,h,l,f,0),u>0&&setTimeout(()=>{this.enqueueTiles(e,h,l-1,f,u-1)},0);const T={};let d=!1;const c=f.representationsByZ;if(l in c){const R=H(this),g=e.time;for(const _ of c[l]){const x=_.tile;if(x.getState()===F.EMPTY)continue;const y=x.tileCoord;if(_.ready){const m=x.getAlpha(R,g);if(m===1){x.endTransition(R);continue}d=!0;const I=ee(y);T[I]=m}if(this.renderComplete=!1,this.findAltTiles_(o,y,l+1,f))continue;const U=o.getMinZoom();for(let m=l-1;m>=U&&!this.findAltTiles_(o,y,m,f);--m);}}const p=Object.keys(c).map(Number).sort(or);if(this.beforeTilesMaskRender(e))for(let R=0,g=p.length;R<g;++R){const _=p[R];for(const x of c[_]){const y=x.tile.tileCoord;if(ee(y)in T)continue;const U=o.getTileCoordExtent(y);this.renderTileMask(x,_,U,Ke(_))}}this.beforeTilesRender(e,d);for(let R=0,g=p.length;R<g;++R){const _=p[R];for(const x of c[_]){const y=x.tile.tileCoord;ee(y)in T||this.drawTile_(e,x,_,a,h,T,o)}}if(l in c)for(const R of c[l]){const g=R.tile.tileCoord;ee(g)in T&&this.drawTile_(e,R,l,a,h,T,o)}this.beforeFinalize(e),this.helper.finalizeDraw(e,this.dispatchPreComposeEvent,this.dispatchPostComposeEvent);const S=this.helper.getCanvas();return this.tileRepresentationCache.expireCache(),this.postRender(t,e),S}beforeFinalize(e){}findAltTiles_(e,t,i,n){const s=e.getTileRangeForTileCoordAndZ(t,i,this.tempTileRange_);if(!s)return!1;let o=!0;const a=this.tileRepresentationCache,h=this.getLayer().getRenderSource();for(let l=s.minX;l<=s.maxX;++l)for(let f=s.minY;f<=s.maxY;++f){const u=Se(h,[i,l,f]);let T=!1;if(a.containsKey(u)){const d=a.get(u);d.ready&&!Ze(n,d.tile)&&(ke(n,d,i),T=!0)}T||(o=!1)}return o}clearCache(){super.clearCache();const e=this.tileRepresentationCache;e.forEach(t=>t.dispose()),e.clear()}afterHelperCreated(){super.afterHelperCreated(),this.tileRepresentationCache.forEach(e=>e.setHelper(this.helper))}disposeInternal(){super.disposeInternal(),delete this.frameState}}const b={...Ir,TILE_TEXTURE_ARRAY:"u_tileTextures",TEXTURE_PIXEL_WIDTH:"u_texturePixelWidth",TEXTURE_PIXEL_HEIGHT:"u_texturePixelHeight",TEXTURE_RESOLUTION:"u_textureResolution",TEXTURE_ORIGIN_X:"u_textureOriginX",TEXTURE_ORIGIN_Y:"u_textureOriginY"},ue={TEXTURE_COORD:"a_textureCoord"},Nr=[{name:ue.TEXTURE_COORD,size:2,type:ne.FLOAT}];class Gr extends Fr{constructor(e,t){super(e,t),this.program_,this.vertexShader_=t.vertexShader,this.fragmentShader_=t.fragmentShader,this.indices_=new ht(Pe,Ue),this.indices_.fromArray([0,1,3,1,2,3]),this.paletteTextures_=t.paletteTextures||[]}reset(e){if(super.reset(e),this.helper){const t=this.helper.getGL();for(const i of this.paletteTextures_)i.delete(t)}if(this.vertexShader_=e.vertexShader,this.fragmentShader_=e.fragmentShader,this.paletteTextures_=e.paletteTextures||[],this.helper){this.program_=this.helper.getProgram(this.fragmentShader_,this.vertexShader_);const t=this.helper.getGL();for(const i of this.paletteTextures_)i.getTexture(t)}}afterHelperCreated(){super.afterHelperCreated();const e=this.helper.getGL();for(const t of this.paletteTextures_)t.getTexture(e);this.program_=this.helper.getProgram(this.fragmentShader_,this.vertexShader_),this.helper.flushBufferData(this.indices_)}removeHelper(){if(this.helper){const e=this.helper.getGL();for(const t of this.paletteTextures_)t.delete(e)}super.removeHelper()}createTileRepresentation(e){return new Ur(e)}beforeTilesRender(e,t){super.beforeTilesRender(e,t),this.helper.useProgram(this.program_,e)}renderTile(e,t,i,n,s,o,a,h,l,f,u){const T=this.helper.getGL();this.helper.bindBuffer(e.coords),this.helper.bindBuffer(this.indices_),this.helper.enableAttributes(Nr);let d=0;for(;d<e.textures.length;){const x=`${b.TILE_TEXTURE_ARRAY}[${d}]`;this.helper.bindTexture(e.textures[d],d,x),++d}for(let x=0;x<this.paletteTextures_.length;++x){const y=this.paletteTextures_[x],P=y.getTexture(T);this.helper.bindTexture(P,d,y.name),++d}const c=i.viewState,p=o[0]+2*f,A=o[1]+2*f,E=e.tile.tileCoord,R=E[1],g=E[2];this.helper.setUniformMatrixValue(b.TILE_TRANSFORM,lt(this.tempMat4,t)),this.helper.setUniformFloatValue(b.TRANSITION_ALPHA,u),this.helper.setUniformFloatValue(b.DEPTH,l);let _=n;f>0&&(_=h,k(_,n,_)),this.helper.setUniformFloatVec4(b.RENDER_EXTENT,_),this.helper.setUniformFloatValue(b.RESOLUTION,c.resolution),this.helper.setUniformFloatValue(b.ZOOM,c.zoom),this.helper.setUniformFloatValue(b.TEXTURE_PIXEL_WIDTH,p),this.helper.setUniformFloatValue(b.TEXTURE_PIXEL_HEIGHT,A),this.helper.setUniformFloatValue(b.TEXTURE_RESOLUTION,s),this.helper.setUniformFloatValue(b.TEXTURE_ORIGIN_X,a[0]+R*o[0]*s-f*s),this.helper.setUniformFloatValue(b.TEXTURE_ORIGIN_Y,a[1]-g*o[1]*s+f*s),this.helper.drawElements(0,this.indices_.getSize())}getData(e){if(!this.helper.getGL())return null;const i=this.frameState;if(!i)return null;const n=this.getLayer(),s=Nt(i.pixelToCoordinateTransform,e.slice()),o=i.viewState,a=n.getExtent();if(a&&!Me(it(a,o.projection),s))return null;const h=n.getSources(ar([s]),o.resolution);let l,f,u;for(l=h.length-1;l>=0;--l)if(f=h[l],f.getState()==="ready"){if(u=f.getTileGridForProjection(o.projection),f.getWrapX())break;const d=u.getExtent();if(!d||Me(d,s))break}if(l<0)return null;const T=this.tileRepresentationCache;for(let d=u.getZForResolution(o.resolution);d>=u.getMinZoom();--d){const c=u.getTileCoordForCoordAndZ(s,d),p=Se(f,c);if(!T.containsKey(p))continue;const A=T.get(p);if(A.tile.getState()===F.EMPTY)return null;if(!A.loaded)continue;const E=u.getOrigin(d),R=q(u.getTileSize(d)),g=u.getResolution(d),_=(s[0]-E[0])/g-c[1]*R[0],x=(E[1]-s[1])/g-c[2]*R[1];return A.getPixelData(_,x)}return null}disposeInternal(){const e=this.helper;if(e){const t=e.getGL();for(const i of this.paletteTextures_)i.delete(t);this.paletteTextures_.length=0,t.deleteProgram(this.program_),delete this.program_,e.deleteBuffer(this.indices_)}super.disposeInternal(),delete this.indices_}}class Or{constructor(e,t){this.name=e,this.data=t,this.texture_=null}getTexture(e){if(!this.texture_){const t=e.createTexture();e.bindTexture(e.TEXTURE_2D,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,this.data.length/4,1,0,e.RGBA,e.UNSIGNED_BYTE,this.data),this.texture_=t}return this.texture_}delete(e){this.texture_&&e.deleteTexture(this.texture_),this.texture_=null}}function Mr(r,e){return`operator_${r}_${Object.keys(e.functions).length}`}function se(r){const e=r.toString();return e.includes(".")?e:e+".0"}function De(r){if(r.length<2||r.length>4)throw new Error("`formatArray` can only output `vec2`, `vec3` or `vec4` arrays.");return`vec${r.length}(${r.map(se).join(", ")})`}function Br(r){const e=st(r),t=e.length>3?e[3]:1;return De([e[0]/255,e[1]/255,e[2]/255,t])}function wr(r){const e=q(r);return De(e)}const ge={};let Xr=0;function Tt(r){return r in ge||(ge[r]=Xr++),ge[r]}function $r(r){return se(Tt(r))}function _t(r){return"u_var_"+r}function Hr(){return{variables:{},properties:{},functions:{},bandCount:0,featureId:!1,geometryType:!1}}const pe="getBandValue",Et="u_paletteTextures",jr="featureId",zr="geometryType",Wr=-9999999;function Yr(r,e,t,i){const n=Gt(r,e,t);return Fe(n,e,i)}function C(r){return(e,t,i)=>{const n=t.args.length,s=new Array(n);for(let o=0;o<n;++o)s[o]=Fe(t.args[o],i,e);return r(s,e)}}const Vr={[L.Get]:(r,e)=>{const i=e.args[0].value;i in r.properties||(r.properties[i]={name:i,type:e.type});let s="a_prop_"+i;return Oe(e.type,Ae)&&(s=`(${s} > 0.0)`),s},[L.Id]:r=>(r.featureId=!0,"a_"+jr),[L.GeometryType]:r=>(r.geometryType=!0,"a_"+zr),[L.LineMetric]:()=>"currentLineMetric",[L.Var]:(r,e)=>{const i=e.args[0].value;i in r.variables||(r.variables[i]={name:i,type:e.type});let s=_t(i);return Oe(e.type,Ae)&&(s=`(${s} > 0.0)`),s},[L.Has]:(r,e)=>{const i=e.args[0].value;return i in r.properties||(r.properties[i]={name:i,type:e.type}),`(a_prop_${i} != ${se(Wr)})`},[L.Resolution]:()=>"u_resolution",[L.Zoom]:()=>"u_zoom",[L.Time]:()=>"u_time",[L.Any]:C(r=>`(${r.join(" || ")})`),[L.All]:C(r=>`(${r.join(" && ")})`),[L.Not]:C(([r])=>`(!${r})`),[L.Equal]:C(([r,e])=>`(${r} == ${e})`),[L.NotEqual]:C(([r,e])=>`(${r} != ${e})`),[L.GreaterThan]:C(([r,e])=>`(${r} > ${e})`),[L.GreaterThanOrEqualTo]:C(([r,e])=>`(${r} >= ${e})`),[L.LessThan]:C(([r,e])=>`(${r} < ${e})`),[L.LessThanOrEqualTo]:C(([r,e])=>`(${r} <= ${e})`),[L.Multiply]:C(r=>`(${r.join(" * ")})`),[L.Divide]:C(([r,e])=>`(${r} / ${e})`),[L.Add]:C(r=>`(${r.join(" + ")})`),[L.Subtract]:C(([r,e])=>`(${r} - ${e})`),[L.Clamp]:C(([r,e,t])=>`clamp(${r}, ${e}, ${t})`),[L.Mod]:C(([r,e])=>`mod(${r}, ${e})`),[L.Pow]:C(([r,e])=>`pow(${r}, ${e})`),[L.Abs]:C(([r])=>`abs(${r})`),[L.Floor]:C(([r])=>`floor(${r})`),[L.Ceil]:C(([r])=>`ceil(${r})`),[L.Round]:C(([r])=>`floor(${r} + 0.5)`),[L.Sin]:C(([r])=>`sin(${r})`),[L.Cos]:C(([r])=>`cos(${r})`),[L.Atan]:C(([r,e])=>e!==void 0?`atan(${r}, ${e})`:`atan(${r})`),[L.Sqrt]:C(([r])=>`sqrt(${r})`),[L.Match]:C(r=>{const e=r[0],t=r[r.length-1];let i=null;for(let n=r.length-3;n>=1;n-=2){const s=r[n],o=r[n+1];i=`(${e} == ${s} ? ${o} : ${i||t})`}return i}),[L.Between]:C(([r,e,t])=>`(${r} >= ${e} && ${r} <= ${t})`),[L.Interpolate]:C(([r,e,...t])=>{let i="";for(let n=0;n<t.length-2;n+=2){const s=t[n],o=i||t[n+1],a=t[n+2],h=t[n+3];let l;r===se(1)?l=`(${e} - ${s}) / (${a} - ${s})`:l=`(pow(${r}, (${e} - ${s})) - 1.0) / (pow(${r}, (${a} - ${s})) - 1.0)`,i=`mix(${o}, ${h}, clamp(${l}, 0.0, 1.0))`}return i}),[L.Case]:C(r=>{const e=r[r.length-1];let t=null;for(let i=r.length-3;i>=0;i-=2){const n=r[i],s=r[i+1];t=`(${n} ? ${s} : ${t||e})`}return t}),[L.In]:C(([r,...e],t)=>{const i=Mr("in",t),n=[];for(let s=0;s<e.length;s+=1)n.push(`  if (inputValue == ${e[s]}) { return true; }`);return t.functions[i]=`bool ${i}(float inputValue) {
${n.join(`
`)}
  return false;
}`,`${i}(${r})`}),[L.Array]:C(r=>`vec${r.length}(${r.join(", ")})`),[L.Color]:C(r=>{if(r.length===1)return`vec4(vec3(${r[0]} / 255.0), 1.0)`;if(r.length===2)return`vec4(vec3(${r[0]} / 255.0), ${r[1]})`;const e=r.slice(0,3).map(i=>`${i} / 255.0`);if(r.length===3)return`vec4(${e.join(", ")}, 1.0)`;const t=r[3];return`vec4(${e.join(", ")}, ${t})`}),[L.Band]:C(([r,e,t],i)=>{if(!(pe in i.functions)){let n="";const s=i.bandCount||1;for(let o=0;o<s;o++){const a=Math.floor(o/4);let h=o%4;o===s-1&&h===1&&(h=3);const l=`${b.TILE_TEXTURE_ARRAY}[${a}]`;n+=`  if (band == ${o+1}.0) {
    return texture2D(${l}, v_textureCoord + vec2(dx, dy))[${h}];
  }
`}i.functions[pe]=`float getBandValue(float band, float xOffset, float yOffset) {
  float dx = xOffset / ${b.TEXTURE_PIXEL_WIDTH};
  float dy = yOffset / ${b.TEXTURE_PIXEL_HEIGHT};
${n}
}`}return`${pe}(${r}, ${e??"0.0"}, ${t??"0.0"})`}),[L.Palette]:(r,e)=>{const[t,...i]=e.args,n=i.length,s=new Uint8Array(n*4);for(let l=0;l<i.length;l++){const f=i[l].value,u=st(f),T=l*4;s[T]=u[0],s[T+1]=u[1],s[T+2]=u[2],s[T+3]=u[3]*255}r.paletteTextures||(r.paletteTextures=[]);const o=`${Et}[${r.paletteTextures.length}]`,a=new Or(o,s);r.paletteTextures.push(a);const h=Fe(t,Z,r);return`texture2D(${o}, vec2((${h} + 0.5) / ${n}.0, 0.5))`}};function Fe(r,e,t){if(r instanceof Ot){const i=Vr[r.operator];if(i===void 0)throw new Error(`No compiler defined for this operator: ${JSON.stringify(r.operator)}`);return i(t,r,e)}if((r.type&Z)>0)return se(r.value);if((r.type&Ae)>0)return r.value.toString();if((r.type&Mt)>0)return $r(r.value.toString());if((r.type&nt)>0)return Br(r.value);if((r.type&Bt)>0)return De(r.value);if((r.type&wt)>0)return wr(r.value);throw new Error(`Unexpected expression ${r.value} (expected type ${Xt(e)})`)}function Q(r,e,t){const i=$t();return Yr(e,t,i,r)}function qe(r,e){const t=`
    attribute vec2 ${ue.TEXTURE_COORD};
    uniform mat4 ${b.TILE_TRANSFORM};
    uniform float ${b.TEXTURE_PIXEL_WIDTH};
    uniform float ${b.TEXTURE_PIXEL_HEIGHT};
    uniform float ${b.TEXTURE_RESOLUTION};
    uniform float ${b.TEXTURE_ORIGIN_X};
    uniform float ${b.TEXTURE_ORIGIN_Y};
    uniform float ${b.DEPTH};

    varying vec2 v_textureCoord;
    varying vec2 v_mapCoord;

    void main() {
      v_textureCoord = ${ue.TEXTURE_COORD};
      v_mapCoord = vec2(
        ${b.TEXTURE_ORIGIN_X} + ${b.TEXTURE_RESOLUTION} * ${b.TEXTURE_PIXEL_WIDTH} * v_textureCoord[0],
        ${b.TEXTURE_ORIGIN_Y} - ${b.TEXTURE_RESOLUTION} * ${b.TEXTURE_PIXEL_HEIGHT} * v_textureCoord[1]
      );
      gl_Position = ${b.TILE_TRANSFORM} * vec4(${ue.TEXTURE_COORD}, ${b.DEPTH}, 1.0);
    }
  `,i={...Hr(),bandCount:e},n=[];if(r.color!==void 0){const u=Q(i,r.color,nt);n.push(`color = ${u};`)}if(r.contrast!==void 0){const u=Q(i,r.contrast,Z);n.push(`color.rgb = clamp((${u} + 1.0) * color.rgb - (${u} / 2.0), vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0));`)}if(r.exposure!==void 0){const u=Q(i,r.exposure,Z);n.push(`color.rgb = clamp((${u} + 1.0) * color.rgb, vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0));`)}if(r.saturation!==void 0){const u=Q(i,r.saturation,Z);n.push(`
      float saturation = ${u} + 1.0;
      float sr = (1.0 - saturation) * 0.2126;
      float sg = (1.0 - saturation) * 0.7152;
      float sb = (1.0 - saturation) * 0.0722;
      mat3 saturationMatrix = mat3(
        sr + saturation, sr, sr,
        sg, sg + saturation, sg,
        sb, sb, sb + saturation
      );
      color.rgb = clamp(saturationMatrix * color.rgb, vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0));
    `)}if(r.gamma!==void 0){const u=Q(i,r.gamma,Z);n.push(`color.rgb = pow(color.rgb, vec3(1.0 / ${u}));`)}if(r.brightness!==void 0){const u=Q(i,r.brightness,Z);n.push(`color.rgb = clamp(color.rgb + ${u}, vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0));`)}const s={},o=Object.keys(i.variables).length;if(o>1&&!r.variables)throw new Error(`Missing variables in style (expected ${i.variables})`);for(let u=0;u<o;++u){const T=i.variables[Object.keys(i.variables)[u]];if(!(T.name in r.variables))throw new Error(`Missing '${T.name}' in style variables`);const d=_t(T.name);s[d]=function(){let c=r.variables[T.name];return typeof c=="string"&&(c=Tt(c)),c!==void 0?c:-9999999}}const a=Object.keys(s).map(function(u){return`uniform float ${u};`}),h=Math.ceil(e/4);a.push(`uniform sampler2D ${b.TILE_TEXTURE_ARRAY}[${h}];`),i.paletteTextures&&a.push(`uniform sampler2D ${Et}[${i.paletteTextures.length}];`);const l=Object.keys(i.functions).map(function(u){return i.functions[u]}),f=`
    #ifdef GL_FRAGMENT_PRECISION_HIGH
    precision highp float;
    #else
    precision mediump float;
    #endif

    varying vec2 v_textureCoord;
    varying vec2 v_mapCoord;
    uniform vec4 ${b.RENDER_EXTENT};
    uniform float ${b.TRANSITION_ALPHA};
    uniform float ${b.TEXTURE_PIXEL_WIDTH};
    uniform float ${b.TEXTURE_PIXEL_HEIGHT};
    uniform float ${b.RESOLUTION};
    uniform float ${b.ZOOM};

    ${a.join(`
`)}

    ${l.join(`
`)}

    void main() {
      if (
        v_mapCoord[0] < ${b.RENDER_EXTENT}[0] ||
        v_mapCoord[1] < ${b.RENDER_EXTENT}[1] ||
        v_mapCoord[0] > ${b.RENDER_EXTENT}[2] ||
        v_mapCoord[1] > ${b.RENDER_EXTENT}[3]
      ) {
        discard;
      }

      vec4 color = texture2D(${b.TILE_TEXTURE_ARRAY}[0],  v_textureCoord);

      ${n.join(`
`)}

      gl_FragColor = color;
      gl_FragColor.rgb *= gl_FragColor.a;
      gl_FragColor *= ${b.TRANSITION_ALPHA};
    }`;return{vertexShader:t,fragmentShader:f,uniforms:s,paletteTextures:i.paletteTextures}}class Kr extends Ht{constructor(e){e=e?Object.assign({},e):{};const t=e.style||{};delete e.style,super(e),this.sources_=e.sources,this.renderedSource_=null,this.renderedResolution_=NaN,this.style_=t,this.styleVariables_=this.style_.variables||{},this.handleSourceUpdate_(),this.addChangeListener(be.SOURCE,this.handleSourceUpdate_)}getSources(e,t){const i=this.getSource();return this.sources_?typeof this.sources_=="function"?this.sources_(e,t):this.sources_:i?[i]:[]}getRenderSource(){return this.renderedSource_||this.getSource()}getSourceState(){const e=this.getRenderSource();return e?e.getState():"undefined"}handleSourceUpdate_(){this.hasRenderer()&&this.getRenderer().clearCache();const e=this.getSource();if(e)if(e.getState()==="loading"){const t=()=>{e.getState()==="ready"&&(e.removeEventListener("change",t),this.setStyle(this.style_))};e.addEventListener("change",t)}else this.setStyle(this.style_)}getSourceBandCount_(){const e=Number.MAX_SAFE_INTEGER,t=this.getSources([-e,-e,e,e],e);return t&&t.length&&"bandCount"in t[0]?t[0].bandCount:4}createRenderer(){const e=qe(this.style_,this.getSourceBandCount_());return new Gr(this,{vertexShader:e.vertexShader,fragmentShader:e.fragmentShader,uniforms:e.uniforms,cacheSize:this.getCacheSize(),paletteTextures:e.paletteTextures})}renderSources(e,t){const i=this.getRenderer();let n;for(let s=0,o=t.length;s<o;++s)this.renderedSource_=t[s],i.prepareFrame(e)&&(n=i.renderFrame(e));return n}render(e,t){this.rendered=!0;const i=e.viewState,n=this.getSources(e.extent,i.resolution);let s=!0;for(let a=0,h=n.length;a<h;++a){const l=n[a],f=l.getState();if(f=="loading"){const u=()=>{l.getState()=="ready"&&(l.removeEventListener("change",u),this.changed())};l.addEventListener("change",u)}s=s&&f=="ready"}const o=this.renderSources(e,n);if(this.getRenderer().renderComplete&&s)return this.renderedResolution_=i.resolution,o;if(this.renderedResolution_>.5*i.resolution){const a=this.getSources(e.extent,this.renderedResolution_).filter(h=>!n.includes(h));if(a.length>0)return this.renderSources(e,a)}return o}setStyle(e){if(this.styleVariables_=e.variables||{},this.style_=e,this.hasRenderer()){const t=qe(this.style_,this.getSourceBandCount_());this.getRenderer().reset({vertexShader:t.vertexShader,fragmentShader:t.fragmentShader,uniforms:t.uniforms,paletteTextures:t.paletteTextures}),this.changed()}}updateStyleVariables(e){Object.assign(this.styleVariables_,e),this.changed()}}Kr.prototype.dispose;class Zr extends jt{constructor(e){super({extent:e.extent,origin:e.origin,origins:e.origins,resolutions:e.resolutions,tileSize:e.tileSize,tileSizes:e.tileSizes,sizes:e.sizes}),this.matrixIds_=e.matrixIds}getMatrixId(e){return this.matrixIds_[e]}getMatrixIds(){return this.matrixIds_}}function li(r,e,t){const i=[],n=[],s=[],o=[],a=[];t=t!==void 0?t:[];const h="SupportedCRS",l="TileMatrix",f="Identifier",u="ScaleDenominator",T="TopLeftCorner",d="TileWidth",c="TileHeight",p=r[h],A=ot(p),S=A.getMetersPerUnit(),E=A.getAxisOrientation().startsWith("ne");return r[l].sort(function(R,g){return g[u]-R[u]}),r[l].forEach(function(R){let g;if(t.length>0?g=t.find(function(_){return R[f]==_[l]?!0:R[f].includes(":")?!1:r[f]+":"+R[f]===_[l]}):g=!0,g){n.push(R[f]);const _=R[u]*28e-5/S,x=R[d],y=R[c];E?s.push([R[T][1],R[T][0]]):s.push(R[T]),i.push(_),o.push(x==y?x:[x,y]),a.push([R.MatrixWidth,R.MatrixHeight])}}),new Zr({extent:e,origins:s,resolutions:i,matrixIds:n,tileSizes:o,sizes:a})}const kr=`
  attribute vec4 a_position;
  attribute vec4 a_texcoord;

  uniform mat4 u_matrix;
  uniform mat4 u_textureMatrix;

  varying vec2 v_texcoord;

  void main() {
    gl_Position = u_matrix * a_position;
    vec2 texcoord = (u_textureMatrix * a_texcoord).xy;
    v_texcoord = texcoord;
  }
`,qr=`
  precision mediump float;

  varying vec2 v_texcoord;

  uniform sampler2D u_texture;

  void main() {
    if (
      v_texcoord.x < 0.0 ||
      v_texcoord.y < 0.0 ||
      v_texcoord.x > 1.0 ||
      v_texcoord.y > 1.0
    ) {
      discard;
    }
    gl_FragColor = texture2D(u_texture, v_texcoord);
  }
`;class Jr{constructor(e){this.gl_=e,this.program_=ye(e,qr,kr),this.positionLocation=e.getAttribLocation(this.program_,"a_position"),this.texcoordLocation=e.getAttribLocation(this.program_,"a_texcoord"),this.matrixLocation=e.getUniformLocation(this.program_,"u_matrix"),this.textureMatrixLocation=e.getUniformLocation(this.program_,"u_textureMatrix"),this.textureLocation=e.getUniformLocation(this.program_,"u_texture"),this.positionBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.positionBuffer),this.positions=[0,0,0,1,1,0,1,0,0,1,1,1],e.bufferData(e.ARRAY_BUFFER,new Float32Array(this.positions),e.STATIC_DRAW),this.texcoordBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.texcoordBuffer),this.texcoords=[0,0,0,1,1,0,1,0,0,1,1,1],e.bufferData(e.ARRAY_BUFFER,new Float32Array(this.texcoords),e.STATIC_DRAW)}drawImage(e,t,i,n,s,o,a,h,l,f,u,T,d){const c=this.gl_;h===void 0&&(h=n),l===void 0&&(l=s),o===void 0&&(o=t),a===void 0&&(a=i),f===void 0&&(f=o),u===void 0&&(u=a),T===void 0&&(T=c.canvas.width),d===void 0&&(d=c.canvas.height),c.bindTexture(c.TEXTURE_2D,e),c.useProgram(this.program_),c.bindBuffer(c.ARRAY_BUFFER,this.positionBuffer),c.enableVertexAttribArray(this.positionLocation),c.vertexAttribPointer(this.positionLocation,2,c.FLOAT,!1,0,0),c.bindBuffer(c.ARRAY_BUFFER,this.texcoordBuffer),c.enableVertexAttribArray(this.texcoordLocation),c.vertexAttribPointer(this.texcoordLocation,2,c.FLOAT,!1,0,0);let p=Le(0,T,0,d,-1,1);p=dr(p,h,l,0),p=He(p,f,u,1),c.uniformMatrix4fv(this.matrixLocation,!1,p);let A=Tr(n/t,s/i,0);A=He(A,o/t,a/i,1),c.uniformMatrix4fv(this.textureMatrixLocation,!1,A),c.uniform1i(this.textureLocation,0),c.drawArrays(c.TRIANGLES,0,this.positions.length/2)}}function Je(r,e,t){const i=r.createShader(e);if(i===null)throw new Error("Shader compilation failed");if(r.shaderSource(i,t),r.compileShader(i),!r.getShaderParameter(i,r.COMPILE_STATUS)){const n=r.getShaderInfoLog(i);throw n===null?new Error("Shader info log creation failed"):new Error(n)}return i}function ye(r,e,t){const i=r.createProgram(),n=Je(r,r.VERTEX_SHADER,t),s=Je(r,r.FRAGMENT_SHADER,e);if(i===null)throw new Error("Program creation failed");if(r.attachShader(i,n),r.attachShader(i,s),r.linkProgram(i),!r.getProgramParameter(i,r.LINK_STATUS))throw r.getProgramInfoLog(i)===null?new Error("Program info log creation failed"):new Error;return i}const Qr=`
  attribute vec4 a_position;

  uniform mat4 u_matrix;

  void main() {
     gl_Position = u_matrix * a_position;
  }
`,ei=`
  precision mediump float;

  uniform vec4 u_val;
  void main() {
     gl_FragColor = u_val;
  }
`,ti=`
  attribute vec4 a_position;
  attribute vec2 a_texcoord;

  varying vec2 v_texcoord;

  uniform mat4 u_matrix;

  void main() {
     gl_Position = u_matrix * a_position;
     v_texcoord = a_texcoord;
  }
`,ri=`
  precision mediump float;

  varying vec2 v_texcoord;

  uniform sampler2D u_texture;

  void main() {
    if (v_texcoord.x < 0.0 || v_texcoord.x > 1.0 || v_texcoord.y < 0.0 || v_texcoord.y > 1.0) {
      discard;
    }
    gl_FragColor = texture2D(u_texture, v_texcoord);
  }
`;function ii(r,e,t,i){let n;return t&&t.length?n=t.shift():zt?n=new OffscreenCanvas(r||300,e||300):n=document.createElement("canvas"),r&&(n.width=r),e&&(n.height=e),n.getContext("webgl",i)}function ni(r){const e=r.canvas;e.width=1,e.height=1,r.clear(r.COLOR_BUFFER_BIT|r.DEPTH_BUFFER_BIT|r.STENCIL_BUFFER_BIT)}const Qe=[];function si(r,e,t,i,n,s,o,a,h,l,f,u,T,d){const c=Math.round(i*e),p=Math.round(i*t);r.canvas.width=c,r.canvas.height=p;let A,S;if(S=r.createTexture(),r.bindTexture(r.TEXTURE_2D,S),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),T?(r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.LINEAR)):(r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.NEAREST),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.NEAREST)),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,c,p,0,r.RGBA,f,null),A=r.createFramebuffer(),r.bindFramebuffer(r.FRAMEBUFFER,A),r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,S,0),A===null)throw new Error("Could not create framebuffer");if(S===null)throw new Error("Could not create texture");if(h.length===0)return{width:c,height:p,framebuffer:A,texture:S};const E=lr();h.forEach(function(m,I,v){cr(E,m.extent)});let R,g,_;const x=1/n;{if(R=r.createTexture(),S===null)throw new Error("Could not create texture");g=Math.round(le(E)*x),_=Math.round(Ee(E)*x);const m=r.getParameter(r.MAX_TEXTURE_SIZE),I=Math.max(g,_),v=I>m?m/I:1,G=Math.round(g*v),B=Math.round(_*v);r.bindTexture(r.TEXTURE_2D,R),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),T?(r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.LINEAR)):(r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.NEAREST),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.NEAREST)),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,G,B,0,r.RGBA,f,null);const N=r.createFramebuffer();r.bindFramebuffer(r.FRAMEBUFFER,N),r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,R,0);const $=new Jr(r);h.forEach(function(D,j,X){const O=(D.extent[0]-E[0])*x*v,w=-(D.extent[3]-E[3])*x*v,W=le(D.extent)*x*v,M=Ee(D.extent)*x*v;if(r.bindFramebuffer(r.FRAMEBUFFER,N),r.viewport(0,0,G,B),D.clipExtent){const z=(D.clipExtent[0]-E[0])*x*v,Y=-(D.clipExtent[3]-E[3])*x*v,K=le(D.clipExtent)*x*v,oe=Ee(D.clipExtent)*x*v;r.enable(r.SCISSOR_TEST),r.scissor(T?z:Math.round(z),T?Y:Math.round(Y),T?K:Math.round(z+K)-Math.round(z),T?oe:Math.round(Y+oe)-Math.round(Y))}$.drawImage(D.texture,D.width,D.height,l,l,D.width-2*l,D.height-2*l,T?O:Math.round(O),T?w:Math.round(w),T?W:Math.round(O+W)-Math.round(O),T?M:Math.round(w+M)-Math.round(w),G,B),r.disable(r.SCISSOR_TEST)}),r.deleteFramebuffer(N)}const y=Be(o),P=Be(E),U=m=>{const I=(m[0][0]-y[0])/s*i,v=-(m[0][1]-y[1])/s*i,G=(m[1][0]-y[0])/s*i,B=-(m[1][1]-y[1])/s*i,N=(m[2][0]-y[0])/s*i,$=-(m[2][1]-y[1])/s*i;return{u1:G,v1:B,u0:I,v0:v,u2:N,v2:$}};r.bindFramebuffer(r.FRAMEBUFFER,A),r.viewport(0,0,c,p);{const m=[],I=[],v=ye(r,ri,ti);r.useProgram(v);const G=r.getUniformLocation(v,"u_texture");r.bindTexture(r.TEXTURE_2D,R),r.uniform1i(G,0),a.getTriangles().forEach(function(O,w,W){const M=O.source,z=O.target,{u1:Y,v1:K,u0:oe,v0:Rt,u2:gt,v2:pt}=U(z),xt=(M[0][0]-P[0])/n/g,mt=-(M[0][1]-P[1])/n/_,At=(M[1][0]-P[0])/n/g,bt=-(M[1][1]-P[1])/n/_,Lt=(M[2][0]-P[0])/n/g,St=-(M[2][1]-P[1])/n/_;m.push(Y,K,oe,Rt,gt,pt),I.push(At,bt,xt,mt,Lt,St)});const B=Le(0,c,p,0,-1,1),N=r.getUniformLocation(v,"u_matrix");r.uniformMatrix4fv(N,!1,B);const $=r.getAttribLocation(v,"a_position"),D=r.createBuffer();r.bindBuffer(r.ARRAY_BUFFER,D),r.bufferData(r.ARRAY_BUFFER,new Float32Array(m),r.STATIC_DRAW),r.vertexAttribPointer($,2,r.FLOAT,!1,0,0),r.enableVertexAttribArray($);const j=r.getAttribLocation(v,"a_texcoord"),X=r.createBuffer();r.bindBuffer(r.ARRAY_BUFFER,X),r.bufferData(r.ARRAY_BUFFER,new Float32Array(I),r.STATIC_DRAW),r.vertexAttribPointer(j,2,r.FLOAT,!1,0,0),r.enableVertexAttribArray(j),r.drawArrays(r.TRIANGLES,0,m.length/2)}if(u){const m=ye(r,ei,Qr);r.useProgram(m);const I=Le(0,c,p,0,-1,1),v=r.getUniformLocation(m,"u_matrix");r.uniformMatrix4fv(v,!1,I);const G=Array.isArray(u)?u:[0,0,0,255],B=r.getUniformLocation(m,"u_val");r.uniform4fv(B,G);const N=r.getAttribLocation(m,"a_position"),$=r.createBuffer();r.bindBuffer(r.ARRAY_BUFFER,$),r.vertexAttribPointer(N,2,r.FLOAT,!1,0,0),r.enableVertexAttribArray(N);const D=a.getTriangles().reduce(function(j,X){const O=X.target,{u1:w,v1:W,u0:M,v0:z,u2:Y,v2:K}=U(O);return j.concat([w,W,M,z,M,z,Y,K,Y,K,w,W])},[]);r.bufferData(r.ARRAY_BUFFER,new Float32Array(D),r.STATIC_DRAW),r.drawArrays(r.LINES,0,D.length/2)}return{width:c,height:p,framebuffer:A,texture:S}}class oi extends Ce{constructor(e){super({tileCoord:e.tileCoord,loader:()=>Promise.resolve(new Uint8ClampedArray(4)),interpolate:e.interpolate,transition:e.transition}),this.renderEdges_=e.renderEdges!==void 0?e.renderEdges:!1,this.pixelRatio_=e.pixelRatio,this.gutter_=e.gutter,this.reprojData_=null,this.reprojError_=null,this.reprojSize_=void 0,this.sourceTileGrid_=e.sourceTileGrid,this.targetTileGrid_=e.targetTileGrid,this.wrappedTileCoord_=e.wrappedTileCoord||e.tileCoord,this.sourceTiles_=[],this.sourcesListenerKeys_=null,this.sourceZ_=0;const t=e.sourceProj,i=t.getExtent(),n=e.sourceTileGrid.getExtent();this.clipExtent_=t.canWrapX()?n?k(i,n):i:n;const s=this.targetTileGrid_.getTileCoordExtent(this.wrappedTileCoord_),o=this.targetTileGrid_.getExtent();let a=this.sourceTileGrid_.getExtent();const h=o?k(s,o):s;if(we(h)===0){this.state=F.EMPTY;return}i&&(a?a=k(a,i):a=i);const l=this.targetTileGrid_.getResolution(this.wrappedTileCoord_[0]),f=e.targetProj,u=Yt(t,f,h,l);if(!isFinite(u)||u<=0){this.state=F.EMPTY;return}const T=e.errorThreshold!==void 0?e.errorThreshold:Vt;if(this.triangulation_=new Kt(t,f,h,a,u*T,l,e.transformMatrix),this.triangulation_.getTriangles().length===0){this.state=F.EMPTY;return}this.sourceZ_=this.sourceTileGrid_.getZForResolution(u);let d=this.triangulation_.calculateSourceExtent();if(a&&(t.canWrapX()?(d[1]=$e(d[1],a[1],a[3]),d[3]=$e(d[3],a[1],a[3])):d=k(d,a)),!we(d))this.state=F.EMPTY;else{let c=0,p=0;t.canWrapX()&&(c=le(i),p=Math.floor((d[0]-i[0])/c)),hr(d.slice(),t,!0).forEach(S=>{const E=this.sourceTileGrid_.getTileRangeForExtentAndZ(S,this.sourceZ_),R=e.getTileFunction;for(let g=E.minX;g<=E.maxX;g++)for(let _=E.minY;_<=E.maxY;_++){const x=R(this.sourceZ_,g,_,this.pixelRatio_);if(x){const y=p*c;this.sourceTiles_.push({tile:x,offset:y})}}++p}),this.sourceTiles_.length===0&&(this.state=F.EMPTY)}}getSize(){return this.reprojSize_}getData(){return this.reprojData_}getError(){return this.reprojError_}reproject_(){const e=[];let t=!1;if(this.sourceTiles_.forEach(g=>{var w;const _=g.tile;if(!_||_.getState()!==F.LOADED)return;const x=_.getSize(),y=this.gutter_;let P;const U=xe(_.getData());U?P=U:(t=!0,P=Wt(me(_.getData())));const m=[x[0]+2*y,x[1]+2*y],I=P instanceof Float32Array,v=m[0]*m[1],G=I?Float32Array:Uint8ClampedArray,B=new G(P.buffer),N=G.BYTES_PER_ELEMENT,$=N*B.length/v,D=B.byteLength/m[1],j=Math.floor(D/N/m[0]),X=this.sourceTileGrid_.getTileCoordExtent(_.tileCoord);X[0]+=g.offset,X[2]+=g.offset;const O=(w=this.clipExtent_)==null?void 0:w.slice();O&&(O[0]+=g.offset,O[2]+=g.offset),e.push({extent:X,clipExtent:O,data:B,dataType:G,bytesPerPixel:$,pixelSize:m,bandCount:j})}),this.sourceTiles_.length=0,e.length===0){this.state=F.ERROR,this.changed();return}const i=this.wrappedTileCoord_[0],n=this.targetTileGrid_.getTileSize(i),s=typeof n=="number"?n:n[0],o=typeof n=="number"?n:n[1],a=Math.round(s*this.pixelRatio_),h=Math.round(o*this.pixelRatio_),l=this.targetTileGrid_.getResolution(i),f=this.sourceTileGrid_.getResolution(this.sourceZ_),u=this.targetTileGrid_.getTileCoordExtent(this.wrappedTileCoord_),T=e[0].bandCount,d=new e[0].dataType(T*a*h),c=ii(a,h,Qe,{premultipliedAlpha:!1,antialias:!1});let p;const A=c.RGBA;let S;e[0].dataType==Float32Array?(S=c.FLOAT,c.getExtension("WEBGL_color_buffer_float"),c.getExtension("OES_texture_float"),c.getExtension("EXT_float_blend"),p=c.getExtension("OES_texture_float_linear")!==null&&this.interpolate):(S=c.UNSIGNED_BYTE,p=this.interpolate);const E=4,R=Math.ceil(T/E);for(let g=R-1;g>=0;--g){const _=[];for(let G=0,B=e.length;G<B;++G){const N=e[G],$=N.pixelSize,D=$[0],j=$[1],X=new N.dataType(E*D*j),O=N.data;let w=g*E;for(let M=0,z=X.length;M<z;M+=E)X[M]=O[w],X[M+1]=O[w+1],X[M+2]=O[w+2],X[M+3]=O[w+3],w+=T;const W=c.createTexture();c.bindTexture(c.TEXTURE_2D,W),p?(c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.LINEAR),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.LINEAR)):(c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.NEAREST),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.NEAREST)),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,c.CLAMP_TO_EDGE),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,c.CLAMP_TO_EDGE),c.texImage2D(c.TEXTURE_2D,0,A,D,j,0,A,S,X),_.push({extent:N.extent,clipExtent:N.clipExtent,texture:W,width:D,height:j})}const{framebuffer:x,width:y,height:P}=si(c,s,o,this.pixelRatio_,f,l,u,this.triangulation_,_,this.gutter_,S,this.renderEdges_,p),U=y,m=P*E,I=new e[0].dataType(U*m);c.bindFramebuffer(c.FRAMEBUFFER,x),c.readPixels(0,0,y,P,c.RGBA,S,I);let v=g*E;for(let G=0,B=I.length;G<B;G+=E){const N=(U-1-(G/m|0))*m+G%m;d[v]=I[N],d[v+1]=I[N+1],d[v+2]=I[N+2],d[v+3]=I[N+3],v+=T}}if(ni(c),Qe.push(c.canvas),t){const g=rt(s,o),_=new ImageData(d,s);g.putImageData(_,0,0),this.reprojData_=g.canvas}else this.reprojData_=d;this.reprojSize_=[a,h],this.state=F.LOADED,this.changed()}load(){if(this.state!==F.IDLE&&this.state!==F.ERROR)return;this.state=F.LOADING,this.changed();let e=0;this.sourcesListenerKeys_=[],this.sourceTiles_.forEach(({tile:t})=>{const i=t.getState();if(i!==F.IDLE&&i!==F.LOADING)return;e++;const n=ur(t,re.CHANGE,()=>{const s=t.getState();(s==F.LOADED||s==F.ERROR||s==F.EMPTY)&&(Xe(n),e--,e===0&&(this.unlistenSources_(),this.reproject_()))});this.sourcesListenerKeys_.push(n)}),e===0?setTimeout(this.reproject_.bind(this),0):this.sourceTiles_.forEach(function({tile:t}){t.getState()==F.IDLE&&t.load()})}unlistenSources_(){this.sourcesListenerKeys_.forEach(Xe),this.sourcesListenerKeys_=null}}class ui extends Zt{constructor(e){const t=e.projection===void 0?"EPSG:3857":e.projection;let i=e.tileGrid;i===void 0&&t&&(i=kt({extent:qt(t),maxResolution:e.maxResolution,maxZoom:e.maxZoom,minZoom:e.minZoom,tileSize:e.tileSize})),super({cacheSize:.1,attributions:e.attributions,attributionsCollapsible:e.attributionsCollapsible,projection:t,tileGrid:i,state:e.state,wrapX:e.wrapX,transition:e.transition,interpolate:e.interpolate,key:e.key,zDirection:e.zDirection}),this.gutter_=e.gutter!==void 0?e.gutter:0,this.tileSize_=e.tileSize?q(e.tileSize):null,this.tileSizes_=null,this.tileLoadingKeys_={},this.loader_=e.loader,this.handleTileChange_=this.handleTileChange_.bind(this),this.bandCount=e.bandCount===void 0?4:e.bandCount,this.tileGridForProjection_={},this.crossOrigin_=e.crossOrigin||"anonymous",this.transformMatrix=null}setTileSizes(e){this.tileSizes_=e}getTileSize(e){if(this.tileSizes_)return this.tileSizes_[e];if(this.tileSize_)return this.tileSize_;const t=this.getTileGrid();return t?q(t.getTileSize(e)):[256,256]}getGutterForProjection(e){const t=this.getProjection();return(!t||Te(t,e))&&!this.transformMatrix?this.gutter_:0}setLoader(e){this.loader_=e}getReprojTile_(e,t,i,n,s,o){const a=this.tileGrid||this.getTileGridForProjection(s||n),h=Math.max.apply(null,a.getResolutions().map((c,p)=>{const A=q(a.getTileSize(p)),S=this.getTileSize(p);return Math.max(S[0]/A[0],S[1]/A[1])})),l=this.getTileGridForProjection(n),f=[e,t,i],u=this.getTileCoordForTileUrlFunction(f,n),T=Object.assign({sourceProj:s||n,sourceTileGrid:a,targetProj:n,targetTileGrid:l,tileCoord:f,wrappedTileCoord:u,pixelRatio:h,gutter:this.gutter_,getTileFunction:(c,p,A,S)=>this.getTile(c,p,A,S,void 0,o),transformMatrix:this.transformMatrix},this.tileOptions),d=new oi(T);return d.key=this.getKey(),d}getTile(e,t,i,n,s,o){var x;const a=this.getProjection();if(s&&(a&&!Te(a,s)||this.transformMatrix))return this.getReprojTile_(e,t,i,s,a,o);const h=this.getTileSize(e),l=this.loader_,f=new AbortController,u={signal:f.signal,crossOrigin:this.crossOrigin_},T=this.getTileCoordForTileUrlFunction([e,t,i]);if(!T)return null;const d=this.getKey(),c=Jt(this,d,e,t,i);if(o&&o.containsKey(c))return o.get(c);const p=T[0],A=T[1],S=T[2],E=(x=this.getTileGrid())==null?void 0:x.getFullTileRange(p);E&&(u.maxY=E.getHeight()-1);function R(){return fr(function(){return l(p,A,S,u)})}const g=Object.assign({tileCoord:[e,t,i],loader:R,size:h,controller:f},this.tileOptions),_=new Ce(g);return _.key=this.getKey(),_.addEventListener(re.CHANGE,this.handleTileChange_),o==null||o.set(c,_),_}handleTileChange_(e){const t=e.target,i=H(t),n=t.getState();let s;n==F.LOADING?(this.tileLoadingKeys_[i]=!0,s=_e.TILELOADSTART):i in this.tileLoadingKeys_&&(delete this.tileLoadingKeys_[i],s=n==F.ERROR?_e.TILELOADERROR:n==F.LOADED?_e.TILELOADEND:void 0),s&&this.dispatchEvent(new Qt(s,t))}getTileGridForProjection(e){const t=this.getProjection();if(this.tileGrid&&(!t||Te(t,e))&&!this.transformMatrix)return this.tileGrid;const i=H(e);return i in this.tileGridForProjection_||(this.tileGridForProjection_[i]=er(e)),this.tileGridForProjection_[i]}setTileGridForProjection(e,t){const i=ot(e);if(i){const n=H(i);n in this.tileGridForProjection_||(this.tileGridForProjection_[n]=t)}}}export{ui as D,Kr as W,Zr as a,li as c};

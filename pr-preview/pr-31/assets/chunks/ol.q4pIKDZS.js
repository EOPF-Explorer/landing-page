const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/chunks/blosc.nNxqTOai.js","assets/chunks/chunk-INHXZS53.D3tQiqtZ.js","assets/chunks/lz4.COuoZ_ur.js","assets/chunks/zstd.CtzXwP91.js"])))=>i.map(i=>d[i]);
var ce=Object.defineProperty;var $t=e=>{throw TypeError(e)};var le=(e,t,n)=>t in e?ce(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var p=(e,t,n)=>le(e,typeof t!="symbol"?t+"":t,n),ht=(e,t,n)=>t.has(e)||$t("Cannot "+n);var _=(e,t,n)=>(ht(e,t,"read from private field"),n?n.call(e):t.get(e)),v=(e,t,n)=>t.has(e)?$t("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,n),w=(e,t,n,r)=>(ht(e,t,"write to private field"),r?r.call(e,n):t.set(e,n),n),ft=(e,t,n)=>(ht(e,t,"access private method"),n);import{j as ue,k as de}from"./Group.BuEEX7y8.js";import{x as yt,y as xt,D as he,z as fe,A as _e,B as ge,X as ye,C as pe,E as me}from"./XYZ.DipmalTG.js";import{a5 as _t}from"./framework.B-R8Tucm.js";function te(e,t,n,r={}){return t!==void 0&&n!==void 0&&(r={...r,headers:{...r.headers,Range:`bytes=${t}-${t+n-1}`}}),fetch(e,r)}function be(e,t){return{...e,...t,headers:{...e.headers,...t.headers}}}function Bt(e,t){const n=typeof e=="string"?new URL(e):e;n.pathname.endsWith("/")||(n.pathname+="/");const r=new URL(t.slice(1),n);return r.search=n.search,r}async function Gt(e){if(e.status!==404){if(e.status===200||e.status===206)return new Uint8Array(await e.arrayBuffer());throw new Error(`Unexpected response status ${e.status} ${e.statusText}`)}}async function we(e,t,n,r){if(r)return fetch(e,{...n,headers:{...n.headers,Range:`bytes=-${t}`}});let i=await fetch(e,{...n,method:"HEAD"});if(!i.ok)return i;let s=i.headers.get("Content-Length"),o=Number(s);return te(e,o-t,o,n)}var P,D,Y,pt;class ke{constructor(t,n={}){v(this,Y);p(this,"url");v(this,P);v(this,D);this.url=t,w(this,P,n.overrides??{}),w(this,D,n.useSuffixRequest??!1)}async get(t,n={}){let r=Bt(this.url,t).href,i=await fetch(r,ft(this,Y,pt).call(this,n));return Gt(i)}async getRange(t,n,r={}){let i=Bt(this.url,t),s=ft(this,Y,pt).call(this,r),o;return"suffixLength"in n?o=await we(i,n.suffixLength,s,_(this,D)):o=await te(i,n.offset,n.length,s),Gt(o)}}P=new WeakMap,D=new WeakMap,Y=new WeakSet,pt=function(t){return be(_(this,P),t)};var R;class ee{constructor(t,n,r){v(this,R);typeof t=="number"?w(this,R,new Uint8Array(t)):t instanceof ArrayBuffer?w(this,R,new Uint8Array(t,n,r)):w(this,R,new Uint8Array(Array.from(t,i=>i?1:0)))}get BYTES_PER_ELEMENT(){return 1}get byteOffset(){return _(this,R).byteOffset}get byteLength(){return _(this,R).byteLength}get buffer(){return _(this,R).buffer}get length(){return _(this,R).length}get(t){let n=_(this,R)[t];return typeof n=="number"?n!==0:n}set(t,n){_(this,R)[t]=n?1:0}fill(t){_(this,R).fill(t?1:0)}*[Symbol.iterator](){for(let t=0;t<this.length;t++)yield this.get(t)}}R=new WeakMap;var j;class vt{constructor(t,n,r,i){p(this,"_data");p(this,"chars");v(this,j);if(this.chars=t,w(this,j,new TextEncoder),typeof n=="number")this._data=new Uint8Array(n*t);else if(n instanceof ArrayBuffer)i&&(i=i*t),this._data=new Uint8Array(n,r,i);else{let s=Array.from(n);this._data=new Uint8Array(s.length*t);for(let o=0;o<s.length;o++)this.set(o,s[o])}}get BYTES_PER_ELEMENT(){return this.chars}get byteOffset(){return this._data.byteOffset}get byteLength(){return this._data.byteLength}get buffer(){return this._data.buffer}get length(){return this.byteLength/this.BYTES_PER_ELEMENT}get(t){const n=new Uint8Array(this.buffer,this.byteOffset+this.chars*t,this.chars);return new TextDecoder().decode(n).replace(/\x00/g,"")}set(t,n){const r=new Uint8Array(this.buffer,this.byteOffset+this.chars*t,this.chars);r.fill(0),r.set(_(this,j).encode(n))}fill(t){const n=_(this,j).encode(t);for(let r=0;r<this.length;r++)this._data.set(n,r*this.chars)}*[Symbol.iterator](){for(let t=0;t<this.length;t++)yield this.get(t)}}j=new WeakMap;var I;const Lt=class Lt{constructor(t,n,r,i){v(this,I);p(this,"chars");if(this.chars=t,typeof n=="number")w(this,I,new Int32Array(n*t));else if(n instanceof ArrayBuffer)i&&(i*=t),w(this,I,new Int32Array(n,r,i));else{const s=n,o=new Lt(t,1);w(this,I,new Int32Array(function*(){for(let a of s)o.set(0,a),yield*_(o,I)}()))}}get BYTES_PER_ELEMENT(){return _(this,I).BYTES_PER_ELEMENT*this.chars}get byteLength(){return _(this,I).byteLength}get byteOffset(){return _(this,I).byteOffset}get buffer(){return _(this,I).buffer}get length(){return _(this,I).length/this.chars}get(t){const n=this.chars*t;let r="";for(let i=0;i<this.chars;i++)r+=String.fromCodePoint(_(this,I)[n+i]);return r.replace(/\u0000/g,"")}set(t,n){const r=this.chars*t,i=_(this,I).subarray(r,r+this.chars);i.fill(0);for(let s=0;s<this.chars;s++)i[s]=n.codePointAt(s)??0}fill(t){this.set(0,t);let n=_(this,I).subarray(0,this.chars);for(let r=1;r<this.length;r++)_(this,I).set(n,r*this.chars)}*[Symbol.iterator](){for(let t=0;t<this.length;t++)yield this.get(t)}};I=new WeakMap;let F=Lt;function tt(e){const t=new TextDecoder().decode(e);return JSON.parse(t)}function Ft(e,t){const n=t/2,r=t-1;let i=0;for(let s=0;s<e.length;s+=t)for(let o=0;o<n;o+=1)i=e[s+o],e[s+o]=e[s+r-o],e[s+r-o]=i}function ne(e){if(e==="v2:object")return globalThis.Array;let t=e.match(/v2:([US])(\d+)/);if(t){let[,r,i]=t;return(r==="U"?F:vt).bind(null,Number(i))}let n={int8:Int8Array,int16:Int16Array,int32:Int32Array,int64:globalThis.BigInt64Array,uint8:Uint8Array,uint16:Uint16Array,uint32:Uint32Array,uint64:globalThis.BigUint64Array,float16:globalThis.Float16Array,float32:Float32Array,float64:Float64Array,bool:ee}[e];return T(n,`Unknown or unsupported data_type: ${e}`),n}function z(e,t){const n=e.length;typeof t=="string"&&(t=t==="C"?Array.from({length:n},(s,o)=>o):Array.from({length:n},(s,o)=>n-1-o)),T(n===t.length,"Order length must match the number of dimensions.");let r=1,i=new Array(n);for(let s=t.length-1;s>=0;s--)i[t[s]]=r,r*=e[t[s]];return i}function Ee({name:e,configuration:t}){if(e==="default"){const n=(t==null?void 0:t.separator)??"/";return r=>["c",...r].join(n)}if(e==="v2"){const n=(t==null?void 0:t.separator)??".";return r=>r.join(n)||"0"}throw new Error(`Unknown chunk key encoding: ${e}`)}function xe(e){if(e==="|O")return{data_type:"v2:object"};let t=e.match(/^([<|>])(.*)$/);T(t,`Invalid dtype: ${e}`);let[,n,r]=t,i={b1:"bool",i1:"int8",u1:"uint8",i2:"int16",u2:"uint16",i4:"int32",u4:"uint32",i8:"int64",u8:"uint64",f2:"float16",f4:"float32",f8:"float64"}[r]??(r.startsWith("S")||r.startsWith("U")?`v2:${r}`:void 0);return T(i,`Unsupported or unknown dtype: ${e}`),n==="|"?{data_type:i}:{data_type:i,endian:n==="<"?"little":"big"}}function ve(e,t={}){let n=[],r=xe(e.dtype);e.order==="F"&&n.push({name:"transpose",configuration:{order:"F"}}),"endian"in r&&r.endian==="big"&&n.push({name:"bytes",configuration:{endian:"big"}});for(let{id:i,...s}of e.filters??[])n.push({name:i,configuration:s});if(e.compressor){let{id:i,...s}=e.compressor;n.push({name:i,configuration:s})}return{zarr_format:3,node_type:"array",shape:e.shape,data_type:r.data_type,chunk_grid:{name:"regular",configuration:{chunk_shape:e.chunks}},chunk_key_encoding:{name:"v2",configuration:{separator:e.dimension_separator??"."}},codecs:n,fill_value:e.fill_value,attributes:t}}function Ae(e,t={}){return{zarr_format:3,node_type:"group",attributes:t}}function Te(e,t){if(t!=="number"&&t!=="bigint"&&t!=="boolean"&&t!=="object"&&t!=="string")return e===t;let n=e==="bool";if(t==="boolean")return n;let r=e.startsWith("v2:U")||e.startsWith("v2:S");if(t==="string")return r;let i=e==="int64"||e==="uint64";if(t==="bigint")return i;let s=e==="v2:object";return t==="object"?s:!r&&!i&&!n&&!s}function Ie(e){return(e==null?void 0:e.name)==="sharding_indexed"}function re(e){return(e.data_type==="uint64"||e.data_type==="int64")&&e.fill_value!=null?BigInt(e.fill_value):e.fill_value}function ie(e,...t){if(!t.some(n=>e instanceof n))throw e}function T(e,t=""){if(!e)throw new Error(t)}async function se(e,{format:t,signal:n}){const r=e instanceof Response?e:new Response(e);T(r.body,"Response does not contain body.");try{return await new Response(r.body.pipeThrough(new DecompressionStream(t),{signal:n})).arrayBuffer()}catch{throw n==null||n.throwIfAborted(),new Error(`Failed to decode ${t}`)}}class At{constructor(t,n){p(this,"kind","array_to_array");T(t.keepbits>=0,"keepbits must be zero or positive")}static fromConfig(t,n){return new At(t,n)}encode(t){throw new Error("`BitroundCodec.encode` is not implemented. Please open an issue at https://github.com/manzt/zarrita.js/issues.")}decode(t){return t}}const Pt=Re();function Re(){const e=new Uint32Array([305419896]);return new Uint8Array(e.buffer,e.byteOffset,e.byteLength)[0]!==18}function Dt(e){return"BYTES_PER_ELEMENT"in e?e.BYTES_PER_ELEMENT:4}var W,L,V,J,U;const Mt=class Mt{constructor(t,n){p(this,"kind","array_to_bytes");v(this,W);v(this,L);v(this,V);v(this,J);v(this,U);w(this,U,t==null?void 0:t.endian),w(this,L,ne(n.data_type)),w(this,J,n.shape),w(this,W,z(n.shape,"C"));const r=new(_(this,L))(0);w(this,V,r.BYTES_PER_ELEMENT)}static fromConfig(t,n){return new Mt(t,n)}encode(t){let n=new Uint8Array(t.data.buffer);return Pt&&_(this,U)==="big"&&Ft(n,Dt(_(this,L))),n}decode(t){return Pt&&_(this,U)==="big"&&Ft(t,Dt(_(this,L))),{data:new(_(this,L))(t.buffer,t.byteOffset,t.byteLength/_(this,V)),shape:_(this,J),stride:_(this,W)}}};W=new WeakMap,L=new WeakMap,V=new WeakMap,J=new WeakMap,U=new WeakMap;let st=Mt;class Tt{constructor(){p(this,"kind","bytes_to_bytes")}static fromConfig(){return new Tt}encode(t){throw new Error("Not implemented")}decode(t){return new Uint8Array(t.buffer,t.byteOffset,t.byteLength-4)}}class It{constructor(){p(this,"kind","bytes_to_bytes")}static fromConfig(t){return new It}encode(t){throw new Error("Gzip encoding is not enabled by default. Please register a custom codec with `numcodecs/gzip`.")}async decode(t){const n=await se(t,{format:"gzip"});return new Uint8Array(n)}}function Oe(e,t){return T(!Number.isNaN(t),"JsonCodec allow_nan is false but NaN was encountered during encoding."),T(t!==Number.POSITIVE_INFINITY,"JsonCodec allow_nan is false but Infinity was encountered during encoding."),T(t!==Number.NEGATIVE_INFINITY,"JsonCodec allow_nan is false but -Infinity was encountered during encoding."),t}function Ce(e,t){return t instanceof Object&&!Array.isArray(t)?Object.keys(t).sort().reduce((n,r)=>(n[r]=t[r],n),{}):t}var X,Z;const zt=class zt{constructor(t={}){p(this,"configuration");p(this,"kind","array_to_bytes");v(this,X);v(this,Z);this.configuration=t;const{encoding:n="utf-8",skipkeys:r=!1,ensure_ascii:i=!0,check_circular:s=!0,allow_nan:o=!0,sort_keys:a=!0,indent:c,strict:u=!0}=t;let l=t.separators;l||(c?l=[", ",": "]:l=[",",":"]),w(this,X,{encoding:n,skipkeys:r,ensure_ascii:i,check_circular:s,allow_nan:o,indent:c,separators:l,sort_keys:a}),w(this,Z,{strict:u})}static fromConfig(t){return new zt(t)}encode(t){const{indent:n,encoding:r,ensure_ascii:i,check_circular:s,allow_nan:o,sort_keys:a}=_(this,X);T(r==="utf-8","JsonCodec does not yet support non-utf-8 encoding.");const c=[];T(s,"JsonCodec does not yet support skipping the check for circular references during encoding."),o||c.push(Oe),a&&c.push(Ce);const u=Array.from(t.data);u.push("|O"),u.push(t.shape);let l;c.length&&(l=(h,g)=>{let b=g;for(let m of c)b=m(h,b);return b});let d=JSON.stringify(u,l,n);return i&&(d=d.replace(/[\u007F-\uFFFF]/g,h=>{const g=`0000${h.charCodeAt(0).toString(16)}`;return`\\u${g.substring(g.length-4)}`})),new TextEncoder().encode(d)}decode(t){const{strict:n}=_(this,Z);T(n,"JsonCodec does not yet support non-strict decoding.");const r=tt(t),i=r.pop();r.pop(),T(i,"0D not implemented for JsonCodec.");const s=z(i,"C");return{data:r,shape:i,stride:s}}};X=new WeakMap,Z=new WeakMap;let mt=zt;function Yt(e){return e instanceof ee||e instanceof vt||e instanceof F?new Proxy(e,{get(n,r){return n.get(Number(r))},set(n,r,i){return n.set(Number(r),i),!0}}):e}function Ne(e,t){let n;return e.data instanceof vt||e.data instanceof F?n=new e.constructor(e.data.length,e.data.chars):n=new e.constructor(e.data.length),{data:n,shape:e.shape,stride:z(e.shape,t)}}function Se(e,t){let n=Ne(e,t),r=e.shape.length,i=e.data.length,s=Array(r).fill(0),o=Yt(e.data),a=Yt(n.data);for(let c=0;c<i;c++){let u=0;for(let l=0;l<r;l++)u+=s[l]*n.stride[l];a[u]=o[c],s[0]+=1;for(let l=0;l<r;l++)if(s[l]===e.shape[l]){if(l+1===r)break;s[l]=0,s[l+1]+=1}}return n}function Le(e){let t=e.shape.length;return T(t===e.stride.length,"Shape and stride must have the same length."),e.stride.map((n,r)=>({stride:n,index:r})).sort((n,r)=>r.stride-n.stride).map(n=>n.index)}function Me(e,t){let n=Le(e);return T(n.length===t.length,"Orders must match"),n.every((r,i)=>r===t[i])}var H,$;const jt=class jt{constructor(t,n){p(this,"kind","array_to_array");v(this,H);v(this,$);let r=t.order??"C",i=n.shape.length,s=new Array(i),o=new Array(i);if(r==="C")for(let a=0;a<i;++a)s[a]=a,o[a]=a;else if(r==="F")for(let a=0;a<i;++a)s[a]=i-a-1,o[a]=i-a-1;else s=r,s.forEach((a,c)=>{T(o[a]===void 0,`Invalid permutation: ${JSON.stringify(r)}`),o[a]=c});w(this,H,s),w(this,$,o)}static fromConfig(t,n){return new jt(t,n)}encode(t){return Me(t,_(this,$))?t:Se(t,_(this,$))}decode(t){return{data:t.data,shape:t.shape,stride:z(t.shape,_(this,H))}}};H=new WeakMap,$=new WeakMap;let bt=jt;var K,Q;const Ut=class Ut{constructor(t){p(this,"kind","array_to_bytes");v(this,K);v(this,Q);w(this,K,t),w(this,Q,z(t,"C"))}static fromConfig(t,n){return new Ut(n.shape)}encode(t){throw new Error("Method not implemented.")}decode(t){let n=new TextDecoder,r=new DataView(t.buffer),i=Array(r.getUint32(0,!0)),s=4;for(let o=0;o<i.length;o++){let a=r.getUint32(s,!0);s+=4,i[o]=n.decode(t.buffer.slice(s,s+a)),s+=a}return{data:i,shape:_(this,K),stride:_(this,Q)}}};K=new WeakMap,Q=new WeakMap;let wt=Ut;class Rt{constructor(){p(this,"kind","bytes_to_bytes")}static fromConfig(t){return new Rt}encode(t){throw new Error("Zlib encoding is not enabled by default. Please register a codec with `numcodecs/zlib`.")}async decode(t){const n=await se(t,{format:"deflate"});return new Uint8Array(n)}}function ze(){return new Map().set("blosc",()=>_t(()=>import("./blosc.nNxqTOai.js"),__vite__mapDeps([0,1])).then(e=>e.default)).set("lz4",()=>_t(()=>import("./lz4.COuoZ_ur.js"),__vite__mapDeps([2,1])).then(e=>e.default)).set("zstd",()=>_t(()=>import("./zstd.CtzXwP91.js"),__vite__mapDeps([3,1])).then(e=>e.default)).set("gzip",()=>It).set("zlib",()=>Rt).set("transpose",()=>bt).set("bytes",()=>st).set("crc32c",()=>Tt).set("vlen-utf8",()=>wt).set("json2",()=>mt).set("bitround",()=>At)}const je=ze();function kt(e){let t;return{async encode(n){t||(t=await Wt(e));for(const i of t.array_to_array)n=await i.encode(n);let r=await t.array_to_bytes.encode(n);for(const i of t.bytes_to_bytes)r=await i.encode(r);return r},async decode(n){t||(t=await Wt(e));for(let i=t.bytes_to_bytes.length-1;i>=0;i--)n=await t.bytes_to_bytes[i].decode(n);let r=await t.array_to_bytes.decode(n);for(let i=t.array_to_array.length-1;i>=0;i--)r=await t.array_to_array[i].decode(r);return r}}}async function Wt(e){let t=e.codecs.map(async s=>{var a;let o=await((a=je.get(s.name))==null?void 0:a());return T(o,`Unknown codec: ${s.name}`),{Codec:o,meta:s}}),n=[],r,i=[];for await(let{Codec:s,meta:o}of t){let a=s.fromConfig(o.configuration,e);switch(a.kind){case"array_to_array":n.push(a);break;case"array_to_bytes":r=a;break;default:i.push(a)}}return r||(T(Ue(e),`Cannot encode ${e.data_type} to bytes without a codec`),r=st.fromConfig({endian:"little"},e)),{array_to_array:n,array_to_bytes:r,bytes_to_bytes:i}}function Ue(e){return e.data_type!=="v2:object"}class et extends Error{constructor(t,n={}){super(`Node not found: ${t}`,n),this.name="NodeNotFoundError"}}class Ot extends Error{constructor(t){super(`Missing key: ${t}`),this.name="KeyError"}}const Vt=18446744073709551615n;function $e(e,t,n,r){T(e.store.getRange,"Store does not support range requests");let i=e.store.getRange.bind(e.store),s=t.map((c,u)=>c/r.chunk_shape[u]),o=kt({data_type:"uint64",shape:[...s,2],codecs:r.index_codecs}),a={};return async c=>{let u=c.map((x,f)=>Math.floor(x/s[f])),l=e.resolve(n(u)).path,d;if(l in a)d=a[l];else{let x=4,f=16*s.reduce((A,C)=>A*C,1),E=await i(l,{suffixLength:f+x});d=a[l]=E?await o.decode(E):null}if(d===null)return;let{data:h,shape:g,stride:b}=d,m=c.map((x,f)=>x%g[f]).reduce((x,f,E)=>x+f*b[E],0),k=h[m],y=h[m+1];if(!(k===Vt&&y===Vt))return i(l,{offset:Number(k),length:Number(y)})}}class B{constructor(t,n="/"){p(this,"store");p(this,"path");this.store=t,this.path=n}resolve(t){let n=new URL(`file://${this.path.endsWith("/")?this.path:`${this.path}/`}`);return new B(this.store,decodeURIComponent(new URL(t,n).pathname))}}var q;class Ct extends B{constructor(n,r,i){super(n,r);p(this,"kind","group");v(this,q);w(this,q,i)}get attrs(){return _(this,q).attributes}}q=new WeakMap;function Jt(e){var n;const t=e.find(r=>r.name==="transpose");return((n=t==null?void 0:t.configuration)==null?void 0:n.order)??"C"}const G=Symbol("zarrita.context");function Be(e){return e[G]}function Ge(e,t){let{configuration:n}=t.codecs.find(Ie)??{},r={encode_chunk_key:Ee(t.chunk_key_encoding),TypedArray:ne(t.data_type),fill_value:t.fill_value};if(n){let s=Jt(n.codecs);return{...r,kind:"sharded",chunk_shape:n.chunk_shape,codec:kt({data_type:t.data_type,shape:n.chunk_shape,codecs:n.codecs}),get_strides(o){return z(o,s)},get_chunk_bytes:$e(e,t.chunk_grid.configuration.chunk_shape,r.encode_chunk_key,n)}}let i=Jt(t.codecs);return{...r,kind:"regular",chunk_shape:t.chunk_grid.configuration.chunk_shape,codec:kt({data_type:t.data_type,shape:t.chunk_grid.configuration.chunk_shape,codecs:t.codecs}),get_strides(s){return z(s,i)},async get_chunk_bytes(s,o){let a=r.encode_chunk_key(s),c=e.resolve(a).path;return e.store.get(c,o)}}}var Kt,Qt,M,qt;let ot=(qt=class extends(Qt=B,Kt=G,Qt){constructor(n,r,i){super(n,r);p(this,"kind","array");v(this,M);p(this,Kt);w(this,M,{...i,fill_value:re(i)}),this[G]=Ge(this,i)}get attrs(){return _(this,M).attributes}get shape(){return _(this,M).shape}get chunks(){return this[G].chunk_shape}get dtype(){return _(this,M).data_type}async getChunk(n,r){let i=this[G],s=await i.get_chunk_bytes(n,r);if(!s){let o=i.chunk_shape.reduce((c,u)=>c*u,1),a=new i.TypedArray(o);return a.fill(i.fill_value),{data:a,shape:i.chunk_shape,stride:i.get_strides(i.chunk_shape)}}return i.codec.decode(s)}is(n){return Te(this.dtype,n)}},M=new WeakMap,qt);function*Fe(e,t,n=1){t===void 0&&(t=e,e=0);for(let r=e;r<t;r+=n)yield r}function*Pe(...e){if(e.length===0)return;const t=e.map(r=>r[Symbol.iterator]()),n=t.map(r=>r.next());if(n.some(r=>r.done))throw new Error("Input contains an empty iterator.");for(let r=0;;){if(n[r].done){if(t[r]=e[r][Symbol.iterator](),n[r]=t[r].next(),++r>=t.length)return}else yield n.map(({value:i})=>i),r=0;n[r]=t[r].next()}}function De({start:e,stop:t,step:n},r){if(n===0)throw new Error("slice step cannot be zero");n=n??1;const i=n<0,[s,o]=i?[-1,r-1]:[0,r];return e===null?e=i?o:s:e<0?(e+=r,e<s&&(e=s)):e>o&&(e=o),t===null?t=i?s:o:t<0?(t+=r,t<s&&(t=s)):t>o&&(t=o),[e,t,n]}function at(e,t,n=null){return t===void 0&&(t=e,e=null),{start:e,stop:t,step:n}}function Ye(){const e=[];return{add:t=>e.push(t()),onIdle:()=>Promise.all(e)}}class Nt extends Error{constructor(t){super(t),this.name="IndexError"}}function We(e,t){throw new Nt(`too many indicies for array; expected ${t.length}, got ${e.length}`)}function Ve(e){throw new Nt(`index out of bounds for dimension with length ${e}`)}function Je(){throw new Nt("only slices with step >= 1 are supported")}function Xe(e,t){e.length>t.length&&We(e,t)}function Ze(e,t){return e=Math.trunc(e),e<0&&(e=t+e),(e>=t||e<0)&&Ve(t),e}class He{constructor({dim_sel:t,dim_len:n,dim_chunk_len:r}){p(this,"dim_sel");p(this,"dim_len");p(this,"dim_chunk_len");p(this,"nitems");t=Ze(t,n),this.dim_sel=t,this.dim_len=n,this.dim_chunk_len=r,this.nitems=1}*[Symbol.iterator](){const t=Math.floor(this.dim_sel/this.dim_chunk_len),n=t*this.dim_chunk_len,r=this.dim_sel-n;yield{dim_chunk_ix:t,dim_chunk_sel:r}}}class Xt{constructor({dim_sel:t,dim_len:n,dim_chunk_len:r}){p(this,"start");p(this,"stop");p(this,"step");p(this,"dim_len");p(this,"dim_chunk_len");p(this,"nitems");p(this,"nchunks");const[i,s,o]=De(t,n);this.start=i,this.stop=s,this.step=o,this.step<1&&Je(),this.dim_len=n,this.dim_chunk_len=r,this.nitems=Math.max(0,Math.ceil((this.stop-this.start)/this.step)),this.nchunks=Math.ceil(this.dim_len/this.dim_chunk_len)}*[Symbol.iterator](){const t=Math.floor(this.start/this.dim_chunk_len),n=Math.ceil(this.stop/this.dim_chunk_len);for(const r of Fe(t,n)){const i=r*this.dim_chunk_len,s=Math.min(this.dim_len,(r+1)*this.dim_chunk_len),o=s-i;let a=0,c=0;if(this.start<i){const g=(i-this.start)%this.step;g&&(c+=this.step-g),a=Math.ceil((i-this.start)/this.step)}else c=this.start-i;const u=this.stop>s?o:this.stop-i,l=[c,u,this.step],d=Math.ceil((u-c)/this.step),h=[a,a+d,1];yield{dim_chunk_ix:r,dim_chunk_sel:l,dim_out_sel:h}}}}function Ke(e,t){let n=[];return e===null?n=t.map(r=>at(null)):Array.isArray(e)&&(n=e.map(r=>r??at(null))),Xe(n,t),n}class Qe{constructor({selection:t,shape:n,chunk_shape:r}){p(this,"dim_indexers");p(this,"shape");this.dim_indexers=Ke(t,n).map((i,s)=>new(typeof i=="number"?He:Xt)({dim_sel:i,dim_len:n[s],dim_chunk_len:r[s]})),this.shape=this.dim_indexers.filter(i=>i instanceof Xt).map(i=>i.nitems)}*[Symbol.iterator](){for(const t of Pe(...this.dim_indexers)){const n=t.map(i=>i.dim_chunk_ix),r=t.map(i=>"dim_out_sel"in i?{from:i.dim_chunk_sel,to:i.dim_out_sel}:{from:i.dim_chunk_sel,to:null});yield{chunk_coords:n,mapping:r}}}}function qe(e,t){return"get"in e?e.get(t):e[t]}async function tn(e,t,n,r){var c;let i=Be(e),s=new Qe({selection:t,shape:e.shape,chunk_shape:e.chunks}),o=r.prepare(new i.TypedArray(s.shape.reduce((u,l)=>u*l,1)),s.shape,i.get_strides(s.shape)),a=((c=n.create_queue)==null?void 0:c.call(n))??Ye();for(const{chunk_coords:u,mapping:l}of s)a.add(async()=>{let{data:d,shape:h,stride:g}=await e.getChunk(u,n.opts),b=r.prepare(d,h,g);r.set_from_chunk(o,b,l)});return await a.onIdle(),s.shape.length===0?qe(o.data,0):o}function St(e,t=0,n){let r=n??e.length-t;return{length:r,subarray(i,s=r){return St(e,t+i,s-i)},set(i,s=0){for(let o=0;o<i.length;o++)e[t+s+o]=i.get(o)},get(i){return e[t+i]}}}function gt(e){return globalThis.Array.isArray(e.data)?{data:St(e.data),stride:e.stride,bytes_per_element:1}:{data:new Uint8Array(e.data.buffer,e.data.byteOffset,e.data.byteLength),stride:e.stride,bytes_per_element:e.data.BYTES_PER_ELEMENT}}function en(e){return"chars"in e?e.constructor.bind(null,e.chars):e.constructor}function nn(e,t){if(globalThis.Array.isArray(e.data))return St([t]);let n=en(e.data),r=new n([t]);return new Uint8Array(r.buffer,r.byteOffset,r.byteLength)}const rn={prepare(e,t,n){return{data:e,shape:t,stride:n}},set_scalar(e,t,n){let r=gt(e);Et(r,t,nn(e,n),r.bytes_per_element)},set_from_chunk(e,t,n){let r=gt(e);it(r,gt(t),r.bytes_per_element,n)}};async function sn(e,t=null,n={}){return tn(e,t,n,rn)}function oe(e,t,n){return n<0&&t<e?Math.floor((e-t-1)/-n)+1:e<t?Math.floor((t-e-1)/n)+1:0}function Et(e,t,n,r){if(t.length===0){e.data.set(n,0);return}const[i,...s]=t,[o,...a]=e.stride;if(typeof i=="number"){const h=e.data.subarray(o*i*r);Et({data:h,stride:a},s,n,r);return}const[c,u,l]=i,d=oe(c,u,l);if(s.length===0){for(let h=0;h<d;h++)e.data.set(n,o*(c+l*h)*r);return}for(let h=0;h<d;h++){const g=e.data.subarray(o*(c+l*h)*r);Et({data:g,stride:a},s,n,r)}}function it(e,t,n,r){const[i,...s]=r,[o,...a]=e.stride,[c,...u]=t.stride;if(i.from===null){if(s.length===0){e.data.set(t.data.subarray(0,n),i.to*n);return}it({data:e.data.subarray(o*i.to*n),stride:a},t,n,s);return}if(i.to===null){if(s.length===0){let y=i.from*n;e.data.set(t.data.subarray(y,y+n),0);return}it(e,{data:t.data.subarray(c*i.from*n),stride:u},n,s);return}const[l,d,h]=i.to,[g,b,m]=i.from,k=oe(l,d,h);if(s.length===0){if(h===1&&m===1&&o===1&&c===1){let y=g*n,x=k*n;e.data.set(t.data.subarray(y,y+x),l*n);return}for(let y=0;y<k;y++){let x=c*(g+m*y)*n;e.data.set(t.data.subarray(x,x+n),o*(l+h*y)*n)}return}for(let y=0;y<k;y++)it({data:e.data.subarray(o*(l+y*h)*n),stride:a},{data:t.data.subarray(c*(g+y*m)*n),stride:u},n,s)}let ct=on();function on(){let e=new WeakMap;function t(n){let r=e.get(n)??{v2:0,v3:0};return e.set(n,r),r}return{increment(n,r){t(n)[r]+=1},version_max(n){let r=t(n);return r.v3>r.v2?"v3":"v2"}}}async function an(e){let t=await e.store.get(e.resolve(".zattrs").path);return t?tt(t):{}}async function cn(e,t={}){let n="store"in e?e:new B(e),r={};return(t.attrs??!0)&&(r=await an(n)),t.kind==="array"?Zt(n,r):t.kind==="group"?Ht(n,r):Zt(n,r).catch(i=>(ie(i,et),Ht(n,r)))}async function Zt(e,t){let{path:n}=e.resolve(".zarray"),r=await e.store.get(n);if(!r)throw new et("v2 array",{cause:new Ot(n)});return ct.increment(e.store,"v2"),new ot(e.store,e.path,ve(tt(r),t))}async function Ht(e,t){let{path:n}=e.resolve(".zgroup"),r=await e.store.get(n);if(!r)throw new et("v2 group",{cause:new Ot(n)});return ct.increment(e.store,"v2"),new Ct(e.store,e.path,Ae(tt(r),t))}async function ln(e){let{store:t,path:n}=e.resolve("zarr.json"),r=await e.store.get(n);if(!r)throw new et("v3 array or group",{cause:new Ot(n)});let i=tt(r);return i.node_type==="array"&&(i.fill_value=re(i)),i.node_type==="array"?new ot(t,e.path,i):new Ct(t,e.path,i)}async function un(e,t={}){let n="store"in e?e:new B(e),r=await ln(n);if(ct.increment(n.store,"v3"),t.kind===void 0||t.kind==="array"&&r instanceof ot||t.kind==="group"&&r instanceof Ct)return r;let i=r instanceof ot?"array":"group";throw new Error(`Expected node of kind ${t.kind}, found ${i}.`)}async function S(e,t={}){let n="store"in e?e.store:e,r=ct.version_max(n),i=r==="v2"?S.v2:S.v3,s=r==="v2"?S.v3:S.v2;return i(e,t).catch(o=>(ie(o,et),s(e,t)))}S.v2=cn;S.v3=un;function dn(e,t,n,r){let i=e.projection;if(!i&&(typeof t.crs=="string"?i=yt(t.crs):"uri"in t.crs&&(i=yt(t.crs.uri)),!i))throw new Error(`Unsupported CRS: ${JSON.stringify(t.crs)}`);const s=t.orderedAxes,a=!(s?s.slice(0,2).map(f=>f.replace(/E|X|Lon/i,"e").replace(/N|Y|Lat/i,"n")).join(""):i.getAxisOrientation()).startsWith("en"),c=t.tileMatrices.sort(function(f,E){return E.cellSize-f.cellSize}),u={};for(let f=0;f<c.length;++f){const E=c[f];u[E.id]=E}const l={},d=[];if(r)for(let f=0;f<r.length;++f){const E=r[f],A=E.tileMatrix,C=u[A],O=c.indexOf(C);d[O]=A,l[A]=E}else for(let f=0;f<c.length;++f){const E=c[f].id;d.push(E)}const h=d.length,g=new Array(h),b=new Array(h),m=new Array(h),k=new Array(h),y=[-1/0,-1/0,1/0,1/0];for(let f=0;f<h;++f){const E=d[f],A=u[E],C=A.pointOfOrigin;a?g[f]=[C[1],C[0]]:g[f]=C,b[f]=A.cellSize,m[f]=[A.matrixWidth,A.matrixHeight],k[f]=[A.tileWidth,A.tileHeight];const O=l[E];if(O){const N=A.cellSize*A.tileWidth,lt=g[f][0]+O.minTileCol*N,nt=g[f][0]+(O.maxTileCol+1)*N,rt=A.cellSize*A.tileHeight,ae=A.cornerOfOrigin==="bottomLeft";let ut,dt;ae?(ut=g[f][1]+O.minTileRow*rt,dt=g[f][1]+(O.maxTileRow+1)*rt):(ut=g[f][1]-(O.maxTileRow+1)*rt,dt=g[f][1]-O.minTileRow*rt),ue(y,[lt,ut,nt,dt],y)}}return{grid:new xt({origins:g,resolutions:b,sizes:m,tileSizes:k,extent:r?y:void 0,matrixIds:d}),projection:i}}const hn=["d35379db-88df-4056-af3a-620245f8e347","f17cb550-5864-4468-aeb7-f3180cfb622f","689b58e2-cf7b-45e0-9fff-9cfc0883d6b4"];class En extends he{constructor(t){super({state:"loading",tileGrid:null,projection:t.projection||null,transition:t.transition,wrapX:t.wrapX}),this.url_=t.url,this.group_=t.group,this.error_=null,this.root_=null,this.consolidatedMetadata_=null,this.bands_=t.bands,this.bandsByLevel_=null,this.fillValue_,this.resampleMethod_=t.resample||"linear",this.bandCount=this.bands_.length,this.setLoader(this.loadTile_.bind(this)),this.tileGrid,this.configure_().then(()=>{this.setState("ready")}).catch(n=>{this.error_=n,this.setState("error")})}async configure_(){const t=new ke(this.url_);this.root_=await S(t,{kind:"group"});try{this.consolidatedMetadata_=JSON.parse(new TextDecoder().decode(await t.get(this.root_.resolve("zarr.json").path))).consolidated_metadata.metadata}catch{}const r=(await S(this.root_.resolve(this.group_),{kind:"group"})).attrs;if("zarr_conventions"in r&&Array.isArray(r.zarr_conventions)&&hn.every(s=>r.zarr_conventions.find(o=>o.uuid===s))&&"layout"in r.multiscales){const{tileGrid:s,projection:o,bandsByLevel:a,fillValue:c}=fn(r,this.consolidatedMetadata_,this.group_,this.bands_);this.bandsByLevel_=a,this.tileGrid=s,this.projection=o,this.fillValue_=c}else if("tile_matrix_set"in r.multiscales){const{tileGrid:s,projection:o}=_n(r);this.tileGrid=s,this.projection=o}const i=this.tileGrid.getExtent();setTimeout(()=>{this.viewResolver({showFullExtent:!0,projection:this.projection,resolutions:this.tileGrid.getResolutions(),center:_e(de(i),this.projection),extent:fe(i,this.projection),zoom:1})})}async loadTile_(t,n,r,i){const s=this.tileGrid.getResolutions(),o=this.tileGrid.getResolution(t),a=this.tileGrid.getTileCoordExtent([t,n,r]),c=[],u=[];for(const g of this.bands_){let b,m,k=0;if(!this.bandsByLevel_)b=this.tileGrid.getMatrixId(t),m=o,k=t;else for(let N=0;N<s.length;N+=1){const lt=s[N];if(b&&lt<o)break;const nt=this.tileGrid.getMatrixId(N);this.bandsByLevel_[nt].includes(g)&&(b=nt,m=this.tileGrid.getResolution(N),k=N)}if(!b||!m)throw new Error(`Could not find available resolution for band ${g}`);const y=this.tileGrid.getOrigin(k),x=Math.round((a[0]-y[0])/m),f=Math.round((a[2]-y[0])/m),E=Math.round((y[1]-a[3])/m),A=Math.round((y[1]-a[1])/m),C=`${this.group_}/${b}/${g}`,O=await S(this.root_.resolve(C),{kind:"array"});c.push(sn(O,[at(E,A),at(x,f)])),u.push(m)}const l=await Promise.all(c),[d,h]=ge(this.tileGrid.getTileSize(t));return gn(l,u,d,h,o,this.resampleMethod_,this.fillValue_||0)}}function fn(e,t,n,r){const i=e.multiscales,s=e["spatial:bbox"],o=yt(e["proj:code"]),a=[],c=t?{}:null;let u;for(const d of i.layout){const h=d["spatial:transform"],g=h[0],b=[h[2],h[5]],m=d.asset;if(a.push({matrixId:m,resolution:g,origin:b}),t){const k=[];for(const y of r){const x=t[`${n}/${m}/${y}`];x&&(k.push(y),u===void 0&&(u=x.fill_value))}c[m]=k}}return a.sort((d,h)=>h.resolution-d.resolution),{tileGrid:new xt({extent:s,origins:a.map(d=>d.origin),resolutions:a.map(d=>d.resolution),matrixIds:a.map(d=>d.matrixId)}),projection:o,bandsByLevel:c,fillValue:u}}function _n(e){const t=e.multiscales,n=t.tile_matrix_set,r=t.tile_matrix_limits,i=n.tileMatrices.length,s=new Array(i);let o=!1;for(let u=0;u<i;u+=1){const l=n.tileMatrices[u],d=l.id;(l.tileWidth>512||l.tileHeight>512)&&(o=!0),s[u]=r[d]}const a=dn({},n,void 0,s);let c=a.grid;return o&&(c=new xt({tileSize:512,extent:c.getExtent(),origins:c.getOrigins(),resolutions:c.getResolutions(),matrixIds:c.getMatrixIds()})),{tileGrid:c,projection:a.projection}}function gn(e,t,n,r,i,s,o){const a=e.length,c=new Float32Array(n*r*a);for(let u=0;u<r;u++)for(let l=0;l<n;l++)for(let d=0;d<a;++d){const h=e[d],g=h.shape[0],b=h.shape[1],m=i/t[d];let k=o;if(m===1)u<g&&l<b&&(k=h.data[u*b+l]);else{const y=u*m,x=l*m;switch(s){case"nearest":{const f=Math.round(y),E=Math.round(x);f<g&&E<b&&(k=h.data[f*b+E]);break}default:throw new Error(`Unsupported resample method: ${s}`)}}isNaN(k)&&(k=o),c[a*(u*n+l)+d]=k}return c}const yn='&#169; <a href="https://www.openstreetmap.org/copyright" target="_blank">OpenStreetMap</a> contributors.';class xn extends ye{constructor(t){t=t||{};let n;t.attributions!==void 0?n=t.attributions:n=[yn];const r=t.crossOrigin!==void 0?t.crossOrigin:"anonymous",i=t.url!==void 0?t.url:"https://tile.openstreetmap.org/{z}/{x}/{y}.png";super({attributions:n,attributionsCollapsible:!1,cacheSize:t.cacheSize,crossOrigin:r,interpolate:t.interpolate,maxZoom:t.maxZoom!==void 0?t.maxZoom:19,reprojectionErrorThreshold:t.reprojectionErrorThreshold,tileLoadFunction:(s,o)=>{const a=s.getImage();!pe&&a instanceof HTMLImageElement&&(a.referrerPolicy="origin-when-cross-origin"),(t.tileLoadFunction||me)(s,o)},transition:t.transition,url:i,wrapX:t.wrapX,zDirection:t.zDirection})}}export{En as G,xn as O};
